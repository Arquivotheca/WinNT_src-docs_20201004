<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ddemlcli.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ddemlcli.c</h1><a href="../../d9/d3/ddemlcli_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: ddemlcli.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* DDE Manager main client side module</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* Created: 10/3/91 Sanford Staab</span>
00009 <span class="comment">*</span>
00010 <span class="comment">\***************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
00015 <span class="comment">// DDEML globals</span>
00016 
<a name="l00017"></a><a class="code" href="../../d9/d3/ddemlcli_8c.html#a0">00017</a> <a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html">PCL_INSTANCE_INFO</a> <a class="code" href="../../d9/d3/ddemlcli_8c.html#a0">pciiList</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
<a name="l00018"></a><a class="code" href="../../d9/d3/ddemlcli_8c.html#a1">00018</a> RTL_CRITICAL_SECTION <a class="code" href="../../d9/d3/ddemlcli_8c.html#a1">gcsDDEML</a>;
00019 <span class="preprocessor">#if DBG</span>
00020 <span class="preprocessor"></span>PVOID gpDDEMLHeap;
00021 <span class="preprocessor">#endif</span>
00022 <span class="preprocessor"></span>
00023 <span class="comment">/***************************************************************************\</span>
00024 <span class="comment">* DdeInitialize (DDEML API)</span>
00025 <span class="comment">*</span>
00026 <span class="comment">* Description:</span>
00027 <span class="comment">* Used two different ways:</span>
00028 <span class="comment">* 1) First time call (*pidInst == 0) - causes a DDEML instance to be</span>
00029 <span class="comment">* created for the calling process/thread. Creates a server side</span>
00030 <span class="comment">* event window, server side instance structure, DDE Access Object,</span>
00031 <span class="comment">* and client side instance structure. The callback function address</span>
00032 <span class="comment">* and filter flags (afCmd) are placed into these structures.</span>
00033 <span class="comment">* 2) Subsequent call (*pidInst == hInst) - updates filter flags in</span>
00034 <span class="comment">* client and server side structures.</span>
00035 <span class="comment">*</span>
00036 <span class="comment">* History:</span>
00037 <span class="comment">* 11-1-91 sanfords Created.</span>
00038 <span class="comment">\***************************************************************************/</span>
<a name="l00039"></a><a class="code" href="../../d9/d3/ddemlcli_8c.html#a2">00039</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d9/d3/ddemlcli_8c.html#a2">DdeInitializeA</a>(
00040 LPDWORD pidInst,
00041 PFNCALLBACK pfnCallback,
00042 DWORD afCmd,
00043 DWORD ulRes)
00044 {
00045     <span class="keywordflow">if</span> (ulRes != 0) {
00046         <span class="keywordflow">return</span> (DMLERR_INVALIDPARAMETER);
00047     }
00048     <span class="keywordflow">return</span> (<a class="code" href="../../d0/d4/ddemlcli_8h.html#a95">InternalDdeInitialize</a>(pidInst, pfnCallback, afCmd, 0));
00049 }
00050 
00051 
<a name="l00052"></a><a class="code" href="../../d9/d3/ddemlcli_8c.html#a3">00052</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d9/d3/ddemlcli_8c.html#a3">DdeInitializeW</a>(
00053 LPDWORD pidInst,
00054 PFNCALLBACK pfnCallback,
00055 DWORD afCmd,
00056 DWORD ulRes)
00057 {
00058     <span class="keywordflow">if</span> (ulRes != 0) {
00059         <span class="keywordflow">return</span> (DMLERR_INVALIDPARAMETER);
00060     }
00061     <span class="keywordflow">return</span> (<a class="code" href="../../d0/d4/ddemlcli_8h.html#a95">InternalDdeInitialize</a>(pidInst, pfnCallback, afCmd, 1));
00062 }
00063 
00064 
<a name="l00065"></a><a class="code" href="../../d0/d4/ddemlcli_8h.html#a95">00065</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d0/d4/ddemlcli_8h.html#a95">InternalDdeInitialize</a>(
00066 LPDWORD pidInst,
00067 PFNCALLBACK pfnCallback,
00068 DWORD afCmd,
00069 BOOL fUnicode)
00070 {
00071     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uiRet = DMLERR_MEMORY_ERROR;
00072     <span class="keyword">register</span> <a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html">PCL_INSTANCE_INFO</a> pcii;
00073 
00074     <span class="keywordflow">if</span> (afCmd &amp; APPCLASS_MONITOR) {
00075         afCmd |= CBF_MONMASK;
00076     }
00077 
00078     <span class="keywordflow">if</span> (afCmd &amp; APPCMD_CLIENTONLY) {
00079         afCmd |= CBF_FAIL_CONNECTIONS;
00080     }
00081 
00082     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a6">EnterDDECrit</a>;
00083 
00084     <span class="keywordflow">if</span> (*pidInst != 0) {
00085         pcii = <a class="code" href="../../d0/d4/instance_8c.html#a7">ValidateInstance</a>((HANDLE)LongToHandle( *pidInst ));
00086         <span class="keywordflow">if</span> (pcii == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00087             uiRet = DMLERR_INVALIDPARAMETER;
00088             <span class="keywordflow">goto</span> Exit;
00089         }
00090 
00091         <span class="comment">// only allow certain bits to be changed on reinitialize call</span>
00092 
00093         pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o7">afCmd</a> = (pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o7">afCmd</a> &amp; ~(CBF_MASK | MF_MASK)) |
00094                 (afCmd &amp; (CBF_MASK | MF_MASK));
00095 
00096         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a7">LeaveDDECrit</a>;
00097         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a121">NtUserUpdateInstance</a>(pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o1">hInstServer</a>, &amp;pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o3">MonitorFlags</a>, afCmd);
00098         <span class="keywordflow">return</span> (DMLERR_NO_ERROR);
00099     }
00100 
00101     pcii = (<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html">PCL_INSTANCE_INFO</a>)<a class="code" href="../../d0/d4/ddemlcli_8h.html#a0">DDEMLAlloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html">CL_INSTANCE_INFO</a>));
00102     <span class="keywordflow">if</span> (pcii == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00103         uiRet = DMLERR_MEMORY_ERROR;
00104         <span class="keywordflow">goto</span> Exit;
00105     }
00106 
00107     pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o11">plaNameService</a> = (<a class="code" href="../../d0/d4/ddemlcli_8h.html#a51">LATOM</a> *)<a class="code" href="../../d0/d4/ddemlcli_8h.html#a0">DDEMLAlloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d4/ddemlcli_8h.html#a51">LATOM</a>));
00108     <span class="keywordflow">if</span> (pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o11">plaNameService</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00109         uiRet = DMLERR_MEMORY_ERROR;
00110         <span class="keywordflow">goto</span> Backout3;
00111     }
00112     <span class="comment">// *pcii-&gt;plaNameService = 0; // zero init takes care of this</span>
00113     pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o12">cNameServiceAlloc</a> = 1;
00114 
00115 
00116     <span class="comment">/*</span>
00117 <span class="comment">     * Flag this window as being create from a diff hmod as the app so</span>
00118 <span class="comment">     * hotkeys don't take it as the first window created in the app and</span>
00119 <span class="comment">     * assign it as the hotkey.</span>
00120 <span class="comment">     */</span>
00121     pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o4">hwndMother</a> =  <a class="code" href="../../d6/d0/usercli_8h.html#a624">_CreateWindowEx</a>(0, (LPTSTR)(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a83">ICLS_DDEMLMOTHER</a>]), <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>,
00122             WS_POPUP, 0, 0, 0, 0, (HWND)0,
00123             (HMENU)0, 0, (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a771">CW_FLAGS_DIFFHMOD</a>);
00124 
00125     <span class="keywordflow">if</span> (pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o4">hwndMother</a> == 0) {
00126         uiRet = DMLERR_SYS_ERROR;
00127         <span class="keywordflow">goto</span> Backout2;
00128     }
00129     <a class="code" href="../../d5/d9/cltxt_8h.html#a12">SetWindowLongPtr</a>(pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o4">hwndMother</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a151">GWLP_INSTANCE_INFO</a>, (LONG_PTR)pcii);
00130 
00131     pcii-&gt;afCmd = afCmd | APPCMD_FILTERINITS;
00132     pcii-&gt;pfnCallback = pfnCallback;
00133     <span class="comment">// pcii-&gt;LastError = DMLERR_NO_ERROR; // zero init</span>
00134     pcii-&gt;tid = GetCurrentThreadId();
00135     <span class="comment">// pcii-&gt;aServerLookup = NULL;          // zero init</span>
00136     <span class="comment">// pcii-&gt;cServerLookupAlloc = 0;        // zero init</span>
00137     <span class="comment">// pcii-&gt;ConvStartupState = 0;          // zero init - Not blocked.</span>
00138     <span class="comment">// pcii-&gt;flags = 0;                     // zero init</span>
00139     <span class="comment">// pcii-&gt;cInDDEMLCallback = 0;          // zero init</span>
00140     <span class="comment">// pcii-&gt;pLinkCounts = NULL;            // zero init</span>
00141 
00142     <span class="comment">// Do this last when the client side is ready for whatever events</span>
00143     <span class="comment">// flying around may come charging in.</span>
00144 
00145     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a7">LeaveDDECrit</a>;
00146     uiRet = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a120">NtUserDdeInitialize</a>(&amp;pcii-&gt;hInstServer,
00147                             &amp;pcii-&gt;hwndEvent,
00148                             &amp;pcii-&gt;MonitorFlags,
00149                             pcii-&gt;afCmd,
00150                             pcii);
00151     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a6">EnterDDECrit</a>;
00152 
00153     <span class="keywordflow">if</span> (uiRet != DMLERR_NO_ERROR) {
00154 Backout:
00155         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a159">NtUserDestroyWindow</a>(pcii-&gt;hwndMother);
00156 Backout2:
00157         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a2">DDEMLFree</a>(pcii-&gt;plaNameService);
00158 Backout3:
00159         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a2">DDEMLFree</a>(pcii);
00160         <span class="keywordflow">goto</span> Exit;
00161     }
00162     pcii-&gt;hInstClient = <a class="code" href="../../d0/d4/instance_8c.html#a5">AddInstance</a>(pcii-&gt;hInstServer);
00163     *pidInst = HandleToUlong(pcii-&gt;hInstClient);
00164     <span class="keywordflow">if</span> (pcii-&gt;hInstClient == 0) {
00165         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a7">LeaveDDECrit</a>;
00166         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>((ULONG_PTR)pcii-&gt;hInstServer, SFI__CSDDEUNINITIALIZE);
00167         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a6">EnterDDECrit</a>;
00168         uiRet = DMLERR_MEMORY_ERROR;
00169         <span class="keywordflow">goto</span> Backout;
00170     }
00171     <a class="code" href="../../d3/d8/handles_8c.html#a9">SetHandleData</a>(pcii-&gt;hInstClient, (ULONG_PTR)pcii);
00172 
00173     pcii-&gt;next = <a class="code" href="../../d9/d3/ddemlcli_8c.html#a0">pciiList</a>;
00174     <a class="code" href="../../d9/d3/ddemlcli_8c.html#a0">pciiList</a> = pcii;
00175     <span class="keywordflow">if</span> (fUnicode) {
00176         pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o16">flags</a> |= <a class="code" href="../../d0/d4/ddemlcli_8h.html#a50">IIF_UNICODE</a>;
00177     }
00178     uiRet = DMLERR_NO_ERROR;
00179 
00180 Exit:
00181     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a7">LeaveDDECrit</a>;
00182     <span class="keywordflow">return</span> (uiRet);
00183 }
00184 
00185 
00186 
00187 <span class="comment">/***************************************************************************\</span>
00188 <span class="comment">* DdeUninitialize (DDEML API)</span>
00189 <span class="comment">*</span>
00190 <span class="comment">* Description:</span>
00191 <span class="comment">* Shuts down a DDEML instance and frees all associated resources.</span>
00192 <span class="comment">*</span>
00193 <span class="comment">* History:</span>
00194 <span class="comment">* 11-12-91 sanfords Created.</span>
00195 <span class="comment">\***************************************************************************/</span>
<a name="l00196"></a><a class="code" href="../../d9/d3/ddemlcli_8c.html#a5">00196</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d3/ddemlcli_8c.html#a5">DdeUninitialize</a>(
00197 DWORD idInst)
00198 {
00199     <a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html">PCL_INSTANCE_INFO</a> pcii, pciiPrev;
00200     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00201 
00202     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a9">CheckDDECritOut</a>;
00203     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a6">EnterDDECrit</a>;
00204 
00205     pcii = <a class="code" href="../../d0/d4/instance_8c.html#a7">ValidateInstance</a>((HANDLE)LongToHandle( idInst ));
00206     <span class="keywordflow">if</span> (pcii == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00207         <a class="code" href="../../d3/d8/handles_8c.html#a14">BestSetLastDDEMLError</a>(DMLERR_INVALIDPARAMETER);
00208         <span class="keywordflow">goto</span> Exit;
00209     }
00210 
00211     <span class="comment">/*</span>
00212 <span class="comment">     * If this thread is in the middle of a synchronous transaction or</span>
00213 <span class="comment">     * a callback, we need to back out of those first.</span>
00214 <span class="comment">     */</span>
00215     <span class="keywordflow">if</span> ((pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o16">flags</a> &amp; <a class="code" href="../../d0/d4/ddemlcli_8h.html#a49">IIF_IN_SYNC_XACT</a>) || pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o17">cInDDEMLCallback</a>) {
00216         pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o7">afCmd</a> |= APPCMD_UNINIT_ASAP;
00217         fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00218         <span class="keywordflow">goto</span> Exit;
00219     }
00220 
00221     <a class="code" href="../../d3/d8/handles_8c.html#a12">ApplyFunctionToObjects</a>(<a class="code" href="../../d0/d4/ddemlcli_8h.html#a37">HTYPE_CONVERSATION_LIST</a>, <a class="code" href="../../d0/d4/ddemlcli_8h.html#a28">InstFromHandle</a>(pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o2">hInstClient</a>),
00222             (<a class="code" href="../../d0/d4/ddemlcli_8h.html#a56">PFNHANDLEAPPLY</a>)<a class="code" href="../../d6/d5/connect_8c.html#a17">DdeDisconnectList</a>);
00223     <a class="code" href="../../d3/d8/handles_8c.html#a12">ApplyFunctionToObjects</a>(<a class="code" href="../../d0/d4/ddemlcli_8h.html#a36">HTYPE_CLIENT_CONVERSATION</a>, <a class="code" href="../../d0/d4/ddemlcli_8h.html#a28">InstFromHandle</a>(pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o2">hInstClient</a>),
00224             (<a class="code" href="../../d0/d4/ddemlcli_8h.html#a56">PFNHANDLEAPPLY</a>)<a class="code" href="../../d6/d5/connect_8c.html#a16">DdeDisconnect</a>);
00225     <a class="code" href="../../d3/d8/handles_8c.html#a12">ApplyFunctionToObjects</a>(<a class="code" href="../../d0/d4/ddemlcli_8h.html#a35">HTYPE_SERVER_CONVERSATION</a>, <a class="code" href="../../d0/d4/ddemlcli_8h.html#a28">InstFromHandle</a>(pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o2">hInstClient</a>),
00226             (<a class="code" href="../../d0/d4/ddemlcli_8h.html#a56">PFNHANDLEAPPLY</a>)<a class="code" href="../../d6/d5/connect_8c.html#a16">DdeDisconnect</a>);
00227     <a class="code" href="../../d3/d8/handles_8c.html#a12">ApplyFunctionToObjects</a>(<a class="code" href="../../d0/d4/ddemlcli_8h.html#a40">HTYPE_ZOMBIE_CONVERSATION</a>, <a class="code" href="../../d0/d4/ddemlcli_8h.html#a28">InstFromHandle</a>(pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o2">hInstClient</a>),
00228             (<a class="code" href="../../d0/d4/ddemlcli_8h.html#a56">PFNHANDLEAPPLY</a>)<a class="code" href="../../d6/d5/connect_8c.html#a21">WaitForZombieTerminate</a>);
00229     <a class="code" href="../../d3/d8/handles_8c.html#a12">ApplyFunctionToObjects</a>(<a class="code" href="../../d0/d4/ddemlcli_8h.html#a39">HTYPE_DATA_HANDLE</a>, <a class="code" href="../../d0/d4/ddemlcli_8h.html#a28">InstFromHandle</a>(pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o2">hInstClient</a>),
00230             (<a class="code" href="../../d0/d4/ddemlcli_8h.html#a56">PFNHANDLEAPPLY</a>)<a class="code" href="../../d0/d4/ddemlcli_8h.html#a123">ApplyFreeDataHandle</a>);
00231 
00232     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a7">LeaveDDECrit</a>;
00233     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>((ULONG_PTR)pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o1">hInstServer</a>, SFI__CSDDEUNINITIALIZE);
00234     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a159">NtUserDestroyWindow</a>(pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o4">hwndMother</a>);
00235     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a6">EnterDDECrit</a>;
00236 
00237     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a2">DDEMLFree</a>(pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o11">plaNameService</a>);
00238     <a class="code" href="../../d0/d4/instance_8c.html#a6">DestroyInstance</a>(pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o2">hInstClient</a>);
00239 
00240     <span class="comment">// unlink pcii from pciiList</span>
00241 
00242     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/ddemlcli_8c.html#a0">pciiList</a> == pcii) {
00243         <a class="code" href="../../d9/d3/ddemlcli_8c.html#a0">pciiList</a> = <a class="code" href="../../d9/d3/ddemlcli_8c.html#a0">pciiList</a>-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o0">next</a>;
00244     } <span class="keywordflow">else</span> {
00245         <span class="keywordflow">for</span> (pciiPrev = <a class="code" href="../../d9/d3/ddemlcli_8c.html#a0">pciiList</a>; pciiPrev != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pciiPrev-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o0">next</a> != pcii;
00246                 pciiPrev = pciiPrev-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o0">next</a>) {
00247             ;
00248         }
00249         <span class="keywordflow">if</span> (pciiPrev != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00250             pciiPrev-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o0">next</a> = pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o0">next</a>;
00251         }
00252     }
00253     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a2">DDEMLFree</a>(pcii);
00254     fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00255 
00256 Exit:
00257     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a7">LeaveDDECrit</a>;
00258     <span class="keywordflow">return</span> (fRet);
00259 }
00260 
00261 
00262 
00263 <span class="comment">/***************************************************************************\</span>
00264 <span class="comment">* DdeNameService (DDEML API)</span>
00265 <span class="comment">*</span>
00266 <span class="comment">* Description:</span>
00267 <span class="comment">* Registers, and Unregisters service names and sets the Initiate filter</span>
00268 <span class="comment">* state for an instance.</span>
00269 <span class="comment">*</span>
00270 <span class="comment">* History:</span>
00271 <span class="comment">* 11-1-91 sanfords Created.</span>
00272 <span class="comment">\***************************************************************************/</span>
<a name="l00273"></a><a class="code" href="../../d9/d3/ddemlcli_8c.html#a6">00273</a> HDDEDATA <a class="code" href="../../d9/d3/ddemlcli_8c.html#a6">DdeNameService</a>(
00274 DWORD idInst,
00275 HSZ hsz1, <span class="comment">// service name</span>
00276 HSZ hsz2, <span class="comment">// reserved for future enhancements</span>
00277 UINT afCmd) <span class="comment">// DNS_ flags.</span>
00278 {
00279     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00280     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a51">LATOM</a> *plaNameService;
00281     <a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html">PCL_INSTANCE_INFO</a> pcii;
00282 
00283     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a6">EnterDDECrit</a>;
00284 
00285     pcii = <a class="code" href="../../d0/d4/instance_8c.html#a7">ValidateInstance</a>((HANDLE)LongToHandle( idInst ));
00286     <span class="keywordflow">if</span> (pcii == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00287         <a class="code" href="../../d3/d8/handles_8c.html#a14">BestSetLastDDEMLError</a>(DMLERR_INVALIDPARAMETER);
00288         fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00289         <span class="keywordflow">goto</span> Exit;
00290     }
00291 
00292     <span class="keywordflow">if</span> ((hsz1 &amp;&amp; <a class="code" href="../../d4/d2/hsz_8c.html#a9">ValidateHSZ</a>(hsz1) == <a class="code" href="../../d0/d4/ddemlcli_8h.html#a10">HSZT_INVALID</a>) || hsz2 != 0) {
00293         <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(pcii, DMLERR_INVALIDPARAMETER);
00294         fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00295         <span class="keywordflow">goto</span> Exit;
00296     }
00297 
00298     <span class="keywordflow">if</span> (afCmd &amp; DNS_FILTERON &amp;&amp; !(pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o7">afCmd</a> &amp; APPCMD_FILTERINITS)) {
00299         pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o7">afCmd</a> |= APPCMD_FILTERINITS;
00300         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a121">NtUserUpdateInstance</a>(pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o1">hInstServer</a>, &amp;pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o3">MonitorFlags</a>, pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o7">afCmd</a>);
00301     }
00302     <span class="keywordflow">if</span> (afCmd &amp; DNS_FILTEROFF &amp;&amp; (pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o7">afCmd</a> &amp; APPCMD_FILTERINITS)) {
00303         pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o7">afCmd</a> &amp;= ~APPCMD_FILTERINITS;
00304         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a121">NtUserUpdateInstance</a>(pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o1">hInstServer</a>, &amp;pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o3">MonitorFlags</a>, pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o7">afCmd</a>);
00305     }
00306 
00307     <span class="keywordflow">if</span> (afCmd &amp; (DNS_REGISTER | DNS_UNREGISTER)) {
00308         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a52">GATOM</a> ga;
00309 
00310         <span class="keywordflow">if</span> (pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o7">afCmd</a> &amp; APPCMD_CLIENTONLY) {
00311             <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(pcii, DMLERR_DLL_USAGE);
00312             fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00313             <span class="keywordflow">goto</span> Exit;
00314         }
00315 
00316         <span class="keywordflow">if</span> (hsz1 == 0) {
00317             <span class="keywordflow">if</span> (afCmd &amp; DNS_REGISTER) {
00318 
00319                 <span class="comment">/*</span>
00320 <span class="comment">                 * registering NULL is not allowed!</span>
00321 <span class="comment">                 */</span>
00322                 <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(pcii, DMLERR_INVALIDPARAMETER);
00323                 fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00324                 <span class="keywordflow">goto</span> Exit;
00325             }
00326 
00327             <span class="comment">/*</span>
00328 <span class="comment">             * unregistering NULL is just like unregistering each</span>
00329 <span class="comment">             * registered name.</span>
00330 <span class="comment">             *</span>
00331 <span class="comment">             * 10/19/90 - made this a synchronous event so that hsz</span>
00332 <span class="comment">             * can be freed by calling app after this call completes</span>
00333 <span class="comment">             * without us having to keep a copy around forever.</span>
00334 <span class="comment">             */</span>
00335             plaNameService = pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o11">plaNameService</a>;
00336             <span class="keywordflow">while</span> (*plaNameService != 0) {
00337                 ga = <a class="code" href="../../d4/d2/hsz_8c.html#a12">LocalToGlobalAtom</a>(*plaNameService);
00338                 DeleteAtom(*plaNameService);
00339                 <a class="code" href="../../d0/d4/ddemlcli_8h.html#a7">LeaveDDECrit</a>;
00340                 <a class="code" href="../../d9/d6/register_8c.html#a1">RegisterService</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, ga, pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o4">hwndMother</a>);
00341                 <a class="code" href="../../d0/d4/ddemlcli_8h.html#a6">EnterDDECrit</a>;
00342                 GlobalDeleteAtom(ga);
00343                 plaNameService++;
00344             }
00345             pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o12">cNameServiceAlloc</a> = 1;
00346             *pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o11">plaNameService</a> = 0;
00347             <span class="keywordflow">goto</span> Exit;
00348         }
00349 
00350         <span class="keywordflow">if</span> (afCmd &amp; DNS_REGISTER) {
00351             plaNameService = (<a class="code" href="../../d0/d4/ddemlcli_8h.html#a51">LATOM</a> *)<a class="code" href="../../d0/d4/ddemlcli_8h.html#a1">DDEMLReAlloc</a>(pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o11">plaNameService</a>,
00352                     <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d4/ddemlcli_8h.html#a51">LATOM</a>) * ++pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o12">cNameServiceAlloc</a>);
00353             <span class="keywordflow">if</span> (plaNameService == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00354                 <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(pcii, DMLERR_MEMORY_ERROR);
00355                 pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o12">cNameServiceAlloc</a>--;
00356                 fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00357                 <span class="keywordflow">goto</span> Exit;
00358             } <span class="keywordflow">else</span> {
00359                 pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o11">plaNameService</a> = plaNameService;
00360             }
00361             <a class="code" href="../../d4/d2/hsz_8c.html#a15">IncLocalAtomCount</a>(<a class="code" href="../../d0/d4/ddemlcli_8h.html#a13">LATOM_FROM_HSZ</a>(hsz1)); <span class="comment">// NameService copy</span>
00362             plaNameService[pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o12">cNameServiceAlloc</a> - 2] = <a class="code" href="../../d0/d4/ddemlcli_8h.html#a13">LATOM_FROM_HSZ</a>(hsz1);
00363             plaNameService[pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o12">cNameServiceAlloc</a> - 1] = 0;
00364 
00365         } <span class="keywordflow">else</span> { <span class="comment">// DNS_UNREGISTER</span>
00366             plaNameService = pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o11">plaNameService</a>;
00367             <span class="keywordflow">while</span> (*plaNameService != 0 &amp;&amp; *plaNameService != <a class="code" href="../../d0/d4/ddemlcli_8h.html#a13">LATOM_FROM_HSZ</a>(hsz1)) {
00368                 plaNameService++;
00369             }
00370             <span class="keywordflow">if</span> (*plaNameService == 0) {
00371                 <span class="keywordflow">goto</span> Exit; <span class="comment">// not found just exit</span>
00372             }
00373             <span class="comment">//</span>
00374             <span class="comment">// fill empty slot with last entry and fill last entry with 0</span>
00375             <span class="comment">//</span>
00376             pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o12">cNameServiceAlloc</a>--;
00377             *plaNameService = pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o11">plaNameService</a>[pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o12">cNameServiceAlloc</a> - 1];
00378             pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o11">plaNameService</a>[pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o12">cNameServiceAlloc</a> - 1] = 0;
00379         }
00380 
00381         ga = <a class="code" href="../../d4/d2/hsz_8c.html#a12">LocalToGlobalAtom</a>(<a class="code" href="../../d0/d4/ddemlcli_8h.html#a13">LATOM_FROM_HSZ</a>(hsz1));
00382         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a7">LeaveDDECrit</a>;
00383         <a class="code" href="../../d9/d6/register_8c.html#a1">RegisterService</a>((afCmd &amp; DNS_REGISTER) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, ga,
00384             pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o4">hwndMother</a>);
00385         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a6">EnterDDECrit</a>;
00386         GlobalDeleteAtom(ga);
00387     }
00388 
00389 Exit:
00390     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a7">LeaveDDECrit</a>;
00391     <span class="keywordflow">return</span> ((HDDEDATA)IntToPtr( fRet ));
00392 }
00393 
00394 
00395 
00396 <span class="comment">/***************************************************************************\</span>
00397 <span class="comment">* DdeGetLastError (DDEML API)</span>
00398 <span class="comment">*</span>
00399 <span class="comment">* Description:</span>
00400 <span class="comment">* Returns last error code set for the instance given.</span>
00401 <span class="comment">*</span>
00402 <span class="comment">* History:</span>
00403 <span class="comment">* 11-12-91 sanfords Created.</span>
00404 <span class="comment">\***************************************************************************/</span>
<a name="l00405"></a><a class="code" href="../../d9/d3/ddemlcli_8c.html#a7">00405</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d9/d3/ddemlcli_8c.html#a7">DdeGetLastError</a>(
00406 DWORD idInst)
00407 {
00408     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uiRet = 0;
00409     <a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html">PCL_INSTANCE_INFO</a> pcii;
00410 
00411     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a6">EnterDDECrit</a>;
00412 
00413     pcii = <a class="code" href="../../d0/d4/instance_8c.html#a7">ValidateInstance</a>((HANDLE)LongToHandle( idInst ));
00414     <span class="keywordflow">if</span> (pcii == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00415         uiRet = DMLERR_INVALIDPARAMETER;
00416         <span class="keywordflow">goto</span> Exit;
00417     }
00418     uiRet = pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o9">LastError</a>;
00419     pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o9">LastError</a> = DMLERR_NO_ERROR;
00420 
00421 Exit:
00422     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a7">LeaveDDECrit</a>;
00423     <span class="keywordflow">return</span> (uiRet);
00424 }
00425 
00426 
00427 
00428 <span class="comment">/***************************************************************************\</span>
00429 <span class="comment">* DdeImpersonateClient()</span>
00430 <span class="comment">*</span>
00431 <span class="comment">* Description:</span>
00432 <span class="comment">*   Does security impersonation for DDEML server apps.</span>
00433 <span class="comment">*   This API should only be called with server side hConvs;</span>
00434 <span class="comment">*</span>
00435 <span class="comment">* History:</span>
00436 <span class="comment">* 5-4-92 sanfords Created.</span>
00437 <span class="comment">\***************************************************************************/</span>
<a name="l00438"></a><a class="code" href="../../d9/d3/ddemlcli_8c.html#a8">00438</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d3/ddemlcli_8c.html#a8">DdeImpersonateClient</a>(
00439 HCONV hConv)
00440 {
00441     <a class="code" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a> pcoi;
00442     <a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html">PCL_INSTANCE_INFO</a> pcii;
00443     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00444 
00445     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a6">EnterDDECrit</a>;
00446 
00447     pcoi = (<a class="code" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a>)<a class="code" href="../../d3/d8/handles_8c.html#a10">ValidateCHandle</a>((HANDLE)hConv,
00448             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a35">HTYPE_SERVER_CONVERSATION</a>, <a class="code" href="../../d0/d4/ddemlcli_8h.html#a42">HINST_ANY</a>);
00449     <span class="keywordflow">if</span> (pcoi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00450         <a class="code" href="../../d3/d8/handles_8c.html#a14">BestSetLastDDEMLError</a>(DMLERR_INVALIDPARAMETER);
00451         <span class="keywordflow">goto</span> Exit;
00452     }
00453     pcii = <a class="code" href="../../d3/d8/handles_8c.html#a11">PciiFromHandle</a>((HANDLE)hConv);
00454     <span class="keywordflow">if</span> (pcii == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00455         <a class="code" href="../../d3/d8/handles_8c.html#a14">BestSetLastDDEMLError</a>(DMLERR_INVALIDPARAMETER);
00456         <span class="keywordflow">goto</span> Exit;
00457     }
00458 
00459     fRet = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a303">NtUserImpersonateDdeClientWindow</a>(pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o6">hwndPartner</a>, pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o7">hwndConv</a>);
00460 Exit:
00461     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a7">LeaveDDECrit</a>;
00462     <span class="keywordflow">return</span> (fRet);
00463 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:39 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
