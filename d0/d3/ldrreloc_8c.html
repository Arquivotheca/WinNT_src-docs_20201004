<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ldrreloc.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ldrreloc.c File Reference</h1><code>#include "<a class="el" href="../../d6/d8/ntrtlp_8h-source.html">ntrtlp.h</a>"</code><br>

<p>
<a href="../../d1/d2/ldrreloc_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d3/ldrreloc_8c.html#a0">SWAP_SHORT</a>(_dst, _src)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d3/ldrreloc_8c.html#a1">SWAP_INT</a>(_dst, _src)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d3/ldrreloc_8c.html#a2">SWAP_LONG_LONG</a>(_dst, _src)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d3/ldrreloc_8c.html#a3">LDRP_RELOCATION_INCREMENT</a>&nbsp;&nbsp;&nbsp;0x1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d3/ldrreloc_8c.html#a4">LDRP_RELOCATION_FINAL</a>&nbsp;&nbsp;&nbsp;0x2</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d3/ldrreloc_8c.html#a5">LdrRelocateImage</a> (IN PVOID NewBase, IN PUCHAR LoaderName, IN ULONG Success, IN ULONG Conflict, IN ULONG Invalid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PIMAGE_BASE_RELOCATION&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d3/ldrreloc_8c.html#a6">LdrProcessRelocationBlock</a> (IN ULONG_PTR VA, IN ULONG SizeOfBlock, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a22">PUSHORT</a> NextOffset, IN LONG_PTR Diff)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a4" doxytag="ldrreloc.c::LDRP_RELOCATION_FINAL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LDRP_RELOCATION_FINAL&nbsp;&nbsp;&nbsp;0x2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d2/ldrreloc_8c-source.html#l00058">58</a> of file <a class="el" href="../../d1/d2/ldrreloc_8c-source.html">ldrreloc.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d2/ldrreloc_8c-source.html#l00194">LdrProcessRelocationBlock()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="ldrreloc.c::LDRP_RELOCATION_INCREMENT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LDRP_RELOCATION_INCREMENT&nbsp;&nbsp;&nbsp;0x1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d2/ldrreloc_8c-source.html#l00053">53</a> of file <a class="el" href="../../d1/d2/ldrreloc_8c-source.html">ldrreloc.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d2/ldrreloc_8c-source.html#l00194">LdrProcessRelocationBlock()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="ldrreloc.c::SWAP_INT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SWAP_INT          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_dst,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>_src&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>((((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)_dst)[3] = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)_src)[0]),                 \
    (((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)_dst)[2] = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)_src)[1]),                 \
    (((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)_dst)[1] = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)_src)[2]),                 \
    (((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)_dst)[0] = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)_src)[3]))
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d2/ldrreloc_8c-source.html#l00034">34</a> of file <a class="el" href="../../d1/d2/ldrreloc_8c-source.html">ldrreloc.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="ldrreloc.c::SWAP_LONG_LONG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SWAP_LONG_LONG          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_dst,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>_src&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>((((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)_dst)[7] = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)_src)[0]),                 \
    (((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)_dst)[6] = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)_src)[1]),                 \
    (((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)_dst)[5] = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)_src)[2]),                 \
    (((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)_dst)[4] = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)_src)[3]),                 \
    (((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)_dst)[3] = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)_src)[4]),                 \
    (((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)_dst)[2] = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)_src)[5]),                 \
    (((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)_dst)[1] = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)_src)[6]),                 \
    (((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)_dst)[0] = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)_src)[7]))
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d2/ldrreloc_8c-source.html#l00040">40</a> of file <a class="el" href="../../d1/d2/ldrreloc_8c-source.html">ldrreloc.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="ldrreloc.c::SWAP_SHORT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SWAP_SHORT          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_dst,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>_src&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>((((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)_dst)[1] = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)_src)[0]),                 \
    (((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)_dst)[0] = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)_src)[1]))
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d2/ldrreloc_8c-source.html#l00030">30</a> of file <a class="el" href="../../d1/d2/ldrreloc_8c-source.html">ldrreloc.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a6" doxytag="ldrreloc.c::LdrProcessRelocationBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PIMAGE_BASE_RELOCATION LdrProcessRelocationBlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>VA</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SizeOfBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a22">PUSHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NextOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>Diff</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d2/ldrreloc_8c-source.html#l00194">194</a> of file <a class="el" href="../../d1/d2/ldrreloc_8c-source.html">ldrreloc.c</a>.
<p>
References <a class="el" href="../../d1/d2/ldrreloc_8c-source.html#l00058">LDRP_RELOCATION_FINAL</a>, <a class="el" href="../../d1/d2/ldrreloc_8c-source.html#l00053">LDRP_RELOCATION_INCREMENT</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00084">PSHORT</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00085">PUSHORT</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00062">SHORT</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d1/d2/ldrreloc_8c-source.html#l00091">LdrRelocateImage()</a>.
<p>
<pre class="fragment"><div>00200 {
00201     PUCHAR FixupVA;
00202     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00203     LONG Temp;
00204     LONG TempOrig;
00205     ULONG Temp32;
00206     ULONGLONG Value64;
00207     LONGLONG Temp64;
00208     LONG_PTR ActualDiff;
00209 
00210     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00211 
00212     <span class="keywordflow">while</span> (SizeOfBlock--) {
00213 
00214        <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = *NextOffset &amp; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)0xfff;
00215        FixupVA = (PUCHAR)(VA + <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>);
00216 
00217        <span class="comment">//</span>
00218        <span class="comment">// Apply the fixups.</span>
00219        <span class="comment">//</span>
00220 
00221        <span class="keywordflow">switch</span> ((*NextOffset) &gt;&gt; 12) {
00222 
00223             <span class="keywordflow">case</span> IMAGE_REL_BASED_HIGHLOW :
00224                 <span class="comment">//</span>
00225                 <span class="comment">// HighLow - (32-bits) relocate the high and low half</span>
00226                 <span class="comment">//      of an address.</span>
00227                 <span class="comment">//</span>
00228                 *(LONG UNALIGNED *)FixupVA += (ULONG) Diff;
00229                 <span class="keywordflow">break</span>;
00230 
00231             <span class="keywordflow">case</span> IMAGE_REL_BASED_HIGH :
00232                 <span class="comment">//</span>
00233                 <span class="comment">// High - (16-bits) relocate the high half of an address.</span>
00234                 <span class="comment">//</span>
00235                 Temp = *(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)FixupVA &lt;&lt; 16;
00236                 Temp += (ULONG) Diff;
00237                 *(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)FixupVA = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(Temp &gt;&gt; 16);
00238                 <span class="keywordflow">break</span>;
00239 
00240             <span class="keywordflow">case</span> IMAGE_REL_BASED_HIGHADJ :
00241                 <span class="comment">//</span>
00242                 <span class="comment">// Adjust high - (16-bits) relocate the high half of an</span>
00243                 <span class="comment">//      address and adjust for sign extension of low half.</span>
00244                 <span class="comment">//</span>
00245 
00246 <span class="preprocessor">#if defined(NTOS_KERNEL_RUNTIME)</span>
00247 <span class="preprocessor"></span>                <span class="comment">//</span>
00248                 <span class="comment">// If the address has already been relocated then don't</span>
00249                 <span class="comment">// process it again now or information will be lost.</span>
00250                 <span class="comment">//</span>
00251                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &amp; <a class="code" href="../../d0/d3/ldrreloc_8c.html#a4">LDRP_RELOCATION_FINAL</a>) {
00252                     ++NextOffset;
00253                     --SizeOfBlock;
00254                     <span class="keywordflow">break</span>;
00255                 }
00256 <span class="preprocessor">#endif</span>
00257 <span class="preprocessor"></span>
00258                 Temp = *(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)FixupVA &lt;&lt; 16;
00259 <span class="preprocessor">#if defined(BLDR_KERNEL_RUNTIME)</span>
00260 <span class="preprocessor"></span>                TempOrig = Temp;
00261 <span class="preprocessor">#endif</span>
00262 <span class="preprocessor"></span>                ++NextOffset;
00263                 --SizeOfBlock;
00264                 Temp += (LONG)(*(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a21">PSHORT</a>)NextOffset);
00265                 Temp += (ULONG) Diff;
00266                 Temp += 0x8000;
00267                 *(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)FixupVA = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(Temp &gt;&gt; 16);
00268 
00269 <span class="preprocessor">#if defined(BLDR_KERNEL_RUNTIME)</span>
00270 <span class="preprocessor"></span>                ActualDiff = ((((ULONG_PTR)(Temp - TempOrig)) &gt;&gt; 16) -
00271                               (((ULONG_PTR)Diff) &gt;&gt; 16 ));
00272 
00273                 <span class="keywordflow">if</span> (ActualDiff == 1) {
00274                     <span class="comment">//</span>
00275                     <span class="comment">// Mark the relocation as needing an increment if it is</span>
00276                     <span class="comment">// relocated again.</span>
00277                     <span class="comment">//</span>
00278                     *(NextOffset - 1) |= <a class="code" href="../../d0/d3/ldrreloc_8c.html#a3">LDRP_RELOCATION_INCREMENT</a>;
00279                 }
00280                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ActualDiff != 0) {
00281                     <span class="comment">//</span>
00282                     <span class="comment">// Mark the relocation as cannot be reprocessed.</span>
00283                     <span class="comment">//</span>
00284                     *(NextOffset - 1) |= <a class="code" href="../../d0/d3/ldrreloc_8c.html#a4">LDRP_RELOCATION_FINAL</a>;
00285                 }
00286 <span class="preprocessor">#endif</span>
00287 <span class="preprocessor"></span>
00288                 <span class="keywordflow">break</span>;
00289 
00290             <span class="keywordflow">case</span> IMAGE_REL_BASED_LOW :
00291                 <span class="comment">//</span>
00292                 <span class="comment">// Low - (16-bit) relocate the low half of an address.</span>
00293                 <span class="comment">//</span>
00294                 Temp = *(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a21">PSHORT</a>)FixupVA;
00295                 Temp += (ULONG) Diff;
00296                 *(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)FixupVA = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Temp;
00297                 <span class="keywordflow">break</span>;
00298 
00299             <span class="keywordflow">case</span> IMAGE_REL_BASED_IA64_IMM64:
00300 
00301                 <span class="comment">//</span>
00302                 <span class="comment">// Align it to bundle address before fixing up the</span>
00303                 <span class="comment">// 64-bit immediate value of the movl instruction.</span>
00304                 <span class="comment">//</span>
00305 
00306                 FixupVA = (PUCHAR)((ULONG_PTR)FixupVA &amp; ~(15));
00307                 Value64 = (ULONGLONG)0;
00308 
00309                 <span class="comment">//</span>
00310                 <span class="comment">// Extract the lower 32 bits of IMM64 from bundle</span>
00311                 <span class="comment">//</span>
00312 
00313 
00314                 EXT_IMM64(Value64,
00315                         (PULONG)FixupVA + EMARCH_ENC_I17_IMM7B_INST_WORD_X,
00316                         EMARCH_ENC_I17_IMM7B_SIZE_X,
00317                         EMARCH_ENC_I17_IMM7B_INST_WORD_POS_X,
00318                         EMARCH_ENC_I17_IMM7B_VAL_POS_X);
00319                 EXT_IMM64(Value64,
00320                         (PULONG)FixupVA + EMARCH_ENC_I17_IMM9D_INST_WORD_X,
00321                         EMARCH_ENC_I17_IMM9D_SIZE_X,
00322                         EMARCH_ENC_I17_IMM9D_INST_WORD_POS_X,
00323                         EMARCH_ENC_I17_IMM9D_VAL_POS_X);
00324                 EXT_IMM64(Value64,
00325                         (PULONG)FixupVA + EMARCH_ENC_I17_IMM5C_INST_WORD_X,
00326                         EMARCH_ENC_I17_IMM5C_SIZE_X,
00327                         EMARCH_ENC_I17_IMM5C_INST_WORD_POS_X,
00328                         EMARCH_ENC_I17_IMM5C_VAL_POS_X);
00329                 EXT_IMM64(Value64,
00330                         (PULONG)FixupVA + EMARCH_ENC_I17_IC_INST_WORD_X,
00331                         EMARCH_ENC_I17_IC_SIZE_X,
00332                         EMARCH_ENC_I17_IC_INST_WORD_POS_X,
00333                         EMARCH_ENC_I17_IC_VAL_POS_X);
00334                 EXT_IMM64(Value64,
00335                         (PULONG)FixupVA + EMARCH_ENC_I17_IMM41a_INST_WORD_X,
00336                         EMARCH_ENC_I17_IMM41a_SIZE_X,
00337                         EMARCH_ENC_I17_IMM41a_INST_WORD_POS_X,
00338                         EMARCH_ENC_I17_IMM41a_VAL_POS_X);
00339 
00340                 <span class="comment">//</span>
00341                 <span class="comment">// Update 64-bit address</span>
00342                 <span class="comment">//</span>
00343 
00344                 Value64+=Diff;
00345 
00346                 <span class="comment">//</span>
00347                 <span class="comment">// Insert IMM64 into bundle</span>
00348                 <span class="comment">//</span>
00349 
00350                 INS_IMM64(Value64,
00351                         ((PULONG)FixupVA + EMARCH_ENC_I17_IMM7B_INST_WORD_X),
00352                         EMARCH_ENC_I17_IMM7B_SIZE_X,
00353                         EMARCH_ENC_I17_IMM7B_INST_WORD_POS_X,
00354                         EMARCH_ENC_I17_IMM7B_VAL_POS_X);
00355                 INS_IMM64(Value64,
00356                         ((PULONG)FixupVA + EMARCH_ENC_I17_IMM9D_INST_WORD_X),
00357                         EMARCH_ENC_I17_IMM9D_SIZE_X,
00358                         EMARCH_ENC_I17_IMM9D_INST_WORD_POS_X,
00359                         EMARCH_ENC_I17_IMM9D_VAL_POS_X);
00360                 INS_IMM64(Value64,
00361                         ((PULONG)FixupVA + EMARCH_ENC_I17_IMM5C_INST_WORD_X),
00362                         EMARCH_ENC_I17_IMM5C_SIZE_X,
00363                         EMARCH_ENC_I17_IMM5C_INST_WORD_POS_X,
00364                         EMARCH_ENC_I17_IMM5C_VAL_POS_X);
00365                 INS_IMM64(Value64,
00366                         ((PULONG)FixupVA + EMARCH_ENC_I17_IC_INST_WORD_X),
00367                         EMARCH_ENC_I17_IC_SIZE_X,
00368                         EMARCH_ENC_I17_IC_INST_WORD_POS_X,
00369                         EMARCH_ENC_I17_IC_VAL_POS_X);
00370                 INS_IMM64(Value64,
00371                         ((PULONG)FixupVA + EMARCH_ENC_I17_IMM41a_INST_WORD_X),
00372                         EMARCH_ENC_I17_IMM41a_SIZE_X,
00373                         EMARCH_ENC_I17_IMM41a_INST_WORD_POS_X,
00374                         EMARCH_ENC_I17_IMM41a_VAL_POS_X);
00375                 INS_IMM64(Value64,
00376                         ((PULONG)FixupVA + EMARCH_ENC_I17_IMM41b_INST_WORD_X),
00377                         EMARCH_ENC_I17_IMM41b_SIZE_X,
00378                         EMARCH_ENC_I17_IMM41b_INST_WORD_POS_X,
00379                         EMARCH_ENC_I17_IMM41b_VAL_POS_X);
00380                 INS_IMM64(Value64,
00381                         ((PULONG)FixupVA + EMARCH_ENC_I17_IMM41c_INST_WORD_X),
00382                         EMARCH_ENC_I17_IMM41c_SIZE_X,
00383                         EMARCH_ENC_I17_IMM41c_INST_WORD_POS_X,
00384                         EMARCH_ENC_I17_IMM41c_VAL_POS_X);
00385                 INS_IMM64(Value64,
00386                         ((PULONG)FixupVA + EMARCH_ENC_I17_SIGN_INST_WORD_X),
00387                         EMARCH_ENC_I17_SIGN_SIZE_X,
00388                         EMARCH_ENC_I17_SIGN_INST_WORD_POS_X,
00389                         EMARCH_ENC_I17_SIGN_VAL_POS_X);
00390                 <span class="keywordflow">break</span>;
00391 
00392             <span class="keywordflow">case</span> IMAGE_REL_BASED_DIR64:
00393 
00394                 *(ULONG_PTR UNALIGNED *)FixupVA += Diff;
00395 
00396                 <span class="keywordflow">break</span>;
00397 
00398             <span class="keywordflow">case</span> IMAGE_REL_BASED_MIPS_JMPADDR :
00399                 <span class="comment">//</span>
00400                 <span class="comment">// JumpAddress - (32-bits) relocate a MIPS jump address.</span>
00401                 <span class="comment">//</span>
00402                 Temp = (*(PULONG)FixupVA &amp; 0x3ffffff) &lt;&lt; 2;
00403                 Temp += (ULONG) Diff;
00404                 *(PULONG)FixupVA = (*(PULONG)FixupVA &amp; ~0x3ffffff) |
00405                                                 ((Temp &gt;&gt; 2) &amp; 0x3ffffff);
00406 
00407                 <span class="keywordflow">break</span>;
00408 
00409             <span class="keywordflow">case</span> IMAGE_REL_BASED_ABSOLUTE :
00410                 <span class="comment">//</span>
00411                 <span class="comment">// Absolute - no fixup required.</span>
00412                 <span class="comment">//</span>
00413                 <span class="keywordflow">break</span>;
00414 
00415             <span class="keywordflow">case</span> IMAGE_REL_BASED_SECTION :
00416                 <span class="comment">//</span>
00417                 <span class="comment">// Section Relative reloc.  Ignore for now.</span>
00418                 <span class="comment">//</span>
00419                 <span class="keywordflow">break</span>;
00420 
00421             <span class="keywordflow">case</span> IMAGE_REL_BASED_REL32 :
00422                 <span class="comment">//</span>
00423                 <span class="comment">// Relative intrasection. Ignore for now.</span>
00424                 <span class="comment">//</span>
00425                 <span class="keywordflow">break</span>;
00426 
00427            <span class="keywordflow">case</span> IMAGE_REL_BASED_HIGH3ADJ :
00428                <span class="comment">//</span>
00429                <span class="comment">// Similar to HIGHADJ except this is the third word.</span>
00430                <span class="comment">//  Adjust low half of high dword of an address and adjust for</span>
00431                <span class="comment">//   sign extension of the low dword.</span>
00432                <span class="comment">//</span>
00433 
00434                Temp64 = *(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)FixupVA &lt;&lt; 16;
00435                ++NextOffset;
00436                --SizeOfBlock;
00437                Temp64 += (LONG)((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)NextOffset[1]);
00438                Temp64 &lt;&lt;= 16;
00439                Temp64 += (LONG)((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)NextOffset[0]);
00440                Temp64 += Diff;
00441                Temp64 += 0x8000;
00442                Temp64 &gt;&gt;=16;
00443                Temp64 += 0x8000;
00444                *(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)FixupVA = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(Temp64 &gt;&gt; 16);
00445                ++NextOffset;
00446                --SizeOfBlock;
00447                <span class="keywordflow">break</span>;
00448 
00449             <span class="keywordflow">default</span> :
00450                 <span class="comment">//</span>
00451                 <span class="comment">// Illegal - illegal relocation type.</span>
00452                 <span class="comment">//</span>
00453 
00454                 <span class="keywordflow">return</span> (PIMAGE_BASE_RELOCATION)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00455        }
00456        ++NextOffset;
00457     }
00458     <span class="keywordflow">return</span> (PIMAGE_BASE_RELOCATION)NextOffset;
00459 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="ldrreloc.c::LdrRelocateImage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG LdrRelocateImage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>NewBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>LoaderName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Success</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Conflict</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Invalid</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d2/ldrreloc_8c-source.html#l00091">91</a> of file <a class="el" href="../../d1/d2/ldrreloc_8c-source.html">ldrreloc.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d1/d2/ldrreloc_8c-source.html#l00194">LdrProcessRelocationBlock()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00085">PUSHORT</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00250">RtlImageDirectoryEntryToData()</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l01261">LdrpMapDll()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l05956">MiReloadBootLoadedDrivers()</a>.
<p>
<pre class="fragment"><div>00101                    :
00102 
00103     This routine relocates an image <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> that was not loaded into memory
00104     at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> preferred address.
00105 
00106 Arguments:
00107 
00108     NewBase - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image base.
00109 
00110     LoaderName - Indicates which loader routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being called from.
00111 
00112     Success - Value to <span class="keywordflow">return</span> <span class="keywordflow">if</span> relocation successful.
00113 
00114     Conflict - Value to <span class="keywordflow">return</span> <span class="keywordflow">if</span> can'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> relocate.
00115 
00116     Invalid - Value to <span class="keywordflow">return</span> <span class="keywordflow">if</span> relocations are invalid.
00117 
00118 Return Value:
00119 
00120     Success <span class="keywordflow">if</span> image <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> relocated.
00121     Conflict <span class="keywordflow">if</span> image can'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> be relocated.
00122     Invalid <span class="keywordflow">if</span> image contains invalid fixups.
00123 
00124 --*/
00125 
00126 {
00127     LONG_PTR Diff;
00128     ULONG TotalCountBytes;
00129     ULONG_PTR VA;
00130     ULONG_PTR OldBase;
00131     ULONG SizeOfBlock;
00132     PUCHAR FixupVA;
00133     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00134     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> NextOffset;
00135     PIMAGE_NT_HEADERS NtHeaders;
00136     PIMAGE_BASE_RELOCATION NextBlock;
00137 
00138     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00139 
00140     NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>( NewBase );
00141     <span class="keywordflow">if</span> ( NtHeaders ) {
00142         OldBase = NtHeaders-&gt;OptionalHeader.ImageBase;
00143         }
00144     <span class="keywordflow">else</span> {
00145         <span class="keywordflow">return</span> Invalid;
00146         }
00147 
00148     <span class="comment">//</span>
00149     <span class="comment">// Locate the relocation section.</span>
00150     <span class="comment">//</span>
00151 
00152     NextBlock = (PIMAGE_BASE_RELOCATION)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
00153             NewBase, TRUE, IMAGE_DIRECTORY_ENTRY_BASERELOC, &amp;TotalCountBytes);
00154 
00155     <span class="keywordflow">if</span> (!NextBlock || !TotalCountBytes) {
00156 
00157         <span class="comment">//</span>
00158         <span class="comment">// The image does not contain a relocation table, and therefore</span>
00159         <span class="comment">// cannot be relocated.</span>
00160         <span class="comment">//</span>
00161 <span class="preprocessor">#if DBG</span>
00162 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"%s: Image can't be relocated, no fixup information.\n"</span>, LoaderName);
00163 <span class="preprocessor">#endif // DBG</span>
00164 <span class="preprocessor"></span>        <span class="keywordflow">return</span> Conflict;
00165     }
00166 
00167     <span class="comment">//</span>
00168     <span class="comment">// If the image has a relocation table, then apply the specified fixup</span>
00169     <span class="comment">// information to the image.</span>
00170     <span class="comment">//</span>
00171 
00172     <span class="keywordflow">while</span> (TotalCountBytes) {
00173         SizeOfBlock = NextBlock-&gt;SizeOfBlock;
00174         TotalCountBytes -= SizeOfBlock;
00175         SizeOfBlock -= <span class="keyword">sizeof</span>(IMAGE_BASE_RELOCATION);
00176         SizeOfBlock /= <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>);
00177         NextOffset = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)((PCHAR)NextBlock + <span class="keyword">sizeof</span>(IMAGE_BASE_RELOCATION));
00178 
00179         VA = (ULONG_PTR)NewBase + NextBlock-&gt;VirtualAddress;
00180         Diff = (PCHAR)NewBase - (PCHAR)OldBase;
00181 
00182         <span class="keywordflow">if</span> ( !(NextBlock = <a class="code" href="../../d0/d3/ldrreloc_8c.html#a6">LdrProcessRelocationBlock</a>(VA,SizeOfBlock,NextOffset,Diff)) ) {
00183 <span class="preprocessor">#if DBG</span>
00184 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"%s: Unknown base relocation type\n"</span>, LoaderName);
00185 <span class="preprocessor">#endif</span>
00186 <span class="preprocessor"></span>            <span class="keywordflow">return</span> Invalid;
00187         }
00188     }
00189 
00190     <span class="keywordflow">return</span> Success;
00191 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:31 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
