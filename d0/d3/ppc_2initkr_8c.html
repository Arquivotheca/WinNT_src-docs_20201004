<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ppc/initkr.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>initkr.c File Reference</h1><code>#include "<a class="el" href="../../d1/d9/ki_8h-source.html">ki.h</a>"</code><br>

<p>
<a href="../../d1/d2/ppc_2initkr_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d3/ppc_2initkr_8c.html#a0">NumBats</a>&nbsp;&nbsp;&nbsp;3</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d3/ppc_2initkr_8c.html#a1">RoundDownTo8MB</a>(x)&nbsp;&nbsp;&nbsp;((x) &amp; ~(0x7fffff))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d3/ppc_2initkr_8c.html#a2">VirtBase</a>&nbsp;&nbsp;&nbsp;0xb0000000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d3/ppc_2initkr_8c.html#a3">EightMeg</a>(x)&nbsp;&nbsp;&nbsp;((x) &lt;&lt; 23)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d3/ppc_2initkr_8c.html#a7">KiPhase0SyncIoMap</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d3/ppc_2initkr_8c.html#a8">KiSetDbatInvalid</a> (IN ULONG Number)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d3/ppc_2initkr_8c.html#a9">KiSetDbat</a> (IN ULONG Number, IN ULONG PhysicalAddress, IN ULONG VirtualAddress, IN ULONG Length, IN ULONG Coherence)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d3/ppc_2initkr_8c.html#a10">KiInitExceptionFilter</a> (IN PEXCEPTION_POINTERS ExceptionPointers)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d3/ppc_2initkr_8c.html#a11">KiInitializeKernel</a> (IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process, IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread, IN PVOID IdleStack, IN PKPRCB Prcb, IN CCHAR Number, IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d3/ppc_2initkr_8c.html#a12">KePhase0MapIo</a> (IN PVOID PhysicalAddress, IN ULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d3/ppc_2initkr_8c.html#a13">KePhase0DeleteIoMap</a> (IN PVOID PhysicalAddress, IN ULONG Length)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap>struct {</td></tr>

<tr><td class="memItemLeft" nowrap>&nbsp;&nbsp;&nbsp;ULONG&nbsp;&nbsp;&nbsp;<a class="el" href="../../d0/d3/ppc_2initkr_8c.html#a4">PhysBase</a></td></tr>

<tr><td class="memItemLeft" nowrap>&nbsp;&nbsp;&nbsp;ULONG&nbsp;&nbsp;&nbsp;<a class="el" href="../../d0/d3/ppc_2initkr_8c.html#a5">RefCount</a></td></tr>

<tr><td class="memItemLeft" nowrap valign=top>}&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d3/ppc_2initkr_8c.html#a6">AllocatedBats</a> [NumBats]</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a3" doxytag="ppc/initkr.c::EightMeg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define EightMeg          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">x&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((x) &lt;&lt; 23)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00557">557</a> of file <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html">ppc/initkr.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00566">KePhase0MapIo()</a>, and <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00705">KiPhase0SyncIoMap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="ppc/initkr.c::NumBats" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define NumBats&nbsp;&nbsp;&nbsp;3          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00554">554</a> of file <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html">ppc/initkr.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00653">KePhase0DeleteIoMap()</a>, <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00566">KePhase0MapIo()</a>, and <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00705">KiPhase0SyncIoMap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="ppc/initkr.c::RoundDownTo8MB" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define RoundDownTo8MB          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">x&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((x) &amp; ~(0x7fffff))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00555">555</a> of file <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html">ppc/initkr.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00653">KePhase0DeleteIoMap()</a>, and <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00566">KePhase0MapIo()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="ppc/initkr.c::VirtBase" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define VirtBase&nbsp;&nbsp;&nbsp;0xb0000000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00556">556</a> of file <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html">ppc/initkr.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00566">KePhase0MapIo()</a>, and <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00705">KiPhase0SyncIoMap()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a13" doxytag="ppc/initkr.c::KePhase0DeleteIoMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KePhase0DeleteIoMap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>PhysicalAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00653">653</a> of file <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html">ppc/initkr.c</a>.
<p>
References <a class="el" href="../../d0/d3/ppc_2initkr_8c.html#a6">AllocatedBats</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00070">KeBugCheck()</a>, <a class="el" href="../../d0/d3/ppc_2initkr_8c.html#a8">KiSetDbatInvalid()</a>, <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00554">NumBats</a>, and <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00555">RoundDownTo8MB</a>.
<p>
<pre class="fragment"><div>00660                    :
00661 
00662     Removes a <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a> to <a class="code" href="../../d6/d8/udfstruc_8h.html#a129a115">Physical</a> address <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a46">translation</a> that was
00663     established with <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a12">KePhase0MapIo</a>.
00664 
00665 Arguments:
00666 
00667     PhysicalAddress - Address to which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/genxx_8h.html#a21">HAL</a> needs access.
00668 
00669     Length - Number of bytes.  (Ignored)
00670 
00671 Return Value:
00672 
00673     None.
00674 
00675 --*/
00676 
00677 {
00678     ULONG Base;
00679     LONG i;
00680 
00681     Base = <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a1">RoundDownTo8MB</a>((ULONG)PhysicalAddress);
00682 
00683     <span class="keywordflow">for</span> ( i = 0 ; i &lt; <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a0">NumBats</a> ; i++ ) {
00684         <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a6">AllocatedBats</a>[i].RefCount ) {
00685             <span class="keywordflow">if</span> ( Base == <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a6">AllocatedBats</a>[i].PhysBase ) {
00686                 <span class="comment">//  We have a match, detach from this bat</span>
00687                 <span class="keywordflow">if</span> ( --<a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a6">AllocatedBats</a>[i].RefCount == 0 ) {
00688                     <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a8">KiSetDbatInvalid</a>(i+1);
00689                 }
00690                 <span class="keywordflow">return</span>;
00691             }
00692         }
00693     }
00694 
00695     <span class="comment">// if we get here we were called to detach from memory</span>
00696     <span class="comment">// we don't have.  This is insane.</span>
00697 
00698     <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(MEMORY_MANAGEMENT);
00699 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="ppc/initkr.c::KePhase0MapIo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID KePhase0MapIo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>PhysicalAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00566">566</a> of file <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html">ppc/initkr.c</a>.
<p>
References <a class="el" href="../../d0/d3/ppc_2initkr_8c.html#a6">AllocatedBats</a>, <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00557">EightMeg</a>, <a class="el" href="../../d0/d3/ppc_2initkr_8c.html#a9">KiSetDbat()</a>, <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00554">NumBats</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00555">RoundDownTo8MB</a>, and <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00556">VirtBase</a>.
<p>
<pre class="fragment"><div>00573                    :
00574 
00575     Assign a <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a> to <a class="code" href="../../d6/d8/udfstruc_8h.html#a129a115">Physical</a> address <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a46">translation</a> <span class="keyword">using</span> PowerPC
00576     Block Address Translation registers <span class="keywordflow">for</span> use by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/genxx_8h.html#a21">HAL</a> prior to
00577     being able to achieve <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same thing <span class="keyword">using</span> MmMapIo.
00578 
00579     Up to three BATs can be used <span class="keywordflow">for</span> <span class="keyword">this</span> function.  This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00580     extremely simplistic.  It will attempt to assign <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> required
00581     address range within an existing BAT <span class="keyword">register</span> <span class="keywordflow">if</span> possible.  In
00582     deference to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> 601, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum range covered by a BAT <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00583     limited to 8MB.  On processors that support seperate Instruction
00584     and Data BATs, <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Data BAT will be set.  Caching in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00585     region <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> disabled.
00586 
00587     In <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first pass at <span class="keyword">this</span>, a full 8MB will be allocated.
00588 
00589     The <a class="code" href="../../d0/d2/genxx_8h.html#a21">HAL</a> should call <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a13">KePhase0DeleteIoMap</a> with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same parameters
00590     to release <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> BAT when <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> able to aquire <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same physical
00591     memory <span class="keyword">using</span> MM.
00592 
00593     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>:  This code <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> NOT applicable <span class="keywordflow">for</span> an MP solution.  Further
00594     study of <span class="keyword">this</span> problem <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required, specifically, a way of ensuring
00595     a change to BATs on one processor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> reflected on other processors.
00596 
00597 
00598 Arguments:
00599 
00600     PhysicalAddress - Address to which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/genxx_8h.html#a21">HAL</a> needs access.
00601 
00602     Length - Number of bytes.
00603 
00604 Return Value:
00605 
00606     <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a> address corresponding to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested physical address or 0
00607     <span class="keywordflow">if</span> unable to allocate.
00608 
00609 --*/
00610 
00611 {
00612     ULONG Base, <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00613     LONG i, FreeBat = -1;
00614 
00615     <span class="comment">//  The maximum allocation we allow is 8MB starting at an 8MB</span>
00616     <span class="comment">//  boundary.</span>
00617 
00618     Base = <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a1">RoundDownTo8MB</a>((ULONG)PhysicalAddress);
00619     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = (ULONG)PhysicalAddress - Base;
00620 
00621     <span class="comment">//  Chack length is acceptable</span>
00622 
00623     <span class="keywordflow">if</span> ( (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> + Length) &gt; 0x800000 ) {
00624         <span class="keywordflow">return</span> (PVOID)0;
00625     }
00626 
00627     <span class="keywordflow">for</span> ( i = 0 ; i &lt; <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a0">NumBats</a> ; i++ ) {
00628         <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a6">AllocatedBats</a>[i].RefCount ) {
00629             <span class="keywordflow">if</span> ( Base == <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a6">AllocatedBats</a>[i].PhysBase ) {
00630                 <span class="comment">//  We have a match, reuse this bat</span>
00631                 <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a6">AllocatedBats</a>[i].RefCount++;
00632                 <span class="keywordflow">return</span> (PVOID)(<a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a2">VirtBase</a> + <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a3">EightMeg</a>(i) + <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>);
00633             }
00634         } <span class="keywordflow">else</span> {
00635             <span class="comment">//  This index is not allocated, remember.</span>
00636             FreeBat = i;
00637         }
00638     }
00639 
00640     <span class="comment">//  No match, we need to allocate another bat (if one is available).</span>
00641 
00642     <span class="keywordflow">if</span> ( FreeBat == -1 ) {
00643         <span class="keywordflow">return</span> (PVOID)0;
00644     }
00645 
00646     <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a6">AllocatedBats</a>[FreeBat].PhysBase = Base;
00647     <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a6">AllocatedBats</a>[FreeBat].RefCount = 1;
00648     <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a9">KiSetDbat</a>(FreeBat + 1, Base, VirtBase + <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a3">EightMeg</a>(FreeBat), 0x800000, 6);
00649     <span class="keywordflow">return</span> (PVOID)(<a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a2">VirtBase</a> + <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a3">EightMeg</a>(FreeBat) + <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>);
00650 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="ppc/initkr.c::KiInitExceptionFilter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG KiInitExceptionFilter           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PEXCEPTION_POINTERS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ExceptionPointers</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00062">62</a> of file <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html">ppc/initkr.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>.
<p>
Referenced by <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00082">KiInitializeKernel()</a>.
<p>
<pre class="fragment"><div>00065 {
00066 <span class="preprocessor">#if DBG</span>
00067 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KE: Phase0 Exception Pointers = %x\n"</span>,ExceptionPointers);
00068     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Code %x Addr %lx Info0 %x Info1 %x Info2 %x Info3 %x\n"</span>,
00069         ExceptionPointers-&gt;ExceptionRecord-&gt;ExceptionCode,
00070         (ULONG)ExceptionPointers-&gt;ExceptionRecord-&gt;ExceptionAddress,
00071         ExceptionPointers-&gt;ExceptionRecord-&gt;ExceptionInformation[0],
00072         ExceptionPointers-&gt;ExceptionRecord-&gt;ExceptionInformation[1],
00073         ExceptionPointers-&gt;ExceptionRecord-&gt;ExceptionInformation[2],
00074         ExceptionPointers-&gt;ExceptionRecord-&gt;ExceptionInformation[3]
00075         );
00076     DbgBreakPoint();
00077 <span class="preprocessor">#endif</span>
00078 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>;
00079 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="ppc/initkr.c::KiInitializeKernel" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiInitializeKernel           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>IdleStack</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKPRCB&nbsp;</td>
          <td class="mdname" nowrap> <em>Prcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN CCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Number</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LoaderBlock</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00082">82</a> of file <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html">ppc/initkr.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l00869">_BOOT_STATUS::BootFinished</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01359">_RESTART_BLOCK::BootStatus</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00029">CcMasterSpinLock</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00075">CcVacbSpinLock</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00041">DBG_STATUS_CONTROL_C</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02496">DMA_READ_DCACHE_INVALIDATE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02498">DMA_WRITE_DCACHE_SNOOP</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d0/d0/ki_8h.html#a86">ExpInitializeExecutive()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d7/hal_8h.html#a196">HalInitializeProcessor()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00091">HIGH_LEVEL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d6/d5/4_2kdinit_8c-source.html#l00072">KdInitSystem()</a>, <a class="el" href="../../d8/d5/4_2kdlock_8c-source.html#l00093">KdPollBreakIn()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02766">KeActiveProcessors</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00070">KeBugCheck()</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02780">KeFeatureBits</a>, <a class="el" href="../../d4/d9/ke_8h.html#a374">KeFlushCurrentTb()</a>, <a class="el" href="../../d5/d0/dpcobj_8c-source.html#l00039">KeInitializeDpc()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00063">KeInitializeProcess()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l00043">KeInitializeThread()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02773">KeLoaderBlock</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02774">KeMaximumIncrement</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02776">KeNumberProcessors</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02777">KeProcessorArchitecture</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02778">KeProcessorLevel</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02779">KeProcessorRevision</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01838">KeSetPriorityThread()</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00127">KiAdjustDpcThreshold</a>, <a class="el" href="../../d0/d0/ki_8h.html#a97">KiApcInterrupt()</a>, <a class="el" href="../../d3/d9/kiinit_8c-source.html#l00237">KiComputeReciprocal()</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l01113">KiContextSwapLock</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l01095">KiDisableAlignmentExceptions</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00332">KiDispatcherLock</a>, <a class="el" href="../../d0/d0/ki_8h.html#a111">KiDispatchInterrupt()</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00301">KiDmaIoCoherency</a>, <a class="el" href="../../d6/d9/kernlini_8c.html#a43">KiGetFeatureBits()</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00044">KiIdleSummary</a>, <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00062">KiInitExceptionFilter()</a>, <a class="el" href="../../d3/d9/kiinit_8c-source.html#l00096">KiInitSystem()</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00125">KiMaximumDpcQueueDepth</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00126">KiMinimumDpcRate</a>, <a class="el" href="../../d0/d0/ki_8h.html#a129">KiPassiveRelease()</a>, <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00705">KiPhase0SyncIoMap()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02782">KiProcessorBlock</a>, <a class="el" href="../../d0/d0/ki_8h.html#a35">KiQuantumEnd</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00505">KiTimeIncrementReciprocal</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00512">KiTimeIncrementShiftCount</a>, <a class="el" href="../../d0/d0/ki_8h.html#a142">KiUnexpectedInterrupt()</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a75a63">LockQueueContextSwapLock</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a75a62">LockQueueDispatcherLock</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a75a67">LockQueueMasterLock</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a75a64">LockQueuePfnLock</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a75a65">LockQueueSystemSpaceLock</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a75a66">LockQueueVacbLock</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l01420">MAXIMUM_PROCESSORS</a>, <a class="el" href="../../d8/d1/alpha_2initkr_8c-source.html#l00039">MmPfnLock</a>, <a class="el" href="../../d5/d3/alpha_2splocks_8c-source.html#l00072">MmSystemSpaceLock</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00050">NIL</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d2/d2/ppcdef_8h-source.html#l00079">PASSIVE_LEVEL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00601">PDI_SHIFT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00266">PKDEFERRED_ROUTINE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00367">PKSTART_ROUTINE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00379">PKSYSTEM_ROUTINE</a>, <a class="el" href="../../d1/d2/po_8h.html#a57">PoInitializePrcb()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00177">PRCB_MAJOR_VERSION</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00176">PRCB_MINOR_VERSION</a>, <a class="el" href="../../d4/d9/ke_8h.html#a406a193">Running</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00065">SetMember</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>00093                    :
00094 
00095     This function gains <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system has been bootstrapped and
00096     before <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system has been initialized. Its function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to initialize
00097     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel data structures, initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> idle thread and process objects,
00098     initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block, call <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> executive initialization
00099     routine, and then <span class="keywordflow">return</span> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system startup routine. This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00100     also called to initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor specific structures when a <span class="keyword">new</span>
00101     processor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> brought on line.
00102 
00103 Arguments:
00104 
00105     Process - Supplies a pointer to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> process <span class="keywordflow">for</span>
00106         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified processor.
00107 
00108     Thread - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> thread <span class="keywordflow">for</span>
00109         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified processor.
00110 
00111     IdleStack - Supplies a pointer <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> real kernel stack <span class="keywordflow">for</span>
00112         idle thread on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified processor.
00113 
00114     Prcb - Supplies a pointer to a processor <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00115         processor.
00116 
00117     Number - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
00118         initialized.
00119 
00120     LoaderBlock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader parameter block.
00121 
00122 Return Value:
00123 
00124     None.
00125 
00126 --*/
00127 
00128 {
00129 
00130     LONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00131     KIRQL OldIrql;
00132     <a class="code" href="../../d5/d4/struct__RESTART__BLOCK.html">PRESTART_BLOCK</a> RestartBlock;
00133     KPCR *Pcr;
00134 
00135     <span class="comment">//</span>
00136     <span class="comment">// Before the hashed page table is set up, the PCR must be referred</span>
00137     <span class="comment">// to by its SPRG.1 address, not by its 0xffffd000 address.</span>
00138     <span class="comment">//</span>
00139 
00140     Pcr = (PKPCR)PCRsprg1;
00141 
00142 <span class="preprocessor">#if !defined(NT_UP)</span>
00143 <span class="preprocessor"></span>
00144     <span class="keywordflow">if</span> (Number != 0) {
00145         <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a7">KiPhase0SyncIoMap</a>();
00146     }
00147 
00148 <span class="preprocessor">#endif</span>
00149 <span class="preprocessor"></span>
00150     <span class="comment">//</span>
00151     <span class="comment">// Set processor version and revision in PCR</span>
00152     <span class="comment">//</span>
00153 
00154     Pcr-&gt;ProcessorRevision = KeGetPvr() &amp; 0xFFFF;
00155     Pcr-&gt;ProcessorVersion = (KeGetPvr() &gt;&gt; 16);
00156 
00157     <span class="comment">//</span>
00158     <span class="comment">// Set global processor architecture, level and revision.  The</span>
00159     <span class="comment">// latter two are the least common denominator on an MP system.</span>
00160     <span class="comment">//</span>
00161 
00162     <a class="code" href="../../d4/d9/ke_8h.html#a134">KeProcessorArchitecture</a> = PROCESSOR_ARCHITECTURE_PPC;
00163     <a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> = 0;
00164     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a135">KeProcessorLevel</a> == 0 ||
00165         <a class="code" href="../../d4/d9/ke_8h.html#a135">KeProcessorLevel</a> &gt; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Pcr-&gt;ProcessorVersion
00166        ) {
00167         <a class="code" href="../../d4/d9/ke_8h.html#a135">KeProcessorLevel</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Pcr-&gt;ProcessorVersion;
00168     }
00169     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a136">KeProcessorRevision</a> == 0 ||
00170         <a class="code" href="../../d4/d9/ke_8h.html#a136">KeProcessorRevision</a> &gt; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Pcr-&gt;ProcessorRevision
00171        ) {
00172         <a class="code" href="../../d4/d9/ke_8h.html#a136">KeProcessorRevision</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Pcr-&gt;ProcessorRevision;
00173     }
00174 
00175     <span class="comment">//</span>
00176     <span class="comment">// Perform platform dependent processor initialization.</span>
00177     <span class="comment">//</span>
00178 
00179     <a class="code" href="../../d2/d7/hal_8h.html#a196">HalInitializeProcessor</a>(Number);
00180     HalSweepIcache();
00181 
00182     <span class="comment">//</span>
00183     <span class="comment">// Save the address of the loader parameter block.</span>
00184     <span class="comment">//</span>
00185 
00186     <a class="code" href="../../d4/d9/ke_8h.html#a130">KeLoaderBlock</a> = LoaderBlock;
00187 
00188     <span class="comment">//</span>
00189     <span class="comment">// Initialize the processor block.</span>
00190     <span class="comment">//</span>
00191 
00192     Prcb-&gt;MinorVersion = <a class="code" href="../../d6/d7/halmips_8h.html#a101">PRCB_MINOR_VERSION</a>;
00193     Prcb-&gt;MajorVersion = <a class="code" href="../../d6/d7/halmips_8h.html#a102">PRCB_MAJOR_VERSION</a>;
00194     Prcb-&gt;BuildType = 0;
00195 
00196 <span class="preprocessor">#if DBG</span>
00197 <span class="preprocessor"></span>
00198     Prcb-&gt;BuildType |= PRCB_BUILD_DEBUG;
00199 
00200 <span class="preprocessor">#endif</span>
00201 <span class="preprocessor"></span>
00202 <span class="preprocessor">#if defined(NT_UP)</span>
00203 <span class="preprocessor"></span>
00204     Prcb-&gt;BuildType |= PRCB_BUILD_UNIPROCESSOR;
00205 
00206 <span class="preprocessor">#endif</span>
00207 <span class="preprocessor"></span>
00208     Prcb-&gt;CurrentThread = Thread;
00209     Prcb-&gt;NextThread = (<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00210     Prcb-&gt;IdleThread = Thread;
00211     Prcb-&gt;SetMember = 1 &lt;&lt; Number;
00212     Prcb-&gt;PcrPage = LoaderBlock-&gt;u.Ppc.PcrPage;
00213     Prcb-&gt;ProcessorState.SpecialRegisters.Sprg0 =
00214                     LoaderBlock-&gt;u.Ppc.PcrPage &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00215     Prcb-&gt;ProcessorState.SpecialRegisters.Sprg1 = (ULONG)Pcr;
00216 
00217 <span class="preprocessor">#if !defined(NT_UP)</span>
00218 <span class="preprocessor"></span>
00219     Prcb-&gt;TargetSet = 0;
00220     Prcb-&gt;WorkerRoutine = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00221     Prcb-&gt;RequestSummary = 0;
00222     Prcb-&gt;IpiFrozen = 0;
00223 
00224 <span class="preprocessor">#if NT_INST</span>
00225 <span class="preprocessor"></span>
00226     Prcb-&gt;IpiCounts = &amp;KiIpiCounts[Number];
00227 
00228 <span class="preprocessor">#endif</span>
00229 <span class="preprocessor"></span>
00230 <span class="preprocessor">#endif</span>
00231 <span class="preprocessor"></span>
00232     Prcb-&gt;MaximumDpcQueueDepth = <a class="code" href="../../d8/d0/cmdat3_8c.html#a64">KiMaximumDpcQueueDepth</a>;
00233     Prcb-&gt;MinimumDpcRate = <a class="code" href="../../d8/d0/cmdat3_8c.html#a65">KiMinimumDpcRate</a>;
00234     Prcb-&gt;AdjustDpcThreshold = <a class="code" href="../../d8/d0/cmdat3_8c.html#a66">KiAdjustDpcThreshold</a>;
00235 
00236     <span class="comment">//</span>
00237     <span class="comment">// Initialize DPC listhead and lock.</span>
00238     <span class="comment">//</span>
00239 
00240     InitializeListHead(&amp;Prcb-&gt;DpcListHead);
00241     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;Prcb-&gt;DpcLock);
00242 
00243     <span class="comment">//</span>
00244     <span class="comment">// Set address of processor block.</span>
00245     <span class="comment">//</span>
00246 
00247     <a class="code" href="../../d4/d9/ke_8h.html#a139">KiProcessorBlock</a>[Number] = Prcb;
00248 
00249     <span class="comment">//</span>
00250     <span class="comment">// Initialize the idle thread initial kernel stack value.</span>
00251     <span class="comment">//</span>
00252 
00253     Pcr-&gt;InitialStack = IdleStack;
00254     Pcr-&gt;StackLimit = (PVOID)((ULONG)IdleStack - KERNEL_STACK_SIZE);
00255 
00256     <span class="comment">//</span>
00257     <span class="comment">// Initialize all interrupt vectors to transfer control to the unexpected</span>
00258     <span class="comment">// interrupt routine.</span>
00259     <span class="comment">//</span>
00260     <span class="comment">// N.B. This interrupt object is never actually "connected" to an interrupt</span>
00261     <span class="comment">//      vector via KeConnectInterrupt. It is initialized and then connected</span>
00262     <span class="comment">//      by simply storing the address of the dispatch code in the interrupt</span>
00263     <span class="comment">//      vector.</span>
00264     <span class="comment">//</span>
00265 
00266     <span class="keywordflow">if</span> (Number == 0) {
00267 
00268         <span class="comment">//</span>
00269         <span class="comment">// Initial the address of the interrupt dispatch routine.</span>
00270         <span class="comment">//</span>
00271 
00272         KxUnexpectedInterrupt.DispatchAddress = <a class="code" href="../../d0/d0/ki_8h.html#a142">KiUnexpectedInterrupt</a>;
00273 
00274         <span class="comment">//</span>
00275         <span class="comment">// Copy the interrupt dispatch function descriptor into the interrupt</span>
00276         <span class="comment">// object.</span>
00277         <span class="comment">//</span>
00278 
00279         KxUnexpectedInterrupt.DispatchCode[0] =
00280                 *(PULONG)(KxUnexpectedInterrupt.DispatchAddress);
00281         KxUnexpectedInterrupt.DispatchCode[1] =
00282                 *(((PULONG)(KxUnexpectedInterrupt.DispatchAddress))+1);
00283 
00284         <span class="comment">//</span>
00285         <span class="comment">// Initialize the context swap spinlock.</span>
00286         <span class="comment">//</span>
00287 
00288         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;KiContextSwapLock);
00289 
00290         <span class="comment">//</span>
00291         <span class="comment">// Set the default DMA I/O coherency attributes.  PowerPC</span>
00292         <span class="comment">// architecture dictates that the D-Cache is fully coherent</span>
00293         <span class="comment">// but the I-Cache doesn't snoop.</span>
00294         <span class="comment">//</span>
00295 
00296         <a class="code" href="../../d5/d9/kernldat_8c.html#a34">KiDmaIoCoherency</a> = <a class="code" href="../../d4/d9/ke_8h.html#a40">DMA_READ_DCACHE_INVALIDATE</a> | <a class="code" href="../../d4/d9/ke_8h.html#a42">DMA_WRITE_DCACHE_SNOOP</a>;
00297     }
00298 
00299     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; MAXIMUM_VECTOR; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00300         Pcr-&gt;InterruptRoutine[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] =
00301                     (PKINTERRUPT_ROUTINE)(&amp;KxUnexpectedInterrupt.DispatchCode);
00302     }
00303 
00304     <span class="comment">//</span>
00305     <span class="comment">// Initialize the profile count and interval.</span>
00306     <span class="comment">//</span>
00307 
00308     Pcr-&gt;ProfileCount = 0;
00309     Pcr-&gt;ProfileInterval = 0x200000;
00310 
00311     <span class="comment">//</span>
00312     <span class="comment">// Initialize the passive release, APC, and DPC interrupt vectors.</span>
00313     <span class="comment">//</span>
00314 
00315     Pcr-&gt;InterruptRoutine[0] = <a class="code" href="../../d0/d0/ki_8h.html#a142">KiUnexpectedInterrupt</a>;
00316 <span class="comment">//  Pcr-&gt;InterruptRoutine[APC_LEVEL] = KiApcInterrupt;</span>
00317 <span class="comment">//  Pcr-&gt;InterruptRoutine[DISPATCH_LEVEL] = KiDispatchInterrupt;</span>
00318 
00319     <span class="comment">// on PowerPC APC and Dispatch Level interrupts are handled explicitly</span>
00320     <span class="comment">// so handle calls thru the dispatch table as no-ops.</span>
00321 
00322     Pcr-&gt;InterruptRoutine[<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>] = <a class="code" href="../../d0/d0/ki_8h.html#a142">KiUnexpectedInterrupt</a>;
00323     Pcr-&gt;InterruptRoutine[<a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>] = <a class="code" href="../../d0/d0/ki_8h.html#a142">KiUnexpectedInterrupt</a>;
00324 
00325     Pcr-&gt;ReservedVectors = (1 &lt;&lt; <a class="code" href="../../d1/d3/ppcdef_8h.html#a21">PASSIVE_LEVEL</a>) |
00326                            (1 &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>)     |
00327                            (1 &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00328 
00329     <span class="comment">//</span>
00330     <span class="comment">// Initialize the set member for the current processor, set IRQL to</span>
00331     <span class="comment">// APC_LEVEL, and set the processor number.</span>
00332     <span class="comment">//</span>
00333 
00334     Pcr-&gt;CurrentIrql = <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>;
00335     Pcr-&gt;SetMember = 1 &lt;&lt; Number;
00336     Pcr-&gt;NotMember = ~Pcr-&gt;SetMember;
00337     Pcr-&gt;Number = Number;
00338 
00339     <span class="comment">//</span>
00340     <span class="comment">// Set the initial stall execution scale factor. This value will be</span>
00341     <span class="comment">// recomputed later by the HAL.</span>
00342     <span class="comment">//</span>
00343 
00344     Pcr-&gt;StallScaleFactor = 50;
00345 
00346     <span class="comment">//</span>
00347     <span class="comment">// Set address of process object in thread object.</span>
00348     <span class="comment">//</span>
00349 
00350     Thread-&gt;ApcState.Process = Process;
00351 
00352     <span class="comment">//</span>
00353     <span class="comment">// Set the appropriate member in the active processors set.</span>
00354     <span class="comment">//</span>
00355 
00356     <a class="code" href="../../d0/d0/ki_8h.html#a7">SetMember</a>(Number, KeActiveProcessors);
00357 
00358     <span class="comment">//</span>
00359     <span class="comment">// Set the number of processors based on the maximum of the current</span>
00360     <span class="comment">// number of processors and the current processor number.</span>
00361     <span class="comment">//</span>
00362 
00363     <span class="keywordflow">if</span> ((Number + 1) &gt; <a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>) {
00364         <a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a> = Number + 1;
00365     }
00366 
00367     <span class="comment">//</span>
00368     <span class="comment">// If the initial processor is being initialized, then initialize the</span>
00369     <span class="comment">// per system data structures.</span>
00370     <span class="comment">//</span>
00371 
00372     <span class="keywordflow">if</span> (Number == 0) {
00373 
00374         <span class="comment">//</span>
00375         <span class="comment">// Initialize the kernel debugger.</span>
00376         <span class="comment">//</span>
00377 
00378         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/4_2kdinit_8c.html#a4">KdInitSystem</a>(LoaderBlock, FALSE) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00379             <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(PHASE0_INITIALIZATION_FAILED);
00380         }
00381 
00382         <span class="comment">//</span>
00383         <span class="comment">// Sweep both the D and the I caches.</span>
00384         <span class="comment">//</span>
00385 
00386         HalSweepDcache();
00387         HalSweepIcache();
00388 
00389         <span class="comment">//</span>
00390         <span class="comment">// Ensure there are NO stale entries in the TLB by</span>
00391         <span class="comment">// flushing the HPT/TLB even though the HPT is fresh.</span>
00392         <span class="comment">//</span>
00393 
00394         <a class="code" href="../../d4/d9/ke_8h.html#a374">KeFlushCurrentTb</a>();
00395 
00396 <span class="preprocessor">#if DBG</span>
00397 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((PCR-&gt;IcacheMode) || (PCR-&gt;DcacheMode))
00398         {
00399                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"******  Dynamic Cache Mode Kernel Invocation\n"</span>);
00400                 <span class="keywordflow">if</span> (PCR-&gt;IcacheMode)
00401                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"******  Icache is OFF\n"</span>);
00402                 <span class="keywordflow">if</span> (PCR-&gt;DcacheMode)
00403                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"******  Dcache is OFF\n"</span>);
00404         }
00405 <span class="preprocessor">#endif</span>
00406 <span class="preprocessor"></span>
00407         <span class="comment">//</span>
00408         <span class="comment">// Initialize the address of the restart block for the boot master.</span>
00409         <span class="comment">//</span>
00410 
00411         Prcb-&gt;RestartBlock = SYSTEM_BLOCK-&gt;RestartBlock;
00412 
00413         <span class="comment">//</span>
00414         <span class="comment">// Initialize processor block array.</span>
00415         <span class="comment">//</span>
00416 
00417         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 1; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d9/d5/ndismain_8h.html#a183">MAXIMUM_PROCESSORS</a>; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00418             <a class="code" href="../../d4/d9/ke_8h.html#a139">KiProcessorBlock</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = (PKPRCB)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00419         }
00420 
00421         <span class="comment">//</span>
00422         <span class="comment">// Perform architecture independent initialization.</span>
00423         <span class="comment">//</span>
00424 
00425         <a class="code" href="../../d2/d0/kiinit_8c.html#a1">KiInitSystem</a>();
00426 
00427         <span class="comment">//</span>
00428         <span class="comment">// Initialize idle thread process object and then set:</span>
00429         <span class="comment">//</span>
00430         <span class="comment">//      1. all the quantum values to the maximum possible.</span>
00431         <span class="comment">//      2. the process in the balance set.</span>
00432         <span class="comment">//      3. the active processor mask to the specified processor.</span>
00433         <span class="comment">//</span>
00434 
00435         <a class="code" href="../../d3/d5/procobj_8c.html#a3">KeInitializeProcess</a>(Process,
00436                             (KPRIORITY)0,
00437                             (KAFFINITY)(0xffffffff),
00438                             (PULONG)(PDE_BASE + ((PDE_BASE &gt;&gt; PDI_SHIFT - 2) &amp; 0xffc)),
00439                             FALSE);
00440 
00441         Process-&gt;ThreadQuantum = MAXCHAR;
00442 
00443     }
00444 
00445     <span class="comment">//</span>
00446     <span class="comment">// Initialize idle thread object and then set:</span>
00447     <span class="comment">//</span>
00448     <span class="comment">//      1. the initial kernel stack to the specified idle stack.</span>
00449     <span class="comment">//      2. the next processor number to the specified processor.</span>
00450     <span class="comment">//      3. the thread priority to the highest possible value.</span>
00451     <span class="comment">//      4. the state of the thread to running.</span>
00452     <span class="comment">//      5. the thread affinity to the specified processor.</span>
00453     <span class="comment">//      6. the specified processor member in the process active processors</span>
00454     <span class="comment">//          set.</span>
00455     <span class="comment">//</span>
00456 
00457     <a class="code" href="../../d9/d1/thredobj_8c.html#a1">KeInitializeThread</a>(Thread, (PVOID)((ULONG)IdleStack - PAGE_SIZE),
00458                        (PKSYSTEM_ROUTINE)KeBugCheck,
00459                        (PKSTART_ROUTINE)NULL,
00460                        (PVOID)NULL, (PCONTEXT)NULL, (PVOID)NULL, Process);
00461 
00462     Thread-&gt;InitialStack = IdleStack;
00463     Thread-&gt;StackBase = IdleStack;
00464     Thread-&gt;StackLimit = (PVOID)((ULONG)IdleStack - KERNEL_STACK_SIZE);
00465     Thread-&gt;NextProcessor = Number;
00466     Thread-&gt;Priority = HIGH_PRIORITY;
00467     Thread-&gt;State = <a class="code" href="../../d4/d9/ke_8h.html#a406a193">Running</a>;
00468     Thread-&gt;Affinity = (KAFFINITY)(1 &lt;&lt; Number);
00469     Thread-&gt;WaitIrql = <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>;
00470 
00471     <span class="comment">//</span>
00472     <span class="comment">// If the current processor is 0, then set the appropriate bit in the</span>
00473     <span class="comment">// active summary of the idle process.</span>
00474     <span class="comment">//</span>
00475 
00476     <span class="keywordflow">if</span> (Number == 0) {
00477         <a class="code" href="../../d0/d0/ki_8h.html#a7">SetMember</a>(Number, Process-&gt;ActiveProcessors);
00478     }
00479 
00480     <span class="comment">//</span>
00481     <span class="comment">// Execute the executive initialization.</span>
00482     <span class="comment">//</span>
00483 
00484     <span class="keywordflow">try</span> {
00485         <a class="code" href="../../d0/d0/ki_8h.html#a86">ExpInitializeExecutive</a>(Number, LoaderBlock);
00486 
00487     } except (<a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a10">KiInitExceptionFilter</a>(GetExceptionInformation())) {
00488         <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a> (PHASE0_EXCEPTION);
00489     }
00490 
00491     <span class="comment">//</span>
00492     <span class="comment">// If the initial processor is being initialized, then compute the</span>
00493     <span class="comment">// timer table reciprocal value and reset the PRCB values for the</span>
00494     <span class="comment">// controllable DPC behavior in order to reflect any registry</span>
00495     <span class="comment">// overrides.</span>
00496     <span class="comment">//</span>
00497 
00498     <span class="keywordflow">if</span> (Number == 0) {
00499         <a class="code" href="../../d5/d9/kernldat_8c.html#a59">KiTimeIncrementReciprocal</a> = <a class="code" href="../../d2/d0/kiinit_8c.html#a2">KiComputeReciprocal</a>((LONG)KeMaximumIncrement,
00500                                                         &amp;KiTimeIncrementShiftCount);
00501         Prcb-&gt;MaximumDpcQueueDepth = <a class="code" href="../../d8/d0/cmdat3_8c.html#a64">KiMaximumDpcQueueDepth</a>;
00502         Prcb-&gt;MinimumDpcRate = <a class="code" href="../../d8/d0/cmdat3_8c.html#a65">KiMinimumDpcRate</a>;
00503         Prcb-&gt;AdjustDpcThreshold = <a class="code" href="../../d8/d0/cmdat3_8c.html#a66">KiAdjustDpcThreshold</a>;
00504     }
00505 
00506     <span class="comment">//</span>
00507     <span class="comment">// Raise IRQL to dispatch level and set the priority of the idle thread</span>
00508     <span class="comment">// to zero. This will have the effect of immediately causing the phase</span>
00509     <span class="comment">// one initialization thread to get scheduled for execution. The idle</span>
00510     <span class="comment">// thread priority is then set to the lowest realtime priority. This is</span>
00511     <span class="comment">// necessary so that mutexes aquired at DPC level do not cause the active</span>
00512     <span class="comment">// matrix to get corrupted.</span>
00513     <span class="comment">//</span>
00514 
00515     KeRaiseIrqlToDpcLevel(&amp;OldIrql);
00516     <a class="code" href="../../d9/d1/thredobj_8c.html#a24">KeSetPriorityThread</a>(Thread, (KPRIORITY)0);
00517     Thread-&gt;Priority = LOW_REALTIME_PRIORITY;
00518 
00519     <span class="comment">//</span>
00520     <span class="comment">// Raise IRQL to the highest level.</span>
00521     <span class="comment">//</span>
00522 
00523     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(HIGH_LEVEL, &amp;OldIrql);
00524 
00525     <span class="comment">//</span>
00526     <span class="comment">// If a restart block exists for the current process, then set boot</span>
00527     <span class="comment">// completed.</span>
00528     <span class="comment">//</span>
00529     <span class="comment">// N.B. Firmware on uniprocessor machines configured for MP operation</span>
00530     <span class="comment">//      can have a restart block address of NULL.</span>
00531     <span class="comment">//</span>
00532 
00533 <span class="preprocessor">#if !defined(NT_UP)</span>
00534 <span class="preprocessor"></span>
00535     RestartBlock = Prcb-&gt;RestartBlock;
00536     <span class="keywordflow">if</span> (RestartBlock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00537         RestartBlock-&gt;<a class="code" href="../../d5/d4/struct__RESTART__BLOCK.html#o8">BootStatus</a>.<a class="code" href="../../d8/d4/struct__BOOT__STATUS.html#o1">BootFinished</a> = 1;
00538     }
00539 
00540     <span class="comment">//</span>
00541     <span class="comment">// If the current processor is not 0, then set the appropriate bit in</span>
00542     <span class="comment">// idle summary.</span>
00543     <span class="comment">//</span>
00544 
00545     <span class="keywordflow">if</span> (Number != 0) {
00546         <a class="code" href="../../d0/d0/ki_8h.html#a7">SetMember</a>(Number, KiIdleSummary);
00547     }
00548 
00549 <span class="preprocessor">#endif</span>
00550 <span class="preprocessor"></span>
00551     <span class="keywordflow">return</span>;
00552 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="ppc/initkr.c::KiPhase0SyncIoMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiPhase0SyncIoMap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00705">705</a> of file <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html">ppc/initkr.c</a>.
<p>
References <a class="el" href="../../d0/d3/ppc_2initkr_8c.html#a6">AllocatedBats</a>, <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00557">EightMeg</a>, <a class="el" href="../../d0/d3/ppc_2initkr_8c.html#a9">KiSetDbat()</a>, <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00554">NumBats</a>, <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00561">PhysBase</a>, and <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00556">VirtBase</a>.
<p>
Referenced by <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00082">KiInitializeKernel()</a>.
<p>
<pre class="fragment"><div>00711                    :
00712 
00713     This routine runs on all processors other than zero to
00714     ensure that all processors have <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same Block Address
00715     Translations (BATs) established during phase 0.
00716 
00717 Arguments:
00718 
00719     None.
00720 
00721 Return Value:
00722 
00723     None.
00724 
00725 --*/
00726 
00727 {
00728     LONG i;
00729 
00730     <span class="keywordflow">for</span> ( i = 0 ; i &lt; <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a0">NumBats</a> ; i++ ) {
00731         <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a6">AllocatedBats</a>[i].RefCount ) {
00732             <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a9">KiSetDbat</a>(i + 1,
00733                       AllocatedBats[i].PhysBase,
00734                       VirtBase + <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a3">EightMeg</a>(i),
00735                       0x800000,
00736                       6);
00737         }
00738     }
00739 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="ppc/initkr.c::KiSetDbat" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiSetDbat           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Number</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PhysicalAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>VirtualAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Coherence</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00566">KePhase0MapIo()</a>, and <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00705">KiPhase0SyncIoMap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="ppc/initkr.c::KiSetDbatInvalid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiSetDbatInvalid           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Number</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00653">KePhase0DeleteIoMap()</a>.    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a6" doxytag="ppc/initkr.c::AllocatedBats" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> struct { ... }   <a class="el" href="../../d0/d3/ppc_2initkr_8c.html#a6">AllocatedBats</a>[NumBats]<code> [static]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00653">KePhase0DeleteIoMap()</a>, <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00566">KePhase0MapIo()</a>, and <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00705">KiPhase0SyncIoMap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="ppc/initkr.c::PhysBase" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d0/d3/ppc_2initkr_8c.html#a4">PhysBase</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00561">561</a> of file <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html">ppc/initkr.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00705">KiPhase0SyncIoMap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="ppc/initkr.c::RefCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d0/d3/ppc_2initkr_8c.html#a5">RefCount</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00562">562</a> of file <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html">ppc/initkr.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/super_8c-source.html#l00056">NtCreateSuperSection()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00406">NtWaitForMultipleObjects()</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l00944">RtlCreateTimer()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:12 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
