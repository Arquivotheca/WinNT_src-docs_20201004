<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: rules.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>rules.c</h1><a href="../../d9/d3/rules_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1998  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment"></span>
00006 <span class="comment">Module Name:</span>
00007 <span class="comment"></span>
00008 <span class="comment">    rules.c</span>
00009 <span class="comment"></span>
00010 <span class="comment">Abstract:</span>
00011 <span class="comment"></span>
00012 <span class="comment">    This modules contains routines to implement rules to describe a machine.</span>
00013 <span class="comment">    This is based on the detection code from W9x.</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Santosh Jodh (santoshj) 08-Aug-1998</span>
00018 <span class="comment"></span>
00019 <span class="comment">Environment:</span>
00020 <span class="comment"></span>
00021 <span class="comment">    Kernel mode.</span>
00022 <span class="comment"></span>
00023 <span class="comment">Revision History:</span>
00024 <span class="comment"></span>
00025 <span class="comment">--*/</span>
00026 
00027 <span class="preprocessor">#include "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00028 <span class="preprocessor">#include "stdlib.h"</span>
00029 <span class="preprocessor">#include "<a class="code" href="../../d6/d3/parseini_8h.html">parseini.h</a>"</span>
00030 <span class="preprocessor">#include "<a class="code" href="../../d9/d0/geninst_8h.html">geninst.h</a>"</span>
00031 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/rules_8h.html">rules.h</a>"</span>
00032 <span class="preprocessor">#include "<a class="code" href="../../d5/d4/acpitabl_8h.html">acpitabl.h</a>"</span>
00033 <span class="preprocessor">#include "<a class="code" href="../../d6/d7/ntacpi_8h.html">ntacpi.h</a>"</span>
00034 
<a name="l00035"></a><a class="code" href="../../d9/d3/rules_8c.html#a0">00035</a> <span class="preprocessor">#define TABLE_ENTRIES_FROM_RSDT_POINTER(p)  (((p)-&gt;Header.Length-min((p)-&gt;Header.Length, sizeof(DESCRIPTION_HEADER))) / 4)</span>
00036 <span class="preprocessor"></span>
00037 
00038 <span class="comment">//</span>
00039 <span class="comment">// Size of the ROM BIOS segment.</span>
00040 <span class="comment">//</span>
00041 
<a name="l00042"></a><a class="code" href="../../d9/d3/rules_8c.html#a1">00042</a> <span class="preprocessor">#define SYSTEM_BIOS_LENGTH 0x10000</span>
00043 <span class="preprocessor"></span>
00044 <span class="comment">//</span>
00045 <span class="comment">// PnP BIOS structure signature.</span>
00046 <span class="comment">//</span>
00047 
<a name="l00048"></a><a class="code" href="../../d9/d3/rules_8c.html#a2">00048</a> <span class="preprocessor">#define PNPBIOS_SIGNATURE   'PnP$'</span>
00049 <span class="preprocessor"></span>
00050 <span class="keyword">typedef</span>
00051 BOOLEAN
<a name="l00052"></a><a class="code" href="../../d9/d3/rules_8c.html#a4">00052</a> (* PFN_RULE)(
00053     IN PVOID InfHandle,
00054     IN PCHAR <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>,
00055     IN ULONG RuleIndex
00056     );
00057 
<a name="l00058"></a><a class="code" href="../../d9/d3/rules_8c.html#a5">00058</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d7/d6/struct__PNP__BIOS__TABLE.html">_PNP_BIOS_TABLE</a> PNP_BIOS_TABLE, *<a class="code" href="../../d9/d3/rules_8c.html#a5">PPNP_BIOS_TABLE</a>;
00059 
00060 <span class="preprocessor">#pragma pack(push, 1)</span>
00061 <span class="preprocessor"></span>
<a name="l00062"></a><a class="code" href="../../d7/d6/struct__PNP__BIOS__TABLE.html">00062</a> <span class="keyword">struct </span><a class="code" href="../../d7/d6/struct__PNP__BIOS__TABLE.html">_PNP_BIOS_TABLE</a>
00063 {
<a name="l00064"></a><a class="code" href="../../d7/d6/struct__PNP__BIOS__TABLE.html#o0">00064</a>     ULONG   <a class="code" href="../../d7/d6/struct__PNP__BIOS__TABLE.html#o0">Signature</a>;
<a name="l00065"></a><a class="code" href="../../d7/d6/struct__PNP__BIOS__TABLE.html#o1">00065</a>     UCHAR   <a class="code" href="../../d7/d6/struct__PNP__BIOS__TABLE.html#o1">Version</a>;
<a name="l00066"></a><a class="code" href="../../d7/d6/struct__PNP__BIOS__TABLE.html#o2">00066</a>     UCHAR   <a class="code" href="../../d7/d6/struct__PNP__BIOS__TABLE.html#o2">Length</a>;
<a name="l00067"></a><a class="code" href="../../d7/d6/struct__PNP__BIOS__TABLE.html#o3">00067</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>  <a class="code" href="../../d7/d6/struct__PNP__BIOS__TABLE.html#o3">ControlField</a>;
<a name="l00068"></a><a class="code" href="../../d7/d6/struct__PNP__BIOS__TABLE.html#o4">00068</a>     UCHAR   <a class="code" href="../../d7/d6/struct__PNP__BIOS__TABLE.html#o4">CheckSum</a>;
<a name="l00069"></a><a class="code" href="../../d7/d6/struct__PNP__BIOS__TABLE.html#o5">00069</a>     ULONG   <a class="code" href="../../d7/d6/struct__PNP__BIOS__TABLE.html#o5">EventNotification</a>;
<a name="l00070"></a><a class="code" href="../../d7/d6/struct__PNP__BIOS__TABLE.html#o6">00070</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>  <a class="code" href="../../d7/d6/struct__PNP__BIOS__TABLE.html#o6">RMOffset</a>;
<a name="l00071"></a><a class="code" href="../../d7/d6/struct__PNP__BIOS__TABLE.html#o7">00071</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>  <a class="code" href="../../d7/d6/struct__PNP__BIOS__TABLE.html#o7">RMSegment</a>;
<a name="l00072"></a><a class="code" href="../../d7/d6/struct__PNP__BIOS__TABLE.html#o8">00072</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>  <a class="code" href="../../d7/d6/struct__PNP__BIOS__TABLE.html#o8">PMOffset</a>;
<a name="l00073"></a><a class="code" href="../../d7/d6/struct__PNP__BIOS__TABLE.html#o9">00073</a>     ULONG   <a class="code" href="../../d7/d6/struct__PNP__BIOS__TABLE.html#o9">PMSegment</a>;
<a name="l00074"></a><a class="code" href="../../d7/d6/struct__PNP__BIOS__TABLE.html#o10">00074</a>     ULONG   <a class="code" href="../../d7/d6/struct__PNP__BIOS__TABLE.html#o10">Oem</a>;
<a name="l00075"></a><a class="code" href="../../d7/d6/struct__PNP__BIOS__TABLE.html#o11">00075</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>  <a class="code" href="../../d7/d6/struct__PNP__BIOS__TABLE.html#o11">RMData</a>;
<a name="l00076"></a><a class="code" href="../../d7/d6/struct__PNP__BIOS__TABLE.html#o12">00076</a>     ULONG   <a class="code" href="../../d7/d6/struct__PNP__BIOS__TABLE.html#o12">PMData</a>;
00077 };
00078 
00079 <span class="preprocessor">#pragma pack(pop)</span>
00080 <span class="preprocessor"></span>
00081 ULONG
00082 <a class="code" href="../../d9/d3/rules_8c.html#a14">CmpComputeChecksum</a>(
00083     IN PCHAR    Address,
00084     IN ULONG    Size
00085     );
00086 
00087 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00088 <a class="code" href="../../d9/d3/rules_8c.html#a15">CmpFindRSDTTable</a>(
00089     OUT <a class="code" href="../../d4/d5/struct__ACPI__BIOS__MULTI__NODE.html">PACPI_BIOS_MULTI_NODE</a>   *Rsdt
00090     );
00091 
00092 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00093 <a class="code" href="../../d9/d3/rules_8c.html#a16">CmpGetRegistryValue</a>(
00094     IN  HANDLE                          KeyName,
00095     IN  PWSTR                           ValueName,
00096     OUT PKEY_VALUE_PARTIAL_INFORMATION  *Information
00097     );
00098 
00099 <a class="code" href="../../d6/d2/struct__DESCRIPTION__HEADER.html">PDESCRIPTION_HEADER</a>
00100 <a class="code" href="../../d9/d3/rules_8c.html#a17">CmpFindACPITable</a>(
00101     IN ULONG                            Signature,
00102     IN OUT PULONG                       Length
00103     );
00104 
00105 BOOLEAN
00106 <a class="code" href="../../d9/d3/rules_8c.html#a18">CmpCheckOperator</a>(
00107     IN PCHAR Operator,
00108     IN ULONG Lhs,
00109     IN ULONG Rhs
00110     );
00111 
00112 PVOID
00113 <a class="code" href="../../d9/d3/rules_8c.html#a19">CmpMapPhysicalAddress</a>(
00114     IN OUT PVOID *BaseAddress,
00115     IN ULONG Address,
00116     IN ULONG Size
00117     );
00118 
00119 BOOLEAN
00120 <a class="code" href="../../d9/d3/rules_8c.html#a20">CmpGetInfData</a>(
00121     IN PVOID InfHandle,
00122     IN PCHAR Section,
00123     IN ULONG KeyIndex,
00124     IN ULONG LineIndex,
00125     IN OUT PCHAR Buffer,
00126     IN OUT PULONG BufferSize
00127     );
00128 
00129 PVOID
00130 <a class="code" href="../../d9/d3/rules_8c.html#a21">CmpFindPattern</a>(
00131     IN PCHAR Buffer,
00132     IN ULONG BufSize,
00133     IN PCHAR Pattern,
00134     IN ULONG PatSize,
00135     IN BOOLEAN IgnoreCase,
00136     IN ULONG Step
00137     );
00138 
00139  ULONG
00140  <a class="code" href="../../d9/d3/rules_8c.html#a22">CmpGetPnPBIOSTableAddress</a>(
00141     VOID
00142     );
00143 
00144 BOOLEAN
00145 <a class="code" href="../../d9/d3/rules_8c.html#a23">CmpMatchDescription</a>(
00146     IN PVOID InfHandle,
00147     IN PCHAR Description
00148     );
00149 
00150 BOOLEAN
00151 <a class="code" href="../../d9/d3/rules_8c.html#a24">CmpMatchDateRule</a>(
00152     IN PVOID InfHandle,
00153     IN PCHAR Description,
00154     IN ULONG RuleIndex
00155     );
00156 
00157 BOOLEAN
00158 <a class="code" href="../../d9/d3/rules_8c.html#a25">CmpMatchMemoryRule</a>(
00159     IN PVOID InfHandle,
00160     IN PCHAR Description,
00161     IN ULONG RuleIndex
00162     );
00163 
00164 BOOLEAN
00165 <a class="code" href="../../d9/d3/rules_8c.html#a26">CmpMatchSearchRule</a>(
00166     IN PVOID InfHandle,
00167     IN PCHAR Description,
00168     IN ULONG RuleIndex
00169     );
00170 
00171 BOOLEAN
00172 <a class="code" href="../../d9/d3/rules_8c.html#a27">CmpMatchNextMatchRule</a>(
00173     IN PVOID InfHandle,
00174     IN PCHAR Description,
00175     IN ULONG RuleIndex
00176     );
00177 
00178 BOOLEAN
00179 <a class="code" href="../../d9/d3/rules_8c.html#a28">CmpMatchPointerRule</a>(
00180     IN PVOID InfHandle,
00181     IN PCHAR Description,
00182     IN ULONG RuleIndex
00183     );
00184 
00185 BOOLEAN
00186 <a class="code" href="../../d9/d3/rules_8c.html#a29">CmpMatchOemIdRule</a>(
00187     IN PVOID InfHandle,
00188     IN PCHAR Description,
00189     IN ULONG RuleIndex
00190     );
00191 
00192 BOOLEAN
00193 <a class="code" href="../../d9/d3/rules_8c.html#a30">CmpMatchPModeRule</a>(
00194     IN PVOID InfHandle,
00195     IN PCHAR Description,
00196     IN ULONG RuleIndex
00197     );
00198 
00199 BOOLEAN
00200 <a class="code" href="../../d9/d3/rules_8c.html#a31">CmpMatchRmPmSameRule</a>(
00201     IN PVOID InfHandle,
00202     IN PCHAR Description,
00203     IN ULONG RuleIndex
00204     );
00205 
00206 BOOLEAN
00207 <a class="code" href="../../d9/d3/rules_8c.html#a32">CmpMatchInstallRule</a>(
00208     IN PVOID InfHandle,
00209     IN PCHAR Description,
00210     IN ULONG RuleIndex
00211     );
00212 
00213 BOOLEAN
00214 <a class="code" href="../../d9/d3/rules_8c.html#a33">CmpMatchAcpiOemIdRule</a>(
00215     IN PVOID InfHandle,
00216     IN PCHAR Description,
00217     IN ULONG RuleIndex
00218     );
00219 
00220 BOOLEAN
00221 <a class="code" href="../../d9/d3/rules_8c.html#a34">CmpMatchAcpiOemTableIdRule</a>(
00222     IN PVOID InfHandle,
00223     IN PCHAR Description,
00224     IN ULONG RuleIndex
00225     );
00226 
00227 BOOLEAN
00228 <a class="code" href="../../d9/d3/rules_8c.html#a35">CmpMatchAcpiOemRevisionRule</a>(
00229     IN PVOID InfHandle,
00230     IN PCHAR Description,
00231     IN ULONG RuleIndex
00232     );
00233 
00234 BOOLEAN
00235 <a class="code" href="../../d9/d3/rules_8c.html#a36">CmpMatchAcpiRevisionRule</a>(
00236     IN PVOID InfHandle,
00237     IN PCHAR Description,
00238     IN ULONG RuleIndex
00239     );
00240 
00241 BOOLEAN
00242 <a class="code" href="../../d9/d3/rules_8c.html#a37">CmpMatchAcpiCreatorRevisionRule</a>(
00243     IN PVOID InfHandle,
00244     IN PCHAR Description,
00245     IN ULONG RuleIndex
00246     );
00247 
00248 <span class="comment">//</span>
00249 <span class="comment">// Number of rules currently implemented.</span>
00250 <span class="comment">//</span>
00251 
<a name="l00252"></a><a class="code" href="../../d9/d3/rules_8c.html#a3">00252</a> <span class="preprocessor">#define NUM_OF_RULES    14</span>
00253 <span class="preprocessor"></span>
00254 <span class="comment">//</span>
00255 <span class="comment">// Rule table.</span>
00256 <span class="comment">//</span>
00257 
00258 <span class="keyword">struct </span>{
<a name="l00259"></a><a class="code" href="../../d9/d3/rules_8c.html#a6">00259</a>     PCHAR       <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
<a name="l00260"></a><a class="code" href="../../d9/d3/rules_8c.html#a7">00260</a>     <a class="code" href="../../d9/d3/rules_8c.html#a4">PFN_RULE</a>    <a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a>;
00261 } <a class="code" href="../../d9/d3/rules_8c.html#a8">gRuleTable</a>[<a class="code" href="../../d9/d3/rules_8c.html#a3">NUM_OF_RULES</a>] =
00262 {
00263     {<span class="stringliteral">"Date"</span>, <a class="code" href="../../d9/d3/rules_8c.html#a24">CmpMatchDateRule</a>},
00264     {<span class="stringliteral">"Memory"</span>, <a class="code" href="../../d9/d3/rules_8c.html#a25">CmpMatchMemoryRule</a>},
00265     {<span class="stringliteral">"Search"</span>, <a class="code" href="../../d9/d3/rules_8c.html#a26">CmpMatchSearchRule</a>},
00266     {<span class="stringliteral">"NextMatch"</span>, <a class="code" href="../../d9/d3/rules_8c.html#a27">CmpMatchNextMatchRule</a>},
00267     {<span class="stringliteral">"Pointer"</span>, <a class="code" href="../../d9/d3/rules_8c.html#a28">CmpMatchPointerRule</a>},
00268     {<span class="stringliteral">"OemId"</span>, <a class="code" href="../../d9/d3/rules_8c.html#a29">CmpMatchOemIdRule</a>},
00269     {<span class="stringliteral">"PMode"</span>, <a class="code" href="../../d9/d3/rules_8c.html#a30">CmpMatchPModeRule</a>},
00270     {<span class="stringliteral">"RmPmSame"</span>, <a class="code" href="../../d9/d3/rules_8c.html#a31">CmpMatchRmPmSameRule</a>},
00271     {<span class="stringliteral">"Install"</span>, <a class="code" href="../../d9/d3/rules_8c.html#a32">CmpMatchInstallRule</a>},
00272     {<span class="stringliteral">"ACPIOemId"</span>, <a class="code" href="../../d9/d3/rules_8c.html#a33">CmpMatchAcpiOemIdRule</a>},
00273     {<span class="stringliteral">"ACPIOemTableId"</span>, <a class="code" href="../../d9/d3/rules_8c.html#a34">CmpMatchAcpiOemTableIdRule</a>},
00274     {<span class="stringliteral">"ACPIOemRevision"</span>, <a class="code" href="../../d9/d3/rules_8c.html#a35">CmpMatchAcpiOemRevisionRule</a>},
00275     {<span class="stringliteral">"ACPIRevision"</span>, <a class="code" href="../../d9/d3/rules_8c.html#a36">CmpMatchAcpiRevisionRule</a>},
00276     {<span class="stringliteral">"ACPICreatorRevision"</span>, <a class="code" href="../../d9/d3/rules_8c.html#a37">CmpMatchAcpiCreatorRevisionRule</a>}
00277 };
00278 
<a name="l00279"></a><a class="code" href="../../d9/d3/rules_8c.html#a9">00279</a> PVOID   <a class="code" href="../../d9/d3/rules_8c.html#a9">gSearchAddress</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00280 
<a name="l00281"></a><a class="code" href="../../d9/d3/rules_8c.html#a10">00281</a> <span class="keyword">static</span> WCHAR <a class="code" href="../../d9/d3/rules_8c.html#a10">rgzMultiFunctionAdapter</a>[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\Hardware\\Description\\System\\MultifunctionAdapter"</span>;
<a name="l00282"></a><a class="code" href="../../d9/d3/rules_8c.html#a11">00282</a> <span class="keyword">static</span> WCHAR <a class="code" href="../../d9/d3/rules_8c.html#a11">rgzAcpiConfigurationData</a>[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Configuration Data"</span>;
<a name="l00283"></a><a class="code" href="../../d9/d3/rules_8c.html#a12">00283</a> <span class="keyword">static</span> WCHAR <a class="code" href="../../d9/d3/rules_8c.html#a12">rgzAcpiIdentifier</a>[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Identifier"</span>;
<a name="l00284"></a><a class="code" href="../../d9/d3/rules_8c.html#a13">00284</a> <span class="keyword">static</span> WCHAR <a class="code" href="../../d9/d3/rules_8c.html#a13">rgzBIOSIdentifier</a>[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ACPI BIOS"</span>;
00285 
00286 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00287 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpFindACPITable)</span>
00288 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpFindRSDTTable)</span>
00289 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpComputeChecksum)</span>
00290 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpCheckOperator)</span>
00291 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpMapPhysicalAddress)</span>
00292 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpGetInfData)</span>
00293 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpFindPattern)</span>
00294 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpGetPnPBIOSTableAddress)</span>
00295 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpMatchInfList)</span>
00296 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpMatchDescription)</span>
00297 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpMatchDateRule)</span>
00298 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpMatchMemoryRule)</span>
00299 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpMatchSearchRule)</span>
00300 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpMatchNextMatchRule)</span>
00301 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpMatchPointerRule)</span>
00302 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpMatchOemIdRule)</span>
00303 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpMatchPModeRule)</span>
00304 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpMatchRmPmSameRule)</span>
00305 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpMatchInstallRule)</span>
00306 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpMatchAcpiOemIdRule)</span>
00307 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpMatchAcpiOemTableIdRule)</span>
00308 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpMatchAcpiOemRevisionRule)</span>
00309 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpMatchAcpiRevisionRule)</span>
00310 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpMatchAcpiCreatorRevisionRule)</span>
00311 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00312 <span class="preprocessor"></span>
00313 
00314 BOOLEAN
<a name="l00315"></a><a class="code" href="../../d0/d4/rules_8h.html#a1">00315</a> <a class="code" href="../../d0/d4/rules_8h.html#a1">CmpMatchInfList</a>(
00316     IN PVOID InfImage,
00317     IN ULONG ImageSize,
00318     IN PCHAR Section
00319     )
00320 
00321 <span class="comment">/*++</span>
00322 <span class="comment"></span>
00323 <span class="comment">    Routine Description:</span>
00324 <span class="comment"></span>
00325 <span class="comment">    Input Parameters:</span>
00326 <span class="comment"></span>
00327 <span class="comment">        InfImage - Pointer to the inf image in memory.</span>
00328 <span class="comment"></span>
00329 <span class="comment">        ImageSize - Size of the inf image.</span>
00330 <span class="comment"></span>
00331 <span class="comment">        Section - Section name containing the descriptions.</span>
00332 <span class="comment"></span>
00333 <span class="comment">        Description -</span>
00334 <span class="comment"></span>
00335 <span class="comment">    Return Value:</span>
00336 <span class="comment"></span>
00337 <span class="comment">        TRUE if the machine matches any one of the descriptions in the inf.</span>
00338 <span class="comment"></span>
00339 <span class="comment">--*/</span>
00340 
00341 {
00342     PCHAR   computerName;
00343     ULONG   i = 0;
00344     PVOID   infHandle;
00345     BOOLEAN result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00346 
00347     infHandle = <a class="code" href="../../d6/d3/parseini_8h.html#a0">CmpOpenInfFile</a>(InfImage, ImageSize);
00348 
00349     <span class="keywordflow">if</span> (infHandle)
00350     {
00351         <span class="comment">//</span>
00352         <span class="comment">// Do any clean-up specified in the inf.</span>
00353         <span class="comment">//</span>
00354 
00355         <a class="code" href="../../d9/d0/geninst_8h.html#a0">CmpGenInstall</a>(infHandle, <span class="stringliteral">"Cleanup"</span>);
00356 
00357         <span class="comment">//</span>
00358         <span class="comment">// Go through each description in this section and try to match</span>
00359         <span class="comment">// this machine to it.</span>
00360         <span class="comment">//</span>
00361 
00362         <span class="keywordflow">while</span> ((computerName = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(infHandle, Section, i++, 0)))
00363         {
00364             <span class="comment">//</span>
00365             <span class="comment">// Reset search result from previous description.</span>
00366             <span class="comment">//</span>
00367 
00368             <a class="code" href="../../d9/d3/rules_8c.html#a9">gSearchAddress</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00369 
00370             <span class="comment">//</span>
00371             <span class="comment">// If this description matches, we are done.</span>
00372             <span class="comment">// NOTE: IF MORE THAN ONE DESCRIPTION MATCHES,</span>
00373             <span class="comment">// WE STOP AT THE FIRST ONE.</span>
00374             <span class="comment">//</span>
00375 
00376             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/rules_8c.html#a23">CmpMatchDescription</a>(infHandle, computerName))
00377             {
00378                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CmpMatchInfList: Machine matches %s description!\n"</span>, computerName);
00379                 result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00380             }
00381         }
00382 
00383         <a class="code" href="../../d6/d3/parseini_8h.html#a1">CmpCloseInfFile</a>(infHandle);
00384     }
00385 
00386     <span class="comment">//</span>
00387     <span class="comment">// None of the descriptions match.</span>
00388     <span class="comment">//</span>
00389 
00390     <span class="keywordflow">return</span> (result);
00391 }
00392 
00393 BOOLEAN
<a name="l00394"></a><a class="code" href="../../d9/d3/rules_8c.html#a23">00394</a> <a class="code" href="../../d9/d3/rules_8c.html#a23">CmpMatchDescription</a>(
00395     IN PVOID InfHandle,
00396     IN PCHAR Description
00397     )
00398 
00399 <span class="comment">/*++</span>
00400 <span class="comment"></span>
00401 <span class="comment">    Routine Description:</span>
00402 <span class="comment"></span>
00403 <span class="comment">        This routine processes all the rules in the specified description.</span>
00404 <span class="comment"></span>
00405 <span class="comment">    Input Parameters:</span>
00406 <span class="comment"></span>
00407 <span class="comment">        InfHandle - Handle to the inf containing the description.</span>
00408 <span class="comment"></span>
00409 <span class="comment">        Description - Section name containing the rules.</span>
00410 <span class="comment"></span>
00411 <span class="comment">    Return Value:</span>
00412 <span class="comment"></span>
00413 <span class="comment">        TRUE iff all the rules in the description succeed.</span>
00414 <span class="comment"></span>
00415 <span class="comment">--*/</span>
00416 
00417 {
00418     ULONG   ruleNumber;
00419     ULONG   i;
00420     PCHAR   ruleName;
00421 
00422     <span class="comment">//</span>
00423     <span class="comment">// Proceed only if the section does exist.</span>
00424     <span class="comment">//</span>
00425 
00426     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/parseini_8h.html#a3">CmpSearchInfSection</a>(InfHandle, <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>))
00427     {
00428         <span class="comment">//</span>
00429         <span class="comment">// Go through all the rules in the description and try to match</span>
00430         <span class="comment">// each of them.</span>
00431         <span class="comment">//</span>
00432 
00433         ruleNumber = 0;
00434         <span class="keywordflow">while</span> ((ruleName = <a class="code" href="../../d6/d3/parseini_8h.html#a2">CmpGetKeyName</a>(InfHandle, <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>, ruleNumber)))
00435         {
00436             <span class="comment">//</span>
00437             <span class="comment">// Search for the rule in our table.</span>
00438             <span class="comment">//</span>
00439 
00440             <span class="keywordflow">for</span> (   i = 0;
00441                     i &lt; <a class="code" href="../../d9/d3/rules_8c.html#a3">NUM_OF_RULES</a> &amp;&amp;
00442                         _stricmp(ruleName, <a class="code" href="../../d9/d3/rules_8c.html#a8">gRuleTable</a>[i].<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00443                     i++);
00444 
00445             <span class="comment">//</span>
00446             <span class="comment">// If we did not find the rule or the rule failed,</span>
00447             <span class="comment">// return failure.</span>
00448             <span class="comment">//</span>
00449 
00450             <span class="keywordflow">if</span> (    i &gt;= <a class="code" href="../../d9/d3/rules_8c.html#a3">NUM_OF_RULES</a> ||
00451                     !(*<a class="code" href="../../d9/d3/rules_8c.html#a8">gRuleTable</a>[i].Action)(InfHandle, <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>, ruleNumber++))
00452             {
00453                 <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00454             }
00455         }
00456 
00457         <span class="comment">//</span>
00458         <span class="comment">// Description matches if we found at least one rule and all rules</span>
00459         <span class="comment">// succeeded.</span>
00460         <span class="comment">//</span>
00461 
00462         <span class="keywordflow">if</span> (ruleNumber)
00463         {
00464             <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00465         }
00466     }
00467 
00468     <span class="comment">//</span>
00469     <span class="comment">// Description did not match.</span>
00470     <span class="comment">//</span>
00471 
00472     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00473 }
00474 
00475 BOOLEAN
<a name="l00476"></a><a class="code" href="../../d9/d3/rules_8c.html#a24">00476</a> <a class="code" href="../../d9/d3/rules_8c.html#a24">CmpMatchDateRule</a>(
00477     IN PVOID InfHandle,
00478     IN PCHAR Description,
00479     IN ULONG RuleIndex
00480     )
00481 
00482 <span class="comment">/*++</span>
00483 <span class="comment"></span>
00484 <span class="comment">    Routine Description:</span>
00485 <span class="comment"></span>
00486 <span class="comment">        This routine checks if the machine satisfies the DATE rule. The BIOS date</span>
00487 <span class="comment">        is stored in a standard location in the BIOS ROM at FFFF:5.</span>
00488 <span class="comment"></span>
00489 <span class="comment">        Syntax -</span>
00490 <span class="comment"></span>
00491 <span class="comment">        DATE=operator,month,day,year</span>
00492 <span class="comment">            where operator [=, ==, !=, &lt;&gt;, &lt;, &lt;=, =&lt;, &gt;, &gt;=, =&gt;]</span>
00493 <span class="comment"></span>
00494 <span class="comment">        Examples -</span>
00495 <span class="comment"></span>
00496 <span class="comment">        date="&lt;=",2,1,95</span>
00497 <span class="comment">            is TRUE if the BIOS date on this machine is less than or equal to</span>
00498 <span class="comment">            02/01/95.</span>
00499 <span class="comment"></span>
00500 <span class="comment">    Input Parameters:</span>
00501 <span class="comment"></span>
00502 <span class="comment">        InfHandle - Handle to the inf to be read.</span>
00503 <span class="comment"></span>
00504 <span class="comment">        Description - Name of the section containing the rule info.</span>
00505 <span class="comment"></span>
00506 <span class="comment">        RuleIndex - Line number for the rule in the description section.</span>
00507 <span class="comment"></span>
00508 <span class="comment">    Return Value:</span>
00509 <span class="comment"></span>
00510 <span class="comment">        TRUE if the BIOS on this machine has the specified relation with the</span>
00511 <span class="comment">        date specified in the rule.</span>
00512 <span class="comment"></span>
00513 <span class="comment">--*/</span>
00514 
00515 {
00516     PCHAR   op;
00517     PCHAR   month;
00518     PCHAR   day;
00519     PCHAR   year;
00520     ULONG   infDate;
00521     ULONG   yr;
00522     ULONG   biosDate;
00523     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>    temp[3];
00524     PVOID   baseAddress;
00525     PCHAR   address;
00526 
00527     op = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(InfHandle, <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>, RuleIndex, 0);
00528     month = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(InfHandle, <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>, RuleIndex, 1);
00529     day = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(InfHandle, <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>, RuleIndex, 2);
00530     year = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(InfHandle, <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>, RuleIndex, 3);
00531 
00532     <span class="keywordflow">if</span> (op &amp;&amp; month &amp;&amp; day &amp;&amp; year)
00533     {
00534         yr = strtoul(year, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16);
00535         infDate = ((yr &lt; 0x80) ? 0x20000000 : 0x19000000) +
00536                     (yr &lt;&lt; 16) +
00537                     (strtoul(month, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16) &lt;&lt; 8) +
00538                     (strtoul(day, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16));
00539 
00540         address = <a class="code" href="../../d9/d3/rules_8c.html#a19">CmpMapPhysicalAddress</a>(&amp;baseAddress, 0xFFFF5, 8);
00541         <span class="keywordflow">if</span> (address)
00542         {
00543             temp[2] = <span class="charliteral">'\0'</span>;
00544 
00545             RtlCopyBytes(temp, address + 6, 2);
00546             yr = strtoul(temp, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16);
00547             biosDate = ((yr &lt; 0x80) ? 0x20000000 : 0x19000000) +
00548                         (yr &lt;&lt; 16);
00549 
00550             RtlCopyBytes(temp, address, 2);
00551             biosDate |= (strtoul(temp, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16) &lt;&lt; 8);
00552 
00553             RtlCopyBytes(temp, address + 3, 2);
00554             biosDate |= strtoul(temp, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16);
00555 
00556             ZwUnmapViewOfSection(NtCurrentProcess(), baseAddress);
00557 
00558             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/rules_8c.html#a18">CmpCheckOperator</a>(op, biosDate, infDate))
00559             {
00560                 <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00561             }
00562         }
00563     }
00564 
00565     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00566 }
00567 
00568 BOOLEAN
<a name="l00569"></a><a class="code" href="../../d9/d3/rules_8c.html#a25">00569</a> <a class="code" href="../../d9/d3/rules_8c.html#a25">CmpMatchMemoryRule</a>(
00570     IN PVOID InfHandle,
00571     IN PCHAR Description,
00572     IN ULONG RuleIndex
00573     )
00574 
00575 <span class="comment">/*++</span>
00576 <span class="comment"></span>
00577 <span class="comment">    Routine Description:</span>
00578 <span class="comment"></span>
00579 <span class="comment">        This routine checks if the machine satisfies the MEMORY rule.</span>
00580 <span class="comment"></span>
00581 <span class="comment">        Syntax -</span>
00582 <span class="comment"></span>
00583 <span class="comment">        MEMORY=segment,offset,type,data</span>
00584 <span class="comment">            where type ["S", "B"]</span>
00585 <span class="comment"></span>
00586 <span class="comment">        Examples -</span>
00587 <span class="comment"></span>
00588 <span class="comment">        memory=f000,e000,S,"TOSHIBA"</span>
00589 <span class="comment">            is TRUE if the memory in this machine at physical address f000:e000</span>
00590 <span class="comment">            has the string "TOSHIBA".</span>
00591 <span class="comment"></span>
00592 <span class="comment">        memory=ffff,5,B,01,02</span>
00593 <span class="comment">            is TRUE if the memory in this machine at physical memory ffff:5</span>
00594 <span class="comment">            has the bytes 0x01 and 0x02.</span>
00595 <span class="comment"></span>
00596 <span class="comment">    Input Parameters:</span>
00597 <span class="comment"></span>
00598 <span class="comment">        InfHandle - Handle to the inf to be read.</span>
00599 <span class="comment"></span>
00600 <span class="comment">        Description - Name of the section containing the rule info.</span>
00601 <span class="comment"></span>
00602 <span class="comment">        RuleIndex - Line number for the rule in the description section.</span>
00603 <span class="comment"></span>
00604 <span class="comment">    Return Value:</span>
00605 <span class="comment"></span>
00606 <span class="comment">        TRUE iff the MEMORY in this machine at the specified address</span>
00607 <span class="comment">        contains the specified data.</span>
00608 <span class="comment"></span>
00609 <span class="comment">--*/</span>
00610 
00611 {
00612     BOOLEAN             match = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00613     PCHAR               segment;
00614     PCHAR               offset;
00615     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>                data[<a class="code" href="../../d0/d4/rules_8h.html#a0">MAX_DESCRIPTION_LEN</a> + 1];
00616     ULONG               cbData;
00617     PVOID               baseAddress;
00618     PCHAR               address;
00619     ULONG               memory;
00620 
00621     <span class="comment">//</span>
00622     <span class="comment">// Read in the segment and offset of the address specified.</span>
00623     <span class="comment">//</span>
00624 
00625     segment = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(InfHandle, <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>, RuleIndex, 0);
00626     offset = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(InfHandle, <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>, RuleIndex, 1);
00627 
00628     <span class="keywordflow">if</span> (segment &amp;&amp; offset)
00629     {
00630         <span class="comment">//</span>
00631         <span class="comment">// Get the data specified in the inf.</span>
00632         <span class="comment">//</span>
00633 
00634         cbData = <span class="keyword">sizeof</span>(data);
00635         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/rules_8c.html#a20">CmpGetInfData</a>(InfHandle, <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>, RuleIndex, 2, data, &amp;cbData))
00636         {
00637             memory = (strtoul(segment, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16) &lt;&lt; 4) + strtoul(offset, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16);
00638 
00639             <span class="comment">//</span>
00640             <span class="comment">// Map in the physical address.</span>
00641             <span class="comment">//</span>
00642 
00643             address = <a class="code" href="../../d9/d3/rules_8c.html#a19">CmpMapPhysicalAddress</a>(&amp;baseAddress, memory, cbData);
00644             <span class="keywordflow">if</span> (address)
00645             {
00646 
00647                 <span class="comment">//</span>
00648                 <span class="comment">// Check if the inf data matches data in memory.</span>
00649                 <span class="comment">//</span>
00650 
00651                 match = (RtlCompareMemory(address, data, cbData) == cbData);
00652 
00653                 <span class="comment">//</span>
00654                 <span class="comment">// Unmap the physical address.</span>
00655                 <span class="comment">//</span>
00656 
00657                 ZwUnmapViewOfSection(NtCurrentProcess(), baseAddress);
00658             }
00659         }
00660     }
00661 
00662     <span class="keywordflow">return</span> (match);
00663 }
00664 
00665 BOOLEAN
<a name="l00666"></a><a class="code" href="../../d9/d3/rules_8c.html#a26">00666</a> <a class="code" href="../../d9/d3/rules_8c.html#a26">CmpMatchSearchRule</a>(
00667     IN PVOID InfHandle,
00668     IN PCHAR Description,
00669     IN ULONG RuleIndex
00670     )
00671 
00672 <span class="comment">/*++</span>
00673 <span class="comment"></span>
00674 <span class="comment">    Routine Description:</span>
00675 <span class="comment"></span>
00676 <span class="comment">        This routine checks to see if the machine matches the SEARCH rule.</span>
00677 <span class="comment"></span>
00678 <span class="comment">        Syntax -</span>
00679 <span class="comment"></span>
00680 <span class="comment">        SEARCH=segment,offset,length,type,data</span>
00681 <span class="comment">            where type ["S", "B"]</span>
00682 <span class="comment"></span>
00683 <span class="comment">        Examples -</span>
00684 <span class="comment"></span>
00685 <span class="comment">        search=f000,e000,7f,S,"SurePath"</span>
00686 <span class="comment">            is TRUE if the string "SurePath" is somewhere in memory range</span>
00687 <span class="comment">            F000:E000 to F000:E07F (inclusive).</span>
00688 <span class="comment"></span>
00689 <span class="comment">    Input Parameters:</span>
00690 <span class="comment"></span>
00691 <span class="comment">        InfHandle - Handle to the inf to be read.</span>
00692 <span class="comment"></span>
00693 <span class="comment">        Description - Name of the section containing the rule info.</span>
00694 <span class="comment"></span>
00695 <span class="comment">        RuleIndex - Line number for the rule in the description section.</span>
00696 <span class="comment"></span>
00697 <span class="comment">    Return Value:</span>
00698 <span class="comment"></span>
00699 <span class="comment">        TRUE iff the specified pattern is found within the specified address</span>
00700 <span class="comment">        range.</span>
00701 <span class="comment"></span>
00702 <span class="comment">--*/</span>
00703 
00704 {
00705     BOOLEAN match = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00706     PCHAR   segment;
00707     PCHAR   offset;
00708     PCHAR   size;
00709     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>    data[<a class="code" href="../../d0/d4/rules_8h.html#a0">MAX_DESCRIPTION_LEN</a> + 1];
00710     ULONG   cbData;
00711     ULONG   memory;
00712     ULONG   length;
00713     PVOID   baseAddress;
00714     PCHAR   address;
00715 
00716     segment = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(InfHandle, <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>, RuleIndex, 0);
00717     offset = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(InfHandle, <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>, RuleIndex, 1);
00718     size = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(InfHandle, <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>, RuleIndex, 2);
00719 
00720     <span class="keywordflow">if</span> (segment &amp;&amp; offset &amp;&amp; size)
00721     {
00722         <span class="comment">//</span>
00723         <span class="comment">// Get the data specified in the inf.</span>
00724         <span class="comment">//</span>
00725 
00726         cbData = <span class="keyword">sizeof</span>(data);
00727         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/rules_8c.html#a20">CmpGetInfData</a>(InfHandle, <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>, RuleIndex, 3, data, &amp;cbData))
00728         {
00729             memory = (strtoul(segment, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16) &lt;&lt; 4) + strtoul(offset, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16);
00730 
00731             <span class="comment">//</span>
00732             <span class="comment">// Map in the physical address.</span>
00733             <span class="comment">//</span>
00734 
00735             length = strtoul(size, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16);
00736             address = <a class="code" href="../../d9/d3/rules_8c.html#a19">CmpMapPhysicalAddress</a>(&amp;baseAddress, memory, length);
00737             <span class="keywordflow">if</span> (address)
00738             {
00739                 <a class="code" href="../../d9/d3/rules_8c.html#a9">gSearchAddress</a> = <a class="code" href="../../d9/d3/rules_8c.html#a21">CmpFindPattern</a>(address, length, data, cbData, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, 0);
00740                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/rules_8c.html#a9">gSearchAddress</a>)
00741                 {
00742                     <span class="comment">//</span>
00743                     <span class="comment">// If we found the pattern, compute the actual address for it.</span>
00744                     <span class="comment">//</span>
00745 
00746                     (PCHAR)<a class="code" href="../../d9/d3/rules_8c.html#a9">gSearchAddress</a> -= (ULONG)address;
00747                     (PCHAR)<a class="code" href="../../d9/d3/rules_8c.html#a9">gSearchAddress</a> += memory;
00748                     match = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00749                 }
00750 
00751                 <span class="comment">//</span>
00752                 <span class="comment">// Unmap the physical address.</span>
00753                 <span class="comment">//</span>
00754 
00755                 ZwUnmapViewOfSection(NtCurrentProcess(), baseAddress);
00756             }
00757         }
00758     }
00759 
00760     <span class="keywordflow">return</span> (match);
00761 }
00762 
00763 BOOLEAN
<a name="l00764"></a><a class="code" href="../../d9/d3/rules_8c.html#a27">00764</a> <a class="code" href="../../d9/d3/rules_8c.html#a27">CmpMatchNextMatchRule</a>(
00765     IN PVOID InfHandle,
00766     IN PCHAR Description,
00767     IN ULONG RuleIndex
00768     )
00769 
00770 <span class="comment">/*++</span>
00771 <span class="comment"></span>
00772 <span class="comment">    Routine Description:</span>
00773 <span class="comment"></span>
00774 <span class="comment">        This routine checks to see if the machine matches the NEXTMATCH rule.</span>
00775 <span class="comment"></span>
00776 <span class="comment">        Syntax -</span>
00777 <span class="comment"></span>
00778 <span class="comment">        NEXTMATCH=offset,type,data</span>
00779 <span class="comment">            where type ["S", "B"]</span>
00780 <span class="comment"></span>
00781 <span class="comment">        Examples -</span>
00782 <span class="comment"></span>
00783 <span class="comment">        nextmatch=f0,S,"Atlanta"</span>
00784 <span class="comment">            is TRUE if the string "Atlanta" is at offset 0xF0 from the previous</span>
00785 <span class="comment">            successful SEARCH or NEXTMATCH rule.</span>
00786 <span class="comment"></span>
00787 <span class="comment">    Input Parameters:</span>
00788 <span class="comment"></span>
00789 <span class="comment">        InfHandle - Handle to the inf to be read.</span>
00790 <span class="comment"></span>
00791 <span class="comment">        Description - Name of the section containing the rule info.</span>
00792 <span class="comment"></span>
00793 <span class="comment">        RuleIndex - Line number for the rule in the description section.</span>
00794 <span class="comment"></span>
00795 <span class="comment">    Return Value:</span>
00796 <span class="comment"></span>
00797 <span class="comment">        TRUE iff the specified pattern is found at the specified offset</span>
00798 <span class="comment">        from the previous successful SEARCH or NEXTMATCH.</span>
00799 <span class="comment"></span>
00800 <span class="comment">--*/</span>
00801 
00802 {
00803     BOOLEAN match = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00804     PCHAR   offset;
00805     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>    data[<a class="code" href="../../d0/d4/rules_8h.html#a0">MAX_DESCRIPTION_LEN</a> + 1];
00806     ULONG   cbData;
00807     PVOID   baseAddress;
00808     PCHAR   address;
00809 
00810     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/rules_8c.html#a9">gSearchAddress</a>)
00811     {
00812         offset = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(InfHandle, <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>, RuleIndex, 0);
00813         <span class="keywordflow">if</span> (offset)
00814         {
00815             <span class="comment">//</span>
00816             <span class="comment">// Get the data specified in the inf.</span>
00817             <span class="comment">//</span>
00818 
00819             cbData = <span class="keyword">sizeof</span>(data);
00820 
00821             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/rules_8c.html#a20">CmpGetInfData</a>(InfHandle, <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>, RuleIndex, 1, data, &amp;cbData))
00822             {
00823                 (PCHAR)<a class="code" href="../../d9/d3/rules_8c.html#a9">gSearchAddress</a> += strtoul(offset, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16);
00824 
00825                 <span class="comment">//</span>
00826                 <span class="comment">// Map in the physical address.</span>
00827                 <span class="comment">//</span>
00828 
00829                 address = <a class="code" href="../../d9/d3/rules_8c.html#a19">CmpMapPhysicalAddress</a>(&amp;baseAddress, (ULONG)<a class="code" href="../../d9/d3/rules_8c.html#a9">gSearchAddress</a>, cbData);
00830                 <span class="keywordflow">if</span> (address)
00831                 {
00832 
00833                     <span class="comment">//</span>
00834                     <span class="comment">// Check if the inf data matches data in memory.</span>
00835                     <span class="comment">//</span>
00836 
00837                     match = (RtlCompareMemory(address, data, cbData) == cbData);
00838 
00839                     <span class="comment">//</span>
00840                     <span class="comment">// Unmap the physical address.</span>
00841                     <span class="comment">//</span>
00842 
00843                     ZwUnmapViewOfSection(NtCurrentProcess(), baseAddress);
00844                 }
00845             }
00846         }
00847     }
00848 
00849     <span class="keywordflow">return</span> (match);
00850 }
00851 
00852 BOOLEAN
<a name="l00853"></a><a class="code" href="../../d9/d3/rules_8c.html#a28">00853</a> <a class="code" href="../../d9/d3/rules_8c.html#a28">CmpMatchPointerRule</a>(
00854     IN PVOID InfHandle,
00855     IN PCHAR Description,
00856     IN ULONG RuleIndex
00857     )
00858 {
00859     BOOLEAN match = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00860     PCHAR   segment1;
00861     PCHAR   offset1;
00862     PCHAR   segment2;
00863     PCHAR   offset2;
00864     PCHAR   index;
00865     PCHAR   op;
00866     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>    data[<a class="code" href="../../d0/d4/rules_8h.html#a0">MAX_DESCRIPTION_LEN</a> + 1];
00867     ULONG   cbData;
00868     ULONG   memory;
00869     ULONG   pointer;
00870     PVOID   baseAddress;
00871     PCHAR   address;
00872 
00873     segment1 = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(InfHandle, <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>, RuleIndex, 0);
00874     offset1 = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(InfHandle, <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>, RuleIndex, 1);
00875     segment2 = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(InfHandle, <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>, RuleIndex, 2);
00876     offset2 = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(InfHandle, <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>, RuleIndex, 3);
00877     index = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(InfHandle, <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>, RuleIndex, 4);
00878     op = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(InfHandle, <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>, RuleIndex, 5);
00879 
00880     <span class="keywordflow">if</span> (    segment1 &amp;&amp; offset1 &amp;&amp;
00881             segment2 &amp;&amp; offset2 &amp;&amp;
00882             index &amp;&amp; op)
00883     {
00884         <span class="comment">//</span>
00885         <span class="comment">// Get the data specified in the inf.</span>
00886         <span class="comment">//</span>
00887 
00888         cbData = <span class="keyword">sizeof</span>(data);
00889 
00890         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/rules_8c.html#a20">CmpGetInfData</a>(InfHandle, <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>, RuleIndex, 6, data, &amp;cbData))
00891         {
00892             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(offset2) == 0)
00893             {
00894                 memory = strtoul(segment2, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16) &lt;&lt; 4;
00895             }
00896             <span class="keywordflow">else</span>
00897             {
00898                 memory = (strtoul(segment2, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16) &lt;&lt; 4) + strtoul(offset2, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16);
00899             }
00900 
00901             address = <a class="code" href="../../d9/d3/rules_8c.html#a19">CmpMapPhysicalAddress</a>(&amp;baseAddress, memory, 4);
00902             <span class="keywordflow">if</span> (address)
00903             {
00904                 pointer = *((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)address);
00905 
00906                 <span class="comment">//</span>
00907                 <span class="comment">// Unmap the physical address.</span>
00908                 <span class="comment">//</span>
00909 
00910                 ZwUnmapViewOfSection(NtCurrentProcess(), baseAddress);
00911 
00912                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(offset1) == 0)
00913                 {
00914                     memory = (strtoul(segment1, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16) &lt;&lt; 4) + pointer;
00915                 }
00916                 <span class="keywordflow">else</span>
00917                 {
00918                     memory = (strtoul(segment1, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16) &lt;&lt; 4) + strtoul(offset1, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16);
00919                     address = <a class="code" href="../../d9/d3/rules_8c.html#a19">CmpMapPhysicalAddress</a>(&amp;baseAddress, memory, 2);
00920                     <span class="keywordflow">if</span> (address)
00921                     {
00922                         memory = ((*(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)address) &lt;&lt; 4) + pointer;
00923 
00924                         <span class="comment">//</span>
00925                         <span class="comment">// Unmap the physical address.</span>
00926                         <span class="comment">//</span>
00927 
00928                         ZwUnmapViewOfSection(NtCurrentProcess(), baseAddress);
00929                     }
00930                 }
00931 
00932                 memory += strtoul(index, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16);
00933 
00934                 <span class="comment">//</span>
00935                 <span class="comment">// Map in the physical address.</span>
00936                 <span class="comment">//</span>
00937 
00938                 address = <a class="code" href="../../d9/d3/rules_8c.html#a19">CmpMapPhysicalAddress</a>(&amp;baseAddress, memory, cbData);
00939                 <span class="keywordflow">if</span> (address)
00940                 {
00941                     match = <a class="code" href="../../d9/d3/rules_8c.html#a18">CmpCheckOperator</a>(op, RtlCompareMemory(address, data, cbData), cbData);
00942 
00943                     <span class="comment">//</span>
00944                     <span class="comment">// Unmap the physical address.</span>
00945                     <span class="comment">//</span>
00946 
00947                     ZwUnmapViewOfSection(NtCurrentProcess(), baseAddress);
00948                 }
00949             }
00950         }
00951     }
00952 
00953     <span class="keywordflow">return</span> (match);
00954 }
00955 
00956 BOOLEAN
<a name="l00957"></a><a class="code" href="../../d9/d3/rules_8c.html#a29">00957</a> <a class="code" href="../../d9/d3/rules_8c.html#a29">CmpMatchOemIdRule</a>(
00958     IN PVOID InfHandle,
00959     IN PCHAR Description,
00960     IN ULONG RuleIndex
00961     )
00962 {
00963     BOOLEAN         match = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00964     ULONG           address;
00965     PCHAR           op;
00966     PCHAR           oemIdStr;
00967     ULONG           oemId;
00968     PCHAR           baseAddress;
00969     <a class="code" href="../../d9/d3/rules_8c.html#a5">PPNP_BIOS_TABLE</a> biosTable;
00970 
00971     <span class="comment">//</span>
00972     <span class="comment">// Search for the PnPBIOS structure in the BIOS ROM.</span>
00973     <span class="comment">//</span>
00974 
00975     address = <a class="code" href="../../d9/d3/rules_8c.html#a22">CmpGetPnPBIOSTableAddress</a>();
00976 
00977     <span class="comment">//</span>
00978     <span class="comment">// Proceed if we found the PnP BIOS structure.</span>
00979     <span class="comment">//</span>
00980 
00981     <span class="keywordflow">if</span> (address)
00982     {
00983         op = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(InfHandle, <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>, RuleIndex, 0);
00984         oemIdStr = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(InfHandle, <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>, RuleIndex, 1);
00985         <span class="keywordflow">if</span> (op &amp;&amp; oemIdStr)
00986         {
00987 
00988             <span class="keywordflow">if</span> (    <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(oemIdStr) == 7 &amp;&amp;
00989                     isalpha(oemIdStr[0]) &amp;&amp;
00990                     isalpha(oemIdStr[1]) &amp;&amp;
00991                     isalpha(oemIdStr[2]) &amp;&amp;
00992                     isxdigit(oemIdStr[3]) &amp;&amp;
00993                     isxdigit(oemIdStr[4]) &amp;&amp;
00994                     isxdigit(oemIdStr[5]) &amp;&amp;
00995                     isxdigit(oemIdStr[6]))
00996             {
00997 
00998                 biosTable = (<a class="code" href="../../d9/d3/rules_8c.html#a5">PPNP_BIOS_TABLE</a>)<a class="code" href="../../d9/d3/rules_8c.html#a19">CmpMapPhysicalAddress</a>(&amp;baseAddress, address, <span class="keyword">sizeof</span>(PNP_BIOS_TABLE));
00999                 <span class="keywordflow">if</span> (biosTable)
01000                 {
01001                     oemId = ((ULONG)(oemIdStr[0] &amp; 0x1F) &lt;&lt; 26) +
01002                             ((ULONG)(oemIdStr[1] &amp; 0x1F) &lt;&lt; 21) +
01003                             ((ULONG)(oemIdStr[2] &amp; 0x1F) &lt;&lt; 16) +
01004                             strtoul(&amp;oemIdStr[3], <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16);
01005 
01006                     <span class="comment">//</span>
01007                     <span class="comment">// We only support EQUAL and NOT EQUAL operators.</span>
01008                     <span class="comment">//</span>
01009 
01010                     <span class="keywordflow">if</span> (strcmp(op, <span class="stringliteral">"="</span>) == 0 || strcmp(op, <span class="stringliteral">"=="</span>) == 0)
01011                     {
01012                         match = (oemId == biosTable-&gt;Oem);
01013                     }
01014                     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(    strcmp(op, <span class="stringliteral">"&lt;&gt;"</span>) == 0 ||
01015                                 strcmp(op, <span class="stringliteral">"!="</span>) == 0 ||
01016                                 strcmp(op, <span class="stringliteral">"=!"</span>) == 0)
01017                     {
01018                         match = (oemId != biosTable-&gt;Oem);
01019                     }
01020 
01021                     <span class="comment">//</span>
01022                     <span class="comment">// Unmap the physical address.</span>
01023                     <span class="comment">//</span>
01024 
01025                     ZwUnmapViewOfSection(NtCurrentProcess(), baseAddress);
01026                 }
01027             }
01028         }
01029     }
01030 
01031     <span class="keywordflow">return</span> (match);
01032 }
01033 
01034 BOOLEAN
<a name="l01035"></a><a class="code" href="../../d9/d3/rules_8c.html#a30">01035</a> <a class="code" href="../../d9/d3/rules_8c.html#a30">CmpMatchPModeRule</a>(
01036     IN PVOID InfHandle,
01037     IN PCHAR Description,
01038     IN ULONG RuleIndex
01039     )
01040 {
01041     BOOLEAN         match = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01042     ULONG           address;
01043     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>            data[<a class="code" href="../../d0/d4/rules_8h.html#a0">MAX_DESCRIPTION_LEN</a> + 1];
01044     ULONG           cbData;
01045     PVOID           baseAddress;
01046     <a class="code" href="../../d9/d3/rules_8c.html#a5">PPNP_BIOS_TABLE</a> biosTable;
01047     ULONG           pmAddress;
01048     PCHAR           pmodeEntry;
01049 
01050     <span class="comment">//</span>
01051     <span class="comment">// Search for the PnPBIOS structure in the BIOS ROM.</span>
01052     <span class="comment">//</span>
01053 
01054     address = <a class="code" href="../../d9/d3/rules_8c.html#a22">CmpGetPnPBIOSTableAddress</a>();
01055 
01056     <span class="comment">//</span>
01057     <span class="comment">// Proceed if we found the PnP BIOS structure.</span>
01058     <span class="comment">//</span>
01059 
01060     <span class="keywordflow">if</span> (address)
01061     {
01062         <span class="comment">//</span>
01063         <span class="comment">// Get the data specified in the inf.</span>
01064         <span class="comment">//</span>
01065 
01066         cbData = <span class="keyword">sizeof</span>(data);
01067         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/rules_8c.html#a20">CmpGetInfData</a>(InfHandle, <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>, RuleIndex, 0, data, &amp;cbData))
01068         {
01069             biosTable = (<a class="code" href="../../d9/d3/rules_8c.html#a5">PPNP_BIOS_TABLE</a>)<a class="code" href="../../d9/d3/rules_8c.html#a19">CmpMapPhysicalAddress</a>(&amp;baseAddress, address, <span class="keyword">sizeof</span>(PNP_BIOS_TABLE));
01070             <span class="keywordflow">if</span> (biosTable)
01071             {
01072                 pmAddress = (biosTable-&gt;PMSegment &lt;&lt; 4) + biosTable-&gt;PMOffset;
01073 
01074                 <span class="comment">//</span>
01075                 <span class="comment">// Unmap the physical address.</span>
01076                 <span class="comment">//</span>
01077 
01078                 ZwUnmapViewOfSection(NtCurrentProcess(), baseAddress);
01079 
01080                 pmodeEntry = <a class="code" href="../../d9/d3/rules_8c.html#a19">CmpMapPhysicalAddress</a>(&amp;baseAddress, pmAddress, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a4">SYSTEM_BIOS_LENGTH</a>);
01081                 <span class="keywordflow">if</span> (pmodeEntry)
01082                 {
01083                     <span class="keywordflow">if</span> (*pmodeEntry == 0xE9)
01084                     {
01085                         pmodeEntry += (3 + (*((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)&amp;pmodeEntry[1])));
01086                     }
01087 
01088                     match = (RtlCompareMemory(pmodeEntry, data, cbData) == cbData);
01089 
01090                     <span class="comment">//</span>
01091                     <span class="comment">// Unmap the physical address.</span>
01092                     <span class="comment">//</span>
01093 
01094                     ZwUnmapViewOfSection(NtCurrentProcess(), baseAddress);
01095                 }
01096             }
01097         }
01098     }
01099 
01100     <span class="keywordflow">return</span> (match);
01101 }
01102 
01103 BOOLEAN
<a name="l01104"></a><a class="code" href="../../d9/d3/rules_8c.html#a31">01104</a> <a class="code" href="../../d9/d3/rules_8c.html#a31">CmpMatchRmPmSameRule</a>(
01105     IN PVOID InfHandle,
01106     IN PCHAR Description,
01107     IN ULONG RuleIndex
01108     )
01109 {
01110     BOOLEAN match = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01111     ULONG           address;
01112     PCHAR           baseAddress;
01113     <a class="code" href="../../d9/d3/rules_8c.html#a5">PPNP_BIOS_TABLE</a> biosTable;
01114 
01115     <span class="comment">//</span>
01116     <span class="comment">// Search for the PnPBIOS structure in the BIOS ROM.</span>
01117     <span class="comment">//</span>
01118 
01119     address = <a class="code" href="../../d9/d3/rules_8c.html#a22">CmpGetPnPBIOSTableAddress</a>();
01120 
01121     <span class="comment">//</span>
01122     <span class="comment">// Proceed if we found the PnP BIOS structure.</span>
01123     <span class="comment">//</span>
01124 
01125     <span class="keywordflow">if</span> (address)
01126     {
01127         biosTable = <a class="code" href="../../d9/d3/rules_8c.html#a19">CmpMapPhysicalAddress</a>(&amp;baseAddress, address, <span class="keyword">sizeof</span>(PNP_BIOS_TABLE));
01128         <span class="keywordflow">if</span> (biosTable)
01129         {
01130             match = (   biosTable-&gt;RMSegment == biosTable-&gt;PMSegment &amp;&amp;
01131                         biosTable-&gt;RMOffset == biosTable-&gt;PMOffset);
01132 
01133             <span class="comment">//</span>
01134             <span class="comment">// Unmap the physical address.</span>
01135             <span class="comment">//</span>
01136 
01137             ZwUnmapViewOfSection(NtCurrentProcess(), baseAddress);
01138         }
01139     }
01140 
01141     <span class="keywordflow">return</span> (match);
01142 }
01143 
01144 BOOLEAN
<a name="l01145"></a><a class="code" href="../../d9/d3/rules_8c.html#a32">01145</a> <a class="code" href="../../d9/d3/rules_8c.html#a32">CmpMatchInstallRule</a>(
01146     IN PVOID InfHandle,
01147     IN PCHAR Description,
01148     IN ULONG RuleIndex
01149     )
01150 {
01151     BOOLEAN match = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01152     PCHAR   install;
01153 
01154     install = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(InfHandle, <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>, RuleIndex, 0);
01155     <span class="keywordflow">if</span> (install)
01156     {
01157         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/geninst_8h.html#a0">CmpGenInstall</a>(InfHandle, install))
01158         {
01159             <span class="comment">//</span>
01160             <span class="comment">// Successfully installed the specified section.</span>
01161             <span class="comment">//</span>
01162 
01163             match = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01164         }
01165     }
01166 
01167     <span class="keywordflow">return</span> (match);
01168 }
01169 
01170 BOOLEAN
<a name="l01171"></a><a class="code" href="../../d9/d3/rules_8c.html#a33">01171</a> <a class="code" href="../../d9/d3/rules_8c.html#a33">CmpMatchAcpiOemIdRule</a>(
01172     IN PVOID InfHandle,
01173     IN PCHAR Description,
01174     IN ULONG RuleIndex
01175     )
01176 <span class="comment">/*++</span>
01177 <span class="comment"></span>
01178 <span class="comment">Routine Description:</span>
01179 <span class="comment"></span>
01180 <span class="comment">    This function processes a ACPI OEM ID rule from an INF file</span>
01181 <span class="comment"></span>
01182 <span class="comment">    Examples:</span>
01183 <span class="comment"></span>
01184 <span class="comment">        AcpiOemId="RSDT", "123456"</span>
01185 <span class="comment"></span>
01186 <span class="comment">    is true if the RSDT has the OEM ID of 123456.</span>
01187 <span class="comment"></span>
01188 <span class="comment">        AcpiOemId="DSDT", "768000"</span>
01189 <span class="comment"></span>
01190 <span class="comment">    is true if the DSDT has the OEM ID of 768000.</span>
01191 <span class="comment"></span>
01192 <span class="comment">Arguments:</span>
01193 <span class="comment"></span>
01194 <span class="comment">    InfHandle - Handle of the inf containing the rule.</span>
01195 <span class="comment"></span>
01196 <span class="comment">    Description - Specifies the section name the rule is in</span>
01197 <span class="comment"></span>
01198 <span class="comment">    RuleIndex - Specifies the index of the rule in the section</span>
01199 <span class="comment"></span>
01200 <span class="comment">Return Value:</span>
01201 <span class="comment"></span>
01202 <span class="comment">    TRUE - the computer has the specified ACPI OEM ID.</span>
01203 <span class="comment"></span>
01204 <span class="comment">    FALSE - the computer does not have the specified ACPI OEM ID.</span>
01205 <span class="comment"></span>
01206 <span class="comment">--*/</span>
01207 
01208 {
01209     BOOLEAN             anyCase = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01210     BOOLEAN             match = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01211     PCHAR               tableName;
01212     PCHAR               oemId;
01213     PCHAR               optionalArgs;
01214     ULONG               length;
01215     <a class="code" href="../../d6/d2/struct__DESCRIPTION__HEADER.html">PDESCRIPTION_HEADER</a> header;
01216     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>                tableOemId[7];
01217     STRING              acpiString;
01218     STRING              tableString;
01219 
01220     tableName = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(
01221         InfHandle,
01222         <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>,
01223         RuleIndex,
01224         0
01225         );
01226     oemId = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(
01227         InfHandle,
01228         <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>,
01229         RuleIndex,
01230         1
01231         );
01232     <span class="keywordflow">if</span> (tableName &amp;&amp; oemId) {
01233 
01234         <span class="comment">//</span>
01235         <span class="comment">// See if we have to do a case insensitive match</span>
01236         <span class="comment">//</span>
01237         optionalArgs = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(
01238             InfHandle,
01239             <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>,
01240             RuleIndex,
01241             2
01242             );
01243         <span class="keywordflow">if</span> (optionalArgs) {
01244 
01245             <span class="keywordflow">if</span> (_stricmp(optionalArgs,<span class="stringliteral">"any"</span>) == 0) {
01246 
01247                 anyCase = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01248 
01249             }
01250 
01251         }
01252 
01253         <span class="comment">//</span>
01254         <span class="comment">// Find the specified table in the BIOS ROM.</span>
01255         <span class="comment">//</span>
01256         header = <a class="code" href="../../d9/d3/rules_8c.html#a17">CmpFindACPITable</a>(*(PULONG)tableName, &amp;length);
01257         <span class="keywordflow">if</span> (header) {
01258 
01259             <span class="comment">//</span>
01260             <span class="comment">// Build the OEM id from the table</span>
01261             <span class="comment">//</span>
01262             RtlZeroMemory(tableOemId, <span class="keyword">sizeof</span>(tableOemId));
01263             RtlCopyMemory(tableOemId, header-&gt;<a class="code" href="../../d6/d2/struct__DESCRIPTION__HEADER.html#o4">OEMID</a>, <span class="keyword">sizeof</span>(header-&gt;<a class="code" href="../../d6/d2/struct__DESCRIPTION__HEADER.html#o4">OEMID</a>));
01264             <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;tableString, tableOemId );
01265 
01266             <span class="comment">//</span>
01267             <span class="comment">// And one from the string in the file</span>
01268             <span class="comment">//</span>
01269             <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;acpiString, oemId );
01270 
01271             <span class="comment">//</span>
01272             <span class="comment">// Now see if they are equal</span>
01273             <span class="comment">//</span>
01274             match = <a class="code" href="../../d2/d7/string_8c.html#a11">RtlEqualString</a>( &amp;acpiString, &amp;tableString, anyCase );
01275 
01276             <span class="comment">//</span>
01277             <span class="comment">// Unmap the table</span>
01278             <span class="comment">//</span>
01279             <a class="code" href="../../d5/d6/iosup_8c.html#a58">MmUnmapIoSpace</a>(header, length );
01280 
01281         }
01282 
01283     }
01284     <span class="keywordflow">return</span> (match);
01285 }
01286 
01287 BOOLEAN
<a name="l01288"></a><a class="code" href="../../d9/d3/rules_8c.html#a34">01288</a> <a class="code" href="../../d9/d3/rules_8c.html#a34">CmpMatchAcpiOemTableIdRule</a>(
01289     IN PVOID InfHandle,
01290     IN PCHAR Description,
01291     IN ULONG RuleIndex
01292     )
01293 <span class="comment">/*++</span>
01294 <span class="comment"></span>
01295 <span class="comment">Routine Description:</span>
01296 <span class="comment"></span>
01297 <span class="comment">    This function processes a ACPI OEM Table ID rule from an INF file.</span>
01298 <span class="comment"></span>
01299 <span class="comment">    Examples:</span>
01300 <span class="comment"></span>
01301 <span class="comment">    AcpiOemTableId="RSDT", "12345678"</span>
01302 <span class="comment"></span>
01303 <span class="comment">        is true if the RSDT has the Oem Table ID of 12345678.</span>
01304 <span class="comment"></span>
01305 <span class="comment">    AcpiOemTableId="DSDT", "87654321"</span>
01306 <span class="comment"></span>
01307 <span class="comment">        is true if the DSDT has the Oem Table ID of 87654321.</span>
01308 <span class="comment"></span>
01309 <span class="comment">Arguments:</span>
01310 <span class="comment"></span>
01311 <span class="comment">    InfHandle - Handle of the inf containing the rule.</span>
01312 <span class="comment"></span>
01313 <span class="comment">    Description - Specifies the section name the rule is in</span>
01314 <span class="comment"></span>
01315 <span class="comment">    RuleIndex - Specifies the index of the rule in the section</span>
01316 <span class="comment"></span>
01317 <span class="comment">Return Value:</span>
01318 <span class="comment"></span>
01319 <span class="comment">    TRUE - the computer has the specified ACPI OEM Table ID.</span>
01320 <span class="comment"></span>
01321 <span class="comment">    FALSE - the computer does not have the specified ACPI OEM Table ID.</span>
01322 <span class="comment"></span>
01323 <span class="comment">--*/</span>
01324 
01325 {
01326     BOOLEAN             match = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01327     PCHAR               tableName;
01328     PCHAR               oemTableId;
01329     ULONG               length;
01330     <a class="code" href="../../d6/d2/struct__DESCRIPTION__HEADER.html">PDESCRIPTION_HEADER</a> header;
01331     ULONG               idLength;
01332     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>                acpiOemTableId[8];
01333 
01334     tableName = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(
01335         InfHandle,
01336         <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>,
01337         RuleIndex,
01338         0
01339         );
01340     oemTableId = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(
01341         InfHandle,
01342         <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>,
01343         RuleIndex,
01344         1
01345         );
01346     <span class="keywordflow">if</span> (tableName &amp;&amp; oemTableId) {
01347 
01348         <span class="comment">//</span>
01349         <span class="comment">// Find the specified table in the BIOS ROM.</span>
01350         <span class="comment">//</span>
01351         header = <a class="code" href="../../d9/d3/rules_8c.html#a17">CmpFindACPITable</a>(*(PULONG)tableName, &amp;length);
01352         <span class="keywordflow">if</span> (header) {
01353 
01354             RtlZeroMemory(acpiOemTableId, <span class="keyword">sizeof</span>(acpiOemTableId));
01355             idLength = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(oemTableId);
01356             <span class="keywordflow">if</span> (idLength &gt; <span class="keyword">sizeof</span>(acpiOemTableId)) {
01357 
01358                 idLength = <span class="keyword">sizeof</span>(acpiOemTableId);
01359 
01360             }
01361             RtlCopyMemory(acpiOemTableId, oemTableId, idLength);
01362             match = RtlEqualMemory(acpiOemTableId, header-&gt;<a class="code" href="../../d6/d2/struct__DESCRIPTION__HEADER.html#o5">OEMTableID</a>, <span class="keyword">sizeof</span>(header-&gt;<a class="code" href="../../d6/d2/struct__DESCRIPTION__HEADER.html#o5">OEMTableID</a>));
01363             <a class="code" href="../../d5/d6/iosup_8c.html#a58">MmUnmapIoSpace</a>( header, length );
01364 
01365         }
01366 
01367     }
01368     <span class="keywordflow">return</span> (match);
01369 }
01370 
01371 BOOLEAN
<a name="l01372"></a><a class="code" href="../../d9/d3/rules_8c.html#a35">01372</a> <a class="code" href="../../d9/d3/rules_8c.html#a35">CmpMatchAcpiOemRevisionRule</a>(
01373     IN PVOID InfHandle,
01374     IN PCHAR Description,
01375     IN ULONG RuleIndex
01376     )
01377 <span class="comment">/*++</span>
01378 <span class="comment"></span>
01379 <span class="comment">Routine Description:</span>
01380 <span class="comment"></span>
01381 <span class="comment">    This function processes a ACPI Oem Revision rule from an INF file.</span>
01382 <span class="comment"></span>
01383 <span class="comment">    Examples:</span>
01384 <span class="comment"></span>
01385 <span class="comment">    AcpiOemRevision="=","RSDT", 1234</span>
01386 <span class="comment"></span>
01387 <span class="comment">        is true if the RSDT has the Oem Revision EQUAL to 1234.</span>
01388 <span class="comment"></span>
01389 <span class="comment">    AcpiOemRevision="&gt;","DSDT", 4321</span>
01390 <span class="comment"></span>
01391 <span class="comment">        is true if the DSDT has the Oem Revision GREATER than 4321.</span>
01392 <span class="comment"></span>
01393 <span class="comment">Arguments:</span>
01394 <span class="comment"></span>
01395 <span class="comment">    InfHandle - Handle of the inf containing the rule.</span>
01396 <span class="comment"></span>
01397 <span class="comment">    Description - Specifies the section name the rule is in</span>
01398 <span class="comment"></span>
01399 <span class="comment">    RuleIndex - Specifies the index of the rule in the section</span>
01400 <span class="comment"></span>
01401 <span class="comment">Return Value:</span>
01402 <span class="comment"></span>
01403 <span class="comment">    TRUE - the computer has the specified ACPI Oem Revision.</span>
01404 <span class="comment"></span>
01405 <span class="comment">    FALSE - the computer does not have the specified ACPI Oem Revision.</span>
01406 <span class="comment"></span>
01407 <span class="comment">--*/</span>
01408 
01409 {
01410     BOOLEAN             match = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01411     PCHAR               op;
01412     PCHAR               tableName;
01413     PCHAR               oemRevisionStr;
01414     ULONG               oemRevision;
01415     ULONG               length;
01416     <a class="code" href="../../d6/d2/struct__DESCRIPTION__HEADER.html">PDESCRIPTION_HEADER</a> header;
01417 
01418     op = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(
01419         InfHandle,
01420         <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>,
01421         RuleIndex,
01422         0
01423         );
01424     tableName = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(
01425         InfHandle,
01426         <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>,
01427         RuleIndex,
01428         1
01429         );
01430     oemRevisionStr = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(
01431         InfHandle,
01432         <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>,
01433         RuleIndex,
01434         2
01435         );
01436     <span class="keywordflow">if</span> (op &amp;&amp; tableName &amp;&amp; oemRevisionStr) {
01437 
01438         <span class="comment">//</span>
01439         <span class="comment">// Find the specified table.</span>
01440         <span class="comment">//</span>
01441         header = <a class="code" href="../../d9/d3/rules_8c.html#a17">CmpFindACPITable</a>(*(PULONG)tableName, &amp;length);
01442         <span class="keywordflow">if</span> (header) {
01443 
01444             <a class="code" href="../../d9/d3/cnvint_8c.html#a3">RtlCharToInteger</a>(oemRevisionStr, 16, &amp;oemRevision);
01445             match = <a class="code" href="../../d9/d3/rules_8c.html#a18">CmpCheckOperator</a>(op, header-&gt;<a class="code" href="../../d6/d2/struct__DESCRIPTION__HEADER.html#o6">OEMRevision</a>, oemRevision);
01446             <a class="code" href="../../d5/d6/iosup_8c.html#a58">MmUnmapIoSpace</a>(header, length);
01447 
01448         }
01449 
01450     }
01451     <span class="keywordflow">return</span>(match);
01452 
01453 }
01454 
01455 BOOLEAN
<a name="l01456"></a><a class="code" href="../../d9/d3/rules_8c.html#a36">01456</a> <a class="code" href="../../d9/d3/rules_8c.html#a36">CmpMatchAcpiRevisionRule</a>(
01457     IN PVOID InfHandle,
01458     IN PCHAR Description,
01459     IN ULONG RuleIndex
01460     )
01461 <span class="comment">/*++</span>
01462 <span class="comment"></span>
01463 <span class="comment">Routine Description:</span>
01464 <span class="comment"></span>
01465 <span class="comment">    This function processes a ACPI Revision rule from an INF file.</span>
01466 <span class="comment"></span>
01467 <span class="comment">    Examples:</span>
01468 <span class="comment"></span>
01469 <span class="comment">        AcpiRevision="=", "RSDT", 1234</span>
01470 <span class="comment"></span>
01471 <span class="comment">    is true if the RSDT ACPI Revision is EQUAL to 1234.</span>
01472 <span class="comment"></span>
01473 <span class="comment">        AcpiRevision="&gt;", "DSDT", 4321</span>
01474 <span class="comment"></span>
01475 <span class="comment">    is true if the DSDT ACPI Revision is GREATER than 4321.</span>
01476 <span class="comment"></span>
01477 <span class="comment">Arguments:</span>
01478 <span class="comment"></span>
01479 <span class="comment">    InfHandle - Handle of the inf containing the rule.</span>
01480 <span class="comment"></span>
01481 <span class="comment">    Description - Specifies the section name the rule is in</span>
01482 <span class="comment"></span>
01483 <span class="comment">    RuleIndex - Specifies the index of the rule in the section</span>
01484 <span class="comment"></span>
01485 <span class="comment">Return Value:</span>
01486 <span class="comment"></span>
01487 <span class="comment">    TRUE - the computer has the specified ACPI Revision.</span>
01488 <span class="comment"></span>
01489 <span class="comment">    FALSE - the computer does not have the specified ACPI Revision.</span>
01490 <span class="comment"></span>
01491 <span class="comment">--*/</span>
01492 
01493 {
01494     BOOLEAN             match = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01495     PCHAR               op;
01496     PCHAR               tableName;
01497     PCHAR               revisionStr;
01498     ULONG               revision;
01499     ULONG               length;
01500     <a class="code" href="../../d6/d2/struct__DESCRIPTION__HEADER.html">PDESCRIPTION_HEADER</a> header;
01501 
01502     op = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(
01503         InfHandle,
01504         <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>,
01505         RuleIndex,
01506         0
01507         );
01508     tableName = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(
01509         InfHandle,
01510         <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>,
01511         RuleIndex,
01512         1
01513         );
01514     revisionStr = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(
01515         InfHandle,
01516         <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>,
01517         RuleIndex,
01518         2
01519         );
01520     <span class="keywordflow">if</span> (op &amp;&amp; tableName &amp;&amp; revisionStr){
01521 
01522         <span class="comment">//</span>
01523         <span class="comment">// Find the specified table.</span>
01524         <span class="comment">//</span>
01525         header = <a class="code" href="../../d9/d3/rules_8c.html#a17">CmpFindACPITable</a>(*(PULONG)tableName, &amp;length);
01526         <span class="keywordflow">if</span> (header) {
01527 
01528             <a class="code" href="../../d9/d3/cnvint_8c.html#a3">RtlCharToInteger</a>(revisionStr, 16, &amp;revision);
01529             match = <a class="code" href="../../d9/d3/rules_8c.html#a18">CmpCheckOperator</a>(op, header-&gt;<a class="code" href="../../d6/d2/struct__DESCRIPTION__HEADER.html#o2">Revision</a>, revision);
01530             <a class="code" href="../../d5/d6/iosup_8c.html#a58">MmUnmapIoSpace</a>(header, length);
01531 
01532         }
01533 
01534     }
01535     <span class="keywordflow">return</span>(match);
01536 
01537 }
01538 
01539 BOOLEAN
<a name="l01540"></a><a class="code" href="../../d9/d3/rules_8c.html#a37">01540</a> <a class="code" href="../../d9/d3/rules_8c.html#a37">CmpMatchAcpiCreatorRevisionRule</a>(
01541     IN PVOID InfHandle,
01542     IN PCHAR Description,
01543     IN ULONG RuleIndex
01544     )
01545 <span class="comment">/*++</span>
01546 <span class="comment"></span>
01547 <span class="comment">Routine Description:</span>
01548 <span class="comment"></span>
01549 <span class="comment">    This function processes a ACPI Creator Revision rule from an INF file.</span>
01550 <span class="comment"></span>
01551 <span class="comment">    Examples:</span>
01552 <span class="comment"></span>
01553 <span class="comment">        AcpiCreatorRevision="=", "RSDT", 1234</span>
01554 <span class="comment"></span>
01555 <span class="comment">    is true if the RSDT ACPI Creator Revision is EQUAL to 1234.</span>
01556 <span class="comment"></span>
01557 <span class="comment">        AcpiCreatorRevision="&gt;", "DSDT", 4321</span>
01558 <span class="comment"></span>
01559 <span class="comment">    is true if the DSDT ACPI Creator Revision is GREATER than 4321.</span>
01560 <span class="comment"></span>
01561 <span class="comment">Arguments:</span>
01562 <span class="comment"></span>
01563 <span class="comment">    InfHandle - Handle of the inf containing the rule.</span>
01564 <span class="comment"></span>
01565 <span class="comment">    Description - Specifies the section name the rule is in</span>
01566 <span class="comment"></span>
01567 <span class="comment">    RuleIndex - Specifies the index of the rule in the section</span>
01568 <span class="comment"></span>
01569 <span class="comment">Return Value:</span>
01570 <span class="comment"></span>
01571 <span class="comment">    TRUE - the computer has the specified ACPI Creator Revision.</span>
01572 <span class="comment"></span>
01573 <span class="comment">    FALSE - the computer does not have the specified ACPI Creator Revision.</span>
01574 <span class="comment"></span>
01575 <span class="comment">--*/</span>
01576 
01577 {
01578     BOOLEAN             match = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01579     PCHAR               op;
01580     PCHAR               tableName;
01581     PCHAR               creatorRevisionStr;
01582     ULONG               creatorRevision;
01583     ULONG               length;
01584     <a class="code" href="../../d6/d2/struct__DESCRIPTION__HEADER.html">PDESCRIPTION_HEADER</a> header;
01585 
01586     op = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(
01587         InfHandle,
01588         <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>,
01589         RuleIndex,
01590         0
01591         );
01592     tableName = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(
01593         InfHandle,
01594         <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>,
01595         RuleIndex,
01596         1
01597         );
01598     creatorRevisionStr = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(
01599         InfHandle,
01600         <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>,
01601         RuleIndex,
01602         2
01603         );
01604     <span class="keywordflow">if</span> (op &amp;&amp; tableName &amp;&amp; creatorRevisionStr) {
01605 
01606         <span class="comment">//</span>
01607         <span class="comment">// Find the specified table.</span>
01608         <span class="comment">//</span>
01609         header = <a class="code" href="../../d9/d3/rules_8c.html#a17">CmpFindACPITable</a>(*(PULONG)tableName, &amp;length);
01610         <span class="keywordflow">if</span> (header){
01611 
01612             <a class="code" href="../../d9/d3/cnvint_8c.html#a3">RtlCharToInteger</a>(creatorRevisionStr, 16, &amp;creatorRevision);
01613             match = <a class="code" href="../../d9/d3/rules_8c.html#a18">CmpCheckOperator</a>(op, header-&gt;<a class="code" href="../../d6/d2/struct__DESCRIPTION__HEADER.html#o8">CreatorRev</a>, creatorRevision);
01614             <a class="code" href="../../d5/d6/iosup_8c.html#a58">MmUnmapIoSpace</a>( header, length );
01615 
01616         }
01617 
01618     }
01619     <span class="keywordflow">return</span>(match);
01620 }
01621 
01622 BOOLEAN
<a name="l01623"></a><a class="code" href="../../d9/d3/rules_8c.html#a39">01623</a> <a class="code" href="../../d9/d3/rules_8c.html#a39">CmpMatchAcpiCreatorIdRule</a>(
01624     IN PVOID InfHandle,
01625     IN PCHAR Description,
01626     IN ULONG RuleIndex
01627     )
01628 <span class="comment">/*++</span>
01629 <span class="comment"></span>
01630 <span class="comment">Routine Description:</span>
01631 <span class="comment"></span>
01632 <span class="comment">    This function processes a ACPI Creator ID rule from an INF file.</span>
01633 <span class="comment"></span>
01634 <span class="comment">    Examples:</span>
01635 <span class="comment"></span>
01636 <span class="comment">        AcpiCreatorId="RSDT", "MSFT"</span>
01637 <span class="comment"></span>
01638 <span class="comment">    is true if the RSDT has the Creator ID of MSFT.</span>
01639 <span class="comment"></span>
01640 <span class="comment">Arguments:</span>
01641 <span class="comment"></span>
01642 <span class="comment">    InfHandle - Handle of the inf containing the rule.</span>
01643 <span class="comment"></span>
01644 <span class="comment">    Description - Specifies the section name the rule is in</span>
01645 <span class="comment"></span>
01646 <span class="comment">    RuleIndex - Specifies the index of the rule in the section</span>
01647 <span class="comment"></span>
01648 <span class="comment">Return Value:</span>
01649 <span class="comment"></span>
01650 <span class="comment">    TRUE - the computer has the specified ACPI Creator ID.</span>
01651 <span class="comment"></span>
01652 <span class="comment">    FALSE - the computer does not have the specified ACPI Creator ID.</span>
01653 <span class="comment"></span>
01654 <span class="comment">--*/</span>
01655 
01656 {
01657     BOOLEAN             match = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01658     PCHAR               tableName;
01659     PCHAR               creatorId;
01660     ULONG               length;
01661     <a class="code" href="../../d6/d2/struct__DESCRIPTION__HEADER.html">PDESCRIPTION_HEADER</a> header;
01662     ULONG               idLength;
01663     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>                acpiCreatorId[6];
01664 
01665     tableName = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(
01666         InfHandle,
01667         <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>,
01668         RuleIndex,
01669         0
01670         );
01671     creatorId = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(
01672         InfHandle,
01673         <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>,
01674         RuleIndex,
01675         1
01676         );
01677     <span class="keywordflow">if</span> (tableName &amp;&amp; creatorId) {
01678 
01679         <span class="comment">//</span>
01680         <span class="comment">// Find the specified table.</span>
01681         <span class="comment">//</span>
01682         header = <a class="code" href="../../d9/d3/rules_8c.html#a17">CmpFindACPITable</a>(*(PULONG)tableName, &amp;length);
01683         <span class="keywordflow">if</span> (header) {
01684 
01685             RtlZeroMemory(acpiCreatorId, <span class="keyword">sizeof</span>(acpiCreatorId));
01686             idLength = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(creatorId);
01687             <span class="keywordflow">if</span> (idLength &gt; <span class="keyword">sizeof</span>(acpiCreatorId)) {
01688 
01689                 idLength = <span class="keyword">sizeof</span>(acpiCreatorId);
01690 
01691             }
01692             RtlCopyMemory(acpiCreatorId, creatorId, idLength);
01693             match = RtlEqualMemory(acpiCreatorId, header-&gt;<a class="code" href="../../d6/d2/struct__DESCRIPTION__HEADER.html#o7">CreatorID</a>, <span class="keyword">sizeof</span>(header-&gt;<a class="code" href="../../d6/d2/struct__DESCRIPTION__HEADER.html#o7">CreatorID</a>));
01694             <a class="code" href="../../d5/d6/iosup_8c.html#a58">MmUnmapIoSpace</a>( header, length );
01695 
01696         }
01697 
01698     }
01699     <span class="keywordflow">return</span>(match);
01700 }
01701 
01702 BOOLEAN
<a name="l01703"></a><a class="code" href="../../d9/d3/rules_8c.html#a20">01703</a> <a class="code" href="../../d9/d3/rules_8c.html#a20">CmpGetInfData</a>(
01704     IN PVOID InfHandle,
01705     IN PCHAR Section,
01706     IN ULONG LineIndex,
01707     IN ULONG ValueIndex,
01708     IN OUT PCHAR Buffer,
01709     IN OUT PULONG BufferSize
01710     )
01711 
01712 <span class="comment">/*++</span>
01713 <span class="comment"></span>
01714 <span class="comment">    Routine Description:</span>
01715 <span class="comment"></span>
01716 <span class="comment">        This routine reads and parses data from the inf. It understands</span>
01717 <span class="comment">        two kinds of data 1. String 2. Binary.</span>
01718 <span class="comment"></span>
01719 <span class="comment">        Examples-</span>
01720 <span class="comment"></span>
01721 <span class="comment">        B,02 - byte 0x02</span>
01722 <span class="comment">        B,72,0D,FF,0F - sequence of bytes 0x72 0x0D 0xFF 0x0F or the DWORD 0x0FFF0D72</span>
01723 <span class="comment">        S,COMPAQ - ASCII string "COMPAQ"</span>
01724 <span class="comment"></span>
01725 <span class="comment">    Input Parameters:</span>
01726 <span class="comment"></span>
01727 <span class="comment">        InfHandle - Handle to the inf to be read.</span>
01728 <span class="comment"></span>
01729 <span class="comment">        Section - Section name to be read.</span>
01730 <span class="comment"></span>
01731 <span class="comment">        LineIndex - Index of the line in the Section to be read.</span>
01732 <span class="comment"></span>
01733 <span class="comment">        ValueIndex - First value to be read on the LineIndex.</span>
01734 <span class="comment"></span>
01735 <span class="comment">        Buffer - Parsed data gets returned in this buffer.</span>
01736 <span class="comment"></span>
01737 <span class="comment">        BufferSize - On entry, contains the size of Buffer.</span>
01738 <span class="comment">        The number of bytes parsed in gets returned in this</span>
01739 <span class="comment">        variable.</span>
01740 <span class="comment"></span>
01741 <span class="comment">    Return Value:</span>
01742 <span class="comment"></span>
01743 <span class="comment">        TRUE iff data was parsed in successfully. Else FALSE.</span>
01744 <span class="comment"></span>
01745 <span class="comment">--*/</span>
01746 
01747 {
01748     BOOLEAN result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01749     ULONG   cbData;
01750     PCHAR   data;
01751     ULONG   remainingBytes;
01752 
01753     <span class="comment">//</span>
01754     <span class="comment">// Validate input parameters.</span>
01755     <span class="comment">//</span>
01756 
01757     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> &amp;&amp; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> &amp;&amp; *<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>)
01758     {
01759         <span class="comment">//</span>
01760         <span class="comment">// Read in the data type "S" or "B".</span>
01761         <span class="comment">//</span>
01762 
01763         PCHAR <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(InfHandle, Section, LineIndex, ValueIndex++);
01764         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>)
01765         {
01766             <span class="comment">//</span>
01767             <span class="comment">// Initialize local data.</span>
01768             <span class="comment">//</span>
01769 
01770             remainingBytes = *<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
01771 
01772             <span class="comment">//</span>
01773             <span class="comment">// Process Binary data.</span>
01774             <span class="comment">//</span>
01775 
01776             <span class="keywordflow">if</span> (_stricmp(<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>, <span class="stringliteral">"B"</span>) == 0)
01777             {
01778 
01779                 <span class="comment">//</span>
01780                 <span class="comment">// Parse data as long as there is more data and the buffer is not full.</span>
01781                 <span class="comment">//</span>
01782 
01783                 <span class="keywordflow">for</span> (result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>; result == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; remainingBytes; remainingBytes--)
01784                 {
01785                     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>    value;
01786 
01787                     <span class="comment">//</span>
01788                     <span class="comment">// Read in the data.</span>
01789                     <span class="comment">//</span>
01790 
01791                     data = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(InfHandle, Section, LineIndex, ValueIndex++);
01792                     <span class="keywordflow">if</span> (data)
01793                     {
01794                         <span class="comment">//</span>
01795                         <span class="comment">// Convert the data read in and validate that is indeed a HEX value.</span>
01796                         <span class="comment">//</span>
01797 
01798                         value = (<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)strtoul(data, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16);
01799                         <span class="keywordflow">if</span> (value == 0 &amp;&amp; strcmp(data, <span class="stringliteral">"00"</span>) &amp;&amp; strcmp(data, <span class="stringliteral">"0"</span>))
01800                         {
01801                             result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01802                         }
01803                         <span class="keywordflow">else</span>
01804                         {
01805                             *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>++ = value;
01806                         }
01807                     }
01808                     <span class="keywordflow">else</span>
01809                     {
01810                         <span class="keywordflow">break</span>;
01811                     }
01812                 }
01813 
01814                 <span class="comment">//</span>
01815                 <span class="comment">// Return the number of bytes parsed in.</span>
01816                 <span class="comment">//</span>
01817 
01818                 *<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> -= remainingBytes;
01819             }
01820 
01821             <span class="comment">//</span>
01822             <span class="comment">// Process String data.</span>
01823             <span class="comment">//</span>
01824 
01825             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(_stricmp(<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>, <span class="stringliteral">"S"</span>) == 0)
01826             {
01827                 <span class="comment">//</span>
01828                 <span class="comment">// Read in the string.</span>
01829                 <span class="comment">//</span>
01830 
01831                 data = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(InfHandle, Section, LineIndex, ValueIndex);
01832 
01833                 <span class="comment">//</span>
01834                 <span class="comment">// Only copy as much data as the buffer can hold.</span>
01835                 <span class="comment">//</span>
01836 
01837                 cbData = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(remainingBytes, <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(data));
01838                 RtlCopyBytes(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, data, cbData);
01839 
01840                 <span class="comment">//</span>
01841                 <span class="comment">// Return the number of bytes actually copied.</span>
01842                 <span class="comment">//</span>
01843 
01844                 *<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = cbData;
01845                 result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01846             }
01847         }
01848     }
01849 
01850     <span class="keywordflow">return</span> (result);
01851 }
01852 
01853 PVOID
<a name="l01854"></a><a class="code" href="../../d9/d3/rules_8c.html#a19">01854</a> <a class="code" href="../../d9/d3/rules_8c.html#a19">CmpMapPhysicalAddress</a>(
01855     IN OUT PVOID *BaseAddress,
01856     IN ULONG Address,
01857     IN ULONG Size
01858     )
01859 
01860 <span class="comment">/*++</span>
01861 <span class="comment"></span>
01862 <span class="comment">    Routine Description:</span>
01863 <span class="comment"></span>
01864 <span class="comment">        This routine maps the specified physical segment into the process</span>
01865 <span class="comment">        virtual memory.</span>
01866 <span class="comment"></span>
01867 <span class="comment">    Input Parameters:</span>
01868 <span class="comment"></span>
01869 <span class="comment">        Segment - Segment to be mapped.</span>
01870 <span class="comment"></span>
01871 <span class="comment">        Size - Segment size to be mapped.</span>
01872 <span class="comment"></span>
01873 <span class="comment">    Return Value:</span>
01874 <span class="comment"></span>
01875 <span class="comment">        Virtual address for the mapped segment.</span>
01876 <span class="comment"></span>
01877 <span class="comment">--*/</span>
01878 
01879 {
01880     UNICODE_STRING      sectionName;
01881     OBJECT_ATTRIBUTES   objectAttributes;
01882     HANDLE              sectionHandle;
01883     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            status;
01884     PVOID               baseAddress;
01885     ULONG               viewSize;
01886     LARGE_INTEGER       viewBase;
01887     PVOID               ptr = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01888 
01889     *BaseAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01890 
01891     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;sectionName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Device\\PhysicalMemory"</span>);
01892     InitializeObjectAttributes( &amp;objectAttributes,
01893                                 &amp;sectionName,
01894                                 OBJ_CASE_INSENSITIVE,
01895                                 (HANDLE)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01896                                 (PSECURITY_DESCRIPTOR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01897     status = ZwOpenSection( &amp;sectionHandle,
01898                             SECTION_MAP_READ,
01899                             &amp;objectAttributes);
01900     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
01901     {
01902         baseAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01903         viewSize = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
01904         viewBase.LowPart = Address &amp; ~(0xFFF);
01905         viewBase.HighPart = 0;
01906         status = ZwMapViewOfSection(    sectionHandle,
01907                                         NtCurrentProcess(),
01908                                         &amp;baseAddress,
01909                                         0,
01910                                         viewSize,
01911                                         &amp;viewBase,
01912                                         &amp;viewSize,
01913                                         ViewUnmap,
01914                                         MEM_DOS_LIM,
01915                                         PAGE_READWRITE);
01916         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
01917         {
01918             ptr = (PVOID)((PCHAR)baseAddress + (Address &amp; 0xFFF));
01919             *BaseAddress = baseAddress;
01920         }
01921     }
01922 
01923     <span class="keywordflow">return</span> (ptr);
01924 }
01925 
01926     BOOLEAN
<a name="l01927"></a><a class="code" href="../../d9/d3/rules_8c.html#a18">01927</a> <a class="code" href="../../d9/d3/rules_8c.html#a18">CmpCheckOperator</a>(
01928     IN PCHAR Operator,
01929     IN ULONG Lhs,
01930     IN ULONG Rhs
01931     )
01932 
01933 <span class="comment">/*++</span>
01934 <span class="comment"></span>
01935 <span class="comment">    Routine Description:</span>
01936 <span class="comment"></span>
01937 <span class="comment">        This routine tests condition specified by the operator by</span>
01938 <span class="comment">        applying it to the specified LHS and RHS arguments.</span>
01939 <span class="comment"></span>
01940 <span class="comment">    Input Parameters:</span>
01941 <span class="comment"></span>
01942 <span class="comment">        Operator - Is the operator to be tested.</span>
01943 <span class="comment"></span>
01944 <span class="comment">        Lhs - Left Hand Side argument for the Operator.</span>
01945 <span class="comment"></span>
01946 <span class="comment">        Rhs - Right Hand Side argument for the Operator.</span>
01947 <span class="comment"></span>
01948 <span class="comment">    Return Value:</span>
01949 <span class="comment"></span>
01950 <span class="comment">        True iff the condition Lhs Operator Rhs is satisfied.</span>
01951 <span class="comment"></span>
01952 <span class="comment">--*/</span>
01953 
01954 {
01955     BOOLEAN result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01956 
01957     <span class="comment">//</span>
01958     <span class="comment">// We are pretty lenient about which operators we support.</span>
01959     <span class="comment">//</span>
01960 
01961     <span class="comment">//</span>
01962     <span class="comment">// "=" or "==" for EQUAL.</span>
01963     <span class="comment">//</span>
01964 
01965     <span class="keywordflow">if</span> (strcmp(Operator, <span class="stringliteral">"="</span>) == 0 || strcmp(Operator, <span class="stringliteral">"=="</span>) == 0)
01966     {
01967         result = (Lhs == Rhs);
01968     }
01969 
01970     <span class="comment">//</span>
01971     <span class="comment">// "!=" or "=!" or "&lt;&gt;" for NOT EQUAL.</span>
01972     <span class="comment">//</span>
01973 
01974     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(    strcmp(Operator, <span class="stringliteral">"!="</span>) == 0 ||
01975                 strcmp(Operator, <span class="stringliteral">"&lt;&gt;"</span>) == 0 ||
01976                 strcmp(Operator, <span class="stringliteral">"=!"</span>) == 0)
01977     {
01978         result = (Lhs != Rhs);
01979     }
01980 
01981     <span class="comment">//</span>
01982     <span class="comment">// "&lt;" for LESS THAN.</span>
01983     <span class="comment">//</span>
01984 
01985     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strcmp(Operator, <span class="stringliteral">"&lt;"</span>) == 0)
01986     {
01987         result = (Lhs &lt; Rhs);
01988     }
01989 
01990     <span class="comment">//</span>
01991     <span class="comment">// "&lt;=" or "=&lt;" for LESS THAN or EQUAL.</span>
01992     <span class="comment">//</span>
01993 
01994     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strcmp(Operator, <span class="stringliteral">"&lt;="</span>) == 0 || strcmp(Operator, <span class="stringliteral">"=&lt;"</span>) == 0)
01995     {
01996         result = (Lhs &lt;= Rhs);
01997     }
01998 
01999     <span class="comment">//</span>
02000     <span class="comment">// "&gt;" for GREATER THAN.</span>
02001     <span class="comment">//</span>
02002 
02003     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strcmp(Operator, <span class="stringliteral">"&gt;"</span>) == 0)
02004     {
02005         result = (Lhs &gt; Rhs);
02006     }
02007 
02008     <span class="comment">//</span>
02009     <span class="comment">// "&gt;=" or "=&gt;" for GREATER THAN or EQUAL.</span>
02010     <span class="comment">//</span>
02011 
02012     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strcmp(Operator, <span class="stringliteral">"&gt;="</span>) == 0 || strcmp(Operator, <span class="stringliteral">"=&gt;"</span>) == 0)
02013     {
02014         result = (Lhs &gt;= Rhs);
02015     }
02016     <span class="keywordflow">else</span>
02017     {
02018         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Invalid operator %s used!\n"</span>, Operator);
02019     }
02020 
02021     <span class="keywordflow">return</span> (result);
02022 }
02023 
02024 PVOID
<a name="l02025"></a><a class="code" href="../../d9/d3/rules_8c.html#a21">02025</a> <a class="code" href="../../d9/d3/rules_8c.html#a21">CmpFindPattern</a>(
02026     IN PCHAR Buffer,
02027     IN ULONG BufSize,
02028     IN PCHAR Pattern,
02029     IN ULONG PatSize,
02030     IN BOOLEAN IgnoreCase,
02031     IN ULONG Step
02032     )
02033 
02034 <span class="comment">/*++</span>
02035 <span class="comment"></span>
02036 <span class="comment">    Routine Description:</span>
02037 <span class="comment"></span>
02038 <span class="comment">        This routine searches the buffer for the specified pattern of data.</span>
02039 <span class="comment"></span>
02040 <span class="comment">    Input Parameters:</span>
02041 <span class="comment"></span>
02042 <span class="comment">        Buffer - Buffer to be searched.</span>
02043 <span class="comment"></span>
02044 <span class="comment">        BufSize - Size of this buffer.</span>
02045 <span class="comment"></span>
02046 <span class="comment">        Pattern - Pattern to be searched.</span>
02047 <span class="comment"></span>
02048 <span class="comment">        PatSize - Size of the pattern.</span>
02049 <span class="comment"></span>
02050 <span class="comment">        IgnoreCase - TRUE if the search is to be case insensitive.</span>
02051 <span class="comment"></span>
02052 <span class="comment">    Return Value:</span>
02053 <span class="comment"></span>
02054 <span class="comment">        Returns the pointer into the buffer where the pattern is first found.</span>
02055 <span class="comment"></span>
02056 <span class="comment">--*/</span>
02057 
02058 {
02059     PCHAR   bufEnd;
02060 
02061     <span class="keywordflow">if</span> (PatSize &gt; BufSize)
02062     {
02063         <span class="keywordflow">return</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02064     }
02065 
02066     <span class="keywordflow">if</span> (PatSize == 0)
02067     {
02068         PatSize = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(<a class="code" href="../../d9/d4/localrtl_8c.html#a2">Pattern</a>);
02069     }
02070 
02071     <span class="keywordflow">if</span> (Step == 0)
02072     {
02073         Step = 1;
02074     }
02075 
02076     <span class="keywordflow">for</span> (   bufEnd = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + BufSize;
02077             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + PatSize &lt; bufEnd;
02078             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> += Step)
02079     {
02080         <span class="keywordflow">if</span> (IgnoreCase)
02081         {
02082             <span class="keywordflow">if</span> (_strnicmp(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <a class="code" href="../../d9/d4/localrtl_8c.html#a2">Pattern</a>, PatSize) == 0)
02083             {
02084                 <span class="keywordflow">return</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
02085             }
02086         }
02087         <span class="keywordflow">else</span>
02088         {
02089             <span class="keywordflow">if</span> (strncmp(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <a class="code" href="../../d9/d4/localrtl_8c.html#a2">Pattern</a>, PatSize) == 0)
02090             {
02091                 <span class="keywordflow">return</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
02092             }
02093         }
02094     }
02095 
02096     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02097  }
02098 
02099  ULONG
<a name="l02100"></a><a class="code" href="../../d9/d3/rules_8c.html#a22">02100</a>  <a class="code" href="../../d9/d3/rules_8c.html#a22">CmpGetPnPBIOSTableAddress</a>(
02101     VOID
02102     )
02103 
02104 <span class="comment">/*++</span>
02105 <span class="comment"></span>
02106 <span class="comment">    Routine Description:</span>
02107 <span class="comment"></span>
02108 <span class="comment">        This routine searches the BIOS ROM for the PnP BIOS installation</span>
02109 <span class="comment">        structure.</span>
02110 <span class="comment"></span>
02111 <span class="comment">    Input Parameters:</span>
02112 <span class="comment"></span>
02113 <span class="comment">        None.</span>
02114 <span class="comment"></span>
02115 <span class="comment">    Return Value:</span>
02116 <span class="comment"></span>
02117 <span class="comment">        Returns the physical address in the ROM BIOS where the PnP</span>
02118 <span class="comment">        BIOS structure is located.</span>
02119 <span class="comment"></span>
02120 <span class="comment">--*/</span>
02121 
02122 {
02123     <span class="keyword">static</span> ULONG    tableAddress = (ULONG)-1;
02124     PVOID           baseAddress;
02125     <a class="code" href="../../d9/d3/rules_8c.html#a5">PPNP_BIOS_TABLE</a> address;
02126     <a class="code" href="../../d9/d3/rules_8c.html#a5">PPNP_BIOS_TABLE</a> lastAddress;
02127     ULONG           i;
02128     ULONG           checksum;
02129 
02130     <span class="keywordflow">if</span> (tableAddress == (ULONG)-1)
02131     {
02132         <span class="comment">//</span>
02133         <span class="comment">// Search for the PnPBIOS structure in the BIOS ROM.</span>
02134         <span class="comment">//</span>
02135 
02136         address = (<a class="code" href="../../d9/d3/rules_8c.html#a5">PPNP_BIOS_TABLE</a>)<a class="code" href="../../d9/d3/rules_8c.html#a19">CmpMapPhysicalAddress</a>(&amp;baseAddress, 0xF0000, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a4">SYSTEM_BIOS_LENGTH</a>);
02137         <span class="keywordflow">if</span> (address)
02138         {
02139             <span class="keywordflow">for</span> (   lastAddress = (<a class="code" href="../../d9/d3/rules_8c.html#a5">PPNP_BIOS_TABLE</a>)((PCHAR)address + <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a4">SYSTEM_BIOS_LENGTH</a> - 0x10);
02140                     address &lt; lastAddress;
02141                     (PCHAR)address += 0x10)
02142             {
02143                 <span class="keywordflow">if</span> (address-&gt;Signature == <a class="code" href="../../d9/d3/rules_8c.html#a2">PNPBIOS_SIGNATURE</a>)
02144                 {
02145                     <span class="keywordflow">for</span> (   i = 0, checksum = 0;
02146                             i &lt; address-&gt;Length;
02147                             i++)
02148                     {
02149                         checksum += ((PUCHAR)address)[i];
02150                     }
02151 
02152                     <span class="keywordflow">if</span> (    (checksum &amp; 0xFF) == 0 &amp;&amp;
02153                             address-&gt;Length &gt;= 0x21)
02154                     {
02155                         tableAddress = 0xF0000 + (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a4">SYSTEM_BIOS_LENGTH</a> - 10) - ((PCHAR)lastAddress - (PCHAR)address);
02156                         <span class="keywordflow">break</span>;
02157                     }
02158                 }
02159             }
02160 
02161             <span class="comment">//</span>
02162             <span class="comment">// Unmap the physical address.</span>
02163             <span class="comment">//</span>
02164 
02165             ZwUnmapViewOfSection(NtCurrentProcess(), baseAddress);
02166         }
02167     }
02168 
02169     <span class="keywordflow">return</span> (tableAddress);
02170 }
02171 
02172 <a class="code" href="../../d6/d2/struct__DESCRIPTION__HEADER.html">PDESCRIPTION_HEADER</a>
<a name="l02173"></a><a class="code" href="../../d9/d3/rules_8c.html#a17">02173</a> <a class="code" href="../../d9/d3/rules_8c.html#a17">CmpFindACPITable</a>(
02174     IN ULONG        Signature,
02175     IN OUT PULONG   Length
02176     )
02177 {
02178     <a class="code" href="../../d6/d2/struct__DESCRIPTION__HEADER.html">PDESCRIPTION_HEADER</a>     header      = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02179     <a class="code" href="../../d6/d2/struct__DESCRIPTION__HEADER.html">PDESCRIPTION_HEADER</a>     tempHeader  = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02180     <span class="keyword">static</span> PHYSICAL_ADDRESS rsdtAddress = { -1, -1 };
02181     ULONG                   length      = 0;
02182 
02183     <span class="comment">//</span>
02184     <span class="comment">// Use the cached location of RSDT address if available.</span>
02185     <span class="comment">//</span>
02186     <span class="keywordflow">if</span> (rsdtAddress.QuadPart == -1) {
02187 
02188         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                status;
02189         <a class="code" href="../../d4/d5/struct__ACPI__BIOS__MULTI__NODE.html">PACPI_BIOS_MULTI_NODE</a>   rsdpMulti;
02190 
02191         rsdtAddress.QuadPart = 0;
02192         <span class="comment">//</span>
02193         <span class="comment">// Get the multinode</span>
02194         <span class="comment">//</span>
02195         status = <a class="code" href="../../d9/d3/rules_8c.html#a15">CmpFindRSDTTable</a>( &amp;rsdpMulti );
02196         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02197 
02198             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02199 
02200         }
02201 
02202         <span class="comment">//</span>
02203         <span class="comment">// Map the address</span>
02204         <span class="comment">//</span>
02205         rsdtAddress.LowPart = rsdpMulti-&gt;<a class="code" href="../../d4/d5/struct__ACPI__BIOS__MULTI__NODE.html#o0">RsdtAddress</a>.LowPart;
02206         rsdtAddress.HighPart = rsdpMulti-&gt;<a class="code" href="../../d4/d5/struct__ACPI__BIOS__MULTI__NODE.html#o0">RsdtAddress</a>.HighPart;
02207 
02208         <span class="comment">//</span>
02209         <span class="comment">// Done with the multinode</span>
02210         <span class="comment">//</span>
02211         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( rsdpMulti );
02212 
02213     }
02214 
02215     <span class="comment">//</span>
02216     <span class="comment">// If we have an address</span>
02217     <span class="comment">//</span>
02218     <span class="keywordflow">if</span> (rsdtAddress.QuadPart) {
02219 
02220         <span class="comment">//</span>
02221         <span class="comment">// Map in the the rsdt table</span>
02222         <span class="comment">//</span>
02223         tempHeader = <a class="code" href="../../d5/d6/iosup_8c.html#a57">MmMapIoSpace</a>(
02224             rsdtAddress,
02225             <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d2/struct__DESCRIPTION__HEADER.html">DESCRIPTION_HEADER</a>),
02226             <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>
02227             );
02228         <span class="keywordflow">if</span> (tempHeader == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02229 
02230             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CmpFindACPITable: Cannot map RSDT at %I64x\n"</span>, rsdtAddress.QuadPart);
02231             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02232 
02233         }
02234 
02235         <span class="comment">//</span>
02236         <span class="comment">// If what we are looking for is the RSDT, then we are done</span>
02237         <span class="comment">//</span>
02238         <span class="keywordflow">if</span> (Signature == <a class="code" href="../../d5/d4/acpitabl_8h.html#a68">RSDT_SIGNATURE</a>) {
02239 
02240             header = tempHeader;
02241             length = <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/acpitabl_8h.html#a79">DESCRIPTION_HEADER</a>);
02242 
02243         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Signature == <a class="code" href="../../d5/d4/acpitabl_8h.html#a72">DSDT_SIGNATURE</a>) {
02244 
02245             <a class="code" href="../../d4/d9/struct__FADT.html">PFADT</a>               fadt;
02246             PHYSICAL_ADDRESS    dsdtAddress;
02247             ULONG               tempLength;
02248 
02249             fadt = (<a class="code" href="../../d4/d9/struct__FADT.html">PFADT</a>) <a class="code" href="../../d9/d3/rules_8c.html#a17">CmpFindACPITable</a>( <a class="code" href="../../d5/d4/acpitabl_8h.html#a17">FADT_SIGNATURE</a>, &amp;length );
02250             <span class="keywordflow">if</span> (fadt) {
02251 
02252                 dsdtAddress.HighPart = 0;
02253                 dsdtAddress.LowPart = fadt-&gt;<a class="code" href="../../d4/d9/struct__FADT.html#o2">dsdt</a>;
02254 
02255                 <span class="comment">//</span>
02256                 <span class="comment">// Done with the FADT</span>
02257                 <span class="comment">//</span>
02258                 <a class="code" href="../../d5/d6/iosup_8c.html#a58">MmUnmapIoSpace</a>( fadt, length );
02259 
02260                 <span class="comment">//</span>
02261                 <span class="comment">// Map in the dsdt table</span>
02262                 <span class="comment">//</span>
02263                 header = <a class="code" href="../../d5/d6/iosup_8c.html#a57">MmMapIoSpace</a>(
02264                     dsdtAddress,
02265                     <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/acpitabl_8h.html#a79">DESCRIPTION_HEADER</a>),
02266                     <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>
02267                     );
02268                 <span class="keywordflow">if</span> (header == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02269 
02270                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(
02271                         <span class="stringliteral">"CmpFindACPITable: Cannot map DSDT at %I64x\n"</span>,
02272                         dsdtAddress.QuadPart
02273                         );
02274                     <a class="code" href="../../d5/d6/iosup_8c.html#a58">MmUnmapIoSpace</a>( tempHeader, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/acpitabl_8h.html#a79">DESCRIPTION_HEADER</a>) );
02275                     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02276 
02277                 }
02278                 length = <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/acpitabl_8h.html#a79">DESCRIPTION_HEADER</a>);
02279 
02280             } <span class="keywordflow">else</span> {
02281 
02282                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CmpFindACPITable: Cannot find FADT\n"</span>);
02283                 <a class="code" href="../../d5/d6/iosup_8c.html#a58">MmUnmapIoSpace</a>( tempHeader, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/acpitabl_8h.html#a79">DESCRIPTION_HEADER</a>) );
02284                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02285 
02286             }
02287 
02288         } <span class="keywordflow">else</span> {
02289 
02290             PHYSICAL_ADDRESS    tableAddress;
02291             <a class="code" href="../../d1/d5/struct__RSDT.html">PRSDT</a>               rsdt;
02292             ULONG               i;
02293             ULONG               num;
02294             ULONG               rsdtLength;
02295 
02296             <span class="comment">//</span>
02297             <span class="comment">// Map in the entire RSDT</span>
02298             <span class="comment">//</span>
02299             rsdtLength = tempHeader-&gt;<a class="code" href="../../d6/d2/struct__DESCRIPTION__HEADER.html#o1">Length</a>;
02300             rsdt = (<a class="code" href="../../d1/d5/struct__RSDT.html">PRSDT</a>) <a class="code" href="../../d5/d6/iosup_8c.html#a57">MmMapIoSpace</a>( rsdtAddress, rsdtLength, <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a> );
02301             <span class="keywordflow">if</span> (rsdt == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02302 
02303                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(
02304                     <span class="stringliteral">"CmpFindACPITable: Cannot map RSDT at %I64x\n"</span>,
02305                     rsdtAddress.QuadPart
02306                     );
02307                 <a class="code" href="../../d5/d6/iosup_8c.html#a58">MmUnmapIoSpace</a>( tempHeader, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/acpitabl_8h.html#a79">DESCRIPTION_HEADER</a>) );
02308                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02309 
02310             }
02311 
02312             <span class="comment">//</span>
02313             <span class="comment">// Done with the temp header</span>
02314             <span class="comment">//</span>
02315             <a class="code" href="../../d5/d6/iosup_8c.html#a58">MmUnmapIoSpace</a>( tempHeader, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/acpitabl_8h.html#a79">DESCRIPTION_HEADER</a>) );
02316 
02317             <span class="comment">//</span>
02318             <span class="comment">// Look at all the table entries for the header that we care about</span>
02319             <span class="comment">//</span>
02320             num = <a class="code" href="../../d9/d3/rules_8c.html#a0">TABLE_ENTRIES_FROM_RSDT_POINTER</a>( rsdt );
02321             <span class="keywordflow">for</span> (i = 0; i &lt; num ; i ++) {
02322 
02323                 <span class="comment">//</span>
02324                 <span class="comment">// Get the address of the table</span>
02325                 <span class="comment">//</span>
02326                 tableAddress.HighPart = 0;
02327                 tableAddress.LowPart = rsdt-&gt;<a class="code" href="../../d1/d5/struct__RSDT.html#o1">Tables</a>[i];
02328 
02329                 <span class="comment">//</span>
02330                 <span class="comment">// Map in the header</span>
02331                 <span class="comment">//</span>
02332                 tempHeader = <a class="code" href="../../d5/d6/iosup_8c.html#a57">MmMapIoSpace</a>(
02333                     tableAddress,
02334                     <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/acpitabl_8h.html#a79">DESCRIPTION_HEADER</a>),
02335                     <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>
02336                     );
02337                 <span class="keywordflow">if</span> (!tempHeader) {
02338 
02339                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(
02340                         <span class="stringliteral">"CmpFindACPITable: Cannot map header at %I64x\n"</span>,
02341                         tableAddress.QuadPart
02342                         );
02343                     <a class="code" href="../../d5/d6/iosup_8c.html#a58">MmUnmapIoSpace</a>( rsdt, rsdtLength );
02344                     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02345 
02346                 }
02347 
02348                 <span class="comment">//</span>
02349                 <span class="comment">// Signature check</span>
02350                 <span class="comment">//</span>
02351                 <span class="keywordflow">if</span> (tempHeader-&gt;<a class="code" href="../../d6/d2/struct__DESCRIPTION__HEADER.html#o0">Signature</a> != Signature) {
02352 
02353                     <a class="code" href="../../d5/d6/iosup_8c.html#a58">MmUnmapIoSpace</a>( tempHeader, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/acpitabl_8h.html#a79">DESCRIPTION_HEADER</a>) );
02354                     <span class="keywordflow">continue</span>;
02355 
02356                 }
02357 
02358                 <span class="comment">//</span>
02359                 <span class="comment">// Are we looking at the FADT?</span>
02360                 <span class="comment">//</span>
02361                 <span class="keywordflow">if</span> (Signature == <a class="code" href="../../d5/d4/acpitabl_8h.html#a17">FADT_SIGNATURE</a>) {
02362 
02363                     <span class="comment">//</span>
02364                     <span class="comment">// Map the entire table for this one</span>
02365                     <span class="comment">//</span>
02366                     length = tempHeader-&gt;<a class="code" href="../../d6/d2/struct__DESCRIPTION__HEADER.html#o1">Length</a>;
02367                     header = <a class="code" href="../../d5/d6/iosup_8c.html#a57">MmMapIoSpace</a>( tableAddress, length, <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a> );
02368 
02369                     <span class="comment">//</span>
02370                     <span class="comment">// Unmap the old table</span>
02371                     <span class="comment">//</span>
02372                     <a class="code" href="../../d5/d6/iosup_8c.html#a58">MmUnmapIoSpace</a>( tempHeader, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/acpitabl_8h.html#a79">DESCRIPTION_HEADER</a>) );
02373 
02374                     <span class="comment">//</span>
02375                     <span class="comment">// Did we successfully map the header?</span>
02376                     <span class="comment">//</span>
02377                     <span class="keywordflow">if</span> (header == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02378 
02379                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(
02380                             <span class="stringliteral">"CmpFindACPITable: Cannot map FADT at %I64x\n"</span>,
02381                             tableAddress.QuadPart
02382                             );
02383                         <a class="code" href="../../d5/d6/iosup_8c.html#a58">MmUnmapIoSpace</a>( rsdt, rsdtLength );
02384                         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02385 
02386                     }
02387 
02388                 } <span class="keywordflow">else</span> {
02389 
02390                     <span class="comment">//</span>
02391                     <span class="comment">// Remember where the table and length are stored</span>
02392                     <span class="comment">//</span>
02393                     length = <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/acpitabl_8h.html#a79">DESCRIPTION_HEADER</a>);
02394                     header = tempHeader;
02395 
02396                 }
02397 
02398             } <span class="comment">// for</span>
02399 
02400             <span class="comment">//</span>
02401             <span class="comment">// Done with the rsdt</span>
02402             <span class="comment">//</span>
02403             <a class="code" href="../../d5/d6/iosup_8c.html#a58">MmUnmapIoSpace</a>( rsdt, rsdtLength );
02404 
02405         }
02406 
02407         <span class="comment">//</span>
02408         <span class="comment">// If we found the table, return its length.</span>
02409         <span class="comment">//</span>
02410         <span class="keywordflow">if</span> (Length) {
02411 
02412             <span class="keywordflow">if</span> (header) {
02413 
02414                 *Length = length;
02415 
02416             } <span class="keywordflow">else</span> {
02417 
02418                 *Length = 0;
02419 
02420             }
02421 
02422         }
02423 
02424     }
02425 
02426     <span class="keywordflow">return</span> (header);
02427 }
02428 
02429 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02430"></a><a class="code" href="../../d9/d3/rules_8c.html#a15">02430</a> <a class="code" href="../../d9/d3/rules_8c.html#a15">CmpFindRSDTTable</a>(
02431     OUT <a class="code" href="../../d4/d5/struct__ACPI__BIOS__MULTI__NODE.html">PACPI_BIOS_MULTI_NODE</a>   *Rsdt
02432     )
02433 <span class="comment">/*++</span>
02434 <span class="comment"></span>
02435 <span class="comment">Routine Description:</span>
02436 <span class="comment"></span>
02437 <span class="comment">    This function looks into the registry to find the ACPI RSDT,</span>
02438 <span class="comment">    which was stored there by ntdetect.com</span>
02439 <span class="comment"></span>
02440 <span class="comment">Arguments:</span>
02441 <span class="comment"></span>
02442 <span class="comment">    RsdtPtr - Pointer to a buffer that contains the ACPI</span>
02443 <span class="comment">              Root System Description Pointer Structure.</span>
02444 <span class="comment">              The caller is responsible for freeing this</span>
02445 <span class="comment">              buffer.  Note:  This is returned in non-paged</span>
02446 <span class="comment">              pool.</span>
02447 <span class="comment"></span>
02448 <span class="comment">Return Value:</span>
02449 <span class="comment"></span>
02450 <span class="comment">    A NTSTATUS code to indicate the result of the initialization.</span>
02451 <span class="comment"></span>
02452 <span class="comment">--*/</span>
02453 {
02454     BOOLEAN                         same;
02455     HANDLE                          hMFunc;
02456     HANDLE                          hBus;
02457     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                        status;
02458     OBJECT_ATTRIBUTES               objectAttributes;
02459     <a class="code" href="../../d4/d5/struct__ACPI__BIOS__MULTI__NODE.html">PACPI_BIOS_MULTI_NODE</a>           multiNode;
02460     PCM_PARTIAL_RESOURCE_DESCRIPTOR prd;
02461     PCM_PARTIAL_RESOURCE_LIST       prl;
02462     PKEY_VALUE_PARTIAL_INFORMATION  valueInfo;
02463     PWSTR                           p;
02464     ULONG                           i;
02465     ULONG                           length;
02466     ULONG                           multiNodeSize;
02467     UNICODE_STRING                  unicodeString;
02468     UNICODE_STRING                  unicodeValueName;
02469     UNICODE_STRING                  biosId;
02470     WCHAR                           wbuffer[10];
02471 
02472     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02473 
02474     <span class="comment">//</span>
02475     <span class="comment">// Look in the registry for the "ACPI BIOS bus" data</span>
02476     <span class="comment">//</span>
02477     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;unicodeString, <a class="code" href="../../d9/d3/rules_8c.html#a10">rgzMultiFunctionAdapter</a> );
02478     InitializeObjectAttributes(
02479         &amp;objectAttributes,
02480         &amp;unicodeString,
02481         OBJ_CASE_INSENSITIVE,
02482         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,       <span class="comment">// handle</span>
02483         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02484         );
02485     status = ZwOpenKey( &amp;hMFunc, KEY_READ, &amp;objectAttributes );
02486     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02487 
02488         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CmpFindRSDTTable: Cannot open MultifunctionAdapter registry key.\n"</span>);
02489         <span class="keywordflow">return</span> status;
02490 
02491     }
02492 
02493     <span class="comment">//</span>
02494     <span class="comment">// We will need to make a unicode string that we can use to enumerate</span>
02495     <span class="comment">// the subkeys of the MFA key</span>
02496     <span class="comment">//</span>
02497     unicodeString.Buffer = wbuffer;
02498     unicodeString.MaximumLength = <span class="keyword">sizeof</span>(wbuffer);
02499     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;biosId, <a class="code" href="../../d9/d3/rules_8c.html#a13">rgzBIOSIdentifier</a> );
02500 
02501     <span class="comment">//</span>
02502     <span class="comment">// Loop over all subkeys</span>
02503     <span class="comment">//</span>
02504     <span class="keywordflow">for</span> (i = 0; <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>; i++) {
02505 
02506         <span class="comment">//</span>
02507         <span class="comment">// Turn the number into a key name</span>
02508         <span class="comment">//</span>
02509         <a class="code" href="../../d9/d3/cnvint_8c.html#a6">RtlIntegerToUnicodeString</a>( i, 10, &amp;unicodeString);
02510         InitializeObjectAttributes(
02511             &amp;objectAttributes,
02512             &amp;unicodeString,
02513             OBJ_CASE_INSENSITIVE,
02514             hMFunc,
02515             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02516             );
02517 
02518         <span class="comment">//</span>
02519         <span class="comment">// Open the named subkey</span>
02520         <span class="comment">//</span>
02521         status = ZwOpenKey( &amp;hBus, KEY_READ, &amp;objectAttributes );
02522         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02523 
02524             <span class="comment">//</span>
02525             <span class="comment">// Out of Multifunction adapter entries...</span>
02526             <span class="comment">//</span>
02527             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CmpFindRSDTTable: ACPI BIOS MultifunctionAdapter registry key not found.\n"</span>);
02528             ZwClose (hMFunc);
02529             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
02530 
02531         }
02532 
02533         <span class="comment">//</span>
02534         <span class="comment">// Check the Indentifier to see if this is an ACPI BIOS entry</span>
02535         <span class="comment">//</span>
02536         status = <a class="code" href="../../d9/d3/rules_8c.html#a16">CmpGetRegistryValue</a>( hBus, <a class="code" href="../../d9/d3/rules_8c.html#a12">rgzAcpiIdentifier</a>, &amp;valueInfo );
02537         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02538 
02539             ZwClose( hBus );
02540             <span class="keywordflow">continue</span>;
02541 
02542         }
02543 
02544         p = (PWSTR) ((PUCHAR) valueInfo-&gt;Data);
02545         unicodeValueName.Buffer = p;
02546         unicodeValueName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)valueInfo-&gt;DataLength;
02547         length = valueInfo-&gt;DataLength;
02548 
02549         <span class="comment">//</span>
02550         <span class="comment">// Determine the real length of the ID string</span>
02551         <span class="comment">//</span>
02552         <span class="keywordflow">while</span> (length) {
02553 
02554             <span class="keywordflow">if</span> (p[length / <span class="keyword">sizeof</span>(WCHAR) - 1] == UNICODE_NULL) {
02555 
02556                 length -= 2;
02557 
02558             } <span class="keywordflow">else</span> {
02559 
02560                 <span class="keywordflow">break</span>;
02561             }
02562 
02563         }
02564 
02565         <span class="comment">//</span>
02566         <span class="comment">// Do we have a match the "ACPI BIOS" identifier?</span>
02567         <span class="comment">//</span>
02568         unicodeValueName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)length;
02569         same = <a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>( &amp;biosId, &amp;unicodeValueName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
02570         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( valueInfo );
02571         <span class="keywordflow">if</span> (!same) {
02572 
02573             ZwClose( hBus );
02574             <span class="keywordflow">continue</span>;
02575 
02576         }
02577 
02578         <span class="comment">//</span>
02579         <span class="comment">// We do, so get the configuration data</span>
02580         <span class="comment">//</span>
02581         status = <a class="code" href="../../d9/d3/rules_8c.html#a16">CmpGetRegistryValue</a>(
02582             hBus,
02583             <a class="code" href="../../d9/d3/rules_8c.html#a11">rgzAcpiConfigurationData</a>,
02584             &amp;valueInfo
02585             );
02586         ZwClose( hBus );
02587         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02588 
02589             <span class="keywordflow">continue</span> ;
02590 
02591         }
02592 
02593         <span class="comment">//</span>
02594         <span class="comment">// The data that we want is at the end of the PARTIAL_RESOURCE_LIST</span>
02595         <span class="comment">// descriptor</span>
02596         <span class="comment">//</span>
02597         prl = (PCM_PARTIAL_RESOURCE_LIST)(valueInfo-&gt;Data);
02598         prd = &amp;prl-&gt;PartialDescriptors[0];
02599         multiNode = (<a class="code" href="../../d4/d5/struct__ACPI__BIOS__MULTI__NODE.html">PACPI_BIOS_MULTI_NODE</a>)
02600             ( (PCHAR) prd + <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_LIST) );
02601         <span class="keywordflow">break</span>;
02602 
02603     }
02604 
02605     <span class="comment">//</span>
02606     <span class="comment">// Calculate the size of the data so that we can make a copy</span>
02607     <span class="comment">//</span>
02608     multiNodeSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/struct__ACPI__BIOS__MULTI__NODE.html">ACPI_BIOS_MULTI_NODE</a>) +
02609         ( (ULONG)(multiNode-&gt;<a class="code" href="../../d4/d5/struct__ACPI__BIOS__MULTI__NODE.html#o1">Count</a> - 1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d0/structACPI__E820__ENTRY.html">ACPI_E820_ENTRY</a>) );
02610     *Rsdt = (<a class="code" href="../../d4/d5/struct__ACPI__BIOS__MULTI__NODE.html">PACPI_BIOS_MULTI_NODE</a>) <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
02611         <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
02612         multiNodeSize,
02613         'IPCA'
02614         );
02615     <span class="keywordflow">if</span> (*Rsdt == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02616 
02617         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( valueInfo );
02618         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02619 
02620     }
02621     RtlCopyMemory(*Rsdt, multiNode, multiNodeSize);
02622 
02623     <span class="comment">//</span>
02624     <span class="comment">// Done with the key memory</span>
02625     <span class="comment">//</span>
02626     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(valueInfo);
02627 
02628     <span class="comment">//</span>
02629     <span class="comment">// Done</span>
02630     <span class="comment">//</span>
02631     <span class="keywordflow">return</span> STATUS_SUCCESS;
02632 }
02633 
02634 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02635"></a><a class="code" href="../../d9/d3/rules_8c.html#a16">02635</a> <a class="code" href="../../d9/d3/rules_8c.html#a16">CmpGetRegistryValue</a>(
02636     IN  HANDLE                          KeyHandle,
02637     IN  PWSTR                           ValueName,
02638     OUT PKEY_VALUE_PARTIAL_INFORMATION  *Information
02639     )
02640 <span class="comment">/*++</span>
02641 <span class="comment"></span>
02642 <span class="comment">Routine Description:</span>
02643 <span class="comment"></span>
02644 <span class="comment">    This routine is invoked to retrieve the data for a registry key's value.</span>
02645 <span class="comment">    This is done by querying the value of the key with a zero-length buffer</span>
02646 <span class="comment">    to determine the size of the value, and then allocating a buffer and</span>
02647 <span class="comment">    actually querying the value into the buffer.</span>
02648 <span class="comment"></span>
02649 <span class="comment">    It is the responsibility of the caller to free the buffer.</span>
02650 <span class="comment"></span>
02651 <span class="comment">Arguments:</span>
02652 <span class="comment"></span>
02653 <span class="comment">    KeyHandle - Supplies the key handle whose value is to be queried</span>
02654 <span class="comment"></span>
02655 <span class="comment">    ValueName - Supplies the null-terminated Unicode name of the value.</span>
02656 <span class="comment"></span>
02657 <span class="comment">    Information - Returns a pointer to the allocated data buffer.</span>
02658 <span class="comment"></span>
02659 <span class="comment">Return Value:</span>
02660 <span class="comment"></span>
02661 <span class="comment">    The function value is the final status of the query operation.</span>
02662 <span class="comment"></span>
02663 <span class="comment">--*/</span>
02664 
02665 {
02666     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                        status;
02667     PKEY_VALUE_PARTIAL_INFORMATION  infoBuffer;
02668     ULONG                           keyValueLength;
02669     UNICODE_STRING                  unicodeString;
02670 
02671     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02672 
02673     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;unicodeString, <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> );
02674 
02675     <span class="comment">//</span>
02676     <span class="comment">// Figure out how big the data value is so that a buffer of the</span>
02677     <span class="comment">// appropriate size can be allocated.</span>
02678     <span class="comment">//</span>
02679     status = ZwQueryValueKey(
02680         KeyHandle,
02681         &amp;unicodeString,
02682         KeyValuePartialInformation,
02683         (PVOID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02684         0,
02685         &amp;keyValueLength
02686         );
02687     <span class="keywordflow">if</span> (status != STATUS_BUFFER_OVERFLOW &amp;&amp;
02688         status != STATUS_BUFFER_TOO_SMALL) {
02689 
02690         <span class="keywordflow">return</span> status;
02691 
02692     }
02693 
02694     <span class="comment">//</span>
02695     <span class="comment">// Allocate a buffer large enough to contain the entire key data value.</span>
02696     <span class="comment">//</span>
02697     infoBuffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
02698         <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
02699         keyValueLength,
02700         'IPCA'
02701         );
02702     <span class="keywordflow">if</span> (!infoBuffer) {
02703 
02704         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02705 
02706     }
02707 
02708     <span class="comment">//</span>
02709     <span class="comment">// Query the data for the key value.</span>
02710     <span class="comment">//</span>
02711     status = ZwQueryValueKey(
02712         KeyHandle,
02713         &amp;unicodeString,
02714         KeyValuePartialInformation,
02715         infoBuffer,
02716         keyValueLength,
02717         &amp;keyValueLength
02718         );
02719     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02720 
02721         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( infoBuffer );
02722 
02723         <span class="keywordflow">return</span> status;
02724 
02725     }
02726 
02727     <span class="comment">//</span>
02728     <span class="comment">// Everything worked, so simply return the address of the allocated</span>
02729     <span class="comment">// buffer to the caller, who is now responsible for freeing it.</span>
02730     <span class="comment">//</span>
02731     *Information = infoBuffer;
02732     <span class="keywordflow">return</span> STATUS_SUCCESS;
02733 
02734 }
02735 
02736 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:41 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
