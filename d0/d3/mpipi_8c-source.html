<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: mpipi.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>mpipi.c</h1><a href="../../d9/d3/mpipi_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1993  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    mpipi.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements MIPS specific MP routine.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Bernard Lint 26-Jun-1996</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Kernel mode only.</span>
00020 <span class="comment"></span>
00021 <span class="comment">Revision History:</span>
00022 <span class="comment"></span>
00023 <span class="comment">    Based on version of David N. Cutler 24-Apr-1993</span>
00024 <span class="comment"></span>
00025 <span class="comment">--*/</span>
00026 
00027 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00028 
00029 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00030 <a class="code" href="../../d5/d0/psctxi64_8c.html#a4">KiFlushUserRseState</a> (
00031     IN PKTRAP_FRAME TrapFrame
00032     );
00033 
00034 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00035"></a><a class="code" href="../../d9/d3/mpipi_8c.html#a1">00035</a> <a class="code" href="../../d9/d6/ppc_2ipi_8c.html#a2">KiRestoreProcessorState</a> (
00036     IN PKTRAP_FRAME TrapFrame,
00037     IN PKEXCEPTION_FRAME ExceptionFrame
00038     )
00039 
00040 <span class="comment">/*++</span>
00041 <span class="comment"></span>
00042 <span class="comment">Routine Description:</span>
00043 <span class="comment"></span>
00044 <span class="comment">    This function moves processor register state from the current</span>
00045 <span class="comment">    processor context structure in the processor block to the</span>
00046 <span class="comment">    specified trap and exception frames.</span>
00047 <span class="comment"></span>
00048 <span class="comment">Arguments:</span>
00049 <span class="comment"></span>
00050 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame.</span>
00051 <span class="comment"></span>
00052 <span class="comment">    ExceptionFrame - Supplies a pointer to an exception frame.</span>
00053 <span class="comment"></span>
00054 <span class="comment">Return Value:</span>
00055 <span class="comment"></span>
00056 <span class="comment">    None.</span>
00057 <span class="comment"></span>
00058 <span class="comment">--*/</span>
00059 
00060 {
00061 
00062 <span class="preprocessor">#if !defined(NT_UP)</span>
00063 <span class="preprocessor"></span>
00064     PKPRCB Prcb;
00065 
00066     <span class="comment">//</span>
00067     <span class="comment">// Get the address of the current processor block and move the</span>
00068     <span class="comment">// specified register state from the processor context structure</span>
00069     <span class="comment">// to the specified trap and exception frames</span>
00070     <span class="comment">//</span>
00071 
00072     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00073     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a10">KeContextToKframes</a>(TrapFrame,
00074                        ExceptionFrame,
00075                        &amp;Prcb-&gt;ProcessorState.ContextFrame,
00076                        <a class="code" href="../../d6/d7/halmips_8h.html#a152">CONTEXT_FULL</a>,
00077                        (<a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>)TrapFrame-&gt;PreviousMode);
00078 
00079 <span class="preprocessor">#endif</span>
00080 <span class="preprocessor"></span>
00081     <span class="keywordflow">return</span>;
00082 }
00083 
00084 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00085"></a><a class="code" href="../../d9/d3/mpipi_8c.html#a2">00085</a> <a class="code" href="../../d9/d6/ppc_2ipi_8c.html#a3">KiSaveProcessorState</a> (
00086     IN PKTRAP_FRAME TrapFrame,
00087     IN PKEXCEPTION_FRAME ExceptionFrame
00088     )
00089 
00090 <span class="comment">/*++</span>
00091 <span class="comment"></span>
00092 <span class="comment">Routine Description:</span>
00093 <span class="comment"></span>
00094 <span class="comment">    This function moves processor register state from the specified trap</span>
00095 <span class="comment">    and exception frames to the processor context structure in the current</span>
00096 <span class="comment">    processor block.</span>
00097 <span class="comment"></span>
00098 <span class="comment">Arguments:</span>
00099 <span class="comment"></span>
00100 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame.</span>
00101 <span class="comment"></span>
00102 <span class="comment">    ExceptionFrame - Supplies a pointer to an exception frame.</span>
00103 <span class="comment"></span>
00104 <span class="comment">Return Value:</span>
00105 <span class="comment"></span>
00106 <span class="comment">    None.</span>
00107 <span class="comment"></span>
00108 <span class="comment">--*/</span>
00109 
00110 {
00111 
00112 <span class="preprocessor">#if !defined(NT_UP)</span>
00113 <span class="preprocessor"></span>
00114     PKPRCB Prcb;
00115 
00116     <span class="comment">//</span>
00117     <span class="comment">// Get the address of the current processor block and move the</span>
00118     <span class="comment">// specified register state from specified trap and exception</span>
00119     <span class="comment">// frames to the current processor context structure.</span>
00120     <span class="comment">//</span>
00121 
00122     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00123     Prcb-&gt;ProcessorState.ContextFrame.ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a152">CONTEXT_FULL</a>;
00124     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a9">KeContextFromKframes</a>(TrapFrame,
00125                          ExceptionFrame,
00126                          &amp;Prcb-&gt;ProcessorState.ContextFrame);
00127 
00128     <span class="keywordflow">if</span> (TrapFrame-&gt;PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>)
00129         <a class="code" href="../../d5/d0/psctxi64_8c.html#a4">KiFlushUserRseState</a>(TrapFrame);
00130 
00131     <span class="comment">//</span>
00132     <span class="comment">// Save ISR in special registers</span>
00133     <span class="comment">//</span>
00134 
00135     Prcb-&gt;ProcessorState.SpecialRegisters.StISR = TrapFrame-&gt;StISR;
00136 
00137     <span class="comment">//</span>
00138     <span class="comment">// Save the current processor control state.</span>
00139     <span class="comment">//</span>
00140 
00141     <a class="code" href="../../d9/d6/ppc_2ipi_8c.html#a1">KiSaveProcessorControlState</a>(&amp;Prcb-&gt;ProcessorState);
00142 
00143 <span class="preprocessor">#endif</span>
00144 <span class="preprocessor"></span>
00145     <span class="keywordflow">return</span>;
00146 }
00147 
00148 BOOLEAN
<a name="l00149"></a><a class="code" href="../../d9/d3/mpipi_8c.html#a3">00149</a> <a class="code" href="../../d9/d6/ppc_2ipi_8c.html#a4">KiIpiServiceRoutine</a> (
00150     IN PKTRAP_FRAME TrapFrame,
00151     IN PKEXCEPTION_FRAME ExceptionFrame
00152     )
00153 
00154 <span class="comment">/*++</span>
00155 <span class="comment"></span>
00156 <span class="comment">Routine Description:</span>
00157 <span class="comment"></span>
00158 <span class="comment"></span>
00159 <span class="comment">    This function is called at IPI_LEVEL to process any outstanding</span>
00160 <span class="comment">    interprocess request for the current processor.</span>
00161 <span class="comment"></span>
00162 <span class="comment">Arguments:</span>
00163 <span class="comment"></span>
00164 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame.</span>
00165 <span class="comment"></span>
00166 <span class="comment">    ExceptionFrame - Supplies a pointer to an exception frame</span>
00167 <span class="comment"></span>
00168 <span class="comment">Return Value:</span>
00169 <span class="comment"></span>
00170 <span class="comment">    A value of TRUE is returned, if one of more requests were service.</span>
00171 <span class="comment">    Otherwise, FALSE is returned.</span>
00172 <span class="comment"></span>
00173 <span class="comment">--*/</span>
00174 
00175 {
00176     ULONG RequestSummary;
00177 
00178     <span class="comment">//</span>
00179     <span class="comment">// Process any outstanding IPI requests</span>
00180     <span class="comment">//</span>
00181 
00182     RequestSummary = <a class="code" href="../../d9/d3/mpipi_8c.html#a4">KiIpiProcessRequests</a>();
00183 
00184     <span class="comment">//</span>
00185     <span class="comment">// If freeze is requested, then freeze target execution.</span>
00186     <span class="comment">//</span>
00187 
00188     <span class="keywordflow">if</span> ((RequestSummary &amp; <a class="code" href="../../d0/d0/ki_8h.html#a18">IPI_FREEZE</a>) != 0) {
00189         <a class="code" href="../../d0/d0/ki_8h.html#a149">KiFreezeTargetExecution</a>(TrapFrame, ExceptionFrame);
00190     }
00191 
00192     <span class="keywordflow">return</span> ((RequestSummary &amp; ~<a class="code" href="../../d0/d0/ki_8h.html#a18">IPI_FREEZE</a>) != 0);
00193 }
00194 
00195 ULONG
<a name="l00196"></a><a class="code" href="../../d9/d3/mpipi_8c.html#a4">00196</a> <a class="code" href="../../d9/d3/mpipi_8c.html#a4">KiIpiProcessRequests</a> (
00197     VOID
00198     )
00199 
00200 <span class="comment">/*++</span>
00201 <span class="comment"></span>
00202 <span class="comment">Routine Description:</span>
00203 <span class="comment"></span>
00204 <span class="comment">    This routine processes interprocessor requests and returns a summary</span>
00205 <span class="comment">    of the requests that were processed.</span>
00206 <span class="comment"></span>
00207 <span class="comment">Arguments:</span>
00208 <span class="comment"></span>
00209 <span class="comment">    None.</span>
00210 <span class="comment"></span>
00211 <span class="comment">Return Value:</span>
00212 <span class="comment"></span>
00213 <span class="comment">    The request summary is returned as the function value.</span>
00214 <span class="comment"></span>
00215 <span class="comment">--*/</span>
00216 {
00217     ULONG RequestSummary;
00218     PKPRCB SignalDone;
00219     PKPRCB Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00220 
00221     RequestSummary = (ULONG)InterlockedExchange((PLONG)&amp;Prcb-&gt;RequestSummary, 0);
00222 
00223     <span class="comment">//</span>
00224     <span class="comment">// If a packet is ready, then get the address of the requested function</span>
00225     <span class="comment">// and call the function passing the address of the packet address as a</span>
00226     <span class="comment">// parameter.</span>
00227     <span class="comment">//</span>
00228 
00229     SignalDone = (PKPRCB)Prcb-&gt;SignalDone;
00230 
00231     <span class="keywordflow">if</span> (SignalDone != 0) {
00232      
00233         Prcb-&gt;SignalDone = 0;
00234 
00235         (*SignalDone-&gt;WorkerRoutine) ((<a class="code" href="../../d0/d9/ntosdef_8h.html#a54">PKIPI_CONTEXT</a>)SignalDone,
00236                                       SignalDone-&gt;CurrentPacket[0], 
00237                                       SignalDone-&gt;CurrentPacket[1], 
00238                                       SignalDone-&gt;CurrentPacket[2]);
00239 
00240     } 
00241 
00242     <span class="keywordflow">if</span> ((RequestSummary &amp; <a class="code" href="../../d0/d0/ki_8h.html#a16">IPI_APC</a>) != 0) {
00243         <a class="code" href="../../d9/d4/intsupc_8c.html#a3">KiRequestSoftwareInterrupt</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
00244     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((RequestSummary &amp; <a class="code" href="../../d0/d0/ki_8h.html#a17">IPI_DPC</a>) != 0) {
00245         <a class="code" href="../../d9/d4/intsupc_8c.html#a3">KiRequestSoftwareInterrupt</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00246     }
00247 
00248     <span class="keywordflow">return</span> RequestSummary;
00249 }
00250 
00251 
00252 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00253"></a><a class="code" href="../../d0/d0/ki_8h.html#a90">00253</a> <a class="code" href="../../d0/d0/ki_8h.html#a90">KiIpiSend</a> (
00254     IN KAFFINITY TargetProcessors,
00255     IN KIPI_REQUEST IpiRequest
00256     )
00257 
00258 <span class="comment">/*++</span>
00259 <span class="comment"></span>
00260 <span class="comment">Routine Description:</span>
00261 <span class="comment"></span>
00262 <span class="comment">    This routine requests the specified operation on the target set of</span>
00263 <span class="comment">    processors.</span>
00264 <span class="comment"></span>
00265 <span class="comment">Arguments:</span>
00266 <span class="comment"></span>
00267 <span class="comment">    TargetProcessors (a0) - Supplies the set of processors on which the</span>
00268 <span class="comment">        specified operation is to be executed.</span>
00269 <span class="comment"></span>
00270 <span class="comment">    IpiRequest (a1) - Supplies the request operation mask.</span>
00271 <span class="comment"></span>
00272 <span class="comment">Return Value:</span>
00273 <span class="comment"></span>
00274 <span class="comment">    None.</span>
00275 <span class="comment"></span>
00276 <span class="comment">--*/</span>
00277 
00278 {
00279 <span class="preprocessor">#if !defined(NT_UP)</span>
00280 <span class="preprocessor"></span>    ULONG RequestSummary;
00281     KAFFINITY NextProcessors;
00282     ULONG Next;
00283 
00284     <span class="comment">//</span>
00285     <span class="comment">// Loop through the target processors and send the packet to the specified</span>
00286     <span class="comment">// recipients.</span>
00287     <span class="comment">//</span>
00288 
00289     NextProcessors = TargetProcessors;
00290     Next = 0;
00291 
00292     <span class="keywordflow">while</span> (NextProcessors != 0) {
00293 
00294         <span class="keywordflow">if</span> ((NextProcessors &amp; 1) != 0) {
00295 
00296             <span class="keywordflow">do</span> {
00297             
00298                 RequestSummary = <a class="code" href="../../d4/d9/ke_8h.html#a139">KiProcessorBlock</a>[Next]-&gt;RequestSummary;
00299 
00300             } <span class="keywordflow">while</span>(InterlockedCompareExchange(
00301                 (PLONG) &amp;<a class="code" href="../../d4/d9/ke_8h.html#a139">KiProcessorBlock</a>[Next]-&gt;RequestSummary, 
00302                 (LONG) (RequestSummary | IpiRequest),
00303                 (LONG) RequestSummary) != (LONG) RequestSummary);  
00304         }
00305 
00306         NextProcessors = NextProcessors &gt;&gt; 1;
00307         
00308         Next = Next + 1;
00309 
00310     }
00311     <a class="code" href="../../d2/d7/hal_8h.html#a198">HalRequestIpi</a> (TargetProcessors);
00312 <span class="preprocessor">#endif</span>
00313 <span class="preprocessor"></span>
00314     <span class="keywordflow">return</span>;
00315 }
00316 
00317 
00318 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00319"></a><a class="code" href="../../d0/d0/ki_8h.html#a91">00319</a> <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a> (
00320     IN KAFFINITY TargetProcessors,
00321     IN PKIPI_WORKER WorkerFunction,
00322     IN PVOID Parameter1,
00323     IN PVOID Parameter2,
00324     IN PVOID Parameter3
00325     )
00326 
00327 <span class="comment">/*++</span>
00328 <span class="comment"></span>
00329 <span class="comment">Routine Description:</span>
00330 <span class="comment"></span>
00331 <span class="comment">    This routine executes the specified worker function on the specified</span>
00332 <span class="comment">    set of processors.</span>
00333 <span class="comment"></span>
00334 <span class="comment">Arguments:</span>
00335 <span class="comment"></span>
00336 <span class="comment">    TargetProcessors (a0) - Supplies the set of processors on which the</span>
00337 <span class="comment">        specified operation is to be executed.</span>
00338 <span class="comment"></span>
00339 <span class="comment">    WorkerFunction (a1) - Supplies the address of the worker function.</span>
00340 <span class="comment"></span>
00341 <span class="comment">    Parameter1 - Parameter3 (a2, a3, 4 * 4(sp)) - Supplies worker</span>
00342 <span class="comment">        function specific parameters.</span>
00343 <span class="comment"></span>
00344 <span class="comment">Return Value:</span>
00345 <span class="comment"></span>
00346 <span class="comment">    None.</span>
00347 <span class="comment"></span>
00348 <span class="comment">--*/</span>
00349 {
00350 <span class="preprocessor">#if !defined(NT_UP)</span>
00351 <span class="preprocessor"></span>    PKPRCB Prcb;
00352     KAFFINITY NextProcessors;
00353     ULONG Next;
00354 
00355     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00356     Prcb-&gt;TargetSet = TargetProcessors;
00357     Prcb-&gt;WorkerRoutine = WorkerFunction;
00358     Prcb-&gt;CurrentPacket[0] = Parameter1;
00359     Prcb-&gt;CurrentPacket[1] = Parameter2;
00360     Prcb-&gt;CurrentPacket[2] = Parameter3;
00361 
00362     <span class="comment">//</span>
00363     <span class="comment">// synchronize memory access</span>
00364     <span class="comment">// </span>
00365 
00366     __mf();
00367     
00368     <span class="comment">//</span>
00369     <span class="comment">// Loop through the target processors and send the packet to the specified</span>
00370     <span class="comment">// recipients.</span>
00371     <span class="comment">//</span>
00372 
00373     NextProcessors = TargetProcessors;
00374     Next = 0;
00375 
00376     <span class="keywordflow">while</span> (NextProcessors != 0) {
00377 
00378         <span class="keywordflow">if</span> ((NextProcessors &amp; 1) != 0) {
00379             
00380             <span class="keywordflow">while</span>(InterlockedCompareExchangePointer(
00381                 (PVOID)&amp;<a class="code" href="../../d4/d9/ke_8h.html#a139">KiProcessorBlock</a>[Next]-&gt;SignalDone, 
00382                 (PVOID)Prcb,
00383                 (PVOID)0) != (PVOID)0);
00384 
00385         }
00386             
00387         NextProcessors = NextProcessors &gt;&gt; 1;
00388         
00389         Next = Next + 1;
00390 
00391     }
00392     <a class="code" href="../../d2/d7/hal_8h.html#a198">HalRequestIpi</a> (TargetProcessors);
00393 <span class="preprocessor">#endif    </span>
00394 <span class="preprocessor"></span>}
00395 
00396 
00397 <span class="preprocessor">#if !defined(NT_UP)</span>
00398 <span class="preprocessor"></span>
00399 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00400"></a><a class="code" href="../../d9/d3/mpipi_8c.html#a7">00400</a> <a class="code" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone</a> (
00401    IN PKPRCB SignalDone
00402    )
00403 
00404 <span class="comment">/*++</span>
00405 <span class="comment"></span>
00406 <span class="comment">Routine Description:</span>
00407 <span class="comment"></span>
00408 <span class="comment">    This routine signals that a processor has completed a packet by</span>
00409 <span class="comment">    clearing the calling processor's set member of the requesting</span>
00410 <span class="comment">    processor's packet.</span>
00411 <span class="comment"></span>
00412 <span class="comment">Arguments:</span>
00413 <span class="comment"></span>
00414 <span class="comment">    SignalDone (a0) - Supplies a pointer to the processor block of the</span>
00415 <span class="comment">        sending processor.</span>
00416 <span class="comment"></span>
00417 <span class="comment">Return Value:</span>
00418 <span class="comment"></span>
00419 <span class="comment">    None.</span>
00420 <span class="comment"></span>
00421 <span class="comment">--*/</span>
00422 {
00423     PKPRCB Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00424 
00425     KAFFINITY TargetSet; 
00426 
00427     <span class="keywordflow">do</span> {
00428 
00429         TargetSet = SignalDone-&gt;TargetSet; 
00430 
00431     } <span class="keywordflow">while</span> (InterlockedCompareExchange(
00432         (PLONG) &amp;SignalDone-&gt;TargetSet, 
00433         (LONG) (TargetSet ^ Prcb-&gt;SetMember), 
00434         (LONG) TargetSet) != (LONG)TargetSet);
00435 }
00436 
00437 <span class="preprocessor">#endif // !defined(NT_UP)</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:53 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
