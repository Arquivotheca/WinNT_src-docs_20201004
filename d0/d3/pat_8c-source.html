<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pat.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pat.c</h1><a href="../../d9/d3/pat_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment">Copyright (c) 1997-8  Microsoft Corporation</span>
00003 <span class="comment"></span>
00004 <span class="comment">Module Name:</span>
00005 <span class="comment"></span>
00006 <span class="comment">    pat.c</span>
00007 <span class="comment"></span>
00008 <span class="comment">Abstract:</span>
00009 <span class="comment"></span>
00010 <span class="comment">    This module implements interfaces that set the Page Attribute</span>
00011 <span class="comment">    Table. These entry points only exist on i386 machines.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Shivnandan Kaushik (Intel Corp.)</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Kernel mode only.</span>
00020 <span class="comment"></span>
00021 <span class="comment">Revision History:</span>
00022 <span class="comment"></span>
00023 <span class="comment">--*/</span>
00024 
00025 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00026 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/pat_8h.html">pat.h</a>"</span>
00027 
00028 <span class="preprocessor">#if DBG</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#define DBGMSG(a)   DbgPrint(a)</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00031"></a><a class="code" href="../../d9/d3/pat_8c.html#a0">00031</a> <span class="preprocessor"></span><span class="preprocessor">#define DBGMSG(a)</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00033 <span class="preprocessor"></span>
00034 <span class="comment">// Structure used for PAT initialization</span>
00035 
<a name="l00036"></a><a class="code" href="../../d9/d1/struct__NEW__PAT.html">00036</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/d1/struct__NEW__PAT.html">_NEW_PAT</a> {
00037 
<a name="l00038"></a><a class="code" href="../../d9/d1/struct__NEW__PAT.html#o0">00038</a>     <a class="code" href="../../d2/d9/union__PAT.html">PAT</a>                 <a class="code" href="../../d9/d1/struct__NEW__PAT.html#o0">Attributes</a>;
00039 
00040     <span class="comment">// IPI context to coordinate concurrent PAT update</span>
00041 
<a name="l00042"></a><a class="code" href="../../d9/d1/struct__NEW__PAT.html#o1">00042</a>     ULONG               <a class="code" href="../../d9/d1/struct__NEW__PAT.html#o1">Processor</a>;
<a name="l00043"></a><a class="code" href="../../d9/d1/struct__NEW__PAT.html#o2">00043</a>     <span class="keyword">volatile</span> ULONG      <a class="code" href="../../d9/d1/struct__NEW__PAT.html#o2">TargetCount</a>;
<a name="l00044"></a><a class="code" href="../../d9/d1/struct__NEW__PAT.html#o3">00044</a>     <span class="keyword">volatile</span> ULONG      *<a class="code" href="../../d9/d1/struct__NEW__PAT.html#o3">TargetPhase</a>;
00045 
00046 } <a class="code" href="../../d9/d1/struct__NEW__PAT.html">NEW_PAT</a>, *<a class="code" href="../../d9/d1/struct__NEW__PAT.html">PNEW_PAT</a>;
00047 
00048 <span class="comment">// Prototypes</span>
00049 
00050 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00051 <a class="code" href="../../d9/d3/pat_8c.html#a3">KeRestorePAT</a> (
00052     VOID
00053     );
00054 
00055 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00056 <a class="code" href="../../d9/d3/pat_8c.html#a4">KiInitializePAT</a> (
00057     VOID
00058     );
00059 
00060 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00061 <a class="code" href="../../d9/d3/pat_8c.html#a5">KiLoadPAT</a> (
00062     IN PNEW_PAT Context
00063     );
00064 
00065 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00066 <a class="code" href="../../d9/d3/pat_8c.html#a6">KiLoadPATTarget</a> (
00067     IN PKIPI_CONTEXT    SignalDone,
00068     IN PVOID            Context,
00069     IN PVOID            Parameter2,
00070     IN PVOID            Parameter3
00071     );
00072 
00073 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00074 <a class="code" href="../../d9/d3/pat_8c.html#a7">KiSynchronizePATLoad</a> (
00075     IN PNEW_PAT   Context
00076     );
00077 
00078 <span class="preprocessor">#if DBG</span>
00079 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00080 KiDumpPAT (
00081     PUCHAR      DebugString,
00082     <a class="code" href="../../d2/d9/union__PAT.html">PAT</a>         Attributes
00083     );
00084 <span class="preprocessor">#endif</span>
00085 <span class="preprocessor"></span>
00086 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00087 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,KiInitializePAT)</span>
00088 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,KiLoadPAT)</span>
00089 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,KiLoadPATTarget)</span>
00090 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,KiSynchronizePATLoad)</span>
00091 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00092 <span class="preprocessor"></span>
00093 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00094"></a><a class="code" href="../../d9/d3/pat_8c.html#a3">00094</a> <a class="code" href="../../d9/d3/pat_8c.html#a3">KeRestorePAT</a> (
00095     VOID
00096     )
00097 <span class="comment">/*++</span>
00098 <span class="comment">Routine Description:</span>
00099 <span class="comment"></span>
00100 <span class="comment">    Reinitialize the Page Attribute Table (PAT) on all processors.</span>
00101 <span class="comment"></span>
00102 <span class="comment">    N.B. The caller must have the PAGELK code locked</span>
00103 <span class="comment"></span>
00104 <span class="comment">  Arguments:</span>
00105 <span class="comment"></span>
00106 <span class="comment">    None.</span>
00107 <span class="comment"></span>
00108 <span class="comment">Return Value:</span>
00109 <span class="comment"></span>
00110 <span class="comment">    None.</span>
00111 <span class="comment">--*/</span>
00112 {
00113     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a10">KF_PAT</a>) {
00114         <a class="code" href="../../d9/d3/pat_8c.html#a4">KiInitializePAT</a>();
00115     }
00116 }
00117 
00118 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00119"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a51">00119</a> <a class="code" href="../../d9/d3/pat_8c.html#a4">KiInitializePAT</a> (
00120     VOID
00121     )
00122 <span class="comment">/*++</span>
00123 <span class="comment"></span>
00124 <span class="comment">Routine Description:</span>
00125 <span class="comment"></span>
00126 <span class="comment">    Initialize the Page Attribute Table (PAT) on all processors. PAT</span>
00127 <span class="comment">    is setup to provide WB, WC, STRONG_UC and WEAK_UC as the memory</span>
00128 <span class="comment">    types such that mm macros for enabling/disabling/querying caching</span>
00129 <span class="comment">    (MI_DISABLE_CACHING, MI_ENABLE_CACHING and MI_IS_CACHING_ENABLED)</span>
00130 <span class="comment">    are unaffected.</span>
00131 <span class="comment"></span>
00132 <span class="comment">    PAT_Entry   PAT Index   PCD PWT     Memory Type</span>
00133 <span class="comment">    0            0           0   0       WB</span>
00134 <span class="comment">    1            0           0   1       WC *</span>
00135 <span class="comment">    2            0           1   0       WEAK_UC</span>
00136 <span class="comment">    3            0           1   1       STRONG_UC</span>
00137 <span class="comment">    4            1           0   0       WB</span>
00138 <span class="comment">    5            1           0   1       WC *</span>
00139 <span class="comment">    6            1           1   0       WEAK_UC</span>
00140 <span class="comment">    7            1           1   1       STRONG_UC</span>
00141 <span class="comment"></span>
00142 <span class="comment">    N.B. The caller must have the PAGELK code locked and ensure that the</span>
00143 <span class="comment">    PAT feature is supported.</span>
00144 <span class="comment"></span>
00145 <span class="comment">  Arguments:</span>
00146 <span class="comment"></span>
00147 <span class="comment">    None.</span>
00148 <span class="comment"></span>
00149 <span class="comment">Return Value:</span>
00150 <span class="comment"></span>
00151 <span class="comment">    None.</span>
00152 <span class="comment"></span>
00153 <span class="comment">--*/</span>
00154 {
00155     <a class="code" href="../../d2/d9/union__PAT.html">PAT</a>         PatAttributes;
00156     ULONG       <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00157     KIRQL       OldIrql, NewIrql;
00158     PKPRCB      Prcb;
00159     <a class="code" href="../../d9/d1/struct__NEW__PAT.html">NEW_PAT</a>     NewPAT;
00160     KAFFINITY   TargetProcessors;
00161 
00162     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a10">KF_PAT</a>) != 0);
00163 
00164     <span class="comment">//</span>
00165     <span class="comment">// Initialize the PAT</span>
00166     <span class="comment">//</span>
00167 
00168     PatAttributes.<a class="code" href="../../d2/d9/union__PAT.html#o1">hw</a>.Pat[0] = <a class="code" href="../../d0/d4/pat_8h.html#a5">PAT_TYPE_WB</a>;
00169     PatAttributes.<a class="code" href="../../d2/d9/union__PAT.html#o1">hw</a>.Pat[1] = <a class="code" href="../../d0/d4/pat_8h.html#a2">PAT_TYPE_USWC</a>;
00170     PatAttributes.<a class="code" href="../../d2/d9/union__PAT.html#o1">hw</a>.Pat[2] = <a class="code" href="../../d0/d4/pat_8h.html#a6">PAT_TYPE_WEAK_UC</a>;
00171     PatAttributes.<a class="code" href="../../d2/d9/union__PAT.html#o1">hw</a>.Pat[3] = <a class="code" href="../../d0/d4/pat_8h.html#a1">PAT_TYPE_STRONG_UC</a>;
00172     PatAttributes.<a class="code" href="../../d2/d9/union__PAT.html#o1">hw</a>.Pat[4] = <a class="code" href="../../d0/d4/pat_8h.html#a5">PAT_TYPE_WB</a>;
00173     PatAttributes.<a class="code" href="../../d2/d9/union__PAT.html#o1">hw</a>.Pat[5] = <a class="code" href="../../d0/d4/pat_8h.html#a2">PAT_TYPE_USWC</a>;
00174     PatAttributes.<a class="code" href="../../d2/d9/union__PAT.html#o1">hw</a>.Pat[6] = <a class="code" href="../../d0/d4/pat_8h.html#a6">PAT_TYPE_WEAK_UC</a>;
00175     PatAttributes.<a class="code" href="../../d2/d9/union__PAT.html#o1">hw</a>.Pat[7] = <a class="code" href="../../d0/d4/pat_8h.html#a1">PAT_TYPE_STRONG_UC</a>;
00176 
00177     <span class="comment">//</span>
00178     <span class="comment">// Synchronize with other IPI functions which may stall</span>
00179     <span class="comment">//</span>
00180 
00181     <a class="code" href="../../d0/d0/ki_8h.html#a11">KiLockContextSwap</a>(&amp;OldIrql);
00182 
00183     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00184 
00185     NewPAT.<a class="code" href="../../d9/d1/struct__NEW__PAT.html#o0">Attributes</a> = PatAttributes;
00186     NewPAT.<a class="code" href="../../d9/d1/struct__NEW__PAT.html#o2">TargetCount</a> = 0;
00187     NewPAT.<a class="code" href="../../d9/d1/struct__NEW__PAT.html#o3">TargetPhase</a> = &amp;Prcb-&gt;ReverseStall;
00188     NewPAT.<a class="code" href="../../d9/d1/struct__NEW__PAT.html#o1">Processor</a> = Prcb-&gt;Number;
00189 
00190 
00191 <span class="preprocessor">#if !defined(NT_UP)</span>
00192 <span class="preprocessor"></span>
00193     <span class="comment">//</span>
00194     <span class="comment">// Collect all the (other) processors</span>
00195     <span class="comment">//</span>
00196 
00197     TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a> &amp; ~Prcb-&gt;SetMember;
00198     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00199 
00200         KiIpiSendSynchronousPacket (
00201             Prcb,
00202             TargetProcessors,
00203             <a class="code" href="../../d9/d3/pat_8c.html#a6">KiLoadPATTarget</a>,
00204             (PVOID) (&amp;NewPAT),
00205             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00206             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00207             );
00208 
00209         <span class="comment">//</span>
00210         <span class="comment">// Wait for all processors to be collected</span>
00211         <span class="comment">//</span>
00212 
00213         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>(TargetProcessors);
00214 
00215         <span class="comment">//</span>
00216         <span class="comment">// All processors are now waiting.  Raise to high level to</span>
00217         <span class="comment">// ensure this processor doesn't enter the debugger due to</span>
00218         <span class="comment">// some interrupt service routine.</span>
00219         <span class="comment">//</span>
00220 
00221         <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a57">HIGH_LEVEL</a>, &amp;NewIrql);
00222 
00223         <span class="comment">//</span>
00224         <span class="comment">// There's no reason for any debug events now, so signal</span>
00225         <span class="comment">// the other processors that they can all begin the PAT update</span>
00226         <span class="comment">//</span>
00227 
00228         Prcb-&gt;ReverseStall += 1;
00229     }
00230 
00231 <span class="preprocessor">#endif</span>
00232 <span class="preprocessor"></span>
00233     <span class="comment">//</span>
00234     <span class="comment">// Update PAT</span>
00235     <span class="comment">//</span>
00236 
00237     <a class="code" href="../../d9/d3/pat_8c.html#a5">KiLoadPAT</a>(&amp;NewPAT);
00238 
00239     <span class="comment">//</span>
00240     <span class="comment">// Release ContextSwap lock and lower to initial irql</span>
00241     <span class="comment">//</span>
00242 
00243     <a class="code" href="../../d0/d0/ki_8h.html#a12">KiUnlockContextSwap</a>(OldIrql);
00244     <a class="code" href="../../d2/d1/mm_8h.html#a189">MmEnablePAT</a>();
00245     <span class="keywordflow">return</span>;
00246 }
00247 
00248 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00249"></a><a class="code" href="../../d9/d3/pat_8c.html#a6">00249</a> <a class="code" href="../../d9/d3/pat_8c.html#a6">KiLoadPATTarget</a> (
00250     IN PKIPI_CONTEXT SignalDone,
00251     IN PVOID NewPAT,
00252     IN PVOID Parameter2,
00253     IN PVOID Parameter3
00254     )
00255 <span class="comment">/*++</span>
00256 <span class="comment"></span>
00257 <span class="comment">Routine Description:</span>
00258 <span class="comment"></span>
00259 <span class="comment">    Synchronize with target processors prior to PAT modification.</span>
00260 <span class="comment"></span>
00261 <span class="comment">Arguments:</span>
00262 <span class="comment"></span>
00263 <span class="comment">    Context     - Context which includes the PAT to load</span>
00264 <span class="comment"></span>
00265 <span class="comment">Return Value:</span>
00266 <span class="comment"></span>
00267 <span class="comment">    None</span>
00268 <span class="comment"></span>
00269 <span class="comment">--*/</span>
00270 {
00271     <a class="code" href="../../d9/d3/pat_8c.html#a2">PNEW_PAT</a> Context;
00272 
00273     Context = (<a class="code" href="../../d9/d3/pat_8c.html#a2">PNEW_PAT</a>) NewPAT;
00274 
00275     <span class="comment">//</span>
00276     <span class="comment">// Wait for all processors to be ready</span>
00277     <span class="comment">//</span>
00278 
00279     KiIpiSignalPacketDoneAndStall (SignalDone, Context-&gt;<a class="code" href="../../d9/d1/struct__NEW__PAT.html#o3">TargetPhase</a>);
00280 
00281     <span class="comment">//</span>
00282     <span class="comment">// Update PAT</span>
00283     <span class="comment">//</span>
00284 
00285     <a class="code" href="../../d9/d3/pat_8c.html#a5">KiLoadPAT</a> (Context);
00286 }
00287 
00288 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00289"></a><a class="code" href="../../d9/d3/pat_8c.html#a5">00289</a> <a class="code" href="../../d9/d3/pat_8c.html#a5">KiLoadPAT</a> (
00290     IN PNEW_PAT Context
00291     )
00292 <span class="comment">/*++</span>
00293 <span class="comment"></span>
00294 <span class="comment">Routine Description:</span>
00295 <span class="comment"></span>
00296 <span class="comment">    This function loads the PAT to all processors.</span>
00297 <span class="comment"></span>
00298 <span class="comment">Arguments:</span>
00299 <span class="comment"></span>
00300 <span class="comment">    Context - Context which includes new PAT to load</span>
00301 <span class="comment"></span>
00302 <span class="comment">Return Value:</span>
00303 <span class="comment"></span>
00304 <span class="comment">    PAT on all processors programmed to new values</span>
00305 <span class="comment"></span>
00306 <span class="comment">--*/</span>
00307 {
00308     BOOLEAN             Enable;
00309     ULONG               HldCr0, HldCr4, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00310 
00311     <span class="comment">//</span>
00312     <span class="comment">// Disable interrupts</span>
00313     <span class="comment">//</span>
00314 
00315     Enable = <a class="code" href="../../d0/d0/ki_8h.html#a106">KiDisableInterrupts</a>();
00316 
00317     <span class="comment">//</span>
00318     <span class="comment">// Synchronize all processors</span>
00319     <span class="comment">//</span>
00320 
00321     <a class="code" href="../../d9/d3/pat_8c.html#a7">KiSynchronizePATLoad</a> (Context);
00322 
00323     _asm {
00324         ;
00325         ; Get current CR0
00326         ;
00327 
00328         mov     eax, cr0
00329         mov     HldCr0, eax
00330 
00331         ;
00332         ; Disable caching &amp; line fill
00333         ;
00334 
00335         and     eax, not CR0_NW
00336         or      eax, CR0_CD
00337         mov     cr0, eax
00338 
00339         ;
00340         ; Flush caches
00341         ;
00342 
00343         ;
00344         ; wbinvd
00345         ;
00346 
00347         _emit 0Fh
00348         _emit 09h
00349 
00350         ;
00351         ; Get current cr4
00352         ;
00353 
00354         _emit  0Fh
00355         _emit  20h
00356         _emit  0E0h             ; mov eax, cr4
00357         mov     HldCr4, eax
00358 
00359         ;
00360         ; Disable global page
00361         ;
00362 
00363         and     eax, not CR4_PGE
00364         _emit  0Fh
00365         _emit  22h
00366         _emit  0E0h             ; mov cr4, eax
00367 
00368         ;
00369         ; Flush TLB
00370         ;
00371 
00372         mov     eax, cr3
00373         mov     cr3, eax
00374     }
00375 
00376     <span class="comment">//</span>
00377     <span class="comment">// Synchronize all processors</span>
00378     <span class="comment">//</span>
00379 
00380     <a class="code" href="../../d9/d3/pat_8c.html#a7">KiSynchronizePATLoad</a> (Context);
00381 
00382     <span class="comment">//</span>
00383     <span class="comment">// Load new PAT</span>
00384     <span class="comment">//</span>
00385 
00386     <a class="code" href="../../d5/d3/i386_8h.html#a53">WRMSR</a> (<a class="code" href="../../d0/d4/pat_8h.html#a0">PAT_MSR</a>, Context-&gt;Attributes.QuadPart);
00387 
00388     <span class="comment">//</span>
00389     <span class="comment">// Synchronize all processors</span>
00390     <span class="comment">//</span>
00391 
00392     <a class="code" href="../../d9/d3/pat_8c.html#a7">KiSynchronizePATLoad</a> (Context);
00393 
00394     _asm {
00395 
00396         ;
00397         ; Flush caches.
00398         ;
00399 
00400         ;
00401         ; wbinvd
00402         ;
00403 
00404         _emit 0Fh
00405         _emit 09h
00406 
00407         ;
00408         ; Flush TLBs
00409         ;
00410 
00411         mov     eax, cr3
00412         mov     cr3, eax
00413     }
00414 
00415     <span class="comment">//</span>
00416     <span class="comment">// Synchronize all processors</span>
00417     <span class="comment">//</span>
00418 
00419     <a class="code" href="../../d9/d3/pat_8c.html#a7">KiSynchronizePATLoad</a> (Context);
00420 
00421     _asm {
00422         ;
00423         ; Restore CR4 (global page enable)
00424         ;
00425 
00426         mov     eax, HldCr4
00427         _emit  0Fh
00428         _emit  22h
00429         _emit  0E0h             ; mov cr4, eax
00430 
00431         ;
00432         ; Restore CR0 (cache enable)
00433         ;
00434 
00435         mov     eax, HldCr0
00436         mov     cr0, eax
00437     }
00438 
00439     <span class="comment">//</span>
00440     <span class="comment">// Restore interrupts and return</span>
00441     <span class="comment">//</span>
00442 
00443     <a class="code" href="../../d0/d0/ki_8h.html#a107">KiRestoreInterrupts</a> (Enable);
00444 }
00445 
00446 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00447"></a><a class="code" href="../../d9/d3/pat_8c.html#a7">00447</a> <a class="code" href="../../d9/d3/pat_8c.html#a7">KiSynchronizePATLoad</a> (
00448     IN PNEW_PAT   Context
00449     )
00450 <span class="comment">/*++</span>
00451 <span class="comment"></span>
00452 <span class="comment">Routine Description:</span>
00453 <span class="comment"></span>
00454 <span class="comment">    This function synchronizes all processors during the various phases</span>
00455 <span class="comment">    of modifying the PAT.</span>
00456 <span class="comment"></span>
00457 <span class="comment">Arguments:</span>
00458 <span class="comment"></span>
00459 <span class="comment">    Context - Context which includes the barrier synchronization counter.</span>
00460 <span class="comment"></span>
00461 <span class="comment">Return Value:</span>
00462 <span class="comment"></span>
00463 <span class="comment">    PAT on all processors programmed to new values</span>
00464 <span class="comment"></span>
00465 <span class="comment">--*/</span>
00466 {
00467     ULONG               CurrentPhase;
00468     <span class="keyword">volatile</span> ULONG      *TargetPhase;
00469     PKPRCB              Prcb;
00470 
00471     TargetPhase = Context-&gt;TargetPhase;
00472     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00473 
00474     <span class="keywordflow">if</span> (Prcb-&gt;Number == (CCHAR) Context-&gt;Processor) {
00475 
00476         <span class="comment">//</span>
00477         <span class="comment">// Wait for all processors to signal</span>
00478         <span class="comment">//</span>
00479 
00480         <span class="keywordflow">while</span> (Context-&gt;TargetCount != (ULONG) <a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a> - 1) ;
00481 
00482         <span class="comment">//</span>
00483         <span class="comment">// Reset count for next time</span>
00484         <span class="comment">//</span>
00485 
00486         Context-&gt;TargetCount = 0;
00487 
00488         <span class="comment">//</span>
00489         <span class="comment">// Let waiting processor go to next synchronization point</span>
00490         <span class="comment">//</span>
00491 
00492         InterlockedIncrement ((PULONG) TargetPhase);
00493 
00494 
00495     } <span class="keywordflow">else</span> {
00496 
00497         <span class="comment">//</span>
00498         <span class="comment">// Get current phase</span>
00499         <span class="comment">//</span>
00500 
00501         CurrentPhase = *TargetPhase;
00502 
00503         <span class="comment">//</span>
00504         <span class="comment">// Signal that we have completed the current phase</span>
00505         <span class="comment">//</span>
00506 
00507         InterlockedIncrement ((PULONG) &amp;Context-&gt;TargetCount);
00508 
00509         <span class="comment">//</span>
00510         <span class="comment">// Wait for new phase to begin</span>
00511         <span class="comment">//</span>
00512 
00513         <span class="keywordflow">while</span> (*TargetPhase == CurrentPhase) ;
00514     }
00515 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:08 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
