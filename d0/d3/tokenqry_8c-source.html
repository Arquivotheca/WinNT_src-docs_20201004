<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: tokenqry.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>tokenqry.c</h1><a href="../../d9/d3/tokenqry_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    Tokenqry.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the QUERY function for the executive</span>
00012 <span class="comment">    token object.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Jim Kelly (JimK) 15-June-1990</span>
00017 <span class="comment"></span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 <span class="preprocessor">#include "<a class="code" href="../../d6/d6/sep_8h.html">sep.h</a>"</span>
00024 <span class="preprocessor">#include "<a class="code" href="../../d8/d3/tokenp_8h.html">tokenp.h</a>"</span>
00025 
00026 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtQueryInformationToken)</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeQueryAuthenticationIdToken)</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeQueryInformationToken)</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00031 <span class="preprocessor"></span>
00032 
00033 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00034"></a><a class="code" href="../../d9/d3/tokenqry_8c.html#a0">00034</a> <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a> (
00035     IN HANDLE TokenHandle,
00036     IN TOKEN_INFORMATION_CLASS TokenInformationClass,
00037     OUT PVOID TokenInformation,
00038     IN ULONG TokenInformationLength,
00039     OUT PULONG ReturnLength
00040     )
00041 
00042 <span class="comment">/*++</span>
00043 <span class="comment"></span>
00044 <span class="comment"></span>
00045 <span class="comment">Routine Description:</span>
00046 <span class="comment"></span>
00047 <span class="comment">    Retrieve information about a specified token.</span>
00048 <span class="comment"></span>
00049 <span class="comment">Arguments:</span>
00050 <span class="comment"></span>
00051 <span class="comment">    TokenHandle - Provides a handle to the token to operate on.</span>
00052 <span class="comment"></span>
00053 <span class="comment">    TokenInformationClass - The token information class about which</span>
00054 <span class="comment">        to retrieve information.</span>
00055 <span class="comment"></span>
00056 <span class="comment">    TokenInformation - The buffer to receive the requested class of</span>
00057 <span class="comment">        information.  The buffer must be aligned on at least a</span>
00058 <span class="comment">        longword boundary.  The actual structures returned are</span>
00059 <span class="comment">        dependent upon the information class requested, as defined in</span>
00060 <span class="comment">        the TokenInformationClass parameter description.</span>
00061 <span class="comment"></span>
00062 <span class="comment">        TokenInformation Format By Information Class:</span>
00063 <span class="comment"></span>
00064 <span class="comment">           TokenUser =&gt; TOKEN_USER data structure.  TOKEN_QUERY</span>
00065 <span class="comment">           access is needed to retrieve this information about a</span>
00066 <span class="comment">           token.</span>
00067 <span class="comment"></span>
00068 <span class="comment">           TokenGroups =&gt; TOKEN_GROUPS data structure.  TOKEN_QUERY</span>
00069 <span class="comment">           access is needed to retrieve this information about a</span>
00070 <span class="comment">           token.</span>
00071 <span class="comment"></span>
00072 <span class="comment">           TokenPrivileges =&gt; TOKEN_PRIVILEGES data structure.</span>
00073 <span class="comment">           TOKEN_QUERY access is needed to retrieve this information</span>
00074 <span class="comment">           about a token.</span>
00075 <span class="comment"></span>
00076 <span class="comment">           TokenOwner =&gt; TOKEN_OWNER data structure.  TOKEN_QUERY</span>
00077 <span class="comment">           access is needed to retrieve this information about a</span>
00078 <span class="comment">           token.</span>
00079 <span class="comment"></span>
00080 <span class="comment">           TokenPrimaryGroup =&gt; TOKEN_PRIMARY_GROUP data structure.</span>
00081 <span class="comment">           TOKEN_QUERY access is needed to retrieve this information</span>
00082 <span class="comment">           about a token.</span>
00083 <span class="comment"></span>
00084 <span class="comment">           TokenDefaultDacl =&gt; TOKEN_DEFAULT_DACL data structure.</span>
00085 <span class="comment">           TOKEN_QUERY access is needed to retrieve this information</span>
00086 <span class="comment">           about a token.</span>
00087 <span class="comment"></span>
00088 <span class="comment">           TokenSource =&gt; TOKEN_SOURCE data structure.</span>
00089 <span class="comment">           TOKEN_QUERY_SOURCE access is needed to retrieve this</span>
00090 <span class="comment">           information about a token.</span>
00091 <span class="comment"></span>
00092 <span class="comment">           TokenType =&gt; TOKEN_TYPE data structure.</span>
00093 <span class="comment">           TOKEN_QUERY access is needed to retrieve this information</span>
00094 <span class="comment">           about a token.</span>
00095 <span class="comment"></span>
00096 <span class="comment">           TokenStatistics =&gt; TOKEN_STATISTICS data structure.</span>
00097 <span class="comment">           TOKEN_QUERY access is needed to retrieve this</span>
00098 <span class="comment">           information about a token.</span>
00099 <span class="comment"></span>
00100 <span class="comment">           TokenGroups =&gt; TOKEN_GROUPS data structure.  TOKEN_QUERY</span>
00101 <span class="comment">           access is needed to retrieve this information about a</span>
00102 <span class="comment">           token.</span>
00103 <span class="comment"></span>
00104 <span class="comment">    TokenInformationLength - Indicates the length, in bytes, of the</span>
00105 <span class="comment">        TokenInformation buffer.</span>
00106 <span class="comment"></span>
00107 <span class="comment">    ReturnLength - This OUT parameter receives the actual length of</span>
00108 <span class="comment">        the requested information.  If this value is larger than that</span>
00109 <span class="comment">        provided by the TokenInformationLength parameter, then the</span>
00110 <span class="comment">        buffer provided to receive the requested information is not</span>
00111 <span class="comment">        large enough to hold that data and no data is returned.</span>
00112 <span class="comment"></span>
00113 <span class="comment">        If the queried class is TokenDefaultDacl and there is no</span>
00114 <span class="comment">        default Dacl established for the token, then the return</span>
00115 <span class="comment">        length will be returned as zero, and no data will be returned.</span>
00116 <span class="comment"></span>
00117 <span class="comment">Return Value:</span>
00118 <span class="comment"></span>
00119 <span class="comment">    STATUS_SUCCESS - Indicates the operation was successful.</span>
00120 <span class="comment"></span>
00121 <span class="comment">    STATUS_BUFFER_TOO_SMALL - if the requested information did not</span>
00122 <span class="comment">        fit in the provided output buffer.  In this case, the</span>
00123 <span class="comment">        ReturnLength OUT parameter contains the number of bytes</span>
00124 <span class="comment">        actually needed to store the requested information.</span>
00125 <span class="comment"></span>
00126 <span class="comment">--*/</span>
00127 {
00128 
00129     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00130     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00131 
00132     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00133 
00134     ULONG RequiredLength;
00135     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00136 
00137     PTOKEN_TYPE LocalType;
00138     PTOKEN_USER LocalUser;
00139     PTOKEN_GROUPS LocalGroups;
00140     PTOKEN_PRIVILEGES LocalPrivileges;
00141     PTOKEN_OWNER LocalOwner;
00142     PTOKEN_PRIMARY_GROUP LocalPrimaryGroup;
00143     PTOKEN_DEFAULT_DACL LocalDefaultDacl;
00144     PTOKEN_SOURCE LocalSource;
00145     PSECURITY_IMPERSONATION_LEVEL LocalImpersonationLevel;
00146     PTOKEN_STATISTICS LocalStatistics;
00147 
00148     PSID PSid;
00149     PACL PAcl;
00150 
00151     PVOID Ignore;
00152     ULONG SessionId;
00153 
00154     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00155 
00156     <span class="comment">//</span>
00157     <span class="comment">// Get previous processor mode and probe output argument if necessary.</span>
00158     <span class="comment">//</span>
00159 
00160     PreviousMode = KeGetPreviousMode();
00161     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00162         <span class="keywordflow">try</span> {
00163 
00164             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
00165                 TokenInformation,
00166                 TokenInformationLength,
00167                 <span class="keyword">sizeof</span>(ULONG)
00168                 );
00169 
00170             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(ReturnLength);
00171 
00172         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00173             <span class="keywordflow">return</span> GetExceptionCode();
00174         }
00175     }
00176 
00177     <span class="comment">//</span>
00178     <span class="comment">// Case on information class.</span>
00179     <span class="comment">//</span>
00180 
00181     <span class="keywordflow">switch</span> ( TokenInformationClass ) {
00182 
00183     <span class="keywordflow">case</span> TokenUser:
00184 
00185         LocalUser = (PTOKEN_USER)TokenInformation;
00186 
00187         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00188                  TokenHandle,           <span class="comment">// Handle</span>
00189                  TOKEN_QUERY,           <span class="comment">// DesiredAccess</span>
00190                  <a class="code" href="../../d0/d5/se_8h.html#a36">SepTokenObjectType</a>,    <span class="comment">// ObjectType</span>
00191                  PreviousMode,          <span class="comment">// AccessMode</span>
00192                  (PVOID *)&amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,       <span class="comment">// Object</span>
00193                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                   <span class="comment">// GrantedAccess</span>
00194                  );
00195 
00196         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00197             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00198         }
00199 
00200         <span class="comment">//</span>
00201         <span class="comment">//  Gain exclusive access to the token.</span>
00202         <span class="comment">//</span>
00203 
00204         <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00205 
00206 
00207 
00208         <span class="comment">//</span>
00209         <span class="comment">// Return the length required now in case not enough buffer</span>
00210         <span class="comment">// was provided by the caller and we have to return an error.</span>
00211         <span class="comment">//</span>
00212 
00213         RequiredLength = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[0].Sid) +
00214                          (ULONG)<span class="keyword">sizeof</span>( TOKEN_USER );
00215 
00216         <span class="keywordflow">try</span> {
00217 
00218             *ReturnLength = RequiredLength;
00219 
00220         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00221 
00222             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00223             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00224             <span class="keywordflow">return</span> GetExceptionCode();
00225         }
00226 
00227         <span class="keywordflow">if</span> ( TokenInformationLength &lt; RequiredLength ) {
00228 
00229             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00230             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00231             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00232 
00233         }
00234 
00235         <span class="comment">//</span>
00236         <span class="comment">// Return the user SID</span>
00237         <span class="comment">//</span>
00238 
00239         <span class="keywordflow">try</span> {
00240 
00241             <span class="comment">//</span>
00242             <span class="comment">//  Put SID immediately following TOKEN_USER data structure</span>
00243             <span class="comment">//</span>
00244             PSid = (PSID)( (ULONG_PTR)LocalUser + (ULONG)<span class="keyword">sizeof</span>(TOKEN_USER) );
00245 
00246             <a class="code" href="../../d8/d6/sertl_8c.html#a47">RtlCopySidAndAttributesArray</a>(
00247                 1,
00248                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups,
00249                 RequiredLength,
00250                 &amp;(LocalUser-&gt;User),
00251                 PSid,
00252                 ((PSID *)&amp;Ignore),
00253                 ((PULONG)&amp;Ignore)
00254                 );
00255 
00256         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00257 
00258             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00259             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00260             <span class="keywordflow">return</span> GetExceptionCode();
00261         }
00262 
00263 
00264         <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00265         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00266         <span class="keywordflow">return</span> STATUS_SUCCESS;
00267 
00268     <span class="keywordflow">case</span> TokenGroups:
00269 
00270         LocalGroups = (PTOKEN_GROUPS)TokenInformation;
00271 
00272         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00273                  TokenHandle,           <span class="comment">// Handle</span>
00274                  TOKEN_QUERY,           <span class="comment">// DesiredAccess</span>
00275                  <a class="code" href="../../d0/d5/se_8h.html#a36">SepTokenObjectType</a>,    <span class="comment">// ObjectType</span>
00276                  PreviousMode,          <span class="comment">// AccessMode</span>
00277                  (PVOID *)&amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,       <span class="comment">// Object</span>
00278                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                   <span class="comment">// GrantedAccess</span>
00279                  );
00280 
00281         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00282             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00283         }
00284 
00285         <span class="comment">//</span>
00286         <span class="comment">//  Gain exclusive access to the token.</span>
00287         <span class="comment">//</span>
00288 
00289         <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00290 
00291         <span class="comment">//</span>
00292         <span class="comment">// Figure out how much space is needed to return the group SIDs.</span>
00293         <span class="comment">// That's the size of TOKEN_GROUPS (without any array entries)</span>
00294         <span class="comment">// plus the size of an SID_AND_ATTRIBUTES times the number of groups.</span>
00295         <span class="comment">// The number of groups is Token-&gt;UserAndGroups-1 (since the count</span>
00296         <span class="comment">// includes the user ID).  Then the lengths of each individual group</span>
00297         <span class="comment">// must be added.</span>
00298         <span class="comment">//</span>
00299 
00300         RequiredLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_GROUPS) +
00301                          ((<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount - <a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a> - 1) *
00302                          ((ULONG)<span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES)) );
00303 
00304         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 1;
00305         <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount) {
00306 
00307             RequiredLength += <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Sid );
00308 
00309             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
00310 
00311         } <span class="comment">// endwhile</span>
00312 
00313         <span class="comment">//</span>
00314         <span class="comment">// Return the length required now in case not enough buffer</span>
00315         <span class="comment">// was provided by the caller and we have to return an error.</span>
00316         <span class="comment">//</span>
00317 
00318         <span class="keywordflow">try</span> {
00319 
00320             *ReturnLength = RequiredLength;
00321 
00322         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00323 
00324             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00325             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00326             <span class="keywordflow">return</span> GetExceptionCode();
00327         }
00328 
00329         <span class="keywordflow">if</span> ( TokenInformationLength &lt; RequiredLength ) {
00330 
00331             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00332             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00333             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00334 
00335         }
00336 
00337         <span class="comment">//</span>
00338         <span class="comment">// Now copy the groups.</span>
00339         <span class="comment">//</span>
00340 
00341         <span class="keywordflow">try</span> {
00342 
00343             LocalGroups-&gt;GroupCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount - 1;
00344 
00345             PSid = (PSID)( (ULONG_PTR)LocalGroups +
00346                            (ULONG)<span class="keyword">sizeof</span>(TOKEN_GROUPS) +
00347                            (   (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount - <a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a> - 1) *
00348                                (ULONG)<span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES) )
00349                          );
00350 
00351             <a class="code" href="../../d8/d6/sertl_8c.html#a47">RtlCopySidAndAttributesArray</a>(
00352                 (ULONG)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount - 1),
00353                 &amp;(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[1]),
00354                 RequiredLength,
00355                 LocalGroups-&gt;Groups,
00356                 PSid,
00357                 ((PSID *)&amp;Ignore),
00358                 ((PULONG)&amp;Ignore)
00359                 );
00360 
00361         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00362 
00363             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00364             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00365             <span class="keywordflow">return</span> GetExceptionCode();
00366         }
00367 
00368 
00369         <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00370         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00371         <span class="keywordflow">return</span> STATUS_SUCCESS;
00372 
00373     <span class="keywordflow">case</span> TokenRestrictedSids:
00374 
00375         LocalGroups = (PTOKEN_GROUPS)TokenInformation;
00376 
00377         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00378                  TokenHandle,           <span class="comment">// Handle</span>
00379                  TOKEN_QUERY,           <span class="comment">// DesiredAccess</span>
00380                  <a class="code" href="../../d0/d5/se_8h.html#a36">SepTokenObjectType</a>,    <span class="comment">// ObjectType</span>
00381                  PreviousMode,          <span class="comment">// AccessMode</span>
00382                  (PVOID *)&amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,       <span class="comment">// Object</span>
00383                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                   <span class="comment">// GrantedAccess</span>
00384                  );
00385 
00386         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00387             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00388         }
00389 
00390         <span class="comment">//</span>
00391         <span class="comment">//  Gain exclusive access to the token.</span>
00392         <span class="comment">//</span>
00393 
00394         <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00395 
00396         <span class="comment">//</span>
00397         <span class="comment">// Figure out how much space is needed to return the group SIDs.</span>
00398         <span class="comment">// That's the size of TOKEN_GROUPS (without any array entries)</span>
00399         <span class="comment">// plus the size of an SID_AND_ATTRIBUTES times the number of groups.</span>
00400         <span class="comment">// The number of groups is Token-&gt;UserAndGroups-1 (since the count</span>
00401         <span class="comment">// includes the user ID).  Then the lengths of each individual group</span>
00402         <span class="comment">// must be added.</span>
00403         <span class="comment">//</span>
00404 
00405         RequiredLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_GROUPS) +
00406                          ((<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;RestrictedSidCount) *
00407                          ((ULONG)<span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES)) -
00408                          <a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a> * <span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES) );
00409 
00410         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
00411         <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;RestrictedSidCount) {
00412 
00413             RequiredLength += <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;RestrictedSids[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Sid );
00414 
00415             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
00416 
00417         } <span class="comment">// endwhile</span>
00418 
00419         <span class="comment">//</span>
00420         <span class="comment">// Return the length required now in case not enough buffer</span>
00421         <span class="comment">// was provided by the caller and we have to return an error.</span>
00422         <span class="comment">//</span>
00423 
00424         <span class="keywordflow">try</span> {
00425 
00426             *ReturnLength = RequiredLength;
00427 
00428         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00429 
00430             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00431             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00432             <span class="keywordflow">return</span> GetExceptionCode();
00433         }
00434 
00435         <span class="keywordflow">if</span> ( TokenInformationLength &lt; RequiredLength ) {
00436 
00437             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00438             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00439             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00440 
00441         }
00442 
00443         <span class="comment">//</span>
00444         <span class="comment">// Now copy the groups.</span>
00445         <span class="comment">//</span>
00446 
00447         <span class="keywordflow">try</span> {
00448 
00449             LocalGroups-&gt;GroupCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;RestrictedSidCount;
00450 
00451             PSid = (PSID)( (ULONG_PTR)LocalGroups +
00452                            (ULONG)<span class="keyword">sizeof</span>(TOKEN_GROUPS) +
00453                            (   (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;RestrictedSidCount ) *
00454                                (ULONG)<span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES) -
00455                                <a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a> * <span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES) )
00456                          );
00457 
00458             <a class="code" href="../../d8/d6/sertl_8c.html#a47">RtlCopySidAndAttributesArray</a>(
00459                 (ULONG)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;RestrictedSidCount),
00460                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;RestrictedSids,
00461                 RequiredLength,
00462                 LocalGroups-&gt;Groups,
00463                 PSid,
00464                 ((PSID *)&amp;Ignore),
00465                 ((PULONG)&amp;Ignore)
00466                 );
00467 
00468         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00469 
00470             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00471             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00472             <span class="keywordflow">return</span> GetExceptionCode();
00473         }
00474 
00475 
00476         <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00477         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00478         <span class="keywordflow">return</span> STATUS_SUCCESS;
00479 
00480     <span class="keywordflow">case</span> TokenPrivileges:
00481 
00482         LocalPrivileges = (PTOKEN_PRIVILEGES)TokenInformation;
00483 
00484         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00485                  TokenHandle,           <span class="comment">// Handle</span>
00486                  TOKEN_QUERY,           <span class="comment">// DesiredAccess</span>
00487                  <a class="code" href="../../d0/d5/se_8h.html#a36">SepTokenObjectType</a>,    <span class="comment">// ObjectType</span>
00488                  PreviousMode,          <span class="comment">// AccessMode</span>
00489                  (PVOID *)&amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,       <span class="comment">// Object</span>
00490                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                   <span class="comment">// GrantedAccess</span>
00491                  );
00492 
00493         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00494             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00495         }
00496 
00497         <span class="comment">//</span>
00498         <span class="comment">//  Gain exclusive access to the token to prevent changes</span>
00499         <span class="comment">//  from occuring to the privileges.</span>
00500         <span class="comment">//</span>
00501 
00502         <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00503 
00504 
00505         <span class="comment">//</span>
00506         <span class="comment">// Return the length required now in case not enough buffer</span>
00507         <span class="comment">// was provided by the caller and we have to return an error.</span>
00508         <span class="comment">//</span>
00509 
00510         RequiredLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_PRIVILEGES) +
00511                          ((<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrivilegeCount - <a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a>) *
00512                          ((ULONG)<span class="keyword">sizeof</span>(LUID_AND_ATTRIBUTES)) );
00513 
00514 
00515         <span class="keywordflow">try</span> {
00516 
00517             *ReturnLength = RequiredLength;
00518 
00519         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00520 
00521             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00522             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00523             <span class="keywordflow">return</span> GetExceptionCode();
00524         }
00525 
00526         <span class="keywordflow">if</span> ( TokenInformationLength &lt; RequiredLength ) {
00527 
00528             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00529             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00530             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00531 
00532         }
00533 
00534         <span class="comment">//</span>
00535         <span class="comment">// Return the token privileges.</span>
00536         <span class="comment">//</span>
00537 
00538         <span class="keywordflow">try</span> {
00539 
00540             LocalPrivileges-&gt;PrivilegeCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrivilegeCount;
00541 
00542             <a class="code" href="../../d8/d6/sertl_8c.html#a52">RtlCopyLuidAndAttributesArray</a>(
00543                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrivilegeCount,
00544                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Privileges,
00545                 LocalPrivileges-&gt;Privileges
00546                 );
00547 
00548         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00549 
00550             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00551             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00552             <span class="keywordflow">return</span> GetExceptionCode();
00553         }
00554 
00555 
00556         <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00557         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00558         <span class="keywordflow">return</span> STATUS_SUCCESS;
00559 
00560     <span class="keywordflow">case</span> TokenOwner:
00561 
00562         LocalOwner = (PTOKEN_OWNER)TokenInformation;
00563 
00564         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00565                  TokenHandle,           <span class="comment">// Handle</span>
00566                  TOKEN_QUERY,           <span class="comment">// DesiredAccess</span>
00567                  <a class="code" href="../../d0/d5/se_8h.html#a36">SepTokenObjectType</a>,    <span class="comment">// ObjectType</span>
00568                  PreviousMode,          <span class="comment">// AccessMode</span>
00569                  (PVOID *)&amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,       <span class="comment">// Object</span>
00570                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                   <span class="comment">// GrantedAccess</span>
00571                  );
00572 
00573         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00574             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00575         }
00576 
00577         <span class="comment">//</span>
00578         <span class="comment">//  Gain exclusive access to the token to prevent changes</span>
00579         <span class="comment">//  from occuring to the owner.</span>
00580         <span class="comment">//</span>
00581 
00582         <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00583 
00584         <span class="comment">//</span>
00585         <span class="comment">// Return the length required now in case not enough buffer</span>
00586         <span class="comment">// was provided by the caller and we have to return an error.</span>
00587         <span class="comment">//</span>
00588 
00589         PSid = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultOwnerIndex].Sid;
00590         RequiredLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_OWNER) +
00591                          <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( PSid );
00592 
00593         <span class="keywordflow">try</span> {
00594 
00595             *ReturnLength = RequiredLength;
00596 
00597         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00598 
00599             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00600             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00601             <span class="keywordflow">return</span> GetExceptionCode();
00602         }
00603 
00604         <span class="keywordflow">if</span> ( TokenInformationLength &lt; RequiredLength ) {
00605 
00606             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00607             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00608             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00609 
00610         }
00611 
00612         <span class="comment">//</span>
00613         <span class="comment">// Return the owner SID</span>
00614         <span class="comment">//</span>
00615 
00616         PSid = (PSID)((ULONG_PTR)LocalOwner +
00617                       (ULONG)<span class="keyword">sizeof</span>(TOKEN_OWNER));
00618 
00619         <span class="keywordflow">try</span> {
00620 
00621             LocalOwner-&gt;Owner = PSid;
00622 
00623             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(
00624                          (RequiredLength - (ULONG)<span class="keyword">sizeof</span>(TOKEN_OWNER)),
00625                          PSid,
00626                          <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultOwnerIndex].Sid
00627                          );
00628 
00629             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
00630 
00631         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00632 
00633             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00634             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00635             <span class="keywordflow">return</span> GetExceptionCode();
00636         }
00637 
00638 
00639         <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00640         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00641         <span class="keywordflow">return</span> STATUS_SUCCESS;
00642 
00643     <span class="keywordflow">case</span> TokenPrimaryGroup:
00644 
00645         LocalPrimaryGroup = (PTOKEN_PRIMARY_GROUP)TokenInformation;
00646 
00647         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00648                  TokenHandle,           <span class="comment">// Handle</span>
00649                  TOKEN_QUERY,           <span class="comment">// DesiredAccess</span>
00650                  <a class="code" href="../../d0/d5/se_8h.html#a36">SepTokenObjectType</a>,    <span class="comment">// ObjectType</span>
00651                  PreviousMode,          <span class="comment">// AccessMode</span>
00652                  (PVOID *)&amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,       <span class="comment">// Object</span>
00653                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                   <span class="comment">// GrantedAccess</span>
00654                  );
00655 
00656         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00657             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00658         }
00659 
00660         <span class="comment">//</span>
00661         <span class="comment">//  Gain exclusive access to the token to prevent changes</span>
00662         <span class="comment">//  from occuring to the owner.</span>
00663         <span class="comment">//</span>
00664 
00665         <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00666 
00667         <span class="comment">//</span>
00668         <span class="comment">// Return the length required now in case not enough buffer</span>
00669         <span class="comment">// was provided by the caller and we have to return an error.</span>
00670         <span class="comment">//</span>
00671 
00672         RequiredLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_PRIMARY_GROUP) +
00673                          <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup );
00674 
00675         <span class="keywordflow">try</span> {
00676 
00677             *ReturnLength = RequiredLength;
00678 
00679         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00680 
00681             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00682             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00683             <span class="keywordflow">return</span> GetExceptionCode();
00684         }
00685 
00686         <span class="keywordflow">if</span> ( TokenInformationLength &lt; RequiredLength ) {
00687 
00688             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00689             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00690             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00691 
00692         }
00693 
00694         <span class="comment">//</span>
00695         <span class="comment">// Return the primary group SID</span>
00696         <span class="comment">//</span>
00697 
00698         PSid = (PSID)((ULONG_PTR)LocalPrimaryGroup +
00699                       (ULONG)<span class="keyword">sizeof</span>(TOKEN_PRIMARY_GROUP));
00700 
00701         <span class="keywordflow">try</span> {
00702 
00703             LocalPrimaryGroup-&gt;PrimaryGroup = PSid;
00704 
00705             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( (RequiredLength - (ULONG)<span class="keyword">sizeof</span>(TOKEN_PRIMARY_GROUP)),
00706                                  PSid,
00707                                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup
00708                                  );
00709 
00710             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
00711 
00712         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00713 
00714             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00715             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00716             <span class="keywordflow">return</span> GetExceptionCode();
00717         }
00718 
00719 
00720         <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00721         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00722         <span class="keywordflow">return</span> STATUS_SUCCESS;
00723 
00724     <span class="keywordflow">case</span> TokenDefaultDacl:
00725 
00726         LocalDefaultDacl = (PTOKEN_DEFAULT_DACL)TokenInformation;
00727 
00728         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00729                  TokenHandle,           <span class="comment">// Handle</span>
00730                  TOKEN_QUERY,           <span class="comment">// DesiredAccess</span>
00731                  <a class="code" href="../../d0/d5/se_8h.html#a36">SepTokenObjectType</a>,    <span class="comment">// ObjectType</span>
00732                  PreviousMode,          <span class="comment">// AccessMode</span>
00733                  (PVOID *)&amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,       <span class="comment">// Object</span>
00734                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                   <span class="comment">// GrantedAccess</span>
00735                  );
00736 
00737         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00738             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00739         }
00740 
00741         <span class="comment">//</span>
00742         <span class="comment">//  Gain exclusive access to the token to prevent changes</span>
00743         <span class="comment">//  from occuring to the owner.</span>
00744         <span class="comment">//</span>
00745 
00746         <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00747 
00748 
00749         <span class="comment">//</span>
00750         <span class="comment">// Return the length required now in case not enough buffer</span>
00751         <span class="comment">// was provided by the caller and we have to return an error.</span>
00752         <span class="comment">//</span>
00753 
00754         RequiredLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_DEFAULT_DACL);
00755 
00756         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl)) {
00757 
00758             RequiredLength += <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl-&gt;AclSize;
00759 
00760         }
00761 
00762         <span class="keywordflow">try</span> {
00763 
00764             *ReturnLength = RequiredLength;
00765 
00766         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00767 
00768             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00769             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00770             <span class="keywordflow">return</span> GetExceptionCode();
00771         }
00772 
00773         <span class="keywordflow">if</span> ( TokenInformationLength &lt; RequiredLength ) {
00774 
00775             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00776             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00777             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00778 
00779         }
00780 
00781         <span class="comment">//</span>
00782         <span class="comment">// Return the default Dacl</span>
00783         <span class="comment">//</span>
00784 
00785         PAcl = (PACL)((ULONG_PTR)LocalDefaultDacl +
00786                       (ULONG)<span class="keyword">sizeof</span>(TOKEN_DEFAULT_DACL));
00787 
00788         <span class="keywordflow">try</span> {
00789 
00790             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl)) {
00791 
00792                 LocalDefaultDacl-&gt;DefaultDacl = PAcl;
00793 
00794                 RtlCopyMemory( (PVOID)PAcl,
00795                                (PVOID)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl,
00796                                <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl-&gt;AclSize
00797                                );
00798             } <span class="keywordflow">else</span> {
00799 
00800                 LocalDefaultDacl-&gt;DefaultDacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00801 
00802             }
00803 
00804         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00805 
00806             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00807             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00808             <span class="keywordflow">return</span> GetExceptionCode();
00809         }
00810 
00811 
00812         <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00813         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00814         <span class="keywordflow">return</span> STATUS_SUCCESS;
00815 
00816 
00817 
00818     <span class="keywordflow">case</span> TokenSource:
00819 
00820         LocalSource = (PTOKEN_SOURCE)TokenInformation;
00821 
00822         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00823                  TokenHandle,           <span class="comment">// Handle</span>
00824                  TOKEN_QUERY_SOURCE,    <span class="comment">// DesiredAccess</span>
00825                  <a class="code" href="../../d0/d5/se_8h.html#a36">SepTokenObjectType</a>,    <span class="comment">// ObjectType</span>
00826                  PreviousMode,          <span class="comment">// AccessMode</span>
00827                  (PVOID *)&amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,       <span class="comment">// Object</span>
00828                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                   <span class="comment">// GrantedAccess</span>
00829                  );
00830 
00831         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00832             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00833         }
00834 
00835         <span class="comment">//</span>
00836         <span class="comment">// The type of a token can not be changed, so</span>
00837         <span class="comment">// exclusive access to the token is not necessary.</span>
00838         <span class="comment">//</span>
00839 
00840         <span class="comment">//</span>
00841         <span class="comment">// Return the length required now in case not enough buffer</span>
00842         <span class="comment">// was provided by the caller and we have to return an error.</span>
00843         <span class="comment">//</span>
00844 
00845         RequiredLength = (ULONG) <span class="keyword">sizeof</span>(TOKEN_SOURCE);
00846 
00847         <span class="keywordflow">try</span> {
00848 
00849             *ReturnLength = RequiredLength;
00850 
00851         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00852 
00853             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00854             <span class="keywordflow">return</span> GetExceptionCode();
00855         }
00856 
00857         <span class="keywordflow">if</span> ( TokenInformationLength &lt; RequiredLength ) {
00858 
00859             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00860             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00861 
00862         }
00863 
00864 
00865         <span class="comment">//</span>
00866         <span class="comment">// Return the token source</span>
00867         <span class="comment">//</span>
00868 
00869         <span class="keywordflow">try</span> {
00870 
00871             (*LocalSource) = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenSource;
00872 
00873         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00874 
00875             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00876             <span class="keywordflow">return</span> GetExceptionCode();
00877         }
00878 
00879 
00880         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00881         <span class="keywordflow">return</span> STATUS_SUCCESS;
00882 
00883     <span class="keywordflow">case</span> TokenType:
00884 
00885         LocalType = (PTOKEN_TYPE)TokenInformation;
00886 
00887         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00888                  TokenHandle,           <span class="comment">// Handle</span>
00889                  TOKEN_QUERY,           <span class="comment">// DesiredAccess</span>
00890                  <a class="code" href="../../d0/d5/se_8h.html#a36">SepTokenObjectType</a>,    <span class="comment">// ObjectType</span>
00891                  PreviousMode,          <span class="comment">// AccessMode</span>
00892                  (PVOID *)&amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,       <span class="comment">// Object</span>
00893                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                   <span class="comment">// GrantedAccess</span>
00894                  );
00895 
00896         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00897             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00898         }
00899 
00900         <span class="comment">//</span>
00901         <span class="comment">// The type of a token can not be changed, so</span>
00902         <span class="comment">// exclusive access to the token is not necessary.</span>
00903         <span class="comment">//</span>
00904 
00905         <span class="comment">//</span>
00906         <span class="comment">// Return the length required now in case not enough buffer</span>
00907         <span class="comment">// was provided by the caller and we have to return an error.</span>
00908         <span class="comment">//</span>
00909 
00910         RequiredLength = (ULONG) <span class="keyword">sizeof</span>(TOKEN_TYPE);
00911 
00912         <span class="keywordflow">try</span> {
00913 
00914             *ReturnLength = RequiredLength;
00915 
00916         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00917 
00918             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00919             <span class="keywordflow">return</span> GetExceptionCode();
00920         }
00921 
00922         <span class="keywordflow">if</span> ( TokenInformationLength &lt; RequiredLength ) {
00923 
00924             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00925             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00926 
00927         }
00928 
00929 
00930         <span class="comment">//</span>
00931         <span class="comment">// Return the token type</span>
00932         <span class="comment">//</span>
00933 
00934         <span class="keywordflow">try</span> {
00935 
00936             (*LocalType) = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenType;
00937 
00938         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00939 
00940             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00941             <span class="keywordflow">return</span> GetExceptionCode();
00942         }
00943 
00944 
00945         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00946         <span class="keywordflow">return</span> STATUS_SUCCESS;
00947 
00948 
00949     <span class="keywordflow">case</span> TokenImpersonationLevel:
00950 
00951         LocalImpersonationLevel = (PSECURITY_IMPERSONATION_LEVEL)TokenInformation;
00952 
00953         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00954                  TokenHandle,           <span class="comment">// Handle</span>
00955                  TOKEN_QUERY,           <span class="comment">// DesiredAccess</span>
00956                  <a class="code" href="../../d0/d5/se_8h.html#a36">SepTokenObjectType</a>,    <span class="comment">// ObjectType</span>
00957                  PreviousMode,          <span class="comment">// AccessMode</span>
00958                  (PVOID *)&amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,       <span class="comment">// Object</span>
00959                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                   <span class="comment">// GrantedAccess</span>
00960                  );
00961 
00962         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00963             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00964         }
00965 
00966         <span class="comment">//</span>
00967         <span class="comment">// The impersonation level of a token can not be changed, so</span>
00968         <span class="comment">// exclusive access to the token is not necessary.</span>
00969         <span class="comment">//</span>
00970 
00971         <span class="comment">//</span>
00972         <span class="comment">//  Make sure the token is an appropriate type to be retrieving</span>
00973         <span class="comment">//  the impersonation level from.</span>
00974         <span class="comment">//</span>
00975 
00976         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenType != TokenImpersonation) {
00977 
00978             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00979             <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
00980 
00981         }
00982 
00983         <span class="comment">//</span>
00984         <span class="comment">// Return the length required now in case not enough buffer</span>
00985         <span class="comment">// was provided by the caller and we have to return an error.</span>
00986         <span class="comment">//</span>
00987 
00988         RequiredLength = (ULONG) <span class="keyword">sizeof</span>(SECURITY_IMPERSONATION_LEVEL);
00989 
00990         <span class="keywordflow">try</span> {
00991 
00992             *ReturnLength = RequiredLength;
00993 
00994         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00995 
00996             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00997             <span class="keywordflow">return</span> GetExceptionCode();
00998         }
00999 
01000         <span class="keywordflow">if</span> ( TokenInformationLength &lt; RequiredLength ) {
01001 
01002             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01003             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
01004 
01005         }
01006 
01007 
01008         <span class="comment">//</span>
01009         <span class="comment">// Return the impersonation level</span>
01010         <span class="comment">//</span>
01011 
01012         <span class="keywordflow">try</span> {
01013 
01014             (*LocalImpersonationLevel) = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ImpersonationLevel;
01015 
01016         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01017 
01018             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01019             <span class="keywordflow">return</span> GetExceptionCode();
01020         }
01021 
01022 
01023         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01024         <span class="keywordflow">return</span> STATUS_SUCCESS;
01025 
01026 
01027     <span class="keywordflow">case</span> TokenStatistics:
01028 
01029         LocalStatistics = (PTOKEN_STATISTICS)TokenInformation;
01030 
01031         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01032                  TokenHandle,           <span class="comment">// Handle</span>
01033                  TOKEN_QUERY,           <span class="comment">// DesiredAccess</span>
01034                  <a class="code" href="../../d0/d5/se_8h.html#a36">SepTokenObjectType</a>,    <span class="comment">// ObjectType</span>
01035                  PreviousMode,          <span class="comment">// AccessMode</span>
01036                  (PVOID *)&amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,       <span class="comment">// Object</span>
01037                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                   <span class="comment">// GrantedAccess</span>
01038                  );
01039 
01040         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
01041             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01042         }
01043 
01044         <span class="comment">//</span>
01045         <span class="comment">//  Gain exclusive access to the token.</span>
01046         <span class="comment">//</span>
01047 
01048         <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01049 
01050 
01051 
01052         <span class="comment">//</span>
01053         <span class="comment">// Return the length required now in case not enough buffer</span>
01054         <span class="comment">// was provided by the caller and we have to return an error.</span>
01055         <span class="comment">//</span>
01056 
01057         RequiredLength = (ULONG)<span class="keyword">sizeof</span>( TOKEN_STATISTICS );
01058 
01059         <span class="keywordflow">try</span> {
01060 
01061             *ReturnLength = RequiredLength;
01062 
01063         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01064 
01065             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01066             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01067             <span class="keywordflow">return</span> GetExceptionCode();
01068         }
01069 
01070         <span class="keywordflow">if</span> ( TokenInformationLength &lt; RequiredLength ) {
01071 
01072             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01073             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01074             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
01075 
01076         }
01077 
01078         <span class="comment">//</span>
01079         <span class="comment">// Return the statistics</span>
01080         <span class="comment">//</span>
01081 
01082         <span class="keywordflow">try</span> {
01083 
01084             LocalStatistics-&gt;TokenId            = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenId;
01085             LocalStatistics-&gt;AuthenticationId   = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;AuthenticationId;
01086             LocalStatistics-&gt;ExpirationTime     = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ExpirationTime;
01087             LocalStatistics-&gt;TokenType          = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenType;
01088             LocalStatistics-&gt;ImpersonationLevel = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ImpersonationLevel;
01089             LocalStatistics-&gt;DynamicCharged     = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicCharged;
01090             LocalStatistics-&gt;DynamicAvailable   = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicAvailable;
01091             LocalStatistics-&gt;GroupCount         = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount-1;
01092             LocalStatistics-&gt;PrivilegeCount     = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrivilegeCount;
01093             LocalStatistics-&gt;ModifiedId         = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ModifiedId;
01094 
01095         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01096 
01097             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01098             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01099             <span class="keywordflow">return</span> GetExceptionCode();
01100         }
01101 
01102 
01103         <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01104         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01105         <span class="keywordflow">return</span> STATUS_SUCCESS;
01106 
01107     <span class="keywordflow">case</span> TokenSessionId:
01108 
01109         <span class="keywordflow">if</span> ( TokenInformationLength != <span class="keyword">sizeof</span>(ULONG) )
01110             <span class="keywordflow">return</span>( STATUS_INFO_LENGTH_MISMATCH );
01111 
01112         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01113                  TokenHandle,           <span class="comment">// Handle</span>
01114                  TOKEN_QUERY,           <span class="comment">// DesiredAccess</span>
01115                  <a class="code" href="../../d0/d5/se_8h.html#a36">SepTokenObjectType</a>,    <span class="comment">// ObjectType</span>
01116                  PreviousMode,          <span class="comment">// AccessMode</span>
01117                  (PVOID *)&amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,       <span class="comment">// Object</span>
01118                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                   <span class="comment">// GrantedAccess</span>
01119                  );
01120 
01121         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
01122             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01123         }
01124 
01125         <span class="comment">//</span>
01126         <span class="comment">// Get SessionId for the token</span>
01127         <span class="comment">//</span>
01128         <a class="code" href="../../d9/d3/tokenqry_8c.html#a3">SeQuerySessionIdToken</a>( (PACCESS_TOKEN)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
01129                                &amp;SessionId);
01130 
01131         <span class="keywordflow">try</span> {
01132 
01133             *(PULONG)TokenInformation = SessionId;
01134             *ReturnLength = <span class="keyword">sizeof</span>(ULONG);
01135 
01136         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01137             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01138             <span class="keywordflow">return</span> GetExceptionCode();
01139         }
01140 
01141         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01142         <span class="keywordflow">return</span>( STATUS_SUCCESS );
01143 
01144     <span class="keywordflow">default</span>:
01145 
01146         <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
01147     }
01148 }
01149 
01150 
01151 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01152"></a><a class="code" href="../../d9/d3/tokenqry_8c.html#a1">01152</a> <a class="code" href="../../d9/d3/tokenqry_8c.html#a1">SeQueryAuthenticationIdToken</a>(
01153     IN PACCESS_TOKEN Token,
01154     OUT PLUID AuthenticationId
01155     )
01156 
01157 <span class="comment">/*++</span>
01158 <span class="comment"></span>
01159 <span class="comment"></span>
01160 <span class="comment">Routine Description:</span>
01161 <span class="comment"></span>
01162 <span class="comment">    Retrieve authentication ID out of the token.</span>
01163 <span class="comment"></span>
01164 <span class="comment">Arguments:</span>
01165 <span class="comment"></span>
01166 <span class="comment">    Token - Referenced pointer to a token.</span>
01167 <span class="comment"></span>
01168 <span class="comment">    AutenticationId - Receives the token's authentication ID.</span>
01169 <span class="comment"></span>
01170 <span class="comment">Return Value:</span>
01171 <span class="comment"></span>
01172 <span class="comment">    STATUS_SUCCESS - Indicates the operation was successful.</span>
01173 <span class="comment"></span>
01174 <span class="comment">    This is the only expected status.</span>
01175 <span class="comment"></span>
01176 <span class="comment">--*/</span>
01177 {
01178     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01179 
01180     <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( ((<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>) );
01181     (*AuthenticationId) = ((<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)-&gt;AuthenticationId;
01182     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( ((<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>) );
01183     <span class="keywordflow">return</span>(STATUS_SUCCESS);
01184 }
01185 
01186 
01187 
01188 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01189"></a><a class="code" href="../../d9/d3/tokenqry_8c.html#a2">01189</a> <a class="code" href="../../d9/d3/tokenqry_8c.html#a2">SeQueryInformationToken</a> (
01190     IN PACCESS_TOKEN AccessToken,
01191     IN TOKEN_INFORMATION_CLASS TokenInformationClass,
01192     OUT PVOID *TokenInformation
01193     )
01194 
01195 <span class="comment">/*++</span>
01196 <span class="comment"></span>
01197 <span class="comment"></span>
01198 <span class="comment">Routine Description:</span>
01199 <span class="comment"></span>
01200 <span class="comment">    Retrieve information about a specified token.</span>
01201 <span class="comment"></span>
01202 <span class="comment">Arguments:</span>
01203 <span class="comment"></span>
01204 <span class="comment">    TokenHandle - Provides a handle to the token to operate on.</span>
01205 <span class="comment"></span>
01206 <span class="comment">    TokenInformationClass - The token information class about which</span>
01207 <span class="comment">        to retrieve information.</span>
01208 <span class="comment"></span>
01209 <span class="comment">    TokenInformation - Receives a pointer to the requested information.</span>
01210 <span class="comment">        The actual structures returned are dependent upon the information</span>
01211 <span class="comment">        class requested, as defined in the TokenInformationClass parameter</span>
01212 <span class="comment">        description.</span>
01213 <span class="comment"></span>
01214 <span class="comment">        TokenInformation Format By Information Class:</span>
01215 <span class="comment"></span>
01216 <span class="comment">           TokenUser =&gt; TOKEN_USER data structure.  TOKEN_QUERY</span>
01217 <span class="comment">           access is needed to retrieve this information about a</span>
01218 <span class="comment">           token.</span>
01219 <span class="comment"></span>
01220 <span class="comment">           TokenGroups =&gt; TOKEN_GROUPS data structure.  TOKEN_QUERY</span>
01221 <span class="comment">           access is needed to retrieve this information about a</span>
01222 <span class="comment">           token.</span>
01223 <span class="comment"></span>
01224 <span class="comment">           TokenPrivileges =&gt; TOKEN_PRIVILEGES data structure.</span>
01225 <span class="comment">           TOKEN_QUERY access is needed to retrieve this information</span>
01226 <span class="comment">           about a token.</span>
01227 <span class="comment"></span>
01228 <span class="comment">           TokenOwner =&gt; TOKEN_OWNER data structure.  TOKEN_QUERY</span>
01229 <span class="comment">           access is needed to retrieve this information about a</span>
01230 <span class="comment">           token.</span>
01231 <span class="comment"></span>
01232 <span class="comment">           TokenPrimaryGroup =&gt; TOKEN_PRIMARY_GROUP data structure.</span>
01233 <span class="comment">           TOKEN_QUERY access is needed to retrieve this information</span>
01234 <span class="comment">           about a token.</span>
01235 <span class="comment"></span>
01236 <span class="comment">           TokenDefaultDacl =&gt; TOKEN_DEFAULT_DACL data structure.</span>
01237 <span class="comment">           TOKEN_QUERY access is needed to retrieve this information</span>
01238 <span class="comment">           about a token.</span>
01239 <span class="comment"></span>
01240 <span class="comment">           TokenSource =&gt; TOKEN_SOURCE data structure.</span>
01241 <span class="comment">           TOKEN_QUERY_SOURCE access is needed to retrieve this</span>
01242 <span class="comment">           information about a token.</span>
01243 <span class="comment"></span>
01244 <span class="comment">           TokenType =&gt; TOKEN_TYPE data structure.</span>
01245 <span class="comment">           TOKEN_QUERY access is needed to retrieve this information</span>
01246 <span class="comment">           about a token.</span>
01247 <span class="comment"></span>
01248 <span class="comment">           TokenStatistics =&gt; TOKEN_STATISTICS data structure.</span>
01249 <span class="comment">           TOKEN_QUERY access is needed to retrieve this</span>
01250 <span class="comment">           information about a token.</span>
01251 <span class="comment"></span>
01252 <span class="comment">Return Value:</span>
01253 <span class="comment"></span>
01254 <span class="comment">    STATUS_SUCCESS - Indicates the operation was successful.</span>
01255 <span class="comment"></span>
01256 <span class="comment">--*/</span>
01257 {
01258 
01259     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01260 
01261     ULONG RequiredLength;
01262     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01263 
01264     PSID PSid;
01265     PACL PAcl;
01266 
01267     PVOID Ignore;
01268     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)AccessToken;
01269 
01270     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01271 
01272     <span class="comment">//</span>
01273     <span class="comment">// Case on information class.</span>
01274     <span class="comment">//</span>
01275 
01276     <span class="keywordflow">switch</span> ( TokenInformationClass ) {
01277 
01278         <span class="keywordflow">case</span> TokenUser:
01279             {
01280                 PTOKEN_USER LocalUser;
01281 
01282                 <span class="comment">//</span>
01283                 <span class="comment">//  Gain exclusive access to the token.</span>
01284                 <span class="comment">//</span>
01285 
01286                 <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01287 
01288                 <span class="comment">//</span>
01289                 <span class="comment">// Return the length required now in case not enough buffer</span>
01290                 <span class="comment">// was provided by the caller and we have to return an error.</span>
01291                 <span class="comment">//</span>
01292 
01293                 RequiredLength = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[0].Sid) +
01294                                  (ULONG)<span class="keyword">sizeof</span>( TOKEN_USER );
01295 
01296                 LocalUser = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, RequiredLength );
01297 
01298                 <span class="keywordflow">if</span> (LocalUser == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01299                     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01300                     <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
01301                 }
01302 
01303                 <span class="comment">//</span>
01304                 <span class="comment">// Return the user SID</span>
01305                 <span class="comment">//</span>
01306                 <span class="comment">//  Put SID immediately following TOKEN_USER data structure</span>
01307                 <span class="comment">//</span>
01308 
01309                 PSid = (PSID)( (ULONG_PTR)LocalUser + (ULONG)<span class="keyword">sizeof</span>(TOKEN_USER) );
01310 
01311                 <a class="code" href="../../d8/d6/sertl_8c.html#a47">RtlCopySidAndAttributesArray</a>(
01312                     1,
01313                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups,
01314                     RequiredLength,
01315                     &amp;(LocalUser-&gt;User),
01316                     PSid,
01317                     ((PSID *)&amp;Ignore),
01318                     ((PULONG)&amp;Ignore)
01319                     );
01320 
01321                 <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01322                 *TokenInformation = LocalUser;
01323                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01324             }
01325 
01326 
01327         <span class="keywordflow">case</span> TokenGroups:
01328             {
01329                 PTOKEN_GROUPS LocalGroups;
01330 
01331                 <span class="comment">//</span>
01332                 <span class="comment">//  Gain exclusive access to the token.</span>
01333                 <span class="comment">//</span>
01334 
01335                 <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01336 
01337                 <span class="comment">//</span>
01338                 <span class="comment">// Figure out how much space is needed to return the group SIDs.</span>
01339                 <span class="comment">// That's the size of TOKEN_GROUPS (without any array entries)</span>
01340                 <span class="comment">// plus the size of an SID_AND_ATTRIBUTES times the number of groups.</span>
01341                 <span class="comment">// The number of groups is Token-&gt;UserAndGroups-1 (since the count</span>
01342                 <span class="comment">// includes the user ID).  Then the lengths of each individual group</span>
01343                 <span class="comment">// must be added.</span>
01344                 <span class="comment">//</span>
01345 
01346                 RequiredLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_GROUPS) +
01347                                  ((<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount - <a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a> - 1) *
01348                                  ((ULONG)<span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES)) );
01349 
01350                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 1;
01351                 <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount) {
01352 
01353                     RequiredLength += <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Sid );
01354 
01355                     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
01356 
01357                 } <span class="comment">// endwhile</span>
01358 
01359                 LocalGroups = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, RequiredLength );
01360 
01361                 <span class="keywordflow">if</span> (LocalGroups == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01362                     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01363                     <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
01364                 }
01365 
01366                 <span class="comment">//</span>
01367                 <span class="comment">// Now copy the groups.</span>
01368                 <span class="comment">//</span>
01369 
01370                 LocalGroups-&gt;GroupCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount - 1;
01371 
01372                 PSid = (PSID)( (ULONG_PTR)LocalGroups +
01373                                (ULONG)<span class="keyword">sizeof</span>(TOKEN_GROUPS) +
01374                                (   (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount - <a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a> - 1) *
01375                                    (ULONG)<span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES) )
01376                              );
01377 
01378                 <a class="code" href="../../d8/d6/sertl_8c.html#a47">RtlCopySidAndAttributesArray</a>(
01379                     (ULONG)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount - 1),
01380                     &amp;(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[1]),
01381                     RequiredLength,
01382                     LocalGroups-&gt;Groups,
01383                     PSid,
01384                     ((PSID *)&amp;Ignore),
01385                     ((PULONG)&amp;Ignore)
01386                     );
01387 
01388                 <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01389                 *TokenInformation = LocalGroups;
01390                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01391             }
01392 
01393 
01394         <span class="keywordflow">case</span> TokenPrivileges:
01395             {
01396                 PTOKEN_PRIVILEGES LocalPrivileges;
01397 
01398                 <span class="comment">//</span>
01399                 <span class="comment">//  Gain exclusive access to the token to prevent changes</span>
01400                 <span class="comment">//  from occuring to the privileges.</span>
01401                 <span class="comment">//</span>
01402 
01403                 <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01404 
01405                 <span class="comment">//</span>
01406                 <span class="comment">// Return the length required now in case not enough buffer</span>
01407                 <span class="comment">// was provided by the caller and we have to return an error.</span>
01408                 <span class="comment">//</span>
01409 
01410                 RequiredLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_PRIVILEGES) +
01411                                  ((<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrivilegeCount - <a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a>) *
01412                                  ((ULONG)<span class="keyword">sizeof</span>(LUID_AND_ATTRIBUTES)) );
01413 
01414                 LocalPrivileges = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, RequiredLength );
01415 
01416                 <span class="keywordflow">if</span> (LocalPrivileges == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01417                     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01418                     <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
01419                 }
01420 
01421                 <span class="comment">//</span>
01422                 <span class="comment">// Return the token privileges.</span>
01423                 <span class="comment">//</span>
01424 
01425                 LocalPrivileges-&gt;PrivilegeCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrivilegeCount;
01426 
01427                 <a class="code" href="../../d8/d6/sertl_8c.html#a52">RtlCopyLuidAndAttributesArray</a>(
01428                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrivilegeCount,
01429                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Privileges,
01430                     LocalPrivileges-&gt;Privileges
01431                     );
01432 
01433                 <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01434                 *TokenInformation = LocalPrivileges;
01435                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01436             }
01437 
01438 
01439         <span class="keywordflow">case</span> TokenOwner:
01440             {
01441                 PTOKEN_OWNER LocalOwner;
01442 
01443                 <span class="comment">//</span>
01444                 <span class="comment">//  Gain exclusive access to the token to prevent changes</span>
01445                 <span class="comment">//  from occuring to the owner.</span>
01446                 <span class="comment">//</span>
01447 
01448                 <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01449 
01450                 <span class="comment">//</span>
01451                 <span class="comment">// Return the length required now in case not enough buffer</span>
01452                 <span class="comment">// was provided by the caller and we have to return an error.</span>
01453                 <span class="comment">//</span>
01454 
01455                 PSid = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultOwnerIndex].Sid;
01456                 RequiredLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_OWNER) +
01457                                  <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( PSid );
01458 
01459                 LocalOwner = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, RequiredLength );
01460 
01461                 <span class="keywordflow">if</span> (LocalOwner == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01462                     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01463                     <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
01464                 }
01465 
01466                 <span class="comment">//</span>
01467                 <span class="comment">// Return the owner SID</span>
01468                 <span class="comment">//</span>
01469 
01470                 PSid = (PSID)((ULONG_PTR)LocalOwner +
01471                               (ULONG)<span class="keyword">sizeof</span>(TOKEN_OWNER));
01472 
01473                 LocalOwner-&gt;Owner = PSid;
01474 
01475                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(
01476                              (RequiredLength - (ULONG)<span class="keyword">sizeof</span>(TOKEN_OWNER)),
01477                              PSid,
01478                              <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultOwnerIndex].Sid
01479                              );
01480 
01481                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
01482 
01483                 <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01484                 *TokenInformation = LocalOwner;
01485                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01486             }
01487 
01488 
01489         <span class="keywordflow">case</span> TokenPrimaryGroup:
01490             {
01491                 PTOKEN_PRIMARY_GROUP LocalPrimaryGroup;
01492 
01493                 <span class="comment">//</span>
01494                 <span class="comment">//  Gain exclusive access to the token to prevent changes</span>
01495                 <span class="comment">//  from occuring to the owner.</span>
01496                 <span class="comment">//</span>
01497 
01498                 <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01499 
01500                 <span class="comment">//</span>
01501                 <span class="comment">// Return the length required now in case not enough buffer</span>
01502                 <span class="comment">// was provided by the caller and we have to return an error.</span>
01503                 <span class="comment">//</span>
01504 
01505                 RequiredLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_PRIMARY_GROUP) +
01506                                  <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup );
01507 
01508                 LocalPrimaryGroup = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, RequiredLength );
01509 
01510                 <span class="keywordflow">if</span> (LocalPrimaryGroup == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01511                     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01512                     <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
01513                 }
01514 
01515                 <span class="comment">//</span>
01516                 <span class="comment">// Return the primary group SID</span>
01517                 <span class="comment">//</span>
01518 
01519                 PSid = (PSID)((ULONG_PTR)LocalPrimaryGroup +
01520                               (ULONG)<span class="keyword">sizeof</span>(TOKEN_PRIMARY_GROUP));
01521 
01522                 LocalPrimaryGroup-&gt;PrimaryGroup = PSid;
01523 
01524                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( (RequiredLength - (ULONG)<span class="keyword">sizeof</span>(TOKEN_PRIMARY_GROUP)),
01525                                      PSid,
01526                                      <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup
01527                                      );
01528 
01529                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
01530 
01531                 <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01532                 *TokenInformation = LocalPrimaryGroup;
01533                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01534             }
01535 
01536 
01537         <span class="keywordflow">case</span> TokenDefaultDacl:
01538             {
01539                 PTOKEN_DEFAULT_DACL LocalDefaultDacl;
01540 
01541                 <span class="comment">//</span>
01542                 <span class="comment">//  Gain exclusive access to the token to prevent changes</span>
01543                 <span class="comment">//  from occuring to the owner.</span>
01544                 <span class="comment">//</span>
01545 
01546                 <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01547 
01548                 <span class="comment">//</span>
01549                 <span class="comment">// Return the length required now in case not enough buffer</span>
01550                 <span class="comment">// was provided by the caller and we have to return an error.</span>
01551                 <span class="comment">//</span>
01552 
01553                 RequiredLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_DEFAULT_DACL);
01554 
01555                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl)) {
01556 
01557                     RequiredLength += <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl-&gt;AclSize;
01558                 }
01559 
01560                 LocalDefaultDacl = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, RequiredLength );
01561 
01562                 <span class="keywordflow">if</span> (LocalDefaultDacl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01563                     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01564                     <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
01565                 }
01566 
01567                 <span class="comment">//</span>
01568                 <span class="comment">// Return the default Dacl</span>
01569                 <span class="comment">//</span>
01570 
01571                 PAcl = (PACL)((ULONG_PTR)LocalDefaultDacl +
01572                               (ULONG)<span class="keyword">sizeof</span>(TOKEN_DEFAULT_DACL));
01573 
01574                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl)) {
01575 
01576                     LocalDefaultDacl-&gt;DefaultDacl = PAcl;
01577 
01578                     RtlCopyMemory( (PVOID)PAcl,
01579                                    (PVOID)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl,
01580                                    <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl-&gt;AclSize
01581                                    );
01582                 } <span class="keywordflow">else</span> {
01583 
01584                     LocalDefaultDacl-&gt;DefaultDacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01585                 }
01586 
01587                 <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01588                 *TokenInformation = LocalDefaultDacl;
01589                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01590             }
01591 
01592 
01593         <span class="keywordflow">case</span> TokenSource:
01594             {
01595                 PTOKEN_SOURCE LocalSource;
01596 
01597                 <span class="comment">//</span>
01598                 <span class="comment">// The type of a token can not be changed, so</span>
01599                 <span class="comment">// exclusive access to the token is not necessary.</span>
01600                 <span class="comment">//</span>
01601 
01602                 <span class="comment">//</span>
01603                 <span class="comment">// Return the length required now in case not enough buffer</span>
01604                 <span class="comment">// was provided by the caller and we have to return an error.</span>
01605                 <span class="comment">//</span>
01606 
01607                 RequiredLength = (ULONG) <span class="keyword">sizeof</span>(TOKEN_SOURCE);
01608 
01609                 LocalSource = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, RequiredLength );
01610 
01611                 <span class="keywordflow">if</span> (LocalSource == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01612                     <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
01613                 }
01614 
01615                 <span class="comment">//</span>
01616                 <span class="comment">// Return the token source</span>
01617                 <span class="comment">//</span>
01618 
01619                 (*LocalSource) = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenSource;
01620                 *TokenInformation = LocalSource;
01621 
01622                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01623             }
01624 
01625 
01626         <span class="keywordflow">case</span> TokenType:
01627             {
01628                 PTOKEN_TYPE LocalType;
01629 
01630                 <span class="comment">//</span>
01631                 <span class="comment">// The type of a token can not be changed, so</span>
01632                 <span class="comment">// exclusive access to the token is not necessary.</span>
01633                 <span class="comment">//</span>
01634 
01635                 <span class="comment">//</span>
01636                 <span class="comment">// Return the length required now in case not enough buffer</span>
01637                 <span class="comment">// was provided by the caller and we have to return an error.</span>
01638                 <span class="comment">//</span>
01639 
01640                 RequiredLength = (ULONG) <span class="keyword">sizeof</span>(TOKEN_TYPE);
01641 
01642                 LocalType = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, RequiredLength );
01643 
01644                 <span class="keywordflow">if</span> (LocalType == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01645                     <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
01646                 }
01647 
01648                 <span class="comment">//</span>
01649                 <span class="comment">// Return the token type</span>
01650                 <span class="comment">//</span>
01651 
01652                 (*LocalType) = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenType;
01653                 *TokenInformation = LocalType;
01654                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01655             }
01656 
01657 
01658         <span class="keywordflow">case</span> TokenImpersonationLevel:
01659             {
01660                 PSECURITY_IMPERSONATION_LEVEL LocalImpersonationLevel;
01661 
01662                 <span class="comment">//</span>
01663                 <span class="comment">// The impersonation level of a token can not be changed, so</span>
01664                 <span class="comment">// exclusive access to the token is not necessary.</span>
01665                 <span class="comment">//</span>
01666 
01667                 <span class="comment">//</span>
01668                 <span class="comment">//  Make sure the token is an appropriate type to be retrieving</span>
01669                 <span class="comment">//  the impersonation level from.</span>
01670                 <span class="comment">//</span>
01671 
01672                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenType != TokenImpersonation) {
01673 
01674                     <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
01675                 }
01676 
01677                 <span class="comment">//</span>
01678                 <span class="comment">// Return the length required now in case not enough buffer</span>
01679                 <span class="comment">// was provided by the caller and we have to return an error.</span>
01680                 <span class="comment">//</span>
01681 
01682                 RequiredLength = (ULONG) <span class="keyword">sizeof</span>(SECURITY_IMPERSONATION_LEVEL);
01683 
01684                 LocalImpersonationLevel = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, RequiredLength );
01685 
01686                 <span class="keywordflow">if</span> (LocalImpersonationLevel == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01687                     <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
01688                 }
01689 
01690                 <span class="comment">//</span>
01691                 <span class="comment">// Return the impersonation level</span>
01692                 <span class="comment">//</span>
01693 
01694                 (*LocalImpersonationLevel) = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ImpersonationLevel;
01695                 *TokenInformation = LocalImpersonationLevel;
01696                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01697             }
01698 
01699 
01700         <span class="keywordflow">case</span> TokenStatistics:
01701             {
01702                 PTOKEN_STATISTICS LocalStatistics;
01703 
01704                 <span class="comment">//</span>
01705                 <span class="comment">//  Gain exclusive access to the token.</span>
01706                 <span class="comment">//</span>
01707 
01708                 <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01709 
01710                 <span class="comment">//</span>
01711                 <span class="comment">// Return the length required now in case not enough buffer</span>
01712                 <span class="comment">// was provided by the caller and we have to return an error.</span>
01713                 <span class="comment">//</span>
01714 
01715                 RequiredLength = (ULONG)<span class="keyword">sizeof</span>( TOKEN_STATISTICS );
01716 
01717                 LocalStatistics = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, RequiredLength );
01718 
01719                 <span class="keywordflow">if</span> (LocalStatistics == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01720                     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01721                     <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
01722                 }
01723 
01724                 <span class="comment">//</span>
01725                 <span class="comment">// Return the statistics</span>
01726                 <span class="comment">//</span>
01727 
01728                 LocalStatistics-&gt;TokenId            = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenId;
01729                 LocalStatistics-&gt;AuthenticationId   = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;AuthenticationId;
01730                 LocalStatistics-&gt;ExpirationTime     = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ExpirationTime;
01731                 LocalStatistics-&gt;TokenType          = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenType;
01732                 LocalStatistics-&gt;ImpersonationLevel = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ImpersonationLevel;
01733                 LocalStatistics-&gt;DynamicCharged     = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicCharged;
01734                 LocalStatistics-&gt;DynamicAvailable   = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicAvailable;
01735                 LocalStatistics-&gt;GroupCount         = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount-1;
01736                 LocalStatistics-&gt;PrivilegeCount     = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrivilegeCount;
01737                 LocalStatistics-&gt;ModifiedId         = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ModifiedId;
01738 
01739                 <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01740                 *TokenInformation = LocalStatistics;
01741                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01742             }
01743 
01744     <span class="keywordflow">case</span> TokenSessionId:
01745 
01746         <span class="comment">/*</span>
01747 <span class="comment">         * Get SessionId for the token</span>
01748 <span class="comment">         */</span>
01749         <a class="code" href="../../d9/d3/tokenqry_8c.html#a3">SeQuerySessionIdToken</a>( (PACCESS_TOKEN)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
01750                              (PULONG)TokenInformation );
01751 
01752         <span class="keywordflow">return</span>( STATUS_SUCCESS );
01753 
01754     <span class="keywordflow">default</span>:
01755 
01756         <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
01757     }
01758 }
01759 
01760 
01761 
01762 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01763"></a><a class="code" href="../../d9/d3/tokenqry_8c.html#a3">01763</a> <a class="code" href="../../d9/d3/tokenqry_8c.html#a3">SeQuerySessionIdToken</a>(
01764     PACCESS_TOKEN Token,
01765     PULONG SessionId
01766     )
01767 
01768 <span class="comment">/*++</span>
01769 <span class="comment"></span>
01770 <span class="comment"></span>
01771 <span class="comment">Routine Description:</span>
01772 <span class="comment"></span>
01773 <span class="comment">    Gets the SessionId from the specified token object.</span>
01774 <span class="comment"></span>
01775 <span class="comment">Arguments:</span>
01776 <span class="comment"></span>
01777 <span class="comment">    Token (input)</span>
01778 <span class="comment">      Opaque kernel ACCESS_TOKEN pointer</span>
01779 <span class="comment">    SessionId (output)</span>
01780 <span class="comment">      pointer to location to return SessionId</span>
01781 <span class="comment"></span>
01782 <span class="comment">Return Value:</span>
01783 <span class="comment"></span>
01784 <span class="comment">    STATUS_SUCCESS - no error</span>
01785 <span class="comment"></span>
01786 <span class="comment">--*/</span>
01787 {
01788 
01789     <span class="comment">/*</span>
01790 <span class="comment">     * Get the SessionId.</span>
01791 <span class="comment">     */</span>
01792     <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( ((<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>) );
01793     (*SessionId) = ((<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)-&gt;SessionId;
01794     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( ((<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>) );
01795     <span class="keywordflow">return</span>( STATUS_SUCCESS );
01796 }
01797 
01798 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:02 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
