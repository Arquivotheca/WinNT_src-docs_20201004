<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: qsquota.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>qsquota.c File Reference</h1><code>#include "<a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>"</code><br>

<p>
<a href="../../d1/d2/qsquota_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d3/qsquota_8c.html#a0">ALIGN_LONG</a>(Address)&nbsp;&nbsp;&nbsp;( (Address + 3) &amp; ~3 )</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d3/qsquota_8c.html#a1">NtQueryQuotaInformationFile</a> (IN HANDLE FileHandle, OUT PIO_STATUS_BLOCK IoStatusBlock, OUT PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN ULONG Length, IN BOOLEAN ReturnSingleEntry, IN PVOID SidList OPTIONAL, IN ULONG SidListLength, IN PULONG StartSid OPTIONAL, IN BOOLEAN RestartScan)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d3/qsquota_8c.html#a2">NtSetQuotaInformationFile</a> (IN HANDLE FileHandle, OUT PIO_STATUS_BLOCK IoStatusBlock, IN PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN ULONG Length)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="qsquota.c::ALIGN_LONG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ALIGN_LONG          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Address&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;( (Address + 3) &amp; ~3 )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a1" doxytag="qsquota.c::NtQueryQuotaInformationFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtQueryQuotaInformationFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnSingleEntry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID SidList&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SidListLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG StartSid&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>RestartScan</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d2/qsquota_8c-source.html#l00035">35</a> of file <a class="el" href="../../d1/d2/qsquota_8c-source.html">qsquota.c</a>.
<p>
References <a class="el" href="../../d4/d6/iosubs_8c.html#a0">ALIGN_LONG</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01154">DO_BUFFERED_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01156">DO_DIRECT_IO</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00127">ExAllocatePoolWithQuota</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02030">_IO_STACK_LOCATION::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01184">_DEVICE_OBJECT::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01492">FO_ALERTABLE_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01491">FO_SYNCHRONOUS_IO</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00652">IoAllocateIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00805">IoAllocateMdl()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00044">IoFileObjectType</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00595">IopAcquireFastLock</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00181">IopAcquireFileObjectLock()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00284">IopAllocateIrpCleanup()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00524">IopCheckGetQuotaBufferValidity()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01934">IopExceptionCleanup()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06926">IopSynchronousApiServiceTail()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l07030">IopSynchronousServiceTail()</a>, <a class="el" href="../../d2/d1/mm_8h.html#a344a169">IoWriteAccess</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01554">IRP_BUFFERED_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01555">IRP_DEALLOCATE_BUFFER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01556">IRP_INPUT_OPERATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00080">IRP_MJ_QUERY_QUOTA</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01552">IRP_SYNCHRONOUS_API</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00238">MmProbeAndLockPages()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a240a140">OtherTransfer</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o24">_IRP::Overlay</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01261">ProbeAndReadUchar</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01498">ProbeForWriteIoStatus</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01641">_IRP::RequestorMode</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01030">RtlLengthRequiredSid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00810">RtlValidSid()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01898">SL_INDEX_SPECIFIED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01896">SL_RESTART_SCAN</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01897">SL_RETURN_SINGLE_ENTRY</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01711">_IRP::UserBuffer</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>.
<p>
<pre class="fragment"><div>00049                    :
00050 
00051     This service returns quota entries associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume specified
00052     by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FileHandle parameter.  The amount of information returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> based
00053     on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota information associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size
00054     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer, and whether or not a specific set of entries has been
00055     requested.
00056 
00057 Arguments:
00058 
00059     FileHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>/volume <span class="keywordflow">for</span> which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota
00060         information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00061 
00062     IoStatusBlock - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's I/O status block.
00063 
00064     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Supplies a buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota information <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume.
00065 
00066     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
00067 
00068     ReturnSingleEntry - Indicates that <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> a single entry should be returned
00069         rather than filling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer with as many entries as possible.
00070 
00071     SidList - Optionally supplies a list of SIDs whose quota information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to
00072         be returned.
00073 
00074     SidListLength - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID list, <span class="keywordflow">if</span> one was specified.
00075 
00076     StartSid - Supplies an optional SID that indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned
00077         information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to start with an entry other than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first.  This
00078         parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored <span class="keywordflow">if</span> a SidList <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified.
00079 
00080     RestartScan - Indicates whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> scan of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be
00081         restarted from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> beginning.
00082 
00083 Return Value:
00084 
00085     The status returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> completion status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
00086 
00087 --*/
00088 
00089 {
00090 
00091 <span class="preprocessor">#define ALIGN_LONG( Address ) ( (Address + 3) &amp; ~3 )</span>
00092 <span class="preprocessor"></span>
00093     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00094     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00095     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
00096     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00097     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> event = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00098     PCHAR auxiliaryBuffer = (PCHAR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00099     ULONG startSidLength = 0;
00100     PSID startSid = (PSID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00101     PFILE_GET_QUOTA_INFORMATION sidList = (PFILE_GET_QUOTA_INFORMATION) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00102     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> requestorMode;
00103     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00104     IO_STATUS_BLOCK localIoStatus;
00105     BOOLEAN synchronousIo;
00106     UCHAR subCount;
00107 
00108     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00109 
00110     <span class="comment">//</span>
00111     <span class="comment">// Get the previous mode;  i.e., the mode of the caller.</span>
00112     <span class="comment">//</span>
00113 
00114     requestorMode = KeGetPreviousMode();
00115 
00116     <span class="keywordflow">if</span> (requestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00117 
00118         <span class="comment">//</span>
00119         <span class="comment">// The caller's access mode is not kernel so probe each of the arguments</span>
00120         <span class="comment">// and capture them as necessary.  If any failures occur, the condition</span>
00121         <span class="comment">// handler will be invoked to handle them.  It will simply cleanup and</span>
00122         <span class="comment">// return an access violation status code back to the system service</span>
00123         <span class="comment">// dispatcher.</span>
00124         <span class="comment">//</span>
00125 
00126         <span class="keywordflow">try</span> {
00127 
00128             <span class="comment">//</span>
00129             <span class="comment">// The IoStatusBlock parameter must be writeable by the caller.</span>
00130             <span class="comment">//</span>
00131 
00132             <a class="code" href="../../d5/d8/ex_8h.html#a31">ProbeForWriteIoStatus</a>( IoStatusBlock );
00133 
00134             <span class="comment">//</span>
00135             <span class="comment">// The buffer must be writeable by the caller.</span>
00136             <span class="comment">//</span>
00137 
00138 <span class="preprocessor">#if defined(_X86_)</span>
00139 <span class="preprocessor"></span>            <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( Buffer, Length, <span class="keyword">sizeof</span>( ULONG ) );
00140 <span class="preprocessor">#elif defined(_WIN64)</span>
00141 <span class="preprocessor"></span>
00142             <span class="comment">//</span>
00143             <span class="comment">// If we are a wow64 process, follow the X86 rules</span>
00144             <span class="comment">//</span>
00145 
00146             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Wow64Process) {
00147                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( Buffer, Length, <span class="keyword">sizeof</span>( ULONG ) );
00148             } <span class="keywordflow">else</span> {
00149                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( Buffer, Length, <span class="keyword">sizeof</span>( ULONGLONG ) );
00150             }
00151 <span class="preprocessor">#else</span>
00152 <span class="preprocessor"></span>            <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( Buffer, Length, <span class="keyword">sizeof</span>( ULONGLONG ) );
00153 <span class="preprocessor">#endif</span>
00154 <span class="preprocessor"></span>
00155             <span class="comment">//</span>
00156             <span class="comment">// If the optional StartSid parameter was specified, then it must</span>
00157             <span class="comment">// be readable by the caller.  Begin by capturing the length of</span>
00158             <span class="comment">// the SID so that the SID itself can be captured.</span>
00159             <span class="comment">//</span>
00160 
00161             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( StartSid )) {
00162 
00163                 subCount = <a class="code" href="../../d5/d8/ex_8h.html#a14">ProbeAndReadUchar</a>( &amp;(((SID *)(StartSid))-&gt;SubAuthorityCount) );
00164                 startSidLength = <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( subCount );
00165                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( StartSid, startSidLength, <span class="keyword">sizeof</span>( ULONG ) );
00166             }
00167 
00168             <span class="comment">//</span>
00169             <span class="comment">// If the optional SidList parameter was specified, then it must</span>
00170             <span class="comment">// be readable by the caller.  Validate that the buffer contains</span>
00171             <span class="comment">// a legal get information structure.</span>
00172             <span class="comment">//</span>
00173 
00174             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( SidList ) &amp;&amp; SidListLength) {
00175 
00176                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( SidList, SidListLength, <span class="keyword">sizeof</span>( ULONG ) );
00177                 auxiliaryBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a11">ExAllocatePoolWithQuota</a>( NonPagedPool,
00178                                                            <a class="code" href="../../d4/d6/iosubs_8c.html#a0">ALIGN_LONG</a>( SidListLength ) +
00179                                                            startSidLength );
00180                 sidList = (PFILE_GET_QUOTA_INFORMATION) auxiliaryBuffer;
00181 
00182                 RtlCopyMemory( auxiliaryBuffer, SidList, SidListLength );
00183 
00184             } <span class="keywordflow">else</span> {
00185 
00186                 <span class="comment">//</span>
00187                 <span class="comment">// No SidList was specified.  Check to see whether or not a</span>
00188                 <span class="comment">// StartSid was specified and, if so, capture it.  Note that</span>
00189                 <span class="comment">// the SID has already been probed.</span>
00190                 <span class="comment">//</span>
00191 
00192                 SidListLength = 0;
00193                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT( StartSid )) {
00194                     auxiliaryBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a11">ExAllocatePoolWithQuota</a>( PagedPool,
00195                                                                startSidLength );
00196                 }
00197             }
00198 
00199             <span class="comment">//</span>
00200             <span class="comment">// If a StartSid was specified tack it onto the end of the auxiliary</span>
00201             <span class="comment">// buffer.</span>
00202             <span class="comment">//</span>
00203 
00204             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( StartSid )) {
00205                 startSid = (PSID) (auxiliaryBuffer + <a class="code" href="../../d4/d6/iosubs_8c.html#a0">ALIGN_LONG</a>( SidListLength ));
00206 
00207                 RtlCopyMemory( startSid, StartSid, startSidLength );
00208                 ((SID *) startSid)-&gt;SubAuthorityCount = subCount;
00209             }
00210 
00211 
00212         } except(EXCEPTION_EXECUTE_HANDLER) {
00213 
00214             <span class="comment">//</span>
00215             <span class="comment">// An exception was incurred while probing the caller's</span>
00216             <span class="comment">// parameters, allocating the pool buffer, or copying the</span>
00217             <span class="comment">// caller's EA list to the buffer.  Cleanup and return an</span>
00218             <span class="comment">// appropriate error status code.</span>
00219             <span class="comment">//</span>
00220 
00221             <span class="keywordflow">if</span> (auxiliaryBuffer) {
00222                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( auxiliaryBuffer );
00223             }
00224 
00225             <span class="keywordflow">return</span> GetExceptionCode();
00226 
00227         }
00228 
00229     } <span class="keywordflow">else</span> {
00230 
00231         <span class="comment">//</span>
00232         <span class="comment">// The caller's mode was KernelMode.  Simply allocate pool for the</span>
00233         <span class="comment">// SidList, if one was specified, and copy the string to it.  Also,</span>
00234         <span class="comment">// if a StartSid was specified copy it as well.</span>
00235         <span class="comment">//</span>
00236 
00237         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( SidList ) &amp;&amp; SidListLength) {
00238             sidList = SidList;
00239         }
00240 
00241         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( StartSid )) {
00242             startSid = StartSid;
00243         }
00244     }
00245 
00246     <span class="comment">//</span>
00247     <span class="comment">// Always check the validity of the buffer since the server uses this </span>
00248     <span class="comment">// routine.</span>
00249     <span class="comment">//</span>
00250 
00251     <span class="keywordflow">if</span> (sidList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00252         status = <a class="code" href="../../d0/d6/iop_8h.html#a153">IopCheckGetQuotaBufferValidity</a>( sidList,
00253                                                  SidListLength,
00254                                                  &amp;IoStatusBlock-&gt;Information );
00255         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00256             <span class="keywordflow">if</span> (auxiliaryBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00257                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( auxiliaryBuffer );
00258             }
00259             <span class="keywordflow">return</span> status;
00260 
00261         }
00262     }
00263 
00264     <span class="keywordflow">if</span> (startSid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00265 
00266         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( startSid )) {
00267             <span class="keywordflow">if</span> (auxiliaryBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00268                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( auxiliaryBuffer );
00269             }
00270             <span class="keywordflow">return</span> STATUS_INVALID_SID;
00271         }
00272     }
00273 
00274     <span class="comment">//</span>
00275     <span class="comment">// There were no blatant errors so far, so reference the file object so</span>
00276     <span class="comment">// the target device object can be found.  Note that if the handle does</span>
00277     <span class="comment">// not refer to a file object, or if the caller does not have the required</span>
00278     <span class="comment">// access to the file, then it will fail.</span>
00279     <span class="comment">//</span>
00280 
00281     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( FileHandle,
00282                                         0,
00283                                         IoFileObjectType,
00284                                         requestorMode,
00285                                         (PVOID *) &amp;fileObject,
00286                                         NULL );
00287     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00288         <span class="keywordflow">if</span> (auxiliaryBuffer) {
00289             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( auxiliaryBuffer );
00290         }
00291         <span class="keywordflow">return</span> status;
00292     }
00293 
00294     <span class="comment">//</span>
00295     <span class="comment">// Make a special check here to determine whether this is a synchronous</span>
00296     <span class="comment">// I/O operation.  If it is, then wait here until the file is owned by</span>
00297     <span class="comment">// the current thread.  If this is not a (serialized) synchronous I/O</span>
00298     <span class="comment">// operation, then allocate and initialize the local event.</span>
00299     <span class="comment">//</span>
00300 
00301     <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
00302 
00303         BOOLEAN interrupted;
00304 
00305         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a13">IopAcquireFastLock</a>( fileObject )) {
00306             status = <a class="code" href="../../d0/d6/iop_8h.html#a147">IopAcquireFileObjectLock</a>( fileObject,
00307                                                requestorMode,
00308                                                (BOOLEAN) ((fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; FO_ALERTABLE_IO) != 0),
00309                                                &amp;interrupted );
00310             <span class="keywordflow">if</span> (interrupted) {
00311                 <span class="keywordflow">if</span> (auxiliaryBuffer) {
00312                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( auxiliaryBuffer );
00313                 }
00314                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
00315                 <span class="keywordflow">return</span> status;
00316             }
00317         }
00318         synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00319     } <span class="keywordflow">else</span> {
00320 
00321         <span class="comment">//</span>
00322         <span class="comment">// This is a synchronous API being invoked for a file that is opened</span>
00323         <span class="comment">// for asynchronous I/O.  This means that this system service is</span>
00324         <span class="comment">// to synchronize the completion of the operation before returning</span>
00325         <span class="comment">// to the caller.  A local event is used to do this.</span>
00326         <span class="comment">//</span>
00327 
00328         event = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool, <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> ) );
00329         <span class="keywordflow">if</span> (!event) {
00330             <span class="keywordflow">if</span> (auxiliaryBuffer) {
00331                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( auxiliaryBuffer );
00332             }
00333             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
00334             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00335         }
00336         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( event, SynchronizationEvent, FALSE );
00337         synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00338     }
00339 
00340     <span class="comment">//</span>
00341     <span class="comment">// Set the file object to the Not-Signaled state.</span>
00342     <span class="comment">//</span>
00343 
00344     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a> );
00345 
00346     <span class="comment">//</span>
00347     <span class="comment">// Get the address of the target device object.</span>
00348     <span class="comment">//</span>
00349 
00350     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( fileObject );
00351 
00352     <span class="comment">//</span>
00353     <span class="comment">// Allocate and initialize the I/O Request Packet (IRP) for this operation.</span>
00354     <span class="comment">// The allocation is performed with an exception handler in case the</span>
00355     <span class="comment">// caller does not have enough quota to allocate the packet.</span>
00356 
00357     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>( deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>, TRUE );
00358     <span class="keywordflow">if</span> (!irp) {
00359 
00360         <span class="comment">//</span>
00361         <span class="comment">// An IRP could not be allocated.  Cleanup and return an appropriate</span>
00362         <span class="comment">// error status code.</span>
00363         <span class="comment">//</span>
00364 
00365         <span class="keywordflow">if</span> (!(fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>)) {
00366             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( event );
00367         }
00368 
00369         <a class="code" href="../../d0/d6/iop_8h.html#a148">IopAllocateIrpCleanup</a>( fileObject, (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL );
00370 
00371         <span class="keywordflow">if</span> (auxiliaryBuffer) {
00372             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( auxiliaryBuffer );
00373         }
00374 
00375         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00376     }
00377     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = fileObject;
00378     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00379     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = requestorMode;
00380 
00381     <span class="comment">//</span>
00382     <span class="comment">// Fill in the service independent parameters in the IRP.</span>
00383     <span class="comment">//</span>
00384 
00385     <span class="keywordflow">if</span> (synchronousIo) {
00386         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00387         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = IoStatusBlock;
00388     } <span class="keywordflow">else</span> {
00389         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = event;
00390         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;localIoStatus;
00391         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>;
00392     }
00393     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine = (PIO_APC_ROUTINE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00394 
00395     <span class="comment">//</span>
00396     <span class="comment">// Get a pointer to the stack location for the first driver.  This will be</span>
00397     <span class="comment">// used to pass the original function codes and parameters.</span>
00398     <span class="comment">//</span>
00399 
00400     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
00401     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a38">IRP_MJ_QUERY_QUOTA</a>;
00402     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = fileObject;
00403 
00404     <span class="comment">//</span>
00405     <span class="comment">// If the caller specified an SID list of names to be queried, then pass</span>
00406     <span class="comment">// the address of the intermediary buffer containing the list to the</span>
00407     <span class="comment">// driver.</span>
00408     <span class="comment">//</span>
00409 
00410     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.AuxiliaryBuffer = auxiliaryBuffer;
00411     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryQuota.SidList = sidList;
00412     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryQuota.SidListLength = SidListLength;
00413 
00414     <span class="comment">//</span>
00415     <span class="comment">// Now determine whether this driver expects to have data buffered</span>
00416     <span class="comment">// to it or whether it performs direct I/O.  This is based on the</span>
00417     <span class="comment">// DO_BUFFERED_IO flag in the device object.  If the flag is set,</span>
00418     <span class="comment">// then a system buffer is allocated and the driver's data will be</span>
00419     <span class="comment">// copied to it.  If the DO_DIRECT_IO flag is set in the device</span>
00420     <span class="comment">// object, then a Memory Descriptor List (MDL) is allocated and</span>
00421     <span class="comment">// the caller's buffer is locked down using it.  Finally, if the</span>
00422     <span class="comment">// driver specifies neither of the flags, then simply pass the</span>
00423     <span class="comment">// address and length of the buffer and allow the driver to perform</span>
00424     <span class="comment">// all of the checking and buffering if any is required.</span>
00425     <span class="comment">//</span>
00426 
00427     <span class="keywordflow">if</span> (deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a123">DO_BUFFERED_IO</a>) {
00428 
00429         <span class="comment">//</span>
00430         <span class="comment">// The driver wishes the caller's buffered be copied into an</span>
00431         <span class="comment">// intermediary buffer.  Allocate the system buffer and specify</span>
00432         <span class="comment">// that it should be deallocated on completion.  Also indicate</span>
00433         <span class="comment">// that this is an input operation so the data will be copied</span>
00434         <span class="comment">// into the caller's buffer.  This is done using an exception</span>
00435         <span class="comment">// handler that will perform cleanup if the operation fails.</span>
00436         <span class="comment">//</span>
00437 
00438         <span class="keywordflow">if</span> (Length) {
00439             <span class="keywordflow">try</span> {
00440 
00441                 <span class="comment">//</span>
00442                 <span class="comment">// Allocate the intermediary system buffer from nonpaged</span>
00443                 <span class="comment">// pool and charge quota for it.</span>
00444                 <span class="comment">//</span>
00445 
00446                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer =
00447                     <a class="code" href="../../d5/d5/cc_8h.html#a11">ExAllocatePoolWithQuota</a>( NonPagedPool, Length );
00448 
00449             } except(EXCEPTION_EXECUTE_HANDLER) {
00450 
00451                 <span class="comment">//</span>
00452                 <span class="comment">// An exception was incurred while either probing the</span>
00453                 <span class="comment">// caller's buffer or allocating the system buffer.</span>
00454                 <span class="comment">// Determine what actually happened, clean everything</span>
00455                 <span class="comment">// up, and return an appropriate error status code.</span>
00456                 <span class="comment">//</span>
00457 
00458                 <a class="code" href="../../d0/d6/iop_8h.html#a170">IopExceptionCleanup</a>( fileObject,
00459                                      irp,
00460                                      (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL,
00461                                      event );
00462 
00463                 <span class="keywordflow">if</span> (auxiliaryBuffer) {
00464                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( auxiliaryBuffer );
00465                 }
00466 
00467                 <span class="keywordflow">return</span> GetExceptionCode();
00468             }
00469 
00470             <span class="comment">//</span>
00471             <span class="comment">// Remember the address of the caller's buffer so the copy can</span>
00472             <span class="comment">// take place during I/O completion.  Also, set the flags so</span>
00473             <span class="comment">// that the completion code knows to do the copy and to deallocate</span>
00474             <span class="comment">// the buffer.</span>
00475             <span class="comment">//</span>
00476 
00477             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o26">UserBuffer</a> = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00478             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= (ULONG) (<a class="code" href="../../d0/d5/io_8h.html#a178">IRP_BUFFERED_IO</a> |
00479                                    <a class="code" href="../../d0/d5/io_8h.html#a179">IRP_DEALLOCATE_BUFFER</a> |
00480                                    <a class="code" href="../../d0/d5/io_8h.html#a180">IRP_INPUT_OPERATION</a>);
00481         } <span class="keywordflow">else</span> {
00482             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00483             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o26">UserBuffer</a> = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00484         }
00485 
00486     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a125">DO_DIRECT_IO</a>) {
00487 
00488         <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> mdl;
00489 
00490         <span class="comment">//</span>
00491         <span class="comment">// This is a direct I/O operation.  Allocate an MDL and invoke</span>
00492         <span class="comment">// the memory management routine to lock the buffer into memory.</span>
00493         <span class="comment">// This is done using an exception handler that will perform</span>
00494         <span class="comment">// cleanup if the operation fails.</span>
00495         <span class="comment">//</span>
00496 
00497         mdl = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00498 
00499         <span class="keywordflow">if</span> (Length) {
00500             <span class="keywordflow">try</span> {
00501 
00502                 <span class="comment">//</span>
00503                 <span class="comment">// Allocate an MDL, charging quota for it, and hang it off</span>
00504                 <span class="comment">// of the IRP.  Probe and lock the pages associated with</span>
00505                 <span class="comment">// the caller's buffer for write access and fill in the MDL</span>
00506                 <span class="comment">// with the PFNs of those pages.</span>
00507                 <span class="comment">//</span>
00508 
00509                 mdl = <a class="code" href="../../d4/d6/iosubs_8c.html#a19">IoAllocateMdl</a>( Buffer, Length, FALSE, TRUE, irp );
00510                 <span class="keywordflow">if</span> (!mdl) {
00511                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
00512                 }
00513                 <a class="code" href="../../d5/d6/iosup_8c.html#a41">MmProbeAndLockPages</a>( mdl, requestorMode, IoWriteAccess );
00514 
00515             } except(EXCEPTION_EXECUTE_HANDLER) {
00516 
00517                 <span class="comment">//</span>
00518                 <span class="comment">// An exception was incurred while either probing the</span>
00519                 <span class="comment">// caller's buffer or allocating the MDL.  Determine what</span>
00520                 <span class="comment">// actually happened, clean everything up, and return an</span>
00521                 <span class="comment">// appropriate error status code.</span>
00522                 <span class="comment">//</span>
00523 
00524                 <a class="code" href="../../d0/d6/iop_8h.html#a170">IopExceptionCleanup</a>( fileObject,
00525                                      irp,
00526                                      (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL,
00527                                      event );
00528 
00529                 <span class="keywordflow">if</span> (auxiliaryBuffer) {
00530                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( auxiliaryBuffer );
00531                 }
00532 
00533                 <span class="keywordflow">return</span> GetExceptionCode();
00534 
00535             }
00536         }
00537 
00538     } <span class="keywordflow">else</span> {
00539 
00540         <span class="comment">//</span>
00541         <span class="comment">// Pass the address of the user's buffer so the driver has access</span>
00542         <span class="comment">// to it.  It is now the driver's responsibility to do everything.</span>
00543         <span class="comment">//</span>
00544 
00545         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o26">UserBuffer</a> = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00546 
00547     }
00548 
00549     <span class="comment">//</span>
00550     <span class="comment">// Copy the caller's parameters to the service-specific portion of the</span>
00551     <span class="comment">// IRP.</span>
00552     <span class="comment">//</span>
00553 
00554     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryQuota.Length = Length;
00555     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryQuota.StartSid = StartSid;
00556     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a> = 0;
00557     <span class="keywordflow">if</span> (RestartScan) {
00558         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a208">SL_RESTART_SCAN</a>;
00559     }
00560     <span class="keywordflow">if</span> (ReturnSingleEntry) {
00561         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a209">SL_RETURN_SINGLE_ENTRY</a>;
00562     }
00563     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( StartSid )) {
00564         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a210">SL_INDEX_SPECIFIED</a>;
00565     }
00566 
00567     <span class="comment">//</span>
00568     <span class="comment">// Queue the packet, call the driver, and synchronize appropriately with</span>
00569     <span class="comment">// I/O completion.</span>
00570     <span class="comment">//</span>
00571 
00572     status = <a class="code" href="../../d0/d6/iop_8h.html#a212">IopSynchronousServiceTail</a>( deviceObject,
00573                                         irp,
00574                                         fileObject,
00575                                         FALSE,
00576                                         requestorMode,
00577                                         synchronousIo,
00578                                         OtherTransfer );
00579 
00580     <span class="comment">//</span>
00581     <span class="comment">// If the file for this operation was not opened for synchronous I/O, then</span>
00582     <span class="comment">// synchronization of completion of the I/O operation has not yet occurred</span>
00583     <span class="comment">// since the allocated event must be used for synchronous APIs on files</span>
00584     <span class="comment">// opened for asynchronous I/O.  Synchronize the completion of the I/O</span>
00585     <span class="comment">// operation now.</span>
00586     <span class="comment">//</span>
00587 
00588     <span class="keywordflow">if</span> (!synchronousIo) {
00589 
00590         status = <a class="code" href="../../d0/d6/iop_8h.html#a211">IopSynchronousApiServiceTail</a>( status,
00591                                                event,
00592                                                irp,
00593                                                requestorMode,
00594                                                &amp;localIoStatus,
00595                                                IoStatusBlock );
00596     }
00597 
00598     <span class="keywordflow">return</span> status;
00599 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="qsquota.c::NtSetQuotaInformationFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtSetQuotaInformationFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d2/qsquota_8c-source.html#l00602">602</a> of file <a class="el" href="../../d1/d2/qsquota_8c-source.html">qsquota.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06326">IopSetEaOrQuotaInformationFile()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
<pre class="fragment"><div>00611                    :
00612 
00613     This service changes quota entries <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00614     FileHandle parameter.  All of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota entries in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified buffer
00615     are applied to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume.
00616 
00617 Arguments:
00618 
00619     FileHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>/volume <span class="keywordflow">for</span> which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota
00620         entries are to be applied.
00621 
00622     IoStatusBlock - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's I/O status block.
00623 
00624     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Supplies a buffer containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> quota entries that should
00625         be applied to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume.
00626 
00627     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
00628 
00629 Return Value:
00630 
00631     The status returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> completion status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
00632 
00633 --*/
00634 
00635 {
00636     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00637 
00638     <span class="comment">//</span>
00639     <span class="comment">// Simply return the status from the internal common routine for setting</span>
00640     <span class="comment">// EAs on a file or quotas on a volume.</span>
00641     <span class="comment">//</span>
00642 
00643     <span class="keywordflow">return</span> <a class="code" href="../../d0/d6/iop_8h.html#a208">IopSetEaOrQuotaInformationFile</a>( FileHandle,
00644                                            IoStatusBlock,
00645                                            Buffer,
00646                                            Length,
00647                                            FALSE );
00648 }
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:24 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
