<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: winmgr.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>winmgr.c</h1><a href="../../d9/d7/kernel_2winmgr_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: winmgr.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Core Window Manager APIs and support routines.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 24-Sep-1990 darrinm   Generated stubs.</span>
00010 <span class="comment">* 22-Jan-1991 IanJa     Handle revalidation added</span>
00011 <span class="comment">* 19-Feb-1991 JimA      Added enum access checks</span>
00012 <span class="comment">\***************************************************************************/</span>
00013 
00014 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00015 <span class="preprocessor">#pragma hdrstop</span>
00016 <span class="preprocessor"></span>
00017 <span class="comment">/***************************************************************************\</span>
00018 <span class="comment">* xxxFlashWindow (API)</span>
00019 <span class="comment">*</span>
00020 <span class="comment">* New for 5.0: HIWORD(dwFlags) contains the number of times the window should be</span>
00021 <span class="comment">*              flashed. LOWORD(dwFlags) contains the FLASHW_ bits.</span>
00022 <span class="comment">*</span>
00023 <span class="comment">* History:</span>
00024 <span class="comment">* 27-Nov-1990 DarrinM   Ported.</span>
00025 <span class="comment">* 15-Nov-1997 MCostea   Added dwTimeout and windowing the maximised cmd</span>
00026 <span class="comment">\***************************************************************************/</span>
<a name="l00027"></a><a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a2">00027</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a2">xxxFlashWindow</a>(
00028     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00029     DWORD dwFlags,
00030     DWORD dwTimeout)
00031 {
00032 
00033     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fStatePrev = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00034     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fFlashOn;
00035     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwState;
00036 
00037     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00038     <span class="comment">/*</span>
00039 <span class="comment">     * Get the previous state. If not available (FLASHW_STOP) then</span>
00040 <span class="comment">     *  initialize on/off based on frame</span>
00041 <span class="comment">     */</span>
00042     dwState = <a class="code" href="../../d4/d1/userk_8h.html#a1686">GetFlashWindowState</a>(pwnd);
00043     <span class="keywordflow">if</span> (dwState == FLASHW_DONE) {
00044         <span class="comment">/*</span>
00045 <span class="comment">         * We just need to clean up and to set the activation correctly</span>
00046 <span class="comment">         */</span>
00047         dwState |= FLASHW_KILLTIMER;
00048         <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> = FLASHW_STOP;
00049         <span class="keywordflow">goto</span> flash;
00050     }
00051     <span class="keywordflow">if</span> (dwState == FLASHW_STOP) {
00052 <span class="preprocessor">#if defined(_X86_)</span>
00053 <span class="preprocessor"></span>        <span class="comment">/*</span>
00054 <span class="comment">         * If there is a fullscreen cmd window, switch it to window mode</span>
00055 <span class="comment">         * so that the user gets a chance to see the flashing one</span>
00056 <span class="comment">         */</span>
00057         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a178">gbFullScreen</a> == FULLSCREEN) {
00058             <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a15">gspwndFullScreen</a>, WM_USER + 6, (WPARAM)WINDOWED, (LPARAM)0);
00059         }
00060 <span class="preprocessor">#endif // _X86_</span>
00061 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a557">WFFRAMEON</a>)) {
00062             dwState = FLASHW_ON | FLASHW_STARTON;
00063         }
00064     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> == FLASHW_TIMERCALL) {
00065         <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> = dwState;
00066     }
00067     <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp;= FLASHW_CALLERBITS;
00068     fStatePrev = (dwState &amp; FLASHW_ON);
00069     <span class="comment">/*</span>
00070 <span class="comment">     * Later5.0 Gerardob</span>
00071 <span class="comment">     * Not sure why we do this check but it used to be here.</span>
00072 <span class="comment">     */</span>
00073     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a>) {
00074         <span class="keywordflow">return</span> fStatePrev;
00075     }
00076     <span class="comment">/*</span>
00077 <span class="comment">     * Check if we're waiting to come to the foreground to stop.</span>
00078 <span class="comment">     */</span>
00079     <span class="keywordflow">if</span> (dwState &amp; FLASHW_FLASHNOFG) {
00080         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq)
00081             <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> = FLASHW_STOP;
00082     }
00083 
00084 flash:
00085     <span class="comment">/*</span>
00086 <span class="comment">     * Figure out new state</span>
00087 <span class="comment">     */</span>
00088     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> != FLASHW_STOP) {
00089         fFlashOn =  !fStatePrev;
00090     } <span class="keywordflow">else</span> {
00091         fFlashOn = (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> == pwnd);
00092     }
00093     <span class="comment">/*</span>
00094 <span class="comment">     * Flash'em</span>
00095 <span class="comment">     */</span>
00096     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> == FLASHW_STOP) || (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; FLASHW_CAPTION)) {
00097         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_NCACTIVATE, fFlashOn, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00098     }
00099     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> == FLASHW_STOP) || (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; FLASHW_TRAY)) {
00100         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/winloop2_8c.html#a2">IsTrayWindow</a>(pwnd)) {
00101             HWND hw = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd);
00102             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fShellFlash;
00103             <span class="keywordflow">if</span> (dwState &amp; FLASHW_DONE) {
00104                 <span class="comment">/*</span>
00105 <span class="comment">                 * If the window is not the active one when we're done flashing,</span>
00106 <span class="comment">                 * let the tray icon remain activated.  The Shell  is going to</span>
00107 <span class="comment">                 * take care to restore it at the when the window gets activated</span>
00108 <span class="comment">                 */</span>
00109                 fShellFlash = !fFlashOn;
00110             } <span class="keywordflow">else</span> {
00111                 fShellFlash = (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> == FLASHW_STOP ? <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> : fFlashOn);
00112             }
00113             <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HSHELL_REDRAW, (WPARAM) hw, (LPARAM) fShellFlash, WH_SHELL);
00114             <a class="code" href="../../d4/d1/userk_8h.html#a1867">PostShellHookMessages</a>(fShellFlash? HSHELL_FLASH:HSHELL_REDRAW, (LPARAM)hw);
00115         }
00116     }
00117     <span class="comment">/*</span>
00118 <span class="comment">     *  If we're to continue, check count, set timer and store</span>
00119 <span class="comment">     *   state as appropriate. Otherwise, kill timer and remove</span>
00120 <span class="comment">     *   state</span>
00121 <span class="comment">     */</span>
00122     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> != FLASHW_STOP) {
00123         <span class="comment">/*</span>
00124 <span class="comment">         * If counting, decrement count when we complete a cycle</span>
00125 <span class="comment">         */</span>
00126         <span class="keywordflow">if</span> (HIWORD(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>) != 0) {
00127             dwState |= FLASHW_COUNTING;
00128             <span class="keywordflow">if</span> (!(fFlashOn ^ !!(dwState &amp; FLASHW_STARTON))) {
00129                 <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> -= MAKELONG(0,1);
00130             }
00131             <span class="comment">/*</span>
00132 <span class="comment">             * Make sure we have a timer going.</span>
00133 <span class="comment">             */</span>
00134             <span class="keywordflow">if</span> (!(dwState &amp; FLASHW_KILLTIMER)) {
00135                 <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> |= FLASHW_TIMER;
00136             }
00137         }
00138         <span class="comment">/*</span>
00139 <span class="comment">         * Set a timer if needed.</span>
00140 <span class="comment">         */</span>
00141         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; FLASHW_TIMER) {
00142             dwState |= FLASHW_KILLTIMER;
00143             <a class="code" href="../../d4/d1/userk_8h.html#a1044">InternalSetTimer</a>(pwnd,
00144                              <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a47">IDSYS_FLASHWND</a>,
00145                              dwTimeout ? dwTimeout : <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;dtCaretBlink,
00146                              <a class="code" href="../../d4/d2/timers_8c.html#a22">xxxSystemTimerProc</a>,
00147                              TMRF_SYSTEM);
00148         }
00149         <span class="comment">/*</span>
00150 <span class="comment">         * Remember on/off state, propagate public flags</span>
00151 <span class="comment">         *  and count then save the state</span>
00152 <span class="comment">         */</span>
00153         <span class="keywordflow">if</span> (dwState &amp; FLASHW_COUNTING &amp;&amp;
00154             HIWORD(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>) == 0) {
00155             dwState = FLASHW_DONE;
00156         }
00157         <span class="keywordflow">else</span> {
00158             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a15">SET_OR_CLEAR_FLAG</a>(dwState, FLASHW_ON, fFlashOn);
00159             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a14">COPY_FLAG</a>(dwState, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>, FLASHW_CALLERBITS &amp; ~FLASHW_TIMER);
00160         }
00161         <a class="code" href="../../d4/d1/userk_8h.html#a1687">SetFlashWindowState</a>(pwnd, dwState);
00162 
00163     } <span class="keywordflow">else</span> {
00164         <span class="comment">/*</span>
00165 <span class="comment">         * We're done.</span>
00166 <span class="comment">         */</span>
00167         <span class="keywordflow">if</span> (dwState &amp; FLASHW_KILLTIMER) {
00168             <a class="code" href="../../d4/d1/userk_8h.html#a1567">_KillSystemTimer</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a47">IDSYS_FLASHWND</a>);
00169         }
00170         <a class="code" href="../../d4/d1/userk_8h.html#a1688">RemoveFlashWindowState</a>(pwnd);
00171     }
00172 
00173     <span class="keywordflow">return</span> fStatePrev;
00174 }
00175 
00176 <span class="comment">/***************************************************************************\</span>
00177 <span class="comment">* xxxEnableWindow (API)</span>
00178 <span class="comment">*</span>
00179 <span class="comment">*</span>
00180 <span class="comment">* History:</span>
00181 <span class="comment">* 12-Nov-1990 DarrinM   Ported.</span>
00182 <span class="comment">\***************************************************************************/</span>
00183 
<a name="l00184"></a><a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a3">00184</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a3">xxxEnableWindow</a>(
00185     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00186     BOOL fEnable)
00187 {
00188     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fOldState, fChange;
00189 
00190     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00191     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
00192 
00193     fOldState = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a651">WFDISABLED</a>);
00194 
00195     <span class="keywordflow">if</span> (!fEnable) {
00196         fChange = !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a651">WFDISABLED</a>);
00197 
00198         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_CANCELMODE, 0, 0);
00199 
00200         <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;pq-&gt;spwndFocus) {
00201                 <a class="code" href="../../d4/d1/userk_8h.html#a1662">xxxSetFocus</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00202         }
00203         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a651">WFDISABLED</a>);
00204 
00205     } <span class="keywordflow">else</span> {
00206         fChange = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a651">WFDISABLED</a>);
00207         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a651">WFDISABLED</a>);
00208     }
00209 
00210     <span class="keywordflow">if</span> (fChange) {
00211         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
00212             <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(EVENT_OBJECT_STATECHANGE, pwnd, OBJID_WINDOW,
00213                     INDEXID_CONTAINER, 0);
00214         }
00215         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_ENABLE, fEnable, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00216     }
00217 
00218     <span class="keywordflow">return</span> fOldState;
00219 }
00220 
00221 <span class="comment">/***************************************************************************\</span>
00222 <span class="comment">* xxxDoSend</span>
00223 <span class="comment">*</span>
00224 <span class="comment">* The following code is REALLY BOGUS!!!! Basically it prevents an</span>
00225 <span class="comment">* app from hooking the WM_GET/SETTEXT messages if they're going to</span>
00226 <span class="comment">* be called from another app.</span>
00227 <span class="comment">*</span>
00228 <span class="comment">* History:</span>
00229 <span class="comment">* 04-Mar-1992 JimA  Ported from Win 3.1 sources.</span>
00230 <span class="comment">\***************************************************************************/</span>
00231 
<a name="l00232"></a><a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a4">00232</a> LRESULT <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a4">xxxDoSend</a>(
00233     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwnd,
00234     UINT  message,
00235     WPARAM wParam,
00236     LPARAM lParam)
00237 {
00238     <span class="comment">/*</span>
00239 <span class="comment">     * We compare PROCESSINFO sturctures here so multi-threaded</span>
00240 <span class="comment">     * app can do what the want.</span>
00241 <span class="comment">     */</span>
00242     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;ppi == <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;ppi) {
00243         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, message, wParam, lParam);
00244     } <span class="keywordflow">else</span> {
00245         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1632">xxxDefWindowProc</a>(pwnd, message, wParam, lParam);
00246     }
00247 }
00248 
00249 <span class="comment">/***************************************************************************\</span>
00250 <span class="comment">* xxxGetWindowText (API)</span>
00251 <span class="comment">*</span>
00252 <span class="comment">*</span>
00253 <span class="comment">* History:</span>
00254 <span class="comment">* 09-Nov-1990 DarrinM   Wrote.</span>
00255 <span class="comment">\***************************************************************************/</span>
00256 
<a name="l00257"></a><a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a5">00257</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a5">xxxGetWindowText</a>(
00258     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>   pwnd,
00259     LPTSTR psz,
00260     <span class="keywordtype">int</span>    cchMax)
00261 {
00262     <a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html">LARGE_UNICODE_STRING</a> str;
00263     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> nRet, nLen;
00264 
00265     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00266 
00267     <span class="keywordflow">if</span> (cchMax) {
00268         <span class="comment">/*</span>
00269 <span class="comment">         * Initialize string empty, in case xxxSendMessage aborts validation</span>
00270 <span class="comment">         * If a bogus value was returned, rely on str.Length</span>
00271 <span class="comment">         */</span>
00272         str.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o2">bAnsi</a>         = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00273         str.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o1">MaximumLength</a> = cchMax * <span class="keyword">sizeof</span>(WCHAR);
00274         str.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a>        = psz;
00275         str.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o0">Length</a>        = 0;
00276 
00277         *psz = TEXT(<span class="charliteral">'\0'</span>);
00278 
00279         nRet = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)<a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a4">xxxDoSend</a>(pwnd, WM_GETTEXT, cchMax, (LPARAM)&amp;str);
00280         nLen = str.Length / <span class="keyword">sizeof</span>(WCHAR);
00281         <span class="keywordflow">return</span> (nRet &gt; nLen) ? nLen : nRet;
00282     }
00283 
00284     <span class="keywordflow">return</span> 0;
00285 }
00286 
00287 <span class="comment">/***************************************************************************\</span>
00288 <span class="comment">* xxxSetParent (API)</span>
00289 <span class="comment">*</span>
00290 <span class="comment">* Change a windows parent to a new window.  These steps are taken:</span>
00291 <span class="comment">*</span>
00292 <span class="comment">* 1. The window is hidden (if visible),</span>
00293 <span class="comment">* 2. Its coordinates are mapped into the new parent's space such that the</span>
00294 <span class="comment">*    window's screen-relative position is unchanged.</span>
00295 <span class="comment">* 3. The window is unlinked from its old parent and relinked to the new.</span>
00296 <span class="comment">* 4. xxxSetWindowPos is used to move the window to its new position.</span>
00297 <span class="comment">* 5. The window is shown again (if originally visible)</span>
00298 <span class="comment">*</span>
00299 <span class="comment">* NOTE: If you have a child window and set its parent to be NULL (the</span>
00300 <span class="comment">* desktop), the WS_CHILD style isn't removed from the window. This bug has</span>
00301 <span class="comment">* been in windows since 2.x. It turns out the apps group depends on this for</span>
00302 <span class="comment">* their combo boxes to work.  Basically, you end up with a top level window</span>
00303 <span class="comment">* that never gets activated (our activation code blows it off due to the</span>
00304 <span class="comment">* WS_CHILD bit).</span>
00305 <span class="comment">*</span>
00306 <span class="comment">* History:</span>
00307 <span class="comment">* 12-Nov-1990 DarrinM   Ported.</span>
00308 <span class="comment">* 19-Feb-1991 JimA      Added enum access check</span>
00309 <span class="comment">\***************************************************************************/</span>
00310 
<a name="l00311"></a><a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a6">00311</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a6">xxxSetParent</a>(
00312     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00313     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndNewParent)
00314 {
00315     POINT pt;
00316     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  fVisible;
00317     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwndOldParent;
00318     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>    tlpwndOldParent;
00319     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>    tlpwndNewParent;
00320     PVOID pvRet;
00321     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwndDesktop;
00322     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwndT;
00323     <span class="keywordtype">int</span> flags = SWP_NOZORDER | SWP_NOSIZE;
00324 
00325     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00326     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndNewParent);
00327 
00328     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a17">ValidateParentDepth</a>(pwnd, pwndNewParent)) {
00329         RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"Exceeded nested children limit"</span>);
00330         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00331     }
00332 
00333     pwndDesktop = <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd);
00334 
00335     <span class="comment">/*</span>
00336 <span class="comment">     * In 1.0x, an app's parent was null, but now it is pwndDesktop.</span>
00337 <span class="comment">     * Need to remember to lock pwndNewParent because we're reassigning</span>
00338 <span class="comment">     * it here.</span>
00339 <span class="comment">     */</span>
00340     <span class="keywordflow">if</span> (pwndNewParent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00341         pwndNewParent = pwndDesktop;
00342 
00343     <span class="comment">/*</span>
00344 <span class="comment">     * Don't ever change the parent of the desktop.</span>
00345 <span class="comment">     */</span>
00346     <span class="keywordflow">if</span> ((pwnd == pwndDesktop) || (pwnd == <a class="code" href="../../d4/d1/userk_8h.html#a323">PWNDMESSAGE</a>(pwnd))) {
00347         RIPERR0(ERROR_ACCESS_DENIED,
00348                 RIP_WARNING,
00349                 <span class="stringliteral">"Access denied: can't change parent of the desktop"</span>);
00350 
00351         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00352     }
00353 
00354     <span class="comment">/*</span>
00355 <span class="comment">     * Don't let the window become its own parent, grandparent, etc.</span>
00356 <span class="comment">     */</span>
00357     <span class="keywordflow">for</span> (pwndT = pwndNewParent; pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>) {
00358 
00359         <span class="keywordflow">if</span> (pwnd == pwndT) {
00360             RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING,
00361                   <span class="stringliteral">"Attempting to creating a parent-child relationship loop"</span>);
00362             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00363         }
00364     }
00365 
00366     <span class="comment">/*</span>
00367 <span class="comment">     * We still need pwndNewParent across callbacks...  and even though</span>
00368 <span class="comment">     * it was passed in, it may have been reassigned above.</span>
00369 <span class="comment">     */</span>
00370     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndNewParent, &amp;tlpwndNewParent);
00371 
00372     <span class="comment">/*</span>
00373 <span class="comment">     * Make the thing disappear from original parent.</span>
00374 <span class="comment">     */</span>
00375     fVisible = <a class="code" href="../../d4/d1/userk_8h.html#a1607">xxxShowWindow</a>(pwnd, MAKELONG(SW_HIDE, <a class="code" href="../../d4/d1/userk_8h.html#a657">TEST_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a636">PUDF_ANIMATE</a>)));
00376 
00377     <span class="comment">/*</span>
00378 <span class="comment">     * Ensure that the window being changed and the new parent</span>
00379 <span class="comment">     * are not in a destroyed state.</span>
00380 <span class="comment">     *</span>
00381 <span class="comment">     * IMPORTANT: After this check, do not leave the critical section</span>
00382 <span class="comment">     * until the window links have been rearranged.</span>
00383 <span class="comment">     */</span>
00384     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a583">WFDESTROYED</a>) || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndNewParent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a583">WFDESTROYED</a>)) {
00385         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndNewParent);
00386         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00387     }
00388 
00389     pwndOldParent = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
00390     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndOldParent, &amp;tlpwndOldParent);
00391 
00392 <span class="preprocessor">#ifdef USE_MIRRORING</span>
00393 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndOldParent, WEFLAYOUTRTL)) {
00394         pt.x = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right;
00395     } <span class="keywordflow">else</span>
00396 <span class="preprocessor">#endif</span>
00397 <span class="preprocessor"></span>    {
00398         pt.x = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left;
00399     }
00400     pt.y = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top;
00401     <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a21">_ScreenToClient</a>(pwndOldParent, &amp;pt);
00402 
00403     <a class="code" href="../../d4/d1/userk_8h.html#a1458">UnlinkWindow</a>(pwnd, pwndOldParent);
00404     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>, pwndNewParent);
00405 
00406     <span class="keywordflow">if</span> (pwndNewParent == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd) &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>)) {
00407 
00408         <span class="comment">/*</span>
00409 <span class="comment">         * Make sure a child who's owner is topmost inherits the topmost</span>
00410 <span class="comment">         * bit. - win31 bug 7568</span>
00411 <span class="comment">         */</span>
00412         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a654">WFCHILD</a>) &amp;&amp;
00413             (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>) &amp;&amp;
00414             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>)) {
00415 
00416             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>);
00417         }
00418 
00419         <span class="comment">/*</span>
00420 <span class="comment">         * BACKWARD COMPATIBILITY HACK ALERT</span>
00421 <span class="comment">         *</span>
00422 <span class="comment">         * All top level windows must be WS_CLIPSIBLINGs bit set.</span>
00423 <span class="comment">         * The SDM ComboBox() code calls SetParent() with a listbox</span>
00424 <span class="comment">         * window that does not have this set.  This causes problems</span>
00425 <span class="comment">         * with InternalInvalidate2() because it does not subtract off</span>
00426 <span class="comment">         * the window from the desktop's update region.</span>
00427 <span class="comment">         *</span>
00428 <span class="comment">         * We must invalidate the DC cache here, too, because if there is</span>
00429 <span class="comment">         * a cache entry lying around, its clipping region will be incorrect.</span>
00430 <span class="comment">         */</span>
00431         <span class="keywordflow">if</span> ((pwndNewParent == <a class="code" href="../../d3/d9/client_2wow_8c.html#a3">_GetDesktopWindow</a>()) &amp;&amp;
00432             !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a650">WFCLIPSIBLINGS</a>)) {
00433 
00434             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a650">WFCLIPSIBLINGS</a>);
00435             <a class="code" href="../../d4/d1/userk_8h.html#a1004">zzzInvalidateDCCache</a>(pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a232">IDC_DEFAULT</a>);
00436         }
00437 
00438         <span class="comment">/*</span>
00439 <span class="comment">         * This is a top level window but it isn't a topmost window so we</span>
00440 <span class="comment">         * have to link it below all topmost windows.</span>
00441 <span class="comment">         */</span>
00442         <a class="code" href="../../d4/d1/userk_8h.html#a1457">LinkWindow</a>(pwnd,
00443                    <a class="code" href="../../d4/d1/userk_8h.html#a1614">CalcForegroundInsertAfter</a>(pwnd),
00444                    pwndNewParent);
00445     } <span class="keywordflow">else</span> {
00446 
00447         <span class="comment">/*</span>
00448 <span class="comment">         * If this is a child window or if this is a TOPMOST window, we can</span>
00449 <span class="comment">         * link at the head of the parent chain.</span>
00450 <span class="comment">         */</span>
00451         <a class="code" href="../../d4/d1/userk_8h.html#a1457">LinkWindow</a>(pwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pwndNewParent);
00452     }
00453 
00454     <span class="comment">/*</span>
00455 <span class="comment">     * If we're a child window, do any necessary attaching and</span>
00456 <span class="comment">     * detaching.</span>
00457 <span class="comment">     */</span>
00458     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwnd)) {
00459 
00460         <span class="comment">/*</span>
00461 <span class="comment">         * Make sure we're not a WFCHILD window that got SetParent()'ed</span>
00462 <span class="comment">         * to the desktop.</span>
00463 <span class="comment">         */</span>
00464         <span class="keywordflow">if</span> ((pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> != <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) &amp;&amp;
00465             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd) != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndOldParent)) {
00466 
00467             <a class="code" href="../../d4/d1/userk_8h.html#a1202">zzzAttachThreadInput</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndOldParent), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00468         }
00469 
00470         <span class="comment">/*</span>
00471 <span class="comment">         * If the new parent window is on a different thread, and also</span>
00472 <span class="comment">         * isn't the desktop window, attach ourselves appropriately.</span>
00473 <span class="comment">         */</span>
00474         <span class="keywordflow">if</span> (pwndNewParent != <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd) &amp;&amp;
00475             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd) != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndNewParent)) {
00476 
00477             <a class="code" href="../../d4/d1/userk_8h.html#a1202">zzzAttachThreadInput</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndNewParent), <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00478         }
00479     }
00480 
00481     <span class="keywordflow">if</span> (pwndNewParent == <a class="code" href="../../d4/d1/userk_8h.html#a323">PWNDMESSAGE</a>(pwnd) || pwndOldParent == <a class="code" href="../../d4/d1/userk_8h.html#a323">PWNDMESSAGE</a>(pwnd))
00482         flags |= SWP_NOACTIVATE;
00483 
00484     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
00485         <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(EVENT_OBJECT_PARENTCHANGE, pwnd, OBJID_WINDOW,
00486                 INDEXID_CONTAINER, <a class="code" href="../../d4/d1/userk_8h.html#a610">WEF_USEPWNDTHREAD</a>);
00487     }
00488 
00489     <span class="comment">/*</span>
00490 <span class="comment">     * We mustn't return an invalid pwndOldParent</span>
00491 <span class="comment">     */</span>
00492     <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pt.x, pt.y, 0, 0, flags);
00493 
00494     <span class="keywordflow">if</span> (fVisible) {
00495         <a class="code" href="../../d4/d1/userk_8h.html#a1607">xxxShowWindow</a>(pwnd, MAKELONG(SW_SHOWNORMAL, <a class="code" href="../../d4/d1/userk_8h.html#a657">TEST_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a636">PUDF_ANIMATE</a>)));
00496     }
00497 
00498     <span class="comment">/*</span>
00499 <span class="comment">     * returns pwndOldParent if still valid, else NULL.</span>
00500 <span class="comment">     */</span>
00501     pvRet = <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndOldParent);
00502     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndNewParent);
00503 
00504     <span class="keywordflow">return</span> pvRet;
00505 }
00506 
00507 <span class="comment">/***************************************************************************\</span>
00508 <span class="comment">* xxxFindWindowEx (API)</span>
00509 <span class="comment">*</span>
00510 <span class="comment">* Searches for a window among top level windows. The keys used are pszClass,</span>
00511 <span class="comment">* (the class name) and/or pszName, (the window title name). Either can be</span>
00512 <span class="comment">* NULL.</span>
00513 <span class="comment">*</span>
00514 <span class="comment">* History:</span>
00515 <span class="comment">* 06-Jun-1994 JohnL     Converted xxxFindWindow to xxxFindWindowEx</span>
00516 <span class="comment">* 10-Nov-1992 mikeke    Added 16bit and 32bit only flag</span>
00517 <span class="comment">* 24-Sep-1990 DarrinM   Generated stubs.</span>
00518 <span class="comment">* 02-Jun-1991 ScottLu   Ported from Win3.</span>
00519 <span class="comment">* 19-Feb-1991 JimA      Added enum access check</span>
00520 <span class="comment">\***************************************************************************/</span>
00521 
<a name="l00522"></a><a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a0">00522</a> <span class="preprocessor">#define CCHMAXNAME 80</span>
00523 <span class="preprocessor"></span>
<a name="l00524"></a><a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a7">00524</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a7">_FindWindowEx</a>(
00525     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>   pwndParent,
00526     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>   pwndChild,
00527     LPCWSTR ccxlpszClass,
00528     LPCWSTR ccxlpszName,
00529     DWORD  dwType)
00530 {
00531     <span class="comment">/*</span>
00532 <span class="comment">     * Note that the Class and Name pointers are client-side addresses.</span>
00533 <span class="comment">     */</span>
00534 
00535     <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a>    pbwl;
00536     HWND    *phwnd;
00537     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwnd;
00538     WORD    atomClass = 0;
00539     LPCWSTR  lpName;
00540     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fTryMessage = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00541 
00542     <span class="keywordflow">if</span> (ccxlpszClass != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00543 
00544         atomClass = <a class="code" href="../../d4/d1/userk_8h.html#a523">FindClassAtom</a>(ccxlpszClass);
00545 
00546         <span class="keywordflow">if</span> (atomClass == 0) {
00547             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00548         }
00549     }
00550 
00551     <span class="comment">/*</span>
00552 <span class="comment">     * Setup parent window</span>
00553 <span class="comment">     */</span>
00554     <span class="keywordflow">if</span> (!pwndParent) {
00555         pwndParent = <a class="code" href="../../d3/d9/client_2wow_8c.html#a3">_GetDesktopWindow</a>();
00556         <span class="comment">/*</span>
00557 <span class="comment">         * If we are starting from the root and no child window</span>
00558 <span class="comment">         * was specified, then check the message window tree too</span>
00559 <span class="comment">         * in case we don't find it on the desktop tree.</span>
00560 <span class="comment">         */</span>
00561 
00562         <span class="keywordflow">if</span> (!pwndChild)
00563             fTryMessage = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00564     }
00565 
00566 TryAgain:
00567     <span class="comment">/*</span>
00568 <span class="comment">     * Setup first child</span>
00569 <span class="comment">     */</span>
00570     <span class="keywordflow">if</span> (!pwndChild) {
00571         pwndChild = pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
00572     } <span class="keywordflow">else</span> {
00573         <span class="keywordflow">if</span> (pwndChild-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> != pwndParent) {
00574             RIPMSG0(RIP_WARNING,
00575                  <span class="stringliteral">"FindWindowEx: Child window doesn't have proper parent"</span>);
00576             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00577         }
00578 
00579         pwndChild = pwndChild-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
00580     }
00581 
00582     <span class="comment">/*</span>
00583 <span class="comment">     * Generate a list of top level windows.</span>
00584 <span class="comment">     */</span>
00585     <span class="keywordflow">if</span> ((pbwl = <a class="code" href="../../d4/d1/userk_8h.html#a1157">BuildHwndList</a>(pwndChild, <a class="code" href="../../d4/d1/userk_8h.html#a410">BWL_ENUMLIST</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00586         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00587     }
00588 
00589     <span class="comment">/*</span>
00590 <span class="comment">     * Set pwnd to NULL in case the window list is empty.</span>
00591 <span class="comment">     */</span>
00592     pwnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00593 
00594     <span class="keywordflow">try</span> {
00595         <span class="keywordflow">for</span> (phwnd = pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o4">rghwnd</a>; *phwnd != (HWND)1; phwnd++) {
00596 
00597             <span class="comment">/*</span>
00598 <span class="comment">             * Validate this hwnd since we left the critsec earlier (below</span>
00599 <span class="comment">             * in the loop we send a message!</span>
00600 <span class="comment">             */</span>
00601             <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(*phwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00602                 <span class="keywordflow">continue</span>;
00603 
00604             <span class="comment">/*</span>
00605 <span class="comment">             * make sure this window is of the right type</span>
00606 <span class="comment">             */</span>
00607             <span class="keywordflow">if</span> (dwType != <a class="code" href="../../d1/d0/inc_2user_8h.html#a187">FW_BOTH</a>) {
00608                 <span class="keywordflow">if</span> (((dwType == <a class="code" href="../../d1/d0/inc_2user_8h.html#a188">FW_16BIT</a>) &amp;&amp; !(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;TIF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>)) ||
00609                     ((dwType == <a class="code" href="../../d1/d0/inc_2user_8h.html#a189">FW_32BIT</a>) &amp;&amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;TIF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>)))
00610                     <span class="keywordflow">continue</span>;
00611             }
00612 
00613             <span class="comment">/*</span>
00614 <span class="comment">             * If the class is specified and doesn't match, skip this window</span>
00615 <span class="comment">             */</span>
00616             <span class="keywordflow">if</span> (!atomClass || (atomClass == pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a>)) {
00617                 <span class="keywordflow">if</span> (!ccxlpszName)
00618                     <span class="keywordflow">break</span>;
00619 
00620                 <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o0">Length</a>) {
00621                     lpName = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a>;
00622                 } <span class="keywordflow">else</span> {
00623                     lpName = <a class="code" href="../../d1/d8/clglobal_8c.html#a13">szNull</a>;
00624                 }
00625 
00626                 <span class="comment">/*</span>
00627 <span class="comment">                 * Is the text the same? If so, return with this window!</span>
00628 <span class="comment">                 */</span>
00629                 <span class="keywordflow">if</span> (_wcsicmp(ccxlpszName, lpName) == 0)
00630                     <span class="keywordflow">break</span>;
00631             }
00632 
00633             <span class="comment">/*</span>
00634 <span class="comment">             * The window did not match.</span>
00635 <span class="comment">             */</span>
00636             pwnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00637         }
00638     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00639         pwnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00640     }
00641 
00642     <a class="code" href="../../d4/d1/userk_8h.html#a1158">FreeHwndList</a>(pbwl);
00643 
00644     <span class="keywordflow">if</span> (!pwnd &amp;&amp; fTryMessage) {
00645         fTryMessage = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00646         pwndParent = <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a15">_GetMessageWindow</a>();
00647         pwndChild = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00648         <span class="keywordflow">goto</span> TryAgain;
00649     }
00650 
00651     <span class="keywordflow">return</span> ((*phwnd == (HWND)1) ? <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> : pwnd);
00652 }
00653 
00654 <span class="comment">/***************************************************************************\</span>
00655 <span class="comment">* UpdateCheckpoint</span>
00656 <span class="comment">*</span>
00657 <span class="comment">* Checkpoints the current window size/position/state and returns a pointer</span>
00658 <span class="comment">* to the structure.</span>
00659 <span class="comment">*</span>
00660 <span class="comment">* History:</span>
00661 <span class="comment">\***************************************************************************/</span>
00662 
<a name="l00663"></a><a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a8">00663</a> <a class="code" href="../../d0/d0/structtagCHECKPOINT.html">PCHECKPOINT</a> <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a8">UpdateCheckpoint</a>(
00664     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00665 {
00666     RECT rc;
00667 
00668     <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a12">GetRect</a>(pwnd, &amp;rc, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a903">GRECT_WINDOW</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a907">GRECT_PARENTCOORDS</a>);
00669     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1240">CkptRestore</a>(pwnd, &amp;rc);
00670 }
00671 
00672 <span class="comment">/***************************************************************************\</span>
00673 <span class="comment">* GetWindowPlacement</span>
00674 <span class="comment">*</span>
00675 <span class="comment">* History:</span>
00676 <span class="comment">* 02-Mar-1992 MikeKe    From Win 3.1</span>
00677 <span class="comment">\***************************************************************************/</span>
00678 
<a name="l00679"></a><a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a9">00679</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a9">_GetWindowPlacement</a>(
00680     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>             pwnd,
00681     PWINDOWPLACEMENT pwp)
00682 {
00683     <a class="code" href="../../d0/d0/structtagCHECKPOINT.html">CHECKPOINT</a> * pcp;
00684 
00685     <span class="comment">/*</span>
00686 <span class="comment">     * this will set the normal or the minimize point in the checkpoint,</span>
00687 <span class="comment">     * so that all elements will be up to date.</span>
00688 <span class="comment">     */</span>
00689     pcp = <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a8">UpdateCheckpoint</a>(pwnd);
00690 
00691     <span class="keywordflow">if</span> (!pcp)
00692         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00693 
00694     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)) {
00695         pwp-&gt;showCmd = SW_SHOWMINIMIZED;
00696     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a648">WFMAXIMIZED</a>)) {
00697         pwp-&gt;showCmd = SW_SHOWMAXIMIZED;
00698     } <span class="keywordflow">else</span> {
00699         pwp-&gt;showCmd = SW_SHOWNORMAL;
00700     }
00701 
00702     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;pwp-&gt;rcNormalPosition, &amp;pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o0">rcNormal</a>);
00703 
00704     <span class="keywordflow">if</span> (pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o6">fMinInitialized</a>) {
00705         pwp-&gt;ptMinPosition = pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o1">ptMin</a>;
00706     } <span class="keywordflow">else</span> {
00707         pwp-&gt;ptMinPosition.x = pwp-&gt;ptMinPosition.y = -1;
00708     }
00709 
00710     <span class="comment">/*</span>
00711 <span class="comment">     * We never ever save the position of "normal" maximized windows.  Other</span>
00712 <span class="comment">     * wise, when the size border changes dimensions, the max pos would be</span>
00713 <span class="comment">     * invalid, and you would never be able to reset it.</span>
00714 <span class="comment">     */</span>
00715     <span class="keywordflow">if</span> (pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o7">fMaxInitialized</a> &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a582">WFREALLYMAXIMIZABLE</a>)) {
00716         pwp-&gt;ptMaxPosition = pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o2">ptMax</a>;
00717     } <span class="keywordflow">else</span> {
00718         pwp-&gt;ptMaxPosition.x = pwp-&gt;ptMaxPosition.y = -1;
00719     }
00720 
00721     <span class="keywordflow">if</span> ((pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) &amp;&amp;
00722             !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a619">WEFTOOLWINDOW</a>)) {
00723 
00724         <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>    pMonitor;
00725 
00726         pMonitor = <a class="code" href="../../d9/d1/mmrtl_8c.html#a7">_MonitorFromRect</a>(&amp;pwp-&gt;rcNormalPosition, MONITOR_DEFAULTTOPRIMARY);
00727 
00728         <span class="comment">/*</span>
00729 <span class="comment">         * Convert min, normal positions to be relative to the working area.</span>
00730 <span class="comment">         * The max pos already is (always is saved that way).</span>
00731 <span class="comment">         *</span>
00732 <span class="comment">         * working area, except for maximized position, which is always</span>
00733 <span class="comment">         * working area relative.</span>
00734 <span class="comment">         */</span>
00735         <span class="keywordflow">if</span> (pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o6">fMinInitialized</a>) {
00736             pwp-&gt;ptMinPosition.x -= (pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.left - pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.left);
00737             pwp-&gt;ptMinPosition.y -= (pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.top - pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top);
00738         }
00739 
00740         <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(&amp;pwp-&gt;rcNormalPosition,
00741             pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.left - pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.left,
00742             pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top - pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.top);
00743     }
00744 
00745     pwp-&gt;flags = 0;
00746 
00747     <span class="comment">/*</span>
00748 <span class="comment">     * B#3276</span>
00749 <span class="comment">     * Don't allow WPF_SETMINPOSITION on top-level windows.</span>
00750 <span class="comment">     */</span>
00751     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwnd) &amp;&amp; pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o3">fDragged</a>)
00752         pwp-&gt;flags |= WPF_SETMINPOSITION;
00753 
00754     <span class="keywordflow">if</span> (pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o4">fWasMaximizedBeforeMinimized</a> || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a648">WFMAXIMIZED</a>))
00755         pwp-&gt;flags |= WPF_RESTORETOMAXIMIZED;
00756 
00757     pwp-&gt;length = <span class="keyword">sizeof</span>(WINDOWPLACEMENT);
00758 
00759     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00760 }
00761 
00762 <span class="comment">/***************************************************************************\</span>
00763 <span class="comment">* CheckPlacementBounds</span>
00764 <span class="comment">*</span>
00765 <span class="comment">* History:</span>
00766 <span class="comment">* 02-Mar-1992 MikeKe    From Win 3.1</span>
00767 <span class="comment">\***************************************************************************/</span>
00768 
<a name="l00769"></a><a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a10">00769</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a10">CheckPlacementBounds</a>(
00770     LPRECT      lprc,
00771     LPPOINT     ptMin,
00772     LPPOINT     ptMax,
00773     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>    pMonitor)
00774 {
00775     <span class="keywordtype">int</span> xIcon;
00776     <span class="keywordtype">int</span> yIcon;
00777     <span class="keywordtype">int</span> sTop;
00778     <span class="keywordtype">int</span> sBottom;
00779     <span class="keywordtype">int</span> sLeft;
00780     <span class="keywordtype">int</span> sRight;
00781 
00782     <span class="comment">/*</span>
00783 <span class="comment">     * Check Normal Window Placement</span>
00784 <span class="comment">     */</span>
00785 
00786     <span class="comment">/*</span>
00787 <span class="comment">     * Possible values for these sign variables are :</span>
00788 <span class="comment">     * -1 : less than the minimum for that dimension</span>
00789 <span class="comment">     *  0 : within the range for that dimension</span>
00790 <span class="comment">     *  1 : more than the maximum for that dimension</span>
00791 <span class="comment">     */</span>
00792     sTop = (lprc-&gt;top &lt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.top) ? -1 :
00793         ((lprc-&gt;top &gt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.bottom) ? 1 : 0);
00794 
00795     sBottom = (lprc-&gt;bottom &lt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.top) ? -1 :
00796         ((lprc-&gt;bottom &gt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.bottom) ? 1 : 0);
00797 
00798     sLeft = (lprc-&gt;left &lt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.left) ? -1 :
00799         ((lprc-&gt;left &gt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.right) ? 1 : 0);
00800 
00801     sRight = (lprc-&gt;right &lt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.left) ? -1 :
00802         ((lprc-&gt;right &gt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.right) ? 1 : 0);
00803 
00804     <span class="keywordflow">if</span> ((sTop * sBottom &gt; 0) || (sLeft * sRight &gt; 0)) {
00805 
00806         <span class="comment">/*</span>
00807 <span class="comment">         * Window is TOTALLY outside monitor bounds.  The resolution and/or</span>
00808 <span class="comment">         * configuration of monitors probably changed since the last time</span>
00809 <span class="comment">         * we ran this app.</span>
00810 <span class="comment">         *</span>
00811 <span class="comment">         * Slide it FULLY onto the monitor at the nearest position.</span>
00812 <span class="comment">         */</span>
00813         <span class="keywordtype">int</span> size;
00814 
00815         <span class="keywordflow">if</span> (sTop &lt; 0) {
00816             lprc-&gt;bottom -= lprc-&gt;top;
00817             lprc-&gt;top     = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.top;
00818         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sBottom &gt; 0) {
00819             size = lprc-&gt;bottom - lprc-&gt;top;
00820             lprc-&gt;top    = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.bottom - size, pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.top);
00821             lprc-&gt;bottom = lprc-&gt;top + size;
00822         }
00823 
00824         <span class="keywordflow">if</span> (sLeft &lt; 0) {
00825             lprc-&gt;right -= lprc-&gt;left;
00826             lprc-&gt;left   = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.left;
00827         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sRight &gt; 0) {
00828             size = lprc-&gt;right - lprc-&gt;left;
00829             lprc-&gt;left  = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.right - size, pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.left);
00830             lprc-&gt;right = lprc-&gt;left + size;
00831         }
00832     }
00833 
00834     <span class="comment">/*</span>
00835 <span class="comment">     * Check Iconic Window Placement</span>
00836 <span class="comment">     */</span>
00837     <span class="keywordflow">if</span> (ptMin-&gt;x != -1) {
00838 
00839         xIcon = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXMINSPACING);
00840         yIcon = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYMINSPACING);
00841 
00842         sTop = (ptMin-&gt;y &lt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.top) ? -1 :
00843             ((ptMin-&gt;y &gt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.bottom) ? 1 : 0);
00844 
00845         sBottom = (ptMin-&gt;y + yIcon &lt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.top) ? -1 :
00846             ((ptMin-&gt;y + yIcon &gt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.bottom) ? 1 : 0);
00847 
00848         sLeft = (ptMin-&gt;x &lt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.left) ? -1 :
00849             ((ptMin-&gt;x &gt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.right) ? 1 : 0);
00850 
00851         sRight = (ptMin-&gt;x + xIcon &lt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.left) ? -1 :
00852             ((ptMin-&gt;x + xIcon &gt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.right) ? 1 : 0);
00853 
00854         <span class="comment">/*</span>
00855 <span class="comment">         * Icon is TOTALLY outside monitor bounds; repark it.</span>
00856 <span class="comment">         */</span>
00857         <span class="keywordflow">if</span> ((sTop * sBottom &gt; 0) || (sLeft * sRight &gt; 0))
00858             ptMin-&gt;x = ptMin-&gt;y = -1;
00859     }
00860 
00861     <span class="comment">/*</span>
00862 <span class="comment">     * Check Maximized Window Placement</span>
00863 <span class="comment">     */</span>
00864     <span class="keywordflow">if</span> (ptMax-&gt;x != -1 &amp;&amp;
00865         (ptMax-&gt;x + pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.left &gt;= pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.right ||
00866          ptMax-&gt;y + pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.top &gt;= pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.bottom)) {
00867 
00868         <span class="comment">/*</span>
00869 <span class="comment">         * window is TOTALLY below beyond maximum dimensions; zero the</span>
00870 <span class="comment">         * position so that the window will at least be clipped to the</span>
00871 <span class="comment">         * monitor.</span>
00872 <span class="comment">         */</span>
00873         ptMax-&gt;x = 0;
00874         ptMax-&gt;y = 0;
00875     }
00876 }
00877 
00878 <span class="comment">/***************************************************************************\</span>
00879 <span class="comment">* WPUpdateCheckPointSettings</span>
00880 <span class="comment">*</span>
00881 <span class="comment">* History:</span>
00882 <span class="comment">* 02/23/98  GerardoB    Extracted from xxxSetWindowPlacement</span>
00883 <span class="comment">\***************************************************************************/</span>
<a name="l00884"></a><a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a11">00884</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a11">WPUpdateCheckPointSettings</a> (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT uWPFlags)
00885 {
00886     <a class="code" href="../../d0/d0/structtagCHECKPOINT.html">CHECKPOINT</a> *    pcp;
00887 
00888     UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>));
00889     <span class="keywordflow">if</span> (pcp = <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a8">UpdateCheckpoint</a>(pwnd)) {
00890 
00891         <span class="comment">/*</span>
00892 <span class="comment">         * Save settings in the checkpoint struct</span>
00893 <span class="comment">         */</span>
00894         <span class="keywordflow">if</span> (uWPFlags &amp; WPF_SETMINPOSITION)
00895             pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o3">fDragged</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00896 
00897         <span class="keywordflow">if</span> (uWPFlags &amp; WPF_RESTORETOMAXIMIZED) {
00898             pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o4">fWasMaximizedBeforeMinimized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00899         } <span class="keywordflow">else</span> {
00900             pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o4">fWasMaximizedBeforeMinimized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00901         }
00902     }
00903 }
00904 <span class="comment">/***************************************************************************\</span>
00905 <span class="comment">* xxxSetWindowPlacement</span>
00906 <span class="comment">*</span>
00907 <span class="comment">* History:</span>
00908 <span class="comment">* 02-Mar-1992 MikeKe    From Win 3.1</span>
00909 <span class="comment">\***************************************************************************/</span>
00910 
<a name="l00911"></a><a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a12">00911</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a12">xxxSetWindowPlacement</a>(
00912     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>             pwnd,
00913     PWINDOWPLACEMENT pwp)
00914 {
00915     <a class="code" href="../../d0/d0/structtagCHECKPOINT.html">CHECKPOINT</a> *    pcp;
00916     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>        pMonitor;
00917     RECT            rc;
00918     POINT           ptMin;
00919     POINT           ptMax;
00920     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>            fMin;
00921     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>            fMax;
00922     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>            uSWPFlags;
00923     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>            fRealAsync;
00924 
00925     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00926 
00927     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rc, &amp;pwp-&gt;rcNormalPosition);
00928     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
00929         pMonitor = <a class="code" href="../../d9/d1/mmrtl_8c.html#a7">_MonitorFromRect</a>(&amp;rc, MONITOR_DEFAULTTOPRIMARY);
00930     }
00931 
00932     ptMin = pwp-&gt;ptMinPosition;
00933     fMin  = ((ptMin.x != -1) &amp;&amp; (ptMin.y != -1));
00934 
00935     ptMax = pwp-&gt;ptMaxPosition;
00936     fMax  = ((ptMax.x != -1) &amp;&amp; (ptMax.y != -1));
00937 
00938     <span class="comment">/*</span>
00939 <span class="comment">     * Convert back to working rectangle coordinates</span>
00940 <span class="comment">     */</span>
00941     <span class="keywordflow">if</span> (    pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd) &amp;&amp;
00942             !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a619">WEFTOOLWINDOW</a>)) {
00943 
00944         <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(
00945                 &amp;rc,
00946                 pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.left - pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.left,
00947                 pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.top - pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top);
00948 
00949         <span class="keywordflow">if</span> (fMin) {
00950             ptMin.x += pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.left - pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.left;
00951             ptMin.y += pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.top - pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top;
00952         }
00953 
00954         <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a10">CheckPlacementBounds</a>(&amp;rc, &amp;ptMin, &amp;ptMax, pMonitor);
00955     }
00956 
00957     <span class="keywordflow">if</span> (pcp = <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a8">UpdateCheckpoint</a>(pwnd)) {
00958 
00959         <span class="comment">/*</span>
00960 <span class="comment">         * Save settings in the checkpoint struct</span>
00961 <span class="comment">         */</span>
00962         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o0">rcNormal</a>, &amp;rc);
00963 
00964         pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o1">ptMin</a>                        = ptMin;
00965         pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o6">fMinInitialized</a>              = fMin;
00966         pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o3">fDragged</a>                     = (pwp-&gt;flags &amp; WPF_SETMINPOSITION) ?
00967                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00968         pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o2">ptMax</a>                        = ptMax;
00969         pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o7">fMaxInitialized</a>              = fMax;
00970         pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o4">fWasMaximizedBeforeMinimized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00971     }
00972 
00973     <span class="comment">/*</span>
00974 <span class="comment">     * WPF_ASYNCWINDOWPLACEMENT new for NT5.</span>
00975 <span class="comment">     */</span>
00976     uSWPFlags = SWP_NOZORDER | SWP_NOACTIVATE
00977                 | ((pwp-&gt;flags &amp; WPF_ASYNCWINDOWPLACEMENT) ? SWP_ASYNCWINDOWPOS : 0);
00978 
00979     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)) {
00980 
00981         <span class="keywordflow">if</span> ((!pcp || pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o3">fDragged</a>) &amp;&amp; fMin) {
00982             <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwnd,
00983                             <a class="code" href="../../d4/d1/userk_8h.html#a452">PWND_TOP</a>,
00984                             ptMin.x,
00985                             ptMin.y,
00986                             0,
00987                             0,
00988                             SWP_NOSIZE | uSWPFlags);
00989         }
00990 
00991     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a648">WFMAXIMIZED</a>)) {
00992 
00993         <span class="keywordflow">if</span> (pcp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00994             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a582">WFREALLYMAXIMIZABLE</a>))
00995                 pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o7">fMaxInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00996 
00997             <span class="keywordflow">if</span> (pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o7">fMaxInitialized</a>) {
00998                 <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
00999                     ptMax.x += pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.left;
01000                     ptMax.y += pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.top;
01001                 }
01002 
01003                 <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwnd,
01004                                 <a class="code" href="../../d4/d1/userk_8h.html#a452">PWND_TOP</a>,
01005                                 ptMax.x,
01006                                 ptMax.y,
01007                                 0,
01008                                 0,
01009                                 SWP_NOSIZE | uSWPFlags);
01010             }
01011         }
01012 
01013 
01014     } <span class="keywordflow">else</span> {
01015 
01016         <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwnd,
01017                         <a class="code" href="../../d4/d1/userk_8h.html#a452">PWND_TOP</a>,
01018                         rc.left,
01019                         rc.top,
01020                         rc.right - rc.left,
01021                         rc.bottom - rc.top,
01022                         uSWPFlags);
01023     }
01024     <span class="comment">/*</span>
01025 <span class="comment">     * xxxSetWindowPos is only assync when the window's thread is on a</span>
01026 <span class="comment">     *  different queue than the current thread's. See AsyncWindowPos.</span>
01027 <span class="comment">     */</span>
01028     fRealAsync = (pwp-&gt;flags &amp; WPF_ASYNCWINDOWPLACEMENT)
01029                     &amp;&amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq != <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;pq);
01030 
01031     <span class="keywordflow">if</span> (fRealAsync) {
01032         <a class="code" href="../../d4/d1/userk_8h.html#a1608">_ShowWindowAsync</a>(pwnd, pwp-&gt;showCmd, pwp-&gt;flags);
01033     } <span class="keywordflow">else</span> {
01034         <a class="code" href="../../d4/d1/userk_8h.html#a1607">xxxShowWindow</a>(pwnd, MAKELONG(pwp-&gt;showCmd, <a class="code" href="../../d4/d1/userk_8h.html#a657">TEST_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a636">PUDF_ANIMATE</a>)));
01035     }
01036 
01037     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>) &amp;&amp; !fRealAsync) {
01038         <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a11">WPUpdateCheckPointSettings</a>(pwnd, pwp-&gt;flags);
01039     }
01040 
01041     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01042 }
01043 
01044 <span class="comment">/***************************************************************************\</span>
01045 <span class="comment">* xxxSetInternalWindowPos</span>
01046 <span class="comment">*</span>
01047 <span class="comment">* Sets a window to the size, position and state it was most recently</span>
01048 <span class="comment">* in.  Side effect (possibly bug): shows and activates the window as well.</span>
01049 <span class="comment">*</span>
01050 <span class="comment">* History:</span>
01051 <span class="comment">* 28-Mar-1991 DavidPe   Ported from Win 3.1 sources.</span>
01052 <span class="comment">\***************************************************************************/</span>
01053 
<a name="l01054"></a><a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a13">01054</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a13">xxxSetInternalWindowPos</a>(
01055     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwnd,
01056     UINT    cmdShow,
01057     LPRECT  lprcWin,
01058     LPPOINT lpptMin)
01059 {
01060     <a class="code" href="../../d0/d0/structtagCHECKPOINT.html">CHECKPOINT</a> *    pcp;
01061     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>        pMonitor;
01062 
01063     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
01064 
01065     <span class="keywordflow">if</span> ((pcp = <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a8">UpdateCheckpoint</a>(pwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01066         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01067     }
01068 
01069     <span class="keywordflow">if</span> (lprcWin) {
01070 
01071         pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o0">rcNormal</a> = *lprcWin;
01072         <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
01073             pMonitor = <a class="code" href="../../d9/d1/mmrtl_8c.html#a7">_MonitorFromRect</a>(lprcWin, MONITOR_DEFAULTTOPRIMARY);
01074             <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(
01075                     &amp;pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o0">rcNormal</a>,
01076                     pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.left - pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.left,
01077                     pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.top - pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top);
01078         }
01079     }
01080 
01081     <span class="keywordflow">if</span> (lpptMin &amp;&amp; (lpptMin-&gt;x != -1)) {
01082 
01083         pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o1">ptMin</a> = *lpptMin;
01084         <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
01085             pMonitor = <a class="code" href="../../d9/d1/mmrtl_8c.html#a7">_MonitorFromRect</a>(&amp;pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o0">rcNormal</a>, MONITOR_DEFAULTTOPRIMARY);
01086             pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o1">ptMin</a>.x += pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.left - pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.left;
01087             pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o1">ptMin</a>.y += pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.top - pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top;
01088         }
01089 
01090         pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o3">fDragged</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01091         pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o6">fMinInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01092 
01093     } <span class="keywordflow">else</span> {
01094         pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o6">fMinInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01095         pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o3">fDragged</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01096     }
01097 
01098     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)) {
01099 
01100         <span class="comment">/*</span>
01101 <span class="comment">         * need to move the icon</span>
01102 <span class="comment">         */</span>
01103         <span class="keywordflow">if</span> (pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o6">fMinInitialized</a>) {
01104             <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwnd,
01105                             <a class="code" href="../../d4/d1/userk_8h.html#a452">PWND_TOP</a>,
01106                             pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o1">ptMin</a>.x,
01107                             pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o1">ptMin</a>.y,
01108                             0,
01109                             0,
01110                             SWP_NOSIZE | SWP_NOZORDER | SWP_NOACTIVATE);
01111         }
01112 
01113     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a648">WFMAXIMIZED</a>) &amp;&amp; lprcWin) {
01114         <span class="comment">/*</span>
01115 <span class="comment">         * need to set the size and the position</span>
01116 <span class="comment">         */</span>
01117         <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwnd,
01118                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01119                         lprcWin-&gt;left,
01120                         lprcWin-&gt;top,
01121                         lprcWin-&gt;right - lprcWin-&gt;left,
01122                         lprcWin-&gt;bottom - lprcWin-&gt;top,
01123                         SWP_NOZORDER);
01124     }
01125 
01126     <a class="code" href="../../d4/d1/userk_8h.html#a1607">xxxShowWindow</a>(pwnd, MAKELONG(cmdShow, <a class="code" href="../../d4/d1/userk_8h.html#a657">TEST_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a636">PUDF_ANIMATE</a>)));
01127 
01128     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01129 }
01130 
01131 <span class="comment">/***************************************************************************\</span>
01132 <span class="comment">* _GetDesktopWindow (API)</span>
01133 <span class="comment">*</span>
01134 <span class="comment">* History:</span>
01135 <span class="comment">* 07-Nov-1990 DarrinM   Implemented.</span>
01136 <span class="comment">\***************************************************************************/</span>
01137 
<a name="l01138"></a><a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a14">01138</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d3/d9/client_2wow_8c.html#a3">_GetDesktopWindow</a>(VOID)
01139 {
01140     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>  pti = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01141     <a class="code" href="../../d1/d3/structtagDESKTOPINFO.html">PDESKTOPINFO</a> pdi;
01142 
01143     <span class="keywordflow">if</span> (pti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01144         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01145 
01146     pdi = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o7">pDeskInfo</a>;
01147 
01148     <span class="keywordflow">return</span> pdi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> : pdi-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>;
01149 }
01150 
01151 <span class="comment">/***************************************************************************\</span>
01152 <span class="comment">* _GetDesktopWindow (API)</span>
01153 <span class="comment">*</span>
01154 <span class="comment">* History:</span>
01155 <span class="comment">* 07-Nov-1990 DarrinM   Implemented.</span>
01156 <span class="comment">\***************************************************************************/</span>
01157 
<a name="l01158"></a><a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a15">01158</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a15">_GetMessageWindow</a>(VOID)
01159 {
01160     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>  pti = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01161     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdi;
01162 
01163     <span class="keywordflow">if</span> (pti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01164         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01165 
01166     pdi = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>;
01167 
01168     <span class="keywordflow">return</span> pdi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> : pdi-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o13">spwndMessage</a>;
01169 }
01170 
01171 <span class="comment">/**************************************************************************\</span>
01172 <span class="comment">* TestWindowProcess</span>
01173 <span class="comment">*</span>
01174 <span class="comment">* History:</span>
01175 <span class="comment">* 14-Nov-1994 JimA      Created.</span>
01176 <span class="comment">\**************************************************************************/</span>
01177 
<a name="l01178"></a><a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a16">01178</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a16">TestWindowProcess</a>(
01179     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
01180 {
01181     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>() == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;ppi);
01182 }
01183 
01184 <span class="comment">/***************************************************************************\</span>
01185 <span class="comment">* ValidateDepth</span>
01186 <span class="comment">*</span>
01187 <span class="comment">* The function conveniently simulates recursion by utilizing the fact</span>
01188 <span class="comment">* that from any sibling in the Next chain we can correctly get to the</span>
01189 <span class="comment">* parent window and that two siblings in the Next chain cannot have</span>
01190 <span class="comment">* different parents.</span>
01191 <span class="comment">*</span>
01192 <span class="comment">* 12-Mar-1997   vadimg      created</span>
01193 <span class="comment">\***************************************************************************/</span>
01194 
<a name="l01195"></a><a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a1">01195</a> <span class="preprocessor">#define NESTED_WINDOW_LIMIT 100</span>
01196 <span class="preprocessor"></span>
<a name="l01197"></a><a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a17">01197</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a17">ValidateParentDepth</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndParent)
01198 {
01199     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cDepth = 1, cDepthMax;
01200     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndStop;
01201 
01202     <span class="comment">/*</span>
01203 <span class="comment">     * Calculate the depth of the parent chain.</span>
01204 <span class="comment">     */</span>
01205     <span class="keywordflow">while</span> (pwndParent != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01206         pwndParent = pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
01207         cDepth++;
01208     }
01209 
01210     cDepthMax = cDepth;
01211 
01212     <span class="comment">/*</span>
01213 <span class="comment">     * When pwnd is NULL, it means that we want to add one more</span>
01214 <span class="comment">     * level to the existing depth of pwndParent.</span>
01215 <span class="comment">     */</span>
01216     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01217         <span class="keywordflow">goto</span> Exit;
01218     } <span class="keywordflow">else</span> {
01219         pwndStop = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
01220     }
01221 
01222 Restart:
01223     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01224         pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
01225         cDepth++;
01226     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01227         pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
01228     } <span class="keywordflow">else</span> {
01229         <span class="keywordflow">if</span> (cDepth &gt; cDepthMax) {
01230             cDepthMax = cDepth;
01231         }
01232 
01233         <span class="comment">/*</span>
01234 <span class="comment">         * Find a parent with siblings and recurse on them. Terminate</span>
01235 <span class="comment">         * when we reach the parent of the original pwnd.</span>
01236 <span class="comment">         */</span>
01237         <span class="keywordflow">do</span> {
01238             pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
01239             cDepth--;
01240 
01241             <span class="keywordflow">if</span> (pwnd == pwndStop)
01242                 <span class="keywordflow">goto</span> Exit;
01243 
01244         } <span class="keywordflow">while</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01245 
01246         pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
01247     }
01248     <span class="keywordflow">goto</span> Restart;
01249 
01250 Exit:
01251     <span class="keywordflow">return</span> (cDepthMax &lt;= <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a1">NESTED_WINDOW_LIMIT</a>);
01252 }
01253 
01254 <span class="comment">/***************************************************************************\</span>
01255 <span class="comment">* ValidateOwnerDepth</span>
01256 <span class="comment">*</span>
01257 <span class="comment">* pwndOwner is the new intended owner, we basically add 1 to the current</span>
01258 <span class="comment">* nested owner chain depth. We assume that the actual window does not have</span>
01259 <span class="comment">* any ownees. In reality, it can through SetWindowLong, but finding the</span>
01260 <span class="comment">* maximum depth of the ownee chain is really tricky - just look in swp.c.</span>
01261 <span class="comment">*</span>
01262 <span class="comment">* 12-Mar-1997   vadimg      created</span>
01263 <span class="comment">\***************************************************************************/</span>
01264 
<a name="l01265"></a><a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a18">01265</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a18">ValidateOwnerDepth</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndOwner)
01266 {
01267     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cDepth = 1;
01268 
01269     <span class="keywordflow">while</span> (pwndOwner != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01270 
01271         <span class="comment">/*</span>
01272 <span class="comment">         * Do not allow loops in the owner chain.</span>
01273 <span class="comment">         */</span>
01274         <span class="keywordflow">if</span> (pwndOwner == pwnd) {
01275             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01276         }
01277 
01278         pwndOwner = pwndOwner-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>;
01279         cDepth++;
01280     }
01281 
01282     <span class="keywordflow">return</span> (cDepth &lt;= <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a1">NESTED_WINDOW_LIMIT</a>);
01283 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:25 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
