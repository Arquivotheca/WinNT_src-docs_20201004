<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: profman.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>profman.c</h1><a href="../../d9/d7/profman_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************Module*Header******************************\</span>
00002 <span class="comment">* Module Name: PROFMAN.C</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Module Descripton: Profile management functions.</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Warnings:</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* Issues:</span>
00009 <span class="comment">*</span>
00010 <span class="comment">* Public Routines:</span>
00011 <span class="comment">*</span>
00012 <span class="comment">* Created: 5 Nov 1996</span>
00013 <span class="comment">*</span>
00014 <span class="comment">* Author:   Srinivasan Chandrasekar    [srinivac]</span>
00015 <span class="comment">*</span>
00016 <span class="comment">* Copyright (c) 1996, 1997  Microsoft Corporation</span>
00017 <span class="comment">\***********************************************************************/</span>
00018 
00019 <span class="preprocessor">#include "<a class="code" href="../../d3/d4/mscms_8h.html">mscms.h</a>"</span>
00020 <span class="preprocessor">#include "objbase.h"</span>
00021 <span class="preprocessor">#include "initguid.h"</span>
00022 <span class="preprocessor">#include "devguid.h"</span>
00023 <span class="preprocessor">#include "<a class="code" href="../../d4/d6/sti_8h.html">sti.h</a>"</span>
00024 
<a name="l00025"></a><a class="code" href="../../d9/d7/profman_8c.html#a0">00025</a> <span class="preprocessor">#define TAG_DEVICESETTINGS      'devs'</span>
<a name="l00026"></a><a class="code" href="../../d9/d7/profman_8c.html#a1">00026</a> <span class="preprocessor"></span><span class="preprocessor">#define TAG_MS01                'MS01'</span>
<a name="l00027"></a><a class="code" href="../../d9/d7/profman_8c.html#a2">00027</a> <span class="preprocessor"></span><span class="preprocessor">#define TAG_MS02                'MS02'</span>
<a name="l00028"></a><a class="code" href="../../d9/d7/profman_8c.html#a3">00028</a> <span class="preprocessor"></span><span class="preprocessor">#define TAG_MS03                'MS03'</span>
00029 <span class="preprocessor"></span>
<a name="l00030"></a><a class="code" href="../../d9/d7/profman_8c.html#a4">00030</a> <span class="preprocessor">#define ID_MSFT_REVERSED        'tfsm'</span>
<a name="l00031"></a><a class="code" href="../../d9/d7/profman_8c.html#a5">00031</a> <span class="preprocessor"></span><span class="preprocessor">#define ID_MEDIATYPE_REVERSED   'aidm'</span>
<a name="l00032"></a><a class="code" href="../../d9/d7/profman_8c.html#a6">00032</a> <span class="preprocessor"></span><span class="preprocessor">#define ID_DITHER_REVERSED      'ntfh'</span>
<a name="l00033"></a><a class="code" href="../../d9/d7/profman_8c.html#a7">00033</a> <span class="preprocessor"></span><span class="preprocessor">#define ID_RESLN_REVERSED       'nlsr'</span>
00034 <span class="preprocessor"></span>
<a name="l00035"></a><a class="code" href="../../d9/d7/profman_8c.html#a8">00035</a> <span class="preprocessor">#define DEVICE_PROFILE_DATA      1</span>
<a name="l00036"></a><a class="code" href="../../d9/d7/profman_8c.html#a9">00036</a> <span class="preprocessor"></span><span class="preprocessor">#define DEVICE_PROFILE_ENUMMODE  2</span>
00037 <span class="preprocessor"></span>
00038 <span class="comment">//</span>
00039 <span class="comment">// Local types</span>
00040 <span class="comment">//</span>
00041 
<a name="l00042"></a><a class="code" href="../../d9/d7/profman_8c.html#a99">00042</a> <span class="keyword">typedef</span> <span class="keyword">enum</span> {
00043     <a class="code" href="../../d9/d7/profman_8c.html#a99a40">NOMATCH</a>     = 0,
00044     <a class="code" href="../../d9/d7/profman_8c.html#a99a41">MATCH</a>       = 1,
00045     <a class="code" href="../../d0/d3/dsocode_8c.html#a1">EXACT_MATCH</a> = 2,
00046 } <a class="code" href="../../d9/d7/profman_8c.html#a99">MATCHTYPE</a>;
00047 
00048 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d2/d5/structtagREGDATA.html">tagREGDATA</a> {
<a name="l00049"></a><a class="code" href="../../d2/d5/structtagREGDATA.html#o0">00049</a>     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d2/d5/structtagREGDATA.html#o0">dwRefCount</a>;
<a name="l00050"></a><a class="code" href="../../d2/d5/structtagREGDATA.html#o1">00050</a>     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d2/d5/structtagREGDATA.html#o1">dwManuID</a>;
<a name="l00051"></a><a class="code" href="../../d2/d5/structtagREGDATA.html#o2">00051</a>     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d2/d5/structtagREGDATA.html#o2">dwModelID</a>;
00052 } <a class="code" href="../../d2/d5/structtagREGDATA.html">REGDATA</a>, *<a class="code" href="../../d2/d5/structtagREGDATA.html">PREGDATA</a>;
00053 
<a name="l00054"></a><a class="code" href="../../d8/d5/structtagSCANNERDATA.html">00054</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d8/d5/structtagSCANNERDATA.html">tagSCANNERDATA</a> {
<a name="l00055"></a><a class="code" href="../../d8/d5/structtagSCANNERDATA.html#o0">00055</a>     PWSTR     <a class="code" href="../../d8/d5/structtagSCANNERDATA.html#o0">pDeviceName</a>;
<a name="l00056"></a><a class="code" href="../../d8/d5/structtagSCANNERDATA.html#o1">00056</a>     HINSTANCE <a class="code" href="../../d8/d5/structtagSCANNERDATA.html#o1">hModule</a>;
<a name="l00057"></a><a class="code" href="../../d8/d5/structtagSCANNERDATA.html#o2">00057</a>     <a class="code" href="../../d4/d6/sti_8h.html#a123">PSTI</a>      <a class="code" href="../../d8/d5/structtagSCANNERDATA.html#o2">pSti</a>;
00058 } <a class="code" href="../../d8/d5/structtagSCANNERDATA.html">SCANNERDATA</a>, *<a class="code" href="../../d8/d5/structtagSCANNERDATA.html">PSCANNERDATA</a>;
00059 
<a name="l00060"></a><a class="code" href="../../d9/d7/profman_8c.html#a22">00060</a> <span class="keyword">typedef</span> <a class="code" href="../../d0/d5/perfuser_8c.html#a20">BOOL</a>  (WINAPI *<a class="code" href="../../d9/d7/profman_8c.html#a22">PFNOPENDEVICE</a>)(PTSTR, LPHANDLE, PTSTR);
<a name="l00061"></a><a class="code" href="../../d9/d7/profman_8c.html#a23">00061</a> <span class="keyword">typedef</span> <a class="code" href="../../d0/d5/perfuser_8c.html#a20">BOOL</a>  (WINAPI *<a class="code" href="../../d9/d7/profman_8c.html#a23">PFNCLOSEDEVICE</a>)(HANDLE);
<a name="l00062"></a><a class="code" href="../../d9/d7/profman_8c.html#a24">00062</a> <span class="keyword">typedef</span> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> (WINAPI *<a class="code" href="../../d9/d7/profman_8c.html#a24">PFNGETDEVICEDATA</a>)(HANDLE, PTSTR, PTSTR, PDWORD, <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>, <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, PDWORD);
<a name="l00063"></a><a class="code" href="../../d9/d7/profman_8c.html#a25">00063</a> <span class="keyword">typedef</span> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> (WINAPI *<a class="code" href="../../d9/d7/profman_8c.html#a25">PFNSETDEVICEDATA</a>)(HANDLE, PTSTR, PTSTR, <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>, <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
<a name="l00064"></a><a class="code" href="../../d9/d7/profman_8c.html#a26">00064</a> <span class="keyword">typedef</span> HRESULT (__stdcall *PFNSTICREATEINSTANCE)(HINSTANCE, <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, <a class="code" href="../../d4/d6/sti_8h.html#a123">PSTI</a>*, LPDWORD);
00065 
00066 <span class="comment">//</span>
00067 <span class="comment">// Local functions</span>
00068 <span class="comment">//</span>
00069 
00070 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  <a class="code" href="../../d9/d7/profman_8c.html#a43">InternalGetColorDirectory</a>(LPCTSTR, PTSTR, DWORD*);
00071 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  <a class="code" href="../../d9/d7/profman_8c.html#a44">InternalInstallColorProfile</a>(LPCTSTR, LPCTSTR);
00072 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  <a class="code" href="../../d9/d7/profman_8c.html#a45">InternalUninstallColorProfile</a>(LPCTSTR, LPCTSTR, BOOL);
00073 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  <a class="code" href="../../d9/d7/profman_8c.html#a46">InternalAssociateColorProfileWithDevice</a>(LPCTSTR, LPCTSTR, LPCTSTR);
00074 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  <a class="code" href="../../d9/d7/profman_8c.html#a47">InternalDisassociateColorProfileFromDevice</a>(LPCTSTR, LPCTSTR, LPCTSTR);
00075 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  <a class="code" href="../../d9/d7/profman_8c.html#a48">InternalEnumColorProfiles</a>(LPCTSTR, PENUMTYPE, PBYTE, PDWORD, PDWORD);
00076 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  <a class="code" href="../../d9/d7/profman_8c.html#a49">InternalSetSCSProfile</a>(LPCTSTR, DWORD, LPCTSTR);
00077 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  <a class="code" href="../../d9/d7/profman_8c.html#a50">InternalGetSCSProfile</a>(LPCTSTR, DWORD, PTSTR, PDWORD);
00078 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>  <a class="code" href="../../d9/d7/profman_8c.html#a51">ConvertDwordToString</a>(DWORD, PTSTR);
00079 PTSTR <a class="code" href="../../d9/d7/profman_8c.html#a52">ConvertClassIdToClassString</a>(DWORD);
00080 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  <a class="code" href="../../d9/d7/profman_8c.html#a53">GetProfileClassString</a>(LPCTSTR, PTSTR, PPROFILEHEADER);
00081 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  <a class="code" href="../../d9/d7/profman_8c.html#a54">GetDeviceData</a>(LPCTSTR, DWORD, DWORD, PVOID*, PDWORD, BOOL);
00082 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  <a class="code" href="../../d9/d7/profman_8c.html#a55">SetDeviceData</a>(LPCTSTR, DWORD, DWORD, PVOID, DWORD);
00083 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  <a class="code" href="../../d9/d7/profman_8c.html#a56">IGetDeviceData</a>(LPCTSTR, DWORD, DWORD, PVOID*, PDWORD, BOOL);
00084 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  <a class="code" href="../../d9/d7/profman_8c.html#a57">ISetDeviceData</a>(LPCTSTR, DWORD, DWORD, PVOID, DWORD);
00085 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  <a class="code" href="../../d9/d7/profman_8c.html#a58">IsStringInMultiSz</a>(PTSTR, PTSTR);
00086 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d9/d7/profman_8c.html#a59">RemoveStringFromMultiSz</a>(PTSTR, PTSTR, DWORD);
00087 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>  <a class="code" href="../../d9/d7/profman_8c.html#a60">InsertInBuffer</a>(PBYTE, PBYTE, PTSTR);
00088 <a class="code" href="../../d9/d7/profman_8c.html#a99">MATCHTYPE</a> <a class="code" href="../../d9/d7/profman_8c.html#a61">DoesProfileMatchEnumRecord</a>(PTSTR, PENUMTYPE);
00089 <a class="code" href="../../d9/d7/profman_8c.html#a99">MATCHTYPE</a> <a class="code" href="../../d9/d7/profman_8c.html#a62">CheckResMedHftnMatch</a>(HPROFILE, PENUMTYPE);
00090 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  <a class="code" href="../../d9/d7/profman_8c.html#a63">DwordMatches</a>(PSETTINGS, DWORD);
00091 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  <a class="code" href="../../d9/d7/profman_8c.html#a64">QwordMatches</a>(PSETTINGS, PDWORD);
00092 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI <a class="code" href="../../d9/d7/profman_8c.html#a65">OpenPrtr</a>(PTSTR, LPHANDLE, PTSTR);
00093 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI <a class="code" href="../../d9/d7/profman_8c.html#a66">ClosePrtr</a>(HANDLE);
00094 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI <a class="code" href="../../d9/d7/profman_8c.html#a67">GetPrtrData</a>(HANDLE, PTSTR, PTSTR, PDWORD, PBYTE, DWORD, PDWORD);
00095 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI <a class="code" href="../../d9/d7/profman_8c.html#a68">SetPrtrData</a>(HANDLE, PTSTR, PTSTR, DWORD, PBYTE, DWORD);
00096 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI <a class="code" href="../../d9/d7/profman_8c.html#a69">OpenMonitor</a>(PTSTR, LPHANDLE, PTSTR);
00097 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI <a class="code" href="../../d9/d7/profman_8c.html#a70">CloseMonitor</a>(HANDLE);
00098 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI <a class="code" href="../../d9/d7/profman_8c.html#a71">GetMonitorData</a>(HANDLE, PTSTR, PTSTR, PDWORD, PBYTE, DWORD, PDWORD);
00099 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI <a class="code" href="../../d8/d8/fullscr_8c.html#a15">SetMonitorData</a>(HANDLE, PTSTR, PTSTR, DWORD, PBYTE, DWORD);
00100 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI <a class="code" href="../../d9/d7/profman_8c.html#a73">OpenScanner</a>(PTSTR, LPHANDLE, PTSTR);
00101 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI <a class="code" href="../../d9/d7/profman_8c.html#a74">CloseScanner</a>(HANDLE);
00102 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI <a class="code" href="../../d9/d7/profman_8c.html#a75">GetScannerData</a>(HANDLE, PTSTR, PTSTR, PDWORD, PBYTE, DWORD, PDWORD);
00103 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI <a class="code" href="../../d9/d7/profman_8c.html#a76">SetScannerData</a>(HANDLE, PTSTR, PTSTR, DWORD, PBYTE, DWORD);
00104 <span class="preprocessor">#ifdef _WIN95_</span>
00105 <span class="preprocessor"></span><a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  LoadSetupAPIDll(VOID);
00106 <span class="preprocessor">#else</span>
00107 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>  <a class="code" href="../../d9/d7/profman_8c.html#a77">ChangeICMSetting</a>(LPCTSTR, LPCTSTR, DWORD);
00108 <span class="preprocessor">#endif // _WIN95_</span>
00109 <span class="preprocessor"></span>
00110 <span class="comment">//</span>
00111 <span class="comment">// SetupAPI function pointers</span>
00112 <span class="comment">//</span>
00113 <span class="keyword">typedef</span> WINSETUPAPI HKEY
<a name="l00114"></a><a class="code" href="../../d9/d7/profman_8c.html#a27">00114</a> (WINAPI *<a class="code" href="../../d9/d7/profman_8c.html#a27">FP_SetupDiOpenDevRegKey</a>)(
00115     IN HDEVINFO         DeviceInfoSet,
00116     IN PSP_DEVINFO_DATA DeviceInfoData,
00117     IN <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>            Scope,
00118     IN <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>            HwProfile,
00119     IN <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>            KeyType,
00120     IN REGSAM           samDesired
00121 );
00122 
00123 <span class="keyword">typedef</span> WINSETUPAPI <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00124"></a><a class="code" href="../../d9/d7/profman_8c.html#a28">00124</a> (WINAPI *<a class="code" href="../../d9/d7/profman_8c.html#a28">FP_SetupDiDestroyDeviceInfoList</a>)(
00125     IN HDEVINFO DeviceInfoSet
00126 );
00127 
00128 <span class="keyword">typedef</span> WINSETUPAPI <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00129"></a><a class="code" href="../../d9/d7/profman_8c.html#a29">00129</a> (WINAPI *<a class="code" href="../../d9/d7/profman_8c.html#a29">FP_SetupDiEnumDeviceInfo</a>)(
00130     IN  HDEVINFO         DeviceInfoSet,
00131     IN  <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>            MemberIndex,
00132     OUT PSP_DEVINFO_DATA DeviceInfoData
00133 );
00134 
00135 <span class="preprocessor">#if !defined(_WIN95_)</span>
00136 <span class="preprocessor"></span><span class="keyword">typedef</span> WINSETUPAPI <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00137"></a><a class="code" href="../../d9/d7/profman_8c.html#a30">00137</a> (WINAPI *<a class="code" href="../../d9/d7/profman_8c.html#a30">FP_SetupDiGetDeviceInstanceId</a>)(
00138     IN  HDEVINFO         DeviceInfoSet,
00139     IN  PSP_DEVINFO_DATA DeviceInfoData,
00140     OUT PWSTR            DeviceInstanceId,
00141     IN  <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>            DeviceInstanceIdSize,
00142     OUT PDWORD           RequiredSize          OPTIONAL
00143 );
00144 
00145 <span class="keyword">typedef</span> WINSETUPAPI HDEVINFO
<a name="l00146"></a><a class="code" href="../../d9/d7/profman_8c.html#a31">00146</a> (WINAPI *<a class="code" href="../../d9/d7/profman_8c.html#a31">FP_SetupDiGetClassDevs</a>)(
00147     IN LPGUID ClassGuid,  OPTIONAL
00148     IN PCWSTR Enumerator, OPTIONAL
00149     IN HWND   hwndParent, OPTIONAL
00150     IN <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  Flags
00151 );
00152 <span class="preprocessor">#else</span>
00153 <span class="preprocessor"></span><span class="keyword">typedef</span> WINSETUPAPI <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00154 (WINAPI *<a class="code" href="../../d9/d7/profman_8c.html#a30">FP_SetupDiGetDeviceInstanceId</a>)(
00155     IN  HDEVINFO         DeviceInfoSet,
00156     IN  PSP_DEVINFO_DATA DeviceInfoData,
00157     OUT PSTR             DeviceInstanceId,
00158     IN  <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>            DeviceInstanceIdSize,
00159     OUT PDWORD           RequiredSize          OPTIONAL
00160 );
00161 
00162 <span class="keyword">typedef</span> WINSETUPAPI HDEVINFO
00163 (WINAPI *<a class="code" href="../../d9/d7/profman_8c.html#a31">FP_SetupDiGetClassDevs</a>)(
00164     IN LPGUID ClassGuid,  OPTIONAL
00165     IN PCSTR  Enumerator, OPTIONAL
00166     IN HWND   hwndParent, OPTIONAL
00167     IN <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  Flags
00168 );
00169 <span class="preprocessor">#endif</span>
00170 <span class="preprocessor"></span>
<a name="l00171"></a><a class="code" href="../../d9/d7/profman_8c.html#a32">00171</a> HMODULE <a class="code" href="../../d9/d7/profman_8c.html#a32">ghModSetupAPIDll</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00172 
<a name="l00173"></a><a class="code" href="../../d9/d7/profman_8c.html#a33">00173</a> <a class="code" href="../../d9/d7/profman_8c.html#a27">FP_SetupDiOpenDevRegKey</a>         <a class="code" href="../../d9/d7/profman_8c.html#a33">fpSetupDiOpenDevRegKey</a>         = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
<a name="l00174"></a><a class="code" href="../../d9/d7/profman_8c.html#a34">00174</a> <a class="code" href="../../d9/d7/profman_8c.html#a28">FP_SetupDiDestroyDeviceInfoList</a> <a class="code" href="../../d9/d7/profman_8c.html#a34">fpSetupDiDestroyDeviceInfoList</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
<a name="l00175"></a><a class="code" href="../../d9/d7/profman_8c.html#a35">00175</a> <a class="code" href="../../d9/d7/profman_8c.html#a29">FP_SetupDiEnumDeviceInfo</a>        <a class="code" href="../../d9/d7/profman_8c.html#a35">fpSetupDiEnumDeviceInfo</a>        = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
<a name="l00176"></a><a class="code" href="../../d9/d7/profman_8c.html#a36">00176</a> <a class="code" href="../../d9/d7/profman_8c.html#a30">FP_SetupDiGetDeviceInstanceId</a>   <a class="code" href="../../d9/d7/profman_8c.html#a36">fpSetupDiGetDeviceInstanceId</a>   = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
<a name="l00177"></a><a class="code" href="../../d9/d7/profman_8c.html#a37">00177</a> <a class="code" href="../../d9/d7/profman_8c.html#a31">FP_SetupDiGetClassDevs</a>          <a class="code" href="../../d9/d7/profman_8c.html#a37">fpSetupDiGetClassDevs</a>          = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00178 
00179 <span class="comment">//</span>
00180 <span class="comment">// Predefined profiles in order - INF file has 1-based index into this list</span>
00181 <span class="comment">//</span>
00182 
<a name="l00183"></a><a class="code" href="../../d9/d7/profman_8c.html#a38">00183</a> TCHAR  *<a class="code" href="../../d9/d7/profman_8c.html#a38">gszDispProfiles</a>[] = {
00184     __TEXT(<span class="stringliteral">"mnB22G15.icm"</span>),                         <span class="comment">// 1</span>
00185     __TEXT(<span class="stringliteral">"mnB22G18.icm"</span>),                         <span class="comment">// 2</span>
00186     __TEXT(<span class="stringliteral">"mnB22G21.icm"</span>),                         <span class="comment">// 3</span>
00187     __TEXT(<span class="stringliteral">"mnEBUG15.icm"</span>),                         <span class="comment">// 4</span>
00188     __TEXT(<span class="stringliteral">"mnEBUG18.icm"</span>),                         <span class="comment">// 5</span>
00189     __TEXT(<span class="stringliteral">"mnEBUG21.icm"</span>),                         <span class="comment">// 6</span>
00190     __TEXT(<span class="stringliteral">"mnP22G15.icm"</span>),                         <span class="comment">// 7</span>
00191     __TEXT(<span class="stringliteral">"mnP22G18.icm"</span>),                         <span class="comment">// 8</span>
00192     __TEXT(<span class="stringliteral">"mnP22G21.icm"</span>),                         <span class="comment">// 9</span>
00193     __TEXT(<span class="stringliteral">"Diamond Compatible 9300K G2.2.icm"</span>),    <span class="comment">// 10</span>
00194     __TEXT(<span class="stringliteral">"Hitachi Compatible 9300K G2.2.icm"</span>),    <span class="comment">// 11</span>
00195     __TEXT(<span class="stringliteral">"NEC Compatible 9300K G2.2.icm"</span>),        <span class="comment">// 12</span>
00196     __TEXT(<span class="stringliteral">"Trinitron Compatible 9300K G2.2.icm"</span>),  <span class="comment">// 13</span>
00197     };
00198 
<a name="l00199"></a><a class="code" href="../../d9/d7/profman_8c.html#a39">00199</a> TCHAR  *<a class="code" href="../../d9/d7/profman_8c.html#a39">gpszClasses</a>[] = {  <span class="comment">// different profile classes</span>
00200     __TEXT(<span class="stringliteral">"mntr"</span>),                                 <span class="comment">// 0</span>
00201     __TEXT(<span class="stringliteral">"prtr"</span>),                                 <span class="comment">// 1</span>
00202     __TEXT(<span class="stringliteral">"scnr"</span>),                                 <span class="comment">// 2</span>
00203     __TEXT(<span class="stringliteral">"link"</span>),                                 <span class="comment">// 3</span>
00204     __TEXT(<span class="stringliteral">"abst"</span>),                                 <span class="comment">// 4</span>
00205     __TEXT(<span class="stringliteral">"spac"</span>),                                 <span class="comment">// 5</span>
00206     __TEXT(<span class="stringliteral">"nmcl"</span>)                                  <span class="comment">// 6</span>
00207     };
00208 
<a name="l00209"></a><a class="code" href="../../d9/d7/profman_8c.html#a10">00209</a> <span class="preprocessor">#define INDEX_CLASS_MONITOR     0</span>
<a name="l00210"></a><a class="code" href="../../d9/d7/profman_8c.html#a11">00210</a> <span class="preprocessor"></span><span class="preprocessor">#define INDEX_CLASS_PRINTER     1</span>
<a name="l00211"></a><a class="code" href="../../d9/d7/profman_8c.html#a12">00211</a> <span class="preprocessor"></span><span class="preprocessor">#define INDEX_CLASS_SCANNER     2</span>
<a name="l00212"></a><a class="code" href="../../d9/d7/profman_8c.html#a13">00212</a> <span class="preprocessor"></span><span class="preprocessor">#define INDEX_CLASS_LINK        3</span>
<a name="l00213"></a><a class="code" href="../../d9/d7/profman_8c.html#a14">00213</a> <span class="preprocessor"></span><span class="preprocessor">#define INDEX_CLASS_ABSTRACT    4</span>
<a name="l00214"></a><a class="code" href="../../d9/d7/profman_8c.html#a15">00214</a> <span class="preprocessor"></span><span class="preprocessor">#define INDEX_CLASS_COLORSPACE  5</span>
<a name="l00215"></a><a class="code" href="../../d9/d7/profman_8c.html#a16">00215</a> <span class="preprocessor"></span><span class="preprocessor">#define INDEX_CLASS_NAMED       6</span>
00216 <span class="preprocessor"></span>
00217 <span class="comment">/******************************************************************************</span>
00218 <span class="comment"> *</span>
00219 <span class="comment"> *                            GetColorDirectory</span>
00220 <span class="comment"> *</span>
00221 <span class="comment"> *  Function:</span>
00222 <span class="comment"> *       These are the ANSI &amp; Unicode wrappers for InternalGetColorDirectory.</span>
00223 <span class="comment"> *       Please see InternalGetColorDirectory for more details on this</span>
00224 <span class="comment"> *       function.</span>
00225 <span class="comment"> *</span>
00226 <span class="comment"> *  Arguments:</span>
00227 <span class="comment"> *       pMachineName    - name identifying machine on which the path</span>
00228 <span class="comment"> *                         to the color directory is requested</span>
00229 <span class="comment"> *       pBuffer         - pointer to buffer to receive pathname</span>
00230 <span class="comment"> *       pdwSize         - pointer to size of buffer. On return it has size of</span>
00231 <span class="comment"> *                         buffer needed if failure, and used on success</span>
00232 <span class="comment"> *</span>
00233 <span class="comment"> *  Returns:</span>
00234 <span class="comment"> *       TRUE if successful, NULL otherwise</span>
00235 <span class="comment"> *</span>
00236 <span class="comment"> ******************************************************************************/</span>
00237 
00238 <span class="preprocessor">#ifdef UNICODE          // Windows NT versions</span>
00239 <span class="preprocessor"></span>
00240 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI
00241 <a class="code" href="../../d9/d7/profman_8c.html#a78">GetColorDirectoryA</a>(
00242     PCSTR   pMachineName,
00243     PSTR    pBuffer,
00244     PDWORD  pdwSize
00245     )
00246 {
00247     PWSTR pwszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;   <span class="comment">// Unicode machine name</span>
00248     PWSTR pwBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;          <span class="comment">// Unicode color directory path</span>
00249     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSize;                   <span class="comment">// size of Unicode buffer</span>
00250     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwErr = 0;                <span class="comment">// error code</span>
00251     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;                <span class="comment">// return code</span>
00252 
00253     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"GetColorDirectoryA\n"</span>)));
00254 
00255     <span class="comment">//</span>
00256     <span class="comment">// Validate parameters before we touch them</span>
00257     <span class="comment">//</span>
00258 
00259     <span class="keywordflow">if</span> (!pdwSize ||
00260         IsBadWritePtr(pdwSize, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)) ||
00261         (pBuffer &amp;&amp; IsBadWritePtr(pBuffer, *pdwSize)))
00262     {
00263         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to GetColorDirectory\n"</span>)));
00264         SetLastError(ERROR_INVALID_PARAMETER);
00265         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00266     }
00267 
00268     <span class="comment">//</span>
00269     <span class="comment">// Convert machine name to Unicode</span>
00270     <span class="comment">//</span>
00271 
00272     <span class="keywordflow">if</span> (pMachineName)
00273     {
00274         rc = <a class="code" href="../../d2/d1/object_8c.html#a11">ConvertToUnicode</a>(pMachineName, &amp;pwszMachineName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00275     }
00276     <span class="keywordflow">else</span>
00277         pwszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00278 
00279     dwSize = *pdwSize * <span class="keyword">sizeof</span>(WCHAR);
00280 
00281     <span class="comment">//</span>
00282     <span class="comment">// Create a buffer to get Unicode directory from system</span>
00283     <span class="comment">//</span>
00284 
00285     <span class="keywordflow">if</span> (pBuffer &amp;&amp; dwSize)
00286     {
00287         pwBuffer = (PWSTR)<a class="code" href="../../d2/d1/object_8c.html#a7">MemAlloc</a>(dwSize);
00288         <span class="keywordflow">if</span> (! pwBuffer)
00289         {
00290             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error allocating memory for Unicode string\n"</span>)));
00291             SetLastError(ERROR_NOT_ENOUGH_MEMORY);
00292             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00293             <span class="keywordflow">goto</span> EndGetColorDirectoryA;
00294         }
00295     }
00296 
00297     rc = rc &amp;&amp; <a class="code" href="../../d9/d7/profman_8c.html#a43">InternalGetColorDirectory</a>(pwszMachineName, pwBuffer, &amp;dwSize);
00298 
00299     *pdwSize = dwSize / <span class="keyword">sizeof</span>(WCHAR);
00300 
00301     <span class="comment">//</span>
00302     <span class="comment">// Convert Unicode path to Ansi</span>
00303     <span class="comment">//</span>
00304 
00305     <span class="keywordflow">if</span> (pwBuffer)
00306     {
00307         rc = rc &amp;&amp; <a class="code" href="../../d2/d1/object_8c.html#a12">ConvertToAnsi</a>(pwBuffer, &amp;pBuffer, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00308     }
00309 
00310 EndGetColorDirectoryA:
00311     <span class="keywordflow">if</span> (pwszMachineName)
00312     {
00313         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pwszMachineName);
00314     }
00315 
00316     <span class="keywordflow">if</span> (pwBuffer)
00317     {
00318         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pwBuffer);
00319     }
00320 
00321     <span class="keywordflow">return</span> rc;
00322 }
00323 
00324 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI
00325 <a class="code" href="../../d9/d7/profman_8c.html#a79">GetColorDirectoryW</a>(
00326     PCWSTR   pMachineName,
00327     PWSTR    pBuffer,
00328     PDWORD   pdwSize
00329     )
00330 {
00331     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"GetColorDirectoryW\n"</span>)));
00332 
00333     <span class="comment">//</span>
00334     <span class="comment">// Internal function is ANSI in Windows 95, call it directly.</span>
00335     <span class="comment">//</span>
00336 
00337     <span class="keywordflow">return</span> <a class="code" href="../../d9/d7/profman_8c.html#a43">InternalGetColorDirectory</a>(pMachineName, pBuffer, pdwSize);
00338 }
00339 
00340 <span class="preprocessor">#else                           // Windows 95 versions</span>
00341 <span class="preprocessor"></span>
00342 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI
<a name="l00343"></a><a class="code" href="../../d9/d7/profman_8c.html#a78">00343</a> <a class="code" href="../../d9/d7/profman_8c.html#a78">GetColorDirectoryA</a>(
00344     PCSTR   pMachineName,
00345     PSTR    pBuffer,
00346     PDWORD  pdwSize
00347     )
00348 {
00349     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"GetColorDirectoryA\n"</span>)));
00350 
00351     <span class="comment">//</span>
00352     <span class="comment">// Internal function is ANSI in Windows 95, call it directly.</span>
00353     <span class="comment">//</span>
00354 
00355     <span class="keywordflow">return</span> <a class="code" href="../../d9/d7/profman_8c.html#a43">InternalGetColorDirectory</a>(pMachineName, pBuffer, pdwSize);
00356 }
00357 
00358 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI
<a name="l00359"></a><a class="code" href="../../d9/d7/profman_8c.html#a79">00359</a> <a class="code" href="../../d9/d7/profman_8c.html#a79">GetColorDirectoryW</a>(
00360     PCWSTR   pMachineName,
00361     PWSTR    pBuffer,
00362     PDWORD   pdwSize
00363     )
00364 {
00365     PSTR pszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;     <span class="comment">// Ansi machine name</span>
00366     PSTR pszBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;          <span class="comment">// Ansi color directory path</span>
00367     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSize;                   <span class="comment">// size of Ansi buffer</span>
00368     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;                <span class="comment">// return code</span>
00369 
00370     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"GetColorDirectoryW\n"</span>)));
00371 
00372     <span class="comment">//</span>
00373     <span class="comment">// Validate parameters before we touch them</span>
00374     <span class="comment">//</span>
00375 
00376     <span class="keywordflow">if</span> (!pdwSize ||
00377         IsBadWritePtr(pdwSize, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)) ||
00378         (pBuffer &amp;&amp; IsBadWritePtr(pBuffer, *pdwSize)))
00379     {
00380         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to GetColorDirectory\n"</span>)));
00381         SetLastError(ERROR_INVALID_PARAMETER);
00382         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00383     }
00384 
00385     <span class="comment">//</span>
00386     <span class="comment">// Convert machine name to Ansi</span>
00387     <span class="comment">//</span>
00388 
00389     <span class="keywordflow">if</span> (pMachineName)
00390     {
00391         rc = <a class="code" href="../../d2/d1/object_8c.html#a12">ConvertToAnsi</a>(pMachineName, &amp;pszMachineName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00392     }
00393     <span class="keywordflow">else</span>
00394         pszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00395 
00396     <span class="comment">//</span>
00397     <span class="comment">// Create a buffer to get Ansi directory from system</span>
00398     <span class="comment">//</span>
00399 
00400     dwSize = *pdwSize / <span class="keyword">sizeof</span>(WCHAR);
00401 
00402     <span class="keywordflow">if</span> (pBuffer &amp;&amp; dwSize)
00403     {
00404         pszBuffer = (PSTR)<a class="code" href="../../d2/d1/object_8c.html#a7">MemAlloc</a>(dwSize);
00405         <span class="keywordflow">if</span> (! pszBuffer)
00406         {
00407             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error allocating memory for Ansi string\n"</span>)));
00408             SetLastError(ERROR_NOT_ENOUGH_MEMORY);
00409             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00410             <span class="keywordflow">goto</span> EndGetColorDirectoryW;
00411         }
00412     }
00413 
00414     rc = rc &amp;&amp; <a class="code" href="../../d9/d7/profman_8c.html#a43">InternalGetColorDirectory</a>(pszMachineName, pszBuffer, &amp;dwSize);
00415 
00416     *pdwSize = dwSize * <span class="keyword">sizeof</span>(WCHAR);
00417 
00418     <span class="comment">//</span>
00419     <span class="comment">// Convert Ansi path to Unicode</span>
00420     <span class="comment">//</span>
00421 
00422     <span class="keywordflow">if</span> (pszBuffer)
00423     {
00424         rc = rc &amp;&amp; <a class="code" href="../../d2/d1/object_8c.html#a11">ConvertToUnicode</a>(pszBuffer, &amp;pBuffer, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00425     }
00426 
00427 EndGetColorDirectoryW:
00428     <span class="keywordflow">if</span> (pszMachineName)
00429     {
00430         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pszMachineName);
00431     }
00432 
00433     <span class="keywordflow">if</span> (pszBuffer)
00434     {
00435         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pszBuffer);
00436     }
00437 
00438     <span class="keywordflow">return</span> rc;
00439 }
00440 
00441 <span class="preprocessor">#endif                          // ! UNICODE</span>
00442 <span class="preprocessor"></span>
00443 
00444 <span class="comment">/******************************************************************************</span>
00445 <span class="comment"> *</span>
00446 <span class="comment"> *                            InstallColorProfile</span>
00447 <span class="comment"> *</span>
00448 <span class="comment"> *  Function:</span>
00449 <span class="comment"> *       These are the ANSI &amp; Unicode wrappers for InternalInstallColorProfile.</span>
00450 <span class="comment"> *       Please see InternalInstallColorProfile for more details on this</span>
00451 <span class="comment"> *       function.</span>
00452 <span class="comment"> *</span>
00453 <span class="comment"> *  Arguments:</span>
00454 <span class="comment"> *       pMachineName    - name identifying machine on which the profile</span>
00455 <span class="comment"> *                         should be installed. NULL implies local</span>
00456 <span class="comment"> *       pProfileName    - pointer to filename of profile to install</span>
00457 <span class="comment"> *</span>
00458 <span class="comment"> *  Returns:</span>
00459 <span class="comment"> *       TRUE if successful, NULL otherwise</span>
00460 <span class="comment"> *</span>
00461 <span class="comment"> ******************************************************************************/</span>
00462 
00463 <span class="preprocessor">#ifdef UNICODE          // Windows NT versions</span>
00464 <span class="preprocessor"></span>
00465 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI
00466 <a class="code" href="../../d9/d7/profman_8c.html#a80">InstallColorProfileA</a>(
00467     PCSTR   pMachineName,
00468     PCSTR   pProfileName
00469     )
00470 
00471 {
00472     PWSTR pwszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;   <span class="comment">// Unicode machine name</span>
00473     PWSTR pwszProfileName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;   <span class="comment">// Unicode profile name</span>
00474     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;                <span class="comment">// return code</span>
00475 
00476     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"InstallColorProfileA\n"</span>)));
00477 
00478     <span class="comment">//</span>
00479     <span class="comment">// Validate parameters before we touch them</span>
00480     <span class="comment">//</span>
00481 
00482     <span class="keywordflow">if</span> (!pProfileName)
00483     {
00484         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to InstallColorProfile\n"</span>)));
00485         SetLastError(ERROR_INVALID_PARAMETER);
00486         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00487     }
00488 
00489     <span class="comment">//</span>
00490     <span class="comment">// Convert machine name to Unicode</span>
00491     <span class="comment">//</span>
00492 
00493     <span class="keywordflow">if</span> (pMachineName)
00494     {
00495         rc = <a class="code" href="../../d2/d1/object_8c.html#a11">ConvertToUnicode</a>(pMachineName, &amp;pwszMachineName, TRUE);
00496     }
00497     <span class="keywordflow">else</span>
00498         pwszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00499 
00500     <span class="comment">//</span>
00501     <span class="comment">// Convert profile name to Unicode</span>
00502     <span class="comment">//</span>
00503 
00504     rc = rc &amp;&amp; <a class="code" href="../../d2/d1/object_8c.html#a11">ConvertToUnicode</a>(pProfileName, &amp;pwszProfileName, TRUE);
00505 
00506     <span class="comment">//</span>
00507     <span class="comment">// Call the internal Unicode function</span>
00508     <span class="comment">//</span>
00509 
00510     rc = rc &amp;&amp; <a class="code" href="../../d9/d7/profman_8c.html#a44">InternalInstallColorProfile</a>(pwszMachineName, pwszProfileName);
00511 
00512     <span class="comment">//</span>
00513     <span class="comment">// Free memory before leaving</span>
00514     <span class="comment">//</span>
00515 
00516     <span class="keywordflow">if</span> (pwszProfileName)
00517     {
00518         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pwszProfileName);
00519     }
00520 
00521     <span class="keywordflow">if</span> (pwszMachineName)
00522     {
00523         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pwszMachineName);
00524     }
00525 
00526     <span class="keywordflow">return</span> rc;
00527 }
00528 
00529 
00530 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI
00531 <a class="code" href="../../d9/d7/profman_8c.html#a81">InstallColorProfileW</a>(
00532     PCWSTR   pMachineName,
00533     PCWSTR   pProfileName
00534     )
00535 {
00536     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"InstallColorProfileW\n"</span>)));
00537 
00538     <span class="comment">//</span>
00539     <span class="comment">// Internal function is Unicode in Windows NT, call it directly.</span>
00540     <span class="comment">//</span>
00541 
00542     <span class="keywordflow">return</span> <a class="code" href="../../d9/d7/profman_8c.html#a44">InternalInstallColorProfile</a>(pMachineName, pProfileName);
00543 }
00544 
00545 
00546 <span class="preprocessor">#else                           // Windows 95 versions</span>
00547 <span class="preprocessor"></span>
00548 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI
<a name="l00549"></a><a class="code" href="../../d9/d7/profman_8c.html#a80">00549</a> <a class="code" href="../../d9/d7/profman_8c.html#a80">InstallColorProfileA</a>(
00550     PCSTR   pMachineName,
00551     PCSTR   pProfileName
00552     )
00553 {
00554     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"InstallColorProfileA\n"</span>)));
00555 
00556     <span class="comment">//</span>
00557     <span class="comment">// Internal function is ANSI in Windows 95, call it directly.</span>
00558     <span class="comment">//</span>
00559 
00560     <span class="keywordflow">return</span> <a class="code" href="../../d9/d7/profman_8c.html#a44">InternalInstallColorProfile</a>(pMachineName, pProfileName);
00561 }
00562 
00563 
00564 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI
<a name="l00565"></a><a class="code" href="../../d9/d7/profman_8c.html#a81">00565</a> <a class="code" href="../../d9/d7/profman_8c.html#a81">InstallColorProfileW</a>(
00566     PCWSTR   pMachineName,
00567     PCWSTR   pProfileName
00568     )
00569 {
00570     PSTR  pszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;    <span class="comment">// Ansi machine name</span>
00571     PSTR  pszProfileName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;    <span class="comment">// Ansi profile name</span>
00572     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;                <span class="comment">// return code</span>
00573 
00574     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"InstallColorProfileW\n"</span>)));
00575 
00576     <span class="comment">//</span>
00577     <span class="comment">// Validate parameters before we touch them</span>
00578     <span class="comment">//</span>
00579 
00580     <span class="keywordflow">if</span> (!pProfileName)
00581     {
00582         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to InstallColorProfile\n"</span>)));
00583         SetLastError(ERROR_INVALID_PARAMETER);
00584         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00585     }
00586 
00587     <span class="comment">//</span>
00588     <span class="comment">// Convert machine name to Ansi</span>
00589     <span class="comment">//</span>
00590 
00591     <span class="keywordflow">if</span> (pMachineName)
00592     {
00593         rc = <a class="code" href="../../d2/d1/object_8c.html#a12">ConvertToAnsi</a>(pMachineName, &amp;pszMachineName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00594     }
00595     <span class="keywordflow">else</span>
00596         pszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00597 
00598     <span class="comment">//</span>
00599     <span class="comment">// Convert profile name to Ansi</span>
00600     <span class="comment">//</span>
00601 
00602     rc = rc &amp;&amp; <a class="code" href="../../d2/d1/object_8c.html#a12">ConvertToAnsi</a>(pProfileName, &amp;pszProfileName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00603 
00604     <span class="comment">//</span>
00605     <span class="comment">// Call the internal Ansi function</span>
00606     <span class="comment">//</span>
00607 
00608     rc = rc &amp;&amp; <a class="code" href="../../d9/d7/profman_8c.html#a44">InternalInstallColorProfile</a>(pszMachineName, pszProfileName);
00609 
00610     <span class="comment">//</span>
00611     <span class="comment">// Free memory before leaving</span>
00612     <span class="comment">//</span>
00613 
00614     <span class="keywordflow">if</span> (pszProfileName)
00615     {
00616         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pszProfileName);
00617     }
00618 
00619     <span class="keywordflow">if</span> (pszMachineName)
00620     {
00621         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pszMachineName);
00622     }
00623 
00624     <span class="keywordflow">return</span> rc;
00625 }
00626 
00627 
00628 <span class="preprocessor">#endif                          // ! UNICODE</span>
00629 <span class="preprocessor"></span>
00630 <span class="comment">/******************************************************************************</span>
00631 <span class="comment"> *</span>
00632 <span class="comment"> *                            UninstallColorProfile</span>
00633 <span class="comment"> *</span>
00634 <span class="comment"> *  Function:</span>
00635 <span class="comment"> *       These are the ANSI &amp; Unicode wrappers for InternalUninstallColorProfile.</span>
00636 <span class="comment"> *       Please see InternalUninstallColorProfile for more details on this</span>
00637 <span class="comment"> *       function.</span>
00638 <span class="comment"> *</span>
00639 <span class="comment"> *  Arguments:</span>
00640 <span class="comment"> *       pMachineName    - name identifying machine on which the profile</span>
00641 <span class="comment"> *                         should be uninstalled. NULL implies local</span>
00642 <span class="comment"> *       pProfileName    - pointer to filename of profile to uninstall</span>
00643 <span class="comment"> *       bDelete         - TRUE if profile should be deleted in disk</span>
00644 <span class="comment"> *</span>
00645 <span class="comment"> *  Returns:</span>
00646 <span class="comment"> *       TRUE if successful, NULL otherwise</span>
00647 <span class="comment"> *</span>
00648 <span class="comment"> ******************************************************************************/</span>
00649 
00650 <span class="preprocessor">#ifdef UNICODE          // Windows NT versions</span>
00651 <span class="preprocessor"></span>
00652 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI
00653 <a class="code" href="../../d9/d7/profman_8c.html#a82">UninstallColorProfileA</a>(
00654     PCSTR   pMachineName,
00655     PCSTR   pProfileName,
00656     BOOL    bDelete
00657     )
00658 {
00659     PWSTR pwszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;   <span class="comment">// Unicode machine name</span>
00660     PWSTR pwszProfileName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;   <span class="comment">// Unicode profile name</span>
00661     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;                <span class="comment">// return code</span>
00662 
00663     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"UninstallColorProfileA\n"</span>)));
00664 
00665     <span class="comment">//</span>
00666     <span class="comment">// Validate parameters before we touch them</span>
00667     <span class="comment">//</span>
00668 
00669     <span class="keywordflow">if</span> (!pProfileName)
00670     {
00671         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to UninstallColorProfile\n"</span>)));
00672         SetLastError(ERROR_INVALID_PARAMETER);
00673         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00674     }
00675 
00676     <span class="comment">//</span>
00677     <span class="comment">// Convert machine name to Unicode</span>
00678     <span class="comment">//</span>
00679 
00680     <span class="keywordflow">if</span> (pMachineName)
00681     {
00682         rc = <a class="code" href="../../d2/d1/object_8c.html#a11">ConvertToUnicode</a>(pMachineName, &amp;pwszMachineName, TRUE);
00683     }
00684     <span class="keywordflow">else</span>
00685         pwszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00686 
00687     <span class="comment">//</span>
00688     <span class="comment">// Convert profile name to Unicode</span>
00689     <span class="comment">//</span>
00690 
00691     rc = rc &amp;&amp; <a class="code" href="../../d2/d1/object_8c.html#a11">ConvertToUnicode</a>(pProfileName, &amp;pwszProfileName, TRUE);
00692 
00693     <span class="comment">//</span>
00694     <span class="comment">// Call the internal Unicode function</span>
00695     <span class="comment">//</span>
00696 
00697     rc = rc &amp;&amp; <a class="code" href="../../d9/d7/profman_8c.html#a45">InternalUninstallColorProfile</a>(pwszMachineName, pwszProfileName,
00698                     bDelete);
00699 
00700     <span class="comment">//</span>
00701     <span class="comment">// Free memory before leaving</span>
00702     <span class="comment">//</span>
00703 
00704     <span class="keywordflow">if</span> (pwszProfileName)
00705     {
00706         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pwszProfileName);
00707     }
00708 
00709     <span class="keywordflow">if</span> (pwszMachineName)
00710     {
00711         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pwszMachineName);
00712     }
00713 
00714     <span class="keywordflow">return</span> rc;
00715 }
00716 
00717 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI
00718 <a class="code" href="../../d9/d7/profman_8c.html#a83">UninstallColorProfileW</a>(
00719     PCWSTR   pMachineName,
00720     PCWSTR   pProfileName,
00721     BOOL     bDelete
00722     )
00723 {
00724     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"UninstallColorProfileW\n"</span>)));
00725 
00726     <span class="comment">//</span>
00727     <span class="comment">// Internal function is Unicode in Windows NT, call it directly.</span>
00728     <span class="comment">//</span>
00729 
00730     <span class="keywordflow">return</span> <a class="code" href="../../d9/d7/profman_8c.html#a45">InternalUninstallColorProfile</a>(pMachineName, pProfileName, bDelete);
00731 }
00732 
00733 
00734 <span class="preprocessor">#else                           // Windows 95 versions</span>
00735 <span class="preprocessor"></span>
00736 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI
<a name="l00737"></a><a class="code" href="../../d9/d7/profman_8c.html#a82">00737</a> <a class="code" href="../../d9/d7/profman_8c.html#a82">UninstallColorProfileA</a>(
00738     PCSTR   pMachineName,
00739     PCSTR   pProfileName,
00740     BOOL    bDelete
00741     )
00742 {
00743     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"UninstallColorProfileA\n"</span>)));
00744 
00745     <span class="comment">//</span>
00746     <span class="comment">// Internal function is ANSI in Windows 95, call it directly.</span>
00747     <span class="comment">//</span>
00748 
00749     <span class="keywordflow">return</span> <a class="code" href="../../d9/d7/profman_8c.html#a45">InternalUninstallColorProfile</a>(pMachineName, pProfileName, bDelete);
00750 }
00751 
00752 
00753 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI
<a name="l00754"></a><a class="code" href="../../d9/d7/profman_8c.html#a83">00754</a> <a class="code" href="../../d9/d7/profman_8c.html#a83">UninstallColorProfileW</a>(
00755     PCWSTR   pMachineName,
00756     PCWSTR   pProfileName,
00757     BOOL     bDelete
00758     )
00759 {
00760     PSTR  pszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;    <span class="comment">// Ansi machine name</span>
00761     PSTR  pszProfileName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;    <span class="comment">// Ansi profile name</span>
00762     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;                <span class="comment">// return code</span>
00763 
00764     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"UninstallColorProfileW\n"</span>)));
00765 
00766     <span class="comment">//</span>
00767     <span class="comment">// Validate parameters before we touch them</span>
00768     <span class="comment">//</span>
00769 
00770     <span class="keywordflow">if</span> (!pProfileName)
00771     {
00772         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to UninstallColorProfile\n"</span>)));
00773         SetLastError(ERROR_INVALID_PARAMETER);
00774         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00775     }
00776 
00777     <span class="comment">//</span>
00778     <span class="comment">// Convert machine name to Ansi</span>
00779     <span class="comment">//</span>
00780 
00781     <span class="keywordflow">if</span> (pMachineName)
00782     {
00783         rc = <a class="code" href="../../d2/d1/object_8c.html#a12">ConvertToAnsi</a>(pMachineName, &amp;pszMachineName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00784     }
00785     <span class="keywordflow">else</span>
00786         pszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00787 
00788     <span class="comment">//</span>
00789     <span class="comment">// Convert profile name to Ansi</span>
00790     <span class="comment">//</span>
00791 
00792     rc = rc &amp;&amp; <a class="code" href="../../d2/d1/object_8c.html#a12">ConvertToAnsi</a>(pProfileName, &amp;pszProfileName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00793 
00794     <span class="comment">//</span>
00795     <span class="comment">// Call the internal Ansi function</span>
00796     <span class="comment">//</span>
00797 
00798     rc = rc &amp;&amp; <a class="code" href="../../d9/d7/profman_8c.html#a45">InternalUninstallColorProfile</a>(pszMachineName, pszProfileName,
00799                     bDelete);
00800 
00801     <span class="comment">//</span>
00802     <span class="comment">// Free memory before leaving</span>
00803     <span class="comment">//</span>
00804 
00805     <span class="keywordflow">if</span> (pszProfileName)
00806     {
00807         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pszProfileName);
00808     }
00809 
00810     <span class="keywordflow">if</span> (pszMachineName)
00811     {
00812         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pszMachineName);
00813     }
00814 
00815     <span class="keywordflow">return</span> rc;
00816 }
00817 
00818 
00819 <span class="preprocessor">#endif                          // ! UNICODE</span>
00820 <span class="preprocessor"></span>
00821 
00822 <span class="comment">/******************************************************************************</span>
00823 <span class="comment"> *</span>
00824 <span class="comment"> *                        AssociateColorProfileWithDevice</span>
00825 <span class="comment"> *</span>
00826 <span class="comment"> *  Function:</span>
00827 <span class="comment"> *       These are the ANSI &amp; Unicode wrappers for</span>
00828 <span class="comment"> *       InternalAssociateColorProfileWithDevice. Please see</span>
00829 <span class="comment"> *       InternalAssociateColorProfileWithDevice for more details</span>
00830 <span class="comment"> *       on this function.</span>
00831 <span class="comment"> *</span>
00832 <span class="comment"> *  Arguments:</span>
00833 <span class="comment"> *       pMachineName    - name identifying machine. NULL implies local</span>
00834 <span class="comment"> *       pProfileName    - pointer to profile to associate</span>
00835 <span class="comment"> *       pDeviceName     - pointer to device name</span>
00836 <span class="comment"> *</span>
00837 <span class="comment"> *  Returns:</span>
00838 <span class="comment"> *       TRUE if successful, NULL otherwise</span>
00839 <span class="comment"> *</span>
00840 <span class="comment"> ******************************************************************************/</span>
00841 
00842 <span class="preprocessor">#ifdef UNICODE          // Windows NT versions</span>
00843 <span class="preprocessor"></span>
00844 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI
00845 <a class="code" href="../../d9/d7/profman_8c.html#a84">AssociateColorProfileWithDeviceA</a>(
00846     PCSTR pMachineName,
00847     PCSTR pProfileName,
00848     PCSTR pDeviceName
00849     )
00850 {
00851     PWSTR pwszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;   <span class="comment">// Unicode machine name</span>
00852     PWSTR pwszProfileName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;   <span class="comment">// Unicode profile name</span>
00853     PWSTR pwszDeviceName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;    <span class="comment">// Unicode device name</span>
00854     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;                <span class="comment">// return code</span>
00855 
00856     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"AssociateColorProfileWithDeviceA\n"</span>)));
00857 
00858     <span class="comment">//</span>
00859     <span class="comment">// Validate parameters before we touch  them</span>
00860     <span class="comment">//</span>
00861 
00862     <span class="keywordflow">if</span> (! pProfileName ||
00863         ! pDeviceName)
00864     {
00865         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to AssociateColorProfileWithDevice\n"</span>)));
00866         SetLastError(ERROR_INVALID_PARAMETER);
00867         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00868     }
00869 
00870     <span class="comment">//</span>
00871     <span class="comment">// Convert machine name to Unicode</span>
00872     <span class="comment">//</span>
00873 
00874     <span class="keywordflow">if</span> (pMachineName)
00875     {
00876         rc = <a class="code" href="../../d2/d1/object_8c.html#a11">ConvertToUnicode</a>(pMachineName, &amp;pwszMachineName, TRUE);
00877     }
00878     <span class="keywordflow">else</span>
00879         pwszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00880 
00881     <span class="comment">//</span>
00882     <span class="comment">// Convert profile name to Unicode</span>
00883     <span class="comment">//</span>
00884 
00885     rc = rc &amp;&amp; <a class="code" href="../../d2/d1/object_8c.html#a11">ConvertToUnicode</a>(pProfileName, &amp;pwszProfileName, TRUE);
00886 
00887     <span class="comment">//</span>
00888     <span class="comment">// Convert device name to Unicode</span>
00889     <span class="comment">//</span>
00890 
00891     rc = rc &amp;&amp; <a class="code" href="../../d2/d1/object_8c.html#a11">ConvertToUnicode</a>(pDeviceName, &amp;pwszDeviceName, TRUE);
00892 
00893     <span class="comment">//</span>
00894     <span class="comment">// Call the internal Unicode function</span>
00895     <span class="comment">//</span>
00896 
00897     rc = rc &amp;&amp; <a class="code" href="../../d9/d7/profman_8c.html#a46">InternalAssociateColorProfileWithDevice</a>(pwszMachineName,
00898                 pwszProfileName, pwszDeviceName);
00899 
00900     <span class="comment">//</span>
00901     <span class="comment">// Free memory before leaving</span>
00902     <span class="comment">//</span>
00903 
00904     <span class="keywordflow">if</span> (pwszProfileName)
00905     {
00906         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pwszProfileName);
00907     }
00908 
00909     <span class="keywordflow">if</span> (pwszMachineName)
00910     {
00911         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pwszMachineName);
00912     }
00913 
00914     <span class="keywordflow">if</span> (pwszDeviceName)
00915     {
00916         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pwszDeviceName);
00917     }
00918 
00919     <span class="keywordflow">return</span> rc;
00920 }
00921 
00922 
00923 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI
00924 <a class="code" href="../../d9/d7/profman_8c.html#a85">AssociateColorProfileWithDeviceW</a>(
00925     PCWSTR pMachineName,
00926     PCWSTR pProfileName,
00927     PCWSTR pDeviceName
00928     )
00929 {
00930     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"AssociateColorProfileWithDeviceW\n"</span>)));
00931 
00932     <span class="comment">//</span>
00933     <span class="comment">// Internal function is Unicode in Windows NT, call it directly.</span>
00934     <span class="comment">//</span>
00935 
00936     <span class="keywordflow">return</span> <a class="code" href="../../d9/d7/profman_8c.html#a46">InternalAssociateColorProfileWithDevice</a>(pMachineName,
00937                 pProfileName, pDeviceName);
00938 }
00939 
00940 
00941 <span class="preprocessor">#else                           // Windows 95 versions</span>
00942 <span class="preprocessor"></span>
00943 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI
<a name="l00944"></a><a class="code" href="../../d9/d7/profman_8c.html#a84">00944</a> <a class="code" href="../../d9/d7/profman_8c.html#a84">AssociateColorProfileWithDeviceA</a>(
00945     PCSTR pMachineName,
00946     PCSTR pProfileName,
00947     PCSTR pDeviceName
00948     )
00949 {
00950     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"AssociateColorProfileWithDeviceA\n"</span>)));
00951 
00952     <span class="comment">//</span>
00953     <span class="comment">// Internal function is ANSI in Windows 95, call it directly.</span>
00954     <span class="comment">//</span>
00955 
00956     <span class="keywordflow">return</span> <a class="code" href="../../d9/d7/profman_8c.html#a46">InternalAssociateColorProfileWithDevice</a>(pMachineName,
00957                 pProfileName, pDeviceName);
00958 }
00959 
00960 
00961 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI
<a name="l00962"></a><a class="code" href="../../d9/d7/profman_8c.html#a85">00962</a> <a class="code" href="../../d9/d7/profman_8c.html#a85">AssociateColorProfileWithDeviceW</a>(
00963     PCWSTR pMachineName,
00964     PCWSTR pProfileName,
00965     PCWSTR pDeviceName
00966     )
00967 {
00968     PSTR  pszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;    <span class="comment">// Ansi machine name</span>
00969     PSTR  pszProfileName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;    <span class="comment">// Ansi profile name</span>
00970     PSTR  pszDeviceName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;     <span class="comment">// Ansi device name</span>
00971     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;                <span class="comment">// return code</span>
00972 
00973     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"AssociateColorProfileWithDeviceW\n"</span>)));
00974 
00975     <span class="comment">//</span>
00976     <span class="comment">// Validate parameters before we touch them</span>
00977     <span class="comment">//</span>
00978 
00979     <span class="keywordflow">if</span> (! pProfileName ||
00980         ! pDeviceName)
00981     {
00982         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to AssociateColorProfileWithDevice\n"</span>)));
00983         SetLastError(ERROR_INVALID_PARAMETER);
00984         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00985     }
00986 
00987     <span class="comment">//</span>
00988     <span class="comment">// Convert machine name to Ansi</span>
00989     <span class="comment">//</span>
00990 
00991     <span class="keywordflow">if</span> (pMachineName)
00992     {
00993         rc = <a class="code" href="../../d2/d1/object_8c.html#a12">ConvertToAnsi</a>(pMachineName, &amp;pszMachineName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00994     }
00995     <span class="keywordflow">else</span>
00996         pszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00997 
00998     <span class="comment">//</span>
00999     <span class="comment">// Convert profile name to Ansi</span>
01000     <span class="comment">//</span>
01001 
01002     rc = rc &amp;&amp; <a class="code" href="../../d2/d1/object_8c.html#a12">ConvertToAnsi</a>(pProfileName, &amp;pszProfileName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01003 
01004     <span class="comment">//</span>
01005     <span class="comment">// Convert device name to Ansi</span>
01006     <span class="comment">//</span>
01007 
01008     rc = rc &amp;&amp; <a class="code" href="../../d2/d1/object_8c.html#a12">ConvertToAnsi</a>(pDeviceName, &amp;pszDeviceName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01009 
01010     <span class="comment">//</span>
01011     <span class="comment">// Call the internal Ansi function</span>
01012     <span class="comment">//</span>
01013 
01014     rc = rc &amp;&amp; <a class="code" href="../../d9/d7/profman_8c.html#a46">InternalAssociateColorProfileWithDevice</a>(pszMachineName,
01015                 pszProfileName, pszDeviceName);
01016 
01017     <span class="comment">//</span>
01018     <span class="comment">// Free memory before leaving</span>
01019     <span class="comment">//</span>
01020 
01021     <span class="keywordflow">if</span> (pszProfileName)
01022     {
01023         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pszProfileName);
01024     }
01025 
01026     <span class="keywordflow">if</span> (pszMachineName)
01027     {
01028         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pszMachineName);
01029     }
01030 
01031     <span class="keywordflow">if</span> (pszDeviceName)
01032     {
01033         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pszDeviceName);
01034     }
01035 
01036     <span class="keywordflow">return</span> rc;
01037 }
01038 
01039 <span class="preprocessor">#endif                          // ! UNICODE</span>
01040 <span class="preprocessor"></span>
01041 
01042 <span class="comment">/******************************************************************************</span>
01043 <span class="comment"> *</span>
01044 <span class="comment"> *                     DisassociateColorProfileFromDevice</span>
01045 <span class="comment"> *</span>
01046 <span class="comment"> *  Function:</span>
01047 <span class="comment"> *       These are the ANSI &amp; Unicode wrappers for</span>
01048 <span class="comment"> *       InternalDisassociateColorProfileFromDevice. Please see</span>
01049 <span class="comment"> *       InternalDisassociateColorProfileFromDevice for more details</span>
01050 <span class="comment"> *       on this function.</span>
01051 <span class="comment"> *</span>
01052 <span class="comment"> *  Arguments:</span>
01053 <span class="comment"> *       pMachineName    - name identifying machine. NULL implies local</span>
01054 <span class="comment"> *       pProfileName    - pointer to profile to disassiciate</span>
01055 <span class="comment"> *       pDeviceName     - pointer to device name</span>
01056 <span class="comment"> *</span>
01057 <span class="comment"> *  Returns:</span>
01058 <span class="comment"> *       TRUE if successful, NULL otherwise</span>
01059 <span class="comment"> *</span>
01060 <span class="comment"> ******************************************************************************/</span>
01061 
01062 <span class="preprocessor">#ifdef UNICODE          // Windows NT versions</span>
01063 <span class="preprocessor"></span>
01064 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI
01065 <a class="code" href="../../d9/d7/profman_8c.html#a86">DisassociateColorProfileFromDeviceA</a>(
01066     PCSTR pMachineName,
01067     PCSTR pProfileName,
01068     PCSTR pDeviceName
01069     )
01070 {
01071     PWSTR pwszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;   <span class="comment">// Unicode machine name</span>
01072     PWSTR pwszProfileName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;   <span class="comment">// Unicode profile name</span>
01073     PWSTR pwszDeviceName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;    <span class="comment">// Unicode device name</span>
01074     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;                <span class="comment">// return code</span>
01075 
01076     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"DisassociateColorProfileWithDeviceA\n"</span>)));
01077 
01078     <span class="comment">//</span>
01079     <span class="comment">// Validate parameters before we touch  them</span>
01080     <span class="comment">//</span>
01081 
01082     <span class="keywordflow">if</span> (! pProfileName ||
01083         ! pDeviceName)
01084     {
01085         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to DisassociateColorProfileFromDevice\n"</span>)));
01086         SetLastError(ERROR_INVALID_PARAMETER);
01087         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01088     }
01089 
01090     <span class="comment">//</span>
01091     <span class="comment">// Convert machine name to Unicode</span>
01092     <span class="comment">//</span>
01093 
01094     <span class="keywordflow">if</span> (pMachineName)
01095     {
01096         rc = <a class="code" href="../../d2/d1/object_8c.html#a11">ConvertToUnicode</a>(pMachineName, &amp;pwszMachineName, TRUE);
01097     }
01098     <span class="keywordflow">else</span>
01099         pwszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01100 
01101     <span class="comment">//</span>
01102     <span class="comment">// Convert profile name to Unicode</span>
01103     <span class="comment">//</span>
01104 
01105     rc = rc &amp;&amp; <a class="code" href="../../d2/d1/object_8c.html#a11">ConvertToUnicode</a>(pProfileName, &amp;pwszProfileName, TRUE);
01106 
01107     <span class="comment">//</span>
01108     <span class="comment">// Convert device name to Unicode</span>
01109     <span class="comment">//</span>
01110 
01111     rc = rc &amp;&amp; <a class="code" href="../../d2/d1/object_8c.html#a11">ConvertToUnicode</a>(pDeviceName, &amp;pwszDeviceName, TRUE);
01112 
01113     <span class="comment">//</span>
01114     <span class="comment">// Call the internal Unicode function</span>
01115     <span class="comment">//</span>
01116 
01117     rc = rc &amp;&amp; <a class="code" href="../../d9/d7/profman_8c.html#a47">InternalDisassociateColorProfileFromDevice</a>(pwszMachineName,
01118                 pwszProfileName, pwszDeviceName);
01119 
01120     <span class="comment">//</span>
01121     <span class="comment">// Free memory before leaving</span>
01122     <span class="comment">//</span>
01123 
01124     <span class="keywordflow">if</span> (pwszProfileName)
01125     {
01126         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pwszProfileName);
01127     }
01128 
01129     <span class="keywordflow">if</span> (pwszMachineName)
01130     {
01131         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pwszMachineName);
01132     }
01133 
01134     <span class="keywordflow">if</span> (pwszDeviceName)
01135     {
01136         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pwszDeviceName);
01137     }
01138 
01139     <span class="keywordflow">return</span> rc;
01140 }
01141 
01142 
01143 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI
01144 <a class="code" href="../../d9/d7/profman_8c.html#a87">DisassociateColorProfileFromDeviceW</a>(
01145     PCWSTR pMachineName,
01146     PCWSTR pProfileName,
01147     PCWSTR pDeviceName
01148     )
01149 {
01150     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"DisassociateColorProfileWithDeviceW\n"</span>)));
01151 
01152     <span class="comment">//</span>
01153     <span class="comment">// Internal function is Unicode in Windows NT, call it directly.</span>
01154     <span class="comment">//</span>
01155 
01156     <span class="keywordflow">return</span> <a class="code" href="../../d9/d7/profman_8c.html#a47">InternalDisassociateColorProfileFromDevice</a>(pMachineName,
01157                 pProfileName, pDeviceName);
01158 }
01159 
01160 
01161 <span class="preprocessor">#else                           // Windows 95 versions</span>
01162 <span class="preprocessor"></span>
01163 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI
<a name="l01164"></a><a class="code" href="../../d9/d7/profman_8c.html#a86">01164</a> <a class="code" href="../../d9/d7/profman_8c.html#a86">DisassociateColorProfileFromDeviceA</a>(
01165     PCSTR pMachineName,
01166     PCSTR pProfileName,
01167     PCSTR pDeviceName
01168     )
01169 {
01170     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"DisassociateColorProfileWithDeviceA\n"</span>)));
01171 
01172     <span class="comment">//</span>
01173     <span class="comment">// Internal function is ANSI in Windows 95, call it directly.</span>
01174     <span class="comment">//</span>
01175 
01176     <span class="keywordflow">return</span> <a class="code" href="../../d9/d7/profman_8c.html#a47">InternalDisassociateColorProfileFromDevice</a>(pMachineName,
01177                 pProfileName, pDeviceName);
01178 }
01179 
01180 
01181 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI
<a name="l01182"></a><a class="code" href="../../d9/d7/profman_8c.html#a87">01182</a> <a class="code" href="../../d9/d7/profman_8c.html#a87">DisassociateColorProfileFromDeviceW</a>(
01183     PCWSTR pMachineName,
01184     PCWSTR pProfileName,
01185     PCWSTR pDeviceName
01186     )
01187 {
01188     PSTR  pszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;    <span class="comment">// Ansi machine name</span>
01189     PSTR  pszProfileName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;    <span class="comment">// Ansi profile name</span>
01190     PSTR  pszDeviceName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;     <span class="comment">// Ansi device name</span>
01191     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;                <span class="comment">// return code</span>
01192 
01193     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"DisassociateColorProfileWithDeviceW\n"</span>)));
01194 
01195     <span class="comment">//</span>
01196     <span class="comment">// Validate parameters before we touch them</span>
01197     <span class="comment">//</span>
01198 
01199     <span class="keywordflow">if</span> (! pProfileName ||
01200         ! pDeviceName)
01201     {
01202         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to AssociateColorProfileWithDevice\n"</span>)));
01203         SetLastError(ERROR_INVALID_PARAMETER);
01204         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01205     }
01206 
01207     <span class="comment">//</span>
01208     <span class="comment">// Convert machine name to Ansi</span>
01209     <span class="comment">//</span>
01210 
01211     <span class="keywordflow">if</span> (pMachineName)
01212     {
01213         rc = <a class="code" href="../../d2/d1/object_8c.html#a12">ConvertToAnsi</a>(pMachineName, &amp;pszMachineName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01214     }
01215     <span class="keywordflow">else</span>
01216         pszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01217 
01218     <span class="comment">//</span>
01219     <span class="comment">// Convert profile name to Ansi</span>
01220     <span class="comment">//</span>
01221 
01222     rc = rc &amp;&amp; <a class="code" href="../../d2/d1/object_8c.html#a12">ConvertToAnsi</a>(pProfileName, &amp;pszProfileName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01223 
01224     <span class="comment">//</span>
01225     <span class="comment">// Convert device name to Ansi</span>
01226     <span class="comment">//</span>
01227 
01228     rc = rc &amp;&amp; <a class="code" href="../../d2/d1/object_8c.html#a12">ConvertToAnsi</a>(pDeviceName, &amp;pszDeviceName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01229 
01230     <span class="comment">//</span>
01231     <span class="comment">// Call the internal Ansi function</span>
01232     <span class="comment">//</span>
01233 
01234     rc = rc &amp;&amp; <a class="code" href="../../d9/d7/profman_8c.html#a47">InternalDisassociateColorProfileFromDevice</a>(pszMachineName,
01235                 pszProfileName, pszDeviceName);
01236 
01237     <span class="comment">//</span>
01238     <span class="comment">// Free memory before leaving</span>
01239     <span class="comment">//</span>
01240 
01241     <span class="keywordflow">if</span> (pszProfileName)
01242     {
01243         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pszProfileName);
01244     }
01245 
01246     <span class="keywordflow">if</span> (pszMachineName)
01247     {
01248         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pszMachineName);
01249     }
01250 
01251     <span class="keywordflow">if</span> (pszDeviceName)
01252     {
01253         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pszDeviceName);
01254     }
01255 
01256     <span class="keywordflow">return</span> rc;
01257 }
01258 
01259 <span class="preprocessor">#endif                          // ! UNICODE</span>
01260 <span class="preprocessor"></span>
01261 
01262 
01263 <span class="comment">/******************************************************************************</span>
01264 <span class="comment"> *</span>
01265 <span class="comment"> *                               EnumColorProfiles</span>
01266 <span class="comment"> *</span>
01267 <span class="comment"> *  Function:</span>
01268 <span class="comment"> *       These are the ANSI &amp; Unicode wrappers for InternalEnumColorProfile.</span>
01269 <span class="comment"> *       Please see InternalEnumColorProfile for more details on this</span>
01270 <span class="comment"> *       function.</span>
01271 <span class="comment"> *</span>
01272 <span class="comment"> *  Arguments:</span>
01273 <span class="comment"> *       pMachineName    - name identifying machine on which the enumeration</span>
01274 <span class="comment"> *                         needs to be done</span>
01275 <span class="comment"> *       pEnumRecord     - pointer to enumeration criteria</span>
01276 <span class="comment"> *       pBuffer         - pointer to buffer to receive result, can be NULL</span>
01277 <span class="comment"> *       pdwSize         - pointer to buffer size. On return it is actual number</span>
01278 <span class="comment"> *                         of bytes copied/needed.</span>
01279 <span class="comment"> *       pnProfiles      - pointer to DWORD. On return, it is number of profiles</span>
01280 <span class="comment"> *                         copied to pBuffer.</span>
01281 <span class="comment"> *</span>
01282 <span class="comment"> *  Returns:</span>
01283 <span class="comment"> *       TRUE if successful, NULL otherwise</span>
01284 <span class="comment"> *</span>
01285 <span class="comment"> ******************************************************************************/</span>
01286 
01287 <span class="preprocessor">#ifdef UNICODE          // Windows NT versions</span>
01288 <span class="preprocessor"></span>
01289 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI
01290 <a class="code" href="../../d9/d7/profman_8c.html#a88">EnumColorProfilesA</a>(
01291     PCSTR      pMachineName,
01292     PENUMTYPEA pEnumRecord,
01293     PBYTE      pBuffer,
01294     PDWORD     pdwSize,
01295     PDWORD     pnProfiles
01296     )
01297 {
01298     PWSTR pwszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;   <span class="comment">// Unicode machine name</span>
01299     PWSTR pwszDeviceName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;    <span class="comment">// Unicode device name</span>
01300     PSTR  pAnsiDeviceName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;   <span class="comment">// incoming Ansi device name</span>
01301     PWSTR pwBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;          <span class="comment">// buffer to receive data</span>
01302     PWSTR pwTempBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;      <span class="comment">// temporary pointer to buffer</span>
01303     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSize;                   <span class="comment">// size of buffer</span>
01304     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSizeOfStruct;           <span class="comment">// size of ENUMTYPE structure</span>
01305     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwVersion;                <span class="comment">// ENUMTYPE structure version</span>
01306     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;                <span class="comment">// return code</span>
01307 
01308     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"EnumColorProfilesA\n"</span>)));
01309 
01310     <span class="comment">//</span>
01311     <span class="comment">// Validate parameters before we touch them</span>
01312     <span class="comment">//</span>
01313 
01314     <span class="keywordflow">if</span> (! pdwSize ||
01315         IsBadWritePtr(pdwSize, <span class="keyword">sizeof</span>(DWORD)) ||
01316         (pBuffer &amp;&amp; IsBadWritePtr(pBuffer, *pdwSize)) ||
01317         ! pEnumRecord ||
01318         IsBadReadPtr(pEnumRecord, <span class="keyword">sizeof</span>(DWORD)*3))   <span class="comment">// probe until ENUMTYPE.dwFields</span>
01319     {
01320 ParameterError_EnumColorProfilesA:
01321         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to EnumColorProfiles\n"</span>)));
01322         SetLastError(ERROR_INVALID_PARAMETER);
01323         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01324     }
01325 
01326     <span class="comment">//</span>
01327     <span class="comment">// Check structure size based on its version.</span>
01328     <span class="comment">//</span>
01329 
01330     dwSizeOfStruct = pEnumRecord-&gt;dwSize;
01331     dwVersion      = pEnumRecord-&gt;dwVersion;
01332 
01333     <span class="keywordflow">if</span> (dwVersion &gt;= ENUM_TYPE_VERSION)
01334     {
01335         <span class="keywordflow">if</span> (dwSizeOfStruct &lt; <span class="keyword">sizeof</span>(ENUMTYPE))
01336             <span class="keywordflow">goto</span> ParameterError_EnumColorProfilesA;
01337     }
01338     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dwVersion == 0x0200)
01339     {
01340         <span class="keywordflow">if</span> (dwSizeOfStruct &lt; <span class="keyword">sizeof</span>(ENUMTYPE)-<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>))
01341             <span class="keywordflow">goto</span> ParameterError_EnumColorProfilesA;
01342 
01343         <span class="comment">//</span>
01344         <span class="comment">// Version 2 should not have ET_DEVICECLASS bit</span>
01345         <span class="comment">//</span>
01346 
01347         <span class="keywordflow">if</span> (pEnumRecord-&gt;dwFields &amp; ET_DEVICECLASS)
01348             <span class="keywordflow">goto</span> ParameterError_EnumColorProfilesA;
01349 
01350         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Old version ENUMTYPE to EnumColorProfiles\n"</span>)));
01351     }
01352     <span class="keywordflow">else</span>
01353     {
01354         <span class="keywordflow">goto</span> ParameterError_EnumColorProfilesA;
01355     }
01356 
01357     <span class="keywordflow">if</span> (IsBadReadPtr(pEnumRecord, dwSizeOfStruct))
01358     {
01359         <span class="keywordflow">goto</span> ParameterError_EnumColorProfilesA;
01360     }
01361 
01362     <span class="comment">//</span>
01363     <span class="comment">// Convert machine name to Unicode</span>
01364     <span class="comment">//</span>
01365 
01366     <span class="keywordflow">if</span> (pMachineName)
01367     {
01368         rc = <a class="code" href="../../d2/d1/object_8c.html#a11">ConvertToUnicode</a>(pMachineName, &amp;pwszMachineName, TRUE);
01369     }
01370     <span class="keywordflow">else</span>
01371         pwszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01372 
01373     <span class="comment">//</span>
01374     <span class="comment">// If device name is specified, convert it to Unicode</span>
01375     <span class="comment">//</span>
01376 
01377     <span class="keywordflow">if</span> (pEnumRecord-&gt;dwFields &amp; ET_DEVICENAME)
01378     {
01379         <span class="keywordflow">if</span> (! pEnumRecord-&gt;pDeviceName)
01380         {
01381             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to EnumColorProfiles\n"</span>)));
01382             SetLastError(ERROR_INVALID_PARAMETER);
01383             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01384             <span class="keywordflow">goto</span> EndEnumColorProfilesA;
01385         }
01386 
01387         <span class="comment">//</span>
01388         <span class="comment">// Convert device name to Unicode</span>
01389         <span class="comment">//</span>
01390 
01391         pAnsiDeviceName = (PSTR)pEnumRecord-&gt;pDeviceName;
01392         rc = rc &amp;&amp; <a class="code" href="../../d2/d1/object_8c.html#a11">ConvertToUnicode</a>(pAnsiDeviceName, &amp;pwszDeviceName, TRUE);
01393         pEnumRecord-&gt;pDeviceName = (PSTR) pwszDeviceName;
01394     }
01395 
01396     dwSize = *pdwSize * <span class="keyword">sizeof</span>(WCHAR);
01397 
01398     <span class="comment">//</span>
01399     <span class="comment">// Allocate buffer of suitable size</span>
01400     <span class="comment">//</span>
01401 
01402     <span class="keywordflow">if</span> (pBuffer &amp;&amp; dwSize)
01403     {
01404         pwBuffer = <a class="code" href="../../d2/d1/object_8c.html#a7">MemAlloc</a>(dwSize);
01405         <span class="keywordflow">if</span> (! pwBuffer)
01406         {
01407             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error allocating memory for Unicode buffer\n"</span>)));
01408             SetLastError(ERROR_NOT_ENOUGH_MEMORY);
01409             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01410             <span class="keywordflow">goto</span> EndEnumColorProfilesA;
01411         }
01412     }
01413 
01414     <span class="comment">//</span>
01415     <span class="comment">// Call the internal Unicode function</span>
01416     <span class="comment">//</span>
01417 
01418     rc = rc &amp;&amp; <a class="code" href="../../d9/d7/profman_8c.html#a48">InternalEnumColorProfiles</a>(pwszMachineName,
01419                 (PENUMTYPEW)pEnumRecord, (PBYTE)pwBuffer, &amp;dwSize, pnProfiles);
01420 
01421     <span class="keywordflow">if</span> (pwBuffer &amp;&amp; rc)
01422     {
01423         pwTempBuffer = pwBuffer;
01424         <span class="keywordflow">while</span> (*pwTempBuffer)
01425         {
01426             rc = rc &amp;&amp; <a class="code" href="../../d2/d1/object_8c.html#a12">ConvertToAnsi</a>(pwTempBuffer, (PSTR *)&amp;pBuffer, FALSE);
01427             pwTempBuffer += lstrlenW(pwTempBuffer) + 1;
01428             pBuffer  += (lstrlenA((PSTR)pBuffer) + 1) * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>);
01429         }
01430 
01431         *((PSTR)pBuffer) = <span class="charliteral">'\0'</span>;
01432     }
01433 
01434     *pdwSize = dwSize / <span class="keyword">sizeof</span>(WCHAR);
01435 
01436 EndEnumColorProfilesA:
01437     <span class="keywordflow">if</span> (pwszMachineName)
01438     {
01439         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pwszMachineName);
01440     }
01441     <span class="keywordflow">if</span> (pAnsiDeviceName)
01442     {
01443         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pEnumRecord-&gt;pDeviceName != NULL);
01444 
01445         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>((PBYTE)pEnumRecord-&gt;pDeviceName);
01446         pEnumRecord-&gt;pDeviceName = (PCSTR)pAnsiDeviceName;
01447     }
01448     <span class="keywordflow">if</span> (pwBuffer)
01449     {
01450         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pwBuffer);
01451     }
01452 
01453     <span class="keywordflow">return</span> rc;
01454 }
01455 
01456 
01457 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI
01458 <a class="code" href="../../d9/d7/profman_8c.html#a89">EnumColorProfilesW</a>(
01459     PCWSTR     pMachineName,
01460     PENUMTYPEW pEnumRecord,
01461     PBYTE      pBuffer,
01462     PDWORD     pdwSize,
01463     PDWORD     pnProfiles
01464     )
01465 {
01466     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"EnumColorProfilesW\n"</span>)));
01467 
01468     <span class="comment">//</span>
01469     <span class="comment">// Internal function is Unicode in Windows NT, call it directly.</span>
01470     <span class="comment">//</span>
01471 
01472     <span class="keywordflow">return</span> <a class="code" href="../../d9/d7/profman_8c.html#a48">InternalEnumColorProfiles</a>(pMachineName, pEnumRecord,
01473         pBuffer, pdwSize, pnProfiles);
01474 }
01475 
01476 <span class="preprocessor">#else                           // Windows 95 versions</span>
01477 <span class="preprocessor"></span>
01478 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI
<a name="l01479"></a><a class="code" href="../../d9/d7/profman_8c.html#a88">01479</a> <a class="code" href="../../d9/d7/profman_8c.html#a88">EnumColorProfilesA</a>(
01480     PCSTR      pMachineName,
01481     PENUMTYPEA pEnumRecord,
01482     PBYTE      pBuffer,
01483     PDWORD     pdwSize,
01484     PDWORD     pnProfiles
01485     )
01486 {
01487     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"EnumColorProfilesA\n"</span>)));
01488 
01489     <span class="comment">//</span>
01490     <span class="comment">// Internal function is ANSI in Windows 95, call it directly.</span>
01491     <span class="comment">//</span>
01492 
01493     <span class="keywordflow">return</span> <a class="code" href="../../d9/d7/profman_8c.html#a48">InternalEnumColorProfiles</a>(pMachineName, pEnumRecord,
01494         pBuffer, pdwSize, pnProfiles);
01495 }
01496 
01497 
01498 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI
<a name="l01499"></a><a class="code" href="../../d9/d7/profman_8c.html#a89">01499</a> <a class="code" href="../../d9/d7/profman_8c.html#a89">EnumColorProfilesW</a>(
01500     PCWSTR     pMachineName,
01501     PENUMTYPEW pEnumRecord,
01502     PBYTE      pBuffer,
01503     PDWORD     pdwSize,
01504     PDWORD     pnProfiles
01505     )
01506 {
01507     PSTR  pszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;    <span class="comment">// Ansi machine name</span>
01508     PSTR  pszDeviceName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;     <span class="comment">// Ansi device name</span>
01509     PWSTR pUnicodeDeviceName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;<span class="comment">// incoming Unicode device name</span>
01510     PSTR  pszBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;         <span class="comment">// buffer to receive data</span>
01511     PSTR  pszTempBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;     <span class="comment">// temporary pointer to buffer</span>
01512     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSize;                   <span class="comment">// size of buffer</span>
01513     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSizeOfStruct;           <span class="comment">// size of ENUMTYPE structure</span>
01514     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwVersion;                <span class="comment">// ENUMTYPE structure version</span>
01515     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;                <span class="comment">// return code</span>
01516 
01517     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"EnumColorProfilesW\n"</span>)));
01518 
01519     <span class="comment">//</span>
01520     <span class="comment">// Validate parameters before we touch them</span>
01521     <span class="comment">//</span>
01522 
01523     <span class="keywordflow">if</span> (! pdwSize ||
01524         IsBadWritePtr(pdwSize, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)) ||
01525         (pBuffer &amp;&amp; IsBadWritePtr(pBuffer, *pdwSize)) ||
01526         ! pEnumRecord ||
01527         IsBadReadPtr(pEnumRecord, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)*3))   <span class="comment">// probe until ENUMTYPE.dwFields</span>
01528     {
01529 ParameterError_EnumColorProfilesW:
01530         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to EnumColorProfiles\n"</span>)));
01531         SetLastError(ERROR_INVALID_PARAMETER);
01532         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01533     }
01534 
01535     <span class="comment">//</span>
01536     <span class="comment">// Check structure size based on its version.</span>
01537     <span class="comment">//</span>
01538 
01539     dwSizeOfStruct = pEnumRecord-&gt;dwSize;
01540     dwVersion      = pEnumRecord-&gt;dwVersion;
01541 
01542     <span class="keywordflow">if</span> (dwVersion &gt;= ENUM_TYPE_VERSION)
01543     {
01544         <span class="keywordflow">if</span> (dwSizeOfStruct &lt; <span class="keyword">sizeof</span>(ENUMTYPE))
01545             <span class="keywordflow">goto</span> ParameterError_EnumColorProfilesW;
01546     }
01547     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dwVersion == 0x0200)
01548     {
01549         <span class="keywordflow">if</span> (dwSizeOfStruct &lt; <span class="keyword">sizeof</span>(ENUMTYPE)-<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>))
01550             <span class="keywordflow">goto</span> ParameterError_EnumColorProfilesW;
01551 
01552         <span class="comment">//</span>
01553         <span class="comment">// Version 2 should not have ET_DEVICECLASS bit</span>
01554         <span class="comment">//</span>
01555 
01556         <span class="keywordflow">if</span> (pEnumRecord-&gt;dwFields &amp; ET_DEVICECLASS)
01557             <span class="keywordflow">goto</span> ParameterError_EnumColorProfilesW;
01558 
01559         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Old version ENUMTYPE to EnumColorProfiles\n"</span>)));
01560     }
01561     <span class="keywordflow">else</span>
01562     {
01563         <span class="keywordflow">goto</span> ParameterError_EnumColorProfilesW;
01564     }
01565 
01566     <span class="keywordflow">if</span> (IsBadReadPtr(pEnumRecord, dwSizeOfStruct))
01567     {
01568         <span class="keywordflow">goto</span> ParameterError_EnumColorProfilesW;
01569     }
01570 
01571     <span class="comment">//</span>
01572     <span class="comment">// Convert machine name to Ansi</span>
01573     <span class="comment">//</span>
01574 
01575     <span class="keywordflow">if</span> (pMachineName)
01576     {
01577         rc = <a class="code" href="../../d2/d1/object_8c.html#a12">ConvertToAnsi</a>(pMachineName, &amp;pszMachineName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01578     }
01579 
01580     <span class="comment">//</span>
01581     <span class="comment">// If device name is specified, convert it to Unicode</span>
01582     <span class="comment">//</span>
01583 
01584     <span class="keywordflow">if</span> (pEnumRecord-&gt;dwFields &amp; ET_DEVICENAME)
01585     {
01586         <span class="keywordflow">if</span> (! pEnumRecord-&gt;pDeviceName)
01587         {
01588             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to EnumColorProfiles\n"</span>)));
01589             SetLastError(ERROR_INVALID_PARAMETER);
01590             <span class="keywordflow">goto</span> EndEnumColorProfilesW;
01591         }
01592 
01593         <span class="comment">//</span>
01594         <span class="comment">// Convert device name to Ansi</span>
01595         <span class="comment">//</span>
01596 
01597         pUnicodeDeviceName = (PWSTR)pEnumRecord-&gt;pDeviceName;
01598         rc = rc &amp;&amp; <a class="code" href="../../d2/d1/object_8c.html#a12">ConvertToAnsi</a>(pUnicodeDeviceName, &amp;pszDeviceName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01599         pEnumRecord-&gt;pDeviceName = (PCWSTR) pszDeviceName;
01600     }
01601 
01602     dwSize = *pdwSize / <span class="keyword">sizeof</span>(WCHAR);
01603 
01604     <span class="comment">//</span>
01605     <span class="comment">// Allocate buffer of suitable size</span>
01606     <span class="comment">//</span>
01607 
01608     <span class="keywordflow">if</span> (pBuffer &amp;&amp; dwSize)
01609     {
01610         pszBuffer = <a class="code" href="../../d2/d1/object_8c.html#a7">MemAlloc</a>(dwSize);
01611         <span class="keywordflow">if</span> (! pszBuffer)
01612         {
01613             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error allocating memory for Ansi buffer\n"</span>)));
01614             SetLastError(ERROR_NOT_ENOUGH_MEMORY);
01615             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01616             <span class="keywordflow">goto</span> EndEnumColorProfilesW;
01617         }
01618     }
01619 
01620     <span class="comment">//</span>
01621     <span class="comment">// Call the internal Ansi function</span>
01622     <span class="comment">//</span>
01623 
01624     rc = rc &amp;&amp; <a class="code" href="../../d9/d7/profman_8c.html#a48">InternalEnumColorProfiles</a>(pszMachineName,
01625                 (PENUMTYPEA)pEnumRecord, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pszBuffer, &amp;dwSize, pnProfiles);
01626 
01627     <span class="keywordflow">if</span> (pszBuffer &amp;&amp; rc)
01628     {
01629         pszTempBuffer = pszBuffer;
01630         <span class="keywordflow">while</span> (*pszTempBuffer)
01631         {
01632             rc = rc &amp;&amp; <a class="code" href="../../d2/d1/object_8c.html#a11">ConvertToUnicode</a>(pszTempBuffer, (PWSTR *)&amp;pBuffer, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01633             pszTempBuffer += lstrlenA(pszTempBuffer) + 1;
01634             pBuffer   += (lstrlenW((PWSTR)pBuffer) + 1) * <span class="keyword">sizeof</span>(WCHAR);
01635         }
01636 
01637         *((PWSTR)pBuffer) = <span class="charliteral">'\0'</span>;
01638     }
01639     *pdwSize = dwSize * <span class="keyword">sizeof</span>(WCHAR);
01640 
01641 EndEnumColorProfilesW:
01642     <span class="keywordflow">if</span> (pszMachineName)
01643     {
01644         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pszMachineName);
01645     }
01646     <span class="keywordflow">if</span> (pUnicodeDeviceName)
01647     {
01648         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pEnumRecord-&gt;pDeviceName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01649 
01650         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>((PSTR)pEnumRecord-&gt;pDeviceName);
01651         pEnumRecord-&gt;pDeviceName = (PCWSTR)pUnicodeDeviceName;
01652     }
01653     <span class="keywordflow">if</span> (pszBuffer)
01654     {
01655         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pszBuffer);
01656     }
01657 
01658     <span class="keywordflow">return</span> rc;
01659 }
01660 
01661 <span class="preprocessor">#endif                          // ! UNICODE</span>
01662 <span class="preprocessor"></span>
01663 
01664 <span class="comment">/******************************************************************************</span>
01665 <span class="comment"> *</span>
01666 <span class="comment"> *                          SetStandardColorSpaceProfile</span>
01667 <span class="comment"> *</span>
01668 <span class="comment"> *  Function:</span>
01669 <span class="comment"> *       These are the ANSI &amp; Unicode wrappers for InternalSetSCSProfile.</span>
01670 <span class="comment"> *       Please see InternalSetSCSProfile for more details on this</span>
01671 <span class="comment"> *       function.</span>
01672 <span class="comment"> *</span>
01673 <span class="comment"> *  Arguments:</span>
01674 <span class="comment"> *       pMachineName    - name identifying machine on which the standard color</span>
01675 <span class="comment"> *                         space profile should be registered</span>
01676 <span class="comment"> *       dwSCS           - ID for the standard color space</span>
01677 <span class="comment"> *       pProfileName    - pointer to profile filename</span>
01678 <span class="comment"> *</span>
01679 <span class="comment"> *  Returns:</span>
01680 <span class="comment"> *       TRUE if successful, NULL otherwise</span>
01681 <span class="comment"> *</span>
01682 <span class="comment"> ******************************************************************************/</span>
01683 
01684 <span class="preprocessor">#ifdef UNICODE          // Windows NT versions</span>
01685 <span class="preprocessor"></span>
01686 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI
01687 <a class="code" href="../../d9/d7/profman_8c.html#a90">SetStandardColorSpaceProfileA</a>(
01688     PCSTR   pMachineName,
01689     DWORD   dwSCS,
01690     PCSTR   pProfileName
01691     )
01692 {
01693     PWSTR pwszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;   <span class="comment">// Unicode machine name</span>
01694     PWSTR pwszProfileName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;   <span class="comment">// Unicode profile name</span>
01695     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;                <span class="comment">// return code</span>
01696 
01697     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"SetStandardColorSpaceProfileA\n"</span>)));
01698 
01699     <span class="comment">//</span>
01700     <span class="comment">// Validate parameters before we touch them</span>
01701     <span class="comment">//</span>
01702 
01703     <span class="keywordflow">if</span> (! pProfileName)
01704     {
01705         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to SetStandardColorSpaceProfile\n"</span>)));
01706         SetLastError(ERROR_INVALID_PARAMETER);
01707         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01708     }
01709 
01710     <span class="comment">//</span>
01711     <span class="comment">// Convert machine name to Unicode</span>
01712     <span class="comment">//</span>
01713 
01714     <span class="keywordflow">if</span> (pMachineName)
01715     {
01716         rc = <a class="code" href="../../d2/d1/object_8c.html#a11">ConvertToUnicode</a>(pMachineName, &amp;pwszMachineName, TRUE);
01717     }
01718     <span class="keywordflow">else</span>
01719         pwszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01720 
01721     <span class="comment">//</span>
01722     <span class="comment">// Convert profile name to Unicode</span>
01723     <span class="comment">//</span>
01724 
01725     rc = rc &amp;&amp; <a class="code" href="../../d2/d1/object_8c.html#a11">ConvertToUnicode</a>(pProfileName, &amp;pwszProfileName, TRUE);
01726 
01727     <span class="comment">//</span>
01728     <span class="comment">// Call the internal Unicode function</span>
01729     <span class="comment">//</span>
01730 
01731     rc = rc &amp;&amp; <a class="code" href="../../d9/d7/profman_8c.html#a49">InternalSetSCSProfile</a>(pwszMachineName, dwSCS, pwszProfileName);
01732 
01733     <span class="comment">//</span>
01734     <span class="comment">// Free memory before leaving</span>
01735     <span class="comment">//</span>
01736 
01737     <span class="keywordflow">if</span> (pwszProfileName)
01738     {
01739         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pwszProfileName);
01740     }
01741 
01742     <span class="keywordflow">if</span> (pwszMachineName)
01743     {
01744         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pwszMachineName);
01745     }
01746 
01747     <span class="keywordflow">return</span> rc;
01748 }
01749 
01750 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI
01751 <a class="code" href="../../d9/d7/profman_8c.html#a91">SetStandardColorSpaceProfileW</a>(
01752     PCWSTR   pMachineName,
01753     DWORD    dwSCS,
01754     PCWSTR   pProfileName
01755     )
01756 {
01757     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"SetStandardColorSpaceProfileW\n"</span>)));
01758 
01759     <span class="comment">//</span>
01760     <span class="comment">// Internal function is Unicode in Windows NT, call it directly.</span>
01761     <span class="comment">//</span>
01762 
01763     <span class="keywordflow">return</span> <a class="code" href="../../d9/d7/profman_8c.html#a49">InternalSetSCSProfile</a>(pMachineName, dwSCS, pProfileName);
01764 }
01765 
01766 <span class="preprocessor">#else                           // Windows 95 versions</span>
01767 <span class="preprocessor"></span>
01768 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI
<a name="l01769"></a><a class="code" href="../../d9/d7/profman_8c.html#a90">01769</a> <a class="code" href="../../d9/d7/profman_8c.html#a90">SetStandardColorSpaceProfileA</a>(
01770     PCSTR   pMachineName,
01771     DWORD   dwSCS,
01772     PCSTR   pProfileName
01773     )
01774 {
01775     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"SetStandardColorSpaceProfileA\n"</span>)));
01776 
01777     <span class="comment">//</span>
01778     <span class="comment">// Internal function is ANSI in Windows 95, call it directly.</span>
01779     <span class="comment">//</span>
01780 
01781     <span class="keywordflow">return</span> <a class="code" href="../../d9/d7/profman_8c.html#a49">InternalSetSCSProfile</a>(pMachineName, dwSCS, pProfileName);
01782 }
01783 
01784 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI
<a name="l01785"></a><a class="code" href="../../d9/d7/profman_8c.html#a91">01785</a> <a class="code" href="../../d9/d7/profman_8c.html#a91">SetStandardColorSpaceProfileW</a>(
01786     PCWSTR   pMachineName,
01787     DWORD    dwSCS,
01788     PCWSTR   pProfileName
01789     )
01790 {
01791     PSTR  pszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;    <span class="comment">// Ansi machine name</span>
01792     PSTR  pszProfileName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;    <span class="comment">// Ansi profile name</span>
01793     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;                <span class="comment">// return code</span>
01794 
01795     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"SetStandardColorSpaceProfileW\n"</span>)));
01796 
01797     <span class="comment">//</span>
01798     <span class="comment">// Validate parameters before we touch them</span>
01799     <span class="comment">//</span>
01800 
01801     <span class="keywordflow">if</span> (! pProfileName)
01802     {
01803         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to SetStandardColorSpaceProfile\n"</span>)));
01804         SetLastError(ERROR_INVALID_PARAMETER);
01805         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01806     }
01807 
01808     <span class="comment">//</span>
01809     <span class="comment">// Convert machine name to Ansi</span>
01810     <span class="comment">//</span>
01811 
01812     <span class="keywordflow">if</span> (pMachineName)
01813     {
01814         rc = <a class="code" href="../../d2/d1/object_8c.html#a12">ConvertToAnsi</a>(pMachineName, &amp;pszMachineName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01815     }
01816     <span class="keywordflow">else</span>
01817         pszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01818 
01819     <span class="comment">//</span>
01820     <span class="comment">// Convert profile name to Ansi</span>
01821     <span class="comment">//</span>
01822 
01823     rc = rc &amp;&amp; <a class="code" href="../../d2/d1/object_8c.html#a12">ConvertToAnsi</a>(pProfileName, &amp;pszProfileName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01824 
01825     <span class="comment">//</span>
01826     <span class="comment">// Call the internal Ansi function</span>
01827     <span class="comment">//</span>
01828 
01829     rc = rc &amp;&amp; <a class="code" href="../../d9/d7/profman_8c.html#a49">InternalSetSCSProfile</a>(pszMachineName, dwSCS, pszProfileName);
01830 
01831     <span class="comment">//</span>
01832     <span class="comment">// Free memory before leaving</span>
01833     <span class="comment">//</span>
01834 
01835     <span class="keywordflow">if</span> (pszProfileName)
01836     {
01837         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pszProfileName);
01838     }
01839 
01840     <span class="keywordflow">if</span> (pszMachineName)
01841     {
01842         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pszMachineName);
01843     }
01844 
01845     <span class="keywordflow">return</span> rc;
01846 }
01847 
01848 <span class="preprocessor">#endif                          // ! UNICODE</span>
01849 <span class="preprocessor"></span>
01850 
01851 <span class="comment">/******************************************************************************</span>
01852 <span class="comment"> *</span>
01853 <span class="comment"> *                          GetStandardColorSpaceProfile</span>
01854 <span class="comment"> *</span>
01855 <span class="comment"> *  Function:</span>
01856 <span class="comment"> *       These are the ANSI &amp; Unicode wrappers for InternalGetSCSProfile.</span>
01857 <span class="comment"> *       Please see InternalGetSCSProfile for more details on this</span>
01858 <span class="comment"> *       function.</span>
01859 <span class="comment"> *</span>
01860 <span class="comment"> *  Arguments:</span>
01861 <span class="comment"> *       pMachineName    - name identifying machine on which the standard color</span>
01862 <span class="comment"> *                         space profile should be queried</span>
01863 <span class="comment"> *       dwSCS           - ID for the standard color space</span>
01864 <span class="comment"> *       pBuffer         - pointer to buffer to receive profile filename</span>
01865 <span class="comment"> *       pdwSize         - pointer to DWORD specifying size of buffer. On return</span>
01866 <span class="comment"> *                         it has size needed/used</span>
01867 <span class="comment"> *</span>
01868 <span class="comment"> *  Returns:</span>
01869 <span class="comment"> *       TRUE if successful, NULL otherwise</span>
01870 <span class="comment"> *</span>
01871 <span class="comment"> ******************************************************************************/</span>
01872 
01873 <span class="preprocessor">#ifdef UNICODE          // Windows NT versions</span>
01874 <span class="preprocessor"></span>
01875 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI
01876 <a class="code" href="../../d9/d7/profman_8c.html#a92">GetStandardColorSpaceProfileA</a>(
01877     PCSTR   pMachineName,
01878     DWORD   dwSCS,
01879     PSTR    pBuffer,
01880     PDWORD  pdwSize
01881     )
01882 {
01883     PWSTR pwszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;   <span class="comment">// Unicode machine name</span>
01884     PWSTR pwBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;          <span class="comment">// Unicode color directory path</span>
01885     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSize;                   <span class="comment">// size of Unicode buffer</span>
01886     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;                <span class="comment">// return code</span>
01887 
01888     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"GetStandardColorSpaceProfileA\n"</span>)));
01889 
01890     <span class="comment">//</span>
01891     <span class="comment">// Validate parameters before we touch them</span>
01892     <span class="comment">//</span>
01893 
01894     <span class="keywordflow">if</span> (! pdwSize ||
01895         IsBadWritePtr(pdwSize, <span class="keyword">sizeof</span>(DWORD)) ||
01896         (pBuffer &amp;&amp; IsBadWritePtr(pBuffer, *pdwSize)))
01897     {
01898         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to GetStandardColorSpaceProfile\n"</span>)));
01899         SetLastError(ERROR_INVALID_PARAMETER);
01900         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01901     }
01902 
01903     <span class="comment">//</span>
01904     <span class="comment">// Convert machine name to Unicode</span>
01905     <span class="comment">//</span>
01906 
01907     <span class="keywordflow">if</span> (pMachineName)
01908     {
01909         rc = <a class="code" href="../../d2/d1/object_8c.html#a11">ConvertToUnicode</a>(pMachineName, &amp;pwszMachineName, TRUE);
01910     }
01911     <span class="keywordflow">else</span>
01912         pwszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01913 
01914     dwSize = *pdwSize * <span class="keyword">sizeof</span>(WCHAR);
01915 
01916     <span class="comment">//</span>
01917     <span class="comment">// Create a buffer to get Unicode filename from system</span>
01918     <span class="comment">//</span>
01919 
01920     <span class="keywordflow">if</span> (pBuffer &amp;&amp; dwSize)
01921     {
01922         pwBuffer = (PWSTR)<a class="code" href="../../d2/d1/object_8c.html#a7">MemAlloc</a>(dwSize);
01923         <span class="keywordflow">if</span> (! pwBuffer)
01924         {
01925             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error allocating memory for Unicode string\n"</span>)));
01926             SetLastError(ERROR_NOT_ENOUGH_MEMORY);
01927             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01928             <span class="keywordflow">goto</span> EndGetSCSProfileA;
01929         }
01930     }
01931 
01932     rc = rc &amp;&amp; <a class="code" href="../../d9/d7/profman_8c.html#a50">InternalGetSCSProfile</a>(pwszMachineName, dwSCS, pwBuffer, &amp;dwSize);
01933 
01934     *pdwSize = dwSize / <span class="keyword">sizeof</span>(WCHAR);
01935 
01936     <span class="comment">//</span>
01937     <span class="comment">// Convert Unicode path to Ansi</span>
01938     <span class="comment">//</span>
01939 
01940     <span class="keywordflow">if</span> (pwBuffer)
01941     {
01942         rc = rc &amp;&amp; <a class="code" href="../../d2/d1/object_8c.html#a12">ConvertToAnsi</a>(pwBuffer, &amp;pBuffer, FALSE);
01943     }
01944 
01945 EndGetSCSProfileA:
01946     <span class="keywordflow">if</span> (pwszMachineName)
01947     {
01948         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pwszMachineName);
01949     }
01950 
01951     <span class="keywordflow">if</span> (pwBuffer)
01952     {
01953         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pwBuffer);
01954     }
01955 
01956     <span class="keywordflow">return</span> rc;
01957 }
01958 
01959 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI
01960 <a class="code" href="../../d9/d7/profman_8c.html#a93">GetStandardColorSpaceProfileW</a>(
01961     PCWSTR   pMachineName,
01962     DWORD    dwSCS,
01963     PWSTR    pBuffer,
01964     PDWORD   pdwSize
01965     )
01966 {
01967     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"GetStandardColorSpaceProfileW\n"</span>)));
01968 
01969     <span class="comment">//</span>
01970     <span class="comment">// Internal function is Unicode in Windows NT, call it directly.</span>
01971     <span class="comment">//</span>
01972 
01973     <span class="keywordflow">return</span> <a class="code" href="../../d9/d7/profman_8c.html#a50">InternalGetSCSProfile</a>(pMachineName, dwSCS, pBuffer, pdwSize);
01974 }
01975 
01976 <span class="preprocessor">#else                           // Windows 95 versions</span>
01977 <span class="preprocessor"></span>
01978 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI
<a name="l01979"></a><a class="code" href="../../d9/d7/profman_8c.html#a92">01979</a> <a class="code" href="../../d9/d7/profman_8c.html#a92">GetStandardColorSpaceProfileA</a>(
01980     PCSTR   pMachineName,
01981     DWORD   dwSCS,
01982     PSTR    pBuffer,
01983     PDWORD  pdwSize
01984     )
01985 {
01986     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"GetStandardColorSpaceProfileA\n"</span>)));
01987 
01988     <span class="comment">//</span>
01989     <span class="comment">// Internal function is ANSI in Windows 95, call it directly.</span>
01990     <span class="comment">//</span>
01991 
01992     <span class="keywordflow">return</span> <a class="code" href="../../d9/d7/profman_8c.html#a50">InternalGetSCSProfile</a>(pMachineName, dwSCS, pBuffer, pdwSize);
01993 }
01994 
01995 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI
<a name="l01996"></a><a class="code" href="../../d9/d7/profman_8c.html#a93">01996</a> <a class="code" href="../../d9/d7/profman_8c.html#a93">GetStandardColorSpaceProfileW</a>(
01997     PCWSTR   pMachineName,
01998     DWORD    dwSCS,
01999     PWSTR    pBuffer,
02000     PDWORD   pdwSize
02001     )
02002 {
02003     PSTR pszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;     <span class="comment">// Ansi machine name</span>
02004     PSTR pszBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;          <span class="comment">// Ansi color directory path</span>
02005     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSize;                   <span class="comment">// size of Ansi buffer</span>
02006     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;                <span class="comment">// return code</span>
02007 
02008     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"GetStandardColorSpaceProfileW\n"</span>)));
02009 
02010     <span class="comment">//</span>
02011     <span class="comment">// Validate parameters before we touch them</span>
02012     <span class="comment">//</span>
02013 
02014     <span class="keywordflow">if</span> (! pdwSize ||
02015         IsBadWritePtr(pdwSize, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)) ||
02016         (pBuffer &amp;&amp; IsBadWritePtr(pBuffer, *pdwSize)))
02017     {
02018         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to GetStandardColorSpaceProfile\n"</span>)));
02019         SetLastError(ERROR_INVALID_PARAMETER);
02020         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02021     }
02022 
02023     <span class="comment">//</span>
02024     <span class="comment">// Convert machine name to Ansi</span>
02025     <span class="comment">//</span>
02026 
02027     <span class="keywordflow">if</span> (pMachineName)
02028     {
02029         rc = <a class="code" href="../../d2/d1/object_8c.html#a12">ConvertToAnsi</a>(pMachineName, &amp;pszMachineName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02030     }
02031     <span class="keywordflow">else</span>
02032         pszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02033 
02034     dwSize = *pdwSize / <span class="keyword">sizeof</span>(WCHAR);
02035 
02036     <span class="comment">//</span>
02037     <span class="comment">// Create a buffer to get Ansi profilename from system</span>
02038     <span class="comment">//</span>
02039 
02040     <span class="keywordflow">if</span> (pBuffer &amp;&amp; dwSize)
02041     {
02042         pszBuffer = (PSTR)<a class="code" href="../../d2/d1/object_8c.html#a7">MemAlloc</a>(dwSize);
02043         <span class="keywordflow">if</span> (! pBuffer)
02044         {
02045             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error allocating memory for Ansi string\n"</span>)));
02046             SetLastError(ERROR_NOT_ENOUGH_MEMORY);
02047             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02048             <span class="keywordflow">goto</span> EndGetSCSProfileW;
02049         }
02050     }
02051 
02052     rc = rc &amp;&amp; <a class="code" href="../../d9/d7/profman_8c.html#a50">InternalGetSCSProfile</a>(pszMachineName, dwSCS, pszBuffer, &amp;dwSize);
02053 
02054     *pdwSize = dwSize * <span class="keyword">sizeof</span>(WCHAR);
02055 
02056     <span class="comment">//</span>
02057     <span class="comment">// Convert Ansi path to Unicode</span>
02058     <span class="comment">//</span>
02059 
02060     <span class="keywordflow">if</span> (pszBuffer)
02061     {
02062         rc = rc &amp;&amp; <a class="code" href="../../d2/d1/object_8c.html#a11">ConvertToUnicode</a>(pszBuffer, &amp;pBuffer, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02063     }
02064 
02065 EndGetSCSProfileW:
02066     <span class="keywordflow">if</span> (pszMachineName)
02067     {
02068         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pszMachineName);
02069     }
02070 
02071     <span class="keywordflow">if</span> (pszBuffer)
02072     {
02073         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pszBuffer);
02074     }
02075 
02076     <span class="keywordflow">return</span> rc;
02077 }
02078 
02079 <span class="preprocessor">#endif                          // ! UNICODE</span>
02080 <span class="preprocessor"></span>
02081 
02082 <span class="comment">/******************************************************************************</span>
02083 <span class="comment"> *</span>
02084 <span class="comment"> *                          GenerateCopyFilePaths</span>
02085 <span class="comment"> *</span>
02086 <span class="comment"> *  Function:</span>
02087 <span class="comment"> *       This function is called by the Windows NT spooler to find the</span>
02088 <span class="comment"> *       directories from which color profiles should be picked up and copied</span>
02089 <span class="comment"> *       to. This is useful if the locations are version or  processor</span>
02090 <span class="comment"> *       architecture dependent. As color profiles depend on neither, we don't</span>
02091 <span class="comment"> *       have to do anything, but have to export this function.</span>
02092 <span class="comment"> *</span>
02093 <span class="comment"> *  Arguments:</span>
02094 <span class="comment"> *       don't care</span>
02095 <span class="comment"> *</span>
02096 <span class="comment"> *  Returns:</span>
02097 <span class="comment"> *       ERROR_SUCCESS if successful, error code otherwise</span>
02098 <span class="comment"> *</span>
02099 <span class="comment"> ******************************************************************************/</span>
02100 
02101 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI
<a name="l02102"></a><a class="code" href="../../d9/d7/profman_8c.html#a94">02102</a> <a class="code" href="../../d9/d7/profman_8c.html#a94">GenerateCopyFilePaths</a>(
02103     LPCWSTR     pszPrinterName,
02104     LPCWSTR     pszDirectory,
02105     LPBYTE      pSplClientInfo,
02106     DWORD       dwLevel,
02107     LPWSTR      pszSourceDir,
02108     LPDWORD     pcchSourceDirSize,
02109     LPWSTR      pszTargetDir,
02110     LPDWORD     pcchTargetDirSize,
02111     DWORD       dwFlags
02112     )
02113 {
02114     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"GenerateCopyFilePaths\n"</span>)));
02115     <span class="keywordflow">return</span> ERROR_SUCCESS;
02116 }
02117 
02118 
02119 <span class="comment">/******************************************************************************</span>
02120 <span class="comment"> *</span>
02121 <span class="comment"> *                          SpoolerCopyFileEvent</span>
02122 <span class="comment"> *</span>
02123 <span class="comment"> *  Function:</span>
02124 <span class="comment"> *       This function is called by the Windows NT spooler when one of the</span>
02125 <span class="comment"> *       following events happens:</span>
02126 <span class="comment"> *          1. When someone does a SetPrinterDataEx of the CopyFiles section</span>
02127 <span class="comment"> *          2. When a printer connection is made</span>
02128 <span class="comment"> *          3. When files for a printer connection get updated</span>
02129 <span class="comment"> *          4. When a printer is deleted</span>
02130 <span class="comment"> *</span>
02131 <span class="comment"> *  Arguments:</span>
02132 <span class="comment"> *       pszPrinterName  - friendly name of printer</span>
02133 <span class="comment"> *       pszKey          - "CopyFiles\ICM" for us</span>
02134 <span class="comment"> *       dwCopyFileEvent - reason for calling</span>
02135 <span class="comment"> *</span>
02136 <span class="comment"> *  Returns:</span>
02137 <span class="comment"> *       TRUE if successful, NULL otherwise</span>
02138 <span class="comment"> *</span>
02139 <span class="comment"> ******************************************************************************/</span>
02140 
02141 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI
<a name="l02142"></a><a class="code" href="../../d9/d7/profman_8c.html#a95">02142</a> <a class="code" href="../../d9/d7/profman_8c.html#a95">SpoolerCopyFileEvent</a>(
02143     LPWSTR  pszPrinterName,
02144     LPWSTR  pszKey,
02145     DWORD   dwCopyFileEvent
02146     )
02147 {
02148     PTSTR pProfileList, pTemp, pBuffer;
02149     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSize;
02150     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  bRc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02151     TCHAR szPath[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
02152 
02153     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"SpoolerCopyFileEvent\n"</span>)));
02154 
02155     <span class="keywordflow">switch</span> (dwCopyFileEvent)
02156     {
02157     <span class="keywordflow">case</span> COPYFILE_EVENT_SET_PRINTER_DATAEX:
02158 
02159         <span class="comment">//</span>
02160         <span class="comment">// When associating profiles with printer connections, we copy</span>
02161         <span class="comment">// the files to the remote machine, and then do a SePrinterDataEx.</span>
02162         <span class="comment">// This causes this event to be generated on the remote machine. We</span>
02163         <span class="comment">// use this to install the profile. This is not needed after we make</span>
02164         <span class="comment">// our APIs remotable</span>
02165         <span class="comment">//</span>
02166         <span class="comment">// Fall thru'</span>
02167         <span class="comment">//</span>
02168 
02169         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a3">TERSE</a>((__TEXT(<span class="stringliteral">"SetPrinterDataEx event\n"</span>)));
02170 
02171     <span class="keywordflow">case</span> COPYFILE_EVENT_ADD_PRINTER_CONNECTION:
02172     <span class="keywordflow">case</span> COPYFILE_EVENT_FILES_CHANGED:
02173 
02174         <span class="comment">//</span>
02175         <span class="comment">// This event is generated when a printer connection is added or</span>
02176         <span class="comment">// associated profiles have changed. Install all the profiles in</span>
02177         <span class="comment">// the client machine now.</span>
02178         <span class="comment">//</span>
02179 
02180 <span class="preprocessor">        #ifdef DBG</span>
02181 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (dwCopyFileEvent == COPYFILE_EVENT_ADD_PRINTER_CONNECTION)
02182         {
02183             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"AddPrinterConnection Event\n"</span>)));
02184         }
02185         <span class="keywordflow">else</span>  <span class="keywordflow">if</span> (dwCopyFileEvent == COPYFILE_EVENT_FILES_CHANGED)
02186         {
02187             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"FilesChanged Event\n"</span>)));
02188         }
02189 <span class="preprocessor">        #endif</span>
02190 <span class="preprocessor"></span>
02191         dwSize = 0;
02192         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d7/profman_8c.html#a54">GetDeviceData</a>((PTSTR)pszPrinterName, CLASS_PRINTER, <a class="code" href="../../d9/d7/profman_8c.html#a8">DEVICE_PROFILE_DATA</a>,
02193                           (PVOID *)&amp;pProfileList, &amp;dwSize, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
02194         {
02195             dwSize = <span class="keyword">sizeof</span>(szPath);
02196             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d7/profman_8c.html#a43">InternalGetColorDirectory</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, szPath, &amp;dwSize))
02197             {
02198                 lstrcat(szPath, <a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a21">gszBackslash</a>);
02199                 pBuffer = szPath + lstrlen(szPath);
02200                 pTemp = pProfileList;
02201                 <span class="keywordflow">while</span> (*pTemp)
02202                 {
02203                     lstrcpy(pBuffer, pTemp);
02204                     InstallColorProfile(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, szPath);
02205                     pTemp += lstrlen(pTemp) + 1;
02206                 }
02207             }
02208 
02209             <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pProfileList);
02210         }
02211         <span class="keywordflow">break</span>;
02212 
02213     <span class="keywordflow">case</span> COPYFILE_EVENT_DELETE_PRINTER:
02214 
02215         <span class="comment">//</span>
02216         <span class="comment">// This event is generated when a printer is about to be deleted.</span>
02217         <span class="comment">// Get all profiles associated with the printer and disassociate</span>
02218         <span class="comment">// them now.</span>
02219         <span class="comment">//</span>
02220 
02221         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a3">TERSE</a>((__TEXT(<span class="stringliteral">"DeletePrinterDataEx Event\n"</span>)));
02222 
02223         dwSize = 0;
02224         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d7/profman_8c.html#a54">GetDeviceData</a>((PTSTR)pszPrinterName, CLASS_PRINTER, <a class="code" href="../../d9/d7/profman_8c.html#a8">DEVICE_PROFILE_DATA</a>,
02225                           (PVOID *)&amp;pProfileList, &amp;dwSize, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
02226         {
02227             pTemp = pProfileList;
02228             <span class="keywordflow">while</span> (*pTemp)
02229             {
02230                 DisassociateColorProfileFromDevice(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pTemp, (PTSTR)pszPrinterName);
02231                 pTemp += lstrlen(pTemp) + 1;
02232             }
02233 
02234             <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pProfileList);
02235         }
02236         <span class="keywordflow">break</span>;
02237     }
02238 
02239     bRc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02240 
02241     <span class="keywordflow">return</span> bRc;
02242 }
02243 
02244 
02245 <span class="comment">/*****************************************************************************/</span>
02246 <span class="comment">/***************************** Internal Functions ****************************/</span>
02247 <span class="comment">/*****************************************************************************/</span>
02248 
02249 <span class="comment">/******************************************************************************</span>
02250 <span class="comment"> *</span>
02251 <span class="comment"> *                         InternalGetColorDirectory</span>
02252 <span class="comment"> *</span>
02253 <span class="comment"> *  Function:</span>
02254 <span class="comment"> *       This function returns the path to the color directory on the machine</span>
02255 <span class="comment"> *       specified.</span>
02256 <span class="comment"> *       associations should be removed before calling this function. It also</span>
02257 <span class="comment"> *       optionally deletes the file if the profile was successfully</span>
02258 <span class="comment"> *       uninstalled.</span>
02259 <span class="comment"> *</span>
02260 <span class="comment"> *  Arguments:</span>
02261 <span class="comment"> *       pMachineName    - name identifying machine on which the path</span>
02262 <span class="comment"> *                         to the color directory is requested</span>
02263 <span class="comment"> *       pBuffer         - pointer to buffer to receive pathname</span>
02264 <span class="comment"> *       pdwSize         - pointer to size of buffer. On return it has size of</span>
02265 <span class="comment"> *                         buffer needed if failure, and used on success</span>
02266 <span class="comment"> *</span>
02267 <span class="comment"> *  Returns:</span>
02268 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
02269 <span class="comment"> *</span>
02270 <span class="comment"> ******************************************************************************/</span>
02271 
02272 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l02273"></a><a class="code" href="../../d9/d7/profman_8c.html#a43">02273</a> <a class="code" href="../../d9/d7/profman_8c.html#a43">InternalGetColorDirectory</a>(
02274     LPCTSTR  pMachineName,
02275     PTSTR    pBuffer,
02276     DWORD   *pdwSize
02277     )
02278 {
02279     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwBufLen = *pdwSize;      <span class="comment">// size supplied</span>
02280     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;               <span class="comment">// return value</span>
02281 
02282     <span class="comment">//</span>
02283     <span class="comment">// Get the printer driver directory</span>
02284     <span class="comment">//</span>
02285 
02286 <span class="preprocessor">#if !defined(_WIN95_)</span>
02287 <span class="preprocessor"></span>
02288     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwNeeded;                 <span class="comment">// size needed</span>
02289 
02290     <span class="keywordflow">if</span> (!pBuffer &amp;&amp; pdwSize &amp;&amp; !IsBadWritePtr(pdwSize, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)))
02291     {
02292         *pdwSize = 0;
02293     }
02294 
02295     <span class="keywordflow">if</span> (GetPrinterDriverDirectory((PTSTR)pMachineName, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 1, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pBuffer,
02296         *pdwSize, pdwSize))
02297     {
02298         <span class="comment">//</span>
02299         <span class="comment">// This API returns the print$ path appended with the environment</span>
02300         <span class="comment">// directory. e.g. c:\winnt\system32\spool\drivers\w32x86. So we need</span>
02301         <span class="comment">// to go back one step and then append the color directory.</span>
02302         <span class="comment">//</span>
02303 
02304         PWSTR pDriverDir;
02305 
02306         pDriverDir = <a class="code" href="../../d9/d7/profman_8c.html#a96">GetFilenameFromPath</a>(pBuffer);
02307 
02308         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (pDriverDir != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02309 
02310         *pdwSize -= lstrlen(pDriverDir) * <span class="keyword">sizeof</span>(WCHAR);
02311 
02312         *pDriverDir = <span class="charliteral">'\0'</span>;
02313 
02314         <span class="comment">//</span>
02315         <span class="comment">// Calculate size of buffer needed to append color directory</span>
02316         <span class="comment">//</span>
02317 
02318         dwNeeded = *pdwSize + lstrlen(<a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a20">gszColorDir</a>) * <span class="keyword">sizeof</span>(WCHAR);
02319         <span class="keywordflow">if</span> (pBuffer[lstrlen(pBuffer) - 1] != <span class="charliteral">'\\'</span>)
02320         {
02321             dwNeeded += <span class="keyword">sizeof</span>(WCHAR);
02322         }
02323 
02324         <span class="comment">//</span>
02325         <span class="comment">// Update size needed</span>
02326         <span class="comment">//</span>
02327 
02328         *pdwSize = dwNeeded;
02329 
02330         <span class="comment">//</span>
02331         <span class="comment">// If supplied buffer is big enough, append our stuff</span>
02332         <span class="comment">//</span>
02333 
02334         <span class="keywordflow">if</span> (dwNeeded &lt;= dwBufLen)
02335         {
02336             <span class="keywordflow">if</span> (pBuffer[lstrlen(pBuffer) - 1] != <span class="charliteral">'\\'</span>)
02337             {
02338                 lstrcat(pBuffer, <a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a21">gszBackslash</a>);
02339             }
02340 
02341             lstrcat(pBuffer, <a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a20">gszColorDir</a>);
02342 
02343             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02344         }
02345         <span class="keywordflow">else</span>
02346         {
02347             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Input buffer to GetColorDirectory not big enough\n"</span>)));
02348             SetLastError(ERROR_INSUFFICIENT_BUFFER);
02349         }
02350     }
02351     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (GetLastError() == ERROR_INVALID_USER_BUFFER)
02352     {
02353         <span class="comment">//</span>
02354         <span class="comment">// Spooler sets this error if buffer is NULL. Map it to our error</span>
02355         <span class="comment">//</span>
02356 
02357         SetLastError(ERROR_INSUFFICIENT_BUFFER);
02358     }
02359     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (GetLastError() == RPC_S_SERVER_UNAVAILABLE)
02360     {
02361         TCHAR achTempPath[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a> * 2]; <span class="comment">// Make sure enough path space.</span>
02362 
02363         <span class="comment">//</span>
02364         <span class="comment">// Spooler service is not running. Use hardcoded path</span>
02365         <span class="comment">//</span>
02366 
02367         <span class="keywordflow">if</span> (GetSystemDirectory(achTempPath,<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>) != 0)
02368         {
02369             _tcscat(achTempPath,TEXT(<span class="stringliteral">"\\spool\\drivers\\color"</span>));
02370 
02371             *pdwSize = wcslen(achTempPath) + 1;
02372 
02373             <span class="keywordflow">if</span> (pBuffer &amp;&amp; (*pdwSize &lt;= dwBufLen))
02374             {
02375                 _tcscpy(pBuffer,achTempPath);
02376 
02377                 rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02378             }
02379             <span class="keywordflow">else</span>
02380             {
02381                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Input buffer to GetColorDirectory not big enough\n"</span>)));
02382                 SetLastError(ERROR_INSUFFICIENT_BUFFER);
02383             }
02384         }
02385     }
02386 
02387 <span class="preprocessor">#else</span>
02388 <span class="preprocessor"></span>
02389     HKEY  hkSetup;                  <span class="comment">// registry key</span>
02390     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwErr;                    <span class="comment">// error code</span>
02391 
02392     <span class="comment">//</span>
02393     <span class="comment">// Only local color directory query is allowed in Memphis</span>
02394     <span class="comment">//</span>
02395 
02396     <span class="keywordflow">if</span> (pMachineName)
02397     {
02398         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Remote color directory query, failing...\n"</span>)));
02399         SetLastError(ERROR_INVALID_PARAMETER);
02400         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02401     }
02402 
02403     <span class="comment">//</span>
02404     <span class="comment">// On Memphis, get this information from the setup section in the registry.</span>
02405     <span class="comment">// The reason we don't call GetPrinterDriverDirectory is that when we call</span>
02406     <span class="comment">// this function from GDI 16, it tries to go back into 16-bit mode and</span>
02407     <span class="comment">// deadlocks on the Win16 lock.</span>
02408     <span class="comment">//</span>
02409 
02410     <span class="keywordflow">if</span> ((dwErr = RegOpenKey(HKEY_LOCAL_MACHINE, gszSetupPath, &amp;hkSetup)) == ERROR_SUCCESS)
02411     {
02412         <span class="keywordflow">if</span> ((dwErr = RegQueryValueEx(hkSetup, gszICMDir, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pBuffer,
02413                 pdwSize)) == ERROR_SUCCESS)
02414         {
02415             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02416         }
02417         RegCloseKey(hkSetup);
02418     }
02419 
02420     <span class="keywordflow">if</span> (!rc)
02421     {
02422         <span class="comment">//</span>
02423         <span class="comment">// Make error codes consistent</span>
02424         <span class="comment">//</span>
02425 
02426         <span class="keywordflow">if</span> (dwErr == ERROR_MORE_DATA)
02427         {
02428             dwErr = ERROR_INSUFFICIENT_BUFFER;
02429         }
02430 
02431         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error getting color directory: %d\n"</span>), dwErr));
02432         SetLastError(dwErr);
02433     }
02434 
02435     <span class="comment">//</span>
02436     <span class="comment">// RegQueryValueEx returns TRUE even if the calling buffer is NULL. Our API</span>
02437     <span class="comment">// is supposed to return FALSE. Check for this case.</span>
02438     <span class="comment">//</span>
02439 
02440     <span class="keywordflow">if</span> (pBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; rc)
02441     {
02442         SetLastError(ERROR_INSUFFICIENT_BUFFER);
02443         rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02444     }
02445 
02446 <span class="preprocessor">#endif // !defined(_WIN95_)</span>
02447 <span class="preprocessor"></span>
02448     <span class="keywordflow">return</span> rc;
02449 }
02450 
02451 
02452 <span class="comment">/******************************************************************************</span>
02453 <span class="comment"> *</span>
02454 <span class="comment"> *                         InternalInstallColorProfile</span>
02455 <span class="comment"> *</span>
02456 <span class="comment"> *  Function:</span>
02457 <span class="comment"> *       This function installs a given color profile on a a given machine.</span>
02458 <span class="comment"> *</span>
02459 <span class="comment"> *  Arguments:</span>
02460 <span class="comment"> *       pMachineName    - name identifying machine on which the profile</span>
02461 <span class="comment"> *                         should be uninstalled. NULL implies local</span>
02462 <span class="comment"> *       pProfileName    - Fully qualified pathname of profile to uninstall</span>
02463 <span class="comment"> *       bDelete         - TRUE if profile should be deleted in disk</span>
02464 <span class="comment"> *</span>
02465 <span class="comment"> *  Returns:</span>
02466 <span class="comment"> *       TRUE if successful, NULL otherwise</span>
02467 <span class="comment"> *</span>
02468 <span class="comment"> *  Warning:</span>
02469 <span class="comment"> *       Currently only local install is supported, so pMachineName should</span>
02470 <span class="comment"> *       be NULL.</span>
02471 <span class="comment"> *</span>
02472 <span class="comment"> ******************************************************************************/</span>
02473 
02474 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l02475"></a><a class="code" href="../../d9/d7/profman_8c.html#a44">02475</a> <a class="code" href="../../d9/d7/profman_8c.html#a44">InternalInstallColorProfile</a>(
02476     LPCTSTR   pMachineName,
02477     LPCTSTR   pProfileName
02478     )
02479 {
02480     PROFILEHEADER header;           <span class="comment">// profile header</span>
02481     <a class="code" href="../../d2/d5/structtagREGDATA.html">REGDATA</a>  regData;               <span class="comment">// for storing registry data about profile</span>
02482     HKEY     hkICM = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;          <span class="comment">// key to ICM branch in registry</span>
02483     HKEY     hkDevice = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;       <span class="comment">// key to ICM device branch in registry</span>
02484     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwSize;                <span class="comment">// size of registry data for profile</span>
02485     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwErr;                 <span class="comment">// error code</span>
02486     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;            <span class="comment">// return code</span>
02487     PTSTR    pFilename;             <span class="comment">// profile name without path</span>
02488     TCHAR    szDest[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];      <span class="comment">// destination path for profile</span>
02489     TCHAR    szClass[5];            <span class="comment">// profile class</span>
02490     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     FileExist;             <span class="comment">// profile already in directory?</span>
02491     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     RegExist;              <span class="comment">// profile in registry?</span>
02492     
02493     <span class="comment">//</span>
02494     <span class="comment">// Validate parameters</span>
02495     <span class="comment">//</span>
02496     
02497     <span class="keywordflow">if</span> (!pProfileName)
02498     {
02499         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to InstallColorProfile\n"</span>)));
02500         SetLastError(ERROR_INVALID_PARAMETER);
02501         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02502     }
02503 
02504     <span class="comment">//</span>
02505     <span class="comment">// Only local installs are allowed now</span>
02506     <span class="comment">//</span>
02507 
02508     <span class="keywordflow">if</span> (pMachineName)
02509     {
02510         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Remote install attempted, failing...\n"</span>)));
02511         SetLastError(ERROR_INVALID_PARAMETER);
02512         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02513     }
02514 
02515     <span class="comment">//</span>
02516     <span class="comment">// Get rid of the directory path and get a pointer to the filename</span>
02517     <span class="comment">//</span>
02518 
02519     pFilename = <a class="code" href="../../d9/d7/profman_8c.html#a96">GetFilenameFromPath</a>((PTSTR)pProfileName);
02520     <span class="keywordflow">if</span> (! pFilename)
02521     {
02522         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Could not parse file name from profile path %s\n"</span>), pProfileName));
02523         SetLastError(ERROR_INVALID_PARAMETER);
02524         <span class="keywordflow">goto</span> EndInstallColorProfile;
02525     }
02526 
02527     <span class="comment">//</span>
02528     <span class="comment">// Get the profile class in the form of a string</span>
02529     <span class="comment">//</span>
02530 
02531     <span class="keywordflow">if</span> (! <a class="code" href="../../d9/d7/profman_8c.html#a53">GetProfileClassString</a>(pProfileName, szClass, &amp;header))
02532     {
02533         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Installing invalid profile %s\n"</span>), pProfileName));
02534         SetLastError(ERROR_INVALID_PROFILE);
02535         <span class="keywordflow">goto</span> EndInstallColorProfile;
02536     }
02537 
02538     <span class="comment">//</span>
02539     <span class="comment">// Open the registry path where profiles are kept</span>
02540     <span class="comment">//</span>
02541 
02542     <span class="keywordflow">if</span> (((dwErr = RegCreateKey(HKEY_LOCAL_MACHINE, <a class="code" href="../../d4/d9/icmupg_8c.html#a8">gszICMRegPath</a>, &amp;hkICM)) != ERROR_SUCCESS) ||
02543         ((dwErr = RegCreateKey(hkICM, szClass, &amp;hkDevice)) != ERROR_SUCCESS))
02544     {
02545         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Cannot open ICM\\device branch of registry: %d\n"</span>), dwErr));
02546         SetLastError(dwErr);
02547         <span class="keywordflow">goto</span> EndInstallColorProfile;
02548     }
02549 
02550 
02551     <span class="comment">//</span>
02552     <span class="comment">// If registry data exists &amp;&amp; the profile is in the directory,  then the profile is already installed,</span>
02553     <span class="comment">// in which case, return success. Otherwise, copy profile to color</span>
02554     <span class="comment">// directory (if it's not already there) and add it to the registry (if it's not already there).</span>
02555     <span class="comment">//</span>
02556 
02557     dwSize = <span class="keyword">sizeof</span>(szDest);
02558         
02559     <span class="comment">//</span>
02560     <span class="comment">// Copy the file to the color directory</span>
02561     <span class="comment">//</span>
02562 
02563     <span class="keywordflow">if</span> (! <a class="code" href="../../d9/d7/profman_8c.html#a43">InternalGetColorDirectory</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, szDest, &amp;dwSize))
02564     {
02565         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Could not get color directory\n"</span>)));
02566         <span class="keywordflow">goto</span> EndInstallColorProfile;
02567     }
02568 
02569     <span class="comment">//</span>
02570     <span class="comment">// This creates the directory if it doesn't exist, doesn't do anything</span>
02571     <span class="comment">// if it already exists</span>
02572     <span class="comment">//</span>
02573 
02574     CreateDirectory(szDest, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02575 
02576     <span class="keywordflow">if</span> (szDest[lstrlen(szDest) - 1] != <span class="charliteral">'\\'</span>)
02577     {
02578         lstrcat(szDest, <a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a21">gszBackslash</a>);
02579     }
02580     lstrcat(szDest, pFilename);
02581 
02582     <span class="comment">//</span>
02583     <span class="comment">// If the profile is already in the color directory, do not attempt</span>
02584     <span class="comment">// to copy it again; it will fail.</span>
02585     <span class="comment">//</span>
02586         
02587     dwSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/structtagREGDATA.html">REGDATA</a>);
02588     
02589     FileExist = GetFileAttributes(szDest) != (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1;
02590     RegExist = RegQueryValueEx(hkDevice, pFilename, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;regData, &amp;dwSize) == ERROR_SUCCESS;
02591 
02592     <span class="comment">//</span>
02593     <span class="comment">// If the file does exist, short circuit the CopyFile </span>
02594     <span class="comment">// and go on to add it into the registry.</span>
02595     <span class="comment">//</span>
02596 
02597     <span class="keywordflow">if</span> (!FileExist &amp;&amp; !CopyFile(pProfileName, szDest, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>))
02598     {
02599         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Could not copy profile %s to color directory\n"</span>), pProfileName));
02600         <span class="keywordflow">goto</span> EndInstallColorProfile;
02601     }
02602 
02603     <span class="comment">//</span>
02604     <span class="comment">// Add profile to the registry</span>
02605     <span class="comment">//</span>
02606 
02607     <span class="keywordflow">if</span>(!RegExist) 
02608     {
02609         regData.dwRefCount = 0;
02610         regData.dwManuID = FIX_ENDIAN(header.phManufacturer);
02611         regData.dwModelID = FIX_ENDIAN(header.phModel);
02612         <span class="keywordflow">if</span> ((dwErr = RegSetValueEx(hkDevice, pFilename, 0, REG_BINARY,
02613                   (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;regData, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/structtagREGDATA.html">REGDATA</a>))) != ERROR_SUCCESS)
02614         {
02615             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Could not set registry data to install profile %s: %d\n"</span>), pFilename, dwErr));
02616             SetLastError(dwErr);
02617             <span class="keywordflow">goto</span> EndInstallColorProfile;
02618         }
02619     }
02620     
02621     rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;              <span class="comment">// Everything went well!</span>
02622 
02623 EndInstallColorProfile:    
02624     <span class="keywordflow">if</span> (hkICM)
02625     {
02626         RegCloseKey(hkICM);
02627     }
02628     <span class="keywordflow">if</span> (hkDevice)
02629     {
02630         RegCloseKey(hkDevice);
02631     }
02632 
02633     <span class="keywordflow">return</span> rc;
02634 }
02635 
02636 
02637 <span class="comment">/******************************************************************************</span>
02638 <span class="comment"> *</span>
02639 <span class="comment"> *                         InternalUninstallColorProfile</span>
02640 <span class="comment"> *</span>
02641 <span class="comment"> *  Function:</span>
02642 <span class="comment"> *       This function uninstalls a given color profile on a a given machine.</span>
02643 <span class="comment"> *       It fails if the color profile is associated with any device, so all</span>
02644 <span class="comment"> *       associations should be removed before calling this function. It also</span>
02645 <span class="comment"> *       optionally deletes the file if the profile was successfully</span>
02646 <span class="comment"> *       uninstalled.</span>
02647 <span class="comment"> *</span>
02648 <span class="comment"> *  Arguments:</span>
02649 <span class="comment"> *       pMachineName    - name identifying machine on which the profile</span>
02650 <span class="comment"> *                         should be uninstalled. NULL implies local</span>
02651 <span class="comment"> *       pProfileName    - pointer to profile to uninstall</span>
02652 <span class="comment"> *       bDelete         - TRUE if profile should be deleted in disk</span>
02653 <span class="comment"> *</span>
02654 <span class="comment"> *  Returns:</span>
02655 <span class="comment"> *       TRUE if successful, NULL otherwise</span>
02656 <span class="comment"> *</span>
02657 <span class="comment"> *  Warning:</span>
02658 <span class="comment"> *       Currently only local uninstall is supported, so pMachineName should</span>
02659 <span class="comment"> *       be NULL.</span>
02660 <span class="comment"> *</span>
02661 <span class="comment"> ******************************************************************************/</span>
02662 
02663 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l02664"></a><a class="code" href="../../d9/d7/profman_8c.html#a45">02664</a> <a class="code" href="../../d9/d7/profman_8c.html#a45">InternalUninstallColorProfile</a>(
02665     LPCTSTR pMachineName,
02666     LPCTSTR pProfileName,
02667     BOOL    bDelete
02668     )
02669 {
02670     <a class="code" href="../../d2/d5/structtagREGDATA.html">REGDATA</a>  regData;               <span class="comment">// for storing registry data about profile</span>
02671     HKEY     hkICM = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;          <span class="comment">// key to ICM branch in registry</span>
02672     HKEY     hkDevice = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;       <span class="comment">// key to ICM device branch in registry</span>
02673     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwSize;                <span class="comment">// size of registry data for profile</span>
02674     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwErr;                 <span class="comment">// error code</span>
02675     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;            <span class="comment">// return code</span>
02676     PTSTR    pFilename;             <span class="comment">// profile name without path</span>
02677     TCHAR    szColorPath[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>]; <span class="comment">// full path name of profile</span>
02678     TCHAR    szClass[5];            <span class="comment">// profile class</span>
02679 
02680     <span class="comment">//</span>
02681     <span class="comment">// Validate parameters</span>
02682     <span class="comment">//</span>
02683 
02684     <span class="keywordflow">if</span> (!pProfileName)
02685     {
02686         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to UninstallColorProfile\n"</span>)));
02687         SetLastError(ERROR_INVALID_PARAMETER);
02688         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02689     }
02690 
02691     <span class="comment">//</span>
02692     <span class="comment">// Only local installs are allowed now</span>
02693     <span class="comment">//</span>
02694 
02695     <span class="keywordflow">if</span> (pMachineName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02696     {
02697         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Remote uninstall attempted, failing...\n"</span>)));
02698         SetLastError(ERROR_NOT_SUPPORTED);
02699         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02700     }
02701 
02702     <span class="comment">//</span>
02703     <span class="comment">// Get rid of the directory path and get a pointer to the filename</span>
02704     <span class="comment">//</span>
02705 
02706     pFilename = <a class="code" href="../../d9/d7/profman_8c.html#a96">GetFilenameFromPath</a>((PTSTR)pProfileName);
02707     <span class="keywordflow">if</span> (! pFilename)
02708     {
02709         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Could not parse file name from profile path\n"</span>), pProfileName));
02710         SetLastError(ERROR_INVALID_PARAMETER);
02711         <span class="keywordflow">goto</span> EndUninstallColorProfile;
02712     }
02713 
02714     <span class="comment">//</span>
02715     <span class="comment">// Create a fully qualified path name</span>
02716     <span class="comment">//</span>
02717 
02718     dwSize = <span class="keyword">sizeof</span>(szColorPath);
02719     <span class="keywordflow">if</span> (! <a class="code" href="../../d9/d7/profman_8c.html#a43">InternalGetColorDirectory</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, szColorPath, &amp;dwSize))
02720     {
02721         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Could not get color directory\n"</span>)));
02722         <span class="keywordflow">goto</span> EndUninstallColorProfile;
02723     }
02724 
02725     <span class="keywordflow">if</span> (szColorPath[lstrlen(szColorPath) - 1] != <span class="charliteral">'\\'</span>)
02726     {
02727         lstrcat(szColorPath, <a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a21">gszBackslash</a>);
02728     }
02729     lstrcat(szColorPath, pFilename);
02730 
02731     <span class="comment">//</span>
02732     <span class="comment">// Get the profile class in the form of a string</span>
02733     <span class="comment">//</span>
02734 
02735     <span class="keywordflow">if</span> (! <a class="code" href="../../d9/d7/profman_8c.html#a53">GetProfileClassString</a>(szColorPath, szClass, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))
02736     {
02737         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Installing invalid profile\n"</span>)));
02738         SetLastError(ERROR_INVALID_PROFILE);
02739         <span class="keywordflow">goto</span> EndUninstallColorProfile;
02740     }
02741 
02742     <span class="comment">//</span>
02743     <span class="comment">// Open the registry path where profiles are kept</span>
02744     <span class="comment">//</span>
02745 
02746     <span class="keywordflow">if</span> (((dwErr = RegOpenKey(HKEY_LOCAL_MACHINE, <a class="code" href="../../d4/d9/icmupg_8c.html#a8">gszICMRegPath</a>, &amp;hkICM)) != ERROR_SUCCESS) ||
02747         ((dwErr = RegOpenKey(hkICM, szClass, &amp;hkDevice)) != ERROR_SUCCESS))
02748     {
02749         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Cannot open ICM\\device branch of registry: %d\n"</span>), dwErr));
02750         SetLastError(dwErr);
02751         <span class="keywordflow">goto</span> EndUninstallColorProfile;
02752     }
02753 
02754     <span class="comment">//</span>
02755     <span class="comment">// Check if reference count is zero and remove value from registry</span>
02756     <span class="comment">//</span>
02757 
02758     dwSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/structtagREGDATA.html">REGDATA</a>);
02759     <span class="keywordflow">if</span> ((dwErr = RegQueryValueEx(hkDevice, pFilename, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;regData,
02760             &amp;dwSize)) != ERROR_SUCCESS)
02761     {
02762         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Trying to uninstall a profile that is not installed %s: %d\n"</span>), pFilename, dwErr));
02763         SetLastError(dwErr);
02764         <span class="keywordflow">goto</span> EndUninstallColorProfile;
02765     }
02766 
02767     <span class="keywordflow">if</span> (regData.dwRefCount != 0)
02768     {
02769         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Trying to uninstall profile %s whose refcount is %d\n"</span>),
02770             pFilename, regData.dwRefCount));
02771         <span class="keywordflow">goto</span> EndUninstallColorProfile;
02772     }
02773 
02774     <span class="keywordflow">if</span> ((dwErr = RegDeleteValue(hkDevice, pFilename)) != ERROR_SUCCESS)
02775     {
02776         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error deleting profile %s from registry: %d\n"</span>), pFilename, dwErr));
02777         SetLastError(dwErr);
02778         <span class="keywordflow">goto</span> EndUninstallColorProfile;
02779     }
02780 
02781     <span class="comment">//</span>
02782     <span class="comment">// Remove profile from the registry</span>
02783     <span class="comment">//</span>
02784 
02785     <span class="keywordflow">if</span> (bDelete)
02786     {
02787         <span class="comment">//</span>
02788         <span class="comment">// Delete profile from the color directory</span>
02789         <span class="comment">//</span>
02790 
02791         <span class="keywordflow">if</span> (! DeleteFile(szColorPath))
02792         {
02793             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error deleting profile %s: %d\n"</span>), szColorPath, GetLastError()));
02794             <span class="keywordflow">goto</span> EndUninstallColorProfile;
02795         }
02796     }
02797 
02798     rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;              <span class="comment">// Everything went well!</span>
02799 
02800 EndUninstallColorProfile:
02801     <span class="keywordflow">if</span> (hkICM)
02802     {
02803         RegCloseKey(hkICM);
02804     }
02805     <span class="keywordflow">if</span> (hkDevice)
02806     {
02807         RegCloseKey(hkDevice);
02808     }
02809 
02810     <span class="keywordflow">return</span> rc;
02811 }
02812 
02813 
02814 <span class="comment">/******************************************************************************</span>
02815 <span class="comment"> *</span>
02816 <span class="comment"> *                    InternalAssociateColorProfileWithDevice</span>
02817 <span class="comment"> *</span>
02818 <span class="comment"> *  Function:</span>
02819 <span class="comment"> *       This function associates a color profile on a a given machine with a</span>
02820 <span class="comment"> *       particular device. It fails if the color profile is not installed on</span>
02821 <span class="comment"> *       the machine. It increases the usage reference count of the profile.</span>
02822 <span class="comment"> *</span>
02823 <span class="comment"> *  Arguments:</span>
02824 <span class="comment"> *       pMachineName    - name identifying machine. NULL implies local</span>
02825 <span class="comment"> *       pProfileName    - pointer to profile to associate</span>
02826 <span class="comment"> *       pDeviceName     - pointer to device name</span>
02827 <span class="comment"> *</span>
02828 <span class="comment"> *  Returns:</span>
02829 <span class="comment"> *       TRUE if successful, NULL otherwise</span>
02830 <span class="comment"> *</span>
02831 <span class="comment"> *  Warning:</span>
02832 <span class="comment"> *       Currently only local association is supported, so pMachineName should</span>
02833 <span class="comment"> *       be NULL.</span>
02834 <span class="comment"> *</span>
02835 <span class="comment"> ******************************************************************************/</span>
02836 
02837 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l02838"></a><a class="code" href="../../d9/d7/profman_8c.html#a46">02838</a> <a class="code" href="../../d9/d7/profman_8c.html#a46">InternalAssociateColorProfileWithDevice</a>(
02839     LPCTSTR pMachineName,
02840     LPCTSTR pProfileName,
02841     LPCTSTR pDeviceName
02842     )
02843 {
02844     PROFILEHEADER header;           <span class="comment">// profile header</span>
02845     <a class="code" href="../../d2/d5/structtagREGDATA.html">REGDATA</a>  regData;               <span class="comment">// for storing registry data about profile</span>
02846     HKEY     hkICM = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;          <span class="comment">// key to ICM branch in registry</span>
02847     HKEY     hkDevice = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;       <span class="comment">// key to ICM device branch in registry</span>
02848     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwSize;                <span class="comment">// size of registry data</span>
02849     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwNewSize;             <span class="comment">// new size of device registry data</span>
02850     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwErr;                 <span class="comment">// error code</span>
02851     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;            <span class="comment">// return code</span>
02852     PTSTR    pFilename;             <span class="comment">// profile name without path</span>
02853     PTSTR    pProfileList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;   <span class="comment">// list of associated profiles</span>
02854     TCHAR    szColorPath[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>]; <span class="comment">// full path name of profile</span>
02855     TCHAR    szClass[5];            <span class="comment">// profile class</span>
02856     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     bFirstProfile = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>; <span class="comment">// First profile to be associated for device</span>
02857     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwDeviceClass;         <span class="comment">// device class</span>
02858 
02859     <span class="comment">//</span>
02860     <span class="comment">// Validate parameters</span>
02861     <span class="comment">//</span>
02862 
02863     <span class="keywordflow">if</span> (! pProfileName ||
02864         ! pDeviceName)
02865     {
02866         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to AssociateColorProfileWithDevice\n"</span>)));
02867         SetLastError(ERROR_INVALID_PARAMETER);
02868         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02869     }
02870 
02871     <span class="comment">//</span>
02872     <span class="comment">// Only local associations are allowed now</span>
02873     <span class="comment">//</span>
02874 
02875     <span class="keywordflow">if</span> (pMachineName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02876     {
02877         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Remote profile association attempted, failing...\n"</span>)));
02878         SetLastError(ERROR_NOT_SUPPORTED);
02879         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02880     }
02881 
02882     <span class="comment">//</span>
02883     <span class="comment">// Get rid of the directory path and get a pointer to the filename</span>
02884     <span class="comment">//</span>
02885 
02886     pFilename = <a class="code" href="../../d9/d7/profman_8c.html#a96">GetFilenameFromPath</a>((PTSTR)pProfileName);
02887     <span class="keywordflow">if</span> (! pFilename)
02888     {
02889         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Could not parse file name from profile path %s\n"</span>), pProfileName));
02890         SetLastError(ERROR_INVALID_PARAMETER);
02891         <span class="keywordflow">goto</span> EndAssociateProfileWithDevice;
02892     }
02893 
02894     <span class="comment">//</span>
02895     <span class="comment">// Create a fully qualified path name</span>
02896     <span class="comment">//</span>
02897 
02898     dwSize = <span class="keyword">sizeof</span>(szColorPath);
02899     <span class="keywordflow">if</span> (! <a class="code" href="../../d9/d7/profman_8c.html#a43">InternalGetColorDirectory</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, szColorPath, &amp;dwSize))
02900     {
02901         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Could not get color directory\n"</span>)));
02902         <span class="keywordflow">goto</span> EndAssociateProfileWithDevice;
02903     }
02904 
02905     <span class="keywordflow">if</span> (szColorPath[lstrlen(szColorPath) - 1] != <span class="charliteral">'\\'</span>)
02906     {
02907         lstrcat(szColorPath, <a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a21">gszBackslash</a>);
02908     }
02909     lstrcat(szColorPath, pFilename);
02910 
02911     <span class="comment">//</span>
02912     <span class="comment">// Get the profile class in the form of a string</span>
02913     <span class="comment">//</span>
02914 
02915     <span class="keywordflow">if</span> (! <a class="code" href="../../d9/d7/profman_8c.html#a53">GetProfileClassString</a>(szColorPath, szClass, &amp;header))
02916     {
02917         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Installing invalid profile %s\n"</span>), szColorPath));
02918         SetLastError(ERROR_INVALID_PROFILE);
02919         <span class="keywordflow">goto</span> EndAssociateProfileWithDevice;
02920     }
02921 
02922     <span class="comment">//</span>
02923     <span class="comment">// Open the registry path where profiles are kept</span>
02924     <span class="comment">//</span>
02925 
02926     <span class="keywordflow">if</span> (((dwErr = RegOpenKey(HKEY_LOCAL_MACHINE, <a class="code" href="../../d4/d9/icmupg_8c.html#a8">gszICMRegPath</a>, &amp;hkICM)) != ERROR_SUCCESS) ||
02927         ((dwErr = RegOpenKey(hkICM, szClass, &amp;hkDevice)) != ERROR_SUCCESS))
02928     {
02929         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Cannot open ICM\\device branch of registry: %d\n"</span>), dwErr));
02930         SetLastError(dwErr);
02931         <span class="keywordflow">goto</span> EndAssociateProfileWithDevice;
02932     }
02933 
02934     <span class="comment">//</span>
02935     <span class="comment">// Check if profile is installed</span>
02936     <span class="comment">//</span>
02937 
02938     dwSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/structtagREGDATA.html">REGDATA</a>);
02939     <span class="keywordflow">if</span> ((dwErr = RegQueryValueEx(hkDevice, pFilename, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;regData,
02940             &amp;dwSize)) != ERROR_SUCCESS)
02941     {
02942         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Trying to associate a profile that is not installed %s: %d\n"</span>), pFilename, dwErr));
02943         SetLastError(dwErr);
02944         <span class="keywordflow">goto</span> EndAssociateProfileWithDevice;
02945     }
02946 
02947     <span class="comment">//</span>
02948     <span class="comment">// Treat CLASS_MONITOR as CLASS_COLORSPACE.</span>
02949     <span class="comment">//</span>
02950     <span class="keywordflow">if</span> ((dwDeviceClass = header.phClass) == CLASS_MONITOR)
02951     {
02952         <span class="comment">//</span>
02953         <span class="comment">// since CLASS_MONTOR profile can be associated any device class.</span>
02954         <span class="comment">//</span>
02955         dwDeviceClass = CLASS_COLORSPACE;
02956     }
02957 
02958     <span class="comment">//</span>
02959     <span class="comment">// Read in the list of profiles associated with the device</span>
02960     <span class="comment">//</span>
02961 
02962     dwSize = 0;
02963     <span class="keywordflow">if</span> (! <a class="code" href="../../d9/d7/profman_8c.html#a54">GetDeviceData</a>(pDeviceName, dwDeviceClass, <a class="code" href="../../d9/d7/profman_8c.html#a8">DEVICE_PROFILE_DATA</a>,
02964                         (PVOID *)&amp;pProfileList, &amp;dwSize, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
02965     {
02966         pProfileList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;        <span class="comment">// no data found</span>
02967     }
02968 
02969     <span class="comment">//</span>
02970     <span class="comment">// If the profile is already associated with the device, return success.</span>
02971     <span class="comment">// Do not check if we didn't get a profile list</span>
02972     <span class="comment">//</span>
02973 
02974     <span class="keywordflow">if</span> (pProfileList &amp;&amp;
02975         <a class="code" href="../../d9/d7/profman_8c.html#a58">IsStringInMultiSz</a>(pProfileList, pFilename) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)
02976     {
02977         rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02978         <span class="keywordflow">goto</span> EndAssociateProfileWithDevice;
02979     }
02980 
02981     <span class="keywordflow">if</span> (dwSize &lt;= <span class="keyword">sizeof</span>(TCHAR))
02982     {
02983         bFirstProfile = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02984     }
02985 
02986     <span class="comment">//</span>
02987     <span class="comment">// Add new profile to the list of profiles, and double NULL</span>
02988     <span class="comment">// terminate the MULTI_SZ string.</span>
02989     <span class="comment">//</span>
02990 
02991     <span class="keywordflow">if</span> (dwSize &gt; 0)
02992     {
02993         <span class="comment">//</span>
02994         <span class="comment">// Use a temporary pointer, so that if MemReAlloc fails, we do</span>
02995         <span class="comment">// not have a memory leak - the original pointer needs to be freed</span>
02996         <span class="comment">//</span>
02997 
02998         PTSTR pTemp;
02999 
03000         dwNewSize = dwSize + (lstrlen(pFilename) + 1) * <span class="keyword">sizeof</span>(TCHAR);
03001 
03002         pTemp = <a class="code" href="../../d2/d1/object_8c.html#a8">MemReAlloc</a>(pProfileList, dwNewSize);
03003         <span class="keywordflow">if</span> (! pTemp)
03004         {
03005             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error reallocating pProfileList\n"</span>)));
03006             SetLastError(ERROR_NOT_ENOUGH_MEMORY);
03007             <span class="keywordflow">goto</span> EndAssociateProfileWithDevice;
03008         }
03009         <span class="keywordflow">else</span>
03010             pProfileList = pTemp;
03011     }
03012     <span class="keywordflow">else</span>
03013     {
03014         <span class="comment">//</span>
03015         <span class="comment">// Allocate extra character for double NULL termination. Setting</span>
03016         <span class="comment">// dwSize to 1 accomplishes this and lets the lstrcpy below</span>
03017         <span class="comment">// to work correctly.</span>
03018         <span class="comment">//</span>
03019 
03020         dwSize = <span class="keyword">sizeof</span>(TCHAR);     <span class="comment">// extra char for double NULL termination</span>
03021 
03022         dwNewSize = dwSize + (lstrlen(pFilename) + 1) * <span class="keyword">sizeof</span>(TCHAR);
03023         pProfileList = <a class="code" href="../../d2/d1/object_8c.html#a7">MemAlloc</a>(dwNewSize);
03024         <span class="keywordflow">if</span> (! pProfileList)
03025         {
03026             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error allocating pProfileList\n"</span>)));
03027             SetLastError(ERROR_NOT_ENOUGH_MEMORY);
03028             <span class="keywordflow">goto</span> EndAssociateProfileWithDevice;
03029         }
03030     }
03031     {
03032         PTSTR pPtr;                 <span class="comment">// temporary pointer</span>
03033 
03034         pPtr = (PTSTR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pProfileList + dwSize - <span class="keyword">sizeof</span>(TCHAR));
03035         lstrcpy(pPtr, pFilename);
03036         pPtr = (PTSTR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pProfileList + dwNewSize - <span class="keyword">sizeof</span>(TCHAR));
03037         *pPtr = <span class="charliteral">'\0'</span>;               <span class="comment">// double NULL terminate</span>
03038     }
03039 
03040     <span class="comment">//</span>
03041     <span class="comment">// Set the device data</span>
03042     <span class="comment">//</span>
03043 
03044     <span class="keywordflow">if</span> (! <a class="code" href="../../d9/d7/profman_8c.html#a55">SetDeviceData</a>(pDeviceName, dwDeviceClass, <a class="code" href="../../d9/d7/profman_8c.html#a8">DEVICE_PROFILE_DATA</a>,
03045                         pProfileList, dwNewSize))
03046     {
03047         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error setting device profile data for %s\n"</span>), pDeviceName));
03048         <span class="keywordflow">goto</span> EndAssociateProfileWithDevice;
03049     }
03050 
03051     <span class="comment">//</span>
03052     <span class="comment">// Increment usage count and set it</span>
03053     <span class="comment">//</span>
03054 
03055     regData.dwRefCount++;
03056     <span class="keywordflow">if</span> ((dwErr = RegSetValueEx(hkDevice, pFilename, 0, REG_BINARY,
03057             (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;regData, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/structtagREGDATA.html">REGDATA</a>))) != ERROR_SUCCESS)
03058     {
03059         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a5">ERR</a>((__TEXT(<span class="stringliteral">"Could not set registry data for profile %s: %d\n"</span>), pFilename, dwErr));
03060         SetLastError(dwErr);
03061         <span class="keywordflow">goto</span> EndAssociateProfileWithDevice;
03062     }
03063 
03064 <span class="preprocessor">    #if !defined(_WIN95_)</span>
03065 <span class="preprocessor"></span>
03066     <span class="keywordflow">if</span> (bFirstProfile)
03067     {
03068         <a class="code" href="../../d9/d7/profman_8c.html#a77">ChangeICMSetting</a>(pMachineName, pDeviceName, ICM_ON);
03069     }
03070 
03071 <span class="preprocessor">    #endif</span>
03072 <span class="preprocessor"></span>
03073     rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;              <span class="comment">// Everything went well!</span>
03074 
03075 EndAssociateProfileWithDevice:
03076     <span class="keywordflow">if</span> (hkICM)
03077     {
03078         RegCloseKey(hkICM);
03079     }
03080     <span class="keywordflow">if</span> (hkDevice)
03081     {
03082         RegCloseKey(hkDevice);
03083     }
03084     <span class="keywordflow">if</span> (pProfileList)
03085     {
03086         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pProfileList);
03087     }
03088 
03089     <span class="keywordflow">return</span> rc;
03090 }
03091 
03092 
03093 <span class="comment">/******************************************************************************</span>
03094 <span class="comment"> *</span>
03095 <span class="comment"> *                    InternalDisassociateColorProfileFromDevice</span>
03096 <span class="comment"> *</span>
03097 <span class="comment"> *  Function:</span>
03098 <span class="comment"> *       This function disassociates a color profile on a a given machine from</span>
03099 <span class="comment"> *       a particular device. It fails if the color profile is not installed</span>
03100 <span class="comment"> *       on the machine and associated with the device. It decreases the usage</span>
03101 <span class="comment"> *       reference count of the profile.</span>
03102 <span class="comment"> *</span>
03103 <span class="comment"> *  Arguments:</span>
03104 <span class="comment"> *       pMachineName    - name identifying machine. NULL implies local</span>
03105 <span class="comment"> *       pProfileName    - pointer to profile to disassociate</span>
03106 <span class="comment"> *       pDeviceName     - pointer to device name</span>
03107 <span class="comment"> *</span>
03108 <span class="comment"> *  Returns:</span>
03109 <span class="comment"> *       TRUE if successful, NULL otherwise</span>
03110 <span class="comment"> *</span>
03111 <span class="comment"> *  Warning:</span>
03112 <span class="comment"> *       Currently only local disassociation is supported, so pMachineName</span>
03113 <span class="comment"> *       should be NULL.</span>
03114 <span class="comment"> *</span>
03115 <span class="comment"> ******************************************************************************/</span>
03116 
03117 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l03118"></a><a class="code" href="../../d9/d7/profman_8c.html#a47">03118</a> <a class="code" href="../../d9/d7/profman_8c.html#a47">InternalDisassociateColorProfileFromDevice</a>(
03119     LPCTSTR pMachineName,
03120     LPCTSTR pProfileName,
03121     LPCTSTR pDeviceName
03122     )
03123 {
03124     PROFILEHEADER header;           <span class="comment">// profile header</span>
03125     <a class="code" href="../../d2/d5/structtagREGDATA.html">REGDATA</a>  regData;               <span class="comment">// for storing registry data about profile</span>
03126     HKEY     hkICM = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;          <span class="comment">// key to ICM branch in registry</span>
03127     HKEY     hkDevice = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;       <span class="comment">// key to ICM device branch in registry</span>
03128     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwSize;                <span class="comment">// size of registry data</span>
03129     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwNewSize;             <span class="comment">// new size of device registry data</span>
03130     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwErr;                 <span class="comment">// error code</span>
03131     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;            <span class="comment">// return code</span>
03132     PTSTR    pFilename;             <span class="comment">// profile name without path</span>
03133     PTSTR    pProfileList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;   <span class="comment">// list of associated profiles</span>
03134     TCHAR    szColorPath[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>]; <span class="comment">// full path name of profile</span>
03135     TCHAR    szClass[5];            <span class="comment">// profile class</span>
03136     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     bLastProfile = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;  <span class="comment">// whether last profile is being removed</span>
03137     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwDeviceClass;         <span class="comment">// device class</span>
03138 
03139     <span class="comment">//</span>
03140     <span class="comment">// Validate parameters</span>
03141     <span class="comment">//</span>
03142 
03143     <span class="keywordflow">if</span> (! pProfileName ||
03144         ! pDeviceName)
03145     {
03146         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to DisassociateColorProfileFromDevice\n"</span>)));
03147         SetLastError(ERROR_INVALID_PARAMETER);
03148         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03149     }
03150 
03151     <span class="comment">//</span>
03152     <span class="comment">// Only local associations are allowed now</span>
03153     <span class="comment">//</span>
03154 
03155     <span class="keywordflow">if</span> (pMachineName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03156     {
03157         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Remote profile disassociation attempted, failing...\n"</span>)));
03158         SetLastError(ERROR_NOT_SUPPORTED);
03159         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03160     }
03161 
03162     <span class="comment">//</span>
03163     <span class="comment">// Get rid of the directory path and get a pointer to the filename</span>
03164     <span class="comment">//</span>
03165 
03166     pFilename = <a class="code" href="../../d9/d7/profman_8c.html#a96">GetFilenameFromPath</a>((PTSTR)pProfileName);
03167     <span class="keywordflow">if</span> (! pFilename)
03168     {
03169         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Could not parse file name from profile path %s\n"</span>), pProfileName));
03170         SetLastError(ERROR_INVALID_PARAMETER);
03171         <span class="keywordflow">goto</span> EndDisassociateProfileWithDevice;
03172     }
03173 
03174     <span class="comment">//</span>
03175     <span class="comment">// Create a fully qualified path name</span>
03176     <span class="comment">//</span>
03177 
03178     dwSize = <span class="keyword">sizeof</span>(szColorPath);
03179     <span class="keywordflow">if</span> (! <a class="code" href="../../d9/d7/profman_8c.html#a43">InternalGetColorDirectory</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, szColorPath, &amp;dwSize))
03180     {
03181         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Could not get color directory\n"</span>)));
03182         <span class="keywordflow">goto</span> EndDisassociateProfileWithDevice;
03183     }
03184 
03185     <span class="keywordflow">if</span> (szColorPath[lstrlen(szColorPath) - 1] != <span class="charliteral">'\\'</span>)
03186     {
03187         lstrcat(szColorPath, <a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a21">gszBackslash</a>);
03188     }
03189     lstrcat(szColorPath, pFilename);
03190 
03191     <span class="comment">//</span>
03192     <span class="comment">// Get the profile class in the form of a string</span>
03193     <span class="comment">//</span>
03194 
03195     <span class="keywordflow">if</span> (! <a class="code" href="../../d9/d7/profman_8c.html#a53">GetProfileClassString</a>(szColorPath, szClass, &amp;header))
03196     {
03197         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Installing invalid profile %s\n"</span>), szColorPath));
03198         SetLastError(ERROR_INVALID_PROFILE);
03199         <span class="keywordflow">goto</span> EndDisassociateProfileWithDevice;
03200     }
03201 
03202     <span class="comment">//</span>
03203     <span class="comment">// Open the registry path where profiles are kept</span>
03204     <span class="comment">//</span>
03205 
03206     <span class="keywordflow">if</span> (((dwErr = RegOpenKey(HKEY_LOCAL_MACHINE, <a class="code" href="../../d4/d9/icmupg_8c.html#a8">gszICMRegPath</a>, &amp;hkICM)) != ERROR_SUCCESS) ||
03207         ((dwErr = RegOpenKey(hkICM, szClass, &amp;hkDevice)) != ERROR_SUCCESS))
03208     {
03209         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Cannot open ICM\\device branch of registry: %d\n"</span>), dwErr));
03210         SetLastError(dwErr);
03211         <span class="keywordflow">goto</span> EndDisassociateProfileWithDevice;
03212     }
03213 
03214     <span class="comment">//</span>
03215     <span class="comment">// Check if profile is installed</span>
03216     <span class="comment">//</span>
03217 
03218     dwSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/structtagREGDATA.html">REGDATA</a>);
03219     <span class="keywordflow">if</span> ((dwErr = RegQueryValueEx(hkDevice, pFilename, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;regData,
03220             &amp;dwSize)) != ERROR_SUCCESS)
03221     {
03222         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Trying to disassociate a profile that is not installed %s: %d\n"</span>), pFilename, dwErr));
03223         SetLastError(dwErr);
03224         <span class="keywordflow">goto</span> EndDisassociateProfileWithDevice;
03225     }
03226 
03227     <span class="comment">//</span>
03228     <span class="comment">// Treat CLASS_MONITOR as CLASS_COLORSPACE.</span>
03229     <span class="comment">//</span>
03230     <span class="keywordflow">if</span> ((dwDeviceClass = header.phClass) == CLASS_MONITOR)
03231     {
03232         <span class="comment">//</span>
03233         <span class="comment">// since CLASS_MONTOR profile can be associated any device class.</span>
03234         <span class="comment">//</span>
03235         dwDeviceClass = CLASS_COLORSPACE;
03236     }
03237 
03238     <span class="comment">//</span>
03239     <span class="comment">// Read in the list of profiles associated with the device</span>
03240     <span class="comment">//</span>
03241 
03242     dwSize = 0;
03243     <span class="keywordflow">if</span> (! <a class="code" href="../../d9/d7/profman_8c.html#a54">GetDeviceData</a>(pDeviceName, dwDeviceClass, <a class="code" href="../../d9/d7/profman_8c.html#a8">DEVICE_PROFILE_DATA</a>,
03244                         (PVOID *)&amp;pProfileList, &amp;dwSize, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
03245     {
03246         pProfileList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;        <span class="comment">// no data found</span>
03247     }
03248 
03249     <span class="comment">//</span>
03250     <span class="comment">// If the profile is not associated with the device, return failure</span>
03251     <span class="comment">//</span>
03252 
03253     <span class="keywordflow">if</span> (! pProfileList ||
03254         ! <a class="code" href="../../d9/d7/profman_8c.html#a58">IsStringInMultiSz</a>(pProfileList, pFilename))
03255     {
03256         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Trying to disassociate a profile that is not associated %s\n"</span>), pFilename));
03257         SetLastError(ERROR_PROFILE_NOT_ASSOCIATED_WITH_DEVICE);
03258         <span class="keywordflow">goto</span> EndDisassociateProfileWithDevice;
03259     }
03260 
03261     <span class="comment">//</span>
03262     <span class="comment">// Remove profile from the list of profiles, and double NULL</span>
03263     <span class="comment">// terminate the MULTI_SZ string.</span>
03264     <span class="comment">//</span>
03265 
03266     dwNewSize = <a class="code" href="../../d9/d7/profman_8c.html#a59">RemoveStringFromMultiSz</a>(pProfileList, pFilename, dwSize);
03267 
03268     <span class="comment">//</span>
03269     <span class="comment">// Set the device data</span>
03270     <span class="comment">//</span>
03271 
03272     <span class="keywordflow">if</span> (! <a class="code" href="../../d9/d7/profman_8c.html#a55">SetDeviceData</a>(pDeviceName, dwDeviceClass, <a class="code" href="../../d9/d7/profman_8c.html#a8">DEVICE_PROFILE_DATA</a>,
03273                         pProfileList, dwNewSize))
03274     {
03275         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error setting device profile data for %s\n"</span>), pDeviceName));
03276         <span class="keywordflow">goto</span> EndDisassociateProfileWithDevice;
03277     }
03278 
03279     <span class="keywordflow">if</span> (dwNewSize &lt;= <span class="keyword">sizeof</span>(TCHAR))
03280     {
03281         bLastProfile = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03282     }
03283 
03284     <span class="comment">//</span>
03285     <span class="comment">// Decrement usage count and set it</span>
03286     <span class="comment">//</span>
03287 
03288     regData.dwRefCount--;
03289     <span class="keywordflow">if</span> ((dwErr = RegSetValueEx(hkDevice, pFilename, 0, REG_BINARY,
03290             (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;regData, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/structtagREGDATA.html">REGDATA</a>))) != ERROR_SUCCESS)
03291     {
03292         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a5">ERR</a>((__TEXT(<span class="stringliteral">"Could not set registry data for profile %s: %d\n"</span>), pFilename, dwErr));
03293         SetLastError(dwErr);
03294         <span class="keywordflow">goto</span> EndDisassociateProfileWithDevice;
03295     }
03296 
03297 <span class="preprocessor">    #if !defined(_WIN95_)</span>
03298 <span class="preprocessor"></span>
03299     <span class="keywordflow">if</span> (bLastProfile)
03300     {
03301         <a class="code" href="../../d9/d7/profman_8c.html#a77">ChangeICMSetting</a>(pMachineName, pDeviceName, ICM_OFF);
03302     }
03303 
03304 <span class="preprocessor">    #endif</span>
03305 <span class="preprocessor"></span>
03306     rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;              <span class="comment">// Everything went well!</span>
03307 
03308 EndDisassociateProfileWithDevice:
03309     <span class="keywordflow">if</span> (hkICM)
03310     {
03311         RegCloseKey(hkICM);
03312     }
03313     <span class="keywordflow">if</span> (hkDevice)
03314     {
03315         RegCloseKey(hkDevice);
03316     }
03317     <span class="keywordflow">if</span> (pProfileList)
03318     {
03319         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pProfileList);
03320     }
03321 
03322     <span class="keywordflow">return</span> rc;
03323 }
03324 
03325 
03326 <span class="comment">/******************************************************************************</span>
03327 <span class="comment"> *</span>
03328 <span class="comment"> *                          InternalEnumColorProfiles</span>
03329 <span class="comment"> *</span>
03330 <span class="comment"> *  Function:</span>
03331 <span class="comment"> *       These functions enumerates color profiles satisfying the given</span>
03332 <span class="comment"> *       enumeration criteria. It searches among all installed profiles, and</span>
03333 <span class="comment"> *       on return fills out a buffer with a series of NULL terminated profile</span>
03334 <span class="comment"> *       filenames double NULL terminated at the end.</span>
03335 <span class="comment"> *</span>
03336 <span class="comment"> *  Arguments:</span>
03337 <span class="comment"> *       pMachineName    - name identifying machine on which the enumeration</span>
03338 <span class="comment"> *                         needs to be done</span>
03339 <span class="comment"> *       pEnumRecord     - pointer to enumeration criteria</span>
03340 <span class="comment"> *       pBuffer         - pointer to buffer to receive result, can be NULL</span>
03341 <span class="comment"> *       pdwSize         - pointer to buffer size. On return it is actual number</span>
03342 <span class="comment"> *                         of bytes copied/needed.</span>
03343 <span class="comment"> *       pnProfiles      - pointer to DWORD. On return, it is number of profiles</span>
03344 <span class="comment"> *                         copied to pBuffer.</span>
03345 <span class="comment"> *</span>
03346 <span class="comment"> *  Returns:</span>
03347 <span class="comment"> *       TRUE if successful, NULL otherwise</span>
03348 <span class="comment"> *</span>
03349 <span class="comment"> *  Warning:</span>
03350 <span class="comment"> *       Currently only local enumeration is supported, so pMachineName should</span>
03351 <span class="comment"> *       be NULL.</span>
03352 <span class="comment"> *</span>
03353 <span class="comment"> ******************************************************************************/</span>
03354 
03355 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l03356"></a><a class="code" href="../../d9/d7/profman_8c.html#a48">03356</a> <a class="code" href="../../d9/d7/profman_8c.html#a48">InternalEnumColorProfiles</a>(
03357     LPCTSTR    pMachineName,
03358     PENUMTYPE  pEnumRecord,
03359     PBYTE      pBuffer,
03360     PDWORD     pdwSize,
03361     PDWORD     pnProfiles
03362     )
03363 {
03364     <a class="code" href="../../d2/d5/structtagREGDATA.html">REGDATA</a>  regData;               <span class="comment">// for storing registry data about profile</span>
03365     HKEY     hkICM = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;          <span class="comment">// key to ICM branch in registry</span>
03366     HKEY     hkDevice = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;       <span class="comment">// key to ICM device branch in registry</span>
03367     PTSTR    pProfileList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;   <span class="comment">// list of associated profiles</span>
03368     PTSTR    pTempProfileList;      <span class="comment">// temporary copy of profile list</span>
03369     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwSize;                <span class="comment">// size of profile value</span>
03370     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwDataSize;            <span class="comment">// size of profile data</span>
03371     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwInputSize;           <span class="comment">// incoming size of buffer</span>
03372     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    i, j;                  <span class="comment">// counter variables</span>
03373     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwErr;                 <span class="comment">// error code</span>
03374     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;            <span class="comment">// return code</span>
03375     TCHAR    szFullPath[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];  <span class="comment">// full path of profile to open</span>
03376     PTSTR    pProfile;              <span class="comment">// pointer to profile name in full path</span>
03377     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwLen;                 <span class="comment">// length of color directory string</span>
03378     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    bSkipMatch;            <span class="comment">// true for skipping exact profile matching</span>
03379     <a class="code" href="../../d9/d7/profman_8c.html#a99">MATCHTYPE</a> match;                <span class="comment">// Type of profile match</span>
03380     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>     pBufferStart;         <span class="comment">// Start of user given buffer</span>
03381     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwSizeOfStruct;        <span class="comment">// size of ENUMTYPE structure</span>
03382     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwVersion;             <span class="comment">// ENUMTYPE structure version</span>
03383 
03384     <span class="comment">//</span>
03385     <span class="comment">// Validate parameters</span>
03386     <span class="comment">//</span>
03387 
03388     <span class="keywordflow">if</span> (! pdwSize ||
03389         IsBadWritePtr(pdwSize, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)) ||
03390         (pBuffer &amp;&amp; IsBadWritePtr(pBuffer, *pdwSize)) ||
03391         (pnProfiles &amp;&amp; IsBadWritePtr(pnProfiles, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>))) ||
03392         ! pEnumRecord ||
03393         IsBadReadPtr(pEnumRecord, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)*3))   <span class="comment">// probe until ENUMTYPE.dwFields</span>
03394     {
03395 ParameterError_InternalEnumColorProfiles:
03396         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to EnumColorProfiles\n"</span>)));
03397         SetLastError(ERROR_INVALID_PARAMETER);
03398         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03399     }
03400 
03401     <span class="comment">//</span>
03402     <span class="comment">// Check structure size based on its version.</span>
03403     <span class="comment">//</span>
03404 
03405     dwSizeOfStruct = pEnumRecord-&gt;dwSize;
03406     dwVersion      = pEnumRecord-&gt;dwVersion;
03407 
03408     <span class="keywordflow">if</span> (dwVersion &gt;= ENUM_TYPE_VERSION)
03409     {
03410         <span class="keywordflow">if</span> (dwSizeOfStruct &lt; <span class="keyword">sizeof</span>(ENUMTYPE))
03411             <span class="keywordflow">goto</span> ParameterError_InternalEnumColorProfiles;
03412     }
03413     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dwVersion == 0x0200)
03414     {
03415         <span class="keywordflow">if</span> (dwSizeOfStruct &lt; <span class="keyword">sizeof</span>(ENUMTYPE)-<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>))
03416             <span class="keywordflow">goto</span> ParameterError_InternalEnumColorProfiles;
03417 
03418         <span class="comment">//</span>
03419         <span class="comment">// Version 2 should not have ET_DEVICECLASS bit</span>
03420         <span class="comment">//</span>
03421 
03422         <span class="keywordflow">if</span> (pEnumRecord-&gt;dwFields &amp; ET_DEVICECLASS)
03423             <span class="keywordflow">goto</span> ParameterError_InternalEnumColorProfiles;
03424 
03425         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Old version ENUMTYPE to InternalEnumColorProfiles\n"</span>)));
03426     }
03427     <span class="keywordflow">else</span>
03428     {
03429         <span class="keywordflow">goto</span> ParameterError_InternalEnumColorProfiles;
03430     }
03431 
03432     <span class="keywordflow">if</span> (IsBadReadPtr(pEnumRecord, dwSizeOfStruct))
03433     {
03434         <span class="keywordflow">goto</span> ParameterError_InternalEnumColorProfiles;
03435     }
03436 
03437     <span class="comment">//</span>
03438     <span class="comment">// Only local enumerations are allowed now</span>
03439     <span class="comment">//</span>
03440 
03441     <span class="keywordflow">if</span> (pMachineName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03442     {
03443         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Remote profile enumeration attempted, failing...\n"</span>)));
03444         SetLastError(ERROR_NOT_SUPPORTED);
03445         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03446     }
03447 
03448     dwInputSize = *pdwSize;
03449 
03450     <span class="comment">//</span>
03451     <span class="comment">// Get color directory</span>
03452     <span class="comment">//</span>
03453 
03454     dwLen = <span class="keyword">sizeof</span>(szFullPath);
03455     <span class="keywordflow">if</span> (! <a class="code" href="../../d9/d7/profman_8c.html#a43">InternalGetColorDirectory</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, szFullPath, &amp;dwLen))
03456     {
03457         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error getting color directory\n"</span>)));
03458         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03459     }
03460 
03461     <span class="keywordflow">if</span> (szFullPath[lstrlen(szFullPath) - 1] != <span class="charliteral">'\\'</span>)
03462     {
03463         lstrcat(szFullPath, <a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a21">gszBackslash</a>);
03464     }
03465     pProfile = &amp;szFullPath[lstrlen(szFullPath)];
03466     dwLen = lstrlen(szFullPath) * <span class="keyword">sizeof</span>(TCHAR);
03467 
03468     <span class="comment">//</span>
03469     <span class="comment">// Initialize return parameters</span>
03470     <span class="comment">//</span>
03471 
03472     *pdwSize = 0;
03473     <span class="keywordflow">if</span> (pnProfiles)
03474         *pnProfiles = 0;
03475 
03476     <span class="keywordflow">if</span> (pBuffer &amp;&amp; dwInputSize &gt;= <span class="keyword">sizeof</span>(TCHAR))
03477     {
03478         *((PTSTR)pBuffer) = <span class="charliteral">'\0'</span>;
03479     }
03480 
03481     <span class="comment">//</span>
03482     <span class="comment">// Check if we are looking for the profiles of a particular device or</span>
03483     <span class="comment">// not because we enumerate them from different places.</span>
03484     <span class="comment">//</span>
03485 
03486     <span class="keywordflow">if</span> (pEnumRecord-&gt;dwFields &amp; ET_DEVICENAME)
03487     {
03488         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *pbSkipMatch = &amp;bSkipMatch;
03489         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  dwDeviceClass;
03490 
03491         <span class="keywordflow">if</span> (! pEnumRecord-&gt;pDeviceName)
03492         {
03493             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to EnumColorProfiles\n"</span>)));
03494             SetLastError(ERROR_INVALID_PARAMETER);
03495             <span class="keywordflow">goto</span> EndEnumerateColorProfiles;
03496         }
03497 
03498         <span class="comment">//</span>
03499         <span class="comment">// Get list of profiles associated with the device. If we don't</span>
03500         <span class="comment">// know what device it is, specify ColorSpace, which tries all three</span>
03501         <span class="comment">//</span>
03502 
03503         <span class="keywordflow">if</span> (pEnumRecord-&gt;dwFields &amp; ET_DEVICECLASS)
03504         {
03505             dwDeviceClass = pEnumRecord-&gt;dwDeviceClass;
03506         }
03507         <span class="keywordflow">else</span>
03508         {
03509             dwDeviceClass = CLASS_COLORSPACE;
03510         }
03511 
03512         <span class="comment">//</span>
03513         <span class="comment">// Get the device configuration whether we do exact matching or not.</span>
03514         <span class="comment">//</span>
03515 
03516         dwSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
03517         <span class="keywordflow">if</span> (! <a class="code" href="../../d9/d7/profman_8c.html#a54">GetDeviceData</a>(pEnumRecord-&gt;pDeviceName, dwDeviceClass, <a class="code" href="../../d9/d7/profman_8c.html#a9">DEVICE_PROFILE_ENUMMODE</a>,
03518                             (PVOID *)&amp;pbSkipMatch, &amp;dwSize, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>))
03519         {
03520             bSkipMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03521         }
03522 
03523         <span class="comment">//</span>
03524         <span class="comment">// Get the profile data.</span>
03525         <span class="comment">//</span>
03526 
03527         dwSize = 0;
03528         <span class="keywordflow">if</span> (! <a class="code" href="../../d9/d7/profman_8c.html#a54">GetDeviceData</a>(pEnumRecord-&gt;pDeviceName, dwDeviceClass, <a class="code" href="../../d9/d7/profman_8c.html#a8">DEVICE_PROFILE_DATA</a>,
03529                             (PVOID *)&amp;pProfileList, &amp;dwSize, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
03530         {
03531             pProfileList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;    <span class="comment">// no data found</span>
03532         }
03533 
03534         <span class="keywordflow">if</span>(! pProfileList)
03535         {
03536             <span class="comment">//</span>
03537             <span class="comment">// No profiles associated with this device</span>
03538             <span class="comment">//</span>
03539 
03540             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03541             <span class="keywordflow">if</span> (pBuffer &amp;&amp; dwInputSize &gt;= <span class="keyword">sizeof</span>(TCHAR)*2)
03542             {
03543                 *((PTSTR)pBuffer + 1) = <span class="charliteral">'\0'</span>;
03544             }
03545             <span class="keywordflow">goto</span> EndEnumerateColorProfiles;
03546         }
03547 
03548         <span class="comment">//</span>
03549         <span class="comment">// Run through the list of profiles and check each one to see if it</span>
03550         <span class="comment">// matches the enumeration criteria. If it does, and the buffer is</span>
03551         <span class="comment">// large enough, copy it to the buffer, and increment the byte count</span>
03552         <span class="comment">// and number of profiles enumerated.</span>
03553         <span class="comment">//</span>
03554 
03555         pBufferStart = pBuffer;
03556         pTempProfileList = pProfileList;
03557 
03558         <span class="keywordflow">while</span> (*pTempProfileList)
03559         {
03560             lstrcpy(pProfile, pTempProfileList);
03561 
03562             <span class="keywordflow">if</span> (bSkipMatch)
03563             {
03564                 match = <a class="code" href="../../d0/d3/dsocode_8c.html#a1">EXACT_MATCH</a>;
03565             }
03566             <span class="keywordflow">else</span>
03567             {
03568                 match = <a class="code" href="../../d9/d7/profman_8c.html#a61">DoesProfileMatchEnumRecord</a>(szFullPath, pEnumRecord);
03569             }
03570 
03571             <span class="keywordflow">if</span> (match != <a class="code" href="../../d9/d7/profman_8c.html#a99a40">NOMATCH</a>)
03572             {
03573                 *pdwSize += (lstrlen(pTempProfileList) + 1) * <span class="keyword">sizeof</span>(TCHAR);
03574 
03575                 <span class="comment">//</span>
03576                 <span class="comment">// Check strictly less than because you need one more for</span>
03577                 <span class="comment">// the final NULL termination</span>
03578                 <span class="comment">//</span>
03579 
03580                 <span class="keywordflow">if</span> (pBuffer &amp;&amp; (*pdwSize &lt; dwInputSize))
03581                 {
03582                     <span class="keywordflow">if</span> (match == <a class="code" href="../../d9/d7/profman_8c.html#a99a41">MATCH</a>)
03583                     {
03584                         lstrcpy((PTSTR)pBuffer, pTempProfileList);
03585                     }
03586                     <span class="keywordflow">else</span>
03587                     {
03588                         <span class="comment">//</span>
03589                         <span class="comment">// Exact match, add to beginning of buffer</span>
03590                         <span class="comment">//</span>
03591 
03592                         <a class="code" href="../../d9/d7/profman_8c.html#a60">InsertInBuffer</a>(pBufferStart, pBuffer, pTempProfileList);
03593                     }
03594 
03595                     pBuffer += (lstrlen(pTempProfileList) + 1) * <span class="keyword">sizeof</span>(TCHAR);
03596                 }
03597 
03598                 <span class="keywordflow">if</span> (pnProfiles)
03599                     (*pnProfiles)++;
03600             }
03601 
03602             pTempProfileList += lstrlen(pTempProfileList) + 1;
03603         }
03604     }
03605     <span class="keywordflow">else</span>
03606     {
03607         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  dwNumClasses;
03608         PTSTR *ppszEnumClasses;
03609         PTSTR  pszEnumClassArray[2];
03610 
03611         <span class="comment">//</span>
03612         <span class="comment">// We are not looking at a particular device, so enumerate</span>
03613         <span class="comment">// profiles from the registry</span>
03614         <span class="comment">//</span>
03615 
03616         <span class="keywordflow">if</span> (pEnumRecord-&gt;dwFields &amp; ET_DEVICECLASS)
03617         {
03618             <span class="comment">//</span>
03619             <span class="comment">// If device class is specified, enumrate the specified device class and color</span>
03620             <span class="comment">// space class which can be associated to any device.</span>
03621             <span class="comment">//</span>
03622 
03623             pszEnumClassArray[0] = <a class="code" href="../../d9/d7/profman_8c.html#a52">ConvertClassIdToClassString</a>(pEnumRecord-&gt;dwDeviceClass);
03624             pszEnumClassArray[1] = <a class="code" href="../../d9/d7/profman_8c.html#a52">ConvertClassIdToClassString</a>(CLASS_COLORSPACE);
03625 
03626             <span class="keywordflow">if</span> (!pszEnumClassArray[0] || !pszEnumClassArray[1])
03627             {
03628                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid DeviceClass to EnumColorProfiles\n"</span>)));
03629                 SetLastError(ERROR_INVALID_PARAMETER);
03630                 <span class="keywordflow">goto</span> EndEnumerateColorProfiles;
03631             }
03632 
03633             ppszEnumClasses = pszEnumClassArray;
03634             dwNumClasses    = 2;
03635         }
03636         <span class="keywordflow">else</span>
03637         {
03638             ppszEnumClasses = <a class="code" href="../../d9/d7/profman_8c.html#a39">gpszClasses</a>;
03639             dwNumClasses    = <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/profman_8c.html#a39">gpszClasses</a>)/<span class="keyword">sizeof</span>(PTSTR);
03640         }
03641 
03642         <span class="comment">//</span>
03643         <span class="comment">// Open the registry path where profiles are kept (and create it if not exist)</span>
03644         <span class="comment">//</span>
03645 
03646         <span class="keywordflow">if</span> ((dwErr = RegCreateKey(HKEY_LOCAL_MACHINE, <a class="code" href="../../d4/d9/icmupg_8c.html#a8">gszICMRegPath</a>, &amp;hkICM)) != ERROR_SUCCESS)
03647         {
03648             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Cannot open ICM branch of registry: %d\n"</span>), dwErr));
03649             SetLastError(dwErr);
03650             <span class="keywordflow">goto</span> EndEnumerateColorProfiles;
03651         }
03652 
03653         pBufferStart = pBuffer;
03654 
03655         <span class="keywordflow">for</span> (i=0; i&lt;dwNumClasses; i++,ppszEnumClasses++)
03656         {
03657             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   nValues;        <span class="comment">// number of name-values in key</span>
03658 
03659             <span class="keywordflow">if</span> (RegOpenKey(hkICM, *ppszEnumClasses, &amp;hkDevice) != ERROR_SUCCESS)
03660             {
03661                 <span class="keywordflow">continue</span>;           <span class="comment">// go to next key</span>
03662             }
03663 
03664             <span class="keywordflow">if</span> ((dwErr = RegQueryInfoKey(hkDevice, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03665                 &amp;nValues, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) != ERROR_SUCCESS)
03666             {
03667                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Cannot count values in device branch of registry: %d\n"</span>), dwErr));
03668                 RegCloseKey(hkDevice);
03669                 SetLastError(dwErr);
03670                 <span class="keywordflow">goto</span> EndEnumerateColorProfiles;
03671             }
03672 
03673             <span class="comment">//</span>
03674             <span class="comment">// Go through the list of profiles and return everything that</span>
03675             <span class="comment">// satisfies the enumeration criteria</span>
03676             <span class="comment">//</span>
03677 
03678             <span class="keywordflow">for</span> (j=0; j&lt;nValues; j++)
03679             {
03680                 dwSize = <span class="keyword">sizeof</span>(szFullPath) - dwLen;
03681                 dwDataSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/structtagREGDATA.html">REGDATA</a>);
03682                 <span class="keywordflow">if</span> (RegEnumValue(hkDevice, j, pProfile, &amp;dwSize, 0,
03683                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;regData, &amp;dwDataSize) == ERROR_SUCCESS)
03684                 {
03685                     match = <a class="code" href="../../d9/d7/profman_8c.html#a61">DoesProfileMatchEnumRecord</a>(szFullPath, pEnumRecord);
03686 
03687                     <span class="keywordflow">if</span> (match != <a class="code" href="../../d9/d7/profman_8c.html#a99a40">NOMATCH</a>)
03688                     {
03689                         *pdwSize += (lstrlen(pProfile) + 1) * <span class="keyword">sizeof</span>(TCHAR);
03690                         <span class="keywordflow">if</span> (pBuffer &amp;&amp; (*pdwSize &lt; dwInputSize))
03691                         {
03692                             <span class="keywordflow">if</span> (match == <a class="code" href="../../d9/d7/profman_8c.html#a99a41">MATCH</a>)
03693                             {
03694                                 lstrcpy((PTSTR)pBuffer, pProfile);
03695                             }
03696                             <span class="keywordflow">else</span>
03697                             {
03698                                 <span class="comment">//</span>
03699                                 <span class="comment">// Exact match, add to beginning of buffer</span>
03700                                 <span class="comment">//</span>
03701 
03702                                 <a class="code" href="../../d9/d7/profman_8c.html#a60">InsertInBuffer</a>(pBufferStart, pBuffer, pProfile);
03703                             }
03704 
03705                             pBuffer += (lstrlen(pProfile) + 1) * <span class="keyword">sizeof</span>(TCHAR);
03706                         }
03707 
03708                         <span class="keywordflow">if</span> (pnProfiles)
03709                             (*pnProfiles)++;
03710                     }
03711                 }
03712             }
03713 
03714             RegCloseKey(hkDevice);
03715         }
03716     }
03717 
03718     *pdwSize += <span class="keyword">sizeof</span>(TCHAR);      <span class="comment">// extra NULL termination</span>
03719 
03720     <span class="keywordflow">if</span> (pBuffer &amp;&amp; *pdwSize &lt;= dwInputSize)
03721     {
03722         *((PTSTR)pBuffer) = <span class="charliteral">'\0'</span>;
03723         rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03724     }
03725     <span class="keywordflow">else</span>
03726     {
03727         SetLastError(ERROR_INSUFFICIENT_BUFFER);
03728     }
03729 
03730 EndEnumerateColorProfiles:
03731 
03732     <span class="keywordflow">if</span> (hkICM)
03733     {
03734         RegCloseKey(hkICM);
03735     }
03736     <span class="keywordflow">if</span> (pProfileList)
03737     {
03738         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pProfileList);
03739     }
03740 
03741     <span class="keywordflow">return</span> rc;
03742 }
03743 
03744 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03745"></a><a class="code" href="../../d9/d7/profman_8c.html#a60">03745</a> <a class="code" href="../../d9/d7/profman_8c.html#a60">InsertInBuffer</a>(
03746     PBYTE  pStart,
03747     PBYTE  pEnd,
03748     PTSTR  pString
03749     )
03750 {
03751     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cnt = (lstrlen(pString) + 1) * <span class="keyword">sizeof</span>(TCHAR);
03752 
03753     <a class="code" href="../../d2/d1/object_8c.html#a10">MyCopyMemory</a>(pStart+cnt, pStart, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(pEnd - pStart));
03754 
03755     lstrcpy((PTSTR)pStart, pString);
03756 
03757     <span class="keywordflow">return</span>;
03758 }
03759 
03760 <span class="comment">/******************************************************************************</span>
03761 <span class="comment"> *</span>
03762 <span class="comment"> *                          InternalSetSCSProfile</span>
03763 <span class="comment"> *</span>
03764 <span class="comment"> *  Function:</span>
03765 <span class="comment"> *       These functions regsiters the given profile for the standard color</span>
03766 <span class="comment"> *       space specified. This will register it in the OS and can be queried</span>
03767 <span class="comment"> *       using GetStandardColorSpaceProfile.</span>
03768 <span class="comment"> *</span>
03769 <span class="comment"> *  Arguments:</span>
03770 <span class="comment"> *       pMachineName    - name identifying machine on which the standard color</span>
03771 <span class="comment"> *                         space profile should be registered</span>
03772 <span class="comment"> *       dwSCS           - ID for the standard color space</span>
03773 <span class="comment"> *       pProfileName    - pointer to profile filename</span>
03774 <span class="comment"> *</span>
03775 <span class="comment"> *  Returns:</span>
03776 <span class="comment"> *       TRUE if successful, NULL otherwise</span>
03777 <span class="comment"> *</span>
03778 <span class="comment"> *  Warning:</span>
03779 <span class="comment"> *       Currently only local registration is supported, so pMachineName should</span>
03780 <span class="comment"> *       be NULL.</span>
03781 <span class="comment"> *</span>
03782 <span class="comment"> ******************************************************************************/</span>
03783 
03784 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l03785"></a><a class="code" href="../../d9/d7/profman_8c.html#a49">03785</a> <a class="code" href="../../d9/d7/profman_8c.html#a49">InternalSetSCSProfile</a>(
03786     LPCTSTR   pMachineName,
03787     DWORD     dwSCS,
03788     LPCTSTR   pProfileName
03789     )
03790 {
03791     HKEY   hkICM = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;            <span class="comment">// key to ICM branch in registry</span>
03792     HKEY   hkRegProf = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;        <span class="comment">// key to registered color spaces branch</span>
03793     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  dwSize;                  <span class="comment">// size of registry data</span>
03794     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  dwErr;                   <span class="comment">// error code</span>
03795     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>   rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;              <span class="comment">// return code</span>
03796     TCHAR  szProfileID[5];          <span class="comment">// profile class</span>
03797 
03798     <span class="comment">//</span>
03799     <span class="comment">// Validate parameters</span>
03800     <span class="comment">//</span>
03801 
03802     <span class="keywordflow">if</span> (!pProfileName)
03803     {
03804         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to SetStandardColorSpaceProfile\n"</span>)));
03805         SetLastError(ERROR_INVALID_PARAMETER);
03806         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03807     }
03808 
03809     <span class="comment">//</span>
03810     <span class="comment">// Only local registration is allowed now</span>
03811     <span class="comment">//</span>
03812 
03813     <span class="keywordflow">if</span> (pMachineName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03814     {
03815         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Remote SCS profile registration attempted, failing...\n"</span>)));
03816         SetLastError(ERROR_NOT_SUPPORTED);
03817         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03818     }
03819 
03820     dwSize = (lstrlen(pProfileName) + 1) * <span class="keyword">sizeof</span>(TCHAR);
03821 
03822     <span class="comment">//</span>
03823     <span class="comment">// Open the registry location where this is kept</span>
03824     <span class="comment">//</span>
03825 
03826     <span class="keywordflow">if</span> (((dwErr = RegCreateKey(HKEY_LOCAL_MACHINE, <a class="code" href="../../d4/d9/icmupg_8c.html#a8">gszICMRegPath</a>, &amp;hkICM)) == ERROR_SUCCESS) &amp;&amp;
03827         ((dwErr = RegCreateKey(hkICM, <a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a22">gszRegisteredProfiles</a>, &amp;hkRegProf))== ERROR_SUCCESS))
03828     {
03829         <a class="code" href="../../d9/d7/profman_8c.html#a51">ConvertDwordToString</a>(dwSCS, szProfileID);
03830 
03831         <span class="keywordflow">if</span> ((dwErr = RegSetValueEx(hkRegProf, szProfileID, 0, REG_SZ,
03832             (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pProfileName, dwSize)) == ERROR_SUCCESS)
03833         {
03834             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03835         }
03836     }
03837 
03838     <span class="keywordflow">if</span> (hkICM)
03839     {
03840         RegCloseKey(hkICM);
03841     }
03842 
03843     <span class="keywordflow">if</span> (hkRegProf)
03844     {
03845         RegCloseKey(hkRegProf);
03846     }
03847 
03848     <span class="keywordflow">if</span> (!rc)
03849     {
03850         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"InternalSetSCSProfile failed: %d\n"</span>), dwErr));
03851         SetLastError(dwErr);
03852     }
03853 
03854     <span class="keywordflow">return</span> rc;
03855 }
03856 
03857 
03858 <span class="comment">/******************************************************************************</span>
03859 <span class="comment"> *</span>
03860 <span class="comment"> *                          InternalGetSCSProfile</span>
03861 <span class="comment"> *</span>
03862 <span class="comment"> *  Function:</span>
03863 <span class="comment"> *       These functions retrieves the profile regsitered for the standard color</span>
03864 <span class="comment"> *       space specified.</span>
03865 <span class="comment"> *</span>
03866 <span class="comment"> *  Arguments:</span>
03867 <span class="comment"> *       pMachineName    - name identifying machine on which the standard color</span>
03868 <span class="comment"> *                         space profile should be queried</span>
03869 <span class="comment"> *       dwSCS           - ID for the standard color space</span>
03870 <span class="comment"> *       pBuffer         - pointer to buffer to receive profile filename</span>
03871 <span class="comment"> *       pdwSize         - pointer to DWORD specifying size of buffer. On return</span>
03872 <span class="comment"> *                         it has size needed/used</span>
03873 <span class="comment"> *</span>
03874 <span class="comment"> *  Returns:</span>
03875 <span class="comment"> *       TRUE if successful, NULL otherwise</span>
03876 <span class="comment"> *</span>
03877 <span class="comment"> *  Warning:</span>
03878 <span class="comment"> *       Currently only local query is supported, so pMachineName should</span>
03879 <span class="comment"> *       be NULL.</span>
03880 <span class="comment"> *</span>
03881 <span class="comment"> ******************************************************************************/</span>
03882 
03883 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l03884"></a><a class="code" href="../../d9/d7/profman_8c.html#a50">03884</a> <a class="code" href="../../d9/d7/profman_8c.html#a50">InternalGetSCSProfile</a>(
03885     LPCTSTR   pMachineName,
03886     DWORD     dwSCS,
03887     PTSTR     pBuffer,
03888     PDWORD    pdwSize
03889     )
03890 {
03891     HKEY   hkICM = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;            <span class="comment">// key to ICM branch in registry</span>
03892     HKEY   hkRegProf = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;        <span class="comment">// key to registered color spaces branch</span>
03893     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  dwErr;                   <span class="comment">// error code</span>
03894     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  dwSize;
03895     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>   rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;              <span class="comment">// return code</span>
03896     TCHAR  szProfileID[5];          <span class="comment">// profile class</span>
03897 
03898     <span class="comment">//</span>
03899     <span class="comment">// Validate parameters</span>
03900     <span class="comment">//</span>
03901 
03902     <span class="keywordflow">if</span> (! pdwSize ||
03903         IsBadWritePtr(pdwSize, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)) ||
03904         (pBuffer &amp;&amp; IsBadWritePtr(pBuffer, *pdwSize)))
03905     {
03906         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to GetStandardColorSpaceProfile\n"</span>)));
03907         SetLastError(ERROR_INVALID_PARAMETER);
03908         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03909     }
03910 
03911     <span class="comment">//</span>
03912     <span class="comment">// Only local query is allowed now</span>
03913     <span class="comment">//</span>
03914 
03915     <span class="keywordflow">if</span> (pMachineName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03916     {
03917         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Remote SCS profile query attempted, failing...\n"</span>)));
03918         SetLastError(ERROR_NOT_SUPPORTED);
03919         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03920     }
03921 
03922     dwSize = *pdwSize;
03923 
03924     <span class="comment">//</span>
03925     <span class="comment">// Look in the registry for a profile registered for this color space ID</span>
03926     <span class="comment">//</span>
03927 
03928     <span class="keywordflow">if</span> (((dwErr = RegOpenKey(HKEY_LOCAL_MACHINE, <a class="code" href="../../d4/d9/icmupg_8c.html#a8">gszICMRegPath</a>, &amp;hkICM)) == ERROR_SUCCESS) &amp;&amp;
03929         ((dwErr = RegOpenKey(hkICM, <a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a22">gszRegisteredProfiles</a>, &amp;hkRegProf)) == ERROR_SUCCESS))
03930     {
03931         <a class="code" href="../../d9/d7/profman_8c.html#a51">ConvertDwordToString</a>(dwSCS, szProfileID);
03932         <span class="keywordflow">if</span> ((dwErr = RegQueryValueEx(hkRegProf, szProfileID, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03933                 (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pBuffer, pdwSize)) == ERROR_SUCCESS)
03934         {
03935             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03936         }
03937     }
03938 
03939     <span class="keywordflow">if</span> (hkICM)
03940     {
03941         RegCloseKey(hkICM);
03942     }
03943 
03944     <span class="keywordflow">if</span> (hkRegProf)
03945     {
03946         RegCloseKey(hkRegProf);
03947     }
03948 
03949     <span class="keywordflow">if</span> (!rc &amp;&amp; (dwSCS == LCS_sRGB || dwSCS == LCS_WINDOWS_COLOR_SPACE))
03950     {
03951         *pdwSize = dwSize;
03952         rc = GetColorDirectory(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pBuffer, pdwSize);
03953         <span class="keywordflow">if</span> (!rc &amp;&amp; GetLastError() != ERROR_INSUFFICIENT_BUFFER)
03954         {
03955             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03956         }
03957 
03958         *pdwSize += (lstrlen(<a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a21">gszBackslash</a>) + lstrlen(<a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a23">gszsRGBProfile</a>)) * <span class="keyword">sizeof</span>(TCHAR);
03959 
03960         <span class="keywordflow">if</span> (*pdwSize &lt;= dwSize &amp;&amp; pBuffer)
03961         {
03962             lstrcat(pBuffer, <a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a21">gszBackslash</a>);
03963             lstrcat(pBuffer, <a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a23">gszsRGBProfile</a>);
03964             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03965         }
03966         <span class="keywordflow">else</span>
03967         {
03968             dwErr = ERROR_INSUFFICIENT_BUFFER;
03969         }
03970     }
03971 
03972     <span class="keywordflow">if</span> (!rc)
03973     {
03974         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"InternalGetSCSProfile failed: %d\n"</span>), dwErr));
03975         SetLastError(dwErr);
03976     }
03977 
03978     <span class="comment">//</span>
03979     <span class="comment">// If pBuffer is NULL, RegQueryValueEx return TRUE. Our API should return FALSE</span>
03980     <span class="comment">// in this case. Handle this.</span>
03981     <span class="comment">//</span>
03982 
03983     <span class="keywordflow">if</span> (pBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; rc)
03984     {
03985         SetLastError(ERROR_INSUFFICIENT_BUFFER);
03986         rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03987     }
03988 
03989     <span class="keywordflow">return</span> rc;
03990 }
03991 
03992 
03993 <span class="comment">/******************************************************************************</span>
03994 <span class="comment"> *</span>
03995 <span class="comment"> *                           ConvertDwordToString</span>
03996 <span class="comment"> *</span>
03997 <span class="comment"> *  Function:</span>
03998 <span class="comment"> *       This function converts a DWORD into a string. The string passed in</span>
03999 <span class="comment"> *       is large enough. It converts to Unicode or Ansi depending on how</span>
04000 <span class="comment"> *       this is compiled.</span>
04001 <span class="comment"> *</span>
04002 <span class="comment"> *  Arguments:</span>
04003 <span class="comment"> *       dword           - DWORD to convert</span>
04004 <span class="comment"> *       pString         - pointer to buffer to hold the result</span>
04005 <span class="comment"> *</span>
04006 <span class="comment"> *  Returns:</span>
04007 <span class="comment"> *       Nothing</span>
04008 <span class="comment"> *</span>
04009 <span class="comment"> ******************************************************************************/</span>
04010 
04011 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04012"></a><a class="code" href="../../d9/d7/profman_8c.html#a51">04012</a> <a class="code" href="../../d9/d7/profman_8c.html#a51">ConvertDwordToString</a>(
04013     DWORD  dword,
04014     PTSTR  pString
04015     )
04016 {
04017     <span class="keywordtype">int</span> i;                          <span class="comment">// counter</span>
04018 
04019     <span class="keywordflow">for</span> (i=0; i&lt;4; i++)
04020     {
04021         pString[i]  = (TCHAR)(((<span class="keywordtype">char</span>*)&amp;dword)[3-i]);
04022     }
04023 
04024     pString[4] = <span class="charliteral">'\0'</span>;
04025 
04026     <span class="keywordflow">return</span>;
04027 }
04028 
04029 <span class="comment">/******************************************************************************</span>
04030 <span class="comment"> *</span>
04031 <span class="comment"> *                           ConvertClassIdToClassString</span>
04032 <span class="comment"> *</span>
04033 <span class="comment"> *  Function:</span>
04034 <span class="comment"> *       This function converts a DWORD Device Class Id into a its device string</span>
04035 <span class="comment"> *</span>
04036 <span class="comment"> *  Arguments:</span>
04037 <span class="comment"> *       dwClassId      - Device class id.</span>
04038 <span class="comment"> *</span>
04039 <span class="comment"> *  Returns:</span>
04040 <span class="comment"> *       pointer to a string</span>
04041 <span class="comment"> *</span>
04042 <span class="comment"> ******************************************************************************/</span>
04043 
04044 PTSTR
<a name="l04045"></a><a class="code" href="../../d9/d7/profman_8c.html#a52">04045</a> <a class="code" href="../../d9/d7/profman_8c.html#a52">ConvertClassIdToClassString</a>(
04046     DWORD  dwClassId
04047     )
04048 {
04049     <span class="keywordflow">switch</span> (dwClassId)
04050     {
04051     <span class="keywordflow">case</span> CLASS_MONITOR:
04052         <span class="keywordflow">return</span> (<a class="code" href="../../d9/d7/profman_8c.html#a39">gpszClasses</a>[<a class="code" href="../../d9/d7/profman_8c.html#a10">INDEX_CLASS_MONITOR</a>]);
04053     <span class="keywordflow">case</span> CLASS_PRINTER:
04054         <span class="keywordflow">return</span> (<a class="code" href="../../d9/d7/profman_8c.html#a39">gpszClasses</a>[<a class="code" href="../../d9/d7/profman_8c.html#a11">INDEX_CLASS_PRINTER</a>]);
04055     <span class="keywordflow">case</span> CLASS_SCANNER:
04056         <span class="keywordflow">return</span> (<a class="code" href="../../d9/d7/profman_8c.html#a39">gpszClasses</a>[<a class="code" href="../../d9/d7/profman_8c.html#a12">INDEX_CLASS_SCANNER</a>]);
04057     <span class="keywordflow">case</span> CLASS_COLORSPACE:
04058         <span class="keywordflow">return</span> (<a class="code" href="../../d9/d7/profman_8c.html#a39">gpszClasses</a>[<a class="code" href="../../d9/d7/profman_8c.html#a15">INDEX_CLASS_COLORSPACE</a>]);
04059     <span class="keywordflow">default</span>:
04060         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04061     }
04062 }
04063 
04064 <span class="comment">/******************************************************************************</span>
04065 <span class="comment"> *</span>
04066 <span class="comment"> *                          GetProfileClassString</span>
04067 <span class="comment"> *</span>
04068 <span class="comment"> *  Function:</span>
04069 <span class="comment"> *       This function returns the profile class from the header as a string.</span>
04070 <span class="comment"> *       It also validates the profile.</span>
04071 <span class="comment"> *</span>
04072 <span class="comment"> *  Arguments:</span>
04073 <span class="comment"> *       pProfileName    - name of profile</span>
04074 <span class="comment"> *       pClass          - pointer to buffer to hold the profile class string</span>
04075 <span class="comment"> *       pHeader         - if this is non NULL, it returns the header here</span>
04076 <span class="comment"> *</span>
04077 <span class="comment"> *  Returns:</span>
04078 <span class="comment"> *       TRUE on success, FALSE otherwise</span>
04079 <span class="comment"> *</span>
04080 <span class="comment"> ******************************************************************************/</span>
04081 
04082 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l04083"></a><a class="code" href="../../d9/d7/profman_8c.html#a53">04083</a> <a class="code" href="../../d9/d7/profman_8c.html#a53">GetProfileClassString</a>(
04084     LPCTSTR        pProfileName,
04085     PTSTR          pClass,
04086     PPROFILEHEADER pHeader
04087     )
04088 {
04089     PROFILEHEADER header;                <span class="comment">// color profile header</span>
04090     PROFILE       prof;                  <span class="comment">// profile object for opening profile</span>
04091     HPROFILE      hProfile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;       <span class="comment">// handle to opened profile</span>
04092     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>          bValidProfile = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>; <span class="comment">// validation of the profile</span>
04093     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>          rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;            <span class="comment">// return code</span>
04094 
04095     <span class="comment">//</span>
04096     <span class="comment">// Open a handle to the profile</span>
04097     <span class="comment">//</span>
04098 
04099     prof.dwType = PROFILE_FILENAME;
04100     prof.pProfileData = (PVOID)pProfileName;
04101     prof.cbDataSize = (lstrlen(pProfileName) + 1) * <span class="keyword">sizeof</span>(TCHAR);
04102 
04103     hProfile = OpenColorProfile(&amp;prof, PROFILE_READ, FILE_SHARE_READ,
04104                     <a class="code" href="../../d4/d8/ntfsexp_8h.html#a141a69">OPEN_EXISTING</a>);
04105     <span class="keywordflow">if</span> (! hProfile)
04106     {
04107         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error opening profile %s\n"</span>), pProfileName));
04108         <span class="keywordflow">goto</span> EndGetProfileClassString;
04109     }
04110 
04111     <span class="comment">//</span>
04112     <span class="comment">// Check the validation of the profile.</span>
04113     <span class="comment">//</span>
04114     <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a15">IsColorProfileValid</a>(hProfile,&amp;bValidProfile) || ! bValidProfile)
04115     {
04116         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error invalid profile %s\n"</span>), pProfileName));
04117         <span class="keywordflow">goto</span> EndGetProfileClassString;
04118     }
04119 
04120     <span class="comment">//</span>
04121     <span class="comment">// Get the profile class</span>
04122     <span class="comment">//</span>
04123 
04124     <span class="keywordflow">if</span> (! pHeader)
04125     {
04126         pHeader = &amp;header;
04127     }
04128 
04129     <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a25">GetColorProfileHeader</a>(hProfile, pHeader))
04130     {
04131         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a5">ERR</a>((__TEXT(<span class="stringliteral">"Error getting color profile header for %s\n"</span>), pProfileName));
04132         <span class="keywordflow">goto</span> EndGetProfileClassString;
04133     }
04134     <a class="code" href="../../d9/d7/profman_8c.html#a51">ConvertDwordToString</a>(pHeader-&gt;phClass, pClass);
04135 
04136     rc= <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04137 
04138 EndGetProfileClassString:
04139     <span class="keywordflow">if</span> (hProfile)
04140     {
04141         <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a13">CloseColorProfile</a>(hProfile);
04142     }
04143 
04144     <span class="keywordflow">return</span> rc;
04145 }
04146 
04147 
04148 <span class="comment">/******************************************************************************</span>
04149 <span class="comment"> *</span>
04150 <span class="comment"> *                           GetFilenameFromPath</span>
04151 <span class="comment"> *</span>
04152 <span class="comment"> *  Function:</span>
04153 <span class="comment"> *       This function takes a fully qualified pathname and returns a pointer</span>
04154 <span class="comment"> *       to the filename part alone</span>
04155 <span class="comment"> *</span>
04156 <span class="comment"> *  Arguments:</span>
04157 <span class="comment"> *       pPathName       - pointer to pathname</span>
04158 <span class="comment"> *</span>
04159 <span class="comment"> *  Returns:</span>
04160 <span class="comment"> *       Pointer to filename on success, NULL otherwise</span>
04161 <span class="comment"> *</span>
04162 <span class="comment"> ******************************************************************************/</span>
04163 
04164 PTSTR
<a name="l04165"></a><a class="code" href="../../d9/d7/profman_8c.html#a96">04165</a> <a class="code" href="../../d9/d7/profman_8c.html#a96">GetFilenameFromPath</a>(
04166     PTSTR pPathName
04167     )
04168 {
04169     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwLen;                      <span class="comment">// length of pathname</span>
04170     PTSTR pPathNameStart = pPathName;
04171 
04172     dwLen = lstrlen(pPathName);
04173 
04174     <span class="keywordflow">if</span> (dwLen == 0)
04175     {
04176         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04177     }
04178 
04179     <span class="comment">//</span>
04180     <span class="comment">// Go to the end of the pathname, and start going backwards till</span>
04181     <span class="comment">// you reach the beginning or a backslash</span>
04182     <span class="comment">//</span>
04183 
04184     pPathName += dwLen;
04185 
04186     <span class="comment">//</span>
04187     <span class="comment">// Currently 'pPathName' points null-terminate character, so move</span>
04188     <span class="comment">// the pointer to last character.</span>
04189     <span class="comment">//</span>
04190 
04191     <span class="keywordflow">do</span>
04192     {
04193         pPathName = CharPrev(pPathNameStart,pPathName);
04194 
04195         <span class="keywordflow">if</span> (*pPathName == TEXT(<span class="charliteral">'\\'</span>))
04196         {
04197             pPathName = CharNext(pPathName);
04198             <span class="keywordflow">break</span>;
04199         }
04200 
04201         <span class="comment">//</span>
04202         <span class="comment">// Loop until fist</span>
04203         <span class="comment">//</span>
04204 
04205     } <span class="keywordflow">while</span> (pPathNameStart &lt; pPathName);
04206 
04207     <span class="comment">//</span>
04208     <span class="comment">// if *pPathName is zero, then we had a string that ends in a backslash</span>
04209     <span class="comment">//</span>
04210 
04211     <span class="keywordflow">return</span> *pPathName ? pPathName : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04212 }
04213 
04214 
04215 <span class="comment">/******************************************************************************</span>
04216 <span class="comment"> *</span>
04217 <span class="comment"> *                              GetDeviceData</span>
04218 <span class="comment"> *</span>
04219 <span class="comment"> *  Function:</span>
04220 <span class="comment"> *       This function is a wrapper for IGetDeviceData. For devices like monitor,</span>
04221 <span class="comment"> *       printer &amp; scanner it calls the internal function. If we are asked</span>
04222 <span class="comment"> *       to get the device data for a "colorspace device", we try monitor, printer</span>
04223 <span class="comment"> *       and scanner till one succeeds or they all fail. This is done so that we</span>
04224 <span class="comment"> *       we can associate sRGB like profiles with any device.</span>
04225 <span class="comment"> *</span>
04226 <span class="comment"> *  Arguments:</span>
04227 <span class="comment"> *       pDeviceName     - pointer to name of the device</span>
04228 <span class="comment"> *       dwClass         - device type like monitor, printer etc.</span>
04229 <span class="comment"> *       ppDeviceData    - pointer to pointer to buffer to receive data</span>
04230 <span class="comment"> *       pdwSize         - pointer to size of buffer. On return it is size of</span>
04231 <span class="comment"> *                         data returned/size needed.</span>
04232 <span class="comment"> *       bAllocate       - If TRUE, allocate memory for data</span>
04233 <span class="comment"> *</span>
04234 <span class="comment"> *  Returns:</span>
04235 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
04236 <span class="comment"> *</span>
04237 <span class="comment"> ******************************************************************************/</span>
04238 
04239 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l04240"></a><a class="code" href="../../d9/d7/profman_8c.html#a54">04240</a> <a class="code" href="../../d9/d7/profman_8c.html#a54">GetDeviceData</a>(
04241     LPCTSTR pDeviceName,
04242     DWORD   dwClass,
04243     DWORD   dwDataType,
04244     PVOID  *ppDeviceData,
04245     PDWORD  pdwSize,
04246     BOOL    bAllocate
04247     )
04248 {
04249     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04250 
04251     <span class="keywordflow">if</span> (dwClass == CLASS_MONITOR ||
04252         dwClass == CLASS_PRINTER ||
04253         dwClass == CLASS_SCANNER)
04254     {
04255         rc = <a class="code" href="../../d9/d7/profman_8c.html#a56">IGetDeviceData</a>(pDeviceName, dwClass, dwDataType, ppDeviceData, pdwSize, bAllocate);
04256     }
04257     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dwClass == CLASS_COLORSPACE)
04258     {
04259         rc = <a class="code" href="../../d9/d7/profman_8c.html#a56">IGetDeviceData</a>(pDeviceName, CLASS_MONITOR, dwDataType, ppDeviceData, pdwSize, bAllocate) ||
04260              <a class="code" href="../../d9/d7/profman_8c.html#a56">IGetDeviceData</a>(pDeviceName, CLASS_PRINTER, dwDataType, ppDeviceData, pdwSize, bAllocate) ||
04261              <a class="code" href="../../d9/d7/profman_8c.html#a56">IGetDeviceData</a>(pDeviceName, CLASS_SCANNER, dwDataType, ppDeviceData, pdwSize, bAllocate);
04262     }
04263 
04264     <span class="keywordflow">return</span> rc;
04265 }
04266 
04267 
04268 <span class="comment">/******************************************************************************</span>
04269 <span class="comment"> *</span>
04270 <span class="comment"> *                              IGetDeviceData</span>
04271 <span class="comment"> *</span>
04272 <span class="comment"> *  Function:</span>
04273 <span class="comment"> *       This function retrieves ICM data stored with the different devices.</span>
04274 <span class="comment"> *</span>
04275 <span class="comment"> *  Arguments:</span>
04276 <span class="comment"> *       pDeviceName     - pointer to name of the device</span>
04277 <span class="comment"> *       dwClass         - device type like monitor, printer etc.</span>
04278 <span class="comment"> *       ppDeviceData    - pointer to pointer to buffer to receive data</span>
04279 <span class="comment"> *       pdwSize         - pointer to size of buffer. On return it is size of</span>
04280 <span class="comment"> *                         data returned/size needed.</span>
04281 <span class="comment"> *       bAllocate       - If TRUE, allocate memory for data</span>
04282 <span class="comment"> *</span>
04283 <span class="comment"> *  Returns:</span>
04284 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
04285 <span class="comment"> *</span>
04286 <span class="comment"> ******************************************************************************/</span>
04287 
04288 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l04289"></a><a class="code" href="../../d9/d7/profman_8c.html#a56">04289</a> <a class="code" href="../../d9/d7/profman_8c.html#a56">IGetDeviceData</a>(
04290     LPCTSTR pDeviceName,
04291     DWORD   dwClass,
04292     DWORD   dwDataType,
04293     PVOID  *ppDeviceData,
04294     PDWORD  pdwSize,
04295     BOOL    bAllocate
04296     )
04297 {
04298     <a class="code" href="../../d9/d7/profman_8c.html#a22">PFNOPENDEVICE</a>    fnOpenDevice;
04299     <a class="code" href="../../d9/d7/profman_8c.html#a23">PFNCLOSEDEVICE</a>   fnCloseDevice;
04300     <a class="code" href="../../d9/d7/profman_8c.html#a24">PFNGETDEVICEDATA</a> fnGetData;
04301     HANDLE           hDevice;
04302     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>            dwSize;
04303     LPTSTR           pDataKey;
04304     LPTSTR           pDataValue;
04305     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04306 
04307     <span class="comment">//</span>
04308     <span class="comment">// Set up function pointers so we can write common code</span>
04309     <span class="comment">//</span>
04310 
04311     <span class="keywordflow">switch</span> (dwClass)
04312     {
04313     <span class="keywordflow">case</span> CLASS_PRINTER:
04314         fnOpenDevice  = (<a class="code" href="../../d9/d7/profman_8c.html#a22">PFNOPENDEVICE</a>)<a class="code" href="../../d9/d7/profman_8c.html#a65">OpenPrtr</a>;
04315         fnCloseDevice = (<a class="code" href="../../d9/d7/profman_8c.html#a23">PFNCLOSEDEVICE</a>)<a class="code" href="../../d9/d7/profman_8c.html#a66">ClosePrtr</a>;
04316         fnGetData     = (<a class="code" href="../../d9/d7/profman_8c.html#a24">PFNGETDEVICEDATA</a>)<a class="code" href="../../d9/d7/profman_8c.html#a67">GetPrtrData</a>;
04317         <span class="keywordflow">break</span>;
04318 
04319     <span class="keywordflow">case</span> CLASS_MONITOR:
04320         fnOpenDevice  = (<a class="code" href="../../d9/d7/profman_8c.html#a22">PFNOPENDEVICE</a>)<a class="code" href="../../d9/d7/profman_8c.html#a69">OpenMonitor</a>;
04321         fnCloseDevice = (<a class="code" href="../../d9/d7/profman_8c.html#a23">PFNCLOSEDEVICE</a>)<a class="code" href="../../d9/d7/profman_8c.html#a70">CloseMonitor</a>;
04322         fnGetData     = (<a class="code" href="../../d9/d7/profman_8c.html#a24">PFNGETDEVICEDATA</a>)<a class="code" href="../../d9/d7/profman_8c.html#a71">GetMonitorData</a>;
04323         <span class="keywordflow">break</span>;
04324 
04325     <span class="keywordflow">case</span> CLASS_SCANNER:
04326         fnOpenDevice  = (<a class="code" href="../../d9/d7/profman_8c.html#a22">PFNOPENDEVICE</a>)<a class="code" href="../../d9/d7/profman_8c.html#a73">OpenScanner</a>;
04327         fnCloseDevice = (<a class="code" href="../../d9/d7/profman_8c.html#a23">PFNCLOSEDEVICE</a>)<a class="code" href="../../d9/d7/profman_8c.html#a74">CloseScanner</a>;
04328         fnGetData     = (<a class="code" href="../../d9/d7/profman_8c.html#a24">PFNGETDEVICEDATA</a>)<a class="code" href="../../d9/d7/profman_8c.html#a75">GetScannerData</a>;
04329         <span class="keywordflow">break</span>;
04330 
04331     <span class="keywordflow">default</span>:
04332         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04333     }
04334 
04335     <span class="comment">//</span>
04336     <span class="comment">// Set up registry keywords.</span>
04337     <span class="comment">//</span>
04338 
04339     <span class="keywordflow">switch</span> (dwDataType)
04340     {
04341     <span class="keywordflow">case</span> <a class="code" href="../../d9/d7/profman_8c.html#a8">DEVICE_PROFILE_DATA</a>:
04342 
04343         pDataKey      = <a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a24">gszICMProfileListKey</a>;
04344 
04345         <span class="comment">//</span>
04346         <span class="comment">// The way to store printer profile is different than others... trim it.</span>
04347         <span class="comment">//</span>
04348 
04349         <span class="keywordflow">if</span> (dwClass == CLASS_PRINTER)
04350         {
04351             pDataValue = <a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a26">gszFiles</a>;
04352         }
04353         <span class="keywordflow">else</span>
04354         {
04355             pDataValue = <a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a25">gszICMProfileListValue</a>;
04356         }
04357 
04358         <span class="keywordflow">break</span>;
04359 
04360     <span class="keywordflow">case</span> <a class="code" href="../../d9/d7/profman_8c.html#a9">DEVICE_PROFILE_ENUMMODE</a>:
04361 
04362         pDataKey      = <a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a30">gszICMDeviceDataKey</a>;
04363         pDataValue    = <a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a31">gszICMProfileEnumMode</a>;
04364         <span class="keywordflow">break</span>;
04365 
04366     <span class="keywordflow">default</span>:
04367         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04368     }
04369 
04370     <span class="comment">//</span>
04371     <span class="comment">// Open the device and get a handle to it</span>
04372     <span class="comment">//</span>
04373 
04374     <span class="keywordflow">if</span> (! (*fnOpenDevice)((PTSTR)pDeviceName, &amp;hDevice, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))
04375     {
04376         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04377     }
04378 
04379     <span class="keywordflow">if</span> (bAllocate || (ppDeviceData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))
04380     {
04381         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> retcode;
04382 
04383         <span class="comment">//</span>
04384         <span class="comment">// We need to allocate memory. Find out how much we need, and</span>
04385         <span class="comment">// allocate it.</span>
04386         <span class="comment">//</span>
04387 
04388         dwSize = 0;
04389         retcode = (*fnGetData)(hDevice, pDataKey, pDataValue, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, &amp;dwSize);
04390 
04391         <span class="keywordflow">if</span> ((retcode != ERROR_SUCCESS)    &amp;&amp;  <span class="comment">// Win 95 returns this</span>
04392             (retcode != ERROR_MORE_DATA))     <span class="comment">// NT returns this</span>
04393         {
04394             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a2">VERBOSE</a>((__TEXT(<span class="stringliteral">"GetDeviceData failed for %s\n"</span>), pDeviceName));
04395             <span class="keywordflow">goto</span> EndGetDeviceData;
04396         }
04397 
04398         *pdwSize = dwSize;
04399 
04400         <span class="keywordflow">if</span> (ppDeviceData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
04401         {
04402             <span class="comment">//</span>
04403             <span class="comment">// Caller wants to know the data size.</span>
04404             <span class="comment">//</span>
04405 
04406             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04407             <span class="keywordflow">goto</span> EndGetDeviceData;
04408         }
04409         <span class="keywordflow">else</span>
04410         {
04411             <span class="comment">//</span>
04412             <span class="comment">// Allocate buffer.</span>
04413             <span class="comment">//</span>
04414 
04415             *ppDeviceData = <a class="code" href="../../d2/d1/object_8c.html#a7">MemAlloc</a>(dwSize);
04416             <span class="keywordflow">if</span> (! *ppDeviceData)
04417             {
04418                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error allocating memory\n"</span>)));
04419                 SetLastError(ERROR_NOT_ENOUGH_MEMORY);
04420                 <span class="keywordflow">goto</span> EndGetDeviceData;
04421             }
04422         }
04423     }
04424 
04425     <span class="comment">//</span>
04426     <span class="comment">// Get the data</span>
04427     <span class="comment">//</span>
04428 
04429     <span class="keywordflow">if</span> ((*fnGetData)(hDevice, pDataKey, pDataValue, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)*ppDeviceData,
04430         *pdwSize, pdwSize) == ERROR_SUCCESS)
04431     {
04432         rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04433     }
04434 
04435 EndGetDeviceData:
04436     (*fnCloseDevice)(hDevice);
04437 
04438     <span class="keywordflow">return</span> rc;
04439 }
04440 
04441 
04442 <span class="comment">/******************************************************************************</span>
04443 <span class="comment"> *</span>
04444 <span class="comment"> *                              SetDeviceData</span>
04445 <span class="comment"> *</span>
04446 <span class="comment"> *  Function:</span>
04447 <span class="comment"> *       This function is a wrapper for ISetDeviceData. For devices like monitor,</span>
04448 <span class="comment"> *       printer &amp; scanner it calls the internal function. If we are asked</span>
04449 <span class="comment"> *       to set the device data for a "colorspace device", we try monitor, printer</span>
04450 <span class="comment"> *       and scanner till one succeeds or they all fail. This is done so that we</span>
04451 <span class="comment"> *       we can associate sRGB like profiles with any device.</span>
04452 <span class="comment"> *</span>
04453 <span class="comment"> *  Arguments:</span>
04454 <span class="comment"> *       pDeviceName     - pointer to name of the device</span>
04455 <span class="comment"> *       dwClass         - device type like monitor, printer etc.</span>
04456 <span class="comment"> *       pDeviceData     - pointer buffer containing data</span>
04457 <span class="comment"> *       dwSize          - size of data</span>
04458 <span class="comment"> *</span>
04459 <span class="comment"> *  Returns:</span>
04460 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
04461 <span class="comment"> *</span>
04462 <span class="comment"> ******************************************************************************/</span>
04463 
04464 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l04465"></a><a class="code" href="../../d9/d7/profman_8c.html#a55">04465</a> <a class="code" href="../../d9/d7/profman_8c.html#a55">SetDeviceData</a>(
04466     LPCTSTR pDeviceName,
04467     DWORD   dwClass,
04468     DWORD   dwDataType,
04469     PVOID   pDeviceData,
04470     DWORD   dwSize
04471     )
04472 {
04473     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04474 
04475     <span class="keywordflow">if</span> (dwClass == CLASS_MONITOR ||
04476         dwClass == CLASS_PRINTER ||
04477         dwClass == CLASS_SCANNER)
04478     {
04479         rc = <a class="code" href="../../d9/d7/profman_8c.html#a57">ISetDeviceData</a>(pDeviceName, dwClass, dwDataType, pDeviceData, dwSize);
04480     }
04481     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dwClass == CLASS_COLORSPACE)
04482     {
04483         rc = <a class="code" href="../../d9/d7/profman_8c.html#a57">ISetDeviceData</a>(pDeviceName, CLASS_MONITOR, dwDataType, pDeviceData, dwSize) ||
04484              <a class="code" href="../../d9/d7/profman_8c.html#a57">ISetDeviceData</a>(pDeviceName, CLASS_PRINTER, dwDataType, pDeviceData, dwSize) ||
04485              <a class="code" href="../../d9/d7/profman_8c.html#a57">ISetDeviceData</a>(pDeviceName, CLASS_SCANNER, dwDataType, pDeviceData, dwSize);
04486     }
04487 
04488     <span class="keywordflow">return</span> rc;
04489 }
04490 
04491 
04492 <span class="comment">/******************************************************************************</span>
04493 <span class="comment"> *</span>
04494 <span class="comment"> *                              ISetDeviceData</span>
04495 <span class="comment"> *</span>
04496 <span class="comment"> *  Function:</span>
04497 <span class="comment"> *       This function sets ICM data stored with the different devices.</span>
04498 <span class="comment"> *</span>
04499 <span class="comment"> *  Arguments:</span>
04500 <span class="comment"> *       pDeviceName     - pointer to name of the device</span>
04501 <span class="comment"> *       dwClass         - device type like monitor, printer etc.</span>
04502 <span class="comment"> *       pDeviceData     - pointer buffer containing data</span>
04503 <span class="comment"> *       dwSize          - size of data</span>
04504 <span class="comment"> *</span>
04505 <span class="comment"> *  Returns:</span>
04506 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
04507 <span class="comment"> *</span>
04508 <span class="comment"> ******************************************************************************/</span>
04509 
04510 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l04511"></a><a class="code" href="../../d9/d7/profman_8c.html#a57">04511</a> <a class="code" href="../../d9/d7/profman_8c.html#a57">ISetDeviceData</a>(
04512     LPCTSTR pDeviceName,
04513     DWORD   dwClass,
04514     DWORD   dwDataType,
04515     PVOID   pDeviceData,
04516     DWORD   dwSize
04517     )
04518 {
04519     PRINTER_DEFAULTS    <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>;
04520     <a class="code" href="../../d9/d7/profman_8c.html#a22">PFNOPENDEVICE</a>       fnOpenDevice;
04521     <a class="code" href="../../d9/d7/profman_8c.html#a23">PFNCLOSEDEVICE</a>      fnCloseDevice;
04522     <a class="code" href="../../d9/d7/profman_8c.html#a25">PFNSETDEVICEDATA</a>    fnSetData;
04523     HANDLE              hDevice;
04524     LPTSTR              pDataKey;
04525     LPTSTR              pDataValue;
04526     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>               dwRegType = REG_BINARY;
04527     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>                rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04528 
04529     <span class="comment">//</span>
04530     <span class="comment">// Set up function pointers so we can write common code</span>
04531     <span class="comment">//</span>
04532 
04533     <span class="keywordflow">switch</span> (dwClass)
04534     {
04535     <span class="keywordflow">case</span> CLASS_PRINTER:
04536         fnOpenDevice  = (<a class="code" href="../../d9/d7/profman_8c.html#a22">PFNOPENDEVICE</a>)<a class="code" href="../../d9/d7/profman_8c.html#a65">OpenPrtr</a>;
04537         fnCloseDevice = (<a class="code" href="../../d9/d7/profman_8c.html#a23">PFNCLOSEDEVICE</a>)<a class="code" href="../../d9/d7/profman_8c.html#a66">ClosePrtr</a>;
04538         fnSetData     = (<a class="code" href="../../d9/d7/profman_8c.html#a25">PFNSETDEVICEDATA</a>)<a class="code" href="../../d9/d7/profman_8c.html#a68">SetPrtrData</a>;
04539         <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>.pDatatype  = __TEXT(<span class="stringliteral">"RAW"</span>);
04540         <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>.pDevMode   = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04541         <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>.DesiredAccess = PRINTER_ACCESS_ADMINISTER;
04542         <span class="keywordflow">break</span>;
04543 
04544     <span class="keywordflow">case</span> CLASS_MONITOR:
04545         fnOpenDevice  = (<a class="code" href="../../d9/d7/profman_8c.html#a22">PFNOPENDEVICE</a>)<a class="code" href="../../d9/d7/profman_8c.html#a69">OpenMonitor</a>;
04546         fnCloseDevice = (<a class="code" href="../../d9/d7/profman_8c.html#a23">PFNCLOSEDEVICE</a>)<a class="code" href="../../d9/d7/profman_8c.html#a70">CloseMonitor</a>;
04547         fnSetData     = (<a class="code" href="../../d9/d7/profman_8c.html#a25">PFNSETDEVICEDATA</a>)<a class="code" href="../../d9/d7/profman_8c.html#a72">SetMonitorData</a>;
04548         <span class="keywordflow">break</span>;
04549 
04550     <span class="keywordflow">case</span> CLASS_SCANNER:
04551         fnOpenDevice  = (<a class="code" href="../../d9/d7/profman_8c.html#a22">PFNOPENDEVICE</a>)<a class="code" href="../../d9/d7/profman_8c.html#a73">OpenScanner</a>;
04552         fnCloseDevice = (<a class="code" href="../../d9/d7/profman_8c.html#a23">PFNCLOSEDEVICE</a>)<a class="code" href="../../d9/d7/profman_8c.html#a74">CloseScanner</a>;
04553         fnSetData     = (<a class="code" href="../../d9/d7/profman_8c.html#a25">PFNSETDEVICEDATA</a>)<a class="code" href="../../d9/d7/profman_8c.html#a76">SetScannerData</a>;
04554         <span class="keywordflow">break</span>;
04555 
04556     <span class="keywordflow">default</span>:
04557         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04558     }
04559 
04560     <span class="comment">//</span>
04561     <span class="comment">// Set up registry keywords.</span>
04562     <span class="comment">//</span>
04563 
04564     <span class="keywordflow">switch</span> (dwDataType)
04565     {
04566     <span class="keywordflow">case</span> <a class="code" href="../../d9/d7/profman_8c.html#a8">DEVICE_PROFILE_DATA</a>:
04567 
04568         pDataKey      = <a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a24">gszICMProfileListKey</a>;
04569 
04570         <span class="comment">//</span>
04571         <span class="comment">// The way to store printer profile is different than others... trim it.</span>
04572         <span class="comment">//</span>
04573 
04574         <span class="keywordflow">if</span> (dwClass == CLASS_PRINTER)
04575         {
04576             pDataValue = <a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a26">gszFiles</a>;
04577             dwRegType  = REG_MULTI_SZ;
04578         }
04579         <span class="keywordflow">else</span>
04580         {
04581             pDataValue = <a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a25">gszICMProfileListValue</a>;
04582         }
04583 
04584         <span class="keywordflow">break</span>;
04585 
04586     <span class="keywordflow">case</span> <a class="code" href="../../d9/d7/profman_8c.html#a9">DEVICE_PROFILE_ENUMMODE</a>:
04587 
04588         pDataKey      = <a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a30">gszICMDeviceDataKey</a>;
04589         pDataValue    = <a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a31">gszICMProfileEnumMode</a>;
04590         <span class="keywordflow">break</span>;
04591 
04592     <span class="keywordflow">default</span>:
04593         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04594     }
04595 
04596     <span class="comment">//</span>
04597     <span class="comment">// Open the device and get a handle to it</span>
04598     <span class="comment">//</span>
04599 
04600     <span class="keywordflow">if</span> (! (*fnOpenDevice)((PTSTR)pDeviceName, &amp;hDevice, (PTSTR)&amp;<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>))
04601     {
04602         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error opening device %s\n"</span>), pDeviceName));
04603         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04604     }
04605 
04606     <span class="comment">//</span>
04607     <span class="comment">// Set the data</span>
04608     <span class="comment">//</span>
04609 
04610     <span class="keywordflow">if</span> ((*fnSetData)(hDevice, pDataKey, pDataValue, dwRegType, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pDeviceData,
04611                      dwSize) == ERROR_SUCCESS)
04612     {
04613         rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04614     }
04615 
04616 <span class="preprocessor">#if !defined(_WIN95_)</span>
04617 <span class="preprocessor"></span>
04618     <span class="comment">//</span>
04619     <span class="comment">// If this is printer class, need some more data for profile list.</span>
04620     <span class="comment">//</span>
04621 
04622     <span class="keywordflow">if</span> ((rc == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp; (dwClass == CLASS_PRINTER) &amp;&amp; (dwDataType == <a class="code" href="../../d9/d7/profman_8c.html#a8">DEVICE_PROFILE_DATA</a>))
04623     {
04624         <span class="keywordflow">if</span> (((*fnSetData)(hDevice, pDataKey, <a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a27">gszDirectory</a>, REG_SZ, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a20">gszColorDir</a>,
04625                           (lstrlen(<a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a20">gszColorDir</a>) + 1)*<span class="keyword">sizeof</span>(TCHAR)) != ERROR_SUCCESS) ||
04626             ((*fnSetData)(hDevice, pDataKey, <a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a28">gszModule</a>, REG_SZ, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a29">gszMSCMS</a>,
04627                           (lstrlen(<a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a29">gszMSCMS</a>) + 1)*<span class="keyword">sizeof</span>(TCHAR)) != ERROR_SUCCESS))
04628         {
04629             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04630         }
04631     }
04632 
04633 <span class="preprocessor">#endif</span>
04634 <span class="preprocessor"></span>
04635     (*fnCloseDevice)(hDevice);
04636 
04637     <span class="keywordflow">return</span> rc;
04638 }
04639 
04640 
04641 <span class="comment">/******************************************************************************</span>
04642 <span class="comment"> *</span>
04643 <span class="comment"> *                              IsStringInMultiSz</span>
04644 <span class="comment"> *</span>
04645 <span class="comment"> *  Function:</span>
04646 <span class="comment"> *       This functions checks if a given multi-sz string has the given string</span>
04647 <span class="comment"> *       as one of the strings, and returns TRUE if it does.</span>
04648 <span class="comment"> *</span>
04649 <span class="comment"> *  Arguments:</span>
04650 <span class="comment"> *       pMultiSzString - multi sz string to look in</span>
04651 <span class="comment"> *       pString        - string to find</span>
04652 <span class="comment"> *</span>
04653 <span class="comment"> *  Returns:</span>
04654 <span class="comment"> *       TRUE</span>
04655 <span class="comment"> *</span>
04656 <span class="comment"> ******************************************************************************/</span>
04657 
04658 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l04659"></a><a class="code" href="../../d9/d7/profman_8c.html#a58">04659</a> <a class="code" href="../../d9/d7/profman_8c.html#a58">IsStringInMultiSz</a>(
04660     PTSTR pMultiSzString,
04661     PTSTR pString
04662     )
04663 {
04664     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;                <span class="comment">// return code</span>
04665 
04666     <span class="keywordflow">while</span> (*pMultiSzString)
04667     {
04668         <span class="keywordflow">if</span> (! lstrcmpi(pMultiSzString, pString))
04669         {
04670             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04671             <span class="keywordflow">break</span>;
04672         }
04673 
04674         pMultiSzString += lstrlen(pMultiSzString) + 1;
04675     }
04676 
04677     <span class="keywordflow">return</span> rc;
04678 }
04679 
04680 
04681 <span class="comment">/******************************************************************************</span>
04682 <span class="comment"> *</span>
04683 <span class="comment"> *                            RemoveStringFromMultiSz</span>
04684 <span class="comment"> *</span>
04685 <span class="comment"> *  Function:</span>
04686 <span class="comment"> *       This functions removes a given string from a multi-sz string.</span>
04687 <span class="comment"> *</span>
04688 <span class="comment"> *  Arguments:</span>
04689 <span class="comment"> *       pMultiSzString - multi sz string to look in</span>
04690 <span class="comment"> *       pString        - string to remove</span>
04691 <span class="comment"> *       dwSize         - size in bytes of multi-sz string</span>
04692 <span class="comment"> *</span>
04693 <span class="comment"> *  Returns:</span>
04694 <span class="comment"> *       TRUE</span>
04695 <span class="comment"> *</span>
04696 <span class="comment"> ******************************************************************************/</span>
04697 
04698 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
<a name="l04699"></a><a class="code" href="../../d9/d7/profman_8c.html#a59">04699</a> <a class="code" href="../../d9/d7/profman_8c.html#a59">RemoveStringFromMultiSz</a>(
04700     PTSTR pMultiSzString,
04701     PTSTR pString,
04702     DWORD dwSize
04703     )
04704 {
04705     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwCount = dwSize;         <span class="comment">// count of bytes remaining</span>
04706 
04707     <span class="keywordflow">while</span> (*pMultiSzString)
04708     {
04709         dwCount -= (lstrlen(pMultiSzString) + 1) * <span class="keyword">sizeof</span>(TCHAR);
04710 
04711         <span class="keywordflow">if</span> (! lstrcmpi(pMultiSzString, pString))
04712         {
04713             <span class="keywordflow">break</span>;
04714         }
04715 
04716         pMultiSzString += lstrlen(pMultiSzString) + 1;
04717     }
04718 
04719     <a class="code" href="../../d2/d1/object_8c.html#a10">MyCopyMemory</a>((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pMultiSzString, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)(pMultiSzString + lstrlen(pString) + 1), dwCount);
04720 
04721     <span class="keywordflow">return</span> dwSize - <span class="keyword">sizeof</span>(TCHAR) * (lstrlen(pString) + 1);
04722 }
04723 
04724 
04725 <span class="comment">/******************************************************************************</span>
04726 <span class="comment"> *</span>
04727 <span class="comment"> *                           DoesProfileMatchEnumRecord</span>
04728 <span class="comment"> *</span>
04729 <span class="comment"> *  Function:</span>
04730 <span class="comment"> *       This functions checks if a profile matches the criteria given in</span>
04731 <span class="comment"> *       the enumeration record. Note that it does not check if the profile</span>
04732 <span class="comment"> *       belongs to the device specified by pDeviceName. So that check must</span>
04733 <span class="comment"> *       have happened before itself.</span>
04734 <span class="comment"> *</span>
04735 <span class="comment"> *  Arguments:</span>
04736 <span class="comment"> *       pProfileName   - profile to look at</span>
04737 <span class="comment"> *       pEnumRecord    - pointer to criteria to check against</span>
04738 <span class="comment"> *</span>
04739 <span class="comment"> *  Returns:</span>
04740 <span class="comment"> *       MATCH or EXACT_MATCH if the profile matches the criteria, NOMATCH otherwise</span>
04741 <span class="comment"> *</span>
04742 <span class="comment"> ******************************************************************************/</span>
04743 
<a name="l04744"></a><a class="code" href="../../d9/d7/profman_8c.html#a17">04744</a> <span class="preprocessor">#define SET(pEnumRecord, bit)        ((pEnumRecord)-&gt;dwFields &amp; (bit))</span>
04745 <span class="preprocessor"></span>
04746 <a class="code" href="../../d9/d7/profman_8c.html#a99">MATCHTYPE</a>
<a name="l04747"></a><a class="code" href="../../d9/d7/profman_8c.html#a61">04747</a> <a class="code" href="../../d9/d7/profman_8c.html#a61">DoesProfileMatchEnumRecord</a>(
04748     PTSTR     pProfileName,
04749     PENUMTYPE pEnumRecord
04750     )
04751 {
04752     PROFILEHEADER header;           <span class="comment">// color profile header</span>
04753     PROFILE       prof;             <span class="comment">// profile object for opening profile</span>
04754     HPROFILE      hProfile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;  <span class="comment">// handle to opened profile</span>
04755     <a class="code" href="../../d9/d7/profman_8c.html#a99">MATCHTYPE</a>     rc = <a class="code" href="../../d9/d7/profman_8c.html#a99a40">NOMATCH</a>;     <span class="comment">// return code</span>
04756 
04757     <span class="comment">//</span>
04758     <span class="comment">// Open a handle to the profile</span>
04759     <span class="comment">//</span>
04760 
04761     prof.dwType = PROFILE_FILENAME;
04762     prof.pProfileData = (PVOID)pProfileName;
04763     prof.cbDataSize = (lstrlen(pProfileName) + 1) * <span class="keyword">sizeof</span>(TCHAR);
04764 
04765     hProfile = OpenColorProfile(&amp;prof, PROFILE_READ, FILE_SHARE_READ,
04766                     <a class="code" href="../../d4/d8/ntfsexp_8h.html#a141a69">OPEN_EXISTING</a>);
04767     <span class="keywordflow">if</span> (! hProfile)
04768     {
04769         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error opening profile %s\n"</span>), pProfileName));
04770         <span class="keywordflow">goto</span> EndDoesProfileMatchEnumRecord;
04771     }
04772 
04773     <span class="comment">//</span>
04774     <span class="comment">// Get the profile header</span>
04775     <span class="comment">//</span>
04776 
04777     <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a25">GetColorProfileHeader</a>(hProfile, &amp;header))
04778     {
04779         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a5">ERR</a>((__TEXT(<span class="stringliteral">"Error getting color profile header for %s\n"</span>), pProfileName));
04780         <span class="keywordflow">goto</span> EndDoesProfileMatchEnumRecord;
04781     }
04782 
04783     <span class="keywordflow">if</span> ((!<a class="code" href="../../d9/d7/profman_8c.html#a17">SET</a>(pEnumRecord, ET_CMMTYPE)         || (pEnumRecord-&gt;dwCMMType         == header.phCMMType))         &amp;&amp;
04784         (!<a class="code" href="../../d9/d7/profman_8c.html#a17">SET</a>(pEnumRecord, ET_CLASS)           || (pEnumRecord-&gt;dwClass           == header.phClass))           &amp;&amp;
04785         (!<a class="code" href="../../d9/d7/profman_8c.html#a17">SET</a>(pEnumRecord, ET_DATACOLORSPACE)  || (pEnumRecord-&gt;dwDataColorSpace  == header.phDataColorSpace))  &amp;&amp;
04786         (!<a class="code" href="../../d9/d7/profman_8c.html#a17">SET</a>(pEnumRecord, ET_CONNECTIONSPACE) || (pEnumRecord-&gt;dwConnectionSpace == header.phConnectionSpace)) &amp;&amp;
04787         (!<a class="code" href="../../d9/d7/profman_8c.html#a17">SET</a>(pEnumRecord, ET_SIGNATURE)       || (pEnumRecord-&gt;dwSignature       == header.phSignature))       &amp;&amp;
04788         (!<a class="code" href="../../d9/d7/profman_8c.html#a17">SET</a>(pEnumRecord, ET_PLATFORM)        || (pEnumRecord-&gt;dwPlatform        == header.phPlatform))        &amp;&amp;
04789         (!<a class="code" href="../../d9/d7/profman_8c.html#a17">SET</a>(pEnumRecord, ET_PROFILEFLAGS)    || (pEnumRecord-&gt;dwProfileFlags    == header.phProfileFlags))    &amp;&amp;
04790         (!<a class="code" href="../../d9/d7/profman_8c.html#a17">SET</a>(pEnumRecord, ET_MANUFACTURER)    || (pEnumRecord-&gt;dwManufacturer    == header.phManufacturer))    &amp;&amp;
04791         (!<a class="code" href="../../d9/d7/profman_8c.html#a17">SET</a>(pEnumRecord, ET_MODEL)           || (pEnumRecord-&gt;dwModel           == header.phModel))           &amp;&amp;
04792         (!<a class="code" href="../../d9/d7/profman_8c.html#a17">SET</a>(pEnumRecord, ET_ATTRIBUTES)      || (pEnumRecord-&gt;dwAttributes[0]   == header.phAttributes[0] &amp;&amp;
04793                                                    pEnumRecord-&gt;dwAttributes[1]   == header.phAttributes[1]))   &amp;&amp;
04794         (!<a class="code" href="../../d9/d7/profman_8c.html#a17">SET</a>(pEnumRecord, ET_RENDERINGINTENT) || (pEnumRecord-&gt;dwRenderingIntent == header.phRenderingIntent)) &amp;&amp;
04795         (!<a class="code" href="../../d9/d7/profman_8c.html#a17">SET</a>(pEnumRecord, ET_CREATOR)         || (pEnumRecord-&gt;dwCreator         == header.phCreator)))
04796     {
04797         rc = <a class="code" href="../../d0/d3/dsocode_8c.html#a1">EXACT_MATCH</a>;
04798     }
04799 
04800     <span class="comment">//</span>
04801     <span class="comment">// Check for resolution, media type and halftoning match</span>
04802     <span class="comment">//</span>
04803 
04804     <span class="keywordflow">if</span> (rc != <a class="code" href="../../d9/d7/profman_8c.html#a99a40">NOMATCH</a> &amp;&amp; <a class="code" href="../../d9/d7/profman_8c.html#a17">SET</a>(pEnumRecord, ET_RESOLUTION|ET_MEDIATYPE|ET_DITHERMODE))
04805     {
04806         rc = <a class="code" href="../../d9/d7/profman_8c.html#a62">CheckResMedHftnMatch</a>(hProfile, pEnumRecord);
04807     }
04808 
04809 EndDoesProfileMatchEnumRecord:
04810     <span class="keywordflow">if</span> (hProfile)
04811     {
04812         <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a13">CloseColorProfile</a>(hProfile);
04813     }
04814 
04815     <span class="keywordflow">return</span> rc;
04816 }
04817 
04818 
04819 <span class="comment">/******************************************************************************</span>
04820 <span class="comment"> *</span>
04821 <span class="comment"> *                           CheckResMedHftnMatch</span>
04822 <span class="comment"> *</span>
04823 <span class="comment"> *  Function:</span>
04824 <span class="comment"> *       This functions checks if a profile matches the resolution,</span>
04825 <span class="comment"> *       media type and halftoning criteria specified by the enumeration record.</span>
04826 <span class="comment"> *       It allows an exact match, as well as an ambiguous match. If the</span>
04827 <span class="comment"> *       profile doesn't specify the criteria, it is considered to ambiguously</span>
04828 <span class="comment"> *       match the specification.</span>
04829 <span class="comment"> *       is desired.</span>
04830 <span class="comment"> *</span>
04831 <span class="comment"> *  Arguments:</span>
04832 <span class="comment"> *       hProfile       - handle identifying profile</span>
04833 <span class="comment"> *       pEnumRecord    - pointer to criteria to check against</span>
04834 <span class="comment"> *</span>
04835 <span class="comment"> *  Returns:</span>
04836 <span class="comment"> *       MATCH or EXACT_MATCH if the profile matches the criteria, NOMATCH otherwise</span>
04837 <span class="comment"> *</span>
04838 <span class="comment"> ******************************************************************************/</span>
04839 
04840 <a class="code" href="../../d9/d7/profman_8c.html#a99">MATCHTYPE</a>
<a name="l04841"></a><a class="code" href="../../d9/d7/profman_8c.html#a62">04841</a> <a class="code" href="../../d9/d7/profman_8c.html#a62">CheckResMedHftnMatch</a>(
04842     HPROFILE   hProfile,
04843     PENUMTYPE  pEnumRecord
04844     )
04845 {
04846     PDEVICESETTINGS   pDevSettings = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04847     PPLATFORMENTRY    pPlatform;
04848     PSETTINGCOMBOS    pCombo;
04849     PSETTINGS         pSetting;
04850     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>             dwMSData[4];
04851     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>             dwSize, i, iMax, j, jMax;
04852     <a class="code" href="../../d9/d7/profman_8c.html#a99">MATCHTYPE</a>         rc = <a class="code" href="../../d9/d7/profman_8c.html#a99a41">MATCH</a>;       <span class="comment">// Assume ambiguous match</span>
04853     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>              bReference;
04854 
04855     <span class="comment">//</span>
04856     <span class="comment">// Check if the profile has the new device settings tag</span>
04857     <span class="comment">//</span>
04858 
04859     dwSize = 0;
04860     <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a21">GetColorProfileElement</a>(hProfile, <a class="code" href="../../d9/d7/profman_8c.html#a0">TAG_DEVICESETTINGS</a>, 0, &amp;dwSize, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;bReference);
04861 
04862     <span class="keywordflow">if</span> (dwSize &gt; 0)
04863     {
04864         <span class="keywordflow">if</span> (!(pDevSettings = (PDEVICESETTINGS)GlobalAllocPtr(GHND, dwSize)))
04865         {
04866             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error allocating memory\n"</span>)));
04867             <span class="keywordflow">return</span> <a class="code" href="../../d9/d7/profman_8c.html#a99a40">NOMATCH</a>;
04868         }
04869 
04870         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a21">GetColorProfileElement</a>(hProfile, <a class="code" href="../../d9/d7/profman_8c.html#a0">TAG_DEVICESETTINGS</a>, 0, &amp;dwSize, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pDevSettings, &amp;bReference))
04871         {
04872             pPlatform = &amp;pDevSettings-&gt;PlatformEntry[0];
04873 
04874             <span class="comment">//</span>
04875             <span class="comment">// Navigate to the place where Microsoft specific settings are kept</span>
04876             <span class="comment">//</span>
04877 
04878             i = 0;
04879             iMax = FIX_ENDIAN(pDevSettings-&gt;nPlatforms);
04880             <span class="keywordflow">while</span> ((i &lt; iMax) &amp;&amp; (pPlatform-&gt;PlatformID != <a class="code" href="../../d9/d7/profman_8c.html#a4">ID_MSFT_REVERSED</a>))
04881 
04882             {
04883                 i++;
04884                 pPlatform = (PPLATFORMENTRY)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pPlatform + FIX_ENDIAN(pPlatform-&gt;dwSize));
04885             }
04886 
04887             <span class="keywordflow">if</span> (i &gt;= iMax)
04888             {
04889                 <span class="comment">//</span>
04890                 <span class="comment">// There are no MS specific settings, assume this profile is valid</span>
04891                 <span class="comment">// for all settings (ambigous match)</span>
04892                 <span class="comment">//</span>
04893 
04894                 <span class="keywordflow">goto</span> EndCheckResMedHftnMatch;
04895             }
04896 
04897             <span class="comment">//</span>
04898             <span class="comment">// Found MS specific data. Now go through each combination of settings</span>
04899             <span class="comment">//</span>
04900 
04901             pCombo = &amp;pPlatform-&gt;SettingCombos[0];
04902             iMax = FIX_ENDIAN(pPlatform-&gt;nSettingCombos);
04903             <span class="keywordflow">for</span> (i=0; i&lt;iMax; i++)
04904             {
04905                 <span class="comment">//</span>
04906                 <span class="comment">// Go through each setting in the combination</span>
04907                 <span class="comment">//</span>
04908 
04909                 pSetting = &amp;pCombo-&gt;Settings[0];
04910                 jMax = FIX_ENDIAN(pCombo-&gt;nSettings);
04911                 <span class="keywordflow">for</span> (j=0; j&lt;jMax; j++)
04912                 {
04913                     <span class="keywordflow">if</span> (pSetting-&gt;dwSettingType == <a class="code" href="../../d9/d7/profman_8c.html#a5">ID_MEDIATYPE_REVERSED</a>)
04914                     {
04915                         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d7/profman_8c.html#a17">SET</a>(pEnumRecord, ET_MEDIATYPE) &amp;&amp;
04916                             !<a class="code" href="../../d9/d7/profman_8c.html#a63">DwordMatches</a>(pSetting, pEnumRecord-&gt;dwMediaType))
04917                         {
04918                             <span class="keywordflow">goto</span> NextCombo;
04919                         }
04920                     }
04921                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pSetting-&gt;dwSettingType == <a class="code" href="../../d9/d7/profman_8c.html#a6">ID_DITHER_REVERSED</a>)
04922                     {
04923                         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d7/profman_8c.html#a17">SET</a>(pEnumRecord, ET_DITHERMODE) &amp;&amp;
04924                             !<a class="code" href="../../d9/d7/profman_8c.html#a63">DwordMatches</a>(pSetting, pEnumRecord-&gt;dwDitheringMode))
04925                         {
04926                             <span class="keywordflow">goto</span> NextCombo;
04927                         }
04928                     }
04929                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pSetting-&gt;dwSettingType == <a class="code" href="../../d9/d7/profman_8c.html#a7">ID_RESLN_REVERSED</a>)
04930                     {
04931                         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d7/profman_8c.html#a17">SET</a>(pEnumRecord, ET_RESOLUTION) &amp;&amp;
04932                             !<a class="code" href="../../d9/d7/profman_8c.html#a64">QwordMatches</a>(pSetting, &amp;pEnumRecord-&gt;dwResolution[0]))
04933                         {
04934                             <span class="keywordflow">goto</span> NextCombo;
04935                         }
04936                     }
04937 
04938                     pSetting = (PSETTINGS)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pSetting + <span class="keyword">sizeof</span>(SETTINGS) - <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) +
04939                                         FIX_ENDIAN(pSetting-&gt;dwSizePerValue) * FIX_ENDIAN(pSetting-&gt;nValues));
04940                 }
04941 
04942                 <span class="comment">//</span>
04943                 <span class="comment">// This combination worked!</span>
04944                 <span class="comment">//</span>
04945 
04946                 rc = <a class="code" href="../../d0/d3/dsocode_8c.html#a1">EXACT_MATCH</a>;
04947                 <span class="keywordflow">goto</span> EndCheckResMedHftnMatch;
04948 
04949             NextCombo:
04950                 pCombo = (PSETTINGCOMBOS)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pCombo + FIX_ENDIAN(pCombo-&gt;dwSize));
04951             }
04952 
04953             rc = <a class="code" href="../../d9/d7/profman_8c.html#a99a40">NOMATCH</a>;
04954             <span class="keywordflow">goto</span> EndCheckResMedHftnMatch;
04955 
04956         }
04957         <span class="keywordflow">else</span>
04958         {
04959             rc = <a class="code" href="../../d9/d7/profman_8c.html#a99a40">NOMATCH</a>;
04960             <span class="keywordflow">goto</span> EndCheckResMedHftnMatch;
04961         }
04962     }
04963     <span class="keywordflow">else</span>
04964     {
04965         <span class="comment">//</span>
04966         <span class="comment">// Check if the old MSxx tags are present</span>
04967         <span class="comment">//</span>
04968 
04969         dwSize = <span class="keyword">sizeof</span>(dwMSData);
04970         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d7/profman_8c.html#a17">SET</a>(pEnumRecord, ET_MEDIATYPE))
04971         {
04972             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a21">GetColorProfileElement</a>(hProfile, <a class="code" href="../../d9/d7/profman_8c.html#a1">TAG_MS01</a>, 0, &amp;dwSize, dwMSData, &amp;bReference))
04973             {
04974                 rc = <a class="code" href="../../d0/d3/dsocode_8c.html#a1">EXACT_MATCH</a>;       <span class="comment">// Assume exact match</span>
04975 
04976                 <span class="keywordflow">if</span> (pEnumRecord-&gt;dwMediaType != FIX_ENDIAN(dwMSData[2]))
04977                 {
04978                     <span class="keywordflow">return</span> <a class="code" href="../../d9/d7/profman_8c.html#a99a40">NOMATCH</a>;
04979                 }
04980             }
04981         }
04982 
04983         dwSize = <span class="keyword">sizeof</span>(dwMSData);
04984         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d7/profman_8c.html#a17">SET</a>(pEnumRecord, ET_DITHERMODE))
04985         {
04986             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a21">GetColorProfileElement</a>(hProfile, <a class="code" href="../../d9/d7/profman_8c.html#a2">TAG_MS02</a>, 0, &amp;dwSize, dwMSData, &amp;bReference))
04987             {
04988                 rc = <a class="code" href="../../d0/d3/dsocode_8c.html#a1">EXACT_MATCH</a>;       <span class="comment">// Assume exact match</span>
04989 
04990                 <span class="keywordflow">if</span> (pEnumRecord-&gt;dwDitheringMode != FIX_ENDIAN(dwMSData[2]))
04991                 {
04992                     <span class="keywordflow">return</span> <a class="code" href="../../d9/d7/profman_8c.html#a99a40">NOMATCH</a>;
04993                 }
04994             }
04995         }
04996 
04997         dwSize = <span class="keyword">sizeof</span>(dwMSData);
04998         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d7/profman_8c.html#a17">SET</a>(pEnumRecord, ET_RESOLUTION))
04999         {
05000             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a21">GetColorProfileElement</a>(hProfile, <a class="code" href="../../d9/d7/profman_8c.html#a3">TAG_MS03</a>, 0, &amp;dwSize, dwMSData, &amp;bReference))
05001             {
05002                 rc = <a class="code" href="../../d0/d3/dsocode_8c.html#a1">EXACT_MATCH</a>;       <span class="comment">// Assume exact match</span>
05003 
05004                 <span class="keywordflow">if</span> (pEnumRecord-&gt;dwResolution[0] != FIX_ENDIAN(dwMSData[2]) ||
05005                     pEnumRecord-&gt;dwResolution[1] != FIX_ENDIAN(dwMSData[3]))
05006                 {
05007                     <span class="keywordflow">return</span> <a class="code" href="../../d9/d7/profman_8c.html#a99a40">NOMATCH</a>;
05008                 }
05009             }
05010         }
05011     }
05012 
05013 EndCheckResMedHftnMatch:
05014 
05015     <span class="keywordflow">if</span> (pDevSettings)
05016     {
05017         GlobalFreePtr(pDevSettings);
05018     }
05019 
05020     <span class="keywordflow">return</span> rc;
05021 }
05022 
05023 
05024 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l05025"></a><a class="code" href="../../d9/d7/profman_8c.html#a63">05025</a> <a class="code" href="../../d9/d7/profman_8c.html#a63">DwordMatches</a>(
05026     PSETTINGS    pSetting,
05027     DWORD        dwValue
05028     )
05029 {
05030     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  i, iMax;
05031     PDWORD pValue;
05032 
05033     dwValue = FIX_ENDIAN(dwValue);  <span class="comment">// so we don't have to do this in the loop</span>
05034 
05035     <span class="comment">//</span>
05036     <span class="comment">// Go through all the values. If any of them match, return TRUE.</span>
05037     <span class="comment">//</span>
05038 
05039     pValue = &amp;pSetting-&gt;Value[0];
05040     iMax = FIX_ENDIAN(pSetting-&gt;nValues);
05041     <span class="keywordflow">for</span> (i=0; i&lt;iMax; i++)
05042     {
05043         <span class="keywordflow">if</span> (dwValue == *pValue)
05044         {
05045             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05046         }
05047 
05048         pValue++;                   <span class="comment">// We know that it is a DWORD</span>
05049     }
05050 
05051     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05052 }
05053 
05054 
05055 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l05056"></a><a class="code" href="../../d9/d7/profman_8c.html#a64">05056</a> <a class="code" href="../../d9/d7/profman_8c.html#a64">QwordMatches</a>(
05057     PSETTINGS    pSetting,
05058     PDWORD       pdwValue
05059     )
05060 {
05061     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  i, iMax, dwValue1, dwValue2;
05062     PDWORD pValue;
05063 
05064     dwValue1 = FIX_ENDIAN(*pdwValue);  <span class="comment">// so we don't have to do this in the loop</span>
05065     dwValue2 = FIX_ENDIAN(*(pdwValue+1));
05066 
05067     <span class="comment">//</span>
05068     <span class="comment">// Go through all the values. If any of them match, return TRUE.</span>
05069     <span class="comment">//</span>
05070 
05071     pValue = &amp;pSetting-&gt;Value[0];
05072     iMax = FIX_ENDIAN(pSetting-&gt;nValues);
05073     <span class="keywordflow">for</span> (i=0; i&lt;iMax; i++)
05074     {
05075         <span class="keywordflow">if</span> ((dwValue1 == *pValue) &amp;&amp; (dwValue2 == *(pValue + 1)))
05076         {
05077             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05078         }
05079 
05080         pValue += 2;                   <span class="comment">// We know that it is a QWORD</span>
05081     }
05082 
05083     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05084 }
05085 
05086 
05087 <span class="comment">/******************************************************************************</span>
05088 <span class="comment"> *</span>
05089 <span class="comment"> *                              OpenPrtr</span>
05090 <span class="comment"> *</span>
05091 <span class="comment"> *  Function:</span>
05092 <span class="comment"> *       On Memphis, we cannot call OpenPrinter() because it calls into 16-bit</span>
05093 <span class="comment"> *       code, so if we call this function from GDI-16, we deadlock. So we</span>
05094 <span class="comment"> *       look into the registry directly.</span>
05095 <span class="comment"> *</span>
05096 <span class="comment"> *  Arguments:</span>
05097 <span class="comment"> *       pDeviceName     - pointer to name of the device</span>
05098 <span class="comment"> *       phDevice        - pointer that receives the handle.</span>
05099 <span class="comment"> *       pDummy          - dummy parameter</span>
05100 <span class="comment"> *</span>
05101 <span class="comment"> *  Returns:</span>
05102 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
05103 <span class="comment"> *</span>
05104 <span class="comment"> ******************************************************************************/</span>
05105 
05106 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI
<a name="l05107"></a><a class="code" href="../../d9/d7/profman_8c.html#a65">05107</a> <a class="code" href="../../d9/d7/profman_8c.html#a65">OpenPrtr</a>(
05108     PTSTR    pDeviceName,
05109     LPHANDLE phDevice,
05110     PTSTR    pDummy
05111     )
05112 {
05113 <span class="preprocessor">#if !defined(_WIN95_)</span>
05114 <span class="preprocessor"></span>    <span class="keywordflow">return</span> OpenPrinter(pDeviceName, phDevice, (LPPRINTER_DEFAULTS)pDummy);
05115 <span class="preprocessor">#else</span>
05116 <span class="preprocessor"></span>    HKEY    hkDevice = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;        <span class="comment">// printers branch of registry</span>
05117     HKEY    hkPrtr   = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;        <span class="comment">// Friendly name branch of registry</span>
05118     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwErr;                  <span class="comment">// error code</span>
05119     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;             <span class="comment">// return code</span>
05120 
05121     *phDevice = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05122 
05123     <span class="keywordflow">if</span> (((dwErr = RegOpenKey(HKEY_LOCAL_MACHINE, gszRegPrinter, &amp;hkDevice)) != ERROR_SUCCESS) ||
05124         ((dwErr = RegOpenKey(hkDevice, pDeviceName, &amp;hkPrtr)) != ERROR_SUCCESS) ||
05125         ((dwErr = RegOpenKey(hkPrtr, gszPrinterData, (HKEY *)phDevice)) != ERROR_SUCCESS))
05126     {
05127         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Cannot open printer data branch of registry for %s: %d\n"</span>), pDeviceName, dwErr));
05128         SetLastError(dwErr);
05129         <span class="keywordflow">goto</span> EndOpenPrtr;
05130     }
05131 
05132     rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05133 
05134 EndOpenPrtr:
05135     <span class="keywordflow">if</span> (hkDevice)
05136     {
05137         RegCloseKey(hkDevice);
05138     }
05139     <span class="keywordflow">if</span> (hkPrtr)
05140     {
05141         RegCloseKey(hkPrtr);
05142     }
05143 
05144     <span class="keywordflow">return</span> rc;
05145 <span class="preprocessor">#endif</span>
05146 <span class="preprocessor"></span>}
05147 
05148 
05149 <span class="comment">/******************************************************************************</span>
05150 <span class="comment"> *</span>
05151 <span class="comment"> *                              ClosePrtr</span>
05152 <span class="comment"> *</span>
05153 <span class="comment"> *  Function:</span>
05154 <span class="comment"> *       This function closes the printer handle opened by OpenPrtr.</span>
05155 <span class="comment"> *</span>
05156 <span class="comment"> *  Arguments:</span>
05157 <span class="comment"> *       hDevice         - open handle</span>
05158 <span class="comment"> *</span>
05159 <span class="comment"> *  Returns:</span>
05160 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
05161 <span class="comment"> *</span>
05162 <span class="comment"> ******************************************************************************/</span>
05163 
05164 
05165 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI
<a name="l05166"></a><a class="code" href="../../d9/d7/profman_8c.html#a66">05166</a> <a class="code" href="../../d9/d7/profman_8c.html#a66">ClosePrtr</a>(
05167     HANDLE hDevice
05168     )
05169 {
05170 <span class="preprocessor">#if !defined(_WIN95_)</span>
05171 <span class="preprocessor"></span>    <span class="keywordflow">return</span> ClosePrinter(hDevice);
05172 <span class="preprocessor">#else</span>
05173 <span class="preprocessor"></span>    <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwErr;
05174 
05175     dwErr = RegCloseKey((HKEY)hDevice);
05176     SetLastError(dwErr);
05177     <span class="keywordflow">return</span> dwErr == ERROR_SUCCESS;
05178 <span class="preprocessor">#endif</span>
05179 <span class="preprocessor"></span>}
05180 
05181 
05182 <span class="comment">/******************************************************************************</span>
05183 <span class="comment"> *</span>
05184 <span class="comment"> *                              GetPrtrData</span>
05185 <span class="comment"> *</span>
05186 <span class="comment"> *  Function:</span>
05187 <span class="comment"> *       This functions returns ICM data stored with the printer instance</span>
05188 <span class="comment"> *</span>
05189 <span class="comment"> *  Arguments:</span>
05190 <span class="comment"> *       hDevice         - open printer handle</span>
05191 <span class="comment"> *       pKey            - registry key for compatibility with GetPrinterDataEx</span>
05192 <span class="comment"> *       pName           - name of registry value</span>
05193 <span class="comment"> *       pdwType         - pointer to dword that receives type  of value</span>
05194 <span class="comment"> *       pData           - pointer to  buffer to receive data</span>
05195 <span class="comment"> *       dwSize          - size of buffer</span>
05196 <span class="comment"> *       pdwNeeded       - on return, this has size of buffer filled/needed</span>
05197 <span class="comment"> *</span>
05198 <span class="comment"> *  Returns:</span>
05199 <span class="comment"> *       ERROR_SUCCESS if successful, error code otherwise</span>
05200 <span class="comment"> *</span>
05201 <span class="comment"> ******************************************************************************/</span>
05202 
05203 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI
<a name="l05204"></a><a class="code" href="../../d9/d7/profman_8c.html#a67">05204</a> <a class="code" href="../../d9/d7/profman_8c.html#a67">GetPrtrData</a>(
05205     HANDLE hDevice,
05206     PTSTR  pKey,
05207     PTSTR  pName,
05208     PDWORD pdwType,
05209     PBYTE  pData,
05210     DWORD  dwSize,
05211     PDWORD pdwNeeded
05212     )
05213 {
05214 <span class="preprocessor">#if !defined(_WIN95_)</span>
05215 <span class="preprocessor"></span>    <span class="keywordflow">return</span> GetPrinterDataEx(hDevice, pKey, pName, pdwType, pData, dwSize, pdwNeeded);
05216 <span class="preprocessor">#else</span>
05217 <span class="preprocessor"></span>    *pdwNeeded = dwSize;
05218 
05219     <span class="keywordflow">return</span> RegQueryValueEx((HKEY)hDevice, pName, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pData, pdwNeeded);
05220 <span class="preprocessor">#endif</span>
05221 <span class="preprocessor"></span>}
05222 
05223 
05224 <span class="comment">/******************************************************************************</span>
05225 <span class="comment"> *</span>
05226 <span class="comment"> *                              SetPrtrData</span>
05227 <span class="comment"> *</span>
05228 <span class="comment"> *  Function:</span>
05229 <span class="comment"> *       This functions stores ICM data with the printer instance</span>
05230 <span class="comment"> *</span>
05231 <span class="comment"> *  Arguments:</span>
05232 <span class="comment"> *       hDevice         - open printer handle</span>
05233 <span class="comment"> *       pKey            - registry key for compatibility with SetPrinterDataEx</span>
05234 <span class="comment"> *       pName           - name of registry value</span>
05235 <span class="comment"> *       dwType          - type  of value</span>
05236 <span class="comment"> *       pData           - pointer to  data buffer</span>
05237 <span class="comment"> *       dwSize          - size of buffer</span>
05238 <span class="comment"> *</span>
05239 <span class="comment"> *  Returns:</span>
05240 <span class="comment"> *       ERROR_SUCCESS if successful, error code otherwise</span>
05241 <span class="comment"> *</span>
05242 <span class="comment"> ******************************************************************************/</span>
05243 
05244 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI
<a name="l05245"></a><a class="code" href="../../d9/d7/profman_8c.html#a68">05245</a> <a class="code" href="../../d9/d7/profman_8c.html#a68">SetPrtrData</a>(
05246     HANDLE hDevice,
05247     PTSTR  pKey,
05248     PTSTR  pName,
05249     DWORD  dwType,
05250     PBYTE  pData,
05251     DWORD  dwSize
05252     )
05253 {
05254 <span class="preprocessor">#if !defined(_WIN95_)</span>
05255 <span class="preprocessor"></span>    <span class="keywordflow">return</span> SetPrinterDataEx(hDevice, pKey, pName, dwType, pData, dwSize);
05256 <span class="preprocessor">#else</span>
05257 <span class="preprocessor"></span>    <span class="keywordflow">return</span> RegSetValueEx((HKEY)hDevice, pName, 0, dwType, pData, dwSize);
05258 <span class="preprocessor">#endif</span>
05259 <span class="preprocessor"></span>}
05260 
05261 
05262 <span class="comment">/******************************************************************************</span>
05263 <span class="comment"> *</span>
05264 <span class="comment"> *                              OpenMonitor</span>
05265 <span class="comment"> *</span>
05266 <span class="comment"> *  Function:</span>
05267 <span class="comment"> *       This function returns a handle to the monitor</span>
05268 <span class="comment"> *</span>
05269 <span class="comment"> *  Arguments:</span>
05270 <span class="comment"> *       pDeviceName     - pointer to name of the device</span>
05271 <span class="comment"> *       phDevice        - pointer that receives the handle.</span>
05272 <span class="comment"> *       pDummy          - dummy parameter</span>
05273 <span class="comment"> *</span>
05274 <span class="comment"> *  Returns:</span>
05275 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
05276 <span class="comment"> *</span>
05277 <span class="comment"> ******************************************************************************/</span>
05278 
05279 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI
<a name="l05280"></a><a class="code" href="../../d9/d7/profman_8c.html#a69">05280</a> <a class="code" href="../../d9/d7/profman_8c.html#a69">OpenMonitor</a>(
05281     PTSTR    pDeviceName,
05282     LPHANDLE phDevice,
05283     PTSTR    pDummy
05284     )
05285 {
05286 <span class="preprocessor">#ifdef _WIN95_</span>
05287 <span class="preprocessor"></span>
05288     <span class="comment">//</span>
05289     <span class="comment">// For Windows 9x platform.</span>
05290     <span class="comment">//</span>
05291 
05292     HDEVINFO        hDevInfo = <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>;
05293     HKEY            hkICM = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05294     HKEY            hkDriver = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;        <span class="comment">// software branch of registry</span>
05295     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>           dwSize;                 <span class="comment">// size of buffer</span>
05296     TCHAR           <a class="code" href="../../d4/d9/icmupg_8c.html#a20">szName</a>[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];       <span class="comment">// buffer</span>
05297     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>            rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;             <span class="comment">// return value</span>
05298     SP_DEVINFO_DATA spdid;
05299     <span class="keywordtype">int</span>             i;                      <span class="comment">// instance counter</span>
05300 
05301     <span class="keywordflow">if</span> (!LoadSetupAPIDll())
05302     {
05303         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error loading setupapi.dll: %d\n"</span>), GetLastError()));
05304         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05305     }
05306 
05307     hDevInfo = (*fpSetupDiGetClassDevs)((LPGUID)&amp;GUID_DEVCLASS_MONITOR, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, DIGCF_PRESENT);
05308 
05309     <span class="keywordflow">if</span> (hDevInfo == <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>)
05310     {
05311         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error getting hDevInfo: %d\n"</span>), GetLastError()));
05312         <span class="keywordflow">goto</span> EndOpenMonitor;
05313     }
05314 
05315     i = 0;
05316     <span class="keywordflow">while</span> (! rc)
05317     {
05318         ZeroMemory(&amp;spdid, <span class="keyword">sizeof</span>(SP_DEVINFO_DATA));
05319         spdid.cbSize = <span class="keyword">sizeof</span>(SP_DEVINFO_DATA);
05320         <span class="keywordflow">if</span> (! (*fpSetupDiEnumDeviceInfo)(hDevInfo, i, &amp;spdid))
05321         {
05322             <span class="keywordflow">if</span> (i == 0 &amp;&amp; !lstrcmpi(pDeviceName, <a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a17">gszDisplay</a>))
05323             {
05324                 <span class="comment">//</span>
05325                 <span class="comment">// PnP support not in - open ICM key in registry</span>
05326                 <span class="comment">//</span>
05327 
05328                 TCHAR szICMMonitorData[] = __TEXT(<span class="stringliteral">"ICMMonitorData"</span>);
05329 
05330                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"PnP support absent - Using DISPLAY\n"</span>)));
05331 
05332                 <span class="comment">//</span>
05333                 <span class="comment">// Open the registry path where monitor data is kept</span>
05334                 <span class="comment">//</span>
05335 
05336                 <span class="keywordflow">if</span> ((RegOpenKey(HKEY_LOCAL_MACHINE, <a class="code" href="../../d4/d9/icmupg_8c.html#a8">gszICMRegPath</a>, &amp;hkICM) != ERROR_SUCCESS) ||
05337                     (RegCreateKey(hkICM, szICMMonitorData, &amp;hkDriver) != ERROR_SUCCESS))
05338                 {
05339                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Cannot open ICMMonitorData branch of registry\n"</span>)));
05340                     <span class="keywordflow">goto</span> EndOpenMonitor;
05341                 }
05342                 rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05343             }
05344             <span class="keywordflow">break</span>;
05345         }
05346 
05347         <span class="comment">//</span>
05348         <span class="comment">// Get PnP ID. Check and see if the monitor name matches it.</span>
05349         <span class="comment">//</span>
05350 
05351         dwSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d9/icmupg_8c.html#a20">szName</a>);
05352         <span class="keywordflow">if</span> ((*fpSetupDiGetDeviceInstanceId)(hDevInfo, &amp;spdid, <a class="code" href="../../d4/d9/icmupg_8c.html#a20">szName</a>, dwSize, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
05353             ! lstrcmp(<a class="code" href="../../d4/d9/icmupg_8c.html#a20">szName</a>, pDeviceName))
05354         {
05355             hkDriver = (*fpSetupDiOpenDevRegKey)(hDevInfo, &amp;spdid, DICS_FLAG_GLOBAL, 0, DIREG_DRV, KEY_ALL_ACCESS);
05356             <span class="keywordflow">if</span> (hkDriver == <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>)
05357             {
05358                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Could not open monitor s/w key for all access\n"</span>)));
05359                 hkDriver = (*fpSetupDiOpenDevRegKey)(hDevInfo, &amp;spdid, DICS_FLAG_GLOBAL, 0, DIREG_DRV, KEY_READ);
05360                 <span class="keywordflow">if</span> (hkDriver == <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>)
05361                 {
05362                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error opening s/w registry key for read access: %x\n"</span>), GetLastError()));
05363                     <span class="keywordflow">goto</span> EndOpenMonitor;
05364                 }
05365             }
05366 
05367             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05368         }
05369 
05370         i++;
05371     }
05372 
05373 EndOpenMonitor:
05374 
05375     <span class="keywordflow">if</span> (hkICM)
05376     {
05377         RegCloseKey(hkICM);
05378     }
05379 
05380     <span class="keywordflow">if</span> (hDevInfo != <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>)
05381     {
05382         (*fpSetupDiDestroyDeviceInfoList)(hDevInfo);
05383     }
05384 
05385     *phDevice = (HANDLE)hkDriver;
05386 
05387     <span class="keywordflow">return</span> rc;
05388 
05389 <span class="preprocessor">#else</span>
05390 <span class="preprocessor"></span>
05391     <span class="comment">//</span>
05392     <span class="comment">// For Windows NT (later than 5.0) platform</span>
05393     <span class="comment">//</span>
05394 
05395     TCHAR  szRegPath[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
05396     HKEY   hkDriver = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05397 
05398     <span class="comment">//</span>
05399     <span class="comment">// Copy device class root key.</span>
05400     <span class="comment">//</span>
05401 
05402     lstrcpy(szRegPath,<a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a6">gszDeviceClass</a>);
05403     lstrcat(szRegPath,<a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a5">gszMonitorGUID</a>);
05404 
05405     <span class="keywordflow">if</span> (!lstrcmpi(pDeviceName, <a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a17">gszDisplay</a>))
05406     {
05407         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"PnP support absent - Using DISPLAY\n"</span>)));
05408 
05409         <span class="comment">//</span>
05410         <span class="comment">// PnP support not in -  just open "0000" device.</span>
05411         <span class="comment">//</span>
05412 
05413         lstrcat(szRegPath,TEXT(<span class="stringliteral">"\\0000"</span>));
05414     }
05415     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (_tcsstr(pDeviceName,<a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a5">gszMonitorGUID</a>))
05416     {
05417         <span class="comment">//</span>
05418         <span class="comment">// Extract monitor number from DeviceName</span>
05419         <span class="comment">//</span>
05420 
05421         TCHAR *pDeviceNumber = _tcsrchr(pDeviceName,TEXT(<span class="charliteral">'\\'</span>));
05422 
05423         <span class="keywordflow">if</span> (pDeviceNumber)
05424         {
05425             lstrcat(szRegPath,pDeviceNumber);
05426         }
05427         <span class="keywordflow">else</span>
05428         {
05429             lstrcat(szRegPath,TEXT(<span class="stringliteral">"\\0000"</span>));
05430         }
05431     }
05432     <span class="keywordflow">else</span>
05433     {
05434         <span class="comment">//</span>
05435         <span class="comment">// This is not valid monitor name.</span>
05436         <span class="comment">//</span>
05437         <span class="keywordflow">goto</span> EndOpenMonitor;
05438     }
05439 
05440     <span class="comment">//</span>
05441     <span class="comment">// Open the registry path where monitor data is kept</span>
05442     <span class="comment">//</span>
05443 
05444     <span class="keywordflow">if</span> (RegOpenKey(HKEY_LOCAL_MACHINE, szRegPath, &amp;hkDriver) != ERROR_SUCCESS)
05445     {
05446         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Cannot open %s key\n"</span>),szRegPath));
05447         hkDriver = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05448     }
05449 
05450 EndOpenMonitor:
05451 
05452     *phDevice = (HANDLE) hkDriver;
05453 
05454     <span class="keywordflow">return</span> (hkDriver != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05455 
05456 <span class="preprocessor">#endif // _WIN95_</span>
05457 <span class="preprocessor"></span>}
05458 
05459 
05460 <span class="comment">/******************************************************************************</span>
05461 <span class="comment"> *</span>
05462 <span class="comment"> *                              CloseMonitor</span>
05463 <span class="comment"> *</span>
05464 <span class="comment"> *  Function:</span>
05465 <span class="comment"> *       This function closes the monitor handle opened by OpenMonitor</span>
05466 <span class="comment"> *</span>
05467 <span class="comment"> *  Arguments:</span>
05468 <span class="comment"> *       hDevice         - open handle</span>
05469 <span class="comment"> *</span>
05470 <span class="comment"> *  Returns:</span>
05471 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
05472 <span class="comment"> *</span>
05473 <span class="comment"> ******************************************************************************/</span>
05474 
05475 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI
<a name="l05476"></a><a class="code" href="../../d9/d7/profman_8c.html#a70">05476</a> <a class="code" href="../../d9/d7/profman_8c.html#a70">CloseMonitor</a>(
05477     HANDLE hDevice
05478     )
05479 {
05480     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwErr;
05481 
05482     dwErr = RegCloseKey((HKEY)hDevice);
05483     SetLastError(dwErr);
05484     <span class="keywordflow">return</span> (dwErr == ERROR_SUCCESS);
05485 }
05486 
05487 
05488 <span class="comment">/******************************************************************************</span>
05489 <span class="comment"> *</span>
05490 <span class="comment"> *                              GetMonitorData</span>
05491 <span class="comment"> *</span>
05492 <span class="comment"> *  Function:</span>
05493 <span class="comment"> *       This functions returns ICM data stored with the monitor instance</span>
05494 <span class="comment"> *</span>
05495 <span class="comment"> *  Arguments:</span>
05496 <span class="comment"> *       hDevice         - open monitor handle</span>
05497 <span class="comment"> *       pKey            - registry key for compatibility with GetPrinterDataEx</span>
05498 <span class="comment"> *       pName           - name of registry value</span>
05499 <span class="comment"> *       pdwType         - pointer to dword that receives type  of value</span>
05500 <span class="comment"> *       pData           - pointer to  buffer to receive data</span>
05501 <span class="comment"> *       dwSize          - size of buffer</span>
05502 <span class="comment"> *       pdwNeeded       - on return, this has size of buffer filled/needed</span>
05503 <span class="comment"> *</span>
05504 <span class="comment"> *  Returns:</span>
05505 <span class="comment"> *       ERROR_SUCCESS if successful, error code otherwise</span>
05506 <span class="comment"> *</span>
05507 <span class="comment"> ******************************************************************************/</span>
05508 
05509 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI
<a name="l05510"></a><a class="code" href="../../d9/d7/profman_8c.html#a71">05510</a> <a class="code" href="../../d9/d7/profman_8c.html#a71">GetMonitorData</a>(
05511     HANDLE hDevice,
05512     PTSTR  pKey,
05513     PTSTR  pName,
05514     PDWORD pdwType,
05515     PBYTE  pData,
05516     DWORD  dwSize,
05517     PDWORD pdwNeeded
05518     )
05519 {
05520     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwType, dwTemp;
05521     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    rc;
05522 
05523     *pdwNeeded = dwSize;
05524 
05525     rc = RegQueryValueEx((HKEY)hDevice, pName, 0, &amp;dwType, pData, pdwNeeded);
05526     <span class="keywordflow">if</span> (rc == ERROR_SUCCESS || rc == ERROR_MORE_DATA)
05527     {
05528         <span class="keywordflow">if</span> (dwType == REG_SZ)
05529         {
05530             PTSTR pFilename;
05531 
05532             <span class="comment">//</span>
05533             <span class="comment">// Old style value, convert to double null terminated binary</span>
05534             <span class="comment">//</span>
05535 
05536             <span class="keywordflow">if</span> (pData)
05537             {
05538                 pFilename = <a class="code" href="../../d9/d7/profman_8c.html#a96">GetFilenameFromPath</a>((PTSTR)pData);
05539                 <span class="keywordflow">if</span> (pFilename != (PTSTR)pData)
05540                 {
05541                     lstrcpy((PTSTR)pData, pFilename);
05542                 }
05543                 *pdwNeeded = lstrlen((PTSTR)pData) * <span class="keyword">sizeof</span>(TCHAR);
05544             }
05545 
05546             *pdwNeeded += <span class="keyword">sizeof</span>(TCHAR);    <span class="comment">// for double NULL termination</span>
05547 
05548             <span class="keywordflow">if</span> ((dwSize &gt;= *pdwNeeded) &amp;&amp; pData)
05549             {
05550                 *((PTSTR)pData + lstrlen((PTSTR)pData) + 1) = <span class="charliteral">'\0'</span>;
05551 
05552                 <span class="comment">//</span>
05553                 <span class="comment">// Set the profile name in new format</span>
05554                 <span class="comment">//</span>
05555 
05556                 RegSetValueEx((HKEY)hDevice, pName, 0, REG_BINARY, pData, (lstrlen((PTSTR)pData)+2)*<span class="keyword">sizeof</span>(TCHAR));
05557             }
05558         }
05559         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*pdwNeeded == 1)
05560         {
05561             <span class="comment">//</span>
05562             <span class="comment">// If we have picked up the data and it is a 1 byte non-zero</span>
05563             <span class="comment">// value, it is an 1 based index in a list of</span>
05564             <span class="comment">// predefined profiles. Deal with this case.</span>
05565             <span class="comment">//</span>
05566             <span class="comment">// If pData is NULL, then we don't know if it is non-zero or</span>
05567             <span class="comment">// not, so we assume it is and ask for a large enough buffer.</span>
05568             <span class="comment">//</span>
05569 
05570             <span class="keywordflow">if</span> (!pData || *pData != 0)
05571             {
05572                 <span class="comment">//</span>
05573                 <span class="comment">// Old style 1-based index value</span>
05574                 <span class="comment">//</span>
05575 
05576                 <span class="keywordflow">if</span> ((dwSize &gt;= <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>) &amp;&amp; pData)
05577                 {
05578                     HKEY     hkICM = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05579                     HKEY     hkDevice = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05580                     <a class="code" href="../../d2/d5/structtagREGDATA.html">REGDATA</a>  regData;
05581 
05582                     <span class="comment">//</span>
05583                     <span class="comment">// Make sure buggy inf doesn't crash us</span>
05584                     <span class="comment">//</span>
05585 
05586                     <span class="keywordflow">if</span> (pData[0] &gt; <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/profman_8c.html#a38">gszDispProfiles</a>)/<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/profman_8c.html#a38">gszDispProfiles</a>[0]))
05587                     {
05588                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Predefined profile index too large: %d\n"</span>), pData[0]));
05589                         <span class="keywordflow">goto</span> EndCompatMode;
05590                     }
05591 
05592                     lstrcpy((PTSTR)pData, <a class="code" href="../../d9/d7/profman_8c.html#a38">gszDispProfiles</a>[pData[0] - 1]);
05593                     *((PTSTR)pData + lstrlen((PTSTR)pData) + 1) = <span class="charliteral">'\0'</span>;
05594 
05595                     <span class="comment">//</span>
05596                     <span class="comment">// We need to update reference count as it wasn't set up</span>
05597                     <span class="comment">// using the new API</span>
05598                     <span class="comment">//</span>
05599                     <span class="comment">// Open the registry path where profiles are kept</span>
05600                     <span class="comment">//</span>
05601 
05602                     <span class="keywordflow">if</span> ((RegCreateKey(HKEY_LOCAL_MACHINE, <a class="code" href="../../d4/d9/icmupg_8c.html#a8">gszICMRegPath</a>, &amp;hkICM) != ERROR_SUCCESS) ||
05603                         (RegCreateKey(hkICM, __TEXT(<span class="stringliteral">"mntr"</span>), &amp;hkDevice) != ERROR_SUCCESS))
05604                     {
05605                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Cannot open ICM\\device branch of registry\n"</span>)));
05606                         <span class="keywordflow">goto</span> EndCompatMode;
05607                     }
05608 
05609                     <span class="comment">//</span>
05610                     <span class="comment">// If registry data exists, then the profile is already installed,</span>
05611                     <span class="comment">// in which case, increment use count, otherwise add entry</span>
05612                     <span class="comment">//</span>
05613 
05614                     dwTemp = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/structtagREGDATA.html">REGDATA</a>);
05615                     <span class="keywordflow">if</span> (RegQueryValueEx(hkDevice, (PTSTR)pData, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;regData,
05616                             &amp;dwTemp) == ERROR_SUCCESS)
05617                     {
05618                         regData.dwRefCount++;
05619                     }
05620                     <span class="keywordflow">else</span>
05621                     {
05622                         regData.dwRefCount = 1;
05623                         regData.dwManuID = 'enon';  <span class="comment">// it is our profile</span>
05624                         regData.dwModelID = 'enon';
05625                     }
05626 
05627                     <span class="keywordflow">if</span> (RegSetValueEx(hkDevice, (PTSTR)pData, 0, REG_BINARY,
05628                             (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;regData, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/structtagREGDATA.html">REGDATA</a>)) != ERROR_SUCCESS)
05629                     {
05630                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error setting registry value\n"</span>)));
05631                         <span class="keywordflow">goto</span> EndCompatMode;
05632                     }
05633 
05634                     <span class="comment">//</span>
05635                     <span class="comment">// Set the profile name in new format</span>
05636                     <span class="comment">//</span>
05637 
05638                     RegSetValueEx((HKEY)hDevice, pName, 0, REG_BINARY, pData,
05639                                   (lstrlen((PTSTR)pData) + 2)*<span class="keyword">sizeof</span>(TCHAR));
05640 
05641                 EndCompatMode:
05642                     <span class="keywordflow">if</span> (hkICM)
05643                     {
05644                         RegCloseKey(hkICM);
05645                     }
05646                     <span class="keywordflow">if</span> (hkDevice)
05647                     {
05648                         RegCloseKey(hkDevice);
05649                     }
05650                 }
05651                 *pdwNeeded = <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>;
05652             }
05653         }
05654     }
05655 
05656     <span class="keywordflow">if</span> ((rc == ERROR_SUCCESS) &amp;&amp; (*pdwNeeded &gt; dwSize))
05657     {
05658         rc = ERROR_MORE_DATA;
05659     }
05660 
05661     <span class="keywordflow">return</span> rc;
05662 }
05663 
05664 
05665 <span class="comment">/******************************************************************************</span>
05666 <span class="comment"> *</span>
05667 <span class="comment"> *                              SetMonitorData</span>
05668 <span class="comment"> *</span>
05669 <span class="comment"> *  Function:</span>
05670 <span class="comment"> *       This functions stores ICM data with the monitor instance</span>
05671 <span class="comment"> *</span>
05672 <span class="comment"> *  Arguments:</span>
05673 <span class="comment"> *       hDevice         - open monitor handle</span>
05674 <span class="comment"> *       pKey            - registry key for compatibility with SetPrinterDataEx</span>
05675 <span class="comment"> *       pName           - name of registry value</span>
05676 <span class="comment"> *       dwType          - type  of value</span>
05677 <span class="comment"> *       pData           - pointer to  data buffer</span>
05678 <span class="comment"> *       dwSize          - size of buffer</span>
05679 <span class="comment"> *</span>
05680 <span class="comment"> *  Returns:</span>
05681 <span class="comment"> *       ERROR_SUCCESS if successful, error code otherwise</span>
05682 <span class="comment"> *</span>
05683 <span class="comment"> ******************************************************************************/</span>
05684 
05685 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI
<a name="l05686"></a><a class="code" href="../../d9/d7/profman_8c.html#a72">05686</a> <a class="code" href="../../d8/d8/fullscr_8c.html#a15">SetMonitorData</a>(
05687     HANDLE hDevice,
05688     PTSTR  pKey,
05689     PTSTR  pName,
05690     DWORD  dwType,
05691     PBYTE  pData,
05692     DWORD  dwSize
05693     )
05694 {
05695     <span class="keywordflow">return</span> RegSetValueEx((HKEY)hDevice, pName, 0, dwType, pData, dwSize);
05696 }
05697 
05698 
05699 <span class="comment">/******************************************************************************</span>
05700 <span class="comment"> *</span>
05701 <span class="comment"> *                              OpenScanner</span>
05702 <span class="comment"> *</span>
05703 <span class="comment"> *  Function:</span>
05704 <span class="comment"> *       This function returns a handle to the scanner</span>
05705 <span class="comment"> *</span>
05706 <span class="comment"> *  Arguments:</span>
05707 <span class="comment"> *       pDeviceName     - pointer to name of the device</span>
05708 <span class="comment"> *       phDevice        - pointer that receives the handle.</span>
05709 <span class="comment"> *       pDummy          - dummy parameter</span>
05710 <span class="comment"> *</span>
05711 <span class="comment"> *  Returns:</span>
05712 <span class="comment"> *       TRUE</span>
05713 <span class="comment"> *</span>
05714 <span class="comment"> ******************************************************************************/</span>
05715 
05716 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI
<a name="l05717"></a><a class="code" href="../../d9/d7/profman_8c.html#a73">05717</a> <a class="code" href="../../d9/d7/profman_8c.html#a73">OpenScanner</a>(
05718     PTSTR    pDeviceName,
05719     LPHANDLE phDevice,
05720     PTSTR    pDummy
05721     )
05722 {
05723     <a class="code" href="../../d2/d7/profile_8cpp.html#a0">PFNSTICREATEINSTANCE</a> pStiCreateInstance;
05724     <a class="code" href="../../d9/d7/profman_8c.html#a21">PSCANNERDATA</a>         psd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05725     HRESULT              hres;
05726     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>                 bRc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05727 
05728     <span class="keywordflow">if</span> (!(psd = (<a class="code" href="../../d9/d7/profman_8c.html#a21">PSCANNERDATA</a>)<a class="code" href="../../d2/d1/object_8c.html#a7">MemAlloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d5/structtagSCANNERDATA.html">SCANNERDATA</a>))))
05729     {
05730         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error allocating memory for scanner data\n"</span>)));
05731         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05732     }
05733 
05734     <span class="keywordflow">if</span> (!(psd-&gt;<a class="code" href="../../d8/d5/structtagSCANNERDATA.html#o0">pDeviceName</a> = <a class="code" href="../../d2/d1/object_8c.html#a7">MemAlloc</a>((lstrlen(pDeviceName) + 1) * <span class="keyword">sizeof</span>(WCHAR))))
05735     {
05736         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error allocating memory for scanner name\n"</span>)));
05737         <span class="keywordflow">goto</span> EndOpenScanner;
05738     }
05739 
05740 <span class="preprocessor">    #ifdef UNICODE</span>
05741 <span class="preprocessor"></span>    lstrcpy(psd-&gt;<a class="code" href="../../d8/d5/structtagSCANNERDATA.html#o0">pDeviceName</a>, pDeviceName);
05742 <span class="preprocessor">    #else</span>
05743 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (! <a class="code" href="../../d2/d1/object_8c.html#a11">ConvertToUnicode</a>(pDeviceName, &amp;psd-&gt;<a class="code" href="../../d8/d5/structtagSCANNERDATA.html#o0">pDeviceName</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>))
05744     {
05745         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error converting scanner name to Unicode\n"</span>)));
05746         <span class="keywordflow">goto</span> EndOpenScanner;
05747     }
05748 <span class="preprocessor">    #endif</span>
05749 <span class="preprocessor"></span>
05750     <span class="keywordflow">if</span> (!(psd-&gt;<a class="code" href="../../d8/d5/structtagSCANNERDATA.html#o1">hModule</a> = LoadLibrary(<a class="code" href="../../d2/d7/profile_8cpp.html#a1">gszStiDll</a>)))
05751     {
05752         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error loading sti.dll: %d\n"</span>), GetLastError()));
05753         <span class="keywordflow">goto</span> EndOpenScanner;
05754     }
05755 
05756     <span class="keywordflow">if</span> (!(pStiCreateInstance = (<a class="code" href="../../d2/d7/profile_8cpp.html#a0">PFNSTICREATEINSTANCE</a>)GetProcAddress(psd-&gt;<a class="code" href="../../d8/d5/structtagSCANNERDATA.html#o1">hModule</a>, <a class="code" href="../../d2/d7/profile_8cpp.html#a2">gszStiCreateInstance</a>)))
05757     {
05758         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error getting proc StiCreateInstance\n"</span>)));
05759         <span class="keywordflow">goto</span> EndOpenScanner;
05760     }
05761 
05762     hres = (*pStiCreateInstance)(GetModuleHandle(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>), <a class="code" href="../../d4/d6/sti_8h.html#a2">STI_VERSION</a>, &amp;psd-&gt;<a class="code" href="../../d8/d5/structtagSCANNERDATA.html#o2">pSti</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05763 
05764     <span class="keywordflow">if</span> (FAILED(hres))
05765     {
05766         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error creating sti instance: %d\n"</span>), hres));
05767         <span class="keywordflow">goto</span> EndOpenScanner;
05768     }
05769 
05770     *phDevice = (HANDLE)psd;
05771 
05772     bRc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05773 
05774 EndOpenScanner:
05775 
05776     <span class="keywordflow">if</span> (!bRc &amp;&amp; psd)
05777     {
05778         <a class="code" href="../../d9/d7/profman_8c.html#a74">CloseScanner</a>((HANDLE)psd);
05779     }
05780 
05781     <span class="keywordflow">return</span> bRc;
05782 }
05783 
05784 
05785 <span class="comment">/******************************************************************************</span>
05786 <span class="comment"> *</span>
05787 <span class="comment"> *                              CloseScanner</span>
05788 <span class="comment"> *</span>
05789 <span class="comment"> *  Function:</span>
05790 <span class="comment"> *       This function closes the monitor handle opened by OpenMonitor</span>
05791 <span class="comment"> *</span>
05792 <span class="comment"> *  Arguments:</span>
05793 <span class="comment"> *       hDevice        - handle of device</span>
05794 <span class="comment"> *</span>
05795 <span class="comment"> *  Returns:</span>
05796 <span class="comment"> *       TRUE</span>
05797 <span class="comment"> *</span>
05798 <span class="comment"> ******************************************************************************/</span>
05799 
05800 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI
<a name="l05801"></a><a class="code" href="../../d9/d7/profman_8c.html#a74">05801</a> <a class="code" href="../../d9/d7/profman_8c.html#a74">CloseScanner</a>(
05802     HANDLE hDevice
05803     )
05804 {
05805     <a class="code" href="../../d9/d7/profman_8c.html#a21">PSCANNERDATA</a> psd = (<a class="code" href="../../d9/d7/profman_8c.html#a21">PSCANNERDATA</a>)hDevice;
05806 
05807     <span class="keywordflow">if</span> (psd)
05808     {
05809         <span class="keywordflow">if</span> (psd-&gt;<a class="code" href="../../d8/d5/structtagSCANNERDATA.html#o2">pSti</a>)
05810         {
05811             psd-&gt;<a class="code" href="../../d8/d5/structtagSCANNERDATA.html#o2">pSti</a>-&gt;lpVtbl-&gt;Release(psd-&gt;<a class="code" href="../../d8/d5/structtagSCANNERDATA.html#o2">pSti</a>);
05812         }
05813 
05814         <span class="keywordflow">if</span> (psd-&gt;<a class="code" href="../../d8/d5/structtagSCANNERDATA.html#o0">pDeviceName</a>)
05815         {
05816             <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(psd-&gt;<a class="code" href="../../d8/d5/structtagSCANNERDATA.html#o0">pDeviceName</a>);
05817         }
05818 
05819         <span class="keywordflow">if</span> (psd-&gt;<a class="code" href="../../d8/d5/structtagSCANNERDATA.html#o1">hModule</a>)
05820         {
05821             FreeLibrary(psd-&gt;<a class="code" href="../../d8/d5/structtagSCANNERDATA.html#o1">hModule</a>);
05822         }
05823 
05824         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(psd);
05825     }
05826 
05827     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05828 }
05829 
05830 
05831 <span class="comment">/******************************************************************************</span>
05832 <span class="comment"> *</span>
05833 <span class="comment"> *                              GetScannerData</span>
05834 <span class="comment"> *</span>
05835 <span class="comment"> *  Function:</span>
05836 <span class="comment"> *       This functions returns ICM data stored with the scannerr instance</span>
05837 <span class="comment"> *</span>
05838 <span class="comment"> *  Arguments:</span>
05839 <span class="comment"> *       hDevice         - open scanner handle</span>
05840 <span class="comment"> *       pKey            - registry key for compatibility with GetPrinterDataEx</span>
05841 <span class="comment"> *       pName           - name of registry value</span>
05842 <span class="comment"> *       pdwType         - pointer to dword that receives type  of value</span>
05843 <span class="comment"> *       pData           - pointer to  buffer to receive data</span>
05844 <span class="comment"> *       dwSize          - size of buffer</span>
05845 <span class="comment"> *       pdwNeeded       - on return, this has size of buffer filled/needed</span>
05846 <span class="comment"> *</span>
05847 <span class="comment"> *  Returns:</span>
05848 <span class="comment"> *       ERROR_SUCCESS if successful, error code otherwise</span>
05849 <span class="comment"> *</span>
05850 <span class="comment"> ******************************************************************************/</span>
05851 
05852 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI
<a name="l05853"></a><a class="code" href="../../d9/d7/profman_8c.html#a75">05853</a> <a class="code" href="../../d9/d7/profman_8c.html#a75">GetScannerData</a>(
05854     HANDLE hDevice,
05855     PTSTR  pKey,
05856     PTSTR  pName,
05857     PDWORD pdwType,
05858     PBYTE  pData,
05859     DWORD  dwSize,
05860     PDWORD pdwNeeded
05861     )
05862 {
05863     <a class="code" href="../../d9/d7/profman_8c.html#a21">PSCANNERDATA</a> psd = (<a class="code" href="../../d9/d7/profman_8c.html#a21">PSCANNERDATA</a>)hDevice;
05864     HRESULT      hres;
05865 <span class="preprocessor">#ifndef UNICODE</span>
05866 <span class="preprocessor"></span>    PWSTR        pwszName;
05867 
05868     <span class="comment">//</span>
05869     <span class="comment">// STI interface "ALWAYS" expects Unicode.</span>
05870     <span class="comment">//</span>
05871     hres = <a class="code" href="../../d2/d1/object_8c.html#a11">ConvertToUnicode</a>(pName, &amp;pwszName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
05872 
05873     <span class="keywordflow">if</span> (!hres)
05874     {
05875         <span class="keywordflow">return</span> (ERROR_INVALID_PARAMETER);
05876     }
05877 
05878     pName = (PSTR)pwszName;
05879 
05880 <span class="preprocessor">#endif</span>
05881 <span class="preprocessor"></span>
05882     *pdwNeeded = dwSize;
05883 
05884     hres = psd-&gt;<a class="code" href="../../d8/d5/structtagSCANNERDATA.html#o2">pSti</a>-&gt;lpVtbl-&gt;GetDeviceValue(psd-&gt;<a class="code" href="../../d8/d5/structtagSCANNERDATA.html#o2">pSti</a>, psd-&gt;<a class="code" href="../../d8/d5/structtagSCANNERDATA.html#o0">pDeviceName</a>, (PWSTR)pName, pdwType, pData, pdwNeeded);
05885 
05886 <span class="preprocessor">#ifndef UNICODE</span>
05887 <span class="preprocessor"></span>
05888     <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pwszName);
05889 
05890 <span class="preprocessor">#endif</span>
05891 <span class="preprocessor"></span>
05892     <span class="keywordflow">return</span> hres;
05893 }
05894 
05895 
05896 <span class="comment">/******************************************************************************</span>
05897 <span class="comment"> *</span>
05898 <span class="comment"> *                              SetScannerData</span>
05899 <span class="comment"> *</span>
05900 <span class="comment"> *  Function:</span>
05901 <span class="comment"> *       This functions stores ICM data with the scanner instance</span>
05902 <span class="comment"> *</span>
05903 <span class="comment"> *  Arguments:</span>
05904 <span class="comment"> *       hDevice         - open scanner handle</span>
05905 <span class="comment"> *       pKey            - registry key for compatibility with SetPrinterDataEx</span>
05906 <span class="comment"> *       pName           - name of registry value</span>
05907 <span class="comment"> *       dwType          - type  of value</span>
05908 <span class="comment"> *       pData           - pointer to  data buffer</span>
05909 <span class="comment"> *       dwSize          - size of buffer</span>
05910 <span class="comment"> *</span>
05911 <span class="comment"> *  Returns:</span>
05912 <span class="comment"> *       ERROR_SUCCESS if successful, error code otherwise</span>
05913 <span class="comment"> *</span>
05914 <span class="comment"> ******************************************************************************/</span>
05915 
05916 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI
<a name="l05917"></a><a class="code" href="../../d9/d7/profman_8c.html#a76">05917</a> <a class="code" href="../../d9/d7/profman_8c.html#a76">SetScannerData</a>(
05918     HANDLE hDevice,
05919     PTSTR  pKey,
05920     PTSTR  pName,
05921     DWORD  dwType,
05922     PBYTE  pData,
05923     DWORD  dwSize
05924     )
05925 {
05926     <a class="code" href="../../d9/d7/profman_8c.html#a21">PSCANNERDATA</a> psd = (<a class="code" href="../../d9/d7/profman_8c.html#a21">PSCANNERDATA</a>)hDevice;
05927     HRESULT      hres;
05928 <span class="preprocessor">#ifndef UNICODE</span>
05929 <span class="preprocessor"></span>    PWSTR        pwszName;
05930 
05931     <span class="comment">//</span>
05932     <span class="comment">// STI interface "ALWAYS" expects Unicode.</span>
05933     <span class="comment">//</span>
05934     hres = <a class="code" href="../../d2/d1/object_8c.html#a11">ConvertToUnicode</a>(pName, &amp;pwszName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
05935 
05936     <span class="keywordflow">if</span> (!hres)
05937     {
05938         <span class="keywordflow">return</span> (ERROR_INVALID_PARAMETER);
05939     }
05940 
05941     pName = (PSTR)pwszName;
05942 
05943 <span class="preprocessor">#endif</span>
05944 <span class="preprocessor"></span>
05945     hres = psd-&gt;<a class="code" href="../../d8/d5/structtagSCANNERDATA.html#o2">pSti</a>-&gt;lpVtbl-&gt;SetDeviceValue(psd-&gt;<a class="code" href="../../d8/d5/structtagSCANNERDATA.html#o2">pSti</a>, psd-&gt;<a class="code" href="../../d8/d5/structtagSCANNERDATA.html#o0">pDeviceName</a>, (PWSTR)pName, dwType, pData, dwSize);
05946 
05947 <span class="preprocessor">#ifndef UNICODE</span>
05948 <span class="preprocessor"></span>
05949     <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pwszName);
05950 
05951 <span class="preprocessor">#endif</span>
05952 <span class="preprocessor"></span>
05953     <span class="keywordflow">return</span> hres;
05954 }
05955 
05956 <span class="comment">//</span>
05957 <span class="comment">// Internal functions</span>
05958 <span class="comment">//</span>
05959 
05960 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI
<a name="l05961"></a><a class="code" href="../../d9/d7/profman_8c.html#a97">05961</a> <a class="code" href="../../d9/d7/profman_8c.html#a97">InternalGetDeviceConfig</a>(
05962     LPCTSTR pDeviceName,
05963     DWORD   dwDeviceClass,
05964     DWORD   dwConfigType,
05965     PVOID   pConfigData,
05966     PDWORD  pdwSize
05967     )
05968 {
05969     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwDataType;
05970     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwSizeRequired = 0;
05971     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05972 
05973     <span class="keywordflow">switch</span> (dwConfigType)
05974     {
05975     <span class="keywordflow">case</span> MSCMS_PROFILE_ENUM_MODE:
05976 
05977         dwDataType = <a class="code" href="../../d9/d7/profman_8c.html#a9">DEVICE_PROFILE_ENUMMODE</a>;
05978         <span class="keywordflow">break</span>;
05979 
05980     <span class="keywordflow">default</span>:
05981 
05982         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to InternalGetDeviceConfig\n"</span>)));
05983         SetLastError(ERROR_INVALID_PARAMETER);
05984         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05985     }
05986 
05987     <span class="comment">//</span>
05988     <span class="comment">// Query the size of the data.</span>
05989     <span class="comment">//</span>
05990 
05991     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d7/profman_8c.html#a54">GetDeviceData</a>(pDeviceName,dwDeviceClass,dwDataType,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,&amp;dwSizeRequired,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>))
05992     {
05993         <span class="keywordflow">if</span> ((dwSizeRequired &lt;= *pdwSize) &amp;&amp; (pConfigData != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))
05994         {
05995             <span class="comment">//</span>
05996             <span class="comment">// If buffer is enough, get the data.</span>
05997             <span class="comment">//</span>
05998 
05999             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d7/profman_8c.html#a54">GetDeviceData</a>(pDeviceName,dwDeviceClass,dwDataType,
06000                               (PVOID *)&amp;pConfigData,pdwSize,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>))
06001             {
06002                 rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06003             }
06004             <span class="keywordflow">else</span>
06005             {
06006                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Failed on GetDeviceData to query data\n"</span>)));
06007                 SetLastError(ERROR_INVALID_PARAMETER);
06008             }
06009         }
06010         <span class="keywordflow">else</span>
06011         {
06012             <span class="comment">//</span>
06013             <span class="comment">// Return nessesary buffer size to caller.</span>
06014             <span class="comment">//</span>
06015 
06016             *pdwSize = dwSizeRequired;
06017             SetLastError(ERROR_INSUFFICIENT_BUFFER);
06018         }
06019     }
06020     <span class="keywordflow">else</span>
06021     {
06022         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Failed on GetDeviceData to query data size\n"</span>)));
06023         SetLastError(ERROR_INVALID_PARAMETER);
06024     }
06025 
06026     <span class="keywordflow">return</span> rc;
06027 }
06028 
06029 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI
<a name="l06030"></a><a class="code" href="../../d9/d7/profman_8c.html#a98">06030</a> <a class="code" href="../../d9/d7/profman_8c.html#a98">InternalSetDeviceConfig</a>(
06031     LPCTSTR pDeviceName,
06032     DWORD   dwDeviceClass,
06033     DWORD   dwConfigType,
06034     PVOID   pConfigData,
06035     DWORD   dwSize
06036     )
06037 {
06038     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwDataType;
06039 
06040     <span class="keywordflow">switch</span> (dwConfigType)
06041     {
06042     <span class="keywordflow">case</span> MSCMS_PROFILE_ENUM_MODE:
06043 
06044         dwDataType = <a class="code" href="../../d9/d7/profman_8c.html#a9">DEVICE_PROFILE_ENUMMODE</a>;
06045         <span class="keywordflow">break</span>;
06046 
06047     <span class="keywordflow">default</span>:
06048 
06049         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to InternalGetDeviceConfig\n"</span>)));
06050         SetLastError(ERROR_INVALID_PARAMETER);
06051         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06052     }
06053 
06054     <span class="comment">//</span>
06055     <span class="comment">// Save the data.</span>
06056     <span class="comment">//</span>
06057 
06058     <span class="keywordflow">return</span> (<a class="code" href="../../d9/d7/profman_8c.html#a55">SetDeviceData</a>(pDeviceName,dwDeviceClass,dwDataType,pConfigData,dwSize));
06059 }
06060 
06061 <span class="preprocessor">#ifdef _WIN95_</span>
06062 <span class="preprocessor"></span>
06063 <span class="comment">//</span>
06064 <span class="comment">// Win9x specific functions are here.</span>
06065 <span class="comment">//</span>
06066 
06067 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
06068 LoadSetupAPIDll(
06069     VOID
06070     )
06071 {
06072     EnterCriticalSection(&amp;critsec);
06073 
06074     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d7/profman_8c.html#a32">ghModSetupAPIDll</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
06075     {
06076         <a class="code" href="../../d9/d7/profman_8c.html#a32">ghModSetupAPIDll</a> = LoadLibrary(TEXT(<span class="stringliteral">"setupapi.dll"</span>));
06077 
06078         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d7/profman_8c.html#a32">ghModSetupAPIDll</a>)
06079         {
06080             <a class="code" href="../../d9/d7/profman_8c.html#a33">fpSetupDiOpenDevRegKey</a> = (<a class="code" href="../../d9/d7/profman_8c.html#a27">FP_SetupDiOpenDevRegKey</a>)
06081                 GetProcAddress(ghModSetupAPIDll,<span class="stringliteral">"SetupDiOpenDevRegKey"</span>);
06082             <a class="code" href="../../d9/d7/profman_8c.html#a34">fpSetupDiDestroyDeviceInfoList</a> = (<a class="code" href="../../d9/d7/profman_8c.html#a28">FP_SetupDiDestroyDeviceInfoList</a>)
06083                 GetProcAddress(ghModSetupAPIDll,<span class="stringliteral">"SetupDiDestroyDeviceInfoList"</span>);
06084             <a class="code" href="../../d9/d7/profman_8c.html#a35">fpSetupDiEnumDeviceInfo</a> = (<a class="code" href="../../d9/d7/profman_8c.html#a29">FP_SetupDiEnumDeviceInfo</a>)
06085                 GetProcAddress(ghModSetupAPIDll,<span class="stringliteral">"SetupDiEnumDeviceInfo"</span>);
06086             <a class="code" href="../../d9/d7/profman_8c.html#a36">fpSetupDiGetDeviceInstanceId</a> = (<a class="code" href="../../d9/d7/profman_8c.html#a30">FP_SetupDiGetDeviceInstanceId</a>)
06087                 GetProcAddress(ghModSetupAPIDll,<span class="stringliteral">"SetupDiGetDeviceInstanceIdA"</span>);
06088             <a class="code" href="../../d9/d7/profman_8c.html#a37">fpSetupDiGetClassDevs</a> = (<a class="code" href="../../d9/d7/profman_8c.html#a31">FP_SetupDiGetClassDevs</a>)
06089                 GetProcAddress(ghModSetupAPIDll,<span class="stringliteral">"SetupDiGetClassDevsA"</span>);
06090 
06091             <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d7/profman_8c.html#a33">fpSetupDiOpenDevRegKey</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
06092                 (<a class="code" href="../../d9/d7/profman_8c.html#a34">fpSetupDiDestroyDeviceInfoList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
06093                 (<a class="code" href="../../d9/d7/profman_8c.html#a35">fpSetupDiEnumDeviceInfo</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
06094                 (<a class="code" href="../../d9/d7/profman_8c.html#a36">fpSetupDiGetDeviceInstanceId</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
06095                 (<a class="code" href="../../d9/d7/profman_8c.html#a37">fpSetupDiGetClassDevs</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))
06096             {
06097                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Could not find Export function in setupapi.dll\n"</span>)));
06098 
06099                 FreeLibrary(ghModSetupAPIDll);
06100                 <a class="code" href="../../d9/d7/profman_8c.html#a32">ghModSetupAPIDll</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06101             }
06102         }
06103     }
06104 
06105     LeaveCriticalSection(&amp;critsec);
06106 
06107     <span class="keywordflow">return</span> (!!<a class="code" href="../../d9/d7/profman_8c.html#a32">ghModSetupAPIDll</a>);
06108 }
06109 
06110 <span class="preprocessor">#else</span>
06111 <span class="preprocessor"></span>
06112 <span class="comment">//</span>
06113 <span class="comment">// Win NT specific functions are here.</span>
06114 <span class="comment">//</span>
06115 
06116 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l06117"></a><a class="code" href="../../d9/d7/profman_8c.html#a77">06117</a> <a class="code" href="../../d9/d7/profman_8c.html#a77">ChangeICMSetting</a>(
06118     LPCTSTR pMachineName,
06119     LPCTSTR pDeviceName,
06120     DWORD   dwICMMode
06121     )
06122 {
06123     PRINTER_INFO_8   *ppi8;
06124     PRINTER_INFO_9   *ppi9;
06125     PRINTER_DEFAULTS <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>;
06126     HANDLE           hPrinter;
06127     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>            dwSize;
06128     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>             temp[2*1024];    <span class="comment">// sufficient for devmode</span>
06129 
06130     <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>.pDatatype = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06131     <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>.pDevMode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06132     <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>.DesiredAccess = PRINTER_ALL_ACCESS;
06133 
06134     <span class="keywordflow">if</span> (!OpenPrinter((PTSTR)pDeviceName, &amp;hPrinter, &amp;<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>))
06135         <span class="keywordflow">return</span>;
06136 
06137     <span class="comment">//</span>
06138     <span class="comment">// Get and update system devmode</span>
06139     <span class="comment">//</span>
06140 
06141     ppi8 = (PRINTER_INFO_8 *)&amp;temp;
06142     <span class="keywordflow">if</span> (GetPrinter(hPrinter, 8, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ppi8, <span class="keyword">sizeof</span>(temp), &amp;dwSize) &amp;&amp;
06143         ppi8-&gt;pDevMode)
06144     {
06145         <span class="keywordflow">switch</span> (dwICMMode)
06146         {
06147         <span class="keywordflow">case</span> ICM_ON:
06148         <span class="keywordflow">case</span> ICM_OFF:
06149             ppi8-&gt;pDevMode-&gt;dmFields |= DM_ICMMETHOD;
06150             <span class="keywordflow">if</span> (dwICMMode == ICM_ON)
06151                 ppi8-&gt;pDevMode-&gt;dmICMMethod = DMICMMETHOD_SYSTEM;
06152             <span class="keywordflow">else</span>
06153                 ppi8-&gt;pDevMode-&gt;dmICMMethod = DMICMMETHOD_NONE;
06154             SetPrinter(hPrinter, 8, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ppi8, 0);
06155             <span class="keywordflow">break</span>;
06156         }
06157     }
06158 
06159     <span class="comment">//</span>
06160     <span class="comment">// If the user has a per-user devmode, update this as well</span>
06161     <span class="comment">//</span>
06162 
06163     ppi9 = (PRINTER_INFO_9 *)&amp;temp;
06164     <span class="keywordflow">if</span> (GetPrinter(hPrinter, 9, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ppi9, <span class="keyword">sizeof</span>(temp), &amp;dwSize) &amp;&amp;
06165         ppi9-&gt;pDevMode)
06166     {
06167         <span class="keywordflow">switch</span> (dwICMMode)
06168         {
06169         <span class="keywordflow">case</span> ICM_ON:
06170         <span class="keywordflow">case</span> ICM_OFF:
06171             ppi9-&gt;pDevMode-&gt;dmFields |= DM_ICMMETHOD;
06172             <span class="keywordflow">if</span> (dwICMMode == ICM_ON)
06173                 ppi9-&gt;pDevMode-&gt;dmICMMethod = DMICMMETHOD_SYSTEM;
06174             <span class="keywordflow">else</span>
06175                 ppi9-&gt;pDevMode-&gt;dmICMMethod = DMICMMETHOD_NONE;
06176             SetPrinter(hPrinter, 9, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ppi9, 0);
06177             <span class="keywordflow">break</span>;
06178         }
06179     }
06180 
06181     ClosePrinter(hPrinter);
06182 
06183     <span class="keywordflow">return</span>;
06184 }
06185 
06186 <span class="preprocessor">#endif // _WIN95_</span>
06187 <span class="preprocessor"></span>
06188 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:30 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
