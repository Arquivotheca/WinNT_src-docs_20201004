<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: dev2dos.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>dev2dos.c File Reference</h1><code>#include &lt;<a class="el" href="../../d6/d8/ntrtlp_8h-source.html">ntrtlp.h</a>&gt;</code><br>
<code>#include &lt;mountdev.h&gt;</code><br>

<p>
<a href="../../d1/d6/dev2dos_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d4/struct__DEVICE__NAME__ENTRY.html">_DEVICE_NAME_ENTRY</a></td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d3/d4/struct__DEVICE__NAME__ENTRY.html">_DEVICE_NAME_ENTRY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/dev2dos_8c.html#a0">DEVICE_NAME_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d3/d4/struct__DEVICE__NAME__ENTRY.html">_DEVICE_NAME_ENTRY</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/dev2dos_8c.html#a1">PDEVICE_NAME_ENTRY</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/dev2dos_8c.html#a2">QuerySymbolicLink</a> (IN PUNICODE_STRING SymbolicLinkName, OUT PUNICODE_STRING LinkTarget)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/dev2dos_8c.html#a3">QueryDeviceNameForPath</a> (IN PUNICODE_STRING Path, OUT PUNICODE_STRING DeviceName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/dev2dos_8c.html#a4">OpenDeviceReparseIndex</a> (IN PUNICODE_STRING DeviceName, OUT PHANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/dev2dos_8c.html#a5">IsVolumeName</a> (IN PUNICODE_STRING <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/dev2dos_8c.html#a6">GetNextReparseVolumePath</a> (IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, OUT PUNICODE_STRING Path)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/dev2dos_8c.html#a7">FindPathForDevice</a> (IN PUNICODE_STRING StartingPath, IN PUNICODE_STRING DeviceName, IN OUT PLIST_ENTRY DevicesInPath, OUT PUNICODE_STRING FinalPath)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/dev2dos_8c.html#a8">RtlVolumeDeviceToDosName</a> (IN PVOID VolumeDeviceObject, OUT PUNICODE_STRING DosName)</td></tr>

</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a0" doxytag="dev2dos.c::DEVICE_NAME_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d3/d4/struct__DEVICE__NAME__ENTRY.html">_DEVICE_NAME_ENTRY</a>  <a class="el" href="../../d3/d4/struct__DEVICE__NAME__ENTRY.html">DEVICE_NAME_ENTRY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="dev2dos.c::PDEVICE_NAME_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d3/d4/struct__DEVICE__NAME__ENTRY.html">_DEVICE_NAME_ENTRY</a> * <a class="el" href="../../d3/d4/struct__DEVICE__NAME__ENTRY.html">PDEVICE_NAME_ENTRY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00454">FindPathForDevice()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a7" doxytag="dev2dos.c::FindPathForDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FindPathForDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingPath</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>DevicesInPath</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>FinalPath</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00454">454</a> of file <a class="el" href="../../d1/d6/dev2dos_8c-source.html">dev2dos.c</a>.
<p>
References <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00090">_DEVICE_NAME_ENTRY::DeviceName</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00326">GetNextReparseVolumePath()</a>, <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00089">_DEVICE_NAME_ENTRY::ListEntry</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00225">OpenDeviceReparseIndex()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d4/d2/dumpuser_8c-source.html#l00045">path</a>, <a class="el" href="../../d0/d7/dev2dos_8c.html#a1">PDEVICE_NAME_ENTRY</a>, <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00149">QueryDeviceNameForPath()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00580">RtlVolumeDeviceToDosName()</a>.
<p>
<pre class="fragment"><div>00463                    :
00464 
00465     This routine finds a <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> (<span class="keywordflow">if</span> any) to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given device that begins
00466     with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given starting <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.  The <span class="keyword">final</span> <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> returned includes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00467     starting <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.
00468 
00469 Arguments:
00470 
00471     StartingPath    - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> to begin <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> search on.
00472 
00473     DeviceName      - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device name whose <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> we are searching <span class="keywordflow">for</span>.
00474 
00475     DevicesInPath   - Supplies a list of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> devices in all proper prefixes
00476                             of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.
00477 
00478     FinalPath       - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given device.
00479 
00480 Return Value:
00481 
00482     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00483 
00484 --*/
00485 
00486 {
00487     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            status;
00488     UNICODE_STRING      startingDeviceName;
00489     PLIST_ENTRY         l;
00490     <a class="code" href="../../d3/d4/struct__DEVICE__NAME__ENTRY.html">PDEVICE_NAME_ENTRY</a>  entry;
00491     HANDLE              h;
00492     UNICODE_STRING      <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>, newStart;
00493 
00494     status = <a class="code" href="../../d0/d7/dev2dos_8c.html#a3">QueryDeviceNameForPath</a>(StartingPath, &amp;startingDeviceName);
00495     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00496         <span class="keywordflow">return</span> status;
00497     }
00498 
00499     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(DeviceName, &amp;startingDeviceName, TRUE)) {
00500         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(startingDeviceName.Buffer);
00501         FinalPath-&gt;Length = StartingPath-&gt;Length;
00502         FinalPath-&gt;MaximumLength = FinalPath-&gt;Length + <span class="keyword">sizeof</span>(WCHAR);
00503         FinalPath-&gt;Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool,
00504                                            FinalPath-&gt;MaximumLength);
00505         <span class="keywordflow">if</span> (!FinalPath-&gt;Buffer) {
00506             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00507         }
00508 
00509         RtlCopyMemory(FinalPath-&gt;Buffer, StartingPath-&gt;Buffer,
00510                       FinalPath-&gt;Length);
00511         FinalPath-&gt;Buffer[FinalPath-&gt;Length/<span class="keyword">sizeof</span>(WCHAR)] = 0;
00512 
00513         <span class="keywordflow">return</span> STATUS_SUCCESS;
00514     }
00515 
00516     <span class="keywordflow">for</span> (l = DevicesInPath-&gt;Flink; l != DevicesInPath; l = l-&gt;Flink) {
00517         entry = CONTAINING_RECORD(l, <a class="code" href="../../d3/d4/struct__DEVICE__NAME__ENTRY.html">DEVICE_NAME_ENTRY</a>, ListEntry);
00518         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;entry-&gt;<a class="code" href="../../d3/d4/struct__DEVICE__NAME__ENTRY.html#o1">DeviceName</a>, &amp;startingDeviceName,
00519                                   TRUE)) {
00520 
00521             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(startingDeviceName.Buffer);
00522             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00523         }
00524     }
00525 
00526     status = <a class="code" href="../../d0/d7/dev2dos_8c.html#a4">OpenDeviceReparseIndex</a>(&amp;startingDeviceName, &amp;h);
00527     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00528         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(startingDeviceName.Buffer);
00529         <span class="keywordflow">return</span> status;
00530     }
00531 
00532     entry = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d4/struct__DEVICE__NAME__ENTRY.html">DEVICE_NAME_ENTRY</a>));
00533     <span class="keywordflow">if</span> (!entry) {
00534         ZwClose(h);
00535         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(startingDeviceName.Buffer);
00536         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00537     }
00538     entry-&gt;<a class="code" href="../../d3/d4/struct__DEVICE__NAME__ENTRY.html#o1">DeviceName</a> = startingDeviceName;
00539     InsertTailList(DevicesInPath, &amp;entry-&gt;<a class="code" href="../../d3/d4/struct__DEVICE__NAME__ENTRY.html#o0">ListEntry</a>);
00540 
00541     <span class="keywordflow">for</span> (;;) {
00542 
00543         status = <a class="code" href="../../d0/d7/dev2dos_8c.html#a6">GetNextReparseVolumePath</a>(h, &amp;path);
00544         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00545             <span class="keywordflow">break</span>;
00546         }
00547         newStart.Length = StartingPath-&gt;Length + <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.Length;
00548         newStart.MaximumLength = newStart.Length + <span class="keyword">sizeof</span>(WCHAR);
00549         newStart.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, newStart.MaximumLength);
00550         <span class="keywordflow">if</span> (!newStart.Buffer) {
00551             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.Buffer);
00552             status = STATUS_INSUFFICIENT_RESOURCES;
00553             <span class="keywordflow">break</span>;
00554         }
00555 
00556         RtlCopyMemory(newStart.Buffer, StartingPath-&gt;Buffer,
00557                       StartingPath-&gt;Length);
00558         RtlCopyMemory((PCHAR) newStart.Buffer + StartingPath-&gt;Length,
00559                       <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.Buffer, <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.Length);
00560         newStart.Buffer[newStart.Length/<span class="keyword">sizeof</span>(WCHAR)] = 0;
00561         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.Buffer);
00562 
00563         status = <a class="code" href="../../d0/d7/dev2dos_8c.html#a7">FindPathForDevice</a>(&amp;newStart, DeviceName, DevicesInPath,
00564                                    FinalPath);
00565         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(newStart.Buffer);
00566         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00567             <span class="keywordflow">break</span>;
00568         }
00569     }
00570 
00571     RemoveEntryList(&amp;entry-&gt;<a class="code" href="../../d3/d4/struct__DEVICE__NAME__ENTRY.html#o0">ListEntry</a>);
00572     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(entry);
00573     ZwClose(h);
00574     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(startingDeviceName.Buffer);
00575 
00576     <span class="keywordflow">return</span> status;
00577 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="dev2dos.c::GetNextReparseVolumePath" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS GetNextReparseVolumePath           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Path</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00326">326</a> of file <a class="el" href="../../d1/d6/dev2dos_8c-source.html">dev2dos.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00296">IsVolumeName()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00582">ZwOpenFile()</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00454">FindPathForDevice()</a>.
<p>
<pre class="fragment"><div>00333                    :
00334 
00335     This routine queries <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reparse index <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next volume mount point.
00336 
00337 Arguments:
00338 
00339     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>  - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle.
00340 
00341     Path    - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.
00342 
00343 
00344 Return Value:
00345 
00346     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00347 
00348 --*/
00349 
00350 {
00351     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                        status;
00352     IO_STATUS_BLOCK                 ioStatus;
00353     FILE_REPARSE_POINT_INFORMATION  reparseInfo;
00354     UNICODE_STRING                  fileId;
00355     OBJECT_ATTRIBUTES               oa;
00356     HANDLE                          h;
00357     PREPARSE_DATA_BUFFER            reparse;
00358     UNICODE_STRING                  volumeName;
00359     ULONG                           nameInfoSize;
00360     PFILE_NAME_INFORMATION          nameInfo;
00361 
00362     <span class="keywordflow">for</span> (;;) {
00363 
00364         status = ZwQueryDirectoryFile(Handle, NULL, NULL, NULL, &amp;ioStatus,
00365                                       &amp;reparseInfo, <span class="keyword">sizeof</span>(reparseInfo),
00366                                       FileReparsePointInformation, TRUE, NULL,
00367                                       FALSE);
00368         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00369             <span class="keywordflow">return</span> status;
00370         }
00371 
00372         <span class="keywordflow">if</span> (reparseInfo.Tag != IO_REPARSE_TAG_MOUNT_POINT) {
00373             <span class="keywordflow">continue</span>;
00374         }
00375 
00376         fileId.Length = <span class="keyword">sizeof</span>(reparseInfo.FileReference);
00377         fileId.MaximumLength = fileId.Length;
00378         fileId.Buffer = (PWSTR) &amp;reparseInfo.FileReference;
00379 
00380         InitializeObjectAttributes(&amp;oa, &amp;fileId, 0, Handle, NULL);
00381 
00382         status = <a class="code" href="../../d6/d9/restrfil_8c.html#a33">ZwOpenFile</a>(&amp;h, SYNCHRONIZE | FILE_GENERIC_READ, &amp;oa,
00383                             &amp;ioStatus, FILE_SHARE_READ | FILE_SHARE_WRITE,
00384                             FILE_OPEN_BY_FILE_ID | FILE_OPEN_REPARSE_POINT |
00385                             FILE_SYNCHRONOUS_IO_ALERT);
00386         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00387             <span class="keywordflow">continue</span>;
00388         }
00389 
00390         reparse = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, MAXIMUM_REPARSE_DATA_BUFFER_SIZE);
00391         <span class="keywordflow">if</span> (!reparse) {
00392             ZwClose(h);
00393             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00394         }
00395 
00396         status = ZwFsControlFile(h, NULL, NULL, NULL, &amp;ioStatus,
00397                                  FSCTL_GET_REPARSE_POINT, NULL, 0, reparse,
00398                                  MAXIMUM_REPARSE_DATA_BUFFER_SIZE);
00399         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00400             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(reparse);
00401             ZwClose(h);
00402             <span class="keywordflow">continue</span>;
00403         }
00404 
00405         volumeName.Length = reparse-&gt;MountPointReparseBuffer.SubstituteNameLength -
00406                             <span class="keyword">sizeof</span>(WCHAR);
00407         volumeName.MaximumLength = volumeName.Length + <span class="keyword">sizeof</span>(WCHAR);
00408         volumeName.Buffer = (PWCHAR)
00409                             ((PCHAR) reparse-&gt;MountPointReparseBuffer.PathBuffer +
00410                             reparse-&gt;MountPointReparseBuffer.SubstituteNameOffset);
00411         volumeName.Buffer[volumeName.Length/<span class="keyword">sizeof</span>(WCHAR)] = 0;
00412 
00413         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d7/dev2dos_8c.html#a5">IsVolumeName</a>(&amp;volumeName)) {
00414             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(reparse);
00415             ZwClose(h);
00416             <span class="keywordflow">continue</span>;
00417         }
00418 
00419         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(reparse);
00420 
00421         nameInfoSize = 1024;
00422         nameInfo = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, nameInfoSize);
00423         <span class="keywordflow">if</span> (!nameInfo) {
00424             ZwClose(h);
00425             <span class="keywordflow">continue</span>;
00426         }
00427 
00428         status = ZwQueryInformationFile(h, &amp;ioStatus, nameInfo, nameInfoSize,
00429                                         FileNameInformation);
00430         ZwClose(h);
00431         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00432             <span class="keywordflow">continue</span>;
00433         }
00434 
00435         Path-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) nameInfo-&gt;FileNameLength;
00436         Path-&gt;MaximumLength = Path-&gt;Length + <span class="keyword">sizeof</span>(WCHAR);
00437         Path-&gt;Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, Path-&gt;MaximumLength);
00438         <span class="keywordflow">if</span> (!Path-&gt;Buffer) {
00439             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(nameInfo);
00440             <span class="keywordflow">continue</span>;
00441         }
00442 
00443         RtlCopyMemory(Path-&gt;Buffer, nameInfo-&gt;FileName, Path-&gt;Length);
00444         Path-&gt;Buffer[Path-&gt;Length/<span class="keyword">sizeof</span>(WCHAR)] = 0;
00445 
00446         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(nameInfo);
00447         <span class="keywordflow">break</span>;
00448     }
00449 
00450     <span class="keywordflow">return</span> status;
00451 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="dev2dos.c::IsVolumeName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IsVolumeName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Name</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00296">296</a> of file <a class="el" href="../../d1/d6/dev2dos_8c-source.html">dev2dos.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00326">GetNextReparseVolumePath()</a>.
<p>
<pre class="fragment"><div>00300 {
00301     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length == 96 &amp;&amp;
00302         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[0] == <span class="charliteral">'\\'</span> &amp;&amp;
00303         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[1] == <span class="charliteral">'?'</span> &amp;&amp;
00304         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[2] == <span class="charliteral">'?'</span> &amp;&amp;
00305         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[3] == <span class="charliteral">'\\'</span> &amp;&amp;
00306         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[4] == <span class="charliteral">'V'</span> &amp;&amp;
00307         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[5] == <span class="charliteral">'o'</span> &amp;&amp;
00308         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[6] == <span class="charliteral">'l'</span> &amp;&amp;
00309         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[7] == <span class="charliteral">'u'</span> &amp;&amp;
00310         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[8] == <span class="charliteral">'m'</span> &amp;&amp;
00311         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[9] == <span class="charliteral">'e'</span> &amp;&amp;
00312         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[10] == <span class="charliteral">'{'</span> &amp;&amp;
00313         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[19] == <span class="charliteral">'-'</span> &amp;&amp;
00314         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[24] == <span class="charliteral">'-'</span> &amp;&amp;
00315         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[29] == <span class="charliteral">'-'</span> &amp;&amp;
00316         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[34] == <span class="charliteral">'-'</span> &amp;&amp;
00317         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[47] == <span class="charliteral">'}'</span>) {
00318 
00319         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00320     }
00321 
00322     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00323 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="dev2dos.c::OpenDeviceReparseIndex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS OpenDeviceReparseIndex           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00225">225</a> of file <a class="el" href="../../d1/d6/dev2dos_8c-source.html">dev2dos.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01517">_FILE_OBJECT::DeviceObject</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01070">_VPB::Flags</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06998">IoGetDeviceObjectPointer()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01186">_DEVICE_OBJECT::Vpb</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01054">VPB_MOUNTED</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00582">ZwOpenFile()</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00454">FindPathForDevice()</a>.
<p>
<pre class="fragment"><div>00232                    :
00233 
00234     This routine opens <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reparse index on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given device.
00235 
00236 Arguments:
00237 
00238     DeviceName  - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device name.
00239 
00240     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>      - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle.
00241 
00242 Return Value:
00243 
00244     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00245 
00246 --*/
00247 
00248 {
00249     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            status;
00250     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>        fileObject;
00251     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>      deviceObject;
00252     UNICODE_STRING      reparseSuffix, reparseName;
00253     OBJECT_ATTRIBUTES   oa;
00254     IO_STATUS_BLOCK     ioStatus;
00255 
00256     status = <a class="code" href="../../d4/d6/iosubs_8c.html#a71">IoGetDeviceObjectPointer</a>(DeviceName, FILE_READ_ATTRIBUTES,
00257                                       &amp;fileObject, &amp;deviceObject);
00258     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00259         <span class="keywordflow">return</span> status;
00260     }
00261     deviceObject = fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a>;
00262 
00263     <span class="keywordflow">if</span> (!deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o10">Vpb</a> || !(deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o10">Vpb</a>-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o2">Flags</a>&amp;<a class="code" href="../../d0/d5/io_8h.html#a116">VPB_MOUNTED</a>)) {
00264         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(fileObject);
00265         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00266     }
00267 
00268     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(fileObject);
00269 
00270     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;reparseSuffix,
00271                          L<span class="stringliteral">"\\$Extend\\$Reparse:$R:$INDEX_ALLOCATION"</span>);
00272     reparseName.Length = DeviceName-&gt;Length + reparseSuffix.Length;
00273     reparseName.MaximumLength = reparseName.Length + <span class="keyword">sizeof</span>(WCHAR);
00274     reparseName.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, reparseName.MaximumLength);
00275     <span class="keywordflow">if</span> (!reparseName.Buffer) {
00276         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00277     }
00278 
00279     RtlCopyMemory(reparseName.Buffer, DeviceName-&gt;Buffer, DeviceName-&gt;Length);
00280     RtlCopyMemory((PCHAR) reparseName.Buffer + DeviceName-&gt;Length,
00281                   reparseSuffix.Buffer, reparseSuffix.Length);
00282     reparseName.Buffer[reparseName.Length/<span class="keyword">sizeof</span>(WCHAR)] = 0;
00283 
00284     InitializeObjectAttributes(&amp;oa, &amp;reparseName, OBJ_CASE_INSENSITIVE, 0, 0);
00285     status = <a class="code" href="../../d6/d9/restrfil_8c.html#a33">ZwOpenFile</a>(Handle, SYNCHRONIZE | FILE_LIST_DIRECTORY, &amp;oa,
00286                         &amp;ioStatus, FILE_SHARE_READ | FILE_SHARE_WRITE,
00287                         FILE_DIRECTORY_FILE | FILE_SYNCHRONOUS_IO_ALERT |
00288                         FILE_OPEN_FOR_BACKUP_INTENT);
00289 
00290     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(reparseName.Buffer);
00291 
00292     <span class="keywordflow">return</span> status;
00293 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="dev2dos.c::QueryDeviceNameForPath" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS QueryDeviceNameForPath           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Path</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00149">149</a> of file <a class="el" href="../../d1/d6/dev2dos_8c-source.html">dev2dos.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00094">QuerySymbolicLink()</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00582">ZwOpenFile()</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00454">FindPathForDevice()</a>.
<p>
<pre class="fragment"><div>00156                    :
00157 
00158     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device name <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.  It first checks
00159     to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a symbolic link and then checks to see <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a
00160     volume reparse point.
00161 
00162 Arguments:
00163 
00164     Path        - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.
00165 
00166     DeviceName  - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device name.
00167 
00168 Return Value:
00169 
00170     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00171 
00172 --*/
00173 
00174 {
00175     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                status;
00176     OBJECT_ATTRIBUTES       oa;
00177     HANDLE                  h;
00178     IO_STATUS_BLOCK         ioStatus;
00179     PREPARSE_DATA_BUFFER    reparse;
00180     UNICODE_STRING          volumeName;
00181 
00182     status = <a class="code" href="../../d0/d7/dev2dos_8c.html#a2">QuerySymbolicLink</a>(Path, DeviceName);
00183     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00184         <span class="keywordflow">return</span> status;
00185     }
00186 
00187     InitializeObjectAttributes(&amp;oa, Path, OBJ_CASE_INSENSITIVE, 0, 0);
00188     status = <a class="code" href="../../d6/d9/restrfil_8c.html#a33">ZwOpenFile</a>(&amp;h, SYNCHRONIZE | FILE_GENERIC_READ, &amp;oa, &amp;ioStatus,
00189                         FILE_SHARE_READ | FILE_SHARE_WRITE,
00190                         FILE_OPEN_REPARSE_POINT | FILE_SYNCHRONOUS_IO_ALERT);
00191     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00192         <span class="keywordflow">return</span> status;
00193     }
00194 
00195     reparse = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, MAXIMUM_REPARSE_DATA_BUFFER_SIZE);
00196     <span class="keywordflow">if</span> (!reparse) {
00197         ZwClose(h);
00198         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00199     }
00200 
00201     status = ZwFsControlFile(h, NULL, NULL, NULL, &amp;ioStatus,
00202                              FSCTL_GET_REPARSE_POINT, NULL, 0, reparse,
00203                              MAXIMUM_REPARSE_DATA_BUFFER_SIZE);
00204     ZwClose(h);
00205     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00206         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(reparse);
00207         <span class="keywordflow">return</span> status;
00208     }
00209 
00210     volumeName.Length = reparse-&gt;MountPointReparseBuffer.SubstituteNameLength -
00211                         <span class="keyword">sizeof</span>(WCHAR);
00212     volumeName.MaximumLength = volumeName.Length + <span class="keyword">sizeof</span>(WCHAR);
00213     volumeName.Buffer = (PWCHAR)
00214                         ((PCHAR) reparse-&gt;MountPointReparseBuffer.PathBuffer +
00215                         reparse-&gt;MountPointReparseBuffer.SubstituteNameOffset);
00216     volumeName.Buffer[volumeName.Length/<span class="keyword">sizeof</span>(WCHAR)] = 0;
00217 
00218     status = <a class="code" href="../../d0/d7/dev2dos_8c.html#a2">QuerySymbolicLink</a>(&amp;volumeName, DeviceName);
00219     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(reparse);
00220 
00221     <span class="keywordflow">return</span> status;
00222 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="dev2dos.c::QuerySymbolicLink" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS QuerySymbolicLink           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SymbolicLinkName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>LinkTarget</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00094">94</a> of file <a class="el" href="../../d1/d6/dev2dos_8c-source.html">dev2dos.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00149">QueryDeviceNameForPath()</a>, and <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00580">RtlVolumeDeviceToDosName()</a>.
<p>
<pre class="fragment"><div>00101                    :
00102 
00103     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> symbolic link name.
00104 
00105 Arguments:
00106 
00107     SymbolicLinkName    - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> symbolic link name.
00108 
00109     LinkTarget          - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> link target.
00110 
00111 Return Value:
00112 
00113     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00114 
00115 --*/
00116 
00117 {
00118     OBJECT_ATTRIBUTES   oa;
00119     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            status;
00120     HANDLE              h;
00121 
00122     InitializeObjectAttributes(&amp;oa, SymbolicLinkName, OBJ_CASE_INSENSITIVE,
00123                                0, 0);
00124 
00125     status = ZwOpenSymbolicLinkObject(&amp;h, GENERIC_READ, &amp;oa);
00126     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00127         <span class="keywordflow">return</span> status;
00128     }
00129 
00130     LinkTarget-&gt;MaximumLength = 200*<span class="keyword">sizeof</span>(WCHAR);
00131     LinkTarget-&gt;Length = 0;
00132     LinkTarget-&gt;Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, LinkTarget-&gt;MaximumLength);
00133     <span class="keywordflow">if</span> (!LinkTarget-&gt;Buffer) {
00134         ZwClose(h);
00135         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00136     }
00137 
00138     status = ZwQuerySymbolicLinkObject(h, LinkTarget, NULL);
00139     ZwClose(h);
00140 
00141     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00142         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(LinkTarget-&gt;Buffer);
00143     }
00144 
00145     <span class="keywordflow">return</span> status;
00146 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="dev2dos.c::RtlVolumeDeviceToDosName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlVolumeDeviceToDosName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>VolumeDeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>DosName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00580">580</a> of file <a class="el" href="../../d1/d6/dev2dos_8c-source.html">dev2dos.c</a>.
<p>
References <a class="el" href="../../d4/d9/user32_8def-source.html#l00799">c</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00454">FindPathForDevice()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01552">IoBuildDeviceIoControlRequest()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00094">QuerySymbolicLink()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00587                    :
00588 
00589     This routine returns a valid DOS <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given device object.
00590     This caller of <span class="keyword">this</span> routine must call <a class="code" href="../../d6/d3/cmwraper_8c.html#a26">ExFreePool</a> on DosName-&gt;Buffer
00591     when <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no longer needed.
00592 
00593 Arguments:
00594 
00595     VolumeDeviceObject  - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume device object.
00596 
00597     DosName             - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DOS name <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume
00598 
00599 Return Value:
00600 
00601     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00602 
00603 --*/
00604 
00605 {
00606     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>  volumeDeviceObject = VolumeDeviceObject;
00607     PMOUNTDEV_NAME  name;
00608     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>            output[512];
00609     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>          event;
00610     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>            irp;
00611     IO_STATUS_BLOCK ioStatus;
00612     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        status;
00613     UNICODE_STRING  deviceName;
00614     WCHAR           buffer[30];
00615     UNICODE_STRING  driveLetterName;
00616     WCHAR           <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
00617     UNICODE_STRING  linkTarget;
00618     LIST_ENTRY      devicesInPath;
00619 
00620     name = (PMOUNTDEV_NAME) output;
00621     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;event, NotificationEvent, FALSE);
00622     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a25">IoBuildDeviceIoControlRequest</a>(IOCTL_MOUNTDEV_QUERY_DEVICE_NAME,
00623                                         volumeDeviceObject, NULL, 0, name, 512,
00624                                         FALSE, &amp;event, &amp;ioStatus);
00625     <span class="keywordflow">if</span> (!irp) {
00626         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00627     }
00628 
00629     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>(volumeDeviceObject, irp);
00630     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
00631         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;event, Executive, KernelMode, FALSE, NULL);
00632         status = ioStatus.Status;
00633     }
00634 
00635     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00636         <span class="keywordflow">return</span> status;
00637     }
00638 
00639     deviceName.MaximumLength = deviceName.Length = name-&gt;NameLength;
00640     deviceName.Buffer = name-&gt;Name;
00641 
00642     swprintf(buffer, L<span class="stringliteral">"\\??\\C:"</span>);
00643     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;driveLetterName, buffer);
00644 
00645     <span class="keywordflow">for</span> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> = <span class="charliteral">'A'</span>; <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> &lt;= <span class="charliteral">'Z'</span>; <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>++) {
00646         driveLetterName.Buffer[4] = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
00647 
00648         status = <a class="code" href="../../d0/d7/dev2dos_8c.html#a2">QuerySymbolicLink</a>(&amp;driveLetterName, &amp;linkTarget);
00649         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00650             <span class="keywordflow">continue</span>;
00651         }
00652 
00653         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;linkTarget, &amp;deviceName, TRUE)) {
00654             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(linkTarget.Buffer);
00655             <span class="keywordflow">break</span>;
00656         }
00657 
00658         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(linkTarget.Buffer);
00659     }
00660 
00661     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> &lt;= <span class="charliteral">'Z'</span>) {
00662         DosName-&gt;Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, 3*<span class="keyword">sizeof</span>(WCHAR));
00663         <span class="keywordflow">if</span> (!DosName-&gt;Buffer) {
00664             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00665         }
00666         DosName-&gt;MaximumLength = 6;
00667         DosName-&gt;Length = 4;
00668         DosName-&gt;Buffer[0] = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
00669         DosName-&gt;Buffer[1] = <span class="charliteral">':'</span>;
00670         DosName-&gt;Buffer[2] = 0;
00671         <span class="keywordflow">return</span> STATUS_SUCCESS;
00672     }
00673 
00674     <span class="keywordflow">for</span> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> = <span class="charliteral">'A'</span>; <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> &lt;= <span class="charliteral">'Z'</span>; <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>++) {
00675         driveLetterName.Buffer[4] = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
00676         InitializeListHead(&amp;devicesInPath);
00677         status = <a class="code" href="../../d0/d7/dev2dos_8c.html#a7">FindPathForDevice</a>(&amp;driveLetterName, &amp;deviceName,
00678                                    &amp;devicesInPath, DosName);
00679 
00680         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00681             DosName-&gt;Length -= 4*<span class="keyword">sizeof</span>(WCHAR);
00682             RtlMoveMemory(DosName-&gt;Buffer, &amp;DosName-&gt;Buffer[4],
00683                           DosName-&gt;Length);
00684             DosName-&gt;Buffer[DosName-&gt;Length/<span class="keyword">sizeof</span>(WCHAR)] = 0;
00685             <span class="keywordflow">return</span> status;
00686         }
00687     }
00688 
00689     <span class="keywordflow">return</span> status;
00690 }
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:26 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
