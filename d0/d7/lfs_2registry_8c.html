<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: lfs/registry.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>registry.c File Reference</h1><code>#include "<a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>"</code><br>

<p>
<a href="../../d1/d6/lfs_2registry_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/lfs_2registry_8c.html#a0">Dbg</a>&nbsp;&nbsp;&nbsp;(DEBUG_TRACE_REGISTRY)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/lfs_2registry_8c.html#a1">LfsRestartLogFile</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> LogFile, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> MaximumClients, IN ULONG LogPageSize OPTIONAL, IN LONGLONG FileSize, IN OUT <a class="el" href="../../d6/d3/lfs_8h.html#a22">PLFS_INFO</a> LfsInfo, OUT <a class="el" href="../../d5/d1/struct__LFS__WRITE__DATA.html">PLFS_WRITE_DATA</a> WriteData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/lfs_2registry_8c.html#a2">LfsNormalizeBasicLogFile</a> (IN OUT PLONGLONG FileSize, IN OUT PULONG LogPageSize, IN OUT <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a22">PUSHORT</a> LogClients, IN BOOLEAN UseDefaultLogPage)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/lfs_2registry_8c.html#a3">LfsUpdateLfcbFromPgHeader</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN ULONG SystemPageSize, IN ULONG LogPageSize, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a13">SHORT</a> MajorVersion, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a13">SHORT</a> MinorVersion, IN BOOLEAN PackLog)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/lfs_2registry_8c.html#a4">LfsUpdateLfcbFromNoRestart</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN LONGLONG FileSize, IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a> LastLsn, IN ULONG LogClients, IN ULONG OpenLogCount, IN BOOLEAN LogFileWrapped, IN BOOLEAN UseMultiplePageIo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/lfs_2registry_8c.html#a5">LfsUpdateLfcbFromRestart</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN <a class="el" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a> RestartArea, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> RestartOffset)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/lfs_2registry_8c.html#a6">LfsUpdateRestartAreaFromLfcb</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN <a class="el" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a> RestartArea)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/lfs_2registry_8c.html#a7">LfsInitializeLogFilePriv</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN BOOLEAN ForceRestartToDisk, IN ULONG RestartAreaSize, IN LONGLONG StartOffsetForClear, IN BOOLEAN ClearLogFile)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/lfs_2registry_8c.html#a8">LfsFindLastLsn</a> (IN OUT <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/lfs_2registry_8c.html#a9">LfsCheckSubsequentLogPage</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN <a class="el" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html">PLFS_RECORD_PAGE_HEADER</a> RecordPageHeader, IN LONGLONG LogFileOffset, IN LONGLONG SequenceNumber)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/lfs_2registry_8c.html#a10">LfsFlushLogPage</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, PVOID LogPage, IN LONGLONG FileOffset, OUT <a class="el" href="../../d4/d3/struct__BCB.html">PBCB</a> *Bcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/lfs_2registry_8c.html#a11">LfsRemoveClientFromList</a> (IN <a class="el" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientArray, IN <a class="el" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientRecord, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a22">PUSHORT</a> ListHead)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/lfs_2registry_8c.html#a12">LfsAddClientToList</a> (IN <a class="el" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientArray, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> ClientIndex, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a22">PUSHORT</a> ListHead)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/lfs_2registry_8c.html#a13">LfsInitializeLogFile</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> LogFile, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> MaximumClients, IN ULONG LogPageSize OPTIONAL, IN LONGLONG FileSize, OUT <a class="el" href="../../d5/d1/struct__LFS__WRITE__DATA.html">PLFS_WRITE_DATA</a> WriteData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/lfs_2registry_8c.html#a14">LfsOpenLogFile</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> LogFile, IN UNICODE_STRING ClientName, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> MaximumClients, IN ULONG LogPageSize OPTIONAL, IN LONGLONG FileSize, IN OUT <a class="el" href="../../d6/d3/lfs_8h.html#a22">PLFS_INFO</a> LfsInfo, OUT <a class="el" href="../../d6/d3/lfs_8h.html#a24">PLFS_LOG_HANDLE</a> LogHandle, OUT <a class="el" href="../../d5/d1/struct__LFS__WRITE__DATA.html">PLFS_WRITE_DATA</a> WriteData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/lfs_2registry_8c.html#a15">LfsCloseLogFile</a> (IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a> LogHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/lfs_2registry_8c.html#a16">LfsDeleteLogHandle</a> (IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a> LogHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/lfs_2registry_8c.html#a17">LfsReadLogFileInformation</a> (IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a> LogHandle, IN <a class="el" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html">PLOG_FILE_INFORMATION</a> <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN OUT PULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/lfs_2registry_8c.html#a18">LfsVerifyLogFile</a> (IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a> LogHandle, IN PVOID LogFileHeader, IN ULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/lfs_2registry_8c.html#a19">LfsResetUndoTotal</a> (IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a> LogHandle, IN ULONG NumberRecords, IN LONG ResetTotal)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/lfs_2registry_8c.html#a20">LfsUpdateLfcbFromRestart</a> (IN OUT <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN <a class="el" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a> RestartArea, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> RestartOffset)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d7/lfs_2registry_8c.html#a21">LfsRemoveClientFromList</a> (<a class="el" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientArray, <a class="el" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientRecord, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a22">PUSHORT</a> ListHead)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="lfs/registry.c::Dbg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Dbg&nbsp;&nbsp;&nbsp;(DEBUG_TRACE_REGISTRY)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00028">28</a> of file <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html">lfs/registry.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a12" doxytag="lfs/registry.c::LfsAddClientToList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsAddClientToList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientArray</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientIndex</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a22">PUSHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ListHead</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l04463">4463</a> of file <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html">lfs/registry.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00355">LFS_NO_CLIENT</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00382">_LFS_CLIENT_RECORD::NextClient</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00381">_LFS_CLIENT_RECORD::PrevClient</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00706">LfsCloseLogFile()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00366">LfsOpenLogFile()</a>.
<p>
<pre class="fragment"><div>04471                    :
04472 
04473     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to add a client record to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of a list.
04474 
04475 Arguments:
04476 
04477     ClientArray - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client record.
04478 
04479     ClientIndex - The index <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> record to add.
04480 
04481     ListHead - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> beginning of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list.  This points to a
04482                <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first element in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list.
04483 
04484 Return Value:
04485 
04486     None.
04487 
04488 --*/
04489 
04490 {
04491     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientRecord;
04492     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> TempClientRecord;
04493 
04494     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04495 
04496     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsAddClientToList:  Entered\n"</span>, 0 );
04497     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Client Array  -&gt; %08lx\n"</span>, ClientArray );
04498     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Client Index  -&gt; %04x\n"</span>, ClientIndex );
04499     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"List Head     -&gt; %08lx\n"</span>, ListHead );
04500 
04501     ClientRecord = ClientArray + ClientIndex;
04502 
04503     <span class="comment">//</span>
04504     <span class="comment">//  This element will become the first element on the list.</span>
04505     <span class="comment">//</span>
04506 
04507     ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o2">PrevClient</a> = <a class="code" href="../../d9/d3/lfsdisk_8h.html#a21">LFS_NO_CLIENT</a>;
04508 
04509     <span class="comment">//</span>
04510     <span class="comment">//  The next element for this record is the previous head of the list.</span>
04511     <span class="comment">//</span>
04512 
04513     ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o3">NextClient</a> = *ListHead;
04514 
04515     <span class="comment">//</span>
04516     <span class="comment">//  If there is at least one element currently on the list, we point</span>
04517     <span class="comment">//  the first element to this new record.</span>
04518     <span class="comment">//</span>
04519 
04520     <span class="keywordflow">if</span> (*ListHead != <a class="code" href="../../d9/d3/lfsdisk_8h.html#a21">LFS_NO_CLIENT</a>) {
04521 
04522         TempClientRecord = ClientArray + *ListHead;
04523         TempClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o2">PrevClient</a> = ClientIndex;
04524     }
04525 
04526     <span class="comment">//</span>
04527     <span class="comment">//  This index is now the head of the list.</span>
04528     <span class="comment">//</span>
04529 
04530     *ListHead = ClientIndex;
04531 
04532     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsAddClientToList:  Exit\n"</span>, 0 );
04533 
04534     <span class="keywordflow">return</span>;
04535 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="lfs/registry.c::LfsCheckSubsequentLogPage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN LfsCheckSubsequentLogPage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html">PLFS_RECORD_PAGE_HEADER</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RecordPageHeader</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LogFileOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SequenceNumber</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l04188">4188</a> of file <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html">lfs/registry.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00347">LFS_SIGNATURE_UNINITIALIZED_ULONG</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00305">LfsLsnToSeqNumber</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00297">LfsTruncateLsnToLogPage</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00140">LSN</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l03193">LfsFindLastLsn()</a>.
<p>
<pre class="fragment"><div>04197                    :
04198 
04199     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to check that a particular log page could not
04200     have been written after a prior Io transfer.  What we are looking <span class="keywordflow">for</span>
04201     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of a transfer which was written after an Io which we
04202     we cannot read from during restart.  The presence of an additional
04203     Io means that we cannot guarantee that we can recover all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04204     restart data <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk.  This makes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk unrecoverable.
04205 
04206     We are given <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> sequence number of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lsn that would occur on <span class="keyword">this</span> page
04207     (<span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not part of an Log record which spans <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>).
04208     If we haven'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> wrapped <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> and find an Lsn whose
04209     sequence number matches <span class="keyword">this</span>, then we have an error.  If we have
04210     wrapped <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> sequence number in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lsn in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04211     first log page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
04212     written subsequent to a previous failing Io.
04213 
04214 Arguments:
04215 
04216     Lfcb - Log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block <span class="keywordflow">for</span> <span class="keyword">this</span> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
04217 
04218     RecordPageHeader - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> header of a log page to check.
04219 
04220     LogFileOffset - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> of <span class="keyword">this</span> page.
04221 
04222     SequenceNumber - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> sequence number that <span class="keyword">this</span> log page should
04223                      not have.  This will be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> sequence number <span class="keywordflow">for</span>
04224                      any log records which begin on <span class="keyword">this</span> page <span class="keywordflow">if</span> written
04225                      after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page that failed.
04226 
04227 Return Value:
04228 
04229     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <span class="keyword">this</span> log page was written after some previous page,
04230               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
04231 
04232 --*/
04233 
04234 {
04235     BOOLEAN IsSubsequent;
04236 
04237     <a class="code" href="../../d6/d3/lfs_8h.html#a10">LSN</a> Lsn;
04238     LONGLONG LsnSeqNumber;
04239     LONGLONG SeqNumberMinus1;
04240     LONGLONG LogPageFileOffset;
04241 
04242     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04243 
04244     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsCheckSubsequentLogPage:  Entered\n"</span>, 0 );
04245     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lfcb                  -&gt; %08lx\n"</span>, Lfcb );
04246     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"RecordPageHeader      -&gt; %08lx\n"</span>, RecordPageHeader );
04247     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"LogFileOffset (Low)   -&gt; %08lx\n"</span>, LogFileOffset.LowPart );
04248     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"LogFileOffset (High)  -&gt; %08lx\n"</span>, LogFileOffset.HighPart );
04249     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"SequenceNumber (Low)  -&gt; %08lx\n"</span>, SequenceNumber.LowPart );
04250     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"SequenceNumber (High) -&gt; %08lx\n"</span>, SequenceNumber.HighPart );
04251 
04252     <span class="comment">//</span>
04253     <span class="comment">//  If the page header is either 0 or -1 then we say this page was not written</span>
04254     <span class="comment">//  after some previous page.</span>
04255     <span class="comment">//</span>
04256 
04257     <span class="keywordflow">if</span> (*((PULONG) RecordPageHeader-&gt;MultiSectorHeader.Signature) == <a class="code" href="../../d9/d3/lfsdisk_8h.html#a20">LFS_SIGNATURE_UNINITIALIZED_ULONG</a>
04258         || *((PULONG) RecordPageHeader-&gt;MultiSectorHeader.Signature) == 0) {
04259 
04260         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsCheckSubsequentLogPage:  Exit -&gt; %08x\n"</span>, FALSE );
04261         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04262     }
04263 
04264     <span class="comment">//</span>
04265     <span class="comment">//  If the last Lsn on the page occurs was</span>
04266     <span class="comment">//  written after the page that caused the original error.  Then we</span>
04267     <span class="comment">//  have a fatal error.</span>
04268     <span class="comment">//</span>
04269 
04270     Lsn = RecordPageHeader-&gt;Copy.LastLsn;
04271 
04272     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a11">LfsTruncateLsnToLogPage</a>( Lfcb, Lsn, &amp;LogPageFileOffset );
04273     LsnSeqNumber = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a13">LfsLsnToSeqNumber</a>( Lfcb, Lsn );
04274 
04275     SeqNumberMinus1 = SequenceNumber - 1;
04276 
04277     <span class="comment">//</span>
04278     <span class="comment">//  If the sequence number for the Lsn in the page is equal or greater than</span>
04279     <span class="comment">//  Lsn we expect, then this is a subsequent write.</span>
04280     <span class="comment">//</span>
04281 
04282     <span class="keywordflow">if</span> ( LsnSeqNumber &gt;= SequenceNumber ) {
04283 
04284         IsSubsequent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04285 
04286     <span class="comment">//</span>
04287     <span class="comment">//  If this page is the start of the file and the sequence number is 1 less</span>
04288     <span class="comment">//  than we expect and the Lsn indicates that we wrapped the file, then it</span>
04289     <span class="comment">//  is also part of a subsequent io.</span>
04290     <span class="comment">//</span>
04291     <span class="comment">//  The following test checks</span>
04292     <span class="comment">//</span>
04293     <span class="comment">//      1 - The sequence number for the Lsn is from the previous pass</span>
04294     <span class="comment">//          through the file.</span>
04295     <span class="comment">//      2 - We are at the first page in the file.</span>
04296     <span class="comment">//      3 - The log record didn't begin on the current page.</span>
04297     <span class="comment">//</span>
04298 
04299     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (( LsnSeqNumber == SeqNumberMinus1 )
04300                &amp;&amp; ( Lfcb-&gt;FirstLogPage == LogFileOffset )
04301                &amp;&amp; ( LogFileOffset != LogPageFileOffset )) {
04302 
04303         IsSubsequent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04304 
04305     } <span class="keywordflow">else</span> {
04306 
04307         IsSubsequent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04308     }
04309 
04310     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsCheckSubsequentLogPage:  Exit -&gt; %08x\n"</span>, IsSubsequent );
04311 
04312     <span class="keywordflow">return</span> IsSubsequent;
04313 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="lfs/registry.c::LfsCloseLogFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsCloseLogFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LogHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00706">706</a> of file <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html">lfs/registry.c</a>.
<p>
References <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00196">_LBCB::ActiveLinks</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01142">CcUnpinDataForThread()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00436">_LFCB::ClientArray</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00163">_LCH::ClientArrayByteOffset</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00443">_LFS_RESTART_AREA::ClientFreeList</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00149">_LCH::ClientId</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00057">_LFS_CLIENT_ID::ClientIndex</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00444">_LFS_RESTART_AREA::ClientInUseList</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00373">_LFS_CLIENT_RECORD::ClientRestartLsn</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00099">_LFCB_SYNC::Event</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00548">_LFCB::Flags</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00285">LBCB_NOT_EMPTY</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00284">LBCB_ON_ACTIVE_QUEUE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00415">_LFCB::LbcbActive</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00273">_LBCB::LbcbFlags</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00414">_LFCB::LbcbWorkque</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00136">_LCH::LchLinks</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00142">_LCH::Lfcb</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00606">LFCB_FINAL_SHUTDOWN</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00315">_LFCB::LfcbLinks</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00355">LFS_NO_CLIENT</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00517">LfsAcquireLch</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00509">LfsAcquireLfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00484">LfsAcquireLfsData</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l04463">LfsAddClientToList()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00706">LfsCloseLogFile()</a>, <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00402">LfsDeallocateLbcb()</a>, <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00188">LfsDeallocateLfcb()</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00058">LfsExceptionFilter()</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00426">_LFCB::LfsIoState</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00445">LfsLbcbIsRestart</a>, <a class="el" href="../../d1/d4/lfsstruc_8h.html#a40a38">LfsNoIoInProgress</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00520">LfsReleaseLch</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00512">LfsReleaseLfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00487">LfsReleaseLfsData</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l04383">LfsRemoveClientFromList()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00593">LfsValidateClientId</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00584">LfsValidateLch</a>, <a class="el" href="../../d8/d9/rstrtsup_8c-source.html#l00036">LfsWriteLfsRestart()</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00147">LfsZeroLsn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00235">_LBCB::LogPageBcb</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00279">_LBCB::ResourceThread</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00435">_LFCB::RestartArea</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00444">_LFCB::RestartAreaSize</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00389">_LFS_CLIENT_RECORD::SeqNumber</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00570">_LFCB::Sync</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02154">try_return</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00576">_LFCB::Waiters</a>, and <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00195">_LBCB::WorkqueLinks</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00706">LfsCloseLogFile()</a>.
<p>
<pre class="fragment"><div>00712                    :
00713 
00714     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when a client detaches itself from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log
00715     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  On <span class="keywordflow">return</span>, all prior references to <span class="keyword">this</span> client in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log
00716     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> are inaccessible.
00717 
00718 Arguments:
00719 
00720     LogHandle - Pointer to <span class="keyword">private</span> Lfs structure used to identify <span class="keyword">this</span>
00721                 client.
00722 
00723 Return Value:
00724 
00725     None
00726 
00727 --*/
00728 
00729 {
00730     <span class="keyword">volatile</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00731 
00732     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
00733 
00734     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
00735 
00736     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> ClientIndex;
00737     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientRecord;
00738 
00739     BOOLEAN FlushRestart;
00740     BOOLEAN ExitLoop;
00741 
00742     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00743 
00744     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsCloseLogFile:  Entered\n"</span>, 0 );
00745     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"LogHandle  -&gt;  %08lx\n"</span>, LogHandle );
00746 
00747     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
00748 
00749     <span class="comment">//</span>
00750     <span class="comment">//  Enclose this in a loop.  We will loop as long as there are waiters or there is an IO</span>
00751     <span class="comment">//  in progress.</span>
00752     <span class="comment">//</span>
00753 
00754     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00755 
00756         <span class="comment">//</span>
00757         <span class="comment">//  Always assume we exit the loop.</span>
00758         <span class="comment">//</span>
00759 
00760         ExitLoop = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00761 
00762         <span class="comment">//</span>
00763         <span class="comment">//  Check that the structure is a valid log handle structure.</span>
00764         <span class="comment">//</span>
00765 
00766         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a32">LfsValidateLch</a>( Lch );
00767 
00768         <span class="comment">//</span>
00769         <span class="comment">//  Protect this entry point with a try-except.</span>
00770         <span class="comment">//</span>
00771 
00772         <span class="keywordflow">try</span> {
00773 
00774             <span class="comment">//</span>
00775             <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00776             <span class="comment">//</span>
00777 
00778             <span class="comment">//</span>
00779             <span class="comment">//  Acquire the global data block and the log file control block.</span>
00780             <span class="comment">//</span>
00781 
00782             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a21">LfsAcquireLfsData</a>();
00783 
00784             <span class="keywordflow">try</span> {
00785 
00786                 <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> ThisLbcb;
00787 
00788                 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
00789 
00790                 Lfcb = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>;
00791 
00792                 <span class="comment">//</span>
00793                 <span class="comment">//  If the Log file has been closed then return immediately.</span>
00794                 <span class="comment">//</span>
00795 
00796                 <span class="keywordflow">if</span> (Lfcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00797 
00798                     <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
00799                 }
00800 
00801                 <span class="comment">//</span>
00802                 <span class="comment">//  Check that there are no waiters or IO in progress before proceeding.</span>
00803                 <span class="comment">//</span>
00804 
00805                 <span class="keywordflow">if</span> ((Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o60">Waiters</a> != 0) ||
00806                     (Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o29">LfsIoState</a> != <a class="code" href="../../d1/d4/lfsstruc_8h.html#a40a38">LfsNoIoInProgress</a>)) {
00807 
00808                     ExitLoop = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00809                     Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o60">Waiters</a> += 1;
00810                     <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
00811                 }
00812 
00813                 <span class="comment">//</span>
00814                 <span class="comment">//  Check that the client Id is valid.</span>
00815                 <span class="comment">//</span>
00816 
00817                 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a33">LfsValidateClientId</a>( Lfcb, Lch );
00818 
00819                 ClientRecord = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a>,
00820                                         Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o6">ClientArrayByteOffset</a>,
00821                                         <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> );
00822 
00823 <span class="preprocessor">#if 1</span>
00824 <span class="preprocessor"></span>                <span class="comment">//</span>
00825                 <span class="comment">//  Increment the client sequence number in the restart area.</span>
00826                 <span class="comment">//  This will prevent anyone else from accessing this client block.</span>
00827                 <span class="comment">//</span>
00828 
00829                 ClientIndex = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o4">ClientId</a>.<a class="code" href="../../d3/d0/struct__LFS__CLIENT__ID.html#o1">ClientIndex</a>;
00830 
00831                 ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o4">SeqNumber</a>++;
00832 <span class="preprocessor">#endif</span>
00833 <span class="preprocessor"></span>
00834                 <span class="comment">//</span>
00835                 <span class="comment">//  Remember if this client wrote a restart area.</span>
00836                 <span class="comment">//</span>
00837 
00838                 FlushRestart = (BOOLEAN) ( <a class="code" href="../../d6/d3/lfs_8h.html#a12">LfsZeroLsn</a>.QuadPart != ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o1">ClientRestartLsn</a>.QuadPart );
00839 
00840 <span class="preprocessor">#if 1</span>
00841 <span class="preprocessor"></span>                <span class="comment">//</span>
00842                 <span class="comment">//  Remove the client from the log file in use list.</span>
00843                 <span class="comment">//</span>
00844 
00845                 <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a21">LfsRemoveClientFromList</a>( Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a>,
00846                                          ClientRecord,
00847                                          &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o30">RestartArea</a>-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o3">ClientInUseList</a> );
00848 
00849                 <span class="comment">//</span>
00850                 <span class="comment">//  Add the client block to the log file free list</span>
00851                 <span class="comment">//</span>
00852 
00853                 <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a12">LfsAddClientToList</a>( Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a>,
00854                                     ClientIndex,
00855                                     &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o30">RestartArea</a>-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o2">ClientFreeList</a> );
00856 
00857                 <span class="comment">//</span>
00858                 <span class="comment">//  If this is the last client then move the last active Lbcb off</span>
00859                 <span class="comment">//  the active queue.</span>
00860                 <span class="comment">//</span>
00861 
00862                 <span class="keywordflow">if</span> (Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o30">RestartArea</a>-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o3">ClientInUseList</a> == <a class="code" href="../../d9/d3/lfsdisk_8h.html#a21">LFS_NO_CLIENT</a>) {
00863 <span class="preprocessor">#endif</span>
00864 <span class="preprocessor"></span>                    <span class="comment">//</span>
00865                     <span class="comment">//  Set the flag to indicate we are at the final close.</span>
00866                     <span class="comment">//</span>
00867 
00868                     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o54">Flags</a>, LFCB_FINAL_SHUTDOWN );
00869 
00870                     <span class="comment">//</span>
00871                     <span class="comment">//  Walk through the active queue and remove any Lbcb's with</span>
00872                     <span class="comment">//  data from that queue.  That will allow them to get out to disk.</span>
00873                     <span class="comment">//</span>
00874 
00875                     <span class="keywordflow">while</span> (!IsListEmpty( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o26">LbcbActive</a> )) {
00876 
00877                         ThisLbcb = CONTAINING_RECORD( Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o26">LbcbActive</a>.Flink,
00878                                                       <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
00879                                                       ActiveLinks );
00880 
00881                         RemoveEntryList( &amp;ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o3">ActiveLinks</a> );
00882                         <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, LBCB_ON_ACTIVE_QUEUE );
00883 
00884                         <span class="comment">//</span>
00885                         <span class="comment">//  If this page has some new entries, allow it to</span>
00886                         <span class="comment">//  be flushed to disk.  Otherwise deallocate it.</span>
00887                         <span class="comment">//</span>
00888 
00889                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, LBCB_NOT_EMPTY )) {
00890 
00891                             RemoveEntryList( &amp;ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o2">WorkqueLinks</a> );
00892 
00893                             <span class="keywordflow">if</span> (ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o9">LogPageBcb</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00894 
00895                                 <a class="code" href="../../d4/d2/cache_8h.html#a94">CcUnpinDataForThread</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o9">LogPageBcb</a>,
00896                                                       ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o14">ResourceThread</a> );
00897                             }
00898 
00899                             <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a4">LfsDeallocateLbcb</a>( Lfcb, ThisLbcb );
00900                         }
00901                     }
00902 
00903                     <span class="comment">//</span>
00904                     <span class="comment">//  It's possible that we have the two restart areas in the workque.</span>
00905                     <span class="comment">//  They can be removed and the memory deallocated if we have no</span>
00906                     <span class="comment">//  more clients.</span>
00907                     <span class="comment">//</span>
00908                     <span class="comment">//  We skip this action if the there is Io in progress or the user</span>
00909                     <span class="comment">//  had a restart area.</span>
00910                     <span class="comment">//</span>
00911 
00912                     <span class="keywordflow">if</span> ((Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o29">LfsIoState</a> == <a class="code" href="../../d1/d4/lfsstruc_8h.html#a40a38">LfsNoIoInProgress</a>) &amp;&amp; !FlushRestart) {
00913 
00914                         PLIST_ENTRY Links;
00915 
00916                         <span class="comment">//</span>
00917                         <span class="comment">//  Now walk through the workque list looking for a non-restart</span>
00918                         <span class="comment">//  entry.</span>
00919                         <span class="comment">//</span>
00920 
00921                         Links = Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o25">LbcbWorkque</a>.Flink;
00922 
00923                         <span class="keywordflow">while</span> (Links != &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o25">LbcbWorkque</a>) {
00924 
00925                             ThisLbcb = CONTAINING_RECORD( Links,
00926                                                           <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
00927                                                           WorkqueLinks );
00928 
00929                             <span class="comment">//</span>
00930                             <span class="comment">//  If this is not a restart area, we exit and remember that</span>
00931                             <span class="comment">//  we need to flush the restart areas.</span>
00932                             <span class="comment">//</span>
00933 
00934                             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d4/lfsprocs_8h.html#a20">LfsLbcbIsRestart</a>( ThisLbcb )) {
00935 
00936                                 FlushRestart = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00937                                 <span class="keywordflow">break</span>;
00938                             }
00939 
00940                             Links = Links-&gt;Flink;
00941                         }
00942 
00943                         <span class="comment">//</span>
00944                         <span class="comment">//  If we are still not to flush the restart areas remove</span>
00945                         <span class="comment">//  all of the restart areas from the queue.</span>
00946                         <span class="comment">//</span>
00947 
00948                         <span class="keywordflow">if</span> (!FlushRestart) {
00949 
00950                             <span class="keywordflow">while</span> (!IsListEmpty( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o25">LbcbWorkque</a>)) {
00951 
00952                                 ThisLbcb = CONTAINING_RECORD( Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o25">LbcbWorkque</a>.Blink,
00953                                                               <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
00954                                                               WorkqueLinks );
00955 
00956                                 RemoveEntryList( &amp;ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o2">WorkqueLinks</a> );
00957                                 <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a4">LfsDeallocateLbcb</a>( Lfcb, ThisLbcb );
00958                             }
00959                         }
00960 
00961                     } <span class="keywordflow">else</span> {
00962 
00963                         FlushRestart = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00964                     }
00965 
00966 <span class="preprocessor">#if 1</span>
00967 <span class="preprocessor"></span>                <span class="comment">//</span>
00968                 <span class="comment">//  We will have to flush the restart area in this case.</span>
00969                 <span class="comment">//</span>
00970 
00971                 } <span class="keywordflow">else</span> {
00972 
00973                     FlushRestart = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00974                 }
00975 <span class="preprocessor">#endif</span>
00976 <span class="preprocessor"></span>
00977                 <span class="comment">//</span>
00978                 <span class="comment">//  Flush the new restart area if we need to.</span>
00979                 <span class="comment">//</span>
00980 
00981                 <span class="keywordflow">if</span> (FlushRestart) {
00982 
00983                     <a class="code" href="../../d7/d0/rstrtsup_8c.html#a1">LfsWriteLfsRestart</a>( Lfcb, Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o34">RestartAreaSize</a>, FALSE );
00984                     <a class="code" href="../../d7/d0/rstrtsup_8c.html#a1">LfsWriteLfsRestart</a>( Lfcb, Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o34">RestartAreaSize</a>, TRUE );
00985                 }
00986 
00987                 <span class="comment">//</span>
00988                 <span class="comment">//  Clear the Lfcb pointer in the client handle.</span>
00989                 <span class="comment">//</span>
00990 
00991                 Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00992                 RemoveEntryList( &amp;Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o2">LchLinks</a> );
00993 
00994                 <span class="comment">//</span>
00995                 <span class="comment">//  If there are no active clients, we can remove this log file</span>
00996                 <span class="comment">//  control block from the active queue.</span>
00997                 <span class="comment">//</span>
00998 
00999 <span class="preprocessor">#if 1</span>
01000 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o30">RestartArea</a>-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o3">ClientInUseList</a> == <a class="code" href="../../d9/d3/lfsdisk_8h.html#a21">LFS_NO_CLIENT</a>) {
01001 <span class="preprocessor">#endif</span>
01002 <span class="preprocessor"></span>
01003                     RemoveEntryList( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o2">LfcbLinks</a> );
01004                     <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a2">LfsDeallocateLfcb</a>( Lfcb, FALSE );
01005 <span class="preprocessor">#if 1</span>
01006 <span class="preprocessor"></span>                }
01007 <span class="preprocessor">#endif</span>
01008 <span class="preprocessor"></span>
01009             try_exit:  NOTHING;
01010             } finally {
01011 
01012                 <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsCloseLogFile );
01013 
01014                 <span class="comment">//</span>
01015                 <span class="comment">//   Release the log file control block if held.</span>
01016                 <span class="comment">//</span>
01017 
01018                 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
01019 
01020                 <span class="comment">//</span>
01021                 <span class="comment">//  Release the global data block if held.</span>
01022                 <span class="comment">//</span>
01023 
01024                 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a22">LfsReleaseLfsData</a>();
01025 
01026                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsCloseLogFile:  Exit\n"</span>, 0 );
01027             }
01028 
01029         } except (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a56">LfsExceptionFilter</a>( GetExceptionInformation() )) {
01030 
01031             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01032         }
01033 
01034         <span class="comment">//</span>
01035         <span class="comment">//  Test if we want to exit the loop now.</span>
01036         <span class="comment">//</span>
01037 
01038         <span class="keywordflow">if</span> (ExitLoop) { <span class="keywordflow">break</span>; }
01039 
01040         <span class="comment">//</span>
01041         <span class="comment">//  Wait for the io to complete.</span>
01042         <span class="comment">//</span>
01043 
01044         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o59">Sync</a>-&gt;<a class="code" href="../../d2/d0/struct__LFCB__SYNC.html#o1">Event</a>,
01045                                Executive,
01046                                KernelMode,
01047                                FALSE,
01048                                NULL );
01049 
01050         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a28">LfsAcquireLfcb</a>( Lfcb );
01051         Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o60">Waiters</a> -= 1;
01052         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a29">LfsReleaseLfcb</a>( Lfcb );
01053     }
01054 
01055     <span class="comment">//</span>
01056     <span class="comment">//  We always let this operation succeed.</span>
01057     <span class="comment">//</span>
01058 
01059     <span class="keywordflow">return</span>;
01060 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="lfs/registry.c::LfsDeleteLogHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsDeleteLogHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LogHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01063">1063</a> of file <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html">lfs/registry.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02478">ExDeleteResource</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d6/lfs_2nodetype_8h-source.html#l00033">LFS_NTC_LCH</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00517">LfsAcquireLch</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00435">LfsDeallocateLch</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00058">LfsExceptionFilter()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00520">LfsReleaseLch</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00129">_LCH::NodeTypeCode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00091">_LFCB_SYNC::Resource</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00170">_LCH::Sync</a>, and <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00106">_LFCB_SYNC::UserCount</a>.
<p>
<pre class="fragment"><div>01069                    :
01070 
01071     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when a client <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> tearing down <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last of
01072     his volume structures.  There will be no more references to <span class="keyword">this</span>
01073     handle.  If <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last handle <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> then we will
01074     deallocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d9/d0/cmdata_8h.html#a104a98">Sync</a> structure as well.
01075 
01076 Arguments:
01077 
01078     LogHandle - Pointer to <span class="keyword">private</span> Lfs structure used to identify <span class="keyword">this</span>
01079                 client.
01080 
01081 Return Value:
01082 
01083     None
01084 
01085 --*/
01086 
01087 {
01088     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
01089 
01090     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01091 
01092     <span class="comment">//</span>
01093     <span class="comment">//  If the log handle is null then return immediately.</span>
01094     <span class="comment">//</span>
01095 
01096     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
01097 
01098     <span class="keywordflow">if</span> ((Lch == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01099         (Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o0">NodeTypeCode</a> != <a class="code" href="../../d0/d7/lfs_2nodetype_8h.html#a2">LFS_NTC_LCH</a>)) {
01100 
01101         <span class="keywordflow">return</span>;
01102     }
01103 
01104     <span class="comment">//</span>
01105     <span class="comment">//  Ignore all errors from now on.</span>
01106     <span class="comment">//</span>
01107 
01108     <span class="keywordflow">try</span> {
01109 
01110         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
01111 
01112         Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o7">Sync</a>-&gt;<a class="code" href="../../d2/d0/struct__LFCB__SYNC.html#o2">UserCount</a> -= 1;
01113 
01114         <span class="comment">//</span>
01115         <span class="comment">//  If we are the last user then deallocate the sync structure.</span>
01116         <span class="comment">//</span>
01117 
01118         <span class="keywordflow">if</span> (Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o7">Sync</a>-&gt;<a class="code" href="../../d2/d0/struct__LFCB__SYNC.html#o2">UserCount</a> == 0) {
01119 
01120             <a class="code" href="../../d5/d8/ex_8h.html#a73">ExDeleteResource</a>( &amp;Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o7">Sync</a>-&gt;<a class="code" href="../../d2/d0/struct__LFCB__SYNC.html#o0">Resource</a> );
01121 
01122             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o7">Sync</a> );
01123 
01124         } <span class="keywordflow">else</span> {
01125 
01126             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
01127         }
01128 
01129         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a17">LfsDeallocateLch</a>( Lch );
01130 
01131     } except (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a56">LfsExceptionFilter</a>( GetExceptionInformation() )) {
01132 
01133         NOTHING;
01134     }
01135 
01136     <span class="keywordflow">return</span>;
01137 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="lfs/registry.c::LfsFindLastLsn" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsFindLastLsn           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Lfcb</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l03193">3193</a> of file <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html">lfs/registry.c</a>.
<p>
References <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01000">CcUnpinData()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o3">_LFS_RECORD_PAGE_HEADER::Copy</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o9">_LFS_RECORD_PAGE_HEADER::Header</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00599">LFCB_LOG_WRAPPED</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00601">LFCB_NO_LAST_LSN</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00602">LFCB_PACK_LOG</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00603">LFCB_REUSE_TAIL</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00343">LFS_SIGNATURE_BAD_USA_ULONG</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00341">LFS_SIGNATURE_RECORD_PAGE_ULONG</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l04188">LfsCheckSubsequentLogPage()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l03193">LfsFindLastLsn()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l04321">LfsFlushLogPage()</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00039">LfsLi0</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00305">LfsLsnToSeqNumber</a>, <a class="el" href="../../d7/d4/logpgsup_8c-source.html#l00040">LfsNextLogPageOffset()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00084">LfsPinOrMapData()</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00253">LOG_PAGE_LOG_RECORD_END</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00140">LSN</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00201">_LFS_RECORD_PAGE_HEADER::MultiSectorHeader</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00514">RESTART_SINGLE_PAGE_IO</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00090">_MULTI_SECTOR_HEADER::Signature</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l03193">LfsFindLastLsn()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01534">LfsRestartLogFile()</a>.
<p>
<pre class="fragment"><div>03199                    :
03200 
03201     This routine walks through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log pages <span class="keywordflow">for</span> a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>, searching <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03202     last log page written to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  It updates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfcb and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current
03203     restart area as well.
03204 
03205     We proceed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following manner.
03206 
03207         1 - Walk through and find all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log pages successfully
03208             flushed to disk.  This search terminates when either we find
03209             an error or when we find a previous page on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk.
03210 
03211         2 - For <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error <span class="keywordflow">case</span> above, we want to insure that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error found
03212             was due to a system crash and that there are no complete I/O
03213             transfers after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bad region.
03214 
03215         3 - We will look at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> 2 pages with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tail copies <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
03216             <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> packed to check on pages with errors.
03217 
03218     At <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <span class="keyword">this</span> routine we will repair <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> by copying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tail
03219     copies back to their correct location in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
03220 
03221 Arguments:
03222 
03223     Lfcb - Log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block <span class="keywordflow">for</span> <span class="keyword">this</span> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
03224 
03225 Return Value:
03226 
03227     None.
03228 
03229 --*/
03230 
03231 {
03232     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> PageCount;
03233     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> PagePosition;
03234 
03235     LONGLONG CurrentLogPageOffset;
03236     LONGLONG NextLogPageOffset;
03237 
03238     <a class="code" href="../../d6/d3/lfs_8h.html#a10">LSN</a> LastKnownLsn;
03239 
03240     BOOLEAN Wrapped;
03241     BOOLEAN WrappedLogFile = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03242 
03243     LONGLONG ExpectedSeqNumber;
03244 
03245     LONGLONG FirstPartialIo;
03246     ULONG PartialIoCount = 0;
03247 
03248     <a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html">PLFS_RECORD_PAGE_HEADER</a> LogPageHeader;
03249     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> LogPageHeaderBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03250 
03251     <a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html">PLFS_RECORD_PAGE_HEADER</a> TestPageHeader;
03252     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> TestPageHeaderBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03253 
03254     LONGLONG FirstTailFileOffset;
03255     <a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html">PLFS_RECORD_PAGE_HEADER</a> FirstTailPage;
03256     LONGLONG FirstTailOffset = 0;
03257     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> FirstTailPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03258 
03259     LONGLONG SecondTailFileOffset;
03260     <a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html">PLFS_RECORD_PAGE_HEADER</a> SecondTailPage;
03261     LONGLONG SecondTailOffset = 0;
03262     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> SecondTailPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03263 
03264     <a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html">PLFS_RECORD_PAGE_HEADER</a> TailPage;
03265 
03266     BOOLEAN UsaError;
03267     BOOLEAN ReplacePage = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03268     BOOLEAN ValidFile = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03269 
03270     BOOLEAN InitialReusePage = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03271 
03272     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03273 
03274     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03275 
03276     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsFindLastLsn:  Entered\n"</span>, 0 );
03277     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lfcb  -&gt; %08lx\n"</span>, Lfcb );
03278 
03279     <span class="comment">//</span>
03280     <span class="comment">//  The page count and page position are from the last page</span>
03281     <span class="comment">//  sucessfully read.  Initialize these to indicate the</span>
03282     <span class="comment">//  'previous' transfer was complete.</span>
03283     <span class="comment">//</span>
03284 
03285     PageCount = 1;
03286     PagePosition = 1;
03287 
03288     <span class="comment">//</span>
03289     <span class="comment">//  We have the current Lsn in the restart area.  This is the last</span>
03290     <span class="comment">//  Lsn on a log page.  We compute the next file offset and sequence</span>
03291     <span class="comment">//  number.</span>
03292     <span class="comment">//</span>
03293 
03294     CurrentLogPageOffset = Lfcb-&gt;NextLogPage;
03295 
03296     <span class="comment">//</span>
03297     <span class="comment">//  If the next log page is the first log page in the file and</span>
03298     <span class="comment">//  the last Lsn represented a log record, then remember that we</span>
03299     <span class="comment">//  have wrapped in the log file.</span>
03300     <span class="comment">//</span>
03301 
03302     <span class="keywordflow">if</span> (( CurrentLogPageOffset == Lfcb-&gt;FirstLogPage )
03303         &amp;&amp; !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_NO_LAST_LSN | LFCB_REUSE_TAIL )) {
03304 
03305         ExpectedSeqNumber = Lfcb-&gt;SeqNumber + 1;
03306         WrappedLogFile = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03307 
03308     } <span class="keywordflow">else</span> {
03309 
03310         ExpectedSeqNumber = Lfcb-&gt;SeqNumber;
03311     }
03312 
03313     <span class="comment">//</span>
03314     <span class="comment">//  If we are going to try to reuse the tail of the last known</span>
03315     <span class="comment">//  page, then remember the last Lsn on this page.</span>
03316     <span class="comment">//</span>
03317 
03318     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_REUSE_TAIL )) {
03319 
03320         LastKnownLsn = Lfcb-&gt;LastFlushedLsn;
03321 
03322         <span class="comment">//</span>
03323         <span class="comment">//  There are some special conditions allowed for this page when</span>
03324         <span class="comment">//  we read it.  It could be either the first or last of the transfer.</span>
03325         <span class="comment">//  It may also have a tail copy.</span>
03326         <span class="comment">//</span>
03327 
03328         InitialReusePage = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03329 
03330     } <span class="keywordflow">else</span> {
03331 
03332         LastKnownLsn = <a class="code" href="../../d7/d3/lfsdata_8c.html#a2">LfsLi0</a>;
03333     }
03334 
03335     <span class="comment">//</span>
03336     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
03337     <span class="comment">//</span>
03338 
03339     <span class="keywordflow">try</span> {
03340 
03341         <span class="comment">//</span>
03342         <span class="comment">//  If this is a packed log file, let's pin the two tail copy pages.</span>
03343         <span class="comment">//</span>
03344 
03345         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_PACK_LOG )) {
03346 
03347             <span class="comment">//</span>
03348             <span class="comment">//  Start with the second page.</span>
03349             <span class="comment">//</span>
03350 
03351             SecondTailFileOffset = Lfcb-&gt;FirstLogPage - Lfcb-&gt;LogPageSize;
03352 
03353             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d4/lfsprocs_8h.html#a48">LfsPinOrMapData</a>( Lfcb,
03354                                              SecondTailFileOffset,
03355                                              (ULONG)Lfcb-&gt;LogPageSize,
03356                                              TRUE,
03357                                              TRUE,
03358                                              TRUE,
03359                                              &amp;UsaError,
03360                                              &amp;SecondTailPage,
03361                                              &amp;SecondTailPageBcb ))) {
03362 
03363                 <span class="comment">//</span>
03364                 <span class="comment">//  If this isn't a valid page then ignore it.</span>
03365                 <span class="comment">//</span>
03366 
03367                 <span class="keywordflow">if</span> (UsaError
03368                     || *((PULONG) &amp;SecondTailPage-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o0">MultiSectorHeader</a>.<a class="code" href="../../d2/d1/struct__MULTI__SECTOR__HEADER.html#o0">Signature</a>) != <a class="code" href="../../d9/d3/lfsdisk_8h.html#a14">LFS_SIGNATURE_RECORD_PAGE_ULONG</a>) {
03369 
03370                     <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( SecondTailPageBcb );
03371                     SecondTailPageBcb = SecondTailPage = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03372 
03373                 } <span class="keywordflow">else</span> {
03374 
03375                     SecondTailOffset = SecondTailPage-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o3">Copy</a>.FileOffset;
03376                 }
03377 
03378             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (SecondTailPageBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03379 
03380                 <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( SecondTailPageBcb );
03381                 SecondTailPageBcb = SecondTailPage = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03382             }
03383 
03384             FirstTailFileOffset = SecondTailFileOffset - Lfcb-&gt;LogPageSize;
03385 
03386             <span class="comment">//</span>
03387             <span class="comment">//  Now try the first.</span>
03388             <span class="comment">//</span>
03389 
03390             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d4/lfsprocs_8h.html#a48">LfsPinOrMapData</a>( Lfcb,
03391                                              FirstTailFileOffset,
03392                                              (ULONG)Lfcb-&gt;LogPageSize,
03393                                              TRUE,
03394                                              TRUE,
03395                                              TRUE,
03396                                              &amp;UsaError,
03397                                              &amp;FirstTailPage,
03398                                              &amp;FirstTailPageBcb ))) {
03399 
03400                 <span class="comment">//</span>
03401                 <span class="comment">//  If this isn't a valid page then ignore it.</span>
03402                 <span class="comment">//</span>
03403 
03404                 <span class="keywordflow">if</span> (UsaError
03405                     || *((PULONG) &amp;FirstTailPage-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o0">MultiSectorHeader</a>.<a class="code" href="../../d2/d1/struct__MULTI__SECTOR__HEADER.html#o0">Signature</a>) != <a class="code" href="../../d9/d3/lfsdisk_8h.html#a14">LFS_SIGNATURE_RECORD_PAGE_ULONG</a>) {
03406 
03407                     <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( FirstTailPageBcb );
03408                     FirstTailPageBcb = FirstTailPage = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03409 
03410                 } <span class="keywordflow">else</span> {
03411 
03412                     FirstTailOffset = FirstTailPage-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o3">Copy</a>.FileOffset;
03413                 }
03414 
03415             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FirstTailPageBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03416 
03417                 <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( FirstTailPageBcb );
03418                 FirstTailPageBcb = FirstTailPage = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03419             }
03420         }
03421 
03422         <span class="comment">//</span>
03423         <span class="comment">//  We continue walking through the file, log page by log page looking</span>
03424         <span class="comment">//  for the end of the data transferred.  The loop below looks for</span>
03425         <span class="comment">//  a log page which contains the end of a log record.  Each time a</span>
03426         <span class="comment">//  log record is successfully read from the disk, we update our in-memory</span>
03427         <span class="comment">//  structures to reflect this.  We exit this loop when we are at a point</span>
03428         <span class="comment">//  where we don't want to find any subsequent pages.  This occurs when</span>
03429         <span class="comment">//</span>
03430         <span class="comment">//      - we get an I/O error reading a page</span>
03431         <span class="comment">//      - we get a Usa error reading a page</span>
03432         <span class="comment">//      - we have a tail copy with more recent data than contained on the page</span>
03433         <span class="comment">//</span>
03434 
03435         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03436 
03437             LONGLONG ActualSeqNumber;
03438             TailPage = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03439 
03440             <span class="comment">//</span>
03441             <span class="comment">//  Pin the next log page, allowing errors.</span>
03442             <span class="comment">//</span>
03443 
03444             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a48">LfsPinOrMapData</a>( Lfcb,
03445                                       CurrentLogPageOffset,
03446                                       (ULONG)Lfcb-&gt;LogPageSize,
03447                                       TRUE,
03448                                       TRUE,
03449                                       TRUE,
03450                                       &amp;UsaError,
03451                                       (PVOID *) &amp;LogPageHeader,
03452                                       &amp;LogPageHeaderBcb );
03453 
03454             <span class="comment">//</span>
03455             <span class="comment">//  Compute the next log page offset in the file.</span>
03456             <span class="comment">//</span>
03457 
03458             <a class="code" href="../../d6/d5/logpgsup_8c.html#a2">LfsNextLogPageOffset</a>( Lfcb,
03459                                   CurrentLogPageOffset,
03460                                   &amp;NextLogPageOffset,
03461                                   &amp;Wrapped );
03462 
03463             <span class="comment">//</span>
03464             <span class="comment">//  If we are at the expected first page of a transfer</span>
03465             <span class="comment">//  check to see if either tail copy is at this offset.</span>
03466             <span class="comment">//  If this page is the last page of a transfer, check</span>
03467             <span class="comment">//  if we wrote a subsequent tail copy.</span>
03468             <span class="comment">//</span>
03469 
03470             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_PACK_LOG ) &amp;&amp;
03471                 ((PageCount == PagePosition) ||
03472                  (PageCount == PagePosition + 1))) {
03473 
03474                 <span class="comment">//</span>
03475                 <span class="comment">//  Check if the offset matches either the first or second</span>
03476                 <span class="comment">//  tail copy.  It is possible it will match both.</span>
03477                 <span class="comment">//</span>
03478 
03479                 <span class="keywordflow">if</span> (CurrentLogPageOffset == FirstTailOffset) {
03480 
03481                     TailPage = FirstTailPage;
03482                 }
03483 
03484                 <span class="keywordflow">if</span> (CurrentLogPageOffset == SecondTailOffset) {
03485 
03486                     <span class="comment">//</span>
03487                     <span class="comment">//  If we already matched on the first page then</span>
03488                     <span class="comment">//  check the ending Lsn's.</span>
03489                     <span class="comment">//</span>
03490 
03491                     <span class="keywordflow">if</span> ((TailPage == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
03492                         (SecondTailPage-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o9">Header</a>.Packed.LastEndLsn.QuadPart &gt;
03493                          FirstTailPage-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o9">Header</a>.Packed.LastEndLsn.QuadPart )) {
03494 
03495                         TailPage = SecondTailPage;
03496                     }
03497                 }
03498 
03499                 <span class="comment">//</span>
03500                 <span class="comment">//  If we have a candidate for a tail copy, check and see if it is</span>
03501                 <span class="comment">//  in the expected pass through the file.  For that to be true we</span>
03502                 <span class="comment">//  must be at the first page of an I/O block. Also the last Lsn on the</span>
03503                 <span class="comment">//  copy page must match the last known flushed Lsn or the sequence</span>
03504                 <span class="comment">//  number on the page must be the expected sequence number.</span>
03505                 <span class="comment">//</span>
03506 
03507                 <span class="keywordflow">if</span> (TailPage) {
03508 
03509                     <span class="keywordflow">if</span> (LastKnownLsn.QuadPart &lt; TailPage-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o9">Header</a>.Packed.LastEndLsn.QuadPart) {
03510 
03511                         ActualSeqNumber = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a13">LfsLsnToSeqNumber</a>( Lfcb, TailPage-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o9">Header</a>.Packed.LastEndLsn );
03512 
03513                         <span class="comment">//</span>
03514                         <span class="comment">//  If the sequence number is not expected, then don't use the tail</span>
03515                         <span class="comment">//  copy.</span>
03516                         <span class="comment">//</span>
03517 
03518                         <span class="keywordflow">if</span> (ExpectedSeqNumber != ActualSeqNumber) {
03519 
03520                             TailPage = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03521                         }
03522 
03523                     <span class="comment">//</span>
03524                     <span class="comment">//  If the last Lsn is greater than the one on this page</span>
03525                     <span class="comment">//  then forget this tail.</span>
03526                     <span class="comment">//</span>
03527 
03528                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (LastKnownLsn.QuadPart &gt; TailPage-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o9">Header</a>.Packed.LastEndLsn.QuadPart) {
03529 
03530                         TailPage = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03531                     }
03532                 }
03533             }
03534 
03535             <span class="comment">//</span>
03536             <span class="comment">//  If we have an error on the current page, we will break out of</span>
03537             <span class="comment">//  this loop.</span>
03538             <span class="comment">//</span>
03539 
03540             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) || UsaError) {
03541 
03542                 <span class="keywordflow">break</span>;
03543             }
03544 
03545             <span class="comment">//</span>
03546             <span class="comment">//  If the last Lsn on this page doesn't match the previous</span>
03547             <span class="comment">//  known last Lsn or the sequence number is not expected</span>
03548             <span class="comment">//  we are done.</span>
03549             <span class="comment">//</span>
03550 
03551             ActualSeqNumber = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a13">LfsLsnToSeqNumber</a>( Lfcb,
03552                                                  LogPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o3">Copy</a>.LastLsn );
03553 
03554             <span class="keywordflow">if</span> ((LastKnownLsn.QuadPart != LogPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o3">Copy</a>.LastLsn.QuadPart) &amp;&amp;
03555                 (ActualSeqNumber != ExpectedSeqNumber)) {
03556 
03557                 <span class="keywordflow">break</span>;
03558             }
03559 
03560             <span class="comment">//</span>
03561             <span class="comment">//  Check that the page position and page count values are correct.</span>
03562             <span class="comment">//  If this is the first page of a transfer the position must be</span>
03563             <span class="comment">//  1 and the count will be unknown.</span>
03564             <span class="comment">//</span>
03565 
03566             <span class="keywordflow">if</span> (PageCount == PagePosition) {
03567 
03568                 <span class="comment">//</span>
03569                 <span class="comment">//  If the current page is the first page we are looking at</span>
03570                 <span class="comment">//  and we are reusing this page then it can be either the</span>
03571                 <span class="comment">//  first or last page of a transfer.  Otherwise it can only</span>
03572                 <span class="comment">//  be the first.</span>
03573                 <span class="comment">//</span>
03574 
03575                 <span class="keywordflow">if</span> ((LogPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o6">PagePosition</a> != 1) &amp;&amp;
03576                     (!InitialReusePage ||
03577                      (LogPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o6">PagePosition</a> != LogPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o5">PageCount</a>))) {
03578 
03579                     <span class="keywordflow">break</span>;
03580                 }
03581 
03582             <span class="comment">//</span>
03583             <span class="comment">//  The page position better be 1 more than the last page position</span>
03584             <span class="comment">//  and the page count better match.</span>
03585             <span class="comment">//</span>
03586 
03587             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((LogPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o5">PageCount</a> != PageCount) ||
03588                        (LogPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o6">PagePosition</a> != PagePosition + 1)) {
03589 
03590                 <span class="keywordflow">break</span>;
03591             }
03592 
03593             <span class="comment">//</span>
03594             <span class="comment">//  We have a valid page in the file and may have a valid page in</span>
03595             <span class="comment">//  the tail copy area.  If the tail page was written after</span>
03596             <span class="comment">//  the page in the file then break out of the loop.</span>
03597             <span class="comment">//</span>
03598 
03599             <span class="keywordflow">if</span> (TailPage &amp;&amp;
03600                 (TailPage-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o9">Header</a>.Packed.LastEndLsn.QuadPart &gt;= LogPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o3">Copy</a>.LastLsn.QuadPart)) {
03601 
03602                 <span class="comment">//</span>
03603                 <span class="comment">//  Remember if we will replace the page.</span>
03604                 <span class="comment">//</span>
03605 
03606                 ReplacePage = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03607                 <span class="keywordflow">break</span>;
03608             }
03609 
03610             TailPage = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03611 
03612             <span class="comment">//</span>
03613             <span class="comment">//  The log page is expected.  If this contains the end of</span>
03614             <span class="comment">//  some log record we can update some fields in the Lfcb.</span>
03615             <span class="comment">//</span>
03616 
03617             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( LogPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o4">Flags</a>, LOG_PAGE_LOG_RECORD_END )) {
03618 
03619                 <span class="comment">//</span>
03620                 <span class="comment">//  Since we have read this page we know the Lfcb sequence</span>
03621                 <span class="comment">//  number is the same as our expected value.  We also</span>
03622                 <span class="comment">//  assume we will not reuse the tail.</span>
03623                 <span class="comment">//</span>
03624 
03625                 Lfcb-&gt;SeqNumber = ExpectedSeqNumber;
03626                 <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Lfcb-&gt;Flags, LFCB_REUSE_TAIL );
03627 
03628                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_PACK_LOG )) {
03629 
03630                     Lfcb-&gt;LastFlushedLsn = LogPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o9">Header</a>.Packed.LastEndLsn;
03631 
03632                     <span class="comment">//</span>
03633                     <span class="comment">//  If there is room on this page for another header then</span>
03634                     <span class="comment">//  remember we want to reuse the page.</span>
03635                     <span class="comment">//</span>
03636 
03637                     <span class="keywordflow">if</span> (Lfcb-&gt;RecordHeaderLength &lt;=
03638                         ((ULONG)Lfcb-&gt;LogPageSize - LogPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o9">Header</a>.Packed.NextRecordOffset )) {
03639 
03640                         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Lfcb-&gt;Flags, LFCB_REUSE_TAIL );
03641                         Lfcb-&gt;ReusePageOffset = LogPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o9">Header</a>.Packed.NextRecordOffset;
03642                     }
03643 
03644                 } <span class="keywordflow">else</span> {
03645 
03646                     Lfcb-&gt;LastFlushedLsn = LogPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o3">Copy</a>.LastLsn;
03647                 }
03648 
03649                 Lfcb-&gt;RestartArea-&gt;CurrentLsn = Lfcb-&gt;LastFlushedLsn;
03650 
03651                 <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Lfcb-&gt;Flags, LFCB_NO_LAST_LSN );
03652 
03653                 <span class="comment">//</span>
03654                 <span class="comment">//  If we may try to reuse the current page then use</span>
03655                 <span class="comment">//  that as the next page offset.  Otherwise move to the</span>
03656                 <span class="comment">//  next page in the file.</span>
03657                 <span class="comment">//</span>
03658 
03659                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_REUSE_TAIL )) {
03660 
03661                     Lfcb-&gt;NextLogPage = CurrentLogPageOffset;
03662 
03663                 } <span class="keywordflow">else</span> {
03664 
03665                     Lfcb-&gt;NextLogPage = NextLogPageOffset;
03666                 }
03667 
03668                 <span class="comment">//</span>
03669                 <span class="comment">//  If we wrapped the log file, then we set the bit indicating so.</span>
03670                 <span class="comment">//</span>
03671 
03672                 <span class="keywordflow">if</span> (WrappedLogFile) {
03673 
03674                     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Lfcb-&gt;Flags, LFCB_LOG_WRAPPED );
03675                 }
03676             }
03677 
03678             <span class="comment">//</span>
03679             <span class="comment">//  Remember the last page count and position.  Also remember</span>
03680             <span class="comment">//  the last known lsn.</span>
03681             <span class="comment">//</span>
03682 
03683             PageCount = LogPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o5">PageCount</a>;
03684             PagePosition = LogPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o6">PagePosition</a>;
03685             LastKnownLsn = LogPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o3">Copy</a>.LastLsn;
03686 
03687             <span class="comment">//</span>
03688             <span class="comment">//  If we are wrapping to the beginning of the file then update</span>
03689             <span class="comment">//  the expected sequence number.</span>
03690             <span class="comment">//</span>
03691 
03692             <span class="keywordflow">if</span> (Wrapped) {
03693 
03694                 ExpectedSeqNumber = ExpectedSeqNumber + 1;
03695                 WrappedLogFile = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03696             }
03697 
03698             CurrentLogPageOffset = NextLogPageOffset;
03699 
03700             <span class="comment">//</span>
03701             <span class="comment">//  Unpin the last log page pinned.</span>
03702             <span class="comment">//</span>
03703 
03704             <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( LogPageHeaderBcb );
03705             LogPageHeaderBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03706 
03707             InitialReusePage = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03708         }
03709 
03710         <span class="comment">//</span>
03711         <span class="comment">//  At this point we expect that there will be no more new pages in</span>
03712         <span class="comment">//  the log file.  We could have had an error of some sort on the most recent</span>
03713         <span class="comment">//  page or we may have found a tail copy for the current page.</span>
03714         <span class="comment">//  If the error occurred on the last Io to the file then</span>
03715         <span class="comment">//  this log file is useful.  Otherwise the log file can't be used.</span>
03716         <span class="comment">//</span>
03717 
03718         <span class="comment">//</span>
03719         <span class="comment">//  If we have a tail copy page then update the values in the</span>
03720         <span class="comment">//  Lfcb and restart area.</span>
03721         <span class="comment">//</span>
03722 
03723         <span class="keywordflow">if</span> (TailPage != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03724 
03725             <span class="comment">//</span>
03726             <span class="comment">//  Since we have read this page we know the Lfcb sequence</span>
03727             <span class="comment">//  number is the same as our expected value.</span>
03728             <span class="comment">//</span>
03729 
03730             Lfcb-&gt;SeqNumber = ExpectedSeqNumber;
03731 
03732             Lfcb-&gt;LastFlushedLsn = TailPage-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o9">Header</a>.Packed.LastEndLsn;
03733 
03734             Lfcb-&gt;RestartArea-&gt;CurrentLsn = Lfcb-&gt;LastFlushedLsn;
03735 
03736             <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Lfcb-&gt;Flags, LFCB_NO_LAST_LSN );
03737 
03738             <span class="comment">//</span>
03739             <span class="comment">//  If there is room on this page for another header then</span>
03740             <span class="comment">//  remember we want to reuse the page.</span>
03741             <span class="comment">//</span>
03742 
03743             <span class="keywordflow">if</span> (((ULONG)Lfcb-&gt;LogPageSize - TailPage-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o9">Header</a>.Packed.NextRecordOffset )
03744                 &gt;= Lfcb-&gt;RecordHeaderLength) {
03745 
03746                 <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Lfcb-&gt;Flags, LFCB_REUSE_TAIL );
03747                 Lfcb-&gt;NextLogPage = CurrentLogPageOffset;
03748                 Lfcb-&gt;ReusePageOffset = TailPage-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o9">Header</a>.Packed.NextRecordOffset;
03749 
03750             } <span class="keywordflow">else</span> {
03751 
03752                 <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Lfcb-&gt;Flags, LFCB_REUSE_TAIL );
03753                 Lfcb-&gt;NextLogPage = NextLogPageOffset;
03754             }
03755 
03756             <span class="comment">//</span>
03757             <span class="comment">//  If we wrapped the log file, then we set the bit indicating so.</span>
03758             <span class="comment">//</span>
03759 
03760             <span class="keywordflow">if</span> (WrappedLogFile) {
03761 
03762                 <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Lfcb-&gt;Flags, LFCB_LOG_WRAPPED );
03763             }
03764         }
03765 
03766         <span class="comment">//</span>
03767         <span class="comment">//  Remember that the partial IO will start at the next page.</span>
03768         <span class="comment">//</span>
03769 
03770         FirstPartialIo = NextLogPageOffset;
03771 
03772         <span class="comment">//</span>
03773         <span class="comment">//  If the next page is the first page of the file then update</span>
03774         <span class="comment">//  the sequence number for log records which begin on the next</span>
03775         <span class="comment">//  page.</span>
03776         <span class="comment">//</span>
03777 
03778         <span class="keywordflow">if</span> (Wrapped) {
03779 
03780             ExpectedSeqNumber = ExpectedSeqNumber + 1;
03781         }
03782 
03783         <span class="comment">//</span>
03784         <span class="comment">//  If we know the length of the transfer containing the page we stopped</span>
03785         <span class="comment">//  on we can just go to the page following the transfer and check</span>
03786         <span class="comment">//  the sequence number.  If we replaced the page then we have already</span>
03787         <span class="comment">//  modified the numbers.  If we know that only single pages were written</span>
03788         <span class="comment">//  to disk then we will munge the numbers now.  If we were in the</span>
03789         <span class="comment">//  middle of a multi-page I/O then the numbers are already set up.</span>
03790         <span class="comment">//</span>
03791 
03792         <span class="comment">//</span>
03793         <span class="comment">//  If we have a tail copy or are performing single page I/O</span>
03794         <span class="comment">//  we can immediately look at the next page.</span>
03795         <span class="comment">//</span>
03796 
03797         <span class="keywordflow">if</span> (ReplacePage ||
03798             <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;RestartArea-&gt;Flags, RESTART_SINGLE_PAGE_IO )) {
03799 
03800             <span class="comment">//</span>
03801             <span class="comment">//  Fudge the counts to show that we don't need swallow any pages.</span>
03802             <span class="comment">//</span>
03803 
03804             PageCount = 2;
03805             PagePosition = 1;
03806 
03807         <span class="comment">//</span>
03808         <span class="comment">//  If the counts match it means the current page should be the first</span>
03809         <span class="comment">//  page of a transfer.  We need to walk forward enough to guarantee</span>
03810         <span class="comment">//  that there was no subsequent transfer that made it out to disk.</span>
03811         <span class="comment">//</span>
03812 
03813         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PagePosition == PageCount) {
03814 
03815             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> CurrentPosition;
03816 
03817             <span class="comment">//</span>
03818             <span class="comment">//  If the next page causes us to wrap to the beginning of the log</span>
03819             <span class="comment">//  file then we know which page to check next.</span>
03820             <span class="comment">//</span>
03821 
03822             <span class="keywordflow">if</span> (Wrapped) {
03823 
03824                 <span class="comment">//</span>
03825                 <span class="comment">//  Fudge the counts to show that we don't need swallow any pages.</span>
03826                 <span class="comment">//</span>
03827 
03828                 PageCount = 2;
03829                 PagePosition = 1;
03830 
03831             <span class="comment">//</span>
03832             <span class="comment">//  Walk forward looking for a page which is from a different IO transfer</span>
03833             <span class="comment">//  from the page we failed on.</span>
03834             <span class="comment">//</span>
03835 
03836             } <span class="keywordflow">else</span> {
03837 
03838                 <span class="comment">//</span>
03839                 <span class="comment">//  We need to find a log page we know is not part of the log</span>
03840                 <span class="comment">//  page which caused the original error.</span>
03841                 <span class="comment">//</span>
03842                 <span class="comment">//  Maintain the count within the current transfer.</span>
03843                 <span class="comment">//</span>
03844 
03845                 CurrentPosition = 2;
03846 
03847                 <span class="keywordflow">do</span> {
03848 
03849                     <span class="comment">//</span>
03850                     <span class="comment">//  We walk through the file, reading log pages.  If we find</span>
03851                     <span class="comment">//  a readable log page that must lie in a subsequent Io block,</span>
03852                     <span class="comment">//  we exit.</span>
03853                     <span class="comment">//</span>
03854 
03855                     <span class="keywordflow">if</span> (TestPageHeaderBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03856 
03857                         <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( TestPageHeaderBcb );
03858                         TestPageHeaderBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03859                     }
03860 
03861                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a48">LfsPinOrMapData</a>( Lfcb,
03862                                               NextLogPageOffset,
03863                                               (ULONG)Lfcb-&gt;LogPageSize,
03864                                               TRUE,
03865                                               TRUE,
03866                                               TRUE,
03867                                               &amp;UsaError,
03868                                               (PVOID *) &amp;TestPageHeader,
03869                                               &amp;TestPageHeaderBcb );
03870 
03871                     <span class="comment">//</span>
03872                     <span class="comment">//  If we get a USA error then assume that we correctly</span>
03873                     <span class="comment">//  found the end of the original transfer.</span>
03874                     <span class="comment">//</span>
03875 
03876                     <span class="keywordflow">if</span> (UsaError) {
03877 
03878                         ValidFile = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03879                         <span class="keywordflow">break</span>;
03880 
03881                     <span class="comment">//</span>
03882                     <span class="comment">//  If we were able to read the page, we examine it to see</span>
03883                     <span class="comment">//  if it is in the same or different Io block.</span>
03884                     <span class="comment">//</span>
03885 
03886                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
03887 
03888                         <span class="comment">//</span>
03889                         <span class="comment">//  If this page is part of the error causing I/O, we will</span>
03890                         <span class="comment">//  use the transfer length to determine the page to</span>
03891                         <span class="comment">//  read for a subsequent error.</span>
03892                         <span class="comment">//</span>
03893 
03894                         <span class="keywordflow">if</span> (TestPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o6">PagePosition</a> == CurrentPosition
03895                             &amp;&amp; <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a9">LfsCheckSubsequentLogPage</a>( Lfcb,
03896                                                           TestPageHeader,
03897                                                           NextLogPageOffset,
03898                                                           ExpectedSeqNumber )) {
03899 
03900                             PageCount = TestPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o5">PageCount</a> + 1;
03901                             PagePosition = TestPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o6">PagePosition</a>;
03902 
03903                             <span class="keywordflow">break</span>;
03904 
03905                         <span class="comment">//</span>
03906                         <span class="comment">//  We found know the Io causing the error didn't</span>
03907                         <span class="comment">//  complete.  So we have no more checks to do.</span>
03908                         <span class="comment">//</span>
03909 
03910                         } <span class="keywordflow">else</span> {
03911 
03912                             ValidFile = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03913                             <span class="keywordflow">break</span>;
03914                         }
03915 
03916                     <span class="comment">//</span>
03917                     <span class="comment">//  Try the next page.</span>
03918                     <span class="comment">//</span>
03919 
03920                     } <span class="keywordflow">else</span> {
03921 
03922                         <span class="comment">//</span>
03923                         <span class="comment">//  Move to the next log page.</span>
03924                         <span class="comment">//</span>
03925 
03926                         <a class="code" href="../../d6/d5/logpgsup_8c.html#a2">LfsNextLogPageOffset</a>( Lfcb,
03927                                               NextLogPageOffset,
03928                                               &amp;NextLogPageOffset,
03929                                               &amp;Wrapped );
03930 
03931                         <span class="comment">//</span>
03932                         <span class="comment">//  If the file wrapped then initialize the page count</span>
03933                         <span class="comment">//  and position so that we will not skip over any</span>
03934                         <span class="comment">//  pages in the final verification below.</span>
03935                         <span class="comment">//</span>
03936 
03937                         <span class="keywordflow">if</span> (Wrapped) {
03938 
03939                             ExpectedSeqNumber = ExpectedSeqNumber + 1;
03940 
03941                             PageCount = 2;
03942                             PagePosition = 1;
03943                         }
03944 
03945                         CurrentPosition += 1;
03946                     }
03947 
03948                     <span class="comment">//</span>
03949                     <span class="comment">//  This is one more page we will want to uninitialize.</span>
03950                     <span class="comment">//</span>
03951 
03952                     PartialIoCount += 1;
03953 
03954                 } <span class="keywordflow">while</span>( !Wrapped );
03955             }
03956         }
03957 
03958         <span class="comment">//</span>
03959         <span class="comment">//  If we are unsure whether the file is valid then we will have</span>
03960         <span class="comment">//  the count and position in the current transfer.  We will walk through</span>
03961         <span class="comment">//  this transfer and read the subsequent page.</span>
03962         <span class="comment">//</span>
03963 
03964         <span class="keywordflow">if</span> (!ValidFile) {
03965 
03966             ULONG RemainingPages;
03967 
03968             <span class="comment">//</span>
03969             <span class="comment">//  Skip over the remaining pages in this transfer.</span>
03970             <span class="comment">//</span>
03971 
03972             RemainingPages = (PageCount - PagePosition) - 1;
03973 
03974             PartialIoCount += RemainingPages;
03975 
03976             <span class="keywordflow">while</span> (RemainingPages--) {
03977 
03978                 <a class="code" href="../../d6/d5/logpgsup_8c.html#a2">LfsNextLogPageOffset</a>( Lfcb,
03979                                       NextLogPageOffset,
03980                                       &amp;NextLogPageOffset,
03981                                       &amp;Wrapped );
03982 
03983                 <span class="keywordflow">if</span> (Wrapped) {
03984 
03985                     ExpectedSeqNumber = ExpectedSeqNumber + 1;
03986                 }
03987             }
03988 
03989             <span class="comment">//</span>
03990             <span class="comment">//  Call our routine to check this log page.</span>
03991             <span class="comment">//</span>
03992 
03993             <span class="keywordflow">if</span> (TestPageHeaderBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03994 
03995                 <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( TestPageHeaderBcb );
03996                 TestPageHeaderBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03997             }
03998 
03999             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a48">LfsPinOrMapData</a>( Lfcb,
04000                                       NextLogPageOffset,
04001                                       (ULONG)Lfcb-&gt;LogPageSize,
04002                                       TRUE,
04003                                       TRUE,
04004                                       TRUE,
04005                                       &amp;UsaError,
04006                                       (PVOID *) &amp;TestPageHeader,
04007                                       &amp;TestPageHeaderBcb );
04008 
04009             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )
04010                 &amp;&amp; !UsaError) {
04011 
04012                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d7/lfs_2registry_8c.html#a9">LfsCheckSubsequentLogPage</a>( Lfcb,
04013                                                TestPageHeader,
04014                                                NextLogPageOffset,
04015                                                ExpectedSeqNumber )) {
04016 
04017                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"Log file is fatally flawed\n"</span>, 0 );
04018                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_DISK_CORRUPT_ERROR );
04019                 }
04020             }
04021 
04022             ValidFile = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04023         }
04024 
04025         <span class="comment">//</span>
04026         <span class="comment">//  Make sure the current page is unpinned.</span>
04027         <span class="comment">//</span>
04028 
04029         <span class="keywordflow">if</span> (LogPageHeaderBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04030 
04031             <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( LogPageHeaderBcb );
04032             LogPageHeaderBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04033         }
04034 
04035         <span class="comment">//</span>
04036         <span class="comment">//  We have a valid file.  The Lfcb is initialized to the point where</span>
04037         <span class="comment">//  the last log record was found.  We possibly have a copy of the</span>
04038         <span class="comment">//  last page in the log file stored as a copy.  Or we could just have</span>
04039         <span class="comment">//  a page that we would like to reuse the end of.</span>
04040         <span class="comment">//</span>
04041 
04042         <span class="keywordflow">if</span> (TailPage != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04043 
04044 <span class="preprocessor">#ifdef BENL_DBG</span>
04045 <span class="preprocessor"></span>            KdPrint(( <span class="stringliteral">"LFS: copying tail page at 0x%x to 0x%I64x, 1st:0x%x 2nd:0x%x \n"</span>, TailPage, TailPage-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o3">Copy</a>.FileOffset, FirstTailPage, SecondTailPage ));
04046 <span class="preprocessor">#endif</span>
04047 <span class="preprocessor"></span>
04048             <span class="comment">//</span>
04049             <span class="comment">//  We will pin the correct page and copy the data from this</span>
04050             <span class="comment">//  page into it.  We will then flush it out to disk.</span>
04051             <span class="comment">//</span>
04052 
04053             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a48">LfsPinOrMapData</a>( Lfcb,
04054                              TailPage-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o3">Copy</a>.FileOffset,
04055                              (ULONG)Lfcb-&gt;LogPageSize,
04056                              TRUE,
04057                              FALSE,
04058                              TRUE,
04059                              &amp;UsaError,
04060                              (PVOID *) &amp;LogPageHeader,
04061                              &amp;LogPageHeaderBcb );
04062 
04063             RtlCopyMemory( LogPageHeader,
04064                            TailPage,
04065                            (ULONG)Lfcb-&gt;LogPageSize );
04066 
04067             <span class="comment">//</span>
04068             <span class="comment">//  Fill in last flushed lsn value flush the page.</span>
04069             <span class="comment">//</span>
04070 
04071             LogPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o3">Copy</a>.LastLsn = TailPage-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o9">Header</a>.Packed.LastEndLsn;
04072 
04073             <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a10">LfsFlushLogPage</a>( Lfcb,
04074                              LogPageHeader,
04075                              TailPage-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o3">Copy</a>.FileOffset,
04076                              &amp;LogPageHeaderBcb );
04077         }
04078 
04079         <span class="comment">//</span>
04080         <span class="comment">//  We also want to write over any partial I/O so it doesn't cause</span>
04081         <span class="comment">//  us problems on a subsequent restart.  We have the starting offset</span>
04082         <span class="comment">//  and the number of blocks.  We will simply write a Baad signature into</span>
04083         <span class="comment">//  each of these pages.  Any subsequent reads will have a Usa error.</span>
04084         <span class="comment">//</span>
04085 
04086         <span class="keywordflow">while</span> (PartialIoCount--) {
04087 
04088             <span class="comment">//</span>
04089             <span class="comment">//  Make sure the current page is unpinned.</span>
04090             <span class="comment">//</span>
04091     
04092             <span class="keywordflow">if</span> (LogPageHeaderBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04093     
04094                 <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( LogPageHeaderBcb );
04095                 LogPageHeaderBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04096             }
04097     
04098             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d4/lfsprocs_8h.html#a48">LfsPinOrMapData</a>( Lfcb,
04099                                              FirstPartialIo,
04100                                              (ULONG)Lfcb-&gt;LogPageSize,
04101                                              TRUE,
04102                                              TRUE,
04103                                              TRUE,
04104                                              &amp;UsaError,
04105                                              (PVOID *) &amp;LogPageHeader,
04106                                              &amp;LogPageHeaderBcb ))) {
04107 
04108                 <span class="comment">//</span>
04109                 <span class="comment">//  Just store a the usa array header in the multi-section</span>
04110                 <span class="comment">//  header.</span>
04111                 <span class="comment">//</span>
04112 
04113                 *((PULONG) &amp;LogPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o0">MultiSectorHeader</a>.<a class="code" href="../../d2/d1/struct__MULTI__SECTOR__HEADER.html#o0">Signature</a>) = <a class="code" href="../../d9/d3/lfsdisk_8h.html#a16">LFS_SIGNATURE_BAD_USA_ULONG</a>;
04114 
04115                 <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a10">LfsFlushLogPage</a>( Lfcb,
04116                                  LogPageHeader,
04117                                  FirstPartialIo,
04118                                  &amp;LogPageHeaderBcb );
04119             }
04120 
04121             <a class="code" href="../../d6/d5/logpgsup_8c.html#a2">LfsNextLogPageOffset</a>( Lfcb,
04122                                   FirstPartialIo,
04123                                   &amp;FirstPartialIo,
04124                                   &amp;Wrapped );
04125         }
04126 
04127         <span class="comment">//</span>
04128         <span class="comment">//  We used to invalidate any tail pages we reused, now we let them</span>
04129         <span class="comment">//  be recopied every restart even if we fail a little later</span>
04130         <span class="comment">//  </span>
04131                        
04132 <span class="preprocessor">#ifdef BENL_DBG</span>
04133 <span class="preprocessor"></span>        
04134         <span class="keywordflow">if</span> (FirstTailPageBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04135             KdPrint(( <span class="stringliteral">"LFS: not spitting BAAD to 1st page\n"</span> ));
04136         }
04137 
04138         <span class="keywordflow">if</span> (SecondTailPageBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04139              KdPrint(( <span class="stringliteral">"LFS: not spitting BAAD to 2nd page\n"</span> ));
04140         }
04141 <span class="preprocessor">#endif</span>
04142 <span class="preprocessor"></span>        
04143 
04144     } finally {
04145 
04146         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsFindLastLsn );
04147 
04148         <span class="comment">//</span>
04149         <span class="comment">//  Unpin the tail pages is pinned.</span>
04150         <span class="comment">//</span>
04151 
04152         <span class="keywordflow">if</span> (SecondTailPageBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04153 
04154             <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( SecondTailPageBcb );
04155         }
04156 
04157         <span class="keywordflow">if</span> (FirstTailPageBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04158 
04159             <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( FirstTailPageBcb );
04160         }
04161 
04162         <span class="comment">//</span>
04163         <span class="comment">//  Unpin the log page header if neccessary.</span>
04164         <span class="comment">//</span>
04165 
04166         <span class="keywordflow">if</span> (LogPageHeaderBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04167 
04168             <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( LogPageHeaderBcb );
04169         }
04170 
04171         <span class="keywordflow">if</span> (TestPageHeaderBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04172 
04173             <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( TestPageHeaderBcb );
04174         }
04175 
04176         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsFindLastLsn:  Exit\n"</span>, 0 );
04177     }
04178 
04179     <span class="keywordflow">return</span>;
04180 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="lfs/registry.c::LfsFlushLogPage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsFlushLogPage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>LogPage</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d4/d3/struct__BCB.html">PBCB</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Bcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l04321">4321</a> of file <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html">lfs/registry.c</a>.
<p>
References <a class="el" href="../../d7/d1/cachesub_8c-source.html#l04411">CcFlushCache()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l02560">CcSetDirtyPinnedData()</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01000">CcUnpinData()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l03193">LfsFindLastLsn()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l03065">LfsInitializeLogFilePriv()</a>.
<p>
<pre class="fragment"><div>04330                    :
04331 
04332     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to write a single log page to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  We will
04333     mark <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> dirty in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cache, unpin <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> and call our flush routine.
04334 
04335 Arguments:
04336 
04337     Lfcb - Log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block <span class="keywordflow">for</span> <span class="keyword">this</span> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
04338 
04339     LogPage - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log page in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cache.
04340 
04341     FileOffset - <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stream.
04342 
04343     Bcb - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Bcb pointer <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cache.
04344 
04345 Return Value:
04346 
04347     None
04348 
04349 --*/
04350 
04351 {
04352     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04353 
04354     <span class="comment">//</span>
04355     <span class="comment">//  Set the page dirty and unpin it.</span>
04356     <span class="comment">//</span>
04357 
04358     <a class="code" href="../../d4/d2/cache_8h.html#a91">CcSetDirtyPinnedData</a>( *Bcb, NULL );
04359     <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( *Bcb );
04360     *Bcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04361 
04362     <span class="comment">//</span>
04363     <span class="comment">//  Now flush the data.</span>
04364     <span class="comment">//</span>
04365 
04366     Lfcb-&gt;UserWriteData-&gt;FileOffset = FileOffset;
04367     Lfcb-&gt;UserWriteData-&gt;Length = (ULONG) Lfcb-&gt;LogPageSize;
04368 
04369     <a class="code" href="../../d4/d2/cache_8h.html#a63">CcFlushCache</a>( Lfcb-&gt;FileObject-&gt;SectionObjectPointer,
04370                   (PLARGE_INTEGER) &amp;FileOffset,
04371                   (ULONG) Lfcb-&gt;LogPageSize,
04372                   NULL );
04373 
04374     <span class="keywordflow">return</span>;
04375 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="lfs/registry.c::LfsInitializeLogFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsInitializeLogFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LogFile</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MaximumClients</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG LogPageSize&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d5/d1/struct__LFS__WRITE__DATA.html">PLFS_WRITE_DATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WriteData</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00150">150</a> of file <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html">lfs/registry.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d9/d4/logsup_8c-source.html#l00032">CcSetAdditionalCacheAttributes()</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00436">_LFCB::ClientArray</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00437">_LFCB::ClientArrayOffset</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00328">_LFCB::FileObject</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00360">_LFCB::FirstLogPage</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00452">_LFCB::InitialRestartArea</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00315">_LFCB::LfcbLinks</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00636">_LFS_DATA::LfcbLinks</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00153">LFS_DEFAULT_LOG_PAGE_SIZE</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00509">LfsAcquireLfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00484">LfsAcquireLfsData</a>, <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00041">LfsAllocateLfcb()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00438">LfsAllocateRestartArea</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00033">LfsData</a>, <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00188">LfsDeallocateLfcb()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00442">LfsDeallocateRestartArea</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00058">LfsExceptionFilter()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00150">LfsInitializeLogFile()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l03065">LfsInitializeLogFilePriv()</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00039">LfsLi0</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02246">LfsNormalizeBasicLogFile()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00512">LfsReleaseLfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00487">LfsReleaseLfsData</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00130">_LFS_WRITE_DATA::LfsStructureSize</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02514">LfsUpdateLfcbFromNoRestart()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02390">LfsUpdateLfcbFromPgHeader()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02964">LfsUpdateRestartAreaFromLfcb()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00435">_LFCB::RestartArea</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00386">_LFCB::RestartDataSize</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00589">_LFCB::UserWriteData</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00150">LfsInitializeLogFile()</a>.
<p>
<pre class="fragment"><div>00160                    :
00161 
00162     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to initialize a log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to prepare <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <span class="keywordflow">for</span> use
00163     by log clients.  Any previous data in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> will be overwritten.
00164 
00165     Lfs will partition <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> into 2 Lfs restart areas and as many log
00166     pages as will fit in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  The restart area size <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> determined
00167     by computing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> amount of space needed <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum number
00168 
00169 Arguments:
00170 
00171     LogFile - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to be used as a log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00172 
00173     MaximumClients - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum number of clients that will be
00174                      active in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> at any one time.
00175 
00176     LogPageSize - If specified (not 0), <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> recommended size of
00177                   <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log page.  Lfs will use <span class="keyword">this</span> as a guide in
00178                   determining <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log page size.
00179 
00180     FileSize - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> available size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00181 
00182     WriteData - Pointer to WRITE_DATA in caller's data structure.
00183 
00184 Return Value:
00185 
00186     None
00187 
00188 --*/
00189 
00190 {
00191     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
00192     LARGE_INTEGER CurrentTime;
00193 
00194     <a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a> RestartArea = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00195 
00196     <span class="keyword">volatile</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00197 
00198     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00199 
00200     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsInitializeLogFile:  Entered\n"</span>, 0 );
00201     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log File          -&gt; %08lx\n"</span>, LogFile );
00202     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Maximum Clients   -&gt; %04x\n"</span>, MaximumClients );
00203     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log Page Size     -&gt; %08lx\n"</span>, LogPageSize );
00204     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"File Size (Low)   -&gt; %08lx\n"</span>, FileSize.LowPart );
00205     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"File Size (High)  -&gt; %08lx\n"</span>, FileSize.HighPart );
00206 
00207     Lfcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00208 
00209     <span class="comment">//</span>
00210     <span class="comment">//  Protect this entry point with a try-except.</span>
00211     <span class="comment">//</span>
00212 
00213     <span class="keywordflow">try</span> {
00214 
00215         <span class="comment">//</span>
00216         <span class="comment">//  We grab the global data exclusively.</span>
00217         <span class="comment">//</span>
00218 
00219         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a21">LfsAcquireLfsData</a>();
00220 
00221         <span class="comment">//</span>
00222         <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00223         <span class="comment">//</span>
00224 
00225         <span class="keywordflow">try</span> {
00226 
00227             <span class="comment">//</span>
00228             <span class="comment">//  We allocate an Lfcb and point it to the log file.</span>
00229             <span class="comment">//</span>
00230 
00231             Lfcb = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a65">LfsAllocateLfcb</a>();
00232 
00233             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a28">LfsAcquireLfcb</a>( Lfcb );
00234 
00235             Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o4">FileObject</a> = LogFile;
00236 
00237             <span class="comment">//</span>
00238             <span class="comment">//  Call the Cache Manager to disable read ahead and write behind;</span>
00239             <span class="comment">//  we flush the log file explicitly.</span>
00240             <span class="comment">//</span>
00241 
00242             <a class="code" href="../../d4/d2/cache_8h.html#a95">CcSetAdditionalCacheAttributes</a>( LogFile, TRUE, TRUE );
00243 
00244             <span class="comment">//</span>
00245             <span class="comment">//  Normalize the values passed in with this call.</span>
00246             <span class="comment">//</span>
00247 
00248             <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a2">LfsNormalizeBasicLogFile</a>( &amp;FileSize,
00249                                       &amp;LogPageSize,
00250                                       &amp;MaximumClients,
00251                                       (BOOLEAN) ((PAGE_SIZE &gt;= LFS_DEFAULT_LOG_PAGE_SIZE) &amp;&amp;
00252                                                  (PAGE_SIZE &lt;= LFS_DEFAULT_LOG_PAGE_SIZE * 2)));
00253 
00254             <span class="comment">//</span>
00255             <span class="comment">//  We can go directly to version 1.1 since we can immediately pack</span>
00256             <span class="comment">//  the log file and use the default system log page size.</span>
00257             <span class="comment">//</span>
00258 
00259             <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a3">LfsUpdateLfcbFromPgHeader</a>( Lfcb,
00260                                        LogPageSize,
00261                                        LogPageSize,
00262                                        1,
00263                                        1,
00264                                        TRUE );
00265 
00266             <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>( &amp;CurrentTime );
00267 
00268             <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a4">LfsUpdateLfcbFromNoRestart</a>( Lfcb,
00269                                         FileSize,
00270                                         LfsLi0,
00271                                         MaximumClients,
00272                                         CurrentTime.LowPart,
00273                                         FALSE,
00274                                         FALSE );
00275 
00276             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a18">LfsAllocateRestartArea</a>( &amp;RestartArea, Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o18">RestartDataSize</a> );
00277 
00278             <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a6">LfsUpdateRestartAreaFromLfcb</a>( Lfcb, RestartArea );
00279 
00280             Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o30">RestartArea</a> = RestartArea;
00281             Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a> = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( RestartArea, Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o32">ClientArrayOffset</a>, <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> );
00282             RestartArea = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00283 
00284             Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o36">InitialRestartArea</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00285 
00286             <span class="comment">//</span>
00287             <span class="comment">//  Now update the caller's WRITE_DATA structure.</span>
00288             <span class="comment">//</span>
00289 
00290             Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o62">UserWriteData</a> = WriteData;
00291             WriteData-&gt;<a class="code" href="../../d5/d1/struct__LFS__WRITE__DATA.html#o2">LfsStructureSize</a> = LogPageSize;
00292             WriteData-&gt;Lfcb = Lfcb;
00293 
00294             <span class="comment">//</span>
00295             <span class="comment">//  Force two restart areas to disk and reinitialize the file.</span>
00296             <span class="comment">//</span>
00297 
00298             <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a7">LfsInitializeLogFilePriv</a>( Lfcb,
00299                                       TRUE,
00300                                       Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o18">RestartDataSize</a>,
00301                                       Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o13">FirstLogPage</a>,
00302                                       TRUE );
00303 
00304             <span class="comment">//</span>
00305             <span class="comment">//  Put the Lfcb into the global queue.</span>
00306             <span class="comment">//</span>
00307 
00308             InsertHeadList( &amp;<a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o2">LfcbLinks</a>, &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o2">LfcbLinks</a> );
00309 
00310         } finally {
00311 
00312             <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsInitializeLogFile );
00313 
00314             <span class="comment">//</span>
00315             <span class="comment">//  If the Lfcb has been acquired, we release it now.</span>
00316             <span class="comment">//</span>
00317 
00318             <span class="keywordflow">if</span> (Lfcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00319 
00320                 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a29">LfsReleaseLfcb</a>( Lfcb );
00321 
00322                 <span class="comment">//</span>
00323                 <span class="comment">//  If an error occurred and we allocated an Lfcb.  We deallocate</span>
00324                 <span class="comment">//  it now.</span>
00325                 <span class="comment">//</span>
00326 
00327                 <span class="keywordflow">if</span> (AbnormalTermination()) {
00328 
00329                     <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a2">LfsDeallocateLfcb</a>( Lfcb, TRUE );
00330                 }
00331             }
00332 
00333             <span class="comment">//</span>
00334             <span class="comment">//  Deallocate the restart area.</span>
00335             <span class="comment">//</span>
00336 
00337             <span class="keywordflow">if</span> (RestartArea != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00338 
00339                 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a19">LfsDeallocateRestartArea</a>( RestartArea );
00340             }
00341 
00342             <span class="comment">//</span>
00343             <span class="comment">//  We release the global data.</span>
00344             <span class="comment">//</span>
00345 
00346             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a22">LfsReleaseLfsData</a>();
00347 
00348             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsInitializeLogFile:  Exit\n"</span>, 0 );
00349         }
00350 
00351     } except (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a56">LfsExceptionFilter</a>( GetExceptionInformation() )) {
00352 
00353         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00354     }
00355 
00356     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00357 
00358         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( Status );
00359     }
00360 
00361     <span class="keywordflow">return</span>;
00362 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="lfs/registry.c::LfsInitializeLogFilePriv" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsInitializeLogFilePriv           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ForceRestartToDisk</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>RestartAreaSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>StartOffsetForClear</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ClearLogFile</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l03065">3065</a> of file <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html">lfs/registry.c</a>.
<p>
References <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01000">CcUnpinData()</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00347">LFS_SIGNATURE_UNINITIALIZED_ULONG</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l04321">LfsFlushLogPage()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00084">LfsPinOrMapData()</a>, <a class="el" href="../../d8/d9/rstrtsup_8c-source.html#l00036">LfsWriteLfsRestart()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00150">LfsInitializeLogFile()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01534">LfsRestartLogFile()</a>.
<p>
<pre class="fragment"><div>03075                    :
03076 
03077     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> our internal routine <span class="keywordflow">for</span> initializing a log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
03078     This can be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span> where we are updating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <span class="keywordflow">for</span>
03079     update sequence array, or differing page size or <span class="keyword">new</span> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> size.
03080 
03081 Arguments:
03082 
03083     Lfcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfcb <span class="keywordflow">for</span> <span class="keyword">this</span> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  It should already have
03084         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> version number information stored.
03085 
03086     ForceRestartToDisk - Indicates that we want to actually force restart
03087         areas to disk instead of simply queueing them to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03088         workqueue.
03089 
03090     RestartAreaSize - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> restart areas.  This may
03091         be larger than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfcb because we may be clearing
03092         stale data <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
03093 
03094     StartOffsetForClear - If we are clearing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> we want to uninitialize
03095         from <span class="keyword">this</span> point.
03096 
03097     ClearLogFile - Indicates <span class="keywordflow">if</span> we want to uninitialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to
03098         remove stale data.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done specifically when changing
03099         system page sizes.
03100 
03101 Return Value:
03102 
03103     None
03104 
03105 --*/
03106 
03107 {
03108     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03109 
03110     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsInitializeLogFilePriv:  Entered\n"</span>, 0 );
03111     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lfcb                  -&gt; %08lx\n"</span>, Lfcb );
03112     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Force Restart         -&gt; %04x\n"</span>, ForceRestartToDisk );
03113     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"RestartAreaSize       -&gt; %08lx\n"</span>, RestartAreaSize );
03114     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"StartOffset (Low)     -&gt; %08lx\n"</span>, StartOffsetForClear.LowPart );
03115     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"StartOffset (High)    -&gt; %08lx\n"</span>, StartOffsetForClear.HighPart );
03116     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Clear Log File        -&gt; %04x\n"</span>, ClearLogFile );
03117 
03118     <span class="comment">//</span>
03119     <span class="comment">//  We start by queueing the restart areas.</span>
03120     <span class="comment">//</span>
03121 
03122     <a class="code" href="../../d7/d0/rstrtsup_8c.html#a1">LfsWriteLfsRestart</a>( Lfcb,
03123                         RestartAreaSize,
03124                         FALSE );
03125 
03126     <a class="code" href="../../d7/d0/rstrtsup_8c.html#a1">LfsWriteLfsRestart</a>( Lfcb,
03127                         RestartAreaSize,
03128                         ForceRestartToDisk );
03129 
03130     <span class="comment">//</span>
03131     <span class="comment">//  If we are to clear the log file, we write all 0xff into the</span>
03132     <span class="comment">//  log pages beginning at the log page offset.</span>
03133     <span class="comment">//</span>
03134 
03135     <span class="keywordflow">if</span> (ClearLogFile) {
03136 
03137         PCHAR LogPage;
03138         <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> LogPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03139 
03140         <span class="keywordflow">try</span> {
03141 
03142             <span class="keywordflow">while</span> ( StartOffsetForClear &lt; Lfcb-&gt;FileSize ) {
03143 
03144                 BOOLEAN UsaError;
03145 
03146                 <span class="comment">//</span>
03147                 <span class="comment">//  We'll do the best we can and ignore all errors.</span>
03148                 <span class="comment">//</span>
03149 
03150                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d4/lfsprocs_8h.html#a48">LfsPinOrMapData</a>( Lfcb,
03151                                                  StartOffsetForClear,
03152                                                  (ULONG)Lfcb-&gt;LogPageSize,
03153                                                  TRUE,
03154                                                  FALSE,
03155                                                  TRUE,
03156                                                  &amp;UsaError,
03157                                                  (PVOID *) &amp;LogPage,
03158                                                  &amp;LogPageBcb ))) {
03159 
03160                     RtlFillMemoryUlong( (PVOID)LogPage,
03161                                         (ULONG)Lfcb-&gt;LogPageSize,
03162                                         LFS_SIGNATURE_UNINITIALIZED_ULONG );
03163 
03164                     <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a10">LfsFlushLogPage</a>( Lfcb,
03165                                      LogPage,
03166                                      StartOffsetForClear,
03167                                      &amp;LogPageBcb );
03168 
03169                     StartOffsetForClear = Lfcb-&gt;LogPageSize + StartOffsetForClear;
03170                 }
03171             }
03172 
03173         } finally {
03174 
03175             <span class="keywordflow">if</span> (LogPageBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03176 
03177                 <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( LogPageBcb );
03178             }
03179         }
03180     }
03181 
03182     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsInitializeLogFilePriv:  Exit\n"</span>, 0 );
03183 
03184     <span class="keywordflow">return</span>;
03185 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="lfs/registry.c::LfsNormalizeBasicLogFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsNormalizeBasicLogFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PLONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LogPageSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a22">PUSHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LogClients</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>UseDefaultLogPage</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02246">2246</a> of file <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html">lfs/registry.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00153">LFS_DEFAULT_LOG_PAGE_SIZE</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00034">LfsMaximumFileSize</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00031">MINIMUM_LFS_PAGES</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00150">LfsInitializeLogFile()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01534">LfsRestartLogFile()</a>.
<p>
<pre class="fragment"><div>02255                    :
02256 
02257     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to normalize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> values which describe <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02258     log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  It will make <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log page a multiple of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system page.
02259     Finally we make sure <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> size ends on a log page boundary.
02260 
02261     On input all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parameters have <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested values, on <span class="keywordflow">return</span>
02262     they have <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> values to use.
02263 
02264 Arguments:
02265 
02266     FileSize - Stated size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
02267 
02268     LogPageSize - Suggested size <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log page.
02269 
02270     LogClients - Requested number of log clients.
02271 
02272     UseDefaultLogPage - Indicates <span class="keywordflow">if</span> we should use <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hardwired log page size or base
02273         <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system page size.
02274 
02275 Return Value:
02276 
02277     None.
02278 
02279 --*/
02280 
02281 {
02282     ULONG LocalLogPageSize;
02283     LONGLONG RestartPageBytes;
02284     LONGLONG LogPages;
02285 
02286     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> MaximumClients;
02287 
02288     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02289 
02290     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsNormalizeBasicLogFile:  Entered\n"</span>, 0 );
02291 
02292     <span class="comment">//</span>
02293     <span class="comment">//  We always make the log page the same as the system page size.</span>
02294     <span class="comment">//  This may change in the future.</span>
02295     <span class="comment">//</span>
02296 
02297     <span class="keywordflow">if</span> (!UseDefaultLogPage) {
02298 
02299         *LogPageSize = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02300 
02301     } <span class="keywordflow">else</span> {
02302 
02303         *LogPageSize = <a class="code" href="../../d6/d3/lfs_8h.html#a1">LFS_DEFAULT_LOG_PAGE_SIZE</a>;
02304     }
02305 
02306     <span class="comment">//</span>
02307     <span class="comment">//  If the log file is greater than the maximum log file size, we</span>
02308     <span class="comment">//  set the log file size to the maximum size.</span>
02309     <span class="comment">//</span>
02310 
02311     <span class="keywordflow">if</span> (*FileSize &gt; <a class="code" href="../../d8/d3/lfsdata_8h.html#a0">LfsMaximumFileSize</a>) {
02312 
02313         *FileSize = <a class="code" href="../../d8/d3/lfsdata_8h.html#a0">LfsMaximumFileSize</a>;
02314     }
02315 
02316     <span class="comment">//</span>
02317     <span class="comment">//  We round the file size down to a system page boundary.  This</span>
02318     <span class="comment">//  may also change if we allow non-system page sized log pages.</span>
02319     <span class="comment">//</span>
02320 
02321     *(PULONG)FileSize &amp;= ~(*LogPageSize - 1);
02322 
02323     <span class="comment">//</span>
02324     <span class="comment">//  There better be at least 2 restart pages.</span>
02325     <span class="comment">//</span>
02326 
02327     RestartPageBytes = 2 * *LogPageSize;
02328 
02329     <span class="keywordflow">if</span> (*FileSize &lt;= RestartPageBytes) {
02330 
02331         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log file is too small\n"</span>, 0 );
02332         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsValidateBasicLogFile:  Abnormal Exit\n"</span>, 0 );
02333 
02334         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
02335     }
02336 
02337     <span class="comment">//</span>
02338     <span class="comment">//  Now compute the number of log pages.</span>
02339     <span class="comment">//</span>
02340 
02341     LogPages = *FileSize - RestartPageBytes;
02342     LocalLogPageSize = *LogPageSize &gt;&gt; 1;
02343 
02344     <span class="keywordflow">while</span> (LocalLogPageSize) {
02345 
02346         LocalLogPageSize = LocalLogPageSize &gt;&gt; 1;
02347         LogPages = ((ULONGLONG)(LogPages)) &gt;&gt; 1;
02348     }
02349 
02350     <span class="comment">//</span>
02351     <span class="comment">//  If there aren't enough log pages then raise an error condition.</span>
02352     <span class="comment">//</span>
02353 
02354     <span class="keywordflow">if</span> (((PLARGE_INTEGER)&amp;LogPages)-&gt;HighPart == 0
02355         &amp;&amp; (ULONG)LogPages &lt; <a class="code" href="../../d9/d3/lfsdisk_8h.html#a0">MINIMUM_LFS_PAGES</a>) {
02356 
02357         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Not enough log pages -&gt; %08lx\n"</span>, LogPages.LowPart );
02358         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsValidateBasicLogFile:  Abnormal Exit\n"</span>, 0 );
02359 
02360         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
02361     }
02362 
02363     <span class="comment">//</span>
02364     <span class="comment">//  Now we compute the amount of space available for log clients.</span>
02365     <span class="comment">//  We will limit the clients to half of the restart system page.</span>
02366     <span class="comment">//</span>
02367 
02368     MaximumClients = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) ((*LogPageSize / 2) / <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">LFS_CLIENT_RECORD</a> ));
02369 
02370     <span class="keywordflow">if</span> (*LogClients == 0) {
02371 
02372         *LogClients = 1;
02373 
02374     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*LogClients &gt; MaximumClients) {
02375 
02376         *LogClients = MaximumClients;
02377     }
02378 
02379     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsNormalizeBasicLogFile:  Exit\n"</span>, 0 );
02380 
02381     <span class="keywordflow">return</span>;
02382 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="lfs/registry.c::LfsOpenLogFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG LfsOpenLogFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LogFile</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MaximumClients</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG LogPageSize&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d6/d3/lfs_8h.html#a22">PLFS_INFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LfsInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d3/lfs_8h.html#a24">PLFS_LOG_HANDLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LogHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d5/d1/struct__LFS__WRITE__DATA.html">PLFS_WRITE_DATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WriteData</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00366">366</a> of file <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html">lfs/registry.c</a>.
<p>
References <a class="el" href="../../d9/d4/logsup_8c-source.html#l00032">CcSetAdditionalCacheAttributes()</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00436">_LFCB::ClientArray</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00163">_LCH::ClientArrayByteOffset</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00443">_LFS_RESTART_AREA::ClientFreeList</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00149">_LCH::ClientId</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00057">_LFS_CLIENT_ID::ClientIndex</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00444">_LFS_RESTART_AREA::ClientInUseList</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00411">_LFS_CLIENT_RECORD::ClientName</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00409">_LFS_CLIENT_RECORD::ClientNameLength</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00373">_LFS_CLIENT_RECORD::ClientRestartLsn</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00328">_LFCB::FileObject</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00548">_LFCB::Flags</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00136">_LCH::LchLinks</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00321">_LFCB::LchLinks</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00142">_LCH::Lfcb</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00605">LFCB_LOG_FILE_CORRUPT</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00602">LFCB_PACK_LOG</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00315">_LFCB::LfcbLinks</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00636">_LFS_DATA::LfcbLinks</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00356">LFS_CLIENT_NAME_MAX</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00197">LFS_LOG_HANDLE</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00355">LFS_NO_CLIENT</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00484">LfsAcquireLfsData</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l04463">LfsAddClientToList()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00428">LfsAllocateLch</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00033">LfsData</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00435">LfsDeallocateLch</a>, <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00188">LfsDeallocateLfcb()</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00058">LfsExceptionFilter()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00366">LfsOpenLogFile()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00512">LfsReleaseLfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00487">LfsReleaseLfsData</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l04383">LfsRemoveClientFromList()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01534">LfsRestartLogFile()</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00147">LfsZeroLsn</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00382">_LFS_CLIENT_RECORD::NextClient</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00467">_LFCB::OldestLsn</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00365">_LFS_CLIENT_RECORD::OldestLsn</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00238">PtrOffset</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00394">_LFCB::RecordHeaderLength</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00435">_LFCB::RestartArea</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00389">_LFS_CLIENT_RECORD::SeqNumber</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00056">_LFS_CLIENT_ID::SeqNumber</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00570">_LFCB::Sync</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00170">_LCH::Sync</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00106">_LFCB_SYNC::UserCount</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00366">LfsOpenLogFile()</a>.
<p>
<pre class="fragment"><div>00379                    :
00380 
00381     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when a client wishes to <span class="keyword">register</span> with logging
00382     service.  This can be a reregistration (i.e. restart after a crash)
00383     or an initial registration.  There can be no other active clients
00384     with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same name.  The Log <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> then used <span class="keywordflow">for</span> any
00385     subsequent access by <span class="keyword">this</span> client.
00386 
00387     If an Lfs restart has not been done on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will be done
00388     at <span class="keyword">this</span> time.
00389 
00390 Arguments:
00391 
00392     LogFile - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <span class="keywordflow">for</span> a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> previously initialized <span class="keywordflow">for</span> use
00393               as a log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00394 
00395     ClientName - This unicode string <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to uniquely identify clients
00396                  of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> logging service.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keywordflow">case</span>-sensitive comparison <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00397                  used to check <span class="keyword">this</span> name against active clients of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00398                  log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00399 
00400     MaximumClients - The maximum number of clients <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> has
00401                      never been initialized.
00402 
00403     LogPageSize - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> recommeded size <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log page.
00404 
00405     FileSize - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00406 
00407     LfsInfo - On entry, indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> state <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user may
00408         know about.  On <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>, indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> state that Lfs
00409         knows about.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a conduit <span class="keywordflow">for</span> Lfs to communicate with its
00410         clients.
00411 
00412     LogHandle - The address to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> identifier <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> logging service
00413                 will use to identify <span class="keyword">this</span> client in all other Lfs calls.
00414 
00415     WriteData - Pointer to WRITE_DATA in caller's data structure.
00416 
00417 Return Value:
00418 
00419     ULONG - Amount to add to reservation value <span class="keywordflow">for</span> header <span class="keywordflow">for</span> log record.
00420 
00421 --*/
00422 
00423 {
00424     <span class="keyword">volatile</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00425 
00426     PLIST_ENTRY Link;
00427     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> ThisLfcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00428     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> NewLfcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00429 
00430     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> ThisClient;
00431     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientRecord;
00432 
00433     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00434 
00435     ULONG ReservedHeader;
00436 
00437     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00438 
00439     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsOpenLogFile:  Entered\n"</span>, 0 );
00440     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log File          -&gt; %08lx\n"</span>, LogFile );
00441     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Client Name       -&gt; %08lx\n"</span>, &amp;ClientName );
00442     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Maximum Clients   -&gt; %04x\n"</span>, MaximumClients );
00443     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log Page Size     -&gt; %08lx\n"</span>, LogPageSize );
00444     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"File Size (Low)   -&gt; %08lx\n"</span>, FileSize.LowPart );
00445     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"File Size (High)  -&gt; %08lx\n"</span>, FileSize.HighPart );
00446 
00447     <span class="comment">//</span>
00448     <span class="comment">//  Check that the client name length is a legal length.</span>
00449     <span class="comment">//</span>
00450 
00451     <span class="keywordflow">if</span> (ClientName.Length &gt; <a class="code" href="../../d9/d3/lfsdisk_8h.html#a22">LFS_CLIENT_NAME_MAX</a>) {
00452 
00453         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Illegal name length for client\n"</span>, 0 );
00454         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsOpenLogFile:  Exit\n"</span>, 0 );
00455         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INVALID_PARAMETER );
00456     }
00457 
00458     <span class="comment">//</span>
00459     <span class="comment">//  Protect this call with a try-except.</span>
00460     <span class="comment">//</span>
00461 
00462     <span class="keywordflow">try</span> {
00463 
00464         <span class="comment">//</span>
00465         <span class="comment">//  Aqcuire the global data.</span>
00466         <span class="comment">//</span>
00467 
00468         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a21">LfsAcquireLfsData</a>();
00469 
00470         <span class="comment">//</span>
00471         <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00472         <span class="comment">//</span>
00473 
00474         <span class="keywordflow">try</span> {
00475 
00476             <span class="comment">//</span>
00477             <span class="comment">//  Walk through the list searching for this file object.</span>
00478             <span class="comment">//</span>
00479 
00480             Link = <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o2">LfcbLinks</a>.Flink;
00481 
00482             <span class="keywordflow">while</span> (Link != &amp;<a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o2">LfcbLinks</a>) {
00483 
00484                 ThisLfcb = CONTAINING_RECORD( Link, <a class="code" href="../../d1/d0/struct__LFCB.html">LFCB</a>, LfcbLinks );
00485 
00486                 <span class="keywordflow">if</span> (ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o4">FileObject</a> == LogFile) {
00487 
00488                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"Found matching log file\n"</span>, 0 );
00489                     <span class="keywordflow">break</span>;
00490                 }
00491 
00492                 Link = Link-&gt;Flink;
00493             }
00494 
00495             <span class="comment">//</span>
00496             <span class="comment">//  If the log file doesn't exist, create an Lfcb and perform an</span>
00497             <span class="comment">//  Lfs restart.</span>
00498             <span class="comment">//</span>
00499 
00500             <span class="keywordflow">if</span> (Link == &amp;<a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o2">LfcbLinks</a>) {
00501 
00502                 <span class="comment">//</span>
00503                 <span class="comment">//  Call the Cache Manager to disable read ahead and write behind;</span>
00504                 <span class="comment">//  we flush the log file explicitly.</span>
00505                 <span class="comment">//</span>
00506 
00507                 <a class="code" href="../../d4/d2/cache_8h.html#a95">CcSetAdditionalCacheAttributes</a>( LogFile, TRUE, TRUE );
00508 
00509                 <span class="comment">//</span>
00510                 <span class="comment">//  Perform Lfs restart on this file object.</span>
00511                 <span class="comment">//</span>
00512 
00513                 ThisLfcb = NewLfcb = <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a1">LfsRestartLogFile</a>( LogFile,
00514                                                         MaximumClients,
00515                                                         0,
00516                                                         FileSize,
00517                                                         LfsInfo,
00518                                                         WriteData );
00519 
00520                 <span class="comment">//</span>
00521                 <span class="comment">//  Insert this Lfcb into the global list.</span>
00522                 <span class="comment">//</span>
00523 
00524                 InsertHeadList( &amp;<a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o2">LfcbLinks</a>, &amp;ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o2">LfcbLinks</a> );
00525             }
00526 
00527             <span class="comment">//</span>
00528             <span class="comment">//  At this point we have the log file control block for the file</span>
00529             <span class="comment">//  object given us.  We first check whether the log file is fatally</span>
00530             <span class="comment">//  corrupt.</span>
00531             <span class="comment">//</span>
00532 
00533             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o54">Flags</a>, LFCB_LOG_FILE_CORRUPT )) {
00534 
00535                 <span class="comment">//</span>
00536                 <span class="comment">//  We leave the in-memory data alone and raise an error if</span>
00537                 <span class="comment">//  anyone attempts to access this file.</span>
00538                 <span class="comment">//</span>
00539 
00540                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"The Lfcb is corrupt\n"</span>, 0 );
00541                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_DISK_CORRUPT_ERROR );
00542             }
00543 
00544             <span class="comment">//</span>
00545             <span class="comment">//  Search through and look for a client match.</span>
00546             <span class="comment">//</span>
00547 
00548             ThisClient = ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o30">RestartArea</a>-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o3">ClientInUseList</a>;
00549 
00550             <span class="keywordflow">while</span> (ThisClient != <a class="code" href="../../d9/d3/lfsdisk_8h.html#a21">LFS_NO_CLIENT</a>) {
00551 
00552                 ClientRecord = ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a> + ThisClient;
00553 
00554                 <span class="keywordflow">if</span> (ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o7">ClientNameLength</a> == (ULONG) ClientName.Length
00555                     &amp;&amp; RtlCompareMemory( ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o8">ClientName</a>,
00556                                          ClientName.Buffer,
00557                                          ClientName.Length ) == (ULONG) ClientName.Length) {
00558 
00559                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"Matching client name found\n"</span>, 0 );
00560                     <span class="keywordflow">break</span>;
00561                 }
00562 
00563                 ThisClient = ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o3">NextClient</a>;
00564             }
00565 
00566             <span class="comment">//</span>
00567             <span class="comment">//  Allocate an Lch structure and link it into the Lfcb.</span>
00568             <span class="comment">//</span>
00569 
00570             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a16">LfsAllocateLch</a>( &amp;Lch );
00571             InsertTailList( &amp;ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o3">LchLinks</a>, &amp;Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o2">LchLinks</a> );
00572 
00573             <span class="comment">//</span>
00574             <span class="comment">//  Initialize the client handle with the data from the Lfcb.</span>
00575             <span class="comment">//</span>
00576 
00577             Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a> = ThisLfcb;
00578             Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o7">Sync</a> = ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o59">Sync</a>;
00579             Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o7">Sync</a>-&gt;<a class="code" href="../../d2/d0/struct__LFCB__SYNC.html#o2">UserCount</a> += 1;
00580 
00581             <span class="comment">//</span>
00582             <span class="comment">//  If a match isn't found, take a client block off the free list</span>
00583             <span class="comment">//  if available.</span>
00584             <span class="comment">//</span>
00585 
00586             <span class="keywordflow">if</span> (ThisClient == <a class="code" href="../../d9/d3/lfsdisk_8h.html#a21">LFS_NO_CLIENT</a>) {
00587 
00588                 <span class="comment">//</span>
00589                 <span class="comment">//  Raise an error status if out of client blocks.</span>
00590                 <span class="comment">//</span>
00591 
00592                 ThisClient = ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o30">RestartArea</a>-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o2">ClientFreeList</a>;
00593 
00594                 <span class="keywordflow">if</span> (ThisClient == <a class="code" href="../../d9/d3/lfsdisk_8h.html#a21">LFS_NO_CLIENT</a>) {
00595 
00596                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"No free client records available\n"</span>, 0 );
00597                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
00598                 }
00599 
00600                 <span class="comment">//</span>
00601                 <span class="comment">//  Initialize the client block.</span>
00602                 <span class="comment">//</span>
00603 
00604                 ClientRecord = ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a> + ThisClient;
00605 
00606                 <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a21">LfsRemoveClientFromList</a>( ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a>,
00607                                          ClientRecord,
00608                                          &amp;ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o30">RestartArea</a>-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o2">ClientFreeList</a> );
00609 
00610                 ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o1">ClientRestartLsn</a> = <a class="code" href="../../d6/d3/lfs_8h.html#a12">LfsZeroLsn</a>;
00611                 ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o0">OldestLsn</a> = ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o39">OldestLsn</a>;
00612                 ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o7">ClientNameLength</a> = ClientName.Length;
00613                 RtlCopyMemory( ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o8">ClientName</a>,
00614                                ClientName.Buffer,
00615                                ClientName.Length );
00616 
00617                 <span class="comment">//</span>
00618                 <span class="comment">//  Add it to the in use list.</span>
00619                 <span class="comment">//</span>
00620 
00621                 <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a12">LfsAddClientToList</a>( ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a>,
00622                                     ThisClient,
00623                                     &amp;ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o30">RestartArea</a>-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o3">ClientInUseList</a> );
00624             }
00625 
00626             <span class="comment">//</span>
00627             <span class="comment">//  Update the client handle with the client block information.</span>
00628             <span class="comment">//</span>
00629 
00630             Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o4">ClientId</a>.<a class="code" href="../../d3/d0/struct__LFS__CLIENT__ID.html#o0">SeqNumber</a> = ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o4">SeqNumber</a>;
00631             Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o4">ClientId</a>.<a class="code" href="../../d3/d0/struct__LFS__CLIENT__ID.html#o1">ClientIndex</a> = ThisClient;
00632 
00633             Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o6">ClientArrayByteOffset</a> = <a class="code" href="../../d2/d7/notify_8c.html#a8">PtrOffset</a>( ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a>,
00634                                                     ClientRecord );
00635 
00636             *LogHandle = (<a class="code" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a>) Lch;
00637 
00638         } finally {
00639 
00640             <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsOpenLogFile );
00641 
00642             <span class="comment">//</span>
00643             <span class="comment">//  If the Lfcb has been acquired, we release it now.</span>
00644             <span class="comment">//</span>
00645 
00646             <span class="keywordflow">if</span> (ThisLfcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00647 
00648                 <span class="comment">//</span>
00649                 <span class="comment">//  Pass information back to our caller for the number</span>
00650                 <span class="comment">//  of bytes to add to the reserved amount for a</span>
00651                 <span class="comment">//  log header.</span>
00652                 <span class="comment">//</span>
00653 
00654                 ReservedHeader = ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o20">RecordHeaderLength</a>;
00655                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o54">Flags</a>, LFCB_PACK_LOG )) {
00656 
00657                     ReservedHeader *= 2;
00658                 }
00659 
00660                 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a29">LfsReleaseLfcb</a>( ThisLfcb );
00661             }
00662 
00663             <span class="comment">//</span>
00664             <span class="comment">//  If there is an error then deallocate the Lch and any new Lfcb.</span>
00665             <span class="comment">//</span>
00666 
00667             <span class="keywordflow">if</span> (AbnormalTermination()) {
00668 
00669                 <span class="keywordflow">if</span> (Lch != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00670 
00671                     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a17">LfsDeallocateLch</a>( Lch );
00672                     ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o59">Sync</a>-&gt;<a class="code" href="../../d2/d0/struct__LFCB__SYNC.html#o2">UserCount</a> -= 1;
00673                 }
00674 
00675                 <span class="keywordflow">if</span> (NewLfcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00676 
00677                     <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a2">LfsDeallocateLfcb</a>( NewLfcb, TRUE );
00678                 }
00679             }
00680 
00681             <span class="comment">//</span>
00682             <span class="comment">//  Always free the global.</span>
00683             <span class="comment">//</span>
00684 
00685             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a22">LfsReleaseLfsData</a>();
00686 
00687             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log Handle    -&gt; %08ln\n"</span>, *LogHandle );
00688             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsOpenLogFile:  Exit\n"</span>, 0 );
00689         }
00690 
00691     } except (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a56">LfsExceptionFilter</a>( GetExceptionInformation() )) {
00692 
00693         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00694     }
00695 
00696     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00697 
00698         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( Status );
00699     }
00700 
00701     <span class="keywordflow">return</span> ReservedHeader;
00702 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="lfs/registry.c::LfsReadLogFileInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsReadLogFileInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LogHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html">PLOG_FILE_INFORMATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01141">1141</a> of file <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html">lfs/registry.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00157">_LCH::ClientUndoCommitment</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00258">_LOG_FILE_INFORMATION::ClientUndoCommitment</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00243">_LOG_FILE_INFORMATION::CurrentAvailable</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00428">_LFS_RESTART_AREA::CurrentLsn</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00483">_LFCB::LastFlushedLsn</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00266">_LOG_FILE_INFORMATION::LastFlushedLsn</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00267">_LOG_FILE_INFORMATION::LastLsn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00142">_LCH::Lfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00517">LfsAcquireLch</a>, <a class="el" href="../../d8/d4/lfs_2verfysup_8c-source.html#l00036">LfsCurrentAvailSpace()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01141">LfsReadLogFileInformation()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00520">LfsReleaseLch</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00593">LfsValidateClientId</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00584">LfsValidateLch</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00467">_LFCB::OldestLsn</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00265">_LOG_FILE_INFORMATION::OldestLsn</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00435">_LFCB::RestartArea</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00511">_LFCB::TotalAvailable</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00235">_LOG_FILE_INFORMATION::TotalAvailable</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00513">_LFCB::TotalUndoCommitment</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00252">_LOG_FILE_INFORMATION::TotalUndoCommitment</a>, and <a class="el" href="../../d6/d4/cc_8h-source.html#l02154">try_return</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01141">LfsReadLogFileInformation()</a>.
<p>
<pre class="fragment"><div>01149                    :
01150 
01151     This routine returns information about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log
01152     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>, primarily to aid <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client perform its checkpoint processing.
01153 
01154 Arguments:
01155 
01156     LogHandle - Pointer to <span class="keyword">private</span> Lfs structure used to identify <span class="keyword">this</span>
01157                 client.
01158 
01159     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Pointer to buffer to <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> information.
01160 
01161     Length - On input <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user's buffer.  On output,
01162              <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> amount of data stored by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfs in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
01163 
01164 Return Value:
01165 
01166     None
01167 
01168 --*/
01169 
01170 {
01171     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
01172     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
01173 
01174     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01175 
01176     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsReadLogFileInformation:  Entered\n"</span>, 0 );
01177     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log Handle    -&gt; %08lx\n"</span>, LogHandle );
01178     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Buffer        -&gt; %08lx\n"</span>, Buffer );
01179     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Length        -&gt; %08lx\n"</span>, *Length );
01180 
01181     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
01182 
01183     <span class="comment">//</span>
01184     <span class="comment">//  Check that the structure is a valid log handle structure.</span>
01185     <span class="comment">//</span>
01186 
01187     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a32">LfsValidateLch</a>( Lch );
01188 
01189     <span class="comment">//</span>
01190     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
01191     <span class="comment">//</span>
01192 
01193     <span class="keywordflow">try</span> {
01194 
01195         <span class="comment">//</span>
01196         <span class="comment">//  Acquire the log file control block for this log file.</span>
01197         <span class="comment">//</span>
01198 
01199         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
01200         Lfcb = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>;
01201 
01202         <span class="comment">//</span>
01203         <span class="comment">//  If the Log file has been closed then return immediately.</span>
01204         <span class="comment">//</span>
01205 
01206         <span class="keywordflow">if</span> (Lfcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01207 
01208             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( *Length = 0 );
01209         }
01210 
01211         <span class="comment">//</span>
01212         <span class="comment">//  Check that the client Id is valid.</span>
01213         <span class="comment">//</span>
01214 
01215         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a33">LfsValidateClientId</a>( Lfcb, Lch );
01216 
01217         <span class="comment">//</span>
01218         <span class="comment">//  The buffer better be large enough.</span>
01219         <span class="comment">//</span>
01220 
01221         <span class="keywordflow">if</span> (*Length &gt;= <span class="keyword">sizeof</span>( <a class="code" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html">LOG_FILE_INFORMATION</a> )) {
01222 
01223             <a class="code" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html">PLOG_FILE_INFORMATION</a> Information;
01224             LONGLONG CurrentAvail;
01225             ULONG UnusedBytes;
01226 
01227             <a class="code" href="../../d7/d5/lfs_2verfysup_8c.html#a0">LfsCurrentAvailSpace</a>( Lfcb,
01228                                   &amp;CurrentAvail,
01229                                   &amp;UnusedBytes );
01230 
01231             <span class="comment">//</span>
01232             <span class="comment">//  Cast a pointer to the buffer and fill in the</span>
01233             <span class="comment">//  data.</span>
01234             <span class="comment">//</span>
01235 
01236             Information = (<a class="code" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html">PLOG_FILE_INFORMATION</a>) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
01237 
01238             Information-&gt;<a class="code" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html#o0">TotalAvailable</a> = Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o42">TotalAvailable</a>;
01239             Information-&gt;<a class="code" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html#o1">CurrentAvailable</a> =  CurrentAvail;
01240             Information-&gt;<a class="code" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html#o2">TotalUndoCommitment</a> = Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o44">TotalUndoCommitment</a>;
01241             Information-&gt;<a class="code" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html#o3">ClientUndoCommitment</a> = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o5">ClientUndoCommitment</a>;
01242 
01243             Information-&gt;<a class="code" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html#o4">OldestLsn</a> = Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o39">OldestLsn</a>;
01244             Information-&gt;<a class="code" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html#o5">LastFlushedLsn</a> = Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o41">LastFlushedLsn</a>;
01245             Information-&gt;<a class="code" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html#o6">LastLsn</a> = Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o30">RestartArea</a>-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o0">CurrentLsn</a>;
01246 
01247             *Length = <span class="keyword">sizeof</span>( <a class="code" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html">LOG_FILE_INFORMATION</a> );
01248 
01249         } <span class="keywordflow">else</span> {
01250 
01251             *Length = 0;
01252         }
01253 
01254     try_exit:  NOTHING;
01255     } finally {
01256 
01257         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsReadLogFileInformation );
01258 
01259         <span class="comment">//</span>
01260         <span class="comment">//  Release the log file control block if held.</span>
01261         <span class="comment">//</span>
01262 
01263         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
01264 
01265         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsReadLogFileInformation:  Exit\n"</span>, 0 );
01266     }
01267 
01268     <span class="keywordflow">return</span>;
01269 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="lfs/registry.c::LfsRemoveClientFromList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsRemoveClientFromList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientArray</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a22">PUSHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ListHead</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l04383">4383</a> of file <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html">lfs/registry.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00355">LFS_NO_CLIENT</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00382">_LFS_CLIENT_RECORD::NextClient</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00381">_LFS_CLIENT_RECORD::PrevClient</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00706">LfsCloseLogFile()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00366">LfsOpenLogFile()</a>.
<p>
<pre class="fragment"><div>04391                    :
04392 
04393     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to remove a client record from a client record
04394     list in an Lfs restart area.
04395 
04396 Arguments:
04397 
04398     ClientArray - Base of client records in restart area.
04399 
04400     ClientRecord - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> record to add.
04401 
04402     ListHead - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> beginning of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list.  This points to a
04403                <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first element in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list.
04404 
04405 Return Value:
04406 
04407     None.
04408 
04409 --*/
04410 
04411 {
04412     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> TempClientRecord;
04413 
04414     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04415 
04416     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsRemoveClientFromList:  Entered\n"</span>, 0 );
04417     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Client Array  -&gt; %08lx\n"</span>, ClientArray );
04418     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Client Record -&gt; %08lx\n"</span>, ClientRecord );
04419     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"List Head     -&gt; %08lx\n"</span>, ListHead );
04420 
04421     <span class="comment">//</span>
04422     <span class="comment">//  If this is the first element in the list, then the head of the list</span>
04423     <span class="comment">//  points to the element after this record.</span>
04424     <span class="comment">//</span>
04425 
04426     <span class="keywordflow">if</span> (ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o2">PrevClient</a> == <a class="code" href="../../d9/d3/lfsdisk_8h.html#a21">LFS_NO_CLIENT</a>) {
04427 
04428         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"Element is first element in the list\n"</span>, 0 );
04429         *ListHead = ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o3">NextClient</a>;
04430 
04431     <span class="comment">//</span>
04432     <span class="comment">//  Otherwise the previous element points to the next element.</span>
04433     <span class="comment">//</span>
04434 
04435     } <span class="keywordflow">else</span> {
04436 
04437         TempClientRecord = ClientArray + ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o2">PrevClient</a>;
04438         TempClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o3">NextClient</a> = ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o3">NextClient</a>;
04439     }
04440 
04441     <span class="comment">//</span>
04442     <span class="comment">//  If this is not the last element in the list, the previous element</span>
04443     <span class="comment">//  becomes the last element.</span>
04444     <span class="comment">//</span>
04445 
04446     <span class="keywordflow">if</span> (ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o3">NextClient</a> != <a class="code" href="../../d9/d3/lfsdisk_8h.html#a21">LFS_NO_CLIENT</a>) {
04447 
04448         TempClientRecord = ClientArray + ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o3">NextClient</a>;
04449         TempClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o2">PrevClient</a> = ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o2">PrevClient</a>;
04450     }
04451 
04452     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsRemoveClientFromList:  Exit\n"</span>, 0 );
04453 
04454     <span class="keywordflow">return</span>;
04455 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="lfs/registry.c::LfsRemoveClientFromList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsRemoveClientFromList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientArray</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a22">PUSHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ListHead</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="lfs/registry.c::LfsResetUndoTotal" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsResetUndoTotal           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LogHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberRecords</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResetTotal</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01361">1361</a> of file <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html">lfs/registry.c</a>.
<p>
References <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00157">_LCH::ClientUndoCommitment</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00548">_LFCB::Flags</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00142">_LCH::Lfcb</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00602">LFCB_PACK_LOG</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00517">LfsAcquireLch</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00520">LfsReleaseLch</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01361">LfsResetUndoTotal()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00593">LfsValidateClientId</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00584">LfsValidateLch</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00394">_LFCB::RecordHeaderLength</a>, and <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00513">_LFCB::TotalUndoCommitment</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01361">LfsResetUndoTotal()</a>.
<p>
<pre class="fragment"><div>01369                    :
01370 
01371     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to adjust <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> undo commitment <span class="keywordflow">for</span> <span class="keyword">this</span> client.
01372     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reset total <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> positive, then we absolutely set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01373     reserve value <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client <span class="keyword">using</span> <span class="keyword">this</span> as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> basis.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value
01374     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> negative, we will adjust <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current value <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client.
01375 
01376     To adjust <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> values in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfcb, we first <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Undo commitment
01377     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle and then adjust by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> values passed in.
01378 
01379     To adjust <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client handle, we simply set <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <span class="keywordflow">if</span>
01380     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reset value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> positive, adjust <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> negative.
01381 
01382     For a packed log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> we just reserve <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> space requested.  We
01383     have already taken into account <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loss of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tail of each page.
01384     For an unpacked log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> we <span class="keywordtype">double</span> each value.
01385 
01386 Arguments:
01387 
01388     LogHandle - Pointer to <span class="keyword">private</span> Lfs structure used to identify <span class="keyword">this</span>
01389                 client.
01390 
01391     NumberRecords - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of records we should assume <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01392                     reset total covers.  We allow an Lfs header <span class="keywordflow">for</span>
01393                     each one.
01394 
01395     ResetTotal - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> amount to adjust (or set) <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> undo
01396                  commitment.
01397 
01398 Return Value:
01399 
01400     None
01401 
01402 --*/
01403 
01404 {
01405     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
01406 
01407     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
01408 
01409     LONGLONG AdjustedUndoTotal;
01410     LONG LfsHeaderBytes;
01411 
01412     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01413 
01414     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsResetUndoTotal:  Entered\n"</span>, 0 );
01415     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log Handle        -&gt; %08lx\n"</span>, LogHandle );
01416     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Number Records    -&gt; %08lx\n"</span>, NumberRecords );
01417     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"ResetTotal        -&gt; %08lx\n"</span>, ResetTotal );
01418 
01419     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
01420 
01421     <span class="comment">//</span>
01422     <span class="comment">//  Check that the structure is a valid log handle structure.</span>
01423     <span class="comment">//</span>
01424 
01425     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a32">LfsValidateLch</a>( Lch );
01426 
01427     <span class="comment">//</span>
01428     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
01429     <span class="comment">//</span>
01430 
01431     <span class="keywordflow">try</span> {
01432 
01433         <span class="comment">//</span>
01434         <span class="comment">//  Acquire the log file control block for this log file.</span>
01435         <span class="comment">//</span>
01436 
01437         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
01438         Lfcb = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>;
01439 
01440         <span class="comment">//</span>
01441         <span class="comment">//  If the Log file has been closed then refuse access.</span>
01442         <span class="comment">//</span>
01443 
01444         <span class="keywordflow">if</span> (Lfcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01445 
01446             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_ACCESS_DENIED );
01447         }
01448 
01449         <span class="comment">//</span>
01450         <span class="comment">//  Check that the client Id is valid.</span>
01451         <span class="comment">//</span>
01452 
01453         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a33">LfsValidateClientId</a>( Lfcb, Lch );
01454 
01455         <span class="comment">//</span>
01456         <span class="comment">//  Compute the adjusted reset total.  Start by computing the</span>
01457         <span class="comment">//  bytes needed for the Lfs log headers.  Add (or subtract) this</span>
01458         <span class="comment">//  from the reset total and multiply by 2 (only if not packing the</span>
01459         <span class="comment">//  log).</span>
01460         <span class="comment">//</span>
01461 
01462         LfsHeaderBytes = NumberRecords * Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o20">RecordHeaderLength</a>;
01463         LfsHeaderBytes *= 2;
01464 
01465         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o54">Flags</a>, LFCB_PACK_LOG )) {
01466 
01467             ResetTotal *= 2;
01468         }
01469 
01470         <span class="comment">//</span>
01471         <span class="comment">//  If the reset total is positive, add the header bytes.</span>
01472         <span class="comment">//</span>
01473 
01474         <span class="keywordflow">if</span> (ResetTotal &gt; 0) {
01475 
01476             <span class="comment">//</span>
01477             <span class="comment">//  Subtract the client's current value from the TotalUndo</span>
01478             <span class="comment">//  commit if he is setting his value exactly.</span>
01479             <span class="comment">//</span>
01480 
01481             Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o44">TotalUndoCommitment</a> = Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o44">TotalUndoCommitment</a> - Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o5">ClientUndoCommitment</a>;
01482 
01483             <span class="comment">//</span>
01484             <span class="comment">//  We can clear the values in the user's handle at this</span>
01485             <span class="comment">//  time.</span>
01486             <span class="comment">//</span>
01487 
01488             Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o5">ClientUndoCommitment</a> = 0;
01489 
01490 
01491             ResetTotal += LfsHeaderBytes;
01492 
01493         <span class="comment">//</span>
01494         <span class="comment">//  Otherwise subtract the value for the header bytes.</span>
01495         <span class="comment">//</span>
01496 
01497         } <span class="keywordflow">else</span> {
01498 
01499             ResetTotal -= LfsHeaderBytes;
01500         }
01501 
01502         <span class="comment">//</span>
01503         <span class="comment">//  Now we adjust the Lfcb and Lch values by the adjustment amount.</span>
01504         <span class="comment">//</span>
01505 
01506         AdjustedUndoTotal = ResetTotal;
01507 
01508         Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o44">TotalUndoCommitment</a> = Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o44">TotalUndoCommitment</a> + AdjustedUndoTotal;
01509 
01510         Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o5">ClientUndoCommitment</a> = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o5">ClientUndoCommitment</a> + AdjustedUndoTotal;
01511 
01512     } finally {
01513 
01514         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsResetUndoTotal );
01515 
01516         <span class="comment">//</span>
01517         <span class="comment">//  Release the log file control block if held.</span>
01518         <span class="comment">//</span>
01519 
01520         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
01521 
01522         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsResetUndoTotal:  Exit\n"</span>, 0 );
01523     }
01524 
01525     <span class="keywordflow">return</span>;
01526 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="lfs/registry.c::LfsRestartLogFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> LfsRestartLogFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LogFile</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MaximumClients</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG LogPageSize&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d6/d3/lfs_8h.html#a22">PLFS_INFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LfsInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d5/d1/struct__LFS__WRITE__DATA.html">PLFS_WRITE_DATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WriteData</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01534">1534</a> of file <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html">lfs/registry.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01000">CcUnpinData()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00436">_LFCB::ClientArray</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00471">_LFS_RESTART_AREA::ClientArrayOffset</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00437">_LFCB::ClientArrayOffset</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00444">_LFS_RESTART_AREA::ClientInUseList</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00583">_LFCB::CurrentOpenLogCount</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00328">_LFCB::FileObject</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00477">_LFS_RESTART_AREA::FileSize</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00452">_LFS_RESTART_AREA::Flags</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00548">_LFCB::Flags</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00452">_LFCB::InitialRestartArea</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00607">LFCB_READ_FIRST_RESTART</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00608">LFCB_READ_SECOND_RESTART</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00153">LFS_DEFAULT_LOG_PAGE_SIZE</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00355">LFS_NO_CLIENT</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00345">LFS_SIGNATURE_MODIFIED_ULONG</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00509">LfsAcquireLfcb</a>, <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00041">LfsAllocateLfcb()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00438">LfsAllocateRestartArea</a>, <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00188">LfsDeallocateLfcb()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00442">LfsDeallocateRestartArea</a>, <a class="el" href="../../d8/d4/lfs_2verfysup_8c-source.html#l00412">LfsFindCurrentAvail()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l03193">LfsFindLastLsn()</a>, <a class="el" href="../../d6/d3/lfs_8h.html#a65a42">LfsFixedPageSize</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l03065">LfsInitializeLogFilePriv()</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00039">LfsLi0</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02246">LfsNormalizeBasicLogFile()</a>, <a class="el" href="../../d6/d3/lfs_8h.html#a65a41">LfsPackLog</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00084">LfsPinOrMapData()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l01402">LfsReadRestart()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00512">LfsReleaseLfcb</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01534">LfsRestartLogFile()</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00130">_LFS_WRITE_DATA::LfsStructureSize</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02514">LfsUpdateLfcbFromNoRestart()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02390">LfsUpdateLfcbFromPgHeader()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02697">LfsUpdateLfcbFromRestart()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02964">LfsUpdateRestartAreaFromLfcb()</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00510">_LFS_RESTART_AREA::LogClientArray</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00445">_LFCB::LogClients</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00298">_LFS_RESTART_PAGE_HEADER::LogPageSize</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00140">LSN</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00320">_LFS_RESTART_PAGE_HEADER::MajorVersion</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00319">_LFS_RESTART_PAGE_HEADER::MinorVersion</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00514">RESTART_SINGLE_PAGE_IO</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00435">_LFCB::RestartArea</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00464">_LFS_RESTART_AREA::RestartAreaLength</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00444">_LFCB::RestartAreaSize</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00386">_LFCB::RestartDataSize</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00305">_LFS_RESTART_PAGE_HEADER::RestartOffset</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00498">_LFS_RESTART_AREA::RestartOpenLogCount</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00062">SHORT</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00291">_LFS_RESTART_PAGE_HEADER::SystemPageSize</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00589">_LFCB::UserWriteData</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00366">LfsOpenLogFile()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01534">LfsRestartLogFile()</a>.
<p>
<pre class="fragment"><div>01545                    :
01546 
01547     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to process an existing log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> when <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> opened
01548     <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first time on a running system.  We walk through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> beginning
01549     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> looking <span class="keywordflow">for</span> a valid restart area.  Once we have a restart
01550     area, we can find <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next restart area and determine which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01551     most recent.  The data in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> restart area will tell us <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system
01552     has been gracefully shutdown and whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> in its current
01553     state can run on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current system.
01554 
01555     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> usable, we perform any necessary initialization on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01556     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to prepare <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <span class="keywordflow">for</span> operation.
01557 
01558 Arguments:
01559 
01560     LogFile - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to use as a log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
01561 
01562     MaximumClients - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum number of clients that will be
01563                      active in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> at any one time.
01564 
01565     LogPageSize - If specified (not 0), <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> recommended size of
01566                   <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log page.  Lfs will use <span class="keyword">this</span> as a guide in
01567                   determining <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log page size.
01568 
01569     FileSize - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> available size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
01570 
01571     LfsInfo - On entry, indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> state <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user may
01572         know about.  On <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>, indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> state that Lfs
01573         knows about.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a conduit <span class="keywordflow">for</span> Lfs to communicate with its
01574         clients.
01575 
01576     WriteData - Pointer to WRITE_DATA in caller's data structure.
01577 
01578 Return Value:
01579 
01580     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to an initialized Lfcb to use <span class="keywordflow">for</span>
01581                               <span class="keyword">this</span> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
01582 
01583 --*/
01584 
01585 {
01586     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> ThisLfcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01587     <a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a> RestartArea = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01588     <a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a> DiskRestartArea;
01589 
01590     BOOLEAN UninitializedFile;
01591 
01592     LONGLONG OriginalFileSize = FileSize;
01593     LONGLONG FirstRestartOffset;
01594     <a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html">PLFS_RESTART_PAGE_HEADER</a> FirstRestartPage;
01595     BOOLEAN FirstChkdskWasRun;
01596     BOOLEAN FirstValidPage;
01597     BOOLEAN FirstLogPacked;
01598     <a class="code" href="../../d6/d3/lfs_8h.html#a10">LSN</a> FirstRestartLastLsn;
01599 
01600     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> FirstRestartPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01601     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> SecondRestartPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01602 
01603     BOOLEAN PackLogFile = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01604     BOOLEAN UseDefaultLogPage = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01605     LARGE_INTEGER CurrentTime;
01606 
01607     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01608 
01609     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsRestartLogFile:  Entered\n"</span>, 0 );
01610     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"LogFile    -&gt; %08lx\n"</span>, LogFile );
01611     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Maximum Clients   -&gt; %04x\n"</span>, MaximumClients );
01612     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log Page Size     -&gt; %08lx\n"</span>, LogPageSize );
01613     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"File Size (Low)   -&gt; %08lx\n"</span>, FileSize.LowPart );
01614     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"File Size (High)  -&gt; %08lx\n"</span>, FileSize.HighPart );
01615     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Pack Log           -&gt; %04x\n"</span>, *LfsInfo );
01616 
01617     <span class="comment">//</span>
01618     <span class="comment">//  Remember if we are to pack the log file.  Once a log file has</span>
01619     <span class="comment">//  been packed we will attempt to keep it that way.</span>
01620     <span class="comment">//</span>
01621 
01622     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( *LfsInfo &gt;= LfsPackLog );
01623 
01624     <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> &gt;= <a class="code" href="../../d6/d3/lfs_8h.html#a1">LFS_DEFAULT_LOG_PAGE_SIZE</a>) &amp;&amp;
01625         (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> &lt;= <a class="code" href="../../d6/d3/lfs_8h.html#a1">LFS_DEFAULT_LOG_PAGE_SIZE</a> * 2) &amp;&amp;
01626         (*LfsInfo &gt;= <a class="code" href="../../d6/d3/lfs_8h.html#a65a42">LfsFixedPageSize</a>)) {
01627 
01628         UseDefaultLogPage = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01629     }
01630 
01631     <span class="comment">//</span>
01632     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
01633     <span class="comment">//</span>
01634 
01635     <span class="keywordflow">try</span> {
01636 
01637         <span class="comment">//</span>
01638         <span class="comment">//  Normalize the values passed in with this call.</span>
01639         <span class="comment">//</span>
01640 
01641         <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a2">LfsNormalizeBasicLogFile</a>( &amp;FileSize,
01642                                   &amp;LogPageSize,
01643                                   &amp;MaximumClients,
01644                                   UseDefaultLogPage );
01645 
01646         <span class="comment">//</span>
01647         <span class="comment">//  Allocate an Lfcb to use for this file.</span>
01648         <span class="comment">//</span>
01649 
01650         ThisLfcb = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a65">LfsAllocateLfcb</a>();
01651 
01652         <span class="comment">//</span>
01653         <span class="comment">//  Acquire the Lfcb and store it in the global queue.</span>
01654         <span class="comment">//</span>
01655 
01656         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a28">LfsAcquireLfcb</a>( ThisLfcb );
01657 
01658         <span class="comment">//</span>
01659         <span class="comment">//  Remember this log file in the Lfcb.</span>
01660         <span class="comment">//</span>
01661 
01662         ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o4">FileObject</a> = LogFile;
01663 
01664         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o54">Flags</a>,
01665                  (LFCB_READ_FIRST_RESTART |
01666                   LFCB_READ_SECOND_RESTART) );
01667 
01668         <span class="comment">//</span>
01669         <span class="comment">//  Look for a restart area on the disk.</span>
01670         <span class="comment">//</span>
01671 
01672         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a52">LfsReadRestart</a>( ThisLfcb,
01673                             FileSize,
01674                             TRUE,
01675                             &amp;FirstRestartOffset,
01676                             &amp;FirstRestartPage,
01677                             &amp;FirstRestartPageBcb,
01678                             &amp;FirstChkdskWasRun,
01679                             &amp;FirstValidPage,
01680                             &amp;UninitializedFile,
01681                             &amp;FirstLogPacked,
01682                             &amp;FirstRestartLastLsn )) {
01683 
01684             BOOLEAN DoubleRestart;
01685 
01686             LONGLONG SecondRestartOffset;
01687             <a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html">PLFS_RESTART_PAGE_HEADER</a> SecondRestartPage;
01688             BOOLEAN SecondChkdskWasRun;
01689             BOOLEAN SecondValidPage;
01690             BOOLEAN SecondLogPacked;
01691             <a class="code" href="../../d6/d3/lfs_8h.html#a10">LSN</a> SecondRestartLastLsn;
01692 
01693             <span class="comment">//</span>
01694             <span class="comment">//  If the restart offset above wasn't zero then we</span>
01695             <span class="comment">//  won't look for a second restart.</span>
01696             <span class="comment">//</span>
01697 
01698             <span class="keywordflow">if</span> (FirstRestartOffset == 0) {
01699 
01700                 <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o54">Flags</a>, LFCB_READ_FIRST_RESTART );
01701 
01702                 DoubleRestart = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a52">LfsReadRestart</a>( ThisLfcb,
01703                                                 FileSize,
01704                                                 FALSE,
01705                                                 &amp;SecondRestartOffset,
01706                                                 &amp;SecondRestartPage,
01707                                                 &amp;SecondRestartPageBcb,
01708                                                 &amp;SecondChkdskWasRun,
01709                                                 &amp;SecondValidPage,
01710                                                 &amp;UninitializedFile,
01711                                                 &amp;SecondLogPacked,
01712                                                 &amp;SecondRestartLastLsn );
01713 
01714                 <span class="keywordflow">if</span> (DoubleRestart) {
01715 
01716                     <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o54">Flags</a>, LFCB_READ_SECOND_RESTART );
01717                 }
01718 
01719             } <span class="keywordflow">else</span> {
01720 
01721                 <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o54">Flags</a>, LFCB_READ_SECOND_RESTART );
01722                 DoubleRestart = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01723             }
01724 
01725             <span class="comment">//</span>
01726             <span class="comment">//  Determine which restart area to use.</span>
01727             <span class="comment">//</span>
01728 
01729             <span class="keywordflow">if</span> (DoubleRestart
01730                 &amp;&amp; (SecondRestartLastLsn.QuadPart &gt; FirstRestartLastLsn.QuadPart)) {
01731 
01732                 BOOLEAN UseSecondPage = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01733                 PULONG SecondPage;
01734                 <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> SecondPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01735                 BOOLEAN UsaError;
01736 
01737                 <span class="comment">//</span>
01738                 <span class="comment">//  In a very strange case we could have crashed on a system with</span>
01739                 <span class="comment">//  a different page size and then run chkdsk on the new system.</span>
01740                 <span class="comment">//  The second restart page may not have the chkdsk signature in</span>
01741                 <span class="comment">//  that case but could have a higher final Lsn.</span>
01742                 <span class="comment">//  We want to ignore the second restart area in that case.</span>
01743                 <span class="comment">//</span>
01744 
01745                 <span class="keywordflow">if</span> (FirstChkdskWasRun &amp;&amp;
01746                     (SecondRestartOffset != <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) {
01747 
01748                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d4/lfsprocs_8h.html#a48">LfsPinOrMapData</a>( ThisLfcb,
01749                                                      PAGE_SIZE,
01750                                                      PAGE_SIZE,
01751                                                      FALSE,
01752                                                      TRUE,
01753                                                      TRUE,
01754                                                      &amp;UsaError,
01755                                                      &amp;SecondPage,
01756                                                      &amp;SecondPageBcb )) &amp;&amp;
01757                         (*SecondPage == <a class="code" href="../../d9/d3/lfsdisk_8h.html#a18">LFS_SIGNATURE_MODIFIED_ULONG</a>)) {
01758 
01759                         UseSecondPage = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01760                     }
01761 
01762                     <span class="keywordflow">if</span> (SecondPageBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01763 
01764                         <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( SecondPageBcb );
01765                     }
01766                 }
01767 
01768                 <span class="keywordflow">if</span> (UseSecondPage) {
01769 
01770                     FirstRestartOffset = SecondRestartOffset;
01771                     FirstRestartPage = SecondRestartPage;
01772                     FirstChkdskWasRun = SecondChkdskWasRun;
01773                     FirstValidPage = SecondValidPage;
01774                     FirstLogPacked = SecondLogPacked;
01775                     FirstRestartLastLsn = SecondRestartLastLsn;
01776                 }
01777             }
01778 
01779             <span class="comment">//</span>
01780             <span class="comment">//  If the restart area is at offset 0, we want to write</span>
01781             <span class="comment">//  the second restart area out first.</span>
01782             <span class="comment">//</span>
01783 
01784             <span class="keywordflow">if</span> (FirstRestartOffset != 0) {
01785 
01786                 ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o36">InitialRestartArea</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01787             }
01788 
01789             <span class="comment">//</span>
01790             <span class="comment">//  If we have a valid page then grab a pointer to the restart area.</span>
01791             <span class="comment">//</span>
01792 
01793             <span class="keywordflow">if</span> (FirstValidPage) {
01794 
01795                 DiskRestartArea = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( FirstRestartPage, FirstRestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o4">RestartOffset</a>, <a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a> );
01796             }
01797 
01798             <span class="comment">//</span>
01799             <span class="comment">//  If checkdisk was run or there are no active clients,</span>
01800             <span class="comment">//  then we will begin at the start of the log file.</span>
01801             <span class="comment">//</span>
01802 
01803             <span class="keywordflow">if</span> (FirstChkdskWasRun
01804                 || DiskRestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o3">ClientInUseList</a> == <a class="code" href="../../d9/d3/lfsdisk_8h.html#a21">LFS_NO_CLIENT</a>) {
01805 
01806                 <span class="comment">//</span>
01807                 <span class="comment">//  Default version is 1.1.</span>
01808                 <span class="comment">//</span>
01809 
01810                 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> MajorVersion = 1;
01811                 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> MinorVersion = 1;
01812 
01813                 BOOLEAN LogFileWrapped = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01814                 BOOLEAN UseMultiplePageIo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01815 
01816                 BOOLEAN ForceRestartToDisk = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01817 
01818                 BOOLEAN ClearLogFile = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01819 
01820                 LONGLONG StartOffsetForClear;
01821                 StartOffsetForClear = LogPageSize * 2;
01822 
01823                 <span class="comment">//</span>
01824                 <span class="comment">//  Do some checks based on whether we have a valid log page.</span>
01825                 <span class="comment">//</span>
01826 
01827                 <span class="keywordflow">if</span> (FirstValidPage) {
01828 
01829                     CurrentTime.LowPart = DiskRestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o12">RestartOpenLogCount</a>;
01830 
01831                     <span class="comment">//</span>
01832                     <span class="comment">//  If the restart page size isn't changing then we want to</span>
01833                     <span class="comment">//  check how much work we need to do.</span>
01834                     <span class="comment">//</span>
01835 
01836                     <span class="keywordflow">if</span> (LogPageSize == FirstRestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o2">SystemPageSize</a>) {
01837 
01838                         <span class="comment">//</span>
01839                         <span class="comment">//  If the file size is changing we want to remember</span>
01840                         <span class="comment">//  at which point we want to start clearing the file.</span>
01841                         <span class="comment">//</span>
01842 
01843                         <span class="keywordflow">if</span> (FileSize &gt; DiskRestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o8">FileSize</a>) {
01844 
01845                             StartOffsetForClear = DiskRestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o8">FileSize</a>;
01846 
01847                         } <span class="keywordflow">else</span> {
01848 
01849                             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DiskRestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o4">Flags</a>, RESTART_SINGLE_PAGE_IO )) {
01850 
01851                                 UseMultiplePageIo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01852                                 LogFileWrapped = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01853                             }
01854 
01855                             <span class="comment">//</span>
01856                             <span class="comment">//  If the page is valid we don't need to clear the log</span>
01857                             <span class="comment">//  file or force the data to disk.</span>
01858                             <span class="comment">//</span>
01859 
01860                             ForceRestartToDisk = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01861                             ClearLogFile = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01862                         }
01863                     }
01864 
01865                 } <span class="keywordflow">else</span> {
01866 
01867                     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>( &amp;CurrentTime );
01868                 }
01869 
01870                 <span class="comment">//</span>
01871                 <span class="comment">//  Initialize our Lfcb for the current log page values.</span>
01872                 <span class="comment">//</span>
01873 
01874                 <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a3">LfsUpdateLfcbFromPgHeader</a>( ThisLfcb,
01875                                            LogPageSize,
01876                                            LogPageSize,
01877                                            MajorVersion,
01878                                            MinorVersion,
01879                                            PackLogFile );
01880 
01881                 <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a4">LfsUpdateLfcbFromNoRestart</a>( ThisLfcb,
01882                                             FileSize,
01883                                             FirstRestartLastLsn,
01884                                             MaximumClients,
01885                                             CurrentTime.LowPart,
01886                                             LogFileWrapped,
01887                                             UseMultiplePageIo );
01888 
01889                 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a18">LfsAllocateRestartArea</a>( &amp;RestartArea, ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o18">RestartDataSize</a> );
01890 
01891                 <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a6">LfsUpdateRestartAreaFromLfcb</a>( ThisLfcb, RestartArea );
01892 
01893                 ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o30">RestartArea</a> = RestartArea;
01894                 ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a> = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( RestartArea,
01895                                                  ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o32">ClientArrayOffset</a>,
01896                                                  <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> );
01897                 RestartArea = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01898 
01899                 <span class="comment">//</span>
01900                 <span class="comment">//  Unpin any pages pinned here.</span>
01901                 <span class="comment">//</span>
01902 
01903                 <span class="keywordflow">if</span> (FirstRestartPageBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01904 
01905                     <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( FirstRestartPageBcb );
01906                     FirstRestartPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01907                 }
01908 
01909                 <span class="keywordflow">if</span> (SecondRestartPageBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01910 
01911                     <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( SecondRestartPageBcb );
01912                     SecondRestartPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01913                 }
01914 
01915                 <span class="comment">//</span>
01916                 <span class="comment">//  Now update the caller's WRITE_DATA structure.</span>
01917                 <span class="comment">//</span>
01918     
01919                 ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o62">UserWriteData</a> = WriteData;
01920                 WriteData-&gt;<a class="code" href="../../d5/d1/struct__LFS__WRITE__DATA.html#o2">LfsStructureSize</a> = LogPageSize;
01921                 WriteData-&gt;Lfcb = ThisLfcb;
01922     
01923                 <span class="comment">//</span>
01924                 <span class="comment">//  Put the restart areas out and initialize the log file</span>
01925                 <span class="comment">//  as required.</span>
01926                 <span class="comment">//</span>
01927 
01928                 <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a7">LfsInitializeLogFilePriv</a>( ThisLfcb,
01929                                           ForceRestartToDisk,
01930                                           ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o18">RestartDataSize</a>,
01931                                           StartOffsetForClear,
01932                                           ClearLogFile );
01933 
01934             <span class="comment">//</span>
01935             <span class="comment">//  If the log page or the system page sizes have changed,</span>
01936             <span class="comment">//  we can't use the log file.  We must use the system</span>
01937             <span class="comment">//  page size instead of the default size if there is not</span>
01938             <span class="comment">//  a clean shutdown.</span>
01939             <span class="comment">//</span>
01940 
01941             } <span class="keywordflow">else</span> {
01942 
01943                 <span class="keywordflow">if</span> (LogPageSize != FirstRestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o2">SystemPageSize</a>) {
01944 
01945                     FileSize = OriginalFileSize;
01946                     <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a2">LfsNormalizeBasicLogFile</a>( &amp;FileSize,
01947                                               &amp;LogPageSize,
01948                                               &amp;MaximumClients,
01949                                               (BOOLEAN) (FirstRestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o2">SystemPageSize</a> == LFS_DEFAULT_LOG_PAGE_SIZE) );
01950                 }
01951 
01952                 <span class="keywordflow">if</span> ((LogPageSize != FirstRestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o2">SystemPageSize</a>) || 
01953                     (LogPageSize != FirstRestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o3">LogPageSize</a>)) {
01954 
01955                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"Page size mismatch\n"</span>, 0 );
01956                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_DISK_CORRUPT_ERROR );
01957 
01958                 <span class="comment">//</span>
01959                 <span class="comment">//  If the file size has shrunk then we won't mount it.</span>
01960                 <span class="comment">//</span>
01961 
01962                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FileSize &lt; DiskRestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o8">FileSize</a>) {
01963 
01964                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"Log file has shrunk without clean shutdown\n"</span>, 0 );
01965                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_DISK_CORRUPT_ERROR );
01966 
01967                 <span class="comment">//</span>
01968                 <span class="comment">//  Otherwise we have a restart area to deal with.</span>
01969                 <span class="comment">//</span>
01970 
01971                 } <span class="keywordflow">else</span> {
01972 
01973                     <span class="comment">//</span>
01974                     <span class="comment">//  We preserve the packed status from the disk.</span>
01975                     <span class="comment">//</span>
01976 
01977                     PackLogFile = FirstLogPacked;
01978 
01979                     <span class="comment">//</span>
01980                     <span class="comment">//  Update the Lfcb from the values in the restart area</span>
01981                     <span class="comment">//  page header and the active restart page.</span>
01982                     <span class="comment">//</span>
01983 
01984                     <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a3">LfsUpdateLfcbFromPgHeader</a>( ThisLfcb,
01985                                                LogPageSize,
01986                                                LogPageSize,
01987                                                FirstRestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o6">MajorVersion</a>,
01988                                                FirstRestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o5">MinorVersion</a>,
01989                                                FirstLogPacked );
01990 
01991                     <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a20">LfsUpdateLfcbFromRestart</a>( ThisLfcb,
01992                                               DiskRestartArea,
01993                                               FirstRestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o4">RestartOffset</a> );
01994 
01995                     <span class="comment">//</span>
01996                     <span class="comment">//  Now allocate a restart area.</span>
01997                     <span class="comment">//</span>
01998 
01999                     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a18">LfsAllocateRestartArea</a>( &amp;RestartArea, ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o18">RestartDataSize</a> );
02000 
02001                     <span class="comment">//</span>
02002                     <span class="comment">//  We may need to grow the restart area to allow room for the open</span>
02003                     <span class="comment">//  log file count.</span>
02004                     <span class="comment">//</span>
02005 
02006                     <span class="keywordflow">if</span> (ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o32">ClientArrayOffset</a> == FIELD_OFFSET( <a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">LFS_RESTART_AREA</a>, LogClientArray )) {
02007 
02008                         RtlCopyMemory( RestartArea, DiskRestartArea, ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o34">RestartAreaSize</a> );
02009 
02010                     } <span class="keywordflow">else</span> {
02011 
02012                         LARGE_INTEGER CurrentTime;
02013 
02014                         <span class="comment">//</span>
02015                         <span class="comment">//  Copy the start of the restart area over.</span>
02016                         <span class="comment">//</span>
02017 
02018                         RtlCopyMemory( RestartArea, DiskRestartArea, ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o32">ClientArrayOffset</a> );
02019 
02020                         <span class="comment">//</span>
02021                         <span class="comment">//  Now copy over the client data to its new location.</span>
02022                         <span class="comment">//</span>
02023 
02024                         RtlCopyMemory( RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o14">LogClientArray</a>,
02025                                        <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( DiskRestartArea, ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o32">ClientArrayOffset</a>, PVOID ),
02026                                        DiskRestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o6">RestartAreaLength</a> - ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o32">ClientArrayOffset</a> );
02027 
02028                         <span class="comment">//</span>
02029                         <span class="comment">//  Update the system open count.</span>
02030                         <span class="comment">//</span>
02031 
02032                         <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>( &amp;CurrentTime );
02033 
02034                         ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o61">CurrentOpenLogCount</a> =
02035                         RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o12">RestartOpenLogCount</a> = CurrentTime.LowPart;
02036 
02037                         <span class="comment">//</span>
02038                         <span class="comment">//  Now update the numbers in the Lfcb and restart area.</span>
02039                         <span class="comment">//</span>
02040 
02041                         ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o32">ClientArrayOffset</a> = FIELD_OFFSET( <a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">LFS_RESTART_AREA</a>, LogClientArray );
02042                         ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o34">RestartAreaSize</a> = ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o32">ClientArrayOffset</a>
02043                                                     + (<span class="keyword">sizeof</span>( <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">LFS_CLIENT_RECORD</a> ) * ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o35">LogClients</a> );
02044 
02045                         RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o7">ClientArrayOffset</a> = ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o32">ClientArrayOffset</a>;
02046                         RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o6">RestartAreaLength</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o34">RestartAreaSize</a>;
02047                     }
02048 
02049                     <span class="comment">//</span>
02050                     <span class="comment">//  Update the log file open count.</span>
02051                     <span class="comment">//</span>
02052 
02053                     RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o12">RestartOpenLogCount</a> += 1;
02054 
02055                     ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o30">RestartArea</a> = RestartArea;
02056 
02057                     ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a> = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( RestartArea, ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o32">ClientArrayOffset</a>, <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> );
02058                     RestartArea = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02059 
02060                     <span class="comment">//</span>
02061                     <span class="comment">//  Unpin any pages pinned here.</span>
02062                     <span class="comment">//</span>
02063 
02064                     <span class="keywordflow">if</span> (FirstRestartPageBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02065 
02066                         <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( FirstRestartPageBcb );
02067                         FirstRestartPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02068                     }
02069 
02070                     <span class="keywordflow">if</span> (SecondRestartPageBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02071 
02072                         <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( SecondRestartPageBcb );
02073                         SecondRestartPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02074                     }
02075 
02076                     <span class="comment">//</span>
02077                     <span class="comment">//  Now update the caller's WRITE_DATA structure.</span>
02078                     <span class="comment">//</span>
02079         
02080                     ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o62">UserWriteData</a> = WriteData;
02081                     WriteData-&gt;<a class="code" href="../../d5/d1/struct__LFS__WRITE__DATA.html#o2">LfsStructureSize</a> = LogPageSize;
02082                     WriteData-&gt;Lfcb = ThisLfcb;
02083         
02084                     <span class="comment">//</span>
02085                     <span class="comment">//  Now we need to walk through looking for the last</span>
02086                     <span class="comment">//  Lsn.</span>
02087                     <span class="comment">//</span>
02088 
02089                     <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a8">LfsFindLastLsn</a>( ThisLfcb );
02090 
02091                     <span class="comment">//</span>
02092                     <span class="comment">//  Recalculate the available pages in the Lfcb.</span>
02093                     <span class="comment">//</span>
02094 
02095                     <a class="code" href="../../d7/d5/lfs_2verfysup_8c.html#a2">LfsFindCurrentAvail</a>( ThisLfcb );
02096 
02097                     <span class="comment">//</span>
02098                     <span class="comment">//  Remember which restart area to write out first.</span>
02099                     <span class="comment">//</span>
02100 
02101                     <span class="keywordflow">if</span> (FirstRestartOffset != 0) {
02102 
02103                         ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o36">InitialRestartArea</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02104                     }
02105 
02106                     <span class="comment">//</span>
02107                     <span class="comment">//  Queue the restart areas.</span>
02108                     <span class="comment">//</span>
02109 
02110                     <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a7">LfsInitializeLogFilePriv</a>( ThisLfcb,
02111                                               FALSE,
02112                                               ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o18">RestartDataSize</a>,
02113                                               0,
02114                                               FALSE );
02115                 }
02116             }
02117 
02118         <span class="comment">//</span>
02119         <span class="comment">//  If the file is uninitialized, we will initialized it with new</span>
02120         <span class="comment">//  restart areas.  We can move to version 1.0 where we use</span>
02121         <span class="comment">//  update sequence array support but don't have to force the values</span>
02122         <span class="comment">//  to disk.</span>
02123         <span class="comment">//</span>
02124 
02125         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (UninitializedFile) {
02126 
02127             <span class="comment">//</span>
02128             <span class="comment">//  We go to a packed system if possible.</span>
02129             <span class="comment">//</span>
02130 
02131             <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a3">LfsUpdateLfcbFromPgHeader</a>( ThisLfcb,
02132                                        LogPageSize,
02133                                        LogPageSize,
02134                                        1,
02135                                        1,
02136                                        PackLogFile );
02137 
02138             <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>( &amp;CurrentTime );
02139             <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a4">LfsUpdateLfcbFromNoRestart</a>( ThisLfcb,
02140                                         FileSize,
02141                                         LfsLi0,
02142                                         MaximumClients,
02143                                         CurrentTime.LowPart,
02144                                         FALSE,
02145                                         FALSE );
02146 
02147             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a18">LfsAllocateRestartArea</a>( &amp;RestartArea, ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o18">RestartDataSize</a> );
02148 
02149             <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a6">LfsUpdateRestartAreaFromLfcb</a>( ThisLfcb, RestartArea );
02150 
02151             ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o30">RestartArea</a> = RestartArea;
02152             ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a> = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( RestartArea, ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o32">ClientArrayOffset</a>, <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> );
02153 
02154             ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o36">InitialRestartArea</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02155             RestartArea = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02156 
02157             <span class="comment">//</span>
02158             <span class="comment">//  Now update the caller's WRITE_DATA structure.</span>
02159             <span class="comment">//</span>
02160 
02161             ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o62">UserWriteData</a> = WriteData;
02162             WriteData-&gt;<a class="code" href="../../d5/d1/struct__LFS__WRITE__DATA.html#o2">LfsStructureSize</a> = LogPageSize;
02163             WriteData-&gt;Lfcb = ThisLfcb;
02164 
02165             <span class="comment">//</span>
02166             <span class="comment">//  Put both restart areas in the queue to be flushed but don't</span>
02167             <span class="comment">//  force them to disk.</span>
02168             <span class="comment">//</span>
02169 
02170             <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a7">LfsInitializeLogFilePriv</a>( ThisLfcb,
02171                                       FALSE,
02172                                       ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o18">RestartDataSize</a>,
02173                                       0,
02174                                       FALSE );
02175 
02176         <span class="comment">//</span>
02177         <span class="comment">//  We didn't find a restart area but the file is not initialized.</span>
02178         <span class="comment">//  This is a corrupt disk.</span>
02179         <span class="comment">//</span>
02180 
02181         } <span class="keywordflow">else</span> {
02182 
02183             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"Log file has no restart area\n"</span>, 0 );
02184             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_DISK_CORRUPT_ERROR );
02185         }
02186 
02187     } finally {
02188 
02189         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsRestartLogFile );
02190 
02191         <span class="comment">//</span>
02192         <span class="comment">//  Free the Lfcb if allocated.</span>
02193         <span class="comment">//</span>
02194 
02195         <span class="keywordflow">if</span> (ThisLfcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02196 
02197             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a29">LfsReleaseLfcb</a>( ThisLfcb );
02198 
02199             <span class="comment">//</span>
02200             <span class="comment">//  Free the Lfcb and Restart areas in the event of an error.</span>
02201             <span class="comment">//</span>
02202 
02203             <span class="keywordflow">if</span> (AbnormalTermination()) {
02204 
02205                 <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a2">LfsDeallocateLfcb</a>( ThisLfcb, TRUE );
02206 
02207                 <span class="keywordflow">if</span> (RestartArea != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02208 
02209                     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a19">LfsDeallocateRestartArea</a>( RestartArea );
02210                 }
02211             }
02212         }
02213 
02214         <span class="keywordflow">if</span> (FirstRestartPageBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02215 
02216             <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( FirstRestartPageBcb );
02217         }
02218 
02219         <span class="keywordflow">if</span> (SecondRestartPageBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02220 
02221             <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( SecondRestartPageBcb );
02222         }
02223 
02224         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsRestartLogFile:  Exit\n"</span>, 0 );
02225     }
02226 
02227     <span class="comment">//</span>
02228     <span class="comment">//  Indicate whether the log is packed.</span>
02229     <span class="comment">//</span>
02230 
02231     <span class="keywordflow">if</span> (PackLogFile
02232         &amp;&amp; *LfsInfo &lt; <a class="code" href="../../d6/d3/lfs_8h.html#a65a41">LfsPackLog</a>) {
02233 
02234         *LfsInfo = <a class="code" href="../../d6/d3/lfs_8h.html#a65a41">LfsPackLog</a>;
02235     }
02236 
02237     <span class="keywordflow">return</span> ThisLfcb;
02238 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="lfs/registry.c::LfsUpdateLfcbFromNoRestart" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsUpdateLfcbFromNoRestart           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LastLsn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LogClients</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>OpenLogCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>LogFileWrapped</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>UseMultiplePageIo</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02514">2514</a> of file <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html">lfs/registry.c</a>.
<p>
References <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00599">LFCB_LOG_WRAPPED</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00600">LFCB_MULTIPLE_PAGE_IO</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00601">LFCB_NO_LAST_LSN</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00604">LFCB_NO_OLDEST_LSN</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00602">LFCB_PACK_LOG</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00132">LFS_RECORD_HEADER_SIZE</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00330">LFS_RESTART_PAGE_HEADER_SIZE</a>, <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00315">LfsAllocateLbcb()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00283">LfsFileOffsetToLsn</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00305">LfsLsnToSeqNumber</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00140">LSN</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00513">QuadAlign</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00075">UPDATE_SEQUENCE_NUMBER</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00150">LfsInitializeLogFile()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01534">LfsRestartLogFile()</a>.
<p>
<pre class="fragment"><div>02526                    :
02527 
02528     This routine updates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> values in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfcb in cases when we don'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> have a
02529     restart area to use.
02530 
02531 Arguments:
02532 
02533     Lfcb - Log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block to update.
02534 
02535     FileSize - Log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> size.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> usable size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  It has
02536         already been adjusted to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log page size.
02537 
02538     LastLsn - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last Lsn to use <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk.
02539 
02540     LogClients - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of clients supported.
02541 
02542     OpenLogCount - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current count of opens <span class="keywordflow">for</span> <span class="keyword">this</span> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
02543 
02544     LogFileWrapped - Indicates <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> has wrapped.
02545 
02546     UseMultiplePageIo - Indicates <span class="keywordflow">if</span> we should be <span class="keyword">using</span> large i/o transfers.
02547 
02548 Return Value:
02549 
02550     None.
02551 
02552 --*/
02553 
02554 {
02555     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
02556 
02557     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02558 
02559     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsUpdateLfcbFromNoRestart:  Entered\n"</span>, 0 );
02560 
02561     Lfcb-&gt;FileSize = FileSize;
02562 
02563     <span class="comment">//</span>
02564     <span class="comment">//  We can compute the number of bits needed for the file size by shifting</span>
02565     <span class="comment">//  until the size is 0.  We then can subtract 3 bits to account for</span>
02566     <span class="comment">//  quadaligning all file offsets for log records.</span>
02567     <span class="comment">//</span>
02568 
02569     <span class="keywordflow">for</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
02570          ( FileSize != 0 );
02571          <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> += 1,
02572          FileSize = ((ULONGLONG)(FileSize)) &gt;&gt; 1) {
02573     }
02574 
02575     Lfcb-&gt;FileDataBits = <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> - 3;
02576 
02577     Lfcb-&gt;SeqNumberBits = (<span class="keyword">sizeof</span>( <a class="code" href="../../d6/d3/lfs_8h.html#a10">LSN</a> ) * 8) - Lfcb-&gt;FileDataBits;
02578 
02579     <span class="comment">//</span>
02580     <span class="comment">//  We get a starting sequence number from the given Lsn.</span>
02581     <span class="comment">//  We add 2 to this for our starting sequence number.</span>
02582     <span class="comment">//</span>
02583 
02584     Lfcb-&gt;SeqNumber = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a13">LfsLsnToSeqNumber</a>( Lfcb, LastLsn ) + 2;
02585 
02586     Lfcb-&gt;SeqNumberForWrap = Lfcb-&gt;SeqNumber + 1;
02587 
02588     Lfcb-&gt;NextLogPage = Lfcb-&gt;FirstLogPage;
02589 
02590     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Lfcb-&gt;Flags, LFCB_NO_LAST_LSN | LFCB_NO_OLDEST_LSN );
02591 
02592     <span class="comment">//</span>
02593     <span class="comment">//  The oldest Lsn is contructed from the sequence number.</span>
02594     <span class="comment">//</span>
02595 
02596     Lfcb-&gt;OldestLsn.QuadPart = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a8">LfsFileOffsetToLsn</a>( Lfcb, 0, Lfcb-&gt;SeqNumber );
02597     Lfcb-&gt;OldestLsnOffset = 0;
02598 
02599     Lfcb-&gt;LastFlushedLsn = Lfcb-&gt;OldestLsn;
02600 
02601     <span class="comment">//</span>
02602     <span class="comment">//  Set the correct flags for the I/O and indicate if we have wrapped.</span>
02603     <span class="comment">//</span>
02604 
02605     <span class="keywordflow">if</span> (LogFileWrapped) {
02606 
02607         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Lfcb-&gt;Flags, LFCB_LOG_WRAPPED );
02608     }
02609 
02610     <span class="keywordflow">if</span> (UseMultiplePageIo) {
02611 
02612         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Lfcb-&gt;Flags, LFCB_MULTIPLE_PAGE_IO );
02613     }
02614 
02615     <span class="comment">//</span>
02616     <span class="comment">//  Compute the Log page values.</span>
02617     <span class="comment">//</span>
02618 
02619     (ULONG)Lfcb-&gt;LogPageDataOffset = <a class="code" href="../../d5/d5/cc_8h.html#a62">QuadAlign</a>( Lfcb-&gt;LogRecordUsaOffset
02620                                                  + (<span class="keyword">sizeof</span>( <a class="code" href="../../d6/d3/lfs_8h.html#a2">UPDATE_SEQUENCE_NUMBER</a> ) * Lfcb-&gt;LogRecordUsaArraySize) );
02621 
02622     Lfcb-&gt;LogPageDataSize = Lfcb-&gt;LogPageSize - Lfcb-&gt;LogPageDataOffset;
02623     Lfcb-&gt;RecordHeaderLength = <a class="code" href="../../d9/d3/lfsdisk_8h.html#a6">LFS_RECORD_HEADER_SIZE</a>;
02624 
02625     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_PACK_LOG )) {
02626 
02627         <span class="comment">//</span>
02628         <span class="comment">//  Allocate the Lbcb for the tail of the packed log file.</span>
02629         <span class="comment">//</span>
02630 
02631         <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a3">LfsAllocateLbcb</a>( Lfcb, &amp;Lfcb-&gt;PrevTail );
02632         Lfcb-&gt;PrevTail-&gt;FileOffset = Lfcb-&gt;FirstLogPage - Lfcb-&gt;LogPageSize;
02633 
02634         <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a3">LfsAllocateLbcb</a>( Lfcb, &amp;Lfcb-&gt;ActiveTail );
02635         Lfcb-&gt;ActiveTail-&gt;FileOffset = Lfcb-&gt;PrevTail-&gt;FileOffset - Lfcb-&gt;LogPageSize;
02636 
02637         <span class="comment">//</span>
02638         <span class="comment">//  Remember the different page sizes for reservation.</span>
02639         <span class="comment">//</span>
02640 
02641         (ULONG)Lfcb-&gt;ReservedLogPageSize = (ULONG)Lfcb-&gt;LogPageDataSize - Lfcb-&gt;RecordHeaderLength;
02642 
02643     } <span class="keywordflow">else</span> {
02644 
02645         (ULONG)Lfcb-&gt;ReservedLogPageSize = (ULONG)Lfcb-&gt;LogPageDataSize;
02646     }
02647 
02648     <span class="comment">//</span>
02649     <span class="comment">//  Compute the restart page values.</span>
02650     <span class="comment">//</span>
02651 
02652     Lfcb-&gt;RestartDataOffset = <a class="code" href="../../d5/d5/cc_8h.html#a62">QuadAlign</a>( LFS_RESTART_PAGE_HEADER_SIZE
02653                                          + (<span class="keyword">sizeof</span>( UPDATE_SEQUENCE_NUMBER ) * Lfcb-&gt;RestartUsaArraySize) );
02654 
02655     Lfcb-&gt;RestartDataSize = (ULONG)Lfcb-&gt;SystemPageSize - Lfcb-&gt;RestartDataOffset;
02656 
02657     Lfcb-&gt;LogClients = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) LogClients;
02658 
02659     Lfcb-&gt;ClientArrayOffset = FIELD_OFFSET( <a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">LFS_RESTART_AREA</a>, LogClientArray );
02660 
02661     Lfcb-&gt;RestartAreaSize = Lfcb-&gt;ClientArrayOffset
02662                             + (<span class="keyword">sizeof</span>( <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">LFS_CLIENT_RECORD</a> ) * Lfcb-&gt;LogClients );
02663 
02664     Lfcb-&gt;CurrentOpenLogCount = OpenLogCount;
02665 
02666     <span class="comment">//</span>
02667     <span class="comment">//  The total available log file space is the number of log file pages times</span>
02668     <span class="comment">//  the space available on each page.</span>
02669     <span class="comment">//</span>
02670 
02671     Lfcb-&gt;TotalAvailInPages = Lfcb-&gt;FileSize - Lfcb-&gt;FirstLogPage;
02672     Lfcb-&gt;TotalAvailable = Int64ShrlMod32(((ULONGLONG)(Lfcb-&gt;TotalAvailInPages)), Lfcb-&gt;LogPageShift);
02673 
02674     <span class="comment">//</span>
02675     <span class="comment">//  If the log file is packed we assume that we can't use the end of the</span>
02676     <span class="comment">//  page less than the file record size.  Then we won't need to reserve more</span>
02677     <span class="comment">//  than the caller asks for.</span>
02678     <span class="comment">//</span>
02679 
02680     Lfcb-&gt;MaxCurrentAvail = Lfcb-&gt;TotalAvailable * (ULONG)Lfcb-&gt;ReservedLogPageSize;
02681 
02682     Lfcb-&gt;TotalAvailable = Lfcb-&gt;TotalAvailable * (ULONG)Lfcb-&gt;LogPageDataSize;
02683 
02684     Lfcb-&gt;CurrentAvailable = Lfcb-&gt;MaxCurrentAvail;
02685 
02686     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsUpdateLfcbFromNoRestart:  Exit\n"</span>, 0 );
02687 
02688     <span class="keywordflow">return</span>;
02689 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="lfs/registry.c::LfsUpdateLfcbFromPgHeader" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsUpdateLfcbFromPgHeader           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemPageSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LogPageSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a13">SHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MajorVersion</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a13">SHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MinorVersion</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>PackLog</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02390">2390</a> of file <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html">lfs/registry.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00602">LFCB_PACK_LOG</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00259">LFS_PACKED_RECORD_PAGE_HEADER_SIZE</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00330">LFS_RESTART_PAGE_HEADER_SIZE</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00255">LFS_UNPACKED_RECORD_PAGE_HEADER_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00042">UpdateSequenceArraySize</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00150">LfsInitializeLogFile()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01534">LfsRestartLogFile()</a>.
<p>
<pre class="fragment"><div>02401                    :
02402 
02403     This routine updates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> values in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfcb which depend on values in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02404     restart page header.
02405 
02406 Arguments:
02407 
02408     Lfcb - Log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block to update.
02409 
02410     SystemPageSize - System page size to use.
02411 
02412     LogPageSize - Log page size to use.
02413 
02414     MajorVersion - Major version number <span class="keywordflow">for</span> Lfs.
02415 
02416     MinorVersion - Minor version number <span class="keywordflow">for</span> Lfs.
02417 
02418     PackLog - Indicates <span class="keywordflow">if</span> we are packing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
02419 
02420 Return Value:
02421 
02422     None.
02423 
02424 --*/
02425 
02426 {
02427     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02428 
02429     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsUpdateLfcbFromPgHeader:  Entered\n"</span>, 0 );
02430     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lfcb              -&gt; %08lx\n"</span>, Lfcb );
02431     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"System Page Size  -&gt; %08lx\n"</span>, SystemPageSize );
02432     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log Page Size     -&gt; %08lx\n"</span>, LogPageSize );
02433     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Major Version     -&gt; %04x\n"</span>, MajorVersion );
02434     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Minor Version     -&gt; %04x\n"</span>, MinorVersion );
02435 
02436     <span class="comment">//</span>
02437     <span class="comment">//  Compute the restart page values.</span>
02438     <span class="comment">//</span>
02439 
02440     Lfcb-&gt;SystemPageSize = SystemPageSize;
02441     Lfcb-&gt;SystemPageMask = SystemPageSize - 1;
02442     Lfcb-&gt;SystemPageInverseMask = ~Lfcb-&gt;SystemPageMask;
02443 
02444     <span class="comment">//</span>
02445     <span class="comment">//  Do the same for the log pages.</span>
02446     <span class="comment">//</span>
02447 
02448     Lfcb-&gt;LogPageSize = LogPageSize;
02449     Lfcb-&gt;LogPageMask = LogPageSize - 1;
02450     Lfcb-&gt;LogPageInverseMask = ~Lfcb-&gt;LogPageMask;
02451 
02452     Lfcb-&gt;LogPageShift = 0;
02453 
02454     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02455 
02456         LogPageSize = LogPageSize &gt;&gt; 1;
02457 
02458         <span class="keywordflow">if</span> (LogPageSize == 0) {
02459 
02460             <span class="keywordflow">break</span>;
02461         }
02462 
02463         Lfcb-&gt;LogPageShift += 1;
02464     }
02465 
02466     <span class="comment">//</span>
02467     <span class="comment">//  If we are packing the log file then the first log page is page</span>
02468     <span class="comment">//  4.  Otherwise it is page 2.  Use the PackLog value to determine the</span>
02469     <span class="comment">//  Usa values.</span>
02470     <span class="comment">//</span>
02471 
02472     Lfcb-&gt;FirstLogPage = Lfcb-&gt;SystemPageSize &lt;&lt; 1;
02473 
02474     <span class="keywordflow">if</span> (PackLog) {
02475 
02476         Lfcb-&gt;FirstLogPage = ( Lfcb-&gt;LogPageSize &lt;&lt; 1 ) + Lfcb-&gt;FirstLogPage;
02477 
02478         Lfcb-&gt;LogRecordUsaOffset = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) <a class="code" href="../../d9/d3/lfsdisk_8h.html#a9">LFS_PACKED_RECORD_PAGE_HEADER_SIZE</a>;
02479 
02480         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Lfcb-&gt;Flags, LFCB_PACK_LOG );
02481 
02482     } <span class="keywordflow">else</span> {
02483 
02484         Lfcb-&gt;LogRecordUsaOffset = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) <a class="code" href="../../d9/d3/lfsdisk_8h.html#a8">LFS_UNPACKED_RECORD_PAGE_HEADER_SIZE</a>;
02485     }
02486 
02487     <span class="comment">//</span>
02488     <span class="comment">//  Remember the values for the version numbers.</span>
02489     <span class="comment">//</span>
02490 
02491     Lfcb-&gt;MajorVersion = MajorVersion;
02492     Lfcb-&gt;MinorVersion = MinorVersion;
02493 
02494     <span class="comment">//</span>
02495     <span class="comment">//  Compute the offsets for the update sequence arrays.</span>
02496     <span class="comment">//</span>
02497 
02498     Lfcb-&gt;RestartUsaOffset = <a class="code" href="../../d9/d3/lfsdisk_8h.html#a10">LFS_RESTART_PAGE_HEADER_SIZE</a>;
02499 
02500     Lfcb-&gt;RestartUsaArraySize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) <a class="code" href="../../d9/d3/lfsdisk_8h.html#a3">UpdateSequenceArraySize</a>( (ULONG)Lfcb-&gt;SystemPageSize );
02501     Lfcb-&gt;LogRecordUsaArraySize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) <a class="code" href="../../d9/d3/lfsdisk_8h.html#a3">UpdateSequenceArraySize</a>( (ULONG)Lfcb-&gt;LogPageSize );
02502 
02503     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsUpdateLfcbFromPgHeader:  Exit\n"</span>, 0 );
02504 
02505     <span class="keywordflow">return</span>;
02506 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="lfs/registry.c::LfsUpdateLfcbFromRestart" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsUpdateLfcbFromRestart           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RestartArea</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RestartOffset</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02697">2697</a> of file <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html">lfs/registry.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00599">LFCB_LOG_WRAPPED</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00600">LFCB_MULTIPLE_PAGE_IO</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00601">LFCB_NO_LAST_LSN</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00604">LFCB_NO_OLDEST_LSN</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00602">LFCB_PACK_LOG</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00603">LFCB_REUSE_TAIL</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00132">LFS_RECORD_HEADER_SIZE</a>, <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00315">LfsAllocateLbcb()</a>, <a class="el" href="../../d8/d4/lfs_2verfysup_8c-source.html#l00412">LfsFindCurrentAvail()</a>, <a class="el" href="../../d8/d9/rstrtsup_8c-source.html#l00189">LfsFindOldestClientLsn()</a>, <a class="el" href="../../d0/d7/lsnsup_8c-source.html#l00036">LfsLsnFinalOffset()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00302">LfsLsnToFileOffset</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00305">LfsLsnToSeqNumber</a>, <a class="el" href="../../d7/d4/logpgsup_8c-source.html#l00040">LfsNextLogPageOffset()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00184">LfsTruncateOffsetToLogPage</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00140">LSN</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00513">QuadAlign</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00514">RESTART_SINGLE_PAGE_IO</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, and <a class="el" href="../../d7/d2/lfs_8h-source.html#l00075">UPDATE_SEQUENCE_NUMBER</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01534">LfsRestartLogFile()</a>.
<p>
<pre class="fragment"><div>02705                    :
02706 
02707     This routine updates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> values in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfcb based on data in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02708     restart area.
02709 
02710 Arguments:
02711 
02712     Lfcb - Log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block to update.
02713 
02714     RestartArea - Restart area to use to update <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfcb.
02715 
02716     RestartOffset - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> restart area in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> restart page.
02717 
02718 Return Value:
02719 
02720     None.
02721 
02722 --*/
02723 
02724 {
02725     LONGLONG LsnFileOffset;
02726 
02727     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02728 
02729     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsUpdateLfcbFromRestartArea:  Entered\n"</span>, 0 );
02730     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lfcb          -&gt; %08lx\n"</span>, Lfcb );
02731     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"RestartArea   -&gt; %08lx\n"</span>, RestartArea );
02732 
02733     Lfcb-&gt;FileSize = RestartArea-&gt;FileSize;
02734 
02735     <span class="comment">//</span>
02736     <span class="comment">//  We get the sequence number bits from the restart area and compute the</span>
02737     <span class="comment">//  file data bits.</span>
02738     <span class="comment">//</span>
02739 
02740     Lfcb-&gt;SeqNumberBits = RestartArea-&gt;SeqNumberBits;
02741     Lfcb-&gt;FileDataBits = (<span class="keyword">sizeof</span>( <a class="code" href="../../d6/d3/lfs_8h.html#a10">LSN</a> ) * 8) - Lfcb-&gt;SeqNumberBits;
02742 
02743     <span class="comment">//</span>
02744     <span class="comment">//  We look at the last flushed Lsn to determine the current sequence count and</span>
02745     <span class="comment">//  the next log page to examine.</span>
02746     <span class="comment">//</span>
02747 
02748     Lfcb-&gt;LastFlushedLsn = RestartArea-&gt;CurrentLsn;
02749 
02750     Lfcb-&gt;SeqNumber = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a13">LfsLsnToSeqNumber</a>( Lfcb, Lfcb-&gt;LastFlushedLsn );
02751     Lfcb-&gt;SeqNumberForWrap = Lfcb-&gt;SeqNumber + 1;
02752 
02753     <span class="comment">//</span>
02754     <span class="comment">//  The restart area size depends on the number of clients and whether the</span>
02755     <span class="comment">//  the file is packed.</span>
02756     <span class="comment">//</span>
02757 
02758     Lfcb-&gt;LogClients = RestartArea-&gt;LogClients;
02759 
02760     <span class="comment">//</span>
02761     <span class="comment">//  Compute the restart page values from the restart offset.</span>
02762     <span class="comment">//</span>
02763 
02764     Lfcb-&gt;RestartDataOffset = RestartOffset;
02765     Lfcb-&gt;RestartDataSize = (ULONG)Lfcb-&gt;SystemPageSize - RestartOffset;
02766 
02767     <span class="comment">//</span>
02768     <span class="comment">//  For a packed log file we can find the following values in the restart</span>
02769     <span class="comment">//  area.  Otherwise we compute them from the current structure sizes.</span>
02770     <span class="comment">//</span>
02771 
02772     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_PACK_LOG )) {
02773 
02774         Lfcb-&gt;RecordHeaderLength = RestartArea-&gt;RecordHeaderLength;
02775 
02776         Lfcb-&gt;ClientArrayOffset = RestartArea-&gt;ClientArrayOffset;
02777 
02778         Lfcb-&gt;RestartAreaSize = RestartArea-&gt;RestartAreaLength;
02779 
02780         (ULONG)Lfcb-&gt;LogPageDataOffset = RestartArea-&gt;LogPageDataOffset;
02781         Lfcb-&gt;LogPageDataSize = Lfcb-&gt;LogPageSize - Lfcb-&gt;LogPageDataOffset;
02782 
02783         <span class="comment">//</span>
02784         <span class="comment">//  For packed files we allocate the tail Lbcbs.</span>
02785         <span class="comment">//</span>
02786 
02787         <span class="comment">//</span>
02788         <span class="comment">//  Allocate the Lbcb for the tail of the packed log file.</span>
02789         <span class="comment">//</span>
02790 
02791         <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a3">LfsAllocateLbcb</a>( Lfcb, &amp;Lfcb-&gt;PrevTail );
02792         Lfcb-&gt;PrevTail-&gt;FileOffset = Lfcb-&gt;FirstLogPage - Lfcb-&gt;LogPageSize;
02793 
02794         <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a3">LfsAllocateLbcb</a>( Lfcb, &amp;Lfcb-&gt;ActiveTail );
02795         Lfcb-&gt;ActiveTail-&gt;FileOffset = Lfcb-&gt;PrevTail-&gt;FileOffset - Lfcb-&gt;LogPageSize;
02796 
02797         <span class="comment">//</span>
02798         <span class="comment">//  Remember the different page sizes for reservation.</span>
02799         <span class="comment">//</span>
02800 
02801         (ULONG)Lfcb-&gt;ReservedLogPageSize = (ULONG)Lfcb-&gt;LogPageDataSize - Lfcb-&gt;RecordHeaderLength;
02802 
02803     } <span class="keywordflow">else</span> {
02804 
02805         Lfcb-&gt;RecordHeaderLength = <a class="code" href="../../d9/d3/lfsdisk_8h.html#a6">LFS_RECORD_HEADER_SIZE</a>;
02806         Lfcb-&gt;ClientArrayOffset = FIELD_OFFSET( <a class="code" href="../../d6/d0/struct__LFS__OLD__RESTART__AREA.html">LFS_OLD_RESTART_AREA</a>, LogClientArray );
02807 
02808         Lfcb-&gt;RestartAreaSize = Lfcb-&gt;ClientArrayOffset
02809                                 + (<span class="keyword">sizeof</span>( <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">LFS_CLIENT_RECORD</a> ) * Lfcb-&gt;LogClients);
02810 
02811         (ULONG)Lfcb-&gt;LogPageDataOffset = <a class="code" href="../../d5/d5/cc_8h.html#a62">QuadAlign</a>( Lfcb-&gt;LogRecordUsaOffset
02812                                                      + (<span class="keyword">sizeof</span>( UPDATE_SEQUENCE_NUMBER ) * Lfcb-&gt;LogRecordUsaArraySize) );
02813 
02814         Lfcb-&gt;LogPageDataSize = Lfcb-&gt;LogPageSize - Lfcb-&gt;LogPageDataOffset;
02815 
02816         (ULONG)Lfcb-&gt;ReservedLogPageSize = (ULONG)Lfcb-&gt;LogPageDataSize;
02817     }
02818 
02819     <span class="comment">//</span>
02820     <span class="comment">//  If the current last flushed Lsn offset is before the first log page</span>
02821     <span class="comment">//  then this is a pseudo Lsn.</span>
02822     <span class="comment">//</span>
02823 
02824     LsnFileOffset = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a12">LfsLsnToFileOffset</a>( Lfcb, Lfcb-&gt;LastFlushedLsn );
02825 
02826     <span class="keywordflow">if</span> ( LsnFileOffset &lt; Lfcb-&gt;FirstLogPage ) {
02827 
02828         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Lfcb-&gt;Flags, LFCB_NO_LAST_LSN );
02829         Lfcb-&gt;NextLogPage = Lfcb-&gt;FirstLogPage;
02830 
02831     <span class="comment">//</span>
02832     <span class="comment">//  Otherwise look at the last Lsn to determine where it ends in the file.</span>
02833     <span class="comment">//</span>
02834 
02835     } <span class="keywordflow">else</span> {
02836 
02837         LONGLONG LsnFinalOffset;
02838         BOOLEAN Wrapped;
02839 
02840         ULONG DataLength;
02841         ULONG RemainingPageBytes;
02842 
02843         DataLength = RestartArea-&gt;LastLsnDataLength;
02844 
02845         <span class="comment">//</span>
02846         <span class="comment">//  Find the end of this log record.</span>
02847         <span class="comment">//</span>
02848 
02849         <a class="code" href="../../d9/d7/lsnsup_8c.html#a1">LfsLsnFinalOffset</a>( Lfcb,
02850                            Lfcb-&gt;LastFlushedLsn,
02851                            DataLength,
02852                            &amp;LsnFinalOffset );
02853 
02854         <span class="comment">//</span>
02855         <span class="comment">//  If we wrapped in the file then increment the sequence number.</span>
02856         <span class="comment">//</span>
02857 
02858         <span class="keywordflow">if</span> ( LsnFinalOffset &lt;= LsnFileOffset ) {
02859 
02860             Lfcb-&gt;SeqNumber = 1 + Lfcb-&gt;SeqNumber;
02861 
02862             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Lfcb-&gt;Flags, LFCB_LOG_WRAPPED );
02863         }
02864 
02865         <span class="comment">//</span>
02866         <span class="comment">//  Now compute the next log page to use.  If we are packing the log file</span>
02867         <span class="comment">//  we will attempt to use the same page.</span>
02868         <span class="comment">//</span>
02869 
02870         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a6">LfsTruncateOffsetToLogPage</a>( Lfcb, LsnFinalOffset, &amp;LsnFileOffset );
02871 
02872         RemainingPageBytes = (ULONG)Lfcb-&gt;LogPageSize
02873                              - ((((ULONG)LsnFinalOffset) &amp; Lfcb-&gt;LogPageMask) + 1);
02874 
02875         <span class="comment">//</span>
02876         <span class="comment">//  If we are packing the log file and we can fit another log record on the</span>
02877         <span class="comment">//  page, move back a page in the log file.</span>
02878         <span class="comment">//</span>
02879 
02880         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_PACK_LOG )
02881             &amp;&amp; (RemainingPageBytes &gt;= Lfcb-&gt;RecordHeaderLength)) {
02882 
02883             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Lfcb-&gt;Flags, LFCB_REUSE_TAIL );
02884             Lfcb-&gt;NextLogPage = LsnFileOffset;
02885             Lfcb-&gt;ReusePageOffset = (ULONG)Lfcb-&gt;LogPageSize - RemainingPageBytes;
02886 
02887         } <span class="keywordflow">else</span> {
02888 
02889             <a class="code" href="../../d6/d5/logpgsup_8c.html#a2">LfsNextLogPageOffset</a>( Lfcb, LsnFileOffset, &amp;Lfcb-&gt;NextLogPage, &amp;Wrapped );
02890         }
02891     }
02892 
02893     <span class="comment">//</span>
02894     <span class="comment">//  Find the oldest client Lsn.  Use the last flushed Lsn as a starting point.</span>
02895     <span class="comment">//</span>
02896 
02897     Lfcb-&gt;OldestLsn = Lfcb-&gt;LastFlushedLsn;
02898 
02899     <a class="code" href="../../d7/d0/rstrtsup_8c.html#a2">LfsFindOldestClientLsn</a>( RestartArea,
02900                             <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( RestartArea, Lfcb-&gt;ClientArrayOffset, <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ),
02901                             &amp;Lfcb-&gt;OldestLsn );
02902 
02903     Lfcb-&gt;OldestLsnOffset = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a12">LfsLsnToFileOffset</a>( Lfcb, Lfcb-&gt;OldestLsn );
02904 
02905     <span class="comment">//</span>
02906     <span class="comment">//  If there is no oldest client Lsn, then update the flag in the Lfcb.</span>
02907     <span class="comment">//</span>
02908 
02909     <span class="keywordflow">if</span> ( Lfcb-&gt;OldestLsnOffset &lt; Lfcb-&gt;FirstLogPage ) {
02910 
02911         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Lfcb-&gt;Flags, LFCB_NO_OLDEST_LSN );
02912     }
02913 
02914     <span class="comment">//</span>
02915     <span class="comment">//  We need to determine the flags for the Lfcb.  These flags let us know</span>
02916     <span class="comment">//  if we wrapped in the file and if we are using multiple page I/O.</span>
02917     <span class="comment">//</span>
02918 
02919     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( RestartArea-&gt;Flags, RESTART_SINGLE_PAGE_IO )) {
02920 
02921         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Lfcb-&gt;Flags, LFCB_LOG_WRAPPED | LFCB_MULTIPLE_PAGE_IO );
02922     }
02923 
02924     <span class="comment">//</span>
02925     <span class="comment">//  Remember the current open log count from the disk.  We may be plucking random data out</span>
02926     <span class="comment">//  of the client area if the restart area hasn't been grown yet but we will detect that</span>
02927     <span class="comment">//  elsewhere.</span>
02928     <span class="comment">//</span>
02929 
02930     Lfcb-&gt;CurrentOpenLogCount = RestartArea-&gt;RestartOpenLogCount;
02931 
02932     <span class="comment">//</span>
02933     <span class="comment">//  The total available log file space is the number of log file pages times</span>
02934     <span class="comment">//  the space available on each page.</span>
02935     <span class="comment">//</span>
02936 
02937     Lfcb-&gt;TotalAvailInPages = Lfcb-&gt;FileSize - Lfcb-&gt;FirstLogPage;
02938 
02939     Lfcb-&gt;TotalAvailable = Int64ShrlMod32(((ULONGLONG)(Lfcb-&gt;TotalAvailInPages)), Lfcb-&gt;LogPageShift);
02940 
02941     <span class="comment">//</span>
02942     <span class="comment">//  If the log file is packed we assume that we can't use the end of the</span>
02943     <span class="comment">//  page less than the file record size.  Then we won't need to reserve more</span>
02944     <span class="comment">//  than the caller asks for.</span>
02945     <span class="comment">//</span>
02946 
02947     Lfcb-&gt;MaxCurrentAvail = Lfcb-&gt;TotalAvailable * (ULONG)Lfcb-&gt;ReservedLogPageSize;
02948 
02949     Lfcb-&gt;TotalAvailable = Lfcb-&gt;TotalAvailable * (ULONG)Lfcb-&gt;LogPageDataSize;
02950 
02951     <a class="code" href="../../d7/d5/lfs_2verfysup_8c.html#a2">LfsFindCurrentAvail</a>( Lfcb );
02952 
02953     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsUpdateLfcbFromRestartArea:  Exit\n"</span>, 0 );
02954 
02955     <span class="keywordflow">return</span>;
02956 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="lfs/registry.c::LfsUpdateLfcbFromRestart" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsUpdateLfcbFromRestart           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RestartArea</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RestartOffset</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="lfs/registry.c::LfsUpdateRestartAreaFromLfcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsUpdateRestartAreaFromLfcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RestartArea</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02964">2964</a> of file <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html">lfs/registry.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00600">LFCB_MULTIPLE_PAGE_IO</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00355">LFS_NO_CLIENT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00514">RESTART_SINGLE_PAGE_IO</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00150">LfsInitializeLogFile()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01534">LfsRestartLogFile()</a>.
<p>
<pre class="fragment"><div>02971                    :
02972 
02973     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to update a restart area from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> values stored
02974     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfcb.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> typically done in a <span class="keywordflow">case</span> where we won'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> use
02975     any of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current values in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> restart area.
02976 
02977 Arguments:
02978 
02979     Lfcb - Log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block.
02980 
02981     RestartArea - Restart area to update.
02982 
02983 Return Value:
02984 
02985     None.
02986 
02987 --*/
02988 
02989 {
02990     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> Client;
02991     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> ClientIndex;
02992     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> PrevClient = <a class="code" href="../../d9/d3/lfsdisk_8h.html#a21">LFS_NO_CLIENT</a>;
02993 
02994     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02995 
02996     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsUpdateRestartAreaFromLfcb:  Entered\n"</span>, 0 );
02997     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lfcb              -&gt; %08lx\n"</span>, Lfcb );
02998 
02999     <span class="comment">//</span>
03000     <span class="comment">//  We can copy most of the fields directly out of Lfcb.</span>
03001     <span class="comment">//</span>
03002 
03003     RestartArea-&gt;CurrentLsn = Lfcb-&gt;LastFlushedLsn;
03004     RestartArea-&gt;LogClients = Lfcb-&gt;LogClients;
03005 
03006     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_MULTIPLE_PAGE_IO )) {
03007 
03008         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( RestartArea-&gt;Flags, RESTART_SINGLE_PAGE_IO );
03009     }
03010 
03011     RestartArea-&gt;SeqNumberBits = Lfcb-&gt;SeqNumberBits;
03012 
03013     RestartArea-&gt;FileSize = Lfcb-&gt;FileSize;
03014     RestartArea-&gt;LastLsnDataLength = 0;
03015     RestartArea-&gt;ClientArrayOffset = Lfcb-&gt;ClientArrayOffset;
03016     RestartArea-&gt;RestartAreaLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) Lfcb-&gt;RestartAreaSize;
03017 
03018     RestartArea-&gt;RecordHeaderLength = Lfcb-&gt;RecordHeaderLength;
03019     RestartArea-&gt;LogPageDataOffset = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Lfcb-&gt;LogPageDataOffset;
03020 
03021     <span class="comment">//</span>
03022     <span class="comment">//  We set the in use list as empty and the free list as containing</span>
03023     <span class="comment">//  all of the client entries.</span>
03024     <span class="comment">//</span>
03025 
03026     RestartArea-&gt;ClientInUseList = <a class="code" href="../../d9/d3/lfsdisk_8h.html#a21">LFS_NO_CLIENT</a>;
03027     RestartArea-&gt;ClientFreeList = 0;
03028 
03029     <span class="keywordflow">for</span> (ClientIndex = 1,
03030          Client = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( RestartArea, Lfcb-&gt;ClientArrayOffset, <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> );
03031          ClientIndex &lt; Lfcb-&gt;LogClients;
03032          ClientIndex += 1,
03033          Client++) {
03034 
03035         Client-&gt;PrevClient = PrevClient;
03036         Client-&gt;NextClient = ClientIndex;
03037 
03038         PrevClient = ClientIndex - 1;
03039     }
03040 
03041     <span class="comment">//</span>
03042     <span class="comment">//  We're now at the last client.</span>
03043     <span class="comment">//</span>
03044 
03045     Client-&gt;PrevClient = PrevClient;
03046     Client-&gt;NextClient = <a class="code" href="../../d9/d3/lfsdisk_8h.html#a21">LFS_NO_CLIENT</a>;
03047 
03048     <span class="comment">//</span>
03049     <span class="comment">//  Use the current value out of the Lfcb to stamp this usage of the log file.</span>
03050     <span class="comment">//</span>
03051 
03052     RestartArea-&gt;RestartOpenLogCount = Lfcb-&gt;CurrentOpenLogCount + 1;
03053 
03054     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsUpdateRestartAreaFromLfcb:  Exit\n"</span>, 0 );
03055 
03056     <span class="keywordflow">return</span>;
03057 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="lfs/registry.c::LfsVerifyLogFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN LfsVerifyLogFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LogHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>LogFileHeader</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01273">1273</a> of file <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html">lfs/registry.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00583">_LFCB::CurrentOpenLogCount</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00142">_LCH::Lfcb</a>, <a class="el" href="../../d1/d6/lfs_2nodetype_8h-source.html#l00033">LFS_NTC_LCH</a>, <a class="el" href="../../d1/d6/lfs_2nodetype_8h-source.html#l00035">LFS_NTC_LFCB</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00339">LFS_SIGNATURE_RESTART_PAGE_ULONG</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00517">LfsAcquireLch</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00520">LfsReleaseLch</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00512">LfsReleaseLfcb</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00307">_LFCB::NodeTypeCode</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00129">_LCH::NodeTypeCode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00305">_LFS_RESTART_PAGE_HEADER::RestartOffset</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00341">_LFCB::SystemPageSize</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>01281                    :
01282 
01283     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by a client to verify that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume has not been removed
01284     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system and then reattached.  We will verify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> open count on
01285     disk matches <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user's handle.
01286 
01287 Arguments:
01288 
01289     LogHandle - Pointer to <span class="keyword">private</span> Lfs structure used to identify <span class="keyword">this</span>
01290                 client.
01291 
01292     LogFileHeader - Pointer to start of log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
01293 
01294     Length - Number bytes returned with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> read.
01295 
01296 Return Value:
01297 
01298     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> has not been altered externally, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> we
01299         fail <span class="keywordflow">for</span> any <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a10">reason</a>.
01300 
01301 --*/
01302 
01303 {
01304     BOOLEAN ValidLogFile = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01305     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
01306     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
01307 
01308     <a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html">PLFS_RESTART_PAGE_HEADER</a> RestartPage = LogFileHeader;
01309 
01310     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01311 
01312     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
01313 
01314     <span class="comment">//</span>
01315     <span class="comment">//  Check that the structure is a valid log handle structure.</span>
01316     <span class="comment">//</span>
01317 
01318     <span class="keywordflow">if</span> ((Lch == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01319         (Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o0">NodeTypeCode</a> != <a class="code" href="../../d0/d7/lfs_2nodetype_8h.html#a2">LFS_NTC_LCH</a>) ||
01320         ((Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01321          (Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o0">NodeTypeCode</a> != <a class="code" href="../../d0/d7/lfs_2nodetype_8h.html#a4">LFS_NTC_LFCB</a>))) {
01322 
01323         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01324     }
01325 
01326     <span class="comment">//</span>
01327     <span class="comment">//  Acquire the log file control block for this log file.</span>
01328     <span class="comment">//</span>
01329 
01330     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
01331     Lfcb = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>;
01332 
01333     <span class="comment">//</span>
01334     <span class="comment">//  If the Log file has been closed then return immediately.</span>
01335     <span class="comment">//</span>
01336 
01337     <span class="keywordflow">if</span> (Lfcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01338 
01339         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
01340         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01341     }
01342 
01343     <span class="comment">//</span>
01344     <span class="comment">//  Check that we have at least one page and that the page is valid.</span>
01345     <span class="comment">//</span>
01346 
01347     <span class="keywordflow">if</span> ((Length &gt;= (ULONG) Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o6">SystemPageSize</a>) &amp;&amp;
01348         (*((PULONG) RestartPage) == <a class="code" href="../../d9/d3/lfsdisk_8h.html#a12">LFS_SIGNATURE_RESTART_PAGE_ULONG</a>) &amp;&amp;
01349         ((RestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o4">RestartOffset</a> + <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">LFS_RESTART_AREA</a> )) &lt; (ULONG) Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o6">SystemPageSize</a>) &amp;&amp;
01350         ((<a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( RestartPage, RestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o4">RestartOffset</a>, <a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a> ))-&gt;RestartOpenLogCount == Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o61">CurrentOpenLogCount</a>)) {
01351 
01352         ValidLogFile = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01353     }
01354 
01355     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a29">LfsReleaseLfcb</a>( Lfcb );
01356     <span class="keywordflow">return</span> ValidLogFile;
01357 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:28 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
