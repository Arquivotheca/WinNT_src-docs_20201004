<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cleanup.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cleanup.c</h1><a href="../../d9/d7/w32_2ntuser_2kernel_2cleanup_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: cleanup.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains code used to clean up after a dying thread.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 02-15-91 DarrinM      Created.</span>
00010 <span class="comment">* 01-16-92 IanJa        Neutralized ANSI/UNICODE (debug strings kept ANSI)</span>
00011 <span class="comment">\***************************************************************************/</span>
00012 
00013 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00014 <span class="preprocessor">#pragma hdrstop</span>
00015 <span class="preprocessor"></span>
00016 <span class="comment">/***************************************************************************\</span>
00017 <span class="comment">* CheckForClientDeath</span>
00018 <span class="comment">*</span>
00019 <span class="comment">* Check to see if the client thread that is paired to the current running</span>
00020 <span class="comment">* server thread has died.  If it has, we raise an exception so this thread</span>
00021 <span class="comment">* can perform its cleanup duties.  NOTE: If the client has died, this</span>
00022 <span class="comment">* will not be returning back to its caller.</span>
00023 <span class="comment">*</span>
00024 <span class="comment">* History:</span>
00025 <span class="comment">* 05-23-91 DarrinM      Created.</span>
00026 <span class="comment">\***************************************************************************/</span>
00027 
00028 <span class="comment">/***************************************************************************\</span>
00029 <span class="comment">* PseudoDestroyClassWindows</span>
00030 <span class="comment">*</span>
00031 <span class="comment">* Walk the window tree from hwndParent looking for windows</span>
00032 <span class="comment">* of class wndClass.  If one is found, destroy it.</span>
00033 <span class="comment">*</span>
00034 <span class="comment">*</span>
00035 <span class="comment">* WARNING windows actually destroys these windows.  We only zombie-ize them</span>
00036 <span class="comment">* so this call does not have to be an xxx call.</span>
00037 <span class="comment">*</span>
00038 <span class="comment">* History:</span>
00039 <span class="comment">* 25-Mar-1994 JohnC from win 3.1</span>
00040 <span class="comment">\***************************************************************************/</span>
00041 
<a name="l00042"></a><a class="code" href="../../d9/d7/w32_2ntuser_2kernel_2cleanup_8c.html#a0">00042</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d7/w32_2ntuser_2kernel_2cleanup_8c.html#a0">PseudoDestroyClassWindows</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndParent, <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a> pcls)
00043 {
00044     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00045     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
00046 
00047     pti = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00048 
00049     <span class="comment">/*</span>
00050 <span class="comment">     * Recursively walk the window list and zombie any windows of this class</span>
00051 <span class="comment">     */</span>
00052     <span class="keywordflow">for</span> (pwnd = pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>; pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>) {
00053 
00054         <span class="comment">/*</span>
00055 <span class="comment">         * If this window belongs to this class then zombie it</span>
00056 <span class="comment">         * if it was created by this message thread.</span>
00057 <span class="comment">         */</span>
00058         <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a> == pcls &amp;&amp; pti == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)) {
00059 
00060             <span class="comment">/*</span>
00061 <span class="comment">             * Zombie-ize the window</span>
00062 <span class="comment">             *</span>
00063 <span class="comment">             * Remove references to the client side window proc because that</span>
00064 <span class="comment">             * WOW selector has been freed.</span>
00065 <span class="comment">             */</span>
00066 
00067             RIPMSG1(RIP_WARNING,
00068                     <span class="stringliteral">"USER: Wow Window not destroyed: %lX"</span>, pwnd);
00069 
00070             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a569">WFSERVERSIDEPROC</a>)) {
00071                 pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o8">lpfnWndProc</a> = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a988">WNDPROC_PWND</a>)<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o8">apfnClientA</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o4">pfnDefWindowProc</a>;
00072             }
00073         }
00074 
00075         <span class="comment">/*</span>
00076 <span class="comment">         * Recurse downward to look for any children that might be</span>
00077 <span class="comment">         * of this class.</span>
00078 <span class="comment">         */</span>
00079         <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00080             <a class="code" href="../../d9/d7/w32_2ntuser_2kernel_2cleanup_8c.html#a0">PseudoDestroyClassWindows</a>(pwnd, pcls);
00081     }
00082 }
00083 
00084 <span class="comment">/***************************************************************************\</span>
00085 <span class="comment">* Go through all the windows owned by the dying queue and do the following:</span>
00086 <span class="comment">*</span>
00087 <span class="comment">* 1. Restore Standard window classes have their window procs restored</span>
00088 <span class="comment">*    to their original value, in case they were subclassed.</span>
00089 <span class="comment">*</span>
00090 <span class="comment">* 2. App window classes have their window procs set to DefWindowProc</span>
00091 <span class="comment">*    so that we don't execute any app code.</span>
00092 <span class="comment">*</span>
00093 <span class="comment">* Array of original window proc addresses,</span>
00094 <span class="comment">* indexed by ICLS_* value is in globals.c now -- gpfnwp.</span>
00095 <span class="comment">*</span>
00096 <span class="comment">* This array is initialized in code in init.c.</span>
00097 <span class="comment">\***************************************************************************/</span>
00098 
<a name="l00099"></a><a class="code" href="../../d4/d1/userk_8h.html#a1999">00099</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1999">_WOWModuleUnload</a>(HANDLE hModule) {
00100     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi = <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>();
00101     <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a>     pheT, pheMax;
00102     <a class="code" href="../../d7/d0/structtagCLS.html">PPCLS</a>   ppcls;
00103     <span class="keywordtype">int</span>     i;
00104 
00105     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a280">gpfnwp</a>[0]);
00106 
00107     <span class="comment">/*</span>
00108 <span class="comment">     * PseudoDestroy windows with wndprocs from this hModule</span>
00109 <span class="comment">     * If its a wow16 wndproc, check if the hMod16 is this module</span>
00110 <span class="comment">     * and Nuke matches.</span>
00111 <span class="comment">     */</span>
00112     pheMax = &amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>[<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a308">giheLast</a>];
00113     <span class="keywordflow">for</span> (pheT = <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>; pheT &lt;= pheMax; pheT++) {
00114         <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiTest = (<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>)pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a>;
00115         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00116         <span class="keywordflow">if</span> ((pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a237">TYPE_WINDOW</a>) &amp;&amp;
00117             (ptiTest-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) &amp;&amp;
00118             (ptiTest-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> == ppi)) {
00119 
00120             pwnd = (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>) pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>;
00121             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a569">WFSERVERSIDEPROC</a>) &amp;&amp;
00122                 IsWOWProc(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o8">lpfnWndProc</a>) &amp;&amp;
00123                 (pwnd-&gt;hMod16 == (WORD)(ULONG_PTR)hModule)) {
00124                 pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o8">lpfnWndProc</a> = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a988">WNDPROC_PWND</a>)<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o8">apfnClientA</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o4">pfnDefWindowProc</a>;
00125             }
00126         }
00127     }
00128 
00129     <span class="comment">/*</span>
00130 <span class="comment">     * Destroy private classes identified by hInstance that are not</span>
00131 <span class="comment">     * referenced by any windows.  Mark in-use classes for later</span>
00132 <span class="comment">     * destruction.</span>
00133 <span class="comment">     */</span>
00134     ppcls = &amp;(ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o4">pclsPrivateList</a>);
00135 
00136     <span class="keywordflow">for</span> (i = 0; i &lt; 2; ++i) {
00137         <span class="keywordflow">while</span> (*ppcls != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00138 
00139             PWC pwc;
00140             <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a> pcls;
00141 
00142             <span class="keywordflow">if</span> (HIWORD((ULONG_PTR)(*ppcls)-&gt;hModule) == (WORD)(ULONG_PTR)hModule) {
00143                 <span class="keywordflow">if</span> ((*ppcls)-&gt;cWndReferenceCount == 0) {
00144                     <a class="code" href="../../d4/d1/userk_8h.html#a1551">DestroyClass</a>(ppcls);
00145                     <span class="comment">/*</span>
00146 <span class="comment">                     * DestroyClass does *ppcls = pcls-&gt;pclsNext;</span>
00147 <span class="comment">                     * so we just want continue here</span>
00148 <span class="comment">                     */</span>
00149                 } <span class="keywordflow">else</span> {
00150 
00151                     <span class="comment">/*</span>
00152 <span class="comment">                     * Zap all the windows around that belong to this class.</span>
00153 <span class="comment">                     */</span>
00154                     <a class="code" href="../../d9/d7/w32_2ntuser_2kernel_2cleanup_8c.html#a0">PseudoDestroyClassWindows</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;rpdesk-&gt;pDeskInfo-&gt;spwnd, *ppcls);
00155 
00156                     <span class="comment">/*</span>
00157 <span class="comment">                     * Win 3.1 does not distinguish between Dll's and Exe's</span>
00158 <span class="comment">                     */</span>
00159                     (*ppcls)-&gt;CSF_flags |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a494">CSF_WOWDEFERDESTROY</a>;
00160                     ppcls = &amp;((*ppcls)-&gt;pclsNext);
00161                 }
00162                 <span class="keywordflow">continue</span>;
00163             }
00164 
00165             pcls = *ppcls;
00166 
00167             <span class="keywordflow">if</span> ((pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o7">CSF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a496">CSF_WOWCLASS</a>) &amp;&amp; ((WORD)(ULONG_PTR)hModule == (pwc = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a491">PWCFromPCLS</a>(pcls))-&gt;hMod16)) {
00168 
00169                 ATOM atom;
00170                 <span class="keywordtype">int</span>  iSel;
00171 
00172                 <span class="comment">/*</span>
00173 <span class="comment">                 * See if the window's class atom matches any of</span>
00174 <span class="comment">                 * the system ones. If so, jam in the original window proc.</span>
00175 <span class="comment">                 * Otherwise, use DefWindowProc</span>
00176 <span class="comment">                 */</span>
00177                 atom = (*ppcls)-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a>;
00178                 <span class="keywordflow">for</span> (iSel = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a68">ICLS_BUTTON</a>; iSel &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a91">ICLS_MAX</a>; iSel++) {
00179                     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a280">gpfnwp</a>[iSel]) &amp;&amp; (atom == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[iSel])) {
00180                         (*ppcls)-&gt;lpfnWndProc = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a988">WNDPROC_PWND</a>)<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a280">gpfnwp</a>[iSel];
00181                         <span class="keywordflow">break</span>;
00182                     }
00183                 }
00184                 <span class="keywordflow">if</span> (iSel == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a91">ICLS_MAX</a>)
00185                     (*ppcls)-&gt;lpfnWndProc = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a988">WNDPROC_PWND</a>)<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o9">apfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o4">pfnDefWindowProc</a>;
00186             }
00187 
00188             ppcls = &amp;((*ppcls)-&gt;pclsNext);
00189         }
00190 
00191         <span class="comment">/*</span>
00192 <span class="comment">         * Destroy public classes identified by hInstance that are not</span>
00193 <span class="comment">         * referenced by any windows.  Mark in-use classes for later</span>
00194 <span class="comment">         * destruction.</span>
00195 <span class="comment">         */</span>
00196         ppcls = &amp;(ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o5">pclsPublicList</a>);
00197     }
00198     <span class="keywordflow">return</span>;
00199 
00200 }
00201 
00202 
00203 <span class="comment">/***************************************************************************\</span>
00204 <span class="comment">* _WOWCleanup</span>
00205 <span class="comment">*</span>
00206 <span class="comment">* Private API to allow WOW to cleanup any process-owned resources when</span>
00207 <span class="comment">* a WOW thread exits or when a DLL is unloaded.</span>
00208 <span class="comment">*</span>
00209 <span class="comment">* Note that at module cleanup, hInstance = the module handle and hTaskWow</span>
00210 <span class="comment">* is NULL.  On task cleanup, hInstance = the hInst/hTask combined which</span>
00211 <span class="comment">* matches the value passed in hModule to WowServerCreateCursorIcon and</span>
00212 <span class="comment">* hTaskWow != NULL.</span>
00213 <span class="comment">*</span>
00214 <span class="comment">* History:</span>
00215 <span class="comment">* 09-02-92 JimA         Created.</span>
00216 <span class="comment">\***************************************************************************/</span>
00217 
<a name="l00218"></a><a class="code" href="../../d4/d1/userk_8h.html#a1998">00218</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1998">_WOWCleanup</a>(
00219     HANDLE hInstance,
00220     DWORD hTaskWow)
00221 {
00222     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi = <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>();
00223     <a class="code" href="../../d7/d0/structtagCLS.html">PPCLS</a>   ppcls;
00224     <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a>     pheT, pheMax;
00225     <span class="keywordtype">int</span>     i;
00226 
00227     <span class="keywordflow">if</span> (hInstance != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00228 
00229         <span class="comment">/*</span>
00230 <span class="comment">         * Task cleanup</span>
00231 <span class="comment">         */</span>
00232 
00233         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00234         hTaskWow = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) LOWORD(hTaskWow);
00235         <span class="comment">/*</span>
00236 <span class="comment">         * Task exit called by wow. This loop will Pseudo-Destroy windows</span>
00237 <span class="comment">         * created by this task.</span>
00238 <span class="comment">         */</span>
00239         pheMax = &amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>[<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a308">giheLast</a>];
00240         <span class="keywordflow">for</span> (pheT = <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>; pheT &lt;= pheMax; pheT++) {
00241             <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiTest = (<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>)pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a>;
00242             <span class="keywordflow">if</span> ((pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a237">TYPE_WINDOW</a>) &amp;&amp;
00243                 (ptiTest-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) &amp;&amp;
00244                 (ptiTest-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>) &amp;&amp;
00245                 (ptiTest-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o5">hTaskWow</a> == hTaskWow) &amp;&amp;
00246                 (ptiTest-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> == ppi)) {
00247 
00248                 pwnd = (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>) pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>;
00249                 <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a569">WFSERVERSIDEPROC</a>)) {
00250                     pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o8">lpfnWndProc</a> = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a988">WNDPROC_PWND</a>)<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o8">apfnClientA</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o4">pfnDefWindowProc</a>;
00251                 }
00252             }
00253         }
00254         <span class="keywordflow">return</span>;
00255     }
00256 
00257     <span class="comment">/*</span>
00258 <span class="comment">     * If we get here, we are in thread cleanup and all of the thread's windows</span>
00259 <span class="comment">     * have been destroyed or disassociated with any classes.  If a class</span>
00260 <span class="comment">     * marked for destruction at this point still has windows, they must</span>
00261 <span class="comment">     * belong to a dll.</span>
00262 <span class="comment">     */</span>
00263 
00264     <span class="comment">/*</span>
00265 <span class="comment">     * Destroy private classes marked for destruction</span>
00266 <span class="comment">     */</span>
00267     ppcls = &amp;(ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o4">pclsPrivateList</a>);
00268     <span class="keywordflow">for</span> (i = 0; i &lt; 2; ++i) {
00269         <span class="keywordflow">while</span> (*ppcls != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00270             <span class="keywordflow">if</span> ((*ppcls)-&gt;hTaskWow == hTaskWow &amp;&amp;
00271                     ((*ppcls)-&gt;CSF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a494">CSF_WOWDEFERDESTROY</a>)) {
00272                 <span class="keywordflow">if</span> ((*ppcls)-&gt;cWndReferenceCount == 0) {
00273                     <a class="code" href="../../d4/d1/userk_8h.html#a1551">DestroyClass</a>(ppcls);
00274                 } <span class="keywordflow">else</span> {
00275                     RIPMSG0(RIP_ERROR, <span class="stringliteral">"Windows remain for a WOW class marked for destruction"</span>);
00276                     ppcls = &amp;((*ppcls)-&gt;pclsNext);
00277                 }
00278             } <span class="keywordflow">else</span>
00279                 ppcls = &amp;((*ppcls)-&gt;pclsNext);
00280         }
00281 
00282         <span class="comment">/*</span>
00283 <span class="comment">         * Destroy public classes marked for destruction</span>
00284 <span class="comment">         */</span>
00285         ppcls = &amp;(ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o5">pclsPublicList</a>);
00286     }
00287 
00288     <span class="comment">/*</span>
00289 <span class="comment">     * Destroy menus, cursors, icons and accel tables identified by hTaskWow</span>
00290 <span class="comment">     */</span>
00291     pheMax = &amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>[<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a308">giheLast</a>];
00292     <span class="keywordflow">for</span> (pheT = <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>; pheT &lt;= pheMax; pheT++) {
00293 
00294         <span class="comment">/*</span>
00295 <span class="comment">         * Check against free before we look at ppi... because pq is stored</span>
00296 <span class="comment">         * in the object itself, which won't be there if TYPE_FREE.</span>
00297 <span class="comment">         */</span>
00298         <span class="keywordflow">if</span> (pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a236">TYPE_FREE</a>)
00299             <span class="keywordflow">continue</span>;
00300 
00301         <span class="comment">/*</span>
00302 <span class="comment">         * Destroy those objects created by this task.</span>
00303 <span class="comment">         */</span>
00304         <span class="keywordflow">if</span> (    !(<a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a241">gahti</a>[pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a>].<a class="code" href="../../d1/d6/structtagHANDLETYPEINFO.html#o2">bObjectCreateFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a414">OCF_PROCESSOWNED</a>) ||
00305                 (<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>)pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a> != ppi ||
00306                 (((<a class="code" href="../../d8/d0/struct__PROCOBJHEAD.html">PPROCOBJHEAD</a>)pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>)-&gt;hTaskWow != hTaskWow) ||
00307                 (pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a243">TYPE_CALLPROC</a>)  <span class="comment">/* Do not destroy CALLPROCDATA objects.</span>
00308 <span class="comment">                                                      * These should only get nuked when the</span>
00309 <span class="comment">                                                      * process goes away or when the class</span>
00310 <span class="comment">                                                      * is nuked.</span>
00311 <span class="comment">                                                      */</span>
00312                     ) {
00313 
00314             <span class="keywordflow">continue</span>;
00315         }
00316 
00317         <span class="comment">/*</span>
00318 <span class="comment">         * Make sure this object isn't already marked to be destroyed - we'll</span>
00319 <span class="comment">         * do no good if we try to destroy it now since it is locked.</span>
00320 <span class="comment">         */</span>
00321         <span class="keywordflow">if</span> (pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o3">bFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a421">HANDLEF_DESTROY</a>) {
00322             <span class="keywordflow">continue</span>;
00323         }
00324 
00325         <span class="comment">/*</span>
00326 <span class="comment">         * Destroy this object.</span>
00327 <span class="comment">         */</span>
00328         <a class="code" href="../../d4/d1/userk_8h.html#a977">HMDestroyUnlockedObject</a>(pheT);
00329     }
00330 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:24 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
