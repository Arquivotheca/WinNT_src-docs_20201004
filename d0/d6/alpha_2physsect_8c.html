<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: alpha/physsect.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>physsect.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d1/d5/alpha_2physsect_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/alpha_2physsect_8c.html#a0">MaximumAlignment</a> (ULONG)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/alpha_2physsect_8c.html#a1">AggregatePages</a> (<a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>, ULONG, ULONG, PULONG)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/alpha_2physsect_8c.html#a2">MiMapViewOfPhysicalSection</a> (IN <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN PVOID *CapturedBase, IN PLARGE_INTEGER SectionOffset, IN PSIZE_T CapturedViewSize, IN ULONG ProtectionMask, IN ULONG_PTR ZeroBits, IN ULONG AllocationType, IN BOOLEAN WriteCombined, OUT PBOOLEAN ReleasedWsMutex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/alpha_2physsect_8c.html#a3">MaximumAlignment</a> (IN ULONG <a class="el" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/alpha_2physsect_8c.html#a4">AggregatePages</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte, IN ULONG Pfn, IN ULONG Pages, OUT PULONG GranularityHint)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a4" doxytag="alpha/physsect.c::AggregatePages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG AggregatePages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PointerPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Pfn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Pages</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>GranularityHint</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/alpha_2physsect_8c-source.html#l00516">516</a> of file <a class="el" href="../../d1/d5/alpha_2physsect_8c-source.html">alpha/physsect.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00248">GH0</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00241">GH1</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00242">GH1_PAGE_SIZE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00234">GH2</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00235">GH2_PAGE_SIZE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00227">GH3</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00228">GH3_PAGE_SIZE</a>, <a class="el" href="../../d2/d5/axp64_2physsect_8c-source.html#l00478">MaximumAlignment()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>.
<p>
<pre class="fragment"><div>00524                    :
00525 
00526     This routine computes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of standard size pages that can be
00527     aggregated into a single large page and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> granularity hint
00528     <span class="keywordflow">for</span> that size large page.
00529 
00530 Arguments:
00531 
00532     PointerPte - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE pointer <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting <span class="keyword">virtual</span> address
00533                      of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping.
00534     Pfn - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting page frame number of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory to be
00535                      mapped.
00536     Pages - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of pages to map.
00537 
00538     GranularityHint - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> granularity hint <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> large page used
00539                          to aggregate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> standard pages.
00540 
00541 Return Value:
00542 
00543     The number of pages that can be aggregated together.
00544 
00545 Environment:
00546 
00547 --*/
00548 {
00549 
00550     ULONG MaxVirtualAlignment;
00551     ULONG MaxPhysicalAlignment;
00552     ULONG MaxPageAlignment;
00553     ULONG MaxAlignment;
00554 
00555     <span class="comment">//</span>
00556     <span class="comment">// Determine the largest page that will map a maximum of Pages.</span>
00557     <span class="comment">// The largest page must be both virtually and physically aligned</span>
00558     <span class="comment">// to the large page size boundary.</span>
00559     <span class="comment">// Determine the largest common alignment for the virtual and</span>
00560     <span class="comment">// physical addresses, factor in Pages, and then match to the</span>
00561     <span class="comment">// largest page size possible via the granularity hints.</span>
00562     <span class="comment">//</span>
00563 
00564     MaxVirtualAlignment = <a class="code" href="../../d1/d6/axp64_2physsect_8c.html#a3">MaximumAlignment</a>((ULONG)
00565                               <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>( PointerPte ) );
00566     MaxPhysicalAlignment = <a class="code" href="../../d1/d6/axp64_2physsect_8c.html#a3">MaximumAlignment</a>( (ULONG)(Pfn &lt;&lt; PAGE_SHIFT) );
00567 
00568     MaxPageAlignment = (ULONG)(Pages &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00569 
00570 <span class="preprocessor">#ifdef AGGREGATE_DBG</span>
00571 <span class="preprocessor"></span>
00572     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Aggregate MaxVirtualAlign = %x\n"</span>, MaxVirtualAlignment );
00573     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Aggregate MaxPhysicalAlign = %x\n"</span>, MaxPhysicalAlignment );
00574     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Aggregate MaxPageAlign = %x\n"</span>, MaxPageAlignment );
00575 
00576 <span class="preprocessor">#endif //AGGREGATE_DBG</span>
00577 <span class="preprocessor"></span>    <span class="comment">//</span>
00578     <span class="comment">// Maximum alignment is the minimum of the virtual and physical alignments.</span>
00579     <span class="comment">//</span>
00580 
00581     MaxAlignment =  (MaxVirtualAlignment &gt; MaxPhysicalAlignment) ?
00582                         MaxPhysicalAlignment : MaxVirtualAlignment;
00583     MaxAlignment = (MaxAlignment &gt; MaxPageAlignment) ?
00584                         MaxPageAlignment : MaxAlignment;
00585 
00586     <span class="comment">//</span>
00587     <span class="comment">// Convert MaxAlignment to granularity hint value</span>
00588     <span class="comment">//</span>
00589 
00590     <span class="keywordflow">if</span>( (MaxAlignment &amp; (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a37">GH3_PAGE_SIZE</a> - 1)) == 0 ){
00591 
00592         *GranularityHint = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a36">GH3</a>;
00593 
00594     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( (MaxAlignment &amp; (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a39">GH2_PAGE_SIZE</a> - 1)) == 0 ){
00595 
00596         *GranularityHint = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a38">GH2</a>;
00597 
00598     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( (MaxAlignment &amp; (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a41">GH1_PAGE_SIZE</a> - 1)) == 0 ){
00599 
00600         *GranularityHint = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a40">GH1</a>;
00601 
00602     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( (MaxAlignment &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) == 0 ){
00603 
00604         *GranularityHint = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a42">GH0</a>;
00605 
00606     } <span class="keywordflow">else</span> {
00607 
00608         *GranularityHint = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a42">GH0</a>;
00609 
00610 <span class="preprocessor">#if DBG</span>
00611 <span class="preprocessor"></span>
00612         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Aggregate Physical pages - not page aligned\n"</span> );
00613 
00614 <span class="preprocessor">#endif //DBG</span>
00615 <span class="preprocessor"></span>
00616     } <span class="comment">// end, if then elseif</span>
00617 
00618     <span class="comment">//</span>
00619     <span class="comment">// Return number of pages aggregated.</span>
00620     <span class="comment">//</span>
00621 
00622     <span class="keywordflow">return</span>( MaxAlignment &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> );
00623 
00624 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="alpha/physsect.c::AggregatePages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG AggregatePages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG&nbsp;</td>
          <td class="mdname" nowrap></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="alpha/physsect.c::MaximumAlignment" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG MaximumAlignment           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Offset</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/alpha_2physsect_8c-source.html#l00472">472</a> of file <a class="el" href="../../d1/d5/alpha_2physsect_8c-source.html">alpha/physsect.c</a>.
<p>
References <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00242">GH1_PAGE_SIZE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00235">GH2_PAGE_SIZE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00228">GH3_PAGE_SIZE</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>.
<p>
<pre class="fragment"><div>00477                    :
00478 
00479     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum granularity hint alignment boundary
00480     to which <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> naturally aligned.
00481 
00482 Arguments:
00483 
00484     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address offset to check <span class="keywordflow">for</span> alignment.
00485 
00486 Return Value:
00487 
00488     The number which represents <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> largest natural alignment of <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.
00489 
00490 Environment:
00491 
00492 --*/
00493 {
00494 
00495     <span class="keywordflow">if</span>( (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &amp; (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a37">GH3_PAGE_SIZE</a> - 1)) == 0 ){
00496         <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a37">GH3_PAGE_SIZE</a>;
00497     }
00498 
00499     <span class="keywordflow">if</span>( (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &amp; (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a39">GH2_PAGE_SIZE</a> - 1)) == 0 ){
00500         <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a39">GH2_PAGE_SIZE</a>;
00501     }
00502 
00503     <span class="keywordflow">if</span>( (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &amp; (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a41">GH1_PAGE_SIZE</a> - 1)) == 0 ){
00504         <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a41">GH1_PAGE_SIZE</a>;
00505     }
00506 
00507     <span class="keywordflow">if</span>( (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) == 0 ){
00508         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00509     }
00510 
00511     <span class="keywordflow">return</span> 0;
00512 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="alpha/physsect.c::MaximumAlignment" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG MaximumAlignment           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="alpha/physsect.c::MiMapViewOfPhysicalSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiMapViewOfPhysicalSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ControlArea</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedViewSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ProtectionMask</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>ZeroBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AllocationType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>WriteCombined</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReleasedWsMutex</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/alpha_2physsect_8c-source.html#l00043">43</a> of file <a class="el" href="../../d1/d5/alpha_2physsect_8c-source.html">alpha/physsect.c</a>.
<p>
<pre class="fragment"><div>00058                    :
00059 
00060     This routine maps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified physical section into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00061     specified process's address space.
00062 
00063 Arguments:
00064 
00065     see <a class="code" href="../../d2/d1/mm_8h.html#a241">MmMapViewOfSection</a> above...
00066 
00067     ControlArea - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> area <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section.
00068 
00069     Process - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process pointer which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> receiving <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section.
00070 
00071     ProtectionMask - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial page protection-mask.
00072 
00073     ReleasedWsMutex - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, receives <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set
00074                       mutex <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> released.
00075 
00076 Return Value:
00077 
00078     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map view operation.
00079 
00080 Environment:
00081 
00082     Kernel Mode, working set mutex and address creation mutex held.
00083 
00084 --*/
00085 
00086 {
00087     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
00088     PVOID StartingAddress;
00089     PVOID EndingAddress;
00090     KIRQL OldIrql;
00091     KIRQL OldIrql2;
00092     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00093     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00094     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00095     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00096     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00097     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
00098     ULONG PhysicalViewSize;
00099     ULONG Alignment;
00100     ULONG PagesToMap;
00101     ULONG NextPfn;
00102     PVOID UsedPageTableHandle;
00103     PVOID UsedPageDirectoryHandle;
00104     <a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">PMI_PHYSICAL_VIEW</a> PhysicalView;
00105 
00106     <span class="comment">//</span>
00107     <span class="comment">// Physical memory section.</span>
00108     <span class="comment">//</span>
00109 
00110 <span class="preprocessor">#ifdef FIRSTDBG</span>
00111 <span class="preprocessor"></span>
00112     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Physsect CaptureBase = %x  SectionOffset = %x\n"</span>,
00113               CapturedBase, SectionOffset-&gt;LowPart );
00114     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Physsect Allocation Type = %x, MEM_LARGE_PAGES = %x\n"</span>,
00115               AllocationType, MEM_LARGE_PAGES );
00116 
00117 <span class="preprocessor">#endif //FIRSTDBG</span>
00118 <span class="preprocessor"></span>
00119     <span class="comment">//</span>
00120     <span class="comment">// Compute the alignment we require for the virtual mapping.</span>
00121     <span class="comment">// The default is 64K to match protection boundaries.</span>
00122     <span class="comment">// Larger page sizes are used if MEM_LARGE_PAGES is requested.</span>
00123     <span class="comment">// The Alpha AXP architecture supports granularity hints so that</span>
00124     <span class="comment">// larger pages can be defined in the following multiples of</span>
00125     <span class="comment">// PAGE_SIZE:</span>
00126     <span class="comment">//            8**(GH) * PAGE_SIZE, where GH element of {0,1,2,3}</span>
00127     <span class="comment">//</span>
00128 
00129     Alignment = <a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>;
00130 
00131     <span class="keywordflow">if</span>( AllocationType &amp; MEM_LARGE_PAGES ){
00132 
00133         <span class="comment">//</span>
00134         <span class="comment">// MaxAlignment is the maximum boundary alignment of the</span>
00135         <span class="comment">// SectionOffset (where the maximum boundary is one of the possible</span>
00136         <span class="comment">//                granularity hints boundaries)</span>
00137         <span class="comment">//</span>
00138 
00139         ULONG MaxAlignment = <a class="code" href="../../d1/d6/axp64_2physsect_8c.html#a3">MaximumAlignment</a>( SectionOffset-&gt;LowPart );
00140 
00141         Alignment = (MaxAlignment &gt; Alignment) ? MaxAlignment : Alignment;
00142 
00143 <span class="preprocessor">#ifdef FIRSTDBG</span>
00144 <span class="preprocessor"></span>
00145         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Alignment = %x, SectionOffset = %x\n"</span>,
00146                        Alignment, SectionOffset-&gt;LowPart );
00147 
00148 <span class="preprocessor">#endif //FIRSTDBG</span>
00149 <span class="preprocessor"></span>
00150     }
00151 
00152 
00153     <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
00154 
00155     <span class="keywordflow">if</span> (*CapturedBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00156 
00157         <span class="comment">//</span>
00158         <span class="comment">// Attempt to locate address space.  This could raise an</span>
00159         <span class="comment">// exception.</span>
00160         <span class="comment">//</span>
00161 
00162         <span class="keywordflow">try</span> {
00163 
00164             <span class="comment">//</span>
00165             <span class="comment">// Find a starting address on an alignment boundary.</span>
00166             <span class="comment">//</span>
00167 
00168 
00169             PhysicalViewSize = (SectionOffset-&gt;LowPart + *CapturedViewSize) -
00170                                (ULONG)<a class="code" href="../../d4/d8/mi_8h.html#a91">MI_64K_ALIGN</a>(SectionOffset-&gt;LowPart);
00171             StartingAddress = <a class="code" href="../../d6/d3/vadtree_8c.html#a3">MiFindEmptyAddressRange</a> (PhysicalViewSize,
00172                                                        Alignment,
00173                                                        (ULONG)ZeroBits);
00174 
00175         } except (EXCEPTION_EXECUTE_HANDLER) {
00176 
00177             <span class="keywordflow">return</span> GetExceptionCode();
00178         }
00179 
00180         EndingAddress = (PVOID)(((ULONG)StartingAddress +
00181                                 PhysicalViewSize - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
00182         StartingAddress = (PVOID)((ULONG)StartingAddress +
00183                                      (SectionOffset-&gt;LowPart &amp; (<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a> - 1)));
00184 
00185         <span class="keywordflow">if</span> (ZeroBits &gt; 0) {
00186             <span class="keywordflow">if</span> (EndingAddress &gt; (PVOID)((ULONG)0xFFFFFFFF &gt;&gt; ZeroBits)) {
00187                 <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00188             }
00189         }
00190 
00191     } <span class="keywordflow">else</span> {
00192 
00193         <span class="comment">//</span>
00194         <span class="comment">// Check to make sure the specified base address to ending address</span>
00195         <span class="comment">// is currently unused.</span>
00196         <span class="comment">//</span>
00197 
00198         PhysicalViewSize = (SectionOffset-&gt;LowPart + *CapturedViewSize) -
00199                                 (ULONG)<a class="code" href="../../d4/d8/mi_8h.html#a91">MI_64K_ALIGN</a>(SectionOffset-&gt;LowPart);
00200         StartingAddress = (PVOID)((ULONG)<a class="code" href="../../d4/d8/mi_8h.html#a91">MI_64K_ALIGN</a>(*CapturedBase) +
00201                                     (SectionOffset-&gt;LowPart &amp; (<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a> - 1)));
00202         EndingAddress = (PVOID)(((ULONG)StartingAddress +
00203                                 *CapturedViewSize - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
00204 
00205         Vad = <a class="code" href="../../d4/d8/mi_8h.html#a98">MiCheckForConflictingVad</a> (StartingAddress, EndingAddress);
00206         <span class="keywordflow">if</span> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00207 <span class="preprocessor">#if 0</span>
00208 <span class="preprocessor"></span>            MiDumpConflictingVad (StartingAddress, EndingAddress, Vad);
00209 <span class="preprocessor">#endif</span>
00210 <span class="preprocessor"></span>
00211             <span class="keywordflow">return</span> STATUS_CONFLICTING_ADDRESSES;
00212         }
00213     }
00214 
00215     <span class="comment">//</span>
00216     <span class="comment">// An unoccuppied address range has been found, build the virtual</span>
00217     <span class="comment">// address descriptor to describe this range.</span>
00218     <span class="comment">//</span>
00219 
00220     <span class="comment">//</span>
00221     <span class="comment">// Establish an exception handler and attempt to allocate</span>
00222     <span class="comment">// the pool and charge quota.  Note that the InsertVad routine</span>
00223     <span class="comment">// will also charge quota which could raise an exception.</span>
00224     <span class="comment">//</span>
00225 
00226     <span class="keywordflow">try</span>  {
00227 
00228         PhysicalView = (<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">PMI_PHYSICAL_VIEW</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
00229                                                                  <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">MI_PHYSICAL_VIEW</a>),
00230                                                                  MI_PHYSICAL_VIEW_KEY);
00231         <span class="keywordflow">if</span> (PhysicalView == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00232             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INSUFFICIENT_RESOURCES);
00233         }
00234 
00235         Vad = (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>), ' daV');
00236         <span class="keywordflow">if</span> (Vad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00237             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INSUFFICIENT_RESOURCES);
00238         }
00239 
00240         PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o1">Vad</a> = Vad;
00241         PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o2">StartVa</a> = StartingAddress;
00242         PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o3">EndVa</a> = EndingAddress;
00243 
00244         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (StartingAddress);
00245         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndingAddress);
00246         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a> = ControlArea;
00247         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.LongFlags = 0;
00248         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.Inherit = ViewUnmap;
00249         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PhysicalMapping = 1;
00250         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o19">u4</a>.Banked = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00251         <span class="comment">// Vad-&gt;u.VadFlags.ImageMap = 0;</span>
00252         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection = ProtectionMask;
00253         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.CopyOnWrite = 0;
00254         <span class="comment">// Vad-&gt;u.VadFlags.LargePages = 0;</span>
00255         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o9">FirstPrototypePte</a> =
00256                        (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a180">MI_CONVERT_PHYSICAL_BUS_TO_PFN</a>(*SectionOffset));
00257 
00258         <span class="comment">//</span>
00259         <span class="comment">// Set the first prototype PTE field in the Vad.</span>
00260         <span class="comment">//</span>
00261 
00262         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o10">LastContiguousPte</a> =
00263                        (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a180">MI_CONVERT_PHYSICAL_BUS_TO_PFN</a>(*SectionOffset));
00264 
00265         <span class="comment">//</span>
00266         <span class="comment">// Insert the VAD.  This could get an exception.</span>
00267         <span class="comment">//</span>
00268 
00269         <a class="code" href="../../d6/d3/vadtree_8c.html#a0">MiInsertVad</a> (Vad);
00270 
00271     } except (EXCEPTION_EXECUTE_HANDLER) {
00272 
00273         <span class="keywordflow">if</span> (PhysicalView != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00274             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (PhysicalView);
00275         }
00276 
00277         <span class="keywordflow">if</span> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00278 
00279             <span class="comment">//</span>
00280             <span class="comment">// The pool allocation suceeded, but the quota charge</span>
00281             <span class="comment">// in InsertVad failed, deallocate the pool and return</span>
00282             <span class="comment">// an error.</span>
00283             <span class="comment">//</span>
00284 
00285             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Vad);
00286             <span class="keywordflow">return</span> GetExceptionCode();
00287         }
00288         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00289     }
00290 
00291     <span class="comment">// Increment the count of the number of views for the</span>
00292     <span class="comment">// section object.  This requires the PFN mutex to be held.</span>
00293     <span class="comment">//</span>
00294 
00295     <a class="code" href="../../d4/d8/mi_8h.html#a133">LOCK_AWE</a> (Process, OldIrql);
00296     <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql2);
00297 
00298     InsertHeadList (&amp;Process-&gt;PhysicalVadList, &amp;PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o0">ListEntry</a>);
00299 
00300     ControlArea-&gt;NumberOfMappedViews += 1;
00301     ControlArea-&gt;NumberOfUserReferences += 1;
00302     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;NumberOfSectionReferences != 0);
00303 
00304     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql2);
00305     <a class="code" href="../../d4/d8/mi_8h.html#a134">UNLOCK_AWE</a> (Process, OldIrql);
00306 
00307     <span class="comment">//</span>
00308     <span class="comment">// Build the PTEs in the address space.</span>
00309     <span class="comment">//</span>
00310 
00311     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (StartingAddress);
00312     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (StartingAddress);
00313     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (StartingAddress);
00314     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EndingAddress);
00315 
00316 <span class="preprocessor">#if defined (_WIN64)</span>
00317 <span class="preprocessor"></span>    <a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (PointerPpe, Process, FALSE);
00318     <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
00319         UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
00320         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MI_GET_USED_PTES_FROM_HANDLE (UsedPageDirectoryHandle) == 0); 
00321         <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
00322     }
00323 <span class="preprocessor">#endif</span>
00324 <span class="preprocessor"></span>
00325     <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a>(PointerPde, Process, FALSE);
00326 
00327     Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
00328 
00329     PagesToMap = ( ((ULONG)EndingAddress - (ULONG)StartingAddress)
00330                    + (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>-1) ) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00331 
00332     NextPfn = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a180">MI_CONVERT_PHYSICAL_BUS_TO_PFN</a>(*SectionOffset);
00333 
00334 <span class="preprocessor">#ifdef FIRSTDBG</span>
00335 <span class="preprocessor"></span>
00336     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Physsect, PagesToMap = %x  NextPfn = %x\n"</span>,
00337                    PagesToMap, NextPfn );
00338 
00339 <span class="preprocessor">#endif //FIRSTDBG</span>
00340 <span class="preprocessor"></span>
00341     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
00342                        NextPfn,
00343                        ProtectionMask,
00344                        PointerPte);
00345 
00346     <span class="keywordflow">if</span> (WriteCombined == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00347         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a111">MI_SET_PTE_WRITE_COMBINE</a> (TempPte);
00348     }
00349 
00350     <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write) {
00351             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Dirty = 1;
00352     }
00353     
00354     <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
00355 
00356         ULONG PagesTogether;
00357         ULONG GranularityHint;
00358 
00359         <span class="comment">//</span>
00360         <span class="comment">// Compute the number of pages that can be mapped together</span>
00361         <span class="comment">//</span>
00362 
00363         <span class="keywordflow">if</span> (AllocationType &amp; MEM_LARGE_PAGES) {
00364             PagesTogether = <a class="code" href="../../d1/d6/axp64_2physsect_8c.html#a4">AggregatePages</a> (PointerPte,
00365                                             NextPfn,
00366                                             PagesToMap,
00367                                             &amp;GranularityHint);
00368         } <span class="keywordflow">else</span> {
00369             PagesTogether = 1;
00370             GranularityHint = 0;
00371         }
00372 
00373 <span class="preprocessor">#ifdef FIRSTDBG</span>
00374 <span class="preprocessor"></span>
00375         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Physsect  PointerPte = %x, NextPfn = %x\n"</span>,
00376                        PointerPte, NextPfn );
00377         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Va = %x  TempPte.Pfn = %x\n"</span>,
00378                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>( PointerPte ),
00379                        TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber );
00380         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: PagesToMap = %x\n"</span>, PagesToMap );
00381         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: PagesTogether = %x, GH = %x\n"</span>,
00382                        PagesTogether, GranularityHint );
00383 
00384 <span class="preprocessor">#endif //FIRSTDBG</span>
00385 <span class="preprocessor"></span>
00386         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.GranularityHint = GranularityHint;
00387 
00388         NextPfn += PagesTogether;
00389         PagesToMap -= PagesTogether;
00390 
00391         UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (MiGetVirtualAddressMappedByPte (PointerPte));
00392 
00393         <span class="keywordflow">while</span> (PagesTogether--) {
00394 
00395             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPte)) {
00396 
00397                 PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
00398 
00399                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a166">MiIsPteOnPpeBoundary</a> (PointerPte)) {
00400                     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
00401                     <a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (PointerPpe, Process, FALSE);
00402                     <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
00403                         UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
00404                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MI_GET_USED_PTES_FROM_HANDLE (UsedPageDirectoryHandle) == 0); 
00405                 
00406                         <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
00407                     }
00408                 }
00409 
00410                 <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a> (PointerPde, Process, FALSE);
00411                 Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
00412                 UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (MiGetVirtualAddressMappedByPte (PointerPte));
00413             }
00414 
00415             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0 );
00416 
00417             *PointerPte = TempPte;
00418 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00419 <span class="preprocessor"></span>            <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00420 <span class="preprocessor">#endif</span>
00421 <span class="preprocessor"></span>            Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
00422 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00423 <span class="preprocessor"></span>            <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00424 <span class="preprocessor">#endif</span>
00425 <span class="preprocessor"></span>
00426             <span class="comment">//</span>
00427             <span class="comment">// Increment the count of non-zero page table entries for this</span>
00428             <span class="comment">// page table and the number of private pages for the process.</span>
00429             <span class="comment">//</span>
00430 
00431             <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageTableHandle);
00432 
00433             PointerPte += 1;
00434 
00435             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber += 1;
00436 
00437         } <span class="comment">// while (PagesTogether-- )</span>
00438 
00439     }  <span class="comment">// while (PointerPte &lt;= LastPte)</span>
00440 
00441     <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
00442     *ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00443 
00444     <span class="comment">//</span>
00445     <span class="comment">// Update the current virtual size in the process header.</span>
00446     <span class="comment">//</span>
00447 
00448     *CapturedViewSize = (ULONG)EndingAddress - (ULONG)StartingAddress + 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00449     Process-&gt;VirtualSize += *CapturedViewSize;
00450 
00451     <span class="keywordflow">if</span> (Process-&gt;VirtualSize &gt; Process-&gt;PeakVirtualSize) {
00452         Process-&gt;PeakVirtualSize = Process-&gt;VirtualSize;
00453     }
00454 
00455     <span class="comment">//</span>
00456     <span class="comment">// Translate the virtual address to a quasi-virtual address for</span>
00457     <span class="comment">// use by drivers that touch mapped devices.  Note: the routine</span>
00458     <span class="comment">// HalCreateQva will not translate the StartingAddress if the</span>
00459     <span class="comment">// StartingAddress is within system memory address space.</span>
00460     <span class="comment">//</span>
00461     <span class="comment">// N.B. - It will not work to attempt map addresses that begin in</span>
00462     <span class="comment">// system memory and extend through i/o space.</span>
00463     <span class="comment">//</span>
00464 
00465     *CapturedBase = HalCreateQva( *SectionOffset, StartingAddress );
00466 
00467     <span class="keywordflow">return</span> STATUS_SUCCESS;
00468 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:02 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
