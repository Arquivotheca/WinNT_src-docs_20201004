<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: profile.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>profile.c</h1><a href="../../d9/d6/ex_2profile_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    profile.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">   This module implements the executive profile object. Functions are provided</span>
00012 <span class="comment">   to create, start, stop, and query profile objects.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Lou Perazzoli (loup) 21-Sep-1990</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Kernel mode only.</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d4/d0/exp_8h.html">exp.h</a>"</span>
00027 
00028 <span class="comment">//</span>
00029 <span class="comment">// Executive profile object.</span>
00030 <span class="comment">//</span>
00031 
<a name="l00032"></a><a class="code" href="../../d5/d4/struct__EPROFILE.html">00032</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d5/d4/struct__EPROFILE.html">_EPROFILE</a> {
<a name="l00033"></a><a class="code" href="../../d5/d4/struct__EPROFILE.html#o0">00033</a>     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> <a class="code" href="../../d5/d4/struct__EPROFILE.html#o0">Process</a>;
<a name="l00034"></a><a class="code" href="../../d5/d4/struct__EPROFILE.html#o1">00034</a>     PVOID <a class="code" href="../../d5/d4/struct__EPROFILE.html#o1">RangeBase</a>;
<a name="l00035"></a><a class="code" href="../../d5/d4/struct__EPROFILE.html#o2">00035</a>     SIZE_T <a class="code" href="../../d5/d4/struct__EPROFILE.html#o2">RangeSize</a>;
<a name="l00036"></a><a class="code" href="../../d5/d4/struct__EPROFILE.html#o3">00036</a>     PVOID <a class="code" href="../../d5/d4/struct__EPROFILE.html#o3">Buffer</a>;
<a name="l00037"></a><a class="code" href="../../d5/d4/struct__EPROFILE.html#o4">00037</a>     ULONG <a class="code" href="../../d5/d4/struct__EPROFILE.html#o4">BufferSize</a>;
<a name="l00038"></a><a class="code" href="../../d5/d4/struct__EPROFILE.html#o5">00038</a>     ULONG <a class="code" href="../../d5/d4/struct__EPROFILE.html#o5">BucketSize</a>;
<a name="l00039"></a><a class="code" href="../../d5/d4/struct__EPROFILE.html#o6">00039</a>     <a class="code" href="../../d6/d7/struct__KPROFILE.html">PKPROFILE</a> <a class="code" href="../../d5/d4/struct__EPROFILE.html#o6">ProfileObject</a>;
<a name="l00040"></a><a class="code" href="../../d5/d4/struct__EPROFILE.html#o7">00040</a>     PVOID <a class="code" href="../../d5/d4/struct__EPROFILE.html#o7">LockedBufferAddress</a>;
<a name="l00041"></a><a class="code" href="../../d5/d4/struct__EPROFILE.html#o8">00041</a>     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> <a class="code" href="../../d5/d4/struct__EPROFILE.html#o8">Mdl</a>;
<a name="l00042"></a><a class="code" href="../../d5/d4/struct__EPROFILE.html#o9">00042</a>     ULONG <a class="code" href="../../d5/d4/struct__EPROFILE.html#o9">Segment</a>;
<a name="l00043"></a><a class="code" href="../../d5/d4/struct__EPROFILE.html#o10">00043</a>     KPROFILE_SOURCE <a class="code" href="../../d5/d4/struct__EPROFILE.html#o10">ProfileSource</a>;
<a name="l00044"></a><a class="code" href="../../d5/d4/struct__EPROFILE.html#o11">00044</a>     KAFFINITY <a class="code" href="../../d5/d4/struct__EPROFILE.html#o11">Affinity</a>;
00045 } <a class="code" href="../../d5/d4/struct__EPROFILE.html">EPROFILE</a>, *<a class="code" href="../../d5/d4/struct__EPROFILE.html">PEPROFILE</a>;
00046 
00047 <span class="comment">//</span>
00048 <span class="comment">// Address of event object type descriptor.</span>
00049 <span class="comment">//</span>
00050 
<a name="l00051"></a><a class="code" href="../../d9/d6/ex_2profile_8c.html#a3">00051</a> <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="code" href="../../d9/d6/ex_2profile_8c.html#a3">ExProfileObjectType</a>;
00052 
<a name="l00053"></a><a class="code" href="../../d9/d6/ex_2profile_8c.html#a4">00053</a> <a class="code" href="../../d3/d7/struct__KMUTANT.html">KMUTEX</a> <a class="code" href="../../d9/d6/ex_2profile_8c.html#a4">ExpProfileStateMutex</a>;
00054 
<a name="l00055"></a><a class="code" href="../../d9/d6/ex_2profile_8c.html#a5">00055</a> ULONG <a class="code" href="../../d9/d6/ex_2profile_8c.html#a5">ExpCurrentProfileUsage</a> = 0;
00056 
<a name="l00057"></a><a class="code" href="../../d9/d6/ex_2profile_8c.html#a6">00057</a> GENERIC_MAPPING <a class="code" href="../../d9/d6/ex_2profile_8c.html#a6">ExpProfileMapping</a> = {
00058     STANDARD_RIGHTS_READ | PROFILE_CONTROL,
00059     STANDARD_RIGHTS_WRITE | PROFILE_CONTROL,
00060     STANDARD_RIGHTS_EXECUTE | PROFILE_CONTROL,
00061     PROFILE_ALL_ACCESS
00062 };
00063 
<a name="l00064"></a><a class="code" href="../../d9/d6/ex_2profile_8c.html#a0">00064</a> <span class="preprocessor">#define ACTIVE_PROFILE_LIMIT 8</span>
00065 <span class="preprocessor"></span>
00066 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00067 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, ExpProfileInitialization)</span>
00068 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ExpProfileDelete)</span>
00069 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtCreateProfile)</span>
00070 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtStartProfile)</span>
00071 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtStopProfile)</span>
00072 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtSetIntervalProfile)</span>
00073 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtQueryIntervalProfile)</span>
00074 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtQueryPerformanceCounter)</span>
00075 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00076 <span class="preprocessor"></span>
00077 
00078 BOOLEAN
<a name="l00079"></a><a class="code" href="../../d9/d6/ex_2profile_8c.html#a7">00079</a> <a class="code" href="../../d4/d0/exp_8h.html#a29">ExpProfileInitialization</a> (
00080     )
00081 
00082 <span class="comment">/*++</span>
00083 <span class="comment"></span>
00084 <span class="comment">Routine Description:</span>
00085 <span class="comment"></span>
00086 <span class="comment">    This function creates the profile object type descriptor at system</span>
00087 <span class="comment">    initialization and stores the address of the object type descriptor</span>
00088 <span class="comment">    in global storage.</span>
00089 <span class="comment"></span>
00090 <span class="comment">Arguments:</span>
00091 <span class="comment"></span>
00092 <span class="comment">    None.</span>
00093 <span class="comment"></span>
00094 <span class="comment">Return Value:</span>
00095 <span class="comment"></span>
00096 <span class="comment">    A value of TRUE is returned if the profile object type descriptor is</span>
00097 <span class="comment">    successfully initialized. Otherwise a value of FALSE is returned.</span>
00098 <span class="comment"></span>
00099 <span class="comment">--*/</span>
00100 
00101 {
00102 
00103     <a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html">OBJECT_TYPE_INITIALIZER</a> ObjectTypeInitializer;
00104     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00105     UNICODE_STRING TypeName;
00106 
00107     <span class="comment">//</span>
00108     <span class="comment">// Initialize mutex for synchronizing start and stop operations.</span>
00109     <span class="comment">//</span>
00110 
00111     <a class="code" href="../../d3/d5/mutntobj_8c.html#a2">KeInitializeMutex</a> (&amp;<a class="code" href="../../d9/d6/ex_2profile_8c.html#a4">ExpProfileStateMutex</a>, <a class="code" href="../../d3/d0/exlevels_8h.html#a1">MUTEX_LEVEL_EX_PROFILE</a>);
00112 
00113     <span class="comment">//</span>
00114     <span class="comment">// Initialize string descriptor.</span>
00115     <span class="comment">//</span>
00116 
00117     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;TypeName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Profile"</span>);
00118 
00119     <span class="comment">//</span>
00120     <span class="comment">// Create event object type descriptor.</span>
00121     <span class="comment">//</span>
00122 
00123     RtlZeroMemory(&amp;ObjectTypeInitializer,<span class="keyword">sizeof</span>(ObjectTypeInitializer));
00124     ObjectTypeInitializer.Length = <span class="keyword">sizeof</span>(ObjectTypeInitializer);
00125     ObjectTypeInitializer.InvalidAttributes = OBJ_OPENLINK;
00126     ObjectTypeInitializer.PoolType = <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>;
00127     ObjectTypeInitializer.DefaultNonPagedPoolCharge = <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/struct__EPROFILE.html">EPROFILE</a>);
00128     ObjectTypeInitializer.ValidAccessMask = PROFILE_ALL_ACCESS;
00129     ObjectTypeInitializer.DeleteProcedure = <a class="code" href="../../d4/d0/exp_8h.html#a31">ExpProfileDelete</a>;
00130     ObjectTypeInitializer.GenericMapping = <a class="code" href="../../d9/d6/ex_2profile_8c.html#a6">ExpProfileMapping</a>;
00131 
00132     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>(&amp;TypeName,
00133                                 &amp;ObjectTypeInitializer,
00134                                 (PSECURITY_DESCRIPTOR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00135                                 &amp;<a class="code" href="../../d9/d6/ex_2profile_8c.html#a3">ExProfileObjectType</a>);
00136 
00137     <span class="comment">//</span>
00138     <span class="comment">// If the event object type descriptor was successfully created, then</span>
00139     <span class="comment">// return a value of TRUE. Otherwise return a value of FALSE.</span>
00140     <span class="comment">//</span>
00141 
00142     <span class="keywordflow">return</span> (BOOLEAN)(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00143 }
00144 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00145"></a><a class="code" href="../../d9/d6/ex_2profile_8c.html#a8">00145</a> <a class="code" href="../../d9/d6/ex_2profile_8c.html#a8">ExpProfileDelete</a> (
00146     IN PVOID Object
00147     )
00148 
00149 <span class="comment">/*++</span>
00150 <span class="comment"></span>
00151 <span class="comment">Routine Description:</span>
00152 <span class="comment"></span>
00153 <span class="comment"></span>
00154 <span class="comment">    This routine is called by the object management procedures whenever</span>
00155 <span class="comment">    the last reference to a profile object has been removed.  This routine</span>
00156 <span class="comment">    stops profiling, returns locked buffers and pages, dereferences the</span>
00157 <span class="comment">    specified process and returns.</span>
00158 <span class="comment"></span>
00159 <span class="comment">Arguments:</span>
00160 <span class="comment"></span>
00161 <span class="comment">    Object - a pointer to the body of the profile object.</span>
00162 <span class="comment"></span>
00163 <span class="comment">Return Value:</span>
00164 <span class="comment"></span>
00165 <span class="comment">    None.</span>
00166 <span class="comment"></span>
00167 <span class="comment">--*/</span>
00168 
00169 {
00170     <a class="code" href="../../d9/d6/ex_2profile_8c.html#a2">PEPROFILE</a> Profile;
00171     BOOLEAN   State;
00172     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessAddress;
00173 
00174     Profile = (<a class="code" href="../../d9/d6/ex_2profile_8c.html#a2">PEPROFILE</a>)Object;
00175 
00176     <span class="keywordflow">if</span> (Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o7">LockedBufferAddress</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00177 
00178         <span class="comment">//</span>
00179         <span class="comment">// Stop profiling and unlock the buffers and deallocate pool.</span>
00180         <span class="comment">//</span>
00181 
00182         State = <a class="code" href="../../d0/d8/profobj_8c.html#a9">KeStopProfile</a> (Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o6">ProfileObject</a>);
00183         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (State != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00184 
00185         <a class="code" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o7">LockedBufferAddress</a>, Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o8">Mdl</a>);
00186         <a class="code" href="../../d5/d6/iosup_8c.html#a45">MmUnlockPages</a> (Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o8">Mdl</a>);
00187         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o6">ProfileObject</a>);
00188     }
00189 
00190     <span class="keywordflow">if</span> (Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o0">Process</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00191         ProcessAddress = CONTAINING_RECORD(Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o0">Process</a>, <a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>, Pcb);
00192         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> ((PVOID)ProcessAddress);
00193     }
00194 
00195     <span class="keywordflow">return</span>;
00196 }
00197 
00198 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00199"></a><a class="code" href="../../d9/d6/ex_2profile_8c.html#a9">00199</a> <a class="code" href="../../d9/d6/ex_2profile_8c.html#a9">NtCreateProfile</a> (
00200     OUT PHANDLE ProfileHandle,
00201     IN HANDLE Process OPTIONAL,
00202     IN PVOID RangeBase,
00203     IN SIZE_T RangeSize,
00204     IN ULONG BucketSize,
00205     IN PULONG Buffer,
00206     IN ULONG BufferSize,
00207     IN KPROFILE_SOURCE ProfileSource,
00208     IN KAFFINITY Affinity
00209     )
00210 
00211 <span class="comment">/*++</span>
00212 <span class="comment"></span>
00213 <span class="comment">Routine Description:</span>
00214 <span class="comment"></span>
00215 <span class="comment">    This function creates a profile object.</span>
00216 <span class="comment"></span>
00217 <span class="comment">Arguments:</span>
00218 <span class="comment"></span>
00219 <span class="comment">    ProfileHandle - Supplies a pointer to a variable that will receive</span>
00220 <span class="comment">                    the profile object handle.</span>
00221 <span class="comment"></span>
00222 <span class="comment">    Process - Optionally, supplies the handle to the process whose</span>
00223 <span class="comment">              address space to profile.  If the value is NULL (0), then</span>
00224 <span class="comment">              all address spaces are included in the profile.</span>
00225 <span class="comment"></span>
00226 <span class="comment">    RangeBase - Supplies the address of the first byte of the address</span>
00227 <span class="comment">                  space for which profiling information is to be collected.</span>
00228 <span class="comment"></span>
00229 <span class="comment"></span>
00230 <span class="comment">    RangeSize - Supplies the size of the range to profile in the</span>
00231 <span class="comment">                address space.  RangeBase and RangeSize are interpreted</span>
00232 <span class="comment">                such that RangeBase &lt;= address &lt; RangeBase+RangeSize</span>
00233 <span class="comment">                will generate a profile hit.</span>
00234 <span class="comment"></span>
00235 <span class="comment">    BucketSize - Supplies the LOG base 2 of the size of the profiling</span>
00236 <span class="comment">                 bucket.  Thus, BucketSize = 2 yields four-byte</span>
00237 <span class="comment">                 buckets, BucketSize = 7 yields 128-byte buckets.</span>
00238 <span class="comment">                 All profile hits in a given bucket will increment</span>
00239 <span class="comment">                 the corresponding counter in Buffer.  Buckets</span>
00240 <span class="comment">                 cannot be smaller than a ULONG.  The acceptable range</span>
00241 <span class="comment">                 of this value is 2 to 30 inclusive.</span>
00242 <span class="comment"></span>
00243 <span class="comment">    Buffer - Supplies an array of ULONGs.  Each ULONG is a hit counter,</span>
00244 <span class="comment">             which records the number of hits of the corresponding</span>
00245 <span class="comment">             bucket.</span>
00246 <span class="comment"></span>
00247 <span class="comment">    BufferSize - Size in bytes of Buffer.</span>
00248 <span class="comment"></span>
00249 <span class="comment">    ProfileSource - Supplies the source for the profile interrupt</span>
00250 <span class="comment"></span>
00251 <span class="comment">    Affinity - Supplies the processor set for the profile interrupt</span>
00252 <span class="comment"></span>
00253 <span class="comment">Return Value:</span>
00254 <span class="comment"></span>
00255 <span class="comment">    TBS</span>
00256 <span class="comment"></span>
00257 <span class="comment">--*/</span>
00258 
00259 {
00260 
00261     <a class="code" href="../../d9/d6/ex_2profile_8c.html#a2">PEPROFILE</a> Profile;
00262     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00263     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00264     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00265     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessAddress;
00266     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00267     BOOLEAN HasPrivilege = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00268     ULONG Segment = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00269     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> PowerOf2;
00270 
00271     <span class="comment">//</span>
00272     <span class="comment">// Verify that the base and size arguments are reasonable.</span>
00273     <span class="comment">//</span>
00274 
00275     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> == 0) {
00276         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_7;
00277     }
00278 
00279 <span class="preprocessor">#ifdef i386</span>
00280 <span class="preprocessor"></span>    <span class="comment">//</span>
00281     <span class="comment">//        sleazy use of bucket size.  If bucket size is zero, and</span>
00282     <span class="comment">//        RangeBase &lt; 64K, then create a profile object to attach</span>
00283     <span class="comment">//        to a non-flat code segment.  In this case, RangeBase is</span>
00284     <span class="comment">//        the non-flat CS for this profile object.</span>
00285     <span class="comment">//</span>
00286 
00287     <span class="keywordflow">if</span> ((BucketSize == 0) &amp;&amp; (RangeBase &lt; (PVOID)(64 * 1024))) {
00288 
00289         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> &lt; <span class="keyword">sizeof</span>(ULONG)) {
00290             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_7;
00291         }
00292 
00293         Segment = (ULONG)RangeBase;
00294         RangeBase = 0;
00295         BucketSize = RangeSize / (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> / <span class="keyword">sizeof</span>(ULONG));
00296 
00297         <span class="comment">//</span>
00298         <span class="comment">// Convert Bucket size of log2(BucketSize)</span>
00299         <span class="comment">//</span>
00300         PowerOf2 = 0;
00301         BucketSize = BucketSize - 1;
00302         <span class="keywordflow">while</span> (BucketSize &gt;&gt;= 1) {
00303             PowerOf2++;
00304         }
00305 
00306         BucketSize = PowerOf2 + 1;
00307 
00308         <span class="keywordflow">if</span> (BucketSize &lt; 2) {
00309             BucketSize = 2;
00310         }
00311     }
00312 <span class="preprocessor">#endif</span>
00313 <span class="preprocessor"></span>
00314     <span class="keywordflow">if</span> ((BucketSize &gt; 31) || (BucketSize &lt; 2)) {
00315         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00316     }
00317 
00318     <span class="keywordflow">if</span> ((RangeSize &gt;&gt; (BucketSize - 2)) &gt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) {
00319         <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00320     }
00321 
00322     <span class="keywordflow">if</span> (((ULONG_PTR)RangeBase + RangeSize) &lt; RangeSize) {
00323         <span class="keywordflow">return</span> STATUS_BUFFER_OVERFLOW;
00324     }
00325 
00326     <span class="comment">//</span>
00327     <span class="comment">// Establish an exception handler, probe the output handle address, and</span>
00328     <span class="comment">// attempt to create a profile object. If the probe fails, then return the</span>
00329     <span class="comment">// exception code as the service status. Otherwise return the status value</span>
00330     <span class="comment">// returned by the object insertion routine.</span>
00331     <span class="comment">//</span>
00332 
00333     <span class="keywordflow">try</span> {
00334         <span class="comment">//</span>
00335         <span class="comment">// Get previous processor mode and probe output handle address if</span>
00336         <span class="comment">// necessary.</span>
00337         <span class="comment">//</span>
00338 
00339         PreviousMode = KeGetPreviousMode ();
00340 
00341         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00342             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>(ProfileHandle);
00343 
00344             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00345                           <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>,
00346                           <span class="keyword">sizeof</span>(ULONG));
00347         }
00348 
00349     <span class="comment">//</span>
00350     <span class="comment">// If an exception occurs during the probe of the output handle address,</span>
00351     <span class="comment">// then always handle the exception and return the exception code as the</span>
00352     <span class="comment">// status value.</span>
00353     <span class="comment">//</span>
00354 
00355     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00356         <span class="keywordflow">return</span> GetExceptionCode();
00357     }
00358 
00359 <span class="comment">//</span>
00360 <span class="comment">// TODO post NT5:</span>
00361 <span class="comment">//</span>
00362 <span class="comment">// Currently, if a process isn't specified, there is no privilege check if</span>
00363 <span class="comment">//   RangeBase &gt; MM_HIGHEST_USER_ADDRESS.</span>
00364 <span class="comment">// The check for user-space addresses is SeSystemProfilePrivilege.</span>
00365 <span class="comment">// Querying a specific process requires only PROCESS_QUERY_INFORMATION.</span>
00366 <span class="comment">//</span>
00367 <span class="comment">// The spec says:</span>
00368 <span class="comment">//</span>
00369 <span class="comment">//     Process - If specified, a handle to a process which describes the address space to profile.</span>
00370 <span class="comment">//     If not present, then all address spaces are included in the profile.</span>
00371 <span class="comment">//     Profiling a process requires PROCESS_QUERY_INFORMATION access to that process and</span>
00372 <span class="comment">//     SeProfileSingleProcessPrivilege privilege.</span>
00373 <span class="comment">//     Profiling all processes requires SeSystemProfilePrivilege privilege.</span>
00374 <span class="comment">//</span>
00375 <span class="comment">// So two changes appear needed.</span>
00376 <span class="comment">//   A check on SeProfileSingleProcessPrivilege needs to be added to the single process case,</span>
00377 <span class="comment">//   and SeSystemProfilePrivilege privilege should be required for both user and system address profiling.</span>
00378 <span class="comment">//</span>
00379 
00380 
00381     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(Process)) {
00382 
00383         <span class="comment">//</span>
00384         <span class="comment">// Don't attach segmented profile objects to all processes</span>
00385         <span class="comment">//</span>
00386 
00387         <span class="keywordflow">if</span> (Segment) {
00388             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00389         }
00390 
00391         <span class="comment">//</span>
00392         <span class="comment">// Profile all processes. Make sure that the specified</span>
00393         <span class="comment">// address range is in system space, unless SeSystemProfilePrivilege.</span>
00394         <span class="comment">//</span>
00395 
00396         <span class="keywordflow">if</span> (RangeBase &lt;= MM_HIGHEST_USER_ADDRESS) {
00397 
00398             <span class="comment">//</span>
00399             <span class="comment">// Check for privilege before allowing a user to profile</span>
00400             <span class="comment">// all processes and USER addresses.</span>
00401             <span class="comment">//</span>
00402 
00403             <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00404                 HasPrivilege =  <a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(
00405                                     <a class="code" href="../../d0/d5/se_8h.html#a90">SeSystemProfilePrivilege</a>,
00406                                     PreviousMode
00407                                     );
00408 
00409                 <span class="keywordflow">if</span> (!HasPrivilege) {
00410 <span class="preprocessor">#if DBG</span>
00411 <span class="preprocessor"></span>                    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"SeSystemProfilePrivilege needed to profile all USER addresses.\n"</span>);
00412 <span class="preprocessor">#endif //DBG</span>
00413 <span class="preprocessor"></span>                    <span class="keywordflow">return</span>( STATUS_PRIVILEGE_NOT_HELD );
00414                 }
00415 
00416             }
00417         }
00418 
00419         ProcessAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00420 
00421 
00422     } <span class="keywordflow">else</span> {
00423 
00424         <span class="comment">//</span>
00425         <span class="comment">// Reference the specified process.</span>
00426         <span class="comment">//</span>
00427 
00428         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> ( Process,
00429                                              PROCESS_QUERY_INFORMATION,
00430                                              <a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>,
00431                                              PreviousMode,
00432                                              (PVOID *)&amp;ProcessAddress,
00433                                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00434 
00435         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00436             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00437         }
00438     }
00439 
00440     InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00441                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00442                                 OBJ_EXCLUSIVE,
00443                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00444                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00445 
00446     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00447                              <a class="code" href="../../d9/d6/ex_2profile_8c.html#a3">ExProfileObjectType</a>,
00448                              &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00449                              PreviousMode,
00450                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00451                              <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/struct__EPROFILE.html">EPROFILE</a>),
00452                              0,
00453                              <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d6/ex_2profile_8c.html#a1">EPROFILE</a>) + <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__KPROFILE.html">KPROFILE</a>),
00454                              (PVOID *)&amp;Profile);
00455 
00456     <span class="comment">//</span>
00457     <span class="comment">// If the profile object was successfully allocated, initialize</span>
00458     <span class="comment">// the profile object.</span>
00459     <span class="comment">//</span>
00460     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00461 
00462 
00463         <span class="keywordflow">if</span> (ProcessAddress != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00464             Profile-&gt;Process = &amp;ProcessAddress-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>;
00465         } <span class="keywordflow">else</span> {
00466             Profile-&gt;Process = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00467         }
00468 
00469         Profile-&gt;RangeBase = RangeBase;
00470         Profile-&gt;RangeSize = RangeSize;
00471         Profile-&gt;Buffer = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00472         Profile-&gt;BufferSize = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
00473         Profile-&gt;BucketSize = BucketSize;
00474         Profile-&gt;LockedBufferAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00475         Profile-&gt;Segment = Segment;
00476         Profile-&gt;ProfileSource = ProfileSource;
00477         Profile-&gt;Affinity = Affinity;
00478 
00479         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>(Profile,
00480                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00481                                 PROFILE_CONTROL,
00482                                 0,
00483                                 (PVOID *)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00484                                 &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
00485         <span class="comment">//</span>
00486         <span class="comment">// If the profile object was successfully inserted in the current</span>
00487         <span class="comment">// process' handle table, then attempt to write the profile object</span>
00488         <span class="comment">// handle value. If the write attempt fails, then do not report</span>
00489         <span class="comment">// an error. When the caller attempts to access the handle value,</span>
00490         <span class="comment">// an access violation will occur.</span>
00491         <span class="comment">//</span>
00492         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00493             <span class="keywordflow">try</span> {
00494                 *ProfileHandle = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00495             } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00496             }
00497         }
00498     }
00499 
00500     <span class="comment">//</span>
00501     <span class="comment">// If we failed, remove our reference to the process object.</span>
00502     <span class="comment">//</span>
00503     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00504         <span class="keywordflow">if</span> (ProcessAddress != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00505             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> ((PVOID)ProcessAddress);
00506         }
00507     }
00508 
00509     <span class="comment">//</span>
00510     <span class="comment">// Return service status.</span>
00511     <span class="comment">//</span>
00512 
00513     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00514 }
00515 
00516 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00517"></a><a class="code" href="../../d9/d6/ex_2profile_8c.html#a10">00517</a> <a class="code" href="../../d9/d6/ex_2profile_8c.html#a10">NtStartProfile</a> (
00518     IN HANDLE ProfileHandle
00519     )
00520 
00521 <span class="comment">/*++</span>
00522 <span class="comment"></span>
00523 <span class="comment">Routine Description:</span>
00524 <span class="comment"></span>
00525 <span class="comment">    The NtStartProfile routine starts the collecting data for the</span>
00526 <span class="comment">    specified profile object.  This involved allocating nonpaged</span>
00527 <span class="comment">    pool to lock the specified buffer in memory, creating a kernel</span>
00528 <span class="comment">    profile object and starting collecting on that profile object.</span>
00529 <span class="comment"></span>
00530 <span class="comment">Arguments:</span>
00531 <span class="comment"></span>
00532 <span class="comment">    ProfileHandle - Supplies the profile handle to start profiling on.</span>
00533 <span class="comment"></span>
00534 <span class="comment">Return Value:</span>
00535 <span class="comment"></span>
00536 <span class="comment">    TBS</span>
00537 <span class="comment"></span>
00538 <span class="comment">--*/</span>
00539 
00540 {
00541 
00542     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00543     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00544     <a class="code" href="../../d9/d6/ex_2profile_8c.html#a2">PEPROFILE</a> Profile;
00545     <a class="code" href="../../d6/d7/struct__KPROFILE.html">PKPROFILE</a> <a class="code" href="../../d4/d9/ke_8h.html#a402a180">ProfileObject</a>;
00546     PVOID LockedVa;
00547     BOOLEAN State;
00548 
00549     PreviousMode = KeGetPreviousMode();
00550 
00551     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( ProfileHandle,
00552                                         PROFILE_CONTROL,
00553                                         <a class="code" href="../../d9/d6/ex_2profile_8c.html#a3">ExProfileObjectType</a>,
00554                                         PreviousMode,
00555                                         (PVOID *)&amp;Profile,
00556                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00557     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00558         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00559     }
00560 
00561     <span class="comment">//</span>
00562     <span class="comment">// Acquire the profile state mutex so two threads can't</span>
00563     <span class="comment">// operate on the same profile object simultaneously.</span>
00564     <span class="comment">//</span>
00565 
00566     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;<a class="code" href="../../d9/d6/ex_2profile_8c.html#a4">ExpProfileStateMutex</a>,
00567                            <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
00568                            <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00569                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00570                            (PLARGE_INTEGER)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00571 
00572     <span class="comment">//</span>
00573     <span class="comment">// Make sure profiling is not already enabled.</span>
00574     <span class="comment">//</span>
00575 
00576     <span class="keywordflow">if</span> (Profile-&gt;LockedBufferAddress != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00577         <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a> (&amp;<a class="code" href="../../d9/d6/ex_2profile_8c.html#a4">ExpProfileStateMutex</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00578         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> ((PVOID)Profile);
00579         <span class="keywordflow">return</span> STATUS_PROFILING_NOT_STOPPED;
00580     }
00581 
00582     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d6/ex_2profile_8c.html#a5">ExpCurrentProfileUsage</a> == <a class="code" href="../../d9/d6/ex_2profile_8c.html#a0">ACTIVE_PROFILE_LIMIT</a>) {
00583         <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a> (&amp;<a class="code" href="../../d9/d6/ex_2profile_8c.html#a4">ExpProfileStateMutex</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00584         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> ((PVOID)Profile);
00585         <span class="keywordflow">return</span> STATUS_PROFILING_AT_LIMIT;
00586     }
00587 
00588     <a class="code" href="../../d4/d9/ke_8h.html#a402a180">ProfileObject</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00589                                     <a class="code" href="../../d5/d6/iosup_8c.html#a72">MmSizeOfMdl</a>(Profile-&gt;Buffer,
00590                                                 Profile-&gt;BufferSize) +
00591                                         <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__KPROFILE.html">KPROFILE</a>),
00592                                         'forP');
00593 
00594     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a402a180">ProfileObject</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00595         <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a> (&amp;<a class="code" href="../../d9/d6/ex_2profile_8c.html#a4">ExpProfileStateMutex</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00596         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> ((PVOID)Profile);
00597         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00598     }
00599 
00600     Profile-&gt;Mdl = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)(<a class="code" href="../../d4/d9/ke_8h.html#a402a180">ProfileObject</a> + 1);
00601     Profile-&gt;ProfileObject = <a class="code" href="../../d4/d9/ke_8h.html#a402a180">ProfileObject</a>;
00602 
00603     <span class="comment">//</span>
00604     <span class="comment">// Probe and lock the specified buffer.</span>
00605     <span class="comment">//</span>
00606 
00607     <a class="code" href="../../d2/d1/mm_8h.html#a24">MmInitializeMdl</a>(Profile-&gt;Mdl, Profile-&gt;Buffer, Profile-&gt;BufferSize);
00608 
00609     <span class="keywordflow">try</span> {
00610 
00611         LockedVa = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00612 
00613         <a class="code" href="../../d5/d6/iosup_8c.html#a41">MmProbeAndLockPages</a> (Profile-&gt;Mdl,
00614                              PreviousMode,
00615                              <a class="code" href="../../d2/d1/mm_8h.html#a344a169">IoWriteAccess</a> );
00616 
00617         LockedVa = (PVOID)43;  <span class="comment">// flag to notice MmMapLockedPages failed.</span>
00618 
00619         LockedVa = <a class="code" href="../../d5/d6/iosup_8c.html#a50">MmMapLockedPagesSpecifyCache</a> (Profile-&gt;Mdl,
00620                                                  <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00621                                                  <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>,
00622                                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00623                                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00624                                                  <a class="code" href="../../d2/d1/mm_8h.html#a347a182">NormalPagePriority</a>);
00625 
00626     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00627 
00628         <span class="keywordflow">if</span> (LockedVa == (PVOID)43 ) {
00629             <a class="code" href="../../d5/d6/iosup_8c.html#a45">MmUnlockPages</a> (Profile-&gt;Mdl);
00630         }
00631         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (<a class="code" href="../../d4/d9/ke_8h.html#a402a180">ProfileObject</a>);
00632         <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a> (&amp;<a class="code" href="../../d9/d6/ex_2profile_8c.html#a4">ExpProfileStateMutex</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00633         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> ((PVOID)Profile);
00634         <span class="keywordflow">return</span> GetExceptionCode();
00635     }
00636 
00637     <span class="keywordflow">if</span> (LockedVa == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00638         <a class="code" href="../../d5/d6/iosup_8c.html#a45">MmUnlockPages</a> (Profile-&gt;Mdl);
00639         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (<a class="code" href="../../d4/d9/ke_8h.html#a402a180">ProfileObject</a>);
00640         <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a> (&amp;<a class="code" href="../../d9/d6/ex_2profile_8c.html#a4">ExpProfileStateMutex</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00641         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> ((PVOID)Profile);
00642         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00643     }
00644 
00645     <span class="comment">//</span>
00646     <span class="comment">// Initialize the profile object.</span>
00647     <span class="comment">//</span>
00648 
00649     <a class="code" href="../../d0/d8/profobj_8c.html#a5">KeInitializeProfile</a> (<a class="code" href="../../d4/d9/ke_8h.html#a402a180">ProfileObject</a>,
00650                          Profile-&gt;Process,
00651                          Profile-&gt;RangeBase,
00652                          Profile-&gt;RangeSize,
00653                          Profile-&gt;BucketSize,
00654                          Profile-&gt;Segment,
00655                          Profile-&gt;ProfileSource,
00656                          Profile-&gt;Affinity);
00657     <span class="keywordflow">try</span> {
00658         State = <a class="code" href="../../d0/d8/profobj_8c.html#a8">KeStartProfile</a> (<a class="code" href="../../d4/d9/ke_8h.html#a402a180">ProfileObject</a>, LockedVa);
00659         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (State != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00660 
00661     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00662 
00663         <a class="code" href="../../d5/d6/iosup_8c.html#a45">MmUnlockPages</a> (Profile-&gt;Mdl);
00664         <a class="code" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (LockedVa, Profile-&gt;Mdl);
00665         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (<a class="code" href="../../d4/d9/ke_8h.html#a402a180">ProfileObject</a>);
00666         <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a> (&amp;<a class="code" href="../../d9/d6/ex_2profile_8c.html#a4">ExpProfileStateMutex</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00667         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> ((PVOID)Profile);
00668         <span class="keywordflow">return</span> GetExceptionCode();
00669     }
00670 
00671     Profile-&gt;LockedBufferAddress = LockedVa;
00672 
00673     <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a> (&amp;<a class="code" href="../../d9/d6/ex_2profile_8c.html#a4">ExpProfileStateMutex</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00674     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> ((PVOID)Profile);
00675 
00676     <span class="keywordflow">return</span> STATUS_SUCCESS;
00677 }
00678 
00679 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00680"></a><a class="code" href="../../d9/d6/ex_2profile_8c.html#a11">00680</a> <a class="code" href="../../d9/d6/ex_2profile_8c.html#a11">NtStopProfile</a> (
00681     IN HANDLE ProfileHandle
00682     )
00683 
00684 <span class="comment">/*++</span>
00685 <span class="comment"></span>
00686 <span class="comment">Routine Description:</span>
00687 <span class="comment"></span>
00688 <span class="comment">    The NtStopProfile routine stops collecting data for the</span>
00689 <span class="comment">    specified profile object.  This involves stopping the data</span>
00690 <span class="comment">    collection on the profile object, unlocking the locked buffers,</span>
00691 <span class="comment">    and deallocating the pool for the MDL and profile object.</span>
00692 <span class="comment"></span>
00693 <span class="comment">Arguments:</span>
00694 <span class="comment"></span>
00695 <span class="comment">    ProfileHandle - Supplies a the profile handle to stop profiling.</span>
00696 <span class="comment"></span>
00697 <span class="comment">Return Value:</span>
00698 <span class="comment"></span>
00699 <span class="comment">    TBS</span>
00700 <span class="comment"></span>
00701 <span class="comment">--*/</span>
00702 
00703 {
00704 
00705     <a class="code" href="../../d9/d6/ex_2profile_8c.html#a2">PEPROFILE</a> Profile;
00706     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00707     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00708     BOOLEAN State;
00709 
00710     PreviousMode = KeGetPreviousMode();
00711 
00712     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( ProfileHandle,
00713                                         PROFILE_CONTROL,
00714                                         <a class="code" href="../../d9/d6/ex_2profile_8c.html#a3">ExProfileObjectType</a>,
00715                                         PreviousMode,
00716                                         (PVOID *)&amp;Profile,
00717                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00718 
00719     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00720         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00721     }
00722 
00723     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;<a class="code" href="../../d9/d6/ex_2profile_8c.html#a4">ExpProfileStateMutex</a>,
00724                            <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
00725                            <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00726                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00727                            (PLARGE_INTEGER)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00728 
00729     <span class="comment">//</span>
00730     <span class="comment">// Check to see if profiling is not active.</span>
00731     <span class="comment">//</span>
00732 
00733     <span class="keywordflow">if</span> (Profile-&gt;LockedBufferAddress == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00734         <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a> (&amp;<a class="code" href="../../d9/d6/ex_2profile_8c.html#a4">ExpProfileStateMutex</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00735         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> ((PVOID)Profile);
00736         <span class="keywordflow">return</span> STATUS_PROFILING_NOT_STARTED;
00737     }
00738 
00739     <span class="comment">//</span>
00740     <span class="comment">// Stop profiling and unlock the buffer.</span>
00741     <span class="comment">//</span>
00742 
00743     State = <a class="code" href="../../d0/d8/profobj_8c.html#a9">KeStopProfile</a> (Profile-&gt;ProfileObject);
00744     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (State != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00745 
00746     <a class="code" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (Profile-&gt;LockedBufferAddress, Profile-&gt;Mdl);
00747     <a class="code" href="../../d5/d6/iosup_8c.html#a45">MmUnlockPages</a> (Profile-&gt;Mdl);
00748     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Profile-&gt;ProfileObject);
00749     Profile-&gt;LockedBufferAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00750     <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a> (&amp;<a class="code" href="../../d9/d6/ex_2profile_8c.html#a4">ExpProfileStateMutex</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00751 
00752     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> ((PVOID)Profile);
00753     <span class="keywordflow">return</span> STATUS_SUCCESS;
00754 }
00755 
00756 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00757"></a><a class="code" href="../../d9/d6/ex_2profile_8c.html#a12">00757</a> <a class="code" href="../../d9/d6/ex_2profile_8c.html#a12">NtSetIntervalProfile</a> (
00758     IN ULONG Interval,
00759     IN KPROFILE_SOURCE Source
00760     )
00761 
00762 <span class="comment">/*++</span>
00763 <span class="comment"></span>
00764 <span class="comment">Routine Description:</span>
00765 <span class="comment"></span>
00766 <span class="comment">    This routine allows the system-wide interval (and thus the profiling</span>
00767 <span class="comment">    rate) for profiling to be set.</span>
00768 <span class="comment"></span>
00769 <span class="comment">Arguments:</span>
00770 <span class="comment"></span>
00771 <span class="comment">    Interval - Supplies the sampling interval in 100ns units.</span>
00772 <span class="comment"></span>
00773 <span class="comment">    Source - Specifies the profile source to be set.</span>
00774 <span class="comment"></span>
00775 <span class="comment">Return Value:</span>
00776 <span class="comment"></span>
00777 <span class="comment">    TBS</span>
00778 <span class="comment"></span>
00779 <span class="comment">--*/</span>
00780 
00781 {
00782 
00783     <a class="code" href="../../d0/d8/profobj_8c.html#a7">KeSetIntervalProfile</a> (Interval, Source);
00784     <span class="keywordflow">return</span> STATUS_SUCCESS;
00785 }
00786 
00787 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00788"></a><a class="code" href="../../d9/d6/ex_2profile_8c.html#a13">00788</a> <a class="code" href="../../d9/d6/ex_2profile_8c.html#a13">NtQueryIntervalProfile</a> (
00789     IN KPROFILE_SOURCE ProfileSource,
00790     OUT PULONG Interval
00791     )
00792 
00793 <span class="comment">/*++</span>
00794 <span class="comment"></span>
00795 <span class="comment">Routine Description:</span>
00796 <span class="comment"></span>
00797 <span class="comment">    This routine queries the system-wide interval (and thus the profiling</span>
00798 <span class="comment">    rate) for profiling.</span>
00799 <span class="comment"></span>
00800 <span class="comment">Arguments:</span>
00801 <span class="comment"></span>
00802 <span class="comment">    Source - Specifies the profile source to be queried.</span>
00803 <span class="comment"></span>
00804 <span class="comment">    Interval - Returns the sampling interval in 100ns units.</span>
00805 <span class="comment"></span>
00806 <span class="comment">Return Value:</span>
00807 <span class="comment"></span>
00808 <span class="comment">    TBS</span>
00809 <span class="comment"></span>
00810 <span class="comment">--*/</span>
00811 
00812 {
00813     ULONG CapturedInterval;
00814     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00815 
00816     PreviousMode = KeGetPreviousMode ();
00817     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00818 
00819         <span class="comment">//</span>
00820         <span class="comment">// Probe accessibility of user's buffer.</span>
00821         <span class="comment">//</span>
00822 
00823         <span class="keywordflow">try</span> {
00824             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a> (Interval);
00825 
00826         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00827 
00828             <span class="comment">//</span>
00829             <span class="comment">// If an exception occurs during the probe or capture</span>
00830             <span class="comment">// of the initial values, then handle the exception and</span>
00831             <span class="comment">// return the exception code as the status value.</span>
00832             <span class="comment">//</span>
00833 
00834             <span class="keywordflow">return</span> GetExceptionCode();
00835         }
00836     }
00837 
00838     CapturedInterval = <a class="code" href="../../d0/d8/profobj_8c.html#a6">KeQueryIntervalProfile</a> (ProfileSource);
00839 
00840     <span class="keywordflow">try</span> {
00841         *Interval = CapturedInterval;
00842 
00843     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00844         NOTHING;
00845     }
00846 
00847     <span class="keywordflow">return</span> STATUS_SUCCESS;
00848 }
00849 
00850 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00851"></a><a class="code" href="../../d9/d6/ex_2profile_8c.html#a14">00851</a> <a class="code" href="../../d9/d6/ex_2profile_8c.html#a14">NtQueryPerformanceCounter</a> (
00852     OUT PLARGE_INTEGER PerformanceCounter,
00853     OUT PLARGE_INTEGER PerformanceFrequency OPTIONAL
00854     )
00855 
00856 <span class="comment">/*++</span>
00857 <span class="comment"></span>
00858 <span class="comment">Routine Description:</span>
00859 <span class="comment"></span>
00860 <span class="comment">    This function returns current value of performance counter and,</span>
00861 <span class="comment">    optionally, the frequency of the performance counter.</span>
00862 <span class="comment"></span>
00863 <span class="comment">    Performance frequency is the frequency of the performance counter</span>
00864 <span class="comment">    in Hertz, i.e., counts/second.  Note that this value is implementation</span>
00865 <span class="comment">    dependent.  If the implementation does not have hardware to support</span>
00866 <span class="comment">    performance timing, the value returned is 0.</span>
00867 <span class="comment"></span>
00868 <span class="comment">Arguments:</span>
00869 <span class="comment"></span>
00870 <span class="comment">    PerformanceCounter - supplies the address of a variable to receive</span>
00871 <span class="comment">        the current Performance Counter value.</span>
00872 <span class="comment"></span>
00873 <span class="comment">    PerformanceFrequency - Optionally, supplies the address of a</span>
00874 <span class="comment">        variable to receive the performance counter frequency.</span>
00875 <span class="comment"></span>
00876 <span class="comment">Return Value:</span>
00877 <span class="comment"></span>
00878 <span class="comment">    STATUS_ACCESS_VIOLATION or STATUS_SUCCESS.</span>
00879 <span class="comment"></span>
00880 <span class="comment">--*/</span>
00881 
00882 {
00883     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00884     LARGE_INTEGER KernelPerformanceFrequency;
00885 
00886     PreviousMode = KeGetPreviousMode();
00887     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00888 
00889         <span class="comment">//</span>
00890         <span class="comment">// Probe accessibility of user's buffer.</span>
00891         <span class="comment">//</span>
00892 
00893         <span class="keywordflow">try</span> {
00894             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a> ( PerformanceCounter,
00895                             <span class="keyword">sizeof</span> (LARGE_INTEGER),
00896                             <span class="keyword">sizeof</span> (ULONG)
00897                           );
00898 
00899             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PerformanceFrequency)) {
00900                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a> ( PerformanceFrequency,
00901                                 <span class="keyword">sizeof</span> (LARGE_INTEGER),
00902                                 <span class="keyword">sizeof</span> (ULONG)
00903                               );
00904             }
00905 
00906         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00907 
00908             <span class="comment">//</span>
00909             <span class="comment">// If an exception occurs during the probe or capture</span>
00910             <span class="comment">// of the initial values, then handle the exception and</span>
00911             <span class="comment">// return the exception code as the status value.</span>
00912             <span class="comment">//</span>
00913 
00914             <span class="keywordflow">return</span> GetExceptionCode();
00915         }
00916     }
00917 
00918     <span class="keywordflow">try</span> {
00919         *PerformanceCounter = <a class="code" href="../../d2/d7/hal_8h.html#a205">KeQueryPerformanceCounter</a> (
00920                                   (PLARGE_INTEGER)&amp;KernelPerformanceFrequency );
00921         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PerformanceFrequency)) {
00922             *PerformanceFrequency = KernelPerformanceFrequency;
00923         }
00924     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00925         <span class="keywordflow">return</span> GetExceptionCode();
00926     }
00927 
00928     <span class="keywordflow">return</span> STATUS_SUCCESS;
00929 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:28 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
