<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ghandler.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ghandler.c File Reference</h1><code>#include "nt.h"</code><br>

<p>
<a href="../../d1/d5/ghandler_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/ghandler_8c.html#a0">IS_EXCEPT</a>(Seb)&nbsp;&nbsp;&nbsp;((Seb)-&gt;JumpTarget != 0)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/ghandler_8c.html#a1">IS_FINALLY</a>(Seb)&nbsp;&nbsp;&nbsp;((Seb)-&gt;JumpTarget == 0)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/ghandler_8c.html#a2">MODIFY_UNWIND_EXCEPTION_RECORD</a>(ExceptionRecord, Seb)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/ghandler_8c.html#a3">__C_ExecuteExceptionFilter</a> (PEXCEPTION_POINTERS ExceptionPointers, EXCEPTION_FILTER ExceptionFilter, ULONG_PTR EstablisherFrame)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG_PTR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/ghandler_8c.html#a4">__C_ExecuteTerminationHandler</a> (BOOLEAN AbnormalTermination, TERMINATION_HANDLER TerminationHandler, ULONG_PTR EstablisherFrame)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>EXCEPTION_DISPOSITION&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/ghandler_8c.html#a5">_OtsCSpecificHandler</a> (IN PEXCEPTION_RECORD ExceptionRecord, IN PVOID EstablisherFrame, IN OUT PCONTEXT ContextRecord, IN OUT PDISPATCHER_CONTEXT DispatcherContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG_PTR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/ghandler_8c.html#a6">_OtsLocalFinallyUnwind</a> (IN PSEH_CONTEXT SehContext, IN PSEH_BLOCK TargetSeb, IN PVOID RealFramePointer)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="ghandler.c::IS_EXCEPT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IS_EXCEPT          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Seb&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((Seb)-&gt;JumpTarget != 0)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/ghandler_8c-source.html#l00071">71</a> of file <a class="el" href="../../d1/d5/ghandler_8c-source.html">ghandler.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d5/ghandler_8c-source.html#l00091">_OtsCSpecificHandler()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="ghandler.c::IS_FINALLY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IS_FINALLY          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Seb&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((Seb)-&gt;JumpTarget == 0)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/ghandler_8c-source.html#l00072">72</a> of file <a class="el" href="../../d1/d5/ghandler_8c-source.html">ghandler.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d5/ghandler_8c-source.html#l00091">_OtsCSpecificHandler()</a>, and <a class="el" href="../../d1/d5/ghandler_8c-source.html#l00331">_OtsLocalFinallyUnwind()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="ghandler.c::MODIFY_UNWIND_EXCEPTION_RECORD" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MODIFY_UNWIND_EXCEPTION_RECORD          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ExceptionRecord,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Seb&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{ \
    ExceptionRecord-&gt;ExceptionCode = STATUS_UNWIND; \
    ExceptionRecord-&gt;ExceptionFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a26">EXCEPTION_UNWINDING</a>; \
    ExceptionRecord-&gt;ExceptionRecord = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; \
    ExceptionRecord-&gt;ExceptionAddress = 0; \
    ExceptionRecord-&gt;NumberParameters = 1; \
    ExceptionRecord-&gt;ExceptionInformation[0] = (ULONG_PTR)(Seb); \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d5/ghandler_8c-source.html#l00081">81</a> of file <a class="el" href="../../d1/d5/ghandler_8c-source.html">ghandler.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d5/ghandler_8c-source.html#l00091">_OtsCSpecificHandler()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="ghandler.c::__C_ExecuteExceptionFilter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG __C_ExecuteExceptionFilter           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PEXCEPTION_POINTERS&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionPointers</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>EXCEPTION_FILTER&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionFilter</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>EstablisherFrame</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="ghandler.c::__C_ExecuteTerminationHandler" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG_PTR __C_ExecuteTerminationHandler           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AbnormalTermination</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>TERMINATION_HANDLER&nbsp;</td>
          <td class="mdname" nowrap> <em>TerminationHandler</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>EstablisherFrame</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="ghandler.c::_OtsCSpecificHandler" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> EXCEPTION_DISPOSITION _OtsCSpecificHandler           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PEXCEPTION_RECORD&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>EstablisherFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PDISPATCHER_CONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>DispatcherContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/ghandler_8c-source.html#l00091">91</a> of file <a class="el" href="../../d1/d5/ghandler_8c-source.html">ghandler.c</a>.
<p>
References <a class="el" href="../../d3/d6/ppc_2chandler_8c.html#a0">__C_ExecuteExceptionFilter()</a>, <a class="el" href="../../d3/d6/ppc_2chandler_8c.html#a1">__C_ExecuteTerminationHandler()</a>, <a class="el" href="../../d1/d5/ghandler_8c-source.html#l00331">_OtsLocalFinallyUnwind()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00059">ExceptionContinueExecution</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00060">ExceptionContinueSearch</a>, <a class="el" href="../../d1/d5/ghandler_8c-source.html#l00071">IS_EXCEPT</a>, <a class="el" href="../../d1/d5/ghandler_8c-source.html#l00072">IS_FINALLY</a>, <a class="el" href="../../d1/d5/ghandler_8c-source.html#l00081">MODIFY_UNWIND_EXCEPTION_RECORD</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00671">RtlUnwind()</a>, <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00737">RtlUnwind2()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00100                    :
00101 
00102     This function walks up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of SEB's associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00103     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> and calls except filters and finally handlers as necessary.
00104 
00105     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called in two different contexts:
00106         (i)  by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception dispatcher after an exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> raised
00107         (ii) by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unwinder during an unwind operation
00108 
00109     In <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first <span class="keywordflow">case</span>, <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> searches <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SEB list <span class="keywordflow">for</span> except filters to evaluate.
00110     In <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second <span class="keywordflow">case</span>, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> searches <span class="keywordflow">for</span> finally handlers to execute.
00111 
00112 Arguments:
00113 
00114     ExceptionRecord - Supplies a pointer to an exception record.
00115 
00116     EstablisherFrame - Supplies a (<span class="keyword">virtual</span> frame) pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> frame of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00117         establisher function.
00118 
00119     ContextRecord - Supplies a pointer to a context record.
00120 
00121     DispatcherContext - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception dispatcher or
00122         unwind dispatcher context.
00123 
00124 Return Value:
00125 
00126     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> handled by one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception filter <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a>, then
00127     there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no <span class="keywordflow">return</span> from <span class="keyword">this</span> routine and <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a19">RtlUnwind</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called. Otherwise,
00128     an exception disposition value of <span class="keywordflow">continue</span> execution or <span class="keywordflow">continue</span> search <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00129     returned.
00130 
00131 Notes:
00132     In context (i) there are 3 possibilities:
00133 
00134         (a) If an exception filter returns a value greater that 0 (meaning
00135             that the associated handler should be invoked) there is no
00136             return from this function. RtlUnwind is called to unwind the
00137             stack to the exception handler corresponding to that filter.
00138 
00139         (b) If an exception filter returns a value less than 0 (meaning
00140             that the exception should be dismissed), this routine returns
00141             value ExceptionContinueExecution.
00142 
00143         (c) If every filter returns value 0 (meaning that the search for a
00144             handler should continue elsewhere), this function returns
00145             ExceptionContinueSearch.
00146 
00147     In context (ii) there are 2 possibilities:
00148 
00149         (d) If no branches are detected out of finally handlers, this
00150             function returns ExceptionContinueSearch.
00151 
00152         (e) If a branch is detected out of a finally handler, there is no
00153             return from this routine. RtlUnwind is called to unwind to the
00154             branch target (and cancel the current unwind).
00155 
00156     There may be <span class="keywordtype">long</span> jumps out of both except filters and finally handlers
00157     in which case this routine will be peeled off the stack without returning.
00158 
00159 --*/
00160 
00161 {
00162 
00163     ULONG_PTR ContinuationAddress;
00164     EXCEPTION_FILTER ExceptionFilter;
00165     PVOID ExceptionHandler;
00166     EXCEPTION_POINTERS ExceptionPointers;
00167     LONG FilterValue;
00168     ULONG_PTR RealFramePointer;
00169     PSEH_BLOCK Seb;
00170     PSEH_CONTEXT SehContext;
00171     PSEH_BLOCK TargetSeb;
00172     TERMINATION_HANDLER TerminationHandler;
00173 
00174     <span class="comment">//</span>
00175     <span class="comment">// Get the address of the SEH context which is at some negative offset</span>
00176     <span class="comment">// from the virtual frame pointer. For GEM, the handler data field of</span>
00177     <span class="comment">// the function entry contains that offset. The current SEB pointer and</span>
00178     <span class="comment">// the RFP (static link) are obtained from the SEH context.</span>
00179     <span class="comment">//</span>
00180 
00181     SehContext = (PSEH_CONTEXT)((ULONG_PTR)EstablisherFrame +
00182         (LONG_PTR)DispatcherContext-&gt;FunctionEntry-&gt;HandlerData);
00183     RealFramePointer = SehContext-&gt;RealFramePointer;
00184 
00185     <span class="comment">//</span>
00186     <span class="comment">// If this is a dispatching context, walk up the list of SEBs evaluating</span>
00187     <span class="comment">// except filters.</span>
00188     <span class="comment">//</span>
00189 
00190     <span class="keywordflow">if</span> (IS_DISPATCHING(ExceptionRecord-&gt;ExceptionFlags)) {
00191 
00192         <span class="comment">//</span>
00193         <span class="comment">// Set up the ExceptionPointers structure that is used by except</span>
00194         <span class="comment">// filters to obtain data for the GetExceptionInformation intrinsic</span>
00195         <span class="comment">// function. Copy the current SEB pointer into a local variable</span>
00196         <span class="comment">// because the real SEB pointer is only modified in unwind contexts.</span>
00197         <span class="comment">//</span>
00198 
00199         ExceptionPointers.ExceptionRecord = ExceptionRecord;
00200         ExceptionPointers.ContextRecord = ContextRecord;
00201 
00202         <span class="keywordflow">for</span> (Seb = SehContext-&gt;CurrentSeb; Seb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; Seb = Seb-&gt;ParentSeb) {
00203             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/ghandler_8c.html#a0">IS_EXCEPT</a>(Seb)) {
00204 
00205                 <span class="comment">//</span>
00206                 <span class="comment">// This is an except filter. Get the addresses of the filter</span>
00207                 <span class="comment">// and exception handler from the SEB, then call the except</span>
00208                 <span class="comment">// filter.</span>
00209                 <span class="comment">//</span>
00210 
00211                 ExceptionFilter = (EXCEPTION_FILTER)Seb-&gt;HandlerAddress;
00212                 ExceptionHandler = (PVOID)Seb-&gt;JumpTarget;
00213 
00214                 FilterValue = <a class="code" href="../../d3/d6/ppc_2chandler_8c.html#a0">__C_ExecuteExceptionFilter</a>(&amp;ExceptionPointers,
00215                                                          ExceptionFilter,
00216                                                          RealFramePointer);
00217 
00218                 <span class="comment">//</span>
00219                 <span class="comment">// If the except filter &lt; 0, dismiss the exception. If &gt; 0,</span>
00220                 <span class="comment">// store the exception code on the stack for the except</span>
00221                 <span class="comment">// handler, modify the given ExceptionRecord so that finally</span>
00222                 <span class="comment">// handlers will be called properly during the unwind, then</span>
00223                 <span class="comment">// unwind down to the except handler. If = 0, resume the</span>
00224                 <span class="comment">// search for except filters.</span>
00225                 <span class="comment">//</span>
00226 
00227                 <span class="keywordflow">if</span> (FilterValue &lt; 0) {
00228                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a36">ExceptionContinueExecution</a>;
00229 
00230                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FilterValue &gt; 0) {
00231                     SehContext-&gt;ExceptionCode = ExceptionRecord-&gt;ExceptionCode;
00232                     <a class="code" href="../../d0/d6/ghandler_8c.html#a2">MODIFY_UNWIND_EXCEPTION_RECORD</a>(ExceptionRecord,
00233                                                    Seb-&gt;ParentSeb);
00234                     <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a12">RtlUnwind2</a>(EstablisherFrame,
00235                                ExceptionHandler,
00236                                ExceptionRecord,
00237                                0,
00238                                ContextRecord);
00239                 }
00240             }
00241         }
00242 
00243     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!IS_TARGET_UNWIND(ExceptionRecord-&gt;ExceptionFlags)) {
00244 
00245         <span class="comment">//</span>
00246         <span class="comment">// This is an unwind but is not the target frame. Since the function</span>
00247         <span class="comment">// is being terminated, finally handlers for all try bodies that are</span>
00248         <span class="comment">// presently in scope must be executed. Walk up the SEB list all the</span>
00249         <span class="comment">// way to the top executing finally handlers. This corresponds to</span>
00250         <span class="comment">// exiting all try bodies that are presently in scope.</span>
00251         <span class="comment">//</span>
00252 
00253         <span class="keywordflow">while</span> (SehContext-&gt;CurrentSeb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00254 
00255             <span class="comment">//</span>
00256             <span class="comment">// Get the address of the SEB and then update the SEH context.</span>
00257             <span class="comment">//</span>
00258 
00259             Seb = SehContext-&gt;CurrentSeb;
00260             SehContext-&gt;CurrentSeb = Seb-&gt;ParentSeb;
00261 
00262             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/ghandler_8c.html#a1">IS_FINALLY</a>(Seb)) {
00263 
00264                 <span class="comment">//</span>
00265                 <span class="comment">// This is a finally handler. Get the address of the handler</span>
00266                 <span class="comment">// from the SEB and call the finally handler.</span>
00267                 <span class="comment">//</span>
00268 
00269                 TerminationHandler = (TERMINATION_HANDLER)Seb-&gt;HandlerAddress;
00270                 ContinuationAddress =
00271                     <a class="code" href="../../d3/d6/ppc_2chandler_8c.html#a1">__C_ExecuteTerminationHandler</a>(TRUE,
00272                                                   TerminationHandler,
00273                                                   RealFramePointer);
00274 
00275                 <span class="comment">//</span>
00276                 <span class="comment">// If the finally handler returns a non-zero result, there</span>
00277                 <span class="comment">// was a branch out of the handler (to that address) and this</span>
00278                 <span class="comment">// routine should unwind to that target.</span>
00279                 <span class="comment">//</span>
00280 
00281                 <span class="keywordflow">if</span> (ContinuationAddress != 0) {
00282                     <a class="code" href="../../d0/d6/ghandler_8c.html#a2">MODIFY_UNWIND_EXCEPTION_RECORD</a>(ExceptionRecord,
00283                                                    SehContext-&gt;CurrentSeb);
00284                     <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a11">RtlUnwind</a>(EstablisherFrame,
00285                               (PVOID)ContinuationAddress,
00286                               ExceptionRecord,
00287                               0);
00288                 }
00289             }
00290         }
00291 
00292     } <span class="keywordflow">else</span> {
00293 
00294         <span class="comment">//</span>
00295         <span class="comment">// This is the target frame of an unwind. Since the target may be</span>
00296         <span class="comment">// in a different try scope than the one defined by the current SEB</span>
00297         <span class="comment">// pointer, finally handlers between the two scopes must execute.</span>
00298         <span class="comment">// Walk up the SEB list from the current SEB to the target SEB and</span>
00299         <span class="comment">// execute all finally handlers encountered.</span>
00300         <span class="comment">//</span>
00301 
00302         TargetSeb = (PSEH_BLOCK)ExceptionRecord-&gt;ExceptionInformation[0];
00303         ContinuationAddress = <a class="code" href="../../d0/d6/ghandler_8c.html#a6">_OtsLocalFinallyUnwind</a>(SehContext,
00304                                                      TargetSeb,
00305                                                      (PVOID)RealFramePointer);
00306         <span class="keywordflow">if</span> (ContinuationAddress != 0) {
00307 
00308             <span class="comment">//</span>
00309             <span class="comment">// A non-zero result indicates there was a branch out of a</span>
00310             <span class="comment">// finally handler that was being executed during the unwind.</span>
00311             <span class="comment">// This routine should unwind to that address.</span>
00312             <span class="comment">//</span>
00313 
00314             <a class="code" href="../../d0/d6/ghandler_8c.html#a2">MODIFY_UNWIND_EXCEPTION_RECORD</a>(ExceptionRecord,
00315                                            SehContext-&gt;CurrentSeb);
00316             <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a11">RtlUnwind</a>(EstablisherFrame,
00317                       (PVOID)ContinuationAddress,
00318                       ExceptionRecord,
00319                       0);
00320         }
00321     }
00322 
00323     <span class="comment">//</span>
00324     <span class="comment">// Continue search for exception or termination handlers.</span>
00325     <span class="comment">//</span>
00326 
00327     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a37">ExceptionContinueSearch</a>;
00328 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="ghandler.c::_OtsLocalFinallyUnwind" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG_PTR _OtsLocalFinallyUnwind           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSEH_CONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>SehContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSEH_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetSeb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>RealFramePointer</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/ghandler_8c-source.html#l00331">331</a> of file <a class="el" href="../../d1/d5/ghandler_8c-source.html">ghandler.c</a>.
<p>
References <a class="el" href="../../d3/d6/ppc_2chandler_8c.html#a1">__C_ExecuteTerminationHandler()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d5/ghandler_8c-source.html#l00072">IS_FINALLY</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d5/ghandler_8c-source.html#l00091">_OtsCSpecificHandler()</a>.
<p>
<pre class="fragment"><div>00339                    :
00340 
00341     This function walks up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SEB tree of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00342     current SEB to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target SEB and executes all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> finally handlers <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
00343     encounters.
00344 
00345     Calls to <span class="keyword">this</span> function are inserted into user code by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> compiler when
00346     there are branches <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> of guarded regions that may require finally
00347     handlers to execute.
00348 
00349     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> also called from <a class="code" href="../../d0/d6/ghandler_8c.html#a5">_OtsCSpecificHandler</a> when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target
00350     frame <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> reached during an unwind operation. There may be finally handlers
00351     that should execute before resuming execution at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unwind target.
00352 
00353 Arguments:
00354 
00355     SehContext - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SEH context structure which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00356         located in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack frame.
00357 
00358     TargetSeb - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SEB corresponding to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> branch
00359         target address.
00360 
00361     RealFramePointer - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> (real frame) pointer of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> establisher
00362         frame, which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current stack frame. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to set up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00363         <span class="keyword">static</span> link <span class="keywordflow">if</span> a finally handler <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked.
00364 
00365 Return Value:
00366 
00367     If a branch <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> of a finally handler <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> detected, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00368     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> branch target. Otherwise, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> zero.
00369 
00370 --*/
00371 
00372 {
00373 
00374     ULONG_PTR ContinuationAddress;
00375     BOOLEAN Nested;
00376     PSEH_BLOCK Seb;
00377     TERMINATION_HANDLER TerminationHandler;
00378 
00379     <span class="comment">//</span>
00380     <span class="comment">// If the SEB pointers are the same, no finally handlers need to execute.</span>
00381     <span class="comment">// The branch is to a target location in the same guarded scope.</span>
00382     <span class="comment">//</span>
00383 
00384     <span class="keywordflow">if</span> (SehContext-&gt;CurrentSeb == TargetSeb) {
00385         <span class="keywordflow">return</span> 0;
00386     }
00387 
00388     <span class="comment">//</span>
00389     <span class="comment">// If the current SEB scope is not nested within the target SEB scope, no</span>
00390     <span class="comment">// finally handlers need to execute. Reset the current SEB pointer to the</span>
00391     <span class="comment">// target SEB pointer and return.</span>
00392     <span class="comment">//</span>
00393 
00394     Nested = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00395     Seb = SehContext-&gt;CurrentSeb;
00396 
00397     <span class="keywordflow">while</span> (Seb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00398         Seb = Seb-&gt;ParentSeb;
00399         <span class="keywordflow">if</span> (Seb == TargetSeb) {
00400             Nested = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00401             <span class="keywordflow">break</span>;
00402         }
00403     }
00404     <span class="keywordflow">if</span> (Nested == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00405         SehContext-&gt;CurrentSeb = TargetSeb;
00406         <span class="keywordflow">return</span> 0;
00407     }
00408 
00409     <span class="comment">//</span>
00410     <span class="comment">// Walk up the list of SEB blocks executing finally handlers. If a branch</span>
00411     <span class="comment">// out of a finally is encountered along the way, return the target</span>
00412     <span class="comment">// address, otherwise return 0.</span>
00413     <span class="comment">//</span>
00414 
00415     <span class="keywordflow">while</span> (SehContext-&gt;CurrentSeb != TargetSeb) {
00416 
00417         <span class="comment">//</span>
00418         <span class="comment">// Get the address of the SEB and then update the SEH context.</span>
00419         <span class="comment">//</span>
00420 
00421         Seb = SehContext-&gt;CurrentSeb;
00422         SehContext-&gt;CurrentSeb = Seb-&gt;ParentSeb;
00423 
00424         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/ghandler_8c.html#a1">IS_FINALLY</a>(Seb)) {
00425             TerminationHandler = (TERMINATION_HANDLER)Seb-&gt;HandlerAddress;
00426             ContinuationAddress =
00427                 <a class="code" href="../../d3/d6/ppc_2chandler_8c.html#a1">__C_ExecuteTerminationHandler</a>(TRUE,
00428                                               TerminationHandler,
00429                                               (ULONG_PTR)RealFramePointer);
00430             <span class="keywordflow">if</span> (ContinuationAddress != 0) {
00431                 <span class="keywordflow">return</span> ContinuationAddress;
00432             }
00433         }
00434     }
00435     <span class="keywordflow">return</span> 0;
00436 }
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:54 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
