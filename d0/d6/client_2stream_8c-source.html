<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: stream.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>stream.c</h1><a href="../../d9/d6/client_2stream_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    stream.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the stubs for the console stream API.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Therese Stowell (thereses) 3-Dec-1990</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    </span>
00020 <span class="comment">    </span>
00021 <span class="comment">--*/</span>
00022 
00023 <span class="preprocessor">#include "<a class="code" href="../../d4/d3/w32_2ntcon_2client_2precomp_8h.html">precomp.h</a>"</span>
00024 <span class="preprocessor">#pragma hdrstop</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#pragma hdrstop</span>
00026 <span class="preprocessor"></span>
00027 <span class="preprocessor">#if !defined(BUILD_WOW64)</span>
00028 <span class="preprocessor"></span>
<a name="l00029"></a><a class="code" href="../../d9/d6/client_2stream_8c.html#a0">00029</a> HANDLE <a class="code" href="../../d8/d9/dllinit_8c.html#a3">InputWaitHandle</a> = (HANDLE)-1;
00030 
00031 HANDLE
00032 <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a>
<a name="l00033"></a><a class="code" href="../../d9/d6/client_2stream_8c.html#a1">00033</a> <a class="code" href="../../d9/d6/client_2stream_8c.html#a1">GetConsoleInputWaitHandle</a>( VOID )
00034 {
00035     <span class="keywordflow">return</span> <a class="code" href="../../d8/d9/dllinit_8c.html#a3">InputWaitHandle</a>;
00036 }
00037 
00038 <span class="preprocessor">#endif </span>
00039 <span class="preprocessor"></span>
00040 <span class="preprocessor"></span><span class="preprocessor">#if !defined(BUILD_WOW6432)</span>
00041 <span class="preprocessor"></span>
00042 HANDLE
00043 <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a>
<a name="l00044"></a><a class="code" href="../../d9/d6/client_2stream_8c.html#a2">00044</a> <a class="code" href="../../d9/d6/client_2stream_8c.html#a2">OpenConsoleWInternal</a>(
00045     IN ULONG HandleType,
00046     IN ULONG DesiredAccess,
00047     IN BOOL InheritHandle,
00048     IN ULONG ShareMode
00049     )
00050 <span class="comment">/*++</span>
00051 <span class="comment"></span>
00052 <span class="comment">Routine Description:</span>
00053 <span class="comment"></span>
00054 <span class="comment">   Marshels parameters for the ConsolepOpenConsole command.</span>
00055 <span class="comment"></span>
00056 <span class="comment">Arguments:</span>
00057 <span class="comment"></span>
00058 <span class="comment">   See the CONSOLE_OPENCONSOLE_MSG structure and OpenConsoleW.</span>
00059 <span class="comment"></span>
00060 <span class="comment">Return Value:</span>
00061 <span class="comment"></span>
00062 <span class="comment">    INVALID_HANDLE_VALUE - An error occured.</span>
00063 <span class="comment"></span>
00064 <span class="comment">--*/</span>
00065 {
00066 
00067     <a class="code" href="../../d5/d9/struct__CONSOLE__API__MSG.html">CONSOLE_API_MSG</a> m;
00068     <a class="code" href="../../d9/d3/struct__CONSOLE__OPENCONSOLE__MSG.html">PCONSOLE_OPENCONSOLE_MSG</a> a = &amp;m.<a class="code" href="../../d5/d9/struct__CONSOLE__API__MSG.html#o77">u</a>.OpenConsole;
00069 
00070     a-&gt;<a class="code" href="../../d9/d3/struct__CONSOLE__OPENCONSOLE__MSG.html#o0">ConsoleHandle</a> = <a class="code" href="../../d6/d4/condll_8h.html#a1">GET_CONSOLE_HANDLE</a>;
00071     a-&gt;<a class="code" href="../../d9/d3/struct__CONSOLE__OPENCONSOLE__MSG.html#o1">HandleType</a>    = HandleType;
00072     a-&gt;<a class="code" href="../../d9/d3/struct__CONSOLE__OPENCONSOLE__MSG.html#o2">DesiredAccess</a> = DesiredAccess;
00073     a-&gt;<a class="code" href="../../d9/d3/struct__CONSOLE__OPENCONSOLE__MSG.html#o3">InheritHandle</a> = InheritHandle;
00074     a-&gt;<a class="code" href="../../d9/d3/struct__CONSOLE__OPENCONSOLE__MSG.html#o4">ShareMode</a>= ShareMode;
00075     <a class="code" href="../../d8/d9/wow64csr_8c.html#a4">CsrClientCallServer</a>( (PCSR_API_MSG)&amp;m,
00076                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00077                          CSR_MAKE_API_NUMBER( CONSRV_SERVERDLL_INDEX,
00078                                               <a class="code" href="../../d5/d5/conmsg_8h.html#a236a163">ConsolepOpenConsole</a>
00079                                             ),
00080                          <span class="keyword">sizeof</span>( *a )
00081                        );
00082     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( m.ReturnValue)) {
00083         <a class="code" href="../../d6/d4/condll_8h.html#a3">SET_LAST_NT_ERROR</a>(m.ReturnValue);
00084         <span class="keywordflow">return</span> (HANDLE) <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>;
00085     }
00086     <span class="keywordflow">else</span> {
00087         <span class="keywordflow">return</span> a-&gt;Handle;
00088     }
00089 
00090 }
00091 
00092 <span class="preprocessor">#endif // !defined(BUILD_WOW6432)</span>
00093 <span class="preprocessor"></span>
00094 <span class="preprocessor">#if !defined(BUILD_WOW64)</span>
00095 <span class="preprocessor"></span>
00096 HANDLE
00097 <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a>
<a name="l00098"></a><a class="code" href="../../d9/d6/client_2stream_8c.html#a3">00098</a> <a class="code" href="../../d9/d6/client_2stream_8c.html#a3">OpenConsoleW</a>(
00099     IN LPWSTR lpConsoleDevice,
00100     IN DWORD dwDesiredAccess,
00101     IN BOOL bInheritHandle,
00102     IN DWORD dwShareMode
00103     )
00104 
00105 <span class="comment">/*++</span>
00106 <span class="comment"></span>
00107 <span class="comment">Parameters:</span>
00108 <span class="comment"></span>
00109 <span class="comment">    lpConsoleDevice - Supplies the console device name to open.  "CONIN$"</span>
00110 <span class="comment">        indicates console input.  "CONOUT$" indicates console output.  The</span>
00111 <span class="comment">        caller must have appropriate access to the console for this call to</span>
00112 <span class="comment">        succeed.</span>
00113 <span class="comment"></span>
00114 <span class="comment">    dwDesiredAccess - Supplies the caller's desired access to the console</span>
00115 <span class="comment">        device.</span>
00116 <span class="comment"></span>
00117 <span class="comment">        DesiredAccess Flags:</span>
00118 <span class="comment"></span>
00119 <span class="comment">        GENERIC_READ - Read access to the console device is requested.  This</span>
00120 <span class="comment">            allows data to be read from the console device.</span>
00121 <span class="comment"></span>
00122 <span class="comment">        GENERIC_WRITE - Write access to the console device is requested.  This</span>
00123 <span class="comment">            allows data to be written to the console device.</span>
00124 <span class="comment"></span>
00125 <span class="comment">    bInheritHandle - Supplies a flag that indicates whether or not the</span>
00126 <span class="comment">        returned handle is to be inherited by a new process</span>
00127 <span class="comment">        during a CreateProcess.  A value of TRUE indicates that the</span>
00128 <span class="comment">        new process will inherit the handle.</span>
00129 <span class="comment"></span>
00130 <span class="comment">    dwShareMode - Supplies a set of flags that indicates how this console</span>
00131 <span class="comment">        device is to be shared with other openers of the console device.  A</span>
00132 <span class="comment">        value of zero for this parameter indicates no sharing of the console,</span>
00133 <span class="comment">        or exclusive access to the console is to occur.</span>
00134 <span class="comment"></span>
00135 <span class="comment">        ShareMode Flags:</span>
00136 <span class="comment"></span>
00137 <span class="comment">        FILE_SHARE_READ - Other open operations may be performed on the</span>
00138 <span class="comment">            console device for read access.</span>
00139 <span class="comment"></span>
00140 <span class="comment">        FILE_SHARE_WRITE - Other open operations may be performed on the</span>
00141 <span class="comment">            console device for write access.</span>
00142 <span class="comment"></span>
00143 <span class="comment">Return Value:</span>
00144 <span class="comment"></span>
00145 <span class="comment">    Not -1 - Returns an open handle to the specified console device.</span>
00146 <span class="comment">        Subsequent access to the file is controlled by the DesiredAccess</span>
00147 <span class="comment">        parameter.</span>
00148 <span class="comment"></span>
00149 <span class="comment">    0xffffffff - The operation failed. Extended error status is available</span>
00150 <span class="comment">        using GetLastError.</span>
00151 <span class="comment">--*/</span>
00152 
00153 {
00154     ULONG HandleType;
00155 
00156     <span class="keywordflow">try</span> {
00157         <span class="keywordflow">if</span> (!lstrcmpiW(CONSOLE_INPUT_STRING,lpConsoleDevice)) {
00158             HandleType = <a class="code" href="../../d5/d5/conmsg_8h.html#a0">CONSOLE_INPUT_HANDLE</a>;
00159         }
00160         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!lstrcmpiW(CONSOLE_OUTPUT_STRING,lpConsoleDevice)) {
00161             HandleType = <a class="code" href="../../d5/d5/conmsg_8h.html#a1">CONSOLE_OUTPUT_HANDLE</a>;
00162         }
00163         <span class="keywordflow">else</span> {
00164             <a class="code" href="../../d6/d4/condll_8h.html#a2">SET_LAST_ERROR</a>(ERROR_INVALID_PARAMETER);
00165             <span class="keywordflow">return</span> (HANDLE) <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>;
00166         }
00167     } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00168         <a class="code" href="../../d6/d4/condll_8h.html#a2">SET_LAST_ERROR</a>(ERROR_INVALID_ACCESS);
00169         <span class="keywordflow">return</span> (HANDLE) <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>;
00170     }
00171     <span class="keywordflow">if</span> (dwDesiredAccess &amp; ~<a class="code" href="../../d6/d4/condll_8h.html#a4">VALID_ACCESSES</a> ||
00172         dwShareMode &amp; ~<a class="code" href="../../d6/d4/condll_8h.html#a5">VALID_SHARE_ACCESSES</a>) {
00173         <a class="code" href="../../d6/d4/condll_8h.html#a2">SET_LAST_ERROR</a>(ERROR_INVALID_PARAMETER);
00174         <span class="keywordflow">return</span> (HANDLE) <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>;
00175     }
00176 
00177     <span class="keywordflow">return</span> <a class="code" href="../../d9/d6/client_2stream_8c.html#a2">OpenConsoleWInternal</a>(HandleType,
00178                                 dwDesiredAccess,
00179                                 bInheritHandle,
00180                                 dwShareMode
00181                                 );
00182 
00183 }
00184 
00185 <span class="preprocessor">#endif // !defined(BUILD_WOW64)</span>
00186 <span class="preprocessor"></span>
00187 <span class="preprocessor">#if !defined(BUILD_WOW6432)</span>
00188 <span class="preprocessor"></span>
00189 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00190 <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a>
<a name="l00191"></a><a class="code" href="../../d9/d6/client_2stream_8c.html#a4">00191</a> <a class="code" href="../../d9/d6/client_2stream_8c.html#a4">ReadConsoleInternal</a>(
00192     IN HANDLE hConsoleInput,
00193     OUT LPVOID lpBuffer,
00194     IN DWORD nNumberOfCharsToRead,
00195     OUT LPDWORD lpNumberOfCharsRead,
00196     IN OUT LPVOID lpReserved,
00197     IN BOOLEAN Unicode,
00198     IN USHORT ExeNameLength,
00199     IN LPWSTR ExeName
00200     )
00201 <span class="comment">/*++</span>
00202 <span class="comment">Parameters:</span>
00203 <span class="comment"></span>
00204 <span class="comment">    hConsoleInput - Supplies an open handle to "CONIN$" open for GENERIC_READ</span>
00205 <span class="comment">        or the StdIn handle.</span>
00206 <span class="comment"></span>
00207 <span class="comment">    lpBuffer - Supplies the address of a buffer to receive the data read</span>
00208 <span class="comment">        from the console input.</span>
00209 <span class="comment"></span>
00210 <span class="comment">    nNumberOfBytesToRead - Supplies the number of bytes to read from the</span>
00211 <span class="comment">        input buffer.</span>
00212 <span class="comment"></span>
00213 <span class="comment">    lpReserved - Ignore unless 4.0 application, in which case it points</span>
00214 <span class="comment">        to a CONSOLE_READCONSOLE_CONTROL data structure.  UNICODE only.</span>
00215 <span class="comment">        If !Unicode, then call fails if this parameter is non-NULL</span>
00216 <span class="comment"></span>
00217 <span class="comment">    Unicode - TRUE if call from ReadConsoleW, FALSE if ReadConsoleA</span>
00218 <span class="comment"></span>
00219 <span class="comment"></span>
00220 <span class="comment">Return Value:</span>
00221 <span class="comment"></span>
00222 <span class="comment">    NON-NULL - Returns the number of bytes actually read from the input buffer.</span>
00223 <span class="comment"></span>
00224 <span class="comment">    FALSE/NULL - The operation failed.</span>
00225 <span class="comment">        Extended error status is available using GetLastError.</span>
00226 <span class="comment">--*/</span>
00227 
00228 {
00229     PCSR_CAPTURE_HEADER CaptureBuffer;
00230     <a class="code" href="../../d5/d9/struct__CONSOLE__API__MSG.html">CONSOLE_API_MSG</a> m;
00231     <a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html">PCONSOLE_READCONSOLE_MSG</a> a = &amp;m.<a class="code" href="../../d5/d9/struct__CONSOLE__API__MSG.html#o77">u</a>.ReadConsole;
00232     BOOLEAN Dummy;
00233     PCONSOLE_READCONSOLE_CONTROL pInputControl;
00234     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00235 
00236     a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o0">ConsoleHandle</a> = <a class="code" href="../../d6/d4/condll_8h.html#a1">GET_CONSOLE_HANDLE</a>;
00237     a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o1">InputHandle</a> = hConsoleInput;
00238     a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o2">ExeNameLength</a> = <a class="code" href="../../d2/d1/client_2cmdline_8c.html#a6">ExeNameLength</a>;
00239     RtlCopyMemory(a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o3">Buffer</a>, ExeName, <a class="code" href="../../d2/d1/client_2cmdline_8c.html#a6">ExeNameLength</a>);
00240     a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o10">Unicode</a> = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>;
00241 
00242     <span class="comment">//</span>
00243     <span class="comment">// if ansi, make capture buffer large enough to hold translated</span>
00244     <span class="comment">// string.  this will make server side code much simpler.</span>
00245     <span class="comment">//</span>
00246 
00247     a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o6">CaptureBufferSize</a> = a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a> = nNumberOfCharsToRead * <span class="keyword">sizeof</span>(WCHAR);
00248     <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o6">CaptureBufferSize</a> &gt; <a class="code" href="../../d9/d9/tcmpmem_8c.html#a0">BUFFER_SIZE</a>) {
00249         CaptureBuffer = <a class="code" href="../../d8/d9/wow64csr_8c.html#a5">CsrAllocateCaptureBuffer</a>( 1,
00250                                                   a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o6">CaptureBufferSize</a>
00251                                                 );
00252         <span class="keywordflow">if</span> (CaptureBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00253             <a class="code" href="../../d6/d4/condll_8h.html#a2">SET_LAST_ERROR</a>(ERROR_NOT_ENOUGH_MEMORY);
00254             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00255         }
00256         <a class="code" href="../../d8/d9/wow64csr_8c.html#a8">CsrCaptureMessageBuffer</a>( CaptureBuffer,
00257                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00258                                  a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o6">CaptureBufferSize</a>,
00259                                  (PVOID *) &amp;a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o4">BufPtr</a>
00260                                );
00261 
00262     }
00263     <span class="keywordflow">else</span> {
00264         a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o4">BufPtr</a> = a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o3">Buffer</a>;
00265         CaptureBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00266     }
00267 
00268 
00269     pInputControl = (PCONSOLE_READCONSOLE_CONTROL)lpReserved;
00270     a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o7">InitialNumBytes</a> = 0;
00271     a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o8">CtrlWakeupMask</a> = 0;
00272     a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o9">ControlKeyState</a> = 0;
00273     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00274     <span class="keywordflow">try</span> {
00275         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> &amp;&amp;
00276             ARGUMENT_PRESENT(lpReserved) &amp;&amp;
00277             NtCurrentPeb()-&gt;ImageSubsystemMajorVersion &gt;= 4 &amp;&amp;
00278             pInputControl-&gt;nLength == <span class="keyword">sizeof</span>(*pInputControl)
00279            ) {
00280             <span class="keywordflow">if</span> ((pInputControl-&gt;nInitialChars &gt; nNumberOfCharsToRead)) {
00281                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00282             } <span class="keywordflow">else</span> {
00283                 a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o7">InitialNumBytes</a> = pInputControl-&gt;nInitialChars * <span class="keyword">sizeof</span>(WCHAR);
00284                 <span class="keywordflow">if</span> (pInputControl-&gt;nInitialChars != 0) {
00285                     RtlCopyMemory( a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o4">BufPtr</a>, lpBuffer, a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o7">InitialNumBytes</a> );
00286                 }
00287                 a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o8">CtrlWakeupMask</a> = pInputControl-&gt;dwCtrlWakeupMask;
00288             }
00289         } <span class="keywordflow">else</span> {
00290             pInputControl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00291         }
00292     } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00293         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00294     }
00295 
00296     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp; pInputControl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00297         <span class="keywordflow">if</span> (CaptureBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00298             <a class="code" href="../../d8/d9/wow64csr_8c.html#a6">CsrFreeCaptureBuffer</a>( CaptureBuffer );
00299         }
00300         <a class="code" href="../../d6/d4/condll_8h.html#a3">SET_LAST_NT_ERROR</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00301         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00302     }
00303 
00304     <a class="code" href="../../d8/d9/wow64csr_8c.html#a4">CsrClientCallServer</a>( (PCSR_API_MSG)&amp;m,
00305                          CaptureBuffer,
00306                          CSR_MAKE_API_NUMBER( CONSRV_SERVERDLL_INDEX,
00307                                               <a class="code" href="../../d5/d5/conmsg_8h.html#a236a192">ConsolepReadConsole</a>
00308                                             ),
00309                          <span class="keyword">sizeof</span>( *a )
00310                        );
00311     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( m.ReturnValue )) {
00312         <span class="keywordflow">try</span> {
00313             *lpNumberOfCharsRead = a-&gt;NumBytes;
00314             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>) {
00315                 *lpNumberOfCharsRead /= <span class="keyword">sizeof</span>(WCHAR);
00316                 <span class="keywordflow">if</span> (pInputControl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00317                     pInputControl-&gt;dwControlKeyState = a-&gt;ControlKeyState;
00318                 }
00319             }
00320             RtlCopyMemory( lpBuffer, a-&gt;BufPtr, a-&gt;NumBytes );
00321         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00322             <span class="keywordflow">if</span> (CaptureBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00323                 <a class="code" href="../../d8/d9/wow64csr_8c.html#a6">CsrFreeCaptureBuffer</a>( CaptureBuffer );
00324             }
00325             <a class="code" href="../../d6/d4/condll_8h.html#a2">SET_LAST_ERROR</a>(ERROR_INVALID_ACCESS);
00326             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00327         }
00328     }
00329     <span class="keywordflow">if</span> (CaptureBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00330         <a class="code" href="../../d8/d9/wow64csr_8c.html#a6">CsrFreeCaptureBuffer</a>( CaptureBuffer );
00331     }
00332     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( m.ReturnValue )) {
00333         <a class="code" href="../../d6/d4/condll_8h.html#a3">SET_LAST_NT_ERROR</a>(m.ReturnValue);
00334         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00335     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (m.ReturnValue == STATUS_ALERTED) {
00336         <span class="comment">// ctrl-c or ctrl-break</span>
00337         <a class="code" href="../../d6/d1/yield_8c.html#a0">NtYieldExecution</a>();
00338         <a class="code" href="../../d6/d4/condll_8h.html#a2">SET_LAST_ERROR</a>(ERROR_OPERATION_ABORTED);
00339     }
00340     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00341 }
00342 
00343 <span class="preprocessor">#endif </span>
00344 <span class="preprocessor"></span>
00345 <span class="preprocessor"></span><span class="preprocessor">#if !defined(BUILD_WOW64)</span>
00346 <span class="preprocessor"></span>
00347 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00348 <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a>
<a name="l00349"></a><a class="code" href="../../d9/d6/client_2stream_8c.html#a5">00349</a> <a class="code" href="../../d9/d6/client_2stream_8c.html#a5">ReadConsoleA</a>(
00350     IN HANDLE hConsoleInput,
00351     OUT LPVOID lpBuffer,
00352     IN DWORD nNumberOfCharsToRead,
00353     OUT LPDWORD lpNumberOfCharsRead,
00354     IN OUT LPVOID lpReserved
00355     )
00356 {
00357 
00358     WCHAR ExeName[<a class="code" href="../../d9/d9/tcmpmem_8c.html#a0">BUFFER_SIZE</a>/2];
00359     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d2/d1/client_2cmdline_8c.html#a6">ExeNameLength</a>;
00360 
00361     <a class="code" href="../../d2/d1/client_2cmdline_8c.html#a6">ExeNameLength</a> = <a class="code" href="../../d6/d4/condll_8h.html#a13">GetCurrentExeName</a>(ExeName, <span class="keyword">sizeof</span>(ExeName));
00362 
00363     <span class="keywordflow">return</span> <a class="code" href="../../d9/d6/client_2stream_8c.html#a4">ReadConsoleInternal</a>(hConsoleInput,
00364                                lpBuffer,
00365                                nNumberOfCharsToRead,
00366                                lpNumberOfCharsRead,
00367                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00368                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00369                                <a class="code" href="../../d2/d1/client_2cmdline_8c.html#a6">ExeNameLength</a>,
00370                                ExeName
00371                               );
00372     UNREFERENCED_PARAMETER(lpReserved);
00373 }
00374 
00375 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00376 <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a>
<a name="l00377"></a><a class="code" href="../../d9/d6/client_2stream_8c.html#a6">00377</a> <a class="code" href="../../d9/d6/client_2stream_8c.html#a6">ReadConsoleW</a>(
00378     IN HANDLE hConsoleInput,
00379     OUT LPVOID lpBuffer,
00380     IN DWORD nNumberOfCharsToRead,
00381     OUT LPDWORD lpNumberOfCharsRead,
00382     IN OUT LPVOID lpReserved
00383     )
00384 {
00385     WCHAR ExeName[<a class="code" href="../../d9/d9/tcmpmem_8c.html#a0">BUFFER_SIZE</a>/2];
00386     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d2/d1/client_2cmdline_8c.html#a6">ExeNameLength</a>;
00387 
00388     <a class="code" href="../../d2/d1/client_2cmdline_8c.html#a6">ExeNameLength</a> = <a class="code" href="../../d6/d4/condll_8h.html#a13">GetCurrentExeName</a>(ExeName, <span class="keyword">sizeof</span>(ExeName));
00389 
00390     <span class="keywordflow">return</span> <a class="code" href="../../d9/d6/client_2stream_8c.html#a4">ReadConsoleInternal</a>(hConsoleInput,
00391                                lpBuffer,
00392                                nNumberOfCharsToRead,
00393                                lpNumberOfCharsRead,
00394                                lpReserved,
00395                                <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00396                                <a class="code" href="../../d2/d1/client_2cmdline_8c.html#a6">ExeNameLength</a>,
00397                                ExeName
00398                               );
00399     UNREFERENCED_PARAMETER(lpReserved);
00400 }
00401 
00402 <span class="preprocessor">#endif </span>
00403 <span class="preprocessor"></span>
00404 <span class="preprocessor"></span><span class="preprocessor">#if !defined(BUILD_WOW6432)</span>
00405 <span class="preprocessor"></span>
00406 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00407 <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a>
<a name="l00408"></a><a class="code" href="../../d9/d6/client_2stream_8c.html#a7">00408</a> <a class="code" href="../../d9/d6/client_2stream_8c.html#a7">WriteConsoleInternal</a>(
00409     IN HANDLE hConsoleOutput,
00410     IN CONST VOID *lpBuffer,
00411     IN DWORD nNumberOfCharsToWrite,
00412     OUT LPDWORD lpNumberOfCharsWritten,
00413     IN BOOLEAN Unicode
00414     )
00415 
00416 <span class="comment">/*++</span>
00417 <span class="comment">Parameters:</span>
00418 <span class="comment"></span>
00419 <span class="comment">    hFile - Supplies an open handle to to "CONOUT$" open for GENERIC_WRITE</span>
00420 <span class="comment">        or the StdOut or StdErr handle.</span>
00421 <span class="comment"></span>
00422 <span class="comment">    lpBuffer - Supplies the address of the data that is to be written to</span>
00423 <span class="comment">        the console output.</span>
00424 <span class="comment"></span>
00425 <span class="comment">    nNumberOfBytesToWrite - Supplies the number of bytes to write to the</span>
00426 <span class="comment">        console output.</span>
00427 <span class="comment"></span>
00428 <span class="comment">Return Value:</span>
00429 <span class="comment"></span>
00430 <span class="comment">    NON-NULL - Returns the number of bytes actually written to the device.</span>
00431 <span class="comment"></span>
00432 <span class="comment">    FALSE/NULL - The operation failed.</span>
00433 <span class="comment">        Extended error status is available using GetLastError.</span>
00434 <span class="comment">--*/</span>
00435 
00436 {
00437 
00438     PCSR_CAPTURE_HEADER CaptureBuffer;
00439     <a class="code" href="../../d5/d9/struct__CONSOLE__API__MSG.html">CONSOLE_API_MSG</a> m;
00440     <a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html">PCONSOLE_WRITECONSOLE_MSG</a> a = &amp;m.<a class="code" href="../../d5/d9/struct__CONSOLE__API__MSG.html#o77">u</a>.WriteConsole;
00441 
00442     a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o0">ConsoleHandle</a> = <a class="code" href="../../d6/d4/condll_8h.html#a1">GET_CONSOLE_HANDLE</a>;
00443     a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o1">OutputHandle</a> = hConsoleOutput;
00444 
00445     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>) {
00446         a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a> = nNumberOfCharsToWrite * <span class="keyword">sizeof</span>(WCHAR);
00447     } <span class="keywordflow">else</span> {
00448         a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a> = nNumberOfCharsToWrite;
00449     }
00450 
00451     a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o7">Unicode</a> = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>;
00452     <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a> &gt; <a class="code" href="../../d9/d9/tcmpmem_8c.html#a0">BUFFER_SIZE</a>) {
00453         CaptureBuffer = <a class="code" href="../../d8/d9/wow64csr_8c.html#a5">CsrAllocateCaptureBuffer</a>( 1,
00454                                                   a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a>
00455                                                 );
00456         <span class="keywordflow">if</span> (CaptureBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00457             <a class="code" href="../../d6/d4/condll_8h.html#a2">SET_LAST_ERROR</a>(ERROR_NOT_ENOUGH_MEMORY);
00458             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00459         }
00460         <a class="code" href="../../d8/d9/wow64csr_8c.html#a8">CsrCaptureMessageBuffer</a>( CaptureBuffer,
00461                                  (PCHAR) lpBuffer,
00462                                  a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a>,
00463                                  (PVOID *) &amp;a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o3">BufPtr</a>
00464                                );
00465         a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o6">BufferInMessage</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00466     }
00467     <span class="keywordflow">else</span> {
00468         a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o3">BufPtr</a> = a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o2">Buffer</a>;
00469         <span class="keywordflow">try</span> {
00470             RtlCopyMemory( a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o3">BufPtr</a>, lpBuffer, a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a>);
00471         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00472             <a class="code" href="../../d6/d4/condll_8h.html#a2">SET_LAST_ERROR</a>(ERROR_INVALID_ACCESS);
00473             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00474         }
00475         CaptureBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00476         a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o6">BufferInMessage</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00477     }
00478     <a class="code" href="../../d8/d9/wow64csr_8c.html#a4">CsrClientCallServer</a>( (PCSR_API_MSG)&amp;m,
00479                          CaptureBuffer,
00480                          CSR_MAKE_API_NUMBER( CONSRV_SERVERDLL_INDEX,
00481                                               <a class="code" href="../../d5/d5/conmsg_8h.html#a236a193">ConsolepWriteConsole</a>
00482                                             ),
00483                          <span class="keyword">sizeof</span>( *a )
00484                        );
00485     <span class="keywordflow">if</span> (CaptureBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00486         <a class="code" href="../../d8/d9/wow64csr_8c.html#a6">CsrFreeCaptureBuffer</a>( CaptureBuffer );
00487     }
00488     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( m.ReturnValue )) {
00489         <a class="code" href="../../d6/d4/condll_8h.html#a3">SET_LAST_NT_ERROR</a>(m.ReturnValue);
00490         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00491     }
00492     <span class="keywordflow">try</span> {
00493        *lpNumberOfCharsWritten = a-&gt;NumBytes;
00494        <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>) {
00495            *lpNumberOfCharsWritten /= <span class="keyword">sizeof</span>(WCHAR);
00496        }
00497     } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00498         <a class="code" href="../../d6/d4/condll_8h.html#a2">SET_LAST_ERROR</a>(ERROR_INVALID_ACCESS);
00499         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00500     }
00501     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00502 
00503 }
00504 
00505 <span class="preprocessor">#endif </span>
00506 <span class="preprocessor"></span>
00507 <span class="preprocessor"></span><span class="preprocessor">#if !defined(BUILD_WOW64)</span>
00508 <span class="preprocessor"></span>
00509 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00510 <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a>
<a name="l00511"></a><a class="code" href="../../d9/d6/client_2stream_8c.html#a8">00511</a> <a class="code" href="../../d9/d6/client_2stream_8c.html#a8">WriteConsoleA</a>(
00512     IN HANDLE hConsoleOutput,
00513     IN CONST VOID *lpBuffer,
00514     IN DWORD nNumberOfCharsToWrite,
00515     OUT LPDWORD lpNumberOfCharsWritten,
00516     IN OUT LPVOID lpReserved
00517     )
00518 {
00519     <span class="keywordflow">return</span> <a class="code" href="../../d9/d6/client_2stream_8c.html#a7">WriteConsoleInternal</a>(hConsoleOutput,
00520                                 lpBuffer,
00521                                 nNumberOfCharsToWrite,
00522                                 lpNumberOfCharsWritten,
00523                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00524                                );
00525     UNREFERENCED_PARAMETER(lpReserved);
00526 }
00527 
00528 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00529 <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a>
<a name="l00530"></a><a class="code" href="../../d9/d6/client_2stream_8c.html#a9">00530</a> <a class="code" href="../../d9/d6/client_2stream_8c.html#a9">WriteConsoleW</a>(
00531     IN HANDLE hConsoleOutput,
00532     IN CONST VOID *lpBuffer,
00533     IN DWORD nNumberOfCharsToWrite,
00534     OUT LPDWORD lpNumberOfCharsWritten,
00535     IN OUT LPVOID lpReserved
00536     )
00537 {
00538     <span class="keywordflow">return</span> <a class="code" href="../../d9/d6/client_2stream_8c.html#a7">WriteConsoleInternal</a>(hConsoleOutput,
00539                                 lpBuffer,
00540                                 nNumberOfCharsToWrite,
00541                                 lpNumberOfCharsWritten,
00542                                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00543                                );
00544     UNREFERENCED_PARAMETER(lpReserved);
00545 }
00546 
00547 <span class="preprocessor">#endif </span>
00548 <span class="preprocessor"></span>
00549 <span class="preprocessor"></span><span class="preprocessor">#if !defined(BUILD_WOW6432)</span>
00550 <span class="preprocessor"></span>
00551 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00552 <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a>
<a name="l00553"></a><a class="code" href="../../d9/d6/client_2stream_8c.html#a10">00553</a> <a class="code" href="../../d9/d6/client_2stream_8c.html#a10">CloseConsoleHandle</a>(
00554     IN HANDLE hConsole
00555     )
00556 
00557 <span class="comment">/*++</span>
00558 <span class="comment"></span>
00559 <span class="comment">Parameters:</span>
00560 <span class="comment"></span>
00561 <span class="comment">    hConsole - An open handle to console input or output.</span>
00562 <span class="comment"></span>
00563 <span class="comment">Return Value:</span>
00564 <span class="comment"></span>
00565 <span class="comment">    TRUE - The operation was successful.</span>
00566 <span class="comment"></span>
00567 <span class="comment">    FALSE/NULL - The operation failed. Extended error status is available</span>
00568 <span class="comment">        using GetLastError.</span>
00569 <span class="comment"></span>
00570 <span class="comment">--*/</span>
00571 
00572 {
00573 
00574     <a class="code" href="../../d5/d9/struct__CONSOLE__API__MSG.html">CONSOLE_API_MSG</a> m;
00575     <a class="code" href="../../d7/d9/struct__CONSOLE__CLOSEHANDLE__MSG.html">PCONSOLE_CLOSEHANDLE_MSG</a> a = &amp;m.<a class="code" href="../../d5/d9/struct__CONSOLE__API__MSG.html#o77">u</a>.CloseHandle;
00576 
00577     a-&gt;<a class="code" href="../../d7/d9/struct__CONSOLE__CLOSEHANDLE__MSG.html#o0">ConsoleHandle</a> = <a class="code" href="../../d6/d4/condll_8h.html#a1">GET_CONSOLE_HANDLE</a>;
00578     a-&gt;<a class="code" href="../../d7/d9/struct__CONSOLE__CLOSEHANDLE__MSG.html#o1">Handle</a> = hConsole;
00579     <a class="code" href="../../d8/d9/wow64csr_8c.html#a4">CsrClientCallServer</a>( (PCSR_API_MSG)&amp;m,
00580                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00581                          CSR_MAKE_API_NUMBER( CONSRV_SERVERDLL_INDEX,
00582                                               <a class="code" href="../../d5/d5/conmsg_8h.html#a236a197">ConsolepCloseHandle</a>
00583                                             ),
00584                          <span class="keyword">sizeof</span>( *a )
00585                        );
00586     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( m.ReturnValue )) {
00587         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00588     } <span class="keywordflow">else</span> {
00589         <a class="code" href="../../d6/d4/condll_8h.html#a3">SET_LAST_NT_ERROR</a> (m.ReturnValue);
00590         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00591     }
00592 
00593 }
00594 
00595 HANDLE
00596 <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a>
<a name="l00597"></a><a class="code" href="../../d9/d6/client_2stream_8c.html#a11">00597</a> <a class="code" href="../../d9/d6/client_2stream_8c.html#a11">DuplicateConsoleHandle</a>(
00598     IN HANDLE hSourceHandle,
00599     IN DWORD dwDesiredAccess,
00600     IN BOOL bInheritHandle,
00601     IN DWORD dwOptions
00602     )
00603 <span class="comment">/*++</span>
00604 <span class="comment">Parameters:</span>
00605 <span class="comment"></span>
00606 <span class="comment">    hSourceHandle - An open handle to the console device.</span>
00607 <span class="comment"></span>
00608 <span class="comment">    dwDesiredAccess - The access requested to for the new handle.  This</span>
00609 <span class="comment">        access must be equal to or a proper subset of the granted access</span>
00610 <span class="comment">        associated with the SourceHandle.  This parameter is ignored if</span>
00611 <span class="comment">        the DUPLICATE_SAME_ACCESS option is specified.</span>
00612 <span class="comment"></span>
00613 <span class="comment">    bInheritHandle - Supplies a flag that if TRUE, marks the target</span>
00614 <span class="comment">        handle as inheritable.  If this is the case, then the target</span>
00615 <span class="comment">        handle will be inherited to new processes each time the target</span>
00616 <span class="comment">        process creates a new process using CreateProcess.</span>
00617 <span class="comment"></span>
00618 <span class="comment">    dwOptions - Specifies optional behaviors for the caller.</span>
00619 <span class="comment"></span>
00620 <span class="comment">        Options Flags:</span>
00621 <span class="comment"></span>
00622 <span class="comment">        DUPLICATE_CLOSE_SOURCE - The SourceHandle will be closed by</span>
00623 <span class="comment">            this service prior to returning to the caller.  This occurs</span>
00624 <span class="comment">            regardless of any error status returned.</span>
00625 <span class="comment"></span>
00626 <span class="comment">        DUPLICATE_SAME_ACCESS - The DesiredAccess parameter is ignored</span>
00627 <span class="comment">            and instead the GrantedAccess associated with SourceHandle</span>
00628 <span class="comment">            is used as the DesiredAccess when creating the TargetHandle.</span>
00629 <span class="comment"></span>
00630 <span class="comment"></span>
00631 <span class="comment">Return Value:</span>
00632 <span class="comment"></span>
00633 <span class="comment">    Not -1 - Returns an open handle to the specified console device.</span>
00634 <span class="comment">        Subsequent access to the file is controlled by the DesiredAccess</span>
00635 <span class="comment">        parameter.</span>
00636 <span class="comment"></span>
00637 <span class="comment">    0xffffffff - The operation failed. Extended error status is available</span>
00638 <span class="comment">        using GetLastError.</span>
00639 <span class="comment">--*/</span>
00640 
00641 {
00642 
00643     <a class="code" href="../../d5/d9/struct__CONSOLE__API__MSG.html">CONSOLE_API_MSG</a> m;
00644     <a class="code" href="../../d0/d0/struct__CONSOLE__DUPHANDLE__MSG.html">PCONSOLE_DUPHANDLE_MSG</a> a = &amp;m.<a class="code" href="../../d5/d9/struct__CONSOLE__API__MSG.html#o77">u</a>.DuplicateHandle;
00645 
00646     <span class="keywordflow">if</span> (dwOptions &amp; ~<a class="code" href="../../d6/d4/condll_8h.html#a6">VALID_DUP_OPTIONS</a>) {
00647         <a class="code" href="../../d6/d4/condll_8h.html#a2">SET_LAST_ERROR</a>(ERROR_INVALID_PARAMETER);
00648         <span class="keywordflow">return</span> (HANDLE) <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>;
00649     }
00650     <span class="keywordflow">if</span> (((dwOptions &amp; DUPLICATE_SAME_ACCESS) == 0) &amp;&amp;
00651          (dwDesiredAccess &amp; ~<a class="code" href="../../d6/d4/condll_8h.html#a4">VALID_ACCESSES</a>)) {
00652         <a class="code" href="../../d6/d4/condll_8h.html#a2">SET_LAST_ERROR</a>(ERROR_INVALID_PARAMETER);
00653         <span class="keywordflow">return</span> (HANDLE) <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>;
00654     }
00655 
00656     a-&gt;<a class="code" href="../../d0/d0/struct__CONSOLE__DUPHANDLE__MSG.html#o0">ConsoleHandle</a> = <a class="code" href="../../d6/d4/condll_8h.html#a1">GET_CONSOLE_HANDLE</a>;
00657     a-&gt;<a class="code" href="../../d0/d0/struct__CONSOLE__DUPHANDLE__MSG.html#o1">SourceHandle</a> = hSourceHandle;
00658     a-&gt;<a class="code" href="../../d0/d0/struct__CONSOLE__DUPHANDLE__MSG.html#o2">DesiredAccess</a> = dwDesiredAccess;
00659     a-&gt;<a class="code" href="../../d0/d0/struct__CONSOLE__DUPHANDLE__MSG.html#o3">InheritHandle</a> = (BOOLEAN) bInheritHandle;
00660     a-&gt;<a class="code" href="../../d0/d0/struct__CONSOLE__DUPHANDLE__MSG.html#o4">Options</a> = dwOptions;
00661     <a class="code" href="../../d8/d9/wow64csr_8c.html#a4">CsrClientCallServer</a>( (PCSR_API_MSG)&amp;m,
00662                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00663                          CSR_MAKE_API_NUMBER( CONSRV_SERVERDLL_INDEX,
00664                                               <a class="code" href="../../d5/d5/conmsg_8h.html#a236a194">ConsolepDupHandle</a>
00665                                             ),
00666                          <span class="keyword">sizeof</span>( *a )
00667                        );
00668     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( m.ReturnValue )) {
00669         <span class="keywordflow">return</span> a-&gt;TargetHandle;
00670     } <span class="keywordflow">else</span> {
00671         <a class="code" href="../../d6/d4/condll_8h.html#a3">SET_LAST_NT_ERROR</a> (m.ReturnValue);
00672         <span class="keywordflow">return</span> (HANDLE) <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>;
00673     }
00674 
00675 }
00676 
00677 
00678 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00679 <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a>
<a name="l00680"></a><a class="code" href="../../d9/d6/client_2stream_8c.html#a12">00680</a> <a class="code" href="../../d9/d6/client_2stream_8c.html#a12">GetConsoleHandleInformation</a>(
00681     IN HANDLE hObject,
00682     OUT LPDWORD lpdwFlags
00683     )
00684 
00685 <span class="comment">/*++</span>
00686 <span class="comment">Parameters:</span>
00687 <span class="comment"></span>
00688 <span class="comment">    hObject - An open handle to console input or output.</span>
00689 <span class="comment"></span>
00690 <span class="comment">    lpdwFlags - Receives flags for console object.</span>
00691 <span class="comment"></span>
00692 <span class="comment">Return Value:</span>
00693 <span class="comment"></span>
00694 <span class="comment">    TRUE - The operation was successful.</span>
00695 <span class="comment"></span>
00696 <span class="comment">    FALSE/NULL - The operation failed. Extended error status is available</span>
00697 <span class="comment">        using GetLastError.</span>
00698 <span class="comment"></span>
00699 <span class="comment">--*/</span>
00700 
00701 {
00702 
00703     <a class="code" href="../../d5/d9/struct__CONSOLE__API__MSG.html">CONSOLE_API_MSG</a> m;
00704     <a class="code" href="../../d0/d2/struct__CONSOLE__GETHANDLEINFORMATION__MSG.html">PCONSOLE_GETHANDLEINFORMATION_MSG</a> a = &amp;m.<a class="code" href="../../d5/d9/struct__CONSOLE__API__MSG.html#o77">u</a>.GetHandleInformation;
00705 
00706     a-&gt;<a class="code" href="../../d0/d2/struct__CONSOLE__GETHANDLEINFORMATION__MSG.html#o0">ConsoleHandle</a> = <a class="code" href="../../d6/d4/condll_8h.html#a1">GET_CONSOLE_HANDLE</a>;
00707     a-&gt;<a class="code" href="../../d0/d2/struct__CONSOLE__GETHANDLEINFORMATION__MSG.html#o1">Handle</a> = hObject;
00708 
00709     <a class="code" href="../../d8/d9/wow64csr_8c.html#a4">CsrClientCallServer</a>( (PCSR_API_MSG)&amp;m,
00710                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00711                          CSR_MAKE_API_NUMBER( CONSRV_SERVERDLL_INDEX,
00712                                               <a class="code" href="../../d5/d5/conmsg_8h.html#a236a195">ConsolepGetHandleInformation</a>
00713                                             ),
00714                          <span class="keyword">sizeof</span>( *a )
00715                        );
00716     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( m.ReturnValue )) {
00717         <span class="keywordflow">try</span> {
00718            *lpdwFlags = a-&gt;Flags;
00719         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00720             <a class="code" href="../../d6/d4/condll_8h.html#a2">SET_LAST_ERROR</a>(ERROR_INVALID_ACCESS);
00721             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00722         }
00723         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00724     } <span class="keywordflow">else</span> {
00725         <a class="code" href="../../d6/d4/condll_8h.html#a3">SET_LAST_NT_ERROR</a> (m.ReturnValue);
00726         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00727     }
00728 
00729 }
00730 
00731 
00732 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00733 <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a>
<a name="l00734"></a><a class="code" href="../../d9/d6/client_2stream_8c.html#a13">00734</a> <a class="code" href="../../d9/d6/client_2stream_8c.html#a13">SetConsoleHandleInformation</a>(
00735     IN HANDLE hObject,
00736     IN DWORD dwMask,
00737     IN DWORD dwFlags
00738     )
00739 
00740 <span class="comment">/*++</span>
00741 <span class="comment">Parameters:</span>
00742 <span class="comment"></span>
00743 <span class="comment">    hObject - An open handle to console input or output.</span>
00744 <span class="comment"></span>
00745 <span class="comment">    dwMask - Flags to change.</span>
00746 <span class="comment"></span>
00747 <span class="comment">    dwFlags - New values for flags.</span>
00748 <span class="comment"></span>
00749 <span class="comment">Return Value:</span>
00750 <span class="comment"></span>
00751 <span class="comment">    TRUE - The operation was successful.</span>
00752 <span class="comment"></span>
00753 <span class="comment">    FALSE/NULL - The operation failed. Extended error status is available</span>
00754 <span class="comment">        using GetLastError.</span>
00755 <span class="comment"></span>
00756 <span class="comment">--*/</span>
00757 
00758 {
00759 
00760     <a class="code" href="../../d5/d9/struct__CONSOLE__API__MSG.html">CONSOLE_API_MSG</a> m;
00761     <a class="code" href="../../d7/d5/struct__CONSOLE__SETHANDLEINFORMATION__MSG.html">PCONSOLE_SETHANDLEINFORMATION_MSG</a> a = &amp;m.<a class="code" href="../../d5/d9/struct__CONSOLE__API__MSG.html#o77">u</a>.SetHandleInformation;
00762 
00763     a-&gt;<a class="code" href="../../d7/d5/struct__CONSOLE__SETHANDLEINFORMATION__MSG.html#o0">ConsoleHandle</a> = <a class="code" href="../../d6/d4/condll_8h.html#a1">GET_CONSOLE_HANDLE</a>;
00764     a-&gt;<a class="code" href="../../d7/d5/struct__CONSOLE__SETHANDLEINFORMATION__MSG.html#o1">Handle</a> = hObject;
00765     a-&gt;<a class="code" href="../../d7/d5/struct__CONSOLE__SETHANDLEINFORMATION__MSG.html#o2">Mask</a> = dwMask;
00766     a-&gt;<a class="code" href="../../d7/d5/struct__CONSOLE__SETHANDLEINFORMATION__MSG.html#o3">Flags</a> = <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;
00767 
00768     <a class="code" href="../../d8/d9/wow64csr_8c.html#a4">CsrClientCallServer</a>( (PCSR_API_MSG)&amp;m,
00769                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00770                          CSR_MAKE_API_NUMBER( CONSRV_SERVERDLL_INDEX,
00771                                               <a class="code" href="../../d5/d5/conmsg_8h.html#a236a196">ConsolepSetHandleInformation</a>
00772                                             ),
00773                          <span class="keyword">sizeof</span>( *a )
00774                        );
00775     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( m.ReturnValue )) {
00776         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00777     } <span class="keywordflow">else</span> {
00778         <a class="code" href="../../d6/d4/condll_8h.html#a3">SET_LAST_NT_ERROR</a> (m.ReturnValue);
00779         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00780     }
00781 
00782 }
00783 
00784 
00785 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00786 <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a>
<a name="l00787"></a><a class="code" href="../../d9/d6/client_2stream_8c.html#a14">00787</a> <a class="code" href="../../d9/d6/client_2stream_8c.html#a14">VerifyConsoleIoHandle</a>(
00788     IN HANDLE hIoHandle
00789     )
00790 
00791 <span class="comment">/*++</span>
00792 <span class="comment">Parameters:</span>
00793 <span class="comment"></span>
00794 <span class="comment">    hIoHandle - Handle to verify</span>
00795 <span class="comment"></span>
00796 <span class="comment">Return Value:</span>
00797 <span class="comment"></span>
00798 <span class="comment">    TRUE - handle is a valid console handle.</span>
00799 <span class="comment"></span>
00800 <span class="comment">    FALSE - handle is not a valid console handle.</span>
00801 <span class="comment"></span>
00802 <span class="comment">--*/</span>
00803 
00804 {
00805 
00806     <a class="code" href="../../d5/d9/struct__CONSOLE__API__MSG.html">CONSOLE_API_MSG</a> m;
00807     <a class="code" href="../../d3/d7/struct__CONSOLE__VERIFYIOHANDLE__MSG.html">PCONSOLE_VERIFYIOHANDLE_MSG</a> a = &amp;m.<a class="code" href="../../d5/d9/struct__CONSOLE__API__MSG.html#o77">u</a>.VerifyConsoleIoHandle;
00808 
00809     a-&gt;<a class="code" href="../../d3/d7/struct__CONSOLE__VERIFYIOHANDLE__MSG.html#o1">ConsoleHandle</a> = <a class="code" href="../../d6/d4/condll_8h.html#a1">GET_CONSOLE_HANDLE</a>;
00810     a-&gt;<a class="code" href="../../d3/d7/struct__CONSOLE__VERIFYIOHANDLE__MSG.html#o2">Handle</a> = hIoHandle;
00811 
00812     <span class="comment">//</span>
00813     <span class="comment">// If this process doesn't have a console handle, bail immediately.</span>
00814     <span class="comment">//</span>
00815 
00816     <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d3/d7/struct__CONSOLE__VERIFYIOHANDLE__MSG.html#o1">ConsoleHandle</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00817         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00818     }
00819 
00820     <a class="code" href="../../d8/d9/wow64csr_8c.html#a4">CsrClientCallServer</a>( (PCSR_API_MSG)&amp;m,
00821                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00822                          CSR_MAKE_API_NUMBER( CONSRV_SERVERDLL_INDEX,
00823                                               <a class="code" href="../../d5/d5/conmsg_8h.html#a236a198">ConsolepVerifyIoHandle</a>
00824                                             ),
00825                          <span class="keyword">sizeof</span>( *a )
00826                        );
00827     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( m.ReturnValue )) {
00828         <span class="keywordflow">return</span> a-&gt;Valid;
00829     } <span class="keywordflow">else</span> {
00830         <a class="code" href="../../d6/d4/condll_8h.html#a3">SET_LAST_NT_ERROR</a> (m.ReturnValue);
00831         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00832     }
00833 
00834 
00835 }
00836 
00837 <span class="preprocessor">#endif </span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:53 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
