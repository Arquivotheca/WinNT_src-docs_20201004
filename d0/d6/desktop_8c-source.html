<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: desktop.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>desktop.c</h1><a href="../../d9/d6/desktop_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/***************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: desktop.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains everything related to the desktop support.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 23-Oct-1990 DarrinM   Created.</span>
00010 <span class="comment">* 01-Feb-1991 JimA      Added new API stubs.</span>
00011 <span class="comment">* 11-Feb-1991 JimA      Added access checks.</span>
00012 <span class="comment">\***************************************************************************/</span>
00013 
00014 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00015 <span class="preprocessor">#pragma hdrstop</span>
00016 <span class="preprocessor"></span>
<a name="l00017"></a><a class="code" href="../../d9/d2/struct__DESKTOP__CONTEXT.html">00017</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/d2/struct__DESKTOP__CONTEXT.html">_DESKTOP_CONTEXT</a> {
<a name="l00018"></a><a class="code" href="../../d9/d2/struct__DESKTOP__CONTEXT.html#o0">00018</a>     PUNICODE_STRING <a class="code" href="../../d9/d2/struct__DESKTOP__CONTEXT.html#o0">pstrDevice</a>;
<a name="l00019"></a><a class="code" href="../../d9/d2/struct__DESKTOP__CONTEXT.html#o1">00019</a>     LPDEVMODE       <a class="code" href="../../d9/d2/struct__DESKTOP__CONTEXT.html#o1">lpDevMode</a>;
<a name="l00020"></a><a class="code" href="../../d9/d2/struct__DESKTOP__CONTEXT.html#o2">00020</a>     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>           <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;
00021 } <a class="code" href="../../d9/d2/struct__DESKTOP__CONTEXT.html">DESKTOP_CONTEXT</a>, *<a class="code" href="../../d9/d2/struct__DESKTOP__CONTEXT.html">PDESKTOP_CONTEXT</a>;
00022 
<a name="l00023"></a><a class="code" href="../../d9/d6/desktop_8c.html#a3">00023</a> <span class="keyword">extern</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d6/desktop_8c.html#a3">fGdiEnabled</a>;
00024 
00025 <span class="comment">/*</span>
00026 <span class="comment"> * We use these to protect a handle we're currently using from being closed.</span>
00027 <span class="comment"> */</span>
<a name="l00028"></a><a class="code" href="../../d9/d6/desktop_8c.html#a4">00028</a> <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> <a class="code" href="../../d9/d6/desktop_8c.html#a4">gProcessInUse</a>;
<a name="l00029"></a><a class="code" href="../../d9/d6/desktop_8c.html#a5">00029</a> HANDLE <a class="code" href="../../d9/d6/desktop_8c.html#a5">gHandleInUse</a>;
00030 
00031 <span class="comment">/*</span>
00032 <span class="comment"> * Debug Related Info.</span>
00033 <span class="comment"> */</span>
00034 <span class="preprocessor">#if DBG</span>
00035 <span class="preprocessor"></span><a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> gDesktopsBusy;     <span class="comment">// diagnostic</span>
00036 <span class="preprocessor">#endif</span>
00037 <span class="preprocessor"></span>
00038 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d6/desktop_8c.html#a6">FreeView</a>(
00039     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00040     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk);
00041 
00042 <span class="preprocessor">#ifdef POOL_INSTR</span>
00043 <span class="preprocessor"></span>    <span class="keyword">extern</span> <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>* gpAllocFastMutex;   <span class="comment">// mutex to syncronize pool allocations</span>
00044 <span class="preprocessor">#endif // POOL_INSTR</span>
00045 <span class="preprocessor"></span>
00046 
<a name="l00047"></a><a class="code" href="../../d4/d1/userk_8h.html#a1020">00047</a> PVOID <a class="code" href="../../d4/d1/userk_8h.html#a1020">DesktopAlloc</a>(
00048     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk,
00049     UINT     uSize,
00050     DWORD    tag)
00051 {
00052     <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a287">DF_DESTROYED</a>) {
00053         RIPMSG2(RIP_ERROR,
00054                 <span class="stringliteral">"DesktopAlloc: tag %d pdesk %#p is destroyed"</span>,
00055                 tag,
00056                 pdesk);
00057         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00058     }
00059 
00060     <span class="keywordflow">return</span> Win32HeapAlloc(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o16">pheapDesktop</a>, uSize, tag, 0);
00061 }
00062 
00063 <span class="preprocessor">#if DBG</span>
00064 <span class="preprocessor"></span>
00065 WCHAR s_strName[64];
00066 WCHAR s_strNameNull[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"null"</span>;
00067 
00068 <span class="comment">/***************************************************************************\</span>
00069 <span class="comment">* GetDesktopName</span>
00070 <span class="comment">*</span>
00071 <span class="comment">* This is for debug purposes.</span>
00072 <span class="comment">*</span>
00073 <span class="comment">* Dec-10-1997 CLUPU     Created.</span>
00074 <span class="comment">\***************************************************************************/</span>
00075 PWCHAR GetDesktopName(
00076     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk)
00077 {
00078     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>           pHead;
00079     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> pNameInfo;
00080 
00081     <span class="keywordflow">if</span> (pdesk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00082         <span class="keywordflow">return</span> s_strNameNull;
00083     }
00084     pHead = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pdesk);
00085     pNameInfo = (<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a>)((<span class="keywordtype">char</span>*)pHead - pHead-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o4">NameInfoOffset</a>);
00086 
00087     UserAssert(pNameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Length &lt; <span class="keyword">sizeof</span>(s_strName));
00088 
00089     RtlCopyMemory(s_strName, pNameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer, pNameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Length);
00090     s_strName[pNameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Length / <span class="keyword">sizeof</span>(WCHAR)] = 0;
00091 
00092     <span class="keywordflow">return</span> s_strName;
00093 }
00094 
00095 <span class="preprocessor">#endif // DBG</span>
00096 <span class="preprocessor"></span>
00097 <span class="comment">/***************************************************************************\</span>
00098 <span class="comment">* xxxDesktopThread</span>
00099 <span class="comment">*</span>
00100 <span class="comment">* This thread owns all desktops windows on a windowstation.</span>
00101 <span class="comment">* While waiting for messages, it moves the mouse cursor without entering the</span>
00102 <span class="comment">* USER critical section.  The RIT does the rest of the mouse input processing.</span>
00103 <span class="comment">*</span>
00104 <span class="comment">* History:</span>
00105 <span class="comment">* 03-Dec-1993 JimA      Created.</span>
00106 <span class="comment">\***************************************************************************/</span>
00107 
00108 <span class="preprocessor">#ifdef LOCK_MOUSE_CODE</span>
00109 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(MOUSE, xxxDesktopThread)</span>
00110 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00111 <span class="preprocessor"></span>
<a name="l00112"></a><a class="code" href="../../d9/d6/desktop_8c.html#a0">00112</a> <span class="preprocessor">#define OBJECTS_COUNT 4</span>
00113 <span class="preprocessor"></span>
<a name="l00114"></a><a class="code" href="../../d4/d1/userk_8h.html#a1191">00114</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1191">xxxDesktopThread</a>(
00115     <a class="code" href="../../d1/d8/structtagTERMINAL.html">PTERMINAL</a> pTerm)
00116 {
00117     KPRIORITY       Priority;
00118     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>     ptiCurrent;
00119     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a>              pqOriginal;
00120     UNICODE_STRING  strThreadName;
00121     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>         *apRITEvents;
00122     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>         pEvent;
00123     <a class="code" href="../../d4/d1/userk_8h.html#a920">MSGWAITCALLBACK</a> pfnHidChangeRoutine = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00124     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>           nEvents = 0;
00125     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>            idMouseInput;
00126     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>            idDesktopDestroy;
00127     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>            idPumpMessages;
00128     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>            idHungThread;
00129     <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">PKWAIT_BLOCK</a>    WaitBlockArray;
00130 
00131     UserAssert(pTerm != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00132 
00133     <span class="comment">/*</span>
00134 <span class="comment">     * Set the desktop thread's priority to low realtime.</span>
00135 <span class="comment">     */</span>
00136     Priority = LOW_REALTIME_PRIORITY;
00137     ZwSetInformationThread(NtCurrentThread(),
00138                            ThreadPriority,
00139                            &amp;Priority,
00140                            <span class="keyword">sizeof</span>(KPRIORITY));
00141 
00142     <span class="comment">/*</span>
00143 <span class="comment">     * There are just two TERMINAL structures. One is for the</span>
00144 <span class="comment">     * interactive windowstation and the other is for all the</span>
00145 <span class="comment">     * non-interactive windowstations.</span>
00146 <span class="comment">     */</span>
00147     <span class="keywordflow">if</span> (pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o0">dwTERMF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a201">TERMF_NOIO</a>) {
00148         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strThreadName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"NOIO_DT"</span>);
00149     } <span class="keywordflow">else</span> {
00150         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strThreadName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"IO_DT"</span>);
00151     }
00152 
00153     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d4/d1/userk_8h.html#a964">InitSystemThread</a>(&amp;strThreadName))) {
00154         pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o0">dwTERMF_Flags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a204">TERMF_DTINITFAILED</a>;
00155         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o4">pEventTermInit</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00156         RIPMSG0(RIP_ERROR, <span class="stringliteral">"Fail to create the desktop thread"</span>);
00157         <span class="keywordflow">return</span>;
00158     }
00159 
00160     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>();
00161 
00162     pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a> = ptiCurrent;
00163     pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o3">pqDesktop</a>  = pqOriginal = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>;
00164 
00165     (pqOriginal-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o23">cLockCount</a>)++;
00166     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o7">pDeskInfo</a> = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a276">diStatic</a>;
00167 
00168     <span class="comment">/*</span>
00169 <span class="comment">     * Set the winsta to NULL. It will be set to the right</span>
00170 <span class="comment">     * windowstation in xxxCreateDesktop before pEventInputReady</span>
00171 <span class="comment">     * is set.</span>
00172 <span class="comment">     */</span>
00173     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o23">pwinsta</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00174 
00175     <span class="comment">/*</span>
00176 <span class="comment">     * Allocate non-paged array.  Include an extra entry for</span>
00177 <span class="comment">     * the thread's input event.</span>
00178 <span class="comment">     */</span>
00179     apRITEvents = UserAllocPoolNonPaged((<a class="code" href="../../d9/d6/desktop_8c.html#a0">OBJECTS_COUNT</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>)),
00180                                         TAG_SYSTEM);
00181 
00182     <span class="keywordflow">if</span> (apRITEvents == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00183         pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o0">dwTERMF_Flags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a204">TERMF_DTINITFAILED</a>;
00184         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o4">pEventTermInit</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00185         <span class="keywordflow">return</span>;
00186     }
00187 
00188     WaitBlockArray = UserAllocPoolNonPaged((<a class="code" href="../../d9/d6/desktop_8c.html#a0">OBJECTS_COUNT</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">KWAIT_BLOCK</a>)),
00189                                            TAG_SYSTEM);
00190     <span class="keywordflow">if</span> (WaitBlockArray == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00191         pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o0">dwTERMF_Flags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a204">TERMF_DTINITFAILED</a>;
00192         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o4">pEventTermInit</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00193         UserFreePool(apRITEvents);
00194         <span class="keywordflow">return</span>;
00195     }
00196 
00197     idMouseInput     = 0xFFFF;
00198     idDesktopDestroy = 0xFFFF;
00199     idHungThread     = 0xFFFF;
00200 
00201     <span class="comment">/*</span>
00202 <span class="comment">     * Reference the mouse input event.  The system terminal doesn't</span>
00203 <span class="comment">     * wait for any mouse input.</span>
00204 <span class="comment">     */</span>
00205     <span class="keywordflow">if</span> (!(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o0">dwTERMF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a201">TERMF_NOIO</a>)) {
00206         pfnHidChangeRoutine = (<a class="code" href="../../d4/d1/userk_8h.html#a920">MSGWAITCALLBACK</a>)<a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a28">ProcessDeviceChanges</a>;
00207         idMouseInput  = nEvents++;
00208         UserAssert(<a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a2">aDeviceTemplate</a>[<a class="code" href="../../d4/d1/userk_8h.html#a175">DEVICE_TYPE_MOUSE</a>].pkeHidChange);
00209         apRITEvents[idMouseInput] = <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a2">aDeviceTemplate</a>[<a class="code" href="../../d4/d1/userk_8h.html#a175">DEVICE_TYPE_MOUSE</a>].<a class="code" href="../../d4/d3/structtagDEVICE__TEMPLATE.html#o12">pkeHidChange</a>;
00210     }
00211 
00212     <span class="comment">/*</span>
00213 <span class="comment">     * Create the desktop destruction event.</span>
00214 <span class="comment">     */</span>
00215     idDesktopDestroy = nEvents++;
00216     apRITEvents[idDesktopDestroy] = <a class="code" href="../../d4/d1/userk_8h.html#a965">CreateKernelEvent</a>(SynchronizationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00217     <span class="keywordflow">if</span> (apRITEvents[idDesktopDestroy] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00218         pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o0">dwTERMF_Flags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a204">TERMF_DTINITFAILED</a>;
00219         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o4">pEventTermInit</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00220         UserFreePool(apRITEvents);
00221         UserFreePool(WaitBlockArray);
00222         <span class="keywordflow">return</span>;
00223     }
00224     pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o5">pEventDestroyDesktop</a> = apRITEvents[idDesktopDestroy];
00225 
00226     <span class="comment">/*</span>
00227 <span class="comment">     * Hung thread not needed for noninteractive windowstations.</span>
00228 <span class="comment">     */</span>
00229     <span class="keywordflow">if</span> (!(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o0">dwTERMF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a201">TERMF_NOIO</a>)) {
00230         idHungThread = nEvents++;
00231         apRITEvents[idHungThread] = <a class="code" href="../../d4/d1/userk_8h.html#a965">CreateKernelEvent</a>(SynchronizationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00232         <span class="keywordflow">if</span> (apRITEvents[idHungThread] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00233             pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o0">dwTERMF_Flags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a204">TERMF_DTINITFAILED</a>;
00234             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o4">pEventTermInit</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00235             <a class="code" href="../../d4/d1/userk_8h.html#a967">FreeKernelEvent</a>(&amp;apRITEvents[idDesktopDestroy]);
00236             UserFreePool(apRITEvents);
00237             UserFreePool(WaitBlockArray);
00238             <span class="keywordflow">return</span>;
00239         }
00240 
00241         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a18">gpEventHungThread</a> = apRITEvents[idHungThread];
00242     }
00243 
00244     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00245     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
00246 
00247     <span class="comment">/*</span>
00248 <span class="comment">     * Set the event that tells the initialization of desktop</span>
00249 <span class="comment">     * thread is done.</span>
00250 <span class="comment">     */</span>
00251     pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o0">dwTERMF_Flags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a203">TERMF_DTINITSUCCESS</a>;
00252     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o4">pEventTermInit</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00253 
00254     <span class="comment">/*</span>
00255 <span class="comment">     * Prepare to wait on input ready event.</span>
00256 <span class="comment">     */</span>
00257     pEvent = pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o7">pEventInputReady</a>;
00258     <a class="code" href="../../d7/d1/obref_8c.html#a6">ObReferenceObjectByPointer</a>(pEvent,
00259                                EVENT_ALL_ACCESS,
00260                                *<a class="code" href="../../d7/d7/ntapi_8c.html#a3">ExEventObjectType</a>,
00261                                <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>);
00262 
00263     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00264 
00265     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(pEvent, <a class="code" href="../../d4/d9/ke_8h.html#a407a211">WrUserRequest</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00266     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pEvent);
00267 
00268     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00269 
00270     <span class="comment">/*</span>
00271 <span class="comment">     * Adjust the event ids</span>
00272 <span class="comment">     */</span>
00273     idMouseInput     += WAIT_OBJECT_0;
00274     idDesktopDestroy += WAIT_OBJECT_0;
00275     idHungThread     += WAIT_OBJECT_0;
00276     idPumpMessages    = WAIT_OBJECT_0 + nEvents;
00277 
00278     <span class="comment">/*</span>
00279 <span class="comment">     * message loop lasts until we get a WM_QUIT message</span>
00280 <span class="comment">     * upon which we shall return from the function</span>
00281 <span class="comment">     */</span>
00282     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00283         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> result;
00284 
00285         <span class="comment">/*</span>
00286 <span class="comment">         * Wait for any message sent or posted to this queue, while calling</span>
00287 <span class="comment">         * ProcessDeviceChanges whenever the mouse change event (pkeHidChange)</span>
00288 <span class="comment">         * is set.</span>
00289 <span class="comment">         */</span>
00290         result = <a class="code" href="../../d4/d1/userk_8h.html#a1649">xxxMsgWaitForMultipleObjects</a>(nEvents,
00291                                               apRITEvents,
00292                                               pfnHidChangeRoutine,
00293                                               WaitBlockArray);
00294 
00295 <span class="preprocessor">#if DBG</span>
00296 <span class="preprocessor"></span>        gDesktopsBusy++; <span class="comment">// diagnostic</span>
00297         <span class="keywordflow">if</span> (gDesktopsBusy &gt;= 2) {
00298             RIPMSG0(RIP_WARNING, <span class="stringliteral">"2 or more desktop threads busy"</span>);
00299         }
00300 <span class="preprocessor">#endif</span>
00301 <span class="preprocessor"></span>
00302         <span class="comment">/*</span>
00303 <span class="comment">         * result tells us the type of event we have:</span>
00304 <span class="comment">         * a message or a signalled handle</span>
00305 <span class="comment">         *</span>
00306 <span class="comment">         * if there are one or more messages in the queue ...</span>
00307 <span class="comment">         */</span>
00308         <span class="keywordflow">if</span> (result == (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)idPumpMessages) {
00309 
00310             <span class="comment">/*</span>
00311 <span class="comment">             * block-local variable</span>
00312 <span class="comment">             */</span>
00313             MSG <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> ;
00314 
00315             <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00316 
00317             <span class="comment">/*</span>
00318 <span class="comment">             * read all of the messages in this next loop</span>
00319 <span class="comment">             * removing each message as we read it</span>
00320 <span class="comment">             */</span>
00321             <span class="keywordflow">while</span> (<a class="code" href="../../d4/d1/userk_8h.html#a576">xxxPeekMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0, PM_REMOVE)) {
00322 
00323                 <span class="comment">/*</span>
00324 <span class="comment">                 * if it's a quit message we're out of here</span>
00325 <span class="comment">                 */</span>
00326                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == WM_QUIT &amp;&amp; ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o49">cWindows</a> == 1) {
00327 
00328                     <a class="code" href="../../d4/d1/userk_8h.html#a778">TRACE_DESKTOP</a>((<span class="stringliteral">"WM_QUIT: Destroying the desktop thread. cWindows %d\n"</span>,
00329                                    ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o49">cWindows</a>));
00330 
00331                     <span class="comment">/*</span>
00332 <span class="comment">                     * The window station is gone, so</span>
00333 <span class="comment">                     *</span>
00334 <span class="comment">                     *      DON'T USE PWINSTA ANYMORE</span>
00335 <span class="comment">                     */</span>
00336 
00337                     <span class="comment">/*</span>
00338 <span class="comment">                     * We could have received a mouse message in between the</span>
00339 <span class="comment">                     * desktop destroy event and the WM_QUIT message in which</span>
00340 <span class="comment">                     * case we may need to clear spwndTrack again to make sure</span>
00341 <span class="comment">                     * that a window (gotta be the desktop) isn't locked in.</span>
00342 <span class="comment">                     */</span>
00343                     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o21">spwndTrack</a>);
00344 
00345                     <span class="comment">/*</span>
00346 <span class="comment">                     * If we're running on the last interactive desktop,</span>
00347 <span class="comment">                     *  then we never unlocked pdesk-&gt;pDeskInfo-&gt;spwnd.</span>
00348 <span class="comment">                     * However, it seems to me that the system stops</span>
00349 <span class="comment">                     *  running before we make it here; otherwise, (or</span>
00350 <span class="comment">                     *  for a Hydra-like thing) we need to unlock that</span>
00351 <span class="comment">                     *  window here.....</span>
00352 <span class="comment">                     */</span>
00353                     UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00354                                ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00355                                ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00356 
00357                     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>);
00358 
00359                     <span class="comment">/*</span>
00360 <span class="comment">                     * Because there is no desktop, we need to fake a</span>
00361 <span class="comment">                     * desktop info structure so that the IsHooked()</span>
00362 <span class="comment">                     * macro can test a "valid" fsHooks value.</span>
00363 <span class="comment">                     */</span>
00364                     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o7">pDeskInfo</a> = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a276">diStatic</a>;
00365 
00366                     <span class="comment">/*</span>
00367 <span class="comment">                     * The desktop window is all that's left, so</span>
00368 <span class="comment">                     * let's exit.  The thread cleanup code will</span>
00369 <span class="comment">                     * handle destruction of the window.</span>
00370 <span class="comment">                     */</span>
00371 
00372                     <span class="comment">/*</span>
00373 <span class="comment">                     * If the thread is not using the original queue,</span>
00374 <span class="comment">                     * destroy it.</span>
00375 <span class="comment">                     */</span>
00376                     UserAssert(pqOriginal-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o23">cLockCount</a>);
00377                     (pqOriginal-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o23">cLockCount</a>)--;
00378                     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> != pqOriginal) {
00379                         <a class="code" href="../../d4/d1/userk_8h.html#a1209">zzzDestroyQueue</a>(pqOriginal, ptiCurrent); <span class="comment">// DeferWinEventNotify() ?? IANJA ??</span>
00380                     }
00381 
00382 <span class="preprocessor">#if DBG</span>
00383 <span class="preprocessor"></span>                    gDesktopsBusy--; <span class="comment">// diagnostic</span>
00384 <span class="preprocessor">#endif</span>
00385 <span class="preprocessor"></span>
00386                     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00387 
00388                     <span class="comment">/*</span>
00389 <span class="comment">                     * Deref the events now that we're done with them.</span>
00390 <span class="comment">                     * Also free the wait array.</span>
00391 <span class="comment">                     */</span>
00392                     <span class="keywordflow">if</span> (!(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o0">dwTERMF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a201">TERMF_NOIO</a>)) {
00393                         <a class="code" href="../../d4/d1/userk_8h.html#a967">FreeKernelEvent</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a18">gpEventHungThread</a>);
00394                     }
00395                     <a class="code" href="../../d4/d1/userk_8h.html#a967">FreeKernelEvent</a>(&amp;apRITEvents[idDesktopDestroy]);
00396                     UserFreePool(apRITEvents);
00397                     UserFreePool(WaitBlockArray);
00398 
00399                     <span class="comment">/*</span>
00400 <span class="comment">                     * Terminate the thread.  This will call the</span>
00401 <span class="comment">                     * Win32k thread cleanup code.</span>
00402 <span class="comment">                     */</span>
00403                     <a class="code" href="../../d4/d1/userk_8h.html#a778">TRACE_DESKTOP</a>((<span class="stringliteral">"call PsTerminateSystemThread\n"</span>));
00404 
00405                     pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00406                     pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o3">pqDesktop</a>  = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00407 
00408                     pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o0">dwTERMF_Flags</a> &amp;= <a class="code" href="../../d4/d1/userk_8h.html#a205">TERMF_DTDESTROYED</a>;
00409 
00410                     <a class="code" href="../../d8/d0/psdelete_8c.html#a7">PsTerminateSystemThread</a>(0);
00411                 }
00412 
00413                 UserAssert(<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message != WM_QUIT);
00414 
00415                 <span class="comment">/*</span>
00416 <span class="comment">                 * otherwise dispatch it</span>
00417 <span class="comment">                 */</span>
00418                 <a class="code" href="../../d4/d1/userk_8h.html#a1640">xxxDispatchMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>);
00419 
00420             } <span class="comment">// end of PeekMessage while loop</span>
00421 
00422         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (result == idDesktopDestroy) {
00423 
00424             <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>        *ppdesk;
00425             <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>        pdesk;
00426             <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>            pwnd;
00427             <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>           pmenu;
00428             <a class="code" href="../../d5/d1/struct__TL.html">TL</a>              tlpwinsta;
00429             <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>  pwinsta;
00430             <a class="code" href="../../d5/d1/struct__TL.html">TL</a>              tlpdesk;
00431             <a class="code" href="../../d5/d1/struct__TL.html">TL</a>              tlpwnd;
00432             <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>        pdeskTemp;
00433             HDESK           hdeskTemp;
00434             <a class="code" href="../../d5/d1/struct__TL.html">TL</a>              tlpdeskTemp;
00435 
00436             <span class="comment">/*</span>
00437 <span class="comment">             * Destroy desktops on the destruction list.</span>
00438 <span class="comment">             */</span>
00439             <span class="keywordflow">for</span> (ppdesk = &amp;pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o6">rpdeskDestroy</a>; *ppdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; ) {
00440                 <span class="comment">/*</span>
00441 <span class="comment">                 * Unlink from the list.</span>
00442 <span class="comment">                 */</span>
00443                 pdesk = *ppdesk;
00444 
00445                 <a class="code" href="../../d4/d1/userk_8h.html#a778">TRACE_DESKTOP</a>((<span class="stringliteral">"Destroying desktop '%ws' %#p ...\n"</span>,
00446                        GetDesktopName(pdesk), pdesk));
00447 
00448                 UserAssert(!(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a285">DF_DYING</a>));
00449 
00450                 <a class="code" href="../../d4/d1/userk_8h.html#a128">ThreadLockDesktop</a>(ptiCurrent, pdesk, &amp;tlpdesk, LDLT_FN_DESKTOPTHREAD_DESK);
00451                 pwinsta = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>;
00452                 <a class="code" href="../../d4/d1/userk_8h.html#a131">ThreadLockWinSta</a>(ptiCurrent, pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>, &amp;tlpwinsta);
00453 
00454                 <a class="code" href="../../d4/d1/userk_8h.html#a126">LockDesktop</a>(ppdesk, pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o2">rpdeskNext</a>, LDL_TERM_DESKDESTROY1, (ULONG_PTR)pTerm);
00455                 <a class="code" href="../../d4/d1/userk_8h.html#a127">UnlockDesktop</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o2">rpdeskNext</a>, LDU_DESK_DESKNEXT, 0);
00456 
00457                 <span class="comment">/*</span>
00458 <span class="comment">                 * !!! If this is the current desktop, switch to another one.</span>
00459 <span class="comment">                 */</span>
00460                 <span class="keywordflow">if</span> (pdesk == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>) {
00461                     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdeskNew;
00462 
00463                     <a class="code" href="../../d4/d1/userk_8h.html#a778">TRACE_DESKTOP</a>((<span class="stringliteral">"Destroying the current active desktop\n"</span>));
00464 
00465                     <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a314">WSF_SWITCHLOCK</a>) {
00466 
00467                         <a class="code" href="../../d4/d1/userk_8h.html#a778">TRACE_DESKTOP</a>((<span class="stringliteral">"The windowstation is locked\n"</span>));
00468 
00469                         <span class="comment">/*</span>
00470 <span class="comment">                         * this should be the interactive windowstation</span>
00471 <span class="comment">                         */</span>
00472                         UserAssert(!(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>));
00473 
00474                         <span class="comment">/*</span>
00475 <span class="comment">                         * Switch to the disconnected desktop if the logon desktop</span>
00476 <span class="comment">                         * is being destroyed, or there is no logon desktop, or</span>
00477 <span class="comment">                         * if the logon desktop has already been destroyed.</span>
00478 <span class="comment">                         */</span>
00479                         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a> &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a329">gspdeskDisconnect</a> &amp;&amp;
00480                              (pdesk == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a242">grpdeskLogon</a> ||
00481                               <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a242">grpdeskLogon</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>  ||
00482                               (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a242">grpdeskLogon</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a286">DF_DESKWNDDESTROYED</a>))) {
00483                             <a class="code" href="../../d4/d1/userk_8h.html#a778">TRACE_DESKTOP</a>((<span class="stringliteral">"disable the screen and switch to the disconnect desktop\n"</span>));
00484                             <a class="code" href="../../d4/d1/userk_8h.html#a2105">RemoteDisableScreen</a>();
00485                             <span class="keywordflow">goto</span> skip;
00486 
00487                         } <span class="keywordflow">else</span> {
00488                             <a class="code" href="../../d4/d1/userk_8h.html#a778">TRACE_DESKTOP</a>((<span class="stringliteral">"Switch to the logon desktop '%ws' %#p ...\n"</span>,
00489                                    GetDesktopName(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a242">grpdeskLogon</a>), <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a242">grpdeskLogon</a>));
00490 
00491                             pdeskNew = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a242">grpdeskLogon</a>;
00492                         }
00493                     } <span class="keywordflow">else</span> {
00494                         pdeskNew = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a>;
00495                         <span class="keywordflow">if</span> (pdeskNew == pdesk)
00496                             pdeskNew = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o2">rpdeskNext</a>;
00497 
00498                         <span class="comment">/*</span>
00499 <span class="comment">                         * You can hit this assert if you exit winlogon before</span>
00500 <span class="comment">                         * logging in.  I.E. all desktop's close so there is</span>
00501 <span class="comment">                         * no "next" one to switch to.  I'm assuming that there</span>
00502 <span class="comment">                         * is a check for a NULL desktop in xxxSwitchDesktop().</span>
00503 <span class="comment">                         *</span>
00504 <span class="comment">                         * You can't switch to a NULL desktop.  But this means</span>
00505 <span class="comment">                         * there isn't any input desktop so clear it manually.</span>
00506 <span class="comment">                         */</span>
00507                         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>) {
00508                             <span class="keywordflow">if</span> (pdeskNew == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00509 
00510                                 <a class="code" href="../../d4/d1/userk_8h.html#a778">TRACE_DESKTOP</a>((<span class="stringliteral">"NO INPUT FOR DT FROM THIS POINT ON ...\n"</span>));
00511 
00512                                 <a class="code" href="../../d4/d1/userk_8h.html#a1199">ClearWakeBit</a>(ptiCurrent, QS_INPUT | QS_EVENT | QS_MOUSEMOVE, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00513                             }
00514                         } <span class="keywordflow">else</span> {
00515                             UserAssert(pdeskNew);
00516                         }
00517                     }
00518 
00519                     <a class="code" href="../../d4/d1/userk_8h.html#a778">TRACE_DESKTOP</a>((<span class="stringliteral">"Switch to desktop '%ws' %#p\n"</span>,
00520                            GetDesktopName(pdeskNew), pdeskNew));
00521 
00522                     <a class="code" href="../../d4/d1/userk_8h.html#a1798">xxxSwitchDesktop</a>(pwinsta, pdeskNew, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00523                 }
00524 skip:
00525 
00526                 <span class="comment">/*</span>
00527 <span class="comment">                 * Close the display if this desktop did not use</span>
00528 <span class="comment">                 * the global display.</span>
00529 <span class="comment">                 */</span>
00530                 <span class="keywordflow">if</span> ((pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00531                     (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>)) {
00532 
00533                     <a class="code" href="../../d4/d1/userk_8h.html#a778">TRACE_DESKTOP</a>((<span class="stringliteral">"Destroy MDEV\n"</span>));
00534 
00535                     DrvDestroyMDEV(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>);
00536                     GreFreePool(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>);
00537                     pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00538                 }
00539 
00540                 <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>) {
00541                     UserAssert(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o13">pMonitorFirst</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00542                     UserFreePool(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a>);
00543                     pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00544                 }
00545 
00546                 <span class="comment">/*</span>
00547 <span class="comment">                 * Destroy desktop and menu windows.</span>
00548 <span class="comment">                 */</span>
00549                 pdeskTemp = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>;            <span class="comment">// save current desktop</span>
00550                 hdeskTemp = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o18">hdesk</a>;
00551                 <a class="code" href="../../d4/d1/userk_8h.html#a128">ThreadLockDesktop</a>(ptiCurrent, pdeskTemp, &amp;tlpdeskTemp, LDLT_FN_DESKTOPTHREAD_DESKTEMP);
00552                 <a class="code" href="../../d4/d1/userk_8h.html#a1801">xxxSetThreadDesktop</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pdesk);
00553                 <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o11">spwndForeground</a>);
00554                 <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o12">spwndTray</a>);
00555 
00556                 <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o21">spwndTrack</a>);
00557                 pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a295">DF_MOUSEMOVETRK</a>;
00558 
00559                 <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o7">spmenuSys</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00560                     pmenu = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o7">spmenuSys</a>;
00561                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1606">UnlockDesktopSysMenu</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o7">spmenuSys</a>))
00562                         <a class="code" href="../../d4/d1/userk_8h.html#a1887">_DestroyMenu</a>(pmenu);
00563                 }
00564 
00565                 <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o8">spmenuDialogSys</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00566                     pmenu = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o8">spmenuDialogSys</a>;
00567                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1606">UnlockDesktopSysMenu</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o8">spmenuDialogSys</a>))
00568                         <a class="code" href="../../d4/d1/userk_8h.html#a1887">_DestroyMenu</a>(pmenu);
00569                 }
00570 
00571                 <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o9">spmenuHScroll</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00572                     pmenu = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o9">spmenuHScroll</a>;
00573                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1604">UnlockDesktopMenu</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o9">spmenuHScroll</a>))
00574                         <a class="code" href="../../d4/d1/userk_8h.html#a1887">_DestroyMenu</a>(pmenu);
00575                 }
00576 
00577                 <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o10">spmenuVScroll</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00578                     pmenu = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o10">spmenuVScroll</a>;
00579                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1604">UnlockDesktopMenu</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o10">spmenuVScroll</a>))
00580                         <a class="code" href="../../d4/d1/userk_8h.html#a1887">_DestroyMenu</a>(pmenu);
00581                 }
00582 
00583                 <span class="comment">/*</span>
00584 <span class="comment">                 * If this desktop doesn't have a pDeskInfo, then</span>
00585 <span class="comment">                 * something is wrong.  All desktops should have</span>
00586 <span class="comment">                 * this until the object is freed.</span>
00587 <span class="comment">                 */</span>
00588                 <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00589                     RIPMSG0(RIP_ERROR,
00590                           <span class="stringliteral">"xxxDesktopThread: There is no pDeskInfo for this desktop"</span>);
00591                 }
00592 
00593                 <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>) {
00594                     <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a15">gspwndFullScreen</a>)
00595                         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a15">gspwndFullScreen</a>);
00596 
00597                     <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o5">spwndShell</a>)
00598                         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o5">spwndShell</a>);
00599 
00600                     <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o7">spwndBkGnd</a>)
00601                         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o7">spwndBkGnd</a>);
00602 
00603                     <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o8">spwndTaskman</a>)
00604                         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o8">spwndTaskman</a>);
00605 
00606                     <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o9">spwndProgman</a>)
00607                         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o9">spwndProgman</a>);
00608                 }
00609 
00610                 UserAssert(!(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a285">DF_DYING</a>));
00611 
00612                 <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o6">spwndMenu</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00613 
00614                     pwnd = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o6">spwndMenu</a>;
00615 
00616                     <span class="comment">/*</span>
00617 <span class="comment">                     * Hide this window without activating anyone else.</span>
00618 <span class="comment">                     */</span>
00619                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) {
00620                         <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwnd, &amp;tlpwnd);
00621                         <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwnd,
00622                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00623                                         0,
00624                                         0,
00625                                         0,
00626                                         0,
00627                                         SWP_HIDEWINDOW | SWP_NOACTIVATE |
00628                                             SWP_NOMOVE | SWP_NOSIZE |
00629                                             SWP_NOZORDER | SWP_NOREDRAW |
00630                                             SWP_NOSENDCHANGING);
00631 
00632                         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
00633                     }
00634 
00635                     <span class="comment">/*</span>
00636 <span class="comment">                     * Reset the flag in the popupmenu structure that tells this</span>
00637 <span class="comment">                     * popup menu belongs to the pdesk-&gt;spwndMenu so it can go away.</span>
00638 <span class="comment">                     */</span>
00639                     ((<a class="code" href="../../d5/d1/structtagMENUWND.html">PMENUWND</a>)pwnd)-&gt;ppopupmenu-&gt;fDesktopMenu = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00640                     ((<a class="code" href="../../d5/d1/structtagMENUWND.html">PMENUWND</a>)pwnd)-&gt;ppopupmenu-&gt;fDelayedFree = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00641 <span class="preprocessor">                    #if DBG</span>
00642 <span class="preprocessor"></span>                        <span class="comment">/* We used to zero out this popup when closing the menu.</span>
00643 <span class="comment">                         * now we zero it out when about to re-use it.</span>
00644 <span class="comment">                         * So make ValidatepPopupMenu happy by clearing the</span>
00645 <span class="comment">                         * leftover ppopupmenuRoot, if any.</span>
00646 <span class="comment">                         */</span>
00647                         ((<a class="code" href="../../d5/d1/structtagMENUWND.html">PMENUWND</a>)pwnd)-&gt;ppopupmenu-&gt;ppopupmenuRoot = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00648 <span class="preprocessor">                    #endif</span>
00649 <span class="preprocessor"></span>
00650                     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o6">spwndMenu</a>)) {
00651                         <a class="code" href="../../d4/d1/userk_8h.html#a1575">xxxDestroyWindow</a>(pwnd);
00652                     }
00653                 }
00654 
00655                 <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o13">spwndMessage</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00656 
00657                     pwnd = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o13">spwndMessage</a>;
00658 
00659                     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o13">spwndMessage</a>)) {
00660                         <a class="code" href="../../d4/d1/userk_8h.html#a1575">xxxDestroyWindow</a>(pwnd);
00661                     }
00662                 }
00663 
00664                 <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o14">spwndTooltip</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00665 
00666                     pwnd = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o14">spwndTooltip</a>;
00667 
00668                     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o14">spwndTooltip</a>)) {
00669                         <a class="code" href="../../d4/d1/userk_8h.html#a1575">xxxDestroyWindow</a>(pwnd);
00670                     }
00671                     UserAssert(!(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a289">DF_TOOLTIPSHOWING</a>));
00672                 }
00673 
00674                 UserAssert(!(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a285">DF_DYING</a>));
00675 
00676                 <span class="comment">/*</span>
00677 <span class="comment">                 * If the dying desktop is the owner of the desktop</span>
00678 <span class="comment">                 * owner window, reassign it to the first available</span>
00679 <span class="comment">                 * desktop.  This is needed to ensure that</span>
00680 <span class="comment">                 * xxxSetWindowPos will work on desktop windows.</span>
00681 <span class="comment">                 */</span>
00682                 <span class="keywordflow">if</span> (pTerm-&gt;spwndDesktopOwner != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00683                     pTerm-&gt;spwndDesktopOwner-&gt;head.rpdesk == pdesk) {
00684 
00685                     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdeskR;
00686 
00687                     <span class="comment">/*</span>
00688 <span class="comment">                     * Find out to what desktop the mother desktop window</span>
00689 <span class="comment">                     * should go. Careful with the NOIO case where there</span>
00690 <span class="comment">                     * might be several windowstations using the same</span>
00691 <span class="comment">                     * mother desktop window</span>
00692 <span class="comment">                     */</span>
00693                     <span class="keywordflow">if</span> (pTerm-&gt;dwTERMF_Flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a201">TERMF_NOIO</a>) {
00694 
00695                         <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinstaW;
00696 
00697                         UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00698 
00699                         pwinstaW = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o0">rpwinstaNext</a>;
00700 
00701                         pdeskR = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00702 
00703                         <span class="keywordflow">while</span> (pwinstaW != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00704                             <span class="keywordflow">if</span> (pwinstaW-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00705                                 pdeskR = pwinstaW-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a>;
00706                                 <span class="keywordflow">break</span>;
00707                             }
00708                             pwinstaW = pwinstaW-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o0">rpwinstaNext</a>;
00709                         }
00710                     } <span class="keywordflow">else</span> {
00711                         pdeskR = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a>;
00712                     }
00713 
00714                     <span class="keywordflow">if</span> (pdeskR == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00715 
00716                         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00717 
00718                         <a class="code" href="../../d4/d1/userk_8h.html#a778">TRACE_DESKTOP</a>((<span class="stringliteral">"DESTROYING THE MOTHER DESKTOP WINDOW %#p\n"</span>,
00719                                 pTerm-&gt;spwndDesktopOwner));
00720 
00721                         pwnd = pTerm-&gt;spwndDesktopOwner;
00722 
00723                         <span class="comment">/*</span>
00724 <span class="comment">                         * Hide it first</span>
00725 <span class="comment">                         */</span>
00726                         <a class="code" href="../../d4/d1/userk_8h.html#a1626">SetVisible</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a750">SV_UNSET</a>);
00727 
00728                         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;(pTerm-&gt;spwndDesktopOwner));
00729 
00730                         <a class="code" href="../../d4/d1/userk_8h.html#a1575">xxxDestroyWindow</a>(pwnd);
00731 
00732                     } <span class="keywordflow">else</span> {
00733                         <a class="code" href="../../d4/d1/userk_8h.html#a778">TRACE_DESKTOP</a>((<span class="stringliteral">"MOVING THE MOTHER DESKTOP WINDOW %#p to pdesk %#p '%ws'\n"</span>,
00734                                 pTerm-&gt;spwndDesktopOwner, pdeskR, GetDesktopName(pdeskR)));
00735 
00736                         <a class="code" href="../../d4/d1/userk_8h.html#a126">LockDesktop</a>(&amp;(pTerm-&gt;spwndDesktopOwner-&gt;head.rpdesk),
00737                                     pdeskR, LDL_MOTHERDESK_DESK1, (ULONG_PTR)(pTerm-&gt;spwndDesktopOwner));
00738                     }
00739                 }
00740 
00741                 <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a> &amp;&amp; (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00742 
00743                     UserAssert(!(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a286">DF_DESKWNDDESTROYED</a>));
00744 
00745                     pwnd = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>;
00746 
00747                     <span class="comment">/*</span>
00748 <span class="comment">                     * Hide this window without activating anyone else.</span>
00749 <span class="comment">                     */</span>
00750                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) {
00751                         <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwnd, &amp;tlpwnd);
00752                         <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwnd,
00753                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00754                                         0,
00755                                         0,
00756                                         0,
00757                                         0,
00758                                         SWP_HIDEWINDOW | SWP_NOACTIVATE |
00759                                             SWP_NOMOVE | SWP_NOSIZE |
00760                                             SWP_NOZORDER | SWP_NOREDRAW |
00761                                             SWP_NOSENDCHANGING);
00762 
00763                         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
00764                     }
00765 
00766                     <span class="comment">/*</span>
00767 <span class="comment">                     * A lot of pwnd related code assumes that we</span>
00768 <span class="comment">                     *  always have a valid desktop window. So we call</span>
00769 <span class="comment">                     *  xxxDestroyWindow first to clean up and then</span>
00770 <span class="comment">                     *  we unlock it to free it (now or eventually).</span>
00771 <span class="comment">                     * However, if we're destroying the last destkop, then</span>
00772 <span class="comment">                     *  we don't unlock the window since we're are forced</span>
00773 <span class="comment">                     *  to continue running on that desktop.</span>
00774 <span class="comment">                     */</span>
00775 
00776                     <a class="code" href="../../d4/d1/userk_8h.html#a778">TRACE_DESKTOP</a>((<span class="stringliteral">"Destroying the desktop window\n"</span>));
00777 
00778                     <a class="code" href="../../d4/d1/userk_8h.html#a1575">xxxDestroyWindow</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>);
00779                     <span class="keywordflow">if</span> (pdesk != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>) {
00780                         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>);
00781                     } <span class="keywordflow">else</span> {
00782 
00783                         <span class="comment">/*</span>
00784 <span class="comment">                         * unlock the gspwndShouldBeForeground window</span>
00785 <span class="comment">                         */</span>
00786                         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>() &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a12">gspwndShouldBeForeground</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00787                             <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a12">gspwndShouldBeForeground</a>);
00788                         }
00789 
00790                         <span class="comment">/*</span>
00791 <span class="comment">                         * This is hit in HYDRA when the last desktop does away</span>
00792 <span class="comment">                         */</span>
00793                         RIPMSG1(RIP_WARNING, <span class="stringliteral">"xxxDesktopThread: Running on zombie desk:%#p"</span>, pdesk);
00794                     }
00795                     pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a286">DF_DESKWNDDESTROYED</a>;
00796                 }
00797 
00798                 <span class="comment">/*</span>
00799 <span class="comment">                 * Restore the previous desktop</span>
00800 <span class="comment">                 */</span>
00801                 <a class="code" href="../../d4/d1/userk_8h.html#a1801">xxxSetThreadDesktop</a>(hdeskTemp, pdeskTemp);
00802 
00803 
00804                 <a class="code" href="../../d4/d1/userk_8h.html#a130">ThreadUnlockDesktop</a>(ptiCurrent, &amp;tlpdeskTemp, LDUT_FN_DESKTOPTHREAD_DESKTEMP);
00805                 <a class="code" href="../../d4/d1/userk_8h.html#a135">ThreadUnlockWinSta</a>(ptiCurrent, &amp;tlpwinsta);
00806                 <a class="code" href="../../d4/d1/userk_8h.html#a130">ThreadUnlockDesktop</a>(ptiCurrent, &amp;tlpdesk, LDUT_FN_DESKTOPTHREAD_DESK);
00807             }
00808 
00809             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>) {
00810                 <span class="comment">/*</span>
00811 <span class="comment">                 * Wakeup ntinput thread for exit processing</span>
00812 <span class="comment">                 */</span>
00813                 <a class="code" href="../../d4/d1/userk_8h.html#a778">TRACE_DESKTOP</a>((<span class="stringliteral">"Wakeup ntinput thread for exit processing\n"</span>));
00814 
00815                 UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a346">gpevtDesktopDestroyed</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00816 
00817                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a346">gpevtDesktopDestroyed</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00818             }
00819 
00820         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (result == idHungThread) {
00821             <span class="comment">/*</span>
00822 <span class="comment">             * By using gspwndMouseOwner this code relies on this event being</span>
00823 <span class="comment">             * received before another click may occur. In the worst case we</span>
00824 <span class="comment">             * may "lose" a click and only react to the latest one.</span>
00825 <span class="comment">             */</span>
00826             <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a90">gspwndMouseOwner</a>;
00827             <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1650">FHungApp</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a912">CMSHUNGAPPTIMEOUT</a>)) {
00828 
00829                 <span class="keywordtype">int</span> ht = <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a0">FindNCHit</a>(pwnd, POINTTOPOINTS(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o3">ptLastClick</a>));
00830 
00831                 <span class="keywordflow">if</span> (ht == HTCLOSE) {
00832                     <span class="comment">/*</span>
00833 <span class="comment">                     * Note -- this is private, and does not go to the hook,</span>
00834 <span class="comment">                     *   only the posted ones from the shell.</span>
00835 <span class="comment">                     */</span>
00836 
00837                     <a class="code" href="../../d4/d1/userk_8h.html#a1867">PostShellHookMessages</a>(HSHELL_ENDTASK, (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd));
00838                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ht == HTMINBUTTON) {
00839                     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
00840 
00841                     <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwnd, &amp;tlpwnd);
00842                     <a class="code" href="../../d4/d1/userk_8h.html#a1160">xxxMinimizeHungWindow</a>(pwnd);
00843                     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
00844                 }
00845             }
00846 
00847         } <span class="keywordflow">else</span> {
00848             RIPMSG0(RIP_WARNING, <span class="stringliteral">"Desktop woke up for what?"</span>);
00849         }
00850 
00851 <span class="preprocessor">#if DBG</span>
00852 <span class="preprocessor"></span>        gDesktopsBusy--; <span class="comment">// diagnostic</span>
00853 <span class="preprocessor">#endif</span>
00854 <span class="preprocessor"></span>    }
00855 }
00856 
00857 <span class="comment">/***************************************************************************\</span>
00858 <span class="comment">* xxxRealizeDesktop</span>
00859 <span class="comment">*</span>
00860 <span class="comment">* 4/28/97   vadimg      created</span>
00861 <span class="comment">\***************************************************************************/</span>
00862 
<a name="l00863"></a><a class="code" href="../../d4/d1/userk_8h.html#a1806">00863</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1806">xxxRealizeDesktop</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00864 {
00865     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00866     UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a196">FNID_DESKTOP</a>);
00867 
00868     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a2">ghpalWallpaper</a>) {
00869         HDC hdc = <a class="code" href="../../d4/d1/userk_8h.html#a1694">_GetDC</a>(pwnd);
00870         <a class="code" href="../../d4/d1/userk_8h.html#a1444">xxxInternalPaintDesktop</a>(pwnd, hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00871         <a class="code" href="../../d4/d1/userk_8h.html#a1697">_ReleaseDC</a>(hdc);
00872     }
00873 }
00874 
00875 <span class="comment">/***************************************************************************\</span>
00876 <span class="comment">* xxxDesktopWndProc</span>
00877 <span class="comment">*</span>
00878 <span class="comment">* History:</span>
00879 <span class="comment">* 23-Oct-1990 DarrinM   Ported from Win 3.0 sources.</span>
00880 <span class="comment">* 08-Aug-1996 jparsons  51725 - added fix to prevent crash on WM_SETICON</span>
00881 <span class="comment">\***************************************************************************/</span>
00882 
<a name="l00883"></a><a class="code" href="../../d4/d1/userk_8h.html#a1483">00883</a> LRESULT <a class="code" href="../../d4/d1/userk_8h.html#a1483">xxxDesktopWndProc</a>(
00884     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>   pwnd,
00885     UINT   message,
00886     WPARAM wParam,
00887     LPARAM lParam)
00888 {
00889     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00890     HDC         hdcT;
00891     PAINTSTRUCT ps;
00892     PWINDOWPOS  pwp;
00893 
00894 
00895     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00896     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
00897 
00898     <a class="code" href="../../d6/d0/usercli_8h.html#a28">VALIDATECLASSANDSIZE</a>(pwnd, message, wParam, lParam, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a196">FNID_DESKTOP</a>, WM_CREATE);
00899 
00900 
00901     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00902         <span class="keywordflow">switch</span> (message) {
00903 
00904             <span class="keywordflow">case</span> WM_SETICON:
00905                 <span class="comment">/*</span>
00906 <span class="comment">                 * cannot allow this as it will cause a callback to user mode from the</span>
00907 <span class="comment">                 * desktop system thread.</span>
00908 <span class="comment">                 */</span>
00909                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"WM_ICON sent to desktop window was discarded.\n"</span>) ;
00910                 <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a> ;
00911 
00912             <span class="keywordflow">default</span>:
00913                 <span class="keywordflow">break</span>;
00914         } <span class="comment">/* switch */</span>
00915 
00916         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1632">xxxDefWindowProc</a>(pwnd, message, wParam, lParam);
00917     }
00918 
00919     <span class="keywordflow">switch</span> (message) {
00920 
00921     <span class="keywordflow">case</span> WM_WINDOWPOSCHANGING:
00922 
00923         <span class="comment">/*</span>
00924 <span class="comment">         * We receive this when switch desktop is called.  Just</span>
00925 <span class="comment">         * to be consistent, set the rit desktop as this</span>
00926 <span class="comment">         * thread's desktop.</span>
00927 <span class="comment">         */</span>
00928         pwp = (PWINDOWPOS)lParam;
00929         <span class="keywordflow">if</span> (!(pwp-&gt;flags &amp; SWP_NOZORDER) &amp;&amp; pwp-&gt;hwndInsertAfter == HWND_TOP) {
00930 
00931             <a class="code" href="../../d4/d1/userk_8h.html#a1801">xxxSetThreadDesktop</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>);
00932 
00933             <span class="comment">/*</span>
00934 <span class="comment">             * If some app has taken over the system-palette, we should make</span>
00935 <span class="comment">             * sure the system is restored.  Otherwise, if this is the logon</span>
00936 <span class="comment">             * desktop, we might not be able to view the dialog correctly.</span>
00937 <span class="comment">             */</span>
00938             <span class="keywordflow">if</span> (GreGetSystemPaletteUse(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o3">hdcScreen</a>) != SYSPAL_STATIC)
00939                 GreRealizeDefaultPalette(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o3">hdcScreen</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00940 
00941             <span class="comment">/*</span>
00942 <span class="comment">             * Let everyone know if the palette has changed</span>
00943 <span class="comment">             */</span>
00944             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a528">DTF_NEEDSPALETTECHANGED</a>) {
00945                 <a class="code" href="../../d4/d1/userk_8h.html#a1581">xxxSendNotifyMessage</a>(<a class="code" href="../../d4/d1/userk_8h.html#a457">PWND_BROADCAST</a>,
00946                                      WM_PALETTECHANGED,
00947                                      (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd),
00948                                      0);
00949                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a528">DTF_NEEDSPALETTECHANGED</a>;
00950             }
00951         }
00952         <span class="keywordflow">break</span>;
00953 
00954     <span class="keywordflow">case</span> WM_FULLSCREEN: {
00955             <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndT;
00956 
00957             <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>, &amp;tlpwndT);
00958             <a class="code" href="../../d4/d1/userk_8h.html#a1756">xxxMakeWindowForegroundWithState</a>(
00959                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>, GDIFULLSCREEN);
00960             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
00961 
00962             <span class="comment">/*</span>
00963 <span class="comment">             * We have to tell the switch window to repaint if we switched</span>
00964 <span class="comment">             * modes</span>
00965 <span class="comment">             */</span>
00966             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00967                 <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a>, &amp;tlpwndT);
00968                 <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a>, WM_FULLSCREEN, 0, 0);
00969                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
00970             }
00971 
00972             <span class="keywordflow">break</span>;
00973         }
00974 
00975     <span class="keywordflow">case</span> WM_CLOSE:
00976 
00977         <span class="comment">/*</span>
00978 <span class="comment">         * Make sure nobody sends this window a WM_CLOSE and causes it to</span>
00979 <span class="comment">         * destroy itself.</span>
00980 <span class="comment">         */</span>
00981         <span class="keywordflow">break</span>;
00982 
00983     <span class="keywordflow">case</span> WM_SETICON:
00984         <span class="comment">/*</span>
00985 <span class="comment">         * cannot allow this as it will cause a callback to user mode from the</span>
00986 <span class="comment">         * desktop system thread.</span>
00987 <span class="comment">         */</span>
00988         RIPMSG0(RIP_WARNING, <span class="stringliteral">"WM_ICON sent to desktop window was discarded.\n"</span>) ;
00989         <span class="keywordflow">break</span>;
00990 
00991     <span class="keywordflow">case</span> WM_CREATE: {
00992         <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlName;
00993         PUNICODE_STRING pProfileUserName = <a class="code" href="../../d4/d1/userk_8h.html#a2000">CreateProfileUserName</a>(&amp;tlName);
00994         <span class="comment">/*</span>
00995 <span class="comment">         * Is there a desktop pattern, or bitmap name in WIN.INI?</span>
00996 <span class="comment">         */</span>
00997         <a class="code" href="../../d4/d1/userk_8h.html#a1185">xxxSetDeskPattern</a>(pProfileUserName, (LPWSTR)-1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00998 
00999         <a class="code" href="../../d4/d1/userk_8h.html#a2001">FreeProfileUserName</a>(pProfileUserName, &amp;tlName);
01000         <span class="comment">/*</span>
01001 <span class="comment">         * Initialize the system colors before we show the desktop window.</span>
01002 <span class="comment">         */</span>
01003         <a class="code" href="../../d4/d1/userk_8h.html#a1581">xxxSendNotifyMessage</a>(pwnd, WM_SYSCOLORCHANGE, 0, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01004 
01005         hdcT = <a class="code" href="../../d4/d1/userk_8h.html#a1694">_GetDC</a>(pwnd);
01006         <a class="code" href="../../d4/d1/userk_8h.html#a1444">xxxInternalPaintDesktop</a>(pwnd, hdcT, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>); <span class="comment">// use "normal" HDC so SelectPalette() will work</span>
01007         <a class="code" href="../../d4/d1/userk_8h.html#a1697">_ReleaseDC</a>(hdcT);
01008 
01009         <span class="comment">/*</span>
01010 <span class="comment">         * Save process and thread ids.</span>
01011 <span class="comment">         */</span>
01012         <a class="code" href="../../d4/d1/userk_8h.html#a1432">xxxSetWindowLong</a>(pwnd,
01013                          0,
01014                          HandleToUlong(<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueProcess),
01015                          <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01016 
01017         <a class="code" href="../../d4/d1/userk_8h.html#a1432">xxxSetWindowLong</a>(pwnd,
01018                          4,
01019                          HandleToUlong(<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueThread),
01020                          <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01021         <span class="keywordflow">break</span>;
01022     }
01023     <span class="keywordflow">case</span> WM_PALETTECHANGED:
01024         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd) == (HWND)wParam)
01025             <span class="keywordflow">break</span>;
01026 
01027         <span class="comment">// FALL THROUGH</span>
01028 
01029     <span class="keywordflow">case</span> WM_QUERYNEWPALETTE:
01030         <a class="code" href="../../d4/d1/userk_8h.html#a1806">xxxRealizeDesktop</a>(pwnd);
01031         <span class="keywordflow">break</span>;
01032 
01033     <span class="keywordflow">case</span> WM_SYSCOLORCHANGE:
01034 
01035         <span class="comment">/*</span>
01036 <span class="comment">         * We do the redrawing if someone has changed the sys-colors from</span>
01037 <span class="comment">         * another desktop and we need to redraw.  This is appearent with</span>
01038 <span class="comment">         * the MATROX card which requires OGL applications to take over</span>
01039 <span class="comment">         * the entire sys-colors for drawing.  When switching desktops, we</span>
01040 <span class="comment">         * never broadcast the WM_SYSCOLORCHANGE event to tell us to redraw</span>
01041 <span class="comment">         * This is only a DAYTONA related fix, and should be removed once</span>
01042 <span class="comment">         * we move the SYSMETS to a per-desktop state.</span>
01043 <span class="comment">         *</span>
01044 <span class="comment">         * 05-03-95 : ChrisWil.</span>
01045 <span class="comment">         */</span>
01046         <a class="code" href="../../d4/d1/userk_8h.html#a1679">xxxRedrawWindow</a>(pwnd,
01047                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01048                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01049                         RDW_INVALIDATE | RDW_ALLCHILDREN | RDW_ERASE);
01050         <span class="keywordflow">break</span>;
01051 
01052     <span class="keywordflow">case</span> WM_ERASEBKGND:
01053         hdcT = (HDC)wParam;
01054         <a class="code" href="../../d4/d1/userk_8h.html#a1444">xxxInternalPaintDesktop</a>(pwnd, hdcT, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01055         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01056 
01057     <span class="keywordflow">case</span> WM_PAINT:
01058         <a class="code" href="../../d4/d1/userk_8h.html#a1710">xxxBeginPaint</a>(pwnd, (LPPAINTSTRUCT)&amp;ps);
01059         <a class="code" href="../../d4/d1/userk_8h.html#a1711">xxxEndPaint</a>(pwnd, (LPPAINTSTRUCT)&amp;ps);
01060         <span class="keywordflow">break</span>;
01061 
01062 <span class="preprocessor">#ifdef HUNGAPP_GHOSTING</span>
01063 <span class="preprocessor"></span>    <span class="keywordflow">case</span> WM_HUNGTHREAD:
01064         {
01065             <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>((HWND)lParam);
01066 
01067             <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1650">FHungApp</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a912">CMSHUNGAPPTIMEOUT</a>)) {
01068                 <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
01069 
01070                 pwnd = <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a11">GetTopLevelWindow</a>(pwnd);
01071 
01072                 <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwnd, &amp;tlpwnd);
01073                 xxxCreateGhost(pwnd);
01074                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
01075             }
01076             <span class="keywordflow">break</span>;
01077         }
01078 <span class="preprocessor">#endif // HUNGAPP_GHOSTING</span>
01079 <span class="preprocessor"></span>
01080     <span class="keywordflow">case</span> WM_LBUTTONDBLCLK:
01081         message = WM_SYSCOMMAND;
01082         wParam = SC_TASKLIST;
01083 
01084         <span class="comment">/*</span>
01085 <span class="comment">         *** FALL THRU **</span>
01086 <span class="comment">         */</span>
01087 
01088     <span class="keywordflow">default</span>:
01089         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1632">xxxDefWindowProc</a>(pwnd, message, wParam, lParam);
01090     }
01091 
01092     <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
01093 }
01094 
01095 <span class="comment">/***************************************************************************\</span>
01096 <span class="comment">* SetDeskPattern</span>
01097 <span class="comment">*</span>
01098 <span class="comment">* NOTE: the lpszPattern parameter is new for Win 3.1.</span>
01099 <span class="comment">*</span>
01100 <span class="comment">* History:</span>
01101 <span class="comment">* 23-Oct-1990 DarrinM   Created stub.</span>
01102 <span class="comment">* 22-Apr-1991 DarrinM   Ported code from Win 3.1 sources.</span>
01103 <span class="comment">\***************************************************************************/</span>
01104 
<a name="l01105"></a><a class="code" href="../../d4/d1/userk_8h.html#a1185">01105</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1185">xxxSetDeskPattern</a>(PUNICODE_STRING pProfileUserName,
01106     LPWSTR   lpszPattern,
01107     BOOL     fCreation)
01108 {
01109     LPWSTR p;
01110     <span class="keywordtype">int</span>    i;
01111     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>   val;
01112     WCHAR  wszNone[20];
01113     WCHAR  wchValue[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
01114     WORD   rgBits[<a class="code" href="../../d4/d1/userk_8h.html#a223">CXYDESKPATTERN</a>];
01115     HBRUSH hBrushTemp;
01116 
01117     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
01118 
01119     <span class="comment">/*</span>
01120 <span class="comment">     * Get rid of the old bitmap (if any).</span>
01121 <span class="comment">     */</span>
01122     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a5">ghbmDesktop</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01123         GreDeleteObject(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a5">ghbmDesktop</a>);
01124         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a5">ghbmDesktop</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01125     }
01126 
01127     <span class="comment">/*</span>
01128 <span class="comment">     * Check if a pattern is passed via lpszPattern.</span>
01129 <span class="comment">     */</span>
01130     <span class="keywordflow">if</span> (lpszPattern != (LPWSTR)LongToPtr( (LONG)-1 )) {
01131 
01132         <span class="comment">/*</span>
01133 <span class="comment">         * Yes! Then use that pattern;</span>
01134 <span class="comment">         */</span>
01135         p = lpszPattern;
01136         <span class="keywordflow">goto</span> GotThePattern;
01137     }
01138 
01139     <span class="comment">/*</span>
01140 <span class="comment">     * Else, pickup the pattern selected in WIN.INI.</span>
01141 <span class="comment">     * Get the "DeskPattern" string from WIN.INI's [Desktop] section.</span>
01142 <span class="comment">     */</span>
01143     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a2011">FastGetProfileStringFromIDW</a>(pProfileUserName,
01144                                         <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>,
01145                                         STR_DESKPATTERN,
01146                                         TEXT(<span class="stringliteral">""</span>),
01147                                         wchValue,
01148                                         <span class="keyword">sizeof</span>(wchValue)/<span class="keyword">sizeof</span>(WCHAR)
01149                                         )) {
01150         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01151     }
01152 
01153     <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>,
01154                      STR_NONE,
01155                      wszNone,
01156                      <span class="keyword">sizeof</span>(wszNone)/<span class="keyword">sizeof</span>(WCHAR));
01157 
01158     p = wchValue;
01159 
01160 GotThePattern:
01161 
01162     <span class="comment">/*</span>
01163 <span class="comment">     * Was a Desk Pattern selected?</span>
01164 <span class="comment">     */</span>
01165     <span class="keywordflow">if</span> (*p == TEXT(<span class="charliteral">'\0'</span>) || _wcsicmp(p, wszNone) == 0) {
01166         hBrushTemp = GreCreateSolidBrush(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(<a class="code" href="../../d0/d3/structtagDESKTOP.html">DESKTOP</a>));
01167         <span class="keywordflow">if</span> (hBrushTemp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01168             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(<a class="code" href="../../d0/d3/structtagDESKTOP.html">DESKTOP</a>)) {
01169                 GreMarkDeletableBrush(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(<a class="code" href="../../d0/d3/structtagDESKTOP.html">DESKTOP</a>));
01170                 GreDeleteObject(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(<a class="code" href="../../d0/d3/structtagDESKTOP.html">DESKTOP</a>));
01171             }
01172             GreMarkUndeletableBrush(hBrushTemp);
01173             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(<a class="code" href="../../d0/d3/structtagDESKTOP.html">DESKTOP</a>) = hBrushTemp;
01174         }
01175         GreSetBrushOwnerPublic(hBrushTemp);
01176         <span class="keywordflow">goto</span> SDPExit;
01177     }
01178 
01179     <span class="comment">/*</span>
01180 <span class="comment">     * Get eight groups of numbers seprated by non-numeric characters.</span>
01181 <span class="comment">     */</span>
01182     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d4/d1/userk_8h.html#a223">CXYDESKPATTERN</a>; i++) {
01183         val = 0;
01184 
01185         <span class="comment">/*</span>
01186 <span class="comment">         * Skip over any non-numeric characters, check for null EVERY time.</span>
01187 <span class="comment">         */</span>
01188         <span class="keywordflow">while</span> (*p &amp;&amp; !(*p &gt;= TEXT(<span class="charliteral">'0'</span>) &amp;&amp; *p &lt;= TEXT(<span class="charliteral">'9'</span>)))
01189             p++;
01190 
01191         <span class="comment">/*</span>
01192 <span class="comment">         * Get the next series of digits.</span>
01193 <span class="comment">         */</span>
01194         <span class="keywordflow">while</span> (*p &gt;= TEXT(<span class="charliteral">'0'</span>) &amp;&amp; *p &lt;= TEXT(<span class="charliteral">'9'</span>))
01195             val = val * (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)10 + (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(*p++ - TEXT(<span class="charliteral">'0'</span>));
01196 
01197         rgBits[i] = (WORD)val;
01198     }
01199 
01200     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a5">ghbmDesktop</a> = GreCreateBitmap(<a class="code" href="../../d4/d1/userk_8h.html#a223">CXYDESKPATTERN</a>,
01201                                   <a class="code" href="../../d4/d1/userk_8h.html#a223">CXYDESKPATTERN</a>,
01202                                   1,
01203                                   1,
01204                                   (LPBYTE)rgBits);
01205 
01206     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a5">ghbmDesktop</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01207         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01208 
01209     GreSetBitmapOwner(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a5">ghbmDesktop</a>, OBJECT_OWNER_PUBLIC);
01210 
01211     <a class="code" href="../../d4/d1/userk_8h.html#a1177">RecolorDeskPattern</a>();
01212 
01213 SDPExit:
01214     <span class="keywordflow">if</span> (!fCreation) {
01215 
01216         <span class="comment">/*</span>
01217 <span class="comment">         * Notify everyone that the colors have changed.</span>
01218 <span class="comment">         */</span>
01219         <a class="code" href="../../d4/d1/userk_8h.html#a1581">xxxSendNotifyMessage</a>(<a class="code" href="../../d4/d1/userk_8h.html#a457">PWND_BROADCAST</a>, WM_SYSCOLORCHANGE, 0, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01220 
01221         <span class="comment">/*</span>
01222 <span class="comment">         * Update the entire screen.  If this is creation, don't update: the</span>
01223 <span class="comment">         * screen hasn't drawn, and also there are some things that aren't</span>
01224 <span class="comment">         * initialized yet.</span>
01225 <span class="comment">         */</span>
01226         <a class="code" href="../../d4/d1/userk_8h.html#a470">xxxRedrawScreen</a>();
01227     }
01228 
01229     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01230 }
01231 
01232 <span class="comment">/***************************************************************************\</span>
01233 <span class="comment">* RecolorDeskPattern</span>
01234 <span class="comment">*</span>
01235 <span class="comment">* Remakes the desktop pattern (if it exists) so that it uses the new</span>
01236 <span class="comment">* system colors.</span>
01237 <span class="comment">*</span>
01238 <span class="comment">* History:</span>
01239 <span class="comment">* 22-Apr-1991 DarrinM   Ported from Win 3.1 sources.</span>
01240 <span class="comment">\***************************************************************************/</span>
01241 
<a name="l01242"></a><a class="code" href="../../d9/d6/desktop_8c.html#a12">01242</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1177">RecolorDeskPattern</a>(VOID)
01243 {
01244     HBITMAP hbmOldDesk;
01245     HBITMAP hbmOldMem;
01246     HBITMAP hbmMem;
01247     HBRUSH  hBrushTemp;
01248     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a5">ghbmDesktop</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01249         <span class="keywordflow">return</span>;
01250 
01251     <span class="comment">/*</span>
01252 <span class="comment">     * Redo the desktop pattern in the new colors.</span>
01253 <span class="comment">     */</span>
01254 
01255     <span class="keywordflow">if</span> (hbmOldDesk = GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a5">ghbmDesktop</a>)) {
01256 
01257         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(SAMEDISPLAYFORMAT)) {
01258 
01259             <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> bmi[<span class="keyword">sizeof</span>(BITMAPINFOHEADER)+<span class="keyword">sizeof</span>(RGBQUAD)*2];
01260             PBITMAPINFO pbmi = (PBITMAPINFO) &amp;bmi;
01261 
01262             pbmi-&gt;bmiHeader.biSize = <span class="keyword">sizeof</span>(BITMAPINFOHEADER);
01263             pbmi-&gt;bmiHeader.biWidth = <a class="code" href="../../d4/d1/userk_8h.html#a223">CXYDESKPATTERN</a>;
01264             pbmi-&gt;bmiHeader.biHeight = <a class="code" href="../../d4/d1/userk_8h.html#a223">CXYDESKPATTERN</a>;
01265             pbmi-&gt;bmiHeader.biPlanes = 1;
01266             pbmi-&gt;bmiHeader.biBitCount = 1;
01267             pbmi-&gt;bmiHeader.biCompression = BI_RGB;
01268             pbmi-&gt;bmiHeader.biSizeImage = 0;
01269             pbmi-&gt;bmiHeader.biXPelsPerMeter = 0;
01270             pbmi-&gt;bmiHeader.biYPelsPerMeter = 0;
01271             pbmi-&gt;bmiHeader.biClrUsed = 2;
01272             pbmi-&gt;bmiHeader.biClrImportant = 2;
01273 
01274             pbmi-&gt;bmiColors[0].rgbBlue  = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(<a class="code" href="../../d0/d3/structtagDESKTOP.html">DESKTOP</a>) &gt;&gt; 16) &amp; 0xff);
01275             pbmi-&gt;bmiColors[0].rgbGreen = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(<a class="code" href="../../d0/d3/structtagDESKTOP.html">DESKTOP</a>) &gt;&gt;  8) &amp; 0xff);
01276             pbmi-&gt;bmiColors[0].rgbRed   = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(<a class="code" href="../../d0/d3/structtagDESKTOP.html">DESKTOP</a>)      ) &amp; 0xff);
01277 
01278             pbmi-&gt;bmiColors[1].rgbBlue  = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(WINDOWTEXT) &gt;&gt; 16) &amp; 0xff);
01279             pbmi-&gt;bmiColors[1].rgbGreen = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(WINDOWTEXT) &gt;&gt;  8) &amp; 0xff);
01280             pbmi-&gt;bmiColors[1].rgbRed   = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(WINDOWTEXT)      ) &amp; 0xff);
01281 
01282             hbmMem = GreCreateDIBitmapReal(
01283                <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a527">HDCBITS</a>(), 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01284                pbmi,DIB_RGB_COLORS,<span class="keyword">sizeof</span>(bmi),0,
01285                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,0,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,0,0);
01286 
01287         } <span class="keywordflow">else</span> {
01288 
01289             hbmMem = GreCreateCompatibleBitmap(
01290                <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a527">HDCBITS</a>(), <a class="code" href="../../d4/d1/userk_8h.html#a223">CXYDESKPATTERN</a>, <a class="code" href="../../d4/d1/userk_8h.html#a223">CXYDESKPATTERN</a>);
01291         }
01292 
01293         <span class="keywordflow">if</span> (hbmMem) {
01294 
01295             <span class="keywordflow">if</span> (hbmOldMem = GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a193">ghdcMem2</a>, hbmMem)) {
01296 
01297                 GreSetTextColor(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a193">ghdcMem2</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(<a class="code" href="../../d0/d3/structtagDESKTOP.html">DESKTOP</a>));
01298                 GreSetBkColor(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a193">ghdcMem2</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(WINDOWTEXT));
01299 
01300                 GreBitBlt(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a193">ghdcMem2</a>,
01301                           0,
01302                           0,
01303                           <a class="code" href="../../d4/d1/userk_8h.html#a223">CXYDESKPATTERN</a>,
01304                           <a class="code" href="../../d4/d1/userk_8h.html#a223">CXYDESKPATTERN</a>,
01305                           <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>,
01306                           0,
01307                           0,
01308                           SRCCOPY,
01309                           0);
01310 
01311                 <span class="keywordflow">if</span> (hBrushTemp = GreCreatePatternBrush(hbmMem)) {
01312 
01313                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(<a class="code" href="../../d0/d3/structtagDESKTOP.html">DESKTOP</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01314                         GreMarkDeletableBrush(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(<a class="code" href="../../d0/d3/structtagDESKTOP.html">DESKTOP</a>));
01315                         GreDeleteObject(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(<a class="code" href="../../d0/d3/structtagDESKTOP.html">DESKTOP</a>));
01316                     }
01317 
01318                     GreMarkUndeletableBrush(hBrushTemp);
01319                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(<a class="code" href="../../d0/d3/structtagDESKTOP.html">DESKTOP</a>) = hBrushTemp;
01320                 }
01321 
01322                 GreSetBrushOwnerPublic(hBrushTemp);
01323                 GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a193">ghdcMem2</a>, hbmOldMem);
01324             }
01325 
01326             GreDeleteObject(hbmMem);
01327         }
01328 
01329         GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>, hbmOldDesk);
01330     }
01331 }
01332 
01333 <span class="comment">/***************************************************************************\</span>
01334 <span class="comment">* xxxCreateDesktop (API)</span>
01335 <span class="comment">*</span>
01336 <span class="comment">* Create a new desktop object</span>
01337 <span class="comment">*</span>
01338 <span class="comment">* History:</span>
01339 <span class="comment">* 16-Jan-1991 JimA      Created scaffold code.</span>
01340 <span class="comment">* 11-Feb-1991 JimA      Added access checks.</span>
01341 <span class="comment">\***************************************************************************/</span>
01342 
<a name="l01343"></a><a class="code" href="../../d9/d6/desktop_8c.html#a13">01343</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d9/d6/desktop_8c.html#a13">xxxCreateDesktop2</a>(
01344     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>   pwinsta,
01345     <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>    pAccessState,
01346     KPROCESSOR_MODE  AccessMode,
01347     PUNICODE_STRING  pstrName,
01348     PDESKTOP_CONTEXT Context,
01349     PVOID            *pObject)
01350 {
01351     LUID              luidCaller;
01352     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
01353     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>         Process;
01354     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>          pdesk;
01355     <a class="code" href="../../d1/d3/structtagDESKTOPINFO.html">PDESKTOPINFO</a>      pdi;
01356     ULONG             ulHeapSize;
01357     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>          <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01358 
01359     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
01360 
01361     <span class="comment">/*</span>
01362 <span class="comment">     * If this is a desktop creation, make sure</span>
01363 <span class="comment">     * that the windowstation grants create access.</span>
01364 <span class="comment">     */</span>
01365     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d1/obse_8c.html#a6">ObCheckCreateObjectAccess</a>(
01366             pwinsta,
01367             WINSTA_CREATEDESKTOP,
01368             pAccessState,
01369             pstrName,
01370             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01371             AccessMode,
01372             &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01373 
01374         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01375     }
01376     <span class="comment">/*</span>
01377 <span class="comment">     * Fail if the windowstation is locked</span>
01378 <span class="comment">     */</span>
01379     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
01380 
01381     <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a315">WSF_OPENLOCK</a> &amp;&amp;
01382             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a>) {
01383 
01384         <span class="comment">/*</span>
01385 <span class="comment">         * If logoff is occuring and the caller does not</span>
01386 <span class="comment">         * belong to the session that is ending, allow the</span>
01387 <span class="comment">         * open to proceed.</span>
01388 <span class="comment">         */</span>
01389         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a961">GetProcessLuid</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;luidCaller);
01390 
01391         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ||
01392                 !(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a317">WSF_SHUTDOWN</a>) ||
01393                 <a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;luidCaller, &amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o17">luidEndSession</a>)) {
01394             <span class="keywordflow">return</span> STATUS_DEVICE_BUSY;
01395         }
01396     }
01397 
01398     <span class="comment">/*</span>
01399 <span class="comment">     * If a devmode has been specified, we also must be able</span>
01400 <span class="comment">     * to switch desktops.</span>
01401 <span class="comment">     */</span>
01402     <span class="keywordflow">if</span> (Context-&gt;<a class="code" href="../../d9/d2/struct__DESKTOP__CONTEXT.html#o1">lpDevMode</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a315">WSF_OPENLOCK</a>) &amp;&amp;
01403             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a>) {
01404         <span class="keywordflow">return</span> STATUS_DEVICE_BUSY;
01405     }
01406 
01407     <span class="comment">/*</span>
01408 <span class="comment">     * Allocate the new object</span>
01409 <span class="comment">     */</span>
01410     InitializeObjectAttributes(&amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>, pstrName, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01411     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>(
01412             <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01413             *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>,
01414             &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01415             <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
01416             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01417             <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d3/structtagDESKTOP.html">DESKTOP</a>),
01418             0,
01419             0,
01420             &amp;pdesk);
01421     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01422         RIPMSG1(RIP_WARNING, <span class="stringliteral">"xxxCreateDesktop2: ObCreateObject failed with Status 0x%x"</span>,
01423                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01424         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01425     }
01426     RtlZeroMemory(pdesk, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/userk_8h.html#a835">DESKTOP</a>));
01427 
01428     <span class="comment">/*</span>
01429 <span class="comment">     * Store the session id of the session who created the desktop</span>
01430 <span class="comment">     */</span>
01431     pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o25">dwSessionId</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a327">gSessionId</a>;
01432 
01433     <span class="comment">/*</span>
01434 <span class="comment">     * Create security descriptor</span>
01435 <span class="comment">     */</span>
01436     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a11">ObAssignSecurity</a>(
01437             pAccessState,
01438             <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pwinsta)-&gt;SecurityDescriptor,
01439             pdesk,
01440             *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>);
01441 
01442     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01443         <span class="keywordflow">goto</span> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>;
01444 
01445     <span class="comment">/*</span>
01446 <span class="comment">     * Set up desktop heap.  The first desktop (logon desktop) uses a</span>
01447 <span class="comment">     * small heap (128).</span>
01448 <span class="comment">     */</span>
01449     <span class="keywordflow">if</span> (!(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>) &amp;&amp; (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01450 <span class="preprocessor">#ifdef _WIN64</span>
01451 <span class="preprocessor"></span>        <span class="comment">/*</span>
01452 <span class="comment">         * Temporary fix. When winlogon starts creating processes on the right</span>
01453 <span class="comment">         * desktop, we'll have to figure out what this size should really be.</span>
01454 <span class="comment">         */</span>
01455         ulHeapSize = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a309">gdwDesktopSectionSize</a>;
01456 <span class="preprocessor">#else</span>
01457 <span class="preprocessor"></span>        ulHeapSize = 128;
01458 <span class="preprocessor">#endif</span>
01459 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
01460         <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>) {
01461             ulHeapSize = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a310">gdwNOIOSectionSize</a>;
01462         } <span class="keywordflow">else</span> {
01463 
01464             <span class="comment">/*</span>
01465 <span class="comment">             * The disconnected desktop should be small also.</span>
01466 <span class="comment">             */</span>
01467             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a> &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a329">gspdeskDisconnect</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01468                 ulHeapSize = 64;
01469             <span class="keywordflow">else</span>
01470                 ulHeapSize = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a309">gdwDesktopSectionSize</a>;
01471         }
01472     }
01473 
01474     ulHeapSize *= 1024;
01475     <span class="comment">/*</span>
01476 <span class="comment">     * Create the desktop heap.</span>
01477 <span class="comment">     */</span>
01478     pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o15">hsectionDesktop</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1534">CreateDesktopHeap</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o16">pheapDesktop</a>, ulHeapSize);
01479     <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o15">hsectionDesktop</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01480         RIPMSG1(RIP_WARNING, <span class="stringliteral">"xxxCreateDesktop: CreateDesktopHeap failed for pdesk %#p"</span>,
01481                 pdesk);
01482         <span class="keywordflow">goto</span> ErrorOutOfMemory;
01483     }
01484 
01485     <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>)) {
01486 
01487         <span class="comment">/*</span>
01488 <span class="comment">         * The first desktop or invisible desktops must also</span>
01489 <span class="comment">         * use the default settings.  This is because specifying</span>
01490 <span class="comment">         * the devmode causes a desktop switch, which must be</span>
01491 <span class="comment">         * avoided in this case.</span>
01492 <span class="comment">         */</span>
01493         Context-&gt;<a class="code" href="../../d9/d2/struct__DESKTOP__CONTEXT.html#o1">lpDevMode</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01494     }
01495 
01496     <span class="comment">/*</span>
01497 <span class="comment">     * Allocate desktopinfo</span>
01498 <span class="comment">     */</span>
01499     pdi = (<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html">PDESKTOPINFO</a>)<a class="code" href="../../d4/d1/userk_8h.html#a1020">DesktopAlloc</a>(pdesk, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html">DESKTOPINFO</a>), <a class="code" href="../../d4/d1/userk_8h.html#a303">DTAG_DESKTOPINFO</a>);
01500     <span class="keywordflow">if</span> (pdi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01501         RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxCreateDesktop: failed DeskInfo Alloc"</span>);
01502         <span class="keywordflow">goto</span> ErrorOutOfMemory;
01503     }
01504 
01505     <span class="comment">/*</span>
01506 <span class="comment">     * Initialize everything.</span>
01507 <span class="comment">     */</span>
01508     pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a> = pdi;
01509     InitializeListHead(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o20">PtiList</a>);
01510 
01511     <span class="comment">/*</span>
01512 <span class="comment">     * If a DEVMODE or another device name is passed in, then use that</span>
01513 <span class="comment">     * information.</span>
01514 <span class="comment">     * Otherwise use the default information (gpDispInfo).</span>
01515 <span class="comment">     */</span>
01516 
01517     <span class="keywordflow">if</span> (Context-&gt;<a class="code" href="../../d9/d2/struct__DESKTOP__CONTEXT.html#o1">lpDevMode</a>) {
01518 
01519         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  bDisabled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01520         PMDEV pmdev = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01521         LONG  ChangeStat = GRE_DISP_CHANGE_FAILED;
01522 
01523         <span class="comment">/*</span>
01524 <span class="comment">         * Allocate a display-info for this device.</span>
01525 <span class="comment">         */</span>
01526         pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a> = (<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html">PDISPLAYINFO</a>)UserAllocPoolZInit(
01527                 <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html">DISPLAYINFO</a>), TAG_DISPLAYINFO);
01528 
01529         <span class="keywordflow">if</span> (!pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a>) {
01530             RIPMSG1(RIP_WARNING, <span class="stringliteral">"xxxCreateDesktop: failed to allocate pDispInfo for pdesk %#p"</span>,
01531                     pdesk);
01532             <span class="keywordflow">goto</span> ErrorOutOfMemory;
01533         }
01534 
01535         <span class="keywordflow">if</span> ((bDisabled = DrvDisableMDEV(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01536 
01537             ChangeStat = DrvChangeDisplaySettings(Context-&gt;<a class="code" href="../../d9/d2/struct__DESKTOP__CONTEXT.html#o0">pstrDevice</a>,
01538                                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01539                                                   Context-&gt;<a class="code" href="../../d9/d2/struct__DESKTOP__CONTEXT.html#o1">lpDevMode</a>,
01540                                                   LongToPtr( <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a277">gdwDesktopId</a> ),
01541                                                   <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
01542                                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01543                                                   <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01544                                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01545                                                   &amp;pmdev,
01546                                                   GRE_DEFAULT,
01547                                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01548         }
01549 
01550         <span class="keywordflow">if</span> (ChangeStat != GRE_DISP_CHANGE_SUCCESSFUL) {
01551 
01552             <span class="keywordflow">if</span> (bDisabled) {
01553                 DrvEnableMDEV(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01554             }
01555 
01556             <span class="comment">//</span>
01557             <span class="comment">// If there is a failure, then repaint the whole screen.</span>
01558             <span class="comment">//</span>
01559 
01560             RIPMSG1(RIP_WARNING, <span class="stringliteral">"xxxCreateDesktop2 callback for pdesk %#p !"</span>,
01561                     pdesk);
01562 
01563             <a class="code" href="../../d9/d6/desktop_8c.html#a26">xxxUserResetDisplayDevice</a>();
01564 
01565             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
01566             <span class="keywordflow">goto</span> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>;
01567         }
01568 
01569         pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>  = pmdev-&gt;hdevParent;
01570         pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a> = pmdev;
01571         pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o5">dwDesktopId</a>      = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a277">gdwDesktopId</a>++;
01572 
01573         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o14">rcScreen</a>, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o14">rcScreen</a>);
01574         pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o16">dmLogPixels</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o16">dmLogPixels</a>;
01575 
01576         pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o13">pMonitorFirst</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01577         pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o12">pMonitorPrimary</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01578 
01579     } <span class="keywordflow">else</span> {
01580 
01581         pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a>   = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>;
01582         pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o5">dwDesktopId</a> = <a class="code" href="../../d4/d1/userk_8h.html#a300">GW_DESKTOP_ID</a>;
01583 
01584     }
01585 
01586     <span class="comment">/*</span>
01587 <span class="comment">     * Heap is HEAP_ZERO_MEMORY, so we should be zero-initialized already.</span>
01588 <span class="comment">     */</span>
01589     UserAssert(pdi-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o21">pvwplShellHook</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01590 
01591     pdi-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o0">pvDesktopBase</a>  = Win32HeapGetHandle(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o16">pheapDesktop</a>);
01592     pdi-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o1">pvDesktopLimit</a> = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pdi-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o0">pvDesktopBase</a> + ulHeapSize;
01593 
01594     <span class="comment">/*</span>
01595 <span class="comment">     * Reference the parent windowstation</span>
01596 <span class="comment">     */</span>
01597     <a class="code" href="../../d4/d1/userk_8h.html#a125">LockWinSta</a>(&amp;(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>), pwinsta);
01598 
01599     <span class="comment">/*</span>
01600 <span class="comment">     * Link the desktop into the windowstation list</span>
01601 <span class="comment">     */</span>
01602     <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01603 
01604         <span class="keywordflow">if</span> (!(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>))
01605             <a class="code" href="../../d4/d1/userk_8h.html#a126">LockDesktop</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a242">grpdeskLogon</a>, pdesk, LDL_DESKLOGON, 0);
01606         <span class="comment">/*</span>
01607 <span class="comment">         * Make the first desktop the "owner" of the top</span>
01608 <span class="comment">         * desktop window.  This is needed to ensure that</span>
01609 <span class="comment">         * xxxSetWindowPos will work on desktop windows.</span>
01610 <span class="comment">         */</span>
01611         <a class="code" href="../../d4/d1/userk_8h.html#a126">LockDesktop</a>(&amp;(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o1">spwndDesktopOwner</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk),
01612                     pdesk, LDL_MOTHERDESK_DESK2, (ULONG_PTR)(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o1">spwndDesktopOwner</a>));
01613     }
01614 
01615 
01616     <a class="code" href="../../d4/d1/userk_8h.html#a126">LockDesktop</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o2">rpdeskNext</a>, pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a>, LDL_DESK_DESKNEXT1, (ULONG_PTR)pwinsta);
01617     <a class="code" href="../../d4/d1/userk_8h.html#a126">LockDesktop</a>(&amp;pwinsta-&gt;rpdeskList, pdesk, LDL_WINSTA_DESKLIST1, (ULONG_PTR)pwinsta);
01618 
01619     <span class="comment">/*</span>
01620 <span class="comment">     * Mask off invalid access bits</span>
01621 <span class="comment">     */</span>
01622     <span class="keywordflow">if</span> (pAccessState-&gt;<a class="code" href="../../d2/d5/struct__ACCESS__STATE.html#o6">RemainingDesiredAccess</a> &amp; MAXIMUM_ALLOWED) {
01623         pAccessState-&gt;<a class="code" href="../../d2/d5/struct__ACCESS__STATE.html#o6">RemainingDesiredAccess</a> &amp;= ~MAXIMUM_ALLOWED;
01624         pAccessState-&gt;<a class="code" href="../../d2/d5/struct__ACCESS__STATE.html#o6">RemainingDesiredAccess</a> |= GENERIC_ALL;
01625     }
01626 
01627     <a class="code" href="../../d8/d6/sertl_8c.html#a70">RtlMapGenericMask</a>( &amp;pAccessState-&gt;<a class="code" href="../../d2/d5/struct__ACCESS__STATE.html#o6">RemainingDesiredAccess</a>, (PGENERIC_MAPPING)&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a305">DesktopMapping</a>);
01628     pAccessState-&gt;<a class="code" href="../../d2/d5/struct__ACCESS__STATE.html#o6">RemainingDesiredAccess</a> &amp;=
01629             (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a305">DesktopMapping</a>.GenericAll | ACCESS_SYSTEM_SECURITY);
01630 
01631     *pObject = pdesk;
01632 
01633     <span class="comment">/*</span>
01634 <span class="comment">     * Add the desktop to the global list of desktops in this win32k.</span>
01635 <span class="comment">     * This is HYDRA only</span>
01636 <span class="comment">     */</span>
01637     <a class="code" href="../../d4/d1/userk_8h.html#a774">DbgTrackAddDesktop</a>(pdesk);
01638 
01639     <span class="keywordflow">return</span> STATUS_SUCCESS;
01640 
01641 ErrorOutOfMemory:
01642     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
01643     <span class="comment">// fall-through</span>
01644 
01645 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>:
01646     <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdesk, LD_DEREF_FN_2CREATEDESKTOP, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, 0);
01647     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pdesk);
01648 
01649     UserAssert(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01650 
01651     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01652 }
01653 
<a name="l01654"></a><a class="code" href="../../d9/d6/desktop_8c.html#a14">01654</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d6/desktop_8c.html#a14">xxxCreateDisconnectDesktop</a>(
01655     HWINSTA        hwinsta,
01656     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta)
01657 {
01658     UNICODE_STRING      strDesktop;
01659     OBJECT_ATTRIBUTES   oa;
01660     HDESK               hdeskDisconnect;
01661     HRGN                hrgn;
01662     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01663 
01664     <span class="comment">/*</span>
01665 <span class="comment">     * If not created yet, then create the Disconnected desktop</span>
01666 <span class="comment">     * (used when WinStation is disconnected), and lock the desktop</span>
01667 <span class="comment">     * and desktop window to ensure they never get deleted.</span>
01668 <span class="comment">     */</span>
01669     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strDesktop, TEXT(<span class="stringliteral">"Disconnect"</span>));
01670     InitializeObjectAttributes(&amp;oa, &amp;strDesktop,
01671             OBJ_OPENIF | OBJ_CASE_INSENSITIVE, hwinsta, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01672 
01673     hdeskDisconnect = <a class="code" href="../../d4/d1/userk_8h.html#a1795">xxxCreateDesktop</a>(&amp;oa, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01674             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, MAXIMUM_ALLOWED);
01675 
01676     <span class="keywordflow">if</span> (hdeskDisconnect == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01677         RIPMSG0(RIP_WARNING, <span class="stringliteral">"Could not create Disconnect desktop"</span>);
01678         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01679     }
01680 
01681     <span class="comment">/*</span>
01682 <span class="comment">     * Keep around an extra reference to the disconnect desktop from</span>
01683 <span class="comment">     * the CSR so it will stay around even if winlogon exits.</span>
01684 <span class="comment">     */</span>
01685     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(hdeskDisconnect,
01686                                        0,
01687                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01688                                        <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01689                                        &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a329">gspdeskDisconnect</a>,
01690                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01691     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01692 
01693         RIPMSG1(RIP_WARNING, <span class="stringliteral">"Disconnect Desktop reference failed 0x%x"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01694 
01695         <a class="code" href="../../d4/d1/userk_8h.html#a1803">xxxCloseDesktop</a>(hdeskDisconnect, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>);
01696         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a329">gspdeskDisconnect</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01697         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01698     }
01699 
01700     <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a329">gspdeskDisconnect</a>, LDL_DESKDISCONNECT, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, 0);
01701 
01702     <span class="comment">/*</span>
01703 <span class="comment">     * Set the region of the desktop window to be (0, 0, 0, 0) so</span>
01704 <span class="comment">     * that there is no hittesting going on the 'disconnect' desktop</span>
01705 <span class="comment">     */</span>
01706     hrgn = <a class="code" href="../../d4/d1/userk_8h.html#a1162">CreateEmptyRgn</a>();
01707 
01708     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a329">gspdeskDisconnect</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01709 
01710     <a class="code" href="../../d4/d1/userk_8h.html#a1611">SelectWindowRgn</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a329">gspdeskDisconnect</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>, hrgn);
01711 
01712     <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>);
01713 
01714     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a3">ObOpenObjectByPointer</a>(
01715                  <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a329">gspdeskDisconnect</a>,
01716                  0,
01717                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01718                  EVENT_ALL_ACCESS,
01719                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01720                  <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01721                  &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a347">ghDisconnectDesk</a>);
01722 
01723     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01724 
01725         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a3">ObOpenObjectByPointer</a>(
01726                      pwinsta,
01727                      0,
01728                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01729                      EVENT_ALL_ACCESS,
01730                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01731                      <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01732                      &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a348">ghDisconnectWinSta</a>);
01733     }
01734 
01735     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
01736 
01737     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01738 
01739         RIPMSG0(RIP_WARNING, <span class="stringliteral">"Could not create Disconnect desktop"</span>);
01740 
01741         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a347">ghDisconnectDesk</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01742             <a class="code" href="../../d4/d1/userk_8h.html#a2073">CloseProtectedHandle</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a347">ghDisconnectDesk</a>);
01743             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a347">ghDisconnectDesk</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01744         }
01745 
01746         <a class="code" href="../../d4/d1/userk_8h.html#a1803">xxxCloseDesktop</a>(hdeskDisconnect, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>);
01747         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01748     }
01749 
01750     <span class="comment">/*</span>
01751 <span class="comment">     * Don't want to do alot of paints if we disconnected before this.</span>
01752 <span class="comment">     */</span>
01753     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a350">gbConnected</a>) {
01754         RIPMSG0(RIP_WARNING,
01755             <span class="stringliteral">"RemoteDisconnect was issued during CreateDesktop(\"Winlogon\"..."</span>);
01756     }
01757 
01758     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01759 }
01760 
<a name="l01761"></a><a class="code" href="../../d9/d6/desktop_8c.html#a15">01761</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d6/desktop_8c.html#a15">CleanupDirtyDesktops</a>(
01762     VOID)
01763 {
01764     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
01765     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>*      ppdesk;
01766 
01767     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
01768 
01769     <span class="keywordflow">for</span> (pwinsta = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a>; pwinsta != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pwinsta = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o0">rpwinstaNext</a>) {
01770 
01771         ppdesk = &amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a>;
01772 
01773         <span class="keywordflow">while</span> (*ppdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01774 
01775             <span class="keywordflow">if</span> (!((*ppdesk)-&gt;dwDTFlags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a298">DF_DESKCREATED</a>)) {
01776                 RIPMSG1(RIP_WARNING, <span class="stringliteral">"Desktop %#p in a dirty state"</span>, *ppdesk);
01777 
01778                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a242">grpdeskLogon</a> == *ppdesk) {
01779                     <a class="code" href="../../d4/d1/userk_8h.html#a127">UnlockDesktop</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a242">grpdeskLogon</a>, LDU_DESKLOGON, 0);
01780                 }
01781 
01782                 <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o1">spwndDesktopOwner</a> &amp;&amp;
01783                     pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o1">spwndDesktopOwner</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk == *ppdesk) {
01784 
01785                     <a class="code" href="../../d4/d1/userk_8h.html#a127">UnlockDesktop</a>(&amp;(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o1">spwndDesktopOwner</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk),
01786                                   LDU_MOTHERDESK_DESK, (ULONG_PTR)(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o1">spwndDesktopOwner</a>));
01787                 }
01788 
01789                 <a class="code" href="../../d4/d1/userk_8h.html#a126">LockDesktop</a>(ppdesk, (*ppdesk)-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o2">rpdeskNext</a>, LDL_WINSTA_DESKLIST1, (ULONG_PTR)pwinsta);
01790             } <span class="keywordflow">else</span> {
01791                 ppdesk = &amp;(*ppdesk)-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o2">rpdeskNext</a>;
01792             }
01793         }
01794     }
01795 }
01796 
<a name="l01797"></a><a class="code" href="../../d4/d1/userk_8h.html#a1795">01797</a> HDESK <a class="code" href="../../d4/d1/userk_8h.html#a1795">xxxCreateDesktop</a>(
01798     POBJECT_ATTRIBUTES ccxObjectAttributes,
01799     KPROCESSOR_MODE    ProbeMode,
01800     PUNICODE_STRING    ccxpstrDevice,
01801     LPDEVMODE          ccxlpdevmode,
01802     DWORD              dwFlags,
01803     DWORD              dwDesiredAccess)
01804 {
01805     HWINSTA         hwinsta;
01806     HDESK           hdesk;
01807     <a class="code" href="../../d9/d2/struct__DESKTOP__CONTEXT.html">DESKTOP_CONTEXT</a> Context;
01808     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>        pdesk;
01809     <a class="code" href="../../d1/d3/structtagDESKTOPINFO.html">PDESKTOPINFO</a>    pdi;
01810     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>  pwinsta;
01811     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>        pdeskTemp;
01812     HDESK           hdeskTemp;
01813     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>            pwndDesktop = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01814     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>            pwndMessage = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01815     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>            pwndTooltip = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01816     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>            pwndMenu = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01817     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>              tlpwnd;
01818     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01819     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>            fWasNull;
01820     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>            bSuccess;
01821     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>    ppi;
01822     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>    ppiSave;
01823     <a class="code" href="../../d1/d8/structtagTERMINAL.html">PTERMINAL</a>       pTerm;
01824     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01825     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>           dwDisableHooks;
01826 
01827 <span class="preprocessor">#if DBG</span>
01828 <span class="preprocessor"></span>    <span class="comment">/*</span>
01829 <span class="comment">     * Too many jumps in this function to use BEGIN/ENDATOMICHCECK</span>
01830 <span class="comment">     */</span>
01831     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwCritSecUseSave = gdwCritSecUseCount;
01832 <span class="preprocessor">#endif</span>
01833 <span class="preprocessor"></span>
01834     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
01835 
01836     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
01837 
01838     <span class="comment">/*</span>
01839 <span class="comment">     * Capture directory handle and check for create access.</span>
01840 <span class="comment">     */</span>
01841     <span class="keywordflow">try</span> {
01842         hwinsta = ccxObjectAttributes-&gt;RootDirectory;
01843     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, RIP_WARNING)) {
01844         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01845     }
01846     <span class="keywordflow">if</span> (hwinsta != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01847         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01848                 hwinsta,
01849                 WINSTA_CREATEDESKTOP,
01850                 *<a class="code" href="../../d3/d7/win32_8c.html#a0">ExWindowStationObjectType</a>,
01851                 ProbeMode,
01852                 &amp;pwinsta,
01853                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01854         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01855             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pwinsta);
01856         } <span class="keywordflow">else</span> {
01857             RIPNTERR0(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, RIP_VERBOSE, <span class="stringliteral">"ObReferenceObjectByHandle Failed"</span>);
01858             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01859         }
01860     }
01861 
01862     <span class="comment">/*</span>
01863 <span class="comment">     * Set up creation context</span>
01864 <span class="comment">     */</span>
01865     Context.<a class="code" href="../../d9/d2/struct__DESKTOP__CONTEXT.html#o1">lpDevMode</a>  = ccxlpdevmode;
01866     Context.<a class="code" href="../../d9/d2/struct__DESKTOP__CONTEXT.html#o0">pstrDevice</a> = ccxpstrDevice;
01867     Context.<a class="code" href="../../d9/d2/struct__DESKTOP__CONTEXT.html#o2">dwFlags</a>    = <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;
01868 
01869     <span class="comment">/*</span>
01870 <span class="comment">     * Create the desktop -- the object manager uses try blocks</span>
01871 <span class="comment">     */</span>
01872     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>(
01873             ccxObjectAttributes,
01874             *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>,
01875             ProbeMode,
01876             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01877             dwDesiredAccess,
01878             &amp;Context,
01879             &amp;hdesk);
01880 
01881     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01882 
01883         RIPNTERR1(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>,
01884                   RIP_WARNING,
01885                   <span class="stringliteral">"xxxCreateDesktop: ObOpenObjectByName failed with Status 0x%x"</span>,
01886                   <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01887 
01888         <span class="comment">/*</span>
01889 <span class="comment">         * Cleanup desktop objects that were created in xxxCreateDesktop2</span>
01890 <span class="comment">         * but later on the Ob manager failed the creation for other</span>
01891 <span class="comment">         * reasons (ex: no quota)</span>
01892 <span class="comment">         */</span>
01893         <a class="code" href="../../d9/d6/desktop_8c.html#a15">CleanupDirtyDesktops</a>();
01894 
01895         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01896     }
01897 
01898     <span class="comment">/*</span>
01899 <span class="comment">     * If the desktop already exists, we're done.  This will only happen</span>
01900 <span class="comment">     * if OBJ_OPENIF was specified.</span>
01901 <span class="comment">     */</span>
01902     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_OBJECT_NAME_EXISTS) {
01903         <a class="code" href="../../d4/d1/userk_8h.html#a2069">SetHandleFlag</a>(hdesk, <a class="code" href="../../d4/d1/userk_8h.html#a747">HF_PROTECTED</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01904         RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxCreateDesktop: Object name exists"</span>);
01905         <span class="keywordflow">return</span> hdesk;
01906     }
01907 
01908     <span class="comment">/*</span>
01909 <span class="comment">     * Reference the desktop to finish initialization</span>
01910 <span class="comment">     */</span>
01911     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01912             hdesk,
01913             0,
01914             *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>,
01915             <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01916             &amp;pdesk,
01917             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01918     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01919         RIPNTERR0(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, RIP_VERBOSE, <span class="stringliteral">""</span>);
01920         <a class="code" href="../../d4/d1/userk_8h.html#a2073">CloseProtectedHandle</a>(hdesk);
01921         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01922     }
01923 
01924     pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a298">DF_DESKCREATED</a>;
01925 
01926     <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdesk, LD_REF_FN_CREATEDESKTOP, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
01927 
01928     pwinsta = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>;
01929     pTerm   = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>;
01930     pdi = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>;
01931 
01932     pdi-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o6">ppiShellProcess</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01933 
01934     <span class="comment">/*</span>
01935 <span class="comment">     * If the desktop was not mapped in as a result of the open,</span>
01936 <span class="comment">     * fail.</span>
01937 <span class="comment">     */</span>
01938     ppi = <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>();
01939     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1283">GetDesktopView</a>(ppi, pdesk) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01940 
01941         <span class="comment">/*</span>
01942 <span class="comment">         * Desktop mapping failed.</span>
01943 <span class="comment">         */</span>
01944         <a class="code" href="../../d4/d1/userk_8h.html#a2073">CloseProtectedHandle</a>(hdesk);
01945 
01946         <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdesk, LD_DEREF_FN_CREATEDESKTOP1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
01947 
01948         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pdesk);
01949         RIPNTERR0(STATUS_ACCESS_DENIED, RIP_WARNING, <span class="stringliteral">"Desktop mapping failed"</span>);
01950         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01951     }
01952 
01953     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01954         <span class="comment">/*</span>
01955 <span class="comment">         * Map the desktop into CSRSS to ensure that the</span>
01956 <span class="comment">         * hard error handler can get access.</span>
01957 <span class="comment">         */</span>
01958         <span class="keywordflow">try</span> {
01959             <a class="code" href="../../d4/d1/userk_8h.html#a1289">MapDesktop</a>(<a class="code" href="../../d4/d0/ob_8h.html#a100a59">ObOpenHandle</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>, pdesk, 0, 1);
01960         } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, RIP_WARNING)) {
01961 
01962             <span class="comment">/*</span>
01963 <span class="comment">             * Desktop mapping failed.</span>
01964 <span class="comment">             */</span>
01965             <a class="code" href="../../d4/d1/userk_8h.html#a2073">CloseProtectedHandle</a>(hdesk);
01966 
01967             <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdesk, LD_DEREF_FN_CREATEDESKTOP2, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
01968 
01969             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pdesk);
01970             RIPNTERR0(STATUS_ACCESS_DENIED, RIP_WARNING, <span class="stringliteral">"Desktop mapping failed (2)"</span>);
01971             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01972         }
01973 
01974         UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a1283">GetDesktopView</a>(<a class="code" href="../../d4/d1/userk_8h.html#a18">PpiFromProcess</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>), pdesk) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01975     }
01976 
01977     <span class="comment">/*</span>
01978 <span class="comment">     * Set hook flags</span>
01979 <span class="comment">     */</span>
01980     <a class="code" href="../../d4/d1/userk_8h.html#a2069">SetHandleFlag</a>(hdesk, <a class="code" href="../../d4/d1/userk_8h.html#a746">HF_DESKTOPHOOK</a>, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; DF_ALLOWOTHERACCOUNTHOOK);
01981 
01982     <span class="comment">/*</span>
01983 <span class="comment">     * Set up to create the desktop window.</span>
01984 <span class="comment">     */</span>
01985     fWasNull = (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o3">rpdeskStartup</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01986     pdeskTemp = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>;            <span class="comment">// save current desktop</span>
01987     hdeskTemp = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o18">hdesk</a>;
01988 
01989     <span class="comment">/*</span>
01990 <span class="comment">     * Switch ppi values so window will be created using the</span>
01991 <span class="comment">     * system's desktop window class.</span>
01992 <span class="comment">     */</span>
01993     ppiSave  = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>;
01994     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> = pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>;
01995 
01996     <a class="code" href="../../d4/d1/userk_8h.html#a614">DeferWinEventNotify</a>();
01997     <a class="code" href="../../d4/d1/userk_8h.html#a161">BeginAtomicCheck</a>();
01998 
01999     <a class="code" href="../../d4/d1/userk_8h.html#a1799">zzzSetDesktop</a>(ptiCurrent, pdesk, hdesk);
02000 
02001     <span class="comment">/*</span>
02002 <span class="comment">     * Create the desktop window</span>
02003 <span class="comment">     */</span>
02004     <span class="comment">/*</span>
02005 <span class="comment">     * HACK HACK HACK!!! (adams) In order to create the desktop window</span>
02006 <span class="comment">     * with the correct desktop, we set the desktop of the current thread</span>
02007 <span class="comment">     * to the new desktop. But in so doing we allow hooks on the current</span>
02008 <span class="comment">     * thread to also hook this new desktop. This is bad, because we don't</span>
02009 <span class="comment">     * want the desktop window to be hooked while it is created. So we</span>
02010 <span class="comment">     * temporarily disable hooks of the current thread and its desktop,</span>
02011 <span class="comment">     * and reenable them after switching back to the original desktop.</span>
02012 <span class="comment">     */</span>
02013 
02014     dwDisableHooks = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a820">TIF_DISABLEHOOKS</a>;
02015     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a820">TIF_DISABLEHOOKS</a>;
02016 
02017     pwndDesktop = <a class="code" href="../../d4/d1/userk_8h.html#a1574">xxxCreateWindowEx</a>(
02018             (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0,
02019             (<a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a>)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a39">DESKTOPCLASS</a>,
02020             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02021             (WS_POPUP | WS_CLIPCHILDREN),
02022             pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o14">rcScreen</a>.left,
02023             pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o14">rcScreen</a>.top,
02024             pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o14">rcScreen</a>.right - pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o14">rcScreen</a>.left,
02025             pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o14">rcScreen</a>.bottom - pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o14">rcScreen</a>.top,
02026             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02027             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02028             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>,
02029             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02030             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a102">VER31</a>);
02031 
02032     <span class="keywordflow">if</span> (pwndDesktop == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02033         RIPMSG1(RIP_WARNING,
02034                 <span class="stringliteral">"xxxCreateDesktop: Failed to create the desktop window for pdesk %#p"</span>,
02035                 pdesk);
02036         <span class="keywordflow">goto</span> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>;
02037     }
02038 
02039     <span class="comment">/*</span>
02040 <span class="comment">     * NOTE: In order for the message window to be created without</span>
02041 <span class="comment">     * the desktop as it's owner, it needs to be created before</span>
02042 <span class="comment">     * setting pdi-&gt;spwnd to the desktop window. This is a complete</span>
02043 <span class="comment">     * hack and should be fixed.</span>
02044 <span class="comment">     */</span>
02045     pwndMessage = <a class="code" href="../../d4/d1/userk_8h.html#a1574">xxxCreateWindowEx</a>(
02046             (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0,
02047             (<a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a>)<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a284">gatomMessage</a>,
02048             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02049             (WS_POPUP | WS_CLIPCHILDREN),
02050             0,
02051             0,
02052             100,
02053             100,
02054             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02055             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02056             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>,
02057             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02058             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a102">VER31</a>);
02059 
02060     <span class="keywordflow">if</span> (pwndMessage == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02061         RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxCreateDesktop: Failed to create the message window"</span>);
02062         <span class="keywordflow">goto</span> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>;
02063     }
02064 
02065     UserAssert(pdi-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02066 
02067     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(pdi-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>), pwndDesktop);
02068 
02069     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a745">SetFullScreen</a>(pwndDesktop, GDIFULLSCREEN);
02070 
02071     <span class="comment">/*</span>
02072 <span class="comment">     * set this windows to the fullscreen window if we don't have one yet</span>
02073 <span class="comment">     */</span>
02074 
02075     <span class="comment">/*</span>
02076 <span class="comment">     * LATER mikeke</span>
02077 <span class="comment">     * this can be a problem if a desktop is created while we are in</span>
02078 <span class="comment">     * FullScreenCleanup()</span>
02079 <span class="comment">     */</span>
02080 
02081     <span class="comment">/*</span>
02082 <span class="comment">     * Don't set gspwndFullScreen if fGdiEnabled has been cleared</span>
02083 <span class="comment">     * (we may be in the middle of a disconnect).</span>
02084 <span class="comment">     */</span>
02085     UserAssert(<a class="code" href="../../d9/d6/desktop_8c.html#a3">fGdiEnabled</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02086 
02087     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a15">gspwndFullScreen</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; !(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>)) {
02088         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a15">gspwndFullScreen</a>), pwndDesktop);
02089     }
02090 
02091     <span class="comment">/*</span>
02092 <span class="comment">     * NT Bug 388747: Link the message window to the mother desktop window</span>
02093 <span class="comment">     * so that it properly has a parent.  We will do this before we link the</span>
02094 <span class="comment">     * desktop window just so the initial message window appears after the</span>
02095 <span class="comment">     * initial desktop window (a minor optimization, but not necessary).</span>
02096 <span class="comment">     */</span>
02097     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pwndMessage-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>, pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o1">spwndDesktopOwner</a>);
02098     <a class="code" href="../../d4/d1/userk_8h.html#a1457">LinkWindow</a>(pwndMessage, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o1">spwndDesktopOwner</a>);
02099     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o13">spwndMessage</a>, pwndMessage);
02100     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pwndMessage-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>);
02101 
02102     <span class="comment">/*</span>
02103 <span class="comment">     * Link it as a child but don't use WS_CHILD style</span>
02104 <span class="comment">     */</span>
02105     <a class="code" href="../../d4/d1/userk_8h.html#a1457">LinkWindow</a>(pwndDesktop, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o1">spwndDesktopOwner</a>);
02106     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pwndDesktop-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>, pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o1">spwndDesktopOwner</a>);
02107     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pwndDesktop-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>);
02108 
02109     <span class="comment">/*</span>
02110 <span class="comment">     * Make it regional if it's display configuration is regional.</span>
02111 <span class="comment">     */</span>
02112     <span class="keywordflow">if</span> (!pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o18">fDesktopIsRect</a>) {
02113         pwndDesktop-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a> = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o15">hrgnScreen</a>;
02114     }
02115 
02116     <span class="comment">/*</span>
02117 <span class="comment">     * Create shared menu window and tooltip window</span>
02118 <span class="comment">     */</span>
02119     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o13">spwndMessage</a>, &amp;tlpwnd);
02120 
02121     <span class="comment">/*</span>
02122 <span class="comment">     * Create the tooltip window only for desktops in</span>
02123 <span class="comment">     * interactive windowstations.</span>
02124 <span class="comment">     */</span>
02125     <span class="keywordflow">if</span> (!(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>)) {
02126         pwndTooltip = <a class="code" href="../../d4/d1/userk_8h.html#a1574">xxxCreateWindowEx</a>(
02127                 WS_EX_TOOLWINDOW | WS_EX_TOPMOST,
02128                 (<a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a>)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a44">TOOLTIPCLASS</a>,
02129                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02130                 WS_POPUP | WS_BORDER,
02131                 0,
02132                 0,
02133                 100,
02134                 100,
02135                 pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o13">spwndMessage</a>,
02136                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02137                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>,
02138                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02139                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a102">VER31</a>);
02140 
02141 
02142         <span class="keywordflow">if</span> (pwndTooltip == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02143             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
02144             RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxCreateDesktop: Failed to create the tooltip window"</span>);
02145             <span class="keywordflow">goto</span> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>;
02146         }
02147 
02148         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o14">spwndTooltip</a>, pwndTooltip);
02149     }
02150 
02151     pwndMenu = <a class="code" href="../../d4/d1/userk_8h.html#a1574">xxxCreateWindowEx</a>(
02152             WS_EX_TOOLWINDOW | WS_EX_DLGMODALFRAME | WS_EX_WINDOWEDGE,
02153             (<a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a>)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a45">MENUCLASS</a>,
02154             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02155             WS_POPUP | WS_BORDER,
02156             0,
02157             0,
02158             100,
02159             100,
02160             pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o13">spwndMessage</a>,
02161             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02162             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>,
02163             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02164             WINVER);
02165 
02166     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
02167 
02168     <span class="keywordflow">if</span> (pwndMenu == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02169         RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxCreateDesktop: Failed to create the menu window"</span>);
02170         <span class="keywordflow">goto</span> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>;
02171     }
02172 
02173     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o6">spwndMenu</a>), pwndMenu);
02174 
02175     <span class="comment">/*</span>
02176 <span class="comment">     * Set the flag in the popupmenu structure that tells this</span>
02177 <span class="comment">     * popup menu belongs to the pdesk-&gt;spwndMenu</span>
02178 <span class="comment">     */</span>
02179     ((<a class="code" href="../../d5/d1/structtagMENUWND.html">PMENUWND</a>)pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o6">spwndMenu</a>)-&gt;ppopupmenu-&gt;fDesktopMenu = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02180     <span class="comment">/*</span>
02181 <span class="comment">     * Unlock spwndPopupMenu since the menu is not in use but mainly</span>
02182 <span class="comment">     *  so we won't have to special case this later when the menu is used.</span>
02183 <span class="comment">     */</span>
02184     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;((<a class="code" href="../../d5/d1/structtagMENUWND.html">PMENUWND</a>)pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o6">spwndMenu</a>)-&gt;ppopupmenu-&gt;spwndPopupMenu);
02185 
02186     <a class="code" href="../../d4/d1/userk_8h.html#a980">HMChangeOwnerThread</a>(pdi-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>, pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>);
02187     <a class="code" href="../../d4/d1/userk_8h.html#a980">HMChangeOwnerThread</a>(pwndMessage, pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>);
02188     <a class="code" href="../../d4/d1/userk_8h.html#a980">HMChangeOwnerThread</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o6">spwndMenu</a>, pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>);
02189 
02190     <span class="keywordflow">if</span> (!(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>)) {
02191         <a class="code" href="../../d4/d1/userk_8h.html#a980">HMChangeOwnerThread</a>(pwndTooltip, pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>);
02192     }
02193 
02194     <span class="comment">/*</span>
02195 <span class="comment">     * Restore caller's ppi</span>
02196 <span class="comment">     */</span>
02197     <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;ppi = ppiSave;
02198 
02199     <span class="comment">/*</span>
02200 <span class="comment">     * HACK HACK HACK (adams): Renable hooks.</span>
02201 <span class="comment">     */</span>
02202     UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a820">TIF_DISABLEHOOKS</a>);
02203     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> = (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a820">TIF_DISABLEHOOKS</a>) | dwDisableHooks;
02204 
02205     <span class="comment">/*</span>
02206 <span class="comment">     * Restore the previous desktop</span>
02207 <span class="comment">     */</span>
02208     <a class="code" href="../../d4/d1/userk_8h.html#a1799">zzzSetDesktop</a>(ptiCurrent, pdeskTemp, hdeskTemp);
02209 
02210     <a class="code" href="../../d4/d1/userk_8h.html#a165">EndAtomicCheck</a>();
02211     UserAssert(dwCritSecUseSave == gdwCritSecUseCount);
02212     <a class="code" href="../../d4/d1/userk_8h.html#a617">zzzEndDeferWinEventNotify</a>();
02213 
02214     <span class="comment">/*</span>
02215 <span class="comment">     * If this is the first desktop, let the worker threads run now</span>
02216 <span class="comment">     * that there is someplace to send input to.  Reassign the event</span>
02217 <span class="comment">     * to handle desktop destruction.</span>
02218 <span class="comment">     */</span>
02219     <span class="keywordflow">if</span> (pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o7">pEventInputReady</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02220 
02221         <span class="comment">/*</span>
02222 <span class="comment">         * Set the windowstation for RIT and desktop thread</span>
02223 <span class="comment">         * so when EventInputReady is signaled the RIT and the desktop</span>
02224 <span class="comment">         * will have a windowstation.</span>
02225 <span class="comment">         */</span>
02226         <span class="keywordflow">if</span> (!(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o0">dwTERMF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a201">TERMF_NOIO</a>)) {
02227             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o23">pwinsta</a> = pwinsta;
02228         } <span class="keywordflow">else</span> {
02229             <span class="comment">/*</span>
02230 <span class="comment">             * let the desktop thread of the system terminal have</span>
02231 <span class="comment">             * a rpdesk.</span>
02232 <span class="comment">             */</span>
02233             <a class="code" href="../../d4/d1/userk_8h.html#a1799">zzzSetDesktop</a>(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>, pdesk, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02234         }
02235 
02236         pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o23">pwinsta</a> = pwinsta;
02237 
02238         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o7">pEventInputReady</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02239 
02240         <span class="keywordflow">if</span> (!(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o0">dwTERMF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a201">TERMF_NOIO</a>)) {
02241 
02242             <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
02243             <span class="keywordflow">while</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02244                 <a class="code" href="../../d4/d1/userk_8h.html#a1294">UserSleep</a>(20);
02245                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"Waiting for grpdeskRitInput to be set ..."</span>);
02246             }
02247             <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
02248         }
02249 
02250         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o7">pEventInputReady</a>);
02251         pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o7">pEventInputReady</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02252     }
02253 
02254 
02255     <span class="comment">/*</span>
02256 <span class="comment">     * HACK HACK:</span>
02257 <span class="comment">     * LATER</span>
02258 <span class="comment">     *</span>
02259 <span class="comment">     * If we have a devmode passed in, then switch desktops ...</span>
02260 <span class="comment">     */</span>
02261 
02262     <span class="keywordflow">if</span> (ccxlpdevmode) {
02263 
02264         <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"xxxCreateDesktop: about to call switch desktop\n"</span>));
02265 
02266         bSuccess = <a class="code" href="../../d4/d1/userk_8h.html#a1798">xxxSwitchDesktop</a>(pwinsta, pdesk, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02267         <span class="keywordflow">if</span> (!bSuccess) {
02268             RIPMSG0(RIP_ERROR, <span class="stringliteral">"Failed to switch desktop on Create\n"</span>);
02269         }
02270 
02271     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pTerm == &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a239">gTermIO</a>){
02272 
02273         UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02274 
02275         <span class="comment">/*</span>
02276 <span class="comment">         * Force the window to the bottom of the z-order if there</span>
02277 <span class="comment">         * is an active desktop so any drawing done on the desktop</span>
02278 <span class="comment">         * window will not be seen.  This will also allow</span>
02279 <span class="comment">         * IsWindowVisible to work for apps on invisible</span>
02280 <span class="comment">         * desktops.</span>
02281 <span class="comment">         */</span>
02282         <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwndDesktop, &amp;tlpwnd);
02283         <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwndDesktop, <a class="code" href="../../d4/d1/userk_8h.html#a453">PWND_BOTTOM</a>, 0, 0, 0, 0,
02284                     SWP_SHOWWINDOW | SWP_NOACTIVATE | SWP_NOMOVE |
02285                     SWP_NOREDRAW | SWP_NOSIZE | SWP_NOSENDCHANGING);
02286         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
02287     }
02288 
02289     <span class="comment">/*</span>
02290 <span class="comment">     * If it was null when we came in, make it null going out, or else</span>
02291 <span class="comment">     * we'll have the wrong desktop selected into this.</span>
02292 <span class="comment">     */</span>
02293     <span class="keywordflow">if</span> (fWasNull)
02294         <a class="code" href="../../d4/d1/userk_8h.html#a127">UnlockDesktop</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o3">rpdeskStartup</a>,
02295                       LDU_PPI_DESKSTARTUP1, (ULONG_PTR)(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>));
02296 
02297     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a> &amp;&amp;
02298         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a329">gspdeskDisconnect</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
02299         pdesk == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a242">grpdeskLogon</a>) {
02300 
02301         UserAssert(hdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02302 
02303         <span class="comment">/*</span>
02304 <span class="comment">         * Create the 'disconnect' desktop</span>
02305 <span class="comment">         */</span>
02306         <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d6/desktop_8c.html#a14">xxxCreateDisconnectDesktop</a>(hwinsta, pwinsta)) {
02307             RIPMSG0(RIP_WARNING, <span class="stringliteral">"Failed to create the 'disconnect' desktop"</span>);
02308 
02309             <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdesk, LD_DEREF_FN_CREATEDESKTOP3, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
02310             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pdesk);
02311 
02312             <a class="code" href="../../d4/d1/userk_8h.html#a1803">xxxCloseDesktop</a>(hdesk, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>);
02313 
02314             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02315         }
02316 
02317         <span class="comment">/*</span>
02318 <span class="comment">         * Signal that the disconnect desktop got created.</span>
02319 <span class="comment">         */</span>
02320         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a19">gpEventDiconnectDesktop</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02321 
02322         <a class="code" href="../../d4/d1/userk_8h.html#a773">HYDRA_HINT</a>(<a class="code" href="../../d4/d1/userk_8h.html#a771">HH_DISCONNECTDESKTOP</a>);
02323     }
02324 
02325 Cleanup:
02326 
02327     <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdesk, LD_DEREF_FN_CREATEDESKTOP3, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
02328     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pdesk);
02329 
02330     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"xxxCreateDesktop: Leaving\n"</span>));
02331 
02332     <span class="keywordflow">if</span> (hdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02333         <a class="code" href="../../d4/d1/userk_8h.html#a2069">SetHandleFlag</a>(hdesk, <a class="code" href="../../d4/d1/userk_8h.html#a747">HF_PROTECTED</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02334     }
02335     <span class="keywordflow">return</span> hdesk;
02336 
02337 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>:
02338 
02339     <a class="code" href="../../d4/d1/userk_8h.html#a165">EndAtomicCheck</a>();
02340     UserAssert(dwCritSecUseSave == gdwCritSecUseCount);
02341     <a class="code" href="../../d4/d1/userk_8h.html#a617">zzzEndDeferWinEventNotify</a>();
02342 
02343     UserAssert(pwndMenu == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02344 
02345     <span class="keywordflow">if</span> (pwndTooltip != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02346         <a class="code" href="../../d4/d1/userk_8h.html#a1575">xxxDestroyWindow</a>(pwndTooltip);
02347         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pdesk-&gt;spwndTooltip);
02348     }
02349     <span class="keywordflow">if</span> (pwndMessage != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02350         <a class="code" href="../../d4/d1/userk_8h.html#a1575">xxxDestroyWindow</a>(pwndMessage);
02351         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pdesk-&gt;spwndMessage);
02352     }
02353     <span class="keywordflow">if</span> (pwndDesktop != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02354         <a class="code" href="../../d4/d1/userk_8h.html#a1575">xxxDestroyWindow</a>(pwndDesktop);
02355         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pdi-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>);
02356         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a15">gspwndFullScreen</a>);
02357     }
02358     <span class="comment">/*</span>
02359 <span class="comment">     * Restore caller's ppi</span>
02360 <span class="comment">     */</span>
02361     <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;ppi = ppiSave;
02362 
02363     UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a820">TIF_DISABLEHOOKS</a>);
02364     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> = (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a820">TIF_DISABLEHOOKS</a>) | dwDisableHooks;
02365     <a class="code" href="../../d4/d1/userk_8h.html#a1799">zzzSetDesktop</a>(ptiCurrent, pdeskTemp, hdeskTemp);
02366 
02367     <a class="code" href="../../d4/d1/userk_8h.html#a2073">CloseProtectedHandle</a>(hdesk);
02368     hdesk = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02369 
02370     <span class="comment">/*</span>
02371 <span class="comment">     * If it was null when we came in, make it null going out, or else</span>
02372 <span class="comment">     * we'll have the wrong desktop selected into this.</span>
02373 <span class="comment">     */</span>
02374     <span class="keywordflow">if</span> (fWasNull)
02375         <a class="code" href="../../d4/d1/userk_8h.html#a127">UnlockDesktop</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o3">rpdeskStartup</a>,
02376                       LDU_PPI_DESKSTARTUP1, (ULONG_PTR)(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>));
02377 
02378     <span class="keywordflow">goto</span> Cleanup;
02379 
02380 }
02381 
02382 <span class="comment">/***************************************************************************\</span>
02383 <span class="comment">* ParseDesktop</span>
02384 <span class="comment">*</span>
02385 <span class="comment">* Parse a desktop path.</span>
02386 <span class="comment">*</span>
02387 <span class="comment">* History:</span>
02388 <span class="comment">* 14-Jun-1995 JimA      Created.</span>
02389 <span class="comment">\***************************************************************************/</span>
02390 
<a name="l02391"></a><a class="code" href="../../d9/d6/desktop_8c.html#a17">02391</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d4/d1/userk_8h.html#a1292">ParseDesktop</a>(
02392     PVOID                        pContainerObject,
02393     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>                 pObjectType,
02394     <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>                pAccessState,
02395     KPROCESSOR_MODE              AccessMode,
02396     ULONG                        Attributes,
02397     PUNICODE_STRING              pstrCompleteName,
02398     PUNICODE_STRING              pstrRemainingName,
02399     PVOID                        Context,
02400     PSECURITY_QUALITY_OF_SERVICE pqos,
02401     PVOID                        *pObject)
02402 {
02403     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>  pwinsta = pContainerObject;
02404     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>        pdesk;
02405     PUNICODE_STRING pstrName;
02406     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_NOT_FOUND;
02407 
02408     *pObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02409 
02410     BEGIN_REENTERCRIT();
02411 
02412     UserAssert(<a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pContainerObject)-&gt;Type == *<a class="code" href="../../d3/d7/win32_8c.html#a0">ExWindowStationObjectType</a>);
02413     UserAssert(pObjectType == *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>);
02414 
02415     <span class="comment">/*</span>
02416 <span class="comment">     * See if the desktop exists</span>
02417 <span class="comment">     */</span>
02418     <span class="keywordflow">for</span> (pdesk = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a>; pdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pdesk = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o2">rpdeskNext</a>) {
02419         pstrName = <a class="code" href="../../d4/d1/userk_8h.html#a522">POBJECT_NAME</a>(pdesk);
02420         <span class="keywordflow">if</span> (pstrName &amp;&amp; <a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(pstrRemainingName, pstrName,
02421                 (BOOLEAN)((Attributes &amp; OBJ_CASE_INSENSITIVE) != 0))) {
02422             <span class="keywordflow">if</span> (Context != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02423                 <span class="keywordflow">if</span> (!(Attributes &amp; OBJ_OPENIF)) {
02424 
02425                     <span class="comment">/*</span>
02426 <span class="comment">                     * We are attempting to create a desktop and one</span>
02427 <span class="comment">                     * already exists.</span>
02428 <span class="comment">                     */</span>
02429                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_COLLISION;
02430                     <span class="keywordflow">goto</span> Exit;
02431 
02432                 } <span class="keywordflow">else</span> {
02433                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_EXISTS;
02434                 }
02435             } <span class="keywordflow">else</span> {
02436                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02437             }
02438 
02439             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(pdesk);
02440 
02441             *pObject = pdesk;
02442             <span class="keywordflow">goto</span> Exit;
02443         }
02444     }
02445 
02446     <span class="comment">/*</span>
02447 <span class="comment">     * Handle creation request</span>
02448 <span class="comment">     */</span>
02449     <span class="keywordflow">if</span> (Context != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02450         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d6/desktop_8c.html#a13">xxxCreateDesktop2</a>(pContainerObject,
02451                                    pAccessState,
02452                                    AccessMode,
02453                                    pstrRemainingName,
02454                                    Context,
02455                                    pObject);
02456     }
02457 
02458 Exit:
02459     END_REENTERCRIT();
02460 
02461     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02462 
02463     UNREFERENCED_PARAMETER(pObjectType);
02464     UNREFERENCED_PARAMETER(pstrCompleteName);
02465     UNREFERENCED_PARAMETER(pqos);
02466 }
02467 
02468 <span class="comment">/***************************************************************************\</span>
02469 <span class="comment">* DestroyDesktop</span>
02470 <span class="comment">*</span>
02471 <span class="comment">* Called upon last close of a desktop to remove the desktop from the</span>
02472 <span class="comment">* desktop list and free all desktop resources.</span>
02473 <span class="comment">*</span>
02474 <span class="comment">* History:</span>
02475 <span class="comment">* 08-Dec-1993 JimA      Created.</span>
02476 <span class="comment">\***************************************************************************/</span>
02477 
<a name="l02478"></a><a class="code" href="../../d9/d6/desktop_8c.html#a18">02478</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d6/desktop_8c.html#a18">DestroyDesktop</a>(
02479     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk)
02480 {
02481     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>;
02482     <a class="code" href="../../d1/d8/structtagTERMINAL.html">PTERMINAL</a>      pTerm;
02483     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>       *ppdesk;
02484 
02485     <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a287">DF_DESTROYED</a>) {
02486         RIPMSG1(RIP_WARNING, <span class="stringliteral">"DestroyDesktop: Already destroyed:%#p"</span>, pdesk);
02487         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02488     }
02489 
02490     <span class="comment">/*</span>
02491 <span class="comment">     * Unlink the desktop, if it has not yet been unlinked.</span>
02492 <span class="comment">     */</span>
02493     <span class="keywordflow">if</span> (pwinsta != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02494 
02495         ppdesk = &amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a>;
02496         <span class="keywordflow">while</span> (*ppdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; *ppdesk != pdesk) {
02497             ppdesk = &amp;((*ppdesk)-&gt;rpdeskNext);
02498         }
02499 
02500         <span class="keywordflow">if</span> (*ppdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02501 
02502             <span class="comment">/*</span>
02503 <span class="comment">             * remove desktop from the list</span>
02504 <span class="comment">             */</span>
02505             <a class="code" href="../../d4/d1/userk_8h.html#a126">LockDesktop</a>(ppdesk, pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o2">rpdeskNext</a>, LDL_WINSTA_DESKLIST2, (ULONG_PTR)pwinsta);
02506             <a class="code" href="../../d4/d1/userk_8h.html#a127">UnlockDesktop</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o2">rpdeskNext</a>, LDU_DESK_DESKNEXT, (ULONG_PTR)pwinsta);
02507         }
02508     }
02509 
02510     <span class="comment">/*</span>
02511 <span class="comment">     * Link it into the destruction list and signal the desktop thread.</span>
02512 <span class="comment">     */</span>
02513     pTerm = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>;
02514 
02515     <a class="code" href="../../d4/d1/userk_8h.html#a126">LockDesktop</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o2">rpdeskNext</a>, pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o6">rpdeskDestroy</a>, LDL_DESK_DESKNEXT2, 0);
02516     <a class="code" href="../../d4/d1/userk_8h.html#a126">LockDesktop</a>(&amp;pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o6">rpdeskDestroy</a>, pdesk, LDL_TERM_DESKDESTROY2, (ULONG_PTR)pTerm);
02517     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(pTerm-&gt;pEventDestroyDesktop, <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02518 
02519     pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a287">DF_DESTROYED</a>;
02520 
02521     <a class="code" href="../../d4/d1/userk_8h.html#a778">TRACE_DESKTOP</a>((<span class="stringliteral">"pdesk %#p '%ws' marked as destroyed\n"</span>, pdesk, GetDesktopName(pdesk)));
02522 
02523     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02524 }
02525 
02526 <span class="comment">/***************************************************************************\</span>
02527 <span class="comment">* FreeDesktop</span>
02528 <span class="comment">*</span>
02529 <span class="comment">* Called to free desktop object and section when last lock is released.</span>
02530 <span class="comment">*</span>
02531 <span class="comment">* History:</span>
02532 <span class="comment">* 08-Dec-1993 JimA      Created.</span>
02533 <span class="comment">\***************************************************************************/</span>
02534 
<a name="l02535"></a><a class="code" href="../../d9/d6/desktop_8c.html#a19">02535</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1291">FreeDesktop</a>(
02536     PVOID pobj)
02537 {
02538     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk = (<a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>)pobj;
02539     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02540 
02541     BEGIN_REENTERCRIT();
02542 
02543     UserAssert(<a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pobj)-&gt;Type == *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>);
02544 
02545 <span class="preprocessor">#ifdef LOGDESKTOPLOCKS</span>
02546 <span class="preprocessor"></span>
02547     <span class="keywordflow">if</span> (pdesk-&gt;pLog != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02548 
02549         <span class="comment">/*</span>
02550 <span class="comment">         * By the time we get here the lock count for lock/unlock</span>
02551 <span class="comment">         * tracking code should be 0</span>
02552 <span class="comment">         */</span>
02553         <span class="keywordflow">if</span> (pdesk-&gt;nLockCount != 0) {
02554             RIPMSG3(RIP_WARNING,
02555                     <span class="stringliteral">"FreeDesktop pdesk %#p, pLog %#p, nLockCount %d should be 0"</span>,
02556                     pdesk, pdesk-&gt;pLog, pdesk-&gt;nLockCount);
02557         }
02558         UserFreePool(pdesk-&gt;pLog);
02559         pdesk-&gt;pLog = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02560     }
02561 <span class="preprocessor">#endif // LOGDESKTOPLOCKS</span>
02562 <span class="preprocessor"></span>
02563 <span class="preprocessor">#if DBG</span>
02564 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a> &amp;&amp; (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02565 
02566         <span class="comment">/*</span>
02567 <span class="comment">         * assert if the desktop has a desktop window but the flag</span>
02568 <span class="comment">         * that says the window is destroyed is not set</span>
02569 <span class="comment">         */</span>
02570         UserAssert(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a286">DF_DESKWNDDESTROYED</a>);
02571     }
02572 <span class="preprocessor">#endif // DBG</span>
02573 <span class="preprocessor"></span>
02574     <span class="comment">/*</span>
02575 <span class="comment">     * Mark the desktop as dying.  Make sure we aren't recursing.</span>
02576 <span class="comment">     */</span>
02577     UserAssert(!(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a285">DF_DYING</a>));
02578     pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a285">DF_DYING</a>;
02579 
02580 <span class="preprocessor">#ifdef DEBUG_DESK</span>
02581 <span class="preprocessor"></span>    {
02582         <span class="comment">/*</span>
02583 <span class="comment">         * Verify that the desktop has been cleaned out.</span>
02584 <span class="comment">         */</span>
02585 <span class="preprocessor">#if 0</span>
02586 <span class="preprocessor"></span>        <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi;
02587         <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a> pcls, pclsClone;
02588 <span class="preprocessor">#endif</span>
02589 <span class="preprocessor"></span>        <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a> pheT, pheMax;
02590         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fDirty = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02591 
02592 <span class="preprocessor">#if 0</span>
02593 <span class="preprocessor"></span>        <span class="keywordflow">for</span> (ppi = gppiFirst; ppi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; ppi = ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o7">ppiNext</a>) {
02594             <span class="keywordflow">for</span> (pcls = ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o4">pclsPrivateList</a>; pcls != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pcls = pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o0">pclsNext</a>) {
02595                 <span class="keywordflow">if</span> (pcls-&gt;pheapDesktop == pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o16">pheapDesktop</a>) {
02596                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"ppi %08x private class at %08x exists\n"</span>, ppi, pcls);
02597                     fDirty = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02598                 }
02599                 <span class="keywordflow">for</span> (pclsClone = pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o12">pclsClone</a>; pclsClone != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02600                         pclsClone = pclsClone-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o0">pclsNext</a>) {
02601                     <span class="keywordflow">if</span> (pclsClone-&gt;pheapDesktop == pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o16">pheapDesktop</a>) {
02602                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"ppi %08x private class clone at %08x exists\n"</span>, ppi, pclsClone);
02603                         fDirty = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02604                     }
02605                 }
02606             }
02607             <span class="keywordflow">for</span> (pcls = ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o5">pclsPublicList</a>; pcls != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pcls = pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o0">pclsNext</a>) {
02608                 <span class="keywordflow">if</span> (pcls-&gt;pheapDesktop == pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o16">pheapDesktop</a>) {
02609                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"ppi %08x public class at %08x exists\n"</span>, ppi, pcls);
02610                     fDirty = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02611                 }
02612                 <span class="keywordflow">for</span> (pclsClone = pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o12">pclsClone</a>; pclsClone != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02613                         pclsClone = pclsClone-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o0">pclsNext</a>) {
02614                     <span class="keywordflow">if</span> (pclsClone-&gt;pheapDesktop == pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o16">pheapDesktop</a>) {
02615                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"ppi %08x public class clone at %08x exists\n"</span>, ppi, pclsClone);
02616                         fDirty = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02617                     }
02618                 }
02619             }
02620         }
02621 <span class="preprocessor">#endif</span>
02622 <span class="preprocessor"></span>
02623         pheMax = &amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>[<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a308">giheLast</a>];
02624         <span class="keywordflow">for</span> (pheT = <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>; pheT &lt;= pheMax; pheT++) {
02625             <span class="keywordflow">switch</span> (pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a>) {
02626                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a237">TYPE_WINDOW</a>:
02627                     <span class="keywordflow">if</span> (((<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>)-&gt;head.rpdesk == pdesk) {
02628                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Window at %08x exists\n"</span>, pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>);
02629                         <span class="keywordflow">break</span>;
02630                     }
02631                     <span class="keywordflow">continue</span>;
02632                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a238">TYPE_MENU</a>:
02633                     <span class="keywordflow">if</span> (((<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>)pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>)-&gt;head.rpdesk == pdesk) {
02634                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Menu at %08x exists\n"</span>, pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>);
02635                         <span class="keywordflow">break</span>;
02636                     }
02637                     <span class="keywordflow">continue</span>;
02638                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a243">TYPE_CALLPROC</a>:
02639                     <span class="keywordflow">if</span> (((<a class="code" href="../../d3/d7/struct__CALLPROCDATA.html">PCALLPROCDATA</a>)pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>)-&gt;head.rpdesk == pdesk) {
02640                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Callproc at %08x exists\n"</span>, pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>);
02641                         <span class="keywordflow">break</span>;
02642                     }
02643                     <span class="keywordflow">continue</span>;
02644                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a241">TYPE_HOOK</a>:
02645                     <span class="keywordflow">if</span> (((<a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a>)pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>)-&gt;head.rpdesk == pdesk) {
02646                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Hook at %08x exists\n"</span>, pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>);
02647                         <span class="keywordflow">break</span>;
02648                     }
02649                     <span class="keywordflow">continue</span>;
02650                 <span class="keywordflow">default</span>:
02651                     <span class="keywordflow">continue</span>;
02652             }
02653             fDirty = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02654         }
02655         <span class="keywordflow">if</span> (fDirty) {
02656             RIPMSG0(RIP_ERROR,<span class="stringliteral">"Desktop cleanup failed\n"</span>);
02657         }
02658     }
02659 <span class="preprocessor">#endif</span>
02660 <span class="preprocessor"></span>
02661     <span class="comment">/*</span>
02662 <span class="comment">     * If the desktop is mapped into CSR, unmap it.  Note the</span>
02663 <span class="comment">     * handle count values passed in will cause the desktop</span>
02664 <span class="comment">     * to be unmapped and skip the desktop destruction tests.</span>
02665 <span class="comment">     */</span>
02666     <a class="code" href="../../d9/d6/desktop_8c.html#a6">FreeView</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>, pdesk);
02667 
02668     <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o16">pheapDesktop</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02669 
02670         PVOID hheap = Win32HeapGetHandle(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o16">pheapDesktop</a>);
02671 
02672         Win32HeapDestroy(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o16">pheapDesktop</a>);
02673 
02674         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = Win32UnmapViewInSessionSpace(hheap);
02675 
02676         UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02677         Win32DestroySection(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o15">hsectionDesktop</a>);
02678     }
02679 
02680     <a class="code" href="../../d4/d1/userk_8h.html#a124">UnlockWinSta</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>);
02681 
02682     <a class="code" href="../../d4/d1/userk_8h.html#a775">DbgTrackRemoveDesktop</a>(pdesk);
02683 
02684     END_REENTERCRIT();
02685 }
02686 
02687 <span class="comment">/***************************************************************************\</span>
02688 <span class="comment">* CreateDesktopHeap</span>
02689 <span class="comment">*</span>
02690 <span class="comment">* Create a new desktop heap</span>
02691 <span class="comment">*</span>
02692 <span class="comment">* History:</span>
02693 <span class="comment">* 27-Jul-1992 JimA      Created.</span>
02694 <span class="comment">\***************************************************************************/</span>
02695 
<a name="l02696"></a><a class="code" href="../../d4/d1/userk_8h.html#a1534">02696</a> HANDLE <a class="code" href="../../d4/d1/userk_8h.html#a1534">CreateDesktopHeap</a>(
02697     PWIN32HEAP* ppheapRet,
02698     ULONG       ulHeapSize)
02699 {
02700     HANDLE        hsection;
02701     LARGE_INTEGER SectionSize;
02702     SIZE_T        ulViewSize;
02703     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>      <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02704     PWIN32HEAP    pheap;
02705     PVOID         pHeapBase;
02706 
02707     <span class="comment">/*</span>
02708 <span class="comment">     * Create desktop heap section and map it into the kernel</span>
02709 <span class="comment">     */</span>
02710     SectionSize.QuadPart = ulHeapSize;
02711 
02712     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = Win32CreateSection(&amp;hsection,
02713                                 SECTION_ALL_ACCESS,
02714                                 (POBJECT_ATTRIBUTES)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02715                                 &amp;SectionSize,
02716                                 PAGE_EXECUTE_READWRITE,
02717                                 SEC_RESERVE,
02718                                 (HANDLE)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02719                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02720                                 TAG_SECTION_DESKTOP);
02721 
02722     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
02723         RIPNTERR0(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, RIP_WARNING, <span class="stringliteral">"Can't create section for desktop heap."</span>);
02724         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02725     }
02726 
02727     ulViewSize = ulHeapSize;
02728     pHeapBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02729 
02730     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = Win32MapViewInSessionSpace(hsection, &amp;pHeapBase, &amp;ulViewSize);
02731 
02732     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02733         RIPNTERR0(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>,
02734                   RIP_WARNING,
02735                   <span class="stringliteral">"Can't map section for desktop heap into system space."</span>);
02736         <span class="keywordflow">goto</span> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>;
02737     }
02738 
02739     <span class="comment">/*</span>
02740 <span class="comment">     * Create desktop heap.</span>
02741 <span class="comment">     */</span>
02742     <span class="keywordflow">if</span> ((pheap = <a class="code" href="../../d4/d1/userk_8h.html#a999">UserCreateHeap</a>(
02743             hsection,
02744             0,
02745             pHeapBase,
02746             ulHeapSize,
02747             <a class="code" href="../../d2/d9/w32_2ntuser_2kernel_2heap_8c.html#a0">UserCommitDesktopMemory</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02748 
02749         RIPERR0(ERROR_NOT_ENOUGH_MEMORY, RIP_WARNING, <span class="stringliteral">"Can't create Desktop heap."</span>);
02750 
02751         Win32UnmapViewInSessionSpace(pHeapBase);
02752 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>:
02753         Win32DestroySection(hsection);
02754         *ppheapRet = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02755         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02756     }
02757 
02758     UserAssert(Win32HeapGetHandle(pheap) == pHeapBase);
02759     *ppheapRet = pheap;
02760 
02761     <span class="keywordflow">return</span> hsection;
02762 }
02763 
02764 <span class="comment">/***************************************************************************\</span>
02765 <span class="comment">* GetDesktopView</span>
02766 <span class="comment">*</span>
02767 <span class="comment">* Determines if a desktop has already been mapped into a process.</span>
02768 <span class="comment">*</span>
02769 <span class="comment">* History:</span>
02770 <span class="comment">* 10-Apr-1995 JimA      Created.</span>
02771 <span class="comment">\***************************************************************************/</span>
02772 
<a name="l02773"></a><a class="code" href="../../d4/d1/userk_8h.html#a1283">02773</a> <a class="code" href="../../d2/d3/structtagDESKTOPVIEW.html">PDESKTOPVIEW</a> <a class="code" href="../../d4/d1/userk_8h.html#a1283">GetDesktopView</a>(
02774     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi,
02775     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>     pdesk)
02776 {
02777     <a class="code" href="../../d2/d3/structtagDESKTOPVIEW.html">PDESKTOPVIEW</a> pdv;
02778 
02779     <span class="keywordflow">if</span>(ppi-&gt;Process != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a> &amp;&amp; pdesk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02780         RIPMSG1(RIP_WARNING, <span class="stringliteral">"Process %#p isn't CSRSS but pdesk is NULL in GetDesktopView"</span>, ppi);
02781     }
02782 
02783     <span class="keywordflow">for</span> (pdv = ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o19">pdvList</a>; pdv != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pdv = pdv-&gt;<a class="code" href="../../d2/d3/structtagDESKTOPVIEW.html#o0">pdvNext</a>)
02784         <span class="keywordflow">if</span> (pdv-&gt;<a class="code" href="../../d2/d3/structtagDESKTOPVIEW.html#o1">pdesk</a> == pdesk)
02785             <span class="keywordflow">break</span>;
02786     <span class="keywordflow">return</span> pdv;
02787 }
02788 
02789 <span class="comment">/***************************************************************************\</span>
02790 <span class="comment">* _MapDesktopObject</span>
02791 <span class="comment">*</span>
02792 <span class="comment">* Maps a desktop object into the client's address space</span>
02793 <span class="comment">*</span>
02794 <span class="comment">* History:</span>
02795 <span class="comment">* 11-Apr-1995 JimA      Created.</span>
02796 <span class="comment">\***************************************************************************/</span>
02797 
<a name="l02798"></a><a class="code" href="../../d4/d1/userk_8h.html#a1282">02798</a> PVOID <a class="code" href="../../d4/d1/userk_8h.html#a1282">_MapDesktopObject</a>(
02799     HANDLE h)
02800 {
02801     <a class="code" href="../../d8/d2/struct__DESKOBJHEAD.html">PDESKOBJHEAD</a>  pobj;
02802     <a class="code" href="../../d2/d3/structtagDESKTOPVIEW.html">PDESKTOPVIEW</a> pdv;
02803 
02804     <span class="comment">/*</span>
02805 <span class="comment">     * Validate the handle</span>
02806 <span class="comment">     */</span>
02807     pobj = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a6">HMValidateHandle</a>(h, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a255">TYPE_GENERIC</a>);
02808     <span class="keywordflow">if</span> (pobj == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02809         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02810 
02811     UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a437">HMObjectFlags</a>(pobj) &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a417">OCF_DESKTOPHEAP</a>);
02812 
02813     <span class="comment">/*</span>
02814 <span class="comment">     * Locate the client's view of the desktop.  Realistically,</span>
02815 <span class="comment">     * this should never fail for valid objects.</span>
02816 <span class="comment">     */</span>
02817     pdv = <a class="code" href="../../d4/d1/userk_8h.html#a1283">GetDesktopView</a>(<a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>(), pobj-&gt;rpdesk);
02818     <span class="keywordflow">if</span> (pdv == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02819         RIPMSG1(RIP_WARNING, <span class="stringliteral">"MapDesktopObject: can not map handle %#p"</span>, h);
02820         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02821     }
02822 
02823     UserAssert(pdv-&gt;<a class="code" href="../../d2/d3/structtagDESKTOPVIEW.html#o2">ulClientDelta</a> != 0);
02824     <span class="keywordflow">return</span> (PVOID)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pobj - pdv-&gt;<a class="code" href="../../d2/d3/structtagDESKTOPVIEW.html#o2">ulClientDelta</a>);
02825 }
02826 
02827 <span class="comment">/***************************************************************************\</span>
02828 <span class="comment">* MapDesktop</span>
02829 <span class="comment">*</span>
02830 <span class="comment">* Attempts to map a desktop heap into a process.</span>
02831 <span class="comment">*</span>
02832 <span class="comment">* History:</span>
02833 <span class="comment">* 20-Oct-1994 JimA      Created.</span>
02834 <span class="comment">\***************************************************************************/</span>
02835 
<a name="l02836"></a><a class="code" href="../../d9/d6/desktop_8c.html#a23">02836</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1289">MapDesktop</a>(
02837     <a class="code" href="../../d4/d0/ob_8h.html#a21">OB_OPEN_REASON</a> OpenReason,
02838     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>      Process,
02839     PVOID          pobj,
02840     ACCESS_MASK    amGranted,
02841     ULONG          cHandles)
02842 {
02843     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>  ppi;
02844     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>      pdesk = (<a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>)pobj;
02845     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>      <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02846     SIZE_T        ulViewSize;
02847     LARGE_INTEGER liOffset;
02848     <a class="code" href="../../d2/d3/structtagDESKTOPVIEW.html">PDESKTOPVIEW</a>  pdvNew;
02849     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>         pClientBase;
02850     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>          bFailed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02851 
02852     UserAssert(<a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pobj)-&gt;Type == *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>);
02853 
02854     <span class="comment">/*</span>
02855 <span class="comment">     * Ignore handle inheritance because MmMapViewOfSection</span>
02856 <span class="comment">     * cannot be called during process creation.</span>
02857 <span class="comment">     */</span>
02858     <span class="keywordflow">if</span> (OpenReason == <a class="code" href="../../d4/d0/ob_8h.html#a100a61">ObInheritHandle</a>)
02859         <span class="keywordflow">return</span>;
02860 
02861     <span class="comment">/*</span>
02862 <span class="comment">     * If there is no ppi, we can't map the desktop</span>
02863 <span class="comment">     */</span>
02864     ppi = <a class="code" href="../../d4/d1/userk_8h.html#a18">PpiFromProcess</a>(Process);
02865     <span class="keywordflow">if</span> (ppi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02866         <span class="keywordflow">return</span>;
02867 
02868     <span class="comment">/*</span>
02869 <span class="comment">     * If the desktop has already been mapped we're done.</span>
02870 <span class="comment">     */</span>
02871     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1283">GetDesktopView</a>(ppi, pdesk) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02872         <span class="keywordflow">return</span>;
02873 
02874     <span class="comment">/*</span>
02875 <span class="comment">     * Allocate a view of the desktop</span>
02876 <span class="comment">     */</span>
02877     pdvNew = UserAllocPoolWithQuota(<span class="keyword">sizeof</span>(*pdvNew), TAG_PROCESSINFO);
02878     <span class="keywordflow">if</span> (pdvNew == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02879         RIPERR0(ERROR_NOT_ENOUGH_MEMORY, RIP_VERBOSE, <span class="stringliteral">""</span>);
02880 
02881         <span class="comment">/*</span>
02882 <span class="comment">         * Raise an exception so that the object manager</span>
02883 <span class="comment">         * knows OpenProcedure wasn't successful</span>
02884 <span class="comment">         */</span>
02885         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_NO_MEMORY);
02886         <span class="keywordflow">return</span>;
02887     }
02888 
02889     BEGIN_REENTERCRIT();
02890 
02891     <span class="comment">/*</span>
02892 <span class="comment">     * Read/write access has been granted.  Map the desktop</span>
02893 <span class="comment">     * memory into the client process.</span>
02894 <span class="comment">     */</span>
02895     ulViewSize = 0;
02896     liOffset.QuadPart = 0;
02897     pClientBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02898 
02899     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a21">MmMapViewOfSection</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o15">hsectionDesktop</a>,
02900                                 Process,
02901                                 &amp;pClientBase,
02902                                 0,
02903                                 0,
02904                                 &amp;liOffset,
02905                                 &amp;ulViewSize,
02906                                 ViewUnmap,
02907                                 SEC_NO_CHANGE,
02908                                 PAGE_EXECUTE_READ);
02909 
02910     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02911 <span class="preprocessor">#if DBG</span>
02912 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_NO_MEMORY &amp;&amp;
02913                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_PROCESS_IS_TERMINATING &amp;&amp;
02914                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_COMMITMENT_LIMIT) {
02915             RIPMSG1(RIP_WARNING, <span class="stringliteral">"MapDesktop - failed to map to client process (status == %lX). Contact ChrisWil"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02916         }
02917 <span class="preprocessor">#endif</span>
02918 <span class="preprocessor"></span>
02919         RIPNTERR0(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, RIP_VERBOSE, <span class="stringliteral">""</span>);
02920         UserFreePool(pdvNew);
02921         bFailed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02922         <span class="keywordflow">goto</span> Exit;
02923     }
02924 
02925     <span class="comment">/*</span>
02926 <span class="comment">     * Link the view into the ppi</span>
02927 <span class="comment">     */</span>
02928     pdvNew-&gt;pdesk         = pdesk;
02929     pdvNew-&gt;ulClientDelta = (ULONG_PTR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)Win32HeapGetHandle(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o16">pheapDesktop</a>) - pClientBase);
02930     pdvNew-&gt;pdvNext       = ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o19">pdvList</a>;
02931     ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o19">pdvList</a>          = pdvNew;
02932 
02933 Exit:
02934     END_REENTERCRIT();
02935 
02936     <span class="comment">/*</span>
02937 <span class="comment">     * If something failed raise an exception so that the object manager</span>
02938 <span class="comment">     * knows OpenProcedure wasn't successful</span>
02939 <span class="comment">     */</span>
02940     <span class="keywordflow">if</span> (bFailed) {
02941         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_NO_MEMORY);
02942     }
02943 
02944     UNREFERENCED_PARAMETER(cHandles);
02945     UNREFERENCED_PARAMETER(amGranted);
02946 }
02947 
02948 
<a name="l02949"></a><a class="code" href="../../d9/d6/desktop_8c.html#a6">02949</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d6/desktop_8c.html#a6">FreeView</a>(
02950     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
02951     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk)
02952 {
02953     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi;
02954     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02955     <a class="code" href="../../d2/d3/structtagDESKTOPVIEW.html">PDESKTOPVIEW</a> pdv;
02956     <a class="code" href="../../d2/d3/structtagDESKTOPVIEW.html">PDESKTOPVIEW</a> *ppdv;
02957 
02958     <span class="comment">/*</span>
02959 <span class="comment">     * Bug 277291: gpepCSRSS can be NULL when FreeView is</span>
02960 <span class="comment">     * called from FreeDesktop.</span>
02961 <span class="comment">     */</span>
02962     <span class="keywordflow">if</span> (Process == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02963         <span class="keywordflow">return</span>;
02964     }
02965 
02966     ppi = <a class="code" href="../../d4/d1/userk_8h.html#a18">PpiFromProcess</a>(Process);
02967 
02968     <span class="comment">/*</span>
02969 <span class="comment">     * If there is no ppi, then the process is gone and nothing</span>
02970 <span class="comment">     * needs to be unmapped.</span>
02971 <span class="comment">     */</span>
02972     <span class="keywordflow">if</span> (ppi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02973         pdv = <a class="code" href="../../d4/d1/userk_8h.html#a1283">GetDesktopView</a>(ppi, pdesk);
02974 
02975         <span class="comment">/*</span>
02976 <span class="comment">         * Because mapping cannot be done when a handle is</span>
02977 <span class="comment">         * inherited, there may not be a view of the desktop.</span>
02978 <span class="comment">         * Only unmap if there is a view.</span>
02979 <span class="comment">         */</span>
02980         <span class="keywordflow">if</span> (pdv != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02981             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d9/umapview_8c.html#a1">MmUnmapViewOfSection</a>(Process,
02982                     (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)Win32HeapGetHandle(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o16">pheapDesktop</a>) - pdv-&gt;<a class="code" href="../../d2/d3/structtagDESKTOPVIEW.html#o2">ulClientDelta</a>);
02983             UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) || <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PROCESS_IS_TERMINATING);
02984             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02985                 RIPMSG1(RIP_WARNING, <span class="stringliteral">"FreeView unmap status = 0x%#lx"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02986             }
02987 
02988             <span class="comment">/*</span>
02989 <span class="comment">             * Unlink and delete the view.</span>
02990 <span class="comment">             */</span>
02991             <span class="keywordflow">for</span> (ppdv = &amp;ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o19">pdvList</a>; *ppdv &amp;&amp; *ppdv != pdv;
02992                     ppdv = &amp;(*ppdv)-&gt;<a class="code" href="../../d2/d3/structtagDESKTOPVIEW.html#o0">pdvNext</a>)
02993                 ;
02994             UserAssert(*ppdv);
02995              *ppdv = pdv-&gt;<a class="code" href="../../d2/d3/structtagDESKTOPVIEW.html#o0">pdvNext</a>;
02996             UserFreePool(pdv);
02997         }
02998 
02999 <span class="preprocessor">#if DBG</span>
03000 <span class="preprocessor"></span>        <span class="comment">/*</span>
03001 <span class="comment">         * No thread in this process should be on this desktop</span>
03002 <span class="comment">         */</span>
03003         {
03004             <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti = ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o1">ptiList</a>;
03005             <span class="keywordflow">while</span> (pti != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03006                 <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == pdesk) {
03007                     RIPMSG2(RIP_ERROR, <span class="stringliteral">"FreeView: pti %#p still on pdesk %#p"</span>, pti, pdesk);
03008                 }
03009                 pti = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o29">ptiSibling</a>;
03010             }
03011         }
03012 <span class="preprocessor">#endif</span>
03013 <span class="preprocessor"></span>    }
03014 }
03015 
03016 
<a name="l03017"></a><a class="code" href="../../d9/d6/desktop_8c.html#a24">03017</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1290">UnmapDesktop</a>(
03018     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>   Process,
03019     PVOID       pobj,
03020     ACCESS_MASK amGranted,
03021     ULONG       cProcessHandles,
03022     ULONG       cSystemHandles)
03023 {
03024     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk = (<a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>)pobj;
03025 
03026     BEGIN_REENTERCRIT();
03027 
03028     UserAssert(<a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pobj)-&gt;Type == *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>);
03029 
03030     <span class="comment">/*</span>
03031 <span class="comment">     * Update cSystemHandles with the correct information</span>
03032 <span class="comment">     */</span>
03033     cSystemHandles = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pobj)-&gt;HandleCount + 1;
03034 
03035     <span class="comment">/*</span>
03036 <span class="comment">     * Only unmap the desktop if this is the last process handle and</span>
03037 <span class="comment">     * the process is not CSR.</span>
03038 <span class="comment">     */</span>
03039     <span class="keywordflow">if</span> (cProcessHandles == 1 &amp;&amp; Process != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>) {
03040         <a class="code" href="../../d9/d6/desktop_8c.html#a6">FreeView</a>(Process, pdesk);
03041     }
03042 
03043     <span class="keywordflow">if</span> (cSystemHandles &gt; 2)
03044         <span class="keywordflow">goto</span> Exit;
03045 
03046     <span class="keywordflow">if</span> (cSystemHandles == 2 &amp;&amp; pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o17">dwConsoleThreadId</a> != 0) {
03047 
03048         <span class="comment">/*</span>
03049 <span class="comment">         * If a console thread exists and we're down to two handles,</span>
03050 <span class="comment">         * it means that the last application handle to the</span>
03051 <span class="comment">         * desktop is being closed.  Terminate the console</span>
03052 <span class="comment">         * thread so the desktop can be freed.</span>
03053 <span class="comment">         */</span>
03054         <a class="code" href="../../d4/d1/userk_8h.html#a1284">TerminateConsole</a>(pdesk);
03055     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cSystemHandles == 1) {
03056 
03057         <span class="comment">/*</span>
03058 <span class="comment">         * If this is the last handle to this desktop in the system,</span>
03059 <span class="comment">         * destroy the desktop.</span>
03060 <span class="comment">         */</span>
03061 
03062         <span class="comment">/*</span>
03063 <span class="comment">         * No pti should be linked to this desktop.</span>
03064 <span class="comment">         */</span>
03065         <span class="keywordflow">if</span> ((&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o20">PtiList</a> != pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o20">PtiList</a>.Flink)
03066                 || (&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o20">PtiList</a> != pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o20">PtiList</a>.Blink)) {
03067 
03068             RIPMSG1(RIP_WARNING, <span class="stringliteral">"UnmapDesktop: PtiList not Empty. pdesk:%#p"</span>, pdesk);
03069         }
03070 
03071         <a class="code" href="../../d9/d6/desktop_8c.html#a18">DestroyDesktop</a>(pdesk);
03072     }
03073 
03074 Exit:
03075     END_REENTERCRIT();
03076 
03077     UNREFERENCED_PARAMETER(amGranted);
03078 }
03079 
03080 <span class="comment">/***************************************************************************\</span>
03081 <span class="comment">* OkayToCloseDesktop</span>
03082 <span class="comment">*</span>
03083 <span class="comment">* We can only close desktop handles if they're not in use.</span>
03084 <span class="comment">*</span>
03085 <span class="comment">* History:</span>
03086 <span class="comment">* 08-Feb-1999 JerrySh   Created.</span>
03087 <span class="comment">\***************************************************************************/</span>
03088 
<a name="l03089"></a><a class="code" href="../../d9/d6/desktop_8c.html#a25">03089</a> BOOLEAN <a class="code" href="../../d4/d1/userk_8h.html#a1293">OkayToCloseDesktop</a>(
03090     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process OPTIONAL,
03091     PVOID Object,
03092     HANDLE Handle)
03093 {
03094     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk = (<a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>)Object;
03095 
03096     UNREFERENCED_PARAMETER(Process);
03097 
03098     UserAssert(<a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(Object)-&gt;Type == *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>);
03099 
03100     <span class="comment">/*</span>
03101 <span class="comment">     * Kernel mode code can close anything.</span>
03102 <span class="comment">     */</span>
03103     <span class="keywordflow">if</span> (KeGetPreviousMode() == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
03104         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03105     }
03106 
03107     <span class="comment">/*</span>
03108 <span class="comment">     * We can't close the desktop if we're still initializing it.</span>
03109 <span class="comment">     */</span>
03110     <span class="keywordflow">if</span> (!(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a298">DF_DESKCREATED</a>)) {
03111         RIPMSG1(RIP_WARNING, <span class="stringliteral">"Trying to close desktop %#p during initialization"</span>, pdesk);
03112         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03113     }
03114 
03115     <span class="comment">/*</span>
03116 <span class="comment">     * We can't close a desktop that's being used.</span>
03117 <span class="comment">     */</span>
03118     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a2072">CheckHandleInUse</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>) || <a class="code" href="../../d4/d1/userk_8h.html#a2070">CheckHandleFlag</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>, <a class="code" href="../../d4/d1/userk_8h.html#a747">HF_PROTECTED</a>)) {
03119         RIPMSG1(RIP_WARNING, <span class="stringliteral">"Trying to close desktop %#p while still in use"</span>, pdesk);
03120         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03121     }
03122 
03123     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03124 }
03125 
03126 <span class="comment">/***************************************************************************\</span>
03127 <span class="comment">* xxxUserResetDisplayDevice</span>
03128 <span class="comment">*</span>
03129 <span class="comment">* Called to reset the display device after a switch to another device.</span>
03130 <span class="comment">* Used when opening a new device, or when switching back to an old desktop</span>
03131 <span class="comment">*</span>
03132 <span class="comment">* History:</span>
03133 <span class="comment">* 31-May-1994 AndreVa   Created.</span>
03134 <span class="comment">\***************************************************************************/</span>
03135 
<a name="l03136"></a><a class="code" href="../../d4/d1/userk_8h.html#a1267">03136</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d6/desktop_8c.html#a26">xxxUserResetDisplayDevice</a>()
03137 {
03138     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
03139     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"xxxUserResetDisplayDevice: about to reset the device\n"</span>));
03140 
03141     <span class="comment">/*</span>
03142 <span class="comment">     * Handle early system initialization gracefully.</span>
03143 <span class="comment">     */</span>
03144     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03145         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>, &amp;tlpwnd);
03146 <span class="preprocessor">#if 0</span>
03147 <span class="preprocessor"></span>        <span class="comment">// what should we do here to notify the display applet ?</span>
03148         <span class="comment">// AndreVa</span>
03149 
03150         <span class="comment">/*</span>
03151 <span class="comment">         * Broadcast that the display has changed resolution.  We are going</span>
03152 <span class="comment">         * to specify the desktop for the changing-desktop.  That way we</span>
03153 <span class="comment">         * don't get confused as to what desktop to broadcast to.</span>
03154 <span class="comment">         */</span>
03155         <a class="code" href="../../d4/d1/userk_8h.html#a1475">xxxBroadcastMessage</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>,
03156                             WM_DISPLAYCHANGE,
03157                             <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;BitCount,
03158                             MAKELONG(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXSCREEN), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYSCREEN)),
03159                             <a class="code" href="../../d4/d1/userk_8h.html#a444">BMSG_SENDNOTIFYMSG</a>,
03160                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03161 <span class="preprocessor">#endif</span>
03162 <span class="preprocessor"></span>        <a class="code" href="../../d4/d1/userk_8h.html#a1679">xxxRedrawWindow</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>,
03163                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03164                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03165                         RDW_INVALIDATE | RDW_ERASE | RDW_ERASENOW |
03166                             RDW_ALLCHILDREN);
03167         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a31">gpqCursor</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03168 
03169         <span class="comment">/*</span>
03170 <span class="comment">         * No need to DeferWinEventNotify() - we just made an xxx call above</span>
03171 <span class="comment">         */</span>
03172         <a class="code" href="../../d4/d1/userk_8h.html#a1179">zzzInternalSetCursorPos</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor.x, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor.y);
03173 
03174         <a class="code" href="../../d4/d1/userk_8h.html#a1790">SetPointer</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03175 
03176         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
03177     }
03178 
03179     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"xxxUserResetDisplayDevice: complete\n"</span>));
03180 
03181 }
03182 
03183 <span class="comment">/***************************************************************************\</span>
03184 <span class="comment">* OpenDesktopCompletion</span>
03185 <span class="comment">*</span>
03186 <span class="comment">* Verifies that a given desktop has successfully opened.</span>
03187 <span class="comment">*</span>
03188 <span class="comment">* History:</span>
03189 <span class="comment">* 03-Oct-1995 JimA      Created.</span>
03190 <span class="comment">\***************************************************************************/</span>
03191 
<a name="l03192"></a><a class="code" href="../../d4/d1/userk_8h.html#a1797">03192</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1797">OpenDesktopCompletion</a>(
03193     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk,
03194     HDESK    hdesk,
03195     DWORD    dwFlags,
03196     BOOL*    pbShutDown)
03197 {
03198     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>   ppi = <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>();
03199     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
03200     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>           fMapped;
03201 
03202     <span class="comment">/*</span>
03203 <span class="comment">     * If the desktop was not mapped in as a result of the open,</span>
03204 <span class="comment">     * fail.</span>
03205 <span class="comment">     */</span>
03206     fMapped = (<a class="code" href="../../d4/d1/userk_8h.html#a1283">GetDesktopView</a>(ppi, pdesk) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03207     <span class="keywordflow">if</span> (!fMapped) {
03208 
03209         RIPMSG0(RIP_WARNING, <span class="stringliteral">"OpenDesktopCompletion failed."</span>
03210                 <span class="stringliteral">" The desktop is not mapped"</span>);
03211 
03212         <span class="comment">/*</span>
03213 <span class="comment">         * Desktop mapping failed.  Status is set by MapDesktop</span>
03214 <span class="comment">         */</span>
03215         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03216     } <span class="keywordflow">else</span> {
03217 
03218         <span class="comment">/*</span>
03219 <span class="comment">         * Fail if the windowstation is locked</span>
03220 <span class="comment">         */</span>
03221         pwinsta = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>;
03222         <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a315">WSF_OPENLOCK</a> &amp;&amp;
03223                 ppi-&gt;Process-&gt;UniqueProcessId != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a>) {
03224             LUID luidCaller;
03225             <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03226 
03227             <span class="comment">/*</span>
03228 <span class="comment">             * If logoff is occuring and the caller does not</span>
03229 <span class="comment">             * belong to the session that is ending, allow the</span>
03230 <span class="comment">             * open to proceed.</span>
03231 <span class="comment">             */</span>
03232             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a961">GetProcessLuid</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;luidCaller);
03233 
03234             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ||
03235                     (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a319">WSF_REALSHUTDOWN</a>) ||
03236                     <a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;luidCaller, &amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o17">luidEndSession</a>)) {
03237 
03238                 RIPERR0(ERROR_BUSY, RIP_WARNING, <span class="stringliteral">"OpenDesktopCompletion failed"</span>);
03239 
03240                 <span class="comment">/*</span>
03241 <span class="comment">                 * Set the shut down flag</span>
03242 <span class="comment">                 */</span>
03243                 *pbShutDown = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03244                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03245             }
03246         }
03247     }
03248 
03249     <a class="code" href="../../d4/d1/userk_8h.html#a2069">SetHandleFlag</a>(hdesk, <a class="code" href="../../d4/d1/userk_8h.html#a746">HF_DESKTOPHOOK</a>, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; DF_ALLOWOTHERACCOUNTHOOK);
03250 
03251     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03252 }
03253 
03254 <span class="comment">/***************************************************************************\</span>
03255 <span class="comment">* xxxOpenDesktop (API)</span>
03256 <span class="comment">*</span>
03257 <span class="comment">* Open a desktop object.  This is an 'xxx' function because it leaves the</span>
03258 <span class="comment">* critical section while waiting for the windowstation desktop open lock</span>
03259 <span class="comment">* to be available.</span>
03260 <span class="comment">*</span>
03261 <span class="comment">* History:</span>
03262 <span class="comment">* 16-Jan-1991 JimA      Created scaffold code.</span>
03263 <span class="comment">\***************************************************************************/</span>
03264 
<a name="l03265"></a><a class="code" href="../../d4/d1/userk_8h.html#a1796">03265</a> HDESK <a class="code" href="../../d4/d1/userk_8h.html#a1796">xxxOpenDesktop</a>(
03266     POBJECT_ATTRIBUTES ccxObjA,
03267     KPROCESSOR_MODE    AccessMode,
03268     DWORD              dwFlags,
03269     DWORD              dwDesiredAccess,
03270     BOOL*              pbShutDown)
03271 {
03272     HDESK    hdesk;
03273     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk;
03274     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03275 
03276     <span class="comment">/*</span>
03277 <span class="comment">     * Require read/write access</span>
03278 <span class="comment">     */</span>
03279     dwDesiredAccess |= DESKTOP_READOBJECTS | DESKTOP_WRITEOBJECTS;
03280 
03281     <span class="comment">/*</span>
03282 <span class="comment">     * Open the desktop -- Ob routines capture Obj attributes.</span>
03283 <span class="comment">     */</span>
03284     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>(
03285             ccxObjA,
03286             *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>,
03287             AccessMode,
03288             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03289             dwDesiredAccess,
03290             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03291             &amp;hdesk);
03292     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03293         RIPNTERR0(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, RIP_VERBOSE, <span class="stringliteral">""</span>);
03294         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03295     }
03296 
03297     <span class="comment">/*</span>
03298 <span class="comment">     * Reference the desktop</span>
03299 <span class="comment">     */</span>
03300     <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
03301             hdesk,
03302             0,
03303             *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>,
03304             <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
03305             &amp;pdesk,
03306             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03307     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03308         RIPNTERR0(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, RIP_VERBOSE, <span class="stringliteral">""</span>);
03309 
03310 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>:
03311         <a class="code" href="../../d4/d1/userk_8h.html#a2073">CloseProtectedHandle</a>(hdesk);
03312         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03313     }
03314 
03315     <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o25">dwSessionId</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a327">gSessionId</a>) {
03316         RIPNTERR1(STATUS_INVALID_HANDLE, RIP_WARNING,
03317                   <span class="stringliteral">"xxxOpenDesktop pdesk %#p belongs to a different session"</span>,
03318                   pdesk);
03319         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pdesk);
03320         <span class="keywordflow">goto</span> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>;
03321     }
03322 
03323     <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdesk, LD_REF_FN_OPENDESKTOP, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
03324 
03325     <span class="comment">/*</span>
03326 <span class="comment">     * Complete the desktop open</span>
03327 <span class="comment">     */</span>
03328     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1797">OpenDesktopCompletion</a>(pdesk, hdesk, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>, pbShutDown)) {
03329         <a class="code" href="../../d4/d1/userk_8h.html#a2073">CloseProtectedHandle</a>(hdesk);
03330         hdesk = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03331     }
03332 
03333     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"xxxOpenDesktop: Leaving\n"</span>));
03334 
03335     <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdesk, LD_DEREF_FN_OPENDESKTOP, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
03336     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pdesk);
03337 
03338     <span class="keywordflow">if</span> (hdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03339         <a class="code" href="../../d4/d1/userk_8h.html#a2069">SetHandleFlag</a>(hdesk, <a class="code" href="../../d4/d1/userk_8h.html#a747">HF_PROTECTED</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03340     }
03341 
03342     <span class="keywordflow">return</span> hdesk;
03343 }
03344 
03345 <span class="comment">/***************************************************************************\</span>
03346 <span class="comment">* xxxSwitchDesktop (API)</span>
03347 <span class="comment">*</span>
03348 <span class="comment">* Switch input focus to another desktop and bring it to the top of the</span>
03349 <span class="comment">* desktops</span>
03350 <span class="comment">*</span>
03351 <span class="comment">* bCreateNew is set when a new desktop has been created on the device, and</span>
03352 <span class="comment">* when we do not want to send another enable\disable</span>
03353 <span class="comment">*</span>
03354 <span class="comment">* History:</span>
03355 <span class="comment">* 16-Jan-1991 JimA      Created scaffold code.</span>
03356 <span class="comment">\***************************************************************************/</span>
03357 
<a name="l03358"></a><a class="code" href="../../d4/d1/userk_8h.html#a1798">03358</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1798">xxxSwitchDesktop</a>(
03359     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta,
03360     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>       pdesk,
03361     BOOL           bCreateNew)
03362 {
03363     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>    Thread;
03364     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndSetForeground;
03365     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlpwndChild;
03366     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlpwnd;
03367     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlhdesk;
03368     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a>          pq;
03369     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        bUpdateCursor = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03370     PLIST_ENTRY pHead, pEntry;
03371     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
03372     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
03373     <a class="code" href="../../d1/d8/structtagTERMINAL.html">PTERMINAL</a>   pTerm;
03374     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03375     HDESK       hdesk;
03376 
03377     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
03378 
03379     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
03380 
03381     <span class="keywordflow">if</span> (pdesk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03382         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03383     }
03384 
03385     <span class="keywordflow">if</span> (pdesk == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>) {
03386         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03387     }
03388 
03389     <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a287">DF_DESTROYED</a>) {
03390         RIPMSG1(RIP_ERROR, <span class="stringliteral">"xxxSwitchDesktop: destroyed:%#p"</span>, pdesk);
03391         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03392     }
03393 
03394     UserAssert(!(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; (<a class="code" href="../../d4/d1/userk_8h.html#a286">DF_DESKWNDDESTROYED</a> | <a class="code" href="../../d4/d1/userk_8h.html#a285">DF_DYING</a>)));
03395 
03396     <span class="keywordflow">if</span> (pwinsta == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03397         pwinsta = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>;
03398 
03399     <span class="comment">/*</span>
03400 <span class="comment">     * Get the windowstation, and assert if this process doesn't have one.</span>
03401 <span class="comment">     */</span>
03402     UserAssert(pwinsta);
03403     <span class="keywordflow">if</span> (pwinsta == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03404         RIPMSG1(RIP_WARNING,
03405                 <span class="stringliteral">"xxxSwitchDesktop: failed for pwinsta NULL pdesk %#p"</span>, pdesk);
03406         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03407     }
03408 
03409     <span class="comment">/*</span>
03410 <span class="comment">     * Don't allow invisible desktops to become active</span>
03411 <span class="comment">     */</span>
03412     <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>) {
03413         RIPMSG1(RIP_VERBOSE,
03414                 <span class="stringliteral">"xxxSwitchDesktop: failed for NOIO pdesk %#p"</span>, pdesk);
03415         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03416     }
03417 
03418     pTerm = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>;
03419 
03420     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> == pwinsta-&gt;pdeskCurrent);
03421 
03422     <span class="comment">/*</span>
03423 <span class="comment">     * Do tracing only if compiled in.</span>
03424 <span class="comment">     */</span>
03425     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"xxxSwitchDesktop: Entering, desktop = %ws, createdNew = %01lx\n"</span>, <a class="code" href="../../d4/d1/userk_8h.html#a522">POBJECT_NAME</a>(pdesk), (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)bCreateNew));
03426     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>) {
03427         <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"               coming from desktop = %ws\n"</span>, <a class="code" href="../../d4/d1/userk_8h.html#a522">POBJECT_NAME</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>)));
03428     }
03429 
03430     <span class="comment">/*</span>
03431 <span class="comment">     * Wait if the logon has the windowstation locked</span>
03432 <span class="comment">     */</span>
03433     Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
03434 
03435     <span class="comment">/*</span>
03436 <span class="comment">     * Allow switches to the disconnected desktop</span>
03437 <span class="comment">     */</span>
03438     <span class="keywordflow">if</span> (pdesk != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a329">gspdeskDisconnect</a>)
03439         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(Thread) &amp;&amp; pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a314">WSF_SWITCHLOCK</a> &amp;&amp;
03440                 pdesk != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a242">grpdeskLogon</a> &amp;&amp;
03441                 Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueProcess != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a>)
03442             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03443 
03444     <span class="comment">/*</span>
03445 <span class="comment">     * We don't allow switching away from the disconnect desktop.</span>
03446 <span class="comment">     */</span>
03447     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a331">gbDesktopLocked</a> &amp;&amp; ((!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a329">gspdeskDisconnect</a>) || (pdesk != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a329">gspdeskDisconnect</a>))) {
03448         <a class="code" href="../../d4/d1/userk_8h.html#a778">TRACE_DESKTOP</a>((<span class="stringliteral">"Attempt to switch away from the disconnect desktop\n"</span>));
03449 
03450         <span class="comment">/*</span>
03451 <span class="comment">         * we should not lock this global !!! clupu</span>
03452 <span class="comment">         */</span>
03453         <a class="code" href="../../d4/d1/userk_8h.html#a126">LockDesktop</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a330">gspdeskShouldBeForeground</a>, pdesk, LDL_DESKSHOULDBEFOREGROUND1, 0);
03454         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03455     }
03456 
03457     <span class="comment">/*</span>
03458 <span class="comment">     * HACKHACK LATER !!!</span>
03459 <span class="comment">     * Where should we really switch the desktop ...</span>
03460 <span class="comment">     * And we need to send repaint messages to everyone...</span>
03461 <span class="comment">     *</span>
03462 <span class="comment">     */</span>
03463 
03464     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> == pwinsta-&gt;pdeskCurrent);
03465 
03466     <span class="keywordflow">if</span> (!bCreateNew &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> &amp;&amp;
03467         (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a> != pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>)) {
03468 
03469         <span class="keywordflow">if</span> (!DrvDisableMDEV(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03470             RIPMSG1(RIP_WARNING, <span class="stringliteral">"xxxSwitchDesktop: DrvDisableMDEV failed for pdesk %#p"</span>,
03471                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>);
03472             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03473         }
03474         DrvEnableMDEV(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03475         bUpdateCursor = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03476 
03477     }
03478 
03479     <span class="comment">/*</span>
03480 <span class="comment">     * Grab a handle to the pdesk</span>
03481 <span class="comment">     */</span>
03482     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a3">ObOpenObjectByPointer</a>(pdesk,
03483                                    0,
03484                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03485                                    EVENT_ALL_ACCESS,
03486                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03487                                    <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
03488                                    &amp;hdesk);
03489     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03490 
03491         RIPMSG2(RIP_ERROR, <span class="stringliteral">"Could not get a handle for pdesk %#p Status %x"</span>,
03492                 pdesk, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03493         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03494     }
03495 
03496     <a class="code" href="../../d4/d1/userk_8h.html#a143">ThreadLockDesktopHandle</a>(ptiCurrent, &amp;tlhdesk, hdesk);
03497 
03498 <span class="preprocessor">#if DBG</span>
03499 <span class="preprocessor"></span>    <span class="comment">/*</span>
03500 <span class="comment">     * The current desktop is now the new desktop.</span>
03501 <span class="comment">     */</span>
03502     pwinsta-&gt;pdeskCurrent = pdesk;
03503 <span class="preprocessor">#endif // DBG</span>
03504 <span class="preprocessor"></span>
03505     <span class="comment">/*</span>
03506 <span class="comment">     * Kill any journalling that is occuring.  If an app is journaling to</span>
03507 <span class="comment">     * the CoolSwitch window, zzzCancelJournalling() will kill the window.</span>
03508 <span class="comment">     */</span>
03509     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03510         <a class="code" href="../../d1/d2/hooks_8c.html#a13">zzzCancelJournalling</a>();
03511 
03512     <span class="comment">/*</span>
03513 <span class="comment">     * Remove the cool switch window if it's on the RIT.  Sending the message</span>
03514 <span class="comment">     * is OK because the destination is the RIT, which should never block.</span>
03515 <span class="comment">     */</span>
03516     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03517 
03518         <a class="code" href="../../d5/d1/struct__TL.html">TL</a>   tlpwndT;
03519 
03520         <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a>, &amp;tlpwndT);
03521         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a>, WM_CLOSE, 0, 0);
03522         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
03523     }
03524 
03525     <span class="comment">/*</span>
03526 <span class="comment">     * Remove all trace of previous active window.</span>
03527 <span class="comment">     */</span>
03528     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03529 
03530         UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o11">spwndForeground</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03531 
03532         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03533             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03534 
03535                 <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o11">spwndForeground</a>,
03536                         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>);
03537 
03538             <span class="comment">/*</span>
03539 <span class="comment">             * This is an API so ptiCurrent can pretty much be on any</span>
03540 <span class="comment">             *  state; it might not be in grpdeskRitInput (current) or</span>
03541 <span class="comment">             *  pdesk (the one we're switching to). It can be sharing its</span>
03542 <span class="comment">             *  queue with other threads from another desktop.</span>
03543 <span class="comment">             * This is tricky because we're calling xxxSetForegroundWindow</span>
03544 <span class="comment">             *  and xxxSetWindowPos but PtiCurrent might be on whatever</span>
03545 <span class="comment">             *  desktop. We cannot cleanly switch ptiCurrent to the proper</span>
03546 <span class="comment">             *  desktop because it might be sharing its queue with other</span>
03547 <span class="comment">             *  threads, own windows, hooks, etc. So this is kind of broken.</span>
03548 <span class="comment">             *</span>
03549 <span class="comment">             * Old Comment:</span>
03550 <span class="comment">             * Fixup the current-thread (system) desktop.  This</span>
03551 <span class="comment">             * could be needed in case the xxxSetForegroundWindow()</span>
03552 <span class="comment">             * calls xxxDeactivate().  There is logic in their which</span>
03553 <span class="comment">             * requires the desktop.  This is only needed temporarily</span>
03554 <span class="comment">             * for this case.</span>
03555 <span class="comment">             *</span>
03556 <span class="comment">             * We would only go into xxxDeactivate if</span>
03557 <span class="comment">             *  ptiCurrent-&gt;pq == qpqForeground; but if this is the case,</span>
03558 <span class="comment">             *  then ptiCurrent must be in grpdeskRitInput already. So</span>
03559 <span class="comment">             *  I don't think we need this at all. Let's find out.</span>
03560 <span class="comment">             * Note that we might switch queues while processing the</span>
03561 <span class="comment">             *  xxxSetForegroundWindow call. That should be fine as long</span>
03562 <span class="comment">             *  as we don't switch desktops.....</span>
03563 <span class="comment">             */</span>
03564             UserAssert((ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>)
03565                         || (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>));
03566 
03567             <span class="comment">/*</span>
03568 <span class="comment">             * The SetForegroundWindow call must succed here, so we call</span>
03569 <span class="comment">             * xxxSetForegroundWindow2() directly</span>
03570 <span class="comment">             */</span>
03571             <a class="code" href="../../d4/d1/userk_8h.html#a1225">xxxSetForegroundWindow2</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, ptiCurrent, 0); <span class="comment">// WHAT KEEPS pdesk LOCKED - IANJA ???</span>
03572 
03573             }
03574         }
03575     }
03576 
03577     <span class="comment">/*</span>
03578 <span class="comment">     * Post update events to all queues sending input to the desktop</span>
03579 <span class="comment">     * that is becoming inactive.  This keeps the queues in sync up</span>
03580 <span class="comment">     * to the desktop switch.</span>
03581 <span class="comment">     */</span>
03582     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03583 
03584         pHead = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o20">PtiList</a>;
03585 
03586         <span class="keywordflow">for</span> (pEntry = pHead-&gt;Flink; pEntry != pHead; pEntry = pEntry-&gt;Flink) {
03587 
03588             pti = CONTAINING_RECORD(pEntry, <a class="code" href="../../d2/d8/structtagTHREADINFO.html">THREADINFO</a>, PtiLink);
03589             pq  = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>;
03590 
03591             <span class="keywordflow">if</span> (pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a856">QF_UPDATEKEYSTATE</a>)
03592                 <a class="code" href="../../d4/d1/userk_8h.html#a1235">PostUpdateKeyStateEvent</a>(pq);
03593 
03594             <span class="comment">/*</span>
03595 <span class="comment">             * Clear the reset bit to ensure that we can properly</span>
03596 <span class="comment">             * reset the key state when this desktop again becomes</span>
03597 <span class="comment">             * active.</span>
03598 <span class="comment">             */</span>
03599             pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a863">QF_KEYSTATERESET</a>;
03600         }
03601     }
03602 
03603     <span class="comment">/*</span>
03604 <span class="comment">     * Send the RIT input to the desktop.  We do this before any window</span>
03605 <span class="comment">     * management since DoPaint() uses grpdeskRitInput to go looking for</span>
03606 <span class="comment">     * windows with update regions.</span>
03607 <span class="comment">     */</span>
03608     <a class="code" href="../../d4/d1/userk_8h.html#a126">LockDesktop</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>, pdesk, LDL_DESKRITINPUT, 0);
03609 
03610     <span class="comment">/*</span>
03611 <span class="comment">     * Free any spbs that are only valid for the previous desktop.</span>
03612 <span class="comment">     */</span>
03613     <a class="code" href="../../d1/d4/spb_8c.html#a12">FreeAllSpbs</a>();
03614 
03615     <span class="comment">/*</span>
03616 <span class="comment">     * Lock it into the RIT thread (we could use this desktop rather than</span>
03617 <span class="comment">     * the global grpdeskRitInput to direct input!)</span>
03618 <span class="comment">     */</span>
03619     <a class="code" href="../../d4/d1/userk_8h.html#a1799">zzzSetDesktop</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>, pdesk, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>); <span class="comment">// DeferWinEventNotify() ?? IANJA ??</span>
03620 
03621     <span class="comment">/*</span>
03622 <span class="comment">     * Lock the desktop into the desktop thread.  Be sure</span>
03623 <span class="comment">     * that the thread is using an unattached queue before</span>
03624 <span class="comment">     * setting the desktop.  This is needed to ensure that</span>
03625 <span class="comment">     * the thread does not using a shared journal queue</span>
03626 <span class="comment">     * for the old desktop.</span>
03627 <span class="comment">     */</span>
03628     <span class="keywordflow">if</span> (pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> != pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o3">pqDesktop</a>) {
03629         UserAssert(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o3">pqDesktop</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a> == 0);
03630         <a class="code" href="../../d4/d1/userk_8h.html#a1204">AllocQueue</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o3">pqDesktop</a>);
03631         pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o3">pqDesktop</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a>++;
03632         <a class="code" href="../../d4/d1/userk_8h.html#a1213">zzzAttachToQueue</a>(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>, pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o3">pqDesktop</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03633     }
03634     <a class="code" href="../../d4/d1/userk_8h.html#a1799">zzzSetDesktop</a>(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>, pdesk, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>); <span class="comment">// DeferWinEventNotify() ?? IANJA ??</span>
03635 
03636     <span class="comment">/*</span>
03637 <span class="comment">     * Bring the desktop window to the top and invalidate</span>
03638 <span class="comment">     * everything.</span>
03639 <span class="comment">     */</span>
03640     <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>, &amp;tlpwnd);
03641 
03642 
03643     <span class="comment">/*</span>
03644 <span class="comment">     * Suspend DirectDraw before we bring up the desktop window, so we make</span>
03645 <span class="comment">     * sure that everything is repainted properly once DirectDraw is disabled.</span>
03646 <span class="comment">     */</span>
03647 
03648     GreSuspendDirectDraw(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03649 
03650     <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>, <span class="comment">// WHAT KEEPS pdesk LOCKED - IANJA ???</span>
03651                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03652                     0,
03653                     0,
03654                     0,
03655                     0,
03656                     SWP_SHOWWINDOW | SWP_NOMOVE | SWP_NOSIZE | SWP_NOCOPYBITS);
03657 
03658     <span class="comment">/*</span>
03659 <span class="comment">     * At this point, my understanding is that the new desktop window has been</span>
03660 <span class="comment">     * brought to the front, and therefore the vis-region of any app on any</span>
03661 <span class="comment">     * other desktop is now NULL.</span>
03662 <span class="comment">     *</span>
03663 <span class="comment">     * So this is the appropriate time to resume DirectDraw, which will</span>
03664 <span class="comment">     * ensure the DirectDraw app can not draw anything in the future.</span>
03665 <span class="comment">     *</span>
03666 <span class="comment">     * If this is not the case, then this code needs to be moved to a more</span>
03667 <span class="comment">     * appropriate location.</span>
03668 <span class="comment">     *</span>
03669 <span class="comment">     * [andreva] 6-26-96</span>
03670 <span class="comment">     */</span>
03671 
03672     GreResumeDirectDraw(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03673 
03674     <span class="comment">/*</span>
03675 <span class="comment">     * Find the first visible top-level window.</span>
03676 <span class="comment">     */</span>
03677     pwndSetForeground = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o11">spwndForeground</a>;
03678     <span class="keywordflow">if</span> (pwndSetForeground == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a438">HMIsMarkDestroy</a>(pwndSetForeground)) {
03679 
03680         pwndSetForeground = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
03681 
03682         <span class="keywordflow">while</span> ((pwndSetForeground != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
03683                 !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndSetForeground, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) {
03684 
03685             pwndSetForeground = pwndSetForeground-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
03686         }
03687     }
03688     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o11">spwndForeground</a>);
03689 
03690     <span class="comment">/*</span>
03691 <span class="comment">     * Now set it to the foreground.</span>
03692 <span class="comment">     */</span>
03693 
03694     <span class="keywordflow">if</span> (pwndSetForeground == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03695         <a class="code" href="../../d4/d1/userk_8h.html#a1225">xxxSetForegroundWindow2</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
03696     } <span class="keywordflow">else</span> {
03697 
03698         UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndSetForeground)-&gt;rpdesk == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>);
03699         <span class="comment">/*</span>
03700 <span class="comment">         * If the new foreground window is a minimized fullscreen app,</span>
03701 <span class="comment">         * make it fullscreen.</span>
03702 <span class="comment">         */</span>
03703         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a744">GetFullScreen</a>(pwndSetForeground) == FULLSCREENMIN) {
03704             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a745">SetFullScreen</a>(pwndSetForeground, FULLSCREEN);
03705         }
03706 
03707         <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwndSetForeground, &amp;tlpwndChild);
03708         <span class="comment">/*</span>
03709 <span class="comment">         * The SetForegroundWindow call must succed here, so we call</span>
03710 <span class="comment">         * xxxSetForegroundWindow2() directly</span>
03711 <span class="comment">         */</span>
03712         <a class="code" href="../../d4/d1/userk_8h.html#a1225">xxxSetForegroundWindow2</a>(pwndSetForeground, ptiCurrent, 0);
03713         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndChild);
03714     }
03715 
03716 
03717     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
03718 
03719     <span class="comment">/*</span>
03720 <span class="comment">     * Overwrite key state of all queues sending input to the new</span>
03721 <span class="comment">     * active desktop with the current async key state.  This</span>
03722 <span class="comment">     * prevents apps on inactive desktops from spying on active</span>
03723 <span class="comment">     * desktops.  This blows away anything set with SetKeyState,</span>
03724 <span class="comment">     * but there is no way of preserving this without giving</span>
03725 <span class="comment">     * away information about what keys were hit on other</span>
03726 <span class="comment">     * desktops.</span>
03727 <span class="comment">     */</span>
03728     pHead = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o20">PtiList</a>;
03729     <span class="keywordflow">for</span> (pEntry = pHead-&gt;Flink; pEntry != pHead; pEntry = pEntry-&gt;Flink) {
03730 
03731         pti = CONTAINING_RECORD(pEntry, <a class="code" href="../../d2/d8/structtagTHREADINFO.html">THREADINFO</a>, PtiLink);
03732         pq  = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>;
03733 
03734         <span class="keywordflow">if</span> (!(pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a863">QF_KEYSTATERESET</a>)) {
03735             pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a856">QF_UPDATEKEYSTATE</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a863">QF_KEYSTATERESET</a>;
03736             RtlFillMemory(pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o16">afKeyRecentDown</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a826">CBKEYSTATERECENTDOWN</a>, 0xff);
03737             <a class="code" href="../../d4/d1/userk_8h.html#a1235">PostUpdateKeyStateEvent</a>(pq);
03738         }
03739     }
03740 
03741     <span class="comment">/*</span>
03742 <span class="comment">     * If there is a hard-error popup up, nuke it and notify the</span>
03743 <span class="comment">     * hard error thread that it needs to pop it up again.</span>
03744 <span class="comment">     */</span>
03745     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a227">gHardErrorHandler</a>.<a class="code" href="../../d2/d6/structtagHARDERRORHANDLER.html#o0">pti</a>) {
03746         <a class="code" href="../../d4/d1/userk_8h.html#a1643">IPostQuitMessage</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a227">gHardErrorHandler</a>.<a class="code" href="../../d2/d6/structtagHARDERRORHANDLER.html#o0">pti</a>, 0);
03747     }
03748 
03749     <span class="comment">/*</span>
03750 <span class="comment">     * Notify anyone waiting for a desktop switch.</span>
03751 <span class="comment">     */</span>
03752     UserAssert(!(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>));
03753 
03754     <a class="code" href="../../d2/d8/eventobj_8c.html#a5">KePulseEvent</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a21">gpEventSwitchDesktop</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03755 
03756     <span class="comment">/*</span>
03757 <span class="comment">     * reset the cursor when we come back from another pdev</span>
03758 <span class="comment">     */</span>
03759     <span class="keywordflow">if</span> (bUpdateCursor == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03760 
03761         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a31">gpqCursor</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03762         <a class="code" href="../../d4/d1/userk_8h.html#a1179">zzzInternalSetCursorPos</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor.x, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor.y);
03763 
03764         <a class="code" href="../../d4/d1/userk_8h.html#a1790">SetPointer</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03765     }
03766 
03767     <span class="comment">/*</span>
03768 <span class="comment">     * Make sure we come back to the right mode when this is all done, because</span>
03769 <span class="comment">     * the device may be left in an interesting state if we were running</span>
03770 <span class="comment">     * DirectDraw.</span>
03771 <span class="comment">     */</span>
03772 
03773     {
03774         <span class="comment">/*</span>
03775 <span class="comment">         * Don't check the return code right now since there is nothing</span>
03776 <span class="comment">         * we can do if we can not reset the mode ...</span>
03777 <span class="comment">         */</span>
03778 
03779             <span class="comment">// BUGBUG</span>
03780             <span class="comment">// DONT_CHECKIN</span>
03781 
03782         <span class="comment">//UserChangeDisplaySettings(pdesk-&gt;pDispInfo-&gt;hDevInfo,</span>
03783         <span class="comment">//                          pdesk-&gt;pDesktopDevmode,</span>
03784         <span class="comment">//                          _GetDesktopWindow(),</span>
03785         <span class="comment">//                          pdesk,</span>
03786         <span class="comment">//                          0,</span>
03787         <span class="comment">//                          NULL,</span>
03788         <span class="comment">//                          TRUE);</span>
03789     }
03790 
03791 
03792     <span class="comment">/*</span>
03793 <span class="comment">     * If this desktop was not active during last display settings change</span>
03794 <span class="comment">     * let's now bradcast the settings change to its windows. This</span>
03795 <span class="comment">     * code is copied from xxxResetDisplayDevice().</span>
03796 <span class="comment">     */</span>
03797 
03798 
03799     <span class="keywordflow">if</span> ((pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a297">DF_NEWDISPLAYSETTINGS</a>) &amp;&amp; pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a> &amp;&amp; pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a> ){
03800 
03801         pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a297">DF_NEWDISPLAYSETTINGS</a>;
03802         <a class="code" href="../../d4/d1/userk_8h.html#a1537">xxxBroadcastDisplaySettingsChange</a>(pdesk, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03803 
03804 
03805     }
03806 
03807     <a class="code" href="../../d4/d1/userk_8h.html#a144">ThreadUnlockDesktopHandle</a>(&amp;tlhdesk);
03808 
03809     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"xxxSwitchDesktop: Leaving\n"</span>));
03810 
03811     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03812 }
03813 
03814 <span class="comment">/***************************************************************************\</span>
03815 <span class="comment">* zzzSetDesktop</span>
03816 <span class="comment">*</span>
03817 <span class="comment">* Set desktop and desktop info in the specified pti.</span>
03818 <span class="comment">*</span>
03819 <span class="comment">* History:</span>
03820 <span class="comment">* 23-Dec-1993 JimA      Created.</span>
03821 <span class="comment">\***************************************************************************/</span>
03822 
<a name="l03823"></a><a class="code" href="../../d4/d1/userk_8h.html#a1799">03823</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1799">zzzSetDesktop</a>(
03824     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti,
03825     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>    pdesk,
03826     HDESK       hdesk)
03827 {
03828     PTEB                      pteb;
03829     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a> ohi;
03830     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>                  pdeskRef;
03831     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>                  pdeskOld;
03832     <a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html">PCLIENTTHREADINFO</a>         pctiOld;
03833     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>                        tlpdesk;
03834     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>               ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
03835 
03836     <span class="keywordflow">if</span> (pti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03837         UserAssert(pti);
03838         <span class="keywordflow">return</span>;
03839     }
03840 
03841     <span class="comment">/*</span>
03842 <span class="comment">     * A handle without an object pointer is bad news.</span>
03843 <span class="comment">     */</span>
03844     UserAssert(pdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || hdesk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03845 
03846     <span class="comment">/*</span>
03847 <span class="comment">     * This desktop must not be destroyed</span>
03848 <span class="comment">     */</span>
03849     <span class="keywordflow">if</span> (pdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; (<a class="code" href="../../d4/d1/userk_8h.html#a286">DF_DESKWNDDESTROYED</a> | <a class="code" href="../../d4/d1/userk_8h.html#a285">DF_DYING</a>)) &amp;&amp;
03850         pdesk != pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>) {
03851         RIPMSG2(RIP_ERROR, <span class="stringliteral">"Assigning pti %#p to a dying desktop %#p"</span>,
03852                 pti, pdesk);
03853         <span class="keywordflow">return</span>;
03854     }
03855 
03856 <span class="preprocessor">#if DBG</span>
03857 <span class="preprocessor"></span>    <span class="comment">/*</span>
03858 <span class="comment">     * Catch reset of important desktops</span>
03859 <span class="comment">     */</span>
03860     <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> &amp;&amp; pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o17">dwConsoleThreadId</a> == <a class="code" href="../../d4/d1/userk_8h.html#a107">TIDq</a>(pti) &amp;&amp;
03861             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o49">cWindows</a> != 0) {
03862         RIPMSG0(RIP_ERROR, <span class="stringliteral">"Reset of console desktop"</span>);
03863     }
03864 <span class="preprocessor">#endif</span>
03865 <span class="preprocessor"></span>
03866     <span class="comment">/*</span>
03867 <span class="comment">     * Clear hook flag</span>
03868 <span class="comment">     */</span>
03869     pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a815">TIF_ALLOWOTHERACCOUNTHOOK</a>;
03870 
03871     <span class="comment">/*</span>
03872 <span class="comment">     * Get granted access</span>
03873 <span class="comment">     */</span>
03874     pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o18">hdesk</a> = hdesk;
03875     <span class="keywordflow">if</span> (hdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03876         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(hdesk,
03877                                                  0,
03878                                                  *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>,
03879                                                  <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
03880                                                  &amp;pdeskRef,
03881                                                  &amp;ohi))) {
03882 
03883             UserAssert(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o25">dwSessionId</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a327">gSessionId</a>);
03884 
03885             <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdeskRef, LD_REF_FN_SETDESKTOP, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
03886 
03887             UserAssert(pdeskRef == pdesk);
03888             <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdesk, LD_DEREF_FN_SETDESKTOP, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
03889             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pdeskRef);
03890             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o48">amdesk</a> = ohi.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o1">GrantedAccess</a>;
03891             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a2070">CheckHandleFlag</a>(hdesk, <a class="code" href="../../d4/d1/userk_8h.html#a746">HF_DESKTOPHOOK</a>))
03892                 pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a815">TIF_ALLOWOTHERACCOUNTHOOK</a>;
03893 
03894             <a class="code" href="../../d4/d1/userk_8h.html#a2069">SetHandleFlag</a>(hdesk, <a class="code" href="../../d4/d1/userk_8h.html#a747">HF_PROTECTED</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03895 
03896         } <span class="keywordflow">else</span> {
03897             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o48">amdesk</a> = 0;
03898         }
03899 
03900     } <span class="keywordflow">else</span> {
03901         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o48">amdesk</a> = 0;
03902     }
03903 
03904     <span class="comment">/*</span>
03905 <span class="comment">     * Do nothing else if the thread has initialized and the desktop</span>
03906 <span class="comment">     * is not changing.</span>
03907 <span class="comment">     */</span>
03908     <span class="keywordflow">if</span> ((pdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (pdesk == pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>))
03909         <span class="keywordflow">return</span>;
03910 
03911     <span class="comment">/*</span>
03912 <span class="comment">     * Save old pointers for later.  Locking the old desktop ensures</span>
03913 <span class="comment">     * that we will be able to free the CLIENTTHREADINFO structure.</span>
03914 <span class="comment">     */</span>
03915     pdeskOld = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>;
03916     <a class="code" href="../../d4/d1/userk_8h.html#a128">ThreadLockDesktop</a>(ptiCurrent, pdeskOld, &amp;tlpdesk, LDLT_FN_SETDESKTOP);
03917     pctiOld = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>;
03918 
03919     <span class="comment">/*</span>
03920 <span class="comment">     * Remove the pti from the current desktop.</span>
03921 <span class="comment">     */</span>
03922      <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>) {
03923         UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a168">ISATOMICCHECK</a>() || pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a> == 1);
03924         RemoveEntryList(&amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o36">PtiLink</a>);
03925      }
03926 
03927     <a class="code" href="../../d4/d1/userk_8h.html#a126">LockDesktop</a>(&amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>, pdesk, LDL_PTI_DESK, (ULONG_PTR)pti);
03928 
03929 
03930     <span class="comment">/*</span>
03931 <span class="comment">     * If there is no desktop, we need to fake a desktop info</span>
03932 <span class="comment">     * structure so that the IsHooked() macro can test a "valid"</span>
03933 <span class="comment">     * fsHooks value.  Also link the pti to the desktop.</span>
03934 <span class="comment">     */</span>
03935     <span class="keywordflow">if</span> (pdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03936         pti-&gt;pDeskInfo = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>;
03937         InsertHeadList(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o20">PtiList</a>, &amp;pti-&gt;PtiLink);
03938     } <span class="keywordflow">else</span> {
03939         pti-&gt;pDeskInfo = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a276">diStatic</a>;
03940     }
03941 
03942     <span class="comment">// UserAssert((pti-&gt;ppi != NULL) || (pti-&gt;ppi == PpiCurrent())); // can't access TEB/pClientInfo of other process</span>
03943 
03944     pteb = pti-&gt;pEThread-&gt;Tcb.Teb;
03945     <span class="keywordflow">if</span> (pteb) {
03946         <a class="code" href="../../d2/d3/structtagDESKTOPVIEW.html">PDESKTOPVIEW</a> pdv;
03947         <span class="keywordflow">if</span> (pdesk &amp;&amp; (pdv = <a class="code" href="../../d4/d1/userk_8h.html#a1283">GetDesktopView</a>(pti-&gt;ppi, pdesk))) {
03948 
03949             pti-&gt;pClientInfo-&gt;pDeskInfo =
03950                     (<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html">PDESKTOPINFO</a>)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pti-&gt;pDeskInfo - pdv-&gt;ulClientDelta);
03951 
03952             pti-&gt;pClientInfo-&gt;ulClientDelta = pdv-&gt;ulClientDelta;
03953 
03954         } <span class="keywordflow">else</span> {
03955 
03956             pti-&gt;pClientInfo-&gt;pDeskInfo     = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03957             pti-&gt;pClientInfo-&gt;ulClientDelta = 0;
03958 
03959             <span class="comment">/*</span>
03960 <span class="comment">             * Reset the cursor level to its orginal state.</span>
03961 <span class="comment">             */</span>
03962             pti-&gt;iCursorLevel = <a class="code" href="../../d4/d1/userk_8h.html#a193">TEST_GTERMF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a199">GTERMF_MOUSE</a>) ? 0 : -1;
03963             <span class="keywordflow">if</span> (pti-&gt;pq)
03964                 pti-&gt;pq-&gt;iCursorLevel = pti-&gt;iCursorLevel;
03965         }
03966     }
03967 
03968     <span class="comment">/*</span>
03969 <span class="comment">     * Allocate thread information visible from client, then copy and free</span>
03970 <span class="comment">     * any old info we have lying around.</span>
03971 <span class="comment">     */</span>
03972     <span class="keywordflow">if</span> (pdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03973 
03974         <span class="comment">/*</span>
03975 <span class="comment">         * Do not use DesktopAlloc here because the desktop might</span>
03976 <span class="comment">         * have DF_DESTROYED set.</span>
03977 <span class="comment">         */</span>
03978         pti-&gt;pcti = <a class="code" href="../../d4/d1/userk_8h.html#a312">DesktopAllocAlways</a>(pdesk,
03979                                        <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html">CLIENTTHREADINFO</a>),
03980                                        <a class="code" href="../../d4/d1/userk_8h.html#a304">DTAG_CLIENTTHREADINFO</a>);
03981     }
03982 
03983     <span class="keywordflow">if</span> (pdesk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || pti-&gt;pcti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03984         pti-&gt;pcti = &amp;(pti-&gt;cti);
03985         pti-&gt;pClientInfo-&gt;pClientThreadInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03986     } <span class="keywordflow">else</span> {
03987         pti-&gt;pClientInfo-&gt;pClientThreadInfo =
03988                 (<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html">PCLIENTTHREADINFO</a>)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pti-&gt;pcti - pti-&gt;pClientInfo-&gt;ulClientDelta);
03989     }
03990 
03991     <span class="keywordflow">if</span> (pctiOld != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03992 
03993         <span class="keywordflow">if</span> (pctiOld != pti-&gt;pcti) {
03994             RtlCopyMemory(pti-&gt;pcti, pctiOld, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html">CLIENTTHREADINFO</a>));
03995         }
03996 
03997         <span class="keywordflow">if</span> (pctiOld != &amp;(pti-&gt;cti)) {
03998             <a class="code" href="../../d4/d1/userk_8h.html#a313">DesktopFree</a>(pdeskOld, pctiOld);
03999         }
04000 
04001     } <span class="keywordflow">else</span> {
04002         RtlZeroMemory(pti-&gt;pcti, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html">CLIENTTHREADINFO</a>));
04003     }
04004 
04005     <span class="comment">/*</span>
04006 <span class="comment">     * If journalling is occuring on the new desktop, attach to</span>
04007 <span class="comment">     * the journal queue.</span>
04008 <span class="comment">     * Assert that the pti and the pdesk point to the same deskinfo</span>
04009 <span class="comment">     *  if not, we will check the wrong hooks.</span>
04010 <span class="comment">     */</span>
04011     UserAssert((pdesk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) || (pti-&gt;pDeskInfo == pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>));
04012     UserAssert(pti-&gt;rpdesk == pdesk);
04013     <span class="keywordflow">if</span> (pti-&gt;pq != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04014         <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pq = <a class="code" href="../../d4/d1/userk_8h.html#a1831">GetJournallingQueue</a>(pti);
04015         <span class="keywordflow">if</span> (pq != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04016             pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a>++;
04017             <a class="code" href="../../d4/d1/userk_8h.html#a1213">zzzAttachToQueue</a>(pti, pq, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04018         }
04019     }
04020 
04021     <a class="code" href="../../d4/d1/userk_8h.html#a130">ThreadUnlockDesktop</a>(ptiCurrent, &amp;tlpdesk, LDUT_FN_SETDESKTOP);
04022 }
04023 
04024 <span class="comment">/***************************************************************************\</span>
04025 <span class="comment">* xxxSetThreadDesktop (API)</span>
04026 <span class="comment">*</span>
04027 <span class="comment">* Associate the current thread with a desktop.</span>
04028 <span class="comment">*</span>
04029 <span class="comment">* History:</span>
04030 <span class="comment">* 16-Jan-1991 JimA      Created stub.</span>
04031 <span class="comment">\***************************************************************************/</span>
04032 
<a name="l04033"></a><a class="code" href="../../d4/d1/userk_8h.html#a1801">04033</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1801">xxxSetThreadDesktop</a>(
04034     HDESK    hdesk,
04035     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk)
04036 {
04037     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>  ptiCurrent;
04038     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppiCurrent;
04039     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a>           pqAttach;
04040 
04041     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
04042     ppiCurrent = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>;
04043 
04044 
04045     <span class="comment">/*</span>
04046 <span class="comment">     * If the handle has not been mapped in, do it now.</span>
04047 <span class="comment">     */</span>
04048     <span class="keywordflow">if</span> (pdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04049         <span class="keywordflow">try</span> {
04050             <a class="code" href="../../d4/d1/userk_8h.html#a1289">MapDesktop</a>(<a class="code" href="../../d4/d0/ob_8h.html#a100a59">ObOpenHandle</a>, ppiCurrent-&gt;Process, pdesk, 0, 1);
04051         } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, RIP_WARNING)) {
04052             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04053         }
04054 
04055         UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a1283">GetDesktopView</a>(ppiCurrent, pdesk) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04056     }
04057 
04058     <span class="comment">/*</span>
04059 <span class="comment">     * Check non-system thread status</span>
04060 <span class="comment">     */</span>
04061     <span class="keywordflow">if</span> (ptiCurrent-&gt;pEThread-&gt;ThreadsProcess != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>) {
04062 
04063         <span class="comment">/*</span>
04064 <span class="comment">         * Fail if the non-system thread has any windows or thread hooks.</span>
04065 <span class="comment">         */</span>
04066         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o49">cWindows</a> != 0 || ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o31">fsHooks</a>) {
04067             RIPERR0(ERROR_BUSY, RIP_WARNING, <span class="stringliteral">"Thread has windows or hooks"</span>);
04068             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04069         }
04070 
04071         <span class="comment">/*</span>
04072 <span class="comment">         * If this is the first desktop assigned to the process,</span>
04073 <span class="comment">         * make it the startup desktop.</span>
04074 <span class="comment">         */</span>
04075         <span class="keywordflow">if</span> (ppiCurrent-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o3">rpdeskStartup</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; hdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04076             <a class="code" href="../../d4/d1/userk_8h.html#a126">LockDesktop</a>(&amp;ppiCurrent-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o3">rpdeskStartup</a>, pdesk, LDL_PPI_DESKSTARTUP1, (ULONG_PTR)ppiCurrent);
04077             ppiCurrent-&gt;hdeskStartup = hdesk;
04078         }
04079     }
04080 
04081 
04082     <span class="comment">/*</span>
04083 <span class="comment">     * If the desktop is changing and the thread is sharing a queue,</span>
04084 <span class="comment">     * detach the thread.  This will ensure that threads sharing</span>
04085 <span class="comment">     * queues are all on the same desktop.  This will prevent</span>
04086 <span class="comment">     * zzzDestroyQueue from getting confused and setting ptiKeyboard</span>
04087 <span class="comment">     * and ptiMouse to NULL when a thread detachs.</span>
04088 <span class="comment">     */</span>
04089     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> != pdesk) {
04090         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a> &gt; 1) {
04091             pqAttach = <a class="code" href="../../d4/d1/userk_8h.html#a1204">AllocQueue</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04092             <span class="keywordflow">if</span> (pqAttach != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04093                 pqAttach-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a>++;
04094                 <a class="code" href="../../d4/d1/userk_8h.html#a1213">zzzAttachToQueue</a>(ptiCurrent, pqAttach, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04095             } <span class="keywordflow">else</span> {
04096                 RIPERR0(ERROR_NOT_ENOUGH_MEMORY, RIP_WARNING, <span class="stringliteral">"Thread could not be detached"</span>);
04097                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04098             }
04099         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>) {
04100             <span class="comment">/*</span>
04101 <span class="comment">             * This thread doesn't own any windows, still it's attached to qpgForeground and</span>
04102 <span class="comment">             *  it's the only thread attached to it.</span>
04103 <span class="comment">             * Since any threads attached to qpgForeground must be in grpdeskRitInput,</span>
04104 <span class="comment">             *  we must set qpgForeground to NULL here because this thread is going to another</span>
04105 <span class="comment">             *  desktop.</span>
04106 <span class="comment">             */</span>
04107             UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04108             UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04109             UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04110             UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04111             <a class="code" href="../../d4/d1/userk_8h.html#a1225">xxxSetForegroundWindow2</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, ptiCurrent, 0);
04112         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04113             <span class="comment">/*</span>
04114 <span class="comment">             * We need to initialize iCursorLevel.</span>
04115 <span class="comment">             */</span>
04116             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o37">iCursorLevel</a> = <a class="code" href="../../d4/d1/userk_8h.html#a193">TEST_GTERMF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a199">GTERMF_MOUSE</a>) ? 0 : -1;
04117             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o20">iCursorLevel</a> = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o37">iCursorLevel</a>;
04118         }
04119 
04120         UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>);
04121 
04122     }
04123 
04124     <a class="code" href="../../d4/d1/userk_8h.html#a1799">zzzSetDesktop</a>(ptiCurrent, pdesk, hdesk);
04125 
04126     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04127 }
04128 <span class="comment">/***************************************************************************\</span>
04129 <span class="comment">* xxxDuplicateObject</span>
04130 <span class="comment">*</span>
04131 <span class="comment">* ZwDuplicateObject grabs ObpInitKillMutant so we have to leave our</span>
04132 <span class="comment">*  critical section.</span>
04133 <span class="comment">*</span>
04134 <span class="comment">* 04-24-96 GerardoB  Created</span>
04135 <span class="comment">\***************************************************************************/</span>
04136 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04137"></a><a class="code" href="../../d9/d6/desktop_8c.html#a32">04137</a> <a class="code" href="../../d4/d1/userk_8h.html#a1275">xxxUserDuplicateObject</a>(
04138     IN HANDLE SourceProcessHandle,
04139     IN HANDLE SourceHandle,
04140     IN HANDLE TargetProcessHandle OPTIONAL,
04141     OUT PHANDLE TargetHandle OPTIONAL,
04142     IN ACCESS_MASK DesiredAccess,
04143     IN ULONG HandleAttributes,
04144     IN ULONG Options
04145     )
04146 
04147 {
04148     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04149 
04150     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
04151 
04152     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
04153 
04154     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwDuplicateObject(SourceProcessHandle, SourceHandle, TargetProcessHandle,
04155             TargetHandle, DesiredAccess, HandleAttributes, Options);
04156 
04157     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
04158 
04159     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04160 }
04161 <span class="comment">/***************************************************************************\</span>
04162 <span class="comment">* xxxUserFindHandleForObject</span>
04163 <span class="comment">*</span>
04164 <span class="comment">* ObFindHandleForObject grabs ObpInitKillMutant so we have to leave our</span>
04165 <span class="comment">*  critical section.</span>
04166 <span class="comment">*</span>
04167 <span class="comment">* 04-24-96 GerardoB  Created</span>
04168 <span class="comment">\***************************************************************************/</span>
04169 
04170 BOOLEAN
<a name="l04171"></a><a class="code" href="../../d9/d6/desktop_8c.html#a33">04171</a> <a class="code" href="../../d9/d6/desktop_8c.html#a33">xxxUserFindHandleForObject</a>(
04172     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
04173     IN PVOID Object OPTIONAL,
04174     IN <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType OPTIONAL,
04175     IN <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">POBJECT_HANDLE_INFORMATION</a> HandleInformation OPTIONAL,
04176     OUT PHANDLE Handle
04177     )
04178 {
04179     BOOLEAN fRet;
04180     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fExclusive, fShared;
04181 
04182     fExclusive = <a class="code" href="../../d5/d8/ex_8h.html#a281">ExIsResourceAcquiredExclusiveLite</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a278">gpresUser</a>);
04183     <span class="keywordflow">if</span> (!fExclusive) {
04184         fShared = <a class="code" href="../../d5/d8/ex_8h.html#a282">ExIsResourceAcquiredSharedLite</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a278">gpresUser</a>);
04185     }
04186 
04187     <span class="keywordflow">if</span> (fExclusive || fShared) {
04188         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
04189     }
04190 
04191     fRet = <a class="code" href="../../d0/d1/obinit_8c.html#a25">ObFindHandleForObject</a>(Process, Object, ObjectType, HandleInformation, <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
04192 
04193     <span class="keywordflow">if</span> (fExclusive) {
04194         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
04195     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fShared) {
04196         <a class="code" href="../../d7/d3/validate_8c.html#a19">EnterSharedCrit</a>();
04197     }
04198 
04199     <span class="keywordflow">return</span> fRet;
04200 }
04201 
04202 <span class="comment">/***************************************************************************\</span>
04203 <span class="comment">* xxxGetThreadDesktop (API)</span>
04204 <span class="comment">*</span>
04205 <span class="comment">* Return a handle to the desktop assigned to the specified thread.</span>
04206 <span class="comment">*</span>
04207 <span class="comment">* History:</span>
04208 <span class="comment">* 16-Jan-1991 JimA      Created stub.</span>
04209 <span class="comment">\***************************************************************************/</span>
04210 
<a name="l04211"></a><a class="code" href="../../d4/d1/userk_8h.html#a1802">04211</a> HDESK <a class="code" href="../../d4/d1/userk_8h.html#a1802">xxxGetThreadDesktop</a>(
04212     DWORD           dwThread,
04213     HDESK           hdeskConsole,
04214     KPROCESSOR_MODE AccessMode)
04215 {
04216     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>  pti = <a class="code" href="../../d4/d1/userk_8h.html#a1201">PtiFromThreadId</a>(dwThread);
04217     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppiThread;
04218     HDESK        hdesk;
04219     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04220 
04221     <span class="keywordflow">if</span> (pti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04222 
04223         <span class="comment">/*</span>
04224 <span class="comment">         * If the thread has a console use that desktop.  If</span>
04225 <span class="comment">         * not, then the thread is either invalid or not</span>
04226 <span class="comment">         * a Win32 thread.</span>
04227 <span class="comment">         */</span>
04228         <span class="keywordflow">if</span> (hdeskConsole == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04229             RIPERR1(ERROR_INVALID_PARAMETER, RIP_VERBOSE,
04230                     <span class="stringliteral">"xxxGetThreadDesktop: invalid threadId 0x%x"</span>,
04231                     dwThread);
04232             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04233         }
04234 
04235         hdesk = hdeskConsole;
04236         ppiThread = <a class="code" href="../../d4/d1/userk_8h.html#a18">PpiFromProcess</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>);
04237     } <span class="keywordflow">else</span> {
04238         hdesk = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o18">hdesk</a>;
04239         ppiThread = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>;
04240     }
04241 
04242     <span class="comment">/*</span>
04243 <span class="comment">     * If there is no desktop, return NULL with no error</span>
04244 <span class="comment">     */</span>
04245     <span class="keywordflow">if</span> (hdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04246 
04247         <span class="comment">/*</span>
04248 <span class="comment">         * If the thread belongs to this process, return the</span>
04249 <span class="comment">         * handle.  Otherwise, enumerate the handle table of</span>
04250 <span class="comment">         * this process to find a handle with the same</span>
04251 <span class="comment">         * attributes.</span>
04252 <span class="comment">         */</span>
04253         <span class="keywordflow">if</span> (ppiThread != <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()) {
04254             PVOID pobj;
04255             <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a> ohi;
04256 
04257             RIPMSG4(RIP_VERBOSE, <span class="stringliteral">"[%x.%x] %s called xxxGetThreadDesktop for pti %#p\n"</span>,
04258                     <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueProcess,
04259                     <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueThread,
04260                     <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ImageFileName,
04261                     pti);
04262 
04263             <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>(&amp;ppiThread-&gt;Process-&gt;Pcb);
04264             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(hdesk,
04265                                                0,
04266                                                *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>,
04267                                                AccessMode,
04268                                                &amp;pobj,
04269                                                &amp;ohi);
04270             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
04271             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ||
04272                 !<a class="code" href="../../d9/d6/desktop_8c.html#a33">xxxUserFindHandleForObject</a>(<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(), pobj, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;ohi, &amp;hdesk)) {
04273 
04274                 RIPMSG0(RIP_VERBOSE, <span class="stringliteral">"Cannot find hdesk for current process"</span>);
04275 
04276                 hdesk = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04277 
04278             } <span class="keywordflow">else</span> {
04279                 <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pobj, LD_REF_FN_GETTHREADDESKTOP, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
04280             }
04281             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
04282                 <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pobj, LD_DEREF_FN_GETTHREADDESKTOP, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
04283                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pobj);
04284             }
04285         }
04286 
04287         <span class="keywordflow">if</span> (hdesk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04288             RIPERR0(ERROR_ACCESS_DENIED, RIP_VERBOSE, <span class="stringliteral">"xxxGetThreadDesktop: hdesk is null"</span>);
04289         } <span class="keywordflow">else</span> {
04290             <a class="code" href="../../d4/d1/userk_8h.html#a2069">SetHandleFlag</a>(hdesk, <a class="code" href="../../d4/d1/userk_8h.html#a747">HF_PROTECTED</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04291         }
04292     }
04293 
04294     <span class="keywordflow">return</span> hdesk;
04295 }
04296 
04297 
04298 <span class="comment">/***************************************************************************\</span>
04299 <span class="comment">* xxxGetInputDesktop (API)</span>
04300 <span class="comment">*</span>
04301 <span class="comment">* Obsolete - kept for compatibility only.  Return a handle to the</span>
04302 <span class="comment">* desktop currently receiving input.  Returns the first handle to</span>
04303 <span class="comment">* the input desktop found.</span>
04304 <span class="comment">*</span>
04305 <span class="comment">* History:</span>
04306 <span class="comment">* 16-Jan-1991 JimA      Created scaffold code.</span>
04307 <span class="comment">\***************************************************************************/</span>
04308 
<a name="l04309"></a><a class="code" href="../../d4/d1/userk_8h.html#a1800">04309</a> HDESK <a class="code" href="../../d4/d1/userk_8h.html#a1800">xxxGetInputDesktop</a>(VOID)
04310 {
04311     HDESK             hdesk;
04312 
04313     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d6/desktop_8c.html#a33">xxxUserFindHandleForObject</a>(<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(), <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;hdesk)) {
04314         <a class="code" href="../../d4/d1/userk_8h.html#a2069">SetHandleFlag</a>(hdesk, <a class="code" href="../../d4/d1/userk_8h.html#a747">HF_PROTECTED</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04315         <span class="keywordflow">return</span> hdesk;
04316     } <span class="keywordflow">else</span> {
04317         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04318     }
04319 }
04320 
04321 <span class="comment">/***************************************************************************\</span>
04322 <span class="comment">* xxxCloseDesktop (API)</span>
04323 <span class="comment">*</span>
04324 <span class="comment">* Close a reference to a desktop and destroy the desktop if it is no</span>
04325 <span class="comment">* longer referenced.</span>
04326 <span class="comment">*</span>
04327 <span class="comment">* History:</span>
04328 <span class="comment">* 16-Jan-1991 JimA      Created scaffold code.</span>
04329 <span class="comment">* 11-Feb-1991 JimA      Added access checks.</span>
04330 <span class="comment">\***************************************************************************/</span>
04331 
<a name="l04332"></a><a class="code" href="../../d4/d1/userk_8h.html#a1803">04332</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1803">xxxCloseDesktop</a>(
04333     HDESK           hdesk,
04334     KPROCESSOR_MODE AccessMode)
04335 {
04336     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>     pdesk;
04337     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>  ptiT;
04338     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi;
04339     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04340 
04341     ppi = <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>();
04342 
04343     <span class="comment">/*</span>
04344 <span class="comment">     * Get a pointer to the desktop.</span>
04345 <span class="comment">     */</span>
04346     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
04347             hdesk,
04348             0,
04349             *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>,
04350             AccessMode,
04351             &amp;pdesk,
04352             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04353     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
04354         RIPNTERR0(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, RIP_VERBOSE, <span class="stringliteral">""</span>);
04355         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04356     }
04357 
04358     UserAssert(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o25">dwSessionId</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a327">gSessionId</a>);
04359 
04360     <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdesk, LD_REF_FN_CLOSEDESKTOP, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
04361 
04362     <span class="keywordflow">if</span> (ppi-&gt;Process != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>) {
04363 
04364         <span class="comment">/*</span>
04365 <span class="comment">         * Disallow closing of the desktop if the handle is in use by</span>
04366 <span class="comment">         * any threads in the process.</span>
04367 <span class="comment">         */</span>
04368         <span class="keywordflow">for</span> (ptiT = ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o1">ptiList</a>; ptiT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; ptiT = ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o29">ptiSibling</a>) {
04369             <span class="keywordflow">if</span> (ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o18">hdesk</a> == hdesk) {
04370                 RIPERR2(ERROR_BUSY, RIP_WARNING,
04371                         <span class="stringliteral">"CloseDesktop: Desktop %#p still in use by thread %#p"</span>,
04372                         pdesk, ptiT);
04373                 <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdesk, LD_DEREF_FN_CLOSEDESKTOP1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
04374                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pdesk);
04375                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04376             }
04377         }
04378 
04379         <span class="comment">/*</span>
04380 <span class="comment">         * If this is the startup desktop, unlock it</span>
04381 <span class="comment">         */</span>
04382          <span class="comment">/*</span>
04383 <span class="comment">          * Bug 41394. Make sure that hdesk == ppi-&gt;hdeskStartup. We might</span>
04384 <span class="comment">          * be getting a handle to the desktop object that is different</span>
04385 <span class="comment">          * from ppi-&gt;hdeskStartup but we still end up</span>
04386 <span class="comment">          * setting ppi-&gt;hdeskStartup to NULL.</span>
04387 <span class="comment">          */</span>
04388         <span class="keywordflow">if</span> ((pdesk == ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o3">rpdeskStartup</a>) &amp;&amp; (hdesk == ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o10">hdeskStartup</a>)) {
04389             <a class="code" href="../../d4/d1/userk_8h.html#a127">UnlockDesktop</a>(&amp;ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o3">rpdeskStartup</a>, LDU_PPI_DESKSTARTUP2, (ULONG_PTR)ppi);
04390             ppi-&gt;hdeskStartup = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04391         }
04392     }
04393 
04394     <span class="comment">/*</span>
04395 <span class="comment">     * Clear hook flag</span>
04396 <span class="comment">     */</span>
04397     <a class="code" href="../../d4/d1/userk_8h.html#a2069">SetHandleFlag</a>(hdesk, <a class="code" href="../../d4/d1/userk_8h.html#a746">HF_DESKTOPHOOK</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04398 
04399     <span class="comment">/*</span>
04400 <span class="comment">     * Close the handle</span>
04401 <span class="comment">     */</span>
04402     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a2073">CloseProtectedHandle</a>(hdesk);
04403 
04404     <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdesk, LD_DEREF_FN_CLOSEDESKTOP2, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
04405     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pdesk);
04406     UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
04407 
04408     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04409 }
04410 
04411 <span class="comment">/***************************************************************************\</span>
04412 <span class="comment">* TerminateConsole</span>
04413 <span class="comment">*</span>
04414 <span class="comment">* Post a quit message to a console thread and wait for it to terminate.</span>
04415 <span class="comment">*</span>
04416 <span class="comment">* History:</span>
04417 <span class="comment">* 08-May-1995 JimA      Created.</span>
04418 <span class="comment">\***************************************************************************/</span>
04419 
<a name="l04420"></a><a class="code" href="../../d4/d1/userk_8h.html#a1284">04420</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1284">TerminateConsole</a>(
04421     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk)
04422 {
04423     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04424     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
04425     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
04426 
04427     <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o17">dwConsoleThreadId</a> == 0)
04428         <span class="keywordflow">return</span>;
04429 
04430     <span class="comment">/*</span>
04431 <span class="comment">     * Locate the console thread.</span>
04432 <span class="comment">     */</span>
04433     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1259">LockThreadByClientId</a>((HANDLE)LongToHandle( pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o17">dwConsoleThreadId</a> ), &amp;Thread);
04434     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
04435         <span class="keywordflow">return</span>;
04436 
04437     <span class="comment">/*</span>
04438 <span class="comment">     * Post a quit message to the console.</span>
04439 <span class="comment">     */</span>
04440     pti = <a class="code" href="../../d4/d1/userk_8h.html#a17">PtiFromThread</a>(Thread);
04441     UserAssert(pti != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04442     <span class="keywordflow">if</span> (pti != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04443         <a class="code" href="../../d4/d1/userk_8h.html#a1645">_PostThreadMessage</a>(pti, WM_QUIT, 0, 0);
04444     }
04445 
04446     <span class="comment">/*</span>
04447 <span class="comment">     * Clear thread id so we don't post twice</span>
04448 <span class="comment">     */</span>
04449     pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o17">dwConsoleThreadId</a> = 0;
04450 
04451     <a class="code" href="../../d4/d1/userk_8h.html#a518">UnlockThread</a>(Thread);
04452 }
04453 
04454 <span class="comment">/***************************************************************************\</span>
04455 <span class="comment">* CheckHandleFlag</span>
04456 <span class="comment">*</span>
04457 <span class="comment">* Returns TRUE if the desktop handle allows other accounts</span>
04458 <span class="comment">* to hook this process.</span>
04459 <span class="comment">*</span>
04460 <span class="comment">* History:</span>
04461 <span class="comment">* 07-13-95 JimA         Created.</span>
04462 <span class="comment">\***************************************************************************/</span>
04463 
<a name="l04464"></a><a class="code" href="../../d4/d1/userk_8h.html#a2070">04464</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a2070">CheckHandleFlag</a>(
04465     HANDLE       hObject,
04466     DWORD        dwFlag)
04467 {
04468     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi;
04469     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = ((<a class="code" href="../../d7/d8/struct__EXHANDLE.html">PEXHANDLE</a>)&amp;hObject)-&gt;Index * <a class="code" href="../../d4/d1/userk_8h.html#a748">HF_LIMIT</a> + dwFlag;
04470     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04471 
04472     <a class="code" href="../../d4/d1/userk_8h.html#a2074">EnterHandleFlagsCrit</a>();
04473 
04474     <span class="keywordflow">if</span> ((ppi = <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04475         fRet = (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o21">bmHandleFlags</a>.SizeOfBitMap &amp;&amp;
04476                 RtlCheckBit(&amp;ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o21">bmHandleFlags</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>));
04477     }
04478 
04479     <a class="code" href="../../d4/d1/userk_8h.html#a2075">LeaveHandleFlagsCrit</a>();
04480 
04481     <span class="keywordflow">return</span> fRet;
04482 }
04483 
04484 <span class="comment">/***************************************************************************\</span>
04485 <span class="comment">* SetHandleFlag</span>
04486 <span class="comment">*</span>
04487 <span class="comment">* Sets and clears the ability of a desktop handle to allow</span>
04488 <span class="comment">* other accounts to hook this process.</span>
04489 <span class="comment">*</span>
04490 <span class="comment">* History:</span>
04491 <span class="comment">* 07-13-95 JimA         Created.</span>
04492 <span class="comment">\***************************************************************************/</span>
04493 
<a name="l04494"></a><a class="code" href="../../d4/d1/userk_8h.html#a2069">04494</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a2069">SetHandleFlag</a>(
04495     HANDLE       hObject,
04496     DWORD        dwFlag,
04497     BOOL         fSet)
04498 {
04499     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi;
04500     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = ((<a class="code" href="../../d7/d8/struct__EXHANDLE.html">PEXHANDLE</a>)&amp;hObject)-&gt;Index * <a class="code" href="../../d4/d1/userk_8h.html#a748">HF_LIMIT</a> + dwFlag;
04501     PRTL_BITMAP pbm;
04502     ULONG       cBits;
04503     PULONG      <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
04504     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04505 
04506     UserAssert(dwFlag &lt; <a class="code" href="../../d4/d1/userk_8h.html#a748">HF_LIMIT</a>);
04507 
04508     <a class="code" href="../../d4/d1/userk_8h.html#a2074">EnterHandleFlagsCrit</a>();
04509 
04510     <span class="keywordflow">if</span> ((ppi = <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04511         pbm = &amp;ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o21">bmHandleFlags</a>;
04512         <span class="keywordflow">if</span> (fSet) {
04513 
04514             <span class="comment">/*</span>
04515 <span class="comment">             * Expand the bitmap if needed</span>
04516 <span class="comment">             */</span>
04517             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt;= pbm-&gt;SizeOfBitMap) {
04518                 <span class="comment">/*</span>
04519 <span class="comment">                 * Index is zero-based - cBits is an exact number of dwords</span>
04520 <span class="comment">                 */</span>
04521                 cBits = ((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> + 1) + 0x1F) &amp; ~0x1F;
04522                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = UserAllocPoolWithQuotaZInit(cBits / 8, TAG_PROCESSINFO);
04523                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04524                     fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04525                     <span class="keywordflow">goto</span> Exit;
04526                 }
04527                 <span class="keywordflow">if</span> (pbm-&gt;Buffer) {
04528                     RtlCopyMemory(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, pbm-&gt;Buffer, pbm-&gt;SizeOfBitMap / 8);
04529                     UserFreePool(pbm-&gt;Buffer);
04530                 }
04531 
04532                 <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a26">RtlInitializeBitMap</a>(pbm, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, cBits);
04533             }
04534 
04535             <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a34">RtlSetBits</a>(pbm, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, 1);
04536         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; pbm-&gt;SizeOfBitMap) {
04537             <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a>(pbm, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, 1);
04538         }
04539     }
04540 
04541 Exit:
04542     <a class="code" href="../../d4/d1/userk_8h.html#a2075">LeaveHandleFlagsCrit</a>();
04543 
04544     <span class="keywordflow">return</span> fRet;
04545 }
04546 
04547 
04548 <span class="comment">/***************************************************************************\</span>
04549 <span class="comment">* CheckHandleInUse</span>
04550 <span class="comment">*</span>
04551 <span class="comment">* Returns TRUE if the handle is currently in use.</span>
04552 <span class="comment">*</span>
04553 <span class="comment">* History:</span>
04554 <span class="comment">* 02-Jun-1999 JerrySh   Created.</span>
04555 <span class="comment">\***************************************************************************/</span>
04556 
<a name="l04557"></a><a class="code" href="../../d4/d1/userk_8h.html#a2072">04557</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a2072">CheckHandleInUse</a>(
04558     HANDLE hObject)
04559 {
04560     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRet;
04561 
04562     <a class="code" href="../../d4/d1/userk_8h.html#a2074">EnterHandleFlagsCrit</a>();
04563     fRet = ((<a class="code" href="../../d9/d6/desktop_8c.html#a4">gProcessInUse</a> == <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()) &amp;&amp;
04564             (<a class="code" href="../../d9/d6/desktop_8c.html#a5">gHandleInUse</a> == hObject));
04565     <a class="code" href="../../d4/d1/userk_8h.html#a2075">LeaveHandleFlagsCrit</a>();
04566 
04567     <span class="keywordflow">return</span> fRet;
04568 }
04569 
04570 <span class="comment">/***************************************************************************\</span>
04571 <span class="comment">* SetHandleInUse</span>
04572 <span class="comment">*</span>
04573 <span class="comment">* Mark the handle as in use.</span>
04574 <span class="comment">*</span>
04575 <span class="comment">* History:</span>
04576 <span class="comment">* 02-Jun-1999 JerrySh   Created.</span>
04577 <span class="comment">\***************************************************************************/</span>
04578 
<a name="l04579"></a><a class="code" href="../../d4/d1/userk_8h.html#a2071">04579</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a2071">SetHandleInUse</a>(
04580     HANDLE hObject)
04581 {
04582     <a class="code" href="../../d4/d1/userk_8h.html#a2074">EnterHandleFlagsCrit</a>();
04583     <a class="code" href="../../d9/d6/desktop_8c.html#a4">gProcessInUse</a> = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
04584     <a class="code" href="../../d9/d6/desktop_8c.html#a5">gHandleInUse</a> = hObject;
04585     <a class="code" href="../../d4/d1/userk_8h.html#a2075">LeaveHandleFlagsCrit</a>();
04586 }
04587 
<a name="l04588"></a><a class="code" href="../../d4/d1/userk_8h.html#a1280">04588</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d4/d1/userk_8h.html#a1280">xxxResolveDesktopForWOW</a> (
04589     IN OUT PUNICODE_STRING pstrDesktop)
04590 {
04591     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>           <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04592     UNICODE_STRING     strDesktop, strWinSta, strStatic;
04593     LPWSTR             pszDesktop;
04594     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>               fWinStaDefaulted;
04595     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>               fDesktopDefaulted;
04596     HWINSTA            hwinsta;
04597     HDESK              hdesk;
04598     OBJECT_ATTRIBUTES  ObjA;
04599     PUNICODE_STRING    pstrStatic;
04600     POBJECT_ATTRIBUTES pObjA = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04601     SIZE_T             cbObjA;
04602     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bShutDown = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04603     PTEB               pteb = NtCurrentTeb();
04604 
04605     UserAssert(pteb);
04606 
04607     <span class="comment">/*</span>
04608 <span class="comment">     * Determine windowstation and desktop names.</span>
04609 <span class="comment">     */</span>
04610 
04611 
04612     <span class="keywordflow">if</span> (pstrDesktop == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04613         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
04614     }
04615 
04616     strStatic.Length = 0;
04617     strStatic.MaximumLength = STATIC_UNICODE_BUFFER_LENGTH * <span class="keyword">sizeof</span>(WCHAR);
04618 
04619     <span class="comment">/*</span>
04620 <span class="comment">     * Use the StaticUnicodeBuffer on the TEB as the buffer for the object name.</span>
04621 <span class="comment">     * Even if this is client side and we pass KernelMode to the Ob call in</span>
04622 <span class="comment">     * _OpenWindowStation this is safe because the TEB is not going to go away</span>
04623 <span class="comment">     * during this call. The worst it can happen is to have the buffer in the TEB</span>
04624 <span class="comment">     * trashed.</span>
04625 <span class="comment">     */</span>
04626     strStatic.Buffer = pteb-&gt;StaticUnicodeBuffer;
04627 
04628     UserAssert(pteb-&gt;StaticUnicodeBuffer == pteb-&gt;StaticUnicodeString.Buffer);
04629     UserAssert(pteb-&gt;StaticUnicodeString.MaximumLength ==STATIC_UNICODE_BUFFER_LENGTH * <span class="keyword">sizeof</span>(WCHAR));
04630 
04631     <span class="keywordflow">if</span> (pstrDesktop-&gt;Length == 0) {
04632         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strDesktop, TEXT(<span class="stringliteral">"Default"</span>));
04633         fWinStaDefaulted = fDesktopDefaulted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04634     } <span class="keywordflow">else</span> {
04635         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> cch;
04636         <span class="comment">/*</span>
04637 <span class="comment">         * The name be of the form windowstation\desktop.  Parse</span>
04638 <span class="comment">         * the string to separate out the names.</span>
04639 <span class="comment">         */</span>
04640         strWinSta = *pstrDesktop;
04641         cch = strWinSta.Length / <span class="keyword">sizeof</span>(WCHAR);
04642         pszDesktop = strWinSta.Buffer;
04643         <span class="keywordflow">while</span> (cch &amp;&amp; *pszDesktop != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>) {
04644             cch--;
04645             pszDesktop++;
04646         }
04647         fDesktopDefaulted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04648 
04649         <span class="keywordflow">if</span> (cch == 0) {
04650 
04651             <span class="comment">/*</span>
04652 <span class="comment">             * No windowstation name was specified, only the desktop.</span>
04653 <span class="comment">             */</span>
04654             strDesktop = strWinSta;
04655             fWinStaDefaulted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04656         } <span class="keywordflow">else</span> {
04657             <span class="comment">/*</span>
04658 <span class="comment">             * Both names were in the string.</span>
04659 <span class="comment">             */</span>
04660             strDesktop.Buffer = pszDesktop + 1;
04661             strDesktop.Length = strDesktop.MaximumLength = (cch - 1) * <span class="keyword">sizeof</span>(WCHAR);
04662             strWinSta.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(pszDesktop - strWinSta.Buffer) * <span class="keyword">sizeof</span>(WCHAR);
04663 
04664             <span class="comment">/*</span>
04665 <span class="comment">             * zero terminate the strWinSta buffer so the rebuild of the desktop</span>
04666 <span class="comment">             * name at the end of the function works.</span>
04667 <span class="comment">             */</span>
04668             *pszDesktop = (WCHAR)0;
04669 
04670             fWinStaDefaulted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04671 
04672             <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;strStatic, (PWSTR)<a class="code" href="../../d6/d8/clinit_8c.html#a9">szWindowStationDirectory</a>);
04673             <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;strStatic, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span>);
04674             <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;strStatic, &amp;strWinSta);
04675 
04676         }
04677     }
04678 
04679     <span class="keywordflow">if</span> (fWinStaDefaulted) {
04680 
04681         <span class="comment">//Default Window Station</span>
04682         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strWinSta, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"WinSta0"</span>);
04683 
04684         <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;strStatic, (PWSTR)<a class="code" href="../../d6/d8/clinit_8c.html#a9">szWindowStationDirectory</a>);
04685         <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;strStatic, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span>);
04686         <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;strStatic, &amp;strWinSta);
04687 
04688     }
04689 
04690     <span class="comment">/*</span>
04691 <span class="comment">     * Open the computed windowstation. This will also do an access check</span>
04692 <span class="comment">     */</span>
04693     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a332">gbSecureDesktop</a>) {
04694         <span class="comment">/*</span>
04695 <span class="comment">         * Allocate an object attributes structure in user address space.</span>
04696 <span class="comment">         */</span>
04697         cbObjA = <span class="keyword">sizeof</span>(*pObjA) + <span class="keyword">sizeof</span>(*pstrStatic);
04698         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory(NtCurrentProcess(),
04699                 &amp;pObjA, 0, &amp;cbObjA, MEM_COMMIT, PAGE_READWRITE);
04700         pstrStatic = (PUNICODE_STRING)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pObjA + <span class="keyword">sizeof</span>(*pObjA));
04701 
04702         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
04703             <span class="comment">/*</span>
04704 <span class="comment">             * Note -- the string must be in client-space or the</span>
04705 <span class="comment">             * address validation in OpenWindowStation will fail.</span>
04706 <span class="comment">             */</span>
04707             <span class="keywordflow">try</span> {
04708                 *pstrStatic = strStatic;
04709                 InitializeObjectAttributes( pObjA,
04710                                             pstrStatic,
04711                                             OBJ_CASE_INSENSITIVE,
04712                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04713                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
04714                                             );
04715             } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
04716                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
04717             }
04718 
04719             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
04720                 hwinsta = <a class="code" href="../../d8/d8/winsta_8c.html#a8">_OpenWindowStation</a>(pObjA, MAXIMUM_ALLOWED, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
04721             } <span class="keywordflow">else</span> {
04722                 hwinsta = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04723             }
04724             <span class="keywordflow">if</span> (!hwinsta) {
04725                 ZwFreeVirtualMemory(NtCurrentProcess(), &amp;pObjA, &amp;cbObjA,
04726                         MEM_RELEASE);
04727                 <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
04728             }
04729         } <span class="keywordflow">else</span> {
04730             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
04731         }
04732     } <span class="keywordflow">else</span> {
04733         InitializeObjectAttributes( &amp;ObjA,
04734                                     &amp;strStatic,
04735                                     OBJ_CASE_INSENSITIVE,
04736                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04737                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
04738                                     );
04739         hwinsta = <a class="code" href="../../d8/d8/winsta_8c.html#a8">_OpenWindowStation</a>(&amp;ObjA, MAXIMUM_ALLOWED, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>);
04740         <span class="keywordflow">if</span> (!hwinsta) {
04741             <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
04742         }
04743     }
04744 
04745     <span class="comment">/*</span>
04746 <span class="comment">     * Do an access check on the desktop by opening it</span>
04747 <span class="comment">     */</span>
04748 
04749     <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>(&amp;strStatic, &amp;strDesktop);
04750 
04751     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a332">gbSecureDesktop</a>) {
04752         <span class="comment">/*</span>
04753 <span class="comment">         * Note -- the string must be in client-space or the</span>
04754 <span class="comment">         * address validation in OpenDesktop will fail.</span>
04755 <span class="comment">         */</span>
04756         <span class="keywordflow">try</span> {
04757             *pstrStatic = strStatic;
04758             InitializeObjectAttributes( pObjA,
04759                                         pstrStatic,
04760                                         OBJ_CASE_INSENSITIVE,
04761                                         hwinsta,
04762                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
04763                                         );
04764         } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
04765             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
04766         }
04767 
04768         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
04769             hdesk = <a class="code" href="../../d4/d1/userk_8h.html#a1796">xxxOpenDesktop</a>(pObjA,
04770                                    <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
04771                                    0,
04772                                    MAXIMUM_ALLOWED,
04773                                    &amp;bShutDown);
04774         } <span class="keywordflow">else</span> {
04775             hdesk = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04776         }
04777 
04778         ZwFreeVirtualMemory(NtCurrentProcess(), &amp;pObjA, &amp;cbObjA,
04779                 MEM_RELEASE);
04780     } <span class="keywordflow">else</span> {
04781         InitializeObjectAttributes( &amp;ObjA,
04782                                     &amp;strStatic,
04783                                     OBJ_CASE_INSENSITIVE,
04784                                     hwinsta,
04785                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
04786                                     );
04787         hdesk = <a class="code" href="../../d4/d1/userk_8h.html#a1796">xxxOpenDesktop</a>(&amp;ObjA,
04788                                <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
04789                                0,
04790                                MAXIMUM_ALLOWED,
04791                                &amp;bShutDown);
04792     }
04793 
04794     <span class="keywordflow">if</span> (!hdesk) {
04795         UserVerify(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ZwClose(hwinsta)));
04796         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
04797     }
04798 
04799     <a class="code" href="../../d4/d1/userk_8h.html#a2073">CloseProtectedHandle</a>(hdesk);
04800     UserVerify(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ZwClose(hwinsta)));
04801 
04802     <span class="comment">/*</span>
04803 <span class="comment">     * Copy the final Computed String</span>
04804 <span class="comment">     */</span>
04805     <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>(pstrDesktop, &amp;strWinSta);
04806     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(pstrDesktop, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span>);
04807     <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(pstrDesktop, &amp;strDesktop);
04808 
04809     <span class="keywordflow">return</span> STATUS_SUCCESS;
04810 }
04811 <span class="comment">/***************************************************************************\</span>
04812 <span class="comment">* xxxResolveDesktop</span>
04813 <span class="comment">*</span>
04814 <span class="comment">* Attempts to return handles to a windowstation and desktop associated</span>
04815 <span class="comment">* with the logon session.</span>
04816 <span class="comment">*</span>
04817 <span class="comment">* History:</span>
04818 <span class="comment">* 25-Apr-1994 JimA      Created.</span>
04819 <span class="comment">\***************************************************************************/</span>
04820 
<a name="l04821"></a><a class="code" href="../../d4/d1/userk_8h.html#a1279">04821</a> HDESK <a class="code" href="../../d4/d1/userk_8h.html#a1279">xxxResolveDesktop</a>(
04822     HANDLE          hProcess,
04823     PUNICODE_STRING pstrDesktop,
04824     HWINSTA         *phwinsta,
04825     BOOL            fInherit,
04826     BOOL*           pbShutDown)
04827 {
04828     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>          Process;
04829     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>       ppi;
04830     HWINSTA            hwinsta;
04831     HDESK              hdesk;
04832     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>           pdesk;
04833     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>     pwinsta;
04834     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>               fInteractive;
04835     UNICODE_STRING     strDesktop;
04836     UNICODE_STRING     strWinSta, strStatic;
04837     OBJECT_ATTRIBUTES  ObjA;
04838     PUNICODE_STRING    pstrStatic;
04839     POBJECT_ATTRIBUTES pObjA = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04840     SIZE_T             cbObjA;
04841     LPWSTR             pszDesktop;
04842     WCHAR              awchName[<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Service-0x0000-0000$"</span>) / <span class="keyword">sizeof</span>(WCHAR)];
04843     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>               fWinStaDefaulted;
04844     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>               fDesktopDefaulted;
04845     LUID               luidService;
04846     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>           <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04847     HWINSTA            hwinstaDup;
04848     PTEB               pteb = NtCurrentTeb();
04849 
04850     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
04851 
04852     UserAssert(pteb);
04853 
04854     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(hProcess,
04855                                        PROCESS_QUERY_INFORMATION,
04856                                        *<a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>,
04857                                        <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
04858                                        &amp;Process,
04859                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04860     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
04861        RIPMSG1(RIP_WARNING, <span class="stringliteral">"ResolveDesktop: Could not reference process handle (0x%X)"</span>, hProcess);
04862        <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04863     }
04864 
04865     strStatic.Length = 0;
04866     strStatic.MaximumLength = STATIC_UNICODE_BUFFER_LENGTH * <span class="keyword">sizeof</span>(WCHAR);
04867 
04868     <span class="comment">/*</span>
04869 <span class="comment">     * Use the StaticUnicodeBuffer on the TEB as the buffer for the object name.</span>
04870 <span class="comment">     * Even if this is client side and we pass KernelMode to the Ob call in</span>
04871 <span class="comment">     * _OpenWindowStation this is safe because the TEB is not going to go away</span>
04872 <span class="comment">     * during this call. The worst it can happen is to have the buffer in the TEB</span>
04873 <span class="comment">     * trashed.</span>
04874 <span class="comment">     */</span>
04875     strStatic.Buffer = pteb-&gt;StaticUnicodeBuffer;
04876 
04877     UserAssert(pteb-&gt;StaticUnicodeBuffer == pteb-&gt;StaticUnicodeString.Buffer);
04878     UserAssert(pteb-&gt;StaticUnicodeString.MaximumLength ==STATIC_UNICODE_BUFFER_LENGTH * <span class="keyword">sizeof</span>(WCHAR));
04879     <span class="comment">/*</span>
04880 <span class="comment">     * The static unicode buffer in the teb</span>
04881 <span class="comment">    /*</span>
04882 <span class="comment">     * If the process already has a windowstation and a startup desktop,</span>
04883 <span class="comment">     * return them.</span>
04884 <span class="comment">     */</span>
04885     hwinsta = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04886     hwinstaDup = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04887     hdesk = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04888     ppi = <a class="code" href="../../d4/d1/userk_8h.html#a18">PpiFromProcess</a>(Process);
04889 
04890     <span class="comment">/*</span>
04891 <span class="comment">     * Make sure the process has not been destroyed. Bug 214643</span>
04892 <span class="comment">     */</span>
04893     <span class="keywordflow">if</span> (ppi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04894 
04895         <span class="keywordflow">if</span> (ppi-&gt;W32PF_Flags &amp; W32PF_TERMINATED) {
04896 
04897             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
04898 
04899             RIPMSG1(RIP_WARNING, <span class="stringliteral">"xxxResolveDesktop: ppi %#p has been destroyed"</span>, ppi);
04900             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04901         }
04902 
04903         <span class="keywordflow">if</span> (ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o15">hwinsta</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o10">hdeskStartup</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04904 
04905             <span class="comment">/*</span>
04906 <span class="comment">             * If the target process is the current process, simply</span>
04907 <span class="comment">             * return the handles.  Otherwise, open the objects.</span>
04908 <span class="comment">             */</span>
04909             <span class="keywordflow">if</span> (Process == <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()) {
04910                 hwinsta = ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o15">hwinsta</a>;
04911                 hdesk = ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o10">hdeskStartup</a>;
04912             } <span class="keywordflow">else</span> {
04913                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a3">ObOpenObjectByPointer</a>(
04914                         ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o14">rpwinsta</a>,
04915                         0,
04916                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04917                         MAXIMUM_ALLOWED,
04918                         *<a class="code" href="../../d3/d7/win32_8c.html#a0">ExWindowStationObjectType</a>,
04919                         (<a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>)(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a332">gbSecureDesktop</a> ? <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>),
04920                         &amp;hwinsta);
04921                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
04922                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a3">ObOpenObjectByPointer</a>(
04923                             ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o3">rpdeskStartup</a>,
04924                             0,
04925                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04926                             MAXIMUM_ALLOWED,
04927                             *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>,
04928                             (<a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>)(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a332">gbSecureDesktop</a> ? <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>),
04929                             &amp;hdesk);
04930                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
04931                         UserVerify(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ZwClose(hwinsta)));
04932                         hwinsta = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04933                     }
04934                 }
04935                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
04936                     RIPNTERR2(
04937                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>,
04938                             RIP_WARNING,
04939                             <span class="stringliteral">"ResolveDesktop: Could not reference winsta=%#p and/or desk=%#p"</span>,
04940                             ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o14">rpwinsta</a>, ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o3">rpdeskStartup</a>);
04941                 }
04942             }
04943 
04944             RIPMSG2(RIP_VERBOSE,
04945                     <span class="stringliteral">"ResolveDesktop: to hwinsta=%#p desktop=%#p"</span>,
04946                     hwinsta, hdesk);
04947 
04948             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
04949             *phwinsta = hwinsta;
04950             <span class="keywordflow">return</span> hdesk;
04951         }
04952     }
04953 
04954     <span class="comment">/*</span>
04955 <span class="comment">     * Determine windowstation and desktop names.</span>
04956 <span class="comment">     */</span>
04957     <span class="keywordflow">if</span> (pstrDesktop == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || pstrDesktop-&gt;Length == 0) {
04958         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strDesktop, TEXT(<span class="stringliteral">"Default"</span>));
04959         fWinStaDefaulted = fDesktopDefaulted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04960     } <span class="keywordflow">else</span> {
04961         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> cch;
04962         <span class="comment">/*</span>
04963 <span class="comment">         * The name be of the form windowstation\desktop.  Parse</span>
04964 <span class="comment">         * the string to separate out the names.</span>
04965 <span class="comment">         */</span>
04966         strWinSta = *pstrDesktop;
04967         cch = strWinSta.Length / <span class="keyword">sizeof</span>(WCHAR);
04968         pszDesktop = strWinSta.Buffer;
04969         <span class="keywordflow">while</span> (cch &amp;&amp; *pszDesktop != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>) {
04970             cch--;
04971             pszDesktop++;
04972         }
04973         fDesktopDefaulted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04974 
04975         <span class="keywordflow">if</span> (cch == 0) {
04976 
04977             <span class="comment">/*</span>
04978 <span class="comment">             * No windowstation name was specified, only the desktop.</span>
04979 <span class="comment">             */</span>
04980             strDesktop = strWinSta;
04981             fWinStaDefaulted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04982         } <span class="keywordflow">else</span> {
04983              <span class="comment">/*</span>
04984 <span class="comment">             * Both names were in the string.</span>
04985 <span class="comment">             */</span>
04986             strDesktop.Buffer = pszDesktop + 1;
04987             strDesktop.Length = strDesktop.MaximumLength = (cch - 1) * <span class="keyword">sizeof</span>(WCHAR);
04988             strWinSta.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(pszDesktop - strWinSta.Buffer) * <span class="keyword">sizeof</span>(WCHAR);
04989             fWinStaDefaulted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04990 
04991             <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;strStatic, (PWSTR)<a class="code" href="../../d6/d8/clinit_8c.html#a9">szWindowStationDirectory</a>);
04992             <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;strStatic, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span>);
04993             <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;strStatic, &amp;strWinSta);
04994 
04995             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1278">_UserTestForWinStaAccess</a>(&amp;strStatic,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))) {
04996                 <span class="keywordflow">if</span> (strStatic.MaximumLength &gt; strStatic.Length)
04997                     strStatic.Buffer[strStatic.Length/<span class="keyword">sizeof</span>(WCHAR)] = 0;
04998                 <span class="keywordflow">else</span>
04999                     strStatic.Buffer[(strStatic.Length - <span class="keyword">sizeof</span>(WCHAR))/<span class="keyword">sizeof</span>(WCHAR)] = 0;
05000                 RIPMSG2(RIP_WARNING,
05001                         <span class="stringliteral">"ResolveDesktop: Error (0x%X) resolving to WinSta='%ws'"</span>,
05002                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, strStatic.Buffer);
05003                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
05004                 *phwinsta = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05005                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05006             }
05007 
05008         }
05009     }
05010 
05011     <span class="comment">/*</span>
05012 <span class="comment">     * If the desktop name is defaulted, make the handles</span>
05013 <span class="comment">     * not inheritable.</span>
05014 <span class="comment">     */</span>
05015     <span class="keywordflow">if</span> (fDesktopDefaulted)
05016         fInherit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05017 
05018     <span class="comment">/*</span>
05019 <span class="comment">     * If a windowstation has not been assigned to this process yet and</span>
05020 <span class="comment">     * there are existing windowstations, attempt an open.</span>
05021 <span class="comment">     */</span>
05022     <span class="keywordflow">if</span> (hwinsta == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a>) {
05023 
05024         <span class="comment">/*</span>
05025 <span class="comment">         * If the windowstation name was defaulted, create a name</span>
05026 <span class="comment">         * based on the session.</span>
05027 <span class="comment">         */</span>
05028         <span class="keywordflow">if</span> (fWinStaDefaulted) {
05029             <span class="comment">//Default Window Station</span>
05030             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strWinSta, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"WinSta0"</span>);
05031 
05032             <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;strStatic, (PWSTR)<a class="code" href="../../d6/d8/clinit_8c.html#a9">szWindowStationDirectory</a>);
05033             <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;strStatic, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span>);
05034             <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;strStatic, &amp;strWinSta);
05035 
05036             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>) {
05037                 <span class="comment">/*</span>
05038 <span class="comment">                 * Fake this out if it's an non-interactive winstation startup.</span>
05039 <span class="comment">                 * We don't want an extra winsta.</span>
05040 <span class="comment">                 */</span>
05041                 fInteractive = <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d4/d1/userk_8h.html#a1278">_UserTestForWinStaAccess</a>(&amp;strStatic, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
05042             } <span class="keywordflow">else</span> {
05043                 fInteractive = <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d4/d1/userk_8h.html#a1278">_UserTestForWinStaAccess</a>(&amp;strStatic,fInherit));
05044             }
05045 
05046             <span class="keywordflow">if</span> (!fInteractive) {
05047                     <a class="code" href="../../d4/d1/userk_8h.html#a961">GetProcessLuid</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;luidService);
05048                     swprintf(awchName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Service-0x%x-%x$"</span>,
05049                             luidService.HighPart, luidService.LowPart);
05050                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strWinSta, awchName);
05051             }
05052         }
05053 
05054         <span class="comment">/*</span>
05055 <span class="comment">         * If no windowstation name was passed in and a windowstation</span>
05056 <span class="comment">         * handle was inherited, assign it.</span>
05057 <span class="comment">         */</span>
05058         <span class="keywordflow">if</span> (fWinStaDefaulted) {
05059             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d6/desktop_8c.html#a33">xxxUserFindHandleForObject</a>(Process, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, *<a class="code" href="../../d3/d7/win32_8c.html#a0">ExWindowStationObjectType</a>,
05060                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;hwinsta)) {
05061 
05062                 <span class="comment">/*</span>
05063 <span class="comment">                 * If the handle belongs to another process,</span>
05064 <span class="comment">                 * dup it into this one</span>
05065 <span class="comment">                 */</span>
05066                 <span class="keywordflow">if</span> (Process != <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()) {
05067 
05068                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1275">xxxUserDuplicateObject</a>(
05069                             hProcess,
05070                             hwinsta,
05071                             NtCurrentProcess(),
05072                             &amp;hwinstaDup,
05073                             0,
05074                             0,
05075                             DUPLICATE_SAME_ACCESS);
05076                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
05077                         hwinsta = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05078                     } <span class="keywordflow">else</span> {
05079                         hwinsta = hwinstaDup;
05080                     }
05081                 }
05082             }
05083         }
05084 
05085         <span class="comment">/*</span>
05086 <span class="comment">         * If we were assigned to a windowstation, make sure</span>
05087 <span class="comment">         * it matches our fInteractive flag</span>
05088 <span class="comment">         */</span>
05089         <span class="keywordflow">if</span> (hwinsta != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05090             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(hwinsta,
05091                                                0,
05092                                                *<a class="code" href="../../d3/d7/win32_8c.html#a0">ExWindowStationObjectType</a>,
05093                                                <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
05094                                                &amp;pwinsta,
05095                                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05096             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
05097                 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fIO = (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05098                 <span class="keywordflow">if</span> (fIO != fInteractive) {
05099                     <span class="keywordflow">if</span> (hwinstaDup) {
05100                         <a class="code" href="../../d4/d1/userk_8h.html#a2073">CloseProtectedHandle</a>(hwinsta);
05101                     }
05102                     hwinsta = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05103                 }
05104                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pwinsta);
05105             }
05106         }
05107 
05108         <span class="comment">/*</span>
05109 <span class="comment">         * If not, open the computed windowstation.</span>
05110 <span class="comment">         */</span>
05111         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp; hwinsta == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05112 
05113             <span class="comment">/*</span>
05114 <span class="comment">             * Fill in the path to the windowstation</span>
05115 <span class="comment">             */</span>
05116             strStatic.Length = 0;
05117             <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;strStatic, (PWSTR)<a class="code" href="../../d6/d8/clinit_8c.html#a9">szWindowStationDirectory</a>);
05118             <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;strStatic, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span>);
05119             <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;strStatic, &amp;strWinSta);
05120 
05121             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a332">gbSecureDesktop</a>) {
05122                 <span class="comment">/*</span>
05123 <span class="comment">                 * Allocate an object attributes structure in user address space.</span>
05124 <span class="comment">                 */</span>
05125                 cbObjA = <span class="keyword">sizeof</span>(*pObjA) + <span class="keyword">sizeof</span>(*pstrStatic);
05126                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory(NtCurrentProcess(),
05127                         &amp;pObjA, 0, &amp;cbObjA, MEM_COMMIT, PAGE_READWRITE);
05128                 pstrStatic = (PUNICODE_STRING)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pObjA + <span class="keyword">sizeof</span>(*pObjA));
05129 
05130                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
05131                     <span class="comment">/*</span>
05132 <span class="comment">                     * Note -- the string must be in client-space or the</span>
05133 <span class="comment">                     * address validation in OpenWindowStation will fail.</span>
05134 <span class="comment">                     */</span>
05135                     <span class="keywordflow">try</span> {
05136                         *pstrStatic = strStatic;
05137                         InitializeObjectAttributes( pObjA,
05138                                                     pstrStatic,
05139                                                     OBJ_CASE_INSENSITIVE,
05140                                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05141                                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
05142                                                     );
05143                         <span class="keywordflow">if</span> (fInherit)
05144                             pObjA-&gt;Attributes |= OBJ_INHERIT;
05145                     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
05146                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
05147                     }
05148 
05149                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
05150                         hwinsta = <a class="code" href="../../d8/d8/winsta_8c.html#a8">_OpenWindowStation</a>(pObjA, MAXIMUM_ALLOWED, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
05151                     }
05152                 }
05153             } <span class="keywordflow">else</span> {
05154                 InitializeObjectAttributes( &amp;ObjA,
05155                                             &amp;strStatic,
05156                                             OBJ_CASE_INSENSITIVE,
05157                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05158                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
05159                                             );
05160                 <span class="keywordflow">if</span> (fInherit)
05161                     ObjA.Attributes |= OBJ_INHERIT;
05162                 hwinsta = <a class="code" href="../../d8/d8/winsta_8c.html#a8">_OpenWindowStation</a>(&amp;ObjA, MAXIMUM_ALLOWED, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>);
05163             }
05164         }
05165 
05166         <span class="comment">/*</span>
05167 <span class="comment">         * Only allow service logons at the console.  I don't think our</span>
05168 <span class="comment">         * win32k exit routines cope with more than one windowstation.</span>
05169 <span class="comment">         */</span>
05170         <span class="comment">/*</span>
05171 <span class="comment">         * If the open failed and the process is in a non-interactive</span>
05172 <span class="comment">         * logon session, attempt to create a windowstation and</span>
05173 <span class="comment">         * desktop for that session.  Note that the desktop handle</span>
05174 <span class="comment">         * will be closed after the desktop has been assigned.</span>
05175 <span class="comment">         */</span>
05176         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a> &amp;&amp; <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp;
05177             hwinsta == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; !fInteractive &amp;&amp; fWinStaDefaulted) {
05178 
05179             *phwinsta = <a class="code" href="../../d4/d1/userk_8h.html#a1276">xxxConnectService</a>(
05180                     &amp;strStatic,
05181                     &amp;hdesk);
05182 
05183             <span class="comment">/*</span>
05184 <span class="comment">             * Clean up and leave.</span>
05185 <span class="comment">             */</span>
05186             <span class="keywordflow">if</span> (pObjA != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05187                 ZwFreeVirtualMemory(NtCurrentProcess(), &amp;pObjA, &amp;cbObjA,
05188                         MEM_RELEASE);
05189             }
05190             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
05191 
05192             RIPMSG2(RIP_VERBOSE,
05193                     <span class="stringliteral">"ResolveDesktop: xxxConnectService was called\n"</span>
05194                     <span class="stringliteral">"to hwinsta=%#p desktop=%#p"</span>,
05195                     *phwinsta, hdesk);
05196 
05197             <span class="keywordflow">return</span> hdesk;
05198         }
05199     }
05200 
05201     <span class="comment">/*</span>
05202 <span class="comment">     * Attempt to assign a desktop.</span>
05203 <span class="comment">     */</span>
05204     <span class="keywordflow">if</span> (hwinsta != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05205 
05206         <span class="comment">/*</span>
05207 <span class="comment">         * Every gui thread needs an associated desktop.  We'll use the default</span>
05208 <span class="comment">         * to start with and the application can override it if it wants.</span>
05209 <span class="comment">         */</span>
05210         <span class="keywordflow">if</span> (hdesk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05211 
05212             <span class="comment">/*</span>
05213 <span class="comment">             * If no desktop name was passed in and a desktop</span>
05214 <span class="comment">             * handle was inherited, assign it.</span>
05215 <span class="comment">             */</span>
05216             <span class="keywordflow">if</span> (fDesktopDefaulted) {
05217                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d6/desktop_8c.html#a33">xxxUserFindHandleForObject</a>(Process, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>,
05218                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;hdesk)) {
05219 
05220                     <span class="comment">/*</span>
05221 <span class="comment">                     * If the handle belongs to another process,</span>
05222 <span class="comment">                     * dup it into this one</span>
05223 <span class="comment">                     */</span>
05224                     <span class="keywordflow">if</span> (Process != <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()) {
05225                         HDESK hdeskDup;
05226 
05227                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1275">xxxUserDuplicateObject</a>(
05228                                 hProcess,
05229                                 hdesk,
05230                                 NtCurrentProcess(),
05231                                 &amp;hdeskDup,
05232                                 0,
05233                                 0,
05234                                 DUPLICATE_SAME_ACCESS);
05235                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
05236                             <a class="code" href="../../d4/d1/userk_8h.html#a2073">CloseProtectedHandle</a>(hdesk);
05237                             hdesk = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05238                         } <span class="keywordflow">else</span> {
05239                             hdesk = hdeskDup;
05240                         }
05241                     }
05242 
05243                     <span class="comment">/*</span>
05244 <span class="comment">                     * Map the desktop into the process.</span>
05245 <span class="comment">                     */</span>
05246                     <span class="keywordflow">if</span> (hdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; ppi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05247                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(hdesk,
05248                                                   0,
05249                                                   *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>,
05250                                                   <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
05251                                                   &amp;pdesk,
05252                                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05253                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
05254 
05255                             <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdesk, LD_REF_FN_RESOLVEDESKTOP, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
05256 
05257                             <span class="keywordflow">try</span> {
05258                                 <a class="code" href="../../d4/d1/userk_8h.html#a1289">MapDesktop</a>(<a class="code" href="../../d4/d0/ob_8h.html#a100a59">ObOpenHandle</a>, Process, pdesk, 0, 1);
05259                             } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, RIP_WARNING)) {
05260                                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
05261                                 <a class="code" href="../../d4/d1/userk_8h.html#a2073">CloseProtectedHandle</a>(hdesk);
05262                                 hdesk = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05263                             }
05264 <span class="preprocessor">#if DBG</span>
05265 <span class="preprocessor"></span>                            <span class="keywordflow">if</span> (hdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05266                                 UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a1283">GetDesktopView</a>(ppi, pdesk) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05267                             }
05268 <span class="preprocessor">#endif // DBG</span>
05269 <span class="preprocessor"></span>                            <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdesk, LD_DEREF_FN_RESOLVEDESKTOP, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
05270                             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pdesk);
05271                         } <span class="keywordflow">else</span> {
05272                             <a class="code" href="../../d4/d1/userk_8h.html#a2073">CloseProtectedHandle</a>(hdesk);
05273                             hdesk = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05274                         }
05275                     }
05276                 }
05277             }
05278 
05279             <span class="comment">/*</span>
05280 <span class="comment">             * If not, open the desktop.</span>
05281 <span class="comment">             */</span>
05282             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp; hdesk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05283                 <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>(&amp;strStatic, &amp;strDesktop);
05284 
05285                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a332">gbSecureDesktop</a>) {
05286                     <span class="keywordflow">if</span> (pObjA == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05287                         <span class="comment">/*</span>
05288 <span class="comment">                         * Allocate an object attributes structure in user address space.</span>
05289 <span class="comment">                         */</span>
05290                         cbObjA = <span class="keyword">sizeof</span>(*pObjA) + <span class="keyword">sizeof</span>(*pstrStatic);
05291                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory(NtCurrentProcess(),
05292                                 &amp;pObjA, 0, &amp;cbObjA, MEM_COMMIT, PAGE_READWRITE);
05293                         pstrStatic = (PUNICODE_STRING)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pObjA + <span class="keyword">sizeof</span>(*pObjA));
05294                     }
05295 
05296                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
05297                         <span class="comment">/*</span>
05298 <span class="comment">                         * Note -- the string must be in client-space or the</span>
05299 <span class="comment">                         * address validation in OpenDesktop will fail.</span>
05300 <span class="comment">                         */</span>
05301                         <span class="keywordflow">try</span> {
05302                             *pstrStatic = strStatic;
05303                             InitializeObjectAttributes( pObjA,
05304                                                         pstrStatic,
05305                                                         OBJ_CASE_INSENSITIVE,
05306                                                         hwinsta,
05307                                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
05308                                                         );
05309                             <span class="keywordflow">if</span> (fInherit)
05310                                 pObjA-&gt;Attributes |= OBJ_INHERIT;
05311                         } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
05312                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
05313                         }
05314 
05315                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
05316                             hdesk = <a class="code" href="../../d4/d1/userk_8h.html#a1796">xxxOpenDesktop</a>(pObjA,
05317                                                    <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
05318                                                    0,
05319                                                    MAXIMUM_ALLOWED,
05320                                                    pbShutDown);
05321                         }
05322                     }
05323                 } <span class="keywordflow">else</span> {
05324                     InitializeObjectAttributes( &amp;ObjA,
05325                                                 &amp;strStatic,
05326                                                 OBJ_CASE_INSENSITIVE,
05327                                                 hwinsta,
05328                                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
05329                                                 );
05330                     <span class="keywordflow">if</span> (fInherit)
05331                         ObjA.Attributes |= OBJ_INHERIT;
05332                     hdesk = <a class="code" href="../../d4/d1/userk_8h.html#a1796">xxxOpenDesktop</a>(&amp;ObjA,
05333                                            <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
05334                                            0,
05335                                            MAXIMUM_ALLOWED,
05336                                            pbShutDown);
05337                 }
05338             }
05339         }
05340         <span class="keywordflow">if</span> (hdesk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05341             UserVerify(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ZwClose(hwinsta)));
05342             hwinsta = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05343         }
05344     }
05345 
05346     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
05347 
05348     <span class="keywordflow">if</span> (pObjA != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05349         ZwFreeVirtualMemory(NtCurrentProcess(), &amp;pObjA, &amp;cbObjA,
05350                 MEM_RELEASE);
05351     }
05352 
05353     *phwinsta = hwinsta;
05354 
05355     RIPMSG2(RIP_VERBOSE,
05356             <span class="stringliteral">"ResolveDesktop: to hwinsta=%#p desktop=%#p"</span>,
05357             *phwinsta, hdesk);
05358 
05359     <span class="keywordflow">return</span> hdesk;
05360 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:40 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
