<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: server.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>server.c</h1><a href="../../d9/d6/kernel_2server_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************************************************************\</span>
00002 <span class="comment">* Module Name: server.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Server support routines for the CSR stuff.  This basically performs the</span>
00007 <span class="comment">* startup/initialization for USER.</span>
00008 <span class="comment">*</span>
00009 <span class="comment">\**************************************************************************/</span>
00010 
00011 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00012 <span class="preprocessor">#pragma hdrstop</span>
00013 <span class="preprocessor"></span>
<a name="l00014"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a12">00014</a> <span class="keyword">extern</span> WORD <a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a11">gDispatchTableValues</a>;
00015 
<a name="l00016"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a13">00016</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d7/d2/power_8c.html#a0">gbUserInitialized</a>;
00017 
00018 <span class="comment">/*</span>
00019 <span class="comment"> * Initialization Routines (external).</span>
00020 <span class="comment"> */</span>
00021 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>     <a class="code" href="../../d6/d3/queue_8c.html#a55">InitQEntryLookaside</a>(VOID);
00022 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>     <a class="code" href="../../d3/d6/kernel_2sendmsg_8c.html#a14">InitSMSLookaside</a>(VOID);
00023 
00024 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    <a class="code" href="../../d9/d6/kernel_2server_8c.html#a51">InitCreateSharedSection</a>(VOID);
00025 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    <a class="code" href="../../d9/d6/kernel_2server_8c.html#a52">InitCreateObjectDirectory</a>(VOID);
00026 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        <a class="code" href="../../d9/d6/kernel_2server_8c.html#a68">InitCreateUserSubsystem</a>(VOID);
00027 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>        <a class="code" href="../../d9/d6/kernel_2server_8c.html#a54">InitFunctionTables</a>(VOID);
00028 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>        <a class="code" href="../../d9/d6/kernel_2server_8c.html#a55">InitMessageTables</a>(VOID);
00029 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>        <a class="code" href="../../d9/d6/kernel_2server_8c.html#a56">InitWindowMsgTable</a>(PBYTE*, PUINT, CONST WORD*);
00030 
00031 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>        <a class="code" href="../../d9/d6/kernel_2server_8c.html#a57">VerifySyncOnlyMessages</a>(VOID);
00032 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        <a class="code" href="../../d9/d6/kernel_2server_8c.html#a58">InitOLEFormats</a>(VOID);
00033 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    <a class="code" href="../../d9/d6/kernel_2server_8c.html#a59">Win32UserInitialize</a>(VOID);
00034 
00035 <span class="preprocessor">#pragma alloc_text(INIT, InitCreateSharedSection)</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, InitCreateUserCrit)</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, InitCreateObjectDirectory)</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, InitCreateUserSubsystem)</span>
00039 <span class="preprocessor"></span><span class="comment">//#pragma alloc_text(INIT, InitDbgTags)</span>
00040 <span class="preprocessor">#pragma alloc_text(INIT, InitFunctionTables)</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, InitMessageTables)</span>
00042 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, InitWindowMsgTable)</span>
00043 <span class="preprocessor"></span>
00044 <span class="preprocessor">#pragma alloc_text(INIT, VerifySyncOnlyMessages)</span>
00045 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, InitOLEFormats)</span>
00046 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, Win32UserInitialize)</span>
00047 <span class="preprocessor"></span>
00048 <span class="comment">/*</span>
00049 <span class="comment"> * Constants pertaining to the user-initialization.</span>
00050 <span class="comment"> */</span>
<a name="l00051"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a0">00051</a> <span class="preprocessor">#define USRINIT_SHAREDSECT_SIZE   32</span>
<a name="l00052"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a1">00052</a> <span class="preprocessor"></span><span class="preprocessor">#define USRINIT_ATOMBUCKET_SIZE   37</span>
00053 <span class="preprocessor"></span>
<a name="l00054"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a2">00054</a> <span class="preprocessor">#define USRINIT_WINDOWSECT_SIZE  512</span>
<a name="l00055"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a3">00055</a> <span class="preprocessor"></span><span class="preprocessor">#define USRINIT_NOIOSECT_SIZE    128</span>
00056 <span class="preprocessor"></span>
<a name="l00057"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a4">00057</a> <span class="preprocessor">#define USRINIT_SHAREDSECT_BUFF_SIZE     640</span>
<a name="l00058"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a5">00058</a> <span class="preprocessor"></span><span class="preprocessor">#define USRINIT_SHAREDSECT_READ_SIZE     (USRINIT_SHAREDSECT_BUFF_SIZE-33)</span>
00059 <span class="preprocessor"></span>
00060 
00061 <span class="comment">/***************************************************************************\</span>
00062 <span class="comment">* Globals stored in the INIT section. These should only be accessed at</span>
00063 <span class="comment">* load time!</span>
00064 <span class="comment">\***************************************************************************/</span>
00065 <span class="preprocessor">#ifdef ALLOC_DATA_PRAGMA</span>
00066 <span class="preprocessor"></span><span class="preprocessor">#pragma data_seg("INIT$Data")</span>
00067 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00068 <span class="preprocessor"></span>
<a name="l00069"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a14">00069</a> CONST WCHAR <a class="code" href="../../d9/d6/kernel_2server_8c.html#a14">szCHECKPOINT_PROP_NAME</a>[]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SysCP"</span>;
<a name="l00070"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a15">00070</a> CONST WCHAR <a class="code" href="../../d9/d6/kernel_2server_8c.html#a15">szDDETRACK_PROP_NAME</a>[]    = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SysDT"</span>;
<a name="l00071"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a16">00071</a> CONST WCHAR <a class="code" href="../../d9/d6/kernel_2server_8c.html#a16">szQOS_PROP_NAME</a>[]         = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SysQOS"</span>;
<a name="l00072"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a17">00072</a> CONST WCHAR <a class="code" href="../../d9/d6/kernel_2server_8c.html#a17">szDDEIMP_PROP_NAME</a>[]      = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SysDDEI"</span>;
<a name="l00073"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a18">00073</a> CONST WCHAR <a class="code" href="../../d9/d6/kernel_2server_8c.html#a18">szWNDOBJ_PROP_NAME</a>[]      = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SysWNDO"</span>;
<a name="l00074"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a19">00074</a> CONST WCHAR <a class="code" href="../../d9/d6/kernel_2server_8c.html#a19">szIMELEVEL_PROP_NAME</a>[]    = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SysIMEL"</span>;
<a name="l00075"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a20">00075</a> CONST WCHAR <a class="code" href="../../d9/d6/kernel_2server_8c.html#a20">szLAYER_PROP_NAME</a>[]       = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SysLayer"</span>;
<a name="l00076"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a21">00076</a> CONST WCHAR <a class="code" href="../../d1/d8/clglobal_8c.html#a12">szUSER32</a>[]                = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"USER32"</span>;
<a name="l00077"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a22">00077</a> CONST WCHAR <a class="code" href="../../d9/d6/kernel_2server_8c.html#a22">szMESSAGE</a>[]               = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Message"</span>;
<a name="l00078"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a23">00078</a> CONST WCHAR <a class="code" href="../../d9/d6/kernel_2server_8c.html#a23">szCONTEXTHELPIDPROP</a>[]     = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SysCH"</span>;
<a name="l00079"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a24">00079</a> CONST WCHAR <a class="code" href="../../d9/d6/kernel_2server_8c.html#a24">szICONSM_PROP_NAME</a>[]      = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SysICS"</span>;
<a name="l00080"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a25">00080</a> CONST WCHAR <a class="code" href="../../d9/d6/kernel_2server_8c.html#a25">szICON_PROP_NAME</a>[]        = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a3">ICON_PROP_NAME</a>;
<a name="l00081"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a26">00081</a> CONST WCHAR <a class="code" href="../../d9/d6/kernel_2server_8c.html#a26">szSHELLHOOK</a>[]             = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SHELLHOOK"</span>;
<a name="l00082"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a27">00082</a> CONST WCHAR <a class="code" href="../../d9/d6/kernel_2server_8c.html#a27">szACTIVATESHELLWINDOW</a>[]   = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ACTIVATESHELLWINDOW"</span>;
<a name="l00083"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a28">00083</a> CONST WCHAR <a class="code" href="../../d9/d6/kernel_2server_8c.html#a28">szOTHERWINDOWCREATED</a>[]    = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"OTHERWINDOWCREATED"</span>;
<a name="l00084"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a29">00084</a> CONST WCHAR <a class="code" href="../../d9/d6/kernel_2server_8c.html#a29">szOTHERWINDOWDESTROYED</a>[]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"OTHERWINDOWDESTROYED"</span>;
<a name="l00085"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a30">00085</a> CONST WCHAR <a class="code" href="../../d9/d6/kernel_2server_8c.html#a30">szOLEMAINTHREADWNDCLASS</a>[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"OleMainThreadWndClass"</span>;
<a name="l00086"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a31">00086</a> CONST WCHAR <a class="code" href="../../d9/d6/kernel_2server_8c.html#a31">szFLASHWSTATE</a>[]           = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"FlashWState"</span>;
00087 
00088 <span class="preprocessor">#ifdef HUNGAPP_GHOSTING</span>
00089 <span class="preprocessor"></span>CONST WCHAR szGHOST[]                 = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Ghost"</span>;
00090 <span class="preprocessor">#endif // HUNGAPP_GHOSTING</span>
00091 <span class="preprocessor"></span>
00092 
00093 <span class="comment">/***************************************************************************\</span>
00094 <span class="comment">* Message Tables</span>
00095 <span class="comment">*</span>
00096 <span class="comment">*   DefDlgProc</span>
00097 <span class="comment">*   MenuWndProc</span>
00098 <span class="comment">*   ScrollBarWndProc</span>
00099 <span class="comment">*   StaticWndProc</span>
00100 <span class="comment">*   ButtonWndProc</span>
00101 <span class="comment">*   ListboxWndProc</span>
00102 <span class="comment">*   ComboWndProc</span>
00103 <span class="comment">*   EditWndProc</span>
00104 <span class="comment">*   DefWindowMsgs</span>
00105 <span class="comment">*   DefWindowSpecMsgs</span>
00106 <span class="comment">*</span>
00107 <span class="comment">* These are used in InitMessageTables() to initialize gSharedInfo.awmControl[]</span>
00108 <span class="comment">* using the INITMSGTABLE() macro.</span>
00109 <span class="comment">*</span>
00110 <span class="comment">* 25-Aug-1995 ChrisWil  Created comment block.</span>
00111 <span class="comment">\***************************************************************************/</span>
00112 
<a name="l00113"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a32">00113</a> CONST WORD <a class="code" href="../../d9/d6/kernel_2server_8c.html#a32">gawDefDlgProc</a>[] = {
00114     WM_COMPAREITEM,
00115     WM_VKEYTOITEM,
00116     WM_CHARTOITEM,
00117     WM_INITDIALOG,
00118     WM_QUERYDRAGICON,
00119     WM_CTLCOLOR,
00120     WM_CTLCOLORMSGBOX,
00121     WM_CTLCOLOREDIT,
00122     WM_CTLCOLORLISTBOX,
00123     WM_CTLCOLORBTN,
00124     WM_CTLCOLORDLG,
00125     WM_CTLCOLORSCROLLBAR,
00126     WM_CTLCOLORSTATIC,
00127     WM_ERASEBKGND,
00128     WM_SHOWWINDOW,
00129     WM_SYSCOMMAND,
00130     WM_SYSKEYDOWN,
00131     WM_ACTIVATE,
00132     WM_SETFOCUS,
00133     WM_CLOSE,
00134     WM_NCDESTROY,
00135     WM_FINALDESTROY,
00136     DM_REPOSITION,
00137     DM_SETDEFID,
00138     DM_GETDEFID,
00139     WM_NEXTDLGCTL,
00140     WM_ENTERMENULOOP,
00141     WM_LBUTTONDOWN,
00142     WM_NCLBUTTONDOWN,
00143     WM_GETFONT,
00144     WM_NOTIFYFORMAT,
00145     WM_INPUTLANGCHANGEREQUEST,
00146     0
00147 };
00148 
<a name="l00149"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a33">00149</a> CONST WORD <a class="code" href="../../d9/d6/kernel_2server_8c.html#a33">gawMenuWndProc</a>[] = {
00150     WM_NCCREATE,
00151     WM_FINALDESTROY,
00152     WM_PAINT,
00153     WM_NCCALCSIZE,
00154     WM_CHAR,
00155     WM_SYSCHAR,
00156     WM_KEYDOWN,
00157     WM_SYSKEYDOWN,
00158     WM_TIMER,
00159     MN_SETHMENU,
00160     MN_SIZEWINDOW,
00161     MN_OPENHIERARCHY,
00162     MN_CLOSEHIERARCHY,
00163     MN_SELECTITEM,
00164     MN_SELECTFIRSTVALIDITEM,
00165     MN_CANCELMENUS,
00166     MN_FINDMENUWINDOWFROMPOINT,
00167     MN_SHOWPOPUPWINDOW,
00168     MN_BUTTONDOWN,
00169     MN_MOUSEMOVE,
00170     MN_BUTTONUP,
00171     MN_SETTIMERTOOPENHIERARCHY,
00172     WM_ACTIVATE,
00173     MN_GETHMENU,
00174     MN_DBLCLK,
00175     MN_ACTIVATEPOPUP,
00176     MN_ENDMENU,
00177     MN_DODRAGDROP,
00178     WM_ACTIVATEAPP,
00179     WM_MOUSELEAVE,
00180     WM_SIZE,
00181     WM_MOVE,
00182     WM_NCHITTEST,
00183     WM_NCPAINT,
00184     WM_PRINT,
00185     WM_PRINTCLIENT,
00186     WM_ERASEBKGND,
00187     WM_WINDOWPOSCHANGING,
00188     WM_WINDOWPOSCHANGED,
00189     0
00190 };
00191 
<a name="l00192"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a34">00192</a> CONST WORD <a class="code" href="../../d9/d6/kernel_2server_8c.html#a34">gawDesktopWndProc</a>[] = {
00193     WM_PAINT,
00194     WM_ERASEBKGND,
00195     0
00196 };
00197 
<a name="l00198"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a35">00198</a> CONST WORD <a class="code" href="../../d9/d6/kernel_2server_8c.html#a35">gawScrollBarWndProc</a>[] = {
00199     WM_CREATE,
00200     WM_SETFOCUS,
00201     WM_KILLFOCUS,
00202     WM_ERASEBKGND,
00203     WM_PAINT,
00204     WM_LBUTTONDBLCLK,
00205     WM_LBUTTONDOWN,
00206     WM_KEYUP,
00207     WM_KEYDOWN,
00208     WM_ENABLE,
00209     SBM_ENABLE_ARROWS,
00210     SBM_SETPOS,
00211     SBM_SETRANGEREDRAW,
00212     SBM_SETRANGE,
00213     SBM_SETSCROLLINFO,
00214     SBM_GETSCROLLINFO,
00215     WM_PRINTCLIENT,
00216     WM_MOUSEMOVE,
00217     WM_MOUSELEAVE,
00218     0
00219 };
00220 
<a name="l00221"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a36">00221</a> CONST WORD <a class="code" href="../../d9/d6/kernel_2server_8c.html#a36">gawStaticWndProc</a>[] = {
00222     STM_GETICON,
00223     STM_GETIMAGE,
00224     STM_SETICON,
00225     STM_SETIMAGE,
00226     WM_ERASEBKGND,
00227     WM_PAINT,
00228     WM_PRINTCLIENT,
00229     WM_CREATE,
00230     WM_DESTROY,
00231     WM_NCCREATE,
00232     WM_NCDESTROY,
00233     WM_FINALDESTROY,
00234     WM_NCHITTEST,
00235     WM_LBUTTONDOWN,
00236     WM_NCLBUTTONDOWN,
00237     WM_LBUTTONDBLCLK,
00238     WM_NCLBUTTONDBLCLK,
00239     WM_SETTEXT,
00240     WM_ENABLE,
00241     WM_GETDLGCODE,
00242     WM_SETFONT,
00243     WM_GETFONT,
00244     WM_GETTEXT,
00245     WM_TIMER,
00246     WM_INPUTLANGCHANGEREQUEST,
00247     WM_UPDATEUISTATE,
00248     0
00249 };
00250 
<a name="l00251"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a37">00251</a> CONST WORD <a class="code" href="../../d9/d6/kernel_2server_8c.html#a37">gawButtonWndProc</a>[] = {
00252     WM_NCHITTEST,
00253     WM_ERASEBKGND,
00254     WM_PRINTCLIENT,
00255     WM_PAINT,
00256     WM_SETFOCUS,
00257     WM_GETDLGCODE,
00258     WM_CAPTURECHANGED,
00259     WM_KILLFOCUS,
00260     WM_LBUTTONDBLCLK,
00261     WM_LBUTTONUP,
00262     WM_MOUSEMOVE,
00263     WM_LBUTTONDOWN,
00264     WM_CHAR,
00265     BM_CLICK,
00266     WM_KEYDOWN,
00267     WM_KEYUP,
00268     WM_SYSKEYUP,
00269     BM_GETSTATE,
00270     BM_SETSTATE,
00271     BM_GETCHECK,
00272     BM_SETCHECK,
00273     BM_SETSTYLE,
00274     WM_SETTEXT,
00275     WM_ENABLE,
00276     WM_SETFONT,
00277     WM_GETFONT,
00278     BM_GETIMAGE,
00279     BM_SETIMAGE,
00280     WM_NCDESTROY,
00281     WM_FINALDESTROY,
00282     WM_NCCREATE,
00283     WM_INPUTLANGCHANGEREQUEST,
00284     WM_UPDATEUISTATE,
00285     0
00286 };
00287 
<a name="l00288"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a38">00288</a> CONST WORD <a class="code" href="../../d9/d6/kernel_2server_8c.html#a38">gawListboxWndProc</a>[] = {
00289     LB_GETTOPINDEX,
00290     LB_SETTOPINDEX,
00291     WM_SIZE,
00292     WM_ERASEBKGND,
00293     LB_RESETCONTENT,
00294     WM_TIMER,
00295     WM_MOUSEMOVE,
00296     WM_MBUTTONDOWN,
00297     WM_LBUTTONDOWN,
00298     WM_LBUTTONUP,
00299     WM_LBUTTONDBLCLK,
00300     WM_CAPTURECHANGED,
00301     LBCB_STARTTRACK,
00302     LBCB_ENDTRACK,
00303     WM_PRINTCLIENT,
00304     WM_PAINT,
00305     WM_NCDESTROY,
00306     WM_FINALDESTROY,
00307     WM_SETFOCUS,
00308     WM_KILLFOCUS,
00309     WM_VSCROLL,
00310     WM_HSCROLL,
00311     WM_GETDLGCODE,
00312     WM_CREATE,
00313     WM_SETREDRAW,
00314     WM_ENABLE,
00315     WM_SETFONT,
00316     WM_GETFONT,
00317     WM_DRAGSELECT,
00318     WM_DRAGLOOP,
00319     WM_DRAGMOVE,
00320     WM_DROPFILES,
00321     WM_QUERYDROPOBJECT,
00322     WM_DROPOBJECT,
00323     LB_GETITEMRECT,
00324     LB_GETITEMDATA,
00325     LB_SETITEMDATA,
00326     LB_ADDSTRINGUPPER,
00327     LB_ADDSTRINGLOWER,
00328     LB_ADDSTRING,
00329     LB_INSERTSTRINGUPPER,
00330     LB_INSERTSTRINGLOWER,
00331     LB_INSERTSTRING,
00332     LB_INITSTORAGE,
00333     LB_DELETESTRING,
00334     LB_DIR,
00335     LB_ADDFILE,
00336     LB_SETSEL,
00337     LB_SETCURSEL,
00338     LB_GETSEL,
00339     LB_GETCURSEL,
00340     LB_SELITEMRANGE,
00341     LB_SELITEMRANGEEX,
00342     LB_GETTEXTLEN,
00343     LB_GETTEXT,
00344     LB_GETCOUNT,
00345     LB_SETCOUNT,
00346     LB_SELECTSTRING,
00347     LB_FINDSTRING,
00348     LB_GETLOCALE,
00349     LB_SETLOCALE,
00350     WM_KEYDOWN,
00351     WM_CHAR,
00352     LB_GETSELITEMS,
00353     LB_GETSELCOUNT,
00354     LB_SETTABSTOPS,
00355     LB_GETHORIZONTALEXTENT,
00356     LB_SETHORIZONTALEXTENT,
00357     LB_SETCOLUMNWIDTH,
00358     LB_SETANCHORINDEX,
00359     LB_GETANCHORINDEX,
00360     LB_SETCARETINDEX,
00361     LB_GETCARETINDEX,
00362     LB_SETITEMHEIGHT,
00363     LB_GETITEMHEIGHT,
00364     LB_FINDSTRINGEXACT,
00365     LB_ITEMFROMPOINT,
00366     LB_SETLOCALE,
00367     LB_GETLOCALE,
00368     LBCB_CARETON,
00369     LBCB_CARETOFF,
00370     WM_NCCREATE,
00371     WM_WINDOWPOSCHANGED,
00372     WM_MOUSEWHEEL,
00373     WM_STYLECHANGED,
00374     WM_STYLECHANGING,
00375     0
00376 };
00377 
<a name="l00378"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a39">00378</a> CONST WORD <a class="code" href="../../d9/d6/kernel_2server_8c.html#a39">gawComboWndProc</a>[] = {
00379     CBEC_KILLCOMBOFOCUS,
00380     WM_COMMAND,
00381     WM_CTLCOLORMSGBOX,
00382     WM_CTLCOLOREDIT,
00383     WM_CTLCOLORLISTBOX,
00384     WM_CTLCOLORBTN,
00385     WM_CTLCOLORDLG,
00386     WM_CTLCOLORSCROLLBAR,
00387     WM_CTLCOLORSTATIC,
00388     WM_CTLCOLOR,
00389     WM_GETTEXT,
00390     WM_GETTEXTLENGTH,
00391     WM_CLEAR,
00392     WM_CUT,
00393     WM_PASTE,
00394     WM_COPY,
00395     WM_SETTEXT,
00396     WM_CREATE,
00397     WM_ERASEBKGND,
00398     WM_GETFONT,
00399     WM_PRINT,
00400     WM_PRINTCLIENT,
00401     WM_PAINT,
00402     WM_GETDLGCODE,
00403     WM_SETFONT,
00404     WM_SYSKEYDOWN,
00405     WM_KEYDOWN,
00406     WM_CHAR,
00407     WM_LBUTTONDBLCLK,
00408     WM_LBUTTONDOWN,
00409     WM_CAPTURECHANGED,
00410     WM_LBUTTONUP,
00411     WM_MOUSEMOVE,
00412     WM_NCDESTROY,
00413     WM_FINALDESTROY,
00414     WM_SETFOCUS,
00415     WM_KILLFOCUS,
00416     WM_SETREDRAW,
00417     WM_ENABLE,
00418     WM_SIZE,
00419     CB_GETDROPPEDSTATE,
00420     CB_GETDROPPEDCONTROLRECT,
00421     CB_SETDROPPEDWIDTH,
00422     CB_GETDROPPEDWIDTH,
00423     CB_DIR,
00424     CB_SETEXTENDEDUI,
00425     CB_GETEXTENDEDUI,
00426     CB_GETEDITSEL,
00427     CB_LIMITTEXT,
00428     CB_SETEDITSEL,
00429     CB_ADDSTRING,
00430     CB_DELETESTRING,
00431     CB_INITSTORAGE,
00432     CB_SETTOPINDEX,
00433     CB_GETTOPINDEX,
00434     CB_GETCOUNT,
00435     CB_GETCURSEL,
00436     CB_GETLBTEXT,
00437     CB_GETLBTEXTLEN,
00438     CB_INSERTSTRING,
00439     CB_RESETCONTENT,
00440     CB_GETHORIZONTALEXTENT,
00441     CB_SETHORIZONTALEXTENT,
00442     CB_FINDSTRING,
00443     CB_FINDSTRINGEXACT,
00444     CB_SELECTSTRING,
00445     CB_SETCURSEL,
00446     CB_GETITEMDATA,
00447     CB_SETITEMDATA,
00448     CB_SETITEMHEIGHT,
00449     CB_GETITEMHEIGHT,
00450     CB_SHOWDROPDOWN,
00451     CB_SETLOCALE,
00452     CB_GETLOCALE,
00453     WM_MEASUREITEM,
00454     WM_DELETEITEM,
00455     WM_DRAWITEM,
00456     WM_COMPAREITEM,
00457     WM_NCCREATE,
00458     WM_HELP,
00459     WM_MOUSEWHEEL,
00460     WM_MOUSELEAVE,
00461     WM_STYLECHANGED,
00462     WM_STYLECHANGING,
00463     WM_UPDATEUISTATE,
00464     0
00465 };
00466 
<a name="l00467"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a40">00467</a> CONST WORD <a class="code" href="../../d9/d6/kernel_2server_8c.html#a40">gawEditWndProc</a>[] = {
00468     EM_CANUNDO,
00469     EM_CHARFROMPOS,
00470     EM_EMPTYUNDOBUFFER,
00471     EM_FMTLINES,
00472     EM_GETFIRSTVISIBLELINE,
00473     EM_GETFIRSTVISIBLELINE,
00474     EM_GETHANDLE,
00475     EM_GETLIMITTEXT,
00476     EM_GETLINE,
00477     EM_GETLINECOUNT,
00478     EM_GETMARGINS,
00479     EM_GETMODIFY,
00480     EM_GETPASSWORDCHAR,
00481     EM_GETRECT,
00482     EM_GETSEL,
00483     EM_GETWORDBREAKPROC,
00484     EM_SETIMESTATUS,
00485     EM_GETIMESTATUS,
00486     EM_LINEFROMCHAR,
00487     EM_LINEINDEX,
00488     EM_LINELENGTH,
00489     EM_LINESCROLL,
00490     EM_POSFROMCHAR,
00491     EM_REPLACESEL,
00492     EM_SCROLL,
00493     EM_SCROLLCARET,
00494     EM_SETHANDLE,
00495     EM_SETLIMITTEXT,
00496     EM_SETMARGINS,
00497     EM_SETMODIFY,
00498     EM_SETPASSWORDCHAR,
00499     EM_SETREADONLY,
00500     EM_SETRECT,
00501     EM_SETRECTNP,
00502     EM_SETSEL,
00503     EM_SETTABSTOPS,
00504     EM_SETWORDBREAKPROC,
00505     EM_UNDO,
00506     WM_CAPTURECHANGED,
00507     WM_CHAR,
00508     WM_CLEAR,
00509     WM_CONTEXTMENU,
00510     WM_COPY,
00511     WM_CREATE,
00512     WM_CUT,
00513     WM_ENABLE,
00514     WM_ERASEBKGND,
00515     WM_GETDLGCODE,
00516     WM_GETFONT,
00517     WM_GETTEXT,
00518     WM_GETTEXTLENGTH,
00519     WM_HSCROLL,
00520     WM_IME_STARTCOMPOSITION,
00521     WM_IME_ENDCOMPOSITION,
00522     WM_IME_COMPOSITION,
00523     WM_IME_SETCONTEXT,
00524     WM_IME_NOTIFY,
00525     WM_IME_COMPOSITIONFULL,
00526     WM_IME_SELECT,
00527     WM_IME_CHAR,
00528     WM_IME_REQUEST,
00529     WM_INPUTLANGCHANGE,
00530     WM_KEYUP,
00531     WM_KEYDOWN,
00532     WM_KILLFOCUS,
00533     WM_MBUTTONDOWN,
00534     WM_LBUTTONDBLCLK,
00535     WM_LBUTTONDOWN,
00536     WM_LBUTTONUP,
00537     WM_MOUSEMOVE,
00538     WM_NCCREATE,
00539     WM_NCDESTROY,
00540     WM_RBUTTONDOWN,
00541     WM_RBUTTONUP,
00542     WM_FINALDESTROY,
00543 <span class="preprocessor">#if 0</span>
00544 <span class="preprocessor"></span>    WM_NCPAINT,
00545 <span class="preprocessor">#endif</span>
00546 <span class="preprocessor"></span>    WM_PAINT,
00547     WM_PASTE,
00548     WM_PRINTCLIENT,
00549     WM_SETFOCUS,
00550     WM_SETFONT,
00551     WM_SETREDRAW,
00552     WM_SETTEXT,
00553     WM_SIZE,
00554     WM_STYLECHANGED,
00555     WM_STYLECHANGING,
00556     WM_SYSCHAR,
00557     WM_SYSKEYDOWN,
00558     <a class="code" href="../../d1/d1/bench_8c.html#a4">WM_SYSTIMER</a>,
00559     WM_UNDO,
00560     WM_VSCROLL,
00561     WM_MOUSEWHEEL,
00562     0
00563 };
00564 
<a name="l00565"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a41">00565</a> CONST WORD <a class="code" href="../../d9/d6/kernel_2server_8c.html#a41">gawImeWndProc</a>[] = {
00566     WM_ERASEBKGND,
00567     WM_PAINT,
00568     WM_DESTROY,
00569     WM_NCDESTROY,
00570     WM_FINALDESTROY,
00571     WM_CREATE,
00572     WM_IME_SYSTEM,
00573     WM_IME_SELECT,
00574     WM_IME_CONTROL,
00575     WM_IME_SETCONTEXT,
00576     WM_IME_NOTIFY,
00577     WM_IME_COMPOSITION,
00578     WM_IME_STARTCOMPOSITION,
00579     WM_IME_ENDCOMPOSITION,
00580     WM_IME_REQUEST,
00581     WM_COPYDATA,
00582     0
00583 };
00584 
00585 <span class="comment">/*</span>
00586 <span class="comment"> * This array is for all the messages that need to be passed straight</span>
00587 <span class="comment"> * across to the server for handling.</span>
00588 <span class="comment"> */</span>
<a name="l00589"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a42">00589</a> CONST WORD <a class="code" href="../../d9/d6/kernel_2server_8c.html#a42">gawDefWindowMsgs</a>[] = {
00590     WM_GETHOTKEY,
00591     WM_SETHOTKEY,
00592     WM_SETREDRAW,
00593     WM_SETTEXT,
00594     WM_PAINT,
00595     WM_CLOSE,
00596     WM_ERASEBKGND,
00597     WM_CANCELMODE,
00598     WM_SETCURSOR,
00599     WM_PAINTICON,
00600     WM_ICONERASEBKGND,
00601     WM_DRAWITEM,
00602     WM_KEYF1,
00603     WM_ISACTIVEICON,
00604     WM_NCCREATE,
00605     WM_SETICON,
00606     WM_NCCALCSIZE,
00607     WM_NCPAINT,
00608     WM_NCACTIVATE,
00609     WM_NCMOUSEMOVE,
00610     WM_NCRBUTTONUP,
00611     WM_NCRBUTTONDOWN,
00612     WM_NCLBUTTONDOWN,
00613     WM_NCLBUTTONUP,
00614     WM_NCLBUTTONDBLCLK,
00615     WM_KEYUP,
00616     WM_SYSKEYUP,
00617     WM_SYSCHAR,
00618     WM_SYSCOMMAND,
00619     WM_QUERYDROPOBJECT,
00620     WM_CLIENTSHUTDOWN,
00621     WM_SYNCPAINT,
00622     WM_PRINT,
00623     WM_GETICON,
00624     WM_CONTEXTMENU,
00625     WM_SYSMENU,
00626     WM_INPUTLANGCHANGEREQUEST,
00627     WM_INPUTLANGCHANGE,
00628     WM_UPDATEUISTATE,
00629     0
00630 };
00631 
00632 <span class="comment">/*</span>
00633 <span class="comment"> * This array is for all messages that can be handled with some special</span>
00634 <span class="comment"> * code by the client.  DefWindowProcWorker returns 0 for all messages</span>
00635 <span class="comment"> * that aren't in this array or the one above.</span>
00636 <span class="comment"> */</span>
<a name="l00637"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a43">00637</a> CONST WORD <a class="code" href="../../d9/d6/kernel_2server_8c.html#a43">gawDefWindowSpecMsgs</a>[] = {
00638     WM_ACTIVATE,
00639     WM_GETTEXT,
00640     WM_GETTEXTLENGTH,
00641     WM_RBUTTONUP,
00642     WM_QUERYENDSESSION,
00643     WM_QUERYOPEN,
00644     WM_SHOWWINDOW,
00645     WM_MOUSEACTIVATE,
00646     WM_HELP,
00647     WM_VKEYTOITEM,
00648     WM_CHARTOITEM,
00649     WM_KEYDOWN,
00650     WM_SYSKEYDOWN,
00651     WM_DROPOBJECT,
00652     WM_WINDOWPOSCHANGING,
00653     WM_WINDOWPOSCHANGED,
00654     WM_KLUDGEMINRECT,
00655     WM_CTLCOLOR,
00656     WM_CTLCOLORMSGBOX,
00657     WM_CTLCOLOREDIT,
00658     WM_CTLCOLORLISTBOX,
00659     WM_CTLCOLORBTN,
00660     WM_CTLCOLORDLG,
00661     WM_CTLCOLORSCROLLBAR,
00662     WM_NCHITTEST,
00663     WM_NCXBUTTONUP,
00664     WM_CTLCOLORSTATIC,
00665     WM_NOTIFYFORMAT,
00666     WM_DEVICECHANGE,
00667     WM_POWERBROADCAST,
00668     WM_MOUSEWHEEL,
00669     WM_XBUTTONUP,
00670     WM_IME_KEYDOWN,
00671     WM_IME_KEYUP,
00672     WM_IME_CHAR,
00673     WM_IME_COMPOSITION,
00674     WM_IME_STARTCOMPOSITION,
00675     WM_IME_ENDCOMPOSITION,
00676     WM_IME_COMPOSITIONFULL,
00677     WM_IME_SETCONTEXT,
00678     WM_IME_CONTROL,
00679     WM_IME_NOTIFY,
00680     WM_IME_SELECT,
00681     WM_IME_SYSTEM,
00682     WM_LPKDRAWSWITCHWND,
00683     WM_QUERYDRAGICON,
00684     WM_CHANGEUISTATE,
00685     WM_QUERYUISTATE,
00686     WM_APPCOMMAND,
00687     0
00688 };
00689 
<a name="l00690"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a44">00690</a> <span class="keyword">static</span> CONST LPCWSTR <a class="code" href="../../d9/d6/kernel_2server_8c.html#a44">lpszOLEFormats</a>[] = {
00691     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ObjectLink"</span>,
00692     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"OwnerLink"</span>,
00693     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Native"</span>,
00694     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Binary"</span>,
00695     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"FileName"</span>,
00696     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"FileNameW"</span>,
00697     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"NetworkName"</span>,
00698     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DataObject"</span>,
00699     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Embedded Object"</span>,
00700     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Embed Source"</span>,
00701     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Custom Link Source"</span>,
00702     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Link Source"</span>,
00703     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Object Descriptor"</span>,
00704     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Link Source Descriptor"</span>,
00705     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"OleDraw"</span>,
00706     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"PBrush"</span>,
00707     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"MSDraw"</span>,
00708     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Ole Private Data"</span>,
00709     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Screen Picture"</span>,
00710     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"OleClipboardPersistOnFlush"</span>,
00711     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"MoreOlePrivateData"</span>
00712 };
00713 
<a name="l00714"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a45">00714</a> <span class="keyword">static</span> CONST LPCWSTR <a class="code" href="../../d9/d6/kernel_2server_8c.html#a45">lpszControls</a>[] = {
00715     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Button"</span>,
00716     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Edit"</span>,
00717     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Static"</span>,
00718     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ListBox"</span>,
00719     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ScrollBar"</span>,
00720     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ComboBox"</span>,
00721     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"MDIClient"</span>,
00722     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ComboLBox"</span>,
00723     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DDEMLEvent"</span>,
00724     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DDEMLMom"</span>,
00725     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DMGClass"</span>,
00726     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DDEMLAnsiClient"</span>,
00727     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DDEMLUnicodeClient"</span>,
00728     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DDEMLAnsiServer"</span>,
00729     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DDEMLUnicodeServer"</span>,
00730     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"IME"</span>,
00731 };
00732 
00733 
00734 <span class="preprocessor">#ifdef ALLOC_DATA_PRAGMA</span>
00735 <span class="preprocessor"></span><span class="preprocessor">#pragma data_seg()</span>
00736 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00737 <span class="preprocessor"></span>
00738 <span class="comment">/***************************************************************************\</span>
00739 <span class="comment">* DispatchServerMessage</span>
00740 <span class="comment">*</span>
00741 <span class="comment">*</span>
00742 <span class="comment">* 19-Aug-1992 MikeKe    Created</span>
00743 <span class="comment">\***************************************************************************/</span>
00744 
<a name="l00745"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a6">00745</a> <span class="preprocessor">#define WRAPPFN(pfn, type)                                   \</span>
00746 <span class="preprocessor">LRESULT xxxWrap ## pfn(                                      \</span>
00747 <span class="preprocessor">    PWND  pwnd,                                              \</span>
00748 <span class="preprocessor">    UINT  message,                                           \</span>
00749 <span class="preprocessor">    WPARAM wParam,                                           \</span>
00750 <span class="preprocessor">    LPARAM lParam,                                           \</span>
00751 <span class="preprocessor">    ULONG_PTR xParam)                                         \</span>
00752 <span class="preprocessor">{                                                            \</span>
00753 <span class="preprocessor">    DBG_UNREFERENCED_PARAMETER(xParam);                      \</span>
00754 <span class="preprocessor">                                                             \</span>
00755 <span class="preprocessor">    return xxx ## pfn((type)pwnd, message, wParam, lParam);  \</span>
00756 <span class="preprocessor">}</span>
00757 <span class="preprocessor"></span>
00758 <a class="code" href="../../d9/d6/kernel_2server_8c.html#a6">WRAPPFN</a>(SBWndProc, <a class="code" href="../../d7/d5/structtagSBWND.html">PSBWND</a>)
00759 WRAPPFN(MenuWindowProc, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)
00760 WRAPPFN(DesktopWndProc, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>);
00761 WRAPPFN(DefWindowProc, PWND)
00762 
<a name="l00763"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a61">00763</a> LRESULT xxxWrapSendMessage(
00764     PWND  pwnd,
00765     UINT  message,
00766     WPARAM wParam,
00767     LPARAM lParam,
00768     ULONG_PTR xParam)
00769 {
00770     DBG_UNREFERENCED_PARAMETER(xParam);
00771 
00772     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1580">xxxSendMessageTimeout</a>(pwnd,
00773                                  message,
00774                                  wParam,
00775                                  lParam,
00776                                  SMTO_NORMAL,
00777                                  0,
00778                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00779 }
00780 
<a name="l00781"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a62">00781</a> LRESULT <a class="code" href="../../d9/d6/kernel_2server_8c.html#a62">xxxWrapSendMessageBSM</a>(
00782     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwnd,
00783     UINT  message,
00784     WPARAM wParam,
00785     LPARAM lParam,
00786     ULONG_PTR xParam)
00787 {
00788     <a class="code" href="../../d3/d1/structBROADCASTSYSTEMMSGPARAMS.html">BROADCASTSYSTEMMSGPARAMS</a> bsmParams;
00789 
00790     <span class="keywordflow">try</span> {
00791         bsmParams = <a class="code" href="../../d4/d1/userk_8h.html#a59">ProbeAndReadBroadcastSystemMsgParams</a>((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a987">LPBROADCASTSYSTEMMSGPARAMS</a>)xParam);
00792     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00793         <span class="keywordflow">return</span> 0;
00794     }
00795 
00796     <span class="comment">/*</span>
00797 <span class="comment">     * If this broadcast is going to all desktops, make sure the thread has</span>
00798 <span class="comment">     * sufficient privileges. Do the check here, so we don't effect kernel</span>
00799 <span class="comment">     * generated broadcasts (i.e power messages).</span>
00800 <span class="comment">     */</span>
00801     <span class="keywordflow">if</span> (bsmParams.<a class="code" href="../../d3/d1/structBROADCASTSYSTEMMSGPARAMS.html#o0">dwRecipients</a> &amp; (BSM_ALLDESKTOPS)) {
00802         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d0/server_2exitwin_8c.html#a22">IsPrivileged</a>(&amp;<a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a248">psTcb</a>)) {
00803             bsmParams.<a class="code" href="../../d3/d1/structBROADCASTSYSTEMMSGPARAMS.html#o0">dwRecipients</a> &amp;= ~(BSM_ALLDESKTOPS);
00804         }
00805     }
00806 
00807     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1577">xxxSendMessageBSM</a>(pwnd,
00808                              message,
00809                              wParam,
00810                              lParam,
00811                              &amp;bsmParams);
00812 }
00813 
00814 <span class="comment">/***************************************************************************\</span>
00815 <span class="comment">* xxxUnusedFunctionId</span>
00816 <span class="comment">*</span>
00817 <span class="comment">* This function is catches attempts to access invalid entries in the server</span>
00818 <span class="comment">* side function dispatch table.</span>
00819 <span class="comment">*</span>
00820 <span class="comment">\***************************************************************************/</span>
00821 
<a name="l00822"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a63">00822</a> LRESULT <a class="code" href="../../d9/d6/kernel_2server_8c.html#a63">xxxUnusedFunctionId</a>(
00823     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwnd,
00824     UINT  message,
00825     WPARAM wParam,
00826     LPARAM lParam,
00827     ULONG_PTR xParam)
00828 {
00829     DBG_UNREFERENCED_PARAMETER(pwnd);
00830     DBG_UNREFERENCED_PARAMETER(message);
00831     DBG_UNREFERENCED_PARAMETER(wParam);
00832     DBG_UNREFERENCED_PARAMETER(lParam);
00833     DBG_UNREFERENCED_PARAMETER(xParam);
00834 
00835     UserAssert(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00836     <span class="keywordflow">return</span> 0;
00837 }
00838 
00839 <span class="comment">/***************************************************************************\</span>
00840 <span class="comment">* xxxWrapCallWindowProc</span>
00841 <span class="comment">*</span>
00842 <span class="comment">* Warning should only be called with valid CallProc Handles or the</span>
00843 <span class="comment">* EditWndProc special handlers.</span>
00844 <span class="comment">*</span>
00845 <span class="comment">*</span>
00846 <span class="comment">* 21-Apr-1993 JohnC     Created</span>
00847 <span class="comment">\***************************************************************************/</span>
00848 
<a name="l00849"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a64">00849</a> LRESULT <a class="code" href="../../d9/d6/kernel_2server_8c.html#a64">xxxWrapCallWindowProc</a>(
00850     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwnd,
00851     UINT  message,
00852     WPARAM wParam,
00853     LPARAM lParam,
00854     ULONG_PTR xParam)
00855 {
00856     <a class="code" href="../../d3/d7/struct__CALLPROCDATA.html">PCALLPROCDATA</a> pCPD;
00857     LRESULT       lRet = 0;
00858 
00859     <span class="keywordflow">if</span> (pCPD = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a8">HMValidateHandleNoRip</a>((PVOID)xParam, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a243">TYPE_CALLPROC</a>)) {
00860 
00861         lRet = <a class="code" href="../../d4/d1/userk_8h.html#a246">ScSendMessage</a>(pwnd,
00862                               message,
00863                               wParam,
00864                               lParam,
00865                               pCPD-&gt;<a class="code" href="../../d3/d7/struct__CALLPROCDATA.html#o2">pfnClientPrevious</a>,
00866                               <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o9">apfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o17">pfnDispatchMessage</a>,
00867                               (pCPD-&gt;<a class="code" href="../../d3/d7/struct__CALLPROCDATA.html#o3">wType</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a460">CPD_UNICODE_TO_ANSI</a>) ?
00868                                       <a class="code" href="../../d4/d1/userk_8h.html#a240">SCMS_FLAGS_ANSI</a> : 0);
00869 
00870     } <span class="keywordflow">else</span> {
00871 
00872         <span class="comment">/*</span>
00873 <span class="comment">         * If it is not a real call proc handle it must be a special</span>
00874 <span class="comment">         * handler for editwndproc or regular EditWndProc</span>
00875 <span class="comment">         */</span>
00876         lRet = <a class="code" href="../../d4/d1/userk_8h.html#a246">ScSendMessage</a>(pwnd,
00877                               message,
00878                               wParam,
00879                               lParam,
00880                               xParam,
00881                               <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o8">apfnClientA</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o17">pfnDispatchMessage</a>,
00882                               (xParam == (ULONG_PTR)<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o8">apfnClientA</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o9">pfnEditWndProc</a>) ?
00883                                       <a class="code" href="../../d4/d1/userk_8h.html#a240">SCMS_FLAGS_ANSI</a> : 0);
00884     }
00885 
00886     <span class="keywordflow">return</span> lRet;
00887 }
00888 
00889 <span class="preprocessor">#if DBG</span>
00890 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d6/kernel_2server_8c.html#a57">VerifySyncOnlyMessages</a>(VOID)
00891 {
00892     <span class="keywordtype">int</span> i;
00893 
00894     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"UserInit: Verify Sync Only Messages\n"</span>));
00895 
00896     <span class="comment">/*</span>
00897 <span class="comment">     * There are a couple of thunks that just pass parameters.  There are other</span>
00898 <span class="comment">     * thunks besides SfnDWORD that do a straight pass through because they</span>
00899 <span class="comment">     * do other processing beside the wparam and lparam</span>
00900 <span class="comment">     */</span>
00901 
00902     <span class="comment">/*</span>
00903 <span class="comment">     * Allow posting of LB_DIR and CB_DIR because DlgDirList allows a DDL_POSTMSGS</span>
00904 <span class="comment">     * flag that makes the API post the messages.  This should be OK as long as we</span>
00905 <span class="comment">     * don't handle these messages in the kernel.  NT 3.51 allowed posting these.</span>
00906 <span class="comment">     */</span>
00907     <span class="keywordflow">for</span> (i=0; i&lt;WM_USER; i++) {
00908         <span class="keywordflow">if</span> (    i != LB_DIR
00909                 &amp;&amp; i != CB_DIR
00910                 &amp;&amp; (<a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a22">gapfnScSendMessage</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1144">MessageTable</a>[i].<a class="code" href="../../d6/d2/structtagMSG__TABLE__ENTRY.html#o0">iFunction</a>] != SfnDWORD)
00911                 &amp;&amp; (<a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a22">gapfnScSendMessage</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1144">MessageTable</a>[i].<a class="code" href="../../d6/d2/structtagMSG__TABLE__ENTRY.html#o0">iFunction</a>] != SfnINWPARAMCHAR)
00912                 &amp;&amp; (<a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a22">gapfnScSendMessage</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1144">MessageTable</a>[i].<a class="code" href="../../d6/d2/structtagMSG__TABLE__ENTRY.html#o0">iFunction</a>] != SfnINWPARAMDBCSCHAR)
00913                 &amp;&amp; (<a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a22">gapfnScSendMessage</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1144">MessageTable</a>[i].<a class="code" href="../../d6/d2/structtagMSG__TABLE__ENTRY.html#o0">iFunction</a>] != SfnSENTDDEMSG)
00914                 &amp;&amp; (<a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a22">gapfnScSendMessage</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1144">MessageTable</a>[i].<a class="code" href="../../d6/d2/structtagMSG__TABLE__ENTRY.html#o0">iFunction</a>] != <a class="code" href="../../d1/d5/srvmsg_8c.html#a8">SfnPOWERBROADCAST</a>)
00915                 &amp;&amp; (<a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a22">gapfnScSendMessage</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1144">MessageTable</a>[i].<a class="code" href="../../d6/d2/structtagMSG__TABLE__ENTRY.html#o0">iFunction</a>] != SfnLOGONNOTIFY)
00916                 &amp;&amp; (<a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a22">gapfnScSendMessage</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1144">MessageTable</a>[i].<a class="code" href="../../d6/d2/structtagMSG__TABLE__ENTRY.html#o0">iFunction</a>] != SfnINDESTROYCLIPBRD)) {
00917             <span class="keywordflow">if</span> (!(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a918">TESTSYNCONLYMESSAGE</a>(i,0x8000)))
00918                 RIPMSG1(RIP_ERROR, <span class="stringliteral">"InitSyncOnly: is this message sync-only 0x%lX"</span>, i);
00919         } <span class="keywordflow">else</span> {
00920             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a918">TESTSYNCONLYMESSAGE</a>(i,0))
00921                 RIPMSG1(RIP_VERBOSE, <span class="stringliteral">"InitSyncOnly: is this message not sync-only 0x%lX"</span>, i);
00922         }
00923 
00924     }
00925 }
00926 <span class="preprocessor">#endif // DBG</span>
00927 <span class="preprocessor"></span>
00928 <span class="comment">/***************************************************************************\</span>
00929 <span class="comment">* InitWindowMsgTables</span>
00930 <span class="comment">*</span>
00931 <span class="comment">* This function generates a bit-array lookup table from a list of messages.</span>
00932 <span class="comment">* The lookup table is used to determine whether the message needs to be</span>
00933 <span class="comment">* passed over to the server for handling or whether it can be handled</span>
00934 <span class="comment">* directly on the client.</span>
00935 <span class="comment">*</span>
00936 <span class="comment">* LATER: Some memory (a couple hundred bytes per process) could be saved</span>
00937 <span class="comment">*        by putting this in the shared read-only heap.</span>
00938 <span class="comment">*</span>
00939 <span class="comment">*</span>
00940 <span class="comment">* 27-Mar-1992 DarrinM   Created.</span>
00941 <span class="comment">* 06-Dec-1993 MikeKe    Added support for all of our window procs.</span>
00942 <span class="comment">\***************************************************************************/</span>
00943 
<a name="l00944"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a56">00944</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d6/kernel_2server_8c.html#a56">InitWindowMsgTable</a>(
00945     PBYTE      *ppbyte,
00946     PUINT      pmax,
00947     CONST WORD *pw)
00948 {
00949     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> i;
00950     WORD <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
00951     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cbTable;
00952 
00953     *pmax = 0;
00954     <span class="keywordflow">for</span> (i = 0; (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> = pw[i]) != 0; i++) {
00955         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> &gt; *pmax)
00956             *pmax = <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
00957     }
00958 
00959     cbTable = *pmax / 8 + 1;
00960     *ppbyte = <a class="code" href="../../d4/d1/userk_8h.html#a1000">SharedAlloc</a>(cbTable);
00961 
00962     <span class="keywordflow">for</span> (i = 0; (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> = pw[i]) != 0; i++)
00963         (*ppbyte)[<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> / 8] |= (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)(1 &lt;&lt; (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> &amp; 7));
00964 }
00965 
00966 <span class="comment">/***************************************************************************\</span>
00967 <span class="comment">* InitFunctionTables</span>
00968 <span class="comment">*</span>
00969 <span class="comment">* Initialize the procedures and function tables.</span>
00970 <span class="comment">*</span>
00971 <span class="comment">*</span>
00972 <span class="comment">* 25-Aug-1995 ChrisWil  Created comment block.</span>
00973 <span class="comment">\***************************************************************************/</span>
00974 
<a name="l00975"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a54">00975</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d6/kernel_2server_8c.html#a54">InitFunctionTables</a>(VOID)
00976 {
00977     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> i;
00978 
00979     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"UserInit: Initialize Function Tables\n"</span>));
00980 
00981     UserAssert(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d2/struct__CLIENTINFO.html">CLIENTINFO</a>) &lt;= <span class="keyword">sizeof</span>(NtCurrentTeb()-&gt;Win32ClientInfo));
00982 
00983     <span class="comment">/*</span>
00984 <span class="comment">     * This table is used to convert from server procs to client procs.</span>
00985 <span class="comment">     */</span>
00986     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a230">STOCID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a193">FNID_SCROLLBAR</a>)              = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a988">WNDPROC_PWND</a>)<a class="code" href="../../d8/d4/sbctl_8c.html#a47">xxxSBWndProc</a>;
00987     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a230">STOCID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a194">FNID_ICONTITLE</a>)              = <a class="code" href="../../d8/d3/dwp_8c.html#a17">xxxDefWindowProc</a>;
00988     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a230">STOCID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a195">FNID_MENU</a>)                   = <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a43">xxxMenuWindowProc</a>;
00989     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a230">STOCID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a196">FNID_DESKTOP</a>)                = <a class="code" href="../../d9/d6/desktop_8c.html#a10">xxxDesktopWndProc</a>;
00990     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a230">STOCID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a197">FNID_DEFWINDOWPROC</a>)          = <a class="code" href="../../d8/d3/dwp_8c.html#a17">xxxDefWindowProc</a>;
00991 
00992     <span class="comment">/*</span>
00993 <span class="comment">     * This table is used to determine the number minimum number</span>
00994 <span class="comment">     * of reserved windows words required for the server proc.</span>
00995 <span class="comment">     */</span>
00996     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a231">CBFNID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a193">FNID_SCROLLBAR</a>)              = <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d5/structtagSBWND.html">SBWND</a>);
00997     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a231">CBFNID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a194">FNID_ICONTITLE</a>)              = <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagWND.html">WND</a>);
00998     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a231">CBFNID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a195">FNID_MENU</a>)                   = <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d1/structtagMENUWND.html">MENUWND</a>);
00999 
01000     <span class="comment">/*</span>
01001 <span class="comment">     * Initialize this data structure (api function table).</span>
01002 <span class="comment">     */</span>
01003     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a224">FNID_ARRAY_SIZE</a>; i++) {
01004         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a229">FNID</a>((i + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a191">FNID_START</a>)) = <a class="code" href="../../d9/d6/kernel_2server_8c.html#a63">xxxUnusedFunctionId</a>;
01005     }
01006     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a229">FNID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a193">FNID_SCROLLBAR</a>)                = xxxWrapSBWndProc;
01007     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a229">FNID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a194">FNID_ICONTITLE</a>)                = xxxWrapDefWindowProc;
01008     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a229">FNID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a195">FNID_MENU</a>)                     = xxxWrapMenuWindowProc;
01009     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a229">FNID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a196">FNID_DESKTOP</a>)                  = xxxWrapDesktopWndProc;
01010     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a229">FNID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a197">FNID_DEFWINDOWPROC</a>)            = xxxWrapDefWindowProc;
01011     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a229">FNID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a216">FNID_SENDMESSAGE</a>)              = <a class="code" href="../../d9/d6/kernel_2server_8c.html#a61">xxxWrapSendMessage</a>;
01012     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a229">FNID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a210">FNID_HKINLPCWPEXSTRUCT</a>)        = <a class="code" href="../../d9/d4/srvhook_8c.html#a2">fnHkINLPCWPEXSTRUCT</a>;
01013     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a229">FNID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a211">FNID_HKINLPCWPRETEXSTRUCT</a>)     = <a class="code" href="../../d9/d4/srvhook_8c.html#a3">fnHkINLPCWPRETEXSTRUCT</a>;
01014     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a229">FNID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a217">FNID_SENDMESSAGEFF</a>)            = <a class="code" href="../../d3/d6/kernel_2sendmsg_8c.html#a21">xxxSendMessageFF</a>;
01015     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a229">FNID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a218">FNID_SENDMESSAGEEX</a>)            = <a class="code" href="../../d3/d6/kernel_2sendmsg_8c.html#a22">xxxSendMessageEx</a>;
01016     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a229">FNID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a219">FNID_CALLWINDOWPROC</a>)           = <a class="code" href="../../d9/d6/kernel_2server_8c.html#a64">xxxWrapCallWindowProc</a>;
01017     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a229">FNID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a220">FNID_SENDMESSAGEBSM</a>)           = <a class="code" href="../../d9/d6/kernel_2server_8c.html#a62">xxxWrapSendMessageBSM</a>;
01018 
01019 <span class="preprocessor">#if DBG</span>
01020 <span class="preprocessor"></span>    {
01021         PULONG_PTR pdw;
01022 
01023         <span class="comment">/*</span>
01024 <span class="comment">         * Make sure that everyone got initialized.</span>
01025 <span class="comment">         */</span>
01026         <span class="keywordflow">for</span> (pdw=(PULONG_PTR)&amp;<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a230">STOCID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a191">FNID_START</a>);
01027                 (ULONG_PTR)pdw&lt;(ULONG_PTR)(&amp;<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a230">STOCID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a198">FNID_WNDPROCEND</a>)); pdw++) {
01028             UserAssert(*pdw);
01029         }
01030 
01031         <span class="keywordflow">for</span> (pdw=(PULONG_PTR)&amp;<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a229">FNID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a191">FNID_START</a>);
01032                 (ULONG_PTR)pdw&lt;(ULONG_PTR)(&amp;<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a229">FNID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a198">FNID_WNDPROCEND</a>)); pdw++) {
01033             UserAssert(*pdw);
01034         }
01035     }
01036 <span class="preprocessor">#endif</span>
01037 <span class="preprocessor"></span>
01038 }
01039 
01040 <span class="comment">/***************************************************************************\</span>
01041 <span class="comment">* InitMessageTables</span>
01042 <span class="comment">*</span>
01043 <span class="comment">* Initialize the message tables.</span>
01044 <span class="comment">*</span>
01045 <span class="comment">*</span>
01046 <span class="comment">* 25-Aug-1995 ChrisWil      Created.</span>
01047 <span class="comment">\***************************************************************************/</span>
01048 
<a name="l01049"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a55">01049</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d6/kernel_2server_8c.html#a55">InitMessageTables</a>(VOID)
01050 {
01051     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"UserInit: Initialize Message Tables\n"</span>));
01052 
01053 <span class="preprocessor">#define INITMSGTABLE(member, procname)                \</span>
01054 <span class="preprocessor">    InitWindowMsgTable(&amp;(gSharedInfo.member.abMsgs),  \</span>
01055 <span class="preprocessor">                       &amp;(gSharedInfo.member.maxMsgs), \</span>
01056 <span class="preprocessor">                       gaw ## procname);</span>
01057 <span class="preprocessor"></span>
01058     <a class="code" href="../../d9/d6/kernel_2server_8c.html#a7">INITMSGTABLE</a>(DefWindowMsgs, DefWindowMsgs);
01059     <a class="code" href="../../d9/d6/kernel_2server_8c.html#a7">INITMSGTABLE</a>(DefWindowSpecMsgs, DefWindowSpecMsgs);
01060 
01061     <a class="code" href="../../d9/d6/kernel_2server_8c.html#a7">INITMSGTABLE</a>(awmControl[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a203">FNID_DIALOG</a>       - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a191">FNID_START</a>], DefDlgProc);
01062     <a class="code" href="../../d9/d6/kernel_2server_8c.html#a7">INITMSGTABLE</a>(awmControl[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a193">FNID_SCROLLBAR</a>    - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a191">FNID_START</a>], ScrollBarWndProc);
01063     <a class="code" href="../../d9/d6/kernel_2server_8c.html#a7">INITMSGTABLE</a>(awmControl[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a195">FNID_MENU</a>         - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a191">FNID_START</a>], MenuWndProc);
01064     <a class="code" href="../../d9/d6/kernel_2server_8c.html#a7">INITMSGTABLE</a>(awmControl[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a196">FNID_DESKTOP</a>      - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a191">FNID_START</a>], DesktopWndProc);
01065     <a class="code" href="../../d9/d6/kernel_2server_8c.html#a7">INITMSGTABLE</a>(awmControl[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a207">FNID_STATIC</a>       - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a191">FNID_START</a>], StaticWndProc);
01066     <a class="code" href="../../d9/d6/kernel_2server_8c.html#a7">INITMSGTABLE</a>(awmControl[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a200">FNID_BUTTON</a>       - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a191">FNID_START</a>], ButtonWndProc);
01067     <a class="code" href="../../d9/d6/kernel_2server_8c.html#a7">INITMSGTABLE</a>(awmControl[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a205">FNID_LISTBOX</a>      - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a191">FNID_START</a>], ListboxWndProc);
01068     <a class="code" href="../../d9/d6/kernel_2server_8c.html#a7">INITMSGTABLE</a>(awmControl[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a201">FNID_COMBOBOX</a>     - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a191">FNID_START</a>], ComboWndProc);
01069     <a class="code" href="../../d9/d6/kernel_2server_8c.html#a7">INITMSGTABLE</a>(awmControl[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a202">FNID_COMBOLISTBOX</a> - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a191">FNID_START</a>], ListboxWndProc);
01070     <a class="code" href="../../d9/d6/kernel_2server_8c.html#a7">INITMSGTABLE</a>(awmControl[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a204">FNID_EDIT</a>         - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a191">FNID_START</a>], <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a23">EditWndProc</a>);
01071     <a class="code" href="../../d9/d6/kernel_2server_8c.html#a7">INITMSGTABLE</a>(awmControl[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a208">FNID_IME</a>          - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a191">FNID_START</a>], ImeWndProc);
01072 }
01073 
01074 <span class="comment">/***************************************************************************\</span>
01075 <span class="comment">* InitOLEFormats</span>
01076 <span class="comment">*</span>
01077 <span class="comment">* OLE performance hack.  OLE was previously having to call the server</span>
01078 <span class="comment">* 15 times for clipboard formats and another 15 LPC calls for the global</span>
01079 <span class="comment">* atoms.  Now we preregister them.  We also assert they are in order so</span>
01080 <span class="comment">* OLE only has to query the first to know them all.  We call AddAtom</span>
01081 <span class="comment">* directly instead of RegisterClipboardFormat.</span>
01082 <span class="comment">*</span>
01083 <span class="comment">*</span>
01084 <span class="comment">* 25-Aug-1995 ChrisWil      Created.</span>
01085 <span class="comment">\***************************************************************************/</span>
01086 
<a name="l01087"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a58">01087</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d6/kernel_2server_8c.html#a58">InitOLEFormats</a>(VOID)
01088 {
01089     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> idx;
01090     ATOM a1;
01091     ATOM a2;
01092     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01093 
01094     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"UserInit: Initialize OLE Formats\n"</span>));
01095 
01096     a1 = <a class="code" href="../../d4/d1/userk_8h.html#a1297">UserAddAtom</a>(<a class="code" href="../../d9/d6/kernel_2server_8c.html#a44">lpszOLEFormats</a>[0], <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01097 
01098     <span class="keywordflow">for</span> (idx = 1; idx &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(<a class="code" href="../../d9/d6/kernel_2server_8c.html#a44">lpszOLEFormats</a>); idx++) {
01099         a2 = <a class="code" href="../../d4/d1/userk_8h.html#a1297">UserAddAtom</a>(<a class="code" href="../../d9/d6/kernel_2server_8c.html#a44">lpszOLEFormats</a>[idx], <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01100         fSuccess &amp;= !!a2;
01101 
01102         UserAssert(((a1 + 1) == a2) &amp;&amp; (a1 = a2));
01103     }
01104 
01105     <span class="keywordflow">if</span> (!fSuccess) {
01106         RIPMSG0(RIP_ERROR, <span class="stringliteral">"InitOLEFormats: at least one atom not registered"</span>);
01107     }
01108 
01109     <span class="keywordflow">return</span> fSuccess;
01110 }
01111 
01112 <span class="comment">/***************************************************************************\</span>
01113 <span class="comment">* InitGlobalRIPFlags (debug only)</span>
01114 <span class="comment">*</span>
01115 <span class="comment">* This initializes the global RIP flags from the registry.</span>
01116 <span class="comment">*</span>
01117 <span class="comment">*</span>
01118 <span class="comment">* 25-Aug-1995 ChrisWil      Created.</span>
01119 <span class="comment">\***************************************************************************/</span>
01120 <span class="preprocessor">#if DBG</span>
01121 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01122 <a class="code" href="../../d9/d6/kernel_2server_8c.html#a8">InitGlobalRIPFlags</a>()
01123 {
01124 
01125     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>  idx;
01126     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>  nCount;
01127     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwFlag;
01128 
01129     <span class="keyword">static</span> CONST <span class="keyword">struct </span>{
01130         LPWSTR lpszKey;
01131         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  dwDef;
01132         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  dwFlag;
01133     } aRIPFlags[] = {
01134         {<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"fPromptOnError"</span>  , 1, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a385">RIPF_PROMPTONERROR</a>  },
01135         {<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"fPromptOnWarning"</span>, 0, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a386">RIPF_PROMPTONWARNING</a>},
01136         {<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"fPromptOnVerbose"</span>, 0, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a387">RIPF_PROMPTONVERBOSE</a>},
01137         {<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"fPrintError"</span>     , 1, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a388">RIPF_PRINTONERROR</a>   },
01138         {<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"fPrintWarning"</span>   , 1, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a389">RIPF_PRINTONWARNING</a> },
01139         {<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"fPrintVerbose"</span>   , 0, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a390">RIPF_PRINTONVERBOSE</a> },
01140         {<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"fPrintFileLine"</span>  , 0, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a391">RIPF_PRINTFILELINE</a>  },
01141     };
01142 
01143     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"UserInit: Initialize Global RIP Flags\n"</span>));
01144 
01145     nCount = <span class="keyword">sizeof</span>(aRIPFlags) / <span class="keyword">sizeof</span>(aRIPFlags[0]);
01146 
01147     <span class="comment">/*</span>
01148 <span class="comment">     * Turn off the rip-on-warning bit.  This is necessary to prevent</span>
01149 <span class="comment">     * the FastGetProfileDwordW() routine from breaking into the</span>
01150 <span class="comment">     * debugger if an entry can't be found.  Since we provide default</span>
01151 <span class="comment">     * values, there's no sense to break.</span>
01152 <span class="comment">     */</span>
01153     UserAssert(gpsi != NULL);
01154 
01155     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a12">CLEAR_FLAG</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o0">wRIPFlags</a>, RIPF_PROMPTONWARNING);
01156     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a12">CLEAR_FLAG</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o0">wRIPFlags</a>, RIPF_PRINTONWARNING);
01157 
01158     <span class="keywordflow">for</span> (idx=0; idx &lt; nCount; idx++) {
01159 
01160         dwFlag = <a class="code" href="../../d4/d1/userk_8h.html#a2006">FastGetProfileDwordW</a>(NULL, PMAP_WINDOWSM,
01161                                       aRIPFlags[idx].lpszKey,
01162                                       aRIPFlags[idx].dwDef
01163                                       );
01164 
01165         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a15">SET_OR_CLEAR_FLAG</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o0">wRIPFlags</a>, aRIPFlags[idx].dwFlag, dwFlag);
01166     }
01167 
01168 }
01169 
01170 <span class="preprocessor">#else // DBG</span>
01171 <span class="preprocessor"></span>
<a name="l01172"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a8">01172</a> <span class="preprocessor">#define InitGlobalRIPFlags()</span>
01173 <span class="preprocessor"></span>
01174 <span class="preprocessor">#endif // DBG</span>
01175 <span class="preprocessor"></span>
01176 
01177 <span class="comment">/***************************************************************************\</span>
01178 <span class="comment">* _GetTextMetricsW</span>
01179 <span class="comment">* _TextOutW</span>
01180 <span class="comment">*</span>
01181 <span class="comment">* Server shared function thunks.</span>
01182 <span class="comment">*</span>
01183 <span class="comment">* History:</span>
01184 <span class="comment">* 10-Nov-1993 MikeKe    Created</span>
01185 <span class="comment">\***************************************************************************/</span>
01186 
<a name="l01187"></a><a class="code" href="../../d4/d1/userk_8h.html#a1933">01187</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1933">_GetTextMetricsW</a>(
01188     HDC           hdc,
01189     LPTEXTMETRICW ptm)
01190 {
01191     TMW_INTERNAL tmi;
01192     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>         <a class="code" href="../../d1/d1/xcpt4_8c.html#a13">fret</a>;
01193 
01194     <a class="code" href="../../d1/d1/xcpt4_8c.html#a13">fret</a> = GreGetTextMetricsW(hdc, &amp;tmi);
01195 
01196     *ptm = tmi.tmw;
01197 
01198     <span class="keywordflow">return</span> <a class="code" href="../../d1/d1/xcpt4_8c.html#a13">fret</a>;
01199 }
01200 
<a name="l01201"></a><a class="code" href="../../d5/d0/kernel_2text_8c.html#a0">01201</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d0/kernel_2text_8c.html#a0">_TextOutW</a>(
01202     HDC     hdc,
01203     <span class="keywordtype">int</span>     x,
01204     <span class="keywordtype">int</span>     y,
01205     LPCWSTR lp,
01206     UINT    cc)
01207 {
01208     <span class="keywordflow">return</span> GreExtTextOutW(hdc, x, y, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, (LPWSTR)lp, cc, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01209 }
01210 
01211 
01212 
01213 <span class="preprocessor">#ifndef PAGE_SIZE</span>
<a name="l01214"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a9">01214</a> <span class="preprocessor"></span><span class="preprocessor">#define PAGE_SIZE 0x1000</span>
01215 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01216 <span class="preprocessor"></span>
<a name="l01217"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a10">01217</a> <span class="preprocessor">#define ROUND_UP_TO_PAGES(SIZE) \</span>
01218 <span class="preprocessor">        (((ULONG)(SIZE) + PAGE_SIZE - 1) &amp; ~(PAGE_SIZE - 1))</span>
01219 <span class="preprocessor"></span>
01220 <span class="comment">/***************************************************************************\</span>
01221 <span class="comment">* InitCreateSharedSection</span>
01222 <span class="comment">*</span>
01223 <span class="comment">* This creates the shared section.</span>
01224 <span class="comment">*</span>
01225 <span class="comment">*</span>
01226 <span class="comment">* 25-Aug-1995 ChrisWil      Created comment block.</span>
01227 <span class="comment">\***************************************************************************/</span>
01228 
<a name="l01229"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a51">01229</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d9/d6/kernel_2server_8c.html#a51">InitCreateSharedSection</a>(VOID)
01230 {
01231     ULONG             ulHeapSize;
01232     ULONG             ulHandleTableSize;
01233     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>          <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01234     LARGE_INTEGER     SectionSize;
01235     SIZE_T            ViewSize;
01236     PVOID             pHeapBase;
01237 
01238     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"UserInit: Create Shared Memory Section\n"</span>));
01239 
01240     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a320">ghSectionShared</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01241 
01242     ulHeapSize        = <a class="code" href="../../d9/d9/csrdll_8h.html#a3">ROUND_UP_TO_PAGES</a>(<a class="code" href="../../d9/d6/kernel_2server_8c.html#a0">USRINIT_SHAREDSECT_SIZE</a> * 1024);
01243     ulHandleTableSize = <a class="code" href="../../d9/d9/csrdll_8h.html#a3">ROUND_UP_TO_PAGES</a>(0x10000 * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">HANDLEENTRY</a>));
01244 
01245     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"UserInit: Share: TableSize = %X; HeapSize = %X\n"</span>,
01246             ulHandleTableSize, ulHeapSize));
01247 
01248     SectionSize.LowPart  = ulHeapSize + ulHandleTableSize;
01249     SectionSize.HighPart = 0;
01250 
01251     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = Win32CreateSection(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a320">ghSectionShared</a>,
01252                                 SECTION_ALL_ACCESS,
01253                                 (POBJECT_ATTRIBUTES)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01254                                 &amp;SectionSize,
01255                                 PAGE_EXECUTE_READWRITE,
01256                                 SEC_RESERVE,
01257                                 (HANDLE)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01258                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01259                                 TAG_SECTION_SHARED);
01260 
01261     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01262         RIPMSG1(RIP_WARNING,
01263                 <span class="stringliteral">"MmCreateSection failed in InitCreateSharedSection with Status %x"</span>,
01264                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01265         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01266     }
01267 
01268     ViewSize = 0;
01269     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a321">gpvSharedBase</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01270 
01271     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = Win32MapViewInSessionSpace(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a320">ghSectionShared</a>, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a321">gpvSharedBase</a>, &amp;ViewSize);
01272 
01273     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01274         RIPMSG1(RIP_WARNING, <span class="stringliteral">"Win32MapViewInSessionSpace failed with Status %x"</span>,
01275                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01276         Win32DestroySection(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a320">ghSectionShared</a>);
01277         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a320">ghSectionShared</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01278         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01279     }
01280 
01281     pHeapBase = ((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a321">gpvSharedBase</a> + ulHandleTableSize);
01282 
01283     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"UserInit: Share: BaseAddr = %X; Heap = %X, ViewSize = %X\n"</span>,
01284             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a321">gpvSharedBase</a>, pHeapBase, ViewSize));
01285 
01286     <span class="comment">/*</span>
01287 <span class="comment">     * Create shared heap.</span>
01288 <span class="comment">     */</span>
01289     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a322">gpvSharedAlloc</a> = <a class="code" href="../../d4/d1/userk_8h.html#a999">UserCreateHeap</a>(
01290             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a320">ghSectionShared</a>,
01291             ulHandleTableSize,
01292             pHeapBase,
01293             ulHeapSize,
01294             <a class="code" href="../../d2/d9/w32_2ntuser_2kernel_2heap_8c.html#a1">UserCommitSharedMemory</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01295 
01296         RIPERR0(ERROR_NOT_ENOUGH_MEMORY, RIP_WARNING, <span class="stringliteral">"Can't create shared memory heap."</span>);
01297 
01298         Win32UnmapViewInSessionSpace(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a321">gpvSharedBase</a>);
01299 
01300         Win32DestroySection(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a320">ghSectionShared</a>);
01301         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a322">gpvSharedAlloc</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01302         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a321">gpvSharedBase</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01303         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a320">ghSectionShared</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01304 
01305         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01306     }
01307 
01308     UserAssert(Win32HeapGetHandle(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a322">gpvSharedAlloc</a>) == pHeapBase);
01309 
01310     <span class="keywordflow">return</span> STATUS_SUCCESS;
01311 }
01312 
01313 <span class="comment">/**************************************************************************\</span>
01314 <span class="comment">* InitCreateUserCrit</span>
01315 <span class="comment">*</span>
01316 <span class="comment">* Create and initialize the user critical sections needed throughout the</span>
01317 <span class="comment">* system.</span>
01318 <span class="comment">*</span>
01319 <span class="comment">* 23-Jan-1996 ChrisWil      Created.</span>
01320 <span class="comment">\**************************************************************************/</span>
01321 
<a name="l01322"></a><a class="code" href="../../d4/d1/userk_8h.html#a1263">01322</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1263">InitCreateUserCrit</a>(VOID)
01323 {
01324     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"Win32UserInit: InitCreateUserCrit()\n"</span>));
01325 
01326     <span class="comment">/*</span>
01327 <span class="comment">     * Initialize a critical section structure that will be used to protect</span>
01328 <span class="comment">     * all of the User Server's critical sections (except a few special</span>
01329 <span class="comment">     * cases like the RIT -- see below).</span>
01330 <span class="comment">     */</span>
01331     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a278">gpresUser</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>,
01332                                       <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a>),
01333                                       TAG_ERESOURCE);
01334     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a278">gpresUser</a>) {
01335         <span class="keywordflow">goto</span> InitCreateUserCritExit;
01336     }
01337     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d5/d8/ex_8h.html#a266">ExInitializeResourceLite</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a278">gpresUser</a>))) {
01338         <span class="keywordflow">goto</span> InitCreateUserCritExit;
01339     }
01340 
01341     <span class="comment">/*</span>
01342 <span class="comment">     * Initialize a critical section to be used in [Un]QueueMouseEvent</span>
01343 <span class="comment">     * to protect the queue of mouse input events that the desktop thread</span>
01344 <span class="comment">     * uses to pass input on to the RIT, after having moved the cursor</span>
01345 <span class="comment">     * without obtaining gpresUser itself.</span>
01346 <span class="comment">     */</span>
01347     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a212">gpresMouseEventQueue</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>,
01348                                                  <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d8/ex_8h.html#a125">ERESOURCE</a>),
01349                                                  TAG_ERESOURCE);
01350     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a212">gpresMouseEventQueue</a>) {
01351         <span class="keywordflow">goto</span> InitCreateUserCritExit;
01352     }
01353     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d5/d8/ex_8h.html#a266">ExInitializeResourceLite</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a212">gpresMouseEventQueue</a>))) {
01354         <span class="keywordflow">goto</span> InitCreateUserCritExit;
01355     }
01356 
01357     <span class="comment">/*</span>
01358 <span class="comment">     * Initialize a critical section to protect the list of DEVICEINFO structs</span>
01359 <span class="comment">     * kept under gpDeviceInfoList.  This is used by the RIT when reading kbd</span>
01360 <span class="comment">     * input, the desktop thread when reading mouse input, and the PnP callback</span>
01361 <span class="comment">     * routines DeviceClassNotify() and DeviceNotify() when devices come and go.</span>
01362 <span class="comment">     */</span>
01363     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a206">gpresDeviceInfoList</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>,
01364                                             <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d8/ex_8h.html#a125">ERESOURCE</a>),
01365                                             TAG_ERESOURCE);
01366     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a206">gpresDeviceInfoList</a>) {
01367         <span class="keywordflow">goto</span> InitCreateUserCritExit;
01368     }
01369     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d5/d8/ex_8h.html#a266">ExInitializeResourceLite</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a206">gpresDeviceInfoList</a>))) {
01370         <span class="keywordflow">goto</span> InitCreateUserCritExit;
01371     }
01372 
01373     <span class="comment">/*</span>
01374 <span class="comment">     * Create the handle flag mutex. We'll need this once we start creating</span>
01375 <span class="comment">     * windowstations and desktops.</span>
01376 <span class="comment">     */</span>
01377     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a279">gpHandleFlagsMutex</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>,
01378                                                <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>),
01379                                                TAG_SYSTEM);
01380     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a279">gpHandleFlagsMutex</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01381         <span class="keywordflow">goto</span> InitCreateUserCritExit;
01382     }
01383     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a279">gpHandleFlagsMutex</a>);
01384 
01385     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"Win32UserInit: gpHandleFlagsMutex = 0x%p\n"</span>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a279">gpHandleFlagsMutex</a>));
01386     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"Win32UserInit: gpresDeviceInfoList = 0x%X\n"</span>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a206">gpresDeviceInfoList</a>));
01387     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"Win32UserInit: gpresMouseEventQueue = 0x%X\n"</span>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a212">gpresMouseEventQueue</a>));
01388     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"Win32UserInit: gpresUser  = 0x%X\n"</span>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a278">gpresUser</a>));
01389 
01390     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"Win32UserInit: exit InitCreateUserCrit()\n"</span>));
01391     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01392 
01393 InitCreateUserCritExit:
01394     RIPERR0(ERROR_NOT_ENOUGH_MEMORY, RIP_ERROR,
01395             <span class="stringliteral">"Win32UserInit: InitCreateUserCrit failed"</span>);
01396 
01397     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a278">gpresUser</a>) {
01398         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a278">gpresUser</a>);
01399     }
01400     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a212">gpresMouseEventQueue</a>) {
01401         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a212">gpresMouseEventQueue</a>);
01402     }
01403     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a206">gpresDeviceInfoList</a>) {
01404         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a206">gpresDeviceInfoList</a>);
01405     }
01406     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01407 }
01408 
01409 <span class="comment">/**************************************************************************\</span>
01410 <span class="comment">* InitCreateObjectDirectory</span>
01411 <span class="comment">*</span>
01412 <span class="comment">* Create and initialize the user critical sections needed throughout the</span>
01413 <span class="comment">* system.</span>
01414 <span class="comment">*</span>
01415 <span class="comment">* 23-Jan-1996 ChrisWil      Created.</span>
01416 <span class="comment">\**************************************************************************/</span>
<a name="l01417"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a52">01417</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d9/d6/kernel_2server_8c.html#a52">InitCreateObjectDirectory</a>(VOID)
01418 {
01419     HANDLE            hDir;
01420     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>          <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01421     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
01422     UNICODE_STRING    UnicodeString;
01423     ULONG             attributes = OBJ_CASE_INSENSITIVE | OBJ_PERMANENT;
01424 
01425     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"UserInit: Create User Object-Directory\n"</span>));
01426 
01427     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, <a class="code" href="../../d6/d8/clinit_8c.html#a9">szWindowStationDirectory</a>);
01428 
01429     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>) {
01430        <span class="comment">/*</span>
01431 <span class="comment">        * Remote sessions don't use this flag</span>
01432 <span class="comment">        */</span>
01433        attributes &amp;= ~OBJ_PERMANENT;
01434     }
01435 
01436     InitializeObjectAttributes(&amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01437                                &amp;UnicodeString,
01438                                attributes,
01439                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01440                                <a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a5">gpsdInitWinSta</a>);
01441 
01442     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateDirectoryObject(&amp;hDir,
01443                                      DIRECTORY_CREATE_OBJECT,
01444                                      &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>);
01445 
01446     UserFreePool(<a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a5">gpsdInitWinSta</a>);
01447 
01448     <span class="comment">/*</span>
01449 <span class="comment">     * Do not close this handle for remote session because</span>
01450 <span class="comment">     * if we do close it then the directory will go away and</span>
01451 <span class="comment">     * we don't want that to happen. When CSRSS will go away</span>
01452 <span class="comment">     * this handle will be freed also.</span>
01453 <span class="comment">     */</span>
01454     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>)
01455         ZwClose(hDir);
01456 
01457     <a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a5">gpsdInitWinSta</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01458 
01459     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01460 }
01461 
01462 <span class="comment">/**************************************************************************\</span>
01463 <span class="comment">* InitCreateUserSubsystem</span>
01464 <span class="comment">*</span>
01465 <span class="comment">* Create and initialize the user subsystem stuff.</span>
01466 <span class="comment">* system.</span>
01467 <span class="comment">*</span>
01468 <span class="comment">* 23-Jan-1996 ChrisWil      Created.</span>
01469 <span class="comment">\**************************************************************************/</span>
01470 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l01471"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a68">01471</a> <a class="code" href="../../d9/d6/kernel_2server_8c.html#a68">InitCreateUserSubsystem</a>()
01472 {
01473     LPWSTR         lpszSubSystem;
01474     LPWSTR         lpszT;
01475     UNICODE_STRING strSize;
01476 
01477     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"UserInit: Create User SubSystem\n"</span>));
01478 
01479     <span class="comment">/*</span>
01480 <span class="comment">     * Initialize the subsystem section.  This identifies the default</span>
01481 <span class="comment">     * user-heap size.</span>
01482 <span class="comment">     */</span>
01483     lpszSubSystem = UserAllocPoolWithQuota(<a class="code" href="../../d9/d6/kernel_2server_8c.html#a4">USRINIT_SHAREDSECT_BUFF_SIZE</a> * <span class="keyword">sizeof</span>(WCHAR),
01484                                            TAG_SYSTEM);
01485 
01486     <span class="keywordflow">if</span> (lpszSubSystem == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01487         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01488     }
01489 
01490     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a2007">FastGetProfileStringW</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a705">PMAP_SUBSYSTEMS</a>,
01491                               <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Windows"</span>,
01492                               <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SharedSection=,3072"</span>,
01493                               lpszSubSystem,
01494                               <a class="code" href="../../d9/d6/kernel_2server_8c.html#a5">USRINIT_SHAREDSECT_READ_SIZE</a>
01495                               ) == 0) {
01496         RIPMSG0(RIP_WARNING,
01497                 <span class="stringliteral">"UserInit: Windows subsystem definition not found"</span>);
01498         UserFreePool(lpszSubSystem);
01499         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01500     }
01501 
01502     <span class="comment">/*</span>
01503 <span class="comment">     * Locate the SharedSection portion of the definition and extract</span>
01504 <span class="comment">     * the second value.</span>
01505 <span class="comment">     */</span>
01506     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a309">gdwDesktopSectionSize</a> = <a class="code" href="../../d9/d6/kernel_2server_8c.html#a2">USRINIT_WINDOWSECT_SIZE</a>;
01507     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a310">gdwNOIOSectionSize</a>    = <a class="code" href="../../d9/d6/kernel_2server_8c.html#a3">USRINIT_NOIOSECT_SIZE</a>;
01508 
01509     <span class="keywordflow">if</span> (lpszT = wcsstr(lpszSubSystem, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SharedSection"</span>)) {
01510 
01511         *(lpszT + 32) = UNICODE_NULL;
01512 
01513         <span class="keywordflow">if</span> (lpszT = wcschr(lpszT, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">','</span>)) {
01514 
01515             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strSize, ++lpszT);
01516             <a class="code" href="../../d9/d3/cnvint_8c.html#a4">RtlUnicodeStringToInteger</a>(&amp;strSize, 0, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a309">gdwDesktopSectionSize</a>);
01517 
01518             <span class="comment">/*</span>
01519 <span class="comment">             * Assert this logic doesn't need to change.</span>
01520 <span class="comment">             */</span>
01521             UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a309">gdwDesktopSectionSize</a> &gt;= <a class="code" href="../../d9/d6/kernel_2server_8c.html#a2">USRINIT_WINDOWSECT_SIZE</a>);
01522 
01523             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a309">gdwDesktopSectionSize</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<a class="code" href="../../d9/d6/kernel_2server_8c.html#a2">USRINIT_WINDOWSECT_SIZE</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a309">gdwDesktopSectionSize</a>);
01524             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a310">gdwNOIOSectionSize</a>    = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a309">gdwDesktopSectionSize</a>;
01525 
01526             <span class="comment">/*</span>
01527 <span class="comment">             * Now see if the optional non-interactive desktop</span>
01528 <span class="comment">             * heap size was specified.</span>
01529 <span class="comment">             */</span>
01530             <span class="keywordflow">if</span> (lpszT = wcschr(lpszT, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">','</span>)) {
01531 
01532                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strSize, ++lpszT);
01533                 <a class="code" href="../../d9/d3/cnvint_8c.html#a4">RtlUnicodeStringToInteger</a>(&amp;strSize, 0, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a310">gdwNOIOSectionSize</a>);
01534 
01535                 UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a310">gdwNOIOSectionSize</a> &gt;= <a class="code" href="../../d9/d6/kernel_2server_8c.html#a3">USRINIT_NOIOSECT_SIZE</a>);
01536                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a310">gdwNOIOSectionSize</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<a class="code" href="../../d9/d6/kernel_2server_8c.html#a3">USRINIT_NOIOSECT_SIZE</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a310">gdwNOIOSectionSize</a>);
01537             }
01538         }
01539     }
01540 
01541     UserFreePool(lpszSubSystem);
01542 
01543     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01544 }
01545 
<a name="l01546"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a46">01546</a> <span class="keyword">extern</span> UNICODE_STRING *<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a8">gpastrSetupExe</a>;     <span class="comment">// These are used in</span>
<a name="l01547"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a47">01547</a> <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d3/queue_8c.html#a14">giSetupExe</a>;                     <span class="comment">// SetAppImeCompatFlags in</span>
01548                                            <span class="comment">// queue.c</span>
01549 
<a name="l01550"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a48">01550</a> WCHAR* <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a9">glpSetupPrograms</a>;
01551 
01552 <span class="comment">/******************************************************</span>
01553 <span class="comment">*</span>
01554 <span class="comment">* Create and initialize the arrary of setup app names.</span>
01555 <span class="comment">* We inherited this hack From Chicago.  See queue.c for</span>
01556 <span class="comment">* more details.</span>
01557 <span class="comment">*******************************************************/</span>
01558 
<a name="l01559"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a69">01559</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d6/kernel_2server_8c.html#a69">CreateSetupNameArray</a>() {
01560     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  dwProgNames;
01561     <span class="keywordtype">int</span>    iSetupProgramCount = 0;
01562     WCHAR* lpTemp;
01563     <span class="keywordtype">int</span>    ic, icnt, icMax;
01564 
01565     dwProgNames = <a class="code" href="../../d4/d1/userk_8h.html#a2013">FastGetProfileValue</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a729">PMAP_SETUPPROGRAMNAMES</a>,
01566                         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SetupProgramNames"</span>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
01567 
01568     <span class="comment">/*</span>
01569 <span class="comment">     * This key is a multi-string, so is best to read as a value.</span>
01570 <span class="comment">     * First, get the length and create the buffer to hold all of</span>
01571 <span class="comment">     * the strings.</span>
01572 <span class="comment">     */</span>
01573     <span class="keywordflow">if</span> (dwProgNames == 0) {
01574         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01575     }
01576 
01577     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a9">glpSetupPrograms</a> = UserAllocPoolWithQuota(dwProgNames,
01578                                        TAG_SYSTEM);
01579 
01580     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a9">glpSetupPrograms</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01581         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CreateSetupNameArray: Memory allocation failure"</span>);
01582         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01583     }
01584 
01585     <a class="code" href="../../d4/d1/userk_8h.html#a2013">FastGetProfileValue</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01586                         <a class="code" href="../../d4/d1/userk_8h.html#a729">PMAP_SETUPPROGRAMNAMES</a>,
01587                         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SetupProgramNames"</span>,
01588                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01589                         (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a9">glpSetupPrograms</a>,
01590                         dwProgNames);
01591 
01592     lpTemp = <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a9">glpSetupPrograms</a>;
01593     icMax = dwProgNames/2;
01594     ic = 0; icnt=0;
01595     <span class="comment">/*</span>
01596 <span class="comment">     * Now count the strings.</span>
01597 <span class="comment">     */</span>
01598     <span class="keywordflow">while</span> (ic &lt; icMax) {
01599         <span class="keywordflow">if</span> (*(lpTemp+ic) == 0) {
01600             ic++;
01601             <span class="keywordflow">continue</span>;
01602         }
01603         ic += wcslen(lpTemp+ic)+1;
01604         icnt++;
01605     }
01606 
01607     <span class="comment">/*</span>
01608 <span class="comment">     * gpastrSetupExe is a pointer to an array of UNICODE_STRING structures.</span>
01609 <span class="comment">     * Each structure is the name of one setup program.</span>
01610 <span class="comment">     */</span>
01611     <a class="code" href="../../d6/d3/queue_8c.html#a14">giSetupExe</a> = icnt;
01612     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a8">gpastrSetupExe</a> = UserAllocPoolWithQuota(<a class="code" href="../../d6/d3/queue_8c.html#a14">giSetupExe</a> * <span class="keyword">sizeof</span>(UNICODE_STRING),
01613                                        TAG_SYSTEM);
01614 
01615     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a8">gpastrSetupExe</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01616         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CreateSetupNameArray: Memory allocation failure"</span>);
01617         <a class="code" href="../../d6/d3/queue_8c.html#a14">giSetupExe</a> = 0;
01618         UserFreePool(<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a9">glpSetupPrograms</a>);
01619         <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a9">glpSetupPrograms</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01620         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01621     }
01622 
01623     ic = 0; icnt=0;
01624     <span class="keywordflow">while</span> (ic &lt; icMax) {
01625         <span class="keywordflow">if</span> (*(lpTemp+ic) == 0) {
01626             ic++;
01627             <span class="keywordflow">continue</span>;
01628         }
01629         <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a8">gpastrSetupExe</a>[icnt].Buffer = lpTemp+ic;
01630         <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a8">gpastrSetupExe</a>[icnt].Length = <span class="keyword">sizeof</span>(WCHAR)*wcslen(lpTemp+ic);
01631         <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a8">gpastrSetupExe</a>[icnt].MaximumLength = <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a8">gpastrSetupExe</a>[icnt].Length + <span class="keyword">sizeof</span>(WCHAR);
01632         ic += wcslen(lpTemp+ic)+1;
01633         icnt++;
01634 
01635     }
01636 
01637     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01638 }
01639 
<a name="l01640"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a11">01640</a> <span class="preprocessor">#define CALC_DELTA(element)                   \</span>
01641 <span class="preprocessor">        (PVOID)((PBYTE)pClientBase +          \</span>
01642 <span class="preprocessor">        ((PBYTE)gSharedInfo.element -         \</span>
01643 <span class="preprocessor">        (PBYTE)gpvSharedBase))</span>
01644 <span class="preprocessor"></span>
01645 <span class="comment">/***************************************************************************\</span>
01646 <span class="comment">* InitMapSharedSection</span>
01647 <span class="comment">*</span>
01648 <span class="comment">* This maps the shared section.</span>
01649 <span class="comment">*</span>
01650 <span class="comment">*</span>
01651 <span class="comment">* 25-Aug-1995 ChrisWil      Created comment block.</span>
01652 <span class="comment">\***************************************************************************/</span>
01653 
<a name="l01654"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a70">01654</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d9/d6/kernel_2server_8c.html#a70">InitMapSharedSection</a>(
01655     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>    Process,
01656     <a class="code" href="../../d6/d4/struct__USERCONNECT.html">PUSERCONNECT</a> pUserConnect)
01657 {
01658     <span class="keywordtype">int</span>           i;
01659     PVOID         pClientBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01660     ULONG_PTR      ulSharedDelta;
01661 
01662     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"UserInit: Map Shared Memory Section\n"</span>));
01663 
01664     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a320">ghSectionShared</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01665 
01666     <a class="code" href="../../d4/d1/userk_8h.html#a519">ValidateProcessSessionId</a>(Process);
01667 
01668     <span class="comment">/*</span>
01669 <span class="comment">     * Check to see if we haven't already mapped the section</span>
01670 <span class="comment">     * This might happen for multiple LoadLibrary()/FreeLibrary calls</span>
01671 <span class="comment">     * in one process.  MCostea #56946</span>
01672 <span class="comment">     */</span>
01673     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o72">Win32Process</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
01674         ((<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>)Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o72">Win32Process</a>)-&gt;pClientBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01675 
01676         SIZE_T        ViewSize;
01677         LARGE_INTEGER liOffset;
01678         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01679 
01680         ViewSize = 0;
01681         liOffset.QuadPart = 0;
01682 
01683         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a21">MmMapViewOfSection</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a320">ghSectionShared</a>,
01684                                 Process,
01685                                 &amp;pClientBase,
01686                                 0,
01687                                 0,
01688                                 &amp;liOffset,
01689                                 &amp;ViewSize,
01690                                 ViewUnmap,
01691                                 SEC_NO_CHANGE,
01692                                 PAGE_EXECUTE_READ);
01693         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01694             <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"UserInit: Map: Client SharedInfo Base = %x\n"</span>, pClientBase));
01695 
01696             UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a321">gpvSharedBase</a> &gt; pClientBase);
01697             <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o72">Win32Process</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01698                 ((<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>)Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o72">Win32Process</a>)-&gt;pClientBase = pClientBase;
01699             }
01700         } <span class="keywordflow">else</span> {
01701             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01702         }
01703 
01704     } <span class="keywordflow">else</span> {
01705         pClientBase = ((<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>)Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o72">Win32Process</a>)-&gt;pClientBase;
01706     }
01707     ulSharedDelta = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a321">gpvSharedBase</a> - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pClientBase;
01708     pUserConnect-&gt;<a class="code" href="../../d6/d4/struct__USERCONNECT.html#o3">siClient</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o3">ulSharedDelta</a> = ulSharedDelta;
01709 
01710     pUserConnect-&gt;<a class="code" href="../../d6/d4/struct__USERCONNECT.html#o3">siClient</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o0">psi</a>          = <a class="code" href="../../d9/d6/kernel_2server_8c.html#a11">CALC_DELTA</a>(psi);
01711     pUserConnect-&gt;<a class="code" href="../../d6/d4/struct__USERCONNECT.html#o3">siClient</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>      = <a class="code" href="../../d9/d6/kernel_2server_8c.html#a11">CALC_DELTA</a>(aheList);
01712     pUserConnect-&gt;<a class="code" href="../../d6/d4/struct__USERCONNECT.html#o3">siClient</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o2">pDispInfo</a>    = <a class="code" href="../../d9/d6/kernel_2server_8c.html#a11">CALC_DELTA</a>(pDispInfo);
01713 
01714 
01715     pUserConnect-&gt;<a class="code" href="../../d6/d4/struct__USERCONNECT.html#o3">siClient</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o6">DefWindowMsgs</a>.<a class="code" href="../../d1/d9/struct__WNDMSG.html#o0">maxMsgs</a>     = <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o6">DefWindowMsgs</a>.<a class="code" href="../../d1/d9/struct__WNDMSG.html#o0">maxMsgs</a>;
01716     pUserConnect-&gt;<a class="code" href="../../d6/d4/struct__USERCONNECT.html#o3">siClient</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o6">DefWindowMsgs</a>.<a class="code" href="../../d1/d9/struct__WNDMSG.html#o1">abMsgs</a>      = <a class="code" href="../../d9/d6/kernel_2server_8c.html#a11">CALC_DELTA</a>(DefWindowMsgs.abMsgs);
01717     pUserConnect-&gt;<a class="code" href="../../d6/d4/struct__USERCONNECT.html#o3">siClient</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o7">DefWindowSpecMsgs</a>.<a class="code" href="../../d1/d9/struct__WNDMSG.html#o0">maxMsgs</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o7">DefWindowSpecMsgs</a>.<a class="code" href="../../d1/d9/struct__WNDMSG.html#o0">maxMsgs</a>;
01718     pUserConnect-&gt;<a class="code" href="../../d6/d4/struct__USERCONNECT.html#o3">siClient</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o7">DefWindowSpecMsgs</a>.<a class="code" href="../../d1/d9/struct__WNDMSG.html#o1">abMsgs</a>  = <a class="code" href="../../d9/d6/kernel_2server_8c.html#a11">CALC_DELTA</a>(DefWindowSpecMsgs.abMsgs);
01719 
01720     <span class="keywordflow">for</span> (i = 0; i &lt; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a223">FNID_END</a> - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a191">FNID_START</a> + 1); ++i) {
01721 
01722         pUserConnect-&gt;<a class="code" href="../../d6/d4/struct__USERCONNECT.html#o3">siClient</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o5">awmControl</a>[i].<a class="code" href="../../d1/d9/struct__WNDMSG.html#o0">maxMsgs</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o5">awmControl</a>[i].<a class="code" href="../../d1/d9/struct__WNDMSG.html#o0">maxMsgs</a>;
01723 
01724         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o5">awmControl</a>[i].<a class="code" href="../../d1/d9/struct__WNDMSG.html#o1">abMsgs</a>)
01725             pUserConnect-&gt;<a class="code" href="../../d6/d4/struct__USERCONNECT.html#o3">siClient</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o5">awmControl</a>[i].<a class="code" href="../../d1/d9/struct__WNDMSG.html#o1">abMsgs</a> = <a class="code" href="../../d9/d6/kernel_2server_8c.html#a11">CALC_DELTA</a>(awmControl[i].abMsgs);
01726         <span class="keywordflow">else</span>
01727             pUserConnect-&gt;<a class="code" href="../../d6/d4/struct__USERCONNECT.html#o3">siClient</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o5">awmControl</a>[i].<a class="code" href="../../d1/d9/struct__WNDMSG.html#o1">abMsgs</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01728     }
01729     <span class="keywordflow">return</span> STATUS_SUCCESS;
01730 }
01731 <span class="comment">/**************************************************************************\</span>
01732 <span class="comment">* InitLoadResources</span>
01733 <span class="comment">*</span>
01734 <span class="comment">*</span>
01735 <span class="comment">* 25-Aug-1995 ChrisWil      Created.</span>
01736 <span class="comment">\**************************************************************************/</span>
01737 
<a name="l01738"></a><a class="code" href="../../d4/d1/userk_8h.html#a1266">01738</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d6/kernel_2server_8c.html#a71">InitLoadResources</a>()
01739 {
01740     PRECT   prc;
01741 
01742     <a class="code" href="../../d0/d4/structtagDISPLAYRESOURCE.html">DISPLAYRESOURCE</a> dr = {
01743         17,     <span class="comment">// Height of vertical thumb</span>
01744         17,     <span class="comment">// Width of horizontal thumb</span>
01745         2,      <span class="comment">// Icon horiz compression factor</span>
01746         2,      <span class="comment">// Icon vert compression factor</span>
01747         1,      <span class="comment">// Cursor horz compression factor</span>
01748         1,      <span class="comment">// Cursor vert compression factor</span>
01749         0,      <span class="comment">// Kanji window height</span>
01750         1,      <span class="comment">// cxBorder (thickness of vertical lines)</span>
01751         1       <span class="comment">// cyBorder (thickness of horizontal lines)</span>
01752     };
01753 
01754 
01755     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"UserInit: Load Display Resources\n"</span>));
01756 
01757     <span class="keywordflow">if</span> (dr.<a class="code" href="../../d0/d4/structtagDISPLAYRESOURCE.html#o2">xCompressIcon</a> &gt; 10) {
01758 
01759         <span class="comment">/*</span>
01760 <span class="comment">         * If so, the actual dimensions of icons and cursors are</span>
01761 <span class="comment">         * kept in OEMBIN.</span>
01762 <span class="comment">         */</span>
01763         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXICON)   = dr.<a class="code" href="../../d0/d4/structtagDISPLAYRESOURCE.html#o2">xCompressIcon</a>;
01764         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYICON)   = dr.<a class="code" href="../../d0/d4/structtagDISPLAYRESOURCE.html#o3">yCompressIcon</a>;
01765         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXCURSOR) = dr.<a class="code" href="../../d0/d4/structtagDISPLAYRESOURCE.html#o4">xCompressCursor</a>;
01766         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYCURSOR) = dr.<a class="code" href="../../d0/d4/structtagDISPLAYRESOURCE.html#o5">yCompressCursor</a>;
01767 
01768     } <span class="keywordflow">else</span> {
01769 
01770         <span class="comment">/*</span>
01771 <span class="comment">         * Else, only the ratio of (64/icon dimensions) is kept there.</span>
01772 <span class="comment">         */</span>
01773         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXICON)   = (64 / dr.<a class="code" href="../../d0/d4/structtagDISPLAYRESOURCE.html#o2">xCompressIcon</a>);
01774         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYICON)   = (64 / dr.<a class="code" href="../../d0/d4/structtagDISPLAYRESOURCE.html#o3">yCompressIcon</a>);
01775         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXCURSOR) = (32 / dr.<a class="code" href="../../d0/d4/structtagDISPLAYRESOURCE.html#o4">xCompressCursor</a>);
01776         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYCURSOR) = (32 / dr.<a class="code" href="../../d0/d4/structtagDISPLAYRESOURCE.html#o5">yCompressCursor</a>);
01777     }
01778 
01779     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXSMICON) = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXICON) / 2;
01780     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYSMICON) = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYICON) / 2;
01781 
01782     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYKANJIWINDOW) = dr.<a class="code" href="../../d0/d4/structtagDISPLAYRESOURCE.html#o6">yKanji</a>;
01783 
01784     <span class="comment">/*</span>
01785 <span class="comment">     * Get border thicknesses.</span>
01786 <span class="comment">     */</span>
01787     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXBORDER) = dr.<a class="code" href="../../d0/d4/structtagDISPLAYRESOURCE.html#o7">cxBorder</a>;
01788     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYBORDER) = dr.<a class="code" href="../../d0/d4/structtagDISPLAYRESOURCE.html#o8">cyBorder</a>;
01789 
01790     <span class="comment">/*</span>
01791 <span class="comment">     * Edge is two borders.</span>
01792 <span class="comment">     */</span>
01793     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXEDGE) = 2 * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXBORDER);
01794     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYEDGE) = 2 * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYBORDER);
01795 
01796     <span class="comment">/*</span>
01797 <span class="comment">     * Fixed frame is outer edge + border.</span>
01798 <span class="comment">     */</span>
01799     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXDLGFRAME) = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXEDGE) + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXBORDER);
01800     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYDLGFRAME) = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYEDGE) + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYBORDER);
01801 
01802     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>) {
01803         <span class="keywordflow">return</span>;
01804     }
01805 
01806     prc = &amp;<a class="code" href="../../d6/d0/usercli_8h.html#a793">GetPrimaryMonitor</a>()-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>;
01807     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXFULLSCREEN) = prc-&gt;right;
01808     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYFULLSCREEN) = prc-&gt;bottom - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYCAPTION);
01809 
01810     <span class="comment">/*</span>
01811 <span class="comment">     * Set the initial cursor position to the center of the primary screen.</span>
01812 <span class="comment">     */</span>
01813     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor.x = prc-&gt;right / 2;
01814     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor.y = prc-&gt;bottom / 2;
01815 }
01816 
01817 <span class="comment">/***************************************************************************\</span>
01818 <span class="comment">* GetCharDimensions</span>
01819 <span class="comment">*</span>
01820 <span class="comment">* This function loads the Textmetrics of the font currently selected into</span>
01821 <span class="comment">* the hDC and returns the Average char width of the font; Pl Note that the</span>
01822 <span class="comment">* AveCharWidth value returned by the Text metrics call is wrong for</span>
01823 <span class="comment">* proportional fonts.  So, we compute them On return, lpTextMetrics contains</span>
01824 <span class="comment">* the text metrics of the currently selected font.</span>
01825 <span class="comment">*</span>
01826 <span class="comment">* History:</span>
01827 <span class="comment">* 10-Nov-1993 mikeke   Created</span>
01828 <span class="comment">\***************************************************************************/</span>
<a name="l01829"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a72">01829</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/d6/kernel_2server_8c.html#a72">GetCharDimensions</a>(
01830         HDC          hdc,
01831         TEXTMETRIC*  lptm,
01832         LPINT        lpcy
01833         )
01834 {
01835     TEXTMETRIC tm;
01836 
01837     <span class="comment">/*</span>
01838 <span class="comment">     * Didn't find it in cache, store the font metrics info.</span>
01839 <span class="comment">     */</span>
01840     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1933">_GetTextMetricsW</a>(hdc, &amp;tm)) {
01841         RIPMSG1(RIP_WARNING, <span class="stringliteral">"GetCharDimensions: _GetTextMetricsW failed. hdc %#lx"</span>, hdc);
01842         tm = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;tmSysFont; <span class="comment">// damage control</span>
01843 
01844         <span class="keywordflow">if</span> (tm.tmAveCharWidth == 0) {
01845             RIPMSG0(RIP_WARNING, <span class="stringliteral">"GetCharDimensions: _GetTextMetricsW first time failure"</span>);
01846             tm.tmAveCharWidth = 8;
01847         }
01848     }
01849     <span class="keywordflow">if</span> (lptm != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01850         *lptm = tm;
01851     <span class="keywordflow">if</span> (lpcy != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01852         *lpcy = tm.tmHeight;
01853 
01854     <span class="comment">/*</span>
01855 <span class="comment">     * If variable_width font</span>
01856 <span class="comment">     */</span>
01857     <span class="keywordflow">if</span> (tm.tmPitchAndFamily &amp; TMPF_FIXED_PITCH) {
01858         SIZE size;
01859         <span class="keyword">static</span> CONST WCHAR wszAvgChars[] =
01860                 <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"</span>;
01861 
01862         <span class="comment">/*</span>
01863 <span class="comment">         * Change from tmAveCharWidth.  We will calculate a true average</span>
01864 <span class="comment">         * as opposed to the one returned by tmAveCharWidth.  This works</span>
01865 <span class="comment">         * better when dealing with proportional spaced fonts.</span>
01866 <span class="comment">         */</span>
01867         <span class="keywordflow">if</span> (GreGetTextExtentW(
01868                 hdc, (LPWSTR)wszAvgChars,
01869                 (<span class="keyword">sizeof</span>(wszAvgChars) / <span class="keyword">sizeof</span>(WCHAR)) - 1,
01870                 &amp;size, GGTE_WIN3_EXTENT)) {
01871 
01872             UserAssert((((size.cx / 26) + 1) / 2) &gt; 0);
01873             <span class="keywordflow">return</span> ((size.cx / 26) + 1) / 2;    <span class="comment">// round up</span>
01874         } <span class="keywordflow">else</span> {
01875             RIPMSG1(RIP_WARNING, <span class="stringliteral">"GetCharDimensions: GreGetTextExtentW failed. hdc %#lx"</span>, hdc);
01876         }
01877     }
01878 
01879     UserAssert(tm.tmAveCharWidth &gt; 0);
01880 
01881     <span class="keywordflow">return</span> tm.tmAveCharWidth;
01882 }
01883 
01884 
01885 <span class="comment">/**************************************************************************\</span>
01886 <span class="comment">* InitVideo</span>
01887 <span class="comment">*</span>
01888 <span class="comment">* Create pmdev.</span>
01889 <span class="comment">*</span>
01890 <span class="comment">* 03-March-1998 CLupu  Moved from UserInitialize code</span>
01891 <span class="comment">\**************************************************************************/</span>
01892 
<a name="l01893"></a><a class="code" href="../../d4/d1/userk_8h.html#a1264">01893</a> PMDEV <a class="code" href="../../d4/d1/userk_8h.html#a1264">InitVideo</a>(
01894     BOOL bReenumerationNeeded)
01895 {
01896     PMDEV pmdev;
01897     LONG  ChangeStatus;
01898 
01899     <span class="comment">/*</span>
01900 <span class="comment">     * BUGBUG !!! Need to get a status return from this call.</span>
01901 <span class="comment">     */</span>
01902     DrvInitConsole(bReenumerationNeeded);
01903 
01904     <span class="comment">/*</span>
01905 <span class="comment">     * BASEVIDEO may be on or off, whether we are in setup or not.</span>
01906 <span class="comment">     */</span>
01907 
01908     ChangeStatus = DrvChangeDisplaySettings(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01909                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01910                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01911                                             (PVOID) (<a class="code" href="../../d4/d1/userk_8h.html#a300">GW_DESKTOP_ID</a>),
01912                                             <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01913                                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01914                                             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01915                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01916                                             &amp;pmdev,
01917                                             GRE_DEFAULT,
01918                                             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01919 
01920     <span class="keywordflow">if</span> (ChangeStatus != GRE_DISP_CHANGE_SUCCESSFUL) {
01921 
01922         <span class="comment">/*</span>
01923 <span class="comment">         * If we fail, try BASEVIDEO temporarily</span>
01924 <span class="comment">         */</span>
01925 
01926         DrvSetBaseVideo(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01927 
01928         ChangeStatus = DrvChangeDisplaySettings(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01929                                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01930                                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01931                                                 (PVOID) (<a class="code" href="../../d4/d1/userk_8h.html#a300">GW_DESKTOP_ID</a>),
01932                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01933                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01934                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01935                                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01936                                                 &amp;pmdev,
01937                                                 GRE_DEFAULT,
01938                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01939 
01940         DrvSetBaseVideo(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01941 
01942         <span class="comment">/*</span>
01943 <span class="comment">         * Give it one last try, not in basevideo, to handle TGA</span>
01944 <span class="comment">         * (non-vgacompatible) during GUI-mode setup (BASEVIDEO is on by</span>
01945 <span class="comment">         * default)</span>
01946 <span class="comment">         */</span>
01947 
01948         <span class="keywordflow">if</span> (ChangeStatus != GRE_DISP_CHANGE_SUCCESSFUL) {
01949 
01950             ChangeStatus = DrvChangeDisplaySettings(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01951                                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01952                                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01953                                                     (PVOID) (<a class="code" href="../../d4/d1/userk_8h.html#a300">GW_DESKTOP_ID</a>),
01954                                                     <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01955                                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01956                                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01957                                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01958                                                     &amp;pmdev,
01959                                                     GRE_DEFAULT,
01960                                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01961 
01962         }
01963     }
01964 
01965     <span class="keywordflow">if</span> (ChangeStatus != GRE_DISP_CHANGE_SUCCESSFUL) {
01966         RIPMSG0(RIP_WARNING, <span class="stringliteral">"InitVideo: No working display driver found"</span>);
01967         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01968     }
01969 
01970     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>  = pmdev-&gt;hdevParent;
01971     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a> = pmdev;
01972 
01973     GreUpdateSharedDevCaps(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
01974 
01975     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/fullscr_8c.html#a17">InitUserScreen</a>()) {
01976         RIPMSG0(RIP_WARNING, <span class="stringliteral">"InitUserScreen failed"</span>);
01977         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01978     }
01979 
01980     <a class="code" href="../../d4/d1/userk_8h.html#a773">HYDRA_HINT</a>(<a class="code" href="../../d4/d1/userk_8h.html#a755">HH_INITVIDEO</a>);
01981 
01982     <span class="keywordflow">return</span> pmdev;
01983 }
01984 
<a name="l01985"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a74">01985</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/d6/kernel_2server_8c.html#a74">DrvDriverFailure</a>(<span class="keywordtype">void</span>)
01986 {
01987     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(VIDEO_DRIVER_INIT_FAILURE,
01988                  0,
01989                  0,
01990                  0,
01991                  <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a409">USERCURRENTVERSION</a>);
01992 }
01993 
01994 
01995 <span class="comment">/**************************************************************************\</span>
01996 <span class="comment">* UserInitialize</span>
01997 <span class="comment">*</span>
01998 <span class="comment">* Worker routine for user initialization.</span>
01999 <span class="comment">*</span>
02000 <span class="comment">* 25-Aug-1995 ChrisWil  Created comment block/Multiple desktop support.</span>
02001 <span class="comment">* 15-Dec-1995 BradG     Modified to return MediaChangeEvent Handle.</span>
02002 <span class="comment">\**************************************************************************/</span>
02003 
<a name="l02004"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a75">02004</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d9/d6/kernel_2server_8c.html#a75">UserInitialize</a>(VOID)
02005 {
02006     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02007 
02008     <span class="comment">/*</span>
02009 <span class="comment">     * Allow a trace of all the init stuff going on related to display drivers.</span>
02010 <span class="comment">     * Usefull to debug boot time problems related to graphics.</span>
02011 <span class="comment">     */</span>
02012     <span class="keywordflow">if</span> (**((PULONG *)&amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a>) &amp; FLG_SHOW_LDR_SNAPS)
02013         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a275">TraceInitialization</a> = 1;
02014 
02015     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"Entering UserInitialize\n"</span>));
02016 
02017     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
02018 
02019     <a class="code" href="../../d4/d1/userk_8h.html#a773">HYDRA_HINT</a>(<a class="code" href="../../d4/d1/userk_8h.html#a754">HH_USERINITIALIZE</a>);
02020 
02021     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
02022 
02023         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>) {
02024             swprintf(<a class="code" href="../../d6/d8/clinit_8c.html#a9">szWindowStationDirectory</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%ws\\%ld%ws"</span>,
02025                      <a class="code" href="../../d8/d9/dllinit_8c.html#a2">SESSION_ROOT</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a327">gSessionId</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a92">WINSTA_DIR</a>);
02026         } <span class="keywordflow">else</span> {
02027             wcscpy(<a class="code" href="../../d6/d8/clinit_8c.html#a9">szWindowStationDirectory</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a92">WINSTA_DIR</a>);
02028         }
02029     } <span class="keywordflow">else</span> {
02030         wcscpy(<a class="code" href="../../d6/d8/clinit_8c.html#a9">szWindowStationDirectory</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a92">WINSTA_DIR</a>);
02031     }
02032 
02033     <span class="comment">/*</span>
02034 <span class="comment">     * Create WindowStation object directory.</span>
02035 <span class="comment">     */</span>
02036     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d6/kernel_2server_8c.html#a52">InitCreateObjectDirectory</a>();
02037 
02038     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02039         RIPMSG1(RIP_WARNING, <span class="stringliteral">"InitCreateObjectDirectory failed with Status %x"</span>,
02040                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02041 
02042         <span class="keywordflow">goto</span> Exit;
02043     }
02044 
02045     <span class="comment">/*</span>
02046 <span class="comment">     * WinStations get init'ed on the first connect</span>
02047 <span class="comment">     */</span>
02048     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>) {
02049 
02050         <span class="comment">/*</span>
02051 <span class="comment">         * Create the event for the diconnect desktop creation</span>
02052 <span class="comment">         */</span>
02053         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a19">gpEventDiconnectDesktop</a> = <a class="code" href="../../d4/d1/userk_8h.html#a965">CreateKernelEvent</a>(SynchronizationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02054 
02055         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a19">gpEventDiconnectDesktop</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02056             RIPMSG0(RIP_WARNING, <span class="stringliteral">"Failed to create gpEventDiconnectDesktop"</span>);
02057             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
02058             <span class="keywordflow">goto</span> Exit;
02059         }
02060 
02061         <span class="keywordflow">goto</span> SkipRemote;
02062     }
02063 
02064     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1264">InitVideo</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02065         <a class="code" href="../../d9/d6/kernel_2server_8c.html#a74">DrvDriverFailure</a>();
02066     }
02067 
02068     <span class="comment">/*</span>
02069 <span class="comment">     * Do this here so power callouts</span>
02070 <span class="comment">     * have the pmdev in gpDispInfo set</span>
02071 <span class="comment">     */</span>
02072     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a323">gbVideoInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02073 
02074 SkipRemote:
02075 
02076     <a class="code" href="../../d7/d2/power_8c.html#a0">gbUserInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02077 
02078     <span class="comment">/*</span>
02079 <span class="comment">     * Now that the system is initialized, allocate</span>
02080 <span class="comment">     * a pti for this thread.</span>
02081 <span class="comment">     */</span>
02082     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1189">xxxCreateThreadInfo</a>(<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>(), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02083 
02084     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02085         RIPMSG1(RIP_WARNING, <span class="stringliteral">"xxxCreateThreadInfo failed during UserInitialize with Status"</span>,
02086                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02087         <span class="keywordflow">goto</span> Exit;
02088     }
02089 
02090     <span class="comment">/*</span>
02091 <span class="comment">     * Initialize Global RIP flags (debug only).</span>
02092 <span class="comment">     */</span>
02093     <a class="code" href="../../d9/d6/kernel_2server_8c.html#a8">InitGlobalRIPFlags</a>();
02094 
02095     <span class="comment">/*</span>
02096 <span class="comment">     * WinStations get init'ed on the first connect</span>
02097 <span class="comment">     */</span>
02098     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>)
02099         UserVerify(<a class="code" href="../../d4/d1/userk_8h.html#a1844">LW_BrushInit</a>());
02100 
02101     <a class="code" href="../../d9/d6/kernel_2server_8c.html#a71">InitLoadResources</a>();
02102 
02103 Exit:
02104     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
02105 
02106     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"Leaving UserInitialize\n"</span>));
02107 
02108     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02109 }
02110 
02111 <span class="comment">/**************************************************************************\</span>
02112 <span class="comment">* IsDBCSEnabledSystem</span>
02113 <span class="comment">*</span>
02114 <span class="comment">* check if the system is configured as FE Enabled</span>
02115 <span class="comment">*</span>
02116 <span class="comment">* 07-Feb-1997 HiroYama  Created</span>
02117 <span class="comment">\**************************************************************************/</span>
<a name="l02118"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a76">02118</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d6/kernel_2server_8c.html#a76">IsDBCSEnabledSystem</a>()
02119 {
02120     <span class="keyword">extern</span> BOOLEAN* <a class="code" href="../../d9/d6/nlsxlat_8c.html#a19">NlsMbCodePageTag</a>;
02121     <span class="keywordflow">return</span> !!*<a class="code" href="../../d9/d6/nlsxlat_8c.html#a19">NlsMbCodePageTag</a>;
02122 }
02123 
02124 
<a name="l02125"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a77">02125</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d6/kernel_2server_8c.html#a77">IsIMMEnabledSystem</a>()
02126 {
02127     <span class="comment">// if the entire system is DBCS enabled, IMM/IME should be activated anyway</span>
02128     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d6/kernel_2server_8c.html#a76">IsDBCSEnabledSystem</a>())
02129         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02130 
02131     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a2006">FastGetProfileDwordW</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a726">PMAP_IMM</a>, TEXT(<span class="stringliteral">"LoadIMM"</span>), 0);
02132 }
02133 
02134 <span class="comment">// Get ACP and check if the system is configured as ME Enabled</span>
<a name="l02135"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a78">02135</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d6/kernel_2server_8c.html#a78">IsMidEastEnabledSystem</a>()
02136 {
02137     <span class="keyword">extern</span> <a class="code" href="../../d5/d6/chartran_8c.html#a2">__declspec</a>(dllimport) <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d9/d6/nlsxlat_8c.html#a12">NlsAnsiCodePage</a>;
02138     <span class="comment">//1255 Hebrew and 1256 Arabic</span>
02139     <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d6/nlsxlat_8c.html#a12">NlsAnsiCodePage</a> == 1255) || (<a class="code" href="../../d9/d6/nlsxlat_8c.html#a12">NlsAnsiCodePage</a> == 1256)) {
02140         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02141     }
02142     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02143 }
02144 
02145 <span class="comment">/***************************************************************************\</span>
02146 <span class="comment">* SetupClassAtoms</span>
02147 <span class="comment">*</span>
02148 <span class="comment">* 10/01/1998   clupu          moved from Win32UserInitialize</span>
02149 <span class="comment">\***************************************************************************/</span>
02150 
<a name="l02151"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a79">02151</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d6/kernel_2server_8c.html#a79">SetupClassAtoms</a>(
02152     VOID)
02153 {
02154     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02155     <span class="keywordtype">int</span>  ind;
02156 
02157     <span class="comment">/*</span>
02158 <span class="comment">     * Set up class atoms</span>
02159 <span class="comment">     */</span>
02160     <span class="comment">/*</span>
02161 <span class="comment">     * HACK: Controls are registered on the client side so we can't</span>
02162 <span class="comment">     * fill in their atomSysClass entry the same way we do for the other</span>
02163 <span class="comment">     * classes.</span>
02164 <span class="comment">     */</span>
02165     <span class="keywordflow">for</span> (ind = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a68">ICLS_BUTTON</a>; ind &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a74">ICLS_CTL_MAX</a>; ind++) {
02166         <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[ind] = <a class="code" href="../../d4/d1/userk_8h.html#a1297">UserAddAtom</a>(<a class="code" href="../../d9/d6/kernel_2server_8c.html#a45">lpszControls</a>[ind], <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02167         fSuccess &amp;= !!<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[ind];
02168     }
02169 
02170     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a76">ICLS_DIALOG</a>]    = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a40">DIALOGCLASS</a>);
02171     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a79">ICLS_ICONTITLE</a>] = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a42">ICONTITLECLASS</a>);
02172     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a90">ICLS_TOOLTIP</a>]   = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a44">TOOLTIPCLASS</a>);
02173     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a75">ICLS_DESKTOP</a>]   = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a39">DESKTOPCLASS</a>);
02174     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a78">ICLS_SWITCH</a>]    = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a41">SWITCHWNDCLASS</a>);
02175     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a77">ICLS_MENU</a>]      = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a45">MENUCLASS</a>);
02176 
02177     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o30">atomContextHelpIdProp</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1297">UserAddAtom</a>(<a class="code" href="../../d9/d6/kernel_2server_8c.html#a23">szCONTEXTHELPIDPROP</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02178     fSuccess &amp;= !!<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o30">atomContextHelpIdProp</a>;
02179 
02180     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o28">atomIconSmProp</a>        = <a class="code" href="../../d4/d1/userk_8h.html#a1297">UserAddAtom</a>(<a class="code" href="../../d9/d6/kernel_2server_8c.html#a24">szICONSM_PROP_NAME</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02181     fSuccess &amp;= !!<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o28">atomIconSmProp</a>;
02182 
02183     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o29">atomIconProp</a>          = <a class="code" href="../../d4/d1/userk_8h.html#a1297">UserAddAtom</a>(<a class="code" href="../../d9/d6/kernel_2server_8c.html#a25">szICON_PROP_NAME</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02184     fSuccess &amp;= !!<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o29">atomIconProp</a>;
02185 
02186     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o15">uiShellMsg</a>            = <a class="code" href="../../d4/d1/userk_8h.html#a1297">UserAddAtom</a>(<a class="code" href="../../d9/d6/kernel_2server_8c.html#a26">szSHELLHOOK</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02187     fSuccess &amp;= !!<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o15">uiShellMsg</a>;
02188 
02189     <span class="comment">/*</span>
02190 <span class="comment">     * Initialize the integer atoms for our magic window properties</span>
02191 <span class="comment">     */</span>
02192     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a287">atomCheckpointProp</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1297">UserAddAtom</a>(<a class="code" href="../../d9/d6/kernel_2server_8c.html#a14">szCHECKPOINT_PROP_NAME</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02193     fSuccess &amp;= !!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a287">atomCheckpointProp</a>;
02194 
02195     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a288">atomDDETrack</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1297">UserAddAtom</a>(<a class="code" href="../../d9/d6/kernel_2server_8c.html#a15">szDDETRACK_PROP_NAME</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02196     fSuccess &amp;= !!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a288">atomDDETrack</a>;
02197 
02198     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a289">atomQOS</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1297">UserAddAtom</a>(<a class="code" href="../../d9/d6/kernel_2server_8c.html#a16">szQOS_PROP_NAME</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02199     fSuccess &amp;= !!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a289">atomQOS</a>;
02200 
02201     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a290">atomDDEImp</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1297">UserAddAtom</a>(<a class="code" href="../../d9/d6/kernel_2server_8c.html#a17">szDDEIMP_PROP_NAME</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02202     fSuccess &amp;= !!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a290">atomDDEImp</a>;
02203 
02204     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a291">atomWndObj</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1297">UserAddAtom</a>(<a class="code" href="../../d9/d6/kernel_2server_8c.html#a18">szWNDOBJ_PROP_NAME</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02205     fSuccess &amp;= !!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a291">atomWndObj</a>;
02206 
02207     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a292">atomImeLevel</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1297">UserAddAtom</a>(<a class="code" href="../../d9/d6/kernel_2server_8c.html#a19">szIMELEVEL_PROP_NAME</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02208     fSuccess &amp;= !!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a292">atomImeLevel</a>;
02209 
02210     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a293">atomLayer</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1297">UserAddAtom</a>(<a class="code" href="../../d9/d6/kernel_2server_8c.html#a20">szLAYER_PROP_NAME</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02211     fSuccess &amp;= !!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a293">atomLayer</a>;
02212 
02213     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a296">guiActivateShellWindow</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1297">UserAddAtom</a>(<a class="code" href="../../d9/d6/kernel_2server_8c.html#a27">szACTIVATESHELLWINDOW</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02214     fSuccess &amp;= !!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a296">guiActivateShellWindow</a>;
02215 
02216     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a294">guiOtherWindowCreated</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1297">UserAddAtom</a>(<a class="code" href="../../d9/d6/kernel_2server_8c.html#a28">szOTHERWINDOWCREATED</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02217     fSuccess &amp;= !!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a294">guiOtherWindowCreated</a>;
02218 
02219     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a295">guiOtherWindowDestroyed</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1297">UserAddAtom</a>(<a class="code" href="../../d9/d6/kernel_2server_8c.html#a29">szOTHERWINDOWDESTROYED</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02220     fSuccess &amp;= !!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a295">guiOtherWindowDestroyed</a>;
02221 
02222     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a284">gatomMessage</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1297">UserAddAtom</a>(<a class="code" href="../../d9/d6/kernel_2server_8c.html#a22">szMESSAGE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02223     fSuccess &amp;= !!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a284">gatomMessage</a>;
02224 
02225 <span class="preprocessor">#ifdef HUNGAPP_GHOSTING</span>
02226 <span class="preprocessor"></span>    gatomGhost = <a class="code" href="../../d4/d1/userk_8h.html#a1297">UserAddAtom</a>(szGHOST, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02227     fSuccess &amp;= !!gatomGhost;
02228 <span class="preprocessor">#endif // HUNGAPP_GHOSTING</span>
02229 <span class="preprocessor"></span>
02230     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a285">gaOleMainThreadWndClass</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1297">UserAddAtom</a>(<a class="code" href="../../d9/d6/kernel_2server_8c.html#a30">szOLEMAINTHREADWNDCLASS</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02231     fSuccess &amp;= !!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a285">gaOleMainThreadWndClass</a>;
02232 
02233     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a286">gaFlashWState</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1297">UserAddAtom</a>(<a class="code" href="../../d9/d6/kernel_2server_8c.html#a31">szFLASHWSTATE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02234     fSuccess &amp;= !!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a286">gaFlashWState</a>;
02235 
02236     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a283">gatomLastPinned</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a285">gaOleMainThreadWndClass</a>;
02237 
02238     <span class="keywordflow">return</span> fSuccess;
02239 }
02240 
02241 
02242 <span class="comment">/**************************************************************************\</span>
02243 <span class="comment">* Win32UserInitialize</span>
02244 <span class="comment">*</span>
02245 <span class="comment">* Worker routine for user initialization called from Win32k.sys DriverEntry()</span>
02246 <span class="comment">*</span>
02247 <span class="comment">\**************************************************************************/</span>
02248 
<a name="l02249"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a23">02249</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d9/d6/kernel_2server_8c.html#a59">Win32UserInitialize</a>(VOID)
02250 {
02251     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02252     <a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html">POBJECT_TYPE_INITIALIZER</a> pTypeInfo;
02253     LONG                     lTemp;
02254 
02255     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"Entering Win32UserInitialize\n"</span>));
02256 
02257     <span class="comment">/*</span>
02258 <span class="comment">     * Create the shared section.</span>
02259 <span class="comment">     */</span>
02260     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d6/kernel_2server_8c.html#a51">InitCreateSharedSection</a>();
02261     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02262         RIPMSG0(RIP_WARNING, <span class="stringliteral">"InitCreateSharedSection failed"</span>);
02263         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02264     }
02265 
02266     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
02267 
02268     <span class="comment">/*</span>
02269 <span class="comment">     * Initialize security stuff.</span>
02270 <span class="comment">     */</span>
02271     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1272">InitSecurity</a>()) {
02272         RIPMSG0(RIP_WARNING, <span class="stringliteral">"InitSecurity failed"</span>);
02273         <span class="keywordflow">goto</span> ExitWin32UserInitialize;
02274     }
02275 
02276     <span class="comment">/*</span>
02277 <span class="comment">     * Fill in windowstation and desktop object types</span>
02278 <span class="comment">     */</span>
02279     pTypeInfo = &amp;(*ExWindowStationObjectType)-&gt;TypeInfo;
02280     pTypeInfo-&gt;<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o11">DefaultNonPagedPoolCharge</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">WINDOWSTATION</a>) + <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>);
02281     pTypeInfo-&gt;<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o10">DefaultPagedPoolCharge</a>    = 0;
02282     pTypeInfo-&gt;<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o7">MaintainHandleCount</a>       = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02283     pTypeInfo-&gt;<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o14">CloseProcedure</a>            = <a class="code" href="../../d4/d1/userk_8h.html#a1285">DestroyWindowStation</a>;
02284     pTypeInfo-&gt;<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o15">DeleteProcedure</a>           = <a class="code" href="../../d4/d1/userk_8h.html#a1286">FreeWindowStation</a>;
02285     pTypeInfo-&gt;<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o16">ParseProcedure</a>            = <a class="code" href="../../d4/d1/userk_8h.html#a1287">ParseWindowStation</a>;
02286     pTypeInfo-&gt;<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o19">OkayToCloseProcedure</a>      = <a class="code" href="../../d4/d1/userk_8h.html#a1288">OkayToCloseWindowStation</a>;
02287     pTypeInfo-&gt;<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o5">ValidAccessMask</a>           = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a304">WinStaMapping</a>.GenericAll;
02288     pTypeInfo-&gt;<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>            = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a304">WinStaMapping</a>;
02289 
02290     pTypeInfo = &amp;(*ExDesktopObjectType)-&gt;TypeInfo;
02291     pTypeInfo-&gt;<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o11">DefaultNonPagedPoolCharge</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d3/structtagDESKTOP.html">DESKTOP</a>);
02292     pTypeInfo-&gt;<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o10">DefaultPagedPoolCharge</a>    = 0;
02293     pTypeInfo-&gt;<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o7">MaintainHandleCount</a>       = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02294     pTypeInfo-&gt;<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o14">CloseProcedure</a>            = <a class="code" href="../../d9/d6/desktop_8c.html#a24">UnmapDesktop</a>;
02295     pTypeInfo-&gt;<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o13">OpenProcedure</a>             = <a class="code" href="../../d9/d6/desktop_8c.html#a23">MapDesktop</a>;
02296     pTypeInfo-&gt;<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o15">DeleteProcedure</a>           = <a class="code" href="../../d9/d6/desktop_8c.html#a19">FreeDesktop</a>;
02297     pTypeInfo-&gt;<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o19">OkayToCloseProcedure</a>      = <a class="code" href="../../d9/d6/desktop_8c.html#a25">OkayToCloseDesktop</a>;
02298     pTypeInfo-&gt;<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o5">ValidAccessMask</a>           = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a305">DesktopMapping</a>.GenericAll;
02299     pTypeInfo-&gt;<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>            = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a305">DesktopMapping</a>;
02300 
02301     <span class="comment">/*</span>
02302 <span class="comment">     * Get this process so we can use the profiles.</span>
02303 <span class="comment">     */</span>
02304     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a300">gpepInit</a> = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
02305 
02306     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>  = <a class="code" href="../../d6/d3/queue_8c.html#a55">InitQEntryLookaside</a>();
02307     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> |= <a class="code" href="../../d3/d6/kernel_2sendmsg_8c.html#a14">InitSMSLookaside</a>();
02308     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a1296">UserRtlCreateAtomTable</a>(<a class="code" href="../../d9/d6/kernel_2server_8c.html#a1">USRINIT_ATOMBUCKET_SIZE</a>);
02309 
02310     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02311         RIPMSG0(RIP_WARNING, <span class="stringliteral">"Initialization failure"</span>);
02312         <span class="keywordflow">goto</span> ExitWin32UserInitialize;
02313     }
02314 
02315     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a297">atomUSER32</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1297">UserAddAtom</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a12">szUSER32</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02316 
02317     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a282">gatomFirstPinned</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a297">atomUSER32</a>;
02318 
02319     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a282">gatomFirstPinned</a> == 0) {
02320         RIPMSG0(RIP_WARNING, <span class="stringliteral">"Could not create atomUSER32"</span>);
02321         <span class="keywordflow">goto</span> ExitWin32UserInitialize;
02322     }
02323 
02324     <span class="comment">/*</span>
02325 <span class="comment">     * Initialize the user subsystem information.</span>
02326 <span class="comment">     */</span>
02327     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d6/kernel_2server_8c.html#a68">InitCreateUserSubsystem</a>()) {
02328         RIPMSG0(RIP_WARNING, <span class="stringliteral">"InitCreateUserSubsystem failed"</span>);
02329         <span class="keywordflow">goto</span> ExitWin32UserInitialize;
02330     }
02331 
02332     <span class="comment">/*</span>
02333 <span class="comment">     * Don't bail out if CreateSetupNameArray fails</span>
02334 <span class="comment">     * MCostea #326652</span>
02335 <span class="comment">     */</span>
02336     <a class="code" href="../../d9/d6/kernel_2server_8c.html#a69">CreateSetupNameArray</a>();
02337 
02338     <span class="comment">/*</span>
02339 <span class="comment">     * Allocated shared SERVERINFO structure.</span>
02340 <span class="comment">     */</span>
02341     <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a> = (<a class="code" href="../../d2/d6/structtagSERVERINFO.html">PSERVERINFO</a>)<a class="code" href="../../d4/d1/userk_8h.html#a1000">SharedAlloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/structtagSERVERINFO.html">SERVERINFO</a>))) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02342         RIPMSG0(RIP_WARNING, <span class="stringliteral">"Could not allocate SERVERINFO"</span>);
02343         <span class="keywordflow">goto</span> ExitWin32UserInitialize;
02344     }
02345 
02346     <span class="comment">/*</span>
02347 <span class="comment">     * Set the default rip-flags to rip on just about</span>
02348 <span class="comment">     * everything.  We'll truly set this in the InitGlobalRIPFlags()</span>
02349 <span class="comment">     * routine.  These are needed so that we can do appropriate ripping</span>
02350 <span class="comment">     * during the rest of the init-calls.</span>
02351 <span class="comment">     */</span>
02352 
02353     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a11">SET_FLAG</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o0">wRIPFlags</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a393">RIPF_DEFAULT</a>);
02354 
02355     <span class="comment">/*</span>
02356 <span class="comment">     * Make sure we will not get a division by zero if the initialization</span>
02357 <span class="comment">     * will not complete correctly. Set these to their normal values.</span>
02358 <span class="comment">     */</span>
02359     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cxMsgFontChar = 6;
02360     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cyMsgFontChar = 13;
02361     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cxSysFontChar = 8;
02362     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cySysFontChar = 16;
02363 
02364     <span class="comment">/*</span>
02365 <span class="comment">     * Initialize the DISPLAYINFO structure.</span>
02366 <span class="comment">     */</span>
02367     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1000">SharedAlloc</a>(<span class="keyword">sizeof</span>(*<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>));
02368     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>) {
02369         RIPMSG0(RIP_WARNING, <span class="stringliteral">"Could not allocate gpDispInfo"</span>);
02370         <span class="keywordflow">goto</span> ExitWin32UserInitialize;
02371     }
02372 
02373     InitDbgTags();
02374 
02375     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a383">SET_OR_CLEAR_SRVIF</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a376">SRVIF_DBCS</a>, <a class="code" href="../../d9/d6/kernel_2server_8c.html#a76">IsDBCSEnabledSystem</a>());
02376     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a383">SET_OR_CLEAR_SRVIF</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a377">SRVIF_IME</a>, <a class="code" href="../../d9/d6/kernel_2server_8c.html#a77">IsIMMEnabledSystem</a>());
02377 
02378     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a383">SET_OR_CLEAR_SRVIF</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a378">SRVIF_MIDEAST</a>, <a class="code" href="../../d9/d6/kernel_2server_8c.html#a78">IsMidEastEnabledSystem</a>());
02379 
02380 <span class="preprocessor">#if DBG</span>
02381 <span class="preprocessor"></span>    <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a381">SET_SRVIF</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a374">SRVIF_CHECKED</a>);
02382 
02383     RIPMSG3(RIP_WARNING, <span class="stringliteral">"*** win32k: DBCS:[%d] IME:[%d] MiddleEast:[%d]"</span>,
02384             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a125">IS_DBCS_ENABLED</a>(),
02385             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>(),
02386             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a128">IS_MIDEAST_ENABLED</a>());
02387 <span class="preprocessor">#endif</span>
02388 <span class="preprocessor"></span>
02389     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o14">dwDefaultHeapSize</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a309">gdwDesktopSectionSize</a> * 1024;
02390 
02391     <span class="comment">/*</span>
02392 <span class="comment">     * Initialize procedures and message tables.</span>
02393 <span class="comment">     * Initialize the class structures for Get/SetClassWord/Long.</span>
02394 <span class="comment">     * Initialize message-box strings.</span>
02395 <span class="comment">     * Initialize OLE-Formats (performance-hack).</span>
02396 <span class="comment">     */</span>
02397     <a class="code" href="../../d9/d6/kernel_2server_8c.html#a54">InitFunctionTables</a>();
02398     <a class="code" href="../../d9/d6/kernel_2server_8c.html#a55">InitMessageTables</a>();
02399 <span class="preprocessor">#if DBG</span>
02400 <span class="preprocessor"></span>    <a class="code" href="../../d9/d6/kernel_2server_8c.html#a57">VerifySyncOnlyMessages</a>();
02401 <span class="preprocessor">#endif</span>
02402 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d6/kernel_2server_8c.html#a58">InitOLEFormats</a>()) {
02403         RIPMSG0(RIP_WARNING, <span class="stringliteral">"InitOLEFormats failed"</span>);
02404         <span class="keywordflow">goto</span> ExitWin32UserInitialize;
02405     }
02406 
02407     <span class="comment">/*</span>
02408 <span class="comment">     * Set up class atoms</span>
02409 <span class="comment">     */</span>
02410     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d6/kernel_2server_8c.html#a79">SetupClassAtoms</a>()) {
02411         RIPMSG0(RIP_WARNING, <span class="stringliteral">"SetupClassAtoms failed to register atoms"</span>);
02412         <span class="keywordflow">goto</span> ExitWin32UserInitialize;
02413     }
02414 
02415     <a class="code" href="../../d4/d1/userk_8h.html#a1836">LW_LoadSomeStrings</a>();
02416 
02417     <span class="comment">/*</span>
02418 <span class="comment">     * Initialize the handle manager.</span>
02419 <span class="comment">     */</span>
02420     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a968">HMInitHandleTable</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a321">gpvSharedBase</a>)) {
02421         RIPMSG0(RIP_WARNING, <span class="stringliteral">"HMInitHandleTable failed"</span>);
02422         <span class="keywordflow">goto</span> ExitWin32UserInitialize;
02423     }
02424 
02425     <span class="comment">/*</span>
02426 <span class="comment">     * Setup shared info block.</span>
02427 <span class="comment">     */</span>
02428     <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o0">psi</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>;
02429     <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o2">pDispInfo</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>;
02430 
02431     <span class="comment">/*</span>
02432 <span class="comment">     * Determine if we have unsigned drivers installed</span>
02433 <span class="comment">     * Use      2BD63D28D7BCD0E251195AEB519243C13142EBC3 as current key to check.</span>
02434 <span class="comment">     * Old key: 300B971A74F97E098B67A4FCEBBBF6B9AE2F404C</span>
02435 <span class="comment">     */</span>
02436     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a21">RtlCheckRegistryKey</a>(RTL_REGISTRY_ABSOLUTE,
02437             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\SOFTWARE\\Microsoft\\SystemCertificates\\Root\\Certificates\\2BD63D28D7BCD0E251195AEB519243C13142EBC3"</span>))
02438              ||
02439             <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a21">RtlCheckRegistryKey</a>(RTL_REGISTRY_ABSOLUTE,
02440             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\SOFTWARE\\Policies\\Microsoft\\SystemCertificates\\Root\\Certificates\\2BD63D28D7BCD0E251195AEB519243C13142EBC3"</span>))) {
02441 
02442         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a8">gfUnsignedDrivers</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02443     }
02444 
02445     <span class="comment">/*</span>
02446 <span class="comment">     * Set up a desktop info structure that is visible in all</span>
02447 <span class="comment">     * clients.</span>
02448 <span class="comment">     */</span>
02449     lTemp = <a class="code" href="../../d4/d1/userk_8h.html#a2006">FastGetProfileDwordW</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02450                                  <a class="code" href="../../d4/d1/userk_8h.html#a696">PMAP_WINDOWSM</a>,
02451                                  <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"USERProcessHandleQuota"</span>,
02452                                  <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a253">gUserProcessHandleQuota</a>);
02453 
02454     <span class="keywordflow">if</span> ((lTemp &gt; <a class="code" href="../../d4/d1/userk_8h.html#a691">MINIMUM_USER_HANDLE_QUOTA</a>) &amp;&amp; (lTemp &lt;= <a class="code" href="../../d4/d1/userk_8h.html#a690">INITIAL_USER_HANDLE_QUOTA</a>)) {
02455         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a253">gUserProcessHandleQuota</a> = lTemp;
02456     }
02457 
02458     <span class="comment">/*</span>
02459 <span class="comment">     * The maximum number of posted message for a thread.</span>
02460 <span class="comment">     */</span>
02461     lTemp = <a class="code" href="../../d4/d1/userk_8h.html#a2006">FastGetProfileDwordW</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02462                                  <a class="code" href="../../d4/d1/userk_8h.html#a696">PMAP_WINDOWSM</a>,
02463                                  <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"USERPostMessageLimit"</span>,
02464                                  <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a254">gUserPostMessageLimit</a>);
02465     <span class="keywordflow">if</span> (lTemp &gt; <a class="code" href="../../d4/d1/userk_8h.html#a693">MINIMUM_POSTMESSAGE_LIMIT</a>) {
02466         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a254">gUserPostMessageLimit</a> = lTemp;
02467     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lTemp == 0) {
02468         <span class="comment">/*</span>
02469 <span class="comment">         * 0 means (virtually) No Limit.</span>
02470 <span class="comment">         */</span>
02471         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a254">gUserPostMessageLimit</a> = ~0;
02472     } <span class="keywordflow">else</span> {
02473         RIPMSG1(RIP_WARNING, <span class="stringliteral">"Win32UserInitialize: USERPostMessageLimit value (%d) is too low."</span>, lTemp);
02474     }
02475 
02476     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a7">gDrawVersionAlways</a>) {
02477         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a7">gDrawVersionAlways</a> = <a class="code" href="../../d4/d1/userk_8h.html#a2006">FastGetProfileDwordW</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02478                                                   <a class="code" href="../../d4/d1/userk_8h.html#a696">PMAP_WINDOWSM</a>,
02479                                                   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DisplayVersion"</span>,
02480                                                   0);
02481     }
02482 
02483     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a332">gbSecureDesktop</a> = <a class="code" href="../../d4/d1/userk_8h.html#a2006">FastGetProfileDwordW</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02484                                            <a class="code" href="../../d4/d1/userk_8h.html#a696">PMAP_WINDOWSM</a>,
02485                                            <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SecureDesktop"</span>,
02486                                            <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02487 
02488     <span class="comment">/*</span>
02489 <span class="comment">     * Initialize SMWP structure</span>
02490 <span class="comment">     */</span>
02491     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1617">AllocateCvr</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a149">gSMWP</a>, 4)) {
02492         RIPMSG0(RIP_WARNING, <span class="stringliteral">"AllocateCvr failed"</span>);
02493         <span class="keywordflow">goto</span> ExitWin32UserInitialize;
02494     }
02495     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
02496 
02497     UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02498     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02499 
02500 ExitWin32UserInitialize:
02501     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
02502 
02503     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02504         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
02505     }
02506 
02507     RIPMSG1(RIP_WARNING, <span class="stringliteral">"UserInitialize failed with Status = %x"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02508     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02509 }
02510 
02511 
02512 <span class="comment">/**************************************************************************\</span>
02513 <span class="comment">* UserGetDesktopDC</span>
02514 <span class="comment">*</span>
02515 <span class="comment">* 09-Jan-1992 mikeke created</span>
02516 <span class="comment">*    Dec-1993 andreva changed to support desktops.</span>
02517 <span class="comment">\**************************************************************************/</span>
02518 
<a name="l02519"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a80">02519</a> HDC <a class="code" href="../../d9/d6/kernel_2server_8c.html#a80">UserGetDesktopDC</a>(
02520     ULONG type,
02521     BOOL  bAltType,
02522     BOOL  bValidate)
02523 {
02524     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>    Thread;
02525     HDC         hdc;
02526     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>();  <span class="comment">// This is called from outside the crit sec</span>
02527     HDEV        hdev  = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>;
02528 
02529     <span class="keywordflow">if</span> (bValidate &amp;&amp; <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> != DCTYPE_INFO &amp;&amp;
02530         <a class="code" href="../../d4/d1/userk_8h.html#a382">IS_THREAD_RESTRICTED</a>(pti, JOB_OBJECT_UILIMIT_HANDLES)) {
02531 
02532         UserAssert(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02533 
02534         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>))) {
02535             RIPMSG0(RIP_WARNING,
02536                     <span class="stringliteral">"UserGetDesktopDC fails desktop window validation"</span>);
02537             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02538         }
02539     }
02540 
02541     <span class="comment">/*</span>
02542 <span class="comment">     * !!! BUGBUG</span>
02543 <span class="comment">     * This is a real nasty trick to get both DCs created on a desktop on</span>
02544 <span class="comment">     * a different device to work (for the video applet) and to be able</span>
02545 <span class="comment">     * to clip DCs that are actually on the same device ...</span>
02546 <span class="comment">     */</span>
02547     <span class="keywordflow">if</span> (pti &amp;&amp; pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>)
02548         hdev = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o1">pDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>;
02549 
02550     <span class="comment">/*</span>
02551 <span class="comment">     * We want to turn this call that was originally OpenDC("Display", ...)</span>
02552 <span class="comment">     * into GetDC null call so this DC will be clipped to the current</span>
02553 <span class="comment">     * desktop or else the DC can write to any desktop.  Only do this</span>
02554 <span class="comment">     * for client apps; let the server do whatever it wants.</span>
02555 <span class="comment">     */</span>
02556     Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
02557     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> != DCTYPE_DIRECT)  ||
02558         (hdev != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>) ||
02559         <a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(Thread) ||
02560         (Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o28">ThreadsProcess</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>)) {
02561 
02562         hdc = GreCreateDisplayDC(hdev, <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>, bAltType);
02563 
02564     } <span class="keywordflow">else</span> {
02565 
02566         <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk;
02567 
02568         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
02569 
02570         <span class="keywordflow">if</span> (pdesk = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;rpdesk) {
02571 
02572             hdc = <a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>,
02573                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02574                            DCX_WINDOW | DCX_CACHE | DCX_CREATEDC);
02575         } <span class="keywordflow">else</span> {
02576             hdc = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02577         }
02578 
02579         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
02580     }
02581 
02582     <span class="keywordflow">return</span> hdc;
02583 }
02584 
02585 
02586 <span class="comment">/**************************************************************************\</span>
02587 <span class="comment">* UserThreadCallout</span>
02588 <span class="comment">*</span>
02589 <span class="comment">*</span>
02590 <span class="comment">* Called by the kernel when a thread starts or ends.</span>
02591 <span class="comment">*</span>
02592 <span class="comment">* Dec-1993 andreva created.</span>
02593 <span class="comment">\**************************************************************************/</span>
02594 
<a name="l02595"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a81">02595</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d9/d6/kernel_2server_8c.html#a81">UserThreadCallout</a>(
02596     IN <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> pEThread,
02597     IN PSW32THREADCALLOUTTYPE CalloutType)
02598 {
02599     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
02600     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02601 
02602     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a278">gpresUser</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02603 
02604     <span class="keywordflow">switch</span> (CalloutType) {
02605         <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/ps_8h.html#a157a96">PsW32ThreadCalloutInitialize</a>:
02606             <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"Entering UserThreadCallout PsW32ThreadCalloutInitialize\n"</span>));
02607 
02608             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a324">gbNoMorePowerCallouts</a>) {
02609                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"No more GUI threads allowed"</span>);
02610                 <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
02611             }
02612 
02613             <span class="comment">/*</span>
02614 <span class="comment">             * Only create a thread info structure if we're initialized.</span>
02615 <span class="comment">             */</span>
02616             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d2/power_8c.html#a0">gbUserInitialized</a>) {
02617                 <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
02618                 UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02619 
02620                 <span class="comment">/*</span>
02621 <span class="comment">                 * Initialize this thread</span>
02622 <span class="comment">                 */</span>
02623                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1189">xxxCreateThreadInfo</a>(pEThread, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02624 
02625                 <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
02626             }
02627             <span class="keywordflow">break</span>;
02628 
02629        <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/ps_8h.html#a157a97">PsW32ThreadCalloutExit</a>:
02630 
02631             <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"Entering UserThreadCallout PsW32ThreadCalloutExit\n"</span>));
02632 
02633             <span class="comment">/*</span>
02634 <span class="comment">             * If we aren't already inside the critical section, enter it.</span>
02635 <span class="comment">             * Because this is the first pass, we remain in the critical</span>
02636 <span class="comment">             * section when we return so that our try/finally handlers</span>
02637 <span class="comment">             * are protected by the critical section.</span>
02638 <span class="comment">             * EnterCrit here before GreUnlockDisplay() provides a pti which</span>
02639 <span class="comment">             * may be required if unlocking the display may release some</span>
02640 <span class="comment">             * deferred WinEvents, for which a pti is required.</span>
02641 <span class="comment">             */</span>
02642             <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
02643 
02644             pti = (<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>)pEThread-&gt;Tcb.Win32Thread;
02645 
02646             <span class="comment">/*</span>
02647 <span class="comment">             * WinStations that haven't gone through the first connect do not</span>
02648 <span class="comment">             * have any of the graphics setup.</span>
02649 <span class="comment">             */</span>
02650             <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a> || <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a323">gbVideoInitialized</a>) {
02651 
02652                 <span class="comment">/*</span>
02653 <span class="comment">                 * Assert that we did not cleaned up gpDispInfo-&gt;hDev</span>
02654 <span class="comment">                 */</span>
02655                 UserAssert(!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a325">gbCleanedUpResources</a>);
02656 
02657                 GreLockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
02658                 GreUnlockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
02659             }
02660 
02661 
02662            <span class="comment">/*</span>
02663 <span class="comment">            * Mark this thread as in the middle of cleanup. This is useful for</span>
02664 <span class="comment">            * several problems in USER where we need to know this information.</span>
02665 <span class="comment">            */</span>
02666            pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>;
02667 
02668            <span class="comment">/*</span>
02669 <span class="comment">            * If we died during a full screen switch make sure we cleanup</span>
02670 <span class="comment">            * correctly</span>
02671 <span class="comment">            */</span>
02672            <a class="code" href="../../d8/d8/fullscr_8c.html#a9">FullScreenCleanup</a>();
02673            <span class="comment">/*</span>
02674 <span class="comment">            * Cleanup gpDispInfo-&gt;hdcScreen - if we crashed while using it,</span>
02675 <span class="comment">            * it may have owned objects still selected into it. Cleaning</span>
02676 <span class="comment">            * it this way will ensure that gdi doesn't try to delete these</span>
02677 <span class="comment">            * objects while they are still selected into this public hdc.</span>
02678 <span class="comment">            */</span>
02679 
02680            <span class="comment">/*</span>
02681 <span class="comment">            * WinStations that haven't gone through the first connect do not</span>
02682 <span class="comment">            * have any of the graphics setup.</span>
02683 <span class="comment">            */</span>
02684            <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a> || <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a323">gbVideoInitialized</a>) {
02685                GreCleanDC(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o3">hdcScreen</a>);
02686            }
02687 
02688            <span class="comment">/*</span>
02689 <span class="comment">            * This thread is exiting execution; xxxDestroyThreadInfo cleans</span>
02690 <span class="comment">            *  up everything that can go now</span>
02691 <span class="comment">            */</span>
02692            UserAssert(pti == <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
02693            <a class="code" href="../../d4/d1/userk_8h.html#a1885">xxxDestroyThreadInfo</a>();
02694            <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
02695 
02696            <span class="keywordflow">break</span>;
02697     }
02698 
02699     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"Leaving UserThreadCallout\n"</span>));
02700 
02701     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02702 }
02703 
02704 <span class="comment">/**************************************************************************\</span>
02705 <span class="comment">* NtUserInitialize</span>
02706 <span class="comment">*</span>
02707 <span class="comment">* 01-Dec-1993 andreva created.</span>
02708 <span class="comment">* 01-Dec-1995 BradG   Modified to return handle to Media Change Event</span>
02709 <span class="comment">\**************************************************************************/</span>
02710 
02711 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d6/kernel_2server_8c.html#a82">TellGdiToGetReady</a>();
02712 
<a name="l02713"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a83">02713</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d9/d6/kernel_2server_8c.html#a83">NtUserInitialize</a>(
02714     IN DWORD   dwVersion,
02715     IN HANDLE  hPowerRequestEvent,
02716     IN HANDLE  hMediaRequestEvent)
02717 {
02718     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02719 
02720     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"Entering NtUserInitialize\n"</span>));
02721 
02722     <span class="comment">/*</span>
02723 <span class="comment">     * Make sure we're not trying to load this twice.</span>
02724 <span class="comment">     */</span>
02725     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02726         RIPMSG0(RIP_ERROR, <span class="stringliteral">"Can't initialize more than once"</span>);
02727         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
02728     }
02729 
02730     <span class="comment">/*</span>
02731 <span class="comment">     * Check version number</span>
02732 <span class="comment">     */</span>
02733     <span class="keywordflow">if</span> (dwVersion != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a409">USERCURRENTVERSION</a>) {
02734         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(WIN32K_INIT_OR_RIT_FAILURE,
02735                      0,
02736                      0,
02737                      dwVersion,
02738                      <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a409">USERCURRENTVERSION</a>);
02739     }
02740 
02741     <span class="comment">/*</span>
02742 <span class="comment">     * Get the session ID from the EPROCESS structure</span>
02743 <span class="comment">     */</span>
02744     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a327">gSessionId</a> = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;SessionId;
02745 
02746     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a327">gSessionId</a> == 0 || <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02747 
02748     <span class="comment">/*</span>
02749 <span class="comment">     * Initialize the power request list.</span>
02750 <span class="comment">     */</span>
02751     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1966">InitializePowerRequestList</a>(hPowerRequestEvent);
02752     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02753         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02754     }
02755 
02756     <a class="code" href="../../d4/d1/userk_8h.html#a996">InitializeMediaChange</a>(hMediaRequestEvent);
02757 
02758     <span class="comment">/*</span>
02759 <span class="comment">     * Save the system process structure.</span>
02760 <span class="comment">     */</span>
02761     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a> = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
02762 
02763     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d6/kernel_2server_8c.html#a82">TellGdiToGetReady</a>())
02764     {
02765         RIPMSG0(RIP_WARNING, <span class="stringliteral">"TellGdiToGetReady failed"</span>);
02766         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
02767         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02768     }
02769 
02770     <span class="comment">/*</span>
02771 <span class="comment">     * Allow CSR to read the screen</span>
02772 <span class="comment">     */</span>
02773     ((PW32PROCESS)<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o72">Win32Process</a>)-&gt;W32PF_Flags |= (W32PF_READSCREENACCESSGRANTED|W32PF_IOWINSTA);
02774 
02775 
02776     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d6/kernel_2server_8c.html#a75">UserInitialize</a>();
02777 
02778     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"Leaving NtUserInitialize\n"</span>));
02779     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02780 }
02781 
02782 <span class="comment">/**************************************************************************\</span>
02783 <span class="comment">* NtUserProcessConnect</span>
02784 <span class="comment">*</span>
02785 <span class="comment">* 01-Dec-1993   Andreva     Created.</span>
02786 <span class="comment">\**************************************************************************/</span>
02787 
<a name="l02788"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a84">02788</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d9/d6/kernel_2server_8c.html#a84">NtUserProcessConnect</a>(
02789     IN HANDLE    hProcess,
02790     IN OUT PVOID pConnectInfo,
02791     IN ULONG     cbConnectInfo)
02792 {
02793     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>    Process;
02794     <a class="code" href="../../d6/d4/struct__USERCONNECT.html">PUSERCONNECT</a> pucConnect = (<a class="code" href="../../d6/d4/struct__USERCONNECT.html">PUSERCONNECT</a>)pConnectInfo;
02795     <a class="code" href="../../d6/d4/struct__USERCONNECT.html">USERCONNECT</a>  ucLocal;
02796     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02797 
02798 
02799     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"Entering NtUserProcessConnect\n"</span>));
02800 
02801     <span class="keywordflow">if</span> (!pucConnect || (cbConnectInfo != <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__USERCONNECT.html">USERCONNECT</a>))) {
02802         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
02803     }
02804 
02805     <span class="keywordflow">try</span> {
02806         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(pucConnect, cbConnectInfo, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
02807 
02808         ucLocal = *pucConnect;
02809     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
02810         <span class="keywordflow">return</span> GetExceptionCode();
02811     }
02812 
02813     <span class="comment">/*</span>
02814 <span class="comment">     * Check client/server versions.</span>
02815 <span class="comment">     */</span>
02816     <span class="keywordflow">if</span> (ucLocal.<a class="code" href="../../d6/d4/struct__USERCONNECT.html#o0">ulVersion</a> != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a409">USERCURRENTVERSION</a>) {
02817 
02818         RIPMSG2(RIP_ERROR,
02819             <span class="stringliteral">"Client version %lx &gt; server version %lx\n"</span>,
02820             ucLocal.<a class="code" href="../../d6/d4/struct__USERCONNECT.html#o0">ulVersion</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a409">USERCURRENTVERSION</a>);
02821         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
02822     }
02823 
02824 
02825 
02826     <span class="keywordflow">if</span> (ucLocal.<a class="code" href="../../d6/d4/struct__USERCONNECT.html#o2">dwDispatchCount</a> != <a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a11">gDispatchTableValues</a>) {
02827         RIPMSG2(RIP_ERROR,
02828             <span class="stringliteral">"!!!! Client Dispatch info %lX != Server %lX\n"</span>,
02829             ucLocal.<a class="code" href="../../d6/d4/struct__USERCONNECT.html#o2">dwDispatchCount</a>, <a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a11">gDispatchTableValues</a>);
02830     }
02831 
02832 
02833     <span class="comment">/*</span>
02834 <span class="comment">     * Reference the process.</span>
02835 <span class="comment">     */</span>
02836     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(hProcess,
02837                                        PROCESS_VM_OPERATION,
02838                                        *<a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>,
02839                                        <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
02840                                        &amp;Process,
02841                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02842     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
02843         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02844     <span class="comment">/*</span>
02845 <span class="comment">     * Return client's view of shared data.</span>
02846 <span class="comment">     */</span>
02847     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d6/kernel_2server_8c.html#a70">InitMapSharedSection</a>(Process, &amp;ucLocal);
02848 
02849     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)                       &amp;&amp;
02850         (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_NO_MEMORY)              &amp;&amp;
02851         (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_PROCESS_IS_TERMINATING) &amp;&amp;
02852         (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_QUOTA_EXCEEDED)         &amp;&amp;
02853         (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_COMMITMENT_LIMIT)) {
02854 
02855         RIPMSG2(RIP_ERROR,
02856               <span class="stringliteral">"Failed to map shared data into client %x, status = %x\n"</span>,
02857               <a class="code" href="../../d4/d1/userk_8h.html#a19">GetCurrentProcessId</a>(), <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02858     }
02859 
02860     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
02861 
02862     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02863 
02864         <span class="keywordflow">try</span> {
02865              *pucConnect = ucLocal;
02866         } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
02867             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
02868         }
02869     }
02870 
02871     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"Leaving NtUserProcessConnect\n"</span>));
02872 
02873     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02874 }
02875 
02876 <span class="comment">/**************************************************************************\</span>
02877 <span class="comment">* xxxUserProcessCallout</span>
02878 <span class="comment">*</span>
02879 <span class="comment">* 01-Dec-1993   andreva     Created.</span>
02880 <span class="comment">\**************************************************************************/</span>
02881 
<a name="l02882"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a85">02882</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d9/d6/kernel_2server_8c.html#a85">xxxUserProcessCallout</a>(
02883     IN PW32PROCESS Process,
02884     IN BOOLEAN     Initialize)
02885 {
02886     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02887 
02888     <span class="keywordflow">if</span> (Initialize) {
02889 
02890         <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"Entering xxxUserProcessCallout Initialize\n"</span>));
02891 
02892         UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a278">gpresUser</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02893         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
02894 
02895         <span class="comment">/*</span>
02896 <span class="comment">         * Initialize the important process level stuff.</span>
02897 <span class="comment">         */</span>
02898         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1200">xxxInitProcessInfo</a>(Process);
02899 
02900         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
02901 
02902         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
02903 
02904             <span class="keywordflow">if</span> (Process-&gt;Process &amp;&amp;
02905                 Process-&gt;Process-&gt;Job &amp;&amp;
02906                 Process-&gt;Process-&gt;Job-&gt;UIRestrictionsClass != 0) {
02907 
02908                 <a class="code" href="../../d4/d8/struct__WIN32__JOBCALLOUT__PARAMETERS.html">WIN32_JOBCALLOUT_PARAMETERS</a> Parms;
02909 
02910                 <a class="code" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job = Process-&gt;Process-&gt;Job;
02911 
02912                 <span class="comment">/*</span>
02913 <span class="comment">                 * aquire the job's lock and after that enter the user</span>
02914 <span class="comment">                 * critical section.</span>
02915 <span class="comment">                 */</span>
02916                 <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
02917                 <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02918 
02919                 Parms.<a class="code" href="../../d4/d8/struct__WIN32__JOBCALLOUT__PARAMETERS.html#o0">Job</a> = Job;
02920                 Parms.<a class="code" href="../../d4/d8/struct__WIN32__JOBCALLOUT__PARAMETERS.html#o1">CalloutType</a> = <a class="code" href="../../d1/d9/ps_8h.html#a156a94">PsW32JobCalloutAddProcess</a>;
02921                 Parms.<a class="code" href="../../d4/d8/struct__WIN32__JOBCALLOUT__PARAMETERS.html#o2">Data</a> = Process;
02922 
02923                 UserAssert(Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o27">SessionId</a> == Process-&gt;Process-&gt;SessionId);
02924 
02925                 <a class="code" href="../../d4/d1/userk_8h.html#a1144">UserJobCallout</a>(&amp;Parms);
02926 
02927                 <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>);
02928                 <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02929             }
02930         }
02931     } <span class="keywordflow">else</span> {
02932 
02933         <span class="keywordtype">int</span>  i;
02934         <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a>  phe;
02935         <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> *ppdce;
02936         <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> pdce;
02937 
02938         <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"Entering xxxUserProcessCallout Cleanup\n"</span>));
02939 
02940         UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a278">gpresUser</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02941 
02942         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
02943 
02944 <span class="preprocessor">#if DBG</span>
02945 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (Process-&gt;Process == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>) {
02946 
02947             <span class="comment">/*</span>
02948 <span class="comment">             * CSRSS should be the last to go ...</span>
02949 <span class="comment">             */</span>
02950             UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a110">gppiList</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o8">ppiNextRunning</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02951         }
02952 <span class="preprocessor">#endif // DBG</span>
02953 <span class="preprocessor"></span>
02954         <span class="keywordflow">if</span> (Process-&gt;Process &amp;&amp; Process-&gt;Process-&gt;Job != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02955             <a class="code" href="../../d4/d1/userk_8h.html#a1145">RemoveProcessFromJob</a>((<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>)Process);
02956         }
02957 
02958         <span class="comment">/*</span>
02959 <span class="comment">         * DestroyProcessInfo will return TRUE if any threads ever</span>
02960 <span class="comment">         * connected.  If nothing ever connected, we needn't do</span>
02961 <span class="comment">         * this cleanup.</span>
02962 <span class="comment">         */</span>
02963         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1190">DestroyProcessInfo</a>(Process)) {
02964 
02965             <span class="comment">/*</span>
02966 <span class="comment">             * See if we can compact the handle table.</span>
02967 <span class="comment">             */</span>
02968             i = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a308">giheLast</a>;
02969             phe = &amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>[<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a308">giheLast</a>];
02970             <span class="keywordflow">while</span> ((phe &gt; &amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>[0]) &amp;&amp; (phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a236">TYPE_FREE</a>)) {
02971                 phe--;
02972                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a308">giheLast</a>--;
02973             }
02974 
02975             <span class="comment">/*</span>
02976 <span class="comment">             * Scan the DC cache to find any DC's that need to be destroyed.</span>
02977 <span class="comment">             */</span>
02978             <span class="keywordflow">for</span> (ppdce = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a>; *ppdce != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; ) {
02979 
02980                 pdce = *ppdce;
02981                 <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_DESTROYTHIS)
02982                     <a class="code" href="../../d4/d1/userk_8h.html#a1700">DestroyCacheDC</a>(ppdce, pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>);
02983 
02984                 <span class="comment">/*</span>
02985 <span class="comment">                 * Step to the next DC.  If the DC was deleted, there</span>
02986 <span class="comment">                 * is no need to calculate address of the next entry.</span>
02987 <span class="comment">                 */</span>
02988                 <span class="keywordflow">if</span> (pdce == *ppdce)
02989                     ppdce = &amp;pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o0">pdceNext</a>;
02990             }
02991         }
02992 
02993         UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a278">gpresUser</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02994 
02995         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
02996     }
02997 
02998     <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"Leaving xxxUserProcessCallout\n"</span>));
02999 
03000     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03001 }
03002 
03003 <span class="comment">/**************************************************************************\</span>
03004 <span class="comment">* UserGetHDEV</span>
03005 <span class="comment">*</span>
03006 <span class="comment">* Provided as a means for GDI to get a hold of USER's hDev.</span>
03007 <span class="comment">*</span>
03008 <span class="comment">* 01-Jan-1996   ChrisWil    Created.</span>
03009 <span class="comment">\**************************************************************************/</span>
03010 
<a name="l03011"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a86">03011</a> HDEV <a class="code" href="../../d9/d6/kernel_2server_8c.html#a86">UserGetHDEV</a>(VOID)
03012 {
03013 
03014     <span class="comment">/*</span>
03015 <span class="comment">     * BUGBUG This is busted.</span>
03016 <span class="comment">     *        This need to return the device for the current desktop.</span>
03017 <span class="comment">     *        The graphics device may not be the same for all desktops.</span>
03018 <span class="comment">     *        -Andre</span>
03019 <span class="comment">     */</span>
03020     <span class="keywordflow">return</span> <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>;
03021 }
03022 
03023 <span class="comment">/**************************************************************************\</span>
03024 <span class="comment">* _UserGetGlobalAtomTable</span>
03025 <span class="comment">*</span>
03026 <span class="comment">* This function is called by the kernel mode global atom manager to get the</span>
03027 <span class="comment">* address of the current thread's global atom table.</span>
03028 <span class="comment">*</span>
03029 <span class="comment">* Pointer to the global atom table for the current thread or NULL if unable</span>
03030 <span class="comment">* to access it.</span>
03031 <span class="comment">*</span>
03032 <span class="comment">*</span>
03033 <span class="comment">\**************************************************************************/</span>
03034 
<a name="l03035"></a><a class="code" href="../../d9/d6/kernel_2server_8c.html#a87">03035</a> PVOID <a class="code" href="../../d9/d6/kernel_2server_8c.html#a87">UserGlobalAtomTableCallout</a>(VOID)
03036 {
03037     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>       Thread;
03038     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>    pti;
03039     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
03040     <a class="code" href="../../d1/d9/structtagW32JOB.html">PW32JOB</a>        pW32Job;
03041     <a class="code" href="../../d0/d3/struct__EJOB.html">PEJOB</a>          Job;
03042     PVOID          GlobalAtomTable = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03043 
03044     Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
03045 
03046     pti = <a class="code" href="../../d4/d1/userk_8h.html#a17">PtiFromThread</a>(Thread);
03047 
03048     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
03049 
03050     <span class="comment">/*</span>
03051 <span class="comment">     * For restricted threads access the atom table off of the job object</span>
03052 <span class="comment">     */</span>
03053     <span class="keywordflow">if</span> (pti != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a382">IS_THREAD_RESTRICTED</a>(pti, JOB_OBJECT_UILIMIT_GLOBALATOMS)) {
03054 
03055         UserAssert(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03056 
03057         pW32Job = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o25">pW32Job</a>;
03058 
03059         UserAssert(pW32Job != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o2">pAtomTable</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03060 
03061         GlobalAtomTable = pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o2">pAtomTable</a>;
03062 
03063         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
03064     }
03065 
03066     Job = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Job;
03067 
03068     <span class="comment">/*</span>
03069 <span class="comment">     * Now handle the case where this si not a GUI thread/process</span>
03070 <span class="comment">     * but it is assigned to a job that has JOB_OBJECT_UILIMIT_GLOBALATOMS</span>
03071 <span class="comment">     * restrictions set. There is no easy way to convert this thread</span>
03072 <span class="comment">     * to GUI.</span>
03073 <span class="comment">     */</span>
03074     <span class="keywordflow">if</span> (pti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; Job != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
03075         (Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o20">UIRestrictionsClass</a> &amp; JOB_OBJECT_UILIMIT_GLOBALATOMS)) {
03076 
03077         <span class="comment">/*</span>
03078 <span class="comment">         * find the W32JOB in the global list</span>
03079 <span class="comment">         */</span>
03080         pW32Job = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a113">gpJobsList</a>;
03081 
03082         <span class="keywordflow">while</span> (pW32Job) {
03083             <span class="keywordflow">if</span> (pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o1">Job</a> == Job) {
03084                 <span class="keywordflow">break</span>;
03085             }
03086             pW32Job = pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o0">pNext</a>;
03087         }
03088 
03089         UserAssert(pW32Job != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o2">pAtomTable</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03090 
03091         GlobalAtomTable = pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o2">pAtomTable</a>;
03092 
03093         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
03094     }
03095 
03096 <span class="preprocessor">#if DBG</span>
03097 <span class="preprocessor"></span>    pwinsta = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03098 <span class="preprocessor">#endif</span>
03099 <span class="preprocessor"></span>
03100     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d8/winsta_8c.html#a13">ReferenceWindowStation</a>(Thread,
03101                                     <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Win32WindowStation,
03102                                     WINSTA_ACCESSGLOBALATOMS,
03103                                     &amp;pwinsta,
03104                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))) {
03105         UserAssert(pwinsta != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03106 
03107         GlobalAtomTable = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o16">pGlobalAtomTable</a>;
03108     }
03109 
03110 <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>:
03111     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
03112 
03113 <span class="preprocessor">#if DBG</span>
03114 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (GlobalAtomTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03115         RIPMSG1(RIP_WARNING,
03116                 <span class="stringliteral">"_UserGetGlobalAtomTable: NULL Atom Table for pwinsta=0x%x"</span>,
03117                 pwinsta);
03118     }
03119 <span class="preprocessor">#endif</span>
03120 <span class="preprocessor"></span>
03121     <span class="keywordflow">return</span> GlobalAtomTable;
03122 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:47 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
