<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: semethod.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>semethod.c File Reference</h1><code>#include "<a class="el" href="../../d7/d5/sep_8h-source.html">sep.h</a>"</code><br>
<code>#include "sertlp.h"</code><br>

<p>
<a href="../../d1/d5/semethod_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/semethod_8c.html#a0">SepDefaultDeleteMethod</a> (IN OUT PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/semethod_8c.html#a1">SeSetSecurityAccessMask</a> (IN SECURITY_INFORMATION SecurityInformation, OUT PACCESS_MASK DesiredAccess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/semethod_8c.html#a2">SeQuerySecurityAccessMask</a> (IN SECURITY_INFORMATION SecurityInformation, OUT PACCESS_MASK DesiredAccess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/semethod_8c.html#a3">SeDefaultObjectMethod</a> (IN PVOID Object, IN <a class="el" href="../../d0/d5/se_8h.html#a19">SECURITY_OPERATION_CODE</a> OperationCode, IN PSECURITY_INFORMATION SecurityInformation, IN OUT PSECURITY_DESCRIPTOR SecurityDescriptor, IN OUT PULONG CapturedLength, IN OUT PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor, IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType, IN PGENERIC_MAPPING GenericMapping)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/semethod_8c.html#a4">SeSetSecurityDescriptorInfo</a> (IN PVOID Object OPTIONAL, IN PSECURITY_INFORMATION SecurityInformation, IN PSECURITY_DESCRIPTOR ModificationDescriptor, IN OUT PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor, IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType, IN PGENERIC_MAPPING GenericMapping)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/semethod_8c.html#a5">SeSetSecurityDescriptorInfoEx</a> (IN PVOID Object OPTIONAL, IN PSECURITY_INFORMATION SecurityInformation, IN PSECURITY_DESCRIPTOR ModificationDescriptor, IN OUT PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor, IN ULONG AutoInheritFlags, IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType, IN PGENERIC_MAPPING GenericMapping)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/semethod_8c.html#a6">SeQuerySecurityDescriptorInfo</a> (IN PSECURITY_INFORMATION SecurityInformation, OUT PSECURITY_DESCRIPTOR SecurityDescriptor, IN OUT PULONG Length, IN PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="semethod.c::SeDefaultObjectMethod" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SeDefaultObjectMethod           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/se_8h.html#a19">SECURITY_OPERATION_CODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OperationCode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSECURITY_DESCRIPTOR *&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectsSecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/semethod_8c-source.html#l00195">195</a> of file <a class="el" href="../../d1/d5/semethod_8c-source.html">semethod.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d5/se_8h.html#a200a111">AssignSecurityDescriptor</a>, <a class="el" href="../../d0/d5/se_8h.html#a200a110">DeleteSecurityDescriptor</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00070">KeBugCheck()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01183">ObAssignObjectSecurityDescriptor()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01679">ObQuerySecurityDescriptorInfo()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01748">ObSetSecurityDescriptorInfo()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d5/se_8h.html#a200a109">QuerySecurityDescriptor</a>, <a class="el" href="../../d1/d5/semethod_8c-source.html#l00920">SepDefaultDeleteMethod()</a>, and <a class="el" href="../../d0/d5/se_8h.html#a200a108">SetSecurityDescriptor</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00069">ObCreateObjectType()</a>, and <a class="el" href="../../d2/d5/tse_8c-source.html#l00205">TestDefaultObjectMethod()</a>.
<p>
<pre class="fragment"><div>00208                    :
00209 
00210     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">default</span> security method <span class="keywordflow">for</span> objects.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> responsible
00211     <span class="keywordflow">for</span> either retrieving, setting, and deleting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor of
00212     an object.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not used to assign <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original security descriptor
00213     to an object (use SeAssignSecurity <span class="keywordflow">for</span> that purpose).
00214 
00215 
00216     IT IS ASSUMED THAT THE OBJECT MANAGER HAS ALREADY DONE THE ACCESS
00217     VALIDATIONS NECESSARY TO ALLOW THE REQUESTED OPERATIONS TO BE PERFORMED.
00218 
00219 Arguments:
00220 
00221     Object - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being used.
00222 
00223     OperationCode - Indicates <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> setting, querying, or
00224         deleting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object's security descriptor.
00225 
00226     SecurityInformation - Indicates which security information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
00227         queried or set.  This argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">delete</span> operation.
00228 
00229     SecurityDescriptor - The meaning of <span class="keyword">this</span> parameter depends on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00230         OperationCode:
00231 
00232         <a class="code" href="../../d0/d5/se_8h.html#a200a109">QuerySecurityDescriptor</a> - For <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query operation <span class="keyword">this</span> supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00233             buffer to copy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> descriptor into.  The security descriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00234             assumed to have been probed up to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size passed in in Length.
00235             Since <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> still points into user space, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must always be
00236             accessed in a <span class="keywordflow">try</span> clause in <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> should suddenly disappear.
00237 
00238         <a class="code" href="../../d0/d5/se_8h.html#a200a108">SetSecurityDescriptor</a> - For a set operation <span class="keyword">this</span> supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00239             security descriptor to copy into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.  The security
00240             descriptor must be captured before <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called.
00241 
00242         <a class="code" href="../../d0/d5/se_8h.html#a200a110">DeleteSecurityDescriptor</a> - It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored when deleting a security
00243             descriptor.
00244 
00245         <a class="code" href="../../d0/d5/se_8h.html#a200a111">AssignSecurityDescriptor</a> - For assign operations <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00246             security descriptor that will be assigned to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
00247             It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to be in kernel space, and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> therefore not
00248             probed or captured.
00249 
00250     CapturedLength - For <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query operation <span class="keyword">this</span> specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in
00251         bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor buffer, and upon <span class="keywordflow">return</span> contains
00252         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes needed to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> descriptor.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length
00253         needed <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> greater than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length supplied <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation will fail.
00254         It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> set and <span class="keyword">delete</span> operation.
00255 
00256         This parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to be captured and probed as appropriate.
00257 
00258     ObjectsSecurityDescriptor - For <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Set operation <span class="keyword">this</span> supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address
00259         of a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object's current security descriptor.  This routine
00260         will either modify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor in place or allocate a <span class="keyword">new</span>
00261         security descriptor and use <span class="keyword">this</span> variable to indicate its <span class="keyword">new</span> location.
00262         For <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query operation <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> simply supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor
00263         being queried.  The caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> responsible <span class="keywordflow">for</span> freeing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> old security
00264         descriptor.
00265 
00266     PoolType - For <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> set operation <span class="keyword">this</span> specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> to use <span class="keywordflow">if</span>
00267         a <span class="keyword">new</span> security descriptor needs to be allocated.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored
00268         in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query and <span class="keyword">delete</span> operation.
00269 
00270         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping of generic to specific/standard access types <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
00271         being accessed.  This mapping structure <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected to be safe to
00272         access (i.e., captured <span class="keywordflow">if</span> necessary) prior to be passed to <span class="keyword">this</span> routine.
00273 
00274 Return Value:
00275 
00276     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - STATUS_SUCCESS <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successful and an
00277         appropriate error status otherwise.
00278 
00279 --*/
00280 
00281 {
00282     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00283 
00284     <span class="comment">//</span>
00285     <span class="comment">// If the object's security descriptor is null, then object is not</span>
00286     <span class="comment">// one that has security information associated with it.  Return</span>
00287     <span class="comment">// an error.</span>
00288     <span class="comment">//</span>
00289 
00290     <span class="comment">//</span>
00291     <span class="comment">//  Make sure the common parts of our input are proper</span>
00292     <span class="comment">//</span>
00293 
00294     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (OperationCode == SetSecurityDescriptor) ||
00295             (OperationCode == QuerySecurityDescriptor) ||
00296             (OperationCode == AssignSecurityDescriptor) ||
00297             (OperationCode == DeleteSecurityDescriptor) );
00298 
00299     <span class="comment">//</span>
00300     <span class="comment">//  This routine simply cases off of the operation code to decide</span>
00301     <span class="comment">//  which support routine to call</span>
00302     <span class="comment">//</span>
00303 
00304     <span class="keywordflow">switch</span> (OperationCode) {
00305 
00306         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/se_8h.html#a200a108">SetSecurityDescriptor</a>:
00307 
00308         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (PoolType == PagedPool) || (PoolType == NonPagedPool) );
00309 
00310         <span class="keywordflow">return</span> <a class="code" href="../../d9/d1/obse_8c.html#a13">ObSetSecurityDescriptorInfo</a>( Object,
00311                                             SecurityInformation,
00312                                             SecurityDescriptor,
00313                                             ObjectsSecurityDescriptor,
00314                                             PoolType,
00315                                             GenericMapping
00316                                             );
00317 
00318 
00319 
00320     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/se_8h.html#a200a109">QuerySecurityDescriptor</a>:
00321 
00322         <span class="comment">//</span>
00323         <span class="comment">//  check the rest of our input and call the default query security</span>
00324         <span class="comment">//  method</span>
00325         <span class="comment">//</span>
00326 
00327         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( CapturedLength != NULL );
00328 
00329         <span class="keywordflow">return</span> <a class="code" href="../../d9/d1/obse_8c.html#a12">ObQuerySecurityDescriptorInfo</a>( SecurityInformation,
00330                                               SecurityDescriptor,
00331                                               CapturedLength,
00332                                               ObjectsSecurityDescriptor );
00333 
00334     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/se_8h.html#a200a110">DeleteSecurityDescriptor</a>:
00335 
00336         <span class="comment">//</span>
00337         <span class="comment">//  call the default delete security method</span>
00338         <span class="comment">//</span>
00339 
00340         <span class="keywordflow">return</span> <a class="code" href="../../d0/d6/semethod_8c.html#a0">SepDefaultDeleteMethod</a>( ObjectsSecurityDescriptor );
00341 
00342     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/se_8h.html#a200a111">AssignSecurityDescriptor</a>:
00343 
00344         <a class="code" href="../../d9/d1/obse_8c.html#a7">ObAssignObjectSecurityDescriptor</a>( Object, SecurityDescriptor, PoolType );
00345         <span class="keywordflow">return</span>( STATUS_SUCCESS );
00346 
00347     <span class="keywordflow">default</span>:
00348 
00349         <span class="comment">//</span>
00350         <span class="comment">//  Bugcheck on any other operation code,  We won't get here if</span>
00351         <span class="comment">//  the earlier asserts are still checked.</span>
00352         <span class="comment">//</span>
00353 
00354         <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>( SECURITY_SYSTEM );
00355         <span class="keywordflow">return</span>( STATUS_INVALID_PARAMETER );
00356 
00357     }
00358 
00359 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="semethod.c::SepDefaultDeleteMethod" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SepDefaultDeleteMethod           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PSECURITY_DESCRIPTOR *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ObjectsSecurityDescriptor</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/semethod_8c-source.html#l00920">920</a> of file <a class="el" href="../../d1/d5/semethod_8c-source.html">semethod.c</a>.
<p>
References <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00637">ObDeassignSecurity()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d1/d5/semethod_8c-source.html#l00195">SeDefaultObjectMethod()</a>.
<p>
<pre class="fragment"><div>00926                    :
00927 
00928     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a <span class="keyword">private</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> to <span class="keyword">delete</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor <span class="keywordflow">for</span>
00929     an object.  It cleans up any <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> allocations that have occured
00930     as part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> descriptor.
00931 
00932 Arguments:
00933 
00934     ObjectsSecurityDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a pointer
00935         to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor being deleted.
00936 
00937 Return Value:
00938 
00939     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - STATUS_SUCCESS
00940 
00941 --*/
00942 
00943 {
00944     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00945 
00946     <span class="keywordflow">return</span> (<a class="code" href="../../d8/d1/obsdata_8c.html#a19">ObDeassignSecurity</a> ( ObjectsSecurityDescriptor ));
00947 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="semethod.c::SeQuerySecurityAccessMask" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SeQuerySecurityAccessMask           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SECURITY_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/semethod_8c-source.html#l00138">138</a> of file <a class="el" href="../../d1/d5/semethod_8c-source.html">semethod.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02547">IoCheckFunctionAccess()</a>, and <a class="el" href="../../d0/d1/obse_8c-source.html#l00255">NtQuerySecurityObject()</a>.
<p>
<pre class="fragment"><div>00145                    :
00146 
00147     This routine builds an access mask representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> accesses necessary
00148     to query <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object security information specified in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00149     SecurityInformation parameter.  While <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not difficult to determine
00150     <span class="keyword">this</span> information, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> use of a single routine to generate <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will ensure
00151     minimal impact when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security information associated with an object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00152     extended in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> future (to include mandatory access control information).
00153 
00154 Arguments:
00155 
00156     SecurityInformation - Identifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object's security information to be
00157         queried.
00158 
00159     DesiredAccess - Points to an access mask to be set to represent <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00160         accesses necessary to query <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information specified in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00161         SecurityInformation parameter.
00162 
00163 Return Value:
00164 
00165     None.
00166 
00167 --*/
00168 
00169 {
00170     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00171 
00172     <span class="comment">//</span>
00173     <span class="comment">// Figure out accesses needed to perform the indicated operation(s).</span>
00174     <span class="comment">//</span>
00175 
00176     (*DesiredAccess) = 0;
00177 
00178     <span class="keywordflow">if</span> ((SecurityInformation &amp; OWNER_SECURITY_INFORMATION) ||
00179         (SecurityInformation &amp; GROUP_SECURITY_INFORMATION) ||
00180         (SecurityInformation &amp; DACL_SECURITY_INFORMATION)) {
00181         (*DesiredAccess) |= READ_CONTROL;
00182     }
00183 
00184     <span class="keywordflow">if</span> ((SecurityInformation &amp; SACL_SECURITY_INFORMATION)) {
00185         (*DesiredAccess) |= ACCESS_SYSTEM_SECURITY;
00186     }
00187 
00188     <span class="keywordflow">return</span>;
00189 
00190 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="semethod.c::SeQuerySecurityDescriptorInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SeQuerySecurityDescriptorInfo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR *&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectsSecurityDescriptor</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/semethod_8c-source.html#l00559">559</a> of file <a class="el" href="../../d1/d5/semethod_8c-source.html">semethod.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00167">LongAlignPtr</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02004">RtlCreateSecurityDescriptorRelative()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, and <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/cmse_8c-source.html#l00847">CmpQuerySecurityDescriptorInfo()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00975">IopGetSetSecurityObject()</a>, and <a class="el" href="../../d0/d1/obse_8c-source.html#l01679">ObQuerySecurityDescriptorInfo()</a>.
<p>
<pre class="fragment"><div>00568                    :
00569 
00570     This routine will extract <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired information from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00571     passed security descriptor and <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information in
00572     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed buffer as a security descriptor in <span class="keyword">self</span>-relative
00573     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>.
00574 
00575 Arguments:
00576 
00577     SecurityInformation - Specifies what information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being queried.
00578 
00579     SecurityDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer to output <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
00580         information into.
00581 
00582         This buffer has been probed <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size indicated by
00583         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Length parameter.  Since <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> still points into user space,
00584         <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must always be accessed in a <span class="keywordflow">try</span> clause.
00585 
00586     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a variable containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of
00587         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor buffer.  Upon <span class="keywordflow">return</span> <span class="keyword">this</span> variable will
00588         contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length needed to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested information.
00589 
00590     ObjectsSecurityDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a pointer to
00591         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> objects security descriptor.  The passed security descriptor
00592         must be in <span class="keyword">self</span>-relative <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>.
00593 
00594 Return Value:
00595 
00596     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - STATUS_SUCCESS <span class="keywordflow">if</span> successful and an appropriate error value
00597         otherwise
00598 
00599 --*/
00600 
00601 {
00602     ULONG BufferLength;
00603 
00604     ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00605     ULONG OwnerLength;
00606     ULONG GroupLength;
00607     ULONG DaclLength;
00608     ULONG SaclLength;
00609     PUCHAR NextFree;
00610     SECURITY_DESCRIPTOR IObjectSecurity;
00611 
00612     <span class="comment">//</span>
00613     <span class="comment">// Note that IObjectSecurity is not a pointer to a pointer</span>
00614     <span class="comment">// like ObjectsSecurityDescriptor is.</span>
00615     <span class="comment">//</span>
00616 
00617     SECURITY_DESCRIPTOR_RELATIVE *ISecurityDescriptor = SecurityDescriptor;
00618 
00619     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00620 
00621     <span class="comment">//</span>
00622     <span class="comment">//  We will be accessing user memory throughout this routine,</span>
00623     <span class="comment">//  therefore do everything in a try-except clause.</span>
00624     <span class="comment">//</span>
00625 
00626     <span class="keywordflow">try</span> {
00627 
00628         BufferLength = *Length;
00629 
00630         <span class="comment">//</span>
00631         <span class="comment">//  Check if the object's descriptor is null, and if it is then</span>
00632         <span class="comment">//  we only need to return a blank security descriptor record</span>
00633         <span class="comment">//</span>
00634 
00635         <span class="keywordflow">if</span> (*ObjectsSecurityDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00636 
00637             *Length = <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR_RELATIVE);
00638 
00639             <span class="comment">//</span>
00640             <span class="comment">//  Now make sure it's large enough for the security descriptor</span>
00641             <span class="comment">//  record</span>
00642             <span class="comment">//</span>
00643 
00644             <span class="keywordflow">if</span> (BufferLength &lt; <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR_RELATIVE)) {
00645 
00646                 <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00647 
00648             }
00649 
00650             <span class="comment">//</span>
00651             <span class="comment">//  It's large enough to make a blank security descriptor record</span>
00652             <span class="comment">//</span>
00653             <span class="comment">//  Note that this parameter has been probed for write by the</span>
00654             <span class="comment">//  object manager, however, we still have to be careful when</span>
00655             <span class="comment">//  writing to it.</span>
00656             <span class="comment">//</span>
00657 
00658             <span class="comment">//</span>
00659             <span class="comment">// We do not have to probe this here, because the object</span>
00660             <span class="comment">// manager has probed it for length=BufferLength, which we</span>
00661             <span class="comment">// know at this point is at least as large as a security</span>
00662             <span class="comment">// descriptor.</span>
00663             <span class="comment">//</span>
00664 
00665             <a class="code" href="../../d8/d6/sertl_8c.html#a54">RtlCreateSecurityDescriptorRelative</a>( SecurityDescriptor,
00666                                                  SECURITY_DESCRIPTOR_REVISION );
00667 
00668             <span class="comment">//</span>
00669             <span class="comment">// Mark it as self-relative</span>
00670             <span class="comment">//</span>
00671 
00672             RtlpSetControlBits( ISecurityDescriptor, SE_SELF_RELATIVE );
00673 
00674             <span class="comment">//</span>
00675             <span class="comment">//  And return to our caller</span>
00676             <span class="comment">//</span>
00677 
00678             <span class="keywordflow">return</span> STATUS_SUCCESS;
00679 
00680         }
00681 
00682         <span class="comment">//</span>
00683         <span class="comment">// Create an absolute format SD on the stack pointing into</span>
00684         <span class="comment">// user space to simplify the following code</span>
00685         <span class="comment">//</span>
00686 
00687         RtlCopyMemory( (&amp;IObjectSecurity),
00688                       *ObjectsSecurityDescriptor,
00689                       <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR_RELATIVE) );
00690 
00691         IObjectSecurity.Owner = RtlpOwnerAddrSecurityDescriptor(
00692                     (SECURITY_DESCRIPTOR *) *ObjectsSecurityDescriptor );
00693         IObjectSecurity.Group = RtlpGroupAddrSecurityDescriptor(
00694                     (SECURITY_DESCRIPTOR *) *ObjectsSecurityDescriptor );
00695         IObjectSecurity.Dacl = RtlpDaclAddrSecurityDescriptor(
00696                     (SECURITY_DESCRIPTOR *) *ObjectsSecurityDescriptor );
00697         IObjectSecurity.Sacl = RtlpSaclAddrSecurityDescriptor(
00698                     (SECURITY_DESCRIPTOR *) *ObjectsSecurityDescriptor );
00699 
00700         IObjectSecurity.Control &amp;= ~SE_SELF_RELATIVE;
00701 
00702         <span class="comment">//</span>
00703         <span class="comment">//  This is not a blank descriptor so we need to determine the size</span>
00704         <span class="comment">//  needed to store the requested information.  It is the size of the</span>
00705         <span class="comment">//  descriptor record plus the size of each requested component.</span>
00706         <span class="comment">//</span>
00707 
00708         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR_RELATIVE);
00709 
00710         <span class="keywordflow">if</span> ( (((*SecurityInformation) &amp; OWNER_SECURITY_INFORMATION)) &amp;&amp;
00711              (IObjectSecurity.Owner != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
00712 
00713             OwnerLength = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( IObjectSecurity.Owner );
00714             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> += (ULONG)LongAlignSize(OwnerLength);
00715 
00716         }
00717 
00718         <span class="keywordflow">if</span> ( (((*SecurityInformation) &amp; GROUP_SECURITY_INFORMATION)) &amp;&amp;
00719              (IObjectSecurity.Group != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
00720 
00721             GroupLength = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( IObjectSecurity.Group );
00722             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> += (ULONG)LongAlignSize(GroupLength);
00723 
00724         }
00725 
00726         <span class="keywordflow">if</span> ( (((*SecurityInformation) &amp; DACL_SECURITY_INFORMATION)) &amp;&amp;
00727              (IObjectSecurity.Control &amp; SE_DACL_PRESENT) &amp;&amp;
00728              (IObjectSecurity.Dacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
00729 
00730 
00731             DaclLength = (ULONG)LongAlignSize((IObjectSecurity.Dacl)-&gt;AclSize);
00732             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> += DaclLength;
00733 
00734         }
00735 
00736         <span class="keywordflow">if</span> ( (((*SecurityInformation) &amp; SACL_SECURITY_INFORMATION)) &amp;&amp;
00737              (IObjectSecurity.Control &amp; SE_SACL_PRESENT) &amp;&amp;
00738              (IObjectSecurity.Sacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
00739 
00740             SaclLength = (ULONG)LongAlignSize((IObjectSecurity.Sacl)-&gt;AclSize);
00741             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> += SaclLength;
00742 
00743         }
00744 
00745         <span class="comment">//</span>
00746         <span class="comment">//  Tell the caller how much space this will require</span>
00747         <span class="comment">//  (whether we actually fit or not)</span>
00748         <span class="comment">//</span>
00749 
00750         *Length = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00751 
00752         <span class="comment">//</span>
00753         <span class="comment">//  Now make sure the size is less than or equal to the length</span>
00754         <span class="comment">//  we were passed</span>
00755         <span class="comment">//</span>
00756 
00757         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &gt; BufferLength) {
00758 
00759             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00760 
00761         }
00762 
00763         <span class="comment">//</span>
00764         <span class="comment">//  The length is fine.</span>
00765         <span class="comment">//</span>
00766         <span class="comment">//  Fill in the length and flags part of the security descriptor.</span>
00767         <span class="comment">//  The real addresses of each acl will be filled in later when we</span>
00768         <span class="comment">//  copy the ACLs over.</span>
00769         <span class="comment">//</span>
00770         <span class="comment">//  Note that we only set a flag in the descriptor if the information</span>
00771         <span class="comment">//  was requested, which is a simple copy of the requested information</span>
00772         <span class="comment">//  input variable</span>
00773         <span class="comment">//</span>
00774         <span class="comment">//  The output buffer has already been probed to the passed size,</span>
00775         <span class="comment">//  so we can just write to it.</span>
00776         <span class="comment">//</span>
00777 
00778         <a class="code" href="../../d8/d6/sertl_8c.html#a54">RtlCreateSecurityDescriptorRelative</a>( SecurityDescriptor,
00779                                              SECURITY_DESCRIPTOR_REVISION );
00780 
00781         <span class="comment">//</span>
00782         <span class="comment">// Mark the returned Security Descriptor as being in</span>
00783         <span class="comment">// self-relative format</span>
00784         <span class="comment">//</span>
00785 
00786         RtlpSetControlBits( ISecurityDescriptor, SE_SELF_RELATIVE );
00787 
00788         <span class="comment">//</span>
00789         <span class="comment">//  NextFree is used to point to the next free spot in the</span>
00790         <span class="comment">//  returned security descriptor.</span>
00791         <span class="comment">//</span>
00792 
00793         NextFree = <a class="code" href="../../d3/d8/udfprocs_8h.html#a27">LongAlignPtr</a>((PUCHAR)SecurityDescriptor +
00794                                         <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR_RELATIVE));
00795 
00796         <span class="comment">//</span>
00797         <span class="comment">//  Copy the Owner SID if necessary and update the NextFree pointer,</span>
00798         <span class="comment">//  keeping it longword aligned.</span>
00799         <span class="comment">//</span>
00800 
00801         <span class="keywordflow">if</span> ( ((*SecurityInformation) &amp; OWNER_SECURITY_INFORMATION) &amp;&amp;
00802              ((IObjectSecurity.Owner) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
00803 
00804                 RtlMoveMemory( NextFree,
00805                                IObjectSecurity.Owner,
00806                                OwnerLength );
00807 
00808                 ISecurityDescriptor-&gt;Owner = (ULONG)((PUCHAR)NextFree - (PUCHAR)SecurityDescriptor);
00809 
00810                 RtlpPropagateControlBits(
00811                     ISecurityDescriptor,
00812                     &amp;IObjectSecurity,
00813                     SE_OWNER_DEFAULTED
00814                     );
00815 
00816                 NextFree += (ULONG)LongAlignSize(OwnerLength);
00817 
00818         }
00819 
00820 
00821         <span class="comment">//</span>
00822         <span class="comment">//  Copy the Group SID if necessary and update the NextFree pointer,</span>
00823         <span class="comment">//  keeping it longword aligned.</span>
00824         <span class="comment">//</span>
00825 
00826         <span class="keywordflow">if</span> ( ((*SecurityInformation) &amp; GROUP_SECURITY_INFORMATION) &amp;&amp;
00827              (IObjectSecurity.Group != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
00828 
00829                 RtlMoveMemory( NextFree,
00830                                IObjectSecurity.Group,
00831                                GroupLength );
00832 
00833                 ISecurityDescriptor-&gt;Group = (ULONG)((PUCHAR)NextFree - (PUCHAR)SecurityDescriptor);
00834 
00835                 RtlpPropagateControlBits(
00836                     ISecurityDescriptor,
00837                     &amp;IObjectSecurity,
00838                     SE_GROUP_DEFAULTED
00839                     );
00840 
00841                 NextFree += (ULONG)LongAlignSize(GroupLength);
00842 
00843         }
00844 
00845 
00846         <span class="comment">//</span>
00847         <span class="comment">//  Set discretionary acl information if requested.</span>
00848         <span class="comment">//  If not set in object's security,</span>
00849         <span class="comment">//  then everything is already set properly.</span>
00850         <span class="comment">//</span>
00851 
00852         <span class="keywordflow">if</span> ( (*SecurityInformation) &amp; DACL_SECURITY_INFORMATION) {
00853 
00854             RtlpPropagateControlBits(
00855                 ISecurityDescriptor,
00856                 &amp;IObjectSecurity,
00857                 SE_DACL_PRESENT | SE_DACL_DEFAULTED | SE_DACL_PROTECTED | SE_DACL_AUTO_INHERITED
00858                 );
00859 
00860             <span class="comment">//</span>
00861             <span class="comment">// Copy the acl if non-null  and update the NextFree pointer,</span>
00862             <span class="comment">// keeping it longword aligned.</span>
00863             <span class="comment">//</span>
00864 
00865             <span class="keywordflow">if</span> ( (IObjectSecurity.Control &amp; SE_DACL_PRESENT) != 0 &amp;&amp;
00866                  IObjectSecurity.Dacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00867 
00868                 RtlMoveMemory( NextFree,
00869                                IObjectSecurity.Dacl,
00870                                (IObjectSecurity.Dacl)-&gt;AclSize );
00871 
00872                 ISecurityDescriptor-&gt;Dacl = (ULONG)((PUCHAR)NextFree - (PUCHAR)SecurityDescriptor);
00873 
00874                 NextFree += DaclLength;
00875 
00876             }
00877         }
00878 
00879 
00880         <span class="comment">//</span>
00881         <span class="comment">//  Set system acl information if requested.</span>
00882         <span class="comment">//  If not set in object's security,</span>
00883         <span class="comment">//  then everything is already set properly.</span>
00884         <span class="comment">//</span>
00885 
00886         <span class="keywordflow">if</span> ( (*SecurityInformation) &amp; SACL_SECURITY_INFORMATION) {
00887 
00888             RtlpPropagateControlBits(
00889                 ISecurityDescriptor,
00890                 &amp;IObjectSecurity,
00891                 SE_SACL_PRESENT | SE_SACL_DEFAULTED | SE_SACL_PROTECTED | SE_SACL_AUTO_INHERITED
00892                 );
00893 
00894             <span class="comment">//</span>
00895             <span class="comment">// Copy the acl if non-null  and update the NextFree pointer,</span>
00896             <span class="comment">// keeping it longword aligned.</span>
00897             <span class="comment">//</span>
00898             <span class="keywordflow">if</span> ( (IObjectSecurity.Control &amp; SE_SACL_PRESENT) != 0 &amp;&amp;
00899                  IObjectSecurity.Sacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00900 
00901                 RtlMoveMemory( NextFree,
00902                                IObjectSecurity.Sacl,
00903                                (IObjectSecurity.Sacl)-&gt;AclSize );
00904 
00905                 ISecurityDescriptor-&gt;Sacl = (ULONG)((PUCHAR)NextFree - (PUCHAR)SecurityDescriptor);
00906 
00907             }
00908         }
00909 
00910     } except(EXCEPTION_EXECUTE_HANDLER) {
00911         <span class="keywordflow">return</span>(GetExceptionCode());
00912     }
00913 
00914     <span class="keywordflow">return</span> STATUS_SUCCESS;
00915 
00916 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="semethod.c::SeSetSecurityAccessMask" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SeSetSecurityAccessMask           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SECURITY_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/semethod_8c-source.html#l00078">78</a> of file <a class="el" href="../../d1/d5/semethod_8c-source.html">semethod.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02547">IoCheckFunctionAccess()</a>, and <a class="el" href="../../d0/d1/obse_8c-source.html#l00046">NtSetSecurityObject()</a>.
<p>
<pre class="fragment"><div>00085                    :
00086 
00087     This routine builds an access mask representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> accesses necessary
00088     to set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object security information specified in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SecurityInformation
00089     parameter.  While <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not difficult to determine <span class="keyword">this</span> information,
00090     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> use of a single routine to generate <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will ensure minimal impact
00091     when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security information associated with an object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> extended in
00092     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> future (to include mandatory access control information).
00093 
00094 Arguments:
00095 
00096     SecurityInformation - Identifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object's security information to be
00097         modified.
00098 
00099     DesiredAccess - Points to an access mask to be set to represent <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00100         accesses necessary to modify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information specified in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00101         SecurityInformation parameter.
00102 
00103 Return Value:
00104 
00105     None.
00106 
00107 --*/
00108 
00109 {
00110 
00111     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00112 
00113     <span class="comment">//</span>
00114     <span class="comment">// Figure out accesses needed to perform the indicated operation(s).</span>
00115     <span class="comment">//</span>
00116 
00117     (*DesiredAccess) = 0;
00118 
00119     <span class="keywordflow">if</span> ((SecurityInformation &amp; OWNER_SECURITY_INFORMATION) ||
00120         (SecurityInformation &amp; GROUP_SECURITY_INFORMATION)   ) {
00121         (*DesiredAccess) |= WRITE_OWNER;
00122     }
00123 
00124     <span class="keywordflow">if</span> (SecurityInformation &amp; DACL_SECURITY_INFORMATION) {
00125         (*DesiredAccess) |= WRITE_DAC;
00126     }
00127 
00128     <span class="keywordflow">if</span> (SecurityInformation &amp; SACL_SECURITY_INFORMATION) {
00129         (*DesiredAccess) |= ACCESS_SYSTEM_SECURITY;
00130     }
00131 
00132     <span class="keywordflow">return</span>;
00133 
00134 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="semethod.c::SeSetSecurityDescriptorInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SeSetSecurityDescriptorInfo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID Object&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>ModificationDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSECURITY_DESCRIPTOR *&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectsSecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/semethod_8c-source.html#l00365">365</a> of file <a class="el" href="../../d1/d5/semethod_8c-source.html">semethod.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d9/d5/sertl_8c-source.html#l10195">RtlpSetSecurityObject()</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/cmse_8c-source.html#l00397">CmpSetSecurityDescriptorInfo()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00877">IopSetDeviceSecurityDescriptors()</a>, and <a class="el" href="../../d0/d1/obse_8c-source.html#l01748">ObSetSecurityDescriptorInfo()</a>.
<p>
<pre class="fragment"><div>00376                    :
00377 
00378     This routine will set an object's security descriptor.  The input
00379     security descriptor must be previously captured.
00380 
00381 Arguments:
00382 
00383     Object - Optionally supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object whose security <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00384         being adjusted.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to update security quota
00385         information.
00386 
00387     SecurityInformation - Indicates which security information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00388         to be applied to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.  The value(s) to be assigned are
00389         passed in the SecurityDescriptor parameter.
00390 
00391     ModificationDescriptor - Supplies the input security descriptor to be
00392         applied to the object.  The caller of this routine is expected
00393         to probe and capture the passed security descriptor before calling
00394         and release it after calling.
00395 
00396     ObjectsSecurityDescriptor - Supplies the address of a pointer to
00397         the objects security descriptor that is going to be altered by
00398         this procedure.  This structure must be deallocated by the caller.
00399 
00400     PoolType - Specifies the type of pool to allocate for the objects
00401         security descriptor.
00402 
00403     GenericMapping - This argument provides the mapping of generic to
00404         specific/standard access types for the object being accessed.
00405         This mapping structure is expected to be safe to access
00406         (i.e., captured if necessary) prior to be passed to this routine.
00407 
00408 Return Value:
00409 
00410     NTSTATUS - STATUS_SUCCESS if successful and an appropriate error
00411         value otherwise.
00412 
00413 --*/
00414 
00415 {
00416 
00417 
00418 
00419     <span class="comment">//</span>
00420     <span class="comment">// Make sure the object already has a security descriptor.</span>
00421     <span class="comment">// Objects that 'may' have security descriptors 'must' have security</span>
00422     <span class="comment">// descriptors.  If this one doesn't already have one, then we can't</span>
00423     <span class="comment">// assign one to it.</span>
00424     <span class="comment">//</span>
00425 
00426     <span class="keywordflow">if</span> ((*ObjectsSecurityDescriptor) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00427         <span class="keywordflow">return</span>(STATUS_NO_SECURITY_ON_OBJECT);
00428     }
00429 
00430 
00431     <span class="comment">//</span>
00432     <span class="comment">// Pass this call to the common Rtlp routine.</span>
00433     <span class="comment">//</span>
00434 
00435     <span class="keywordflow">return</span> <a class="code" href="../../d8/d6/sertl_8c.html#a77">RtlpSetSecurityObject</a> (
00436                     Object,
00437                     *SecurityInformation,
00438                     ModificationDescriptor,
00439                     ObjectsSecurityDescriptor,
00440                     0,  <span class="comment">// No Auto Inheritance</span>
00441                     PoolType,
00442                     GenericMapping,
00443                     NULL ); <span class="comment">// No Token</span>
00444 
00445 
00446 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="semethod.c::SeSetSecurityDescriptorInfoEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SeSetSecurityDescriptorInfoEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID Object&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>ModificationDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSECURITY_DESCRIPTOR *&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectsSecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AutoInheritFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/semethod_8c-source.html#l00452">452</a> of file <a class="el" href="../../d1/d5/semethod_8c-source.html">semethod.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d9/d5/sertl_8c-source.html#l10195">RtlpSetSecurityObject()</a>.
<p>
<pre class="fragment"><div>00464                    :
00465 
00466     This routine will set an object's security descriptor.  The input
00467     security descriptor must be previously captured.
00468 
00469 Arguments:
00470 
00471     Object - Optionally supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object whose security <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00472         being adjusted.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to update security quota
00473         information.
00474 
00475     SecurityInformation - Indicates which security information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00476         to be applied to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.  The value(s) to be assigned are
00477         passed in the SecurityDescriptor parameter.
00478 
00479     ModificationDescriptor - Supplies the input security descriptor to be
00480         applied to the object.  The caller of this routine is expected
00481         to probe and capture the passed security descriptor before calling
00482         and release it after calling.
00483 
00484     ObjectsSecurityDescriptor - Supplies the address of a pointer to
00485         the objects security descriptor that is going to be altered by
00486         this procedure.  This structure must be deallocated by the caller.
00487 
00488     AutoInheritFlags - Controls automatic inheritance of ACES.
00489         Valid values are a bits mask of the logical OR of
00490         one or more of the following bits:
00491 
00492         SEF_DACL_AUTO_INHERIT - If set, inherited ACEs from the
00493             DACL in the ObjectsSecurityDescriptor are preserved and inherited ACEs from
00494             the ModificationDescriptor are ignored. Inherited ACEs are not supposed
00495             to be modified; so preserving them across this call is appropriate.
00496             If a protected server does not itself implement auto inheritance, it should
00497             not set this bit.  The caller of the protected server may implement
00498             auto inheritance and my indeed be modifying inherited ACEs.
00499 
00500         SEF_SACL_AUTO_INHERIT - If set, inherited ACEs from the
00501             SACL in the ObjectsSecurityDescriptor are preserved and inherited ACEs from
00502             the ModificationDescriptor are ignored. Inherited ACEs are not supposed
00503             to be modified; so preserving them across this call is appropriate.
00504             If a protected server does not itself implement auto inheritance, it should
00505             not set this bit.  The caller of the protected server may implement
00506             auto inheritance and my indeed be modifying inherited ACEs.
00507 
00508     PoolType - Specifies the type of pool to allocate for the objects
00509         security descriptor.
00510 
00511     GenericMapping - This argument provides the mapping of generic to
00512         specific/standard access types for the object being accessed.
00513         This mapping structure is expected to be safe to access
00514         (i.e., captured if necessary) prior to be passed to this routine.
00515 
00516 Return Value:
00517 
00518     NTSTATUS - STATUS_SUCCESS if successful and an appropriate error
00519         value otherwise.
00520 
00521 --*/
00522 
00523 {
00524 
00525 
00526 
00527     <span class="comment">//</span>
00528     <span class="comment">// Make sure the object already has a security descriptor.</span>
00529     <span class="comment">// Objects that 'may' have security descriptors 'must' have security</span>
00530     <span class="comment">// descriptors.  If this one doesn't already have one, then we can't</span>
00531     <span class="comment">// assign one to it.</span>
00532     <span class="comment">//</span>
00533 
00534     <span class="keywordflow">if</span> ((*ObjectsSecurityDescriptor) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00535         <span class="keywordflow">return</span>(STATUS_NO_SECURITY_ON_OBJECT);
00536     }
00537 
00538 
00539     <span class="comment">//</span>
00540     <span class="comment">// Pass this call to the common Rtlp routine.</span>
00541     <span class="comment">//</span>
00542 
00543     <span class="keywordflow">return</span> <a class="code" href="../../d8/d6/sertl_8c.html#a77">RtlpSetSecurityObject</a> (
00544                     Object,
00545                     *SecurityInformation,
00546                     ModificationDescriptor,
00547                     ObjectsSecurityDescriptor,
00548                     AutoInheritFlags,
00549                     PoolType,
00550                     GenericMapping,
00551                     NULL ); <span class="comment">// No Token</span>
00552 
00553 
00554 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:35 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
