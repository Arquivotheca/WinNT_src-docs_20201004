<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: lpcmove.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>lpcmove.c</h1><a href="../../d9/d6/lpcmove_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00010 <span class="comment">/*++</span>
00011 <span class="comment"></span>
00012 <span class="comment">Copyright (c) 1995 Intel Corporation</span>
00013 <span class="comment"></span>
00014 <span class="comment">Module Name:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    lpcmove.c</span>
00017 <span class="comment"></span>
00018 <span class="comment">Abstract:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    This module implements functions to support the efficient movement</span>
00021 <span class="comment">    of LPC message blocks.</span>
00022 <span class="comment"></span>
00023 <span class="comment">    There is a corresponding .s version that is hand optimized.</span>
00024 <span class="comment">    Need to evaluate and install one or the other.</span>
00025 <span class="comment"></span>
00026 <span class="comment">Author:</span>
00027 <span class="comment"></span>
00028 <span class="comment">    Roy D'Souza (rdsouza) 5-May-96</span>
00029 <span class="comment"></span>
00030 <span class="comment">Revision History:</span>
00031 <span class="comment"></span>
00032 <span class="comment">--*/</span>
00033 
00034 <span class="preprocessor">#include "<a class="code" href="../../d0/d7/lpcp_8h.html">lpcp.h</a>"</span>
00035 
00036 
00037 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00038"></a><a class="code" href="../../d9/d6/lpcmove_8c.html#a0">00038</a> <a class="code" href="../../d0/d7/lpcp_8h.html#a31">LpcpMoveMessage</a> (
00039     OUT PPORT_MESSAGE DstMsg,
00040     IN PPORT_MESSAGE SrcMsg,
00041     IN PUCHAR SrcMsgData,
00042     IN ULONG MsgType OPTIONAL,
00043     IN PCLIENT_ID ClientId OPTIONAL
00044     )
00045 
00046 <span class="comment">/*++</span>
00047 <span class="comment"></span>
00048 <span class="comment">Routine Description:</span>
00049 <span class="comment"></span>
00050 <span class="comment">    This function moves an LPC message block and optionally sets the message</span>
00051 <span class="comment">    type and client id to the specified values.</span>
00052 <span class="comment"></span>
00053 <span class="comment">Arguments:</span>
00054 <span class="comment"></span>
00055 <span class="comment">    DstMsg     - Supplies a pointer to the destination message.</span>
00056 <span class="comment"></span>
00057 <span class="comment">    SrcMsg     - Supplies a pointer to the source message.</span>
00058 <span class="comment"></span>
00059 <span class="comment">    SrcMsgData - Supplies a pointer to the source message data to</span>
00060 <span class="comment">                 copy to destination.</span>
00061 <span class="comment"></span>
00062 <span class="comment">    MsgType    - If non-zero, then store in type field of the</span>
00063 <span class="comment">                 destination message.</span>
00064 <span class="comment"></span>
00065 <span class="comment">    ClientId   - If non-NULL, then points to a ClientId to copy to</span>
00066 <span class="comment">                 the destination message.</span>
00067 <span class="comment"></span>
00068 <span class="comment">Return Value:</span>
00069 <span class="comment"></span>
00070 <span class="comment">    None</span>
00071 <span class="comment"></span>
00072 <span class="comment">--*/</span>
00073 
00074 {
00075     ULONG NumberDwords;
00076     ULONGLONG Temp1, Temp2, Temp3;
00077 
00078     <span class="comment">//</span>
00079     <span class="comment">// Extract the data length and copy over the first dword</span>
00080     <span class="comment">//</span>
00081 
00082     *((PULONG)DstMsg)++ = NumberDwords = *((PULONG)SrcMsg)++;
00083     NumberDwords = ((0x0000FFFF &amp; NumberDwords) + 3) &gt;&gt; 2;
00084 
00085     <span class="comment">//</span>
00086     <span class="comment">// Set the message type properly and update the second dword</span>
00087     <span class="comment">//</span>
00088 
00089     *((PULONG)DstMsg)++ = MsgType == 0 ? *((PULONG)SrcMsg)++ :
00090                          *((PULONG)SrcMsg)++ &amp; 0xFFFF0000 | MsgType &amp; 0xFFFF;
00091 
00092     <span class="comment">//</span>
00093     <span class="comment">// Set the ClientId appropriately and update the third dword</span>
00094     <span class="comment">//</span>
00095 
00096     *((PULONG_PTR)DstMsg)++ = ClientId == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? *((PULONG_PTR)SrcMsg) :
00097             *((PULONG_PTR)ClientId)++;
00098     ((PULONG_PTR)SrcMsg)++;
00099 
00100     *((PULONG_PTR)DstMsg)++ = ClientId == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? *((PULONG_PTR)SrcMsg) :
00101             *((PULONG_PTR)ClientId);
00102     ((PULONG_PTR)SrcMsg)++;
00103 
00104     <span class="comment">//</span>
00105     <span class="comment">// Update the final two longwords in the header</span>
00106     <span class="comment">//</span>
00107 
00108     *((PULONG_PTR)DstMsg)++ = *((PULONG_PTR)SrcMsg)++;
00109     *((PULONG_PTR)DstMsg)++ = *((PULONG_PTR)SrcMsg)++;
00110 
00111     <span class="comment">//</span>
00112     <span class="comment">// Copy the data</span>
00113     <span class="comment">//</span>
00114 
00115     <span class="keywordflow">if</span> (NumberDwords &gt; 0) {
00116 
00117         <span class="keywordflow">if</span> ((ULONG_PTR) SrcMsgData &amp; (<span class="keyword">sizeof</span>(ULONGLONG)-1)) {
00118 
00119             <span class="comment">//</span>
00120             <span class="comment">// SrcMsgData is 4-byte aligned while DstMsg is 8-byte aligned.</span>
00121             <span class="comment">//</span>
00122 
00123             Temp1 = *((PULONG) SrcMsgData)++;
00124 
00125             <span class="keywordflow">while</span> (NumberDwords &gt;= 3) {
00126 
00127                 Temp2 = *((PULONGLONG)SrcMsgData)++;
00128                 *((PULONGLONG)DstMsg)++ = (Temp2 &lt;&lt; 32) | Temp1;
00129                 Temp1 = Temp2 &amp; 0x0000FFFF;
00130                 NumberDwords -= <span class="keyword">sizeof</span>(ULONGLONG) / <span class="keyword">sizeof</span>(ULONG);
00131             }
00132 
00133             *(PULONG)DstMsg = (ULONG)Temp1;
00134             NumberDwords--;
00135 
00136         } <span class="keywordflow">else</span> {
00137 
00138             <span class="comment">// </span>
00139             <span class="comment">// Both DstMsg and SrcMsgData are 8-byte aligned;</span>
00140             <span class="comment">// copy 2 dwords (1 qword) at a time.</span>
00141             <span class="comment">// </span>
00142 
00143             <span class="keywordflow">while</span> (NumberDwords &gt;= <span class="keyword">sizeof</span>(ULONGLONG) / <span class="keyword">sizeof</span>(ULONG)) {
00144 
00145                 *((PULONGLONG)DstMsg)++ = *((PULONGLONG)SrcMsgData)++;
00146                 NumberDwords -= <span class="keyword">sizeof</span>(ULONGLONG) / <span class="keyword">sizeof</span>(ULONG);
00147             }
00148         }
00149 
00150         <span class="comment">//</span>
00151         <span class="comment">// copy the remaining dwords, if any</span>
00152         <span class="comment">//</span>
00153     
00154         <span class="keywordflow">while</span> (NumberDwords--) {
00155             *((PULONG)DstMsg)++ = *((PULONG)SrcMsgData)++;
00156         }
00157     }
00158 }
00159 
00160 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:39 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
