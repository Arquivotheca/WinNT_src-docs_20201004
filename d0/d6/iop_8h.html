<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: iop.h File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>iop.h File Reference</h1><code>#include "<a class="el" href="../../d0/d8/ntos_8h-source.html">ntos.h</a>"</code><br>
<code>#include "ntdddisk.h"</code><br>
<code>#include "ntddscsi.h"</code><br>
<code>#include "mountmgr.h"</code><br>
<code>#include "ntiodump.h"</code><br>
<code>#include "ntiolog.h"</code><br>
<code>#include "ntiologc.h"</code><br>
<code>#include "ntseapi.h"</code><br>
<code>#include "zwapi.h"</code><br>
<code>#include "stdio.h"</code><br>
<code>#include "stdlib.h"</code><br>
<code>#include "string.h"</code><br>
<code>#include "<a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>"</code><br>
<code>#include "<a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>"</code><br>
<code>#include "<a class="el" href="../../d8/d5/ioverifier_8h-source.html">ioverifier.h</a>"</code><br>
<code>#include "safeboot.h"</code><br>

<p>
<a href="../../d1/d5/iop_8h-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html">_ERROR_LOG_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d0/struct__IOP__HARD__ERROR__QUEUE.html">_IOP_HARD_ERROR_QUEUE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/struct__IOP__HARD__ERROR__PACKET.html">_IOP_HARD_ERROR_PACKET</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/struct__IOP__APC__HARD__ERROR__PACKET.html">_IOP_APC_HARD_ERROR_PACKET</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d9/struct__IO__WORKITEM.html">_IO_WORKITEM</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/struct__DUMMY__FILE__OBJECT.html">_DUMMY_FILE_OBJECT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/struct__OPEN__PACKET.html">_OPEN_PACKET</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/struct__LOAD__PACKET.html">_LOAD_PACKET</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/struct__LINK__TRACKING__PACKET.html">_LINK_TRACKING_PACKET</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/struct__REINIT__PACKET.html">_REINIT_PACKET</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/struct__SHUTDOWN__PACKET.html">_SHUTDOWN_PACKET</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/struct__NOTIFICATION__PACKET.html">_NOTIFICATION_PACKET</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/struct__IOP__MINI__COMPLETION__PACKET.html">_IOP_MINI_COMPLETION_PACKET</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/struct__MINIPORT__NODE.html">_MINIPORT_NODE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">_DUMP_CONTROL_BLOCK</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a0">IOP_ABORT</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a1">IOP_MAXIMUM_LOG_ALLOCATION</a>&nbsp;&nbsp;&nbsp;PAGE_SIZE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a2">IOP_MAXIMUM_OUTSTANDING_HARD_ERRORS</a>&nbsp;&nbsp;&nbsp;25</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a3">OPEN_PACKET_PATTERN</a>&nbsp;&nbsp;&nbsp;0xbeaa0251</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a4">IO_TYPE_DCB</a>&nbsp;&nbsp;&nbsp;0xff</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a5">DCB_DUMP_ENABLED</a>&nbsp;&nbsp;&nbsp;0x01</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a6">DCB_SUMMARY_ENABLED</a>&nbsp;&nbsp;&nbsp;0x02</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a7">DCB_AUTO_REBOOT</a>&nbsp;&nbsp;&nbsp;0x04</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a8">DCB_DUMP_HEADER_ENABLED</a>&nbsp;&nbsp;&nbsp;0x10</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a9">DCB_SUMMARY_DUMP_ENABLED</a>&nbsp;&nbsp;&nbsp;0x20</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a10">DCB_TRIAGE_DUMP_ENABLED</a>&nbsp;&nbsp;&nbsp;0x40</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a11">DCB_TRIAGE_DUMP_ACT_UPON_ENABLED</a>&nbsp;&nbsp;&nbsp;0x80</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a12">IOP_FIXED_SIZE_MDL_PFNS</a>&nbsp;&nbsp;&nbsp;0x17</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a13">IopAcquireFastLock</a>(FileObject)&nbsp;&nbsp;&nbsp;( InterlockedExchange( &amp;FileObject-&gt;Busy, (ULONG) TRUE ) == FALSE )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a14">IopAcquireCancelSpinLockAtDpcLevel</a>()&nbsp;&nbsp;&nbsp;ExAcquireSpinLockAtDpcLevel (&amp;<a class="el" href="../../d0/d6/iop_8h.html#a49">IopCancelSpinLock</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a15">IopReleaseCancelSpinLockFromDpcLevel</a>()&nbsp;&nbsp;&nbsp;ExReleaseSpinLockFromDpcLevel (&amp;<a class="el" href="../../d0/d6/iop_8h.html#a49">IopCancelSpinLock</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a16">IopAllocateIrp</a>(StackSize, ChargeQuota)&nbsp;&nbsp;&nbsp;IoAllocateIrp((StackSize), (ChargeQuota))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a17">IsIoVerifierOn</a>()&nbsp;&nbsp;&nbsp;<a class="el" href="../../d6/d6/ioverifier_8c.html#a16">IopVerifierOn</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a18">IopDequeueThreadIrp</a>(<a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a19">IopApcRoutinePresent</a>(ApcRoutine)&nbsp;&nbsp;&nbsp;ARGUMENT_PRESENT(ApcRoutine)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a20">IopInitializeIrp</a>(<a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, PacketSize, StackSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a21">IopQueueThreadIrp</a>(<a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a22">IopReleaseFileObjectLock</a>(FileObject)</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d0/d6/iop_8h.html#a240">_TRANSFER_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a25">TRANSFER_TYPE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d0/d6/iop_8h.html#a240">_TRANSFER_TYPE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a26">PTRANSFER_TYPE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html">_ERROR_LOG_ENTRY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a27">ERROR_LOG_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html">_ERROR_LOG_ENTRY</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a28">PERROR_LOG_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d0/struct__IOP__HARD__ERROR__QUEUE.html">_IOP_HARD_ERROR_QUEUE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a29">IOP_HARD_ERROR_QUEUE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d0/struct__IOP__HARD__ERROR__QUEUE.html">_IOP_HARD_ERROR_QUEUE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a30">PIOP_HARD_ERROR_QUEUE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d0/struct__IOP__HARD__ERROR__PACKET.html">_IOP_HARD_ERROR_PACKET</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a31">IOP_HARD_ERROR_PACKET</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d0/struct__IOP__HARD__ERROR__PACKET.html">_IOP_HARD_ERROR_PACKET</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a32">PIOP_HARD_ERROR_PACKET</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d0/struct__IOP__APC__HARD__ERROR__PACKET.html">_IOP_APC_HARD_ERROR_PACKET</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a33">IOP_APC_HARD_ERROR_PACKET</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d0/struct__IOP__APC__HARD__ERROR__PACKET.html">_IOP_APC_HARD_ERROR_PACKET</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a34">PIOP_APC_HARD_ERROR_PACKET</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef IN CCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a36">PriorityBoost</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef VOID(*&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a37">PIO_FREE_IRP</a> )(IN struct <a class="el" href="../../d0/d2/struct__IRP.html">_IRP</a> *<a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>(*&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a38">PIO_ALLOCATE_IRP</a> )(IN CCHAR StackSize, IN BOOLEAN ChargeQuota)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d9/struct__IO__WORKITEM.html">_IO_WORKITEM</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a41">IO_WORKITEM</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d1/struct__DUMMY__FILE__OBJECT.html">_DUMMY_FILE_OBJECT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a53">DUMMY_FILE_OBJECT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d1/struct__DUMMY__FILE__OBJECT.html">_DUMMY_FILE_OBJECT</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a54">PDUMMY_FILE_OBJECT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d3/d7/struct__OPEN__PACKET.html">_OPEN_PACKET</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a55">OPEN_PACKET</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d3/d7/struct__OPEN__PACKET.html">_OPEN_PACKET</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a56">POPEN_PACKET</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d2/struct__LOAD__PACKET.html">_LOAD_PACKET</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a57">LOAD_PACKET</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d2/struct__LOAD__PACKET.html">_LOAD_PACKET</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a58">PLOAD_PACKET</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d1/struct__LINK__TRACKING__PACKET.html">_LINK_TRACKING_PACKET</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a59">LINK_TRACKING_PACKET</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d1/struct__LINK__TRACKING__PACKET.html">_LINK_TRACKING_PACKET</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a60">PLINK_TRACKING_PACKET</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d3/struct__REINIT__PACKET.html">_REINIT_PACKET</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a61">REINIT_PACKET</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d3/struct__REINIT__PACKET.html">_REINIT_PACKET</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a62">PREINIT_PACKET</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d2/d3/struct__SHUTDOWN__PACKET.html">_SHUTDOWN_PACKET</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a63">SHUTDOWN_PACKET</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d2/d3/struct__SHUTDOWN__PACKET.html">_SHUTDOWN_PACKET</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a64">PSHUTDOWN_PACKET</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d3/struct__NOTIFICATION__PACKET.html">_NOTIFICATION_PACKET</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a65">NOTIFICATION_PACKET</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d3/struct__NOTIFICATION__PACKET.html">_NOTIFICATION_PACKET</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a66">PNOTIFICATION_PACKET</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d0/d6/iop_8h.html#a241">_COMPLETION_PACKET_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a67">COMPLETION_PACKET_TYPE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d0/d6/iop_8h.html#a241">_COMPLETION_PACKET_TYPE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a68">PCOMPLETION_PACKET_TYPE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d0/struct__IOP__MINI__COMPLETION__PACKET.html">_IOP_MINI_COMPLETION_PACKET</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a69">IOP_MINI_COMPLETION_PACKET</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d0/struct__IOP__MINI__COMPLETION__PACKET.html">_IOP_MINI_COMPLETION_PACKET</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a70">PIOP_MINI_COMPLETION_PACKET</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d9/struct__MINIPORT__NODE.html">_MINIPORT_NODE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a71">MINIPORT_NODE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d9/struct__MINIPORT__NODE.html">_MINIPORT_NODE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a72">PMINIPORT_NODE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">_DUMP_CONTROL_BLOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a73">DUMP_CONTROL_BLOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">_DUMP_CONTROL_BLOCK</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a74">PDUMP_CONTROL_BLOCK</a></td></tr>

<tr><td colspan=2><br><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a240">_TRANSFER_TYPE</a> { <a class="el" href="../../d0/d6/iop_8h.html#a240a138">ReadTransfer</a>, 
<a class="el" href="../../d0/d6/iop_8h.html#a240a139">WriteTransfer</a>, 
<a class="el" href="../../d0/d6/iop_8h.html#a240a140">OtherTransfer</a>
 }</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a241">_COMPLETION_PACKET_TYPE</a> { <a class="el" href="../../d0/d6/iop_8h.html#a241a141">IopCompletionPacketIrp</a>, 
<a class="el" href="../../d0/d6/iop_8h.html#a241a142">IopCompletionPacketMini</a>, 
<a class="el" href="../../d0/d6/iop_8h.html#a241a143">IopCompletionPacketQuota</a>
 }</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> (FASTCALL *PIO_CALL_DRIVER)(IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a145">VOID</a> (FASTCALL *PIO_COMPLETE_REQUEST)(IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a146">IopAbortRequest</a> (IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a147">IopAcquireFileObjectLock</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> RequestorMode, IN BOOLEAN Alertable, OUT PBOOLEAN Interrupted)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a148">IopAllocateIrpCleanup</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> EventObject OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a149">IopAllocateIrpMustSucceed</a> (IN CCHAR StackSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a150">IopApcHardError</a> (IN PVOID StartContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a151">IopCancelAlertedRequest</a> (IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> Event, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a152">IopCheckBackupRestorePrivilege</a> (IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState, IN OUT PULONG CreateOptions, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode, IN ULONG Disposition)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a153">IopCheckGetQuotaBufferValidity</a> (IN PFILE_GET_QUOTA_INFORMATION QuotaBuffer, IN ULONG QuotaLength, OUT PULONG_PTR ErrorOffset)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a154">IopCloseFile</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process OPTIONAL, IN PVOID Object, IN ULONG GrantedAccess, IN ULONG ProcessHandleCount, IN ULONG SystemHandleCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a155">IopCompleteUnloadOrDelete</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN KIRQL Irql)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a156">IopCompletePageWrite</a> (IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *NormalRoutine, IN PVOID *NormalContext, IN PVOID *SystemArgument1, IN PVOID *SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a157">IopCompleteRequest</a> (IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *NormalRoutine, IN PVOID *NormalContext, IN PVOID *SystemArgument1, IN PVOID *SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a158">IopConnectLinkTrackingPort</a> (IN PVOID Parameter)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a159">IopCreateVpb</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a160">IopDeallocateApc</a> (IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *NormalRoutine, IN PVOID *NormalContext, IN PVOID *SystemArgument1, IN PVOID *SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a161">IopDecrementDeviceObjectRef</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN BOOLEAN AlwaysUnload)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a162">IopDeleteDriver</a> (IN PVOID Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a163">IopDeleteDevice</a> (IN PVOID Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a164">IopDeleteFile</a> (IN PVOID Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a165">IopDeleteIoCompletion</a> (IN PVOID Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a166">IopDisassociateThreadIrp</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a167">IopDmaDispatch</a> (IN <a class="el" href="../../d0/d7/struct__KINTERRUPT.html">PKINTERRUPT</a> Interrupt, IN PVOID ServiceContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a168">IopDropIrp</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a169">IopExceptionFilter</a> (IN PEXCEPTION_POINTERS ExceptionPointers, OUT PNTSTATUS ExceptionCode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a170">IopExceptionCleanup</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> EventObject OPTIONAL, IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> KernelEvent OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a171">IopErrorLogThread</a> (IN PVOID StartContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a172">IopFreeIrpAndMdls</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a173">IopGetDeviceAttachmentBase</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a174">IopGetDeviceAttachmentBaseRef</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a175">IopGetDriverNameFromKeyNode</a> (IN HANDLE KeyHandle, OUT PUNICODE_STRING DriverName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a176">IopGetDumpControlBlockCheck</a> (IN <a class="el" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">PDUMP_CONTROL_BLOCK</a> Dcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a177">IopGetFileName</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN ULONG Length, OUT PVOID FileInformation, OUT PULONG ReturnedLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a178">IopGetMountFlag</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a179">IopGetRegistryKeyInformation</a> (IN HANDLE KeyHandle, OUT PKEY_FULL_INFORMATION *Information)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a180">IopGetRegistryValue</a> (IN HANDLE KeyHandle, IN PWSTR <a class="el" href="../../d8/d2/rtrenval_8c.html#a3">ValueName</a>, OUT PKEY_VALUE_FULL_INFORMATION *Information)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a181">IopGetRegistryValues</a> (IN HANDLE KeyHandle, IN PKEY_VALUE_FULL_INFORMATION *ValueList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN OUT PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN ULONG Length, IN ULONG OperationFlags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a183">IopGetSetSecurityObject</a> (IN PVOID Object, IN <a class="el" href="../../d0/d5/se_8h.html#a19">SECURITY_OPERATION_CODE</a> OperationCode, IN PSECURITY_INFORMATION SecurityInformation, IN OUT PSECURITY_DESCRIPTOR SecurityDescriptor, IN OUT PULONG CapturedLength, IN OUT PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor, IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType, IN PGENERIC_MAPPING GenericMapping)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a184">IopGetVolumeId</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN OUT PLINK_TRACKING_INFORMATION ObjectId, IN ULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a185">IopHardErrorThread</a> (PVOID StartContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a186">IopInitializeResourceMap</a> (<a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a187">IopInsertRemoveDevice</a> (IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN BOOLEAN Insert)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a188">IopInvalidDeviceRequest</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a189">IopInvalidateVolumesForDevice</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a190">IopIsSameMachine</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> SourceFile, IN HANDLE TargetFile)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a191">IopLoadDriver</a> (IN HANDLE KeyHandle, IN BOOLEAN CheckForSafeBoot)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a192">IopLoadFileSystemDriver</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a193">IopLoadUnloadDriver</a> (IN PVOID Parameter)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a194">IopLookupBusStringFromID</a> (IN HANDLE KeyHandle, IN INTERFACE_TYPE <a class="el" href="../../d6/d0/cmdat_8c.html#a4">InterfaceType</a>, OUT PWCHAR <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN ULONG Length, OUT PULONG BusFlags OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a195">IopMountVolume</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN BOOLEAN AllowRawMount, IN BOOLEAN DeviceLockAlreadyHeld, IN BOOLEAN Alertable)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a196">IopNotifyPnpWhenChainDereferenced</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *PhysicalDeviceObjects, IN ULONG DeviceObjectCount, IN BOOLEAN Query, OUT <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *VetoingDevice)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a197">IopOpenLinkOrRenameTarget</a> (OUT PHANDLE TargetHandle, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN PVOID RenameBuffer, IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a> (OUT PHANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN HANDLE BaseHandle OPTIONAL, IN PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>, IN ACCESS_MASK DesiredAccess, IN BOOLEAN Create)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a199">IopParseDevice</a> (IN PVOID ParseObject, IN PVOID ObjectType, IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, IN ULONG Attributes, IN OUT PUNICODE_STRING CompleteName, IN OUT PUNICODE_STRING RemainingName, IN OUT PVOID Context OPTIONAL, IN PSECURITY_QUALITY_OF_SERVICE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a9">SecurityQos</a> OPTIONAL, OUT PVOID *Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a200">IopParseFile</a> (IN PVOID ParseObject, IN PVOID ObjectType, IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, IN ULONG Attributes, IN OUT PUNICODE_STRING CompleteName, IN OUT PUNICODE_STRING RemainingName, IN OUT PVOID Context OPTIONAL, IN PSECURITY_QUALITY_OF_SERVICE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a9">SecurityQos</a> OPTIONAL, OUT PVOID *Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a201">IopProtectSystemPartition</a> (IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a202">IopQueryName</a> (IN PVOID Object, IN BOOLEAN HasObjectName, OUT POBJECT_NAME_INFORMATION ObjectNameInfo, IN ULONG Length, OUT PULONG ReturnLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a203">IopQueryXxxInformation</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN ULONG InformationClass, IN ULONG Length, OUT PVOID Information, OUT PULONG ReturnedLength, IN BOOLEAN FileInformation)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a204">IopQueueWorkRequest</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a205">IopRaiseHardError</a> (IN PVOID NormalContext, IN PVOID SystemArgument1, IN PVOID SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a206">IopRaiseInformationalHardError</a> (IN PVOID NormalContext, IN PVOID SystemArgument1, IN PVOID SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a207">IopReadyDeviceObjects</a> (IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a208">IopSetEaOrQuotaInformationFile</a> (IN HANDLE FileHandle, OUT PIO_STATUS_BLOCK IoStatusBlock, IN PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN ULONG Length, IN BOOLEAN SetEa)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a209">IopSetRemoteLink</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> DestinationFileObject OPTIONAL, IN PFILE_TRACKING_INFORMATION FileInformation OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a210">IopStartApcHardError</a> (IN PVOID StartContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a211">IopSynchronousApiServiceTail</a> (IN NTSTATUS ReturnedStatus, IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> Event, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> RequestorMode, IN PIO_STATUS_BLOCK LocalIoStatus, OUT PIO_STATUS_BLOCK IoStatusBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a212">IopSynchronousServiceTail</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN BOOLEAN DeferredIoCompletion, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> RequestorMode, IN BOOLEAN SynchronousIo, IN <a class="el" href="../../d0/d6/iop_8h.html#a25">TRANSFER_TYPE</a> TransferType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a213">IopTimerDispatch</a> (IN <a class="el" href="../../d1/d6/struct__KDPC.html">PKDPC</a> Dpc, IN PVOID DeferredContext, IN PVOID SystemArgument1, IN PVOID SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a214">IopTrackLink</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN OUT PIO_STATUS_BLOCK IoStatusBlock, IN PFILE_TRACKING_INFORMATION FileInformation, IN ULONG Length, IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> Event, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> RequestorMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a215">IopUserCompletion</a> (IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *NormalRoutine, IN PVOID *NormalContext, IN PVOID *SystemArgument1, IN PVOID *SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a216">IopXxxControlFile</a> (IN HANDLE FileHandle, IN HANDLE Event OPTIONAL, IN PIO_APC_ROUTINE ApcRoutine OPTIONAL, IN PVOID ApcContext OPTIONAL, OUT PIO_STATUS_BLOCK IoStatusBlock, IN ULONG IoControlCode, IN PVOID InputBuffer OPTIONAL, IN ULONG InputBufferLength, OUT PVOID OutputBuffer OPTIONAL, IN ULONG OutputBufferLength, IN BOOLEAN DeviceIoControl)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a217">IopReportResourceUsage</a> (IN PUNICODE_STRING DriverClassName OPTIONAL, IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject, IN PCM_RESOURCE_LIST DriverList OPTIONAL, IN ULONG DriverListSize OPTIONAL, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject OPTIONAL, IN PCM_RESOURCE_LIST DeviceList OPTIONAL, IN ULONG DeviceListSize OPTIONAL, IN BOOLEAN OverrideConflict, OUT PBOOLEAN ConflictDetected)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a218">IopAddRemoteBootValuesToRegistry</a> (<a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a219">IopStartNetworkForRemoteBoot</a> (<a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a220">IopStartTcpIpForRemoteBoot</a> (<a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a221">IopIsRemoteBootCard</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock, IN PWCHAR HwIds)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a222">IopSetupRemoteBootCard</a> (IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock, IN HANDLE UniqueIdHandle, IN PUNICODE_STRING UnicodeDeviceInstance)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a223">IopSafebootDriverLoad</a> (PUNICODE_STRING DriverId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PSECURITY_DESCRIPTOR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a224">IopCreateDefaultDeviceSecurityDescriptor</a> (IN DEVICE_TYPE DeviceType, IN ULONG DeviceCharacteristics, IN BOOLEAN DeviceHasName, IN PUCHAR <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, OUT PACL *AllocatedAcl, OUT PSECURITY_INFORMATION SecurityInformation OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a225">IopDoNameTransmogrify</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN PREPARSE_DATA_BUFFER ReparseBuffer)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a226">IopQueryDeviceCapabilities</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, OUT <a class="el" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">PDEVICE_CAPABILITIES</a> Capabilities)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a227">IopLogErrorEvent</a> (IN ULONG SequenceNumber, IN ULONG UniqueErrorValue, IN NTSTATUS FinalStatus, IN NTSTATUS SpecificIOStatus, IN ULONG LengthOfInsert1, IN PWCHAR Insert1, IN ULONG LengthOfInsert2, IN PWCHAR Insert2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a228">IopConfigureCrashDump</a> (IN HANDLE HandlePagingFile)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a229">IopUpdateOtherOperationCount</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a230">IopUpdateReadOperationCount</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a231">IopUpdateWriteOperationCount</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a232">IopUpdateOtherTransferCount</a> (IN ULONG TransferCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a233">IopUpdateReadTransferCount</a> (IN ULONG TransferCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a234">IopUpdateWriteTransferCount</a> (IN ULONG TransferCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a235">IopfCallDriver</a> (<a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a236">IopfCompleteRequest</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN CCHAR PriorityBost)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a237">IopAllocateIrpPrivate</a> (IN CCHAR StackSize, IN BOOLEAN ChargeQuota)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a238">IopFreeIrp</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a239">IopAllocateErrorLogEntry</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject, IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject, IN UCHAR EntrySize)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a23">BreakDiskByteOffset</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a24">BreakPfn</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d0/struct__IOP__HARD__ERROR__QUEUE.html">IOP_HARD_ERROR_QUEUE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a39">IopHardError</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d7/d0/struct__IOP__HARD__ERROR__PACKET.html">PIOP_HARD_ERROR_PACKET</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a40">IopCurrentHardError</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">WORK_QUEUE_ITEM</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a42">IopErrorLogWorkItem</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a43">IopErrorLogPortPending</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a44">IopErrorLogDisabledThisBoot</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>KSPIN_LOCK&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a45">IopErrorLogLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a46">IopErrorLogListHead</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a47">IopErrorLogAllocation</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>KSPIN_LOCK&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a48">IopErrorLogAllocationLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>KSPIN_LOCK&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a49">IopCancelSpinLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>KSPIN_LOCK&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a50">IopVpbSpinLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>GENERIC_MAPPING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a51">IopFileMapping</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>GENERIC_MAPPING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a52">IopCompletionMapping</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>KSPIN_LOCK&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a75">IopDatabaseLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a76">IopDatabaseResource</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a77">IopSecurityResource</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a78">IopDiskFileSystemQueueHead</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a79">IopCdRomFileSystemQueueHead</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a80">IopNetworkFileSystemQueueHead</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a81">IopTapeFileSystemQueueHead</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a82">IopBootDriverReinitializeQueueHead</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a83">IopDriverReinitializeQueueHead</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a84">IopNotifyShutdownQueueHead</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a85">IopNotifyLastChanceShutdownQueueHead</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a86">IopFsNotifyChangeQueueHead</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>KSPIN_LOCK&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a87">IoStatisticsLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d7/struct__KSEMAPHORE.html">KSEMAPHORE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a88">IopRegistrySemaphore</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>KSPIN_LOCK&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a89">IopTimerLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a90">IopTimerQueueHead</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d6/struct__KDPC.html">KDPC</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a91">IopTimerDpc</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d8/struct__KTIMER.html">KTIMER</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a92">IopTimer</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a93">IopTimerCount</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a94">IopLargeIrpStackLocations</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>KSPIN_LOCK&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a95">IopCompletionLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a96">IoAdapterObjectType</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a97">IoCompletionObjectType</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a98">IoControllerObjectType</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a99">IoDeviceObjectType</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a100">IoDriverObjectType</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a101">IoDeviceHandlerObjectType</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a102">IoFileObjectType</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a103">IoDeviceHandlerObjectSize</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a104">IopLargeIrpLookasideList</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a105">IopSmallIrpLookasideList</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a106">IopMdlLookasideList</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a107">IopCompletionLookasideList</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a108">IopQueryOperationLength</a> []</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a109">IopSetOperationLength</a> []</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a110">IopQueryOperationAccess</a> []</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a111">IopSetOperationAccess</a> []</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a112">IopQuerySetAlignmentRequirement</a> []</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a113">IopQueryFsOperationLength</a> []</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a114">IopSetFsOperationLength</a> []</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a115">IopQueryFsOperationAccess</a> []</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a116">IopSetFsOperationAccess</a> []</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a117">IopQuerySetFsAlignmentRequirement</a> []</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UNICODE_STRING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a118">IoArcBootDeviceName</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UNICODE_STRING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a119">IoArcHalDeviceName</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PUCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a120">IoLoaderArcBootDeviceName</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">PDUMP_CONTROL_BLOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a121">IopDumpControlBlock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a122">IopDumpControlBlockChecksum</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a123">IopUniqueDeviceObjectNumber</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a124">IopLinkTrackingServiceObject</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a125">IopLinkTrackingServiceEvent</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a126">IopLinkTrackingPortObject</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d1/struct__LINK__TRACKING__PACKET.html">LINK_TRACKING_PACKET</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a127">IopLinkTrackingPacket</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a128">IopLoaderBlock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a129">IopRemoteBootCardInitialized</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a130">IopLookasideIrpFloat</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a131">IopLookasideIrpLimit</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a132">IopVerifierOn</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PIO_CALL_DRIVER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a133">pIofCallDriver</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PIO_COMPLETE_REQUEST&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a134">pIofCompleteRequest</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d6/iop_8h.html#a37">PIO_FREE_IRP</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a135">pIoFreeIrp</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d6/iop_8h.html#a38">PIO_ALLOCATE_IRP</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a136">pIoAllocateIrp</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/iop_8h.html#a137">ExEventObjectType</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a7" doxytag="iop.h::DCB_AUTO_REBOOT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DCB_AUTO_REBOOT&nbsp;&nbsp;&nbsp;0x04          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00444">444</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04252">IopFreeDCB()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04580">IopInitializeDCB()</a>, and <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01519">IoWriteCrashDump()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="iop.h::DCB_DUMP_ENABLED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DCB_DUMP_ENABLED&nbsp;&nbsp;&nbsp;0x01          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00442">442</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02492">IopCalculateRequiredDumpSpace()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04746">IopConfigureCrashDump()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04379">IopReadDumpRegistry()</a>, and <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01519">IoWriteCrashDump()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="iop.h::DCB_DUMP_HEADER_ENABLED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DCB_DUMP_HEADER_ENABLED&nbsp;&nbsp;&nbsp;0x10          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00445">445</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02492">IopCalculateRequiredDumpSpace()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01452">IopInitializeDumpSpaceAndType()</a>, and <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01519">IoWriteCrashDump()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="iop.h::DCB_SUMMARY_DUMP_ENABLED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DCB_SUMMARY_DUMP_ENABLED&nbsp;&nbsp;&nbsp;0x20          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00446">446</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02492">IopCalculateRequiredDumpSpace()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01452">IopInitializeDumpSpaceAndType()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04379">IopReadDumpRegistry()</a>, and <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01519">IoWriteCrashDump()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="iop.h::DCB_SUMMARY_ENABLED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DCB_SUMMARY_ENABLED&nbsp;&nbsp;&nbsp;0x02          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00443">443</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02492">IopCalculateRequiredDumpSpace()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04746">IopConfigureCrashDump()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04580">IopInitializeDCB()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04379">IopReadDumpRegistry()</a>, and <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01519">IoWriteCrashDump()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="iop.h::DCB_TRIAGE_DUMP_ACT_UPON_ENABLED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DCB_TRIAGE_DUMP_ACT_UPON_ENABLED&nbsp;&nbsp;&nbsp;0x80          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00448">448</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04379">IopReadDumpRegistry()</a>, and <a class="el" href="../../d6/d4/triage_8c-source.html#l00367">TriageActUpon()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="iop.h::DCB_TRIAGE_DUMP_ENABLED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DCB_TRIAGE_DUMP_ENABLED&nbsp;&nbsp;&nbsp;0x40          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00447">447</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02492">IopCalculateRequiredDumpSpace()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04580">IopInitializeDCB()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01452">IopInitializeDumpSpaceAndType()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04379">IopReadDumpRegistry()</a>, and <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01519">IoWriteCrashDump()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="iop.h::IO_TYPE_DCB" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IO_TYPE_DCB&nbsp;&nbsp;&nbsp;0xff          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00440">440</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04580">IopInitializeDCB()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="iop.h::IOP_ABORT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IOP_ABORT&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00065">65</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l04282">IopMountVolume()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l05617">IopRaiseHardError()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="iop.h::IOP_FIXED_SIZE_MDL_PFNS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IOP_FIXED_SIZE_MDL_PFNS&nbsp;&nbsp;&nbsp;0x17          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00480">480</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00805">IoAllocateMdl()</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="iop.h::IOP_MAXIMUM_LOG_ALLOCATION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IOP_MAXIMUM_LOG_ALLOCATION&nbsp;&nbsp;&nbsp;PAGE_SIZE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00082">82</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00542">IopAllocateErrorLogEntry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="iop.h::IOP_MAXIMUM_OUTSTANDING_HARD_ERRORS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IOP_MAXIMUM_OUTSTANDING_HARD_ERRORS&nbsp;&nbsp;&nbsp;25          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00155">155</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08909">IoRaiseInformationalHardError()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="iop.h::IopAcquireCancelSpinLockAtDpcLevel" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopAcquireCancelSpinLockAtDpcLevel          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExAcquireSpinLockAtDpcLevel (&amp;<a class="el" href="../../d0/d6/iop_8h.html#a49">IopCancelSpinLock</a>)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00598">598</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="iop.h::IopAcquireFastLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopAcquireFastLock          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">FileObject&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;( InterlockedExchange( &amp;FileObject-&gt;Busy, (ULONG) TRUE ) == FALSE )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00595">595</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/dir_8c-source.html#l00057">BuildQueryDirectoryIrp()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00181">IopAcquireFileObjectLock()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00036">IopCloseFile()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00417">IopDeleteFile()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00975">IopGetSetSecurityObject()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05397">IopQueryXxxInformation()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06326">IopSetEaOrQuotaInformationFile()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08084">IopXxxControlFile()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09835">IoSetInformation()</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00386">NtFlushBuffersFile()</a>, <a class="el" href="../../d2/d4/lock_8c-source.html#l00035">NtLockFile()</a>, <a class="el" href="../../d1/d7/dir_8c-source.html#l00821">NtNotifyChangeDirectoryFile()</a>, <a class="el" href="../../d8/d1/qsea_8c-source.html#l00035">NtQueryEaFile()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00101">NtQueryInformationFile()</a>, <a class="el" href="../../d1/d2/qsquota_8c-source.html#l00035">NtQueryQuotaInformationFile()</a>, <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00037">NtQueryVolumeInformationFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00036">NtReadFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00730">NtReadFileScatter()</a>, <a class="el" href="../../d8/d1/qsea_8c-source.html#l00652">NtSetEaFile()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>, <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00492">NtSetVolumeInformationFile()</a>, <a class="el" href="../../d2/d4/lock_8c-source.html#l00458">NtUnlockFile()</a>, <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00035">NtWriteFile()</a>, and <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00801">NtWriteFileGather()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="iop.h::IopAllocateIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopAllocateIrp          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">StackSize,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ChargeQuota&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;IoAllocateIrp((StackSize), (ChargeQuota))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00604">604</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d2/parse_8c-source.html#l00202">IopParseDevice()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08084">IopXxxControlFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00036">NtReadFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00730">NtReadFileScatter()</a>, <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00035">NtWriteFile()</a>, and <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00801">NtWriteFileGather()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="iop.h::IopApcRoutinePresent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopApcRoutinePresent          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ApcRoutine&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ARGUMENT_PRESENT(ApcRoutine)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00768">768</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/dir_8c-source.html#l00057">BuildQueryDirectoryIrp()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08084">IopXxxControlFile()</a>, <a class="el" href="../../d2/d4/lock_8c-source.html#l00035">NtLockFile()</a>, <a class="el" href="../../d1/d7/dir_8c-source.html#l00821">NtNotifyChangeDirectoryFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00036">NtReadFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00730">NtReadFileScatter()</a>, <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00035">NtWriteFile()</a>, and <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00801">NtWriteFileGather()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="iop.h::IopDequeueThreadIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopDequeueThreadIrp          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{ \
   RemoveEntryList( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o8">ThreadListEntry</a> ); \
   InitializeListHead( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o8">ThreadListEntry</a> ) ; \
   }
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00758">758</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12535">IoCancelFileOpen()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00036">IopCloseFile()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01019">IopCompleteRequest()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00417">IopDeleteFile()</a>, and <a class="el" href="../../d5/d2/parse_8c-source.html#l00202">IopParseDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="iop.h::IopInitializeIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopInitializeIrp          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PacketSize,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>StackSize&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{          \
    RtlZeroMemory( (Irp), (PacketSize) );                         \
    (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>)-&gt;Type = (CSHORT) <a class="code" href="../../d0/d5/io_8h.html#a5">IO_TYPE_IRP</a>;                           \
    (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>)-&gt;Size = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) ((PacketSize));                        \
    (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>)-&gt;StackCount = (CCHAR) ((StackSize));                    \
    (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>)-&gt;CurrentLocation = (CCHAR) ((StackSize) + 1);           \
    (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>)-&gt;ApcEnvironment = <a class="code" href="../../d4/d9/ke_8h.html#a11">KeGetCurrentApcEnvironment</a>();         \
    InitializeListHead (&amp;(Irp)-&gt;ThreadListEntry);                 \
    (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>)-&gt;Tail.Overlay.CurrentStackLocation =                    \
        ((<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>) ((UCHAR *) (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>) +                  \
            <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> ) +                                       \
            ( (StackSize) * <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> )))); }
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00930">930</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08338">IoMakeAssociatedIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00662">IopAllocateIrpPrivate()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07497">IoReuseIrp()</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00353">IovAllocateIrp()</a>, and <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03132">IovpAllocateIrp1()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="iop.h::IopQueueThreadIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopQueueThreadIrp          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                      \
    KIRQL irql;                                         \
    <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>( APC_LEVEL, &amp;irql );                    \
    InsertHeadList( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread-&gt;IrpList, \
                    &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o8">ThreadListEntry</a> );            \
    <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>( irql );                                \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l01103">1103</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01552">IoBuildDeviceIoControlRequest()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01933">IoBuildSynchronousFsdRequest()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12535">IoCancelFileOpen()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06429">IoEnqueueIrp()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00036">IopCloseFile()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00417">IopDeleteFile()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l03255">IopFilterResourceRequirementsCall()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02256">IopGetFileName()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00975">IopGetSetSecurityObject()</a>, <a class="el" href="../../d5/d2/parse_8c-source.html#l00202">IopParseDevice()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05397">IopQueryXxxInformation()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l07030">IopSynchronousServiceTail()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08738">IoQueueThreadIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09835">IoSetInformation()</a>, <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l01531">IovpThrowBogusSynchronousIrp()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00101">NtQueryInformationFile()</a>, and <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="iop.h::IopReleaseCancelSpinLockFromDpcLevel" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopReleaseCancelSpinLockFromDpcLevel          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExReleaseSpinLockFromDpcLevel (&amp;<a class="el" href="../../d0/d6/iop_8h.html#a49">IopCancelSpinLock</a>)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00601">601</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="iop.h::IopReleaseFileObjectLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopReleaseFileObjectLock          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">FileObject&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{    \
    ULONG Result;                                   \
    Result = InterlockedExchange( &amp;FileObject-&gt;Busy, FALSE ); \
    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Result != FALSE);                        \
    <span class="keywordflow">if</span> (FileObject-&gt;Waiters != 0) {                 \
        <a class="code" href="../../d4/d9/ke_8h.html#a282">KeSetEvent</a>( &amp;FileObject-&gt;Lock, 0, FALSE );  \
    }                                               \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l01157">1157</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l00284">IopAllocateIrpCleanup()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00036">IopCloseFile()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01934">IopExceptionCleanup()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00975">IopGetSetSecurityObject()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05397">IopQueryXxxInformation()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l07030">IopSynchronousServiceTail()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08084">IopXxxControlFile()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09835">IoSetInformation()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00101">NtQueryInformationFile()</a>, <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00037">NtQueryVolumeInformationFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00036">NtReadFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00730">NtReadFileScatter()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>, <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00035">NtWriteFile()</a>, and <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00801">NtWriteFileGather()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="iop.h::IsIoVerifierOn" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IsIoVerifierOn          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;<a class="el" href="../../d6/d6/ioverifier_8c.html#a16">IopVerifierOn</a></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00607">607</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="iop.h::OPEN_PACKET_PATTERN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OPEN_PACKET_PATTERN&nbsp;&nbsp;&nbsp;0xbeaa0251          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00196">196</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l04502">IoCreateFile()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06463">IoFastQueryNetworkAttributes()</a>, <a class="el" href="../../d5/d2/parse_8c-source.html#l00202">IopParseDevice()</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00298">NtDeleteFile()</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00629">NtQueryAttributesFile()</a>, and <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00745">NtQueryFullAttributesFile()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a67" doxytag="iop.h::COMPLETION_PACKET_TYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d0/d6/iop_8h.html#a241">_COMPLETION_PACKET_TYPE</a>  <a class="el" href="../../d0/d6/iop_8h.html#a67">COMPLETION_PACKET_TYPE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a53" doxytag="iop.h::DUMMY_FILE_OBJECT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d1/struct__DUMMY__FILE__OBJECT.html">_DUMMY_FILE_OBJECT</a>  <a class="el" href="../../d0/d1/struct__DUMMY__FILE__OBJECT.html">DUMMY_FILE_OBJECT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a73" doxytag="iop.h::DUMP_CONTROL_BLOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">_DUMP_CONTROL_BLOCK</a>  <a class="el" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">DUMP_CONTROL_BLOCK</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01062">IopGetDumpControlBlockCheck()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="iop.h::ERROR_LOG_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html">_ERROR_LOG_ENTRY</a>  <a class="el" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html">ERROR_LOG_ENTRY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d8/d6/errorlog_8c-source.html#l00088">IopErrorLogThread()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="iop.h::IO_WORKITEM" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d5/d9/struct__IO__WORKITEM.html">_IO_WORKITEM</a>  <a class="el" href="../../d5/d9/struct__IO__WORKITEM.html">IO_WORKITEM</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00891">IoAllocateWorkItem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="iop.h::IOP_APC_HARD_ERROR_PACKET" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d5/d0/struct__IOP__APC__HARD__ERROR__PACKET.html">_IOP_APC_HARD_ERROR_PACKET</a>  <a class="el" href="../../d5/d0/struct__IOP__APC__HARD__ERROR__PACKET.html">IOP_APC_HARD_ERROR_PACKET</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="iop.h::IOP_HARD_ERROR_PACKET" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d0/struct__IOP__HARD__ERROR__PACKET.html">_IOP_HARD_ERROR_PACKET</a>  <a class="el" href="../../d7/d0/struct__IOP__HARD__ERROR__PACKET.html">IOP_HARD_ERROR_PACKET</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l02977">IopHardErrorThread()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08909">IoRaiseInformationalHardError()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="iop.h::IOP_HARD_ERROR_QUEUE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d0/struct__IOP__HARD__ERROR__QUEUE.html">_IOP_HARD_ERROR_QUEUE</a>  <a class="el" href="../../d8/d0/struct__IOP__HARD__ERROR__QUEUE.html">IOP_HARD_ERROR_QUEUE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a69" doxytag="iop.h::IOP_MINI_COMPLETION_PACKET" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d9/d0/struct__IOP__MINI__COMPLETION__PACKET.html">_IOP_MINI_COMPLETION_PACKET</a>  <a class="el" href="../../d9/d0/struct__IOP__MINI__COMPLETION__PACKET.html">IOP_MINI_COMPLETION_PACKET</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, and <a class="el" href="../../d6/d3/complete_8c-source.html#l00485">NtRemoveIoCompletion()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="iop.h::Irp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">130</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/dir_8c-source.html#l00057">BuildQueryDirectoryIrp()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l02717">CcSetValidData()</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00040">CdfsRecFsControl()</a>, <a class="el" href="../../d6/d0/fat__rec_8c-source.html#l00043">FatRecFsControl()</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00195">FsRecCleanupClose()</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00233">FsRecCreate()</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00446">FsRecFsControl()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01678">FsRtlAcknowledgeOplockBreak()</a>, <a class="el" href="../../d8/d0/faulttol_8c-source.html#l00031">FsRtlBalanceReads()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03519">FsRtlCancelExclusiveIrp()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l02555">FsRtlCancelNotify()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03396">FsRtlCancelOplockIIIrp()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03288">FsRtlCancelWaitIrp()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01315">FsRtlCheckLockForReadAccess()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01416">FsRtlCheckLockForWriteAccess()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00823">FsRtlCheckOplock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00507">FsRtlCompleteLockIrpReal()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03241">FsRtlCompletionRoutinePriv()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l02691">FsRtlGetFileSize()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l02467">FsRtlNotifyCompleteIrpList()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03698">FsRtlNotifyCompletion()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01937">FsRtlOpBatchBreakClosePending()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02111">FsRtlOplockBreakNotify()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02454">FsRtlOplockBreakToII()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02690">FsRtlOplockBreakToNone()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02249">FsRtlOplockCleanup()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00581">FsRtlOplockFsctrl()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05721">FsRtlPrivateCancelFileLockIrp()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l04722">FsRtlPrivateCheckWaitingLocks()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03867">FsRtlPrivateLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01173">FsRtlProcessFileLock()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02952">FsRtlRemoveAndCompleteIrp()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03623">FsRtlRemoveAndCompleteWaitIrp()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01299">FsRtlRequestExclusiveOplock()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01514">FsRtlRequestOplockII()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l02864">FsRtlSetFileSize()</a>, <a class="el" href="../../d8/d0/faulttol_8c-source.html#l00096">FsRtlSyncVolumes()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00995">FsRtlUninitializeFileLock()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00413">FsRtlUninitializeOplock()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03025">FsRtlWaitOnIrp()</a>, <a class="el" href="../../d7/d7/fsvga_8c-source.html#l01213">FsVgaDeviceControl()</a>, <a class="el" href="../../d7/d7/fsvga_8c-source.html#l01167">FsVgaOpenCloseDispatch()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00805">IoAllocateMdl()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00934">IoAsynchronousPageWrite()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12073">IoCallDriver()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02149">IoCancelIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12088">IoCompleteRequest()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06429">IoEnqueueIrp()</a>, <a class="el" href="../../d5/d4/ioeapi_8c-source.html#l00073">IoErrInitErrLogByIrp()</a>, <a class="el" href="../../d5/d4/ioeapi_8c-source.html#l00135">IoErrLogErrByIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02135">IofCallDriver()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l03166">IofCompleteRequest()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01300">IoFreeDumpStack()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06632">IoFreeIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07374">IoGetRequestorProcess()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07330">IoGetRequestorProcessId()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12301">IoGetRequestorSessionId()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07444">IoInitializeIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07615">IoIsOperationSynchronous()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07705">IoIsValidNameGraftingBuffer()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08338">IoMakeAssociatedIrp()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00417">IopCancelAlertedRequest()</a>, <a class="el" href="../../d6/d3/complete_8c-source.html#l00864">IopDeleteIoCompletion()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00896">IopDeviceEjectComplete()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01496">IopDeviceRelationsComplete()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01370">IopDeviceStartComplete()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08130">IopDoNameTransmogrify()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01821">IopDropIrp()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01934">IopExceptionCleanup()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02063">IopfCallDriver()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06641">IopFreeIrp()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02029">IopFreeIrpAndMdls()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00384">IopGetDumpStack()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03087">IopInvalidDeviceRequest()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05126">IopOpenLinkOrRenameTarget()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01009">IopPnPCompleteRequest()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00648">IopPnPDispatch()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00570">IopPowerDispatch()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06870">IopStartApcHardError()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06926">IopSynchronousApiServiceTail()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l07030">IopSynchronousServiceTail()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08738">IoQueueThreadIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08769">IoRaiseHardError()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07497">IoReuseIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09796">IoSetHardErrorOrVerifyDevice()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l10321">IoSetTopLevelIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l10735">IoStartPacket()</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00455">IovBuildAsynchronousFsdRequest()</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00486">IovBuildDeviceIoControlRequest()</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00248">IovCallDriver()</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l01332">IovCancelIrp()</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00297">IovCompleteRequest()</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00198">IovFreeIrp()</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00206">IovFreeIrpPrivate()</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l01279">IovInitializeIrp()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03216">IovpAllocateIrp2()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02872">IovpCancelIrp()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01267">IovpCompleteRequest1()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01416">IovpCompleteRequest2()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01693">IovpCompleteRequest3()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01813">IovpCompleteRequest4()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01965">IovpCompleteRequestApc()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02239">IovpExamineIrpStackForwarding()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02990">IovpFreeIrp()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03268">IovpInitializeIrp()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02446">IovpInternalCompletionTrap()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02555">IovpInternalDeferredCompletion()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00807">IovpProtectedIrpMakeTouchable()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00744">IovpProtectedIrpMakeUntouchable()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02751">IovpSwapSurrogateIrp()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00122">IovpTrackingDataCreateAndLock()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00276">IovpTrackingDataFindAndLock()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00345">IovpTrackingDataFindPointer()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00865">IovpWatermarkIrp()</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l01159">IovSpecialIrpCallDriver()</a>, <a class="el" href="../../d3/d7/ntfs__rec_8c-source.html#l00042">NtfsRecFsControl()</a>, <a class="el" href="../../d6/d3/complete_8c-source.html#l00485">NtRemoveIoCompletion()</a>, <a class="el" href="../../d3/d8/workque_8c-source.html#l00316">UdfAddToWorkque()</a>, <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html#l00042">UdfCommonCleanup()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00319">UdfCommonClose()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00108">UdfCommonCreate()</a>, <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00069">UdfCommonDevControl()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00255">UdfCommonDirControl()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00283">UdfCommonFsControl()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00046">UdfCommonLockControl()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00075">UdfCommonPnp()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00156">UdfCommonQueryInfo()</a>, <a class="el" href="../../d8/d5/volinfo_8c-source.html#l00082">UdfCommonQueryVolInfo()</a>, <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00385">UdfCommonSetInfo()</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00285">UdfCompleteMdl()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01301">UdfCreateIrpContext()</a>, <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00451">UdfDevCtrlCompletionRoutine()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00966">UdfDismountVolume()</a>, <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00337">UdfDvdReadStructure()</a>, <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00227">UdfDvdTransferKey()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>, <a class="el" href="../../d3/d8/workque_8c-source.html#l00061">UdfFsdPostRequest()</a>, <a class="el" href="../../d1/d7/fspdisp_8c-source.html#l00038">UdfFspDispatch()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01271">UdfInvalidateVolumes()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01236">UdfIsPathnameValid()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01064">UdfIsVolumeDirty()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01175">UdfIsVolumeMounted()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00780">UdfLockVolume()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01444">UdfMountVolume()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01863">UdfMultiAsyncCompletionRoutine()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01435">UdfMultipleAsync()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01779">UdfMultiSyncCompletionRoutine()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00904">UdfNotifyChangeDirectory()</a>, <a class="el" href="../../d3/d8/workque_8c-source.html#l00222">UdfOplockComplete()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00470">UdfOplockRequest()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00573">UdfPerformDevIoCtrl()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00042">UdfPerformVerify()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00632">UdfPnpCancelRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00194">UdfPnpQueryRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00350">UdfPnpRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00500">UdfPnpSurpriseRemove()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00883">UdfPrepareBuffers()</a>, <a class="el" href="../../d3/d8/workque_8c-source.html#l00111">UdfPrePostIrp()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00539">UdfProcessException()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00334">UdfQueryDirectory()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00685">UdfReadSectors()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l02039">UdfSingleAsyncCompletionRoutine()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01980">UdfSingleSyncCompletionRoutine()</a>, <a class="el" href="../../d5/d7/udfs__rec_8c-source.html#l00060">UdfsRecFsControl()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00877">UdfUnlockVolume()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00363">UdfUserFsctl()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02043">UdfVerifyVolume()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a59" doxytag="iop.h::LINK_TRACKING_PACKET" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d1/struct__LINK__TRACKING__PACKET.html">_LINK_TRACKING_PACKET</a>  <a class="el" href="../../d8/d1/struct__LINK__TRACKING__PACKET.html">LINK_TRACKING_PACKET</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l06127">IopSendMessageToTrackService()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a57" doxytag="iop.h::LOAD_PACKET" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d2/struct__LOAD__PACKET.html">_LOAD_PACKET</a>  <a class="el" href="../../d0/d2/struct__LOAD__PACKET.html">LOAD_PACKET</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l00657">IopCompleteUnloadOrDelete()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a71" doxytag="iop.h::MINIPORT_NODE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d9/struct__MINIPORT__NODE.html">_MINIPORT_NODE</a>  <a class="el" href="../../d7/d9/struct__MINIPORT__NODE.html">MINIPORT_NODE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04580">IopInitializeDCB()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a65" doxytag="iop.h::NOTIFICATION_PACKET" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d3/struct__NOTIFICATION__PACKET.html">_NOTIFICATION_PACKET</a>  <a class="el" href="../../d8/d3/struct__NOTIFICATION__PACKET.html">NOTIFICATION_PACKET</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a55" doxytag="iop.h::OPEN_PACKET" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d3/d7/struct__OPEN__PACKET.html">_OPEN_PACKET</a>  <a class="el" href="../../d3/d7/struct__OPEN__PACKET.html">OPEN_PACKET</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06463">IoFastQueryNetworkAttributes()</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00298">NtDeleteFile()</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00629">NtQueryAttributesFile()</a>, and <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00745">NtQueryFullAttributesFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a68" doxytag="iop.h::PCOMPLETION_PACKET_TYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d0/d6/iop_8h.html#a241">_COMPLETION_PACKET_TYPE</a> * <a class="el" href="../../d0/d6/iop_8h.html#a68">PCOMPLETION_PACKET_TYPE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a54" doxytag="iop.h::PDUMMY_FILE_OBJECT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d1/struct__DUMMY__FILE__OBJECT.html">_DUMMY_FILE_OBJECT</a> * <a class="el" href="../../d0/d1/struct__DUMMY__FILE__OBJECT.html">PDUMMY_FILE_OBJECT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a74" doxytag="iop.h::PDUMP_CONTROL_BLOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">_DUMP_CONTROL_BLOCK</a> * <a class="el" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">PDUMP_CONTROL_BLOCK</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="iop.h::PERROR_LOG_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html">_ERROR_LOG_ENTRY</a> * <a class="el" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html">PERROR_LOG_ENTRY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d8/d6/errorlog_8c-source.html#l00088">IopErrorLogThread()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="iop.h::PIO_ALLOCATE_IRP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>(* <a class="el" href="../../d0/d6/iop_8h.html#a38">PIO_ALLOCATE_IRP</a>)(IN CCHAR StackSize, IN BOOLEAN ChargeQuota)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00147">147</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="iop.h::PIO_FREE_IRP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef VOID(* <a class="el" href="../../d0/d6/iop_8h.html#a37">PIO_FREE_IRP</a>)(IN struct <a class="el" href="../../d0/d2/struct__IRP.html">_IRP</a> *<a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00141">141</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="iop.h::PIOP_APC_HARD_ERROR_PACKET" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d5/d0/struct__IOP__APC__HARD__ERROR__PACKET.html">_IOP_APC_HARD_ERROR_PACKET</a> * <a class="el" href="../../d5/d0/struct__IOP__APC__HARD__ERROR__PACKET.html">PIOP_APC_HARD_ERROR_PACKET</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l00383">IopApcHardError()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="iop.h::PIOP_HARD_ERROR_PACKET" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d0/struct__IOP__HARD__ERROR__PACKET.html">_IOP_HARD_ERROR_PACKET</a> * <a class="el" href="../../d7/d0/struct__IOP__HARD__ERROR__PACKET.html">PIOP_HARD_ERROR_PACKET</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l02977">IopHardErrorThread()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="iop.h::PIOP_HARD_ERROR_QUEUE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d0/struct__IOP__HARD__ERROR__QUEUE.html">_IOP_HARD_ERROR_QUEUE</a> * <a class="el" href="../../d8/d0/struct__IOP__HARD__ERROR__QUEUE.html">PIOP_HARD_ERROR_QUEUE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a70" doxytag="iop.h::PIOP_MINI_COMPLETION_PACKET" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d9/d0/struct__IOP__MINI__COMPLETION__PACKET.html">_IOP_MINI_COMPLETION_PACKET</a> * <a class="el" href="../../d9/d0/struct__IOP__MINI__COMPLETION__PACKET.html">PIOP_MINI_COMPLETION_PACKET</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a60" doxytag="iop.h::PLINK_TRACKING_PACKET" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d1/struct__LINK__TRACKING__PACKET.html">_LINK_TRACKING_PACKET</a> * <a class="el" href="../../d8/d1/struct__LINK__TRACKING__PACKET.html">PLINK_TRACKING_PACKET</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l01506">IopConnectLinkTrackingPort()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a58" doxytag="iop.h::PLOAD_PACKET" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d2/struct__LOAD__PACKET.html">_LOAD_PACKET</a> * <a class="el" href="../../d0/d2/struct__LOAD__PACKET.html">PLOAD_PACKET</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l04169">IopLoadUnloadDriver()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a72" doxytag="iop.h::PMINIPORT_NODE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d9/struct__MINIPORT__NODE.html">_MINIPORT_NODE</a> * <a class="el" href="../../d7/d9/struct__MINIPORT__NODE.html">PMINIPORT_NODE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a66" doxytag="iop.h::PNOTIFICATION_PACKET" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d3/struct__NOTIFICATION__PACKET.html">_NOTIFICATION_PACKET</a> * <a class="el" href="../../d8/d3/struct__NOTIFICATION__PACKET.html">PNOTIFICATION_PACKET</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a56" doxytag="iop.h::POPEN_PACKET" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d3/d7/struct__OPEN__PACKET.html">_OPEN_PACKET</a> * <a class="el" href="../../d3/d7/struct__OPEN__PACKET.html">POPEN_PACKET</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a62" doxytag="iop.h::PREINIT_PACKET" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d5/d3/struct__REINIT__PACKET.html">_REINIT_PACKET</a> * <a class="el" href="../../d5/d3/struct__REINIT__PACKET.html">PREINIT_PACKET</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l04169">IopLoadUnloadDriver()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="iop.h::PriorityBoost" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef IN CCHAR <a class="el" href="../../d0/d6/iop_8h.html#a36">PriorityBoost</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00137">137</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12088">IoCompleteRequest()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l03166">IofCompleteRequest()</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00297">IovCompleteRequest()</a>, and <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01267">IovpCompleteRequest1()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a64" doxytag="iop.h::PSHUTDOWN_PACKET" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d2/d3/struct__SHUTDOWN__PACKET.html">_SHUTDOWN_PACKET</a> * <a class="el" href="../../d2/d3/struct__SHUTDOWN__PACKET.html">PSHUTDOWN_PACKET</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="iop.h::PTRANSFER_TYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d0/d6/iop_8h.html#a240">_TRANSFER_TYPE</a> * <a class="el" href="../../d0/d6/iop_8h.html#a26">PTRANSFER_TYPE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a61" doxytag="iop.h::REINIT_PACKET" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d5/d3/struct__REINIT__PACKET.html">_REINIT_PACKET</a>  <a class="el" href="../../d5/d3/struct__REINIT__PACKET.html">REINIT_PACKET</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l04169">IopLoadUnloadDriver()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a63" doxytag="iop.h::SHUTDOWN_PACKET" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d2/d3/struct__SHUTDOWN__PACKET.html">_SHUTDOWN_PACKET</a>  <a class="el" href="../../d2/d3/struct__SHUTDOWN__PACKET.html">SHUTDOWN_PACKET</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="iop.h::TRANSFER_TYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d0/d6/iop_8h.html#a240">_TRANSFER_TYPE</a>  <a class="el" href="../../d0/d6/iop_8h.html#a25">TRANSFER_TYPE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l07030">IopSynchronousServiceTail()</a>.    </td>
  </tr>
</table>
<hr><h2>Enumeration Type Documentation</h2>
<a class="anchor" name="a241" doxytag="iop.h::_COMPLETION_PACKET_TYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d0/d6/iop_8h.html#a241">_COMPLETION_PACKET_TYPE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a241a141" doxytag="IopCompletionPacketIrp" ></a>IopCompletionPacketIrp</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a241a142" doxytag="IopCompletionPacketMini" ></a>IopCompletionPacketMini</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a241a143" doxytag="IopCompletionPacketQuota" ></a>IopCompletionPacketQuota</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00374">374</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
<pre class="fragment"><div>00374                                      {
00375     <a class="code" href="../../d0/d6/iop_8h.html#a241a141">IopCompletionPacketIrp</a>,
00376     <a class="code" href="../../d0/d6/iop_8h.html#a241a142">IopCompletionPacketMini</a>,
00377     <a class="code" href="../../d0/d6/iop_8h.html#a241a143">IopCompletionPacketQuota</a>
00378 } <a class="code" href="../../d0/d6/iop_8h.html#a67">COMPLETION_PACKET_TYPE</a>, *<a class="code" href="../../d0/d6/iop_8h.html#a68">PCOMPLETION_PACKET_TYPE</a>;
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a240" doxytag="iop.h::_TRANSFER_TYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d0/d6/iop_8h.html#a240">_TRANSFER_TYPE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a240a138" doxytag="ReadTransfer" ></a>ReadTransfer</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a240a139" doxytag="WriteTransfer" ></a>WriteTransfer</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a240a140" doxytag="OtherTransfer" ></a>OtherTransfer</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00071">71</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
<pre class="fragment"><div>00071                             {
00072     <a class="code" href="../../d0/d6/iop_8h.html#a240a138">ReadTransfer</a>,
00073     <a class="code" href="../../d0/d6/iop_8h.html#a240a139">WriteTransfer</a>,
00074     <a class="code" href="../../d0/d6/iop_8h.html#a240a140">OtherTransfer</a>
00075 } <a class="code" href="../../d0/d6/iop_8h.html#a25">TRANSFER_TYPE</a>, *<a class="code" href="../../d0/d6/iop_8h.html#a26">PTRANSFER_TYPE</a>;
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a146" doxytag="iop.h::IopAbortRequest" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopAbortRequest           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Apc</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l00144">144</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d3/d3/internal_8c-source.html#l01019">IopCompleteRequest()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08769">IoRaiseHardError()</a>.
<p>
<pre class="fragment"><div>00150                    :
00151 
00152     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to abort an I/O request.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked during <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00153     rundown of a thread.
00154 
00155 Arguments:
00156 
00157     Apc - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel APC structure.  This structure <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> contained
00158         within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet (<a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>) itself.
00159 
00160 Return Value:
00161 
00162     None.
00163 
00164 --*/
00165 
00166 {
00167     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00168 
00169     <span class="comment">//</span>
00170     <span class="comment">// Invoke the normal special kernel APC routine.</span>
00171     <span class="comment">//</span>
00172 
00173     <a class="code" href="../../d0/d6/iop_8h.html#a157">IopCompleteRequest</a>( Apc,
00174                         &amp;Apc-&gt;NormalRoutine,
00175                         &amp;Apc-&gt;NormalContext,
00176                         &amp;Apc-&gt;SystemArgument1,
00177                         &amp;Apc-&gt;SystemArgument2 );
00178 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a147" doxytag="iop.h::IopAcquireFileObjectLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopAcquireFileObjectLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RequestorMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Alertable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Interrupted</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l00181">181</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00595">IopAcquireFastLock</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/dir_8c-source.html#l00057">BuildQueryDirectoryIrp()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00036">IopCloseFile()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00417">IopDeleteFile()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00975">IopGetSetSecurityObject()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05397">IopQueryXxxInformation()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06326">IopSetEaOrQuotaInformationFile()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08084">IopXxxControlFile()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09835">IoSetInformation()</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00386">NtFlushBuffersFile()</a>, <a class="el" href="../../d2/d4/lock_8c-source.html#l00035">NtLockFile()</a>, <a class="el" href="../../d1/d7/dir_8c-source.html#l00821">NtNotifyChangeDirectoryFile()</a>, <a class="el" href="../../d8/d1/qsea_8c-source.html#l00035">NtQueryEaFile()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00101">NtQueryInformationFile()</a>, <a class="el" href="../../d1/d2/qsquota_8c-source.html#l00035">NtQueryQuotaInformationFile()</a>, <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00037">NtQueryVolumeInformationFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00036">NtReadFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00730">NtReadFileScatter()</a>, <a class="el" href="../../d8/d1/qsea_8c-source.html#l00652">NtSetEaFile()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>, <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00492">NtSetVolumeInformationFile()</a>, <a class="el" href="../../d2/d4/lock_8c-source.html#l00458">NtUnlockFile()</a>, <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00035">NtWriteFile()</a>, and <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00801">NtWriteFileGather()</a>.
<p>
<pre class="fragment"><div>00190                    :
00191 
00192     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to acquire <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock <span class="keywordflow">for</span> a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object whenever
00193     there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> contention and obtaining <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fast lock <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> failed.
00194 
00195 Arguments:
00196 
00197     FileObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object whose lock <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be acquired.
00198 
00199     RequestorMode - Processor access mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
00200 
00201     Alertable - Indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock should be obtained in an
00202         alertable manner.
00203 
00204     Interrupted - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> variable to receive a BOOLEAN that indicates whether or
00205         not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> attempt to acquire <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock was interrupted by an alert or
00206         an APC.
00207 
00208 Return Value:
00209 
00210     The function status <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
00211 
00212 --*/
00213 {
00214     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00215 
00216     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00217 
00218     <span class="comment">//</span>
00219     <span class="comment">// Assume that the function will not be interrupted by an alert or an</span>
00220     <span class="comment">// APC while attempting to acquire the lock.</span>
00221     <span class="comment">//</span>
00222 
00223     *Interrupted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00224 
00225     <span class="comment">//</span>
00226     <span class="comment">// Loop attempting to acquire the lock for the file object.</span>
00227     <span class="comment">//</span>
00228 
00229     InterlockedIncrement (&amp;FileObject-&gt;Waiters);
00230 
00231     <span class="keywordflow">for</span> (;;) {
00232         <span class="keywordflow">if</span> (!FileObject-&gt;Busy) {
00233 
00234             <span class="comment">//</span>
00235             <span class="comment">// The file object appears to be un-owned, try to acquire it</span>
00236             <span class="comment">//</span>
00237 
00238             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a13">IopAcquireFastLock</a> ( FileObject ) ) {
00239 
00240                 <span class="comment">//</span>
00241                 <span class="comment">// Object was acquired. Remove our count and return success</span>
00242                 <span class="comment">//</span>
00243 
00244                 InterlockedDecrement (&amp;FileObject-&gt;Waiters);
00245                 <span class="keywordflow">return</span> STATUS_SUCCESS;
00246             }
00247         }
00248 
00249         <span class="comment">//</span>
00250         <span class="comment">// Wait for the event that indicates that the thread that currently</span>
00251         <span class="comment">// owns the file object has released it.</span>
00252         <span class="comment">//</span>
00253 
00254         status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;FileObject-&gt;Lock,
00255                                         Executive,
00256                                         RequestorMode,
00257                                         Alertable,
00258                                         (PLARGE_INTEGER) NULL );
00259 
00260         <span class="comment">//</span>
00261         <span class="comment">// If the above wait was interrupted, then indicate so and return.</span>
00262         <span class="comment">// Before returning, however, check the state of the ownership of</span>
00263         <span class="comment">// the file object itself.  If it is not currently owned (the busy</span>
00264         <span class="comment">// flag is clear), then check to see whether or not there are any</span>
00265         <span class="comment">// other waiters.  If so, then set the event to the signaled state</span>
00266         <span class="comment">// again so that they wake up and check the state of the busy flag.</span>
00267         <span class="comment">//</span>
00268 
00269         <span class="keywordflow">if</span> (status == STATUS_USER_APC || status == STATUS_ALERTED) {
00270             InterlockedDecrement (&amp;FileObject-&gt;Waiters);
00271 
00272             <span class="keywordflow">if</span> (!FileObject-&gt;Busy  &amp;&amp;  FileObject-&gt;Waiters) {
00273                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;FileObject-&gt;Lock, 0, FALSE );
00274 
00275             }
00276             *Interrupted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00277             <span class="keywordflow">return</span> status;
00278         }
00279     }
00280 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a218" doxytag="iop.h::IopAddRemoteBootValuesToRegistry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopAddRemoteBootValuesToRegistry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LoaderBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/netboot_8c-source.html#l00314">314</a> of file <a class="el" href="../../d5/d5/netboot_8c-source.html">netboot.c</a>.
<p>
References <a class="el" href="../../d2/d8/arc_8h-source.html#l01854">_LOADER_PARAMETER_BLOCK::ArcBootDeviceName</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00178">CmRegistryMachineSystemCurrentControlSetServices</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00449">_SETUP_LOADER_BLOCK::ComputerName</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00453">_SETUP_LOADER_BLOCK::DefaultRouter</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00511">_SETUP_LOADER_BLOCK::Flags</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l03974">IopWriteIpAddressToRegistry()</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00450">_SETUP_LOADER_BLOCK::IpAddress</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00543">_SETUP_LOADER_BLOCK::MachineDirectoryPath</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00471">_SETUP_LOADER_BLOCK::NetbootCardDriverName</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00477">_SETUP_LOADER_BLOCK::NetbootCardServiceName</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01856">_LOADER_PARAMETER_BLOCK::NtBootPathName</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00504">NtDeleteValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l02519">RtlDnsHostNameToComputerName()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00102">RtlInitAnsiString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00514">SETUPBLK_FLAGS_IS_TEXTMODE</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01862">_LOADER_PARAMETER_BLOCK::SetupLoaderBlock</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00451">_SETUP_LOADER_BLOCK::SubnetMask</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>.
<p>
<pre class="fragment"><div>00317 {
00318     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
00319     HANDLE handle;
00320     HANDLE serviceHandle;
00321     OBJECT_ATTRIBUTES objectAttributes;
00322     UNICODE_STRING string;
00323     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> addressA[16];
00324     WCHAR addressW[16];
00325     STRING addressStringA;
00326     UNICODE_STRING addressStringW;
00327     PUCHAR addressPointer;
00328     PUCHAR p;
00329     PUCHAR q;
00330     UCHAR ntName[128];
00331     WCHAR imagePath[128];
00332     STRING ansiString;
00333     UNICODE_STRING unicodeString;
00334     UNICODE_STRING dnsNameString;
00335     UNICODE_STRING netbiosNameString;
00336     ULONG tmpValue;
00337 
00338     <span class="keywordflow">if</span> (LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o20">ComputerName</a>[0] != 0) {
00339 
00340         <span class="comment">//</span>
00341         <span class="comment">// Convert the name to a Netbios name.</span>
00342         <span class="comment">//</span>
00343 
00344         _wcsupr( LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o20">ComputerName</a> );
00345 
00346         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;dnsNameString, LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o20">ComputerName</a> );
00347 
00348         status = <a class="code" href="../../d6/d6/nls_8c.html#a51">RtlDnsHostNameToComputerName</a>(
00349                      &amp;netbiosNameString,
00350                      &amp;dnsNameString,
00351                      TRUE);            <span class="comment">// allocate netbiosNameString</span>
00352 
00353         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00354             KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Failed RtlDnsHostNameToComputerName: %x\n"</span>, status ));
00355             <span class="keywordflow">goto</span> cleanup;
00356         }
00357 
00358         <span class="comment">//</span>
00359         <span class="comment">// Add a value for the computername.</span>
00360         <span class="comment">//</span>
00361 
00362         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\ComputerName\\ComputerName"</span> );
00363 
00364         InitializeObjectAttributes(
00365             &amp;objectAttributes,
00366             &amp;string,
00367             OBJ_CASE_INSENSITIVE,
00368             NULL,
00369             NULL
00370             );
00371 
00372         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( &amp;handle, KEY_ALL_ACCESS, &amp;objectAttributes );
00373         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00374             KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to open ComputerName key: %x\n"</span>, status ));
00375             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;netbiosNameString );
00376             <span class="keywordflow">goto</span> cleanup;
00377         }
00378 
00379         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"ComputerName"</span> );
00380 
00381         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00382                     handle,
00383                     &amp;string,
00384                     0,
00385                     REG_SZ,
00386                     netbiosNameString.Buffer,
00387                     netbiosNameString.Length + <span class="keyword">sizeof</span>(WCHAR)
00388                     );
00389         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
00390         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;netbiosNameString );
00391 
00392         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00393             KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to set ComputerName value: %x\n"</span>, status ));
00394             <span class="keywordflow">goto</span> cleanup;
00395         }
00396 
00397         <span class="comment">//</span>
00398         <span class="comment">// Add a value for the host name.</span>
00399         <span class="comment">//</span>
00400 
00401         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Services\\Tcpip\\Parameters"</span> );
00402 
00403         InitializeObjectAttributes(
00404             &amp;objectAttributes,
00405             &amp;string,
00406             OBJ_CASE_INSENSITIVE,
00407             NULL,
00408             NULL
00409             );
00410 
00411         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( &amp;handle, KEY_ALL_ACCESS, &amp;objectAttributes );
00412         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00413             KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to open Tcpip\\Parameters key: %x\n"</span>, status ));
00414             <span class="keywordflow">goto</span> cleanup;
00415         }
00416 
00417         _wcslwr( LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o20">ComputerName</a> );
00418 
00419         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"Hostname"</span> );
00420 
00421         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00422                     handle,
00423                     &amp;string,
00424                     0,
00425                     REG_SZ,
00426                     LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o20">ComputerName</a>,
00427                     (wcslen(LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o20">ComputerName</a>) + 1) * <span class="keyword">sizeof</span>(WCHAR)
00428                     );
00429         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
00430         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00431             KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to set Hostname value: %x\n"</span>, status ));
00432             <span class="keywordflow">goto</span> cleanup;
00433         }
00434     }
00435 
00436     <span class="comment">//</span>
00437     <span class="comment">//  If the UNC path to the system files is supplied then store it in the registry.</span>
00438     <span class="comment">//</span>
00439 
00440     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( _stricmp(LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o10">ArcBootDeviceName</a>,<span class="stringliteral">"net(0)"</span>) == 0 );
00441 
00442     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control"</span> );
00443 
00444     InitializeObjectAttributes(
00445         &amp;objectAttributes,
00446         &amp;string,
00447         OBJ_CASE_INSENSITIVE,
00448         NULL,
00449         NULL
00450         );
00451 
00452     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( &amp;handle, KEY_ALL_ACCESS, &amp;objectAttributes );
00453     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00454         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to open Control key: %x\n"</span>, status ));
00455         <span class="keywordflow">goto</span> skiproot;
00456     }
00457 
00458     p = strrchr( LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o12">NtBootPathName</a>, <span class="charliteral">'\\'</span> );   <span class="comment">// find last separator</span>
00459     <span class="keywordflow">if</span> ( (p != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (*(p+1) == 0) ) {
00460 
00461         <span class="comment">//</span>
00462         <span class="comment">// NtBootPathName ends with a backslash, so we need to back up</span>
00463         <span class="comment">// to the previous backslash.</span>
00464         <span class="comment">//</span>
00465 
00466         q = p;
00467         *q = 0;
00468         p = strrchr( LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o12">NtBootPathName</a>, <span class="charliteral">'\\'</span> );   <span class="comment">// find last separator</span>
00469         *q = <span class="charliteral">'\\'</span>;
00470     }
00471     <span class="keywordflow">if</span> ( p == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00472         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: malformed NtBootPathName: %s\n"</span>, LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o12">NtBootPathName</a> ));
00473         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
00474         <span class="keywordflow">goto</span> skiproot;
00475     }
00476     *p = 0;                                 <span class="comment">// terminate \server\share\images\machine</span>
00477 
00478 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
00479 <span class="preprocessor"></span>    <span class="comment">//</span>
00480     <span class="comment">// Store the server path in the shared user data area. Note that we need</span>
00481     <span class="comment">// to add an extra \ at the beginning of this path to make it a UNC name.</span>
00482     <span class="comment">//</span>
00483 
00484     SharedUserData-&gt;RemoteBootServerPath[0] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>;
00485     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;ansiString, LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o12">NtBootPathName</a> );
00486     unicodeString.MaximumLength = <span class="keyword">sizeof</span>(SharedUserData-&gt;RemoteBootServerPath) - (2 * <span class="keyword">sizeof</span>(WCHAR));
00487     unicodeString.Buffer = &amp;SharedUserData-&gt;RemoteBootServerPath[1];
00488     <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;unicodeString, &amp;ansiString, FALSE );
00489     SharedUserData-&gt;RemoteBootServerPath[1 + (unicodeString.Length/<span class="keyword">sizeof</span>(WCHAR))] = 0;
00490 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
00491 <span class="preprocessor"></span>
00492     strcpy( ntName, <span class="stringliteral">"\\Device\\LanmanRedirector"</span>);
00493     strcat( ntName, LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o12">NtBootPathName</a> );  <span class="comment">// append \server\share\images\machine</span>
00494     *p = <span class="charliteral">'\\'</span>;
00495 
00496     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;ansiString, ntName );
00497     <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;unicodeString, &amp;ansiString, TRUE );
00498 
00499     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"RemoteBootRoot"</span> );
00500 
00501     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00502                 handle,
00503                 &amp;string,
00504                 0,
00505                 REG_SZ,
00506                 unicodeString.Buffer,
00507                 unicodeString.Length + <span class="keyword">sizeof</span>(WCHAR)
00508                 );
00509 
00510     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;unicodeString );
00511     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00512         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to set RemoteBootRoot value: %x\n"</span>, status ));
00513     }
00514 
00515     <span class="keywordflow">if</span> ((LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; <a class="code" href="../../d3/d8/setupblk_8h.html#a26">SETUPBLK_FLAGS_IS_TEXTMODE</a>) != 0) {
00516 
00517         strcpy( ntName, <span class="stringliteral">"\\Device\\LanmanRedirector"</span>);
00518         strcat( ntName, LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o34">MachineDirectoryPath</a> );
00519         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;ansiString, ntName );
00520         <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;unicodeString, &amp;ansiString, TRUE );
00521 
00522         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"RemoteBootMachineDirectory"</span> );
00523 
00524         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00525                     handle,
00526                     &amp;string,
00527                     0,
00528                     REG_SZ,
00529                     unicodeString.Buffer,
00530                     unicodeString.Length + <span class="keyword">sizeof</span>(WCHAR)
00531                     );
00532 
00533         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;unicodeString );
00534         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00535             KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to set RemoteBootMachineDirectory value: %x\n"</span>, status ));
00536         }
00537     }
00538 
00539     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
00540 
00541 skiproot:
00542 
00543 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
00544 <span class="preprocessor"></span>    StartCsc = INIT_CSC;
00545     IopSetFlushCSC(READ_CSC);
00546 
00547     <span class="keywordflow">if</span> ( (StartCsc != FLUSH_CSC) &amp;&amp;
00548          ((LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; SETUPBLK_FLAGS_REPIN) != 0) ) {
00549         StartCsc = FLUSH_CSC;
00550         IopSetFlushCSC(SET_FLUSH_CSC);
00551     }
00552 
00553 <span class="preprocessor">#if 0</span>
00554 <span class="preprocessor"></span>    <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"\\Registry\\Machine\\Software\\Microsoft\\Windows\\CSCSettings"</span> );
00555 
00556     InitializeObjectAttributes(
00557         &amp;objectAttributes,
00558         &amp;string,
00559         OBJ_CASE_INSENSITIVE,
00560         NULL,
00561         NULL
00562         );
00563 
00564     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( &amp;handle, KEY_ALL_ACCESS, &amp;objectAttributes );
00565 
00566     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00567 
00568         PKEY_VALUE_PARTIAL_INFORMATION keyValue;
00569         UCHAR buffer[FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION, Data) + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)];
00570         ULONG length;
00571         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> disabled;
00572 
00573 <span class="preprocessor">#define ONE_BOOT 2</span>
00574 <span class="preprocessor"></span>
00575         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"DisableAgent"</span> );
00576 
00577         <span class="keywordflow">if</span> ( (LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; SETUPBLK_FLAGS_DISABLE_CSC) == 0 ) {
00578 
00579             <span class="comment">//</span>
00580             <span class="comment">// Disable CSC for this boot.</span>
00581             <span class="comment">//</span>
00582 
00583             disabled = ONE_BOOT;
00584             status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00585                         handle,
00586                         &amp;string,
00587                         0,
00588                         REG_DWORD,
00589                         &amp;disabled,
00590                         <span class="keyword">sizeof</span>(DWORD));
00591 
00592         } <span class="keywordflow">else</span> {
00593 
00594             keyValue = (PKEY_VALUE_PARTIAL_INFORMATION)buffer;
00595             status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
00596                          handle,
00597                          &amp;string,
00598                          KeyValuePartialInformation,
00599                          keyValue,
00600                          <span class="keyword">sizeof</span>(buffer),
00601                          &amp;length);
00602             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00603                 disabled = *((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)(&amp;keyValue-&gt;Data[0]));
00604 
00605                 <span class="keywordflow">if</span> (disabled == ONE_BOOT) {
00606                     <span class="comment">//  Only disabled for last boot so re-enable now.</span>
00607                     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a16">NtDeleteValueKey</a>( handle, &amp;string);
00608                     <span class="comment">//  BUGBUG should we repin?</span>
00609                 }
00610             }
00611         }
00612 
00613         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
00614         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00615             KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to set CSCSettings: %x\n"</span>, status ));
00616             <span class="keywordflow">goto</span> cleanup;
00617         }
00618     }
00619 <span class="preprocessor">#endif</span>
00620 <span class="preprocessor"></span><span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
00621 <span class="preprocessor"></span>
00622     <span class="comment">//</span>
00623     <span class="comment">// Add registry values for the IP address and subnet mask received</span>
00624     <span class="comment">// from DHCP. These are stored under the Tcpip service key and are</span>
00625     <span class="comment">// read by both Tcpip and Netbt. The adapter name used is the known</span>
00626     <span class="comment">// GUID for the NetbootCard.</span>
00627     <span class="comment">//</span>
00628 
00629     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Services\\Tcpip\\Parameters\\Interfaces\\{54C7D140-09EF-11D1-B25A-F5FE627ED95E}"</span> );
00630 
00631     InitializeObjectAttributes(
00632         &amp;objectAttributes,
00633         &amp;string,
00634         OBJ_CASE_INSENSITIVE,
00635         NULL,
00636         NULL
00637         );
00638 
00639     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( &amp;handle, KEY_ALL_ACCESS, &amp;objectAttributes );
00640     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00641         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to open Tcpip\\Parameters\\Interfaces\\{54C7D140-09EF-11D1-B25A-F5FE627ED95E} key: %x\n"</span>, status ));
00642         <span class="keywordflow">goto</span> cleanup;
00643     }
00644 
00645     status = <a class="code" href="../../d4/d6/netboot_8c.html#a4">IopWriteIpAddressToRegistry</a>(handle,
00646                                          L<span class="stringliteral">"DhcpIPAddress"</span>,
00647                                          (PUCHAR)&amp;(LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o21">IpAddress</a>)
00648                                         );
00649 
00650     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00651         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(handle);
00652         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to write DhcpIPAddress: %x\n"</span>, status ));
00653         <span class="keywordflow">goto</span> cleanup;
00654     }
00655 
00656     status = <a class="code" href="../../d4/d6/netboot_8c.html#a4">IopWriteIpAddressToRegistry</a>(handle,
00657                                          L<span class="stringliteral">"DhcpSubnetMask"</span>,
00658                                          (PUCHAR)&amp;(LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o22">SubnetMask</a>)
00659                                         );
00660 
00661     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00662         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(handle);
00663         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to write DhcpSubnetMask: %x\n"</span>, status ));
00664         <span class="keywordflow">goto</span> cleanup;
00665     }
00666 
00667     status = <a class="code" href="../../d4/d6/netboot_8c.html#a4">IopWriteIpAddressToRegistry</a>(handle,
00668                                          L<span class="stringliteral">"DhcpDefaultGateway"</span>,
00669                                          (PUCHAR)&amp;(LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o24">DefaultRouter</a>)
00670                                         );
00671 
00672     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(handle);
00673 
00674     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00675         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to write DhcpDefaultGateway: %x\n"</span>, status ));
00676         <span class="keywordflow">goto</span> cleanup;
00677     }
00678 
00679     <span class="comment">//</span>
00680     <span class="comment">// Create the service key for the netboot card. We need to have</span>
00681     <span class="comment">// the Type value there or the card won't be initialized.</span>
00682     <span class="comment">//</span>
00683 
00684     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
00685                                 NULL,
00686                                 &amp;CmRegistryMachineSystemCurrentControlSetServices,
00687                                 KEY_ALL_ACCESS,
00688                                 FALSE
00689                                 );
00690 
00691     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00692         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to open CurrentControlSet\\Services: %x\n"</span>, status ));
00693         <span class="keywordflow">goto</span> cleanup;
00694     }
00695 
00696     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;string, LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o28">NetbootCardServiceName</a>);
00697 
00698     InitializeObjectAttributes(&amp;objectAttributes,
00699                                &amp;string,
00700                                OBJ_CASE_INSENSITIVE,
00701                                handle,
00702                                (PSECURITY_DESCRIPTOR)NULL
00703                                );
00704 
00705     status = ZwCreateKey(&amp;serviceHandle,
00706                          KEY_ALL_ACCESS,
00707                          &amp;objectAttributes,
00708                          0,
00709                          (PUNICODE_STRING)NULL,
00710                          0,
00711                          &amp;tmpValue     <span class="comment">// disposition</span>
00712                          );
00713 
00714     ZwClose(handle);
00715 
00716     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00717         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to open/create netboot card service key: %x\n"</span>, status ));
00718         <span class="keywordflow">goto</span> cleanup;
00719     }
00720 
00721     <span class="comment">//</span>
00722     <span class="comment">// Store the image path.</span>
00723     <span class="comment">//</span>
00724 
00725     PiWstrToUnicodeString(&amp;string, L<span class="stringliteral">"ImagePath"</span>);
00726     wcscpy(imagePath, L<span class="stringliteral">"system32\\drivers\\"</span>);
00727     wcscat(imagePath, LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o27">NetbootCardDriverName</a>);
00728 
00729     status = ZwSetValueKey(serviceHandle,
00730                            &amp;string,
00731                            TITLE_INDEX_VALUE,
00732                            REG_SZ,
00733                            imagePath,
00734                            (wcslen(imagePath) + 1) * <span class="keyword">sizeof</span>(WCHAR)
00735                            );
00736 
00737     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00738         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(serviceHandle);
00739         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to write ImagePath: %x\n"</span>, status ));
00740         <span class="keywordflow">goto</span> cleanup;
00741     }
00742 
00743     <span class="comment">//</span>
00744     <span class="comment">// Store the type.</span>
00745     <span class="comment">//</span>
00746 
00747     PiWstrToUnicodeString(&amp;string, L<span class="stringliteral">"Type"</span>);
00748     tmpValue = 1;
00749 
00750     ZwSetValueKey(serviceHandle,
00751                   &amp;string,
00752                   TITLE_INDEX_VALUE,
00753                   REG_DWORD,
00754                   &amp;tmpValue,
00755                   <span class="keyword">sizeof</span>(tmpValue)
00756                   );
00757 
00758     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(serviceHandle);
00759 
00760     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00761         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to write Type: %x\n"</span>, status ));
00762     }
00763 
00764 cleanup:
00765 
00766     <span class="keywordflow">return</span> status;
00767 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a239" doxytag="iop.h::IopAllocateErrorLogEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID IopAllocateErrorLogEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>deviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>driverObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>EntrySize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00542">542</a> of file <a class="el" href="../../d5/d5/iosubs_8c-source.html">iosubs.c</a>.
<p>
References <a class="el" href="../../d1/d5/iop_8h-source.html#l00092">_ERROR_LOG_ENTRY::DeviceObject</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00093">_ERROR_LOG_ENTRY::DriverObject</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00045">IO_TYPE_ERROR_LOG</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00082">IOP_MAXIMUM_LOG_ALLOCATION</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00185">IopErrorLogAllocation</a>, <a class="el" href="../../d5/d3/alpha_2splocks_8c-source.html#l00049">IopErrorLogAllocationLock</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00090">_ERROR_LOG_ENTRY::Size</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00089">_ERROR_LOG_ENTRY::Type</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00428">IoAllocateErrorLogEntry()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00506">IoAllocateGenericErrorLogEntry()</a>.
<p>
<pre class="fragment"><div>00547 {
00548     <a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html">PERROR_LOG_ENTRY</a> elEntry;
00549     PVOID returnValue;
00550     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00551     KIRQL oldIrql;
00552     ULONG size;
00553 
00554     <span class="comment">//</span>
00555     <span class="comment">// Make sure the packet is large enough but not too large.</span>
00556     <span class="comment">//</span>
00557 
00558     <span class="keywordflow">if</span> (EntrySize &lt; <span class="keyword">sizeof</span>(IO_ERROR_LOG_PACKET) ||
00559         EntrySize &gt; ERROR_LOG_MAXIMUM_SIZE) {
00560 
00561         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00562     }
00563 
00564     <span class="comment">//</span>
00565     <span class="comment">// Round entry size to a PVOID size boundary.</span>
00566     <span class="comment">//</span>
00567 
00568     EntrySize = (UCHAR) ((EntrySize + <span class="keyword">sizeof</span>(PVOID) - 1) &amp; ~(<span class="keyword">sizeof</span>(PVOID) - 1));
00569 
00570     <span class="comment">//</span>
00571     <span class="comment">// Calculate the size of the entry needed.</span>
00572     <span class="comment">//</span>
00573 
00574     size = <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html">ERROR_LOG_ENTRY</a>) + EntrySize;
00575 
00576     <span class="comment">//</span>
00577     <span class="comment">// Make sure that there are not too many outstanding packets.</span>
00578     <span class="comment">//</span>
00579 
00580     ExAcquireSpinLock(&amp;IopErrorLogAllocationLock, &amp;oldIrql);
00581 
00582     <span class="keywordflow">try</span>{
00583 
00584         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/iodata_8c.html#a22">IopErrorLogAllocation</a> &gt; <a class="code" href="../../d0/d6/iop_8h.html#a1">IOP_MAXIMUM_LOG_ALLOCATION</a>) {
00585 
00586             <span class="comment">//</span>
00587             <span class="comment">// Fail the request.</span>
00588             <span class="comment">//</span>
00589 
00590             <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00591         }
00592 
00593         <span class="comment">//</span>
00594         <span class="comment">// Increase the outstanding allocation.</span>
00595         <span class="comment">//</span>
00596 
00597         <a class="code" href="../../d3/d5/iodata_8c.html#a22">IopErrorLogAllocation</a> += size;
00598 
00599         <span class="comment">//</span>
00600         <span class="comment">// Allocate the packet.</span>
00601         <span class="comment">//</span>
00602 
00603         elEntry = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPool, size, 'rEoI' );
00604 
00605         <span class="keywordflow">if</span> (elEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00606 
00607             <span class="comment">//</span>
00608             <span class="comment">// Drop the allocation and return.</span>
00609             <span class="comment">//</span>
00610 
00611             <a class="code" href="../../d3/d5/iodata_8c.html#a22">IopErrorLogAllocation</a> -= size;
00612 
00613             <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00614         }
00615 
00616         <span class="comment">//</span>
00617         <span class="comment">// Reference the device object and driver object. So they don't</span>
00618         <span class="comment">// go away before the name gets pulled out.</span>
00619         <span class="comment">//</span>
00620 
00621         <span class="keywordflow">if</span> (deviceObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00622 
00623             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( deviceObject );
00624         }
00625 
00626         <span class="keywordflow">if</span> (driverObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00627 
00628             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( driverObject );
00629         }
00630 
00631         <span class="comment">//</span>
00632         <span class="comment">// Initialize the fields.</span>
00633         <span class="comment">//</span>
00634 
00635         RtlZeroMemory(elEntry, size);
00636 
00637         elEntry-&gt;<a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html#o0">Type</a> = <a class="code" href="../../d0/d5/io_8h.html#a10">IO_TYPE_ERROR_LOG</a>;
00638         elEntry-&gt;<a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html#o1">Size</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) size;
00639         elEntry-&gt;<a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html#o3">DeviceObject</a> = deviceObject;
00640         elEntry-&gt;<a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html#o4">DriverObject</a> = driverObject;
00641 
00642         returnValue = elEntry+1;
00643 
00644     } finally {
00645         ExReleaseSpinLock(&amp;IopErrorLogAllocationLock, oldIrql);
00646     }                   
00647 
00648     <span class="keywordflow">return</span> returnValue;
00649 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a148" doxytag="iop.h::IopAllocateIrpCleanup" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopAllocateIrpCleanup           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> EventObject&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l00284">284</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01491">FO_SYNCHRONOUS_IO</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01157">IopReleaseFileObjectLock</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/dir_8c-source.html#l00057">BuildQueryDirectoryIrp()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02256">IopGetFileName()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00975">IopGetSetSecurityObject()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05397">IopQueryXxxInformation()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06326">IopSetEaOrQuotaInformationFile()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08084">IopXxxControlFile()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09835">IoSetInformation()</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00386">NtFlushBuffersFile()</a>, <a class="el" href="../../d2/d4/lock_8c-source.html#l00035">NtLockFile()</a>, <a class="el" href="../../d1/d7/dir_8c-source.html#l00821">NtNotifyChangeDirectoryFile()</a>, <a class="el" href="../../d8/d1/qsea_8c-source.html#l00035">NtQueryEaFile()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00101">NtQueryInformationFile()</a>, <a class="el" href="../../d1/d2/qsquota_8c-source.html#l00035">NtQueryQuotaInformationFile()</a>, <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00037">NtQueryVolumeInformationFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00036">NtReadFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00730">NtReadFileScatter()</a>, <a class="el" href="../../d8/d1/qsea_8c-source.html#l00652">NtSetEaFile()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>, <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00492">NtSetVolumeInformationFile()</a>, <a class="el" href="../../d2/d4/lock_8c-source.html#l00458">NtUnlockFile()</a>, <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00035">NtWriteFile()</a>, and <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00801">NtWriteFileGather()</a>.
<p>
<pre class="fragment"><div>00291                    :
00292 
00293     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked internally by those system services that attempt
00294     to allocate an <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> and fail.  This routine cleans up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object
00295     and any event object that has been references and releases any locks
00296     that were taken <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>.
00297 
00298 Arguments:
00299 
00300     FileObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object being worked on.
00301 
00302     EventObject - Optional pointer to a referenced event to be dereferenced.
00303 
00304 Return Value:
00305 
00306     None.
00307 
00308 --*/
00309 
00310 {
00311     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00312 
00313     <span class="comment">//</span>
00314     <span class="comment">// Begin by dereferencing the event, if one was specified.</span>
00315     <span class="comment">//</span>
00316 
00317     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( EventObject )) {
00318         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( EventObject );
00319     }
00320 
00321     <span class="comment">//</span>
00322     <span class="comment">// Release the synchronization semaphore if it is currently held and</span>
00323     <span class="comment">// dereference the file object.</span>
00324     <span class="comment">//</span>
00325 
00326     <span class="keywordflow">if</span> (FileObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
00327         <a class="code" href="../../d0/d6/iop_8h.html#a22">IopReleaseFileObjectLock</a>( FileObject );
00328     }
00329 
00330     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( FileObject );
00331 
00332     <span class="keywordflow">return</span>;
00333 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a149" doxytag="iop.h::IopAllocateIrpMustSucceed" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> IopAllocateIrpMustSucceed           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN CCHAR&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>StackSize</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l00336">336</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01680">_IRP::AllocationFlags</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00652">IoAllocateIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07444">IoInitializeIrp()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04269">IoSizeOfIrp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01575">IRP_ALLOCATED_MUST_SUCCEED</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12535">IoCancelFileOpen()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00036">IopCloseFile()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00417">IopDeleteFile()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l04282">IopMountVolume()</a>.
<p>
<pre class="fragment"><div>00342                    :
00343 
00344     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to allocate an <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> when there are no appropriate
00345     packets remaining on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> look-aside list, and no memory was available
00346     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> general non-paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>, and yet, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> code <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> requiring <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00347     packet has no way of backing <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> and simply returning an error.  There-
00348     fore, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must allocate an <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>.  Hence, <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to allocate
00349     that packet.
00350 
00351 Arguments:
00352 
00353     StackSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> I/O stack locations that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00354         packet must have when allocated.
00355 
00356 Return Value:
00357 
00358     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet.
00359 
00360 --*/
00361 
00362 {
00363     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00364     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> packetSize;
00365 
00366     <span class="comment">//</span>
00367     <span class="comment">// Attempt to allocate the IRP normally and failing that, allocate the</span>
00368     <span class="comment">// IRP from nonpaged must succeed pool.</span>
00369     <span class="comment">//</span>
00370 
00371     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>(StackSize, FALSE);
00372     <span class="keywordflow">if</span> (!irp) {
00373         packetSize = <a class="code" href="../../d0/d5/io_8h.html#a245">IoSizeOfIrp</a>(StackSize);
00374         irp = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPoolMustSucceed, packetSize, ' prI');
00375         <a class="code" href="../../d4/d6/iosubs_8c.html#a80">IoInitializeIrp</a>(irp, packetSize, StackSize);
00376         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o17">AllocationFlags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a191">IRP_ALLOCATED_MUST_SUCCEED</a>;
00377     }
00378 
00379     <span class="keywordflow">return</span> irp;
00380 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a237" doxytag="iop.h::IopAllocateIrpPrivate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> IopAllocateIrpPrivate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN CCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>StackSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ChargeQuota</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00662">662</a> of file <a class="el" href="../../d5/d5/iosubs_8c-source.html">iosubs.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00729">_GENERAL_LOOKASIDE::AllocateMisses</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01680">_IRP::AllocationFlags</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00265">ExAllocatePoolWithQuotaTag</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d5/d8/ex_8h.html#a242">ExInterlockedPopEntrySList()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00930">IopInitializeIrp</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00112">IopLargeIrpStackLocations</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00546">IopLookasideIrpFloat</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00547">IopLookasideIrpLimit</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04269">IoSizeOfIrp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01576">IRP_ALLOCATED_FIXED_SIZE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01575">IRP_ALLOCATED_MUST_SUCCEED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01577">IRP_LOOKASIDE_ALLOCATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01574">IRP_QUOTA_CHARGED</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00755">_NPAGED_LOOKASIDE_LIST::L</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00724">_GENERAL_LOOKASIDE::ListHead</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00756">_NPAGED_LOOKASIDE_LIST::Lock</a>, <a class="el" href="../../d5/d8/ex_8h.html#a331a198">LookasideLargeIrpList</a>, <a class="el" href="../../d5/d8/ex_8h.html#a331a197">LookasideSmallIrpList</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a108">PP_NPAGED_LOOKASIDE_NUMBER</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00727">_GENERAL_LOOKASIDE::TotalAllocates</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00953">IopSetIoRoutines()</a>, and <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00353">IovAllocateIrp()</a>.
<p>
<pre class="fragment"><div>00669                    :
00670 
00671     This routine allocates an I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system nonpaged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
00672     The packet will be allocated to contain StackSize stack locations.  The <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>
00673     will also be initialized.
00674 
00675 Arguments:
00676 
00677     StackSize - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum number of stack locations required.
00678 
00679     ChargeQuota - Specifies whether quota should be charged against thread.
00680 
00681 Return Value:
00682 
00683     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated/initialized <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>,
00684     or <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> one could not be allocated.
00685 
00686 --*/
00687 
00688 {
00689     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> allocateSize;
00690     UCHAR fixedSize;
00691     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00692     UCHAR lookasideAllocation;
00693     <a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">PNPAGED_LOOKASIDE_LIST</a> lookasideList;
00694     UCHAR mustSucceed;
00695     <a class="code" href="../../d5/d8/ex_8h.html#a108">PP_NPAGED_LOOKASIDE_NUMBER</a> number;
00696     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> packetSize;
00697     PKPRCB prcb;
00698 
00699     <span class="comment">//</span>
00700     <span class="comment">// If the size of the packet required is less than or equal to those on</span>
00701     <span class="comment">// the lookaside lists, then attempt to allocate the packet from the</span>
00702     <span class="comment">// lookaside lists.</span>
00703     <span class="comment">//</span>
00704 
00705     irp = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00706     fixedSize = 0;
00707     mustSucceed = 0;
00708     packetSize = <a class="code" href="../../d0/d5/io_8h.html#a245">IoSizeOfIrp</a>(StackSize);
00709     allocateSize = packetSize;
00710     <span class="keywordflow">if</span> ((StackSize &lt;= (CCHAR)<a class="code" href="../../d8/d0/cmdat3_8c.html#a56">IopLargeIrpStackLocations</a>) &amp;&amp;
00711         ((ChargeQuota == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) || (<a class="code" href="../../d0/d6/iop_8h.html#a130">IopLookasideIrpFloat</a> &lt; <a class="code" href="../../d0/d6/iop_8h.html#a131">IopLookasideIrpLimit</a>))) {
00712         fixedSize = <a class="code" href="../../d0/d5/io_8h.html#a192">IRP_ALLOCATED_FIXED_SIZE</a>;
00713         number = <a class="code" href="../../d5/d8/ex_8h.html#a331a197">LookasideSmallIrpList</a>;
00714         <span class="keywordflow">if</span> (StackSize != 1) {
00715             allocateSize = <a class="code" href="../../d0/d5/io_8h.html#a245">IoSizeOfIrp</a>((CCHAR)IopLargeIrpStackLocations);
00716             number = <a class="code" href="../../d5/d8/ex_8h.html#a331a198">LookasideLargeIrpList</a>;
00717         }
00718 
00719         prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00720         lookasideList = prcb-&gt;PPLookasideList[number].P;
00721         lookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o3">TotalAllocates</a> += 1;
00722         irp = (<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>)<a class="code" href="../../d5/d8/ex_8h.html#a242">ExInterlockedPopEntrySList</a>(&amp;lookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>,
00723                                                &amp;lookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o1">Lock</a>);
00724 
00725         <span class="keywordflow">if</span> (irp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00726             lookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o4">AllocateMisses</a> += 1;
00727             lookasideList = prcb-&gt;PPLookasideList[number].<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>;
00728             lookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o3">TotalAllocates</a> += 1;
00729             irp = (<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>)<a class="code" href="../../d5/d8/ex_8h.html#a242">ExInterlockedPopEntrySList</a>(&amp;lookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>,
00730                                                    &amp;lookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o1">Lock</a>);
00731         }
00732     }
00733 
00734     <span class="comment">//</span>
00735     <span class="comment">// If an IRP was not allocated from the lookaside list, then allocate</span>
00736     <span class="comment">// the packet from nonpaged pool and charge quota if requested.</span>
00737     <span class="comment">//</span>
00738 
00739     lookasideAllocation = 0;
00740     <span class="keywordflow">if</span> (!irp) {
00741         <span class="keywordflow">if</span> (fixedSize != 0) {
00742             lookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o4">AllocateMisses</a> += 1;
00743         }
00744 
00745         <span class="comment">//</span>
00746         <span class="comment">// There are no free packets on the lookaside list, or the packet is</span>
00747         <span class="comment">// too large to be allocated from one of the lists, so it must be</span>
00748         <span class="comment">// allocated from nonpaged pool. If quota is to be charged, charge it</span>
00749         <span class="comment">// against the current process. Otherwise, allocate the pool normally.</span>
00750         <span class="comment">//</span>
00751 
00752         <span class="keywordflow">if</span> (ChargeQuota) {
00753             <span class="keywordflow">try</span> {
00754                 irp = <a class="code" href="../../d5/d8/ex_8h.html#a5">ExAllocatePoolWithQuotaTag</a>(NonPagedPool, allocateSize,' prI');
00755 
00756             } except(EXCEPTION_EXECUTE_HANDLER) {
00757                 NOTHING;
00758             }
00759 
00760         } <span class="keywordflow">else</span> {
00761 
00762             <span class="comment">//</span>
00763             <span class="comment">// Attempt to allocate the pool from non-paged pool.  If this</span>
00764             <span class="comment">// fails, and the caller's previous mode was kernel then allocate</span>
00765             <span class="comment">// the pool as must succeed.</span>
00766             <span class="comment">//</span>
00767 
00768             irp = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPool, allocateSize, ' prI');
00769             <span class="keywordflow">if</span> (!irp) {
00770                 mustSucceed = <a class="code" href="../../d0/d5/io_8h.html#a191">IRP_ALLOCATED_MUST_SUCCEED</a>;
00771                 <span class="keywordflow">if</span> (KeGetPreviousMode() == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> ) {
00772                     irp = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPoolMustSucceed,
00773                                                 allocateSize,
00774                                                 ' prI');
00775                 }
00776             }
00777         }
00778 
00779         <span class="keywordflow">if</span> (!irp) {
00780             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00781         }
00782 
00783     } <span class="keywordflow">else</span> {
00784         <span class="keywordflow">if</span> (ChargeQuota != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00785             lookasideAllocation = <a class="code" href="../../d0/d5/io_8h.html#a193">IRP_LOOKASIDE_ALLOCATION</a>;
00786             InterlockedIncrement( &amp;IopLookasideIrpFloat );
00787         }
00788         ChargeQuota = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00789     }
00790 
00791     <span class="comment">//</span>
00792     <span class="comment">// Initialize the packet.</span>
00793     <span class="comment">//</span>
00794 
00795     <a class="code" href="../../d0/d6/iop_8h.html#a20">IopInitializeIrp</a>(irp, packetSize, StackSize);
00796     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o17">AllocationFlags</a> = (fixedSize | lookasideAllocation | mustSucceed);
00797     <span class="keywordflow">if</span> (ChargeQuota) {
00798         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o17">AllocationFlags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a190">IRP_QUOTA_CHARGED</a>;
00799     }
00800 
00801     <span class="keywordflow">return</span> irp;
00802 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a150" doxytag="iop.h::IopApcHardError" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopApcHardError           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>StartContext</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l00383">383</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05617">IopRaiseHardError()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00120">_IOP_APC_HARD_ERROR_PACKET::Irp</a>, <a class="el" href="../../d0/d6/iop_8h.html#a34">PIOP_APC_HARD_ERROR_PACKET</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00122">_IOP_APC_HARD_ERROR_PACKET::RealDeviceObject</a>, and <a class="el" href="../../d1/d5/iop_8h-source.html#l00121">_IOP_APC_HARD_ERROR_PACKET::Vpb</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l06870">IopStartApcHardError()</a>.
<p>
<pre class="fragment"><div>00389                    :
00390 
00391     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when we need to <span class="keywordflow">do</span> a hard error pop-up, but <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00392     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>'s originating thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> at APC level, ie. <a class="code" href="../../d0/d5/io_8h.html#a524">IoPageRead</a>.  We in a special
00393     purpose thread that will go away when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user responds to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pop-up.
00394 
00395 Arguments:
00396 
00397     StartContext - Startup context, contains a <a class="code" href="../../d5/d0/struct__IOP__APC__HARD__ERROR__PACKET.html">IOP_APC_HARD_ERROR_PACKET</a>.
00398 
00399 Return Value:
00400 
00401     None.
00402 
00403 --*/
00404 
00405 {
00406     <a class="code" href="../../d5/d0/struct__IOP__APC__HARD__ERROR__PACKET.html">PIOP_APC_HARD_ERROR_PACKET</a> packet;
00407 
00408     packet = StartContext;
00409 
00410     <a class="code" href="../../d0/d6/iop_8h.html#a205">IopRaiseHardError</a>( packet-&gt;<a class="code" href="../../d5/d0/struct__IOP__APC__HARD__ERROR__PACKET.html#o1">Irp</a>, packet-&gt;<a class="code" href="../../d5/d0/struct__IOP__APC__HARD__ERROR__PACKET.html#o2">Vpb</a>, packet-&gt;<a class="code" href="../../d5/d0/struct__IOP__APC__HARD__ERROR__PACKET.html#o3">RealDeviceObject</a> );
00411 
00412     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( packet );
00413 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a151" doxytag="iop.h::IopCancelAlertedRequest" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopCancelAlertedRequest           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Event</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l00417">417</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02149">IoCancelIrp()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00253">KeReadStateEvent()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l05397">IopQueryXxxInformation()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06926">IopSynchronousApiServiceTail()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l07030">IopSynchronousServiceTail()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09835">IoSetInformation()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00101">NtQueryInformationFile()</a>, and <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>.
<p>
<pre class="fragment"><div>00424                    :
00425 
00426     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when a synchronous I/O operation that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> blocked in
00427     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O system needs to be canceled because <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread making <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request has
00428     either been alerted because <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> going away or because of a CTRL/C.  This
00429     routine carefully attempts to work its way <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current operation so
00430     that local events or other local data will not be accessed once <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service
00431     being interrupted returns.
00432 
00433 Arguments:
00434 
00435     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> - The address of a kernel event that will be set to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Signaled state
00436         by I/O completion when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> complete.
00437 
00438     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet (<a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>) representing the current request.
00439 
00440 Return Value:
00441 
00442     None.
00443 
00444 --*/
00445 
00446 {
00447     KIRQL irql;
00448     LARGE_INTEGER deltaTime;
00449     BOOLEAN canceled;
00450 
00451     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00452 
00453     <span class="comment">//</span>
00454     <span class="comment">// Begin by blocking special kernel APCs so that the request cannot</span>
00455     <span class="comment">// complete.</span>
00456     <span class="comment">//</span>
00457 
00458     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>( APC_LEVEL, &amp;irql );
00459 
00460     <span class="comment">//</span>
00461     <span class="comment">// Check the state of the event to determine whether or not the</span>
00462     <span class="comment">// packet has already been completed.</span>
00463     <span class="comment">//</span>
00464 
00465     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/eventobj_8c.html#a6">KeReadStateEvent</a>( Event ) == 0) {
00466 
00467         <span class="comment">//</span>
00468         <span class="comment">// The packet has not been completed, so attempt to cancel it.</span>
00469         <span class="comment">//</span>
00470 
00471         canceled = <a class="code" href="../../d4/d6/iosubs_8c.html#a30">IoCancelIrp</a>( Irp );
00472 
00473         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>( irql );
00474 
00475         <span class="keywordflow">if</span> (canceled) {
00476 
00477             <span class="comment">//</span>
00478             <span class="comment">// The packet had a cancel routine, so it was canceled.  Loop,</span>
00479             <span class="comment">// waiting for the packet to complete.  This should occur almost</span>
00480             <span class="comment">// immediately.</span>
00481             <span class="comment">//</span>
00482 
00483             deltaTime.QuadPart = - 10 * 1000 * 10;
00484 
00485             <span class="keywordflow">while</span> (<a class="code" href="../../d2/d8/eventobj_8c.html#a6">KeReadStateEvent</a>( Event ) == 0) {
00486 
00487                 <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a>( KernelMode, FALSE, &amp;deltaTime );
00488 
00489             }
00490 
00491         } <span class="keywordflow">else</span> {
00492 
00493             <span class="comment">//</span>
00494             <span class="comment">// The packet did not have a cancel routine, so simply wait for</span>
00495             <span class="comment">// the event to be set to the Signaled state.  This will save</span>
00496             <span class="comment">// CPU time by not looping, since it is not known when the packet</span>
00497             <span class="comment">// will actually complete.  Note, however, that the cancel flag</span>
00498             <span class="comment">// is set in the packet, so should a driver examine the flag</span>
00499             <span class="comment">// at some point in the future, it will immediately stop</span>
00500             <span class="comment">// processing the request.</span>
00501             <span class="comment">//</span>
00502 
00503             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( Event,
00504                                           Executive,
00505                                           KernelMode,
00506                                           FALSE,
00507                                           (PLARGE_INTEGER) NULL );
00508 
00509         }
00510 
00511     } <span class="keywordflow">else</span> {
00512 
00513         <span class="comment">//</span>
00514         <span class="comment">// The packet has already been completed, so simply lower the</span>
00515         <span class="comment">// IRQL back to its original value and exit.</span>
00516         <span class="comment">//</span>
00517 
00518         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>( irql );
00519 
00520     }
00521 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a152" doxytag="iop.h::IopCheckBackupRestorePrivilege" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopCheckBackupRestorePrivilege           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CreateOptions</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Disposition</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/parse_8c-source.html#l02048">2048</a> of file <a class="el" href="../../d5/d2/parse_8c-source.html">parse.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00085">SE_BACKUP_PRIVILEGES_CHECKED</a>, <a class="el" href="../../d3/d4/seastate_8c-source.html#l00434">SeAppendPrivileges()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01685">SeBackupPrivilege</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00158">SePrivilegeCheck()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01686">SeRestorePrivilege</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00073">TOKEN_HAS_BACKUP_PRIVILEGE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00074">TOKEN_HAS_RESTORE_PRIVILEGE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d5/d2/parse_8c-source.html#l00202">IopParseDevice()</a>.
<p>
<pre class="fragment"><div>02057                    :
02058 
02059     This funcion will determine <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> asking <span class="keywordflow">for</span> any accesses
02060     that may be satisfied by Backup or Restore privileges, and <span class="keywordflow">if</span> so,
02061     perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privilge checks.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privilege checks succeed, then
02062     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate bits will be <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a100">moved</a> <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> RemainingDesiredAccess
02063     field in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AccessState structure and placed into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PreviouslyGrantedAccess
02064     field.
02065 
02066     Note that access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not denied <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller does not have either or
02067     both of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privileges, since he may be granted <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access
02068     via <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
02069 
02070     This routine will also set a flag in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AccessState structure so that
02071     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will not perform these privilege checks again in <span class="keywordflow">case</span> we come through
02072     <span class="keyword">this</span> way again due to a reparse.
02073 
02074 Arguments:
02075 
02076     AccessState - The AccessState containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current state of <span class="keyword">this</span> access
02077         attempt.
02078 
02079     CreateOptions - The CreateOptions field from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d7/struct__OPEN__PACKET.html">OPEN_PACKET</a> structure <span class="keywordflow">for</span>
02080         <span class="keyword">this</span> open attempt.
02081 
02082     PreviousMode - The processor mode to be used in checking parameters.
02083 
02084     Disposition - The create disposition <span class="keywordflow">for</span> <span class="keyword">this</span> request.
02085 
02086 Return Value:
02087 
02088     None.
02089 
02090 --*/
02091 
02092 {
02093     ACCESS_MASK desiredAccess;
02094     ACCESS_MASK readAccess;
02095     ACCESS_MASK writeAccess;
02096     PRIVILEGE_SET requiredPrivileges;
02097     BOOLEAN accessGranted;
02098     BOOLEAN keepBackupIntent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02099     BOOLEAN ForceRestoreCheck = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02100 
02101     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02102 
02103     <span class="comment">//</span>
02104     <span class="comment">// Check to determine whether or not this check has already been made.</span>
02105     <span class="comment">// If so, simply return back to the caller.</span>
02106     <span class="comment">//</span>
02107 
02108     <span class="keywordflow">if</span> (AccessState-&gt;Flags &amp; <a class="code" href="../../d0/d5/se_8h.html#a6">SE_BACKUP_PRIVILEGES_CHECKED</a>) {
02109         <span class="keywordflow">return</span>;
02110     }
02111 
02112     <span class="keywordflow">if</span> (*CreateOptions &amp; FILE_OPEN_FOR_BACKUP_INTENT) {
02113         AccessState-&gt;Flags |= <a class="code" href="../../d0/d5/se_8h.html#a6">SE_BACKUP_PRIVILEGES_CHECKED</a>;
02114 
02115         readAccess = READ_CONTROL | ACCESS_SYSTEM_SECURITY | FILE_GENERIC_READ | FILE_TRAVERSE;
02116         writeAccess = WRITE_DAC | WRITE_OWNER | ACCESS_SYSTEM_SECURITY | FILE_GENERIC_WRITE | FILE_ADD_FILE | FILE_ADD_SUBDIRECTORY | DELETE;
02117 
02118         desiredAccess = AccessState-&gt;RemainingDesiredAccess;
02119 
02120         <span class="comment">//</span>
02121         <span class="comment">// If the caller has requested MAXIMUM_ALLOWED, then make it appear as</span>
02122         <span class="comment">// if the request was for everything permitted by Backup and Restore,</span>
02123         <span class="comment">// and then grant everything that can actually be granted.</span>
02124         <span class="comment">//</span>
02125 
02126         <span class="keywordflow">if</span> (desiredAccess &amp; MAXIMUM_ALLOWED) {
02127             desiredAccess |= ( readAccess | writeAccess );
02128         }
02129 
02130         <span class="comment">//</span>
02131         <span class="comment">// If the disposition says that we're opening the file, check for both backup</span>
02132         <span class="comment">// and restore privilege, depending on what's in the desired access.</span>
02133         <span class="comment">//</span>
02134         <span class="comment">// If the disposition says that we're creating or trying to overwrite the file,</span>
02135         <span class="comment">// then all we need to do is to check for restore privilege, and if it's there,</span>
02136         <span class="comment">// grant every possible access.</span>
02137         <span class="comment">//</span>
02138 
02139         <span class="keywordflow">if</span> ( Disposition &amp; FILE_OPEN ) {
02140 
02141             <span class="comment">//</span>
02142             <span class="comment">// If the request was for any of the bits in the read access mask, then</span>
02143             <span class="comment">// assume that this is a backup operation, and check for the Backup</span>
02144             <span class="comment">// privielege.  If the caller has it, then grant the intersection of</span>
02145             <span class="comment">// the desired access and read access masks.</span>
02146             <span class="comment">//</span>
02147 
02148             <span class="keywordflow">if</span> (readAccess &amp; desiredAccess) {
02149 
02150                 requiredPrivileges.PrivilegeCount = 1;
02151                 requiredPrivileges.Control = PRIVILEGE_SET_ALL_NECESSARY;
02152                 requiredPrivileges.Privilege[0].Luid = <a class="code" href="../../d0/d5/se_8h.html#a94">SeBackupPrivilege</a>;
02153                 requiredPrivileges.Privilege[0].Attributes = 0;
02154 
02155                 accessGranted = <a class="code" href="../../d8/d4/privileg_8c.html#a1">SePrivilegeCheck</a>( &amp;requiredPrivileges,
02156                                                   &amp;AccessState-&gt;SubjectSecurityContext,
02157                                                   PreviousMode );
02158 
02159                 <span class="keywordflow">if</span> (accessGranted) {
02160 
02161                     <span class="comment">//</span>
02162                     <span class="comment">// The caller has Backup privilege, so grant the appropriate</span>
02163                     <span class="comment">// accesses.</span>
02164                     <span class="comment">//</span>
02165 
02166                     keepBackupIntent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02167                     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d2/d5/seastate_8c.html#a5">SeAppendPrivileges</a>( AccessState, &amp;requiredPrivileges );
02168                     AccessState-&gt;PreviouslyGrantedAccess |= ( desiredAccess &amp; readAccess );
02169                     AccessState-&gt;RemainingDesiredAccess &amp;= ~readAccess;
02170                     desiredAccess &amp;= ~readAccess;
02171                     AccessState-&gt;Flags |= <a class="code" href="../../d0/d5/se_8h.html#a2">TOKEN_HAS_BACKUP_PRIVILEGE</a>;
02172                 }
02173             }
02174 
02175         } <span class="keywordflow">else</span> {
02176 
02177             ForceRestoreCheck = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02178         }
02179 
02180         <span class="comment">//</span>
02181         <span class="comment">// If the request was for any of the bits in the write access mask, then</span>
02182         <span class="comment">// assume that this is a restore operation, so check for the Restore</span>
02183         <span class="comment">// privilege.  If the caller has it, then grant the intersection of</span>
02184         <span class="comment">// the desired access and write access masks.</span>
02185         <span class="comment">//</span>
02186 
02187         <span class="keywordflow">if</span> ((writeAccess &amp; desiredAccess) || ForceRestoreCheck) {
02188 
02189             requiredPrivileges.PrivilegeCount = 1;
02190             requiredPrivileges.Control = PRIVILEGE_SET_ALL_NECESSARY;
02191             requiredPrivileges.Privilege[0].Luid = <a class="code" href="../../d0/d5/se_8h.html#a95">SeRestorePrivilege</a>;
02192             requiredPrivileges.Privilege[0].Attributes = 0;
02193 
02194             accessGranted = <a class="code" href="../../d8/d4/privileg_8c.html#a1">SePrivilegeCheck</a>( &amp;requiredPrivileges,
02195                                               &amp;AccessState-&gt;SubjectSecurityContext,
02196                                               PreviousMode );
02197 
02198             <span class="keywordflow">if</span> (accessGranted) {
02199 
02200                 <span class="comment">//</span>
02201                 <span class="comment">// The caller has Restore privilege, so grant the appropriate</span>
02202                 <span class="comment">// accesses.</span>
02203                 <span class="comment">//</span>
02204 
02205                 keepBackupIntent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02206                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d2/d5/seastate_8c.html#a5">SeAppendPrivileges</a>( AccessState, &amp;requiredPrivileges );
02207                 AccessState-&gt;PreviouslyGrantedAccess |= (desiredAccess &amp; writeAccess);
02208                 AccessState-&gt;RemainingDesiredAccess &amp;= ~writeAccess;
02209                 AccessState-&gt;Flags |= <a class="code" href="../../d0/d5/se_8h.html#a3">TOKEN_HAS_RESTORE_PRIVILEGE</a>;
02210             }
02211         }
02212 
02213         <span class="comment">//</span>
02214         <span class="comment">// If either of the access types was granted because the caller had</span>
02215         <span class="comment">// backup or restore privilege, then the backup intent flag is kept.</span>
02216         <span class="comment">// Otherwise, it is cleared so that it is not passed onto the driver</span>
02217         <span class="comment">// so that it is not incorrectly propogated anywhere else, since this</span>
02218         <span class="comment">// caller does not actually have the privilege enabled.</span>
02219         <span class="comment">//</span>
02220 
02221         <span class="keywordflow">if</span> (!keepBackupIntent) {
02222             *CreateOptions &amp;= ~FILE_OPEN_FOR_BACKUP_INTENT;
02223         }
02224     }
02225 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a153" doxytag="iop.h::IopCheckGetQuotaBufferValidity" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopCheckGetQuotaBufferValidity           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PFILE_GET_QUOTA_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>QuotaBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>QuotaLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>ErrorOffset</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l00524">524</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d2/d4/internal_8c.html#a1">GET_OFFSET_LENGTH</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01350">RtlLengthSid()</a>, and <a class="el" href="../../d9/d5/sertl_8c-source.html#l00810">RtlValidSid()</a>.
<p>
Referenced by <a class="el" href="../../d1/d2/qsquota_8c-source.html#l00035">NtQueryQuotaInformationFile()</a>.
<p>
<pre class="fragment"><div>00532                    :
00533 
00534     This routine checks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> validity of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified get quota buffer to
00535     guarantee that its <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> proper, no fields hang over, that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00536     not recursive, etc.
00537 
00538 Arguments:
00539 
00540     QuotaBuffer - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> get quota structure
00541         array to be checked.
00542 
00543     QuotaLength - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota buffer.
00544 
00545     ErrorOffset - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offending entry
00546         in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota buffer <span class="keywordflow">if</span> an error <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> incurred.  This variable <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>
00547         valid <span class="keywordflow">if</span> an error occurs.
00548 
00549 Return Value:
00550 
00551     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> STATUS_SUCCESS <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> get quota buffer contains a
00552     valid, properly formed list, otherwise STATUS_QUOTA_LIST_INCONSISTENT.
00553 
00554 --*/
00555 
00556 {
00557 
00558 <span class="preprocessor">#define GET_OFFSET_LENGTH( CurrentSid, SidBase ) ( (ULONG) ((PCHAR) CurrentSid - (PCHAR) SidBase) )</span>
00559 <span class="preprocessor"></span>
00560     LONG tempLength;
00561     LONG entrySize;
00562     PFILE_GET_QUOTA_INFORMATION sids;
00563 
00564     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00565 
00566     <span class="comment">//</span>
00567     <span class="comment">// Walk the buffer and ensure that its format is valid.  That is, ensure</span>
00568     <span class="comment">// that it does not walk off the end of the buffer, is not recursive, etc.</span>
00569     <span class="comment">//</span>
00570 
00571     sids = QuotaBuffer;
00572     tempLength = QuotaLength;
00573 
00574     <span class="keywordflow">for</span> (;;) {
00575 
00576         <span class="comment">//</span>
00577         <span class="comment">// Ensure that the current entry is valid.</span>
00578         <span class="comment">//</span>
00579 
00580         <span class="keywordflow">if</span> ((tempLength &lt; (LONG) (FIELD_OFFSET(FILE_GET_QUOTA_INFORMATION, Sid.SubAuthority) +
00581                                   <span class="keyword">sizeof</span> (sids-&gt;Sid.SubAuthority))) ||
00582             !<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( &amp;sids-&gt;Sid)) {
00583 
00584             *ErrorOffset = <a class="code" href="../../d2/d4/internal_8c.html#a1">GET_OFFSET_LENGTH</a>( sids, QuotaBuffer );
00585             <span class="keywordflow">return</span> STATUS_QUOTA_LIST_INCONSISTENT;
00586         }
00587 
00588         <span class="comment">//</span>
00589         <span class="comment">// Get the size of the current entry in the buffer.</span>
00590         <span class="comment">//</span>
00591 
00592         entrySize = FIELD_OFFSET( FILE_GET_QUOTA_INFORMATION, Sid ) + <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>( (&amp;sids-&gt;Sid) );
00593 
00594         <span class="keywordflow">if</span> (sids-&gt;NextEntryOffset) {
00595 
00596             <span class="comment">//</span>
00597             <span class="comment">// There is another entry in the buffer and it must be longword</span>
00598             <span class="comment">// aligned.  Ensure that the offset indicates that it is.  If it</span>
00599             <span class="comment">// isn't, return an invalid parameter status.</span>
00600             <span class="comment">//</span>
00601 
00602             <span class="keywordflow">if</span> (entrySize &gt; (LONG) sids-&gt;NextEntryOffset ||
00603                 sids-&gt;NextEntryOffset &amp; (<span class="keyword">sizeof</span>( ULONG ) - 1)) {
00604                 *ErrorOffset = <a class="code" href="../../d2/d4/internal_8c.html#a1">GET_OFFSET_LENGTH</a>( sids, QuotaBuffer );
00605                 <span class="keywordflow">return</span> STATUS_QUOTA_LIST_INCONSISTENT;
00606 
00607             } <span class="keywordflow">else</span> {
00608 
00609                 <span class="comment">//</span>
00610                 <span class="comment">// There is another entry in the buffer, so account for the</span>
00611                 <span class="comment">// size of the current entry in the length and get a pointer</span>
00612                 <span class="comment">// to the next entry.</span>
00613                 <span class="comment">//</span>
00614 
00615                 tempLength -= sids-&gt;NextEntryOffset;
00616                 <span class="keywordflow">if</span> (tempLength &lt; 0) {
00617                     *ErrorOffset = <a class="code" href="../../d2/d4/internal_8c.html#a1">GET_OFFSET_LENGTH</a>( sids, QuotaBuffer );
00618                     <span class="keywordflow">return</span> STATUS_QUOTA_LIST_INCONSISTENT;
00619                 }
00620                 sids = (PFILE_GET_QUOTA_INFORMATION) ((PCHAR) sids + sids-&gt;NextEntryOffset);
00621             }
00622 
00623         } <span class="keywordflow">else</span> {
00624 
00625             <span class="comment">//</span>
00626             <span class="comment">// There are no other entries in the buffer.  Simply account for</span>
00627             <span class="comment">// the overall buffer length according to the size of the current</span>
00628             <span class="comment">// entry and exit the loop.</span>
00629             <span class="comment">//</span>
00630 
00631             tempLength -= entrySize;
00632             <span class="keywordflow">break</span>;
00633         }
00634     }
00635 
00636     <span class="comment">//</span>
00637     <span class="comment">// All of the entries in the buffer have been processed.  Check to see</span>
00638     <span class="comment">// whether the overall buffer length went negative.  If so, return an</span>
00639     <span class="comment">// error.</span>
00640     <span class="comment">//</span>
00641 
00642     <span class="keywordflow">if</span> (tempLength &lt; 0) {
00643         *ErrorOffset = <a class="code" href="../../d2/d4/internal_8c.html#a1">GET_OFFSET_LENGTH</a>( sids, QuotaBuffer );
00644         <span class="keywordflow">return</span> STATUS_QUOTA_LIST_INCONSISTENT;
00645     }
00646 
00647     <span class="comment">//</span>
00648     <span class="comment">// The format of the get quota buffer was correct, so simply return a</span>
00649     <span class="comment">// success status code.</span>
00650     <span class="comment">//</span>
00651 
00652     <span class="keywordflow">return</span> STATUS_SUCCESS;
00653 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a154" doxytag="iop.h::IopCloseFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopCloseFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>GrantedAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandleCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemHandleCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/objsup_8c-source.html#l00036">36</a> of file <a class="el" href="../../d4/d0/objsup_8c-source.html">objsup.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01517">_FILE_OBJECT::DeviceObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01540">_FILE_OBJECT::Event</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01403">_DRIVER_OBJECT::FastIoDispatch</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00950">_FAST_IO_DISPATCH::FastIoUnlockAll</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01533">_FILE_OBJECT::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01501">FO_DIRECT_DEVICE_OPEN</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01508">FO_HANDLE_CREATED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01491">FO_SYNCHRONOUS_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06632">IoFreeIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06786">IoGetAttachedDevice()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00595">IopAcquireFastLock</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00181">IopAcquireFileObjectLock()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00336">IopAllocateIrpMustSucceed()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00758">IopDequeueThreadIrp</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01103">IopQueueThreadIrp</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01157">IopReleaseFileObjectLock</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12345">IopUpdateOtherOperationCount()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01561">IRP_CLOSE_OPERATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00073">IRP_MJ_CLEANUP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00072">IRP_MJ_LOCK_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00125">IRP_MN_UNLOCK_ALL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01552">IRP_SYNCHRONOUS_API</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01525">_FILE_OBJECT::LockOperation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o24">_IRP::Overlay</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01641">_IRP::RequestorMode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>, <a class="el" href="../../d4/d9/ke_8h.html#a407a204">UserRequest</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01936">IopCreateObjectTypes()</a>, and <a class="el" href="../../d4/d0/objsup_8c-source.html#l00417">IopDeleteFile()</a>.
<p>
<pre class="fragment"><div>00046                    :
00047 
00048     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked whenever a handle to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> deleted.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00049     handle being deleted <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a9">file</a> (the ProcessHandleCount
00050     parameter is one), then all locks <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> owned by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00051     process must be released.
00052 
00053     Likewise, <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SystemHandleCount <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> one then <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last handle
00054     <span class="keywordflow">for</span> <span class="keyword">this</span> <span class="keywordflow">for</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object across all processes.  For <span class="keyword">this</span> <span class="keywordflow">case</span>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
00055     system <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> notified so that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can perform any necessary cleanup on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00056     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00057 
00058 Arguments:
00059 
00060     Process - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process that closed <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle.
00061 
00062     Object - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle referenced.
00063 
00064     GrantedAccess - Access that was granted to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle.
00065 
00066     ProcessHandleCount - <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> of handles outstanding to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00067         process specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Process argument.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> count <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> one
00068         then <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last handle to <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> by that process.
00069 
00070     SystemHandleCount - <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> of handles outstanding to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00071         entire system.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> count <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> one then <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last handle
00072         to <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system.
00073 
00074 Return Value:
00075 
00076     None.
00077 
00078 --*/
00079 
00080 {
00081     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00082     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00083     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00084     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> fastIoDispatch;
00085     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00086     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
00087     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
00088     KIRQL irql;
00089 
00090     UNREFERENCED_PARAMETER( Process );
00091     UNREFERENCED_PARAMETER( GrantedAccess );
00092 
00093     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00094 
00095     <span class="comment">//</span>
00096     <span class="comment">// If the handle count is not one then this is not the last close of</span>
00097     <span class="comment">// this file for the specified process so there is nothing to do.</span>
00098     <span class="comment">//</span>
00099 
00100     <span class="keywordflow">if</span> (ProcessHandleCount != 1) {
00101         <span class="keywordflow">return</span>;
00102     }
00103 
00104     fileObject = (<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>) Object;
00105 
00106     <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o10">LockOperation</a> &amp;&amp; SystemHandleCount != 1) {
00107 
00108         IO_STATUS_BLOCK localIoStatus;
00109 
00110         <span class="comment">//</span>
00111         <span class="comment">// This is the last handle for the specified process and the process</span>
00112         <span class="comment">// called the NtLockFile or NtUnlockFile system services at least once.</span>
00113         <span class="comment">// Also, this is not the last handle for this file object system-wide</span>
00114         <span class="comment">// so unlock all of the pending locks for this process.  Note that</span>
00115         <span class="comment">// this check causes an optimization so that if this is the last</span>
00116         <span class="comment">// system-wide handle to this file object the cleanup code will take</span>
00117         <span class="comment">// care of releasing any locks on the file rather than having to</span>
00118         <span class="comment">// send the file system two different packets to get them shut down.</span>
00119 
00120         <span class="comment">//</span>
00121         <span class="comment">// Get the address of the target device object and the Fast I/O dispatch</span>
00122         <span class="comment">//</span>
00123 
00124         <span class="keywordflow">if</span> (!(fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a161">FO_DIRECT_DEVICE_OPEN</a>)) {
00125             deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( fileObject );
00126         } <span class="keywordflow">else</span> {
00127             deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a66">IoGetAttachedDevice</a>( fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a> );
00128         }
00129         fastIoDispatch = deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
00130 
00131         <span class="comment">//</span>
00132         <span class="comment">// If this file is open for synchronous I/O, wait until this thread</span>
00133         <span class="comment">// owns it exclusively since there may still be a thread using it.</span>
00134         <span class="comment">// This occurs when a system service owns the file because it owns</span>
00135         <span class="comment">// the semaphore, but the I/O completion code has already dereferenced</span>
00136         <span class="comment">// the file object itself.  Without waiting here for the same semaphore</span>
00137         <span class="comment">// there would be a race condition in the service who owns it now. The</span>
00138         <span class="comment">// service needs to be able to access the object w/o it going away after</span>
00139         <span class="comment">// its wait for the file event is satisfied.</span>
00140         <span class="comment">//</span>
00141 
00142         <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
00143 
00144             BOOLEAN interrupted;
00145 
00146             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a13">IopAcquireFastLock</a>( fileObject )) {
00147                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d0/d6/iop_8h.html#a147">IopAcquireFileObjectLock</a>( fileObject,
00148                                                  KernelMode,
00149                                                  FALSE,
00150                                                  &amp;interrupted );
00151             }
00152         }
00153 
00154         <span class="comment">//</span>
00155         <span class="comment">// Turbo unlock support.  If the fast Io Dispatch specifies a fast lock</span>
00156         <span class="comment">// routine then we'll first try and calling it with the specified lock</span>
00157         <span class="comment">// parameters.  If this is all successful then we do not need to do</span>
00158         <span class="comment">// the Irp based unlock all call.</span>
00159         <span class="comment">//</span>
00160 
00161         <span class="keywordflow">if</span> (fastIoDispatch &amp;&amp;
00162             fastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o8">FastIoUnlockAll</a> &amp;&amp;
00163             fastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o8">FastIoUnlockAll</a>( fileObject,
00164                                              <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(),
00165                                              &amp;localIoStatus,
00166                                              deviceObject )) {
00167 
00168             NOTHING;
00169 
00170         } <span class="keywordflow">else</span> {
00171 
00172             <span class="comment">//</span>
00173             <span class="comment">// Initialize the local event that will be used to synchronize access</span>
00174             <span class="comment">// to the driver completing this I/O operation.</span>
00175             <span class="comment">//</span>
00176 
00177             <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event, SynchronizationEvent, FALSE );
00178 
00179             <span class="comment">//</span>
00180             <span class="comment">// Reset the event in the file object.</span>
00181             <span class="comment">//</span>
00182 
00183             <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a> );
00184 
00185             <span class="comment">//</span>
00186             <span class="comment">// Allocate and initialize the I/O Request Packet (IRP) for this</span>
00187             <span class="comment">// operation.</span>
00188             <span class="comment">//</span>
00189 
00190             irp = <a class="code" href="../../d0/d6/iop_8h.html#a149">IopAllocateIrpMustSucceed</a>( deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a> );
00191             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = fileObject;
00192             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00193             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
00194 
00195             <span class="comment">//</span>
00196             <span class="comment">// Fill in the service independent parameters in the IRP.</span>
00197             <span class="comment">//</span>
00198 
00199             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = &amp;event;
00200             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>;
00201             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>;
00202             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine = (PIO_APC_ROUTINE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00203 
00204             <span class="comment">//</span>
00205             <span class="comment">// Get a pointer to the stack location for the first driver.  This will</span>
00206             <span class="comment">// be used to pass the original function codes and parameters.  No</span>
00207             <span class="comment">// function-specific parameters are required for this operation.</span>
00208             <span class="comment">//</span>
00209 
00210             irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
00211             irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a30">IRP_MJ_LOCK_CONTROL</a>;
00212             irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a54">IRP_MN_UNLOCK_ALL</a>;
00213             irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = fileObject;
00214 
00215             <span class="comment">//</span>
00216             <span class="comment">//  Reference the fileobject again for the IRP (cleared on completion)</span>
00217             <span class="comment">//</span>
00218 
00219             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( fileObject );
00220 
00221             <span class="comment">//</span>
00222             <span class="comment">// Insert the packet at the head of the IRP list for the thread.</span>
00223             <span class="comment">//</span>
00224 
00225             <a class="code" href="../../d0/d6/iop_8h.html#a21">IopQueueThreadIrp</a>( irp );
00226 
00227             <span class="comment">//</span>
00228             <span class="comment">// Invoke the driver at its appropriate dispatch entry with the IRP.</span>
00229             <span class="comment">//</span>
00230 
00231             status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject, irp );
00232 
00233             <span class="comment">//</span>
00234             <span class="comment">// If no error was incurred, wait for the I/O operation to complete.</span>
00235             <span class="comment">//</span>
00236 
00237             <span class="keywordflow">if</span> (status == STATUS_PENDING) {
00238                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
00239                                               UserRequest,
00240                                               KernelMode,
00241                                               FALSE,
00242                                               (PLARGE_INTEGER) NULL );
00243             }
00244         }
00245 
00246         <span class="comment">//</span>
00247         <span class="comment">// If this operation was a synchronous I/O operation, release the</span>
00248         <span class="comment">// semaphore so that the file can be used by other threads.</span>
00249         <span class="comment">//</span>
00250 
00251         <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
00252             <a class="code" href="../../d0/d6/iop_8h.html#a22">IopReleaseFileObjectLock</a>( fileObject );
00253         }
00254     }
00255 
00256     <span class="keywordflow">if</span> (SystemHandleCount == 1) {
00257 
00258         <span class="comment">//</span>
00259         <span class="comment">// The last handle to this file object for all of the processes in the</span>
00260         <span class="comment">// system has just been closed, so invoke the driver's "cleanup" handler</span>
00261         <span class="comment">// for this file.  This is the file system's opportunity to remove any</span>
00262         <span class="comment">// share access information for the file, to indicate that if the file</span>
00263         <span class="comment">// is opened for a caching operation and this is the last file object</span>
00264         <span class="comment">// to the file, then it can do whatever it needs with memory management</span>
00265         <span class="comment">// to cleanup any information.</span>
00266         <span class="comment">//</span>
00267         <span class="comment">// Begin by getting the address of the target device object.</span>
00268         <span class="comment">//</span>
00269 
00270         <span class="keywordflow">if</span> (!(fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a161">FO_DIRECT_DEVICE_OPEN</a>)) {
00271             deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( fileObject );
00272         } <span class="keywordflow">else</span> {
00273             deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a66">IoGetAttachedDevice</a>( fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a> );
00274         }
00275 
00276         <span class="comment">//</span>
00277         <span class="comment">// Ensure that the I/O system believes that this file has a handle</span>
00278         <span class="comment">// associated with it in case it doesn't actually get one from the</span>
00279         <span class="comment">// Object Manager.  This is done because sometimes the Object Manager</span>
00280         <span class="comment">// actually creates a handle, but the I/O system never finds out</span>
00281         <span class="comment">// about it so it attempts to send two cleanups for the same file.</span>
00282         <span class="comment">//</span>
00283 
00284         fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a168">FO_HANDLE_CREATED</a>;
00285 
00286         <span class="comment">//</span>
00287         <span class="comment">// If this file is open for synchronous I/O, wait until this thread</span>
00288         <span class="comment">// owns it exclusively since there may still be a thread using it.</span>
00289         <span class="comment">// This occurs when a system service owns the file because it owns</span>
00290         <span class="comment">// the semaphore, but the I/O completion code has already dereferenced</span>
00291         <span class="comment">// the file object itself.  Without waiting here for the same semaphore</span>
00292         <span class="comment">// there would be a race condition in the service who owns it now. The</span>
00293         <span class="comment">// service needs to be able to access the object w/o it going away after</span>
00294         <span class="comment">// its wait for the file event is satisfied.</span>
00295         <span class="comment">//</span>
00296 
00297         <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
00298 
00299             BOOLEAN interrupted;
00300 
00301             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a13">IopAcquireFastLock</a>( fileObject )) {
00302                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d0/d6/iop_8h.html#a147">IopAcquireFileObjectLock</a>( fileObject,
00303                                                  KernelMode,
00304                                                  FALSE,
00305                                                  &amp;interrupted );
00306             }
00307         }
00308 
00309         <span class="comment">//</span>
00310         <span class="comment">// Initialize the local event that will be used to synchronize access</span>
00311         <span class="comment">// to the driver completing this I/O operation.</span>
00312         <span class="comment">//</span>
00313 
00314         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event, SynchronizationEvent, FALSE );
00315 
00316         <span class="comment">//</span>
00317         <span class="comment">// Reset the event in the file object.</span>
00318         <span class="comment">//</span>
00319 
00320         <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a> );
00321 
00322         <span class="comment">//</span>
00323         <span class="comment">// Allocate and initialize the I/O Request Packet (IRP) for this</span>
00324         <span class="comment">// operation.</span>
00325         <span class="comment">//</span>
00326 
00327         irp = <a class="code" href="../../d0/d6/iop_8h.html#a149">IopAllocateIrpMustSucceed</a>( deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a> );
00328         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = fileObject;
00329         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00330         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
00331 
00332         <span class="comment">//</span>
00333         <span class="comment">// Fill in the service independent parameters in the IRP.</span>
00334         <span class="comment">//</span>
00335 
00336         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = &amp;event;
00337         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>;
00338         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine = (PIO_APC_ROUTINE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00339         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a> | <a class="code" href="../../d0/d5/io_8h.html#a185">IRP_CLOSE_OPERATION</a>;
00340 
00341         <span class="comment">//</span>
00342         <span class="comment">// Get a pointer to the stack location for the first driver.  This will</span>
00343         <span class="comment">// be used to pass the original function codes and parameters.  No</span>
00344         <span class="comment">// function-specific parameters are required for this operation.</span>
00345         <span class="comment">//</span>
00346 
00347         irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
00348         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a31">IRP_MJ_CLEANUP</a>;
00349         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = fileObject;
00350 
00351         <span class="comment">//</span>
00352         <span class="comment">// Insert the packet at the head of the IRP list for the thread.</span>
00353         <span class="comment">//</span>
00354 
00355         <a class="code" href="../../d0/d6/iop_8h.html#a21">IopQueueThreadIrp</a>( irp );
00356 
00357         <span class="comment">//</span>
00358         <span class="comment">// Update the operation count statistic for the current process for</span>
00359         <span class="comment">// operations other than read and write.</span>
00360         <span class="comment">//</span>
00361 
00362         <a class="code" href="../../d4/d6/iosubs_8c.html#a129">IopUpdateOtherOperationCount</a>();
00363 
00364         <span class="comment">//</span>
00365         <span class="comment">// Invoke the driver at its appropriate dispatch entry with the IRP.</span>
00366         <span class="comment">//</span>
00367 
00368         status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject, irp );
00369 
00370         <span class="comment">//</span>
00371         <span class="comment">// If no error was incurred, wait for the I/O operation to complete.</span>
00372         <span class="comment">//</span>
00373 
00374         <span class="keywordflow">if</span> (status == STATUS_PENDING) {
00375             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
00376                                           UserRequest,
00377                                           KernelMode,
00378                                           FALSE,
00379                                           (PLARGE_INTEGER) NULL );
00380         }
00381 
00382         <span class="comment">//</span>
00383         <span class="comment">// The following code tears down the IRP by hand since it may not</span>
00384         <span class="comment">// either be possible to it to be completed (because this code was</span>
00385         <span class="comment">// invoked as APC_LEVEL in the first place - or because the reference</span>
00386         <span class="comment">// count on the object cannot be incremented due to this routine</span>
00387         <span class="comment">// being invoked by the delete file procedure below).  Cleanup IRPs</span>
00388         <span class="comment">// therefore use close sematics (the close operation flag is set</span>
00389         <span class="comment">// in the IRP) so that the I/O complete request routine itself sets</span>
00390         <span class="comment">// the event to the Signaled state.</span>
00391         <span class="comment">//</span>
00392 
00393         <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>( APC_LEVEL, &amp;irql );
00394         <a class="code" href="../../d0/d6/iop_8h.html#a18">IopDequeueThreadIrp</a>( irp );
00395         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>( irql );
00396 
00397         <span class="comment">//</span>
00398         <span class="comment">// Also, free the IRP.</span>
00399         <span class="comment">//</span>
00400 
00401         <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>( irp );
00402 
00403         <span class="comment">//</span>
00404         <span class="comment">// If this operation was a synchronous I/O operation, release the</span>
00405         <span class="comment">// semaphore so that the file can be used by other threads.</span>
00406         <span class="comment">//</span>
00407 
00408         <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
00409             <a class="code" href="../../d0/d6/iop_8h.html#a22">IopReleaseFileObjectLock</a>( fileObject );
00410         }
00411     }
00412 
00413     <span class="keywordflow">return</span>;
00414 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a156" doxytag="iop.h::IopCompletePageWrite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopCompletePageWrite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Apc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l00919">919</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06632">IoFreeIrp()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00048">NT_ERROR</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o24">_IRP::Overlay</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01648">_IRP::PendingReturned</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>.
<p>
<pre class="fragment"><div>00929                    :
00930 
00931     This routine executes as a special kernel APC routine in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of
00932     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Modified Page <a class="code" href="../../d4/d0/tex_8c.html#a44">Writer</a> (MPW) system thread when an out-page operation
00933     has completed.
00934 
00935     This routine performs the following tasks:
00936 
00937         o   The I/O status is copied.
00938 
00939         o   The Modified Page Writer's APC routine is invoked.
00940 
00941 Arguments:
00942 
00943     Apc - Supplies a pointer to kernel APC structure.
00944 
00945     NormalRoutine - Supplies a pointer to a pointer to the normal function
00946         that was specified when the APC was initialized.
00947 
00948     NormalContext - Supplies a pointer to a pointer to an arbitrary data
00949         structure that was specified when the APC was initialized.
00950 
00951     SystemArgument1 - Supplies a pointer to an argument that contains an
00952         argument that is unused by this routine.
00953 
00954     SystemArgument2 - Supplies a pointer to an argument that contains an
00955         argument that is unused by this routine.
00956 
00957 Return Value:
00958 
00959     None.
00960 
00961 --*/
00962 
00963 {
00964     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00965     PIO_APC_ROUTINE apcRoutine;
00966     PVOID apcContext;
00967     PIO_STATUS_BLOCK ioStatus;
00968 
00969     UNREFERENCED_PARAMETER( NormalRoutine );
00970     UNREFERENCED_PARAMETER( NormalContext );
00971     UNREFERENCED_PARAMETER( SystemArgument1 );
00972     UNREFERENCED_PARAMETER( SystemArgument2 );
00973 
00974     <span class="comment">//</span>
00975     <span class="comment">// Begin by getting the address of the I/O Request Packet from the APC.</span>
00976     <span class="comment">//</span>
00977 
00978     irp = CONTAINING_RECORD( Apc, <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>, Tail.Apc );
00979 
00980     <span class="comment">//</span>
00981     <span class="comment">// If this I/O operation did not complete successfully through the</span>
00982     <span class="comment">// dispatch routine of the driver, then drop everything on the floor</span>
00983     <span class="comment">// now and return to the original call point in the MPW.</span>
00984     <span class="comment">//</span>
00985 
00986     <span class="keywordflow">if</span> (!irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o11">PendingReturned</a> &amp;&amp; <a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status )) {
00987         <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>( irp );
00988         <span class="keywordflow">return</span>;
00989     }
00990 
00991     <span class="comment">//</span>
00992     <span class="comment">// Copy the I/O status from the IRP into the caller's I/O status block.</span>
00993     <span class="comment">//</span>
00994 
00995     *irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>;
00996 
00997     <span class="comment">//</span>
00998     <span class="comment">// Copy the pertinent information from the I/O Request Packet into locals</span>
00999     <span class="comment">// and free it.</span>
01000     <span class="comment">//</span>
01001 
01002     apcRoutine = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine;
01003     apcContext = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcContext;
01004     ioStatus = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a>;
01005 
01006     <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>( irp );
01007 
01008     <span class="comment">//</span>
01009     <span class="comment">// Finally, invoke the MPW's APC routine.</span>
01010     <span class="comment">//</span>
01011 
01012     apcRoutine( apcContext, ioStatus, 0 );
01013 
01014     <span class="keywordflow">return</span>;
01015 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a157" doxytag="iop.h::IopCompleteRequest" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopCompleteRequest           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Apc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l01019">1019</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01541">_FILE_OBJECT::CompletionContext</a>, <a class="el" href="../../d4/d9/ke_8h.html#a403a183">CurrentApcEnvironment</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01540">_FILE_OBJECT::Event</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01523">_FILE_OBJECT::FinalStatus</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01533">_FILE_OBJECT::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01491">FO_SYNCHRONOUS_IO</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06632">IoFreeIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06744">IoFreeMdl()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a241a141">IopCompletionPacketIrp</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00758">IopDequeueThreadIrp</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08130">IopDoNameTransmogrify()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01883">IopExceptionFilter()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12441">IopUpdateOtherTransferCount()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12473">IopUpdateReadTransferCount()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12504">IopUpdateWriteTransferCount()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l07981">IopUserCompletion()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08051">IopUserRundown()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d8/d5/ioverifier_8h-source.html#l00039">IOVP_COMPLETE_REQUEST</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01554">IRP_BUFFERED_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01558">IRP_CREATE_OPERATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01555">IRP_DEALLOCATE_BUFFER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01556">IRP_INPUT_OPERATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01565">IRP_OB_QUERY_NAME</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01559">IRP_READ_OPERATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01567">IRP_RETRY_IO_COMPLETION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01552">IRP_SYNCHRONOUS_API</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01560">IRP_WRITE_OPERATION</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00039">KeInitializeApc()</a>, <a class="el" href="../../d9/d2/queueobj_8c-source.html#l00124">KeInsertQueue()</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00217">KeInsertQueueApc()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01483">_IO_COMPLETION_CONTEXT::Key</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01596">_IRP::MdlAddress</a>, <a class="el" href="../../d2/d4/internal_8c.html#a3">MEMORY_BARRIER</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00414">_MDL::Next</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00048">NT_ERROR</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o24">_IRP::Overlay</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01648">_IRP::PendingReturned</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00196">PKNORMAL_ROUTINE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00214">PKRUNDOWN_ROUTINE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01482">_IO_COMPLETION_CONTEXT::Port</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01641">_IRP::RequestorMode</a>, <a class="el" href="../../d2/d4/internal_8c.html#a2">SynchronousIo</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00347">_ETHREAD::Tcb</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01711">_IRP::UserBuffer</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l00144">IopAbortRequest()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l07030">IopSynchronousServiceTail()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12782">IoRetryIrpCompletions()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00101">NtQueryInformationFile()</a>, and <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>.
<p>
<pre class="fragment"><div>01029                    :
01030 
01031     This routine executes as a special kernel APC routine in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of
01032     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread which originally requested <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O operation which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> now
01033     being completed.
01034 
01035     This routine performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following tasks:
01036 
01037         o   <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> check <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to determine whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified request ended
01038             with an error status.  If so, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error code qualifies as one
01039             which should be reported to an error port, then an error port <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01040             looked <span class="keywordflow">for</span> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread/process.   If one exists, then <span class="keyword">this</span> routine
01041             will attempt to set up an LPC to <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.  Otherwise, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will attempt to
01042             set up an LPC to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system error port.
01043 
01044         o   <a class="code" href="../../d9/d0/cmdata_8h.html#a104a97">Copy</a> buffers.
01045 
01046         o   Free MDLs.
01047 
01048         o   <a class="code" href="../../d9/d0/cmdata_8h.html#a104a97">Copy</a> I/O status.
01049 
01050         o   Set event, <span class="keywordflow">if</span> any and dereference <span class="keywordflow">if</span> appropriate.
01051 
01052         o   Dequeue <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread queue as pending I/O request.
01053 
01054         o   Queue APC to thread, <span class="keywordflow">if</span> any.
01055 
01056         o   If no APC <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be queued, then free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> packet now.
01057 
01058 
01059 Arguments:
01060 
01061     Apc - Supplies a pointer to kernel APC structure.
01062 
01063     NormalRoutine - Supplies a pointer to a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> normal function
01064         that was specified when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC was initialied.
01065 
01066     NormalContext - Supplies a pointer to a pointer to an arbitrary data
01067         structure that was specified when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC was initialized.
01068 
01069     SystemArgument1 - Supplies a pointer to an argument that contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01070         address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <span class="keywordflow">for</span> <span class="keyword">this</span> I/O operation.
01071 
01072     SystemArgument2 - Supplies a pointer to an argument that contains an
01073         argument that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used by <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span> of STATUS_REPARSE.
01074 
01075 Return Value:
01076 
01077     None.
01078 
01079 --*/
01080 {
01081 <span class="preprocessor">#define SynchronousIo( Irp, FileObject ) (  \</span>
01082 <span class="preprocessor">    (Irp-&gt;Flags &amp; IRP_SYNCHRONOUS_API) ||   \</span>
01083 <span class="preprocessor">    (FileObject == NULL ? 0 : FileObject-&gt;Flags &amp; FO_SYNCHRONOUS_IO) )</span>
01084 <span class="preprocessor"></span>
01085     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
01086     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> mdl, nextMdl;
01087     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> thread;
01088     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
01089     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
01090 
01091     UNREFERENCED_PARAMETER( NormalRoutine );
01092     UNREFERENCED_PARAMETER( NormalContext );
01093 
01094     <span class="comment">//</span>
01095     <span class="comment">// Begin by getting the address of the I/O Request Packet.  Also, get</span>
01096     <span class="comment">// the address of the current thread and the address of the original file</span>
01097     <span class="comment">// object for this I/O operation.</span>
01098     <span class="comment">//</span>
01099 
01100     irp = CONTAINING_RECORD( Apc, <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>, Tail.Apc );
01101     thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01102     fileObject = (<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>) *SystemArgument1;
01103 
01104     <a class="code" href="../../d7/d6/ioverifier_8h.html#a0">IOVP_COMPLETE_REQUEST</a>(Apc, SystemArgument1, SystemArgument2);
01105 
01106     <span class="comment">//</span>
01107     <span class="comment">// Ensure that the packet is not being completed with a minus one.  This</span>
01108     <span class="comment">// is apparently a common problem in some drivers, and has no meaning</span>
01109     <span class="comment">// as a status code.</span>
01110     <span class="comment">//</span>
01111 
01112     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status != 0xffffffff );
01113 
01114     <span class="comment">//</span>
01115     <span class="comment">// See if we need to do the name transmogrify work.</span>
01116     <span class="comment">//</span>
01117 
01118     <span class="keywordflow">if</span> ( *SystemArgument2 != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01119 
01120         PREPARSE_DATA_BUFFER reparseBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01121 
01122         <span class="comment">//</span>
01123         <span class="comment">// The IO_REPARSE_TAG_MOUNT_POINT tag needs attention.</span>
01124         <span class="comment">//</span>
01125 
01126         <span class="keywordflow">if</span> ( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status == STATUS_REPARSE &amp;&amp;
01127              irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information == IO_REPARSE_TAG_MOUNT_POINT ) {
01128 
01129             reparseBuffer = (PREPARSE_DATA_BUFFER) *SystemArgument2;
01130 
01131             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( reparseBuffer-&gt;ReparseTag == IO_REPARSE_TAG_MOUNT_POINT );
01132             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( reparseBuffer-&gt;ReparseDataLength &lt; MAXIMUM_REPARSE_DATA_BUFFER_SIZE );
01133             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( reparseBuffer-&gt;Reserved &lt; MAXIMUM_REPARSE_DATA_BUFFER_SIZE );
01134 
01135             <a class="code" href="../../d4/d6/iosubs_8c.html#a86">IopDoNameTransmogrify</a>( irp,
01136                                    fileObject,
01137                                    reparseBuffer );
01138         }
01139     }
01140 
01141     <span class="comment">//</span>
01142     <span class="comment">// Check to see whether there is any data in a system buffer which needs</span>
01143     <span class="comment">// to be copied to the caller's buffer.  If so, copy the data and then</span>
01144     <span class="comment">// free the system buffer if necessary.</span>
01145     <span class="comment">//</span>
01146 
01147     <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a178">IRP_BUFFERED_IO</a>) {
01148 
01149         <span class="comment">//</span>
01150         <span class="comment">// Copy the data if this was an input operation.  Note that no copy</span>
01151         <span class="comment">// is performed if the status indicates that a verify operation is</span>
01152         <span class="comment">// required, or if the final status was an error-level severity.</span>
01153         <span class="comment">//</span>
01154 
01155         <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a180">IRP_INPUT_OPERATION</a>  &amp;&amp;
01156             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status != STATUS_VERIFY_REQUIRED &amp;&amp;
01157             !<a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status )) {
01158 
01159             <span class="comment">//</span>
01160             <span class="comment">// Copy the information from the system buffer to the caller's</span>
01161             <span class="comment">// buffer.  This is done with an exception handler in case</span>
01162             <span class="comment">// the operation fails because the caller's address space</span>
01163             <span class="comment">// has gone away, or it's protection has been changed while</span>
01164             <span class="comment">// the service was executing.</span>
01165             <span class="comment">//</span>
01166 
01167             <span class="keywordflow">try</span> {
01168                 RtlCopyMemory( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o26">UserBuffer</a>,
01169                                irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer,
01170                                irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information );
01171             } except(<a class="code" href="../../d0/d6/iop_8h.html#a169">IopExceptionFilter</a>(GetExceptionInformation(), &amp;status)) {
01172 
01173                 <span class="comment">//</span>
01174                 <span class="comment">// An exception occurred while attempting to copy the</span>
01175                 <span class="comment">// system buffer contents to the caller's buffer.  Set</span>
01176                 <span class="comment">// a new I/O completion status.</span>
01177                 <span class="comment">// If the status is a special one set by Mm then we need to </span>
01178                 <span class="comment">// return here and the operation will be retried in </span>
01179                 <span class="comment">// IoRetryIrpCompletions.</span>
01180                 <span class="comment">//</span>
01181 
01182                 <span class="keywordflow">if</span> (status == STATUS_MULTIPLE_FAULT_VIOLATION) {
01183                     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = fileObject;  <span class="comment">/* Wiped out by APC  overlay */</span>
01184                     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a189">IRP_RETRY_IO_COMPLETION</a>;
01185                     <span class="keywordflow">return</span>;
01186                 }
01187                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = GetExceptionCode();
01188             }
01189         }
01190 
01191         <span class="comment">//</span>
01192         <span class="comment">// Free the buffer if needed.</span>
01193         <span class="comment">//</span>
01194 
01195         <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a179">IRP_DEALLOCATE_BUFFER</a>) {
01196             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer );
01197         }
01198     }
01199 
01200     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp;= ~(<a class="code" href="../../d0/d5/io_8h.html#a179">IRP_DEALLOCATE_BUFFER</a>|<a class="code" href="../../d0/d5/io_8h.html#a178">IRP_BUFFERED_IO</a>);
01201 
01202     <span class="comment">//</span>
01203     <span class="comment">// If there is an MDL (or MDLs) associated with this I/O request,</span>
01204     <span class="comment">// Free it (them) here.  This is accomplished by walking the MDL list</span>
01205     <span class="comment">// hanging off of the IRP and deallocating each MDL encountered.</span>
01206     <span class="comment">//</span>
01207 
01208     <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a>) {
01209         <span class="keywordflow">for</span> (mdl = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a>; mdl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; mdl = nextMdl) {
01210             nextMdl = mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o0">Next</a>;
01211             <a class="code" href="../../d4/d6/iosubs_8c.html#a65">IoFreeMdl</a>( mdl );
01212         }
01213     }
01214     
01215     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01216 
01217     <span class="comment">//</span>
01218     <span class="comment">// Check to see whether or not the I/O operation actually completed.  If</span>
01219     <span class="comment">// it did, then proceed normally.  Otherwise, cleanup everything and get</span>
01220     <span class="comment">// out of here.</span>
01221     <span class="comment">//</span>
01222 
01223     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status ) ||
01224         (<a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status ) &amp;&amp;
01225         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o11">PendingReturned</a> &amp;&amp;
01226         !<a class="code" href="../../d2/d4/internal_8c.html#a2">SynchronousIo</a>( irp, fileObject ))) {
01227 
01228         PVOID port = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01229         PVOID key;
01230         BOOLEAN createOperation = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01231 
01232         <span class="comment">//</span>
01233         <span class="comment">// If there is an I/O completion port object associated w/this request,</span>
01234         <span class="comment">// save it here so that the file object can be dereferenced.</span>
01235         <span class="comment">//</span>
01236 
01237         <span class="keywordflow">if</span> (fileObject &amp;&amp; fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o26">CompletionContext</a>) {
01238             port = fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o26">CompletionContext</a>-&gt;<a class="code" href="../../d2/d4/struct__IO__COMPLETION__CONTEXT.html#o0">Port</a>;
01239             key = fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o26">CompletionContext</a>-&gt;<a class="code" href="../../d2/d4/struct__IO__COMPLETION__CONTEXT.html#o1">Key</a>;
01240         }
01241 
01242         <span class="comment">//</span>
01243         <span class="comment">// Copy the I/O status from the IRP into the caller's I/O status</span>
01244         <span class="comment">// block. This is done using an exception handler in case the caller's</span>
01245         <span class="comment">// virtual address space for the I/O status block was deleted or</span>
01246         <span class="comment">// its protection was changed to readonly.  Note that if the I/O</span>
01247         <span class="comment">// status block cannot be written, the error is simply ignored since</span>
01248         <span class="comment">// there is no way to tell the caller that something went wrong.</span>
01249         <span class="comment">// This is, of course, by definition, since the I/O status block</span>
01250         <span class="comment">// is where the caller will attempt to look for errors in the first</span>
01251         <span class="comment">// place!</span>
01252         <span class="comment">//</span>
01253 
01254         <span class="keywordflow">try</span> {
01255 
01256             <span class="comment">//</span>
01257             <span class="comment">// Since HasOverlappedIoCompleted and GetOverlappedResult only</span>
01258             <span class="comment">// look at the Status field of the UserIosb to determine if the</span>
01259             <span class="comment">// IRP has completed, the Information field must be written</span>
01260             <span class="comment">// before the Status field.</span>
01261             <span class="comment">//</span>
01262 
01263 <span class="preprocessor">#if defined(_M_ALPHA) &amp;&amp; !defined(NT_UP)</span>
01264 <span class="preprocessor"></span><span class="preprocessor">#define MEMORY_BARRIER()    __MB()</span>
01265 <span class="preprocessor"></span><span class="preprocessor">#else</span>
01266 <span class="preprocessor"></span><span class="preprocessor">#define MEMORY_BARRIER()</span>
01267 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01268 <span class="preprocessor"></span>
01269 <span class="preprocessor">#if defined(_WIN64)</span>
01270 <span class="preprocessor"></span>            PIO_STATUS_BLOCK32    UserIosb32;
01271 
01272             <span class="comment">//</span>
01273             <span class="comment">// If the caller passes a 32 bit IOSB the ApcRoutine has the LSB set to 1</span>
01274             <span class="comment">//</span>
01275             <span class="keywordflow">if</span> ((ULONG_PTR)(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine) &amp; 1) {
01276                 UserIosb32 = (PIO_STATUS_BLOCK32)irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a>;
01277 
01278                 UserIosb32-&gt;Information = (ULONG)irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information;
01279                 <a class="code" href="../../d2/d4/internal_8c.html#a3">MEMORY_BARRIER</a>();
01280                 UserIosb32-&gt;Status = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
01281             } <span class="keywordflow">else</span> {
01282                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a>-&gt;Information = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information;
01283                 <a class="code" href="../../d2/d4/internal_8c.html#a3">MEMORY_BARRIER</a>();
01284                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a>-&gt;Status = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
01285             }
01286 <span class="preprocessor">#else</span>
01287 <span class="preprocessor"></span>            irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a>-&gt;Information = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information;
01288             <a class="code" href="../../d2/d4/internal_8c.html#a3">MEMORY_BARRIER</a>();
01289             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a>-&gt;Status = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
01290 <span class="preprocessor">#endif  </span><span class="comment">/*_WIN64 */</span>
01291 
01292         } except(<a class="code" href="../../d0/d6/iop_8h.html#a169">IopExceptionFilter</a>(GetExceptionInformation(), &amp;status)) {
01293 
01294             <span class="comment">//</span>
01295             <span class="comment">// An exception was incurred attempting to write the caller's</span>
01296             <span class="comment">// I/O status block.  Simply continue executing as if nothing</span>
01297             <span class="comment">// ever happened since nothing can be done about it anyway.</span>
01298             <span class="comment">// If the status is a multiple fault status, this is a special</span>
01299             <span class="comment">// status sent by the Memory manager. Mark the IRP and return from</span>
01300             <span class="comment">// this routine. Mm will call us back later and we will retry this</span>
01301             <span class="comment">// operation (IoRetryIrpCompletions)</span>
01302             <span class="comment">//</span>
01303             <span class="keywordflow">if</span> (status == STATUS_MULTIPLE_FAULT_VIOLATION) {
01304                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = fileObject;  <span class="comment">/* Wiped out by APC  overlay */</span>
01305                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a189">IRP_RETRY_IO_COMPLETION</a>;
01306                 <span class="keywordflow">return</span>;
01307             }
01308         }
01309 
01310 
01311         <span class="comment">//</span>
01312         <span class="comment">// Determine whether the caller supplied an event that needs to be set</span>
01313         <span class="comment">// to the Signaled state.  If so, then set it; otherwise, set the event</span>
01314         <span class="comment">// in the file object to the Signaled state.</span>
01315         <span class="comment">//</span>
01316         <span class="comment">// It is possible for the event to have been specified as a PKEVENT if</span>
01317         <span class="comment">// this was an I/O operation hand-built for an FSP or an FSD, or</span>
01318         <span class="comment">// some other types of operations such as synchronous I/O APIs.  In</span>
01319         <span class="comment">// any of these cases, the event was not referenced since it is not an</span>
01320         <span class="comment">// object manager event, so it should not be dereferenced.</span>
01321         <span class="comment">//</span>
01322         <span class="comment">// Also, it is possible for there not to be a file object for this IRP.</span>
01323         <span class="comment">// This occurs when an FSP is doing I/O operations to a device driver on</span>
01324         <span class="comment">// behalf of a process doing I/O to a file.  The file object cannot be</span>
01325         <span class="comment">// dereferenced if this is the case.  If this operation was a create</span>
01326         <span class="comment">// operation then the object should not be dereferenced either.  This</span>
01327         <span class="comment">// is because the reference count must be one or it will go away for</span>
01328         <span class="comment">// the caller (not much point in making an object that just got created</span>
01329         <span class="comment">// go away).</span>
01330         <span class="comment">//</span>
01331 
01332         <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a>) {
01333             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a>, 0, FALSE );
01334             <span class="keywordflow">if</span> (fileObject) {
01335                 <span class="keywordflow">if</span> (!(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>)) {
01336                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> );
01337                 }
01338                 <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a> &amp;&amp; !(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a187">IRP_OB_QUERY_NAME</a>)) {
01339                     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a>, 0, FALSE );
01340                     fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o8">FinalStatus</a> = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
01341                 }
01342                 <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a182">IRP_CREATE_OPERATION</a>) {
01343                     createOperation = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01344                     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine = (PIO_APC_ROUTINE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01345                 }
01346             }
01347         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fileObject) {
01348             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a>, 0, FALSE );
01349             fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o8">FinalStatus</a> = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
01350             <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a182">IRP_CREATE_OPERATION</a>) {
01351                 createOperation = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01352                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine = (PIO_APC_ROUTINE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01353             }
01354         }
01355 
01356         <span class="comment">//</span>
01357         <span class="comment">// If this is normal I/O, update the transfer count for this process.</span>
01358         <span class="comment">//</span>
01359 
01360         <span class="keywordflow">if</span> (!(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a182">IRP_CREATE_OPERATION</a>)) {
01361             <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a183">IRP_READ_OPERATION</a>) {
01362                 <a class="code" href="../../d4/d6/iosubs_8c.html#a133">IopUpdateReadTransferCount</a>( (ULONG) irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information );
01363             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a184">IRP_WRITE_OPERATION</a>) {
01364                 <a class="code" href="../../d4/d6/iosubs_8c.html#a134">IopUpdateWriteTransferCount</a>( (ULONG) irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information );
01365             } <span class="keywordflow">else</span> {
01366                 <span class="comment">//</span>
01367                 <span class="comment">// If the information field contains a pointer then skip the update.</span>
01368                 <span class="comment">// Some PNP IRPs contain this.</span>
01369                 <span class="comment">//</span>
01370                 <span class="keywordflow">if</span> (!((ULONG) irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information &amp; 0x80000000)) {
01371                     <a class="code" href="../../d4/d6/iosubs_8c.html#a132">IopUpdateOtherTransferCount</a>( (ULONG) irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information );
01372                 }
01373             }
01374         }
01375 
01376         <span class="comment">//</span>
01377         <span class="comment">// Dequeue the packet from the thread's pending I/O request list.</span>
01378         <span class="comment">//</span>
01379 
01380         <a class="code" href="../../d0/d6/iop_8h.html#a18">IopDequeueThreadIrp</a>( irp );
01381 
01382         <span class="comment">//</span>
01383         <span class="comment">// If the caller requested an APC, queue it to the thread.  If not, then</span>
01384         <span class="comment">// simply free the packet now.</span>
01385         <span class="comment">//</span>
01386 
01387 <span class="preprocessor">#ifdef  _WIN64</span>
01388 <span class="preprocessor"></span>        <span class="comment">//</span>
01389         <span class="comment">// For 64 bit systems clear the LSB field of the ApcRoutine that indicates whether</span>
01390         <span class="comment">// the IOSB is a 32 bit IOSB or a 64 bit IOSB.</span>
01391         <span class="comment">//</span>
01392         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine =
01393           (PIO_APC_ROUTINE)((LONG_PTR)(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine) &amp; ~1);
01394 <span class="preprocessor">#endif</span>
01395 <span class="preprocessor"></span>
01396         <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine) {
01397             <a class="code" href="../../d5/d7/apcobj_8c.html#a1">KeInitializeApc</a>( &amp;irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Apc,
01398                              &amp;thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>,
01399                              CurrentApcEnvironment,
01400                              IopUserCompletion,
01401                              (PKRUNDOWN_ROUTINE) IopUserRundown,
01402                              (PKNORMAL_ROUTINE) irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine,
01403                              irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a>,
01404                              irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcContext );
01405 
01406             <a class="code" href="../../d5/d7/apcobj_8c.html#a3">KeInsertQueueApc</a>( &amp;irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Apc,
01407                               irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a>,
01408                               NULL,
01409                               2 );
01410 
01411         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (port &amp;&amp; irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcContext) {
01412 
01413             <span class="comment">//</span>
01414             <span class="comment">// If there is a completion context associated w/this I/O operation,</span>
01415             <span class="comment">// send the message to the port. Tag completion packet as an Irp.</span>
01416             <span class="comment">//</span>
01417 
01418             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.CompletionKey = key;
01419             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.PacketType = <a class="code" href="../../d0/d6/iop_8h.html#a241a141">IopCompletionPacketIrp</a>;
01420 
01421             <a class="code" href="../../d8/d3/queueobj_8c.html#a3">KeInsertQueue</a>( (<a class="code" href="../../d7/d7/struct__KQUEUE.html">PKQUEUE</a>) port,
01422                            &amp;irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.ListEntry );
01423 
01424         } <span class="keywordflow">else</span> {
01425 
01426             <span class="comment">//</span>
01427             <span class="comment">// Free the IRP now since it is no longer needed.</span>
01428             <span class="comment">//</span>
01429 
01430             <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>( irp );
01431         }
01432 
01433         <span class="keywordflow">if</span> (fileObject &amp;&amp; !createOperation) {
01434 
01435             <span class="comment">//</span>
01436             <span class="comment">// Dereference the file object now.</span>
01437             <span class="comment">//</span>
01438 
01439             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
01440         }
01441 
01442     } <span class="keywordflow">else</span> {
01443 
01444         <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o11">PendingReturned</a> &amp;&amp; fileObject) {
01445 
01446             <span class="comment">//</span>
01447             <span class="comment">// This is an I/O operation that completed as an error for</span>
01448             <span class="comment">// which a pending status was returned and the I/O operation</span>
01449             <span class="comment">// is synchronous.  For this case, the I/O system is waiting</span>
01450             <span class="comment">// on behalf of the caller.  If the reason that the I/O was</span>
01451             <span class="comment">// synchronous is that the file object was opened for synchronous</span>
01452             <span class="comment">// I/O, then the event associated with the file object is set</span>
01453             <span class="comment">// to the signaled state.  If the I/O operation was synchronous</span>
01454             <span class="comment">// because this is a synchronous API, then the event is set to</span>
01455             <span class="comment">// the signaled state.</span>
01456             <span class="comment">//</span>
01457             <span class="comment">// Note also that the status must be returned for both types</span>
01458             <span class="comment">// of synchronous I/O.  If this is a synchronous API, then the</span>
01459             <span class="comment">// I/O system supplies its own status block so it can simply</span>
01460             <span class="comment">// be written;  otherwise, the I/O system will obtain the final</span>
01461             <span class="comment">// status from the file object itself.</span>
01462             <span class="comment">//</span>
01463 
01464             <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>) {
01465                 *irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>;
01466                 <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a>) {
01467                     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a>, 0, FALSE );
01468                 } <span class="keywordflow">else</span> {
01469                     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a>, 0, FALSE );
01470                 }
01471             } <span class="keywordflow">else</span> {
01472                 fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o8">FinalStatus</a> = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
01473                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a>, 0, FALSE );
01474             }
01475         }
01476 
01477         <span class="comment">//</span>
01478         <span class="comment">// The operation was incomplete.  Perform the general cleanup.  Note</span>
01479         <span class="comment">// that everything is basically dropped on the floor without doing</span>
01480         <span class="comment">// anything.  That is:</span>
01481         <span class="comment">//</span>
01482         <span class="comment">//     IoStatusBlock - Do nothing.</span>
01483         <span class="comment">//     Event - Dereference without setting to Signaled state.</span>
01484         <span class="comment">//     FileObject - Dereference without setting to Signaled state.</span>
01485         <span class="comment">//     ApcRoutine - Do nothing.</span>
01486         <span class="comment">//</span>
01487 
01488         <span class="keywordflow">if</span> (fileObject) {
01489             <span class="keywordflow">if</span> (!(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a182">IRP_CREATE_OPERATION</a>)) {
01490                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
01491             }
01492         }
01493 
01494         <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> &amp;&amp;
01495             fileObject &amp;&amp;
01496             !(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>)) {
01497             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> );
01498         }
01499 
01500         <a class="code" href="../../d0/d6/iop_8h.html#a18">IopDequeueThreadIrp</a>( irp );
01501         <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>( irp );
01502     }
01503 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a155" doxytag="iop.h::IopCompleteUnloadOrDelete" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopCompleteUnloadOrDelete           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KIRQL&nbsp;</td>
          <td class="mdname" nowrap> <em>Irql</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l00657">657</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01181">_DEVICE_OBJECT::AttachedDevice</a>, <a class="el" href="../../d5/d8/ex_8h.html#a332a206">DelayedWorkQueue</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01366">_DRIVER_OBJECT::DeviceObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00553">DNF_REMOVE_PENDING_CLOSES</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01221">DOE_DELETE_PENDING</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01222">DOE_REMOVE_PENDING</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01223">DOE_REMOVE_PROCESSED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01220">DOE_UNLOAD_PENDING</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00317">_LOAD_PACKET::DriverObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01299">DRVO_UNLOAD_INVOKED</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00316">_LOAD_PACKET::Event</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01961">ExInitializeWorkItem</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00375">ExQueueWorkItem()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01268">_DEVOBJ_EXTENSION::ExtensionFlags</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00955">_FAST_IO_DISPATCH::FastIoDetachDevice</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01367">_DRIVER_OBJECT::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00084">IopChainDereferenceComplete()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00054">IopDatabaseLock</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03919">IopGetDeviceAttachmentBase()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l04026">IopInsertRemoveDevice()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04169">IopLoadUnloadDriver()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a57">LOAD_PACKET</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01180">_DEVICE_OBJECT::NextDevice</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00484">ObMakeTemporaryObject()</a>, <a class="el" href="../../d0/d5/io_8h.html#a342">PDEVOBJ_EXTENSION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01178">_DEVICE_OBJECT::ReferenceCount</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00942">_FAST_IO_DISPATCH::SizeOfFastIoDispatch</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, and <a class="el" href="../../d1/d5/iop_8h-source.html#l00315">_LOAD_PACKET::WorkQueueItem</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05951">IoDeleteDevice()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06298">IoDetachDevice()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l04022">IopDecrementDeviceObjectRef()</a>.
<p>
<pre class="fragment"><div>00664                    :
00665 
00666     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count on a device object
00667     transitions to a zero and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> mark <span class="keywordflow">for</span> unload or device has
00668     been marked <span class="keywordflow">for</span> <span class="keyword">delete</span>. This means that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> may be possible to actually
00669     unload <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver or <span class="keyword">delete</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object.  If all
00670     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> devices have a reference count of zero, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00671     actually unloaded.  Note that in order to ensure that <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00672     not invoked twice, at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same time, on two different processors, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00673     I/O database spin lock <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> still held at <span class="keyword">this</span> point.
00674 
00675 Arguments:
00676 
00677     DeviceObject - Supplies a pointer to one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver's device objects,
00678         namely <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> one whose reference count just went to zero.
00679 
00680     Irql - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IRQL of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O
00681         database lock was acquired.
00682 
00683 Return Value:
00684 
00685     None.
00686 
00687 --*/
00688 
00689 {
00690     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
00691     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00692     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> baseDeviceObject;
00693     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> attachedDeviceObject;
00694     <a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html">PDEVOBJ_EXTENSION</a> deviceExtension;
00695     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
00696 
00697     BOOLEAN unload = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00698 
00699     driverObject = DeviceObject-&gt;DriverObject;
00700 
00701     <span class="keywordflow">if</span> (DeviceObject-&gt;DeviceObjectExtension-&gt;ExtensionFlags &amp; <a class="code" href="../../d0/d5/io_8h.html#a140">DOE_REMOVE_PENDING</a>) {
00702 
00703         <span class="comment">//</span>
00704         <span class="comment">// Run some tests to determine if it is an appropriate time to notify</span>
00705         <span class="comment">// PnP that all file objects in the attachment chain have gone away.</span>
00706         <span class="comment">//</span>
00707 
00708         baseDeviceObject = <a class="code" href="../../d0/d6/iop_8h.html#a173">IopGetDeviceAttachmentBase</a>( DeviceObject );
00709         deviceExtension = baseDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>;
00710         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
00711 
00712         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode != NULL);
00713 
00714         <span class="comment">//</span>
00715         <span class="comment">// baseDeviceObject is a PDO, this is a PnP stack.  See if</span>
00716         <span class="comment">// an IRP_MN_REMOVE_DEVICE is pending.</span>
00717         <span class="comment">//</span>
00718 
00719         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; DNF_REMOVE_PENDING_CLOSES);
00720 
00721         <span class="comment">//</span>
00722         <span class="comment">// PnP wants to be notified as soon as all refcounts on all devices in</span>
00723         <span class="comment">// this attachment chain go away.</span>
00724         <span class="comment">//</span>
00725 
00726         attachedDeviceObject = baseDeviceObject;
00727         <span class="keywordflow">while</span> (attachedDeviceObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00728 
00729             <span class="keywordflow">if</span> (attachedDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o2">ReferenceCount</a> != 0) {
00730 
00731                 <span class="comment">//</span>
00732                 <span class="comment">// At least one device object in the attachment chain has</span>
00733                 <span class="comment">// an outstanding open.</span>
00734                 <span class="comment">//</span>
00735 
00736                 ExReleaseSpinLock( &amp;IopDatabaseLock, Irql );
00737 
00738                 <span class="keywordflow">return</span>;
00739             }
00740             attachedDeviceObject = attachedDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
00741         }
00742 
00743         <span class="comment">//</span>
00744         <span class="comment">// Now one more time changing DOE_REMOVE_PENDING to</span>
00745         <span class="comment">// DOE_REMOVE_PROCESSED.</span>
00746         <span class="comment">//</span>
00747 
00748         attachedDeviceObject = baseDeviceObject;
00749         <span class="keywordflow">while</span> (attachedDeviceObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00750 
00751             deviceExtension = attachedDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>;
00752 
00753             deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> &amp;= ~<a class="code" href="../../d0/d5/io_8h.html#a140">DOE_REMOVE_PENDING</a>;
00754             deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a141">DOE_REMOVE_PROCESSED</a>;
00755 
00756             attachedDeviceObject = attachedDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
00757         }
00758 
00759         <span class="comment">//</span>
00760         <span class="comment">// It is time to give PnP the notification it was waiting for.  We have</span>
00761         <span class="comment">// to release the spinlock before doing so.</span>
00762         <span class="comment">//</span>
00763 
00764         ExReleaseSpinLock( &amp;IopDatabaseLock, Irql );
00765 
00766         <a class="code" href="../../d9/d0/pnpiop_8h.html#a316">IopChainDereferenceComplete</a>( baseDeviceObject );
00767 
00768         <span class="keywordflow">return</span>;
00769     }
00770 
00771     <span class="keywordflow">if</span> (DeviceObject-&gt;DeviceObjectExtension-&gt;ExtensionFlags &amp; <a class="code" href="../../d0/d5/io_8h.html#a139">DOE_DELETE_PENDING</a>) {
00772 
00773         <span class="keywordflow">if</span> ((DeviceObject-&gt;DeviceObjectExtension-&gt;ExtensionFlags &amp;
00774             <a class="code" href="../../d0/d5/io_8h.html#a138">DOE_UNLOAD_PENDING</a>) == 0 ||
00775             driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a143">DRVO_UNLOAD_INVOKED</a>) {
00776 
00777             unload = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00778         }
00779 
00780         <span class="comment">//</span>
00781         <span class="comment">// If another device is attached to this device, inform the former's</span>
00782         <span class="comment">// driver that the device is being deleted.</span>
00783         <span class="comment">//</span>
00784 
00785         <span class="keywordflow">if</span> (DeviceObject-&gt;AttachedDevice) {
00786             <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> fastIoDispatch = DeviceObject-&gt;AttachedDevice-&gt;DriverObject-&gt;FastIoDispatch;
00787             <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> attachedDevice = DeviceObject-&gt;AttachedDevice;
00788 
00789             <span class="comment">//</span>
00790             <span class="comment">// Increment the device reference count so the detach routine</span>
00791             <span class="comment">// does not recurse back to here.</span>
00792             <span class="comment">//</span>
00793 
00794             DeviceObject-&gt;ReferenceCount++;
00795 
00796             ExReleaseSpinLock( &amp;IopDatabaseLock, Irql );
00797 
00798             <span class="keywordflow">if</span> (fastIoDispatch &amp;&amp;
00799                 fastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt; FIELD_OFFSET( <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, FastIoDetachDevice ) &amp;&amp;
00800                 fastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o13">FastIoDetachDevice</a>) {
00801                 (fastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o13">FastIoDetachDevice</a>)( attachedDevice, DeviceObject );
00802             }
00803 
00804             ExAcquireSpinLock( &amp;IopDatabaseLock, &amp;Irql );
00805 
00806             <span class="comment">//</span>
00807             <span class="comment">// Restore the reference count value.</span>
00808             <span class="comment">//</span>
00809 
00810             DeviceObject-&gt;ReferenceCount--;
00811 
00812             <span class="keywordflow">if</span> (DeviceObject-&gt;AttachedDevice ||
00813                 DeviceObject-&gt;ReferenceCount != 0) {
00814 
00815 
00816                 ExReleaseSpinLock( &amp;IopDatabaseLock, Irql );
00817                 <span class="keywordflow">return</span>;
00818             }
00819         }
00820 
00821         ExReleaseSpinLock( &amp;IopDatabaseLock, Irql );
00822 
00823         <span class="comment">//</span>
00824         <span class="comment">// Deallocate the memory for the security descriptor that was allocated</span>
00825         <span class="comment">// for this device object.</span>
00826         <span class="comment">//</span>
00827 
00828         <span class="keywordflow">if</span> (DeviceObject-&gt;SecurityDescriptor != (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00829             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DeviceObject-&gt;SecurityDescriptor );
00830         }
00831 
00832         <span class="comment">//</span>
00833         <span class="comment">// Remove this device object from the driver object's list.</span>
00834         <span class="comment">//</span>
00835 
00836         <a class="code" href="../../d4/d6/iosubs_8c.html#a43">IopInsertRemoveDevice</a>( DeviceObject-&gt;DriverObject, DeviceObject, FALSE );
00837 
00838         <span class="comment">//</span>
00839         <span class="comment">// Finally, dereference the object so it is deleted.</span>
00840         <span class="comment">//</span>
00841 
00842         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( DeviceObject );
00843 
00844         <span class="comment">//</span>
00845         <span class="comment">// Return if the unload does not need to be done.</span>
00846         <span class="comment">//</span>
00847 
00848         <span class="keywordflow">if</span> (!unload) {
00849             <span class="keywordflow">return</span>;
00850         }
00851 
00852         <span class="comment">//</span>
00853         <span class="comment">// Reacquire the spin lock make sure the unload routine does has</span>
00854         <span class="comment">// not been called.</span>
00855         <span class="comment">//</span>
00856 
00857         ExAcquireSpinLock( &amp;IopDatabaseLock, &amp;Irql );
00858 
00859         <span class="keywordflow">if</span> (driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a143">DRVO_UNLOAD_INVOKED</a>) {
00860 
00861             <span class="comment">//</span>
00862             <span class="comment">// Some other thread is doing the unload, release the lock and return.</span>
00863             <span class="comment">//</span>
00864 
00865             ExReleaseSpinLock( &amp;IopDatabaseLock, Irql );
00866             <span class="keywordflow">return</span>;
00867         }
00868     }
00869 
00870     <span class="comment">//</span>
00871     <span class="comment">// Scan the list of device objects for this driver, looking for a</span>
00872     <span class="comment">// non-zero reference count.  If any reference count is non-zero, then</span>
00873     <span class="comment">// the driver may not be unloaded.</span>
00874     <span class="comment">//</span>
00875 
00876     deviceObject = driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o2">DeviceObject</a>;
00877 
00878     <span class="keywordflow">while</span> (deviceObject) {
00879         <span class="keywordflow">if</span> (deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o2">ReferenceCount</a> || deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a> ||
00880             deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> &amp; (<a class="code" href="../../d0/d5/io_8h.html#a139">DOE_DELETE_PENDING</a> | <a class="code" href="../../d0/d5/io_8h.html#a140">DOE_REMOVE_PENDING</a>)) {
00881             unload = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00882             <span class="keywordflow">break</span>;
00883         }
00884         deviceObject = deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o4">NextDevice</a>;
00885     }
00886 
00887     <span class="keywordflow">if</span> (unload) {
00888         driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a143">DRVO_UNLOAD_INVOKED</a>;
00889     }
00890 
00891     ExReleaseSpinLock( &amp;IopDatabaseLock, Irql );
00892 
00893     <span class="comment">//</span>
00894     <span class="comment">// If the reference counts for all of the devices is zero, then this</span>
00895     <span class="comment">// driver can now be unloaded.</span>
00896     <span class="comment">//</span>
00897 
00898     <span class="keywordflow">if</span> (unload) {
00899         <a class="code" href="../../d0/d2/struct__LOAD__PACKET.html">LOAD_PACKET</a> loadPacket;
00900 
00901         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;loadPacket.<a class="code" href="../../d0/d2/struct__LOAD__PACKET.html#o1">Event</a>, NotificationEvent, FALSE );
00902         loadPacket.<a class="code" href="../../d0/d2/struct__LOAD__PACKET.html#o2">DriverObject</a> = driverObject;
00903         <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>( &amp;loadPacket.<a class="code" href="../../d0/d2/struct__LOAD__PACKET.html#o0">WorkQueueItem</a>,
00904                               IopLoadUnloadDriver,
00905                               &amp;loadPacket );
00906         <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>( &amp;loadPacket.<a class="code" href="../../d0/d2/struct__LOAD__PACKET.html#o0">WorkQueueItem</a>, DelayedWorkQueue );
00907         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;loadPacket.<a class="code" href="../../d0/d2/struct__LOAD__PACKET.html#o1">Event</a>,
00908                                       Executive,
00909                                       KernelMode,
00910                                       FALSE,
00911                                       (PLARGE_INTEGER) NULL );
00912 
00913         <a class="code" href="../../d5/d0/obclose_8c.html#a3">ObMakeTemporaryObject</a>( driverObject );
00914         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( driverObject );
00915     }
00916 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a228" doxytag="iop.h::IopConfigureCrashDump" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopConfigureCrashDump           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>HandlePagingFile</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04746">4746</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d1/d5/iop_8h-source.html#l00442">DCB_DUMP_ENABLED</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00443">DCB_SUMMARY_ENABLED</a>, <a class="el" href="../../d0/d5/io_8h.html#a603a420">DeviceUsageTypeDumpFile</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01160">DO_SYSTEM_BOOT_PARTITION</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00469">_DUMP_CONTROL_BLOCK::DumpFileSize</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00457">_DUMP_CONTROL_BLOCK::DumpStack</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01184">_DEVICE_OBJECT::Flags</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00452">_DUMP_CONTROL_BLOCK::Flags</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00468">_DUMP_CONTROL_BLOCK::HeaderSize</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00433">IO_DUMP_MEMORY_BLOCK_PAGES</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00231">IoDebugPrint</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00044">IoFileObjectType</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00335">IoGetDumpStack()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02492">IopCalculateRequiredDumpSpace()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04061">IopCompleteDumpInitialization()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00263">IopDumpControlBlock</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04252">IopFreeDCB()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04580">IopInitializeDCB()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04393">IopLogErrorEvent()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00458">_DUMP_CONTROL_BLOCK::MemoryDescriptor</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00040">_PHYSICAL_MEMORY_DESCRIPTOR::NumberOfPages</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08468">IoPageFileCreated()</a>.
<p>
<pre class="fragment"><div>04751                    :
04752 
04753     This routine configures <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system <span class="keywordflow">for</span> crash dump. The following things
04754     are done:
04755     
04756         1. Initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dump <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block and init registry crashdump
04757            parameters.
04758 
04759         2. Configure either page or fast dump.
04760 
04761         3. Complete dump <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> initialization.
04762 
04763     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called as each page <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keywordflow">return</span> value of
04764     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> tells <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller (i.e., NtCreatePagingFiles, IoPageFileCreated)
04765     that crash dump has been configured.
04766 
04767 
04768 Arguments:
04769 
04770        hPageFile - Handle to the paging file
04771 
04772 Return Value:
04773 
04774     TRUE - Configuration complete (or crash dump not enabled).
04775 
04776     FALSE - Error, retry PageFile is not on boot partition.
04777 
04778 --*/
04779 {
04780     ULONG           dwStatus;
04781     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>    fileObject;
04782     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>  deviceObject;
04783 
04784     <span class="comment">//</span>
04785     <span class="comment">// Only Init DCB Once.</span>
04786     <span class="comment">//</span>
04787     
04788     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>) {
04789         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d3/dumpctl_8c.html#a32">IopInitializeDCB</a>()) {
04790             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04791         }
04792     }
04793 
04794     <span class="comment">//</span>
04795     <span class="comment">// Return crash dump not enabled</span>
04796     <span class="comment">//</span>
04797     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>){
04798         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04799     }
04800 
04801     <span class="comment">//</span>
04802     <span class="comment">//  Only autoreboot?</span>
04803     <span class="comment">//</span>
04804     
04805     <span class="keywordflow">if</span> ( !( <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> &amp; (<a class="code" href="../../d0/d6/iop_8h.html#a5">DCB_DUMP_ENABLED</a> | <a class="code" href="../../d0/d6/iop_8h.html#a6">DCB_SUMMARY_ENABLED</a>) ) ) {
04806         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04807     }
04808 
04809     <span class="comment">//</span>
04810     <span class="comment">// Configure the paging file for crash dump.</span>
04811     <span class="comment">//</span>
04812 
04813     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"[IoPageFileCreated]: Page file dump\n"</span>));
04814 
04815 
04816     dwStatus = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
04817                                         hPageFile,
04818                                         0,
04819                                         IoFileObjectType,
04820                                         KernelMode,
04821                                         (PVOID *) &amp;fileObject,
04822                                         NULL
04823                                         );
04824 
04825     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( dwStatus )) {
04826         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((1,<span class="stringliteral">"[IoPageFileCreated]: ObReferenceObjectByHandle for Paging file failed status = %x\n"</span>,dwStatus));
04827         <span class="keywordflow">goto</span> error_return;
04828     }
04829 
04830     <span class="comment">//</span>
04831     <span class="comment">// Get a pointer to the device object for this file.  Note that it</span>
04832     <span class="comment">// cannot go away, since there is an open handle to it, so it is</span>
04833     <span class="comment">// OK to dereference it and then use it.</span>
04834     <span class="comment">//</span>
04835 
04836     deviceObject = fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a>;
04837 
04838     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
04839 
04840     <span class="comment">//</span>
04841     <span class="comment">// If this device object does not represents the boot partition return</span>
04842     <span class="comment">// FALSE so MM will try again.</span>
04843     <span class="comment">//</span>
04844     
04845     <span class="keywordflow">if</span> ( ! (deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a129">DO_SYSTEM_BOOT_PARTITION</a>) ) {
04846         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04847     }
04848 
04849     <span class="comment">//</span>
04850     <span class="comment">// Load paging file dump stack</span>
04851     <span class="comment">//</span>
04852     
04853     dwStatus = <a class="code" href="../../d2/d3/dumpctl_8c.html#a36">IoGetDumpStack</a> (L<span class="stringliteral">"dump_"</span>,
04854                                &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o6">DumpStack</a>,
04855                                DeviceUsageTypeDumpFile,
04856                                FALSE);
04857 
04858     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(dwStatus)) {
04859         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((1, <span class="stringliteral">"IoPageFileCreated: Could not load dump stack status = %x\n"</span>,dwStatus) );
04860         <span class="keywordflow">goto</span> error_return;
04861     }
04862 
04863     <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o6">DumpStack</a>-&gt;Init.CrashDump = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04864 
04865     <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o6">DumpStack</a>-&gt;Init.MemoryBlock = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
04866                                                 NonPagedPool,
04867                                                 IO_DUMP_MEMORY_BLOCK_PAGES * PAGE_SIZE,
04868                                                 'pmuD'
04869                                                 );
04870 
04871     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o6">DumpStack</a>-&gt;Init.MemoryBlock) {
04872         dwStatus = STATUS_NO_MEMORY;
04873         <span class="keywordflow">goto</span> error_return;
04874     }
04875 
04876 
04877     <span class="comment">//</span>
04878     <span class="comment">// Calculate the amount of space required for the dump</span>
04879     <span class="comment">//</span>
04880     <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o18">DumpFileSize</a> =<a class="code" href="../../d2/d3/dumpctl_8c.html#a33">IopCalculateRequiredDumpSpace</a>(
04881                                                     <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a>,
04882                                                     <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o17">HeaderSize</a>,
04883                                                     <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a>,
04884                                                     <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a>
04885                                                     );
04886 
04887 
04888     <span class="comment">//</span>
04889     <span class="comment">// Complete dump initialization</span>
04890     <span class="comment">//</span>
04891 
04892     dwStatus = <a class="code" href="../../d2/d3/dumpctl_8c.html#a34">IopCompleteDumpInitialization</a>(hPageFile);
04893 
04894 error_return:
04895 
04896     <span class="comment">//</span>
04897     <span class="comment">// The BOOT partition paging file could not be configured.</span>
04898     <span class="comment">//   1. Log an error message</span>
04899     <span class="comment">//   2. Return TRUE so that MM does not try again</span>
04900     <span class="comment">//</span>
04901 
04902     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(dwStatus)) {
04903         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((1,<span class="stringliteral">"IopPageFileCreated: Page File dump init FAILED status = %x\n"</span>,dwStatus));
04904 
04905         <a class="code" href="../../d0/d6/iop_8h.html#a227">IopLogErrorEvent</a>(0,3,STATUS_SUCCESS,IO_DUMP_PAGE_CONFIG_FAILED,0,NULL,0,NULL);
04906 
04907         <a class="code" href="../../d2/d3/dumpctl_8c.html#a55">IopFreeDCB</a>(FALSE);
04908 
04909     }
04910 
04911     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04912 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a158" doxytag="iop.h::IopConnectLinkTrackingPort" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopConnectLinkTrackingPort           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Parameter</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l01506">1506</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d1/d5/iop_8h-source.html#l00330">_LINK_TRACKING_PACKET::Event</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00331">_LINK_TRACKING_PACKET::FinalStatus</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00346">IopLinkTrackingServiceEvent</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00345">IopLinkTrackingServiceObject</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00253">KeReadStateEvent()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00091">LpcPortObjectType</a>, <a class="el" href="../../d2/d4/internal_8c.html#a4">MESSAGE_SIZE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d6/d5/lpcconn_8c-source.html#l00043">NtConnectPort()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d6/iop_8h.html#a60">PLINK_TRACKING_PACKET</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l06127">IopSendMessageToTrackService()</a>.
<p>
<pre class="fragment"><div>01512                    :
01513 
01514     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to connect to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user-mode link tracking service's
01515     LPC port.  It makes a connection which establishes a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> port,
01516     and then creates a referenced object pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> port.
01517 
01518 Arguments:
01519 
01520     Parameter - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> link tracking packet.
01521 
01522 Return Value:
01523 
01524     None.
01525 
01526 
01527 --*/
01528 
01529 {
01530 <span class="preprocessor">    #define MESSAGE_SIZE    ( (2 * sizeof( FILE_VOLUMEID_WITH_TYPE )) + \</span>
01531 <span class="preprocessor">                            sizeof( FILE_OBJECTID_BUFFER ) +              \</span>
01532 <span class="preprocessor">                            sizeof( GUID ) + \</span>
01533 <span class="preprocessor">                            sizeof( NTSTATUS ) + \</span>
01534 <span class="preprocessor">                            sizeof( ULONG ) )</span>
01535 <span class="preprocessor"></span>
01536     <a class="code" href="../../d8/d1/struct__LINK__TRACKING__PACKET.html">PLINK_TRACKING_PACKET</a> ltp;
01537     HANDLE serviceHandle;
01538     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01539 
01540     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01541     <span class="comment">//</span>
01542     <span class="comment">// Begin by getting a pointer to the link tracking packet.</span>
01543     <span class="comment">//</span>
01544 
01545     ltp = (<a class="code" href="../../d8/d1/struct__LINK__TRACKING__PACKET.html">PLINK_TRACKING_PACKET</a>) Parameter;
01546 
01547 
01548     <span class="comment">//</span>
01549     <span class="comment">// Ensure that the port has not already been opened.</span>
01550     <span class="comment">//</span>
01551 
01552     status = STATUS_SUCCESS;
01553     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d5/iodata_8c.html#a61">IopLinkTrackingServiceObject</a>) {
01554 
01555         UNICODE_STRING portName;
01556         ULONG maxMessageLength;
01557         SECURITY_QUALITY_OF_SERVICE dynamicQos;
01558 
01559         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/eventobj_8c.html#a6">KeReadStateEvent</a>( IopLinkTrackingServiceEvent )) {
01560 
01561             <span class="comment">//</span>
01562             <span class="comment">// Attempt to open a handle to the port.</span>
01563             <span class="comment">//</span>
01564 
01565             <span class="comment">//</span>
01566             <span class="comment">// Set up the security quality of service parameters to use over the</span>
01567             <span class="comment">// port.  Use the most efficient (least overhead) which is dynamic</span>
01568             <span class="comment">// rather than static tracking.</span>
01569             <span class="comment">//</span>
01570 
01571             dynamicQos.ImpersonationLevel = SecurityImpersonation;
01572             dynamicQos.ContextTrackingMode = SECURITY_DYNAMIC_TRACKING;
01573             dynamicQos.EffectiveOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01574 
01575             <span class="comment">//</span>
01576             <span class="comment">// Generate the string structure for describing the port.</span>
01577             <span class="comment">//</span>
01578 
01579             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;portName, L<span class="stringliteral">"\\Security\\TRKWKS_PORT"</span> );
01580 
01581             status = <a class="code" href="../../d5/d6/lpcconn_8c.html#a1">NtConnectPort</a>( &amp;serviceHandle,
01582                                     &amp;portName,
01583                                     &amp;dynamicQos,
01584                                     (PPORT_VIEW) NULL,
01585                                     (PREMOTE_PORT_VIEW) NULL,
01586                                     &amp;maxMessageLength,
01587                                     (PVOID) NULL,
01588                                     (PULONG) NULL );
01589             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01590                 <span class="keywordflow">if</span> (maxMessageLength &gt;= <a class="code" href="../../d2/d4/internal_8c.html#a4">MESSAGE_SIZE</a>) {
01591                     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( serviceHandle,
01592                                                         0,
01593                                                         LpcPortObjectType,
01594                                                         KernelMode,
01595                                                         &amp;IopLinkTrackingServiceObject,
01596                                                         NULL );
01597                     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( serviceHandle );
01598                 } <span class="keywordflow">else</span> {
01599                     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( serviceHandle );
01600                     status = STATUS_INVALID_PARAMETER;
01601                 }
01602             }
01603 
01604         } <span class="keywordflow">else</span> {
01605 
01606             <span class="comment">//</span>
01607             <span class="comment">// The service has not been started so the port does not exist.</span>
01608             <span class="comment">//</span>
01609 
01610             status = STATUS_OBJECT_NAME_NOT_FOUND;
01611         }
01612     }
01613 
01614 
01615     <span class="comment">//</span>
01616     <span class="comment">// Return final status and wake the caller up.</span>
01617     <span class="comment">//</span>
01618     ltp-&gt;<a class="code" href="../../d8/d1/struct__LINK__TRACKING__PACKET.html#o2">FinalStatus</a> = status;
01619     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;ltp-&gt;<a class="code" href="../../d8/d1/struct__LINK__TRACKING__PACKET.html#o1">Event</a>, 0, FALSE );
01620 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a224" doxytag="iop.h::IopCreateDefaultDeviceSecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PSECURITY_DESCRIPTOR IopCreateDefaultDeviceSecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN DEVICE_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceCharacteristics</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceHasName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACL *&nbsp;</td>
          <td class="mdname" nowrap> <em>AllocatedAcl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSECURITY_INFORMATION SecurityInformation&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12098">12098</a> of file <a class="el" href="../../d5/d5/iosubs_8c-source.html">iosubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01945">RtlCreateSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00871">RtlEqualSid()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00996">RtlGetAce()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02543">RtlSetDaclSecurityDescriptor()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01630">SeAliasAdminsSid</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01659">SePublicDefaultUnrestrictedDacl</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01661">SePublicOpenUnrestrictedDacl</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01609">SeWorldSid</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l04073">IoCreateDevice()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04759">IopChangeDeviceObjectFromRegistryProperties()</a>.
<p>
<pre class="fragment"><div>12106 {
12107     PSECURITY_DESCRIPTOR descriptor = (PSECURITY_DESCRIPTOR) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
12108 
12109     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
12110 
12111     <span class="keywordflow">if</span>(ARGUMENT_PRESENT(SecurityInformation)) {
12112         (*SecurityInformation) = 0;
12113     }
12114 
12115     *AllocatedAcl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
12116 
12117     <span class="keywordflow">switch</span> ( DeviceType ) {
12118 
12119         <span class="keywordflow">case</span> FILE_DEVICE_DISK_FILE_SYSTEM:
12120         <span class="keywordflow">case</span> FILE_DEVICE_CD_ROM_FILE_SYSTEM:
12121         <span class="keywordflow">case</span> FILE_DEVICE_FILE_SYSTEM:
12122         <span class="keywordflow">case</span> FILE_DEVICE_TAPE_FILE_SYSTEM: {
12123 
12124             <span class="comment">//</span>
12125             <span class="comment">// Use the standard public default protection for these types of devices.</span>
12126             <span class="comment">//</span>
12127 
12128             <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>(descriptor,
12129                                         SECURITY_DESCRIPTOR_REVISION );
12130 
12131             <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>(descriptor,
12132                                          TRUE,
12133                                          SePublicDefaultUnrestrictedDacl,
12134                                          FALSE );
12135 
12136             <span class="keywordflow">if</span>(ARGUMENT_PRESENT(SecurityInformation)) {
12137                 (*SecurityInformation) |= DACL_SECURITY_INFORMATION;
12138             }
12139 
12140             <span class="keywordflow">break</span>;
12141         }
12142 
12143         <span class="keywordflow">case</span> FILE_DEVICE_CD_ROM:
12144         <span class="keywordflow">case</span> FILE_DEVICE_MASS_STORAGE:
12145         <span class="keywordflow">case</span> FILE_DEVICE_DISK:
12146         <span class="keywordflow">case</span> FILE_DEVICE_VIRTUAL_DISK:
12147         <span class="keywordflow">case</span> FILE_DEVICE_NETWORK_FILE_SYSTEM:
12148         <span class="keywordflow">case</span> FILE_DEVICE_DFS_FILE_SYSTEM:
12149         <span class="keywordflow">case</span> FILE_DEVICE_NETWORK: {
12150 
12151             <span class="keywordflow">if</span> ((DeviceHasName) &amp;&amp;
12152                 ((DeviceCharacteristics &amp; FILE_FLOPPY_DISKETTE) != 0)) {
12153 
12154                 status = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>(
12155                             descriptor,
12156                             SECURITY_DESCRIPTOR_REVISION );
12157 
12158                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) );
12159 
12160                 status = <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>(
12161                             descriptor,
12162                             TRUE,
12163                             SePublicOpenUnrestrictedDacl,
12164                             FALSE );
12165 
12166                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) );
12167 
12168                 <span class="keywordflow">if</span>(ARGUMENT_PRESENT(SecurityInformation)) {
12169                     (*SecurityInformation) |= DACL_SECURITY_INFORMATION;
12170                 }
12171 
12172             } <span class="keywordflow">else</span> {
12173 
12174                 UCHAR i;
12175                 PACL acl;
12176                 BOOLEAN aceFound;
12177                 BOOLEAN aceFoundForCDROM;
12178                 PACCESS_ALLOWED_ACE ace;
12179 
12180                 <span class="comment">//</span>
12181                 <span class="comment">// Protect the device so that an administrator can run chkdsk</span>
12182                 <span class="comment">// on it. This is done by making a copy of the default public</span>
12183                 <span class="comment">// ACL and changing the accesses granted to the administrators</span>
12184                 <span class="comment">// alias.</span>
12185                 <span class="comment">//</span>
12186                 <span class="comment">// The logic here is:</span>
12187                 <span class="comment">//</span>
12188                 <span class="comment">//      - Copy the public default dacl into another buffer</span>
12189                 <span class="comment">//</span>
12190                 <span class="comment">//      - Find the ACE granting ADMINISTRATORS access</span>
12191                 <span class="comment">//</span>
12192                 <span class="comment">//      - Change the granted access mask of that ACE to give</span>
12193                 <span class="comment">//        administrators write access.</span>
12194                 <span class="comment">//</span>
12195                 <span class="comment">//</span>
12196 
12197                 acl = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
12198                         PagedPool,
12199                         <a class="code" href="../../d0/d5/se_8h.html#a74">SePublicDefaultUnrestrictedDacl</a>-&gt;AclSize,
12200                         'eSoI' );
12201 
12202                 <span class="keywordflow">if</span> (!acl) {
12203                     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
12204                 }
12205 
12206                 RtlCopyMemory( acl,
12207                                SePublicDefaultUnrestrictedDacl,
12208                                <a class="code" href="../../d0/d5/se_8h.html#a74">SePublicDefaultUnrestrictedDacl</a>-&gt;AclSize );
12209 
12210                 <span class="comment">//</span>
12211                 <span class="comment">// Find the Administrators ACE</span>
12212                 <span class="comment">//</span>
12213 
12214                 aceFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
12215                 aceFoundForCDROM = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
12216 
12217                 <span class="keywordflow">for</span> ( i = 0, status = <a class="code" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a>(acl, 0, &amp;ace);
12218                       <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status);
12219                       i++, status = <a class="code" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a>(acl, i, &amp;ace)) {
12220 
12221                     PSID sid;
12222 
12223                     sid = &amp;(ace-&gt;SidStart);
12224                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( SeAliasAdminsSid, sid )) {
12225                         PACCESS_MASK mask;
12226 
12227                         ace-&gt;Mask |= ( GENERIC_READ |
12228                                        GENERIC_WRITE |
12229                                        GENERIC_EXECUTE );
12230 
12231                         aceFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
12232                     }
12233 
12234                     <span class="keywordflow">if</span> (DeviceType == FILE_DEVICE_CD_ROM) {
12235 
12236                          <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( SeWorldSid, sid )) {
12237                              ace-&gt;Mask |= GENERIC_READ;
12238                              aceFoundForCDROM = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
12239                          }
12240                      }
12241                 }
12242 
12243                 <span class="comment">//</span>
12244                 <span class="comment">// If the ACE wasn't found, then the public default ACL has been</span>
12245                 <span class="comment">// changed.  For this case, this code needs to be updated to match</span>
12246                 <span class="comment">// the new public default DACL.</span>
12247                 <span class="comment">//</span>
12248 
12249                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(aceFound == TRUE);
12250 
12251                 <span class="keywordflow">if</span> (DeviceType == FILE_DEVICE_CD_ROM) {
12252                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(aceFoundForCDROM == TRUE);
12253                 }
12254 
12255                 <span class="comment">//</span>
12256                 <span class="comment">// Finally, build a full security descriptor from the above DACL.</span>
12257                 <span class="comment">//</span>
12258 
12259                 <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>( descriptor,
12260                                              SECURITY_DESCRIPTOR_REVISION );
12261 
12262                 <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>( descriptor,
12263                                               TRUE,
12264                                               acl,
12265                                               FALSE );
12266 
12267                 <span class="keywordflow">if</span>(ARGUMENT_PRESENT(SecurityInformation)) {
12268                     (*SecurityInformation) |= DACL_SECURITY_INFORMATION;
12269                 }
12270 
12271                 *AllocatedAcl = acl;
12272             }
12273 
12274             <span class="keywordflow">break</span>;
12275         }
12276 
12277         <span class="keywordflow">default</span>: {
12278 
12279             status = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>( descriptor,
12280                                                   SECURITY_DESCRIPTOR_REVISION );
12281             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) );
12282 
12283             status = <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>( descriptor,
12284                                                    TRUE,
12285                                                    SePublicOpenUnrestrictedDacl,
12286                                                    FALSE );
12287 
12288             <span class="keywordflow">if</span>(ARGUMENT_PRESENT(SecurityInformation)) {
12289                 (*SecurityInformation) |= DACL_SECURITY_INFORMATION;
12290             }
12291 
12292             <span class="keywordflow">break</span>;
12293         }
12294     }
12295 
12296     <span class="keywordflow">return</span> descriptor;
12297 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a159" doxytag="iop.h::IopCreateVpb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopCreateVpb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/iosubs_8c-source.html#l04053">4053</a> of file <a class="el" href="../../d5/d5/iosubs_8c-source.html">iosubs.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00044">IO_TYPE_VPB</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01073">_VPB::RealDevice</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01069">_VPB::Size</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01068">_VPB::Type</a>, <a class="el" href="../../d0/d5/io_8h.html#a332">VPB</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01186">_DEVICE_OBJECT::Vpb</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l04073">IoCreateDevice()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11389">IoVerifyVolume()</a>.
<p>
<pre class="fragment"><div>04056 {
04057     <a class="code" href="../../d7/d7/struct__VPB.html">PVPB</a> Vpb;
04058 
04059     Vpb = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
04060                 NonPagedPoolMustSucceed,
04061                 <span class="keyword">sizeof</span>( <a class="code" href="../../d7/d7/struct__VPB.html">VPB</a> ),
04062                 ' bpV'
04063                 );
04064 
04065     RtlZeroMemory (Vpb, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d7/struct__VPB.html">VPB</a>));
04066     Vpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o0">Type</a> = <a class="code" href="../../d0/d5/io_8h.html#a9">IO_TYPE_VPB</a>;
04067     Vpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o1">Size</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d7/d7/struct__VPB.html">VPB</a> );
04068     Vpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o5">RealDevice</a> = DeviceObject;
04069     DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o10">Vpb</a> = Vpb;
04070 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a160" doxytag="iop.h::IopDeallocateApc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopDeallocateApc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Apc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l01771">1771</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08769">IoRaiseHardError()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08909">IoRaiseInformationalHardError()</a>.
<p>
<pre class="fragment"><div>01781                    :
01782 
01783     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to deallocate an APC that was used to queue a
01784     request to a target thread.  It simple deallocates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC.
01785 
01786 Arguments:
01787 
01788     Apc - Supplies a pointer to kernel APC structure.
01789 
01790     NormalRoutine - Supplies a pointer to a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> normal function
01791         that was specified when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC was initialied.
01792 
01793     NormalContext - Supplies a pointer to a pointer to an arbitrary data
01794         structure that was specified when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC was initialized.
01795 
01796     SystemArgument1, SystemArgument2 - Supplies a set of two pointers to
01797         two arguments that contain untyped data.
01798 
01799 Return Value:
01800 
01801     None.
01802 
01803 --*/
01804 
01805 {
01806     UNREFERENCED_PARAMETER( NormalRoutine );
01807     UNREFERENCED_PARAMETER( NormalContext );
01808     UNREFERENCED_PARAMETER( SystemArgument1 );
01809     UNREFERENCED_PARAMETER( SystemArgument2 );
01810 
01811     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01812 
01813     <span class="comment">//</span>
01814     <span class="comment">// Free the APC.</span>
01815     <span class="comment">//</span>
01816 
01817     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Apc );
01818 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a161" doxytag="iop.h::IopDecrementDeviceObjectRef" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopDecrementDeviceObjectRef           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AlwaysUnload</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l04022">4022</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01221">DOE_DELETE_PENDING</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01222">DOE_REMOVE_PENDING</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01220">DOE_UNLOAD_PENDING</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00657">IopCompleteUnloadOrDelete()</a>, and <a class="el" href="../../d4/d4/iodata_8c-source.html#l00054">IopDatabaseLock</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05378">IoCreateStreamFileObject()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05535">IoCreateStreamFileObjectLite()</a>, <a class="el" href="../../d5/d2/parse_8c-source.html#l00098">IopCheckVpbMounted()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00417">IopDeleteFile()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04077">IopLoadFileSystemDriver()</a>, and <a class="el" href="../../d5/d2/parse_8c-source.html#l00202">IopParseDevice()</a>.
<p>
<pre class="fragment"><div>04029                    :
04030 
04031     The routine decrements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count on a device object.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04032     reference count goes to zero and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a candidate <span class="keywordflow">for</span> deletion
04033     then <a class="code" href="../../d2/d4/internal_8c.html#a26">IopCompleteUnloadOrDelete</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> device object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> subject <span class="keywordflow">for</span>
04034     deletion <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AlwaysUnload flag <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keyword">true</span>, or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> pending
04035     deletion or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> pending unload.
04036 
04037 Arguments:
04038 
04039     DeviceObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object whose reference count <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be
04040                    decremented.
04041 
04042     AlwaysUnload - Indicates <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver should be unloaded regardless of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04043                    state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unload flag.
04044 
04045 Return Value:
04046 
04047     None.
04048 
04049 --*/
04050 {
04051     KIRQL irql;
04052 
04053     <span class="comment">//</span>
04054     <span class="comment">// Decrement the reference count on the device object.  If this is the last</span>
04055     <span class="comment">// last reason that this mini-file system recognizer needs to stay around,</span>
04056     <span class="comment">// then unload it.</span>
04057     <span class="comment">//</span>
04058 
04059     ExAcquireSpinLock( &amp;IopDatabaseLock, &amp;irql );
04060 
04061     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( DeviceObject-&gt;ReferenceCount &gt; 0 );
04062 
04063     DeviceObject-&gt;ReferenceCount--;
04064 
04065     <span class="keywordflow">if</span> (!DeviceObject-&gt;ReferenceCount &amp;&amp; (AlwaysUnload ||
04066          DeviceObject-&gt;DeviceObjectExtension-&gt;ExtensionFlags &amp;
04067          (<a class="code" href="../../d0/d5/io_8h.html#a139">DOE_DELETE_PENDING</a> | <a class="code" href="../../d0/d5/io_8h.html#a138">DOE_UNLOAD_PENDING</a> | <a class="code" href="../../d0/d5/io_8h.html#a140">DOE_REMOVE_PENDING</a>))) {
04068 
04069         <a class="code" href="../../d0/d6/iop_8h.html#a155">IopCompleteUnloadOrDelete</a>( DeviceObject, irql );
04070     } <span class="keywordflow">else</span> {
04071         ExReleaseSpinLock( &amp;IopDatabaseLock, irql );
04072     }
04073 
04074 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a163" doxytag="iop.h::IopDeleteDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopDeleteDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Object</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/objsup_8c-source.html#l00769">769</a> of file <a class="el" href="../../d4/d0/objsup_8c-source.html">objsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00147">ASSERTMSG</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01070">_VPB::Flags</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a284">IopDestroyDeviceNode()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01075">_VPB::ReferenceCount</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01186">_DEVICE_OBJECT::Vpb</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01055">VPB_LOCKED</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01054">VPB_MOUNTED</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01936">IopCreateObjectTypes()</a>.
<p>
<pre class="fragment"><div>00775                    :
00776 
00777     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count <span class="keywordflow">for</span> a device object
00778     becomes zero.  That <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last reference <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device has gone away.
00779     This routine ensures that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> cleaned up and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver object
00780     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> dereferenced.
00781 
00782 Arguments:
00783 
00784     Object - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver object whose reference count has gone
00785         to zero.
00786 
00787 Return value:
00788 
00789     None.
00790 
00791 --*/
00792 
00793 {
00794     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) Object;
00795     <a class="code" href="../../d7/d7/struct__VPB.html">PVPB</a> vpb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00796 
00797     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00798 
00799     <a class="code" href="../../d9/d0/pnpiop_8h.html#a284">IopDestroyDeviceNode</a>(deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>);
00800 
00801 <span class="preprocessor">#if DBG</span>
00802 <span class="preprocessor"></span>    IopCheckDeviceNodeTree (deviceObject, NULL);
00803 <span class="preprocessor">#endif</span>
00804 <span class="preprocessor"></span>
00805     <span class="comment">//</span>
00806     <span class="comment">// If there's still a VPB attached then free it.</span>
00807     <span class="comment">//</span>
00808 
00809     vpb = InterlockedExchangePointer(&amp;(deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o10">Vpb</a>), vpb);
00810 
00811     <span class="keywordflow">if</span>(vpb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00812 
00813         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>(<span class="stringliteral">"Unreferenced device object to be deleted is still in use"</span>,
00814                   ((vpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o2">Flags</a> &amp; (VPB_MOUNTED | VPB_LOCKED)) == 0));
00815 
00816         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(vpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o7">ReferenceCount</a> == 0);
00817         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(vpb);
00818     }
00819     <span class="keywordflow">if</span> (deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00820         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a> );
00821     }
00822 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a162" doxytag="iop.h::IopDeleteDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopDeleteDriver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Object</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/objsup_8c-source.html#l00698">698</a> of file <a class="el" href="../../d4/d0/objsup_8c-source.html">objsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01350">_DRIVER_EXTENSION::ClientDriverExtension</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01366">_DRIVER_OBJECT::DeviceObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01378">_DRIVER_OBJECT::DriverExtension</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01385">_DRIVER_OBJECT::DriverName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01377">_DRIVER_OBJECT::DriverSection</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d8/d0/genuedef_8c-source.html#l00009">extension</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">MmUnloadSystemImage()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01337">_DRIVER_EXTENSION::ServiceKeyName</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01936">IopCreateObjectTypes()</a>.
<p>
<pre class="fragment"><div>00704                    :
00705 
00706     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count <span class="keywordflow">for</span> a driver object
00707     becomes zero.  That <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last reference <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver has gone away.
00708     This routine ensures that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> cleaned up and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver
00709     unloaded.
00710 
00711 Arguments:
00712 
00713     Object - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver object whose reference count has gone
00714         to zero.
00715 
00716 Return value:
00717 
00718     None.
00719 
00720 --*/
00721 
00722 {
00723     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject = (<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>) Object;
00724     <a class="code" href="../../d1/d4/struct__IO__CLIENT__EXTENSION.html">PIO_CLIENT_EXTENSION</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>;
00725     <a class="code" href="../../d1/d4/struct__IO__CLIENT__EXTENSION.html">PIO_CLIENT_EXTENSION</a> nextExtension;
00726 
00727     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00728 
00729     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o2">DeviceObject</a> );
00730 
00731     <span class="comment">//</span>
00732     <span class="comment">// Free any client driver object extensions.</span>
00733     <span class="comment">//</span>
00734 
00735     <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a> = driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o4">ClientDriverExtension</a>;
00736     <span class="keywordflow">while</span> (<a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00737 
00738         nextExtension = <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>-&gt;NextExtension;
00739         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( extension );
00740         <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a> = nextExtension;
00741     }
00742 
00743     <span class="comment">//</span>
00744     <span class="comment">// If there is a driver section then unload the driver.</span>
00745     <span class="comment">//</span>
00746 
00747     <span class="keywordflow">if</span> (driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o6">DriverSection</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00748         <a class="code" href="../../d8/d8/sysload_8c.html#a59">MmUnloadSystemImage</a>( driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o6">DriverSection</a> );
00749     }
00750 
00751     <span class="comment">//</span>
00752     <span class="comment">// Free the pool associated with the name of the driver.</span>
00753     <span class="comment">//</span>
00754 
00755     <span class="keywordflow">if</span> (driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>.Buffer) {
00756         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>.Buffer );
00757     }
00758 
00759     <span class="comment">//</span>
00760     <span class="comment">// Free the pool associated with the service key name of the driver.</span>
00761     <span class="comment">//</span>
00762 
00763     <span class="keywordflow">if</span> (driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>.Buffer) {
00764         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>.Buffer );
00765     }
00766 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a164" doxytag="iop.h::IopDeleteFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopDeleteFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Object</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/objsup_8c-source.html#l00417">417</a> of file <a class="el" href="../../d4/d0/objsup_8c-source.html">objsup.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01541">_FILE_OBJECT::CompletionContext</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01517">_FILE_OBJECT::DeviceObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01162">DO_NEVER_LAST_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01540">_FILE_OBJECT::Event</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a235">ExInterlockedAddUlong()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01534">_FILE_OBJECT::FileName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01533">_FILE_OBJECT::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01184">_DEVICE_OBJECT::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01501">FO_DIRECT_DEVICE_OPEN</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01508">FO_HANDLE_CREATED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01491">FO_SYNCHRONOUS_IO</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00652">IoAllocateIrp()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06632">IoFreeIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06786">IoGetAttachedDevice()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00595">IopAcquireFastLock</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00181">IopAcquireFileObjectLock()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00336">IopAllocateIrpMustSucceed()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00036">IopCloseFile()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00054">IopDatabaseLock</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04022">IopDecrementDeviceObjectRef()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00758">IopDequeueThreadIrp</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01103">IopQueueThreadIrp</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00042">IopVpbSpinLock</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01561">IRP_CLOSE_OPERATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00057">IRP_MJ_CLOSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01552">IRP_SYNCHRONOUS_API</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01482">_IO_COMPLETION_CONTEXT::Port</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01075">_VPB::ReferenceCount</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01178">_DEVICE_OBJECT::ReferenceCount</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01518">_FILE_OBJECT::Vpb</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01936">IopCreateObjectTypes()</a>, and <a class="el" href="../../d5/d2/parse_8c-source.html#l00202">IopParseDevice()</a>.
<p>
<pre class="fragment"><div>00423                    :
00424 
00425     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last handle to a specific <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> handle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00426     being closed and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> going away.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> responsibility
00427     of <span class="keyword">this</span> routine to perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a>:
00428 
00429         o  Notify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device driver that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> open on that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00430            <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being closed.
00431 
00432         o  Dereference <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user's error port <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object, <span class="keywordflow">if</span> there
00433            <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> one associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.
00434 
00435         o  Decrement <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object reference count.
00436 
00437 Arguments:
00438 
00439     Object - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object being deleted.
00440 
00441 Return Value:
00442 
00443     None.
00444 
00445 --*/
00446 
00447 {
00448     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00449     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00450     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00451     IO_STATUS_BLOCK ioStatusBlock;
00452     KIRQL irql;
00453     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00454     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
00455     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
00456     <a class="code" href="../../d7/d7/struct__VPB.html">PVPB</a> vpb;
00457     BOOLEAN referenceCountDecremented;
00458 
00459     <span class="comment">//</span>
00460     <span class="comment">// Obtain a pointer to the file object.</span>
00461     <span class="comment">//</span>
00462 
00463     fileObject = (<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>) Object;
00464 
00465     <span class="comment">//</span>
00466     <span class="comment">// Get a pointer to the first device driver which should be notified that</span>
00467     <span class="comment">// this file is going away.  If the device driver field is NULL, then this</span>
00468     <span class="comment">// file is being shut down due to an error attempting to get it open in the</span>
00469     <span class="comment">// first place, so do not do any further processing.</span>
00470     <span class="comment">//</span>
00471 
00472     <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a>) {
00473         <span class="keywordflow">if</span> (!(fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a161">FO_DIRECT_DEVICE_OPEN</a>)) {
00474             deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( fileObject );
00475         } <span class="keywordflow">else</span> {
00476             deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a66">IoGetAttachedDevice</a>( fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a> );
00477         }
00478 
00479         <span class="comment">//</span>
00480         <span class="comment">// If this file has never had a file handle created for it, and yet</span>
00481         <span class="comment">// it exists, invoke the close file procedure so that the file system</span>
00482         <span class="comment">// gets the cleanup IRP it is expecting before sending the close IRP.</span>
00483         <span class="comment">//</span>
00484 
00485         <span class="keywordflow">if</span> (!(fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a168">FO_HANDLE_CREATED</a>)) {
00486             <a class="code" href="../../d3/d1/objsup_8c.html#a0">IopCloseFile</a>( (<a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>) NULL,
00487                           Object,
00488                           0,
00489                           1,
00490                           1 );
00491         }
00492 
00493         <span class="comment">//</span>
00494         <span class="comment">// If this file is open for synchronous I/O, wait until this thread</span>
00495         <span class="comment">// owns it exclusively since there may still be a thread using it.</span>
00496         <span class="comment">// This occurs when a system service owns the file because it owns</span>
00497         <span class="comment">// the semaphore, but the I/O completion code has already dereferenced</span>
00498         <span class="comment">// the file object itself.  Without waiting here for the same semaphore</span>
00499         <span class="comment">// there would be a race condition in the service who owns it now.  The</span>
00500         <span class="comment">// service needs to be able to access the object w/o it going away after</span>
00501         <span class="comment">// its wait for the file event is satisfied.</span>
00502         <span class="comment">//</span>
00503 
00504         <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
00505 
00506             BOOLEAN interrupted;
00507 
00508             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a13">IopAcquireFastLock</a>( fileObject )) {
00509                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d0/d6/iop_8h.html#a147">IopAcquireFileObjectLock</a>( fileObject,
00510                                                  KernelMode,
00511                                                  FALSE,
00512                                                  &amp;interrupted );
00513             }
00514         }
00515 
00516         <span class="comment">//</span>
00517         <span class="comment">// Reset a local event that can be used to wait for the device driver</span>
00518         <span class="comment">// to close the file.</span>
00519         <span class="comment">//</span>
00520 
00521         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event, SynchronizationEvent, FALSE );
00522 
00523         <span class="comment">//</span>
00524         <span class="comment">// Reset the event in the file object.</span>
00525         <span class="comment">//</span>
00526 
00527         <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a> );
00528 
00529         <span class="comment">//</span>
00530         <span class="comment">// Allocate an I/O Request Packet (IRP) to be used in communicating with</span>
00531         <span class="comment">// the appropriate device driver that the file is being closed.  Notice</span>
00532         <span class="comment">// that the allocation of this packet is done without charging quota so</span>
00533         <span class="comment">// that the operation will not fail.  This is done because there is no</span>
00534         <span class="comment">// way to return an error to the caller at this point.</span>
00535         <span class="comment">//</span>
00536 
00537         irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>( deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>, FALSE );
00538         <span class="keywordflow">if</span> (!irp) {
00539             irp = <a class="code" href="../../d0/d6/iop_8h.html#a149">IopAllocateIrpMustSucceed</a>( deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a> );
00540         }
00541 
00542         <span class="comment">//</span>
00543         <span class="comment">// Get a pointer to the stack location for the first driver.  This is</span>
00544         <span class="comment">// where the function codes and parameters are placed.</span>
00545         <span class="comment">//</span>
00546 
00547         irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
00548 
00549         <span class="comment">//</span>
00550         <span class="comment">// Fill in the IRP, indicating that this file object is being deleted.</span>
00551         <span class="comment">//</span>
00552 
00553         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a15">IRP_MJ_CLOSE</a>;
00554         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = fileObject;
00555         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;ioStatusBlock;
00556         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = &amp;event;
00557         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = fileObject;
00558         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00559         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = (PVOID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00560         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a185">IRP_CLOSE_OPERATION</a> | <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>;
00561 
00562         <span class="comment">//</span>
00563         <span class="comment">// Place this packet in the thread's I/O pending queue.</span>
00564         <span class="comment">//</span>
00565 
00566         <a class="code" href="../../d0/d6/iop_8h.html#a21">IopQueueThreadIrp</a>( irp );
00567 
00568         <span class="comment">//</span>
00569         <span class="comment">// Decrement the reference count on the VPB, if necessary.  We</span>
00570         <span class="comment">// have to do this BEFORE handing the Irp to the file system</span>
00571         <span class="comment">// because of a trick the file systems play with close, and</span>
00572         <span class="comment">// believe me, you really don't want to know what it is.</span>
00573         <span class="comment">//</span>
00574         <span class="comment">// Since there is not a error path here (close cannot fail),</span>
00575         <span class="comment">// and the file system is the only ome who can actually synchronize</span>
00576         <span class="comment">// with the actual completion of close processing, the file system</span>
00577         <span class="comment">// is the one responsible for Vpb deletion.</span>
00578         <span class="comment">//</span>
00579 
00580         vpb = fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o3">Vpb</a>;
00581 
00582         <span class="keywordflow">if</span> (vpb &amp;&amp; !(fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a161">FO_DIRECT_DEVICE_OPEN</a>)) {
00583             <a class="code" href="../../d5/d8/ex_8h.html#a235">ExInterlockedAddUlong</a>( &amp;vpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o7">ReferenceCount</a>,
00584                                    0xffffffff,
00585                                    &amp;IopVpbSpinLock );
00586         }
00587 
00588         <span class="comment">//</span>
00589         <span class="comment">// If this device object has stated for a fact that it knows it will</span>
00590         <span class="comment">// never have the final non-zero reference count among the other</span>
00591         <span class="comment">// device objects associated with our driver object, then decrement</span>
00592         <span class="comment">// our reference count here BEFORE calling the file system.  This</span>
00593         <span class="comment">// is required because for a special class of device objects, the</span>
00594         <span class="comment">// file system may delete them.</span>
00595         <span class="comment">//</span>
00596 
00597         <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a131">DO_NEVER_LAST_DEVICE</a>) {
00598             <a class="code" href="../../d5/d8/ex_8h.html#a235">ExInterlockedAddUlong</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o2">ReferenceCount</a>,
00599                                    0xffffffff,
00600                                    &amp;IopDatabaseLock );
00601 
00602             referenceCountDecremented = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00603         } <span class="keywordflow">else</span> {
00604             referenceCountDecremented = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00605         }
00606 
00607         <span class="comment">//</span>
00608         <span class="comment">// Give the device driver the packet.  If this request does not work,</span>
00609         <span class="comment">// there is nothing that can be done about it.  This is unfortunate</span>
00610         <span class="comment">// because the driver may have had problems that it was about to</span>
00611         <span class="comment">// report about other operations (e.g., write behind failures, etc.)</span>
00612         <span class="comment">// that it can no longer report.  The reason is that this routine</span>
00613         <span class="comment">// is really initially invoked by NtClose, which has already closed</span>
00614         <span class="comment">// the caller's handle, and that's what the return status from close</span>
00615         <span class="comment">// indicates:  the handle has successfully been closed.</span>
00616         <span class="comment">//</span>
00617 
00618         status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject, irp );
00619 
00620         <span class="keywordflow">if</span> (status == STATUS_PENDING) {
00621             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
00622                                           Executive,
00623                                           KernelMode,
00624                                           FALSE,
00625                                           (PLARGE_INTEGER) NULL );
00626         }
00627 
00628         <span class="comment">//</span>
00629         <span class="comment">// Perform any completion operations that need to be performed on</span>
00630         <span class="comment">// the IRP that was used for this request.  This is done here as</span>
00631         <span class="comment">// as opposed to in normal completion code because there is a race</span>
00632         <span class="comment">// condition between when this routine executes if it was invoked</span>
00633         <span class="comment">// from a special kernel APC (e.g., some IRP was just completed and</span>
00634         <span class="comment">// dereferenced this file object for the last time), and when the</span>
00635         <span class="comment">// special kernel APC because of this packet's completion executing.</span>
00636         <span class="comment">//</span>
00637         <span class="comment">// This problem is solved by not having to queue a special kernel</span>
00638         <span class="comment">// APC routine for completion of this packet.  Rather, it is treated</span>
00639         <span class="comment">// much like a synchronous paging I/O operation, except that the</span>
00640         <span class="comment">// packet is not even freed during I/O completion.  This is because</span>
00641         <span class="comment">// the packet is still in this thread's queue, and there is no way</span>
00642         <span class="comment">// to get it out except at APC_LEVEL.  Unfortunately, the part of</span>
00643         <span class="comment">// I/O completion that needs to dequeue the packet is running at</span>
00644         <span class="comment">// DISPATCH_LEVEL.</span>
00645         <span class="comment">//</span>
00646         <span class="comment">// Hence, the packet must be removed from the queue (synchronized,</span>
00647         <span class="comment">// of course), and then it must be freed.</span>
00648         <span class="comment">//</span>
00649 
00650         <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>( APC_LEVEL, &amp;irql );
00651         <a class="code" href="../../d0/d6/iop_8h.html#a18">IopDequeueThreadIrp</a>( irp );
00652         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>( irql );
00653 
00654         <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>( irp );
00655 
00656         <span class="comment">//</span>
00657         <span class="comment">// Free the file name string buffer if there was one.</span>
00658         <span class="comment">//</span>
00659 
00660         <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.Length != 0) {
00661             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.Buffer );
00662         }
00663 
00664         <span class="comment">//</span>
00665         <span class="comment">// If there was an completion port associated w/this file object, dereference</span>
00666         <span class="comment">// it now, and deallocate the completion context pool.</span>
00667         <span class="comment">//</span>
00668 
00669         <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o26">CompletionContext</a>) {
00670             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o26">CompletionContext</a>-&gt;<a class="code" href="../../d2/d4/struct__IO__COMPLETION__CONTEXT.html#o0">Port</a> );
00671             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o26">CompletionContext</a> );
00672         }
00673 
00674         <span class="comment">//</span>
00675         <span class="comment">// Get a pointer to the real device object so its reference count</span>
00676         <span class="comment">// can be decremented.</span>
00677         <span class="comment">//</span>
00678 
00679         deviceObject = fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a>;
00680 
00681         <span class="comment">//</span>
00682         <span class="comment">// Decrement the reference count on the device object.  Note that</span>
00683         <span class="comment">// if the driver has been marked for an unload operation, and the</span>
00684         <span class="comment">// reference count goes to zero, then the driver may need to be</span>
00685         <span class="comment">// unloaded at this point.</span>
00686         <span class="comment">//</span>
00687         <span class="comment">// Note: only do this if the reference count was not already done</span>
00688         <span class="comment">// above.  The device object may be gone in this case.</span>
00689         <span class="comment">//</span>
00690 
00691         <span class="keywordflow">if</span> (!referenceCountDecremented) {
00692             <a class="code" href="../../d0/d6/iop_8h.html#a161">IopDecrementDeviceObjectRef</a>( deviceObject, FALSE );
00693         }
00694     }
00695 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a165" doxytag="iop.h::IopDeleteIoCompletion" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopDeleteIoCompletion           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Object</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d3/complete_8c-source.html#l00864">864</a> of file <a class="el" href="../../d6/d3/complete_8c-source.html">complete.c</a>.
<p>
References <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06632">IoFreeIrp()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a241a141">IopCompletionPacketIrp</a>, <a class="el" href="../../d6/d3/complete_8c-source.html#l00797">IopFreeMiniPacket()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d9/d2/queueobj_8c-source.html#l00570">KeRundownQueue()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00401">_IOP_MINI_COMPLETION_PACKET::ListEntry</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d5/iop_8h-source.html#l00418">_IOP_MINI_COMPLETION_PACKET::PacketType</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01936">IopCreateObjectTypes()</a>.
<p>
<pre class="fragment"><div>00870                    :
00871 
00872     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">delete</span> routine <span class="keywordflow">for</span> I/O completion objects. Its
00873     function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to release all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entries in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> repsective completion
00874     queue and to rundown all threads that are current associated.
00875 
00876 Arguments:
00877 
00878     Object - Supplies a pointer to an executive I/O completion object.
00879 
00880 Return Value:
00881 
00882     None.
00883 
00884 --*/
00885 
00886 {
00887 
00888     PLIST_ENTRY FirstEntry;
00889     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
00890     PLIST_ENTRY NextEntry;
00891     <a class="code" href="../../d9/d0/struct__IOP__MINI__COMPLETION__PACKET.html">PIOP_MINI_COMPLETION_PACKET</a> MiniPacket;
00892 
00893     <span class="comment">//</span>
00894     <span class="comment">// Rundown threads associated with the I/O completion object and get</span>
00895     <span class="comment">// the list of unprocessed I/O completion IRPs.</span>
00896     <span class="comment">//</span>
00897 
00898     FirstEntry = <a class="code" href="../../d8/d3/queueobj_8c.html#a6">KeRundownQueue</a>((<a class="code" href="../../d7/d7/struct__KQUEUE.html">PKQUEUE</a>)Object);
00899     <span class="keywordflow">if</span> (FirstEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00900         NextEntry = FirstEntry;
00901         <span class="keywordflow">do</span> {
00902             MiniPacket = CONTAINING_RECORD(NextEntry,
00903                                            <a class="code" href="../../d9/d0/struct__IOP__MINI__COMPLETION__PACKET.html">IOP_MINI_COMPLETION_PACKET</a>,
00904                                            ListEntry);
00905 
00906             NextEntry = NextEntry-&gt;Flink;
00907             <span class="keywordflow">if</span> (MiniPacket-&gt;<a class="code" href="../../d9/d0/struct__IOP__MINI__COMPLETION__PACKET.html#o2">PacketType</a> == <a class="code" href="../../d0/d6/iop_8h.html#a241a141">IopCompletionPacketIrp</a>) {
00908                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = CONTAINING_RECORD(MiniPacket, <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>, Tail.Overlay.ListEntry);
00909                 <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>(Irp);
00910 
00911             } <span class="keywordflow">else</span> {
00912                 <a class="code" href="../../d5/d4/complete_8c.html#a0">IopFreeMiniPacket</a>(MiniPacket);
00913             }
00914 
00915         } <span class="keywordflow">while</span> (FirstEntry != NextEntry);
00916     }
00917 
00918     <span class="keywordflow">return</span>;
00919 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a166" doxytag="iop.h::IopDisassociateThreadIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopDisassociateThreadIrp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l01623">1623</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01655">_IRP::CurrentLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02488">_IO_STACK_LOCATION::DeviceObject</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00428">IoAllocateErrorLogEntry()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00196">IopCompletionLock</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00056">IopDeadIrp</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11556">IoWriteErrorLogEntry()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00414">_ETHREAD::IrpList</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01654">_IRP::StackCount</a>, and <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02242">IoCancelThreadIo()</a>.
<p>
<pre class="fragment"><div>01629                    :
01630 
01631     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O requests <span class="keywordflow">for</span> a thread are being
01632     cancelled, but there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a packet at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread's queue that
01633     has not been completed <span class="keywordflow">for</span> such a <span class="keywordtype">long</span> period of time that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> has timed
01634     <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keyword">this</span> routine's responsibility to <span class="keywordflow">try</span> to disassociate that
01635     <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> with <span class="keyword">this</span> thread.
01636 
01637 Arguments:
01638 
01639     None.
01640 
01641 Return Value:
01642 
01643     None.
01644 
01645 --*/
01646 
01647 {
01648     KIRQL irql;
01649     KIRQL spIrql;
01650     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
01651     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> thread;
01652     PLIST_ENTRY entry;
01653     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
01654     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
01655     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
01656     WCHAR buffer[512];
01657     POBJECT_NAME_INFORMATION nameInformation;
01658     ULONG nameLength;
01659     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01660     ULONG response;
01661     PIO_ERROR_LOG_PACKET errorLogEntry;
01662 
01663     <span class="comment">//</span>
01664     <span class="comment">// Begin by ensuring that the packet has not already been removed from</span>
01665     <span class="comment">// the thread's queue.</span>
01666     <span class="comment">//</span>
01667 
01668     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>( APC_LEVEL, &amp;irql );
01669 
01670     thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01671 
01672     <span class="comment">//</span>
01673     <span class="comment">// If there are no packets on the IRP list, then simply return now.</span>
01674     <span class="comment">// All of the packets have been fully completed, so the caller will also</span>
01675     <span class="comment">// simply return to its caller.</span>
01676     <span class="comment">//</span>
01677 
01678     <span class="keywordflow">if</span> (IsListEmpty( &amp;thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o18">IrpList</a> )) {
01679         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>( irql );
01680         <span class="keywordflow">return</span>;
01681     }
01682 
01683     <span class="comment">//</span>
01684     <span class="comment">// Get a pointer to the first packet on the queue, and begin examining</span>
01685     <span class="comment">// it.  Note that because the processor is at raised IRQL, and because</span>
01686     <span class="comment">// the packet can only be removed in the context of the currently</span>
01687     <span class="comment">// executing thread, that it is not possible for the packet to be removed</span>
01688     <span class="comment">// from the list.  On the other hand, it IS possible for the packet to</span>
01689     <span class="comment">// be queued to the thread's APC list at this point, and this must be</span>
01690     <span class="comment">// blocked/synchronized in order to examine the request.</span>
01691     <span class="comment">//</span>
01692     <span class="comment">// Begin, therefore, by acquiring the I/O completion spinlock, so that</span>
01693     <span class="comment">// the packet can be safely examined.</span>
01694     <span class="comment">//</span>
01695 
01696     ExAcquireSpinLock( &amp;IopCompletionLock, &amp;spIrql );
01697 
01698     <span class="comment">//</span>
01699     <span class="comment">// Check to see whether or not the packet has been completed (that is,</span>
01700     <span class="comment">// queued to the current thread).  If not, change threads.</span>
01701     <span class="comment">//</span>
01702 
01703     entry = thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o18">IrpList</a>.Flink;
01704     irp = CONTAINING_RECORD( entry, <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>, ThreadListEntry );
01705 
01706     <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a> == irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o12">StackCount</a> + 2) {
01707 
01708         <span class="comment">//</span>
01709         <span class="comment">// The request has just gone through enough of completion that</span>
01710         <span class="comment">// queueing it to the thread is inevitable.  Simply release the</span>
01711         <span class="comment">// lock and return.</span>
01712         <span class="comment">//</span>
01713 
01714         ExReleaseSpinLock( &amp;IopCompletionLock, spIrql );
01715         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>( irql );
01716         <span class="keywordflow">return</span>;
01717     }
01718 
01719     <span class="comment">//</span>
01720     <span class="comment">// The packet has been located, and it is not going through completion</span>
01721     <span class="comment">// at this point.  Switch threads, so that it will not complete through</span>
01722     <span class="comment">// this thread, remove the request from this thread's queue, and release</span>
01723     <span class="comment">// the spinlock.  Final processing of the IRP will occur when I/O</span>
01724     <span class="comment">// completion notices that there is no thread associated with the</span>
01725     <span class="comment">// request.  It will essentially drop the I/O on the floor.</span>
01726     <span class="comment">//</span>
01727     <span class="comment">// Also, while the request is still held, attempt to determine on which</span>
01728     <span class="comment">// device object the operation is being performed.</span>
01729     <span class="comment">//</span>
01730 
01735 
01736     <a class="code" href="../../d2/d4/internal_8c.html#a11">IopDeadIrp</a> = irp;
01737 
01738     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = (<a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01739     entry = RemoveHeadList( &amp;thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o18">IrpList</a> );
01740 
01741     <span class="comment">// Initialize the thread entry. Otherwise the assertion in IoFreeIrp</span>
01742     <span class="comment">// called via IopDeadIrp will fail.</span>
01743     InitializeListHead (&amp;(irp)-&gt;ThreadListEntry);
01744 
01745     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( irp );
01746     <span class="keywordflow">if</span> (irp-&gt;CurrentLocation &lt;= irp-&gt;StackCount) {
01747         deviceObject = irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o57">DeviceObject</a>;
01748     } <span class="keywordflow">else</span> {
01749         deviceObject = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01750     }
01751     ExReleaseSpinLock( &amp;IopCompletionLock, spIrql );
01752     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>( irql );
01753 
01754     <span class="comment">//</span>
01755     <span class="comment">// If a device object could be identified then try to write to the event log about this</span>
01756     <span class="comment">// device object.</span>
01757     <span class="comment">//</span>
01758 
01759     <span class="keywordflow">if</span> (deviceObject) {
01760             errorLogEntry = <a class="code" href="../../d4/d6/iosubs_8c.html#a14">IoAllocateErrorLogEntry</a>(deviceObject, <span class="keyword">sizeof</span>(IO_ERROR_LOG_PACKET));
01761             <span class="keywordflow">if</span> (errorLogEntry) {
01762                 errorLogEntry-&gt;ErrorCode = IO_DRIVER_CANCEL_TIMEOUT;
01763                 <a class="code" href="../../d4/d6/iosubs_8c.html#a123">IoWriteErrorLogEntry</a>(errorLogEntry);
01764             }
01765     }
01766 
01767     <span class="keywordflow">return</span>;
01768 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a167" doxytag="iop.h::IopDmaDispatch" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopDmaDispatch           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d7/struct__KINTERRUPT.html">PKINTERRUPT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Interrupt</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ServiceContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a225" doxytag="iop.h::IopDoNameTransmogrify" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopDoNameTransmogrify           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PREPARSE_DATA_BUFFER&nbsp;</td>
          <td class="mdname" nowrap> <em>ReparseBuffer</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08130">8130</a> of file <a class="el" href="../../d5/d5/iosubs_8c-source.html">iosubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l01019">IopCompleteRequest()</a>, and <a class="el" href="../../d5/d2/parse_8c-source.html#l00202">IopParseDevice()</a>.
<p>
<pre class="fragment"><div>08138                    :
08139 
08140     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to <span class="keywordflow">do</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name grafting needed <span class="keywordflow">for</span> junctions.
08141 
08142 Arguments:
08143 
08144     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet (<a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>) representing the operation
08145         to be performed.
08146 
08147     FileObject - Pointer to the file object whose name is being affected.
08148 
08149     ReparseBuffer - Pointer to a reparse data buffer that is supposed to contain
08150         a self-consistent set of names to perform name grafting.
08151 
08152 Return Value:
08153 
08154     No explicit return value. The appropriate fields off the <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> are set.
08155 
08156 Note:
08157 
08158     This function needs to be kept synchronized with the definition of
08159     REPARSE_DATA_BUFFER.
08160 
08161 --*/
08162 
08163 {
08164     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> pathLength = 0;
08165     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> neededBufferLength = 0;
08166     PVOID outBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08167     PWSTR pathBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08168 
08169     <span class="comment">//</span>
08170     <span class="comment">// We do the appropriate paste of the new name in the FileName buffer</span>
08171     <span class="comment">// and deallocate the buffer that brought the data from the file system.</span>
08172     <span class="comment">//</span>
08173 
08174     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status == STATUS_REPARSE );
08175     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information == IO_REPARSE_TAG_MOUNT_POINT );
08176 
08177     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.AuxiliaryBuffer != NULL );
08178 
08179     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ReparseBuffer != NULL );
08180     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ReparseBuffer-&gt;ReparseTag == IO_REPARSE_TAG_MOUNT_POINT );
08181     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ReparseBuffer-&gt;ReparseDataLength &lt; MAXIMUM_REPARSE_DATA_BUFFER_SIZE );
08182     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ReparseBuffer-&gt;Reserved &lt; MAXIMUM_REPARSE_DATA_BUFFER_SIZE );
08183 
08184 <span class="preprocessor">#if DBG</span>
08185 <span class="preprocessor"></span><span class="comment">//    DbgPrint( "iosubs.c DoNameTransmogrify: Tag %x Reserved %x MaximumLength %x FileName %Z\n",</span>
08186 <span class="comment">//              ReparseBuffer-&gt;ReparseTag, ReparseBuffer-&gt;Reserved, FileObject-&gt;FileName.MaximumLength, &amp;(FileObject-&gt;FileName) );</span>
08187 <span class="preprocessor">#endif // DBG</span>
08188 <span class="preprocessor"></span>
08189     <span class="comment">//</span>
08190     <span class="comment">// Determine whether we have enough data for all the length fields.</span>
08191     <span class="comment">//</span>
08192     <span class="comment">// Determine whether the lengths returned are consistent with the maximum</span>
08193     <span class="comment">// buffer. This is the best self-defense check we can do at this time as</span>
08194     <span class="comment">// the stack pointer is already invalid.</span>
08195     <span class="comment">//</span>
08196 
08197     <span class="keywordflow">if</span> (ReparseBuffer-&gt;ReparseDataLength &gt;=
08198         (FIELD_OFFSET(REPARSE_DATA_BUFFER, MountPointReparseBuffer.PathBuffer[0]) - REPARSE_DATA_BUFFER_HEADER_SIZE)) {
08199 
08200         <span class="keywordflow">if</span> (MAXIMUM_REPARSE_DATA_BUFFER_SIZE &lt;
08201             (FIELD_OFFSET(REPARSE_DATA_BUFFER, MountPointReparseBuffer.PathBuffer[0]) +
08202                 ReparseBuffer-&gt;MountPointReparseBuffer.SubstituteNameLength +
08203                 ReparseBuffer-&gt;MountPointReparseBuffer.PrintNameLength)) {
08204 
08205             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = STATUS_IO_REPARSE_DATA_INVALID;
08206         }
08207     } <span class="keywordflow">else</span> {
08208         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = STATUS_IO_REPARSE_DATA_INVALID;
08209     }
08210 
08211     <span class="comment">//</span>
08212     <span class="comment">// The value in  ReparseBuffer-&gt;Reserved  is the length of the file</span>
08213     <span class="comment">// name that has still to be parsed.</span>
08214     <span class="comment">//</span>
08215 
08216     <span class="comment">//</span>
08217     <span class="comment">// Copy the buffer when it has the appropriate length, else return a null UNICODE name:</span>
08218     <span class="comment">//   (1) Do defensive sanity checks on the name lengths returned.</span>
08219     <span class="comment">//</span>
08220     <span class="comment">// We only care to do this if we have no error conditions.</span>
08221     <span class="comment">//</span>
08222 
08223     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status )) {
08224 
08225         pathBuffer = (PWSTR)((PCHAR)ReparseBuffer-&gt;MountPointReparseBuffer.PathBuffer +
08226                              ReparseBuffer-&gt;MountPointReparseBuffer.SubstituteNameOffset);
08227         pathLength = ReparseBuffer-&gt;MountPointReparseBuffer.SubstituteNameLength;
08228     }
08229 
08230     <span class="comment">//</span>
08231     <span class="comment">// Notice that if the data returned in AuxiliaryBuffer is not long enough then</span>
08232     <span class="comment">// pathLength has value 0 and pathBuffer has value NULL.</span>
08233     <span class="comment">//</span>
08234     <span class="comment">// The value in  ReparseBuffer-&gt;Reserved  is the length of the file name that</span>
08235     <span class="comment">// has still to be parsed.</span>
08236     <span class="comment">//</span>
08237     <span class="comment">// We only care to do this if we have no error conditions.</span>
08238     <span class="comment">//</span>
08239 
08240     <span class="keywordflow">if</span> (ReparseBuffer-&gt;Reserved &lt; 0) {
08241 
08242         <span class="comment">//</span>
08243         <span class="comment">// This is an invalid offset.</span>
08244         <span class="comment">//</span>
08245 
08246         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = STATUS_IO_REPARSE_DATA_INVALID;
08247     }
08248 
08249     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status )) {
08250 
08251         <span class="comment">//</span>
08252         <span class="comment">// Check for overflow. (pathLength &lt;= MAXIMUM_REPARSE_DATA_BUFFER_SIZE)</span>
08253         <span class="comment">// so pathLength + sizeof(UNICODE_NULL) cannot overflow.</span>
08254         <span class="comment">//</span>
08255 
08256         <span class="keywordflow">if</span> (((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)MAXUSHORT - ReparseBuffer-&gt;Reserved ) &gt; (pathLength +(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>(UNICODE_NULL))) {
08257             neededBufferLength = pathLength + ReparseBuffer-&gt;Reserved + <span class="keyword">sizeof</span>( UNICODE_NULL );
08258             <span class="comment">//</span>
08259             <span class="comment">// If the out name buffer isn't large enough, allocate a new one.</span>
08260             <span class="comment">//</span>
08261 
08262             <span class="keywordflow">if</span> (FileObject-&gt;FileName.MaximumLength &lt; neededBufferLength) {
08263                 outBuffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool,
08264                                                    neededBufferLength,
08265                                                    'cFoI' );
08266                 <span class="keywordflow">if</span> (!outBuffer) {
08267                     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = STATUS_INSUFFICIENT_RESOURCES;
08268                 }
08269             } <span class="keywordflow">else</span> {
08270                 outBuffer = FileObject-&gt;FileName.Buffer;
08271             }
08272         } <span class="keywordflow">else</span> {
08273             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = STATUS_NAME_TOO_LONG;
08274         }
08275     }
08276 
08277     <span class="comment">//</span>
08278     <span class="comment">// Place in the out name buffer the remaining part of the name.</span>
08279     <span class="comment">//</span>
08280     <span class="comment">// We only care to do this if we have no error conditions.</span>
08281     <span class="comment">//</span>
08282 
08283     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status )) {
08284 
08285         <span class="keywordflow">if</span> (ReparseBuffer-&gt;Reserved) {
08286 
08287             RtlMoveMemory ( (PCHAR)outBuffer + pathLength,
08288                             (PCHAR)FileObject-&gt;FileName.Buffer +
08289                                   (FileObject-&gt;FileName.Length - ReparseBuffer-&gt;Reserved),
08290                             ReparseBuffer-&gt;Reserved );
08291         }
08292 
08293         <span class="comment">//</span>
08294         <span class="comment">// Copy into the front of the out name buffer the value of the</span>
08295         <span class="comment">// reparse point.</span>
08296         <span class="comment">//</span>
08297 
08298         <span class="keywordflow">if</span> (pathLength) {
08299 
08300             RtlCopyMemory( (PCHAR)outBuffer,
08301                            (PCHAR)pathBuffer,
08302                            pathLength );
08303         }
08304 
08305         FileObject-&gt;FileName.Length = neededBufferLength - <span class="keyword">sizeof</span>( UNICODE_NULL );
08306 
08307         <span class="comment">//</span>
08308         <span class="comment">// Free the old name buffer when needed and update the appropriate values.</span>
08309         <span class="comment">//</span>
08310 
08311         <span class="keywordflow">if</span> (outBuffer != FileObject-&gt;FileName.Buffer) {
08312 
08313             <span class="keywordflow">if</span> (FileObject-&gt;FileName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08314                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( FileObject-&gt;FileName.Buffer );
08315             }
08316             FileObject-&gt;FileName.Buffer = outBuffer;
08317             FileObject-&gt;FileName.MaximumLength = neededBufferLength;
08318             ((PWSTR)outBuffer)[ (neededBufferLength / <span class="keyword">sizeof</span>( WCHAR ))-1 ] = UNICODE_NULL;
08319         }
08320     }
08321 
08322     <span class="comment">//</span>
08323     <span class="comment">// Free the buffer that came from the file system.</span>
08324     <span class="comment">// NULL the pointer.</span>
08325     <span class="comment">//</span>
08326 
08327     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ReparseBuffer );
08328     ReparseBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08329 
08330     <span class="comment">//</span>
08331     <span class="comment">// Clear the tag from then Information field.</span>
08332     <span class="comment">//</span>
08333 
08334     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = IO_REPARSE_TAG_RESERVED_ZERO;
08335 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a168" doxytag="iop.h::IopDropIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopDropIrp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l01821">1821</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06632">IoFreeIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06744">IoFreeMdl()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01558">IRP_CREATE_OPERATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01555">IRP_DEALLOCATE_BUFFER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01552">IRP_SYNCHRONOUS_API</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01596">_IRP::MdlAddress</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00414">_MDL::Next</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>.
<p>
<pre class="fragment"><div>01828                    :
01829 
01830     This routine attempts to drop everything about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01831     floor.
01832 
01833 Arguments:
01834 
01835     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet to be completed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bit bucket.
01836 
01837     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <span class="keywordflow">for</span> which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet was
01838         bound.
01839 
01840 Return Value:
01841 
01842     None.
01843 
01844 --*/
01845 
01846 {
01847     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> mdl;
01848     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> nextMdl;
01849 
01850     <span class="comment">//</span>
01851     <span class="comment">// Free the resources associated with the IRP.</span>
01852     <span class="comment">//</span>
01853 
01854     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a179">IRP_DEALLOCATE_BUFFER</a>) {
01855         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer );
01856     }
01857 
01858     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a>) {
01859         <span class="keywordflow">for</span> (mdl = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a>; mdl; mdl = nextMdl) {
01860             nextMdl = mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o0">Next</a>;
01861             <a class="code" href="../../d4/d6/iosubs_8c.html#a65">IoFreeMdl</a>( mdl );
01862         }
01863     }
01864 
01865     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> &amp;&amp;
01866         FileObject &amp;&amp;
01867         !(<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>)) {
01868         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> );
01869     }
01870 
01871     <span class="keywordflow">if</span> (FileObject &amp;&amp; !(<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a182">IRP_CREATE_OPERATION</a>)) {
01872         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( FileObject );
01873     }
01874 
01875     <span class="comment">//</span>
01876     <span class="comment">// Finally, free the IRP itself.</span>
01877     <span class="comment">//</span>
01878 
01879     <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>( Irp );
01880 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a171" doxytag="iop.h::IopErrorLogThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopErrorLogThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>StartContext</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/errorlog_8c-source.html#l00088">88</a> of file <a class="el" href="../../d8/d6/errorlog_8c-source.html">errorlog.c</a>.
<p>
References <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00092">_ERROR_LOG_ENTRY::DeviceObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01385">_DRIVER_OBJECT::DriverName</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00093">_ERROR_LOG_ENTRY::DriverObject</a>, <a class="el" href="../../d0/d6/iop_8h.html#a27">ERROR_LOG_ENTRY</a>, <a class="el" href="../../d8/d6/errorlog_8c-source.html#l00076">ErrorLogPort</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a235">ExInterlockedAddUlong()</a>, <a class="el" href="../../d8/d6/errorlog_8c-source.html#l00085">IO_ERROR_NAME_LENGTH</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00046">IO_TYPE_ERROR_MESSAGE</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00185">IopErrorLogAllocation</a>, <a class="el" href="../../d5/d3/alpha_2splocks_8c-source.html#l00049">IopErrorLogAllocationLock</a>, <a class="el" href="../../d8/d6/errorlog_8c-source.html#l00566">IopErrorLogConnectPort()</a>, <a class="el" href="../../d8/d6/errorlog_8c-source.html#l00707">IopErrorLogGetEntry()</a>, <a class="el" href="../../d8/d6/errorlog_8c-source.html#l00760">IopErrorLogQueueRequest()</a>, <a class="el" href="../../d8/d6/errorlog_8c-source.html#l00829">IopErrorLogRequeueEntry()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00091">_ERROR_LOG_ENTRY::ListEntry</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l00032">NtRequestPort()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00713">ObQueryNameString()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d6/iop_8h.html#a28">PERROR_LOG_ENTRY</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00090">_ERROR_LOG_ENTRY::Size</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00094">_ERROR_LOG_ENTRY::TimeStamp</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/errorlog_8c-source.html#l00660">IopErrorLogDpc()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11556">IoWriteErrorLogEntry()</a>.
<p>
<pre class="fragment"><div>00094                    :
00095 
00096     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d9/arcinst_8c.html#a19">main</a> loop <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O error log thread which executes in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00097     system process context.  This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> started when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00098     initialized.
00099 
00100 Arguments:
00101 
00102     StartContext - Startup context; not used.
00103 
00104 Return Value:
00105 
00106     None.
00107 
00108 --*/
00109 
00110 {
00111     <a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html">PERROR_LOG_ENTRY</a> errorLogEntry;
00112     UNICODE_STRING nameString;
00113     PLIST_ENTRY listEntry;
00114     PIO_ERROR_LOG_MESSAGE errorMessage;
00115     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00116     PELF_PORT_MSG portMessage;
00117     PCHAR objectName;
00118     ULONG messageLength;
00119     ULONG driverNameLength;
00120     ULONG deviceNameLength;
00121     ULONG objectNameLength;
00122     ULONG remainingLength;
00123     ULONG stringLength;
00124     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> nameBuffer[<a class="code" href="../../d7/d7/errorlog_8c.html#a0">IO_ERROR_NAME_LENGTH</a>+<span class="keyword">sizeof</span>( OBJECT_NAME_INFORMATION )];
00125     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
00126     POBJECT_NAME_INFORMATION nameInformation;
00127     PIO_ERROR_LOG_PACKET errorData;
00128     PWSTR string;
00129 
00130     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00131 
00132     UNREFERENCED_PARAMETER( StartContext );
00133 
00134     <span class="comment">//</span>
00135     <span class="comment">// Check to see whether a connection has been made to the error log</span>
00136     <span class="comment">// port.  If the port is not connected return.</span>
00137     <span class="comment">//</span>
00138 
00139     <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d7/errorlog_8c.html#a8">IopErrorLogConnectPort</a>()) {
00140 
00141         <span class="comment">//</span>
00142         <span class="comment">// The port could not be connected.  A timer was started that will</span>
00143         <span class="comment">// try again later.</span>
00144         <span class="comment">//</span>
00145 
00146         <span class="keywordflow">return</span>;
00147     }
00148 
00149     <span class="comment">//</span>
00150     <span class="comment">// Allocate and zero the port message structure, include space for the</span>
00151     <span class="comment">// name of the device and driver.</span>
00152     <span class="comment">//</span>
00153 
00154     messageLength = IO_ERROR_LOG_MESSAGE_LENGTH;
00155     portMessage = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, messageLength);
00156 
00157     <span class="keywordflow">if</span> (portMessage == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00158 
00159         <span class="comment">//</span>
00160         <span class="comment">// The message buffer could not be allocated. Request that</span>
00161         <span class="comment">// the error log thread routine be called again later.</span>
00162         <span class="comment">//</span>
00163 
00164         <a class="code" href="../../d7/d7/errorlog_8c.html#a11">IopErrorLogQueueRequest</a>();
00165         <span class="keywordflow">return</span>;
00166     }
00167 
00168     RtlZeroMemory( portMessage, <span class="keyword">sizeof</span>( *portMessage ) );
00169     portMessage-&gt;MessageType = IO_ERROR_LOG;
00170     errorMessage = &amp;portMessage-&gt;u.IoErrorLogMessage;
00171 
00172     nameInformation = (PVOID) &amp;nameBuffer;
00173 
00174     <span class="comment">//</span>
00175     <span class="comment">// Now enter the main loop for this thread.  This thread performs the</span>
00176     <span class="comment">// following operations:</span>
00177     <span class="comment">//</span>
00178     <span class="comment">//   1)  If a connection has been made to the error log port, dequeue a</span>
00179     <span class="comment">//       packet from the queue head and attempt to send it to the port.</span>
00180     <span class="comment">//</span>
00181     <span class="comment">//   2)  If the send works, loop sending packets until there are no more</span>
00182     <span class="comment">//       packets;  otherwise, indicate that the connection has been broken,</span>
00183     <span class="comment">//       cleanup, place the packet back onto the head of the queue and</span>
00184     <span class="comment">//       return.</span>
00185     <span class="comment">//</span>
00186     <span class="comment">//   3)  After all the packets are sent clear the pending variable and</span>
00187     <span class="comment">//       return.</span>
00188     <span class="comment">//</span>
00189 
00190     <span class="keywordflow">for</span> (;;) {
00191 
00192         <span class="comment">//</span>
00193         <span class="comment">// Loop dequeueing  packets from the queue head and attempt to send</span>
00194         <span class="comment">// each to the port.</span>
00195         <span class="comment">//</span>
00196         <span class="comment">// If the send works, continue looping until there are no more packets.</span>
00197         <span class="comment">// Otherwise, indicate that the connection has been broken, cleanup,</span>
00198         <span class="comment">// place the packet back onto the head of the queue, and start from the</span>
00199         <span class="comment">// top of the loop again.</span>
00200         <span class="comment">//</span>
00201 
00202         <span class="keywordflow">if</span> (!(listEntry = <a class="code" href="../../d7/d7/errorlog_8c.html#a10">IopErrorLogGetEntry</a>())) {
00203             <span class="keywordflow">break</span>;
00204         }
00205 
00206         errorLogEntry = CONTAINING_RECORD( listEntry,
00207                                            <a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html">ERROR_LOG_ENTRY</a>,
00208                                            ListEntry );
00209 
00210         <span class="comment">//</span>
00211         <span class="comment">// The size of errorLogEntry is ERROR_LOG_ENTRY +</span>
00212         <span class="comment">// IO_ERROR_LOG_PACKET + (Extra Dump data).  The size of the</span>
00213         <span class="comment">// initial message length should be IO_ERROR_LOG_MESSAGE +</span>
00214         <span class="comment">// (Extra Dump data), since IO_ERROR_LOG_MESSAGE contains an</span>
00215         <span class="comment">// IO_ERROR_LOG_PACKET. Using the above calculations set the</span>
00216         <span class="comment">// message length.</span>
00217         <span class="comment">//</span>
00218 
00219         messageLength = <span class="keyword">sizeof</span>( IO_ERROR_LOG_MESSAGE ) -
00220             <span class="keyword">sizeof</span>( <a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html">ERROR_LOG_ENTRY</a> ) - <span class="keyword">sizeof</span>( IO_ERROR_LOG_PACKET ) +
00221             errorLogEntry-&gt;<a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html#o1">Size</a>;
00222 
00223         errorData = (PIO_ERROR_LOG_PACKET) (errorLogEntry + 1);
00224 
00225         <span class="comment">//</span>
00226         <span class="comment">// Copy the error log packet and the extra data to the message.</span>
00227         <span class="comment">//</span>
00228 
00229         RtlMoveMemory( &amp;errorMessage-&gt;EntryData,
00230                        errorData,
00231                        errorLogEntry-&gt;<a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html#o1">Size</a> - <span class="keyword">sizeof</span>( <a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html">ERROR_LOG_ENTRY</a> ) );
00232 
00233         errorMessage-&gt;TimeStamp = errorLogEntry-&gt;<a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html#o5">TimeStamp</a>;
00234         errorMessage-&gt;Type = <a class="code" href="../../d0/d5/io_8h.html#a11">IO_TYPE_ERROR_MESSAGE</a>;
00235 
00236         <span class="comment">//</span>
00237         <span class="comment">// Add the driver and device name string.  These strings go</span>
00238         <span class="comment">// before the error log strings.  Just write over the current</span>
00239         <span class="comment">// strings and they will be recopied later.</span>
00240         <span class="comment">//</span>
00241 
00242         <span class="keywordflow">if</span> (errorData-&gt;NumberOfStrings != 0) {
00243 
00244             <span class="comment">//</span>
00245             <span class="comment">// Start the driver and device strings where the current</span>
00246             <span class="comment">// strings start.</span>
00247             <span class="comment">//</span>
00248 
00249             objectName = (PCHAR) (&amp;errorMessage-&gt;EntryData) +
00250                                  errorData-&gt;StringOffset;
00251 
00252         } <span class="keywordflow">else</span> {
00253 
00254             <span class="comment">//</span>
00255             <span class="comment">// Put the driver and device strings at the end of the</span>
00256             <span class="comment">// data.</span>
00257             <span class="comment">//</span>
00258 
00259             objectName = (PCHAR) errorMessage + messageLength;
00260 
00261         }
00262 
00263         <span class="comment">//</span>
00264         <span class="comment">// Make sure the driver offset starts on an even bountry.</span>
00265         <span class="comment">//</span>
00266 
00267         objectName = (PCHAR) ((ULONG_PTR) (objectName + <span class="keyword">sizeof</span>(WCHAR) - 1) &amp;
00268             ~(ULONG_PTR)(<span class="keyword">sizeof</span>(WCHAR) - 1));
00269 
00270         errorMessage-&gt;DriverNameOffset = (ULONG)(objectName - (PCHAR) errorMessage);
00271 
00272         remainingLength = (ULONG)((PCHAR) portMessage + IO_ERROR_LOG_MESSAGE_LENGTH
00273                             - objectName);
00274 
00275         <span class="comment">//</span>
00276         <span class="comment">// Calculate the length of the driver name and</span>
00277         <span class="comment">// the device name. If the driver object has a name then get</span>
00278         <span class="comment">// it from there; otherwise try to query the device object.</span>
00279         <span class="comment">//</span>
00280 
00281         driverObject = errorLogEntry-&gt;<a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html#o4">DriverObject</a>;
00282         driverNameLength = 0;
00283 
00284         <span class="keywordflow">if</span> (driverObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00285             <span class="keywordflow">if</span> (driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00286 
00287                 nameString.Buffer = driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>.Buffer;
00288                 driverNameLength = driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>.Length;
00289             }
00290 
00291             <span class="keywordflow">if</span> (driverNameLength == 0) {
00292 
00293                 <span class="comment">//</span>
00294                 <span class="comment">// Try to query the driver object for a name.</span>
00295                 <span class="comment">//</span>
00296 
00297                 status = <a class="code" href="../../d6/d1/obquery_8c.html#a7">ObQueryNameString</a>( driverObject,
00298                                             nameInformation,
00299                                             IO_ERROR_NAME_LENGTH + <span class="keyword">sizeof</span>( OBJECT_NAME_INFORMATION ),
00300                                             &amp;objectNameLength );
00301 
00302                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) || !nameInformation-&gt;Name.Length) {
00303 
00304                     <span class="comment">//</span>
00305                     <span class="comment">// No driver name was available.</span>
00306                     <span class="comment">//</span>
00307 
00308                     driverNameLength = 0;
00309 
00310                 } <span class="keywordflow">else</span> {
00311                     nameString = nameInformation-&gt;Name;
00312                 }
00313 
00314             }
00315 
00316         } <span class="keywordflow">else</span> {
00317 
00318             <span class="comment">//</span>
00319             <span class="comment">// If no driver object, this message must be from the </span>
00320             <span class="comment">// kernel.   We need to point the eventlog service to</span>
00321             <span class="comment">// an event message file containing ntstatus messages,</span>
00322             <span class="comment">// ie, ntdll, we do this by claiming this event is an</span>
00323             <span class="comment">// application popup.</span>
00324             <span class="comment">//</span>
00325 
00326             nameString.Buffer = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Application Popup"</span>;
00327             driverNameLength = wcslen(nameString.Buffer) * <span class="keyword">sizeof</span>(WCHAR);
00328         }
00329 
00330         <span class="keywordflow">if</span> (driverNameLength != 0 ) {
00331 
00332             <span class="comment">//</span>
00333             <span class="comment">// Pick out the module name.</span>
00334             <span class="comment">//</span>
00335 
00336             string = nameString.Buffer +
00337                 (driverNameLength / <span class="keyword">sizeof</span>(WCHAR));
00338 
00339             driverNameLength = <span class="keyword">sizeof</span>(WCHAR);
00340             string--;
00341             <span class="keywordflow">while</span> (*string != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span> &amp;&amp; string != nameString.Buffer) {
00342                 string--;
00343                 driverNameLength += <span class="keyword">sizeof</span>(WCHAR);
00344             }
00345 
00346             <span class="keywordflow">if</span> (*string == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>) {
00347                 string++;
00348                 driverNameLength -= <span class="keyword">sizeof</span>(WCHAR);
00349             }
00350 
00351             <span class="comment">//</span>
00352             <span class="comment">// Ensure there is enough room for the driver name.</span>
00353             <span class="comment">// Save space for 3 NULLs one for the driver name,</span>
00354             <span class="comment">// one for the device name and one for strings.</span>
00355             <span class="comment">//</span>
00356 
00357             <span class="keywordflow">if</span> (driverNameLength &gt; remainingLength - (3 * <span class="keyword">sizeof</span>(WCHAR))) {
00358                 driverNameLength = remainingLength - (3 * <span class="keyword">sizeof</span>(WCHAR));
00359             }
00360 
00361             RtlMoveMemory(
00362                 objectName,
00363                 string,
00364                 driverNameLength
00365                 );
00366 
00367         }
00368 
00369         <span class="comment">//</span>
00370         <span class="comment">// Add a null after the driver name even if there is no</span>
00371         <span class="comment">// driver name.</span>
00372         <span class="comment">//</span>
00373 
00374        *((PWSTR) (objectName + driverNameLength)) = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00375        driverNameLength += <span class="keyword">sizeof</span>(WCHAR);
00376 
00377         <span class="comment">//</span>
00378         <span class="comment">// Determine where the next string goes.</span>
00379         <span class="comment">//</span>
00380 
00381         objectName += driverNameLength;
00382         remainingLength -= driverNameLength;
00383 
00384         errorMessage-&gt;EntryData.StringOffset = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(objectName - (PCHAR) errorMessage);
00385 
00386         <span class="keywordflow">if</span> (errorLogEntry-&gt;<a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html#o3">DeviceObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00387 
00388             status = <a class="code" href="../../d6/d1/obquery_8c.html#a7">ObQueryNameString</a>( errorLogEntry-&gt;<a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html#o3">DeviceObject</a>,
00389                                         nameInformation,
00390                                         IO_ERROR_NAME_LENGTH + <span class="keyword">sizeof</span>( OBJECT_NAME_INFORMATION ) - driverNameLength,
00391                                         &amp;objectNameLength );
00392 
00393             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) || !nameInformation-&gt;Name.Length) {
00394 
00395                 <span class="comment">//</span>
00396                 <span class="comment">// No device name was available. Add a Null string.</span>
00397                 <span class="comment">//</span>
00398 
00399                 nameInformation-&gt;Name.Length = 0;
00400                 nameInformation-&gt;Name.Buffer = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\0"</span>;
00401 
00402             }
00403 
00404             <span class="comment">//</span>
00405             <span class="comment">// No device name was available. Add a Null string.</span>
00406             <span class="comment">// Always add a device name string so that the</span>
00407             <span class="comment">// insertion string counts are correct.</span>
00408             <span class="comment">//</span>
00409 
00410         } <span class="keywordflow">else</span> {
00411 
00412                 <span class="comment">//</span>
00413                 <span class="comment">// No device name was available. Add a Null string.</span>
00414                 <span class="comment">// Always add a device name string so that the</span>
00415                 <span class="comment">// insertion string counts are correct.</span>
00416                 <span class="comment">//</span>
00417 
00418                 nameInformation-&gt;Name.Length = 0;
00419                 nameInformation-&gt;Name.Buffer = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\0"</span>;
00420 
00421         }
00422 
00423         deviceNameLength = nameInformation-&gt;Name.Length;
00424 
00425         <span class="comment">//</span>
00426         <span class="comment">// Ensure there is enough room for the device name.</span>
00427         <span class="comment">// Save space for a NULL.</span>
00428         <span class="comment">//</span>
00429 
00430         <span class="keywordflow">if</span> (deviceNameLength &gt; remainingLength - (2 * <span class="keyword">sizeof</span>(WCHAR))) {
00431 
00432             deviceNameLength = remainingLength - (2 * <span class="keyword">sizeof</span>(WCHAR));
00433 
00434         }
00435 
00436         RtlMoveMemory( objectName,
00437                        nameInformation-&gt;Name.Buffer,
00438                        deviceNameLength );
00439 
00440         <span class="comment">//</span>
00441         <span class="comment">// Add a null after the device name even if there is no</span>
00442         <span class="comment">// device name.</span>
00443         <span class="comment">//</span>
00444 
00445         *((PWSTR) (objectName + deviceNameLength)) = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00446         deviceNameLength += <span class="keyword">sizeof</span>(WCHAR);
00447 
00448         <span class="comment">//</span>
00449         <span class="comment">// Update the string count for the device object.</span>
00450         <span class="comment">//</span>
00451 
00452         errorMessage-&gt;EntryData.NumberOfStrings++;
00453         objectName += deviceNameLength;
00454         remainingLength -= deviceNameLength;
00455 
00456         <span class="keywordflow">if</span> (errorData-&gt;NumberOfStrings) {
00457 
00458             stringLength = errorLogEntry-&gt;<a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html#o1">Size</a> - <span class="keyword">sizeof</span>( <a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html">ERROR_LOG_ENTRY</a> ) -
00459                             errorData-&gt;StringOffset;
00460 
00461             <span class="comment">//</span>
00462             <span class="comment">// Ensure there is enough room for the strings.</span>
00463             <span class="comment">// Save space for a NULL.</span>
00464             <span class="comment">//</span>
00465 
00466             <span class="keywordflow">if</span> (stringLength &gt; remainingLength - <span class="keyword">sizeof</span>(WCHAR)) {
00467 
00468 
00469                 messageLength -= stringLength - remainingLength;
00470                 stringLength = remainingLength - <span class="keyword">sizeof</span>(WCHAR);
00471 
00472             }
00473 
00474             <span class="comment">//</span>
00475             <span class="comment">// Copy the strings to the end of the message.</span>
00476             <span class="comment">//</span>
00477 
00478             RtlMoveMemory( objectName,
00479                            (PCHAR) errorData + errorData-&gt;StringOffset,
00480                            stringLength );
00481 
00482             <span class="comment">//</span>
00483             <span class="comment">// Add a null after the strings</span>
00484             <span class="comment">//</span>
00485             <span class="comment">//</span>
00486 
00487            *((PWSTR) (objectName + stringLength)) = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00488 
00489         }
00490 
00491         <span class="comment">//</span>
00492         <span class="comment">// Update the message length.</span>
00493         <span class="comment">//</span>
00494 
00495         errorMessage-&gt;DriverNameLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) driverNameLength;
00496         messageLength += deviceNameLength + driverNameLength;
00497         errorMessage-&gt;Size = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) messageLength;
00498 
00499         messageLength += FIELD_OFFSET ( ELF_PORT_MSG, u ) -
00500             FIELD_OFFSET (ELF_PORT_MSG, MessageType);
00501 
00502         portMessage-&gt;PortMessage.u1.s1.TotalLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)
00503             (<span class="keyword">sizeof</span>( PORT_MESSAGE ) + messageLength);
00504         portMessage-&gt;PortMessage.u1.s1.DataLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (messageLength);
00505         status = <a class="code" href="../../d6/d7/lpcsend_8c.html#a0">NtRequestPort</a>( ErrorLogPort, (PPORT_MESSAGE) portMessage );
00506 
00507         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00508 
00509             <span class="comment">//</span>
00510             <span class="comment">// The send failed.  Place the packet back onto the head of</span>
00511             <span class="comment">// the error log queue, forget the current connection since</span>
00512             <span class="comment">// it no longer works, and close the handle to the port.</span>
00513             <span class="comment">// Set a timer up for another attempt later.</span>
00514             <span class="comment">// Finally, exit the loop since there is no connection</span>
00515             <span class="comment">// to do any work on.</span>
00516             <span class="comment">//</span>
00517 
00518             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( ErrorLogPort );
00519 
00520             <a class="code" href="../../d7/d7/errorlog_8c.html#a12">IopErrorLogRequeueEntry</a>( &amp;errorLogEntry-&gt;<a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html#o2">ListEntry</a> );
00521 
00522             <a class="code" href="../../d7/d7/errorlog_8c.html#a11">IopErrorLogQueueRequest</a>();
00523 
00524             <span class="keywordflow">break</span>;
00525 
00526         } <span class="keywordflow">else</span> {
00527 
00528             <span class="comment">//</span>
00529             <span class="comment">// The send worked fine.  Free the packet and the update</span>
00530             <span class="comment">// the allocation count.</span>
00531             <span class="comment">//</span>
00532 
00533             <a class="code" href="../../d5/d8/ex_8h.html#a235">ExInterlockedAddUlong</a>( &amp;IopErrorLogAllocation,
00534                                    (ULONG) ( -errorLogEntry-&gt;<a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html#o1">Size</a> ),
00535                                    &amp;IopErrorLogAllocationLock );
00536 
00537             <span class="comment">//</span>
00538             <span class="comment">// Dereference the object pointers now that the name has been</span>
00539             <span class="comment">// captured.</span>
00540             <span class="comment">//</span>
00541 
00542 
00543             <span class="keywordflow">if</span> (errorLogEntry-&gt;<a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html#o3">DeviceObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00544                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( errorLogEntry-&gt;<a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html#o3">DeviceObject</a> );
00545             }
00546 
00547             <span class="keywordflow">if</span> (driverObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00548                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( errorLogEntry-&gt;<a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html#o4">DriverObject</a> );
00549             }
00550 
00551             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( errorLogEntry );
00552 
00553         } <span class="comment">// if</span>
00554 
00555     } <span class="comment">// for</span>
00556 
00557     <span class="comment">//</span>
00558     <span class="comment">// Finally, free the message buffer and return.</span>
00559     <span class="comment">//</span>
00560 
00561     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(portMessage);
00562 
00563 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a170" doxytag="iop.h::IopExceptionCleanup" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopExceptionCleanup           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> EventObject&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> KernelEvent&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l01934">1934</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01491">FO_SYNCHRONOUS_IO</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06632">IoFreeIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06744">IoFreeMdl()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01157">IopReleaseFileObjectLock</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01596">_IRP::MdlAddress</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/dir_8c-source.html#l00057">BuildQueryDirectoryIrp()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06326">IopSetEaOrQuotaInformationFile()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08084">IopXxxControlFile()</a>, <a class="el" href="../../d2/d4/lock_8c-source.html#l00035">NtLockFile()</a>, <a class="el" href="../../d1/d7/dir_8c-source.html#l00821">NtNotifyChangeDirectoryFile()</a>, <a class="el" href="../../d8/d1/qsea_8c-source.html#l00035">NtQueryEaFile()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00101">NtQueryInformationFile()</a>, <a class="el" href="../../d1/d2/qsquota_8c-source.html#l00035">NtQueryQuotaInformationFile()</a>, <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00037">NtQueryVolumeInformationFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00036">NtReadFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00730">NtReadFileScatter()</a>, <a class="el" href="../../d8/d1/qsea_8c-source.html#l00652">NtSetEaFile()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>, <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00492">NtSetVolumeInformationFile()</a>, <a class="el" href="../../d2/d4/lock_8c-source.html#l00458">NtUnlockFile()</a>, <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00035">NtWriteFile()</a>, and <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00801">NtWriteFileGather()</a>.
<p>
<pre class="fragment"><div>01943                    :
01944 
01945     This routine performs generalized cleanup <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O system services when
01946     an exception occurs during caller parameter processing.  This routine
01947     performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following steps:
01948 
01949         o   If a system buffer was allocated <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> freed.
01950 
01951         o   If an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> was allocated <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> freed.
01952 
01953         o   The <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> freed.
01954 
01955         o   If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> opened <span class="keywordflow">for</span> synchronous I/O, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> semaphore
01956             <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> released.
01957 
01958         o   If an event object was referenced <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> dereferenced.
01959 
01960         o   If a kernel event was allocated, free <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
01961 
01962         o   The <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> dereferenced.
01963 
01964 Arguments:
01965 
01966     FileObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object currently being worked on.
01967 
01968     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> allocated to handle <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O request.
01969 
01970     EventObject - Optional pointer to a referenced event object.
01971 
01972     KernelEvent - Optional pointer to an allocated kernel event.
01973 
01974 Return Value:
01975 
01976     None.
01977 
01978 --*/
01979 
01980 {
01981     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01982 
01983     <span class="comment">//</span>
01984     <span class="comment">// If a system buffer was allocated from nonpaged pool, free it.</span>
01985     <span class="comment">//</span>
01986 
01987     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01988         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer );
01989     }
01990 
01991     <span class="comment">//</span>
01992     <span class="comment">// If an MDL was allocated, free it.</span>
01993     <span class="comment">//</span>
01994 
01995     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01996         <a class="code" href="../../d4/d6/iosubs_8c.html#a65">IoFreeMdl</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> );
01997     }
01998 
01999     <span class="comment">//</span>
02000     <span class="comment">// Free the I/O Request Packet.</span>
02001     <span class="comment">//</span>
02002 
02003     <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>( Irp );
02004 
02005     <span class="comment">//</span>
02006     <span class="comment">// Finally, release the synchronization semaphore if it is currently</span>
02007     <span class="comment">// held, dereference the event if one was specified, free the kernel</span>
02008     <span class="comment">// event if one was allocated, and dereference the file object.</span>
02009     <span class="comment">//</span>
02010 
02011     <span class="keywordflow">if</span> (FileObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
02012         <a class="code" href="../../d0/d6/iop_8h.html#a22">IopReleaseFileObjectLock</a>( FileObject );
02013     }
02014 
02015     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( EventObject )) {
02016         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( EventObject );
02017     }
02018 
02019     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( KernelEvent )) {
02020         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( KernelEvent );
02021     }
02022 
02023     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( FileObject );
02024 
02025     <span class="keywordflow">return</span>;
02026 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a169" doxytag="iop.h::IopExceptionFilter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG IopExceptionFilter           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PEXCEPTION_POINTERS&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionPointers</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PNTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionCode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l01883">1883</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l01019">IopCompleteRequest()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00036">NtReadFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00730">NtReadFileScatter()</a>, <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00035">NtWriteFile()</a>, and <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00801">NtWriteFileGather()</a>.
<p>
<pre class="fragment"><div>01890                    :
01891 
01892     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when an exception occurs to determine whether or
01893     not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception was due to an error that caused an in-page error status
01894     code exception to be raised.  If so, then <span class="keyword">this</span> routine changes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> code
01895     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception record to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual error code that was originally
01896     raised.
01897 
01898 Arguments:
01899 
01900     ExceptionPointer - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception record.
01901 
01902     ExceptionCode - Variable to receive actual exception code.
01903 
01904 Return Value:
01905 
01906     The function value indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception handler <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be executed.
01907 
01908 --*/
01909 
01910 {
01911     <span class="comment">//</span>
01912     <span class="comment">// Simply check for an in-page error status code and, if the conditions</span>
01913     <span class="comment">// are right, replace it with the actual status code.</span>
01914     <span class="comment">//</span>
01915 
01916     *ExceptionCode = ExceptionPointer-&gt;ExceptionRecord-&gt;ExceptionCode;
01917     <span class="keywordflow">if</span> (*ExceptionCode == STATUS_IN_PAGE_ERROR &amp;&amp;
01918         ExceptionPointer-&gt;ExceptionRecord-&gt;NumberParameters &gt;= 3) {
01919         *ExceptionCode = (LONG) ExceptionPointer-&gt;ExceptionRecord-&gt;ExceptionInformation[2];
01920     }
01921 
01922     <span class="comment">//</span>
01923     <span class="comment">// Translate alignment warnings into alignment errors.</span>
01924     <span class="comment">//</span>
01925 
01926     <span class="keywordflow">if</span> (*ExceptionCode == STATUS_DATATYPE_MISALIGNMENT) {
01927         *ExceptionCode = STATUS_DATATYPE_MISALIGNMENT_ERROR;
01928     }
01929 
01930     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>;
01931 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a235" doxytag="iop.h::IopfCallDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FASTCALL IopfCallDriver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00953">IopSetIoRoutines()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a236" doxytag="iop.h::IopfCompleteRequest" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IopfCompleteRequest           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN CCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>PriorityBost</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/iosubs_8c-source.html#l03180">3180</a> of file <a class="el" href="../../d5/d5/iosubs_8c-source.html">iosubs.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d4/d6/iosubs_8c.html#a5">ZeroIrpStackLocation</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00953">IopSetIoRoutines()</a>, and <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00297">IovCompleteRequest()</a>.
<p>
<pre class="fragment"><div>03187                    :
03188 
03189     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to complete an I/O request.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03190     driver in its DPC routine to perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> completion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>.  The
03191     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a> performed by <span class="keyword">this</span> routine are as follows.
03192 
03193         1.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> check <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to determine whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> packet's stack locations
03194             have been exhausted.  If not, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack location pointer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set
03195             to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next location and <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a routine to be invoked, then
03196             <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will be invoked.  This continues until there are either no more
03197             <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> which are interested or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> packet runs <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> of stack.
03198 
03199             If a routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> packet <span class="keywordflow">for</span> a specific driver
03200             which needs to perform work a lot of work or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> work needs to be
03201             performed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of another process, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine will
03202             <span class="keywordflow">return</span> an alternate success code of STATUS_MORE_PROCESSING_REQUIRED.
03203             This indicates that <span class="keyword">this</span> completion routine should simply <span class="keywordflow">return</span> to
03204             its caller because <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation will be <span class="stringliteral">"completed"</span> by <span class="keyword">this</span> routine
03205             again sometime in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> future.
03206 
03207         2.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> check <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to determine whether <span class="keyword">this</span> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an associated <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>.
03208             If <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> count on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> master <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> decremented.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03209             count <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> master becomes zero, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> master <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> will be
03210             completed according to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> steps below taken <span class="keywordflow">for</span> a normal <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> being
03211             completed.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> count <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> still non-zero, then <span class="keyword">this</span> <a class="code" href="../../d0/d5/io_8h.html#a355">IRP</a> (the one
03212             being completed) will simply be deallocated.
03213 
03214         3.  If <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> paging I/O or a close operation, then simply write <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03215             I/O status block and set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> signaled state, and
03216             dereference <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event.  If <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> paging I/O, deallocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d5/io_8h.html#a355">IRP</a>
03217             as well.
03218 
03219         4.  <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages, <span class="keywordflow">if</span> any, specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> by calling
03220             <a class="code" href="../../d2/d1/mm_8h.html#a274">MmUnlockPages</a>.
03221 
03222         5.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> check <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to determine whether or not completion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03223             request can be deferred until later.  If <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can be, then <span class="keyword">this</span>
03224             routine simply exits and leaves <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> up to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> originator of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03225             request to fully complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d5/io_8h.html#a355">IRP</a>.  By not initializing and queueing
03226             <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> special kernel APC to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling thread (which is the current
03227             thread by definition), a lot of interrupt and queueing processing
03228             can be avoided.
03229 
03230 
03231         6.  The <span class="keyword">final</span> rundown routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to queue <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request packet to
03232             <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target (requesting) thread as a special kernel mode APC.
03233 
03234 Arguments:
03235 
03236     Irp - Pointer to the I/O Request Packet to complete.
03237 
03238     PriorityBoost - Supplies the amount of priority boost that is to be given
03239         to the target thread when the special kernel APC is queued.
03240 
03241 Return Value:
03242 
03243     None.
03244 
03245 --*/
03246 
03247 #define ZeroIrpStackLocation( IrpSp ) {         \
03248     (IrpSp)-&gt;MinorFunction = 0;                 \
03249     (IrpSp)-&gt;Flags = 0;                         \
03250     (IrpSp)-&gt;Control = 0 ;                      \
03251     (IrpSp)-&gt;Parameters.Others.Argument1 = 0;   \
03252     (IrpSp)-&gt;Parameters.Others.Argument2 = 0;   \
03253     (IrpSp)-&gt;Parameters.Others.Argument3 = 0;   \
03254     (IrpSp)-&gt;Parameters.Others.Argument4 = 0;   \
03255     (IrpSp)-&gt;FileObject = (<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; }
03256 
03257 {
03258     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> masterIrp;
03259     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03260     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> stackPointer;
03261     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> mdl;
03262     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> thread;
03263     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
03264     KIRQL irql;
03265     PVOID saveAuxiliaryPointer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03266 
03267     <span class="comment">//</span>
03268     <span class="comment">// Begin by ensuring that this packet has not already been completed</span>
03269     <span class="comment">// by someone.</span>
03270     <span class="comment">//</span>
03271 
03272     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a> &gt; (CCHAR) (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o12">StackCount</a> + 1) ||
03273         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o0">Type</a> != <a class="code" href="../../d0/d5/io_8h.html#a5">IO_TYPE_IRP</a>) {
03274         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( MULTIPLE_IRP_COMPLETE_REQUESTS, (ULONG_PTR) Irp, __LINE__, 0, 0 );
03275     }
03276 
03277     <span class="comment">//</span>
03278     <span class="comment">// Ensure that the packet being completed really is still an IRP.</span>
03279     <span class="comment">//</span>
03280 
03281     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o0">Type</a> == IO_TYPE_IRP );
03282 
03283     <span class="comment">//</span>
03284     <span class="comment">// Ensure that no one believes that this request is still in a cancelable</span>
03285     <span class="comment">// state.</span>
03286     <span class="comment">//</span>
03287 
03288     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o25">CancelRoutine</a> );
03289 
03290     <span class="comment">//</span>
03291     <span class="comment">// Ensure that the packet is not being completed with a thoroughly</span>
03292     <span class="comment">// confusing status code.  Actually completing a packet with a pending</span>
03293     <span class="comment">// status probably means that someone forgot to set the real status in</span>
03294     <span class="comment">// the packet.</span>
03295     <span class="comment">//</span>
03296 
03297     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status != STATUS_PENDING );
03298 
03299     <span class="comment">//</span>
03300     <span class="comment">// Ensure that the packet is not being completed with a minus one.  This</span>
03301     <span class="comment">// is apparently a common problem in some drivers, and has no meaning</span>
03302     <span class="comment">// as a status code.</span>
03303     <span class="comment">//</span>
03304 
03305     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status != 0xffffffff );
03306 
03307     <span class="comment">//</span>
03308     <span class="comment">// Ensure that if this is a paging I/O operation, and it failed, that the</span>
03309     <span class="comment">// reason for the failure isn't because quota was exceeded.</span>
03310     <span class="comment">//</span>
03311 
03312     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !(<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; IRP_PAGING_IO &amp;&amp; <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status == STATUS_QUOTA_EXCEEDED ) );
03313 
03314     <span class="comment">//</span>
03315     <span class="comment">// Now check to see whether this is the last driver that needs to be</span>
03316     <span class="comment">// invoked for this packet.  If not, then bump the stack and check to</span>
03317     <span class="comment">// see whether the driver wishes to see the completion.  As each stack</span>
03318     <span class="comment">// location is examined, invoke any routine which needs to be invoked.</span>
03319     <span class="comment">// If the routine returns STATUS_MORE_PROCESSING_REQUIRED, then stop the</span>
03320     <span class="comment">// processing of this packet.</span>
03321     <span class="comment">//</span>
03322 
03323     <span class="keywordflow">for</span> (stackPointer = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp ),
03324          <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a>++,
03325          <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.CurrentStackLocation++;
03326          <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a> &lt;= (CCHAR) (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o12">StackCount</a> + 1);
03327          stackPointer++,
03328          <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a>++,
03329          <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.CurrentStackLocation++) {
03330 
03331         <span class="comment">//</span>
03332         <span class="comment">// A stack location was located.  Check to see whether or not it</span>
03333         <span class="comment">// has a completion routine and if so, whether or not it should be</span>
03334         <span class="comment">// invoked.</span>
03335         <span class="comment">//</span>
03336         <span class="comment">// Begin by saving the pending returned flag in the current stack</span>
03337         <span class="comment">// location in the fixed part of the IRP.</span>
03338         <span class="comment">//</span>
03339 
03340         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o11">PendingReturned</a> = stackPointer-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o3">Control</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a194">SL_PENDING_RETURNED</a>;
03341 
03342         <span class="keywordflow">if</span> ( (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status ) &amp;&amp;
03343              stackPointer-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o3">Control</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a196">SL_INVOKE_ON_SUCCESS</a>) ||
03344              (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status ) &amp;&amp;
03345              stackPointer-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o3">Control</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a197">SL_INVOKE_ON_ERROR</a>) ||
03346              (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a> &amp;&amp;
03347              stackPointer-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o3">Control</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a195">SL_INVOKE_ON_CANCEL</a>)
03348            ) {
03349 
03350             <span class="comment">//</span>
03351             <span class="comment">// This driver has specified a completion routine.  Invoke the</span>
03352             <span class="comment">// routine passing it a pointer to its device object and the</span>
03353             <span class="comment">// IRP that is being completed.</span>
03354             <span class="comment">//</span>
03355 
03356             <a class="code" href="../../d4/d6/iosubs_8c.html#a5">ZeroIrpStackLocation</a>( stackPointer );
03357 
03358             <a class="code" href="../../d2/d1/mm_8h.html#a43">PERFINFO_DRIVER_COMPLETIONROUTINE_CALL</a>(Irp, stackPointer);
03359 
03360             status = stackPointer-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o116">CompletionRoutine</a>( (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a> == (CCHAR) (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o12">StackCount</a> + 1) ?
03361                                                       (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) NULL :
03362                                                       <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp )-&gt;DeviceObject),
03363                                                       Irp,
03364                                                       stackPointer-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o117">Context</a> );
03365 
03366             <a class="code" href="../../d2/d1/mm_8h.html#a44">PERFINFO_DRIVER_COMPLETIONROUTINE_RETURN</a>(Irp, stackPointer);
03367 
03368             <span class="keywordflow">if</span> (status == STATUS_MORE_PROCESSING_REQUIRED) {
03369 
03370                 <span class="comment">//</span>
03371                 <span class="comment">// Note:  Notice that if the driver has returned the above</span>
03372                 <span class="comment">//        status value, it may have already DEALLOCATED the</span>
03373                 <span class="comment">//        packet!  Therefore, do NOT touch any part of the</span>
03374                 <span class="comment">//        IRP in the following code.</span>
03375                 <span class="comment">//</span>
03376 
03377                 <span class="keywordflow">return</span>;
03378             }
03379 
03380         } <span class="keywordflow">else</span> {
03381             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o11">PendingReturned</a> &amp;&amp; <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a> &lt;= <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o12">StackCount</a>) {
03382                 <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( Irp );
03383             }
03384             <a class="code" href="../../d4/d6/iosubs_8c.html#a5">ZeroIrpStackLocation</a>( stackPointer );
03385         }
03386     }
03387 
03388     <span class="comment">//</span>
03389     <span class="comment">// Check to see whether this is an associated IRP.  If so, then decrement</span>
03390     <span class="comment">// the count in the master IRP.  If the count is decremented to zero,</span>
03391     <span class="comment">// then complete the master packet as well.</span>
03392     <span class="comment">//</span>
03393 
03394     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a177">IRP_ASSOCIATED_IRP</a>) {
03395         ULONG count;
03396         masterIrp = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.MasterIrp;
03397         count = <a class="code" href="../../d5/d8/ex_8h.html#a235">ExInterlockedAddUlong</a>( (PULONG) &amp;masterIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.IrpCount,
03398                                        0xffffffff,
03399                                        &amp;IopDatabaseLock );
03400 
03401         <span class="comment">//</span>
03402         <span class="comment">// Deallocate this packet and any MDLs that are associated with it</span>
03403         <span class="comment">// by either doing direct deallocations if they were allocated from</span>
03404         <span class="comment">// a zone or by queueing the packet to a thread to perform the</span>
03405         <span class="comment">// deallocation.</span>
03406         <span class="comment">//</span>
03407         <span class="comment">// Also, check the count of the master IRP to determine whether or not</span>
03408         <span class="comment">// the count has gone to zero.  If not, then simply get out of here.</span>
03409         <span class="comment">// Otherwise, complete the master packet.</span>
03410         <span class="comment">//</span>
03411 
03412         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = masterIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread;
03413         <a class="code" href="../../d0/d6/iop_8h.html#a172">IopFreeIrpAndMdls</a>( Irp );
03414         <span class="keywordflow">if</span> (count == 1) {
03415             <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>( masterIrp, PriorityBoost );
03416         }
03417         <span class="keywordflow">return</span>;
03418     }
03419 
03420     <span class="comment">//</span>
03421     <span class="comment">// Check to see if we have a name junction. If so set the stage to</span>
03422     <span class="comment">// transmogrify the reparse point data in IopCompleteRequest.</span>
03423     <span class="comment">//</span>
03424 
03425     <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status == STATUS_REPARSE )  &amp;&amp;
03426         (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information &gt; IO_REPARSE_TAG_RESERVED_RANGE)) {
03427 
03428         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information == IO_REPARSE_TAG_MOUNT_POINT) {
03429 
03430             <span class="comment">//</span>
03431             <span class="comment">// For name junctions, we save the pointer to the auxiliary</span>
03432             <span class="comment">// buffer and use it below.</span>
03433             <span class="comment">//</span>
03434 
03435             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.AuxiliaryBuffer != NULL );
03436 
03437             saveAuxiliaryPointer = (PVOID) <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.AuxiliaryBuffer;
03438 
03439             <span class="comment">//</span>
03440             <span class="comment">// We NULL the entry to avoid its de-allocation at this time.</span>
03441             <span class="comment">// This buffer get deallocated in IopDoNameTransmogrify</span>
03442             <span class="comment">//</span>
03443 
03444             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.AuxiliaryBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03445         } <span class="keywordflow">else</span> {
03446 
03447             <span class="comment">//</span>
03448             <span class="comment">// Fail the request. A driver needed to act on this IRP prior</span>
03449             <span class="comment">// to getting to this point.</span>
03450             <span class="comment">//</span>
03451 
03452             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = STATUS_IO_REPARSE_TAG_NOT_HANDLED;
03453         }
03454     }
03455 
03456     <span class="comment">//</span>
03457     <span class="comment">// Check the auxiliary buffer pointer in the packet and if a buffer was</span>
03458     <span class="comment">// allocated, deallocate it now.  Note that this buffer must be freed</span>
03459     <span class="comment">// here since the pointer is overlayed with the APC that will be used</span>
03460     <span class="comment">// to get to the requesting thread's context.</span>
03461     <span class="comment">//</span>
03462 
03463     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.AuxiliaryBuffer) {
03464         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.AuxiliaryBuffer );
03465         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.AuxiliaryBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03466     }
03467 
03468     <span class="comment">//</span>
03469     <span class="comment">// Check to see if this is paging I/O or a close operation.  If either,</span>
03470     <span class="comment">// then special processing must be performed.  The reasons that special</span>
03471     <span class="comment">// processing must be performed is different based on the type of</span>
03472     <span class="comment">// operation being performed.  The biggest reasons for special processing</span>
03473     <span class="comment">// on paging operations are that using a special kernel APC for an in-</span>
03474     <span class="comment">// page operation cannot work since the special kernel APC can incur</span>
03475     <span class="comment">// another pagefault.  Likewise, all paging I/O uses MDLs that belong</span>
03476     <span class="comment">// to the memory manager, not the I/O system.</span>
03477     <span class="comment">//</span>
03478     <span class="comment">// Close operations are special because the close may have been invoked</span>
03479     <span class="comment">// because of a special kernel APC (some IRP was completed which caused</span>
03480     <span class="comment">// the reference count on the object to become zero while in the I/O</span>
03481     <span class="comment">// system's special kernel APC routine).  Therefore, a special kernel APC</span>
03482     <span class="comment">// cannot be used since it cannot execute until the close APC finishes.</span>
03483     <span class="comment">//</span>
03484     <span class="comment">// The special steps are as follows for a synchronous paging operation</span>
03485     <span class="comment">// and close are:</span>
03486     <span class="comment">//</span>
03487     <span class="comment">//     1.  Copy the I/O status block (it is in SVAS, nonpaged).</span>
03488     <span class="comment">//     2.  Signal the event</span>
03489     <span class="comment">//     3.  If paging I/O, deallocate the IRP</span>
03490     <span class="comment">//</span>
03491     <span class="comment">// The special steps taken for asynchronous paging operations (out-pages)</span>
03492     <span class="comment">// are as follows:</span>
03493     <span class="comment">//</span>
03494     <span class="comment">//     1.  Initialize a special kernel APC just for page writes.</span>
03495     <span class="comment">//     1.  Queue the special kernel APC.</span>
03496     <span class="comment">//</span>
03497     <span class="comment">// It should also be noted that the logic for completing a Mount request</span>
03498     <span class="comment">// operation is exactly the same as a Page Read.  No assumptions should be</span>
03499     <span class="comment">// made here about this being a Page Read operation w/o carefully checking</span>
03500     <span class="comment">// to ensure that they are also true for a Mount.  That is:</span>
03501     <span class="comment">//</span>
03502     <span class="comment">//     IRP_PAGING_IO  and  IRP_MOUNT_COMPLETION</span>
03503     <span class="comment">//</span>
03504     <span class="comment">// are the same flag in the IRP.</span>
03505     <span class="comment">//</span>
03506     <span class="comment">// Also note that the last time the IRP is touched for a close operation</span>
03507     <span class="comment">// must be just before the event is set to the signaled state.  Once this</span>
03508     <span class="comment">// occurs, the IRP can be deallocated by the thread waiting for the event.</span>
03509     <span class="comment">//</span>
03510 
03511     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; (<a class="code" href="../../d0/d5/io_8h.html#a174">IRP_PAGING_IO</a> | <a class="code" href="../../d0/d5/io_8h.html#a185">IRP_CLOSE_OPERATION</a>)) {
03512         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; (<a class="code" href="../../d0/d5/io_8h.html#a181">IRP_SYNCHRONOUS_PAGING_IO</a> | <a class="code" href="../../d0/d5/io_8h.html#a185">IRP_CLOSE_OPERATION</a>)) {
03513             ULONG flags;
03514 
03515             flags = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a181">IRP_SYNCHRONOUS_PAGING_IO</a>;
03516             *<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>;
03517             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a>, PriorityBoost, FALSE );
03518             <span class="keywordflow">if</span> (flags) {
03519                 <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>( Irp );
03520             }
03521         } <span class="keywordflow">else</span> {
03522             thread = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread;
03523             <a class="code" href="../../d5/d7/apcobj_8c.html#a1">KeInitializeApc</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Apc,
03524                              &amp;thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>,
03525                              <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o16">ApcEnvironment</a>,
03526                              IopCompletePageWrite,
03527                              (PKRUNDOWN_ROUTINE) NULL,
03528                              (PKNORMAL_ROUTINE) NULL,
03529                              KernelMode,
03530                              (PVOID) NULL );
03531             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d5/d7/apcobj_8c.html#a3">KeInsertQueueApc</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Apc,
03532                                      (PVOID) NULL,
03533                                      (PVOID) NULL,
03534                                      PriorityBoost );
03535         }
03536         <span class="keywordflow">return</span>;
03537     }
03538 
03539     <span class="comment">//</span>
03540     <span class="comment">// Check to see whether any pages need to be unlocked.</span>
03541     <span class="comment">//</span>
03542 
03543     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03544 
03545         <span class="comment">//</span>
03546         <span class="comment">// Unlock any pages that may be described by MDLs.</span>
03547         <span class="comment">//</span>
03548 
03549         mdl = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a>;
03550         <span class="keywordflow">while</span> (mdl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03551             <a class="code" href="../../d5/d6/iosup_8c.html#a45">MmUnlockPages</a>( mdl );
03552             mdl = mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o0">Next</a>;
03553         }
03554     }
03555 
03556     <span class="comment">//</span>
03557     <span class="comment">// Make a final check here to determine whether or not this is a</span>
03558     <span class="comment">// synchronous I/O operation that is being completed in the context</span>
03559     <span class="comment">// of the original requestor.  If so, then an optimal path through</span>
03560     <span class="comment">// I/O completion can be taken.</span>
03561     <span class="comment">//</span>
03562 
03563     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a186">IRP_DEFER_IO_COMPLETION</a> &amp;&amp; !<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o11">PendingReturned</a>) {
03564 
03565         <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status == STATUS_REPARSE )  &amp;&amp;
03566             (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information == IO_REPARSE_TAG_MOUNT_POINT)) {
03567 
03568             <span class="comment">//</span>
03569             <span class="comment">// For name junctions we reinstate the address of the appropriate</span>
03570             <span class="comment">// buffer. It is freed in parse.c</span>
03571             <span class="comment">//</span>
03572 
03573             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.AuxiliaryBuffer = saveAuxiliaryPointer;
03574         }
03575 
03576         <span class="keywordflow">return</span>;
03577     }
03578 
03579     <span class="comment">//</span>
03580     <span class="comment">// Finally, initialize the IRP as an APC structure and queue the special</span>
03581     <span class="comment">// kernel APC to the target thread.</span>
03582     <span class="comment">//</span>
03583 
03584     thread = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread;
03585     fileObject = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject;
03586 
03587     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a>) {
03588 
03589         <a class="code" href="../../d5/d7/apcobj_8c.html#a1">KeInitializeApc</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Apc,
03590                          &amp;thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>,
03591                          <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o16">ApcEnvironment</a>,
03592                          IopCompleteRequest,
03593                          IopAbortRequest,
03594                          (PKNORMAL_ROUTINE) NULL,
03595                          KernelMode,
03596                          (PVOID) NULL );
03597 
03598         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d5/d7/apcobj_8c.html#a3">KeInsertQueueApc</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Apc,
03599                                  fileObject,
03600                                  (PVOID) saveAuxiliaryPointer,
03601                                  PriorityBoost );
03602     } <span class="keywordflow">else</span> {
03603 
03604         <span class="comment">//</span>
03605         <span class="comment">// This request has been cancelled.  Ensure that access to the thread</span>
03606         <span class="comment">// is synchronized, otherwise it may go away while attempting to get</span>
03607         <span class="comment">// through the remainder of completion for this request.  This happens</span>
03608         <span class="comment">// when the thread times out waiting for the request to be completed</span>
03609         <span class="comment">// once it has been cancelled.</span>
03610         <span class="comment">//</span>
03611         <span class="comment">// Note that it is safe to capture the thread pointer above, w/o having</span>
03612         <span class="comment">// the lock because the cancel flag was not set at that point, and</span>
03613         <span class="comment">// the code that disassociates IRPs must set the flag before looking to</span>
03614         <span class="comment">// see whether or not the packet has been completed, and this packet</span>
03615         <span class="comment">// will appear to be completed because it no longer belongs to a driver.</span>
03616         <span class="comment">//</span>
03617 
03618         ExAcquireSpinLock( &amp;IopCompletionLock, &amp;irql );
03619 
03620         thread = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread;
03621 
03622         <span class="keywordflow">if</span> (thread) {
03623 
03624             <a class="code" href="../../d5/d7/apcobj_8c.html#a1">KeInitializeApc</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Apc,
03625                              &amp;thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>,
03626                              <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o16">ApcEnvironment</a>,
03627                              IopCompleteRequest,
03628                              IopAbortRequest,
03629                              (PKNORMAL_ROUTINE) NULL,
03630                              KernelMode,
03631                              (PVOID) NULL );
03632 
03633             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d5/d7/apcobj_8c.html#a3">KeInsertQueueApc</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Apc,
03634                                      fileObject,
03635                                      (PVOID) saveAuxiliaryPointer,
03636                                      PriorityBoost );
03637 
03638             ExReleaseSpinLock( &amp;IopCompletionLock, irql );
03639 
03640         } <span class="keywordflow">else</span> {
03641 
03642             <span class="comment">//</span>
03643             <span class="comment">// This request has been aborted from completing in the caller's</span>
03644             <span class="comment">// thread.  This can only occur if the packet was cancelled, and</span>
03645             <span class="comment">// the driver did not complete the request, so it was timed out.</span>
03646             <span class="comment">// Attempt to drop things on the floor, since the originating thread</span>
03647             <span class="comment">// has probably exited at this point.</span>
03648             <span class="comment">//</span>
03649 
03650             ExReleaseSpinLock( &amp;IopCompletionLock, irql );
03651 
03652             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a> );
03653 
03654             <span class="comment">//</span>
03655             <span class="comment">// Drop the IRP on the floor.</span>
03656             <span class="comment">//</span>
03657 
03658             <a class="code" href="../../d0/d6/iop_8h.html#a168">IopDropIrp</a>( Irp, fileObject );
03659 
03660         }
03661     }
03662 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a238" doxytag="iop.h::IopFreeIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopFreeIrp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Irp</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06641">6641</a> of file <a class="el" href="../../d5/d5/iosubs_8c-source.html">iosubs.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01680">_IRP::AllocationFlags</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01655">_IRP::CurrentLocation</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00725">_GENERAL_LOOKASIDE::Depth</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a243">ExInterlockedPushEntrySList()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00637">ExQueryDepthSList</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l03480">ExReturnPoolQuota()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00735">_GENERAL_LOOKASIDE::FreeMisses</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00040">IO_TYPE_IRP</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00546">IopLookasideIrpFloat</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00547">IopLookasideIrpLimit</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01576">IRP_ALLOCATED_FIXED_SIZE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01575">IRP_ALLOCATED_MUST_SUCCEED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01577">IRP_LOOKASIDE_ALLOCATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01574">IRP_QUOTA_CHARGED</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00755">_NPAGED_LOOKASIDE_LIST::L</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00724">_GENERAL_LOOKASIDE::ListHead</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00756">_NPAGED_LOOKASIDE_LIST::Lock</a>, <a class="el" href="../../d5/d8/ex_8h.html#a331a198">LookasideLargeIrpList</a>, <a class="el" href="../../d5/d8/ex_8h.html#a331a197">LookasideSmallIrpList</a>, <a class="el" href="../../d5/d8/ex_8h.html#a108">PP_NPAGED_LOOKASIDE_NUMBER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01654">_IRP::StackCount</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00733">_GENERAL_LOOKASIDE::TotalFrees</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01584">_IRP::Type</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00953">IopSetIoRoutines()</a>, and <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00206">IovFreeIrpPrivate()</a>.
<p>
<pre class="fragment"><div>06647                    :
06648 
06649     This routine deallocates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet.
06650 
06651 Arguments:
06652 
06653     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet to deallocate.
06654 
06655 Return Value:
06656 
06657     None.
06658 
06659 --*/
06660 
06661 {
06662     <a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">PNPAGED_LOOKASIDE_LIST</a> lookasideList;
06663     <a class="code" href="../../d5/d8/ex_8h.html#a108">PP_NPAGED_LOOKASIDE_NUMBER</a> number;
06664     PKPRCB prcb;
06665 
06666     <span class="comment">//</span>
06667     <span class="comment">// Ensure that the data structure being freed is really an IRP.</span>
06668     <span class="comment">//</span>
06669 
06670     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o0">Type</a> == IO_TYPE_IRP );
06671 
06672     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o0">Type</a> != <a class="code" href="../../d0/d5/io_8h.html#a5">IO_TYPE_IRP</a>) {
06673         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( MULTIPLE_IRP_COMPLETE_REQUESTS, (ULONG_PTR) Irp, __LINE__, 0, 0 );
06674     }
06675 
06676 
06677     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsListEmpty(&amp;(Irp)-&gt;ThreadListEntry));
06678     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o0">Type</a> = 0;
06679 
06680     <span class="comment">//</span>
06681     <span class="comment">// Ensure that all of the owners of the IRP have at least been notified</span>
06682     <span class="comment">// that the request is going away.</span>
06683     <span class="comment">//</span>
06684 
06685     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a> &gt;= <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o12">StackCount</a> );
06686 
06687     <span class="comment">//</span>
06688     <span class="comment">// Deallocate the IRP.</span>
06689     <span class="comment">//</span>
06690 
06691     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o17">AllocationFlags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a193">IRP_LOOKASIDE_ALLOCATION</a>) {
06692         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o17">AllocationFlags</a> ^= <a class="code" href="../../d0/d5/io_8h.html#a193">IRP_LOOKASIDE_ALLOCATION</a>;
06693         InterlockedDecrement( &amp;IopLookasideIrpFloat );
06694     }
06695     <span class="keywordflow">if</span> (!(<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o17">AllocationFlags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a192">IRP_ALLOCATED_FIXED_SIZE</a>) ||
06696         (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o17">AllocationFlags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a191">IRP_ALLOCATED_MUST_SUCCEED</a>) ||
06697         (<a class="code" href="../../d0/d6/iop_8h.html#a130">IopLookasideIrpFloat</a> &gt;= <a class="code" href="../../d0/d6/iop_8h.html#a131">IopLookasideIrpLimit</a>)) {
06698         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Irp );
06699 
06700     } <span class="keywordflow">else</span> {
06701         number = <a class="code" href="../../d5/d8/ex_8h.html#a331a197">LookasideSmallIrpList</a>;
06702         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o12">StackCount</a> != 1) {
06703             number = <a class="code" href="../../d5/d8/ex_8h.html#a331a198">LookasideLargeIrpList</a>;
06704         }
06705 
06706         prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
06707         lookasideList = prcb-&gt;PPLookasideList[number].P;
06708         lookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o6">TotalFrees</a> += 1;
06709         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d8/ex_8h.html#a10">ExQueryDepthSList</a>( &amp;lookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a> ) &gt;= lookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o1">Depth</a> ) {
06710             lookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o7">FreeMisses</a> += 1;
06711             lookasideList = prcb-&gt;PPLookasideList[number].<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>;
06712             lookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o6">TotalFrees</a> += 1;
06713             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/ex_8h.html#a10">ExQueryDepthSList</a>( &amp;lookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a> ) &gt;= lookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o1">Depth</a>) {
06714                 lookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o7">FreeMisses</a> += 1;
06715                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Irp );
06716 
06717             } <span class="keywordflow">else</span> {
06718                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o17">AllocationFlags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a190">IRP_QUOTA_CHARGED</a>) {
06719                     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o17">AllocationFlags</a> ^= <a class="code" href="../../d0/d5/io_8h.html#a190">IRP_QUOTA_CHARGED</a>;
06720                     <a class="code" href="../../d5/d8/ex_8h.html#a230">ExReturnPoolQuota</a>( Irp );
06721                 }
06722 
06723                 <a class="code" href="../../d5/d8/ex_8h.html#a243">ExInterlockedPushEntrySList</a>( &amp;lookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>,
06724                                              (PSINGLE_LIST_ENTRY) Irp,
06725                                              &amp;lookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o1">Lock</a> );
06726             }
06727 
06728         } <span class="keywordflow">else</span> {
06729             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o17">AllocationFlags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a190">IRP_QUOTA_CHARGED</a>) {
06730                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o17">AllocationFlags</a> ^= <a class="code" href="../../d0/d5/io_8h.html#a190">IRP_QUOTA_CHARGED</a>;
06731                 <a class="code" href="../../d5/d8/ex_8h.html#a230">ExReturnPoolQuota</a>( Irp );
06732             }
06733 
06734             <a class="code" href="../../d5/d8/ex_8h.html#a243">ExInterlockedPushEntrySList</a>( &amp;lookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>,
06735                                          (PSINGLE_LIST_ENTRY) Irp,
06736                                          &amp;lookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o1">Lock</a> );
06737         }
06738     }
06739 
06740     <span class="keywordflow">return</span>;
06741 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a172" doxytag="iop.h::IopFreeIrpAndMdls" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopFreeIrpAndMdls           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Irp</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l02029">2029</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06632">IoFreeIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06744">IoFreeMdl()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01596">_IRP::MdlAddress</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00414">_MDL::Next</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
<pre class="fragment"><div>02035                    :
02036 
02037     This routine frees <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet and all of its Memory
02038     Descriptor Lists.
02039 
02040 Arguments:
02041 
02042     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet to be freed.
02043 
02044 Return Value:
02045 
02046     None.
02047 
02048 --*/
02049 
02050 {
02051     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> mdl;
02052     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> nextMdl;
02053 
02054     <span class="comment">//</span>
02055     <span class="comment">// If there are any MDLs that need to be freed, free them now.</span>
02056     <span class="comment">//</span>
02057 
02058     <span class="keywordflow">for</span> (mdl = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a>; mdl != (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; mdl = nextMdl) {
02059         nextMdl = mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o0">Next</a>;
02060         <a class="code" href="../../d4/d6/iosubs_8c.html#a65">IoFreeMdl</a>( mdl );
02061     }
02062 
02063     <span class="comment">//</span>
02064     <span class="comment">// Free the IRP.</span>
02065     <span class="comment">//</span>
02066 
02067     <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>( Irp );
02068     <span class="keywordflow">return</span>;
02069 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a173" doxytag="iop.h::IopGetDeviceAttachmentBase" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> IopGetDeviceAttachmentBase           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l03919">3919</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01283">_DEVOBJ_EXTENSION::AttachedTo</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l00657">IopCompleteUnloadOrDelete()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03967">IopGetDeviceAttachmentBaseRef()</a>, and <a class="el" href="../../d4/d0/objsup_8c-source.html#l00826">IopGetDevicePDO()</a>.
<p>
<pre class="fragment"><div>03925                    :
03926 
03927     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lowest level device object associated with
03928     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device.
03929 
03930 Arguments:
03931 
03932     DeviceObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device <span class="keywordflow">for</span> which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bottom of
03933         attachment chain <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be found.
03934 
03935 Return Value:
03936 
03937     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a reference to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lowest level device attached
03938     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supplied device object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> that device
03939     object, then a pointer to <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
03940 
03941     N.B. Caller must own <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/iodata_8c.html#a3">IopDatabaseLock</a>.
03942 
03943 --*/
03944 
03945 {
03946     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> baseDeviceObject;
03947     <a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html">PDEVOBJ_EXTENSION</a> deviceExtension;
03948 
03949     <span class="comment">//</span>
03950     <span class="comment">// Descend down the attachment chain until we find a device object</span>
03951     <span class="comment">// that isn't attached to anything else.</span>
03952     <span class="comment">//</span>
03953 
03954     baseDeviceObject = DeviceObject;
03955     deviceExtension = baseDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>;
03956     <span class="keywordflow">while</span> (deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o7">AttachedTo</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03957 
03958         baseDeviceObject = deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o7">AttachedTo</a>;
03959         deviceExtension = baseDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>;
03960     }
03961 
03962     <span class="keywordflow">return</span> baseDeviceObject;
03963 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a174" doxytag="iop.h::IopGetDeviceAttachmentBaseRef" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> IopGetDeviceAttachmentBaseRef           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l03967">3967</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d4/d4/iodata_8c-source.html#l00054">IopDatabaseLock</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03919">IopGetDeviceAttachmentBase()</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>.
<p>
<pre class="fragment"><div>03973                    :
03974 
03975     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lowest level device object associated with
03976     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device.
03977 
03978 Arguments:
03979 
03980     DeviceObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device <span class="keywordflow">for</span> which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bottom of
03981         attachment chain <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be found.
03982 
03983 Return Value:
03984 
03985     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a reference to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lowest level device attached
03986     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supplied device object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> that device
03987     object, then a pointer to <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
03988 
03989     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> reference <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> taken on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned device object.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03990     responsibility of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller to release <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
03991 
03992 --*/
03993 
03994 {
03995     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> baseDeviceObject;
03996     KIRQL irql;
03997 
03998     <span class="comment">//</span>
03999     <span class="comment">// Any examination of attachment chain linkage must be done with</span>
04000     <span class="comment">// IopDatabaseLock taken.</span>
04001     <span class="comment">//</span>
04002 
04003     ExAcquireSpinLock( &amp;IopDatabaseLock, &amp;irql );
04004 
04005     <span class="comment">//</span>
04006     <span class="comment">// Find the base of the attachment chain.</span>
04007     <span class="comment">//</span>
04008 
04009     baseDeviceObject = <a class="code" href="../../d0/d6/iop_8h.html#a173">IopGetDeviceAttachmentBase</a>( DeviceObject );
04010 
04011     <span class="comment">//</span>
04012     <span class="comment">// Reference the device object before releasing the database lock.</span>
04013     <span class="comment">//</span>
04014 
04015     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( baseDeviceObject );
04016     ExReleaseSpinLock( &amp;IopDatabaseLock, irql );
04017 
04018     <span class="keywordflow">return</span> baseDeviceObject;
04019 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a175" doxytag="iop.h::IopGetDriverNameFromKeyNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetDriverNameFromKeyNode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l02072">2072</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01883">RtlAppendUnicodeStringToString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01821">RtlAppendUnicodeToString()</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03165">IopCallDriverAddDeviceQueryRoutine()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03146">IopInitializeSystemDrivers()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04654">IopLoadBootFilterDriver()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>, and <a class="el" href="../../d9/d3/loadunld_8c-source.html#l00244">NtUnloadDriver()</a>.
<p>
<pre class="fragment"><div>02079                    :
02080 
02081     Given a handle to a driver service list key in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry, <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02082     name that represents <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Object <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a79">Manager</a> name space string that should
02083     be used to locate/create <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver object.
02084 
02085 Arguments:
02086 
02087     KeyHandle - Supplies a handle to driver service entry in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry.
02088 
02089     DriverName - Supplies a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> string descriptor variable in which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02090         name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
02091 
02092 Return Value:
02093 
02094     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
02095 
02096 --*/
02097 
02098 {
02099     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
02100     PKEY_BASIC_INFORMATION keyBasicInformation;
02101     ULONG keyBasicLength;
02102     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02103 
02104     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02105 
02106     <span class="comment">//</span>
02107     <span class="comment">// Get the optional object name for this driver from the value for this</span>
02108     <span class="comment">// key.  If one exists, then its name overrides the default name of the</span>
02109     <span class="comment">// driver.</span>
02110     <span class="comment">//</span>
02111 
02112     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( KeyHandle,
02113                                   L<span class="stringliteral">"ObjectName"</span>,
02114                                   &amp;keyValueInformation );
02115 
02116     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02117 
02118         PWSTR src, dst;
02119         ULONG i;
02120 
02121         <span class="comment">//</span>
02122         <span class="comment">// The driver entry specifies an object name.  This overrides the</span>
02123         <span class="comment">// default name for the driver.  Use this name to open the driver</span>
02124         <span class="comment">// object.</span>
02125         <span class="comment">//</span>
02126 
02127         <span class="keywordflow">if</span> (!keyValueInformation-&gt;DataLength) {
02128             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
02129             <span class="keywordflow">return</span> STATUS_ILL_FORMED_SERVICE_ENTRY;
02130         }
02131 
02132         DriverName-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (keyValueInformation-&gt;DataLength - <span class="keyword">sizeof</span>( WCHAR ));
02133         DriverName-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) keyValueInformation-&gt;DataLength;
02134 
02135         src = (PWSTR) ((PUCHAR) keyValueInformation + keyValueInformation-&gt;DataOffset);
02136         dst = (PWSTR) keyValueInformation;
02137         <span class="keywordflow">for</span> (i = DriverName-&gt;Length; i; i--) {
02138             *dst++ = *src++;
02139         }
02140 
02141         DriverName-&gt;Buffer = (PWSTR) keyValueInformation;
02142 
02143     } <span class="keywordflow">else</span> {
02144 
02145         PULONG driverType;
02146         PWSTR baseObjectName;
02147         UNICODE_STRING remainderName;
02148 
02149         <span class="comment">//</span>
02150         <span class="comment">// The driver node does not specify an object name, so determine</span>
02151         <span class="comment">// what the default name for the driver object should be based on</span>
02152         <span class="comment">// the information in the key.</span>
02153         <span class="comment">//</span>
02154 
02155         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( KeyHandle,
02156                                       L<span class="stringliteral">"Type"</span>,
02157                                       &amp;keyValueInformation );
02158         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) || !keyValueInformation-&gt;DataLength) {
02159 
02160             <span class="comment">//</span>
02161             <span class="comment">// There must be some type of "Type" associated with this driver,</span>
02162             <span class="comment">// either DRIVER or FILE_SYSTEM.  Otherwise, this node is ill-</span>
02163             <span class="comment">// formed.</span>
02164             <span class="comment">//</span>
02165 
02166             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02167                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
02168             }
02169 
02170             <span class="keywordflow">return</span> STATUS_ILL_FORMED_SERVICE_ENTRY;
02171         }
02172 
02173         <span class="comment">//</span>
02174         <span class="comment">// Now determine whether the type of this entry is a driver or a</span>
02175         <span class="comment">// file system.  Begin by assuming that it is a device driver.</span>
02176         <span class="comment">//</span>
02177 
02178         baseObjectName = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Driver\\"</span>;
02179         DriverName-&gt;Length = 8*2;
02180 
02181         driverType = (PULONG) ((PUCHAR) keyValueInformation + keyValueInformation-&gt;DataOffset);
02182 
02183         <span class="keywordflow">if</span> (*driverType == FileSystemType ||
02184             *driverType == RecognizerType) {
02185             baseObjectName = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\FileSystem\\"</span>;
02186             DriverName-&gt;Length = 12*2;
02187         }
02188 
02189         <span class="comment">//</span>
02190         <span class="comment">// Get the name of the key that is being used to describe this</span>
02191         <span class="comment">// driver.  This will return just the last component of the name</span>
02192         <span class="comment">// string, which can be used to formulate the name of the driver.</span>
02193         <span class="comment">//</span>
02194 
02195         status = ZwQueryKey( KeyHandle,
02196                              KeyBasicInformation,
02197                              (PVOID) NULL,
02198                              0,
02199                              &amp;keyBasicLength );
02200 
02201         keyBasicInformation = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool, keyBasicLength );
02202         <span class="keywordflow">if</span> (!keyBasicInformation) {
02203             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
02204             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02205         }
02206 
02207         status = ZwQueryKey( KeyHandle,
02208                              KeyBasicInformation,
02209                              keyBasicInformation,
02210                              keyBasicLength,
02211                              &amp;keyBasicLength );
02212         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02213             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyBasicInformation );
02214             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
02215             <span class="keywordflow">return</span> status;
02216         }
02217 
02218         <span class="comment">//</span>
02219         <span class="comment">// Allocate a buffer from pool that is large enough to contain the</span>
02220         <span class="comment">// entire name string of the driver object.</span>
02221         <span class="comment">//</span>
02222 
02223         DriverName-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (DriverName-&gt;Length + keyBasicInformation-&gt;NameLength);
02224         DriverName-&gt;Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool,
02225                                             DriverName-&gt;MaximumLength );
02226         <span class="keywordflow">if</span> (!DriverName-&gt;Buffer) {
02227             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyBasicInformation );
02228             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
02229             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02230         }
02231 
02232         <span class="comment">//</span>
02233         <span class="comment">// Now form the name of the object to be opened.</span>
02234         <span class="comment">//</span>
02235 
02236         DriverName-&gt;Length = 0;
02237         <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( DriverName, baseObjectName );
02238         remainderName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) keyBasicInformation-&gt;NameLength;
02239         remainderName.MaximumLength = remainderName.Length;
02240         remainderName.Buffer = &amp;keyBasicInformation-&gt;Name[0];
02241         <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>( DriverName, &amp;remainderName );
02242         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyBasicInformation );
02243         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
02244     }
02245 
02246     <span class="comment">//</span>
02247     <span class="comment">// Finally, simply return to the caller with the name filled in.  Note</span>
02248     <span class="comment">// that the caller must free the buffer pointed to by the Buffer field</span>
02249     <span class="comment">// of the Unicode string descriptor.</span>
02250     <span class="comment">//</span>
02251 
02252     <span class="keywordflow">return</span> STATUS_SUCCESS;
02253 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a176" doxytag="iop.h::IopGetDumpControlBlockCheck" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG IopGetDumpControlBlockCheck           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">PDUMP_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Dcb</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01062">1062</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d0/d6/iop_8h.html#a73">DUMP_CONTROL_BLOCK</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d5/io_8h.html#a281">PDUMP_STACK_CONTEXT</a>, <a class="el" href="../../d0/d5/io_8h.html#a280">PDUMP_STACK_IMAGE</a>, and <a class="el" href="../../d1/d2/po_8h.html#a68">PoSimpleCheck()</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04061">IopCompleteDumpInitialization()</a>, and <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01519">IoWriteCrashDump()</a>.
<p>
<pre class="fragment"><div>01067                    :
01068 
01069     Return <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current checksum total <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Dcb
01070 
01071 Arguments:
01072 
01073     DumpStack           - <a class="code" href="../../d2/d5/editreg_8c.html#a66">Dump</a> driver stack to checksum
01074 
01075 Return Value:
01076 
01077     Checksum value
01078 
01079 --*/
01080 {
01081     ULONG                   Check;
01082     PLIST_ENTRY             Link;
01083     <a class="code" href="../../d0/d5/io_8h.html#a280">PDUMP_STACK_IMAGE</a>       DumpImage;
01084     PMAPPED_ADDRESS         MappedAddress;
01085     <a class="code" href="../../d0/d5/io_8h.html#a281">PDUMP_STACK_CONTEXT</a>     DumpStack;
01086 
01087 
01088     <span class="comment">//</span>
01089     <span class="comment">// Check the DCB, memory descriptor array, and the FileDescriptorArray</span>
01090     <span class="comment">//</span>
01091 
01092     Check = <a class="code" href="../../d1/d2/po_8h.html#a68">PoSimpleCheck</a>(0, Dcb, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">DUMP_CONTROL_BLOCK</a>));
01093     Check = <a class="code" href="../../d1/d2/po_8h.html#a68">PoSimpleCheck</a>(
01094                 Check,
01095                 Dcb-&gt;MemoryDescriptor,
01096                 Dcb-&gt;MemoryDescriptorLength
01097                 );
01098 
01099     Check = <a class="code" href="../../d1/d2/po_8h.html#a68">PoSimpleCheck</a>(Check, Dcb-&gt;FileDescriptorArray, Dcb-&gt;FileDescriptorSize);
01100 
01101     DumpStack = Dcb-&gt;DumpStack;
01102     <span class="keywordflow">if</span> (DumpStack) {
01103 
01104         <span class="comment">//</span>
01105         <span class="comment">// Include the dump stack context structure, and dump driver images</span>
01106         <span class="comment">//</span>
01107 
01108         Check = <a class="code" href="../../d1/d2/po_8h.html#a68">PoSimpleCheck</a>(Check, DumpStack, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/structDUMP__STACK__CONTEXT.html">DUMP_STACK_CONTEXT</a>));
01109         Check = <a class="code" href="../../d1/d2/po_8h.html#a68">PoSimpleCheck</a>(Check, DumpStack-&gt;DumpPointers, DumpStack-&gt;PointersLength);
01110 
01111         <span class="keywordflow">for</span> (Link = DumpStack-&gt;DriverList.Flink;
01112              Link != &amp;DumpStack-&gt;DriverList;
01113              Link = Link-&gt;Flink) {
01114 
01115             DumpImage = CONTAINING_RECORD(Link, <a class="code" href="../../d4/d8/structDUMP__STACK__IMAGE.html">DUMP_STACK_IMAGE</a>, Link);
01116             Check = <a class="code" href="../../d1/d2/po_8h.html#a68">PoSimpleCheck</a>(Check, DumpImage, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/structDUMP__STACK__IMAGE.html">DUMP_STACK_IMAGE</a>));
01117             Check = <a class="code" href="../../d1/d2/po_8h.html#a68">PoSimpleCheck</a>(Check, DumpImage-&gt;ImageBase, DumpImage-&gt;SizeOfImage);
01118         }
01119 
01120         <span class="comment">//</span>
01121         <span class="comment">// Include the mapped addresses</span>
01122         <span class="comment">//</span>
01123         <span class="comment">// If this is non-null it is treated as a PMAPPED_ADDRESS * (see scsiport and atdisk)</span>
01124         <span class="comment">//</span>
01125         <span class="keywordflow">if</span> (DumpStack-&gt;Init.MappedRegisterBase != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01126             MappedAddress = *(PMAPPED_ADDRESS *)DumpStack-&gt;Init.MappedRegisterBase;
01127         } <span class="keywordflow">else</span> {
01128             MappedAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01129         }
01130 
01131         <span class="keywordflow">while</span> (MappedAddress) {
01132             Check = <a class="code" href="../../d1/d2/po_8h.html#a68">PoSimpleCheck</a> (Check, MappedAddress, <span class="keyword">sizeof</span>(MAPPED_ADDRESS));
01133             MappedAddress = MappedAddress-&gt;NextMappedAddress;
01134         }
01135     }
01136 
01137     <span class="keywordflow">return</span> Check;
01138 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a177" doxytag="iop.h::IopGetFileName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetFileName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>FileInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnedLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l02256">2256</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00652">IoAllocateIrp()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00284">IopAllocateIrpCleanup()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01103">IopQueueThreadIrp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01554">IRP_BUFFERED_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00060">IRP_MJ_QUERY_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01565">IRP_OB_QUERY_NAME</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01552">IRP_SYNCHRONOUS_API</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o24">_IRP::Overlay</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01641">_IRP::RequestorMode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d5/d2/parse_8c-source.html#l01811">IopQueryName()</a>.
<p>
<pre class="fragment"><div>02265                    :
02266 
02267     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to asynchronously obtain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object
02268     when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> was opened <span class="keywordflow">for</span> synchronous I/O, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02269     caller was kernel mode, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query was done through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Object <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a79">Manager</a>.
02270     In <span class="keyword">this</span> <span class="keywordflow">case</span>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> situation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> likely that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lazy <a class="code" href="../../d4/d0/tex_8c.html#a44">Writer</a> has incurred a
02271     write error, and <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> attempting to obtain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> so that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
02272     can output a popup.  In doing so, a deadlock can occur because another
02273     thread has locked <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object synchronous I/O lock.  Hence, <span class="keyword">this</span> routine
02274     obtains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> w/o acquiring that lock.
02275 
02276 Arguments:
02277 
02278     FileObject - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object whose name <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be queried.
02279 
02280     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name.
02281 
02282     FileInformation - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name.
02283 
02284     ReturnedLength - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name returned.
02285 
02286 Return Value:
02287 
02288     The status returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> completion status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
02289 
02290 --*/
02291 
02292 {
02293 
02294     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
02295     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02296     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
02297     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
02298     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
02299     IO_STATUS_BLOCK localIoStatus;
02300 
02301     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02302 
02303     <span class="comment">//</span>
02304     <span class="comment">// Reference the file object here so that no special checks need be made</span>
02305     <span class="comment">// in I/O completion to determine whether or not to dereference the file</span>
02306     <span class="comment">// object.</span>
02307     <span class="comment">//</span>
02308 
02309     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( FileObject );
02310 
02311     <span class="comment">//</span>
02312     <span class="comment">// Initialize an event that will be used to synchronize the completion of</span>
02313     <span class="comment">// the query operation.  Note that this is the only way to synchronize this</span>
02314     <span class="comment">// since the file object itself cannot be used since it was opened for</span>
02315     <span class="comment">// synchronous I/O and may be busy.</span>
02316     <span class="comment">//</span>
02317 
02318     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event, SynchronizationEvent, FALSE );
02319 
02320     <span class="comment">//</span>
02321     <span class="comment">// Get the address of the target device object.</span>
02322     <span class="comment">//</span>
02323 
02324     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject );
02325 
02326     <span class="comment">//</span>
02327     <span class="comment">// Allocate and initialize the I/O Request Packet (IRP) for this operation.</span>
02328     <span class="comment">//</span>
02329 
02330     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>( deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>, FALSE );
02331     <span class="keywordflow">if</span> (!irp) {
02332 
02333         <span class="comment">//</span>
02334         <span class="comment">// An IRP could not be allocated.  Cleanup and return an appropriate</span>
02335         <span class="comment">// error status code.</span>
02336         <span class="comment">//</span>
02337 
02338         <a class="code" href="../../d0/d6/iop_8h.html#a148">IopAllocateIrpCleanup</a>( FileObject, (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL );
02339         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02340     }
02341 
02342     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = FileObject;
02343     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
02344     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
02345 
02346     <span class="comment">//</span>
02347     <span class="comment">// Fill in the service independent parameters in the IRP.  Note that the</span>
02348     <span class="comment">// setting of the special query name flag in the packet guarantees that the</span>
02349     <span class="comment">// standard completion for a synchronous file object will not occur because</span>
02350     <span class="comment">// this flag communicates to the I/O completion that it should not do so.</span>
02351     <span class="comment">//</span>
02352 
02353     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = &amp;event;
02354     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a> | <a class="code" href="../../d0/d5/io_8h.html#a187">IRP_OB_QUERY_NAME</a>;
02355     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;localIoStatus;
02356     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine = (PIO_APC_ROUTINE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02357 
02358     <span class="comment">//</span>
02359     <span class="comment">// Get a pointer to the stack location for the first driver.  This will be</span>
02360     <span class="comment">// used to pass the original function codes and parameters.</span>
02361     <span class="comment">//</span>
02362 
02363     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
02364     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a18">IRP_MJ_QUERY_INFORMATION</a>;
02365     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = FileObject;
02366 
02367     <span class="comment">//</span>
02368     <span class="comment">// Set the system buffer address to the address of the caller's buffer and</span>
02369     <span class="comment">// set the flags so that the buffer is not deallocated.</span>
02370     <span class="comment">//</span>
02371 
02372     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = FileInformation;
02373     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a178">IRP_BUFFERED_IO</a>;
02374 
02375     <span class="comment">//</span>
02376     <span class="comment">// Copy the caller's parameters to the service-specific portion of the</span>
02377     <span class="comment">// IRP.</span>
02378     <span class="comment">//</span>
02379 
02380     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryFile.Length = Length;
02381     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryFile.FileInformationClass = FileNameInformation;
02382 
02383     <span class="comment">//</span>
02384     <span class="comment">// Insert the packet at the head of the IRP list for the thread.</span>
02385     <span class="comment">//</span>
02386 
02387     <a class="code" href="../../d0/d6/iop_8h.html#a21">IopQueueThreadIrp</a>( irp );
02388 
02389     <span class="comment">//</span>
02390     <span class="comment">// Now simply invoke the driver at its dispatch entry with the IRP.</span>
02391     <span class="comment">//</span>
02392 
02393     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject, irp );
02394 
02395     <span class="comment">//</span>
02396     <span class="comment">// Now get the final status of the operation once the request completes</span>
02397     <span class="comment">// and return the length of the buffer written.</span>
02398     <span class="comment">//</span>
02399 
02400     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
02401         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
02402                                       Executive,
02403                                       KernelMode,
02404                                       FALSE,
02405                                       (PLARGE_INTEGER) NULL );
02406         status = localIoStatus.Status;
02407     }
02408 
02409     *ReturnedLength = (ULONG) localIoStatus.Information;
02410     <span class="keywordflow">return</span> status;
02411 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a178" doxytag="iop.h::IopGetMountFlag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopGetMountFlag           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l02414">2414</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00042">IopVpbSpinLock</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01054">VPB_MOUNTED</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00037">NtQueryVolumeInformationFile()</a>.
<p>
<pre class="fragment"><div>02420                    :
02421 
02422     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to determine whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device
02423     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> mounted.
02424 
02425 Arguments:
02426 
02427     DeviceObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object <span class="keywordflow">for</span> which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mount
02428         flag <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> tested.
02429 
02430 Return Value:
02431 
02432     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> mounted, otherwise
02433     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
02434 
02435 
02436 --*/
02437 
02438 {
02439     KIRQL irql;
02440     BOOLEAN deviceMounted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02441 
02442     <span class="comment">//</span>
02443     <span class="comment">// Check to see whether or not the device is mounted.  Note that the caller</span>
02444     <span class="comment">// has probably already looked to see whether or not the device has a VPB</span>
02445     <span class="comment">// outside of owning the lock, so simply get the lock and check it again</span>
02446     <span class="comment">// to start with, rather than checking to see whether or not the device</span>
02447     <span class="comment">// still has a VPB without holding the lock.</span>
02448     <span class="comment">//</span>
02449 
02450     ExAcquireFastLock( &amp;IopVpbSpinLock, &amp;irql );
02451     <span class="keywordflow">if</span> (DeviceObject-&gt;Vpb) {
02452         <span class="keywordflow">if</span> (DeviceObject-&gt;Vpb-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a116">VPB_MOUNTED</a>) {
02453             deviceMounted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02454         }
02455     }
02456     ExReleaseFastLock( &amp;IopVpbSpinLock, irql );
02457 
02458     <span class="keywordflow">return</span> deviceMounted;
02459 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a179" doxytag="iop.h::IopGetRegistryKeyInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetRegistryKeyInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PKEY_FULL_INFORMATION *&nbsp;</td>
          <td class="mdname" nowrap> <em>Information</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l02462">2462</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04140">IopUnregisterDeviceInterface()</a>, <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00223">pIoQueryBusDescription()</a>, and <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00565">pIoQueryDeviceDescription()</a>.
<p>
<pre class="fragment"><div>02469                    :
02470 
02471     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to retrieve <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full key information <span class="keywordflow">for</span> a
02472     registry key.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done by querying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full key information
02473     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key with a zero-length buffer to determine <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data,
02474     and then allocating a buffer and actually querying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
02475 
02476     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> responsibility of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller to free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
02477 
02478 Arguments:
02479 
02480     KeyHandle - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key handle whose full key information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to
02481         be queried
02482 
02483     Information - Returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated data buffer.
02484 
02485 Return Value:
02486 
02487     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query operation.
02488 
02489 --*/
02490 
02491 {
02492     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02493     PKEY_FULL_INFORMATION infoBuffer;
02494     ULONG keyInfoLength;
02495 
02496     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02497 
02498     <span class="comment">//</span>
02499     <span class="comment">// Figure out how big the data value is so that a buffer of the</span>
02500     <span class="comment">// appropriate size can be allocated.</span>
02501     <span class="comment">//</span>
02502 
02503     status = ZwQueryKey( KeyHandle,
02504                          KeyFullInformation,
02505                          (PVOID) NULL,
02506                          0,
02507                          &amp;keyInfoLength );
02508     <span class="keywordflow">if</span> (status != STATUS_BUFFER_OVERFLOW &amp;&amp;
02509         status != STATUS_BUFFER_TOO_SMALL) {
02510         <span class="keywordflow">return</span> status;
02511     }
02512 
02513     <span class="comment">//</span>
02514     <span class="comment">// Allocate a buffer large enough to contain the entire key data.</span>
02515     <span class="comment">//</span>
02516 
02517     infoBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool, keyInfoLength );
02518     <span class="keywordflow">if</span> (!infoBuffer) {
02519         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02520     }
02521 
02522     <span class="comment">//</span>
02523     <span class="comment">// Query the full key data for the key.</span>
02524     <span class="comment">//</span>
02525 
02526     status = ZwQueryKey( KeyHandle,
02527                          KeyFullInformation,
02528                          infoBuffer,
02529                          keyInfoLength,
02530                          &amp;keyInfoLength );
02531     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02532         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( infoBuffer );
02533         <span class="keywordflow">return</span> status;
02534     }
02535 
02536     <span class="comment">//</span>
02537     <span class="comment">// Everything worked, so simply return the address of the allocated</span>
02538     <span class="comment">// buffer to the caller, who is now responsible for freeing it.</span>
02539     <span class="comment">//</span>
02540 
02541     *Information = infoBuffer;
02542     <span class="keywordflow">return</span> STATUS_SUCCESS;
02543 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a180" doxytag="iop.h::IopGetRegistryValue" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetRegistryValue           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PKEY_VALUE_FULL_INFORMATION *&nbsp;</td>
          <td class="mdname" nowrap> <em>Information</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">2546</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
<pre class="fragment"><div>02554                    :
02555 
02556     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to retrieve <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <span class="keywordflow">for</span> a registry key's value.
02557     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done by querying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key with a zero-length buffer
02558     to determine <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value, and then allocating a buffer and
02559     actually querying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
02560 
02561     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> responsibility of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller to free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
02562 
02563 Arguments:
02564 
02565     KeyHandle - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key handle whose value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be queried
02566 
02567     <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> null-terminated <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value.
02568 
02569     Information - Returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated data buffer.
02570 
02571 Return Value:
02572 
02573     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query operation.
02574 
02575 --*/
02576 
02577 {
02578     UNICODE_STRING unicodeString;
02579     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02580     PKEY_VALUE_FULL_INFORMATION infoBuffer;
02581     ULONG keyValueLength;
02582 
02583     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02584 
02585     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;unicodeString, ValueName );
02586 
02587     <span class="comment">//</span>
02588     <span class="comment">// Figure out how big the data value is so that a buffer of the</span>
02589     <span class="comment">// appropriate size can be allocated.</span>
02590     <span class="comment">//</span>
02591 
02592     status = ZwQueryValueKey( KeyHandle,
02593                               &amp;unicodeString,
02594                               KeyValueFullInformation,
02595                               (PVOID) NULL,
02596                               0,
02597                               &amp;keyValueLength );
02598     <span class="keywordflow">if</span> (status != STATUS_BUFFER_OVERFLOW &amp;&amp;
02599         status != STATUS_BUFFER_TOO_SMALL) {
02600         <span class="keywordflow">return</span> status;
02601     }
02602 
02603     <span class="comment">//</span>
02604     <span class="comment">// Allocate a buffer large enough to contain the entire key data value.</span>
02605     <span class="comment">//</span>
02606 
02607     infoBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool, keyValueLength );
02608     <span class="keywordflow">if</span> (!infoBuffer) {
02609         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02610     }
02611 
02612     <span class="comment">//</span>
02613     <span class="comment">// Query the data for the key value.</span>
02614     <span class="comment">//</span>
02615 
02616     status = ZwQueryValueKey( KeyHandle,
02617                               &amp;unicodeString,
02618                               KeyValueFullInformation,
02619                               infoBuffer,
02620                               keyValueLength,
02621                               &amp;keyValueLength );
02622     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02623         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( infoBuffer );
02624         <span class="keywordflow">return</span> status;
02625     }
02626 
02627     <span class="comment">//</span>
02628     <span class="comment">// Everything worked, so simply return the address of the allocated</span>
02629     <span class="comment">// buffer to the caller, who is now responsible for freeing it.</span>
02630     <span class="comment">//</span>
02631 
02632     *Information = infoBuffer;
02633     <span class="keywordflow">return</span> STATUS_SUCCESS;
02634 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a181" doxytag="iop.h::IopGetRegistryValues" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetRegistryValues           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKEY_VALUE_FULL_INFORMATION *&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueList</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l02637">2637</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00223">pIoQueryBusDescription()</a>, and <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00565">pIoQueryDeviceDescription()</a>.
<p>
<pre class="fragment"><div>02644                    :
02645 
02646     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to retrieve <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> *three* types of data <span class="keywordflow">for</span> a
02647     registry key's.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done by calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d4/internal_8c.html#a40">IopGetRegistryValue</a> function
02648     with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> three valid key names.
02649 
02650     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> responsibility of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller to free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> three buffers.
02651 
02652 Arguments:
02653 
02654     KeyHandle - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key handle whose value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be queried
02655 
02656     ValueList - Pointer to a buffer in which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> three pointers to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value
02657         entries will be stored.
02658 
02659 Return Value:
02660 
02661     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query operation.
02662 
02663 Note:
02664 
02665     The values are stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> order represented by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O query device
02666     data <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>.
02667 
02668 --*/
02669 
02670 {
02671     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02672 
02673     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02674 
02675     <span class="comment">//</span>
02676     <span class="comment">// Zero out all entries initially.</span>
02677     <span class="comment">//</span>
02678 
02679     *ValueList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02680     *(ValueList + 1) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02681     *(ValueList + 2) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02682 
02683     <span class="comment">//</span>
02684     <span class="comment">// Get the information for each of the three types of entries available.</span>
02685     <span class="comment">// Each time, check if an internal error occurred; If the object name was</span>
02686     <span class="comment">// not found, it only means not data was present, and this does not</span>
02687     <span class="comment">// constitute an error.</span>
02688     <span class="comment">//</span>
02689 
02690     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( KeyHandle,
02691                                   L<span class="stringliteral">"Identifier"</span>,
02692                                   ValueList );
02693 
02694     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) &amp;&amp; (status != STATUS_OBJECT_NAME_NOT_FOUND)) {
02695         <span class="keywordflow">return</span> status;
02696     }
02697 
02698     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( KeyHandle,
02699                                   L<span class="stringliteral">"Configuration Data"</span>,
02700                                   ++ValueList );
02701 
02702     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) &amp;&amp; (status != STATUS_OBJECT_NAME_NOT_FOUND)) {
02703         <span class="keywordflow">return</span> status;
02704     }
02705 
02706     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( KeyHandle,
02707                                   L<span class="stringliteral">"Component Information"</span>,
02708                                   ++ValueList );
02709 
02710     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) &amp;&amp; (status != STATUS_OBJECT_NAME_NOT_FOUND)) {
02711         <span class="keywordflow">return</span> status;
02712     }
02713 
02714     <span class="keywordflow">return</span> STATUS_SUCCESS;
02715 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a182" doxytag="iop.h::IopGetSetObjectId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetSetObjectId           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>OperationFlags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l02718">2718</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01552">IoBuildDeviceIoControlRequest()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00068">IRP_MJ_FILE_SYSTEM_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00117">IRP_MN_KERNEL_CALL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01552">IRP_SYNCHRONOUS_API</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01711">_IRP::UserBuffer</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l07272">IopTrackLink()</a>.
<p>
<pre class="fragment"><div>02727                    :
02728 
02729     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to obtain or set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> <span class="keywordflow">for</span> a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  If
02730     one does not exist <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>, then one <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created, provided that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02731     underlying <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system supports object IDs in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first place (query).
02732 
02733 Arguments:
02734 
02735     FileObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> referenced <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object whose <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02736         to be returned or set.
02737 
02738     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a9">file</a> (query) or that
02739         contains the object ID that is to be set on the file.
02740 
02741     Length - The length of the Buffer.
02742 
02743     Function - The FSCTL to send.
02744         FSCTL_LMR_GET_LINK_TRACKING_INFORMATION;
02745         FSCTL_CREATE_OR_GET_OBJECT_ID;
02746         FSCTL_GET_OBJECT_ID;
02747         FSCTL_SET_OBJECT_ID_EXTENDED;
02748         FSCTL_LMR_SET_LINK_TRACKING_INFORMATION;
02749         FSCTL_SET_OBJECT_ID_EXTENDED;
02750         FSCTL_SET_OBJECT_ID;
02751         FSCTL_DELETE_OBJECT_ID;
02752 
02753 Return Value:
02754 
02755     The status returned is the final completion status of the operation.
02756 
02757 --*/
02758 
02759 {
02760     IO_STATUS_BLOCK ioStatus;
02761     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02762     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
02763     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
02764     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
02765     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
02766 
02767     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02768 
02769     <span class="comment">//</span>
02770     <span class="comment">// Initialize the event structure to synchronize completion of the I/O</span>
02771     <span class="comment">// request.</span>
02772     <span class="comment">//</span>
02773 
02774     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event,
02775                        NotificationEvent,
02776                        FALSE );
02777 
02778     <span class="comment">//</span>
02779     <span class="comment">// Build an I/O Request Packet to be sent to the file system driver to get</span>
02780     <span class="comment">// the object ID.</span>
02781     <span class="comment">//</span>
02782 
02783     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject );
02784 
02785     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a25">IoBuildDeviceIoControlRequest</a>( Function,
02786                                          deviceObject,
02787                                          NULL,
02788                                          0,
02789                                          NULL,
02790                                          0,
02791                                          FALSE,
02792                                          &amp;event,
02793                                          &amp;ioStatus );
02794     <span class="keywordflow">if</span> (!irp) {
02795         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02796     }
02797 
02798     <span class="comment">//</span>
02799     <span class="comment">// Fill in the remainder of the IRP to retrieve the object ID for the</span>
02800     <span class="comment">// file.</span>
02801     <span class="comment">//</span>
02802 
02803     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>;
02804     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o26">UserBuffer</a> = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
02805     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
02806     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = FileObject;
02807 
02808     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
02809     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = FileObject;
02810     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a26">IRP_MJ_FILE_SYSTEM_CONTROL</a>;
02811     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a51">IRP_MN_KERNEL_CALL</a>;
02812 
02813     <span class="keywordflow">if</span> (Function == FSCTL_LMR_GET_LINK_TRACKING_INFORMATION ||
02814         Function == FSCTL_CREATE_OR_GET_OBJECT_ID ||
02815         Function == FSCTL_GET_OBJECT_ID ) {
02816         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.FileSystemControl.OutputBufferLength = Length;
02817     } <span class="keywordflow">else</span> {
02818         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.FileSystemControl.InputBufferLength = Length;
02819     }
02820 
02821     <span class="comment">//</span>
02822     <span class="comment">// Take out another reference to the file object to guarantee that it does</span>
02823     <span class="comment">// not get deleted.</span>
02824     <span class="comment">//</span>
02825 
02826     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( FileObject );
02827 
02828     <span class="comment">//</span>
02829     <span class="comment">// Call the driver to get the request.</span>
02830     <span class="comment">//</span>
02831 
02832     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject, irp );
02833 
02834     <span class="comment">//</span>
02835     <span class="comment">// Synchronize completion of the request.</span>
02836     <span class="comment">//</span>
02837 
02838     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
02839         status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
02840                                         Executive,
02841                                         KernelMode,
02842                                         FALSE,
02843                                         (PLARGE_INTEGER) NULL );
02844         status = ioStatus.Status;
02845     }
02846 
02847     <span class="keywordflow">return</span> status;
02848 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a183" doxytag="iop.h::IopGetSetSecurityObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetSetSecurityObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/se_8h.html#a19">SECURITY_OPERATION_CODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OperationCode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSECURITY_DESCRIPTOR *&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectsSecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/objsup_8c-source.html#l00975">975</a> of file <a class="el" href="../../d4/d0/objsup_8c-source.html">objsup.c</a>.
<p>
References <a class="el" href="../../d0/d5/se_8h.html#a200a111">AssignSecurityDescriptor</a>, <a class="el" href="../../d0/d5/se_8h.html#a200a110">DeleteSecurityDescriptor</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01517">_FILE_OBJECT::DeviceObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01540">_FILE_OBJECT::Event</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01534">_FILE_OBJECT::FileName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01523">_FILE_OBJECT::FinalStatus</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01533">_FILE_OBJECT::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01492">FO_ALERTABLE_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01501">FO_DIRECT_DEVICE_OPEN</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01498">FO_STREAM_FILE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01491">FO_SYNCHRONOUS_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00037">IO_TYPE_DEVICE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00652">IoAllocateIrp()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06786">IoGetAttachedDevice()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00595">IopAcquireFastLock</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00181">IopAcquireFileObjectLock()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00284">IopAllocateIrpCleanup()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00826">IopGetDevicePDO()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01103">IopQueueThreadIrp</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01157">IopReleaseFileObjectLock</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00074">IopSecurityResource</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00877">IopSetDeviceSecurityDescriptors()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12345">IopUpdateOtherOperationCount()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00075">IRP_MJ_QUERY_SECURITY</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00076">IRP_MJ_SET_SECURITY</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01552">IRP_SYNCHRONOUS_API</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o24">_IRP::Overlay</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d0/d5/se_8h.html#a200a109">QuerySecurityDescriptor</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01524">_FILE_OBJECT::RelatedFileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01641">_IRP::RequestorMode</a>, <a class="el" href="../../d2/d4/seassign_8c-source.html#l00529">SeAssignWorldSecurityDescriptor()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01204">_DEVICE_OBJECT::SecurityDescriptor</a>, <a class="el" href="../../d1/d5/semethod_8c-source.html#l00559">SeQuerySecurityDescriptorInfo()</a>, <a class="el" href="../../d0/d5/se_8h.html#a200a108">SetSecurityDescriptor</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01711">_IRP::UserBuffer</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01936">IopCreateObjectTypes()</a>.
<p>
<pre class="fragment"><div>00988                    :
00989 
00990     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to either query or set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor
00991     <span class="keywordflow">for</span> a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>, directory, volume, or device.  It implements these <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a>
00992     by either performing an in-line check <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a device or a
00993     volume, or an I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet (<a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>) is generated and given to the
00994     driver to perform the operation.
00995 
00996 Arguments:
00997 
00998     Object - Pointer to the file or device object representing the open object.
00999 
01000     SecurityInformation - Information about what is being done to or obtained
01001         from the object's security descriptor.
01002 
01003     SecurityDescriptor - Supplies the base security descriptor and returns
01004         the final security descriptor.  Note that if this buffer is coming
01005         from user space, it has already been probed by the object manager
01006         to length "CapturedLength", otherwise it points to kernel space and
01007         should not be probed.  It must, however, be referenced in a try
01008         clause.
01009 
01010     CapturedLength - For a query operation this specifies the size, in
01011         bytes, of the output security descriptor buffer and on return
01012         contains the number of bytes needed to store the complete security
01013         descriptor.  If the length needed is greater than the length
01014         supplied the operation will fail.  This parameter is ignored for
01015         the set and delete operations.  It is expected to point into
01016         system space, ie, it need not be probed and it will not change.
01017 
01018     ObjectsSecurityDescriptor - Supplies and returns the object's security
01019         descriptor.
01020 
01021     PoolType - Specifies from which type of pool memory is to be allocated.
01022 
01023     GenericMapping - Supplies the generic mapping for the object type.
01024 
01025 Return Value:
01026 
01027     The final status of the operation is returned as the function value.
01028 
01029 --*/
01030 
01031 {
01032     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01033     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
01034     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
01035     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> devicePDO = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01036     BOOLEAN synchronousIo;
01037 
01038     UNREFERENCED_PARAMETER( ObjectsSecurityDescriptor );
01039     UNREFERENCED_PARAMETER( PoolType );
01040 
01041     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01042 
01043 
01044     <span class="comment">//</span>
01045     <span class="comment">// Begin by determining whether the security operation is to be performed</span>
01046     <span class="comment">// in this routine or by the driver.  This is based upon whether the</span>
01047     <span class="comment">// object represents a device object, or it represents a file object</span>
01048     <span class="comment">// to a device, or a file on the device. If the open is a direct device</span>
01049     <span class="comment">// open then use the device object.</span>
01050     <span class="comment">//</span>
01051 
01052     <span class="keywordflow">if</span> (((<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) (Object))-&gt;Type == <a class="code" href="../../d0/d5/io_8h.html#a2">IO_TYPE_DEVICE</a>) {
01053         deviceObject = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) Object;
01054         fileObject = (<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01055     } <span class="keywordflow">else</span> {
01056         fileObject = (<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>) Object;
01057         <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a161">FO_DIRECT_DEVICE_OPEN</a>) {
01058             deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a66">IoGetAttachedDevice</a>( fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a> );
01059         }
01060         <span class="keywordflow">else</span> {
01061                 deviceObject = fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a>;
01062         }
01063     }
01064 
01065     <span class="keywordflow">if</span> (!fileObject ||
01066         (!fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.Length &amp;&amp; !fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o9">RelatedFileObject</a>) ||
01067         (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a161">FO_DIRECT_DEVICE_OPEN</a>)) {
01068 
01069         <span class="comment">//</span>
01070         <span class="comment">// This security operation is for the device itself, either through</span>
01071         <span class="comment">// a file object, or directly to the device object.  For the latter</span>
01072         <span class="comment">// case, assignment operations are also possible.  Also note that</span>
01073         <span class="comment">// this may be a stream file object, which do not have security.</span>
01074         <span class="comment">// The security for a stream file is actually represented by the</span>
01075         <span class="comment">// security descriptor on the file itself, or the volume, or the</span>
01076         <span class="comment">// device.</span>
01077         <span class="comment">//</span>
01078 
01079         <span class="keywordflow">if</span> (OperationCode == <a class="code" href="../../d0/d5/se_8h.html#a200a111">AssignSecurityDescriptor</a>) {
01080 
01081             <span class="comment">//</span>
01082             <span class="comment">// Simply assign the security descriptor to the device object,</span>
01083             <span class="comment">// if this is a device object.</span>
01084             <span class="comment">//</span>
01085 
01086             <span class="keywordflow">if</span> (fileObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || !(fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a158">FO_STREAM_FILE</a>)) {
01087                 <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01088                 <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( &amp;IopSecurityResource, TRUE );
01089                 deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o21">SecurityDescriptor</a> = SecurityDescriptor;
01090                 <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( &amp;IopSecurityResource );
01091                 <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01092             }
01093             status = STATUS_SUCCESS;
01094 
01095         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (OperationCode == <a class="code" href="../../d0/d5/se_8h.html#a200a108">SetSecurityDescriptor</a>) {
01096 
01097             <span class="comment">//</span>
01098             <span class="comment">// This is a set operation.  The SecurityInformation parameter</span>
01099             <span class="comment">// determines what part of the SecurityDescriptor is going to</span>
01100             <span class="comment">// be applied to the ObjectsSecurityDescriptor.</span>
01101             <span class="comment">//</span>
01102 
01103             <span class="comment">//</span>
01104             <span class="comment">// if this deviceObject is attached to a PDO then we want</span>
01105             <span class="comment">// to modify the security on the PDO and apply it up the</span>
01106             <span class="comment">// device chain</span>
01107             <span class="comment">//</span>
01108             <span class="keywordflow">if</span> (fileObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || !(fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a161">FO_DIRECT_DEVICE_OPEN</a>)) {
01109                 <span class="comment">//</span>
01110                 <span class="comment">// see if there is a PDO for this object, and obtain it</span>
01111                 <span class="comment">//</span>
01112                 devicePDO = <a class="code" href="../../d3/d1/objsup_8c.html#a4">IopGetDevicePDO</a>(deviceObject);
01113             } <span class="keywordflow">else</span> {
01114                 devicePDO = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01115             }
01116             <span class="keywordflow">if</span> (devicePDO) {
01117                 <span class="comment">//</span>
01118                 <span class="comment">// set PDO and all attached device objects</span>
01119                 <span class="comment">//</span>
01120                 status = <a class="code" href="../../d3/d1/objsup_8c.html#a5">IopSetDeviceSecurityDescriptors</a>(devicePDO,SecurityInformation,SecurityDescriptor,PoolType,GenericMapping,TRUE);
01121                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( devicePDO );
01122             } <span class="keywordflow">else</span> {
01123                 <span class="comment">//</span>
01124                 <span class="comment">// set this device object only</span>
01125                 <span class="comment">//</span>
01126                 status = <a class="code" href="../../d3/d1/objsup_8c.html#a5">IopSetDeviceSecurityDescriptors</a>(deviceObject,SecurityInformation,SecurityDescriptor,PoolType,GenericMapping,FALSE);
01127             }
01128 
01129         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (OperationCode == <a class="code" href="../../d0/d5/se_8h.html#a200a109">QuerySecurityDescriptor</a>) {
01130 
01131             <span class="comment">//</span>
01132             <span class="comment">// This is a get operation.  The SecurityInformation parameter</span>
01133             <span class="comment">// determines what part of the SecurityDescriptor is going to</span>
01134             <span class="comment">// be returned from the ObjectsSecurityDescriptor.</span>
01135             <span class="comment">//</span>
01136 
01137             <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01138             <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( &amp;IopSecurityResource, TRUE );
01139             status = <a class="code" href="../../d0/d6/semethod_8c.html#a6">SeQuerySecurityDescriptorInfo</a>( SecurityInformation,
01140                                                     SecurityDescriptor,
01141                                                     CapturedLength,
01142                                                     &amp;deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o21">SecurityDescriptor</a> );
01143             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( &amp;IopSecurityResource );
01144             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01145 
01146         } <span class="keywordflow">else</span> {
01147 
01148             <span class="comment">//</span>
01149             <span class="comment">// This is a delete operation.  Simply indicate that everything</span>
01150             <span class="comment">// worked just fine.</span>
01151             <span class="comment">//</span>
01152 
01153             status = STATUS_SUCCESS;
01154 
01155         }
01156 
01157     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (OperationCode == <a class="code" href="../../d0/d5/se_8h.html#a200a110">DeleteSecurityDescriptor</a>) {
01158 
01159         <span class="comment">//</span>
01160         <span class="comment">// This is a delete operation for the security descriptor on a file</span>
01161         <span class="comment">// object.  This function will be performed by the file system once</span>
01162         <span class="comment">// the FCB itself is deleted.  Simply indicate that the operation</span>
01163         <span class="comment">// was successful.</span>
01164         <span class="comment">//</span>
01165 
01166         status = STATUS_SUCCESS;
01167 
01168     } <span class="keywordflow">else</span> {
01169 
01170         <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
01171         IO_STATUS_BLOCK localIoStatus;
01172         <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
01173         <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
01174         <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> requestorMode;
01175 
01176         <span class="comment">//</span>
01177         <span class="comment">// This file object does not refer to the device itself.  Rather, it</span>
01178         <span class="comment">// refers to either a file or a directory on the device.  This means</span>
01179         <span class="comment">// that the request must be passed to the file system for processing.</span>
01180         <span class="comment">// Note that the only requests that are passed through in this manner</span>
01181         <span class="comment">// are SET or QUERY security operations.  DELETE operations have</span>
01182         <span class="comment">// already been taken care of above since the file system which just</span>
01183         <span class="comment">// drop the storage on the floor when it really needs to, and ASSIGN</span>
01184         <span class="comment">// operations are irrelevant to file systems since they never</span>
01185         <span class="comment">// generate one because they never assign the security descriptor</span>
01186         <span class="comment">// to the object in the first place, they just assign it to the FCB.</span>
01187         <span class="comment">//</span>
01188 
01189         requestorMode = KeGetPreviousMode();
01190 
01191         <span class="comment">//</span>
01192         <span class="comment">// Begin by referencing the object by pointer.   Note that the object</span>
01193         <span class="comment">// handle has already been checked for the appropriate access by the</span>
01194         <span class="comment">// object system caller.  This reference must be performed because</span>
01195         <span class="comment">// standard I/O completion will dereference the object.</span>
01196         <span class="comment">//</span>
01197 
01198         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( fileObject );
01199 
01200         <span class="comment">//</span>
01201         <span class="comment">// Make a special check here to determine whether this is a synchronous</span>
01202         <span class="comment">// I/O operation.  If it is, then wait here until the file is owned by</span>
01203         <span class="comment">// the current thread.  If this is not a (serialized) synchronous I/O</span>
01204         <span class="comment">// operation, then initialize the local event.</span>
01205         <span class="comment">//</span>
01206 
01207         <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
01208 
01209             BOOLEAN interrupted;
01210 
01211             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a13">IopAcquireFastLock</a>( fileObject )) {
01212                 status = <a class="code" href="../../d0/d6/iop_8h.html#a147">IopAcquireFileObjectLock</a>( fileObject,
01213                                                    requestorMode,
01214                                                    (BOOLEAN) ((fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; FO_ALERTABLE_IO) != 0),
01215                                                    &amp;interrupted );
01216                 <span class="keywordflow">if</span> (interrupted) {
01217                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
01218                     <span class="keywordflow">return</span> status;
01219                 }
01220             }
01221             synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01222         } <span class="keywordflow">else</span> {
01223             <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event, SynchronizationEvent, FALSE );
01224             synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01225         }
01226 
01227         <span class="comment">//</span>
01228         <span class="comment">// Set the file object to the Not-Signaled state.</span>
01229         <span class="comment">//</span>
01230 
01231         <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a> );
01232 
01233         <span class="comment">//</span>
01234         <span class="comment">// Get the address of the target device object.</span>
01235         <span class="comment">//</span>
01236 
01237         deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( fileObject );
01238 
01239         <span class="comment">//</span>
01240         <span class="comment">// Allocate and initialize the I/O Request Packet (IRP) for this</span>
01241         <span class="comment">// operation.  The allocation is performed with an exception handler</span>
01242         <span class="comment">// in case the caller does not have enough quota to allocate the packet.</span>
01243 
01244         irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>( deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>, TRUE );
01245         <span class="keywordflow">if</span> (!irp) {
01246 
01247             <span class="comment">//</span>
01248             <span class="comment">// An IRP could not be allocated.  Cleanup and return an</span>
01249             <span class="comment">// appropriate error status code.</span>
01250             <span class="comment">//</span>
01251 
01252             <a class="code" href="../../d0/d6/iop_8h.html#a148">IopAllocateIrpCleanup</a>( fileObject, (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL );
01253 
01254             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01255         }
01256         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = fileObject;
01257         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01258         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = requestorMode;
01259 
01260         <span class="comment">//</span>
01261         <span class="comment">// Fill in the service independent parameters in the IRP.</span>
01262         <span class="comment">//</span>
01263 
01264         <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
01265             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01266         } <span class="keywordflow">else</span> {
01267             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = &amp;event;
01268             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>;
01269         }
01270         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;localIoStatus;
01271         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine = (PIO_APC_ROUTINE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01272 
01273         <span class="comment">//</span>
01274         <span class="comment">// Get a pointer to the stack location for the first driver.  This will</span>
01275         <span class="comment">// be used to pass the original function codes and parameters.</span>
01276         <span class="comment">//</span>
01277 
01278         irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
01279 
01280         <span class="comment">//</span>
01281         <span class="comment">// Now determine whether this is a set or a query operation.</span>
01282         <span class="comment">//</span>
01283 
01284         <span class="keywordflow">if</span> (OperationCode == <a class="code" href="../../d0/d5/se_8h.html#a200a109">QuerySecurityDescriptor</a>) {
01285 
01286             <span class="comment">//</span>
01287             <span class="comment">// This is a query operation.  Fill in the appropriate fields in</span>
01288             <span class="comment">// the stack location for the packet, as well as the fixed part</span>
01289             <span class="comment">// of the packet.  Note that each of these parameters has been</span>
01290             <span class="comment">// captured as well, so there is no need to perform any probing.</span>
01291             <span class="comment">// The only exception is the UserBuffer memory may change, but</span>
01292             <span class="comment">// that is the file system's responsibility to check.  Note that</span>
01293             <span class="comment">// it has already been probed, so the pointer is at least not</span>
01294             <span class="comment">// in an address space that the caller should not be accessing</span>
01295             <span class="comment">// because of mode.</span>
01296             <span class="comment">//</span>
01297 
01298             irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a33">IRP_MJ_QUERY_SECURITY</a>;
01299             irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QuerySecurity.SecurityInformation = *SecurityInformation;
01300             irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QuerySecurity.Length = *CapturedLength;
01301             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o26">UserBuffer</a> = SecurityDescriptor;
01302 
01303         } <span class="keywordflow">else</span> {
01304 
01305             <span class="comment">//</span>
01306             <span class="comment">// This is a set operation.  Fill in the appropriate fields in</span>
01307             <span class="comment">// the stack location for the packet.  Note that access to the</span>
01308             <span class="comment">// SecurityInformation parameter is safe, as the parameter was</span>
01309             <span class="comment">// captured by the caller.  Likewise, the SecurityDescriptor</span>
01310             <span class="comment">// refers to a captured copy of the descriptor.</span>
01311             <span class="comment">//</span>
01312 
01313             irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a34">IRP_MJ_SET_SECURITY</a>;
01314             irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetSecurity.SecurityInformation = *SecurityInformation;
01315             irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetSecurity.SecurityDescriptor = SecurityDescriptor;
01316 
01317         }
01318 
01319         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = fileObject;
01320 
01321         <span class="comment">//</span>
01322         <span class="comment">// Insert the packet at the head of the IRP list for the thread.</span>
01323         <span class="comment">//</span>
01324 
01325         <a class="code" href="../../d0/d6/iop_8h.html#a21">IopQueueThreadIrp</a>( irp );
01326 
01327         <span class="comment">//</span>
01328         <span class="comment">// Update the operation count statistic for the current process for</span>
01329         <span class="comment">// operations other than read and write.</span>
01330         <span class="comment">//</span>
01331 
01332         <a class="code" href="../../d4/d6/iosubs_8c.html#a129">IopUpdateOtherOperationCount</a>();
01333 
01334         <span class="comment">//</span>
01335         <span class="comment">// Everything has been properly set up, so simply invoke the driver.</span>
01336         <span class="comment">//</span>
01337 
01338         status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject, irp );
01339 
01340         <span class="comment">//</span>
01341         <span class="comment">// If this operation was a synchronous I/O operation, check the return</span>
01342         <span class="comment">// status to determine whether or not to wait on the file object.  If</span>
01343         <span class="comment">// the file object is to be waited on, wait for the operation to be</span>
01344         <span class="comment">// completed and obtain the final status from the file object itself.</span>
01345         <span class="comment">//</span>
01346 
01347         <span class="keywordflow">if</span> (synchronousIo) {
01348             <span class="keywordflow">if</span> (status == STATUS_PENDING) {
01349                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a>,
01350                                               Executive,
01351                                               KernelMode,
01352                                               FALSE,
01353                                               (PLARGE_INTEGER) NULL );
01354                 status = fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o8">FinalStatus</a>;
01355             }
01356             <a class="code" href="../../d0/d6/iop_8h.html#a22">IopReleaseFileObjectLock</a>( fileObject );
01357 
01358         } <span class="keywordflow">else</span> {
01359 
01360             <span class="comment">//</span>
01361             <span class="comment">// This is a normal synchronous I/O operation, as opposed to a</span>
01362             <span class="comment">// serialized synchronous I/O operation.  For this case, wait</span>
01363             <span class="comment">// for the local event and return the final status information</span>
01364             <span class="comment">// back to the caller.</span>
01365             <span class="comment">//</span>
01366 
01367             <span class="keywordflow">if</span> (status == STATUS_PENDING) {
01368                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
01369                                               Executive,
01370                                               KernelMode,
01371                                               FALSE,
01372                                               (PLARGE_INTEGER) NULL );
01373                 status = localIoStatus.Status;
01374             }
01375         }
01376 
01377         <span class="comment">//</span>
01378         <span class="comment">// If this operation was just attempted on a file system or a device</span>
01379         <span class="comment">// driver of some kind that does not implement security, then return</span>
01380         <span class="comment">// a normal null security descriptor.</span>
01381         <span class="comment">//</span>
01382 
01383         <span class="keywordflow">if</span> (status == STATUS_INVALID_DEVICE_REQUEST) {
01384 
01385             <span class="comment">//</span>
01386             <span class="comment">// The file system does not implement a security policy.  Determine</span>
01387             <span class="comment">// what type of operation this was and implement the correct</span>
01388             <span class="comment">// semantics for the file system.</span>
01389             <span class="comment">//</span>
01390 
01391             <span class="keywordflow">if</span> (OperationCode == <a class="code" href="../../d0/d5/se_8h.html#a200a109">QuerySecurityDescriptor</a>) {
01392 
01393                 <span class="comment">//</span>
01394                 <span class="comment">// The operation is a query.  If the caller's buffer is too</span>
01395                 <span class="comment">// small, then indicate that this is the case and let him know</span>
01396                 <span class="comment">// what size buffer is required.  Otherwise, attempt to return</span>
01397                 <span class="comment">// a null security descriptor.</span>
01398                 <span class="comment">//</span>
01399 
01400                <span class="keywordflow">try</span> {
01401                     status = <a class="code" href="../../d1/d5/seassign_8c.html#a5">SeAssignWorldSecurityDescriptor</a>(
01402                                  SecurityDescriptor,
01403                                  CapturedLength,
01404                                  SecurityInformation
01405                                  );
01406 
01407                 } except( EXCEPTION_EXECUTE_HANDLER ) {
01408 
01409                     <span class="comment">//</span>
01410                     <span class="comment">// An exception was incurred while attempting to</span>
01411                     <span class="comment">// access the caller's buffer.  Clean everything</span>
01412                     <span class="comment">// up and return an appropriate status code.</span>
01413                     <span class="comment">//</span>
01414 
01415                     status = GetExceptionCode();
01416                 }
01417 
01418             } <span class="keywordflow">else</span> {
01419 
01420                 <span class="comment">//</span>
01421                 <span class="comment">// This was an operation other than a query.  Simply indicate</span>
01422                 <span class="comment">// that the operation was successful.</span>
01423                 <span class="comment">//</span>
01424 
01425                 status = STATUS_SUCCESS;
01426             }
01427 
01428         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (OperationCode == <a class="code" href="../../d0/d5/se_8h.html#a200a109">QuerySecurityDescriptor</a>) {
01429 
01430             <span class="comment">//</span>
01431             <span class="comment">// The final return status from the file system was something</span>
01432             <span class="comment">// other than invalid device request.  This means that the file</span>
01433             <span class="comment">// system actually implemented the query.  Copy the size of the</span>
01434             <span class="comment">// returned data, or the size of the buffer required in order</span>
01435             <span class="comment">// to query the security descriptor.  Note that once again the</span>
01436             <span class="comment">// assignment is performed inside of an exception handler in case</span>
01437             <span class="comment">// the caller's buffer is inaccessible.  Also note that in order</span>
01438             <span class="comment">// for the Information field of the I/O status block to be set,</span>
01439             <span class="comment">// the file system must return a warning status.  Return the</span>
01440             <span class="comment">// status that the caller expects if the buffer really is too</span>
01441             <span class="comment">// small.</span>
01442             <span class="comment">//</span>
01443 
01444             <span class="keywordflow">if</span> (status == STATUS_BUFFER_OVERFLOW) {
01445                 status = STATUS_BUFFER_TOO_SMALL;
01446             }
01447 
01448             <span class="keywordflow">try</span> {
01449 
01450                 *CapturedLength = (ULONG) localIoStatus.Information;
01451 
01452             } except( EXCEPTION_EXECUTE_HANDLER ) {
01453                 status = GetExceptionCode();
01454             }
01455         }
01456     }
01457 
01458     <span class="keywordflow">return</span> status;
01459 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a184" doxytag="iop.h::IopGetVolumeId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetVolumeId           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PLINK_TRACKING_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l07272">IopTrackLink()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a185" doxytag="iop.h::IopHardErrorThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopHardErrorThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>StartContext</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a186" doxytag="iop.h::IopInitializeResourceMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopInitializeResourceMap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LoaderBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/report_8c-source.html#l00066">66</a> of file <a class="el" href="../../d2/d7/report_8c-source.html">report.c</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00034">_PHYSICAL_MEMORY_RUN::BasePage</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00172">CmRegistryMachineHardwareResourceMapName</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d2/d7/report_8c-source.html#l00760">IopWriteResourceList()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00749">IopWstrPhysicalMemory</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00750">IopWstrSpecialMemory</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00748">IopWstrSystem</a>, <a class="el" href="../../d8/d8/assign_8c-source.html#l00056">IopWstrTranslated</a>, <a class="el" href="../../d1/d9/arc_8h.html#a320a278">LoaderMaximum</a>, <a class="el" href="../../d1/d9/arc_8h.html#a320a276">LoaderSpecialMemory</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00031">MAX_PHYSICAL_MEMORY_FRAGMENTS</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l01582">MmInitializeMemoryLimits()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00048">MmPhysicalMemoryBlock</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00039">_PHYSICAL_MEMORY_DESCRIPTOR::NumberOfRuns</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00035">_PHYSICAL_MEMORY_RUN::PageCount</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00041">_PHYSICAL_MEMORY_DESCRIPTOR::Run</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>.
<p>
<pre class="fragment"><div>00075 {
00076     ULONG i, j, pass, length;
00077     LARGE_INTEGER li;
00078     HANDLE keyHandle;
00079     UNICODE_STRING  unicodeString, systemString, listString;
00080     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00081     PCM_RESOURCE_LIST ResourceList;
00082     PCM_PARTIAL_RESOURCE_DESCRIPTOR CmDescriptor;
00083     BOOLEAN IncludeType[<a class="code" href="../../d1/d9/arc_8h.html#a320a278">LoaderMaximum</a>];
00084     ULONG MemoryAlloc[(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PHYSICAL_MEMORY_DESCRIPTOR</a>) +
00085             <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PHYSICAL_MEMORY_RUN</a>)*<a class="code" href="../../d2/d1/mm_8h.html#a0">MAX_PHYSICAL_MEMORY_FRAGMENTS</a>) /
00086               <span class="keyword">sizeof</span>(ULONG)];
00087     <a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a> MemoryBlock;
00088 
00089     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;systemString,  IopWstrSystem);
00090     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;listString, IopWstrTranslated );
00091 
00092     <span class="keywordflow">for</span> (pass=0; pass &lt; 2; pass++) {
00093         <span class="keywordflow">switch</span> (pass) {
00094             <span class="keywordflow">case</span> 0:
00095                 <span class="comment">//</span>
00096                 <span class="comment">// Add MmPhysicalMemoryBlock to regitry</span>
00097                 <span class="comment">//</span>
00098 
00099                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;unicodeString, IopWstrPhysicalMemory);
00100                 MemoryBlock = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>;
00101                 <span class="keywordflow">break</span>;
00102 
00103             <span class="keywordflow">case</span> 1:
00104 
00105                 <span class="comment">//</span>
00106                 <span class="comment">// Add LoadSpecialMemory to registry</span>
00107                 <span class="comment">//</span>
00108 
00109                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;unicodeString, IopWstrSpecialMemory);
00110 
00111                 <span class="comment">//</span>
00112                 <span class="comment">// Computer memory limits of LoaderSpecialMemory</span>
00113                 <span class="comment">//</span>
00114 
00115                 MemoryBlock = (<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a>)&amp;MemoryAlloc;
00116                 MemoryBlock-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> = <a class="code" href="../../d2/d1/mm_8h.html#a0">MAX_PHYSICAL_MEMORY_FRAGMENTS</a>;
00117 
00118                 <span class="keywordflow">for</span> (j=0; j &lt; <a class="code" href="../../d1/d9/arc_8h.html#a320a278">LoaderMaximum</a>; j++) {
00119                     IncludeType[j] = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00120                 }
00121                 IncludeType[<a class="code" href="../../d1/d9/arc_8h.html#a320a276">LoaderSpecialMemory</a>] = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00122                 <a class="code" href="../../d5/d1/mminit_8c.html#a52">MmInitializeMemoryLimits</a>(
00123                     LoaderBlock,
00124                     IncludeType,
00125                     MemoryBlock
00126                     );
00127 
00128                 <span class="keywordflow">break</span>;
00129         }
00130 
00131         <span class="comment">//</span>
00132         <span class="comment">// Allocate and build a CM_RESOURCE_LIST to describe all</span>
00133         <span class="comment">// of physical memory</span>
00134         <span class="comment">//</span>
00135 
00136         j = MemoryBlock-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>;
00137         <span class="keywordflow">if</span> (j == 0) {
00138             <span class="keywordflow">continue</span>;
00139         }
00140 
00141         length = <span class="keyword">sizeof</span>(CM_RESOURCE_LIST) + (j-1) * <span class="keyword">sizeof</span> (CM_PARTIAL_RESOURCE_DESCRIPTOR);
00142         ResourceList = (PCM_RESOURCE_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (PagedPool, length);
00143         <span class="keywordflow">if</span> (!ResourceList) {
00144             <span class="keywordflow">return</span>;
00145         }
00146         RtlZeroMemory ((PVOID) ResourceList, length);
00147 
00148         ResourceList-&gt;Count = 1;
00149         ResourceList-&gt;List[0].PartialResourceList.Count = j;
00150         CmDescriptor = ResourceList-&gt;List[0].PartialResourceList.PartialDescriptors;
00151 
00152         <span class="keywordflow">for</span> (i=0; i &lt; j; i++) {
00153             CmDescriptor-&gt;Type = CmResourceTypeMemory;
00154             CmDescriptor-&gt;ShareDisposition = CmResourceShareDeviceExclusive;
00155             li.QuadPart = (LONGLONG)(MemoryBlock-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[i].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>);
00156             li.QuadPart &lt;&lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00157             CmDescriptor-&gt;u.Memory.Start  = li;
00158 
00159             <span class="comment">// fixfix - handle page frame numbers greater than 32 bits.</span>
00160 
00161             CmDescriptor-&gt;u.Memory.Length =
00162                 (ULONG)(MemoryBlock-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[i].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a> &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00163 
00164             CmDescriptor++;
00165         }
00166 
00167 
00168         <span class="comment">//</span>
00169         <span class="comment">// Add the resoruce list to the resorucemap</span>
00170         <span class="comment">//</span>
00171 
00172         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>( &amp;keyHandle,
00173                                      (HANDLE) NULL,
00174                                      &amp;CmRegistryMachineHardwareResourceMapName,
00175                                      KEY_READ | KEY_WRITE,
00176                                      TRUE );
00177         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00178             <a class="code" href="../../d1/d8/report_8c.html#a15">IopWriteResourceList</a> ( keyHandle,
00179                                    &amp;systemString,
00180                                    &amp;unicodeString,
00181                                    &amp;listString,
00182                                    ResourceList,
00183                                    length
00184                                    );
00185             ZwClose( keyHandle );
00186         }
00187         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ResourceList);
00188     }
00189 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a187" doxytag="iop.h::IopInsertRemoveDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopInsertRemoveDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Insert</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/iosubs_8c-source.html#l04026">4026</a> of file <a class="el" href="../../d5/d5/iosubs_8c-source.html">iosubs.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01366">_DRIVER_OBJECT::DeviceObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00054">IopDatabaseLock</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01180">_DEVICE_OBJECT::NextDevice</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l04073">IoCreateDevice()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l00657">IopCompleteUnloadOrDelete()</a>.
<p>
<pre class="fragment"><div>04032 {
04033     KIRQL irql;
04034 
04035     ExAcquireSpinLock( &amp;IopDatabaseLock, &amp;irql );
04036     <span class="keywordflow">if</span> (Insert) {
04037         DeviceObject-&gt;NextDevice = DriverObject-&gt;DeviceObject;
04038         DriverObject-&gt;DeviceObject = DeviceObject;
04039         }
04040     <span class="keywordflow">else</span> {
04041         <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *prevPoint;
04042 
04043         prevPoint = &amp;DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o2">DeviceObject</a>;
04044         <span class="keywordflow">while</span> (*prevPoint != DeviceObject) {
04045             prevPoint = &amp;(*prevPoint)-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o4">NextDevice</a>;
04046         }
04047         *prevPoint = DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o4">NextDevice</a>;
04048     }
04049     ExReleaseSpinLock( &amp;IopDatabaseLock, irql );
04050 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a189" doxytag="iop.h::IopInvalidateVolumesForDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopInvalidateVolumesForDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l04710">4710</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01181">_DEVICE_OBJECT::AttachedDevice</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01552">IoBuildDeviceIoControlRequest()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05535">IoCreateStreamFileObjectLite()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00044">IoFileObjectType</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00094">IopCdRomFileSystemQueueHead</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00065">IopDatabaseResource</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00084">IopDiskFileSystemQueueHead</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00114">IopTapeFileSystemQueueHead</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00068">IRP_MJ_FILE_SYSTEM_CONTROL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00367">ObOpenObjectByPointer()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01186">_DEVICE_OBJECT::Vpb</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01518">_FILE_OBJECT::Vpb</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00927">IopRemoveDevice()</a>.
<p>
<pre class="fragment"><div>04716                    :
04717 
04718     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to force filesystems to, as completely as possible, <span class="keywordflow">throw</span>
04719     <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> volumes which remain referenced <span class="keywordflow">for</span> a given device.
04720     
04721 Arguments:
04722 
04723     DeviceObject - Pointer to device object <span class="keywordflow">for</span> which volumes are to be
04724         invalidated.
04725 
04726 Return Value:
04727 
04728     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a successful status code <span class="keywordflow">if</span> all filesystems accepted <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04729     operation.  Otherwise, an error code <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
04730 
04731 --*/
04732 
04733 {
04734     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04735     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> finalStatus;
04736     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
04737     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
04738     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> fsDeviceObject;
04739     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> attachedDevice;
04740     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> storageFileObject;
04741     HANDLE storageHandle;
04742     PLIST_ENTRY entry;
04743     PLIST_ENTRY queueHeader;
04744     IO_STATUS_BLOCK ioStatus;
04745     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
04746 
04747     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04748 
04749     <span class="comment">//</span>
04750     <span class="comment">// Now acquire the resource database lock for the I/O system to perform this</span>
04751     <span class="comment">// operation.  This resource protects access to the file system queue.</span>
04752     <span class="comment">//</span>
04753     
04754     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
04755     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( &amp;IopDatabaseResource, TRUE );
04756 
04757     <span class="comment">//</span>
04758     <span class="comment">// Get the actual device that would be mounted on.  This device is the final</span>
04759     <span class="comment">// device in the list of devices which are attached to the specified real device.</span>
04760     <span class="comment">//</span>
04761 
04762     attachedDevice = DeviceObject;
04763     <span class="keywordflow">while</span> (attachedDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>) {
04764         attachedDevice = attachedDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
04765     }
04766 
04767     <span class="comment">//</span>
04768     <span class="comment">// Get a handle to this device for use in the fsctl.  The way we have to do</span>
04769     <span class="comment">// this is kind of loopy: note we wind up with two references to clean up.</span>
04770     <span class="comment">//</span>
04771     <span class="comment">// The only use of this fileobject/handle is to communicate the device to</span>
04772     <span class="comment">// invalidate volumes on.  It isn't used for anything else, and must not be.</span>
04773     <span class="comment">//</span>
04774 
04775     <span class="keywordflow">try</span> {
04776 
04777         storageFileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04778         storageFileObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a49">IoCreateStreamFileObjectLite</a>( NULL, attachedDevice );
04779         storageFileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o3">Vpb</a> = attachedDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o10">Vpb</a>;
04780         
04781         storageHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04782         status = <a class="code" href="../../d7/d1/obref_8c.html#a3">ObOpenObjectByPointer</a>( storageFileObject,
04783                                         OBJ_KERNEL_HANDLE,
04784                                         NULL,
04785                                         0,
04786                                         IoFileObjectType,
04787                                         KernelMode,
04788                                         &amp;storageHandle );
04789 
04790     } except(EXCEPTION_EXECUTE_HANDLER) {
04791           
04792         status = GetExceptionCode();
04793     }
04794     
04795     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04796         
04797         <span class="comment">//</span>
04798         <span class="comment">// Determine which type of file system should be invoked based on</span>
04799         <span class="comment">// the device type of the device being invalidated.</span>
04800         <span class="comment">//</span>
04801 
04802         <span class="keywordflow">if</span> (DeviceObject-&gt;DeviceType == FILE_DEVICE_DISK ||
04803             DeviceObject-&gt;DeviceType == FILE_DEVICE_VIRTUAL_DISK) {
04804             queueHeader = &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a6">IopDiskFileSystemQueueHead</a>;
04805         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DeviceObject-&gt;DeviceType == FILE_DEVICE_CD_ROM) {
04806             queueHeader = &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a7">IopCdRomFileSystemQueueHead</a>;
04807         } <span class="keywordflow">else</span> {
04808             queueHeader = &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a9">IopTapeFileSystemQueueHead</a>;
04809         }
04810 
04811         <span class="comment">//</span>
04812         <span class="comment">// Initialize the event and set the status to set up</span>
04813         <span class="comment">// for the loop.</span>
04814         <span class="comment">//</span>
04815 
04816         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event, NotificationEvent, FALSE );
04817         finalStatus = STATUS_SUCCESS;
04818 
04819         <span class="comment">//</span>
04820         <span class="comment">// Now loop through each of the file systems which have been loaded in</span>
04821         <span class="comment">// the system and ask them to invalidate volumes they have had mounted</span>
04822         <span class="comment">// on it.</span>
04823         <span class="comment">//</span>
04824 
04825         <span class="keywordflow">for</span> (entry = queueHeader-&gt;Flink;
04826              entry != queueHeader;
04827              entry = entry-&gt;Flink) {
04828 
04829             <span class="comment">//</span>
04830             <span class="comment">// If this is the final entry (Raw file system), then break out of the</span>
04831             <span class="comment">// loop at this point, as volumes cannot be invalidated for the caller's</span>
04832             <span class="comment">// purposes in Raw.</span>
04833             <span class="comment">//</span>
04834 
04835             <span class="keywordflow">if</span> (entry-&gt;Flink == queueHeader) {
04836                 <span class="keywordflow">break</span>;
04837             }
04838 
04839             fsDeviceObject = CONTAINING_RECORD( entry, <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">DEVICE_OBJECT</a>, Queue.ListEntry );
04840 
04841             <span class="comment">//</span>
04842             <span class="comment">// It is possible that the file system has been attached to, so</span>
04843             <span class="comment">// walk the attached list for the file system.</span>
04844             <span class="comment">//</span>
04845 
04846             <span class="keywordflow">while</span> (fsDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>) {
04847                 fsDeviceObject = fsDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
04848             }
04849 
04850             <span class="comment">//</span>
04851             <span class="comment">// Another file system has been found.  Attempt to invalidate volumes</span>
04852             <span class="comment">// using this file system.</span>
04853             <span class="comment">//</span>
04854             <span class="comment">// Begin by resetting the event being used for synchronization with</span>
04855             <span class="comment">// the I/O operation.</span>
04856             <span class="comment">//</span>
04857 
04858             <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( &amp;event );
04859 
04860             <span class="comment">//</span>
04861             <span class="comment">// Build an IRP for this operation.</span>
04862             <span class="comment">//</span>
04863 
04864             irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a25">IoBuildDeviceIoControlRequest</a>( FSCTL_INVALIDATE_VOLUMES,
04865                                                  fsDeviceObject,
04866                                                  &amp;storageHandle,
04867                                                  <span class="keyword">sizeof</span>(HANDLE),
04868                                                  NULL,
04869                                                  0,
04870                                                  FALSE,
04871                                                  &amp;event,
04872                                                  &amp;ioStatus );
04873 
04874             <span class="keywordflow">if</span> (irp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04875 
04876                 finalStatus = STATUS_INSUFFICIENT_RESOURCES;
04877                 <span class="keywordflow">break</span>;
04878             }
04879 
04880             irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
04881             irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a26">IRP_MJ_FILE_SYSTEM_CONTROL</a>;
04882 
04883             status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( fsDeviceObject, irp );
04884 
04885             <span class="comment">//</span>
04886             <span class="comment">// Wait for the I/O operation to complete.</span>
04887             <span class="comment">//</span>
04888 
04889             <span class="keywordflow">if</span> (status == STATUS_PENDING) {
04890                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
04891                                               Executive,
04892                                               KernelMode,
04893                                               FALSE,
04894                                               (PLARGE_INTEGER) NULL );
04895 
04896                 status = ioStatus.Status;
04897 
04898             } <span class="keywordflow">else</span> {
04899                 
04900                 <span class="comment">//</span>
04901                 <span class="comment">// Ensure that the proper status value gets picked up.</span>
04902                 <span class="comment">//</span>
04903 
04904                 ioStatus.Status = status;
04905                 ioStatus.Information = 0;
04906             }
04907 
04908             <span class="comment">//</span>
04909             <span class="comment">// Commute status' indicating the operation is not implemented</span>
04910             <span class="comment">// to success.  If a filesystem does not implement, it must not</span>
04911             <span class="comment">// hold volumes that are not mounted.</span>
04912             <span class="comment">//</span>
04913 
04914             <span class="keywordflow">if</span> (status == STATUS_INVALID_DEVICE_REQUEST ||
04915                 status == STATUS_NOT_IMPLEMENTED) {
04916                 
04917                 status = STATUS_SUCCESS;
04918             }
04919 
04920             <span class="comment">//</span>
04921             <span class="comment">//  Hand back the first failure we get, but plow on anyway.</span>
04922             <span class="comment">//</span>
04923             
04924             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( finalStatus ) &amp;&amp; !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04925                 finalStatus = status;
04926             }
04927         }
04928 
04929         <span class="keywordflow">if</span> (storageFileObject) {
04930             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( storageFileObject );
04931             <span class="keywordflow">if</span> (storageHandle) {
04932                 ZwClose( storageHandle );
04933             }
04934         }
04935 
04936         status = finalStatus;
04937     }
04938 
04939     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( &amp;IopDatabaseResource );
04940     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
04941 
04942     <span class="keywordflow">return</span> status;
04943 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a188" doxytag="iop.h::IopInvalidDeviceRequest" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopInvalidDeviceRequest           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l03087">3087</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00056">IO_NO_INCREMENT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02960">IoCompleteRequest</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00077">IRP_MJ_POWER</a>, and <a class="el" href="../../d1/d2/po_8h.html#a79">PoStartNextPowerIrp()</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01071">IoCreateDriver()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>, and <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l00433">IovpAssertIrpStackDownward()</a>.
<p>
<pre class="fragment"><div>03094                    :
03095 
03096     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">default</span> dispatch routine <span class="keywordflow">for</span> all driver entries
03097     not implemented by drivers that have been loaded into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system.  Its
03098     responsibility <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> simply to set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> packet to indicate
03099     that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation requested <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invalid <span class="keywordflow">for</span> <span class="keyword">this</span> device <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>, and then
03100     complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> packet.
03101 
03102 Arguments:
03103 
03104     DeviceObject - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object <span class="keywordflow">for</span> which <span class="keyword">this</span> request <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
03105         bound.  Ignored by <span class="keyword">this</span> routine.
03106 
03107     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet (<a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>) for this
03108         request.
03109 
03110 Return Value:
03111 
03112     The final status is always STATUS_INVALID_DEVICE_REQUEST.
03113 
03114 
03115 --*/
03116 
03117 {
03118     UNREFERENCED_PARAMETER( DeviceObject );
03119 
03120     <span class="comment">//</span>
03121     <span class="comment">// Simply store the appropriate status, complete the request, and return</span>
03122     <span class="comment">// the same status stored in the packet.</span>
03123     <span class="comment">//</span>
03124 
03125     <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>(Irp))-&gt;MajorFunction == <a class="code" href="../../d0/d5/io_8h.html#a35">IRP_MJ_POWER</a>) {
03126         <a class="code" href="../../d1/d2/po_8h.html#a79">PoStartNextPowerIrp</a>(Irp);
03127     }
03128     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = STATUS_INVALID_DEVICE_REQUEST;
03129     <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>( Irp, IO_NO_INCREMENT );
03130     <span class="keywordflow">return</span> STATUS_INVALID_DEVICE_REQUEST;
03131 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a221" doxytag="iop.h::IopIsRemoteBootCard" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopIsRemoteBootCard           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LoaderBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>HwIds</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/netboot_8c-source.html#l01903">1903</a> of file <a class="el" href="../../d5/d5/netboot_8c-source.html">netboot.c</a>.
<p>
References <a class="el" href="../../d3/d6/hal_8h-source.html#l01170">BusNumber</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00465">_SETUP_LOADER_BLOCK::NetbootCardHardwareId</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00504">_SETUP_LOADER_BLOCK::NetbootCardInfo</a>, <a class="el" href="../../d3/d8/setupblk_8h.html#a42">PSETUP_LOADER_BLOCK</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>.
<p>
<pre class="fragment"><div>01911                    :
01912 
01913     This function determines <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> card described by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hwIds <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01914     remote boot network card. It checks against <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hardware <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01915     card that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> setup loader block.
01916 
01917     THIS ASSUMES THAT IOREMOTEBOOTCLIENT IS <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> AND THAT LOADERBLOCK
01918     IS VALID.
01919 
01920 Arguments:
01921 
01922     DeviceNode - Device node <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> card in question.
01923 
01924     LoaderBlock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader parameter block that was
01925         created by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> OS Loader.
01926 
01927     HwIds - The hardware IDs <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device in question.
01928 
01929 Return Value:
01930 
01931     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> or <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
01932 
01933 --*/
01934 
01935 {
01936     <a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html">PSETUP_LOADER_BLOCK</a> setupLoaderBlock;
01937     PWCHAR curHwId;
01938 
01939     <span class="comment">//</span>
01940     <span class="comment">// setupLoaderBlock will always be non-NULL if we are</span>
01941     <span class="comment">// remote booting, even if we are not in setup.</span>
01942     <span class="comment">//</span>
01943 
01944     setupLoaderBlock = LoaderBlock-&gt;SetupLoaderBlock;
01945 
01946     <span class="comment">//</span>
01947     <span class="comment">// Scan through the HwIds for a match.</span>
01948     <span class="comment">//</span>
01949 
01950     curHwId = HwIds;
01951 
01952     <span class="keywordflow">while</span> (*curHwId != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>) {
01953         <span class="keywordflow">if</span> (wcscmp(curHwId, setupLoaderBlock-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o26">NetbootCardHardwareId</a>) == 0) {
01954 
01955             ULONG <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>, SlotNumber;
01956 
01957             <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> = (ULONG)((((PNET_CARD_INFO)setupLoaderBlock-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o31">NetbootCardInfo</a>)-&gt;pci.BusDevFunc) &gt;&gt; 8);
01958             SlotNumber = (ULONG)(((((PNET_CARD_INFO)setupLoaderBlock-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o31">NetbootCardInfo</a>)-&gt;pci.BusDevFunc) &amp; 0xf8) &gt;&gt; 3);
01959             
01960             KdPrint((<span class="stringliteral">"IopIsRemoteBootCard: FOUND %ws\n"</span>, setupLoaderBlock-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o26">NetbootCardHardwareId</a>));
01961             <span class="keywordflow">if</span> ((DeviceNode-&gt;ResourceRequirements-&gt;BusNumber != <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>) ||
01962                 (DeviceNode-&gt;ResourceRequirements-&gt;SlotNumber != SlotNumber)) {
01963                 KdPrint((<span class="stringliteral">"IopIsRemoteBootCard: ignoring non-matching card:\n"</span>));
01964                 KdPrint((<span class="stringliteral">"  devnode bus %d, busdevfunc bus %d\n"</span>,
01965                     DeviceNode-&gt;ResourceRequirements-&gt;BusNumber,
01966                     BusNumber));
01967                 KdPrint((<span class="stringliteral">"  devnode slot %d, busdevfunc slot %d\n"</span>,
01968                     DeviceNode-&gt;ResourceRequirements-&gt;SlotNumber,
01969                     SlotNumber));
01970                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01971             } <span class="keywordflow">else</span> {
01972                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01973             }
01974         }
01975         curHwId += (wcslen(curHwId) + 1);
01976     }
01977 
01978     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01979 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a190" doxytag="iop.h::IopIsSameMachine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopIsSameMachine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceFile</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetFile</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l03134">3134</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00952">_FAST_IO_DISPATCH::FastIoDeviceControl</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01403">_DRIVER_OBJECT::FastIoDispatch</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l07272">IopTrackLink()</a>.
<p>
<pre class="fragment"><div>03141                    :
03142 
03143     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to determine whether two <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> objects that represent
03144     files on remote machines actually reside on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same physical system.
03145 
03146 Arguments:
03147 
03148     SourceFile - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
03149 
03150     TargetFile - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
03151 
03152 Return Value:
03153 
03154     The <span class="keyword">final</span> function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> files reside on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same machine,
03155     otherwise <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
03156 
03157 --*/
03158 
03159 {
03160     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
03161     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> fastIoDispatch;
03162     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_NOT_SAME_DEVICE;
03163     IO_STATUS_BLOCK ioStatus;
03164     HANDLE target = TargetFile;
03165 
03166     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03167 
03168     <span class="comment">//</span>
03169     <span class="comment">// Simply invoke the device I/O control function to determine whether or</span>
03170     <span class="comment">// not the two files are on the same server.  If the fast I/O path does</span>
03171     <span class="comment">// not exist, or the function fails for any reason, then the two files are</span>
03172     <span class="comment">// assumed to not be on the same machine.  Note that this simply means</span>
03173     <span class="comment">// that there will be a performance penalty on open of the target, but</span>
03174     <span class="comment">// the above will only fail if the two files really aren't on the same</span>
03175     <span class="comment">// machine in the first place, or if there's a filter that doesn't under-</span>
03176     <span class="comment">// stand what is being done here.</span>
03177     <span class="comment">//</span>
03178 
03179     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( SourceFile );
03180 
03181     fastIoDispatch = deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
03182     <span class="keywordflow">if</span> (fastIoDispatch &amp;&amp; fastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o10">FastIoDeviceControl</a>) {
03183         <span class="keywordflow">if</span> (fastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o10">FastIoDeviceControl</a>( SourceFile,
03184                                                  TRUE,
03185                                                  (PVOID) &amp;target,
03186                                                  <span class="keyword">sizeof</span>( target ),
03187                                                  (PVOID) NULL,
03188                                                  0,
03189                                                  IOCTL_LMR_ARE_FILE_OBJECTS_ON_SAME_SERVER,
03190                                                  &amp;ioStatus,
03191                                                  deviceObject )) {
03192             status = ioStatus.Status;
03193         }
03194     }
03195 
03196     <span class="keywordflow">return</span> status == STATUS_SUCCESS;
03197 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a191" doxytag="iop.h::IopLoadDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopLoadDriver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CheckForSafeBoot</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">3200</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03778">CmBootLastKnownGood()</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00170">CmRegistryMachineHardwareDescriptionSystemName</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d0/d5/io_8h.html#a343">DRIVER_EXTENSION</a>, <a class="el" href="../../d0/d5/io_8h.html#a345">DRIVER_OBJECT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01300">DRVO_LEGACY_DRIVER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01303">DRVO_REINIT_REGISTERED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01299">DRVO_UNLOAD_INVOKED</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00044">InitSafeBootMode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00038">IO_TYPE_DRIVER</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00236">IoDriverObjectType</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l09046">IopBootLog()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l05338">IopDeleteLegacyKey()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l02609">IopDriverLoadingFailed()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02072">IopGetDriverNameFromKeyNode()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03087">IopInvalidDeviceRequest()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03071">IopIsAnyDeviceInstanceEnabled()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l05177">IopIsLegacyDriver()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00753">IopPrepareDriverLoading()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05910">IopReadyDeviceObjects()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05951">IopResurrectDriver()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08822">IopSafebootDriverLoad()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01740">IopStartDriverDevices()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00084">IRP_MJ_MAXIMUM_FUNCTION</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02106">MmFreeDriverInitialization()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00315">MmLoadSystemImage()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">MmUnloadSystemImage()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02018">NtQueryKey()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00058">NtQueryObject()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00484">ObMakeTemporaryObject()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d5/io_8h.html#a344">PDRIVER_EXTENSION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00522">PDRIVER_INITIALIZE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02166">PERFINFO_DRIVER_INIT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02167">PERFINFO_DRIVER_INIT_COMPLETE</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00110">PnPInitialized</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00582">PsLoadedModuleList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00583">PsLoadedModuleResource</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01883">RtlAppendUnicodeStringToString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01821">RtlAppendUnicodeToString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00399">RtlEqualString()</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03165">IopCallDriverAddDeviceQueryRoutine()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03146">IopInitializeSystemDrivers()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l04169">IopLoadUnloadDriver()</a>.
<p>
<pre class="fragment"><div>03207                    :
03208 
03209     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to load a device or <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system driver, either
03210     during system initialization, or dynamically <span class="keywordflow">while</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> running.
03211 
03212 Arguments:
03213 
03214     KeyHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver service node in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry
03215         that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver to be loaded.
03216 
03217 Return Value:
03218 
03219     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> load operation.
03220 
03221 Notes:
03222 
03223     Note that <span class="keyword">this</span> routine closes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KeyHandle before returning.
03224 
03225 
03226 --*/
03227 
03228 {
03229     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03230     PLIST_ENTRY nextEntry;
03231     PLDR_DATA_TABLE_ENTRY driverEntry;
03232     PKEY_BASIC_INFORMATION keyBasicInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03233     PKEY_VALUE_FULL_INFORMATION keyValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03234     ULONG keyBasicLength;
03235     UNICODE_STRING baseName;
03236     UNICODE_STRING serviceName = {0, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>};
03237     OBJECT_ATTRIBUTES objectAttributes;
03238     PVOID sectionPointer;
03239     UNICODE_STRING driverName;
03240     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
03241     PIMAGE_NT_HEADERS ntHeaders;
03242     PVOID imageBaseAddress;
03243     ULONG_PTR entryPoint;
03244     HANDLE driverHandle;
03245     ULONG i;
03246     POBJECT_NAME_INFORMATION registryPath;
03247 <span class="preprocessor">#if DBG</span>
03248 <span class="preprocessor"></span>    LARGE_INTEGER stime, etime;
03249     ULONG dtime;
03250 <span class="preprocessor">#endif</span>
03251 <span class="preprocessor"></span>
03252     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03253 
03254     driverName.Buffer = (PWSTR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03255 
03256     <span class="comment">//</span>
03257     <span class="comment">// Begin by formulating the name of the driver image file to be loaded.</span>
03258     <span class="comment">// Note that this is used to determine whether or not the driver has</span>
03259     <span class="comment">// already been loaded by the OS loader, not necessarily in actually</span>
03260     <span class="comment">// loading the driver image, since the node can override that name.</span>
03261     <span class="comment">//</span>
03262 
03263     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a24">NtQueryKey</a>( KeyHandle,
03264                          KeyBasicInformation,
03265                          (PVOID) NULL,
03266                          0,
03267                          &amp;keyBasicLength );
03268     <span class="keywordflow">if</span> (status != STATUS_BUFFER_OVERFLOW &amp;&amp;
03269         status != STATUS_BUFFER_TOO_SMALL) {
03270         status = STATUS_ILL_FORMED_SERVICE_ENTRY;
03271         <span class="keywordflow">goto</span> IopLoadExit;
03272     }
03273 
03274     keyBasicInformation = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool,
03275                                           keyBasicLength + (4 * 2) );
03276     <span class="keywordflow">if</span> (!keyBasicInformation) {
03277         status = STATUS_INSUFFICIENT_RESOURCES;
03278         <span class="keywordflow">goto</span> IopLoadExit;
03279     }
03280 
03281     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a24">NtQueryKey</a>( KeyHandle,
03282                          KeyBasicInformation,
03283                          keyBasicInformation,
03284                          keyBasicLength,
03285                          &amp;keyBasicLength );
03286     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03287         <span class="keywordflow">goto</span> IopLoadExit;
03288     }
03289 
03290     <span class="comment">//</span>
03291     <span class="comment">// Create a Unicode string descriptor which forms the name of the</span>
03292     <span class="comment">// driver.</span>
03293     <span class="comment">//</span>
03294 
03295     baseName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) keyBasicInformation-&gt;NameLength;
03296     baseName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (baseName.Length + (4 * 2));
03297     baseName.Buffer = &amp;keyBasicInformation-&gt;Name[0];
03298 <span class="comment">//#if _PNP_POWER_</span>
03299     serviceName.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, baseName.Length + <span class="keyword">sizeof</span>(UNICODE_NULL));
03300     <span class="keywordflow">if</span> (serviceName.Buffer) {
03301         serviceName.Length = baseName.Length;
03302         serviceName.MaximumLength = serviceName.Length + <span class="keyword">sizeof</span>(UNICODE_NULL);
03303         RtlMoveMemory(serviceName.Buffer, baseName.Buffer, baseName.Length);
03304         serviceName.Buffer[serviceName.Length / <span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
03305     }
03306 <span class="preprocessor">#if DBG</span>
03307 <span class="preprocessor"></span>      <span class="keywordflow">else</span> {
03308         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopLoadDriver: No memory available for Service Keyname\n"</span>);
03309     }
03310 <span class="preprocessor">#endif</span>
03311 <span class="preprocessor"></span><span class="comment">//#endif</span>
03312     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( &amp;baseName, L<span class="stringliteral">".SYS"</span> );
03313 
03314     <span class="keywordflow">if</span> (CheckForSafeBoot &amp;&amp; <a class="code" href="../../d8/d1/init_8h.html#a18">InitSafeBootMode</a>) {
03315 
03316         BOOLEAN GroupIsGood = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03317         UNICODE_STRING string;
03318         PKEY_VALUE_PARTIAL_INFORMATION keyValue;
03319         UCHAR nameBuffer[FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION, Data) + 64];
03320         ULONG length;
03321 
03322         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"Group"</span> );
03323         keyValue = (PKEY_VALUE_PARTIAL_INFORMATION)nameBuffer;
03324         RtlZeroMemory(nameBuffer, <span class="keyword">sizeof</span>(nameBuffer));
03325 
03326         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
03327             KeyHandle,
03328             &amp;string,
03329             KeyValuePartialInformation,
03330             keyValue,
03331             <span class="keyword">sizeof</span>(nameBuffer),
03332             &amp;length
03333             );
03334         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03335 
03336             string.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(keyValue-&gt;DataLength - <span class="keyword">sizeof</span>(WCHAR));
03337             string.MaximumLength = string.Length;
03338             string.Buffer = (PWSTR)keyValue-&gt;Data;
03339 
03340             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a223">IopSafebootDriverLoad</a>(&amp;string)) {
03341                 GroupIsGood = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03342             }
03343         }
03344 
03345         <span class="keywordflow">if</span> (!GroupIsGood &amp;&amp; !<a class="code" href="../../d0/d6/iop_8h.html#a223">IopSafebootDriverLoad</a>(&amp;baseName)) {
03346             <span class="comment">//</span>
03347             <span class="comment">// don't load the driver</span>
03348             <span class="comment">//</span>
03349 
03350             <a class="code" href="../../d2/d4/internal_8c.html#a75">IopBootLog</a>(&amp;baseName, FALSE);
03351 
03352             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"SAFEBOOT: skipping device = %wZ(%wZ)\n"</span>,&amp;baseName,&amp;string);
03353             <span class="keywordflow">return</span> STATUS_SUCCESS;
03354         }
03355 
03356     }
03357 
03358     <span class="comment">//</span>
03359     <span class="comment">// See if this driver has already been loaded by the boot loader.</span>
03360     <span class="comment">//</span>
03361 
03362     <span class="comment">//KeEnterCriticalRegion();</span>
03363     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( &amp;PsLoadedModuleResource, TRUE );
03364     nextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
03365     <span class="keywordflow">while</span> (nextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
03366 
03367         <span class="comment">//</span>
03368         <span class="comment">// Look at the next boot driver in the list.</span>
03369         <span class="comment">//</span>
03370 
03371         driverEntry = CONTAINING_RECORD( nextEntry,
03372                                          LDR_DATA_TABLE_ENTRY,
03373                                          InLoadOrderLinks );
03374 
03375         <span class="comment">//</span>
03376         <span class="comment">// If this is not the kernel image (ntoskrnl) and not the HAL (hal),</span>
03377         <span class="comment">// then this is a driver, so initialize it.</span>
03378         <span class="comment">//</span>
03379 
03380         <span class="keywordflow">if</span> ((driverEntry-&gt;Flags &amp; LDRP_ENTRY_PROCESSED) &amp;&amp;
03381             <a class="code" href="../../d2/d7/string_8c.html#a11">RtlEqualString</a>( (PSTRING) &amp;baseName,
03382                             (PSTRING) &amp;driverEntry-&gt;FullDllName,
03383                             TRUE )) {
03384             status = STATUS_IMAGE_ALREADY_LOADED;
03385             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( &amp;PsLoadedModuleResource );
03386             <span class="comment">//KeLeaveCriticalRegion();</span>
03387 
03388             <a class="code" href="../../d2/d4/internal_8c.html#a75">IopBootLog</a>(&amp;baseName, TRUE);
03389 
03390             <span class="keywordflow">goto</span> IopLoadExit;
03391         }
03392 
03393         nextEntry = nextEntry-&gt;Flink;
03394     }
03395     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( &amp;PsLoadedModuleResource );
03396     <span class="comment">//KeLeaveCriticalRegion();</span>
03397 
03398     <span class="comment">//</span>
03399     <span class="comment">// This driver has not already been loaded by the OS loader.  Form the</span>
03400     <span class="comment">// full path name for this driver.  Begin by attempting to determine</span>
03401     <span class="comment">// whether or not the file has an image path.  If so, then use that,</span>
03402     <span class="comment">// otherwise, form one from the above driver name by putting the</span>
03403     <span class="comment">// appropriate path name in front of it.</span>
03404     <span class="comment">//</span>
03405 
03406     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( KeyHandle,
03407                                   L<span class="stringliteral">"ImagePath"</span>,
03408                                   &amp;keyValueInformation );
03409 
03410     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) &amp;&amp; keyValueInformation-&gt;DataLength) {
03411 
03412         <span class="comment">//</span>
03413         <span class="comment">// The driver service node contained an image path name from which</span>
03414         <span class="comment">// the driver is to be loaded.</span>
03415         <span class="comment">//</span>
03416 
03417         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyBasicInformation );
03418         keyBasicInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03419         baseName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) keyValueInformation-&gt;DataLength;
03420         <span class="keywordflow">if</span> (baseName.Length &gt; 0) {
03421             baseName.Length -= <span class="keyword">sizeof</span>( WCHAR );
03422         }
03423         baseName.MaximumLength = baseName.Length;
03424         baseName.Buffer = (PWSTR) ((PUCHAR) keyValueInformation + keyValueInformation-&gt;DataOffset);
03425 
03426         <span class="keywordflow">if</span> (baseName.Buffer[0] != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>) {
03427 
03428             UNICODE_STRING prefixName;
03429             UNICODE_STRING tmpName;
03430             PWCHAR fileName;
03431 
03432             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;prefixName, L<span class="stringliteral">"\\SystemRoot\\"</span> );
03433             fileName = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool,
03434                                        prefixName.Length + baseName.Length );
03435             <span class="keywordflow">if</span> (!fileName) {
03436                 status = STATUS_INSUFFICIENT_RESOURCES;
03437                 <span class="keywordflow">goto</span> IopLoadExit;
03438             }
03439 
03440             tmpName.Length = baseName.Length;
03441             tmpName.Buffer = baseName.Buffer;
03442             baseName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (prefixName.Length + baseName.Length);
03443             baseName.Length = 0;
03444             baseName.Buffer = fileName;
03445 
03446             <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>( &amp;baseName, &amp;prefixName );
03447             <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>( &amp;baseName, &amp;tmpName );
03448 
03449             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
03450             keyValueInformation = (PKEY_VALUE_FULL_INFORMATION) fileName;
03451         }
03452 
03453     } <span class="keywordflow">else</span> {
03454 
03455         UNICODE_STRING prefixName;
03456         UNICODE_STRING fileName;
03457 
03458         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;prefixName, L<span class="stringliteral">"\\SystemRoot\\System32\\Drivers\\"</span> );
03459 
03460         <span class="comment">//</span>
03461         <span class="comment">// Ensure that the driver entry did not actually contain an image path</span>
03462         <span class="comment">// name, and if it did, free the appropriate pool because it was a key</span>
03463         <span class="comment">// without a value.</span>
03464         <span class="comment">//</span>
03465 
03466         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03467             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
03468         }
03469 
03470         <span class="comment">//</span>
03471         <span class="comment">// The driver entry did not contain an image path name, so the above</span>
03472         <span class="comment">// default name for the driver image is name of the file.  Form a</span>
03473         <span class="comment">// fully qualified path to get to the image file.</span>
03474         <span class="comment">//</span>
03475 
03476         keyValueInformation = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool,
03477                                               baseName.MaximumLength +
03478                                               prefixName.Length );
03479         <span class="keywordflow">if</span> (!keyValueInformation) {
03480             status = STATUS_INSUFFICIENT_RESOURCES;
03481             <span class="keywordflow">goto</span> IopLoadExit;
03482         }
03483 
03484         fileName.Length = baseName.Length;
03485         fileName.MaximumLength = baseName.MaximumLength;
03486         fileName.Buffer = baseName.Buffer;
03487 
03488         baseName.Length = 0;
03489         baseName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (fileName.Length + prefixName.Length);
03490         baseName.Buffer = (PWSTR) keyValueInformation;
03491 
03492         <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>( &amp;baseName, &amp;prefixName );
03493         <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>( &amp;baseName, &amp;fileName );
03494 
03495         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyBasicInformation );
03496         keyBasicInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03497     }
03498 
03499     <span class="comment">//</span>
03500     <span class="comment">// Now get the name of the driver object.</span>
03501     <span class="comment">//</span>
03502 
03503     status = <a class="code" href="../../d0/d6/iop_8h.html#a175">IopGetDriverNameFromKeyNode</a>( KeyHandle,
03504                                           &amp;driverName );
03505     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03506         <span class="keywordflow">goto</span> IopLoadExit;
03507     }
03508 
03509     InitializeObjectAttributes( &amp;objectAttributes,
03510                                 &amp;driverName,
03511                                 OBJ_PERMANENT,
03512                                 (HANDLE) NULL,
03513                                 (PSECURITY_DESCRIPTOR) NULL );
03514 
03515     <span class="comment">//</span>
03516     <span class="comment">// Load the driver image into memory.  If this fails partway through</span>
03517     <span class="comment">// the operation, then it will automatically be unloaded.</span>
03518     <span class="comment">//</span>
03519 
03520     status = <a class="code" href="../../d8/d8/sysload_8c.html#a53">MmLoadSystemImage</a>( &amp;baseName,
03521                                 NULL,
03522                                 NULL,
03523                                 FALSE,
03524                                 &amp;sectionPointer,
03525                                 (PVOID *) &amp;imageBaseAddress );
03526 
03527     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03528 
03529         <span class="comment">//</span>
03530         <span class="comment">// If the image was not already loaded then exit.</span>
03531         <span class="comment">//</span>
03532 
03533         <span class="keywordflow">if</span> (status != STATUS_IMAGE_ALREADY_LOADED) {
03534 
03535             <a class="code" href="../../d2/d4/internal_8c.html#a75">IopBootLog</a>(&amp;baseName, FALSE);
03536 
03537             <span class="keywordflow">goto</span> IopLoadExit;
03538         }
03539 
03540         <span class="comment">//</span>
03541         <span class="comment">// Open the driver object.</span>
03542         <span class="comment">//</span>
03543 
03544         status = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>( &amp;objectAttributes,
03545                                      IoDriverObjectType,
03546                                      KernelMode,
03547                                      NULL,
03548                                      0,
03549                                      NULL,
03550                                      &amp;driverHandle );
03551 
03552 
03553         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03554 
03555             <a class="code" href="../../d2/d4/internal_8c.html#a75">IopBootLog</a>(&amp;baseName, FALSE);
03556 
03557             <span class="keywordflow">goto</span> IopLoadExit;
03558         }
03559 
03560         <span class="comment">//</span>
03561         <span class="comment">// Reference the handle and obtain a pointer to the driver object so that</span>
03562         <span class="comment">// the handle can be deleted without the object going away.</span>
03563         <span class="comment">//</span>
03564 
03565         status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( driverHandle,
03566                                             0,
03567                                             IoDriverObjectType,
03568                                             KeGetPreviousMode(),
03569                                             (PVOID *) &amp;driverObject,
03570                                             (<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">POBJECT_HANDLE_INFORMATION</a>) NULL );
03571 
03572         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( driverHandle );
03573 
03574         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03575             <a class="code" href="../../d2/d4/internal_8c.html#a75">IopBootLog</a>(&amp;baseName, FALSE);
03576             <span class="keywordflow">goto</span> IopLoadExit;
03577         }
03578 
03579         status = <a class="code" href="../../d2/d4/internal_8c.html#a13">IopResurrectDriver</a>( driverObject );
03580 
03581         <span class="comment">//</span>
03582         <span class="comment">// Regardless of the status the driver object should be dereferenced.</span>
03583         <span class="comment">// if the unload has already run then driver is almost gone. If</span>
03584         <span class="comment">// the driver has been resurrected then the I/O system still has its</span>
03585         <span class="comment">// original reference.</span>
03586         <span class="comment">//</span>
03587 
03588         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( driverObject );
03589         <a class="code" href="../../d2/d4/internal_8c.html#a75">IopBootLog</a>(&amp;baseName, FALSE);
03590         <span class="keywordflow">goto</span> IopLoadExit;
03591     } <span class="keywordflow">else</span> {
03592 
03593         ntHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>( imageBaseAddress );
03594 
03595         <span class="comment">//</span>
03596         <span class="comment">// Check should this driver be loaded.  If yes, the enum subkey</span>
03597         <span class="comment">// of the service will be prepared.</span>
03598         <span class="comment">//</span>
03599 
03600         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a5">IopPrepareDriverLoading</a> (&amp;serviceName, KeyHandle, ntHeaders);
03601         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03602             <a class="code" href="../../d8/d8/sysload_8c.html#a59">MmUnloadSystemImage</a>(sectionPointer);
03603             <a class="code" href="../../d2/d4/internal_8c.html#a75">IopBootLog</a>(&amp;baseName, FALSE);
03604             <span class="keywordflow">goto</span> IopLoadExit;
03605         }
03606 
03607     }
03608 
03609     <span class="comment">//</span>
03610     <span class="comment">// The driver image has now been loaded into memory.  Create the driver</span>
03611     <span class="comment">// object that represents this image.</span>
03612     <span class="comment">//</span>
03613 
03614     status = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>( KeGetPreviousMode(),
03615                              IoDriverObjectType,
03616                              &amp;objectAttributes,
03617                              KernelMode,
03618                              (PVOID) NULL,
03619                              (ULONG) (<span class="keyword">sizeof</span>( <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">DRIVER_OBJECT</a> ) + <span class="keyword">sizeof</span> ( <a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html">DRIVER_EXTENSION</a> )),
03620                              0,
03621                              0,
03622                              (PVOID *) &amp;driverObject );
03623 
03624     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03625         <a class="code" href="../../d2/d4/internal_8c.html#a75">IopBootLog</a>(&amp;baseName, FALSE);
03626         <span class="keywordflow">goto</span> IopLoadExit;
03627     }
03628 
03629     <span class="comment">//</span>
03630     <span class="comment">// Initialize this driver object and insert it into the object table.</span>
03631     <span class="comment">//</span>
03632 
03633     RtlZeroMemory( driverObject, <span class="keyword">sizeof</span>( DRIVER_OBJECT ) + <span class="keyword">sizeof</span> ( DRIVER_EXTENSION) );
03634     driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a> = (<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html">PDRIVER_EXTENSION</a>) (driverObject + 1);
03635     driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o0">DriverObject</a> = driverObject;
03636 
03637     <span class="keywordflow">for</span> (i = 0; i &lt;= <a class="code" href="../../d0/d5/io_8h.html#a42">IRP_MJ_MAXIMUM_FUNCTION</a>; i++) {
03638         driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o14">MajorFunction</a>[i] = <a class="code" href="../../d2/d4/internal_8c.html#a45">IopInvalidDeviceRequest</a>;
03639     }
03640 
03641     driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o0">Type</a> = <a class="code" href="../../d0/d5/io_8h.html#a3">IO_TYPE_DRIVER</a>;
03642     driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o1">Size</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d5/io_8h.html#a345">DRIVER_OBJECT</a> );
03643     ntHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>( imageBaseAddress );
03644     entryPoint = ntHeaders-&gt;OptionalHeader.AddressOfEntryPoint;
03645     entryPoint += (ULONG_PTR) imageBaseAddress;
03646     <span class="keywordflow">if</span> (!(ntHeaders-&gt;OptionalHeader.DllCharacteristics &amp; IMAGE_DLLCHARACTERISTICS_WDM_DRIVER)) {
03647         driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a144">DRVO_LEGACY_DRIVER</a>;
03648     }
03649     driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o11">DriverInit</a> = (<a class="code" href="../../d0/d5/io_8h.html#a284">PDRIVER_INITIALIZE</a>) entryPoint;
03650     driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o6">DriverSection</a> = sectionPointer;
03651     driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o4">DriverStart</a> = imageBaseAddress;
03652     driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o5">DriverSize</a> = ntHeaders-&gt;OptionalHeader.SizeOfImage;
03653 
03654     status = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>( driverObject,
03655                              (<a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>) NULL,
03656                              FILE_READ_DATA,
03657                              0,
03658                              (PVOID *) NULL,
03659                              &amp;driverHandle );
03660     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03661         <a class="code" href="../../d2/d4/internal_8c.html#a75">IopBootLog</a>(&amp;baseName, FALSE);
03662         <span class="keywordflow">goto</span> IopLoadExit;
03663     }
03664 
03665     <span class="comment">//</span>
03666     <span class="comment">// Reference the handle and obtain a pointer to the driver object so that</span>
03667     <span class="comment">// the handle can be deleted without the object going away.</span>
03668     <span class="comment">//</span>
03669 
03670     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( driverHandle,
03671                                         0,
03672                                         IoDriverObjectType,
03673                                         KeGetPreviousMode(),
03674                                         (PVOID *) &amp;driverObject,
03675                                         (<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">POBJECT_HANDLE_INFORMATION</a>) NULL );
03676 
03677     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( driverHandle );
03678 
03679     <span class="comment">//</span>
03680     <span class="comment">// Load the Registry information in the appropriate fields of the device</span>
03681     <span class="comment">// object.</span>
03682     <span class="comment">//</span>
03683 
03684     driverObject-&gt;HardwareDatabase =
03685         &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a17">CmRegistryMachineHardwareDescriptionSystemName</a>;
03686 
03687     <span class="comment">//</span>
03688     <span class="comment">// Store the name of the device driver in the driver object so that it</span>
03689     <span class="comment">// can be easily found by the error log thread.</span>
03690     <span class="comment">//</span>
03691 
03692     driverObject-&gt;DriverName.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool,
03693                                                       driverName.MaximumLength );
03694     <span class="keywordflow">if</span> (driverObject-&gt;DriverName.Buffer) {
03695         driverObject-&gt;DriverName.MaximumLength = driverName.MaximumLength;
03696         driverObject-&gt;DriverName.Length = driverName.Length;
03697 
03698         RtlCopyMemory( driverObject-&gt;DriverName.Buffer,
03699                        driverName.Buffer,
03700                        driverName.MaximumLength );
03701     }
03702 
03703     <span class="comment">//</span>
03704     <span class="comment">// Query the name of the registry path for this driver so that it can</span>
03705     <span class="comment">// be passed to the driver.</span>
03706     <span class="comment">//</span>
03707 
03708     registryPath = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool, PAGE_SIZE );
03709     <span class="keywordflow">if</span> (!registryPath) {
03710         <a class="code" href="../../d5/d0/obclose_8c.html#a3">ObMakeTemporaryObject</a>( driverObject );
03711         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( driverObject );
03712         status = STATUS_INSUFFICIENT_RESOURCES;
03713         <span class="keywordflow">goto</span> IopLoadExit;
03714     }
03715 
03716     status = <a class="code" href="../../d6/d1/obquery_8c.html#a5">NtQueryObject</a>( KeyHandle,
03717                             ObjectNameInformation,
03718                             registryPath,
03719                             PAGE_SIZE,
03720                             &amp;i );
03721     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03722         <a class="code" href="../../d5/d0/obclose_8c.html#a3">ObMakeTemporaryObject</a>( driverObject );
03723         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( driverObject );
03724         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( registryPath );
03725         <span class="keywordflow">goto</span> IopLoadExit;
03726     }
03727 
03728 <span class="preprocessor">#if DBG</span>
03729 <span class="preprocessor"></span>    <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a> (&amp;stime);
03730 <span class="preprocessor">#endif</span>
03731 <span class="preprocessor"></span>
03732     <span class="comment">//</span>
03733     <span class="comment">// Store the service key name of the device driver in the driver object</span>
03734     <span class="comment">//</span>
03735 
03736     <span class="keywordflow">if</span> (serviceName.Buffer) {
03737         driverObject-&gt;DriverExtension-&gt;ServiceKeyName.Buffer =
03738             <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool, serviceName.MaximumLength );
03739         <span class="keywordflow">if</span> (driverObject-&gt;DriverExtension-&gt;ServiceKeyName.Buffer) {
03740             driverObject-&gt;DriverExtension-&gt;ServiceKeyName.MaximumLength = serviceName.MaximumLength;
03741             driverObject-&gt;DriverExtension-&gt;ServiceKeyName.Length = serviceName.Length;
03742 
03743             RtlCopyMemory( driverObject-&gt;DriverExtension-&gt;ServiceKeyName.Buffer,
03744                            serviceName.Buffer,
03745                            serviceName.MaximumLength );
03746         }
03747     }
03748 
03749     <span class="comment">//</span>
03750     <span class="comment">// Now invoke the driver's initialization routine to initialize itself.</span>
03751     <span class="comment">//</span>
03752 
03753     <a class="code" href="../../d2/d1/mm_8h.html#a45">PERFINFO_DRIVER_INIT</a>(driverObject);
03754 
03755     status = driverObject-&gt;DriverInit( driverObject, &amp;registryPath-&gt;Name );
03756 
03757     <a class="code" href="../../d2/d1/mm_8h.html#a46">PERFINFO_DRIVER_INIT_COMPLETE</a>(driverObject);
03758 
03759 <span class="preprocessor">#if DBG</span>
03760 <span class="preprocessor"></span>
03761     <span class="comment">//</span>
03762     <span class="comment">// If DriverInit took longer than 5 seconds, print a message.</span>
03763     <span class="comment">//</span>
03764 
03765     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a> (&amp;etime);
03766     dtime  = (ULONG) ((etime.QuadPart - stime.QuadPart) / 1000000);
03767 
03768     <span class="keywordflow">if</span> (dtime &gt; 50) {
03769         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IOLOAD: Driver %wZ took %d.%ds to %s\n"</span>,
03770             &amp;driverName,
03771             dtime/10,
03772             dtime%10,
03773             <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ? <span class="stringliteral">"initialize"</span> : <span class="stringliteral">"fail initialization"</span>
03774             );
03775 
03776     }
03777 <span class="preprocessor">#endif</span>
03778 <span class="preprocessor"></span>
03779     <span class="comment">//</span>
03780     <span class="comment">// Workaround for broken NT 4.0 3D labs driver</span>
03781     <span class="comment">// They zero out some function table entries by mistake.</span>
03782 
03783     <span class="keywordflow">for</span> (i = 0; i &lt;= <a class="code" href="../../d0/d5/io_8h.html#a42">IRP_MJ_MAXIMUM_FUNCTION</a>; i++) {
03784         <span class="keywordflow">if</span> (driverObject-&gt;MajorFunction[i] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03785             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(driverObject-&gt;MajorFunction[i] != NULL);
03786             driverObject-&gt;MajorFunction[i] = <a class="code" href="../../d2/d4/internal_8c.html#a45">IopInvalidDeviceRequest</a>;
03787         }
03788     }
03789 
03790     <span class="comment">//</span>
03791     <span class="comment">// If DriverInit doesn't work, then simply unload the image and mark the driver</span>
03792     <span class="comment">// object as temporary.  This will cause everything to be deleted.</span>
03793     <span class="comment">//</span>
03794 
03795     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( registryPath );
03796 
03797     <span class="comment">//</span>
03798     <span class="comment">// If we load the driver because we think it is a legacy driver and</span>
03799     <span class="comment">// it does not create any device object in its DriverEntry.  We will</span>
03800     <span class="comment">// unload this driver.</span>
03801     <span class="comment">//</span>
03802 
03803     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; !<a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a32">IopIsLegacyDriver</a>(driverObject)) {
03804         <span class="keywordflow">if</span> (driverObject-&gt;DeviceObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
03805             serviceName.Buffer &amp;&amp;
03806             !<a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a19">IopIsAnyDeviceInstanceEnabled</a>(&amp;serviceName, NULL, FALSE) &amp;&amp;
03807             !(driverObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a146">DRVO_REINIT_REGISTERED</a>)) {
03808             <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a18">IopDriverLoadingFailed</a>(KeyHandle, NULL);
03809             status = STATUS_PLUGPLAY_NO_DEVICE;
03810         } <span class="keywordflow">else</span> {
03811 
03812             <span class="comment">//</span>
03813             <span class="comment">// Start the devices controlled by the driver and enumerate them</span>
03814             <span class="comment">// At this point, we know there is at least one device controlled by the driver.</span>
03815             <span class="comment">//</span>
03816 
03817             <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a34">IopDeleteLegacyKey</a>(driverObject);
03818             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a14">PnPInitialized</a>) {
03819                 status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a287">IopStartDriverDevices</a>(driverObject);
03820             }
03821         }
03822         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03823             <span class="keywordflow">if</span> (driverObject-&gt;DriverUnload) {
03824                 driverObject-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a143">DRVO_UNLOAD_INVOKED</a>;
03825                 driverObject-&gt;DriverUnload(driverObject);
03826                 <a class="code" href="../../d2/d4/internal_8c.html#a75">IopBootLog</a>(&amp;baseName, FALSE);
03827             } <span class="keywordflow">else</span> {
03828 <span class="preprocessor">    #if DBG</span>
03829 <span class="preprocessor"></span>                <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopLoadDriver: A PnP driver %wZ does not support DriverUnload routine.\n"</span>, &amp;driverName);
03830                 <span class="comment">// ASSERT(0);</span>
03831 <span class="preprocessor">    #endif</span>
03832 <span class="preprocessor"></span>            }
03833         }
03834     }
03835 
03836     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03837         <a class="code" href="../../d5/d0/obclose_8c.html#a3">ObMakeTemporaryObject</a>( driverObject );
03838         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( driverObject );
03839     } <span class="keywordflow">else</span> {
03840 
03841         <span class="comment">//</span>
03842         <span class="comment">// Free the memory occupied by the driver's initialization routines.</span>
03843         <span class="comment">//</span>
03844 
03845         <a class="code" href="../../d2/d4/internal_8c.html#a75">IopBootLog</a>(&amp;baseName, TRUE);
03846         <a class="code" href="../../d8/d8/sysload_8c.html#a55">MmFreeDriverInitialization</a>( driverObject-&gt;DriverSection );
03847         <a class="code" href="../../d0/d6/iop_8h.html#a207">IopReadyDeviceObjects</a>( driverObject );
03848     }
03849 
03850 IopLoadExit:
03851 
03852     <span class="comment">//</span>
03853     <span class="comment">// Free any pool that was allocated by this routine that has not yet</span>
03854     <span class="comment">// been freed.</span>
03855     <span class="comment">//</span>
03856 
03857     <span class="keywordflow">if</span> (driverName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03858         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( driverName.Buffer );
03859     }
03860 
03861     <span class="keywordflow">if</span> (keyValueInformation != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03862         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
03863     }
03864 
03865     <span class="keywordflow">if</span> (keyBasicInformation != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03866         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyBasicInformation );
03867     }
03868 
03869     <span class="keywordflow">if</span> (serviceName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03870         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(serviceName.Buffer);
03871     }
03872 
03873     <span class="comment">//</span>
03874     <span class="comment">// If this routine is about to return a failure, then let the Configuration</span>
03875     <span class="comment">// Manager know about it.  But, if STATUS_PLUGPLAY_NO_DEVICE, the device was</span>
03876     <span class="comment">// disabled by hardware profile.  In this case we don't need to report it.</span>
03877     <span class="comment">//</span>
03878 
03879     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) &amp;&amp; (status != STATUS_PLUGPLAY_NO_DEVICE)) {
03880 
03881         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> lStatus;
03882         PULONG errorControl;
03883 
03884         <span class="keywordflow">if</span> (status != STATUS_IMAGE_ALREADY_LOADED) {
03885 
03886             <span class="comment">//</span>
03887             <span class="comment">// If driver was loaded, do not call IopDriverLoadingFailed to change</span>
03888             <span class="comment">// the driver loading status.  Because, obviously, the driver is</span>
03889             <span class="comment">// running.</span>
03890             <span class="comment">//</span>
03891 
03892             <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a18">IopDriverLoadingFailed</a>(KeyHandle, NULL);
03893             lStatus = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( KeyHandle,
03894                                            L<span class="stringliteral">"ErrorControl"</span>,
03895                                            &amp;keyValueInformation );
03896             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( lStatus ) || !keyValueInformation-&gt;DataLength) {
03897                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( lStatus )) {
03898                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
03899                 }
03900             } <span class="keywordflow">else</span> {
03901                 errorControl = (PULONG) ((PUCHAR) keyValueInformation + keyValueInformation-&gt;DataOffset);
03902                 <a class="code" href="../../d7/d9/cm_8h.html#a34">CmBootLastKnownGood</a>( *errorControl );
03903                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
03904             }
03905         }
03906     }
03907 
03908     <span class="comment">//</span>
03909     <span class="comment">// Close the caller's handle and return the final status from the load</span>
03910     <span class="comment">// operation.</span>
03911     <span class="comment">//</span>
03912 
03913     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( KeyHandle );
03914     <span class="keywordflow">return</span> status;
03915 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a192" doxytag="iop.h::IopLoadFileSystemDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopLoadFileSystemDriver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l04077">4077</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01181">_DEVICE_OBJECT::AttachedDevice</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01552">IoBuildDeviceIoControlRequest()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04022">IopDecrementDeviceObjectRef()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00069">IRP_MJ_DEVICE_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00068">IRP_MJ_FILE_SYSTEM_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00115">IRP_MN_LOAD_FILE_SYSTEM</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l04282">IopMountVolume()</a>.
<p>
<pre class="fragment"><div>04083                    :
04084 
04085     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when a mini-<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system recognizer driver recognizes
04086     a volume as being a particular <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system, but <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver <span class="keywordflow">for</span> that <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
04087     system has not yet been loaded.  This function allows <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mini-driver to
04088     load <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> real <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system, and remove itself from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system, so that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04089     real <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system can mount <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device in question.
04090 
04091 Arguments:
04092 
04093     DeviceObject - Registered <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system device object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mini-driver.
04094 
04095 Return Value:
04096 
04097     None.
04098 
04099 --*/
04100 
04101 {
04102     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
04103     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04104     IO_STATUS_BLOCK ioStatus;
04105     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
04106     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
04107     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> attachedDevice;
04108 
04109     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04110 
04111     attachedDevice = DeviceObject;
04112     <span class="keywordflow">while</span> (attachedDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>) {
04113         attachedDevice = attachedDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
04114     }
04115 
04116     <span class="comment">//</span>
04117     <span class="comment">// Begin by building an I/O Request Packet to have the mini-file system</span>
04118     <span class="comment">// driver load the real file system.</span>
04119     <span class="comment">//</span>
04120 
04121     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event, NotificationEvent, FALSE );
04122 
04123     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a25">IoBuildDeviceIoControlRequest</a>( IRP_MJ_DEVICE_CONTROL,
04124                                          attachedDevice,
04125                                          (PVOID) NULL,
04126                                          0,
04127                                          (PVOID) NULL,
04128                                          0,
04129                                          FALSE,
04130                                          &amp;event,
04131                                          &amp;ioStatus );
04132     <span class="keywordflow">if</span> (irp) {
04133 
04134         <span class="comment">//</span>
04135         <span class="comment">// Change the actual major and minor function codes to be a file system</span>
04136         <span class="comment">// control with a minor function code of load FS driver.</span>
04137         <span class="comment">//</span>
04138 
04139         irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
04140         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a26">IRP_MJ_FILE_SYSTEM_CONTROL</a>;
04141         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a49">IRP_MN_LOAD_FILE_SYSTEM</a>;
04142 
04143         <span class="comment">//</span>
04144         <span class="comment">// Now issue the request.</span>
04145         <span class="comment">//</span>
04146 
04147         status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( attachedDevice, irp );
04148         <span class="keywordflow">if</span> (status == STATUS_PENDING) {
04149             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
04150                                           Executive,
04151                                           KernelMode,
04152                                           FALSE,
04153                                           (PLARGE_INTEGER) NULL );
04154         }
04155     }
04156 
04157     <span class="comment">//</span>
04158     <span class="comment">// Decrement the reference count on the device object.  If this is the last</span>
04159     <span class="comment">// last reason that this mini-file system recognizer needs to stay around,</span>
04160     <span class="comment">// then unload it.</span>
04161     <span class="comment">//</span>
04162 
04163     <a class="code" href="../../d0/d6/iop_8h.html#a161">IopDecrementDeviceObjectRef</a>(DeviceObject, TRUE);
04164 
04165     <span class="keywordflow">return</span>;
04166 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a193" doxytag="iop.h::IopLoadUnloadDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopLoadUnloadDriver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Parameter</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l04169">4169</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d1/d5/iop_8h-source.html#l00345">_REINIT_PACKET::Context</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01330">_DRIVER_EXTENSION::Count</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01378">_DRIVER_OBJECT::DriverExtension</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00343">_REINIT_PACKET::DriverObject</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00317">_LOAD_PACKET::DriverObject</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00344">_REINIT_PACKET::DriverReinitializationRoutine</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00318">_LOAD_PACKET::DriverServiceName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01413">_DRIVER_OBJECT::DriverUnload</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01303">DRVO_REINIT_REGISTERED</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00316">_LOAD_PACKET::Event</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a239">ExInterlockedRemoveHeadList()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00319">_LOAD_PACKET::FinalStatus</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01367">_DRIVER_OBJECT::Flags</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00054">IopDatabaseLock</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00128">IopDriverReinitializeQueueHead</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d6/iop_8h.html#a58">PLOAD_PACKET</a>, <a class="el" href="../../d0/d6/iop_8h.html#a62">PREINIT_PACKET</a>, <a class="el" href="../../d0/d6/iop_8h.html#a61">REINIT_PACKET</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l00657">IopCompleteUnloadOrDelete()</a>, <a class="el" href="../../d9/d3/loadunld_8c-source.html#l00035">NtLoadDriver()</a>, and <a class="el" href="../../d9/d3/loadunld_8c-source.html#l00244">NtUnloadDriver()</a>.
<p>
<pre class="fragment"><div>04175                    :
04176 
04177     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> executed as an EX worker thread routine when a driver <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
04178     to be loaded or unloaded dynamically.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used because some drivers
04179     need to create system threads in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system process, which
04180     cannot be done in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system service that
04181     was invoked to load or unload <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified driver.
04182 
04183 Arguments:
04184 
04185     Parameter - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> load packet describing what work <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be
04186         done.
04187 
04188 Return Value:
04189 
04190     None.
04191 
04192 --*/
04193 
04194 {
04195     <a class="code" href="../../d0/d2/struct__LOAD__PACKET.html">PLOAD_PACKET</a> loadPacket;
04196     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04197     HANDLE keyHandle;
04198 
04199     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04200 
04201     <span class="comment">//</span>
04202     <span class="comment">// Begin by getting a pointer to the load packet.</span>
04203     <span class="comment">//</span>
04204 
04205     loadPacket = (<a class="code" href="../../d0/d2/struct__LOAD__PACKET.html">PLOAD_PACKET</a>) Parameter;
04206 
04207     <span class="comment">//</span>
04208     <span class="comment">// If the driver object field of the packet is non-NULL, then this is</span>
04209     <span class="comment">// a request to complete the unload of a driver.  Simply invoke the</span>
04210     <span class="comment">// driver's unload routine.  Note that the final status of the unload</span>
04211     <span class="comment">// is ignored, so it is not set here.</span>
04212     <span class="comment">//</span>
04213 
04214     <span class="keywordflow">if</span> (loadPacket-&gt;<a class="code" href="../../d0/d2/struct__LOAD__PACKET.html#o2">DriverObject</a>) {
04215 
04216         loadPacket-&gt;<a class="code" href="../../d0/d2/struct__LOAD__PACKET.html#o2">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o13">DriverUnload</a>( loadPacket-&gt;<a class="code" href="../../d0/d2/struct__LOAD__PACKET.html#o2">DriverObject</a> );
04217         status = STATUS_SUCCESS;
04218 
04219     } <span class="keywordflow">else</span> {
04220 
04221         PLIST_ENTRY entry;
04222         <a class="code" href="../../d5/d3/struct__REINIT__PACKET.html">PREINIT_PACKET</a> reinitEntry;
04223 
04224         <span class="comment">//</span>
04225         <span class="comment">// The driver specified by the DriverServiceName is to be loaded.</span>
04226         <span class="comment">// Begin by opening the registry node for this driver.  Note</span>
04227         <span class="comment">// that if this is successful, then the load driver routine is</span>
04228         <span class="comment">// responsible for closing the handle.</span>
04229         <span class="comment">//</span>
04230 
04231         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>( &amp;keyHandle,
04232                                      (HANDLE) NULL,
04233                                      loadPacket-&gt;<a class="code" href="../../d0/d2/struct__LOAD__PACKET.html#o3">DriverServiceName</a>,
04234                                      KEY_READ,
04235                                      FALSE );
04236         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04237 
04238             <span class="comment">//</span>
04239             <span class="comment">// Invoke the internal common routine to perform the work.</span>
04240             <span class="comment">// This is the same routine that is used by the I/O system</span>
04241             <span class="comment">// initialization code to load drivers.</span>
04242             <span class="comment">//</span>
04243 
04244             status = <a class="code" href="../../d0/d6/iop_8h.html#a191">IopLoadDriver</a>( keyHandle, TRUE );
04245 
04246             <span class="comment">//</span>
04247             <span class="comment">// Walk the list reinitialization list in case this driver, or</span>
04248             <span class="comment">// some other driver, has requested to be invoked at a re-</span>
04249             <span class="comment">// initialization entry point.</span>
04250             <span class="comment">//</span>
04251 
04252             <span class="keywordflow">while</span> (entry = <a class="code" href="../../d5/d8/ex_8h.html#a239">ExInterlockedRemoveHeadList</a>( &amp;IopDriverReinitializeQueueHead, &amp;IopDatabaseLock )) {
04253                 reinitEntry = CONTAINING_RECORD( entry, <a class="code" href="../../d5/d3/struct__REINIT__PACKET.html">REINIT_PACKET</a>, ListEntry );
04254 <span class="comment">//#if _PNP_POWER_</span>
04255                 reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o2">Count</a>++;
04256                 reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> &amp;= ~<a class="code" href="../../d0/d5/io_8h.html#a146">DRVO_REINIT_REGISTERED</a>;
04257                 reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o2">DriverReinitializationRoutine</a>( reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>,
04258                                                             reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o3">Context</a>,
04259                                                             reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o2">Count</a> );
04260 <span class="comment">//#else</span>
04261 <span class="preprocessor">#if 0</span>
04262 <span class="preprocessor"></span>                reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>-&gt;Count++;
04263                 reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o2">DriverReinitializationRoutine</a>( reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>,
04264                                                             reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o3">Context</a>,
04265                                                             reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>-&gt;Count );
04266 <span class="preprocessor">#endif // _PNP_POWER_</span>
04267 <span class="preprocessor"></span>                <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( reinitEntry );
04268             }
04269         }
04270     }
04271 
04272     <span class="comment">//</span>
04273     <span class="comment">// Set the final status of the load or unload operation, and indicate to</span>
04274     <span class="comment">// the caller that the operation is now complete.</span>
04275     <span class="comment">//</span>
04276 
04277     loadPacket-&gt;<a class="code" href="../../d0/d2/struct__LOAD__PACKET.html#o4">FinalStatus</a> = status;
04278     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;loadPacket-&gt;<a class="code" href="../../d0/d2/struct__LOAD__PACKET.html#o1">Event</a>, 0, FALSE );
04279 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a227" doxytag="iop.h::IopLogErrorEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopLogErrorEvent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SequenceNumber</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>UniqueErrorValue</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN NTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>FinalStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN NTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>SpecificIOStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LengthOfInsert1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Insert1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LengthOfInsert2</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Insert2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04393">4393</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
References <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00428">IoAllocateErrorLogEntry()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00075">IopErrorLogObject</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11556">IoWriteErrorLogEntry()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04061">IopCompleteDumpInitialization()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04746">IopConfigureCrashDump()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00384">IopGetDumpStack()</a>, and <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04580">IopInitializeDCB()</a>.
<p>
<pre class="fragment"><div>04406                    :
04407 
04408     This routine allocates an error log entry, copies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supplied data
04409     to <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>, and requests that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> be written to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
04410 
04411 Arguments:
04412     SequenceNumber - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> unique to an <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> over <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> life of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> irp in
04413     <span class="keyword">this</span> driver. - 0 generally means an error not associated with an <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>
04414 
04415     UniqueErrorValue - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> unique <span class="keywordtype">long</span> word that identifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> particular
04416     call to <span class="keyword">this</span> function.
04417 
04418     FinalStatus - The <span class="keyword">final</span> status given to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> irp that was associated
04419     with <span class="keyword">this</span> error.  If <span class="keyword">this</span> log entry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> during one of
04420     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> retries <span class="keyword">this</span> value will be STATUS_SUCCESS.
04421 
04422     SpecificIOStatus - The IO status <span class="keywordflow">for</span> a particular error.
04423 
04424     LengthOfInsert1 - The length in bytes (including the terminating NULL)
04425                       of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first insertion string.
04426 
04427     Insert1 - The first insertion string.
04428 
04429     LengthOfInsert2 - The length in bytes (including the terminating NULL)
04430                       of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second insertion string.  NOTE, there must
04431                       be a first insertion string <span class="keywordflow">for</span> their to be
04432                       a second insertion string.
04433 
04434     Insert2 - The second insertion string.
04435 
04436 Return Value:
04437 
04438     STATUS_SUCCESS - Success
04439     STATUS_INVALID_HANDLE - <a class="code" href="../../d6/d8/udfstruc_8h.html#a129a114">Uninitialized</a> error log device object
04440     STATUS_NO_DATA_DETECTED - <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a> log entry
04441 
04442 --*/
04443 
04444 {
04445     PIO_ERROR_LOG_PACKET errorLogEntry;
04446     PUCHAR ptrToFirstInsert;
04447     PUCHAR ptrToSecondInsert;
04448 
04449     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d5/ioinit_8c.html#a8">IopErrorLogObject</a>) {
04450         <span class="keywordflow">return</span>(STATUS_INVALID_HANDLE);
04451     }
04452 
04453 
04454     errorLogEntry = <a class="code" href="../../d4/d6/iosubs_8c.html#a14">IoAllocateErrorLogEntry</a>(
04455                         IopErrorLogObject,
04456                         (UCHAR)( <span class="keyword">sizeof</span>(IO_ERROR_LOG_PACKET) +
04457                                 LengthOfInsert1 +
04458                                 LengthOfInsert2) );
04459 
04460    <span class="keywordflow">if</span> ( errorLogEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
04461 
04462       errorLogEntry-&gt;ErrorCode = SpecificIOStatus;
04463       errorLogEntry-&gt;SequenceNumber = SequenceNumber;
04464       errorLogEntry-&gt;MajorFunctionCode = 0;
04465       errorLogEntry-&gt;RetryCount = 0;
04466       errorLogEntry-&gt;UniqueErrorValue = UniqueErrorValue;
04467       errorLogEntry-&gt;FinalStatus = FinalStatus;
04468       errorLogEntry-&gt;DumpDataSize = 0;
04469 
04470       ptrToFirstInsert = (PUCHAR)&amp;errorLogEntry-&gt;DumpData[0];
04471 
04472       ptrToSecondInsert = ptrToFirstInsert + LengthOfInsert1;
04473 
04474       <span class="keywordflow">if</span> (LengthOfInsert1) {
04475 
04476          errorLogEntry-&gt;NumberOfStrings = 1;
04477          errorLogEntry-&gt;StringOffset = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(ptrToFirstInsert -
04478                                                 (PUCHAR)errorLogEntry);
04479          RtlCopyMemory(
04480                       ptrToFirstInsert,
04481                       Insert1,
04482                       LengthOfInsert1
04483                       );
04484 
04485          <span class="keywordflow">if</span> (LengthOfInsert2) {
04486 
04487             errorLogEntry-&gt;NumberOfStrings = 2;
04488             RtlCopyMemory(
04489                          ptrToSecondInsert,
04490                          Insert2,
04491                          LengthOfInsert2
04492                          );
04493 
04494          } <span class="comment">//LenghtOfInsert2</span>
04495 
04496       } <span class="comment">// LenghtOfInsert1</span>
04497 
04498       <a class="code" href="../../d4/d6/iosubs_8c.html#a123">IoWriteErrorLogEntry</a>(errorLogEntry);
04499       <span class="keywordflow">return</span>(STATUS_SUCCESS);
04500 
04501    }  <span class="comment">// errorLogEntry != NULL</span>
04502 
04503     <span class="keywordflow">return</span>(STATUS_NO_DATA_DETECTED);
04504 
04505 } <span class="comment">//IopLogErrorEvent</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a194" doxytag="iop.h::IopLookupBusStringFromID" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopLookupBusStringFromID           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN INTERFACE_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>InterfaceType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG BusFlags&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l08729">8729</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d4/d9/user32_8def-source.html#l00799">c</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00050">InterfaceType</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
<pre class="fragment"><div>08738                    :
08739 
08740     Translates INTERFACE_TYPE to its corresponding WCHAR[] string.
08741 
08742 Arguments:
08743 
08744     KeyHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> opened registry key,
08745         HKLM\System\CurrentControlSet\Control\SystemResources\BusValues.
08746 
08747     <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> interface <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <span class="keywordflow">for</span> which a descriptive
08748         name <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be retrieved.
08749 
08750     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Supplies a pointer to a unicode character buffer that will
08751         receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bus name.  Since <span class="keyword">this</span> buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used in an
08752         intermediate step to retrieve a KEY_VALUE_FULL_INFORMATION structure,
08753         <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must be large enough to contain <span class="keyword">this</span> structure (including the
08754         longest value name &amp; data length under KeyHandle).
08755 
08756     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>.
08757 
08758     BusFlags - Optionally receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flags specified in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second
08759         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a> REG_BINARY value.
08760 
08761 Return Value:
08762 
08763     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
08764 
08765 --*/
08766 {
08767     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                        status;
08768     ULONG                           <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, junk, i, j;
08769     PULONG                          pl;
08770     PKEY_VALUE_FULL_INFORMATION     KeyInformation;
08771     WCHAR                           <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
08772 
08773     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
08774 
08775     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
08776     KeyInformation = (PKEY_VALUE_FULL_INFORMATION) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
08777 
08778     <span class="keywordflow">for</span> (; ;) {
08779         status = ZwEnumerateValueKey (
08780                         KeyHandle,
08781                         Index++,
08782                         KeyValueFullInformation,
08783                         Buffer,
08784                         Length,
08785                         &amp;junk
08786                         );
08787 
08788         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
08789             <span class="keywordflow">return</span> status;
08790         }
08791 
08792         <span class="keywordflow">if</span> (KeyInformation-&gt;Type != REG_BINARY) {
08793             <span class="keywordflow">continue</span>;
08794         }
08795 
08796         pl = (PULONG) ((PUCHAR) KeyInformation + KeyInformation-&gt;DataOffset);
08797         <span class="keywordflow">if</span> ((ULONG) <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> != pl[0]) {
08798             <span class="keywordflow">continue</span>;
08799         }
08800 
08801         <span class="comment">//</span>
08802         <span class="comment">// Found a match - move the name to the start of the buffer</span>
08803         <span class="comment">//</span>
08804 
08805         <span class="keywordflow">if</span>(ARGUMENT_PRESENT(BusFlags)) {
08806             *BusFlags = pl[1];
08807         }
08808 
08809         j = KeyInformation-&gt;NameLength / <span class="keyword">sizeof</span> (WCHAR);
08810         <span class="keywordflow">for</span> (i=0; i &lt; j; i++) {
08811             <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> = KeyInformation-&gt;Name[i];
08812             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[i] = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
08813         }
08814 
08815         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[i] = 0;
08816         <span class="keywordflow">return</span> STATUS_SUCCESS;
08817     }
08818 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a195" doxytag="iop.h::IopMountVolume" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopMountVolume           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AllowRawMount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceLockAlreadyHeld</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Alertable</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l04282">4282</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01181">_DEVICE_OBJECT::AttachedDevice</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01160">DO_SYSTEM_BOOT_PARTITION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01153">DO_VERIFY_VOLUME</a>, <a class="el" href="../../d1/d1/config_2test_2init386_8c-source.html#l00027">dummy()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d5/d8/ex_8h.html#a235">ExInterlockedAddUlong()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02030">_IO_STACK_LOCATION::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d8/d2/fsrtl_2filter_8c-source.html#l00304">FsRtlIsTotalDeviceFailure()</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00070">InitializationPhase</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03528">IoIsErrorUserInduced</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00065">IOP_ABORT</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00336">IopAllocateIrpMustSucceed()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00094">IopCdRomFileSystemQueueHead</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00054">IopDatabaseLock</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00065">IopDatabaseResource</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00084">IopDiskFileSystemQueueHead</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04077">IopLoadFileSystemDriver()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00114">IopTapeFileSystemQueueHead</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00068">IRP_MJ_FILE_SYSTEM_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00113">IRP_MN_MOUNT_VOLUME</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01551">IRP_MOUNT_COMPLETION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01557">IRP_SYNCHRONOUS_PAGING_IO</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01178">_DEVICE_OBJECT::ReferenceCount</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01641">_IRP::RequestorMode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01054">VPB_MOUNTED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01058">VPB_RAW_MOUNT</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01057">VPB_REMOVE_PENDING</a>.
<p>
Referenced by <a class="el" href="../../d5/d2/parse_8c-source.html#l00098">IopCheckVpbMounted()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11389">IoVerifyVolume()</a>.
<p>
<pre class="fragment"><div>04291                    :
04292 
04293     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to mount a volume on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device.  The Volume
04294     Parameter Block (<a class="code" href="../../d7/d7/struct__VPB.html">VPB</a>) for the specified device is a "clean" <a class="code" href="../../d7/d7/struct__VPB.html">VPB</a>.  That is,
04295     it indicates that the volume has never been mounted.  It is up to the file
04296     system that eventually mounts the volume to determine whether the volume is,
04297     or has been, mounted elsewhere.
04298 
04299 Arguments:
04300 
04301     DeviceObject - Pointer to device object on which the volume is to be
04302         mounted.
04303 
04304     AllowRawMount - This parameter tells us if we should continue our
04305         filesystem search to include the Raw file system.  This flag will
04306         only be passed in as TRUE as a result of a DASD open.
04307 
04308     DeviceLockAlreadyHeld - If TRUE, then the caller has already acquired
04309         the device lock and we should not attempt to acquire it.  This is
04310         currently passed in as TRUE when called from IoVerifyVolume.
04311 
04312 Return Value:
04313 
04314     The function value is a successful status code if a volume was successfully
04315     mounted on the device.  Otherwise, an error code is returned.
04316 
04317 
04318 --*/
04319 
04320 {
04321     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04322     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
04323     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
04324     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> fsDeviceObject;
04325     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> attachedDevice;
04326     PLIST_ENTRY entry;
04327     PLIST_ENTRY queueHeader;
04328     IO_STATUS_BLOCK ioStatus;
04329     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
04330     ULONG extraStack;
04331     LIST_ENTRY <a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>;
04332     ULONG rawMountOnly;
04333 
04334     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04335 
04336     <span class="comment">//</span>
04337     <span class="comment">// Obtain the lock for the device to be mounted.  This guarantees that</span>
04338     <span class="comment">// only one thread is attempting to mount (or verify) this particular</span>
04339     <span class="comment">// device at a time.</span>
04340     <span class="comment">//</span>
04341 
04342     <span class="keywordflow">if</span> (!DeviceLockAlreadyHeld) {
04343 
04344         status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;DeviceObject-&gt;DeviceLock,
04345                                         Executive,
04346                                         KeGetPreviousMode(),
04347                                         Alertable,
04348                                         (PLARGE_INTEGER) NULL );
04349 
04350         <span class="comment">//</span>
04351         <span class="comment">// If the wait ended because of an alert or an APC, return now</span>
04352         <span class="comment">// without mounting the device.  Note that as the wait for the</span>
04353         <span class="comment">// event was unsuccessful, we do not set it on exit.</span>
04354         <span class="comment">//</span>
04355 
04356         <span class="keywordflow">if</span> (status == STATUS_ALERTED || status == STATUS_USER_APC) {
04357 
04358             <span class="keywordflow">return</span> status;
04359         }
04360     }
04361 
04362     <span class="comment">//</span>
04363     <span class="comment">// Now acquire the resource database lock for the I/O system to perform this</span>
04364     <span class="comment">// operation.  This resource protects access to the file system queue.</span>
04365     <span class="comment">//</span>
04366 
04367     <span class="comment">//KeEnterCriticalRegion();</span>
04368     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( &amp;IopDatabaseResource, TRUE );
04369 
04370     <span class="comment">//</span>
04371     <span class="comment">// Check the 'mounted' flag of the VPB to ensure that it is still clear.</span>
04372     <span class="comment">// If it is, then no one has gotten in before this to mount the volume.</span>
04373     <span class="comment">// Attempt to mount the volume in this case.</span>
04374     <span class="comment">//</span>
04375 
04376     <span class="keywordflow">if</span> ((DeviceObject-&gt;Vpb-&gt;Flags &amp; (<a class="code" href="../../d0/d5/io_8h.html#a116">VPB_MOUNTED</a> | <a class="code" href="../../d0/d5/io_8h.html#a119">VPB_REMOVE_PENDING</a>)) == 0) {
04377 
04378         <span class="comment">//</span>
04379         <span class="comment">// This volume has never been mounted.  Initialize the event and set the</span>
04380         <span class="comment">// status to unsuccessful to set up for the loop.  Also if the device</span>
04381         <span class="comment">// has the verify bit set, clear it.</span>
04382         <span class="comment">//</span>
04383 
04384         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event, NotificationEvent, FALSE );
04385         status = STATUS_UNSUCCESSFUL;
04386         DeviceObject-&gt;Flags &amp;= ~<a class="code" href="../../d0/d5/io_8h.html#a122">DO_VERIFY_VOLUME</a>;
04387 
04388         <span class="comment">//</span>
04389         <span class="comment">// Get the actual device that this volume is to be mounted on.  This</span>
04390         <span class="comment">// device is the final device in the list of devices which are attached</span>
04391         <span class="comment">// to the specified real device.</span>
04392         <span class="comment">//</span>
04393 
04394         attachedDevice = DeviceObject;
04395         <span class="keywordflow">while</span> (attachedDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>) {
04396             attachedDevice = attachedDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
04397         }
04398 
04399         <span class="comment">//</span>
04400         <span class="comment">// Reference the device object so it cannot go away.</span>
04401         <span class="comment">//</span>
04402 
04403         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( attachedDevice );
04404 
04405         <span class="comment">//</span>
04406         <span class="comment">// Determine which type of file system should be invoked based on</span>
04407         <span class="comment">// the device type of the device being mounted.</span>
04408         <span class="comment">//</span>
04409 
04410         <span class="keywordflow">if</span> (DeviceObject-&gt;DeviceType == FILE_DEVICE_DISK ||
04411             DeviceObject-&gt;DeviceType == FILE_DEVICE_VIRTUAL_DISK) {
04412             queueHeader = &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a6">IopDiskFileSystemQueueHead</a>;
04413         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DeviceObject-&gt;DeviceType == FILE_DEVICE_CD_ROM) {
04414             queueHeader = &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a7">IopCdRomFileSystemQueueHead</a>;
04415         } <span class="keywordflow">else</span> {
04416             queueHeader = &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a9">IopTapeFileSystemQueueHead</a>;
04417         }
04418 
04419         rawMountOnly = (DeviceObject-&gt;Vpb-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a120">VPB_RAW_MOUNT</a>);
04420 
04421         <span class="comment">//</span>
04422         <span class="comment">// Now loop through each of the file systems which have been loaded in</span>
04423         <span class="comment">// the system to see whether anyone understands the media in the device.</span>
04424         <span class="comment">//</span>
04425 
04426         <span class="keywordflow">for</span> (entry = queueHeader-&gt;Flink;
04427              entry != queueHeader &amp;&amp; !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status );
04428              entry = entry-&gt;Flink) {
04429 
04430             <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> savedFsDeviceObject;
04431 
04432             <span class="comment">//</span>
04433             <span class="comment">// If this is the final entry (Raw file system), and it is also</span>
04434             <span class="comment">// not the first entry, and a raw mount is not permitted, then</span>
04435             <span class="comment">// break out of the loop at this point, as this volume cannot</span>
04436             <span class="comment">// be mounted for the caller's purposes.</span>
04437             <span class="comment">//</span>
04438 
04439             <span class="keywordflow">if</span> (!AllowRawMount &amp;&amp; entry-&gt;Flink == queueHeader &amp;&amp; entry != queueHeader-&gt;Flink) {
04440                 <span class="keywordflow">break</span>;
04441             }
04442 
04443             <span class="comment">//</span>
04444             <span class="comment">// If raw mount is the only one requested and this is not the last entry on the list</span>
04445             <span class="comment">// then skip.</span>
04446             <span class="comment">//</span>
04447             <span class="keywordflow">if</span> (rawMountOnly &amp;&amp; (entry-&gt;Flink != queueHeader)) {
04448                 <span class="keywordflow">continue</span>;
04449             }
04450 
04451             fsDeviceObject = CONTAINING_RECORD( entry, <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">DEVICE_OBJECT</a>, Queue.ListEntry );
04452             savedFsDeviceObject = fsDeviceObject;
04453 
04454             <span class="comment">//</span>
04455             <span class="comment">// It is possible that the file system has been attached to, so</span>
04456             <span class="comment">// walk the attached list for the file system.  The number of stack</span>
04457             <span class="comment">// locations that must be allocated in the IRP must include one for</span>
04458             <span class="comment">// the file system itself, and then one for each driver that is</span>
04459             <span class="comment">// attached to it.  Account for all of the stack locations required</span>
04460             <span class="comment">// to get through the mount process.</span>
04461             <span class="comment">//</span>
04462 
04463             extraStack = 1;
04464 
04465             <span class="keywordflow">while</span> (fsDeviceObject-&gt;AttachedDevice) {
04466                 fsDeviceObject = fsDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
04467                 extraStack++;
04468             }
04469 
04470             <span class="comment">//</span>
04471             <span class="comment">// Another file system has been found and the volume has still not</span>
04472             <span class="comment">// been mounted.  Attempt to mount the volume using this file</span>
04473             <span class="comment">// system.</span>
04474             <span class="comment">//</span>
04475             <span class="comment">// Begin by resetting the event being used for synchronization with</span>
04476             <span class="comment">// the I/O operation.</span>
04477             <span class="comment">//</span>
04478 
04479             <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( &amp;event );
04480 
04481             <span class="comment">//</span>
04482             <span class="comment">// Allocate and initialize an IRP for this mount operation.  Notice</span>
04483             <span class="comment">// that the flags for this operation appear the same as a page read</span>
04484             <span class="comment">// operation.  This is because the completion code for both of the</span>
04485             <span class="comment">// operations is exactly the same logic.</span>
04486             <span class="comment">//</span>
04487 
04488             irp = <a class="code" href="../../d0/d6/iop_8h.html#a149">IopAllocateIrpMustSucceed</a>( (CCHAR) (attachedDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a> + extraStack) );
04489             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a175">IRP_MOUNT_COMPLETION</a> | <a class="code" href="../../d0/d5/io_8h.html#a181">IRP_SYNCHRONOUS_PAGING_IO</a>;
04490             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
04491             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = &amp;event;
04492             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;ioStatus;
04493             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
04494             irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
04495             irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a26">IRP_MJ_FILE_SYSTEM_CONTROL</a>;
04496             irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a47">IRP_MN_MOUNT_VOLUME</a>;
04497             irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a> = AllowRawMount;
04498             irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.MountVolume.Vpb = DeviceObject-&gt;Vpb;
04499             irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.MountVolume.DeviceObject = attachedDevice;
04500 
04501             status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( fsDeviceObject, irp );
04502 
04503             <span class="comment">//</span>
04504             <span class="comment">// Wait for the I/O operation to complete.</span>
04505             <span class="comment">//</span>
04506 
04507             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04508                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
04509                                               Executive,
04510                                               KernelMode,
04511                                               FALSE,
04512                                               (PLARGE_INTEGER) NULL );
04513             } <span class="keywordflow">else</span> {
04514 
04515                 <span class="comment">//</span>
04516                 <span class="comment">// Ensure that the proper status value gets picked up.</span>
04517                 <span class="comment">//</span>
04518 
04519                 ioStatus.Status = status;
04520                 ioStatus.Information = 0;
04521             }
04522 
04523             <span class="comment">//</span>
04524             <span class="comment">// If the operation was successful then set the VPB as mounted.</span>
04525             <span class="comment">//</span>
04526 
04527             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( ioStatus.Status )) {
04528                 status = ioStatus.Status;
04529                 DeviceObject-&gt;Vpb-&gt;Flags = <a class="code" href="../../d0/d5/io_8h.html#a116">VPB_MOUNTED</a>;
04530 
04531                 <span class="comment">//</span>
04532                 <span class="comment">// We explicitly propagate VPB_RAW_MOUNT as the previous</span>
04533                 <span class="comment">// statement that has been there for a long time in NT</span>
04534                 <span class="comment">// could be clearing other flags which should be cleared.</span>
04535                 <span class="comment">//</span>
04536                 <span class="keywordflow">if</span> (rawMountOnly) { 
04537                     DeviceObject-&gt;Vpb-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a120">VPB_RAW_MOUNT</a>;
04538                 }
04539                 DeviceObject-&gt;Vpb-&gt;DeviceObject-&gt;StackSize = (UCHAR) (attachedDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a> + 1);
04540 
04541             } <span class="keywordflow">else</span> {
04542 
04543                 <span class="comment">//</span>
04544                 <span class="comment">// The mount operation failed.  Make a special check here to</span>
04545                 <span class="comment">// determine whether or not a popup was enabled, and if so,</span>
04546                 <span class="comment">// check to see whether or not the operation was to be aborted.</span>
04547                 <span class="comment">// If so, bail out now and return the error to the caller.</span>
04548                 <span class="comment">//</span>
04549 
04550                 status = ioStatus.Status;
04551                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/io_8h.html#a232">IoIsErrorUserInduced</a>(status) &amp;&amp;
04552                     ioStatus.Information == <a class="code" href="../../d0/d6/iop_8h.html#a0">IOP_ABORT</a>) {
04553                     <span class="keywordflow">break</span>;
04554                 }
04555 
04556                 <span class="comment">//</span>
04557                 <span class="comment">// Also check to see whether or not this is a volume that has</span>
04558                 <span class="comment">// been recognized, but the file system for it needs to be</span>
04559                 <span class="comment">// loaded.  If so, drop the locks held at this point, tell the</span>
04560                 <span class="comment">// mini-file system recognizer to load the driver, and then</span>
04561                 <span class="comment">// reacquire the locks.</span>
04562                 <span class="comment">//</span>
04563 
04564                 <span class="keywordflow">if</span> (status == STATUS_FS_DRIVER_REQUIRED) {
04565 
04566                     <span class="comment">//</span>
04567                     <span class="comment">// Increment the number of reasons that this driver cannot</span>
04568                     <span class="comment">// be unloaded.  Note that this must be done while still</span>
04569                     <span class="comment">// holding the database resource.</span>
04570                     <span class="comment">//</span>
04571 
04572                     <a class="code" href="../../d5/d8/ex_8h.html#a235">ExInterlockedAddUlong</a>( &amp;savedFsDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o2">ReferenceCount</a>,
04573                                            1,
04574                                            &amp;IopDatabaseLock );
04575 
04576                     <span class="comment">//</span>
04577                     <span class="comment">// Release the locks, load the new file system, and unload</span>
04578                     <span class="comment">// the recognizer.</span>
04579                     <span class="comment">//</span>
04580 
04581                     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( &amp;IopDatabaseResource );
04582                     <span class="comment">//KeLeaveCriticalRegion();</span>
04583                     <span class="keywordflow">if</span> (!DeviceLockAlreadyHeld) {
04584                         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;DeviceObject-&gt;DeviceLock, 0, FALSE );
04585                     }
04586                     <a class="code" href="../../d0/d6/iop_8h.html#a192">IopLoadFileSystemDriver</a>( savedFsDeviceObject );
04587 
04588                     <span class="comment">//</span>
04589                     <span class="comment">// Now reacquire the locks, in the correct order, and check</span>
04590                     <span class="comment">// to see if the volume has been mounted before we could</span>
04591                     <span class="comment">// get back.  If so, exit; otherwise, restart the file</span>
04592                     <span class="comment">// file system queue scan from the beginning.</span>
04593                     <span class="comment">//</span>
04594 
04595                     <span class="keywordflow">if</span> (!DeviceLockAlreadyHeld) {
04596                         status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;DeviceObject-&gt;DeviceLock,
04597                                                         Executive,
04598                                                         KeGetPreviousMode(),
04599                                                         Alertable,
04600                                                         (PLARGE_INTEGER) NULL );
04601                         <span class="keywordflow">if</span> (status == STATUS_ALERTED || status == STATUS_USER_APC) {
04602 
04603                             <span class="comment">//</span>
04604                             <span class="comment">// The device was not mounted by us so</span>
04605                             <span class="comment">// drop the reference before returning.</span>
04606                             <span class="comment">//</span>
04607 
04608                             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( attachedDevice );
04609 
04610                             <span class="keywordflow">return</span> status;
04611                         }
04612                     }
04613 
04614                     <span class="comment">//KeEnterCriticalRegion();</span>
04615                     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( &amp;IopDatabaseResource, TRUE );
04616 
04617                     <span class="keywordflow">if</span> (DeviceObject-&gt;Vpb-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a116">VPB_MOUNTED</a>) {
04618 
04619                         <span class="comment">//</span>
04620                         <span class="comment">//  This volume was mounted before we got back.</span>
04621                         <span class="comment">//</span>
04622 
04623                         status = STATUS_SUCCESS;
04624                         <span class="keywordflow">break</span>;
04625                     }
04626 
04627                     <span class="comment">//</span>
04628                     <span class="comment">// Reset the list back to the beginning and start over</span>
04629                     <span class="comment">// again.</span>
04630                     <span class="comment">//</span>
04631 
04632                     <a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>.Flink = queueHeader-&gt;Flink;
04633                     entry = &amp;<a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>;
04634                     status = STATUS_UNRECOGNIZED_VOLUME;
04635                 }
04636 
04637                 <span class="comment">//</span>
04638                 <span class="comment">// If the error wasn't STATUS_UNRECOGNIZED_VOLUME, and this</span>
04639                 <span class="comment">// request is not going to the Raw file system, then there</span>
04640                 <span class="comment">// is no reason to continue looping.</span>
04641                 <span class="comment">//</span>
04642 
04643                 <span class="keywordflow">if</span> (!AllowRawMount &amp;&amp; (status != STATUS_UNRECOGNIZED_VOLUME) &amp;&amp;
04644                     <a class="code" href="../../d1/d8/fsrtl_8h.html#a111">FsRtlIsTotalDeviceFailure</a>(status)) {
04645                     <span class="keywordflow">break</span>;
04646                 }
04647             }
04648         }
04649 
04650         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04651 
04652             <span class="comment">//</span>
04653             <span class="comment">// The device was not mounted by us so</span>
04654             <span class="comment">// drop the reference.</span>
04655             <span class="comment">//</span>
04656 
04657             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( attachedDevice );
04658 
04659         }
04660 
04661     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>((DeviceObject-&gt;Vpb-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a119">VPB_REMOVE_PENDING</a>) != 0) {
04662 
04663         <span class="comment">//</span>
04664         <span class="comment">// Pnp is attempting to remove this volume.  Don't allow the mount.</span>
04665         <span class="comment">//</span>
04666 
04667         status = STATUS_DEVICE_DOES_NOT_EXIST;
04668 
04669     } <span class="keywordflow">else</span> {
04670 
04671         <span class="comment">//</span>
04672         <span class="comment">// The volume for this device has already been mounted.  Return a</span>
04673         <span class="comment">// success code.</span>
04674         <span class="comment">//</span>
04675 
04676         status = STATUS_SUCCESS;
04677     }
04678 
04679     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( &amp;IopDatabaseResource );
04680     <span class="comment">//KeLeaveCriticalRegion();</span>
04681 
04682     <span class="comment">//</span>
04683     <span class="comment">// Release the I/O database resource lock and the synchronization event for</span>
04684     <span class="comment">// the device.</span>
04685     <span class="comment">//</span>
04686 
04687     <span class="keywordflow">if</span> (!DeviceLockAlreadyHeld) {
04688         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;DeviceObject-&gt;DeviceLock, 0, FALSE );
04689     }
04690 
04691     <span class="comment">//</span>
04692     <span class="comment">// Finally, if the mount operation failed, and the target device is the</span>
04693     <span class="comment">// boot partition, then bugcheck the system.  It is not possible for the</span>
04694     <span class="comment">// system to run properly if the system's boot partition cannot be mounted.</span>
04695     <span class="comment">//</span>
04696     <span class="comment">// Note: Don't bugcheck if the system is already booted.</span>
04697     <span class="comment">//</span>
04698 
04699     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) &amp;&amp;
04700         DeviceObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a129">DO_SYSTEM_BOOT_PARTITION</a> &amp;&amp;
04701         <a class="code" href="../../d8/d1/init_8h.html#a21">InitializationPhase</a> &lt; 2) {
04702         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( INACCESSIBLE_BOOT_DEVICE, (ULONG_PTR) DeviceObject, status, 0, 0 );
04703     }
04704 
04705     <span class="keywordflow">return</span> status;
04706 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a196" doxytag="iop.h::IopNotifyPnpWhenChainDereferenced" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopNotifyPnpWhenChainDereferenced           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>PhysicalDeviceObjects</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObjectCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Query</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>VetoingDevice</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l04947">4947</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01181">_DEVICE_OBJECT::AttachedDevice</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01222">DOE_REMOVE_PENDING</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01223">DOE_REMOVE_PROCESSED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01268">_DEVOBJ_EXTENSION::ExtensionFlags</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00084">IopChainDereferenceComplete()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00054">IopDatabaseLock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01178">_DEVICE_OBJECT::ReferenceCount</a>.
<p>
<pre class="fragment"><div>04956                    :
04957 
04958     Called by PnP when processing a Surprise Removal or a Query Remove.
04959 
04960     In <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span> of Surprise Removal <span class="keyword">this</span> function will set <a class="code" href="../../d0/d5/io_8h.html#a140">DOE_REMOVE_PENDING</a>
04961     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a> flags of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> each PDO and all its attached devices.
04962     For each PDO (and its attachment chain) which currently has a zero
04963     ReferenceCount <a class="code" href="../../d0/d5/io_8h.html#a140">DOE_REMOVE_PENDING</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> reset and <a class="code" href="../../d0/d5/io_8h.html#a141">DOE_REMOVE_PROCESSED</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
04964     set.  <a class="code" href="../../d3/d0/pnpdel_8c.html#a6">IopChainDereferenceComplete</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> then called to notify PnP that
04965     <span class="keyword">this</span> PDO <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ready <span class="keywordflow">for</span> removal.
04966 
04967     Then as each remaining PDO and its attachment chain's ReferenceCount drops
04968     to zero IopCheckUnloadOrDelete will call <a class="code" href="../../d3/d0/pnpdel_8c.html#a6">IopChainDereferenceComplete</a>
04969     (supplied by PnP).
04970 
04971     In <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span> of Query Remove <span class="keyword">this</span> function set <a class="code" href="../../d0/d5/io_8h.html#a141">DOE_REMOVE_PROCESSED</a> on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04972     PDO and all its attached devices to prevent further opens.  It also checks
04973     to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ReferenceCount <span class="keywordflow">for</span> all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDOs and their attached devices <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
04974     zero.  If so <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> leaves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d5/io_8h.html#a141">DOE_REMOVE_PROCESSED</a> set and returns <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.  If
04975     not, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> resets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d5/io_8h.html#a141">DOE_REMOVE_PROCESSED</a> on all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDOs and their attached
04976     devices and returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>.
04977 
04978 Arguments:
04979 
04980     PhysicalDeviceObjects   <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> of PDEVICE_OBJECTs <span class="keywordflow">for</span> all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDOs to be
04981                             checked.
04982 
04983     DeviceObjectCount       <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> of PDEVICE_OBJECTs in PhysicalDeviceObjects.
04984 
04985     Query                   <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> a Query Remove.
04986 
04987     VetoingDevice           Only used <span class="keywordflow">for</span> Query Remove, Set to first PDO with a
04988                             ReferenceCount not equal to zero.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to
04989                             provide feedback to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user as to why <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query
04990                             may have failed.
04991 
04992 
04993 Return Value:
04994 
04995     If Query <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">return</span> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> there are outstanding
04996     opens on any of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDOs or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> attached devices, otherwise <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
04997     returned.
04998 
04999     If Query <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> NOT set then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">return</span> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>.
05000 
05001 --*/
05002 
05003 {
05004     <a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html">PDEVOBJ_EXTENSION</a> deviceExtension;
05005     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
05006     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> attachedDeviceObject;
05007     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
05008     ULONG referenced;
05009     ULONG pass1SetFlag;
05010     ULONG pass1ClearFlag;
05011     LONG i;
05012     KIRQL irql;
05013 
05014     ExAcquireSpinLock( &amp;IopDatabaseLock, &amp;irql );
05015 
05016     <span class="keywordflow">if</span> (Query) {
05017         pass1SetFlag = <a class="code" href="../../d0/d5/io_8h.html#a141">DOE_REMOVE_PROCESSED</a>;
05018         pass1ClearFlag = 0;
05019     } <span class="keywordflow">else</span> {
05020         pass1SetFlag = <a class="code" href="../../d0/d5/io_8h.html#a140">DOE_REMOVE_PENDING</a>;
05021         pass1ClearFlag = <a class="code" href="../../d0/d5/io_8h.html#a141">DOE_REMOVE_PROCESSED</a>;
05022     }
05023 
05024     <span class="keywordflow">for</span> (i = 0; i &lt; (LONG)DeviceObjectCount; i++) {
05025         deviceObject = PhysicalDeviceObjects[i];
05026         deviceExtension = deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>;
05027 
05028         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
05029 
05030         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( deviceNode != NULL );
05031 
05032         <span class="comment">//</span>
05033         <span class="comment">// Assume that at least one device object has a reference.  Walk the</span>
05034         <span class="comment">// entire chain marking them with DOE_REMOVE_PENDING.</span>
05035         <span class="comment">//</span>
05036 
05037         <span class="comment">//</span>
05038         <span class="comment">// We don't actually care how many aggregate references there actually</span>
05039         <span class="comment">// are.  All we're interested in is whether there are any.  So we'll OR</span>
05040         <span class="comment">// them together rather than adding them.  That way we don't have to do</span>
05041         <span class="comment">// testing or branching and we don't have to worry about overflow in the</span>
05042         <span class="comment">// highly unlikely event that there are a total of more references than</span>
05043         <span class="comment">// will fit in a ULONG.</span>
05044         <span class="comment">//</span>
05045 
05046         referenced = 0;
05047         attachedDeviceObject = deviceObject;
05048         <span class="keywordflow">do</span> {
05049             deviceExtension = attachedDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>;
05050 
05051             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceExtension != NULL);
05052             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> &amp; pass1SetFlag));
05053 
05054 
05055             deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> &amp;= ~pass1ClearFlag;
05056             deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> |= pass1SetFlag;
05057             referenced |= attachedDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o2">ReferenceCount</a>;
05058 
05059             attachedDeviceObject = attachedDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
05060 
05061         } <span class="keywordflow">while</span> (attachedDeviceObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05062 
05063         <span class="keywordflow">if</span> (!Query &amp;&amp; referenced == 0) {
05064 
05065             <span class="comment">//</span>
05066             <span class="comment">// There aren't any outstanding references, retraverse the chain and</span>
05067             <span class="comment">// mark them all DOE_REMOVE_PROCESSED.  This will still prevent any</span>
05068             <span class="comment">// opens or attaches from occuring but we won't call</span>
05069             <span class="comment">// IopChainDereferenceComplete in IopCompleteUnloadOrDelete.</span>
05070             <span class="comment">//</span>
05071 
05072             attachedDeviceObject = deviceObject;
05073             <span class="keywordflow">do</span> {
05074                 deviceExtension = attachedDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>;
05075 
05076                 deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> &amp;= ~<a class="code" href="../../d0/d5/io_8h.html#a140">DOE_REMOVE_PENDING</a>;
05077                 deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a141">DOE_REMOVE_PROCESSED</a>;
05078 
05079                 attachedDeviceObject = attachedDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
05080 
05081             } <span class="keywordflow">while</span> (attachedDeviceObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05082 
05083             ExReleaseSpinLock( &amp;IopDatabaseLock, irql );
05084 
05085             <a class="code" href="../../d9/d0/pnpiop_8h.html#a316">IopChainDereferenceComplete</a>( deviceObject );
05086 
05087             ExAcquireSpinLock( &amp;IopDatabaseLock, &amp;irql );
05088         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Query &amp;&amp; referenced != 0) {
05089             <span class="keywordflow">break</span>;
05090         }
05091     }
05092 
05093     <span class="keywordflow">if</span> (Query &amp;&amp; referenced != 0) {
05094 
05095         <span class="keywordflow">if</span> (VetoingDevice != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05096             *VetoingDevice = deviceObject;
05097         }
05098 
05099         <span class="keywordflow">for</span> (; i &gt;= 0; i--) {
05100             deviceObject = PhysicalDeviceObjects[i];
05101             deviceExtension = deviceObject-&gt;DeviceObjectExtension;
05102 
05103             <span class="comment">//</span>
05104             <span class="comment">// There are outstanding references, retraverse the chain and</span>
05105             <span class="comment">// unset DOE_REMOVE_PROCESSED.</span>
05106             <span class="comment">//</span>
05107 
05108             attachedDeviceObject = deviceObject;
05109             <span class="keywordflow">do</span> {
05110                 deviceExtension = attachedDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>;
05111 
05112                 deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> &amp;= ~<a class="code" href="../../d0/d5/io_8h.html#a141">DOE_REMOVE_PROCESSED</a>;
05113 
05114                 attachedDeviceObject = attachedDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
05115 
05116             } <span class="keywordflow">while</span> (attachedDeviceObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05117         }
05118     }
05119 
05120     ExReleaseSpinLock( &amp;IopDatabaseLock, irql );
05121 
05122     <span class="keywordflow">return</span> !Query || referenced != 0;
05123 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a197" doxytag="iop.h::IopOpenLinkOrRenameTarget" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopOpenLinkOrRenameTarget           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>RenameBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l05126">5126</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d5/io_8h.html#a600a406">CreateFileTypeNone</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01507">FO_OPENED_CASE_SENSITIVE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00233">IO_FORCE_ACCESS_CHECK</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00243">IO_NO_PARAMETER_CHECKING</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00235">IO_OPEN_TARGET_DIRECTORY</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l04502">IoCreateFile()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00044">IoFileObjectType</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09835">IoSetInformation()</a>, and <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>.
<p>
<pre class="fragment"><div>05135                    :
05136 
05137     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> rename, set link and set copy-on-write code
05138     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O system's <a class="code" href="../../d6/d9/restrfil_8c.html#a38">NtSetInformationFile</a> system service when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller has
05139     specified a fully qualified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> name as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target of a rename, set link,
05140     or set copy-on-write operation.  This routine attempts to open <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent
05141     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> and checks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
05142 
05143         o   If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> itself exists, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller must have specified that
05144             <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be replaced, otherwise an error <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
05145 
05146         o   Ensures that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> specification refers to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same volume
05147             upon which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> exists.
05148 
05149 Arguments:
05150 
05151     TargetHandle - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a variable to <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle to
05152         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> opened target <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <span class="keywordflow">if</span> no errors have occurred.
05153 
05154     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> that represents <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current rename
05155         request.
05156 
05157     RenameBuffer - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system intermediate buffer that
05158         contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's rename parameters.
05159 
05160     FileObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
05161         being renamed.
05162 
05163 Return Value:
05164 
05165     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
05166 
05167 Note:
05168 
05169     This function assumes that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> layout of a rename, set link and set
05170     copy-on-write information structure are exactly <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same.
05171 
05172 --*/
05173 
05174 {
05175     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05176     IO_STATUS_BLOCK ioStatus;
05177     HANDLE handle;
05178     OBJECT_ATTRIBUTES objectAttributes;
05179     UNICODE_STRING newFileName;
05180     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
05181     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> targetFileObject;
05182     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a> handleInformation;
05183     PFILE_RENAME_INFORMATION renameBuffer = RenameBuffer;
05184 
05185     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05186 
05187     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>( FILE_RENAME_INFORMATION ) ==
05188             <span class="keyword">sizeof</span>( FILE_LINK_INFORMATION ) );
05189     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FIELD_OFFSET( FILE_RENAME_INFORMATION, ReplaceIfExists ) ==
05190             FIELD_OFFSET( FILE_LINK_INFORMATION, ReplaceIfExists ) );
05191     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FIELD_OFFSET( FILE_RENAME_INFORMATION, RootDirectory ) ==
05192             FIELD_OFFSET( FILE_LINK_INFORMATION, RootDirectory ) );
05193     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FIELD_OFFSET( FILE_RENAME_INFORMATION, FileNameLength ) ==
05194             FIELD_OFFSET( FILE_LINK_INFORMATION, FileNameLength ) );
05195     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FIELD_OFFSET( FILE_RENAME_INFORMATION, FileName ) ==
05196             FIELD_OFFSET( FILE_LINK_INFORMATION, FileName ) );
05197 
05198     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>( FILE_RENAME_INFORMATION ) ==
05199             <span class="keyword">sizeof</span>( FILE_MOVE_CLUSTER_INFORMATION ) );
05200     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FIELD_OFFSET( FILE_RENAME_INFORMATION, ReplaceIfExists ) ==
05201             FIELD_OFFSET( FILE_MOVE_CLUSTER_INFORMATION, ClusterCount ) );
05202     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FIELD_OFFSET( FILE_RENAME_INFORMATION, RootDirectory ) ==
05203             FIELD_OFFSET( FILE_MOVE_CLUSTER_INFORMATION, RootDirectory ) );
05204     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FIELD_OFFSET( FILE_RENAME_INFORMATION, FileNameLength ) ==
05205             FIELD_OFFSET( FILE_MOVE_CLUSTER_INFORMATION, FileNameLength ) );
05206     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FIELD_OFFSET( FILE_RENAME_INFORMATION, FileName ) ==
05207             FIELD_OFFSET( FILE_MOVE_CLUSTER_INFORMATION, FileName ) );
05208 
05209     <span class="comment">//</span>
05210     <span class="comment">// A fully qualified file name was specified.  Begin by attempting to open</span>
05211     <span class="comment">// the parent directory of the specified target file.</span>
05212     <span class="comment">//</span>
05213 
05214     newFileName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) renameBuffer-&gt;FileNameLength;
05215     newFileName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) renameBuffer-&gt;FileNameLength;
05216     newFileName.Buffer = renameBuffer-&gt;FileName;
05217 
05218     InitializeObjectAttributes( &amp;objectAttributes,
05219                                 &amp;newFileName,
05220                                 FileObject-&gt;Flags &amp; FO_OPENED_CASE_SENSITIVE ? 0 : OBJ_CASE_INSENSITIVE,
05221                                 renameBuffer-&gt;RootDirectory,
05222                                 (PSECURITY_DESCRIPTOR) NULL );
05223 
05224     status = <a class="code" href="../../d4/d6/iosubs_8c.html#a46">IoCreateFile</a>( &amp;handle,
05225                            FILE_WRITE_DATA | SYNCHRONIZE,
05226                            &amp;objectAttributes,
05227                            &amp;ioStatus,
05228                            (PLARGE_INTEGER) NULL,
05229                            0,
05230                            FILE_SHARE_READ | FILE_SHARE_WRITE,
05231                            FILE_OPEN,
05232                            FILE_OPEN_FOR_BACKUP_INTENT,
05233                            (PVOID) NULL,
05234                            0L,
05235                            CreateFileTypeNone,
05236                            (PVOID) NULL,
05237                            IO_NO_PARAMETER_CHECKING |
05238                            IO_OPEN_TARGET_DIRECTORY |
05239                            IO_FORCE_ACCESS_CHECK );
05240     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
05241         <span class="comment">//</span>
05242         <span class="comment">// The open operation for the target file's parent directory was</span>
05243         <span class="comment">// successful.  Check to see whether or not the file exists.</span>
05244         <span class="comment">//</span>
05245 
05246         irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( Irp );
05247         <span class="keywordflow">if</span> (irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetFile.FileInformationClass == FileLinkInformation &amp;&amp;
05248             !renameBuffer-&gt;ReplaceIfExists &amp;&amp;
05249             ioStatus.Information == FILE_EXISTS) {
05250 
05251             <span class="comment">//</span>
05252             <span class="comment">// The target file exists, and the caller does not want to replace</span>
05253             <span class="comment">// it.  This is a name collision error so cleanup and return.</span>
05254             <span class="comment">//</span>
05255 
05256             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
05257             status = STATUS_OBJECT_NAME_COLLISION;
05258 
05259         } <span class="keywordflow">else</span> {
05260 
05261             <span class="comment">//</span>
05262             <span class="comment">// Everything up to this point is fine, so dereference the handle</span>
05263             <span class="comment">// to a pointer to the file object and ensure that the two file</span>
05264             <span class="comment">// specifications refer to the same device.</span>
05265             <span class="comment">//</span>
05266 
05267             status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( handle,
05268                                               FILE_WRITE_DATA,
05269                                               IoFileObjectType,
05270                                               UserMode,
05271                                               (PVOID *) &amp;targetFileObject,
05272                                               &amp;handleInformation );
05273             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
05274 
05275                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( targetFileObject );
05276 
05277                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( targetFileObject) !=
05278                     <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject )) {
05279 
05280                     <span class="comment">//</span>
05281                     <span class="comment">// The two files refer to different devices.  Clean everything</span>
05282                     <span class="comment">// up and return an appropriate error.</span>
05283                     <span class="comment">//</span>
05284 
05285                     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
05286                     status = STATUS_NOT_SAME_DEVICE;
05287 
05288                 } <span class="keywordflow">else</span> {
05289 
05290                     <span class="comment">//</span>
05291                     <span class="comment">// Otherwise, everything worked, so allow the rename operation</span>
05292                     <span class="comment">// to continue.</span>
05293                     <span class="comment">//</span>
05294 
05295                     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetFile.FileObject = targetFileObject;
05296                     *TargetHandle = handle;
05297                     status = STATUS_SUCCESS;
05298 
05299                 }
05300 
05301             } <span class="keywordflow">else</span> {
05302 
05303                 <span class="comment">//</span>
05304                 <span class="comment">// There was an error referencing the handle to what should</span>
05305                 <span class="comment">// have been the target directory.  This generally means that</span>
05306                 <span class="comment">// there was a resource problem or the handle was invalid, etc.</span>
05307                 <span class="comment">// Simply attempt to close the handle and return the error.</span>
05308                 <span class="comment">//</span>
05309 
05310                 <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
05311 
05312             }
05313 
05314         }
05315     }
05316 
05317     <span class="comment">//</span>
05318     <span class="comment">// Return the final status of the operation.</span>
05319     <span class="comment">//</span>
05320 
05321     <span class="keywordflow">return</span> status;
05322 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a198" doxytag="iop.h::IopOpenRegistryKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopOpenRegistryKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE BaseHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Create</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">5325</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d1/d5/consubs_8c-source.html#l00023">Create()</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/netboot_8c-source.html#l00314">IopAddRemoteBootValuesToRegistry()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l02036">IopApplyFunctionToServiceInstances()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01690">IopApplyFunctionToSubKeys()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l09046">IopBootLog()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03841">IopCleanupDeviceRegistryValues()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l09157">IopCopyBootLogRegistryToFile()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00087">IopCreateMadeupNode()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l05338">IopDeleteLegacyKey()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03651">IopDeviceObjectFromDeviceInstance()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03776">IopDeviceObjectToDeviceInstance()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l02609">IopDriverLoadingFailed()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03967">IopGetDeviceResourcesFromRegistry()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l05221">IopGetGroupOrderIndex()</a>, <a class="el" href="../../d2/d7/report_8c-source.html#l00066">IopInitializeResourceMap()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03071">IopIsAnyDeviceInstanceEnabled()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03332">IopIsDeviceInstanceEnabled()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04169">IopLoadUnloadDriver()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01588">IopOpenCurrentHwProfileDeviceInstanceKey()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01342">IopOpenServiceEnumKeys()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00753">IopPrepareDriverLoading()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04379">IopReadDumpRegistry()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08822">IopSafebootDriverLoad()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00964">IopServiceInstanceToDeviceInstance()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l01982">IopSetupRemoteBootCard()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00862">IopUpdateHardwareProfile()</a>, <a class="el" href="../../d2/d7/report_8c-source.html#l00760">IopWriteResourceList()</a>, <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00070">IoQueryDeviceDescription()</a>, <a class="el" href="../../d2/d7/report_8c-source.html#l00193">IoReportHalResourceUsage()</a>, <a class="el" href="../../d9/d3/loadunld_8c-source.html#l00244">NtUnloadDriver()</a>, <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00223">pIoQueryBusDescription()</a>, and <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00565">pIoQueryDeviceDescription()</a>.
<p>
<pre class="fragment"><div>05335                    :
05336 
05337     Opens or creates a <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a5">VOLATILE</a> registry key <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name passed in based
05338     at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> BaseHandle node.
05339 
05340 Arguments:
05341 
05342     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle which will contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry key that
05343         was opened.
05344 
05345     BaseHandle - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> from which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key must be opened.
05346 
05347     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> - <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> that must be opened/created.
05348 
05349     DesiredAccess - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller needs to
05350         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key.
05351 
05352     <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> - Determines <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be created <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> does not exist.
05353 
05354 Return Value:
05355 
05356    The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
05357 
05358 --*/
05359 
05360 {
05361     OBJECT_ATTRIBUTES objectAttributes;
05362     ULONG disposition;
05363 
05364     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05365 
05366     <span class="comment">//</span>
05367     <span class="comment">// Initialize the object for the key.</span>
05368     <span class="comment">//</span>
05369 
05370     InitializeObjectAttributes( &amp;objectAttributes,
05371                                 KeyName,
05372                                 OBJ_CASE_INSENSITIVE,
05373                                 BaseHandle,
05374                                 (PSECURITY_DESCRIPTOR) NULL );
05375 
05376     <span class="comment">//</span>
05377     <span class="comment">// Create the key or open it, as appropriate based on the caller's</span>
05378     <span class="comment">// wishes.</span>
05379     <span class="comment">//</span>
05380 
05381     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a>) {
05382         <span class="keywordflow">return</span> ZwCreateKey( Handle,
05383                             DesiredAccess,
05384                             &amp;objectAttributes,
05385                             0,
05386                             (PUNICODE_STRING) NULL,
05387                             REG_OPTION_VOLATILE,
05388                             &amp;disposition );
05389     } <span class="keywordflow">else</span> {
05390         <span class="keywordflow">return</span> ZwOpenKey( Handle,
05391                           DesiredAccess,
05392                           &amp;objectAttributes );
05393     }
05394 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a199" doxytag="iop.h::IopParseDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopParseDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ParseObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Attributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>CompleteName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>RemainingName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID Context&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_QUALITY_OF_SERVICE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a9">SecurityQos</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/parse_8c-source.html#l00202">202</a> of file <a class="el" href="../../d5/d2/parse_8c-source.html">parse.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01020">_IO_SECURITY_CONTEXT::AccessState</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00221">_OPEN_PACKET::AllocationSize</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01181">_DEVICE_OBJECT::AttachedDevice</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00235">_OPEN_PACKET::BasicInformation</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00313">_OBJECT_HEADER::Body</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01661">_IRP::Cancel</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01701">_IRP::CancelRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01185">_DEVICE_OBJECT::Characteristics</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02031">_IO_STACK_LOCATION::Control</a>, <a class="el" href="../../d4/d3/parse_8c.html#a2">COPY_ATTRIBUTES</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00248">_OPEN_PACKET::CreateFileType</a>, <a class="el" href="../../d0/d5/io_8h.html#a600a407">CreateFileTypeNamedPipe</a>, <a class="el" href="../../d0/d5/io_8h.html#a600a406">CreateFileTypeNone</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00222">_OPEN_PACKET::CreateOptions</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01655">_IRP::CurrentLocation</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00283">_OPEN_PACKET::DeleteOnly</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01021">_IO_SECURITY_CONTEXT::DesiredAccess</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01517">_FILE_OBJECT::DeviceObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01072">_VPB::DeviceObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02488">_IO_STACK_LOCATION::DeviceObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01188">_DEVICE_OBJECT::DeviceType</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00228">_OPEN_PACKET::Disposition</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00225">_OPEN_PACKET::EaBuffer</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00226">_OPEN_PACKET::EaLength</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01540">_FILE_OBJECT::Event</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a235">ExInterlockedAddUlong()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00256">_OPEN_PACKET::ExtraCreateParameters</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01403">_DRIVER_OBJECT::FastIoDispatch</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00946">_FAST_IO_DISPATCH::FastIoQueryBasicInfo</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00956">_FAST_IO_DISPATCH::FastIoQueryNetworkOpenInfo</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00966">_FAST_IO_DISPATCH::FastIoQueryOpen</a>, <a class="el" href="../../d0/d5/io_8h.html#a353">FILE_OBJECT</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00223">_OPEN_PACKET::FileAttributes</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01534">_FILE_OBJECT::FileName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00208">_OPEN_PACKET::FileObject</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00209">_OPEN_PACKET::FinalStatus</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01533">_FILE_OBJECT::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02030">_IO_STACK_LOCATION::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01492">FO_ALERTABLE_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01501">FO_DIRECT_DEVICE_OPEN</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01511">FO_FILE_OPEN_CANCELLED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01493">FO_NO_INTERMEDIATE_BUFFERING</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01507">FO_OPENED_CASE_SENSITIVE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01510">FO_RANDOM_ACCESS</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01495">FO_SEQUENTIAL_ONLY</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01491">FO_SYNCHRONOUS_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01512">FO_VOLUME_OPEN</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01494">FO_WRITE_THROUGH</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00291">_OPEN_PACKET::FullAttributes</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01022">_IO_SECURITY_CONTEXT::FullCreateOptions</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00168">_OBJECT_TYPE_INITIALIZER::GenericMapping</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00413">_KEVENT::Header</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00210">_OPEN_PACKET::Information</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00233">IO_FORCE_ACCESS_CHECK</a>, <a class="el" href="../../d5/d2/parse_8c-source.html#l00037">IO_MAX_REMOUNT_REPARSE_ATTEMPTS</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00251">IO_REMOUNT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00250">IO_REPARSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00039">IO_TYPE_FILE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00042">IO_TYPE_OPEN_PACKET</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00044">IoFileObjectType</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06632">IoFreeIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06786">IoGetAttachedDevice()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00604">IopAllocateIrp</a>, <a class="el" href="../../d5/d2/parse_8c-source.html#l02048">IopCheckBackupRestorePrivilege()</a>, <a class="el" href="../../d5/d2/parse_8c-source.html#l00047">IopCheckDeviceAndDriver()</a>, <a class="el" href="../../d5/d2/parse_8c-source.html#l00098">IopCheckVpbMounted()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04022">IopDecrementDeviceObjectRef()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00417">IopDeleteFile()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00758">IopDequeueThreadIrp</a>, <a class="el" href="../../d5/d2/parse_8c-source.html#l00180">IopDereferenceVpbAndFree()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08130">IopDoNameTransmogrify()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01103">IopQueueThreadIrp</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00074">IopSecurityResource</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00042">IopVpbSpinLock</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08628">IoQueryFileInformation()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03977">IoSetNextIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01554">IRP_BUFFERED_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01558">IRP_CREATE_OPERATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01555">IRP_DEALLOCATE_BUFFER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01564">IRP_DEFER_IO_COMPLETION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00055">IRP_MJ_CREATE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00074">IRP_MJ_CREATE_MAILSLOT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00056">IRP_MJ_CREATE_NAMED_PIPE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01552">IRP_SYNCHRONOUS_API</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00300">_OPEN_PACKET::LocalFileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01596">_IRP::MdlAddress</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00242">_OPEN_PACKET::NetworkInformation</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00188">_DUMMY_FILE_OBJECT::ObjectHeader</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00196">OPEN_PACKET_PATTERN</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00227">_OPEN_PACKET::Options</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o24">_IRP::Overlay</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00267">_OPEN_PACKET::Override</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00211">_OPEN_PACKET::ParseCheck</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00547">PDRIVER_CANCEL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01648">_IRP::PendingReturned</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00196">PKNORMAL_ROUTINE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00297">_OBJECT_HEADER::PointerCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00275">_OPEN_PACKET::QueryOnly</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01075">_VPB::ReferenceCount</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00212">_OPEN_PACKET::RelatedFileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01524">_FILE_OBJECT::RelatedFileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01641">_IRP::RequestorMode</a>, <a class="el" href="../../d5/d2/parse_8c-source.html#l00032">RoundNameSize</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01763">RtlCopyUnicodeString()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03381">RtlMapGenericMask()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00085">SE_BACKUP_PRIVILEGES_CHECKED</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03323">SeAccessCheck()</a>, <a class="el" href="../../d3/d4/seastate_8c-source.html#l00434">SeAppendPrivileges()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01204">_DEVICE_OBJECT::SecurityDescriptor</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01019">_IO_SECURITY_CONTEXT::SecurityQos</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00037">SecurityQos</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03871">SeFastTraverseCheck()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03294">SeFreePrivileges()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00115">SeLockSubjectContext()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02765">SeOpenObjectAuditAlarm()</a>, <a class="el" href="../../d3/d4/seastate_8c-source.html#l00396">SeSetAccessStateGenericMapping()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03429">SeTraverseAuditAlarm()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00159">SeUnlockSubjectContext()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00224">_OPEN_PACKET::ShareAccess</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00262">_DISPATCHER_HEADER::SignalState</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00207">_OPEN_PACKET::Size</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01516">_FILE_OBJECT::Size</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00942">_FAST_IO_DISPATCH::SizeOfFastIoDispatch</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01867">SL_CASE_SENSITIVE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01654">_IRP::StackCount</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00072">TOKEN_HAS_TRAVERSE_PRIVILEGE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00076">TOKEN_IS_RESTRICTED</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00206">_OPEN_PACKET::Type</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01515">_FILE_OBJECT::Type</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01518">_FILE_OBJECT::Vpb</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01936">IopCreateObjectTypes()</a>, and <a class="el" href="../../d5/d2/parse_8c-source.html#l01690">IopParseFile()</a>.
<p>
<pre class="fragment"><div>00217                    :
00218 
00219     This routine interfaces to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NT Object <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a79">Manager</a>.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when
00220     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object system <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> given <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of an entity to create or open and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00221     name translates to a device object.  This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parse
00222     routine <span class="keywordflow">for</span> all device objects.
00223 
00224     In <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> normal <span class="keywordflow">case</span> of an <a class="code" href="../../d6/d9/restrfil_8c.html#a30">NtCreateFile</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user specifies either <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name
00225     of a device or of a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  In <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> former situation, <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked
00226     with a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device and a null (<span class="stringliteral">""</span>) string.  For this case, the
00227     routine simply allocates an <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>, fills it in, and passes it to the driver
00228     for the device.  The driver will then perform whatever rudimentary functions
00229     are necessary and will return a status code indicating whether an error was
00230     incurred.  This status code is remembered in the Open Packet (OP).
00231 
00232     In the latter situation, the name string to be opened/created is non-null.
00233     That is, it contains the remainder of the pathname to the file that is to
00234     be opened or created.  For this case, the routine allocates an IRP, fills
00235     it in, and passes it to the driver for the device.  The driver may then
00236     need to take further action or it may complete the request immediately.  If
00237     it needs to perform some work asynchronously, then it can queue the request
00238     and return a status of STATUS_PENDING.  This allows this routine and its
00239     caller to return to the user so that he can continue.  Otherwise, the open/
00240     create is basically finished.
00241 
00242     If the driver supports symbolic links, then it is also possible for the
00243     driver to return a new name.  This name will be returned to the Object
00244     Manager as a new name to look up.  The parsing will then begin again from
00245     the start.
00246 
00247     It is also the responsibility of this routine to create a file object for
00248     the file, if the name specifies a file.  The file object's address is
00249     returned to the NtCreateFile service through the OP.
00250 
00251 Arguments:
00252 
00253     ParseObject - Pointer to the device object the name translated into.
00254 
00255     ObjectType - Type of the object being opened.
00256 
00257     AccessState - Running security access state information for operation.
00258 
00259     AccessMode - Access mode of the original caller.
00260 
00261     Attributes - Attributes to be applied to the object.
00262 
00263     CompleteName - Complete name of the object.
00264 
00265     RemainingName - Remaining name of the object.
00266 
00267     Context - Pointer to an Open Packet (OP) from NtCreateFile service.
00268 
00269     SecurityQos - Optional security quality of service indicator.
00270 
00271     Object - The address of a variable to receive the created file object, if
00272         any.
00273 
00274 Return Value:
00275 
00276     The function return value is one of the following:
00277 
00278         a)  Success - This indicates that the function succeeded and the object
00279             parameter contains the address of the created file object.
00280 
00281         b)  Error - This indicates that the file was not found or created and
00282             no file object was created.
00283 
00284         c)  Reparse - This indicates that the remaining name string has been
00285             replaced by a new name that is to be parsed.
00286 
00287 --*/
00288 
00289 {
00290 
00291 <span class="preprocessor">#define COPY_ATTRIBUTES( n, b, s ) {                                    \</span>
00292 <span class="preprocessor">        (n)-&gt;CreationTime.QuadPart = (b)-&gt;CreationTime.QuadPart;        \</span>
00293 <span class="preprocessor">        (n)-&gt;LastAccessTime.QuadPart = (b)-&gt;LastAccessTime.QuadPart;    \</span>
00294 <span class="preprocessor">        (n)-&gt;LastWriteTime.QuadPart = (b)-&gt;LastWriteTime.QuadPart;      \</span>
00295 <span class="preprocessor">        (n)-&gt;ChangeTime.QuadPart = (b)-&gt;ChangeTime.QuadPart;            \</span>
00296 <span class="preprocessor">        (n)-&gt;AllocationSize.QuadPart = (s)-&gt;AllocationSize.QuadPart;    \</span>
00297 <span class="preprocessor">        (n)-&gt;EndOfFile.QuadPart = (s)-&gt;EndOfFile.QuadPart;              \</span>
00298 <span class="preprocessor">        (n)-&gt;FileAttributes = (b)-&gt;FileAttributes; }</span>
00299 <span class="preprocessor"></span>
00300     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00301     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00302     <a class="code" href="../../d3/d7/struct__OPEN__PACKET.html">POPEN_PACKET</a> op;
00303     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
00304     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00305     IO_STATUS_BLOCK ioStatus;
00306     <a class="code" href="../../d1/d5/struct__IO__SECURITY__CONTEXT.html">IO_SECURITY_CONTEXT</a> securityContext;
00307     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00308     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> parseDeviceObject;
00309     BOOLEAN directDeviceOpen;
00310     <a class="code" href="../../d7/d7/struct__VPB.html">PVPB</a> vpb;
00311     ACCESS_MASK desiredAccess;
00312     <a class="code" href="../../d0/d1/struct__DUMMY__FILE__OBJECT.html">PDUMMY_FILE_OBJECT</a> localFileObject;
00313     BOOLEAN realFileObjectRequired;
00314     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> modeForPrivilegeCheck;
00315     ULONG retryCount = 0;
00316     BOOLEAN  relativeVolumeOpen = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;     <span class="comment">// True if opening a filesystem volume</span>
00317 
00318     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00319 
00320 reparse_loop:
00321 
00322     <span class="comment">//</span>
00323     <span class="comment">// Assume failure by setting the returned object pointer to NULL.</span>
00324     <span class="comment">//</span>
00325 
00326     *Object = (PVOID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00327 
00328     <span class="comment">//</span>
00329     <span class="comment">// Get the address of the Open Packet (OP).</span>
00330     <span class="comment">//</span>
00331 
00332     op = Context;
00333 
00334     <span class="comment">//</span>
00335     <span class="comment">// Ensure that this routine is actually being invoked because someone is</span>
00336     <span class="comment">// attempting to open a device or a file through NtCreateFile.  This code</span>
00337     <span class="comment">// must be invoked from there (as opposed to some other random object</span>
00338     <span class="comment">// create or open routine).</span>
00339     <span class="comment">//</span>
00340 
00341     <span class="keywordflow">if</span> (op == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
00342         op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o0">Type</a> != <a class="code" href="../../d0/d5/io_8h.html#a7">IO_TYPE_OPEN_PACKET</a> ||
00343         op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o1">Size</a> != <span class="keyword">sizeof</span>( <a class="code" href="../../d3/d7/struct__OPEN__PACKET.html">OPEN_PACKET</a> )) {
00344 
00345         <span class="keywordflow">return</span> STATUS_OBJECT_TYPE_MISMATCH;
00346     }
00347 
00348     <span class="comment">//</span>
00349     <span class="comment">// Obtain a pointer to the parse object as a device object, which is the</span>
00350     <span class="comment">// actual type of the object anyway.</span>
00351     <span class="comment">//</span>
00352 
00353     parseDeviceObject = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) ParseObject;
00354 
00355     <span class="comment">//</span>
00356     <span class="comment">// If this is a relative open, then get the device on which the file</span>
00357     <span class="comment">// is really being opened from the related file object and use that for</span>
00358     <span class="comment">// the remainder of this function and for all operations performed on</span>
00359     <span class="comment">// the file object that is about to be created.</span>
00360     <span class="comment">//</span>
00361 
00362     <span class="keywordflow">if</span> (op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o6">RelatedFileObject</a>) {
00363         parseDeviceObject = op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o6">RelatedFileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a>;
00364     }
00365 
00366     <span class="comment">//</span>
00367     <span class="comment">// Make sure that the device and its driver are really there and they are</span>
00368     <span class="comment">// going to stay there.  The object itself cannot go away just yet because</span>
00369     <span class="comment">// the object management system has performed a reference which bumps the</span>
00370     <span class="comment">// count of the number of reasons why the object must stick around.</span>
00371     <span class="comment">// However, the driver could be attempting to unload itself, so perform</span>
00372     <span class="comment">// this check.  If the driver is being unloaded, then set the final status</span>
00373     <span class="comment">// of the operation to "No such device" and return with a NULL file object</span>
00374     <span class="comment">// pointer.</span>
00375     <span class="comment">//</span>
00376     <span class="comment">// Note that it is possible to "open" an exclusive device more than once</span>
00377     <span class="comment">// provided that the caller is performing a relative open.  This feature</span>
00378     <span class="comment">// is how users "allocate" a device, and then use it to perform operations.</span>
00379     <span class="comment">//</span>
00380 
00381     status = <a class="code" href="../../d4/d3/parse_8c.html#a3">IopCheckDeviceAndDriver</a>( op, parseDeviceObject );
00382 
00383     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00384         <span class="keywordflow">return</span> op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o3">FinalStatus</a> = status;
00385     }
00386 
00387     <span class="comment">//</span>
00388     <span class="comment">// Since ObOpenObjectByName is called without being passed</span>
00389     <span class="comment">// any object type information, we need to map the generic</span>
00390     <span class="comment">// bits in the DesiredAccess mask here.  We also need to save</span>
00391     <span class="comment">// the object's generic mapping in the access state structure</span>
00392     <span class="comment">// here, because this is the earliest opportunity we have</span>
00393     <span class="comment">// to do so.</span>
00394     <span class="comment">//</span>
00395 
00396     <a class="code" href="../../d8/d6/sertl_8c.html#a70">RtlMapGenericMask</a>( &amp;AccessState-&gt;RemainingDesiredAccess,
00397                        &amp;<a class="code" href="../../d5/d8/fssup_8c.html#a3">IoFileObjectType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> );
00398 
00399     <a class="code" href="../../d8/d6/sertl_8c.html#a70">RtlMapGenericMask</a>( &amp;AccessState-&gt;OriginalDesiredAccess,
00400                        &amp;<a class="code" href="../../d5/d8/fssup_8c.html#a3">IoFileObjectType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> );
00401 
00402     <a class="code" href="../../d2/d5/seastate_8c.html#a4">SeSetAccessStateGenericMapping</a>( AccessState, &amp;<a class="code" href="../../d5/d8/fssup_8c.html#a3">IoFileObjectType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> );
00403 
00404     desiredAccess = AccessState-&gt;RemainingDesiredAccess;
00405 
00406     <span class="comment">//</span>
00407     <span class="comment">// Compute the previous mode to be passed in to the privilege check</span>
00408     <span class="comment">//</span>
00409 
00410     <span class="keywordflow">if</span> (AccessMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> || op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o13">Options</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a104">IO_FORCE_ACCESS_CHECK</a>) {
00411         modeForPrivilegeCheck = <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>;
00412     } <span class="keywordflow">else</span> {
00413         modeForPrivilegeCheck = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
00414     }
00415 
00416     <a class="code" href="../../d4/d3/parse_8c.html#a9">IopCheckBackupRestorePrivilege</a>( AccessState,
00417                                     &amp;op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o8">CreateOptions</a>,
00418                                     modeForPrivilegeCheck,
00419                                     op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o14">Disposition</a>
00420                                     );
00421 
00422     <span class="comment">//</span>
00423     <span class="comment">// If this is not the first time through here for this object, and the</span>
00424     <span class="comment">// object itself is being opened, then the desired access must also</span>
00425     <span class="comment">// include the previously granted access from the last pass.  Likewise,</span>
00426     <span class="comment">// if the privileges have been checked already, then this is another</span>
00427     <span class="comment">// pass through for a file, so add in the previously granted access.</span>
00428     <span class="comment">//</span>
00429 
00430     <span class="keywordflow">if</span> ((op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o19">Override</a> &amp;&amp; !RemainingName-&gt;Length) ||
00431         AccessState-&gt;Flags &amp; <a class="code" href="../../d0/d5/se_8h.html#a6">SE_BACKUP_PRIVILEGES_CHECKED</a>) {
00432         desiredAccess |= AccessState-&gt;PreviouslyGrantedAccess;
00433     }
00434 
00435     <span class="comment">//</span>
00436     <span class="comment">// If its a filesystem volume open and we are doing a relative open to it</span>
00437     <span class="comment">// then do the access check. Note that relative opens can be nested and we propagate</span>
00438     <span class="comment">// the fact that the relative open is for a volume using the FO_VOLUME_OPEN flag.</span>
00439     <span class="comment">//</span>
00440 
00441     <span class="keywordflow">if</span> (op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o6">RelatedFileObject</a>) {
00442         <span class="keywordflow">if</span> ((op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o6">RelatedFileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a172">FO_VOLUME_OPEN</a>) &amp;&amp; RemainingName-&gt;Length == 0) {
00443             relativeVolumeOpen = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00444         }
00445     }
00446 
00447     <span class="comment">//</span>
00448     <span class="comment">// Now determine what type of security check should be made.  This is</span>
00449     <span class="comment">// based on whether the remaining name string is null.  If it is null,</span>
00450     <span class="comment">// then the device itself is being opened, so a full security check is</span>
00451     <span class="comment">// performed.  Otherwise, only a check to ensure that the caller can</span>
00452     <span class="comment">// traverse the device object is made.  Note that these checks are only</span>
00453     <span class="comment">// made if the caller's mode is user, or if access checking is being</span>
00454     <span class="comment">// forced.  Note also that if an access check was already made on the</span>
00455     <span class="comment">// device itself, and this code is being executed again because of a</span>
00456     <span class="comment">// reparse, then the access check need not be made the second time</span>
00457     <span class="comment">// around.</span>
00458     <span class="comment">//</span>
00459 
00460 
00461     <span class="keywordflow">if</span> ((AccessMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> || op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o13">Options</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a104">IO_FORCE_ACCESS_CHECK</a>) &amp;&amp;
00462         (!op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o6">RelatedFileObject</a> || relativeVolumeOpen) &amp;&amp;
00463         !op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o19">Override</a>) {
00464 
00465         BOOLEAN subjectContextLocked = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00466         BOOLEAN accessGranted;
00467         ACCESS_MASK grantedAccess;
00468 
00469         <span class="comment">//</span>
00470         <span class="comment">// The caller's mode is either user or access checking is being</span>
00471         <span class="comment">// forced.  Perform the appropriate access check on the device</span>
00472         <span class="comment">// object.</span>
00473         <span class="comment">//</span>
00474 
00475         <span class="keywordflow">if</span> (!RemainingName-&gt;Length) {
00476 
00477             UNICODE_STRING nameString;
00478             PPRIVILEGE_SET privileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00479 
00480             <span class="comment">//</span>
00481             <span class="comment">// The device itself is being opened.  Make a full security check</span>
00482             <span class="comment">// to ensure that the caller has the appropriate access.</span>
00483             <span class="comment">//</span>
00484 
00485             <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>( );
00486             <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( &amp;IopSecurityResource, TRUE );
00487 
00488             <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
00489             subjectContextLocked = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00490 
00491             accessGranted = <a class="code" href="../../d0/d4/accessck_8c.html#a18">SeAccessCheck</a>( parseDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o21">SecurityDescriptor</a>,
00492                                            &amp;AccessState-&gt;SubjectSecurityContext,
00493                                            subjectContextLocked,
00494                                            desiredAccess,
00495                                            0,
00496                                            &amp;privileges,
00497                                            &amp;<a class="code" href="../../d5/d8/fssup_8c.html#a3">IoFileObjectType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>,
00498                                            UserMode,
00499                                            &amp;grantedAccess,
00500                                            &amp;status );
00501 
00502             <span class="keywordflow">if</span> (privileges) {
00503                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d2/d5/seastate_8c.html#a5">SeAppendPrivileges</a>( AccessState,
00504                                            privileges );
00505                 <a class="code" href="../../d0/d4/accessck_8c.html#a17">SeFreePrivileges</a>( privileges );
00506             }
00507 
00508             <span class="keywordflow">if</span> (accessGranted) {
00509                 AccessState-&gt;PreviouslyGrantedAccess |= grantedAccess;
00510                 AccessState-&gt;RemainingDesiredAccess &amp;= ~( grantedAccess | MAXIMUM_ALLOWED );
00511                 op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o19">Override</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00512             }
00513 
00514             nameString.Length = 8;
00515             nameString.MaximumLength = 8;
00516             nameString.Buffer = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"File"</span>;
00517 
00518             <a class="code" href="../../d3/d5/seaudit_8c.html#a23">SeOpenObjectAuditAlarm</a>( &amp;nameString,
00519                                     parseDeviceObject,
00520                                     CompleteName,
00521                                     parseDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o21">SecurityDescriptor</a>,
00522                                     AccessState,
00523                                     FALSE,
00524                                     accessGranted,
00525                                     UserMode,
00526                                     &amp;AccessState-&gt;GenerateOnClose );
00527 
00528             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( &amp;IopSecurityResource );
00529             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00530 
00531         } <span class="keywordflow">else</span> {
00532 
00533             <span class="comment">//</span>
00534             <span class="comment">// The device is not being opened, rather, a file on the device</span>
00535             <span class="comment">// is being opened or created.  Therefore, only perform a check</span>
00536             <span class="comment">// here for traverse access to the device.</span>
00537             <span class="comment">//</span>
00538 
00539             <span class="comment">//</span>
00540             <span class="comment">// First determine if we have to perform traverse checking at all.</span>
00541             <span class="comment">// Traverse checking only needs to be done if the device being</span>
00542             <span class="comment">// traversed is a disk, or if the caller does not already have</span>
00543             <span class="comment">// traverse checking privilege.  Note that the former case is so</span>
00544             <span class="comment">// that an administrator can turn off access to the "system</span>
00545             <span class="comment">// partition", or someone would be able to install a trojan horse</span>
00546             <span class="comment">// into the system by simply replacing one of the files there with</span>
00547             <span class="comment">// something of their own.</span>
00548             <span class="comment">//</span>
00549 
00550             <span class="keywordflow">if</span> (!(AccessState-&gt;Flags &amp; <a class="code" href="../../d0/d5/se_8h.html#a1">TOKEN_HAS_TRAVERSE_PRIVILEGE</a>) ||
00551                 parseDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o12">DeviceType</a> == FILE_DEVICE_DISK ||
00552                 parseDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o12">DeviceType</a> == FILE_DEVICE_CD_ROM ) {
00553 
00554                 <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>( );
00555                 <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( &amp;IopSecurityResource, TRUE );
00556 
00557                 <span class="comment">//</span>
00558                 <span class="comment">// If the token is restricted we need to do the full</span>
00559                 <span class="comment">// access check.</span>
00560                 <span class="comment">//</span>
00561 
00562                 <span class="keywordflow">if</span> ((AccessState-&gt;Flags &amp; <a class="code" href="../../d0/d5/se_8h.html#a5">TOKEN_IS_RESTRICTED</a>) == 0) {
00563                     accessGranted = <a class="code" href="../../d0/d4/accessck_8c.html#a22">SeFastTraverseCheck</a>( parseDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o21">SecurityDescriptor</a>,
00564                                                          FILE_TRAVERSE,
00565                                                          UserMode );
00566                 } <span class="keywordflow">else</span> {
00567                     accessGranted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00568                 }
00569 
00570                 <span class="keywordflow">if</span> (!accessGranted) {
00571 
00572                     PPRIVILEGE_SET privileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00573 
00574                     <span class="comment">//</span>
00575                     <span class="comment">// The caller was not granted traverse access through the</span>
00576                     <span class="comment">// normal fast path lookup.  Perform a full-blown access</span>
00577                     <span class="comment">// check to determine whether some other ACE allows traverse</span>
00578                     <span class="comment">// access.</span>
00579                     <span class="comment">//</span>
00580 
00581                     <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
00582 
00583                     subjectContextLocked = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00584 
00585                     accessGranted = <a class="code" href="../../d0/d4/accessck_8c.html#a18">SeAccessCheck</a>( parseDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o21">SecurityDescriptor</a>,
00586                                                    &amp;AccessState-&gt;SubjectSecurityContext,
00587                                                    subjectContextLocked,
00588                                                    FILE_TRAVERSE,
00589                                                    0,
00590                                                    &amp;privileges,
00591                                                    &amp;<a class="code" href="../../d5/d8/fssup_8c.html#a3">IoFileObjectType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>,
00592                                                    UserMode,
00593                                                    &amp;grantedAccess,
00594                                                    &amp;status );
00595 
00596                     <span class="keywordflow">if</span> (privileges) {
00597 
00598                         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d2/d5/seastate_8c.html#a5">SeAppendPrivileges</a>( AccessState,
00599                                                    privileges );
00600                         <a class="code" href="../../d0/d4/accessck_8c.html#a17">SeFreePrivileges</a>( privileges );
00601                     }
00602 
00603                 }
00604 
00605                 <span class="comment">//</span>
00606                 <span class="comment">// Perform the traverse audit alarm if necessary.</span>
00607                 <span class="comment">//</span>
00608 
00609                 <a class="code" href="../../d3/d5/seaudit_8c.html#a25">SeTraverseAuditAlarm</a>( &amp;AccessState-&gt;OperationID,
00610                                       parseDeviceObject,
00611                                       parseDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o21">SecurityDescriptor</a>,
00612                                       &amp;AccessState-&gt;SubjectSecurityContext,
00613                                       subjectContextLocked,
00614                                       FILE_TRAVERSE,
00615                                       (PPRIVILEGE_SET) NULL,
00616                                       accessGranted,
00617                                       UserMode );
00618                 <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( &amp;IopSecurityResource );
00619                 <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00620 
00621             } <span class="keywordflow">else</span> {
00622 
00623                     accessGranted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00624             }
00625         }
00626 
00627         <span class="comment">//</span>
00628         <span class="comment">// Unlock the subject's security context so that it can be changed,</span>
00629         <span class="comment">// if it was locked.</span>
00630         <span class="comment">//</span>
00631 
00632         <span class="keywordflow">if</span> (subjectContextLocked) {
00633             <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
00634         }
00635 
00636         <span class="comment">//</span>
00637         <span class="comment">// Finally, determine whether or not access was granted to the device.</span>
00638         <span class="comment">// If not, clean everything up and get out now without even invoking</span>
00639         <span class="comment">// the device driver.</span>
00640         <span class="comment">//</span>
00641 
00642         <span class="keywordflow">if</span> (!accessGranted) {
00643 
00644             <a class="code" href="../../d0/d6/iop_8h.html#a161">IopDecrementDeviceObjectRef</a>( parseDeviceObject, FALSE );
00645             <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00646         }
00647 
00648     }
00649 
00650     realFileObjectRequired = !(op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o20">QueryOnly</a> || op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o21">DeleteOnly</a>);
00651 
00652     <span class="keywordflow">if</span> (RemainingName-&gt;Length == 0 &amp;&amp;
00653         op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o6">RelatedFileObject</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00654         ((desiredAccess &amp; ~(SYNCHRONIZE |
00655                             FILE_READ_ATTRIBUTES |
00656                             READ_CONTROL |
00657                             ACCESS_SYSTEM_SECURITY |
00658                             WRITE_OWNER |
00659                             WRITE_DAC)) == 0) &amp;&amp;
00660         realFileObjectRequired) {
00661 
00662         <span class="comment">//</span>
00663         <span class="comment">// If the name of the object being opened is just the name of the</span>
00664         <span class="comment">// device itself, and there is no related file object, and the caller</span>
00665         <span class="comment">// is opening the device for only read attributes access, then this</span>
00666         <span class="comment">// device will not be mounted.  This allows applications to obtain</span>
00667         <span class="comment">// attributes about the device without actually mounting it.</span>
00668         <span class="comment">//</span>
00669         <span class="comment">// Note that if this *is* a direct device open, then the normal path</span>
00670         <span class="comment">// through the I/O system and drivers may never be used, even if</span>
00671         <span class="comment">// the device appears to be mounted.  This is because the user may</span>
00672         <span class="comment">// remove the media from the drive (even though it is mounted), and</span>
00673         <span class="comment">// now attempting to determine what type of drive it is will still</span>
00674         <span class="comment">// fail, this time very hard, because a whole mount process is now</span>
00675         <span class="comment">// required, thus defeating this feature.</span>
00676         <span class="comment">//</span>
00677 
00678         directDeviceOpen = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00679 
00680     } <span class="keywordflow">else</span> {
00681 
00682         <span class="comment">//</span>
00683         <span class="comment">// Otherwise, this is a normal open of a file, directory, device, or</span>
00684         <span class="comment">// volume.</span>
00685         <span class="comment">//</span>
00686 
00687         directDeviceOpen = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00688     }
00689 
00690     <span class="comment">//</span>
00691     <span class="comment">// There are now five different cases.  These are as follows:</span>
00692     <span class="comment">//</span>
00693     <span class="comment">//    1)  This is a relative open, in which case we want to send the</span>
00694     <span class="comment">//        request to then same device that opened the relative file object.</span>
00695     <span class="comment">//</span>
00696     <span class="comment">//    2)  The VPB pointer in the device object is NULL.  This means that</span>
00697     <span class="comment">//        this device does not support a file system.  This includes</span>
00698     <span class="comment">//        devices such as terminals, etc.</span>
00699     <span class="comment">//</span>
00700     <span class="comment">//    3)  The VPB pointer in the device object is not NULL and:</span>
00701     <span class="comment">//</span>
00702     <span class="comment">//        a)  The VPB is "blank".  That is, the VPB has never been filled</span>
00703     <span class="comment">//            in, which means that the device has never been mounted.</span>
00704     <span class="comment">//</span>
00705     <span class="comment">//        b)  The VPB is non-blank, but the verify flag on the device is</span>
00706     <span class="comment">//            set, indicating that the door to the drive may have been</span>
00707     <span class="comment">//            opened and the media may therefore have been changed.</span>
00708     <span class="comment">//</span>
00709     <span class="comment">//        c)  The VPB is non-blank and the verify flag is not set.</span>
00710     <span class="comment">//</span>
00711     <span class="comment">//        Both of the latter are not explicitly checked for, as #c is</span>
00712     <span class="comment">//        the normal case, and #b is the responsibility of the file</span>
00713     <span class="comment">//        system to check.</span>
00714     <span class="comment">//</span>
00715 
00716     <span class="comment">//</span>
00717     <span class="comment">//  If this is a file system that supports volumes, vpbRefCount will</span>
00718     <span class="comment">//  be filled in to point to the reference count in the Vpb.  Error</span>
00719     <span class="comment">//  exits paths later on key off this value to see if they should</span>
00720     <span class="comment">//  decrement the ref count.  Note that a direct device open does not</span>
00721     <span class="comment">//  make it to the file system, so no increment is needed, and no</span>
00722     <span class="comment">//  decrement will be performed in objsup.c IopDeleteFile().</span>
00723     <span class="comment">//</span>
00724 
00725     vpb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00726 
00727     <span class="comment">//</span>
00728     <span class="comment">// If the related open was a direct device open then we should go through the full mount </span>
00729     <span class="comment">// path for this open as this may not be a direct device open.</span>
00730     <span class="comment">//</span>
00731     <span class="keywordflow">if</span> (op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o6">RelatedFileObject</a> &amp;&amp; (!(op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o6">RelatedFileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a161">FO_DIRECT_DEVICE_OPEN</a>))) {
00732 
00733         deviceObject = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)ParseObject;
00734 
00735         <span class="keywordflow">if</span> (op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o6">RelatedFileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o3">Vpb</a>) {
00736 
00737             vpb = op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o6">RelatedFileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o3">Vpb</a>;
00738 
00739             <span class="comment">//</span>
00740             <span class="comment">// Synchronize here with the file system to make sure that</span>
00741             <span class="comment">// volumes don't go away while en route to the FS.</span>
00742             <span class="comment">//</span>
00743 
00744             <a class="code" href="../../d5/d8/ex_8h.html#a235">ExInterlockedAddUlong</a>( &amp;vpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o7">ReferenceCount</a>, 1, &amp;IopVpbSpinLock );
00745         }
00746 
00747     } <span class="keywordflow">else</span> {
00748 
00749         deviceObject = parseDeviceObject;
00750 
00751         <span class="keywordflow">if</span> (parseDeviceObject-&gt;Vpb &amp;&amp; !directDeviceOpen) {
00752             vpb = <a class="code" href="../../d4/d3/parse_8c.html#a4">IopCheckVpbMounted</a>( op,
00753                                       parseDeviceObject,
00754                                       RemainingName,
00755                                       &amp;status );
00756             <span class="keywordflow">if</span> ( !vpb ) {
00757                 <span class="keywordflow">return</span> status;
00758             }
00759 
00760             <span class="comment">//</span>
00761             <span class="comment">// Set the address of the device object associated with the VPB.</span>
00762             <span class="comment">//</span>
00763 
00764             deviceObject = vpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o4">DeviceObject</a>;
00765         }
00766 
00767         <span class="comment">//</span>
00768         <span class="comment">// Walk the attached device list.</span>
00769         <span class="comment">//</span>
00770 
00771         <span class="keywordflow">if</span> (deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>) {
00772             deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a66">IoGetAttachedDevice</a>( deviceObject );
00773         }
00774     }
00775 
00776     <span class="comment">//</span>
00777     <span class="comment">//  If the driver says that the IO manager should do the access checks, lets do it here.</span>
00778     <span class="comment">//  We do the check against the parse device object as that device object has a name</span>
00779     <span class="comment">//  and we can set an ACL against it.</span>
00780     <span class="comment">//  We only worry about related opens of devices as the other case is taken care of in the</span>
00781     <span class="comment">//  filesystem.</span>
00782     <span class="comment">//</span>
00783     <span class="keywordflow">if</span> ((deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o9">Characteristics</a> &amp; FILE_DEVICE_SECURE_OPEN) &amp;&amp;
00784         (op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o6">RelatedFileObject</a> || RemainingName-&gt;Length) &amp;&amp;  (!relativeVolumeOpen)) {
00785 
00786         BOOLEAN subjectContextLocked = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00787         BOOLEAN accessGranted;
00788         ACCESS_MASK grantedAccess;
00789         UNICODE_STRING nameString;
00790         PPRIVILEGE_SET privileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00791 
00792         <span class="comment">//</span>
00793         <span class="comment">// If the device wants to ensure secure opens then lets check the two</span>
00794         <span class="comment">// cases which were skipped earlier. These cases are if its a relative</span>
00795         <span class="comment">// open or if there are trailing names.</span>
00796         <span class="comment">//</span>
00797 
00798         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>( );
00799         <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( &amp;IopSecurityResource, TRUE );
00800 
00801         <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
00802         subjectContextLocked = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00803 
00804         accessGranted = <a class="code" href="../../d0/d4/accessck_8c.html#a18">SeAccessCheck</a>( parseDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o21">SecurityDescriptor</a>,
00805                                        &amp;AccessState-&gt;SubjectSecurityContext,
00806                                        subjectContextLocked,
00807                                        desiredAccess,
00808                                        0,
00809                                        &amp;privileges,
00810                                        &amp;<a class="code" href="../../d5/d8/fssup_8c.html#a3">IoFileObjectType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>,
00811                                        UserMode,
00812                                        &amp;grantedAccess,
00813                                        &amp;status );
00814 
00815         <span class="keywordflow">if</span> (privileges) {
00816             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d2/d5/seastate_8c.html#a5">SeAppendPrivileges</a>( AccessState,
00817                                        privileges );
00818             <a class="code" href="../../d0/d4/accessck_8c.html#a17">SeFreePrivileges</a>( privileges );
00819         }
00820 
00821         <span class="keywordflow">if</span> (accessGranted) {
00822             AccessState-&gt;PreviouslyGrantedAccess |= grantedAccess;
00823             AccessState-&gt;RemainingDesiredAccess &amp;= ~( grantedAccess | MAXIMUM_ALLOWED );
00824         }
00825 
00826         nameString.Length = 8;
00827         nameString.MaximumLength = 8;
00828         nameString.Buffer = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"File"</span>;
00829 
00830         <a class="code" href="../../d3/d5/seaudit_8c.html#a23">SeOpenObjectAuditAlarm</a>( &amp;nameString,
00831                                 deviceObject,
00832                                 CompleteName,
00833                                 parseDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o21">SecurityDescriptor</a>,
00834                                 AccessState,
00835                                 FALSE,
00836                                 accessGranted,
00837                                 UserMode,
00838                                 &amp;AccessState-&gt;GenerateOnClose );
00839 
00840         <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
00841         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( &amp;IopSecurityResource );
00842         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00843 
00844         <span class="keywordflow">if</span> (!accessGranted) {
00845             <a class="code" href="../../d0/d6/iop_8h.html#a161">IopDecrementDeviceObjectRef</a>( parseDeviceObject, FALSE );
00846 
00847             <span class="keywordflow">if</span> (vpb) {
00848                 <a class="code" href="../../d4/d3/parse_8c.html#a5">IopDereferenceVpbAndFree</a>(vpb);
00849             }
00850             <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00851         }
00852     }
00853 
00854     <span class="comment">//</span>
00855     <span class="comment">// Allocate and fill in the I/O Request Packet (IRP) to use in interfacing</span>
00856     <span class="comment">// to the driver.  The allocation is done using an exception handler in</span>
00857     <span class="comment">// case the caller does not have enough quota to allocate the packet.</span>
00858     <span class="comment">//</span>
00859 
00860     irp = <a class="code" href="../../d0/d6/iop_8h.html#a16">IopAllocateIrp</a>( deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>, TRUE );
00861     <span class="keywordflow">if</span> (!irp) {
00862 
00863         <span class="comment">//</span>
00864         <span class="comment">// An IRP could not be allocated.  Cleanup and return an appropriate</span>
00865         <span class="comment">// error status code.</span>
00866         <span class="comment">//</span>
00867 
00868         <a class="code" href="../../d0/d6/iop_8h.html#a161">IopDecrementDeviceObjectRef</a>( parseDeviceObject, FALSE );
00869 
00870         <span class="keywordflow">if</span> (vpb) {
00871             <a class="code" href="../../d4/d3/parse_8c.html#a5">IopDereferenceVpbAndFree</a>(vpb);
00872         }
00873         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00874     }
00875     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00876     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = AccessMode;
00877     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a182">IRP_CREATE_OPERATION</a> | <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a> | <a class="code" href="../../d0/d5/io_8h.html#a186">IRP_DEFER_IO_COMPLETION</a>;
00878 
00879     securityContext.<a class="code" href="../../d1/d5/struct__IO__SECURITY__CONTEXT.html#o0">SecurityQos</a> = <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a14">SecurityQos</a>;
00880     securityContext.<a class="code" href="../../d1/d5/struct__IO__SECURITY__CONTEXT.html#o1">AccessState</a> = AccessState;
00881     securityContext.<a class="code" href="../../d1/d5/struct__IO__SECURITY__CONTEXT.html#o2">DesiredAccess</a> = desiredAccess;
00882     securityContext.<a class="code" href="../../d1/d5/struct__IO__SECURITY__CONTEXT.html#o3">FullCreateOptions</a> = op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o8">CreateOptions</a>;
00883 
00884     <span class="comment">//</span>
00885     <span class="comment">// Get a pointer to the stack location for the first driver.  This is where</span>
00886     <span class="comment">// the original function codes and parameters are passed.</span>
00887     <span class="comment">//</span>
00888 
00889     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
00890     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o3">Control</a> = 0;
00891 
00892     <span class="keywordflow">if</span> (op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o17">CreateFileType</a> == <a class="code" href="../../d0/d5/io_8h.html#a600a406">CreateFileTypeNone</a>) {
00893 
00894         <span class="comment">//</span>
00895         <span class="comment">// This is a normal file open or create function.</span>
00896         <span class="comment">//</span>
00897 
00898         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a>;
00899         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.EaLength = op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o12">EaLength</a>;
00900         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a> = (UCHAR) op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o13">Options</a>;
00901         <span class="keywordflow">if</span> (!(Attributes &amp; OBJ_CASE_INSENSITIVE)) {
00902             irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a201">SL_CASE_SENSITIVE</a>;
00903         }
00904 
00905     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o17">CreateFileType</a> == <a class="code" href="../../d0/d5/io_8h.html#a600a407">CreateFileTypeNamedPipe</a>) {
00906 
00907         <span class="comment">//</span>
00908         <span class="comment">// A named pipe is being created.</span>
00909         <span class="comment">//</span>
00910 
00911         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a14">IRP_MJ_CREATE_NAMED_PIPE</a>;
00912         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.CreatePipe.Parameters = op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o18">ExtraCreateParameters</a>;
00913 
00914     } <span class="keywordflow">else</span> {
00915 
00916         <span class="comment">//</span>
00917         <span class="comment">// A mailslot is being created.</span>
00918         <span class="comment">//</span>
00919 
00920         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a32">IRP_MJ_CREATE_MAILSLOT</a>;
00921         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.CreateMailslot.Parameters = op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o18">ExtraCreateParameters</a>;
00922     }
00923 
00924     <span class="comment">//</span>
00925     <span class="comment">// Also fill in the NtCreateFile service's caller's parameters.</span>
00926     <span class="comment">//</span>
00927 
00928     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AllocationSize = op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o7">AllocationSize</a>;
00929     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o11">EaBuffer</a>;
00930     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options = (op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o14">Disposition</a> &lt;&lt; 24) | (op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o8">CreateOptions</a> &amp; 0x00ffffff);
00931     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.FileAttributes = op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o9">FileAttributes</a>;
00932     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.ShareAccess = op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o10">ShareAccess</a>;
00933     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.SecurityContext = &amp;securityContext;
00934 
00935     <span class="comment">//</span>
00936     <span class="comment">// Fill in local parameters so this routine can determine when the I/O is</span>
00937     <span class="comment">// finished, and the normal I/O completion code will not get any errors.</span>
00938     <span class="comment">//</span>
00939 
00940     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;ioStatus;
00941     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00942     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o11">PendingReturned</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00943     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00944     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00945     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o25">CancelRoutine</a> = (<a class="code" href="../../d0/d5/io_8h.html#a286">PDRIVER_CANCEL</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00946     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.AuxiliaryBuffer = (PVOID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00947 
00948     <span class="comment">//</span>
00949     <span class="comment">// Allocate and initialize the file object that will be used in dealing</span>
00950     <span class="comment">// with the device for the remainder of this session with the user.  How</span>
00951     <span class="comment">// the file object is allocated is based on whether or not a real file</span>
00952     <span class="comment">// object is actually required.  It is not required for the query and</span>
00953     <span class="comment">// delete only operations.</span>
00954     <span class="comment">//</span>
00955 
00956     <span class="keywordflow">if</span> (realFileObjectRequired) {
00957 
00958         OBJECT_ATTRIBUTES objectAttributes;
00959 
00960         <span class="comment">//</span>
00961         <span class="comment">// A real, full-blown file object is actually required.</span>
00962         <span class="comment">//</span>
00963 
00964         InitializeObjectAttributes( &amp;objectAttributes,
00965                                     (PUNICODE_STRING) NULL,
00966                                     Attributes,
00967                                     (HANDLE) NULL,
00968                                     (PSECURITY_DESCRIPTOR) NULL
00969                                   );
00970 
00971         status = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>( KernelMode,
00972                                  IoFileObjectType,
00973                                  &amp;objectAttributes,
00974                                  AccessMode,
00975                                  (PVOID) NULL,
00976                                  (ULONG) <span class="keyword">sizeof</span>( <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">FILE_OBJECT</a> ),
00977                                  0,
00978                                  0,
00979                                  (PVOID *) &amp;fileObject );
00980 
00981         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00982             <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>( irp );
00983 
00984             <a class="code" href="../../d0/d6/iop_8h.html#a161">IopDecrementDeviceObjectRef</a>( parseDeviceObject, FALSE );
00985 
00986             <span class="keywordflow">if</span> (vpb) {
00987                <a class="code" href="../../d4/d3/parse_8c.html#a5">IopDereferenceVpbAndFree</a>(vpb);
00988             }
00989             <span class="keywordflow">return</span> op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o3">FinalStatus</a> = status;
00990         }
00991 
00992         RtlZeroMemory( fileObject, <span class="keyword">sizeof</span>( FILE_OBJECT ) );
00993         fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o0">Type</a> = <a class="code" href="../../d0/d5/io_8h.html#a4">IO_TYPE_FILE</a>;
00994         fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o1">Size</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d5/io_8h.html#a353">FILE_OBJECT</a> );
00995         fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o9">RelatedFileObject</a> = op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o6">RelatedFileObject</a>;
00996         <span class="keywordflow">if</span> (op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o8">CreateOptions</a> &amp; (FILE_SYNCHRONOUS_IO_ALERT | FILE_SYNCHRONOUS_IO_NONALERT)) {
00997             fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>;
00998             <span class="keywordflow">if</span> (op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o8">CreateOptions</a> &amp; FILE_SYNCHRONOUS_IO_ALERT) {
00999                 fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a152">FO_ALERTABLE_IO</a>;
01000             }
01001         }
01002 
01003         <span class="comment">//</span>
01004         <span class="comment">// Now fill in the file object as best is possible at this point and set</span>
01005         <span class="comment">// a pointer to it in the IRP so everyone else can find it.</span>
01006         <span class="comment">//</span>
01007 
01008         <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
01009             <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o24">Lock</a>, SynchronizationEvent, FALSE );
01010             fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o21">Waiters</a> = 0;
01011             fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o20">CurrentByteOffset</a>.QuadPart = 0;
01012         }
01013         <span class="keywordflow">if</span> (op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o8">CreateOptions</a> &amp; FILE_NO_INTERMEDIATE_BUFFERING) {
01014             fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a153">FO_NO_INTERMEDIATE_BUFFERING</a>;
01015         }
01016         <span class="keywordflow">if</span> (op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o8">CreateOptions</a> &amp; FILE_WRITE_THROUGH) {
01017             fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a154">FO_WRITE_THROUGH</a>;
01018         }
01019         <span class="keywordflow">if</span> (op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o8">CreateOptions</a> &amp; FILE_SEQUENTIAL_ONLY) {
01020             fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a155">FO_SEQUENTIAL_ONLY</a>;
01021         }
01022         <span class="keywordflow">if</span> (op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o8">CreateOptions</a> &amp; FILE_RANDOM_ACCESS) {
01023             fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a170">FO_RANDOM_ACCESS</a>;
01024         }
01025 
01026     } <span class="keywordflow">else</span> {
01027 
01028         <span class="comment">//</span>
01029         <span class="comment">// This is either a quick delete or query operation.  For these cases,</span>
01030         <span class="comment">// it is possible to optimize the Object Manager out of the picture by</span>
01031         <span class="comment">// simply putting together something that "looks" like a file object,</span>
01032         <span class="comment">// and then operating on it.</span>
01033         <span class="comment">//</span>
01034 
01035         localFileObject = op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o23">LocalFileObject</a>;
01036         RtlZeroMemory( localFileObject, <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d1/struct__DUMMY__FILE__OBJECT.html">DUMMY_FILE_OBJECT</a> ) );
01037         fileObject = (<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>) &amp;localFileObject-&gt;<a class="code" href="../../d0/d1/struct__DUMMY__FILE__OBJECT.html#o0">ObjectHeader</a>.<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o11">Body</a>;
01038         localFileObject-&gt;<a class="code" href="../../d0/d1/struct__DUMMY__FILE__OBJECT.html#o0">ObjectHeader</a>.<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> = <a class="code" href="../../d5/d8/fssup_8c.html#a3">IoFileObjectType</a>;
01039         localFileObject-&gt;<a class="code" href="../../d0/d1/struct__DUMMY__FILE__OBJECT.html#o0">ObjectHeader</a>.<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o0">PointerCount</a> = 1;
01040     }
01041 
01042     <span class="keywordflow">if</span> (directDeviceOpen) {
01043         fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a161">FO_DIRECT_DEVICE_OPEN</a>;
01044     }
01045     <span class="keywordflow">if</span> (!(Attributes &amp; OBJ_CASE_INSENSITIVE)) {
01046         fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a167">FO_OPENED_CASE_SENSITIVE</a>;
01047     }
01048 
01049     fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o0">Type</a> = <a class="code" href="../../d0/d5/io_8h.html#a4">IO_TYPE_FILE</a>;
01050     fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o1">Size</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d5/io_8h.html#a353">FILE_OBJECT</a> );
01051     fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o9">RelatedFileObject</a> = op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o6">RelatedFileObject</a>;
01052     fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a> = parseDeviceObject;
01053 
01054     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = fileObject;
01055     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = fileObject;
01056 
01057     <span class="comment">//</span>
01058     <span class="comment">// Allocate a file name string buffer which is large enough to contain</span>
01059     <span class="comment">// the entire remaining name string and initialize the maximum length.</span>
01060     <span class="comment">//</span>
01061 
01062     <span class="keywordflow">if</span> (RemainingName-&gt;Length) {
01063         fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.MaximumLength = <a class="code" href="../../d4/d3/parse_8c.html#a0">RoundNameSize</a>( RemainingName-&gt;Length );
01064         fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool,
01065                                                              fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.MaximumLength,
01066                                                              'mNoI' );
01067         <span class="keywordflow">if</span> (!fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.Buffer) {
01068             <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>( irp );
01069 
01070             <a class="code" href="../../d0/d6/iop_8h.html#a161">IopDecrementDeviceObjectRef</a>( parseDeviceObject, FALSE );
01071 
01072             <span class="keywordflow">if</span> (vpb) {
01073                <a class="code" href="../../d4/d3/parse_8c.html#a5">IopDereferenceVpbAndFree</a>(vpb);
01074             }
01075             fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a> = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01076             <span class="keywordflow">if</span> (realFileObjectRequired) {
01077                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
01078             }
01079             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01080         }
01081     }
01082 
01083     <span class="comment">//</span>
01084     <span class="comment">// Now copy the name string into the file object from the remaining name</span>
01085     <span class="comment">// that is being reparsed.  If the driver decides to reparse, then it must</span>
01086     <span class="comment">// replace this name.</span>
01087     <span class="comment">//</span>
01088 
01089     <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>, RemainingName );
01090 
01091     <span class="comment">//</span>
01092     <span class="comment">// Before invoking the driver's open routine, check to see whether or not</span>
01093     <span class="comment">// this is a fast network attributes query and, if so, and the driver</span>
01094     <span class="comment">// implements the function, attempt to call it here.</span>
01095     <span class="comment">//</span>
01096 
01097     <span class="keywordflow">if</span> (op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o20">QueryOnly</a>) {
01098         <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> fastIoDispatch = deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
01099         BOOLEAN result;
01100 
01101         <span class="keywordflow">if</span> (fastIoDispatch &amp;&amp;
01102             fastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt; FIELD_OFFSET( <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, FastIoQueryOpen ) &amp;&amp;
01103             fastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o24">FastIoQueryOpen</a>) {
01104 
01105             <a class="code" href="../../d0/d5/io_8h.html#a238">IoSetNextIrpStackLocation</a>( irp );
01106             irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o57">DeviceObject</a> = deviceObject;
01107             result = (fastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o24">FastIoQueryOpen</a>)( irp,
01108                                                         op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o16">NetworkInformation</a>,
01109                                                         deviceObject );
01110             <span class="keywordflow">if</span> (result) {
01111                 op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o3">FinalStatus</a> = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
01112                 op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o4">Information</a> = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information;
01113 
01114                 <span class="comment">//</span>
01115                 <span class="comment">// The operation worked, so simply dereference and free the</span>
01116                 <span class="comment">// resources acquired up to this point.</span>
01117                 <span class="comment">//</span>
01118 
01119                 <span class="keywordflow">if</span> ((op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o3">FinalStatus</a> == STATUS_REPARSE) &amp;&amp;
01120                     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.AuxiliaryBuffer) {
01121                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o4">Information</a> &gt; IO_REPARSE_TAG_RESERVED_ONE );
01122                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.AuxiliaryBuffer );
01123                     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.AuxiliaryBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01124                     op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o6">RelatedFileObject</a> = (<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01125                 }
01126 
01127                 <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.Length) {
01128                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.Buffer );
01129                 }
01130 
01131                 <a class="code" href="../../d0/d6/iop_8h.html#a161">IopDecrementDeviceObjectRef</a>( parseDeviceObject, FALSE );
01132 
01133                 <span class="keywordflow">if</span> (vpb) {
01134                     <a class="code" href="../../d4/d3/parse_8c.html#a5">IopDereferenceVpbAndFree</a>(vpb);
01135                 }
01136 
01137 <span class="preprocessor">#if DBG</span>
01138 <span class="preprocessor"></span>                irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a> = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o12">StackCount</a> + 2;
01139 <span class="preprocessor">#endif // DBG</span>
01140 <span class="preprocessor"></span>
01141                 <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>( irp );
01142 
01143                 <span class="comment">//</span>
01144                 <span class="comment">// Finally, indicate that the parse routine was actually</span>
01145                 <span class="comment">// invoked and that the information returned herein can be</span>
01146                 <span class="comment">// used.</span>
01147                 <span class="comment">//</span>
01148 
01149                 op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o5">ParseCheck</a> = <a class="code" href="../../d0/d6/iop_8h.html#a3">OPEN_PACKET_PATTERN</a>;
01150                 status = STATUS_SUCCESS;
01151 
01152                 <span class="keywordflow">if</span> (!op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o22">FullAttributes</a>) {
01153                     <span class="keywordflow">try</span> {
01154                         op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o15">BasicInformation</a>-&gt;FileAttributes = op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o16">NetworkInformation</a>-&gt;FileAttributes;
01155                     } except(EXCEPTION_EXECUTE_HANDLER) {
01156                         status = GetExceptionCode();
01157                     }
01158                 }
01159 
01160                 <span class="keywordflow">return</span> status;
01161 
01162             } <span class="keywordflow">else</span> {
01163 
01164                 <span class="comment">//</span>
01165                 <span class="comment">// The fast I/O operation did not work, so take the longer</span>
01166                 <span class="comment">// route.</span>
01167                 <span class="comment">//</span>
01168 
01169                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.CurrentStackLocation++;
01170                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a>++;
01171             }
01172         }
01173     }
01174 
01175     <span class="comment">//</span>
01176     <span class="comment">// Finally, initialize the file object's event to the Not Signaled state</span>
01177     <span class="comment">// and remember that a file object was created.</span>
01178     <span class="comment">//</span>
01179 
01180     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a>, NotificationEvent, FALSE );
01181     op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o2">FileObject</a> = fileObject;
01182 
01183     <span class="comment">//</span>
01184     <span class="comment">// Insert the packet at the head of the IRP list for the thread.</span>
01185     <span class="comment">//</span>
01186 
01187     <a class="code" href="../../d0/d6/iop_8h.html#a21">IopQueueThreadIrp</a>( irp );
01188 
01189     <span class="comment">//</span>
01190     <span class="comment">// Now invoke the driver itself to open the file.</span>
01191     <span class="comment">//</span>
01192 
01193     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject, irp );
01194 
01195     <span class="comment">//</span>
01196     <span class="comment">// One of four things may have happened when the driver was invoked:</span>
01197     <span class="comment">//</span>
01198     <span class="comment">//    1.  The I/O operation is pending (Status == STATUS_PENDING).  This can</span>
01199     <span class="comment">//        occur on devices which need to perform some sort of device</span>
01200     <span class="comment">//        manipulation (such as opening a file for a file system).</span>
01201     <span class="comment">//</span>
01202     <span class="comment">//    2.  The driver returned an error (Status &lt; 0). This occurs when either</span>
01203     <span class="comment">//        a supplied parameter was in error, or the device or file system</span>
01204     <span class="comment">//        incurred or discovered an error.</span>
01205     <span class="comment">//</span>
01206     <span class="comment">//    3.  The operation ended in a reparse (Status == STATUS_REPARSE).  This</span>
01207     <span class="comment">//        occurs when a file system opens the file, only to discover that it</span>
01208     <span class="comment">//        represents a symbolic link.</span>
01209     <span class="comment">//</span>
01210     <span class="comment">//    4.  The operation is complete and was successful (Status ==</span>
01211     <span class="comment">//        STATUS_SUCCESS).  Note that for this case the only action is to</span>
01212     <span class="comment">//        return a pointer to the file object.</span>
01213     <span class="comment">//</span>
01214 
01215     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
01216 
01217         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a>,
01218                                       Executive,
01219                                       KernelMode,
01220                                       FALSE,
01221                                       (PLARGE_INTEGER) NULL );
01222         status = ioStatus.Status;
01223 
01224     } <span class="keywordflow">else</span> {
01225 
01226         <span class="comment">//</span>
01227         <span class="comment">// The I/O operation was completed without returning a status of</span>
01228         <span class="comment">// pending.  This means that at this point, the IRP has not been</span>
01229         <span class="comment">// fully completed.  Complete it now.</span>
01230         <span class="comment">//</span>
01231 
01232         <a class="code" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> normalRoutine;
01233         PVOID normalContext;
01234         KIRQL irql;
01235 
01236         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o11">PendingReturned</a> );
01237         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> );
01238 
01239         <span class="comment">//</span>
01240         <span class="comment">// In the case of name junctions do the transmogrify work.</span>
01241         <span class="comment">//</span>
01242 
01243         <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status == STATUS_REPARSE &amp;&amp;
01244             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information == IO_REPARSE_TAG_MOUNT_POINT ) {
01245 
01246             PREPARSE_DATA_BUFFER reparseBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01247 
01248             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.AuxiliaryBuffer != NULL );
01249 
01250             reparseBuffer = (PREPARSE_DATA_BUFFER) irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.AuxiliaryBuffer;
01251 
01252             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( reparseBuffer-&gt;ReparseTag == IO_REPARSE_TAG_MOUNT_POINT );
01253             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( reparseBuffer-&gt;ReparseDataLength &lt; MAXIMUM_REPARSE_DATA_BUFFER_SIZE );
01254             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( reparseBuffer-&gt;Reserved &lt; MAXIMUM_REPARSE_DATA_BUFFER_SIZE );
01255 
01256             <a class="code" href="../../d4/d6/iosubs_8c.html#a86">IopDoNameTransmogrify</a>( irp,
01257                                    fileObject,
01258                                    reparseBuffer );
01259         }
01260 
01261         <span class="comment">//</span>
01262         <span class="comment">// Now finish up the request.</span>
01263         <span class="comment">//</span>
01264 
01265         <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>( APC_LEVEL, &amp;irql );
01266 
01267         <span class="comment">//</span>
01268         <span class="comment">// Note that normally the system would simply call IopCompleteRequest</span>
01269         <span class="comment">// here to complete the packet.  However, because this is a create</span>
01270         <span class="comment">// operation, several assumptions can be made that make it much faster</span>
01271         <span class="comment">// to perform the couple of operations that completing the request</span>
01272         <span class="comment">// would perform.  These include:  copying the I/O status block,</span>
01273         <span class="comment">// dequeueing the IRP and freeing it, and setting the file object's</span>
01274         <span class="comment">// event to the signalled state.  The latter is done here by hand,</span>
01275         <span class="comment">// since it is known that it is not possible for any thread to be</span>
01276         <span class="comment">// waiting on the event.</span>
01277         <span class="comment">//</span>
01278 
01279         ioStatus = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>;
01280         status = ioStatus.Status;
01281 
01282         fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a>.<a class="code" href="../../d2/d6/struct__KEVENT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o4">SignalState</a> = 1;
01283 
01284         <a class="code" href="../../d0/d6/iop_8h.html#a18">IopDequeueThreadIrp</a>( irp );
01285 
01286         <span class="comment">//</span>
01287         <span class="comment">// The SystemBuffer is in some cases used by the driver, and</span>
01288         <span class="comment">// needs to be freed if present.</span>
01289         <span class="comment">//</span>
01290 
01291         <span class="keywordflow">if</span> ((irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a178">IRP_BUFFERED_IO</a>) &amp;&amp; (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a179">IRP_DEALLOCATE_BUFFER</a>)) {
01292             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer);
01293         }
01294 
01295         <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>( irp );
01296 
01297         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>( irql );
01298     }
01299 
01300     <span class="comment">//</span>
01301     <span class="comment">// Copy the information field of the I/O status block back to the</span>
01302     <span class="comment">// original caller in case it is required.</span>
01303     <span class="comment">//</span>
01304 
01305     op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o4">Information</a> = ioStatus.Information;
01306 
01307     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01308         <span class="keywordtype">int</span> openCancelled;
01309 
01310         <span class="comment">//</span>
01311         <span class="comment">// The operation ended in an error.  Kill the file object, dereference</span>
01312         <span class="comment">// the device object, and return a null pointer.</span>
01313         <span class="comment">//</span>
01314 
01315         <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.Length) {
01316             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.Buffer );
01317             fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.Length = 0;
01318         }
01319 
01320         fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a> = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01321 
01322         openCancelled = (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a171">FO_FILE_OPEN_CANCELLED</a>);
01323 
01324         <span class="keywordflow">if</span> (realFileObjectRequired) {
01325             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
01326         }
01327         op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o2">FileObject</a> = (<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01328 
01329         <a class="code" href="../../d0/d6/iop_8h.html#a161">IopDecrementDeviceObjectRef</a>( parseDeviceObject, FALSE );
01330 
01331         <span class="keywordflow">if</span> ((!openCancelled) &amp;&amp; (vpb )) {
01332             <a class="code" href="../../d4/d3/parse_8c.html#a5">IopDereferenceVpbAndFree</a>(vpb);
01333         }
01334 
01335         <span class="keywordflow">return</span> op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o3">FinalStatus</a> = status;
01336 
01337     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == STATUS_REPARSE) {
01338 
01339         <span class="comment">//</span>
01340         <span class="comment">// The operation resulted in a reparse.  This means that the file</span>
01341         <span class="comment">// name in the file object is the new name to be looked up. Replace</span>
01342         <span class="comment">// the complete name string with the new name and return STATUS_REPARSE</span>
01343         <span class="comment">// so the object manager knows to start over again.  Note, however,</span>
01344         <span class="comment">// that the file name buffer in the file object itself is kept intact</span>
01345         <span class="comment">// so that it can be reused when coming back here again.</span>
01346         <span class="comment">//</span>
01347         <span class="comment">// A reparse status may also have been returned from the file system if</span>
01348         <span class="comment">// the volume that was in a drive needed to have been verified, but</span>
01349         <span class="comment">// the verification failed, and a new volume was mounted.  In this</span>
01350         <span class="comment">// case, everything starts over again using the new volume.</span>
01351         <span class="comment">//</span>
01352 
01353         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IO_REPARSE == IO_REPARSE_TAG_RESERVED_ZERO );
01354 
01355         <span class="keywordflow">if</span> ((ioStatus.Information == <a class="code" href="../../d0/d5/io_8h.html#a108">IO_REPARSE</a>) ||
01356             (ioStatus.Information == IO_REPARSE_TAG_MOUNT_POINT)) {
01357 
01358             <span class="comment">//</span>
01359             <span class="comment">// If the complete name buffer isn't large enough, reallocate it.</span>
01360             <span class="comment">//</span>
01361 
01362             <span class="keywordflow">if</span> (CompleteName-&gt;MaximumLength &lt; fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.Length) {
01363 
01364                 PVOID buffer;
01365 
01366                 buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool,
01367                                                 fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.Length,
01368                                                 'cFoI' );
01369                 <span class="keywordflow">if</span> (!buffer) {
01370                     <span class="keywordflow">return</span> op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o3">FinalStatus</a> = STATUS_INSUFFICIENT_RESOURCES;
01371                 } <span class="keywordflow">else</span> {
01372                     <span class="keywordflow">if</span> (CompleteName-&gt;Buffer) {
01373                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( CompleteName-&gt;Buffer );
01374                     }
01375                     CompleteName-&gt;Buffer = buffer;
01376                     CompleteName-&gt;MaximumLength = fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.Length;
01377                 }
01378             }
01379 
01380             <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>( CompleteName, &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a> );
01381 
01382             <span class="comment">//</span>
01383             <span class="comment">// For NTFS directory junction points we NULL the RelatedFileObject.</span>
01384             <span class="comment">// If the prior call was a relative open, the subsequent one will</span>
01385             <span class="comment">// not be.</span>
01386             <span class="comment">//</span>
01387 
01388             <span class="keywordflow">if</span> (ioStatus.Information == IO_REPARSE_TAG_MOUNT_POINT) {
01389 
01390                 op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o6">RelatedFileObject</a> = (<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01391             }
01392         }
01393 
01394         <span class="comment">//</span>
01395         <span class="comment">// Kill the file object, dereference the device object, and return a</span>
01396         <span class="comment">// null pointer.</span>
01397         <span class="comment">//</span>
01398 
01399         <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.Length) {
01400             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.Buffer );
01401             fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.Length = 0;
01402         }
01403 
01404         fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a> = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01405 
01406         <span class="keywordflow">if</span> (realFileObjectRequired) {
01407             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
01408         }
01409         op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o2">FileObject</a> = (<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01410 
01411         <a class="code" href="../../d0/d6/iop_8h.html#a161">IopDecrementDeviceObjectRef</a>( parseDeviceObject, FALSE );
01412 
01413         <span class="keywordflow">if</span> (vpb) {
01414             <a class="code" href="../../d4/d3/parse_8c.html#a5">IopDereferenceVpbAndFree</a>(vpb);
01415         }
01416 
01417         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IO_REMOUNT == IO_REPARSE_TAG_RESERVED_ONE );
01418 
01419         <span class="keywordflow">if</span> (ioStatus.Information == IO_REPARSE_TAG_RESERVED_ONE) {
01420 
01421             <span class="comment">//</span>
01422             <span class="comment">// If we are reparsing to verify a volume, restart the reparse</span>
01423             <span class="comment">// by attempting to parse the device once again.  Note that it</span>
01424             <span class="comment">// would be best to simply recurse, but it's not possible since</span>
01425             <span class="comment">// there is a limited amount of stack available to kernel mode</span>
01426             <span class="comment">// and a limit needs to be enforced for the number of times that</span>
01427             <span class="comment">// verify reparse can occur.</span>
01428             <span class="comment">//</span>
01429 
01430             <span class="keywordflow">if</span> (++retryCount &gt; <a class="code" href="../../d4/d3/parse_8c.html#a1">IO_MAX_REMOUNT_REPARSE_ATTEMPTS</a>) {
01431 
01432                 <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01433             }
01434             <span class="keywordflow">goto</span> reparse_loop;
01435 
01436         } <span class="keywordflow">else</span> {
01437 
01438             <span class="comment">//</span>
01439             <span class="comment">// Really reparsing a symbolic link, so go back to the object</span>
01440             <span class="comment">// manager so it can begin the parse from the top.</span>
01441             <span class="comment">//</span>
01442 
01443             op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o6">RelatedFileObject</a> = (<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01444             <span class="keywordflow">return</span> STATUS_REPARSE;
01445         }
01446 
01447     } <span class="keywordflow">else</span> {
01448 
01449         <span class="comment">//</span>
01450         <span class="comment">// The operation was successful. The first thing to do is to see if</span>
01451         <span class="comment">// the device that processed the open also opened the file. If</span>
01452         <span class="comment">// not, we need to adjust the vpb reference counts. Then, if this is</span>
01453         <span class="comment">// not a query or a delete, but rather a normal open/create, return</span>
01454         <span class="comment">// the address of the FileObject to the caller and set the</span>
01455         <span class="comment">// information returned in the original requestor's I/O status block.</span>
01456         <span class="comment">// Also set the value of the parse check field in the open packet to</span>
01457         <span class="comment">// a value which will let the caller know that this routine was</span>
01458         <span class="comment">// successful in creating the file object. Finally, return the status</span>
01459         <span class="comment">// of the operation to the caller.</span>
01460         <span class="comment">//</span>
01461 
01462         <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObjectThatOpenedFile;
01463 
01464         deviceObjectThatOpenedFile = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>(fileObject);
01465         <span class="keywordflow">if</span> (deviceObject != deviceObjectThatOpenedFile) {
01466             <span class="comment">//</span>
01467             <span class="comment">// The device that opened the related file is not the one</span>
01468             <span class="comment">// that opened this file. So, readjust the vpb reference</span>
01469             <span class="comment">// counts.</span>
01470             <span class="keywordflow">if</span> (vpb) {
01471                 <a class="code" href="../../d4/d3/parse_8c.html#a5">IopDereferenceVpbAndFree</a>(vpb);
01472             }
01473             vpb = fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o3">Vpb</a>;
01474             <span class="keywordflow">if</span> (vpb) {
01475                 <a class="code" href="../../d5/d8/ex_8h.html#a235">ExInterlockedAddUlong</a>(
01476                     &amp;vpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o7">ReferenceCount</a>, 1, &amp;IopVpbSpinLock );
01477             }
01478         }
01479 
01480         <span class="keywordflow">if</span> (realFileObjectRequired) {
01481 
01482             *Object = fileObject;
01483             op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o5">ParseCheck</a> = <a class="code" href="../../d0/d6/iop_8h.html#a3">OPEN_PACKET_PATTERN</a>;
01484 
01485             <span class="comment">//</span>
01486             <span class="comment">// Add a reference so the file object cannot go away before</span>
01487             <span class="comment">// the create routine gets chance to flag the object for handle</span>
01488             <span class="comment">// create.</span>
01489             <span class="comment">//</span>
01490 
01491             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( fileObject );
01492 
01493             <span class="comment">//</span>
01494             <span class="comment">// If the filename length is zero and its not a relative open or</span>
01495             <span class="comment">// its a relative open to a volume open then set the volume open flag.</span>
01496             <span class="comment">// Also set it only for filesystem device object volume.</span>
01497             <span class="comment">//</span>
01498             <span class="keywordflow">if</span> ((!fileObject-&gt;RelatedFileObject || fileObject-&gt;RelatedFileObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a172">FO_VOLUME_OPEN</a>) &amp;&amp;
01499                 (!fileObject-&gt;FileName.Length)) {
01500                 <span class="keywordflow">switch</span> (deviceObjectThatOpenedFile-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o12">DeviceType</a>) {
01501                 <span class="keywordflow">case</span> FILE_DEVICE_DISK_FILE_SYSTEM:
01502                 <span class="keywordflow">case</span> FILE_DEVICE_CD_ROM_FILE_SYSTEM:
01503                 <span class="keywordflow">case</span> FILE_DEVICE_TAPE_FILE_SYSTEM:
01504                 <span class="keywordflow">case</span> FILE_DEVICE_FILE_SYSTEM:
01505 
01506                     fileObject-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a172">FO_VOLUME_OPEN</a>;
01507                     <span class="keywordflow">break</span>;
01508 
01509                 <span class="keywordflow">default</span>:
01510                     <span class="keywordflow">break</span>;
01511                 }
01512             }
01513 
01514             <span class="keywordflow">return</span> op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o3">FinalStatus</a> = ioStatus.Status;
01515 
01516         } <span class="keywordflow">else</span> {
01517 
01518             <span class="comment">//</span>
01519             <span class="comment">// This is either a quick query or delete operation.  Determine</span>
01520             <span class="comment">// which it is and quickly perform the operation.</span>
01521             <span class="comment">//</span>
01522 
01523             <span class="keywordflow">if</span> (op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o20">QueryOnly</a>) {
01524                 <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> fastIoDispatch;
01525                 BOOLEAN queryResult = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01526 
01527                 fastIoDispatch = deviceObjectThatOpenedFile-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
01528 
01529                 <span class="keywordflow">if</span> (!op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o22">FullAttributes</a>) {
01530                     PFILE_BASIC_INFORMATION basicInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01531 
01532                     <span class="comment">//</span>
01533                     <span class="comment">// This is a simple FAT file attribute query.  Attempt to</span>
01534                     <span class="comment">// obtain the basic information about the file.</span>
01535                     <span class="comment">//</span>
01536 
01537                     <span class="keywordflow">try</span> {
01538 
01539                         <span class="keywordflow">if</span> (fastIoDispatch &amp;&amp; fastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o4">FastIoQueryBasicInfo</a>) {
01540                             queryResult = fastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o4">FastIoQueryBasicInfo</a>(
01541                                             fileObject,
01542                                             TRUE,
01543                                             op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o15">BasicInformation</a>,
01544                                             &amp;ioStatus,
01545                                             deviceObjectThatOpenedFile
01546                                             );
01547                         }
01548                         <span class="keywordflow">if</span> (!queryResult) {
01549                             ULONG returnedLength;
01550 
01551                             basicInfo = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool,
01552                                                         <span class="keyword">sizeof</span>( FILE_BASIC_INFORMATION ) );
01553                             <span class="keywordflow">if</span> (basicInfo) {
01554                                 status = <a class="code" href="../../d4/d6/iosubs_8c.html#a90">IoQueryFileInformation</a>(
01555                                             fileObject,
01556                                             FileBasicInformation,
01557                                             <span class="keyword">sizeof</span>( FILE_BASIC_INFORMATION ),
01558                                             basicInfo,
01559                                             &amp;returnedLength
01560                                             );
01561                                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01562                                     RtlCopyMemory( op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o15">BasicInformation</a>,
01563                                                    basicInfo,
01564                                                    returnedLength );
01565                                 }
01566                                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( basicInfo );
01567                             } <span class="keywordflow">else</span> {
01568                                 status = STATUS_INSUFFICIENT_RESOURCES;
01569                             }
01570                         } <span class="keywordflow">else</span> {
01571                             status = ioStatus.Status;
01572                         }
01573                     } except(EXCEPTION_EXECUTE_HANDLER) {
01574                         <span class="keywordflow">if</span> (basicInfo) {
01575                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( basicInfo );
01576                         }
01577                         status = GetExceptionCode();
01578                     }
01579 
01580                 } <span class="keywordflow">else</span> {
01581 
01582                     <span class="comment">//</span>
01583                     <span class="comment">// This is a full attribute query.  Attempt to obtain the</span>
01584                     <span class="comment">// full network attributes for the file.  This includes</span>
01585                     <span class="comment">// both the basic and standard information about the</span>
01586                     <span class="comment">// file.  Try the fast path first, if it exists.</span>
01587                     <span class="comment">//</span>
01588 
01589                     <span class="keywordflow">if</span> (fastIoDispatch &amp;&amp;
01590                         fastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt; FIELD_OFFSET( <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, FastIoQueryNetworkOpenInfo ) &amp;&amp;
01591                         fastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o14">FastIoQueryNetworkOpenInfo</a>) {
01592                         queryResult = fastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o14">FastIoQueryNetworkOpenInfo</a>(
01593                                         fileObject,
01594                                         TRUE,
01595                                         op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o16">NetworkInformation</a>,
01596                                         &amp;ioStatus,
01597                                         deviceObjectThatOpenedFile
01598                                         );
01599                     }
01600                     <span class="keywordflow">if</span> (!queryResult) {
01601                         ULONG returnedLength;
01602 
01603                         <span class="comment">//</span>
01604                         <span class="comment">// Either the fast dispatch routine did not exist, or</span>
01605                         <span class="comment">// it simply wasn't callable at this time.  Attempt to</span>
01606                         <span class="comment">// obtain all of the information at once via an IRP-</span>
01607                         <span class="comment">// based call.</span>
01608                         <span class="comment">//</span>
01609 
01610                         status = <a class="code" href="../../d4/d6/iosubs_8c.html#a90">IoQueryFileInformation</a>(
01611                                     fileObject,
01612                                     FileNetworkOpenInformation,
01613                                     <span class="keyword">sizeof</span>( FILE_NETWORK_OPEN_INFORMATION ),
01614                                     op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o16">NetworkInformation</a>,
01615                                     &amp;returnedLength
01616                                     );
01617 
01618                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01619                             <span class="keywordflow">if</span> (status == STATUS_INVALID_PARAMETER ||
01620                                 status == STATUS_NOT_IMPLEMENTED) {
01621                                 FILE_BASIC_INFORMATION basicInfo;
01622                                 FILE_STANDARD_INFORMATION stdInfo;
01623 
01624                                 <span class="comment">//</span>
01625                                 <span class="comment">// The IRP-based call did not work either, so</span>
01626                                 <span class="comment">// simply try to obtain the information by</span>
01627                                 <span class="comment">// doing IRP-based queries for the basic and</span>
01628                                 <span class="comment">// standard information and piecing together</span>
01629                                 <span class="comment">// the results into the caller's buffer.  Note</span>
01630                                 <span class="comment">// that it might be possible to perform fast</span>
01631                                 <span class="comment">// I/O operations to get the data, but it</span>
01632                                 <span class="comment">// might also fail because of the above.  So</span>
01633                                 <span class="comment">// simply query the information the long way.</span>
01634                                 <span class="comment">//</span>
01635 
01636                                 status = <a class="code" href="../../d4/d6/iosubs_8c.html#a90">IoQueryFileInformation</a>(
01637                                             fileObject,
01638                                             FileBasicInformation,
01639                                             <span class="keyword">sizeof</span>( FILE_BASIC_INFORMATION ),
01640                                             &amp;basicInfo,
01641                                             &amp;returnedLength
01642                                             );
01643                                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01644                                     status = <a class="code" href="../../d4/d6/iosubs_8c.html#a90">IoQueryFileInformation</a>(
01645                                                 fileObject,
01646                                                 FileStandardInformation,
01647                                                 <span class="keyword">sizeof</span>( FILE_STANDARD_INFORMATION ),
01648                                                 &amp;stdInfo,
01649                                                 &amp;returnedLength
01650                                                 );
01651                                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01652                                         <a class="code" href="../../d4/d3/parse_8c.html#a2">COPY_ATTRIBUTES</a>( op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o16">NetworkInformation</a>,
01653                                                          &amp;basicInfo,
01654                                                          &amp;stdInfo );
01655                                     }
01656                                 }
01657                             }
01658                         }
01659                     }
01660                 }
01661 
01662             } <span class="keywordflow">else</span> {
01663 
01664                 <span class="comment">//</span>
01665                 <span class="comment">// There is nothing to do for a quick delete since the caller</span>
01666                 <span class="comment">// set the FILE_DELETE_ON_CLOSE CreateOption so it is already</span>
01667                 <span class="comment">// set in the file system.</span>
01668                 <span class="comment">//</span>
01669 
01670                 NOTHING;
01671 
01672             }
01673 
01674             op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o5">ParseCheck</a> = <a class="code" href="../../d0/d6/iop_8h.html#a3">OPEN_PACKET_PATTERN</a>;
01675             <span class="keywordflow">if</span> (realFileObjectRequired) {
01676                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
01677             } <span class="keywordflow">else</span> {
01678                 <a class="code" href="../../d3/d1/objsup_8c.html#a1">IopDeleteFile</a>( fileObject );
01679             }
01680             op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o2">FileObject</a> = (<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01681 
01682             op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o3">FinalStatus</a> = status;
01683 
01684             <span class="keywordflow">return</span> status;
01685         }
01686     }
01687 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a200" doxytag="iop.h::IopParseFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopParseFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ParseObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Attributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>CompleteName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>RemainingName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID Context&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_QUALITY_OF_SERVICE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a9">SecurityQos</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/parse_8c-source.html#l01690">1690</a> of file <a class="el" href="../../d5/d2/parse_8c-source.html">parse.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l00042">IO_TYPE_OPEN_PACKET</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d5/d2/parse_8c-source.html#l00202">IopParseDevice()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00212">_OPEN_PACKET::RelatedFileObject</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00037">SecurityQos</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00207">_OPEN_PACKET::Size</a>, and <a class="el" href="../../d1/d5/iop_8h-source.html#l00206">_OPEN_PACKET::Type</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01936">IopCreateObjectTypes()</a>.
<p>
<pre class="fragment"><div>01705                    :
01706 
01707     This routine interfaces to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NT Object <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a79">Manager</a>.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when
01708     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object system <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> given <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of an entity to create or open and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01709     also given a handle to a directory <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be
01710     performed relative to.  This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parse routine <span class="keywordflow">for</span>
01711     all <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> objects.
01712 
01713     This routine simply invokes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parse routine <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate device
01714     that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> responsibility of that
01715     routine to perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
01716 
01717 Arguments:
01718 
01719     ParseObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be opened or
01720         created relative to.
01721 
01722     ObjectType - Type of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being opened.
01723 
01724     AccessState - <a class="code" href="../../d4/d9/ke_8h.html#a406a193">Running</a> security access state information <span class="keywordflow">for</span> operation.
01725 
01726     AccessMode - Access mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original caller.
01727 
01728     Attributes - Attributes to be applied to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
01729 
01730     CompleteName - Complete name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
01731 
01732     RemainingName - Remaining name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
01733 
01734     Context - Pointer to an Open Packet (OP) from NtCreateFile service.
01735 
01736     SecurityQos - Supplies a pointer to the captured QOS information
01737         if available.
01738 
01739     Object - The address of a variable to receive the created file object, if
01740         any.
01741 
01742 Return Value:
01743 
01744     The function return value is one of the following:
01745 
01746         a)  Success - This indicates that the function succeeded and the object
01747             parameter contains the address of the created file object.
01748 
01749         b)  Error - This indicates that the file was not found or created and
01750             no file object was created.
01751 
01752         c)  Reparse - This indicates that the remaining name string has been
01753             replaced by a new name that is to be parsed.
01754 
01755 --*/
01756 
01757 {
01758     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
01759     <a class="code" href="../../d3/d7/struct__OPEN__PACKET.html">POPEN_PACKET</a> op;
01760 
01761     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01762 
01763     <span class="comment">//</span>
01764     <span class="comment">// Get the address of the Open Packet (OP).</span>
01765     <span class="comment">//</span>
01766 
01767     op = (<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html">POPEN_PACKET</a>) Context;
01768 
01769     <span class="comment">//</span>
01770     <span class="comment">// Ensure that this routine is actually being invoked because someone is</span>
01771     <span class="comment">// attempting to open a device or a file through NtCreateFile.  This code</span>
01772     <span class="comment">// must be invoked from there (as opposed to some other random object</span>
01773     <span class="comment">// create or open routine).</span>
01774     <span class="comment">//</span>
01775 
01776     <span class="keywordflow">if</span> (op == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
01777         op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o0">Type</a> != <a class="code" href="../../d0/d5/io_8h.html#a7">IO_TYPE_OPEN_PACKET</a> ||
01778         op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o1">Size</a> != <span class="keyword">sizeof</span>( <a class="code" href="../../d3/d7/struct__OPEN__PACKET.html">OPEN_PACKET</a> )) {
01779         <span class="keywordflow">return</span> STATUS_OBJECT_TYPE_MISMATCH;
01780     }
01781 
01782     <span class="comment">//</span>
01783     <span class="comment">// Get a pointer to the device object for this file.</span>
01784     <span class="comment">//</span>
01785 
01786     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( (<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>) ParseObject );
01787 
01788     <span class="comment">//</span>
01789     <span class="comment">// Pass the related file object to the device object parse routine.</span>
01790     <span class="comment">//</span>
01791 
01792     op-&gt;<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o6">RelatedFileObject</a> = (<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>) ParseObject;
01793 
01794     <span class="comment">//</span>
01795     <span class="comment">// Open or create the specified file.</span>
01796     <span class="comment">//</span>
01797 
01798     <span class="keywordflow">return</span> <a class="code" href="../../d4/d3/parse_8c.html#a6">IopParseDevice</a>( deviceObject,
01799                            ObjectType,
01800                            AccessState,
01801                            AccessMode,
01802                            Attributes,
01803                            CompleteName,
01804                            RemainingName,
01805                            Context,
01806                            SecurityQos,
01807                            Object );
01808 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a201" doxytag="iop.h::IopProtectSystemPartition" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopProtectSystemPartition           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LoaderBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/arcsec_8c-source.html#l00053">53</a> of file <a class="el" href="../../d6/d8/arcsec_8c-source.html">arcsec.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d8/arcsec_8c-source.html#l00049">IOP_SYSTEM_PART_PROT_KEY</a>, <a class="el" href="../../d6/d8/arcsec_8c-source.html#l00050">IOP_SYSTEM_PART_PROT_VALUE</a>, <a class="el" href="../../d6/d8/arcsec_8c-source.html#l00168">IopApplySystemPartitionProt()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>.
<p>
<pre class="fragment"><div>00059                    :
00060 
00061     This routine assigns protection to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system partition of an
00062     ARC system, <span class="keywordflow">if</span> necessary.  If <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not an ARC system, or
00063     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system partition does not need to be <span class="keyword">protected</span>, then <span class="keyword">this</span>
00064     routine does nothing.
00065 
00066 
00067 Arguments:
00068 
00069     LoaderBlock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader parameter block that was
00070         created by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> OS Loader.
00071 
00072 Return Value:
00073 
00074     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a BOOLEAN indicating whether or not protection
00075     has been appropriately applied.   <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates no errors were
00076     encountered.  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> indicates an error was encountered.
00077 
00078 
00079 --*/
00080 
00081 {
00082 
00083     <span class="comment">//</span>
00084     <span class="comment">// We only entertain the possibility of assigning protection</span>
00085     <span class="comment">// to the system partition if we are an ARC system.  For the</span>
00086     <span class="comment">// time being, the best way to determine if you are an ARC</span>
00087     <span class="comment">// system is to see if you aren't and X86 machine.  DavidRo</span>
00088     <span class="comment">// believes that at some point in the future we will have</span>
00089     <span class="comment">// ARC compliant X86 machines.  At that point in time, we</span>
00090     <span class="comment">// will need to change the following #ifdef's into something</span>
00091     <span class="comment">// that does a run-time determination.</span>
00092     <span class="comment">//</span>
00093 
00094 <span class="preprocessor">#ifdef i386  // if (!ARC-Compliant system)</span>
00095 <span class="preprocessor"></span>
00096 
00097     <span class="comment">//</span>
00098     <span class="comment">// Nothing to do for non-ARC systems</span>
00099     <span class="comment">//</span>
00100 
00101     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00102 
00103 
00104 <span class="preprocessor">#else // ARC-COMPLIANT system</span>
00105 <span class="preprocessor"></span>
00106     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00107     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> tmpStatus;
00108     HANDLE keyHandle;
00109     OBJECT_ATTRIBUTES objectAttributes;
00110     UNICODE_STRING keyName;
00111     UNICODE_STRING valueName;
00112     ULONG resultLength;
00113     ULONG keyBuffer[<span class="keyword">sizeof</span>( KEY_VALUE_PARTIAL_INFORMATION ) + <span class="keyword">sizeof</span>( ULONG )];
00114     PKEY_VALUE_PARTIAL_INFORMATION keyValue;
00115 
00116     <span class="comment">//</span>
00117     <span class="comment">// This is an ARC system.  Attempt to retrieve information from the registry</span>
00118     <span class="comment">// indicating whether or not we should protect the system partition.</span>
00119     <span class="comment">//</span>
00120 
00121     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;keyName, IOP_SYSTEM_PART_PROT_KEY );
00122     InitializeObjectAttributes( &amp;objectAttributes,
00123                                 &amp;keyName,
00124                                 OBJ_CASE_INSENSITIVE,
00125                                 NULL,
00126                                 NULL );
00127     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( &amp;keyHandle, KEY_READ, &amp;objectAttributes);
00128 
00129     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00130 
00131         keyValue = (PKEY_VALUE_PARTIAL_INFORMATION) &amp;keyBuffer[0];
00132         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;valueName, IOP_SYSTEM_PART_PROT_VALUE );
00133         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>( keyHandle,
00134                                   &amp;valueName,
00135                                   KeyValuePartialInformation,
00136                                   keyValue,
00137                                   <span class="keyword">sizeof</span>( KEY_VALUE_PARTIAL_INFORMATION ) + <span class="keyword">sizeof</span>( ULONG ),
00138                                   &amp;resultLength );
00139 
00140         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00141 
00142             PBOOLEAN applyIt;
00143 
00144             <span class="comment">//</span>
00145             <span class="comment">// The appropriate information was located in the registry.  Now</span>
00146             <span class="comment">// determine whether or not is indicates that protection is to be</span>
00147             <span class="comment">// applied.</span>
00148             <span class="comment">//</span>
00149 
00150             applyIt = &amp;(keyValue-&gt;Data[0]);
00151 
00152             <span class="keywordflow">if</span> (*applyIt) {
00153                 status = <a class="code" href="../../d5/d9/arcsec_8c.html#a2">IopApplySystemPartitionProt</a>( LoaderBlock );
00154             }
00155         }
00156 
00157         tmpStatus = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( keyHandle );
00158         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( tmpStatus ));
00159     }
00160 
00161 
00162     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00163 
00164 <span class="preprocessor">#endif // ARC-COMPLIANT system</span>
00165 <span class="preprocessor"></span>}

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a226" doxytag="iop.h::IopQueryDeviceCapabilities" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryDeviceCapabilities           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">PDEVICE_CAPABILITIES</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Capabilities</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03694">3694</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
<pre class="fragment"><div>03701                    :
03702 
03703     This routine will issue an irp to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DeviceObject to retrieve <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03704     pnp device capabilities.
03705     Should <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> be called twice - first from <a class="code" href="../../d6/d0/pnpenum_8c.html#a35">IopProcessNewDeviceNode</a>,
03706     and second from <a class="code" href="../../d9/d0/pnpiop_8h.html#a328">IopDeviceNodeCapabilitiesToRegistry</a>, called after
03707     device <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> started. If you consider calling <span class="keyword">this</span> device, see <span class="keywordflow">if</span>
03708     DeviceNode-&gt;CapabilityFlags does what you need instead (accessed
03709     via <a class="code" href="../../d9/d0/pnpiop_8h.html#a101">IopDeviceNodeFlagsToCapabilities</a>(...).
03710 
03711 Arguments:
03712 
03713     DeviceNode - the device object the request should be sent to.
03714 
03715     Capabilities - a capabilities structure to be filled in by the driver.
03716 
03717 Return Value:
03718 
03719     status
03720 
03721 --*/
03722 
03723 {
03724     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpStack;
03725     PVOID dummy;
03726 
03727     NTSTATUS status;
03728 
03729     <span class="comment">//</span>
03730     <span class="comment">// Initialize the capabilities structure.</span>
03731     <span class="comment">//</span>
03732 
03733     RtlZeroMemory(Capabilities, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">DEVICE_CAPABILITIES</a>));
03734     Capabilities-&gt;Size = <span class="keyword">sizeof</span>(DEVICE_CAPABILITIES);
03735     Capabilities-&gt;Version = 1;
03736     Capabilities-&gt;Address = Capabilities-&gt;UINumber = (ULONG)-1;
03737 
03738     <span class="comment">//</span>
03739     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
03740     <span class="comment">//</span>
03741 
03742     RtlZeroMemory(&amp;irpStack, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
03743 
03744     <span class="comment">//</span>
03745     <span class="comment">// Query the device's capabilities</span>
03746     <span class="comment">//</span>
03747 
03748     irpStack.MajorFunction = IRP_MJ_PNP;
03749     irpStack.MinorFunction = IRP_MN_QUERY_CAPABILITIES;
03750     irpStack.Parameters.DeviceCapabilities.Capabilities = Capabilities;
03751 
03752     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a291">IopSynchronousCall</a>(DeviceNode-&gt;PhysicalDeviceObject,
03753                                 &amp;irpStack,
03754                                 &amp;dummy);
03755 
03756     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status != STATUS_PENDING);
03757 
03758     <span class="keywordflow">return</span> status;
03759 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a202" doxytag="iop.h::IopQueryName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>HasObjectName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT POBJECT_NAME_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectNameInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/parse_8c-source.html#l01811">1811</a> of file <a class="el" href="../../d5/d2/parse_8c-source.html">parse.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01517">_FILE_OBJECT::DeviceObject</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01533">_FILE_OBJECT::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01491">FO_SYNCHRONOUS_IO</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02256">IopGetFileName()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08628">IoQueryFileInformation()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00048">NT_ERROR</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00713">ObQueryNameString()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01936">IopCreateObjectTypes()</a>.
<p>
<pre class="fragment"><div>01821                    :
01822 
01823     This function implements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query name <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Object <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a79">Manager</a>
01824     <span class="keywordflow">for</span> querying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> names of <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> objects.
01825 
01826 Arguments:
01827 
01828     Object - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object whose name <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be retrieved.
01829 
01830     HasObjectName - Indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object has a name.
01831 
01832     ObjectNameInfo - <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> in which to <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name.
01833 
01834     Length - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> output buffer, in bytes.
01835 
01836     ReturnLength - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes actually returned in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01837         output buffer.
01838 
01839 Return Value:
01840 
01841     The function <span class="keywordflow">return</span> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query operation.
01842 
01843 --*/
01844 
01845 {
01846     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01847     ULONG lengthNeeded;
01848     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
01849     PUCHAR buffer;
01850     PWSTR p;
01851     POBJECT_NAME_INFORMATION deviceNameInfo;
01852     PFILE_NAME_INFORMATION fileNameInfo;
01853     ULONG length;
01854 
01855     UNREFERENCED_PARAMETER( HasObjectName );
01856 
01857     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01858 
01859     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FIELD_OFFSET( FILE_NAME_INFORMATION, FileName ) &lt; <span class="keyword">sizeof</span>( OBJECT_NAME_INFORMATION ) );
01860 
01861     <span class="comment">//</span>
01862     <span class="comment">// Ensure that the size of the output buffer is at least the minimum</span>
01863     <span class="comment">// size required to include the basic object name information structure.</span>
01864     <span class="comment">//</span>
01865 
01866     <span class="keywordflow">if</span> (Length &lt; <span class="keyword">sizeof</span>( OBJECT_NAME_INFORMATION )) {
01867         <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01868         }
01869 
01870     <span class="comment">//</span>
01871     <span class="comment">// Begin by allocating a buffer in which to build the name of the file.</span>
01872     <span class="comment">//</span>
01873 
01874     buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, Length, '  oI' );
01875     <span class="keywordflow">if</span> (!buffer) {
01876         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01877         }
01878 
01879     <span class="keywordflow">try</span> {
01880 
01881         <span class="comment">//</span>
01882         <span class="comment">// Query the name of the device on which the file is open.</span>
01883         <span class="comment">//</span>
01884 
01885         fileObject = (<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>) Object;
01886         deviceNameInfo = (POBJECT_NAME_INFORMATION) buffer;
01887 
01888         status = <a class="code" href="../../d6/d1/obquery_8c.html#a7">ObQueryNameString</a>( (PVOID) fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a>,
01889                                     deviceNameInfo,
01890                                     Length,
01891                                     &amp;lengthNeeded );
01892         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01893             <span class="keywordflow">return</span> status;
01894             }
01895 
01896         <span class="comment">//</span>
01897         <span class="comment">// Ensure that there is enough room in the output buffer to return the</span>
01898         <span class="comment">// name and copy it.</span>
01899         <span class="comment">//</span>
01900 
01901         RtlCopyMemory( ObjectNameInfo,
01902                        deviceNameInfo,
01903                        lengthNeeded &gt; Length ? Length : lengthNeeded );
01904         p = (PWSTR) (ObjectNameInfo + 1);
01905         ObjectNameInfo-&gt;Name.Buffer = p;
01906         p = (PWSTR) ((PCHAR) p + deviceNameInfo-&gt;Name.Length);
01907 
01908         <span class="comment">//</span>
01909         <span class="comment">// If the buffer is already full, then return.</span>
01910         <span class="comment">//</span>
01911 
01912         <span class="keywordflow">if</span> (lengthNeeded &gt; Length) {
01913             <span class="keywordflow">return</span> STATUS_BUFFER_OVERFLOW;
01914             }
01915 
01916         <span class="comment">//</span>
01917         <span class="comment">// Reset the state for the buffer to obtain the filename portion of the</span>
01918         <span class="comment">// name and calculate the remaining length of the caller's buffer.  Note</span>
01919         <span class="comment">// that in the following calculations, there are two assumptions and</span>
01920         <span class="comment">// and dependencies:</span>
01921         <span class="comment">//</span>
01922         <span class="comment">//     1)  The above query of the device name's returned length needed</span>
01923         <span class="comment">//         include a NULL character which will be included at the end</span>
01924         <span class="comment">//         of the entire name.  This is included in the calculations</span>
01925         <span class="comment">//         although it does not appear to be included.</span>
01926         <span class="comment">//</span>
01927         <span class="comment">//     2)  The sizeof the object name information buffer is assumed</span>
01928         <span class="comment">//         (and guaranteed because it can never change) to be larger</span>
01929         <span class="comment">//         than the filename offset in a file name information buffer.</span>
01930         <span class="comment">//         Therefore it is known that the new length of the "buffer"</span>
01931         <span class="comment">//         variable can be set to the remaining length plus at least 4.</span>
01932         <span class="comment">//</span>
01933 
01934         fileNameInfo = (PFILE_NAME_INFORMATION) buffer;
01935         length = Length - lengthNeeded;
01936 
01937         length += FIELD_OFFSET( FILE_NAME_INFORMATION, FileName );
01938 
01939         <span class="keywordflow">if</span> (KeGetPreviousMode() == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a> ||
01940             !(fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>)) {
01941 
01942             <span class="comment">//</span>
01943             <span class="comment">// Query the name of the file based using an intermediary buffer.</span>
01944             <span class="comment">//</span>
01945 
01946             status = <a class="code" href="../../d4/d6/iosubs_8c.html#a90">IoQueryFileInformation</a>( fileObject,
01947                                              FileNameInformation,
01948                                              length,
01949                                              (PVOID) fileNameInfo,
01950                                              &amp;lengthNeeded );
01951             }
01952         <span class="keywordflow">else</span> {
01953 
01954             <span class="comment">//</span>
01955             <span class="comment">// This is a kernel mode request for a file that was opened for</span>
01956             <span class="comment">// synchronous I/O.  A special function that does not obtain the</span>
01957             <span class="comment">// file object lock is required, otherwise the request may deadlock</span>
01958             <span class="comment">// since the lock is probably already owned.</span>
01959             <span class="comment">//</span>
01960 
01961             status = <a class="code" href="../../d0/d6/iop_8h.html#a177">IopGetFileName</a>( fileObject,
01962                                      length,
01963                                      fileNameInfo,
01964                                      &amp;lengthNeeded );
01965             }
01966 
01967         <span class="comment">//</span>
01968         <span class="comment">// If an error occurred attempting to obtain the filename return now.  Note</span>
01969         <span class="comment">// that buffer overflow is a warning, not an error.</span>
01970         <span class="comment">//</span>
01971 
01972         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>( status )) {
01973             <span class="keywordflow">if</span> (status == STATUS_INVALID_PARAMETER ||
01974                 status == STATUS_INVALID_DEVICE_REQUEST ||
01975                 status == STATUS_NOT_IMPLEMENTED ||
01976                 status == STATUS_INVALID_INFO_CLASS) {
01977                 lengthNeeded = FIELD_OFFSET( FILE_NAME_INFORMATION, FileName );
01978                 fileNameInfo-&gt;FileNameLength = 0;
01979                 fileNameInfo-&gt;FileName[0] = OBJ_NAME_PATH_SEPARATOR;
01980                 status = STATUS_SUCCESS;
01981                 }
01982             <span class="keywordflow">else</span> {
01983                 <span class="keywordflow">return</span> status;
01984                 }
01985             }
01986 
01987         <span class="comment">//</span>
01988         <span class="comment">// Set the remaining length of the caller's buffer as well as the total</span>
01989         <span class="comment">// length needed to contain the entire name of the file.</span>
01990         <span class="comment">//</span>
01991 
01992         length = lengthNeeded - FIELD_OFFSET( FILE_NAME_INFORMATION, FileName );
01993         lengthNeeded = (ULONG)((PUCHAR) p - (PUCHAR) ObjectNameInfo) + fileNameInfo-&gt;FileNameLength;
01994 
01995         <span class="comment">//</span>
01996         <span class="comment">// Attempt to copy the name of the file into the output buffer.  Note</span>
01997         <span class="comment">// that if the file name does not begin w/a '\', then it is not volume</span>
01998         <span class="comment">// relative, so the name of the file cannot be expressed as the</span>
01999         <span class="comment">// concatenation of the name of the device and the file.  Therefore an</span>
02000         <span class="comment">// error is returned.</span>
02001         <span class="comment">//</span>
02002         <span class="comment">// The only example of this situation known at this time is when one</span>
02003         <span class="comment">// opens a directory by file ID, and then opens a file relative to that</span>
02004         <span class="comment">// directory.  When attempting to query the path, if the caller did not</span>
02005         <span class="comment">// have traverse access to open the directory, then the only name that</span>
02006         <span class="comment">// can be returned is the path name to the file from the directory, but</span>
02007         <span class="comment">// the volume-relative name cannot be returned.  Therefore, the file</span>
02008         <span class="comment">// system returns only the name of the directory and the path to the</span>
02009         <span class="comment">// file, but this is not volume-relative so the only recourse is to</span>
02010         <span class="comment">// return an error.</span>
02011         <span class="comment">//</span>
02012         <span class="comment">// Note that if the caller were to call NtQueryInformationFile and</span>
02013         <span class="comment">// request FileNameInformation, then the name above named will be</span>
02014         <span class="comment">// successfully returned from the file system.</span>
02015         <span class="comment">//</span>
02016 
02017         <span class="keywordflow">if</span> (fileNameInfo-&gt;FileName[0] != OBJ_NAME_PATH_SEPARATOR) {
02018             <span class="keywordflow">return</span> STATUS_OBJECT_PATH_INVALID;
02019             }
02020 
02021         RtlMoveMemory( p,
02022                        fileNameInfo-&gt;FileName,
02023                        length );
02024         p = (PWSTR) ((PCH) p + length);
02025         *p = <span class="charliteral">'\0'</span>;
02026         lengthNeeded += <span class="keyword">sizeof</span>( WCHAR );
02027 
02028         *ReturnLength = lengthNeeded;
02029 
02030         length = (ULONG)((PUCHAR) p - (PUCHAR) ObjectNameInfo);
02031         ObjectNameInfo-&gt;Name.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (length - <span class="keyword">sizeof</span>( *ObjectNameInfo ));
02032         ObjectNameInfo-&gt;Name.MaximumLength =  (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) ((length - <span class="keyword">sizeof</span>( *ObjectNameInfo )) + <span class="keyword">sizeof</span>( WCHAR ));
02033         }
02034 
02035     finally {
02036 
02037         <span class="comment">//</span>
02038         <span class="comment">// Finally, free the temporary buffer.</span>
02039         <span class="comment">//</span>
02040 
02041         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( buffer );
02042         }
02043 
02044     <span class="keywordflow">return</span> status;
02045 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a203" doxytag="iop.h::IopQueryXxxInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryXxxInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>InformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Information</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnedLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>FileInformation</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l05397">5397</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01492">FO_ALERTABLE_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01491">FO_SYNCHRONOUS_IO</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00652">IoAllocateIrp()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00595">IopAcquireFastLock</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00181">IopAcquireFileObjectLock()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00284">IopAllocateIrpCleanup()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00417">IopCancelAlertedRequest()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01103">IopQueueThreadIrp</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01157">IopReleaseFileObjectLock</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01554">IRP_BUFFERED_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00060">IRP_MJ_QUERY_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00065">IRP_MJ_QUERY_VOLUME_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01552">IRP_SYNCHRONOUS_API</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o24">_IRP::Overlay</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01641">_IRP::RequestorMode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08628">IoQueryFileInformation()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08683">IoQueryVolumeInformation()</a>.
<p>
<pre class="fragment"><div>05408                    :
05409 
05410     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested information about a specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
05411     or volume.  The information returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> determined by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">class </span>that
05412     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified, and <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> placed into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's output buffer.
05413 
05414 Arguments:
05415 
05416     FileObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object about which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
05417         information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
05418 
05419     FsInformationClass - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of information which should be
05420         returned about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>/volume.
05421 
05422     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer in bytes.
05423 
05424     FsInformation - Supplies a buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested information
05425         returned about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  This buffer must not be pageable and must
05426         reside in system space.
05427 
05428     ReturnedLength - Supplies a variable that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05429         information written to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
05430 
05431     FileInformation - <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a21">Boolean</a> that indicates whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information requested
05432         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> for a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> or a volume.
05433 
05434 Return Value:
05435 
05436     The status returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> final completion status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
05437 
05438 --*/
05439 
05440 {
05441     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
05442     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05443     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
05444     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
05445     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
05446     IO_STATUS_BLOCK localIoStatus;
05447     BOOLEAN synchronousIo;
05448 
05449     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05450 
05451     <span class="comment">//</span>
05452     <span class="comment">// Reference the file object here so that no special checks need be made</span>
05453     <span class="comment">// in I/O completion to determine whether or not to dereference the file</span>
05454     <span class="comment">// object.</span>
05455     <span class="comment">//</span>
05456 
05457     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( FileObject );
05458 
05459     <span class="comment">//</span>
05460     <span class="comment">// Make a special check here to determine whether this is a synchronous</span>
05461     <span class="comment">// I/O operation.  If it is, then wait here until the file is owned by</span>
05462     <span class="comment">// the current thread.  If this is not a (serialized) synchronous I/O</span>
05463     <span class="comment">// operation, then initialize the local event.</span>
05464     <span class="comment">//</span>
05465 
05466     <span class="keywordflow">if</span> (FileObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
05467 
05468         BOOLEAN interrupted;
05469 
05470         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a13">IopAcquireFastLock</a>( FileObject )) {
05471             status = <a class="code" href="../../d0/d6/iop_8h.html#a147">IopAcquireFileObjectLock</a>( FileObject,
05472                                                KernelMode,
05473                                                (BOOLEAN) ((FileObject-&gt;Flags &amp; FO_ALERTABLE_IO) != 0),
05474                                                &amp;interrupted );
05475             <span class="keywordflow">if</span> (interrupted) {
05476                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( FileObject );
05477                 <span class="keywordflow">return</span> status;
05478             }
05479         }
05480         <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( &amp;FileObject-&gt;Event );
05481         synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05482     } <span class="keywordflow">else</span> {
05483         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event, SynchronizationEvent, FALSE );
05484         synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05485     }
05486 
05487     <span class="comment">//</span>
05488     <span class="comment">// Get the address of the target device object.</span>
05489     <span class="comment">//</span>
05490 
05491     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject );
05492 
05493     <span class="comment">//</span>
05494     <span class="comment">// Allocate and initialize the I/O Request Packet (IRP) for this operation.</span>
05495     <span class="comment">// The allocation is performed with an exception handler in case the</span>
05496     <span class="comment">// caller does not have enough quota to allocate the packet.</span>
05497     <span class="comment">//</span>
05498 
05499     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>( deviceObject-&gt;StackSize, TRUE );
05500     <span class="keywordflow">if</span> (!irp) {
05501 
05502         <span class="comment">//</span>
05503         <span class="comment">// An IRP could not be allocated.  Cleanup and return an appropriate</span>
05504         <span class="comment">// error status code.</span>
05505         <span class="comment">//</span>
05506 
05507         <a class="code" href="../../d0/d6/iop_8h.html#a148">IopAllocateIrpCleanup</a>( FileObject, (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL );
05508 
05509         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05510     }
05511     irp-&gt;Tail.Overlay.OriginalFileObject = FileObject;
05512     irp-&gt;Tail.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
05513     irp-&gt;RequestorMode = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
05514 
05515     <span class="comment">//</span>
05516     <span class="comment">// Fill in the service independent parameters in the IRP.</span>
05517     <span class="comment">//</span>
05518 
05519     <span class="keywordflow">if</span> (synchronousIo) {
05520         irp-&gt;UserEvent = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05521     } <span class="keywordflow">else</span> {
05522         irp-&gt;UserEvent = &amp;event;
05523         irp-&gt;Flags = <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>;
05524     }
05525     irp-&gt;UserIosb = &amp;localIoStatus;
05526     irp-&gt;Overlay.AsynchronousParameters.UserApcRoutine = (PIO_APC_ROUTINE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05527 
05528     <span class="comment">//</span>
05529     <span class="comment">// Get a pointer to the stack location for the first driver.  This will be</span>
05530     <span class="comment">// used to pass the original function codes and parameters.</span>
05531     <span class="comment">//</span>
05532 
05533     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
05534     irpSp-&gt;MajorFunction = FileInformation ?
05535                            <a class="code" href="../../d0/d5/io_8h.html#a18">IRP_MJ_QUERY_INFORMATION</a> :
05536                            <a class="code" href="../../d0/d5/io_8h.html#a23">IRP_MJ_QUERY_VOLUME_INFORMATION</a>;
05537     irpSp-&gt;FileObject = FileObject;
05538 
05539     <span class="comment">//</span>
05540     <span class="comment">// Set the system buffer address to the address of the caller's buffer and</span>
05541     <span class="comment">// set the flags so that the buffer is not deallocated.</span>
05542     <span class="comment">//</span>
05543 
05544     irp-&gt;AssociatedIrp.SystemBuffer = Information;
05545     irp-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a178">IRP_BUFFERED_IO</a>;
05546 
05547     <span class="comment">//</span>
05548     <span class="comment">// Copy the caller's parameters to the service-specific portion of the</span>
05549     <span class="comment">// IRP.</span>
05550     <span class="comment">//</span>
05551 
05552     <span class="keywordflow">if</span> (FileInformation) {
05553         irpSp-&gt;Parameters.QueryFile.Length = Length;
05554         irpSp-&gt;Parameters.QueryFile.FileInformationClass = InformationClass;
05555     } <span class="keywordflow">else</span> {
05556         irpSp-&gt;Parameters.QueryVolume.Length = Length;
05557         irpSp-&gt;Parameters.QueryVolume.FsInformationClass = InformationClass;
05558     }
05559 
05560     <span class="comment">//</span>
05561     <span class="comment">// Insert the packet at the head of the IRP list for the thread.</span>
05562     <span class="comment">//</span>
05563 
05564     <a class="code" href="../../d0/d6/iop_8h.html#a21">IopQueueThreadIrp</a>( irp );
05565 
05566     <span class="comment">//</span>
05567     <span class="comment">// Now simply invoke the driver at its dispatch entry with the IRP.</span>
05568     <span class="comment">//</span>
05569 
05570     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject, irp );
05571 
05572     <span class="comment">//</span>
05573     <span class="comment">// If this operation was a synchronous I/O operation, check the return</span>
05574     <span class="comment">// status to determine whether or not to wait on the file object.  If</span>
05575     <span class="comment">// the file object is to be waited on, wait for the operation to complete</span>
05576     <span class="comment">// and obtain the final status from the file object itself.</span>
05577     <span class="comment">//</span>
05578 
05579     <span class="keywordflow">if</span> (synchronousIo) {
05580         <span class="keywordflow">if</span> (status == STATUS_PENDING) {
05581             status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;FileObject-&gt;Event,
05582                                             Executive,
05583                                             KernelMode,
05584                                             (BOOLEAN) ((FileObject-&gt;Flags &amp; FO_ALERTABLE_IO) != 0),
05585                                             (PLARGE_INTEGER) NULL );
05586             <span class="keywordflow">if</span> (status == STATUS_ALERTED) {
05587                 <a class="code" href="../../d0/d6/iop_8h.html#a151">IopCancelAlertedRequest</a>( &amp;FileObject-&gt;Event, irp );
05588             }
05589             status = FileObject-&gt;FinalStatus;
05590         }
05591         <a class="code" href="../../d0/d6/iop_8h.html#a22">IopReleaseFileObjectLock</a>( FileObject );
05592 
05593     } <span class="keywordflow">else</span> {
05594 
05595         <span class="comment">//</span>
05596         <span class="comment">// This is a normal synchronous I/O operation, as opposed to a</span>
05597         <span class="comment">// serialized synchronous I/O operation.  For this case, wait</span>
05598         <span class="comment">// for the local event and copy the final status information</span>
05599         <span class="comment">// back to the caller.</span>
05600         <span class="comment">//</span>
05601 
05602         <span class="keywordflow">if</span> (status == STATUS_PENDING) {
05603             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
05604                                           Executive,
05605                                           KernelMode,
05606                                           FALSE,
05607                                           (PLARGE_INTEGER) NULL );
05608             status = localIoStatus.Status;
05609         }
05610     }
05611 
05612     *ReturnedLength = (ULONG) localIoStatus.Information;
05613     <span class="keywordflow">return</span> status;
05614 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a204" doxytag="iop.h::IopQueueWorkRequest" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopQueueWorkRequest           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Irp</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a205" doxytag="iop.h::IopRaiseHardError" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopRaiseHardError           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l05617">5617</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l02488">_IO_STACK_LOCATION::DeviceObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00700">ExRaiseHardError()</a>, <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00058">ExReadyForErrors</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01070">_VPB::Flags</a>, <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00070">IO_DISK_INCREMENT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02960">IoCompleteRequest</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00065">IOP_ABORT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01556">IRP_INPUT_OPERATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00068">IRP_MJ_FILE_SYSTEM_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00113">IRP_MN_MOUNT_VOLUME</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01414">_DRIVER_OBJECT::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01065">MAXIMUM_VOLUME_LABEL_LENGTH</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00713">ObQueryNameString()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02168">PERFINFO_DRIVER_MAJORFUNCTION_CALL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02169">PERFINFO_DRIVER_MAJORFUNCTION_RETURN</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01076">_VPB::VolumeLabel</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01071">_VPB::VolumeLabelLength</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01054">VPB_MOUNTED</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l00383">IopApcHardError()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08769">IoRaiseHardError()</a>.
<p>
<pre class="fragment"><div>05625                    :
05626 
05627     This routine raises a hard error popup in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current
05628     thread.  The APC was used to get into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of <span class="keyword">this</span> thread so that
05629     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> popup would be sent to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate port.
05630 
05631 Arguments:
05632 
05633     NormalContext - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet (<a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>) that
05634         was initially used to request the operation that has failed.
05635 
05636     SystemArgument1 - Supplies a pointer to the media's volume parameter block.
05637         See IoRaiseHardError documentation for more information.
05638 
05639     SystemArgument2 - Supplies a pointer to the real device object.  See
05640         IoRaiseHardError documentation for more information.
05641 
05642 Return Value:
05643 
05644     None.
05645 
05646 --*/
05647 
05648 {
05649     ULONG_PTR parameters[2];
05650     ULONG numberOfParameters;
05651     ULONG parameterMask;
05652     ULONG response;
05653     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05654     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp = (<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>) NormalContext;
05655     <a class="code" href="../../d7/d7/struct__VPB.html">PVPB</a> vpb = (<a class="code" href="../../d7/d7/struct__VPB.html">PVPB</a>) SystemArgument1;
05656     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> realDeviceObject = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) SystemArgument2;
05657 
05658     ULONG length;
05659     POBJECT_NAME_INFORMATION objectName;
05660 
05661     UNICODE_STRING labelName;
05662 
05663     <span class="comment">//</span>
05664     <span class="comment">// Determine the name of the device and the volume label of the offending</span>
05665     <span class="comment">// media.  Start by determining the size of the DeviceName, and allocate</span>
05666     <span class="comment">// enough storage for both the ObjectName structure and the string</span>
05667     <span class="comment">// because "that's the ways Steve's routine works".</span>
05668     <span class="comment">//</span>
05669 
05670     <a class="code" href="../../d6/d1/obquery_8c.html#a7">ObQueryNameString</a>( realDeviceObject, NULL, 0, &amp;length );
05671 
05672     <span class="keywordflow">if</span> ((objectName = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, length)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05673 
05674         status = STATUS_INSUFFICIENT_RESOURCES;
05675 
05676     } <span class="keywordflow">else</span> {
05677 
05678         status = STATUS_SUCCESS;
05679     }
05680 
05681     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) ||
05682         !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status = <a class="code" href="../../d6/d1/obquery_8c.html#a7">ObQueryNameString</a>( realDeviceObject,
05683                                                  objectName,
05684                                                  length,
05685                                                  &amp;response ) )) {
05686 
05687         <span class="comment">//</span>
05688         <span class="comment">// Allocation of the pool to put up this popup did not work or</span>
05689         <span class="comment">// something else failed, so there isn't really much that can be</span>
05690         <span class="comment">// done here.  Simply return an error back to the user.</span>
05691         <span class="comment">//</span>
05692 
05693         <span class="keywordflow">if</span> (objectName) {
05694             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( objectName );
05695         }
05696 
05697         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = status;
05698         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = 0;
05699 
05700         <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>( irp, IO_DISK_INCREMENT );
05701 
05702         <span class="keywordflow">return</span>;
05703     }
05704 
05705     <span class="comment">//</span>
05706     <span class="comment">// The volume label has a max size of 32 characters (Unicode).  Convert</span>
05707     <span class="comment">// it to a Unicode string for output in the popup message.</span>
05708     <span class="comment">//</span>
05709 
05710     <span class="keywordflow">if</span> (vpb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; vpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o2">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a116">VPB_MOUNTED</a>) {
05711 
05712         labelName.Buffer = &amp;vpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o8">VolumeLabel</a>[0];
05713         labelName.Length = vpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o3">VolumeLabelLength</a>;
05714         labelName.MaximumLength = <a class="code" href="../../d0/d5/io_8h.html#a121">MAXIMUM_VOLUME_LABEL_LENGTH</a>;
05715 
05716     } <span class="keywordflow">else</span> {
05717 
05718         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;labelName, NULL );
05719     }
05720 
05721     <span class="comment">//</span>
05722     <span class="comment">// Different pop-ups have different printf formats.  Depending on the</span>
05723     <span class="comment">// specific error value, adjust the parameters.</span>
05724     <span class="comment">//</span>
05725 
05726     <span class="keywordflow">switch</span>( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status ) {
05727 
05728     <span class="keywordflow">case</span> STATUS_MEDIA_WRITE_PROTECTED:
05729     <span class="keywordflow">case</span> STATUS_WRONG_VOLUME:
05730 
05731         numberOfParameters = 2;
05732         parameterMask = 3;
05733 
05734         parameters[0] = (ULONG_PTR) &amp;labelName;
05735         parameters[1] = (ULONG_PTR) &amp;objectName-&gt;Name;
05736 
05737         <span class="keywordflow">break</span>;
05738 
05739     <span class="keywordflow">case</span> STATUS_DEVICE_NOT_READY:
05740     <span class="keywordflow">case</span> STATUS_IO_TIMEOUT:
05741     <span class="keywordflow">case</span> STATUS_NO_MEDIA_IN_DEVICE:
05742     <span class="keywordflow">case</span> STATUS_UNRECOGNIZED_MEDIA:
05743 
05744         numberOfParameters = 1;
05745         parameterMask = 1;
05746 
05747         parameters[0] = (ULONG_PTR) &amp;objectName-&gt;Name;
05748         parameters[1] = 0;
05749 
05750         <span class="keywordflow">break</span>;
05751 
05752     <span class="keywordflow">default</span>:
05753 
05754         numberOfParameters = 0;
05755         parameterMask = 0;
05756 
05757     }
05758 
05759     <span class="comment">//</span>
05760     <span class="comment">// Simply raise the hard error.</span>
05761     <span class="comment">//</span>
05762 
05763     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/ex_2harderr_8c.html#a5">ExReadyForErrors</a>) {
05764         status = <a class="code" href="../../d5/d8/ex_8h.html#a306">ExRaiseHardError</a>( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status,
05765                                    numberOfParameters,
05766                                    parameterMask,
05767                                    parameters,
05768                                    OptionCancelTryContinue,
05769                                    &amp;response );
05770 
05771     } <span class="keywordflow">else</span> {
05772 
05773         status = STATUS_UNSUCCESSFUL;
05774         response = ResponseReturnToCaller;
05775     }
05776 
05777     <span class="comment">//</span>
05778     <span class="comment">// Free any pool or other resources that were allocated to output the</span>
05779     <span class="comment">// popup.</span>
05780     <span class="comment">//</span>
05781 
05782     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( objectName );
05783 
05784     <span class="comment">//</span>
05785     <span class="comment">// If there was a problem, or the user didn't want to retry, just</span>
05786     <span class="comment">// complete the request.  Otherwise simply call the driver entry</span>
05787     <span class="comment">// point and retry the IRP as if it had never been tried before.</span>
05788     <span class="comment">//</span>
05789 
05790     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) || response != ResponseTryAgain) {
05791 
05792         <span class="comment">//</span>
05793         <span class="comment">// Before completing the request, make one last check.  If this was</span>
05794         <span class="comment">// a mount request, and the reason for the failure was t/o, no media,</span>
05795         <span class="comment">// or unrecognized media, then set the Information field of the status</span>
05796         <span class="comment">// block to indicate whether or not an abort was performed.</span>
05797         <span class="comment">//</span>
05798 
05799         <span class="keywordflow">if</span> (response == ResponseCancel) {
05800             <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( irp );
05801             <span class="keywordflow">if</span> (irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> == <a class="code" href="../../d0/d5/io_8h.html#a26">IRP_MJ_FILE_SYSTEM_CONTROL</a> &amp;&amp;
05802                 irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> == <a class="code" href="../../d0/d5/io_8h.html#a47">IRP_MN_MOUNT_VOLUME</a>) {
05803                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = <a class="code" href="../../d0/d6/iop_8h.html#a0">IOP_ABORT</a>;
05804             } <span class="keywordflow">else</span> {
05805                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = STATUS_REQUEST_ABORTED;
05806             }
05807         }
05808 
05809         <span class="comment">//</span>
05810         <span class="comment">// An error was incurred, so zero out the information field before</span>
05811         <span class="comment">// completing the request if this was an input operation.  Otherwise,</span>
05812         <span class="comment">// IopCompleteRequest will try to copy to the user's buffer.</span>
05813         <span class="comment">//</span>
05814 
05815         <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a180">IRP_INPUT_OPERATION</a>) {
05816             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = 0;
05817         }
05818 
05819         <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>( irp, IO_DISK_INCREMENT );
05820 
05821     } <span class="keywordflow">else</span> {
05822 
05823         <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( irp );
05824         <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> fsDeviceObject = irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o57">DeviceObject</a>;
05825         <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject = fsDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>;
05826 
05827         <span class="comment">//</span>
05828         <span class="comment">// Retry the request from the top.</span>
05829         <span class="comment">//</span>
05830 
05831         <a class="code" href="../../d2/d1/mm_8h.html#a47">PERFINFO_DRIVER_MAJORFUNCTION_CALL</a>(irp, irpSp, driverObject);
05832 
05833         driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o14">MajorFunction</a>[irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a>]( fsDeviceObject,
05834                                                            irp );
05835 
05836         <a class="code" href="../../d2/d1/mm_8h.html#a48">PERFINFO_DRIVER_MAJORFUNCTION_RETURN</a>(irp, irpSp, driverObject);
05837     }
05838 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a206" doxytag="iop.h::IopRaiseInformationalHardError" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopRaiseInformationalHardError           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l05841">5841</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d1/d5/iop_8h-source.html#l00114">_IOP_HARD_ERROR_PACKET::ErrorStatus</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00700">ExRaiseHardError()</a>, <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00058">ExReadyForErrors</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00203">IopHardError</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00109">_IOP_HARD_ERROR_QUEUE::NumPendingApcPopups</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00115">_IOP_HARD_ERROR_PACKET::String</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08909">IoRaiseInformationalHardError()</a>.
<p>
<pre class="fragment"><div>05849                    :
05850 
05851     This routine performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual pop-up.  It will called from either <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05852     hard-error thread, or a APC routine in a user thread after exiting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05853     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system.
05854 
05855 Arguments:
05856 
05857     NormalContext - Contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pop-up
05858 
05859     SystemArgument1 - not used.
05860 
05861     SystemArgument1 - not used.
05862 
05863 Return Value:
05864 
05865     None.
05866 
05867 --*/
05868 
05869 {
05870     ULONG parameterPresent;
05871     ULONG_PTR errorParameter;
05872     ULONG errorResponse;
05873     <a class="code" href="../../d7/d0/struct__IOP__HARD__ERROR__PACKET.html">PIOP_HARD_ERROR_PACKET</a> hardErrorPacket;
05874 
05875     UNREFERENCED_PARAMETER( SystemArgument1 );
05876     UNREFERENCED_PARAMETER( SystemArgument2 );
05877 
05878     hardErrorPacket = (<a class="code" href="../../d7/d0/struct__IOP__HARD__ERROR__PACKET.html">PIOP_HARD_ERROR_PACKET</a>) NormalContext;
05879 
05880     <span class="comment">//</span>
05881     <span class="comment">// Simply raise the hard error if the system is ready to accept one.</span>
05882     <span class="comment">//</span>
05883 
05884     errorParameter = (ULONG_PTR) &amp;hardErrorPacket-&gt;<a class="code" href="../../d7/d0/struct__IOP__HARD__ERROR__PACKET.html#o2">String</a>;
05885 
05886     parameterPresent = (hardErrorPacket-&gt;<a class="code" href="../../d7/d0/struct__IOP__HARD__ERROR__PACKET.html#o2">String</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05887 
05888     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/ex_2harderr_8c.html#a5">ExReadyForErrors</a>) {
05889         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d5/d8/ex_8h.html#a306">ExRaiseHardError</a>( hardErrorPacket-&gt;<a class="code" href="../../d7/d0/struct__IOP__HARD__ERROR__PACKET.html#o1">ErrorStatus</a>,
05890                                  parameterPresent,
05891                                  parameterPresent,
05892                                  parameterPresent ? &amp;errorParameter : NULL,
05893                                  OptionOk,
05894                                  &amp;errorResponse );
05895     }
05896 
05897     <span class="comment">//</span>
05898     <span class="comment">// Now free the packet and the buffer, if one was specified.</span>
05899     <span class="comment">//</span>
05900 
05901     <span class="keywordflow">if</span> (hardErrorPacket-&gt;<a class="code" href="../../d7/d0/struct__IOP__HARD__ERROR__PACKET.html#o2">String</a>.Buffer) {
05902         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( hardErrorPacket-&gt;<a class="code" href="../../d7/d0/struct__IOP__HARD__ERROR__PACKET.html#o2">String</a>.Buffer );
05903     }
05904 
05905     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( hardErrorPacket );
05906     InterlockedDecrement(&amp;<a class="code" href="../../d3/d5/iodata_8c.html#a25">IopHardError</a>.<a class="code" href="../../d8/d0/struct__IOP__HARD__ERROR__QUEUE.html#o5">NumPendingApcPopups</a>);
05907 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a207" doxytag="iop.h::IopReadyDeviceObjects" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopReadyDeviceObjects           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DriverObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l05910">5910</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01159">DO_DEVICE_INITIALIZING</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01304">DRVO_INITIALIZED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01184">_DEVICE_OBJECT::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01180">_DEVICE_OBJECT::NextDevice</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02812">IopInitializeBuiltinDriver()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>.
<p>
<pre class="fragment"><div>05916                    :
05917 
05918     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to mark all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device objects owned by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05919     specified driver as having been fully initialized and therefore ready
05920     <span class="keywordflow">for</span> access by other drivers/clients.
05921 
05922 Arguments:
05923 
05924     DriverObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver
05925         whose devices are to be marked as being <span class="stringliteral">"ready"</span>.
05926 
05927 Return Value:
05928 
05929     None.
05930 
05931 --*/
05932 
05933 {
05934     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject = DriverObject-&gt;DeviceObject;
05935 
05936     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05937 
05938     <span class="comment">//</span>
05939     <span class="comment">// Loop through all of the driver's device objects, clearing the</span>
05940     <span class="comment">// DO_DEVICE_INITIALIZING flag.</span>
05941     <span class="comment">//</span>
05942 
05943     DriverObject-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a147">DRVO_INITIALIZED</a>;
05944     <span class="keywordflow">while</span> (deviceObject) {
05945         deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> &amp;= ~<a class="code" href="../../d0/d5/io_8h.html#a128">DO_DEVICE_INITIALIZING</a>;
05946         deviceObject = deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o4">NextDevice</a>;
05947     }
05948 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a217" doxytag="iop.h::IopReportResourceUsage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopReportResourceUsage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING DriverClassName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_RESOURCE_LIST DriverList&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG DriverListSize&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_RESOURCE_LIST DeviceList&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG DeviceListSize&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>OverrideConflict</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ConflictDetected</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a223" doxytag="iop.h::IopSafebootDriverLoad" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopSafebootDriverLoad           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PUNICODE_STRING&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DriverId</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l08822">8822</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00181">CmRegistryMachineSystemCurrentControlSetControlSafeBoot</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00044">InitSafeBootMode</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01883">RtlAppendUnicodeStringToString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01821">RtlAppendUnicodeToString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01763">RtlCopyUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l02525">IopCallDriverAddDevice()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>.
<p>
<pre class="fragment"><div>08827                    :
08828 
08829     Checks to see <span class="keywordflow">if</span> a driver or service <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> included
08830     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current safeboot registry section.
08831 
08832 Arguments:
08833 
08834     DriverId - Specifies which driver <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be validated.
08835         The string should contain a driver executable name
08836         like <a class="code" href="../../d8/d7/udbgk_8c.html#a2">foo</a>.sys or a GUID <span class="keywordflow">for</span> a pnp driver <span class="keyword">class</span>.
08837 
08838 Return Value:
08839 
08840     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>    - driver/service <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry
08841     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>   - driver/service <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> NOT in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry
08842 
08843 --*/
08844 {
08845     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
08846     HANDLE hSafeBoot,hGuid;
08847     UNICODE_STRING safeBootKey;
08848     UNICODE_STRING SafeBootTypeString;
08849 
08850 
08851 
08852     <span class="comment">//</span>
08853     <span class="comment">// set the first part of the registry key name</span>
08854     <span class="comment">//</span>
08855 
08856     <span class="keywordflow">switch</span> (<a class="code" href="../../d8/d1/init_8h.html#a18">InitSafeBootMode</a>) {
08857         <span class="keywordflow">case</span> SAFEBOOT_MINIMAL:
08858             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;SafeBootTypeString,SAFEBOOT_MINIMAL_STR_W);
08859             <span class="keywordflow">break</span>;
08860 
08861         <span class="keywordflow">case</span> SAFEBOOT_NETWORK:
08862             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;SafeBootTypeString,SAFEBOOT_NETWORK_STR_W);
08863             <span class="keywordflow">break</span>;
08864 
08865         <span class="keywordflow">case</span> SAFEBOOT_DSREPAIR:
08866             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
08867 
08868         <span class="keywordflow">default</span>:
08869             KdPrint((<span class="stringliteral">"SAFEBOOT: invalid safeboot option = %d\n"</span>,InitSafeBootMode));
08870             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08871     }
08872 
08873     safeBootKey.Length = 0;
08874     safeBootKey.MaximumLength = DriverId-&gt;Length + SafeBootTypeString.Length + (4*<span class="keyword">sizeof</span>(WCHAR));
08875     safeBootKey.Buffer = (PWCHAR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool,safeBootKey.MaximumLength);
08876     <span class="keywordflow">if</span> (!safeBootKey.Buffer) {
08877         KdPrint((<span class="stringliteral">"SAFEBOOT: could not allocate pool\n"</span>));
08878         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08879     }
08880 
08881     <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>(&amp;safeBootKey,&amp;SafeBootTypeString);
08882     status = <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;safeBootKey,L<span class="stringliteral">"\\"</span>);
08883     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08884         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (safeBootKey.Buffer);
08885         KdPrint((<span class="stringliteral">"SAFEBOOT: could not create registry key string = %x\n"</span>,status));
08886         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08887     }
08888     status = <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;safeBootKey,DriverId);
08889     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08890         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (safeBootKey.Buffer);
08891         KdPrint((<span class="stringliteral">"SAFEBOOT: could not create registry key string = %x\n"</span>,status));
08892         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08893     }
08894 
08895     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a> (
08896         &amp;hSafeBoot,
08897         NULL,
08898         &amp;CmRegistryMachineSystemCurrentControlSetControlSafeBoot,
08899         KEY_ALL_ACCESS,
08900         FALSE
08901         );
08902     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08903         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a> (
08904             &amp;hGuid,
08905             hSafeBoot,
08906             &amp;safeBootKey,
08907             KEY_ALL_ACCESS,
08908             FALSE
08909             );
08910         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hSafeBoot);
08911         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08912             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hGuid);
08913             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(safeBootKey.Buffer);
08914             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
08915         }
08916     }
08917 
08918     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(safeBootKey.Buffer);
08919 
08920     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08921 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a208" doxytag="iop.h::IopSetEaOrQuotaInformationFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopSetEaOrQuotaInformationFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SetEa</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l06326">6326</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01154">DO_BUFFERED_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01156">DO_DIRECT_IO</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00127">ExAllocatePoolWithQuota</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01184">_DEVICE_OBJECT::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01492">FO_ALERTABLE_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01491">FO_SYNCHRONOUS_IO</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00652">IoAllocateIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00805">IoAllocateMdl()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02392">IoCheckEaBufferValidity()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02874">IoCheckQuotaBufferValidity()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00044">IoFileObjectType</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00595">IopAcquireFastLock</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00181">IopAcquireFileObjectLock()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00284">IopAllocateIrpCleanup()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01934">IopExceptionCleanup()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06926">IopSynchronousApiServiceTail()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l07030">IopSynchronousServiceTail()</a>, <a class="el" href="../../d2/d1/mm_8h.html#a344a168">IoReadAccess</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01554">IRP_BUFFERED_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01555">IRP_DEALLOCATE_BUFFER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00063">IRP_MJ_SET_EA</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00081">IRP_MJ_SET_QUOTA</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01552">IRP_SYNCHRONOUS_API</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00238">MmProbeAndLockPages()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a240a140">OtherTransfer</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o24">_IRP::Overlay</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01498">ProbeForWriteIoStatus</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01641">_IRP::RequestorMode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01711">_IRP::UserBuffer</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>.
<p>
Referenced by <a class="el" href="../../d1/d2/qsquota_8c-source.html#l00602">NtSetQuotaInformationFile()</a>.
<p>
<pre class="fragment"><div>06336                    :
06337 
06338     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NtSetEa[Quota]InformationFile system services
06339     to either modify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> EAs on a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota entries on a volume.  All of
06340     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified entries in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer are <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> or volume.
06341 
06342 Arguments:
06343 
06344     FileHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>/volume <span class="keywordflow">for</span> which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entries are
06345         to be applied.
06346 
06347     IoStatusBlock - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's I/O status block.
06348 
06349     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Supplies a buffer containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entries to be added/modified.
06350 
06351     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
06352 
06353     SetEa - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> BOOLEAN that indicates whether to change <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> EAs on a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> or
06354         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota entries on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume.
06355 
06356 Return Value:
06357 
06358     The status returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> completion status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
06359 
06360 --*/
06361 
06362 {
06363     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
06364     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
06365     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
06366     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
06367     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> event = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06368     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> requestorMode;
06369     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
06370     IO_STATUS_BLOCK localIoStatus;
06371     BOOLEAN synchronousIo;
06372 
06373     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
06374 
06375     <span class="comment">//</span>
06376     <span class="comment">// Get the previous mode;  i.e., the mode of the caller.</span>
06377     <span class="comment">//</span>
06378 
06379     requestorMode = KeGetPreviousMode();
06380 
06381     <span class="keywordflow">if</span> (requestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
06382 
06383         <span class="comment">//</span>
06384         <span class="comment">// The caller's access mode is user, so probe each of the arguments</span>
06385         <span class="comment">// and capture them as necessary.  If any failures occur, the condition</span>
06386         <span class="comment">// handler will be invoked to handle them.  It will simply cleanup and</span>
06387         <span class="comment">// return an access violation status code back to the system service</span>
06388         <span class="comment">// dispatcher.</span>
06389         <span class="comment">//</span>
06390 
06391         <span class="keywordflow">try</span> {
06392 
06393             <span class="comment">//</span>
06394             <span class="comment">// The IoStatusBlock parameter must be writeable by the caller.</span>
06395             <span class="comment">//</span>
06396 
06397             <a class="code" href="../../d5/d8/ex_8h.html#a31">ProbeForWriteIoStatus</a>( IoStatusBlock);
06398 
06399             <span class="comment">//</span>
06400             <span class="comment">// The Buffer parameter must be readable by the caller.</span>
06401             <span class="comment">//</span>
06402 
06403             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( Buffer, Length, <span class="keyword">sizeof</span>( ULONG ) );
06404 
06405         } except(EXCEPTION_EXECUTE_HANDLER) {
06406 
06407             <span class="comment">//</span>
06408             <span class="comment">// An exception was incurred while probing the caller's parameters.</span>
06409             <span class="comment">// Cleanup and return an appropriate error status code.</span>
06410             <span class="comment">//</span>
06411 
06412             <span class="keywordflow">return</span> GetExceptionCode();
06413         }
06414     }
06415 
06416     <span class="comment">//</span>
06417     <span class="comment">// There were no blatant errors so far, so reference the file object so</span>
06418     <span class="comment">// the target device object can be found.  Note that if the handle does</span>
06419     <span class="comment">// not refer to a file object, or if the caller does not have the required</span>
06420     <span class="comment">// access to the file, then it will fail.</span>
06421     <span class="comment">//</span>
06422 
06423     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( FileHandle,
06424                                         SetEa ? FILE_WRITE_EA : FILE_WRITE_DATA,
06425                                         IoFileObjectType,
06426                                         requestorMode,
06427                                         (PVOID *) &amp;fileObject,
06428                                         NULL );
06429     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
06430         <span class="keywordflow">return</span> status;
06431     }
06432 
06433     <span class="comment">//</span>
06434     <span class="comment">// Make a special check here to determine whether this is a synchronous</span>
06435     <span class="comment">// I/O operation.  If it is, then wait here until the file is owned by</span>
06436     <span class="comment">// the current thread.  If this is not a (serialized) synchronous I/O</span>
06437     <span class="comment">// operation, then allocate and initialize the local event.</span>
06438     <span class="comment">//</span>
06439 
06440     <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
06441 
06442         BOOLEAN interrupted;
06443 
06444         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a13">IopAcquireFastLock</a>( fileObject )) {
06445             status = <a class="code" href="../../d0/d6/iop_8h.html#a147">IopAcquireFileObjectLock</a>( fileObject,
06446                                                requestorMode,
06447                                                (BOOLEAN) ((fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; FO_ALERTABLE_IO) != 0),
06448                                                &amp;interrupted );
06449             <span class="keywordflow">if</span> (interrupted) {
06450                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
06451                 <span class="keywordflow">return</span> status;
06452             }
06453         }
06454         synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06455     } <span class="keywordflow">else</span> {
06456 
06457         <span class="comment">//</span>
06458         <span class="comment">// This is a synchronous API being invoked for a file that is opened</span>
06459         <span class="comment">// for asynchronous I/O.  This means that this system service is</span>
06460         <span class="comment">// to synchronize the completion of the operation before returning</span>
06461         <span class="comment">// to the caller.  A local event is used to do this.</span>
06462         <span class="comment">//</span>
06463 
06464         event = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool, <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> ) );
06465         <span class="keywordflow">if</span> (!event) {
06466             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
06467             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
06468         }
06469         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( event, SynchronizationEvent, FALSE );
06470         synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06471     }
06472 
06473     <span class="comment">//</span>
06474     <span class="comment">// Set the file object to the Not-Signaled state.</span>
06475     <span class="comment">//</span>
06476 
06477     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a> );
06478 
06479     <span class="comment">//</span>
06480     <span class="comment">// Get the address of the target device object.</span>
06481     <span class="comment">//</span>
06482 
06483     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( fileObject );
06484 
06485     <span class="comment">//</span>
06486     <span class="comment">// Allocate and initialize the I/O Request Packet (IRP) for this operation.</span>
06487     <span class="comment">// The allocation is performed with an exception handler in case the</span>
06488     <span class="comment">// caller does not have enough quota to allocate the packet.</span>
06489 
06490     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>( deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>, TRUE );
06491     <span class="keywordflow">if</span> (!irp) {
06492 
06493         <span class="comment">//</span>
06494         <span class="comment">// An IRP could not be allocated.  Cleanup and return an appropriate</span>
06495         <span class="comment">// error status code.</span>
06496         <span class="comment">//</span>
06497 
06498         <span class="keywordflow">if</span> (!(fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>)) {
06499             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( event );
06500         }
06501 
06502         <a class="code" href="../../d0/d6/iop_8h.html#a148">IopAllocateIrpCleanup</a>( fileObject, (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL );
06503 
06504         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
06505     }
06506     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = fileObject;
06507     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
06508     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = requestorMode;
06509 
06510     <span class="comment">//</span>
06511     <span class="comment">// Fill in the service independent parameters in the IRP.</span>
06512     <span class="comment">//</span>
06513 
06514     <span class="keywordflow">if</span> (synchronousIo) {
06515         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06516         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = IoStatusBlock;
06517     } <span class="keywordflow">else</span> {
06518         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = event;
06519         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;localIoStatus;
06520         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>;
06521     }
06522     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine = (PIO_APC_ROUTINE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06523 
06524     <span class="comment">//</span>
06525     <span class="comment">// Get a pointer to the stack location for the first driver.  This will be</span>
06526     <span class="comment">// used to pass the original function codes and parameters.</span>
06527     <span class="comment">//</span>
06528 
06529     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
06530     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = SetEa ? <a class="code" href="../../d0/d5/io_8h.html#a21">IRP_MJ_SET_EA</a> : <a class="code" href="../../d0/d5/io_8h.html#a39">IRP_MJ_SET_QUOTA</a>;
06531     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = fileObject;
06532 
06533     <span class="comment">//</span>
06534     <span class="comment">// Now determine whether this driver expects to have data buffered to it</span>
06535     <span class="comment">// or whether it performs direct I/O.  This is based on the DO_BUFFERED_IO</span>
06536     <span class="comment">// flag in the device object.  if the flag is set, then a system buffer is</span>
06537     <span class="comment">// allocated and driver's data is copied to it.  If the DO_DIRECT_IO flag</span>
06538     <span class="comment">// is set in the device object, then a Memory Descriptor List (MDL) is</span>
06539     <span class="comment">// allocated and the caller's buffer is locked down using it.  Finally, if</span>
06540     <span class="comment">// the driver specifies neither of the flags, then simply pass the address</span>
06541     <span class="comment">// and length of the buffer and allow the driver to perform all of the</span>
06542     <span class="comment">// checking and buffering if any is required.</span>
06543     <span class="comment">//</span>
06544 
06545     <span class="keywordflow">if</span> (deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a123">DO_BUFFERED_IO</a>) {
06546 
06547         PVOID systemBuffer;
06548         ULONG errorOffset;
06549 
06550         <span class="comment">//</span>
06551         <span class="comment">// The driver wishes the caller's buffer to be copied into an</span>
06552         <span class="comment">// intermediary buffer.  Allocate the system buffer and specify</span>
06553         <span class="comment">// that it should be deallocated on completion.  Also check to</span>
06554         <span class="comment">// ensure that the caller's EA list or quota list is valid.  All</span>
06555         <span class="comment">// of this is performed within an exception handler that will perform</span>
06556         <span class="comment">// cleanup if the operation fails.</span>
06557         <span class="comment">//</span>
06558 
06559         <span class="keywordflow">try</span> {
06560 
06561             <span class="comment">//</span>
06562             <span class="comment">// Allocate the intermediary system buffer and charge the caller</span>
06563             <span class="comment">// quota for its allocation.  Copy the caller's buffer into the</span>
06564             <span class="comment">// system buffer and check to ensure that it is valid.</span>
06565             <span class="comment">//</span>
06566 
06567             systemBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a11">ExAllocatePoolWithQuota</a>( NonPagedPool, Length );
06568 
06569             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = systemBuffer;
06570 
06571             RtlCopyMemory( systemBuffer, Buffer, Length );
06572 
06573             <span class="keywordflow">if</span> (SetEa) {
06574                 status = <a class="code" href="../../d4/d6/iosubs_8c.html#a33">IoCheckEaBufferValidity</a>( systemBuffer,
06575                                                   Length,
06576                                                   &amp;errorOffset );
06577             } <span class="keywordflow">else</span> {
06578                 status = <a class="code" href="../../d4/d6/iosubs_8c.html#a37">IoCheckQuotaBufferValidity</a>( systemBuffer,
06579                                                      Length,
06580                                                      &amp;errorOffset );
06581             }
06582 
06583             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
06584                 IoStatusBlock-&gt;Status = status;
06585                 IoStatusBlock-&gt;Information = errorOffset;
06586                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( status );
06587             }
06588 
06589         } except(EXCEPTION_EXECUTE_HANDLER) {
06590 
06591             <span class="comment">//</span>
06592             <span class="comment">// An exception was incurred while allocating the buffer, copying</span>
06593             <span class="comment">// the caller's data into it, or walking the buffer.  Determine</span>
06594             <span class="comment">// what happened, cleanup, and return an appropriate error status</span>
06595             <span class="comment">// code.</span>
06596             <span class="comment">//</span>
06597 
06598             <a class="code" href="../../d0/d6/iop_8h.html#a170">IopExceptionCleanup</a>( fileObject,
06599                                  irp,
06600                                  (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL,
06601                                  event );
06602 
06603             <span class="keywordflow">return</span> GetExceptionCode();
06604 
06605         }
06606 
06607         <span class="comment">//</span>
06608         <span class="comment">// Set the flags so that the completion code knows to deallocate the</span>
06609         <span class="comment">// buffer.</span>
06610         <span class="comment">//</span>
06611 
06612         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a178">IRP_BUFFERED_IO</a> | <a class="code" href="../../d0/d5/io_8h.html#a179">IRP_DEALLOCATE_BUFFER</a>;
06613 
06614     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a125">DO_DIRECT_IO</a>) {
06615 
06616         <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> mdl;
06617 
06618         <span class="comment">//</span>
06619         <span class="comment">// This is a direct I/O operation.  Allocate an MDL and invoke the</span>
06620         <span class="comment">// memory management routine to lock the buffer into memory.  This is</span>
06621         <span class="comment">// done using an exception handler that will perform cleanup if the</span>
06622         <span class="comment">// operation fails.</span>
06623         <span class="comment">//</span>
06624 
06625         mdl = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06626 
06627         <span class="keywordflow">try</span> {
06628 
06629             <span class="comment">//</span>
06630             <span class="comment">// Allocate an MDL, charging quota for it, and hang it off of the</span>
06631             <span class="comment">// IRP.  Probe and lock the pages associated with the caller's</span>
06632             <span class="comment">// buffer for read access and fill in the MDL with the PFNs of those</span>
06633             <span class="comment">// pages.</span>
06634             <span class="comment">//</span>
06635 
06636             mdl = <a class="code" href="../../d4/d6/iosubs_8c.html#a19">IoAllocateMdl</a>( Buffer, Length, FALSE, TRUE, irp );
06637             <span class="keywordflow">if</span> (!mdl) {
06638                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
06639             }
06640             <a class="code" href="../../d5/d6/iosup_8c.html#a41">MmProbeAndLockPages</a>( mdl, requestorMode, IoReadAccess );
06641 
06642         } except(EXCEPTION_EXECUTE_HANDLER) {
06643 
06644             <span class="comment">//</span>
06645             <span class="comment">// An exception was incurred while either probing the caller's</span>
06646             <span class="comment">// buffer or allocating the MDL.  Determine what actually happened,</span>
06647             <span class="comment">// clean everything up, and return an appropriate error status code.</span>
06648             <span class="comment">//</span>
06649 
06650             <a class="code" href="../../d0/d6/iop_8h.html#a170">IopExceptionCleanup</a>( fileObject,
06651                                  irp,
06652                                  (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL,
06653                                  event );
06654 
06655             <span class="keywordflow">return</span> GetExceptionCode();
06656 
06657         }
06658 
06659     } <span class="keywordflow">else</span> {
06660 
06661         <span class="comment">//</span>
06662         <span class="comment">// Pass the address of the user's buffer so the driver has access to</span>
06663         <span class="comment">// it.  It is now the driver's responsibility to do everything.</span>
06664         <span class="comment">//</span>
06665 
06666         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o26">UserBuffer</a> = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
06667 
06668     }
06669 
06670     <span class="comment">//</span>
06671     <span class="comment">// Copy the caller's parameters to the service-specific portion of the</span>
06672     <span class="comment">// IRP.</span>
06673     <span class="comment">//</span>
06674 
06675     <span class="keywordflow">if</span> (SetEa) {
06676         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetEa.Length = Length;
06677     } <span class="keywordflow">else</span> {
06678         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetQuota.Length = Length;
06679     }
06680 
06681     <span class="comment">//</span>
06682     <span class="comment">// Queue the packet, call the driver, and synchronize appropriately with</span>
06683     <span class="comment">// I/O completion.</span>
06684     <span class="comment">//</span>
06685 
06686     status = <a class="code" href="../../d0/d6/iop_8h.html#a212">IopSynchronousServiceTail</a>( deviceObject,
06687                                         irp,
06688                                         fileObject,
06689                                         FALSE,
06690                                         requestorMode,
06691                                         synchronousIo,
06692                                         OtherTransfer );
06693 
06694     <span class="comment">//</span>
06695     <span class="comment">// If the file for this operation was not opened for synchronous I/O, then</span>
06696     <span class="comment">// synchronization of completion of the I/O operation has not yet occurred</span>
06697     <span class="comment">// since the allocated event must be used for synchronous APIs on files</span>
06698     <span class="comment">// opened for asynchronous I/O.  Synchronize the completion of the I/O</span>
06699     <span class="comment">// operation now.</span>
06700     <span class="comment">//</span>
06701 
06702     <span class="keywordflow">if</span> (!synchronousIo) {
06703 
06704         status = <a class="code" href="../../d0/d6/iop_8h.html#a211">IopSynchronousApiServiceTail</a>( status,
06705                                                event,
06706                                                irp,
06707                                                requestorMode,
06708                                                &amp;localIoStatus,
06709                                                IoStatusBlock );
06710     }
06711 
06712     <span class="keywordflow">return</span> status;
06713 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a209" doxytag="iop.h::IopSetRemoteLink" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopSetRemoteLink           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> DestinationFileObject&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFILE_TRACKING_INFORMATION FileInformation&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l06716">6716</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01552">IoBuildDeviceIoControlRequest()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00068">IRP_MJ_FILE_SYSTEM_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00117">IRP_MN_KERNEL_CALL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01552">IRP_SYNCHRONOUS_API</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l00052">_REMOTE_LINK_BUFFER::TrackingInformation</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l07272">IopTrackLink()</a>.
<p>
<pre class="fragment"><div>06724                    :
06725 
06726     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to remote an <a class="code" href="../../d6/d9/restrfil_8c.html#a38">NtSetInformationFile</a> API call via an
06727     FSCTL to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Redirector.  The call will cause <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remote system to perform
06728     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service call to track <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> link <span class="keywordflow">for</span> a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> which was just <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a100">moved</a>.
06729 
06730 Arguments:
06731 
06732     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> that was <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a100">moved</a>.
06733 
06734     DestinationFileObject - Optionally supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span>
06735         destination location <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
06736 
06737     FileInformation - Optionally supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume and <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object IDs of
06738         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
06739 
06740 Return Value:
06741 
06742     The <span class="keyword">final</span> function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> completion status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
06743 
06744 --*/
06745 
06746 {
06747     <a class="code" href="../../d8/d3/struct__REMOTE__LINK__BUFFER.html">REMOTE_LINK_BUFFER</a> remoteBuffer;
06748     IO_STATUS_BLOCK ioStatus;
06749     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
06750     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
06751     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
06752     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
06753     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
06754     ULONG length = 0;
06755 
06756     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
06757 
06758     <span class="comment">//</span>
06759     <span class="comment">// Initialize the event structure to synchronize completion of the I/O</span>
06760     <span class="comment">// request.</span>
06761     <span class="comment">//</span>
06762 
06763     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event,
06764                        NotificationEvent,
06765                        FALSE );
06766 
06767     <span class="comment">//</span>
06768     <span class="comment">// Build an I/O Request Packet to be sent to the file system driver to get</span>
06769     <span class="comment">// the volume ID.</span>
06770     <span class="comment">//</span>
06771 
06772     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject );
06773 
06774     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a25">IoBuildDeviceIoControlRequest</a>( FSCTL_LMR_SET_LINK_TRACKING_INFORMATION,
06775                                          deviceObject,
06776                                          NULL,
06777                                          0,
06778                                          NULL,
06779                                          0,
06780                                          FALSE,
06781                                          &amp;event,
06782                                          &amp;ioStatus );
06783     <span class="keywordflow">if</span> (!irp) {
06784         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
06785     }
06786 
06787     <span class="comment">//</span>
06788     <span class="comment">// Initialize the remote link buffer according to the input information.</span>
06789     <span class="comment">//</span>
06790 
06791     <span class="keywordflow">if</span> (DestinationFileObject) {
06792 
06793         <span class="comment">// The FileObject and DestinationFileObject are on the same machine</span>
06794         remoteBuffer.<a class="code" href="../../d8/d3/struct__REMOTE__LINK__BUFFER.html#o0">TrackingInformation</a>.TargetFileObject = DestinationFileObject;
06795 
06796         <span class="keywordflow">if</span> (FileInformation) {
06797             <span class="comment">// Copy the ObjectInformation from the FileInformation buffer into</span>
06798             <span class="comment">// the TargetLinkTrackingInformationBuffer.  Set 'length' to include</span>
06799             <span class="comment">// this buffer.</span>
06800 
06801             remoteBuffer.<a class="code" href="../../d8/d3/struct__REMOTE__LINK__BUFFER.html#o0">TrackingInformation</a>.TargetLinkTrackingInformationLength
06802                 = length = FileInformation-&gt;ObjectInformationLength;
06803             RtlCopyMemory( &amp;remoteBuffer.<a class="code" href="../../d8/d3/struct__REMOTE__LINK__BUFFER.html#o0">TrackingInformation</a>.TargetLinkTrackingInformationBuffer,
06804                            FileInformation-&gt;ObjectInformation,
06805                            length );
06806         } <span class="keywordflow">else</span> {
06807             <span class="comment">// We don't have any extra FileInformation.</span>
06808             remoteBuffer.<a class="code" href="../../d8/d3/struct__REMOTE__LINK__BUFFER.html#o0">TrackingInformation</a>.TargetLinkTrackingInformationLength = 0;
06809         }
06810 
06811         <span class="comment">// Increment the length to include the size of the non-optional fields in</span>
06812         <span class="comment">// REMOTE_LINK_TRACKING_INFORMATION.</span>
06813         length += <span class="keyword">sizeof</span>( <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> ) + <span class="keyword">sizeof</span>( ULONG );
06814 
06815     } <span class="keywordflow">else</span> {
06816         <span class="comment">// There's no DestinationFileObject, so all the necessary information is in the</span>
06817         <span class="comment">// FileInformation structure.</span>
06818         length = FileInformation-&gt;ObjectInformationLength + <span class="keyword">sizeof</span>( HANDLE ) + <span class="keyword">sizeof</span>( ULONG );
06819         RtlCopyMemory( &amp;remoteBuffer.<a class="code" href="../../d8/d3/struct__REMOTE__LINK__BUFFER.html#o0">TrackingInformation</a>,
06820                        FileInformation,
06821                        length );
06822         remoteBuffer.<a class="code" href="../../d8/d3/struct__REMOTE__LINK__BUFFER.html#o0">TrackingInformation</a>.TargetFileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06823     }
06824 
06825     <span class="comment">//</span>
06826     <span class="comment">// Fill in the remainder of the IRP to retrieve the object ID for the</span>
06827     <span class="comment">// file.</span>
06828     <span class="comment">//</span>
06829 
06830     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>;
06831     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = &amp;remoteBuffer;
06832     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = FileObject;
06833 
06834     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
06835     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = FileObject;
06836     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a26">IRP_MJ_FILE_SYSTEM_CONTROL</a>;
06837     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a51">IRP_MN_KERNEL_CALL</a>;
06838     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.FileSystemControl.InputBufferLength = length;
06839 
06840     <span class="comment">//</span>
06841     <span class="comment">// Take out another reference to the file object to guarantee that it does</span>
06842     <span class="comment">// not get deleted.</span>
06843     <span class="comment">//</span>
06844 
06845     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( FileObject );
06846 
06847     <span class="comment">//</span>
06848     <span class="comment">// Call the driver to get the request.</span>
06849     <span class="comment">//</span>
06850 
06851     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject, irp );
06852 
06853     <span class="comment">//</span>
06854     <span class="comment">// Synchronize completion of the request.</span>
06855     <span class="comment">//</span>
06856 
06857     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
06858         status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
06859                                         Executive,
06860                                         KernelMode,
06861                                         FALSE,
06862                                         (PLARGE_INTEGER) NULL );
06863         status = ioStatus.Status;
06864     }
06865 
06866     <span class="keywordflow">return</span> status;
06867 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a222" doxytag="iop.h::IopSetupRemoteBootCard" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopSetupRemoteBootCard           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LoaderBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>UniqueIdHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>UnicodeDeviceInstance</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/netboot_8c-source.html#l01982">1982</a> of file <a class="el" href="../../d5/d5/netboot_8c-source.html">netboot.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00175">CmRegistryMachineSystemCurrentControlSet</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00180">CmRegistryMachineSystemCurrentControlSetControlClass</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00721">IopRemoteBootCardInitialized</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00471">_SETUP_LOADER_BLOCK::NetbootCardDriverName</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00465">_SETUP_LOADER_BLOCK::NetbootCardHardwareId</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00504">_SETUP_LOADER_BLOCK::NetbootCardInfo</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00496">_SETUP_LOADER_BLOCK::NetbootCardRegistry</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00477">_SETUP_LOADER_BLOCK::NetbootCardServiceName</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00102">RtlInitAnsiString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00056">RtlInitString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d2/d7/regtest_8c.html#a2">strlen()</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>.
<p>
<pre class="fragment"><div>01990                    :
01991 
01992     This function modifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry to set up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> netboot card.
01993     We must <span class="keywordflow">do</span> <span class="keyword">this</span> here since <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> card <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to boot, we can'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>
01994     wait <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">class </span>installer to run.
01995 
01996     THIS ASSUMES THAT IOREMOTEBOOTCLIENT IS <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>.
01997 
01998 Arguments:
01999 
02000     LoaderBlock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader parameter block that was
02001         created by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> OS Loader.
02002 
02003     UniqueIdHandle - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device's unique node under <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02004         Enum key.
02005 
02006     UnicodeDeviceInstance - The device instance assigned to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device.
02007 
02008 Return Value:
02009 
02010     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
02011 
02012 --*/
02013 
02014 {
02015     <a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html">PSETUP_LOADER_BLOCK</a> setupLoaderBlock;
02016     UNICODE_STRING unicodeName, pnpInstanceId, keyName;
02017     HANDLE tmpHandle;
02018     HANDLE parametersHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02019     HANDLE currentControlSetHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02020     HANDLE remoteBootHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02021     HANDLE instanceHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02022     PWCHAR componentIdBuffer, curComponentIdLoc;
02023     PCHAR registryList;
02024     ULONG componentIdLength;
02025     WCHAR tempNameBuffer[32];
02026     WCHAR tempValueBuffer[128];
02027     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02028     ULONG tmpValue, length;
02029     PKEY_VALUE_PARTIAL_INFORMATION keyValue;
02030     PKEY_VALUE_BASIC_INFORMATION keyValueBasic;
02031     UCHAR dataBuffer[FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION, Data) + 128];
02032     ULONG enumerateIndex;
02033     OBJECT_ATTRIBUTES objectAttributes;
02034     ULONG disposition;
02035 
02036     <span class="comment">//</span>
02037     <span class="comment">// If we already think we have initialized a remote boot card, then</span>
02038     <span class="comment">// exit (should not really happen once we identify cards using the</span>
02039     <span class="comment">// bus/slot.</span>
02040     <span class="comment">//</span>
02041 
02042     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/iodata_8c.html#a74">IopRemoteBootCardInitialized</a>) {
02043         <span class="keywordflow">return</span> STATUS_SUCCESS;
02044     }
02045 
02046     <span class="comment">//</span>
02047     <span class="comment">// setupLoaderBlock will always be non-NULL if we are</span>
02048     <span class="comment">// remote booting, even if we are not in setup.</span>
02049     <span class="comment">//</span>
02050 
02051     setupLoaderBlock = LoaderBlock-&gt;SetupLoaderBlock;
02052 
02053     <span class="comment">//</span>
02054     <span class="comment">// Open the current control set.</span>
02055     <span class="comment">//</span>
02056 
02057     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;currentControlSetHandle,
02058                                 NULL,
02059                                 &amp;CmRegistryMachineSystemCurrentControlSet,
02060                                 KEY_ALL_ACCESS,
02061                                 FALSE
02062                                 );
02063 
02064     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02065         <span class="keywordflow">goto</span> cleanup;
02066     }
02067 
02068     <span class="comment">//</span>
02069     <span class="comment">// Open the Control\RemoteBoot key, which may not exist.</span>
02070     <span class="comment">//</span>
02071 
02072     PiWstrToUnicodeString(&amp;unicodeName, L<span class="stringliteral">"Control\\RemoteBoot"</span>);
02073 
02074     InitializeObjectAttributes(&amp;objectAttributes,
02075                                &amp;unicodeName,
02076                                OBJ_CASE_INSENSITIVE,
02077                                currentControlSetHandle,
02078                                (PSECURITY_DESCRIPTOR)NULL
02079                                );
02080 
02081     status = ZwCreateKey(&amp;remoteBootHandle,
02082                          KEY_ALL_ACCESS,
02083                          &amp;objectAttributes,
02084                          0,
02085                          (PUNICODE_STRING)NULL,
02086                          0,
02087                          &amp;disposition
02088                          );
02089 
02090     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02091         <span class="keywordflow">goto</span> cleanup;
02092     }
02093 
02094     <span class="comment">//</span>
02095     <span class="comment">// Open the key where the netui code stores information about the cards.</span>
02096     <span class="comment">// During textmode setup this will fail because the Control\Network</span>
02097     <span class="comment">// key is not there. After that it should work, although we may need</span>
02098     <span class="comment">// to create the last node in the path.</span>
02099     <span class="comment">//</span>
02100 
02101     PiWstrToUnicodeString(&amp;unicodeName, L<span class="stringliteral">"Control\\Network\\{4D36E972-E325-11CE-BFC1-08002BE10318}\\{54C7D140-09EF-11D1-B25A-F5FE627ED95E}"</span>);
02102 
02103     InitializeObjectAttributes(&amp;objectAttributes,
02104                                &amp;unicodeName,
02105                                OBJ_CASE_INSENSITIVE,
02106                                currentControlSetHandle,
02107                                (PSECURITY_DESCRIPTOR)NULL
02108                                );
02109 
02110     status = ZwCreateKey(&amp;instanceHandle,
02111                          KEY_ALL_ACCESS,
02112                          &amp;objectAttributes,
02113                          0,
02114                          (PUNICODE_STRING)NULL,
02115                          0,
02116                          &amp;disposition
02117                          );
02118 
02119     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02120 
02121         <span class="comment">//</span>
02122         <span class="comment">// If the PnpInstanceID of the first netboot card matches the one</span>
02123         <span class="comment">// for this device node, and the NET_CARD_INFO that the loader</span>
02124         <span class="comment">// found is the same as the one we saved, then this is the same</span>
02125         <span class="comment">// card with the same instance ID as before, so we don't need to</span>
02126         <span class="comment">// do anything.</span>
02127         <span class="comment">//</span>
02128 
02129         PiWstrToUnicodeString(&amp;unicodeName, L<span class="stringliteral">"PnPInstanceID"</span>);
02130         keyValue = (PKEY_VALUE_PARTIAL_INFORMATION)dataBuffer;
02131         RtlZeroMemory(dataBuffer, <span class="keyword">sizeof</span>(dataBuffer));
02132 
02133         status = ZwQueryValueKey(
02134                      instanceHandle,
02135                      &amp;unicodeName,
02136                      KeyValuePartialInformation,
02137                      keyValue,
02138                      <span class="keyword">sizeof</span>(dataBuffer),
02139                      &amp;length);
02140 
02141         <span class="comment">//</span>
02142         <span class="comment">// Check that it matches. We can init the string because we zeroed</span>
02143         <span class="comment">// the dataBuffer before reading the key, so even if the</span>
02144         <span class="comment">// registry value had no NULL at the end that is OK.</span>
02145         <span class="comment">//</span>
02146 
02147         <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) &amp;&amp;
02148             (keyValue-&gt;Type == REG_SZ)) {
02149 
02150             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;pnpInstanceId, (PWSTR)(keyValue-&gt;Data));
02151 
02152             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(UnicodeDeviceInstance, &amp;pnpInstanceId, TRUE)) {
02153 
02154                 <span class="comment">//</span>
02155                 <span class="comment">// Instance ID matched, see if the NET_CARD_INFO matches.</span>
02156                 <span class="comment">//</span>
02157 
02158                 PiWstrToUnicodeString(&amp;unicodeName, L<span class="stringliteral">"NetCardInfo"</span>);
02159                 RtlZeroMemory(dataBuffer, <span class="keyword">sizeof</span>(dataBuffer));
02160 
02161                 status = ZwQueryValueKey(
02162                              remoteBootHandle,
02163                              &amp;unicodeName,
02164                              KeyValuePartialInformation,
02165                              keyValue,
02166                              <span class="keyword">sizeof</span>(dataBuffer),
02167                              &amp;length);
02168 
02169                 <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) &amp;&amp;
02170                     (keyValue-&gt;Type == REG_BINARY) &amp;&amp;
02171                     (keyValue-&gt;DataLength == <span class="keyword">sizeof</span>(NET_CARD_INFO)) &amp;&amp;
02172                     (memcmp(keyValue-&gt;Data, setupLoaderBlock-&gt;NetbootCardInfo, <span class="keyword">sizeof</span>(NET_CARD_INFO)) == 0)) {
02173 
02174                     <span class="comment">//</span>
02175                     <span class="comment">// Everything matched, so no need to do any setup.</span>
02176                     <span class="comment">//</span>
02177 
02178                     status = STATUS_SUCCESS;
02179                     <span class="keywordflow">goto</span> cleanup;
02180 
02181                 }
02182             }
02183         }
02184     }
02185 
02186 
02187     <span class="comment">//</span>
02188     <span class="comment">// We come through here if the saved registry data was missing or</span>
02189     <span class="comment">// not correct. Write all the relevant values to the registry.</span>
02190     <span class="comment">//</span>
02191 
02192 
02193     <span class="comment">//</span>
02194     <span class="comment">// Service name is in the loader block.</span>
02195     <span class="comment">//</span>
02196 
02197     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VALUE_SERVICE);
02198     ZwSetValueKey(UniqueIdHandle,
02199                   &amp;unicodeName,
02200                   TITLE_INDEX_VALUE,
02201                   REG_SZ,
02202                   setupLoaderBlock-&gt;NetbootCardServiceName,
02203                   (wcslen(setupLoaderBlock-&gt;NetbootCardServiceName) + 1) * <span class="keyword">sizeof</span>(WCHAR)
02204                   );
02205 
02206     <span class="comment">//</span>
02207     <span class="comment">// ClassGUID is the known net card GUID.</span>
02208     <span class="comment">//</span>
02209 
02210     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VALUE_CLASSGUID);
02211     ZwSetValueKey(UniqueIdHandle,
02212                   &amp;unicodeName,
02213                   TITLE_INDEX_VALUE,
02214                   REG_SZ,
02215                   L<span class="stringliteral">"{4D36E972-E325-11CE-BFC1-08002BE10318}"</span>,
02216                   <span class="keyword">sizeof</span>(L<span class="stringliteral">"{4D36E972-E325-11CE-BFC1-08002BE10318}"</span>)
02217                   );
02218 
02219     <span class="comment">//</span>
02220     <span class="comment">// Driver is the first net card.</span>
02221     <span class="comment">//</span>
02222 
02223     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VALUE_DRIVER);
02224     ZwSetValueKey(UniqueIdHandle,
02225                   &amp;unicodeName,
02226                   TITLE_INDEX_VALUE,
02227                   REG_SZ,
02228                   L<span class="stringliteral">"{4D36E972-E325-11CE-BFC1-08002BE10318}\\0000"</span>,
02229                   <span class="keyword">sizeof</span>(L<span class="stringliteral">"{4D36E972-E325-11CE-BFC1-08002BE10318}\\0000"</span>)
02230                   );
02231 
02232 <span class="preprocessor">#ifdef REMOTE_BOOT</span>
02233 <span class="preprocessor"></span>    <span class="comment">//</span>
02234     <span class="comment">// Identify this as the netboot card so the network class</span>
02235     <span class="comment">// installer knows to assign the reserved GUID.</span>
02236     <span class="comment">//</span>
02237 
02238     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VALUE_CONFIG_FLAGS);
02239 
02240     keyValue = (PKEY_VALUE_PARTIAL_INFORMATION)dataBuffer;
02241     RtlZeroMemory(dataBuffer, <span class="keyword">sizeof</span>(dataBuffer));
02242 
02243     status = ZwQueryValueKey(UniqueIdHandle,
02244                              &amp;unicodeName,
02245                              KeyValuePartialInformation,
02246                              keyValue,
02247                              <span class="keyword">sizeof</span>(dataBuffer),
02248                              &amp;length);
02249 
02250     <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) &amp;&amp;
02251         (keyValue-&gt;Type == REG_DWORD)) {
02252         <span class="comment">//</span>
02253         <span class="comment">// The ConfigFlags value exists in the registry</span>
02254         <span class="comment">//</span>
02255         tmpValue = (*(PULONG)keyValue-&gt;Data) | CONFIGFLAG_NETBOOT_CARD;
02256     } <span class="keywordflow">else</span> {
02257         tmpValue = CONFIGFLAG_NETBOOT_CARD;
02258     }
02259 
02260     ZwSetValueKey(UniqueIdHandle,
02261                   &amp;unicodeName,
02262                   TITLE_INDEX_VALUE,
02263                   REG_DWORD,
02264                   &amp;tmpValue,
02265                   <span class="keyword">sizeof</span>(tmpValue)
02266                   );
02267 <span class="preprocessor">#endif</span>
02268 <span class="preprocessor"></span>
02269 
02270     <span class="comment">//</span>
02271     <span class="comment">// Open a handle for card parameters. We write RemoteBootCard plus</span>
02272     <span class="comment">// whatever the BINL server told us to write.</span>
02273     <span class="comment">//</span>
02274 
02275     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;tmpHandle,
02276                                 NULL,
02277                                 &amp;CmRegistryMachineSystemCurrentControlSetControlClass,
02278                                 KEY_ALL_ACCESS,
02279                                 FALSE
02280                                 );
02281 
02282     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02283         <span class="keywordflow">goto</span> cleanup;
02284     }
02285 
02286     PiWstrToUnicodeString(&amp;unicodeName, L<span class="stringliteral">"{4D36E972-E325-11CE-BFC1-08002BE10318}\\0000"</span>);
02287 
02288     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;parametersHandle,
02289                                 tmpHandle,
02290                                 &amp;unicodeName,
02291                                 KEY_ALL_ACCESS,
02292                                 FALSE
02293                                 );
02294 
02295     ZwClose(tmpHandle);
02296 
02297     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02298         <span class="keywordflow">goto</span> cleanup;
02299     }
02300 
02301     <span class="comment">//</span>
02302     <span class="comment">// We know that this is a different NIC, so remove all the old parameters.</span>
02303     <span class="comment">//</span>
02304 
02305     keyValueBasic = (PKEY_VALUE_BASIC_INFORMATION)dataBuffer;
02306     enumerateIndex = 0;
02307 
02308     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02309 
02310         RtlZeroMemory(dataBuffer, <span class="keyword">sizeof</span>(dataBuffer));
02311 
02312         status = ZwEnumerateValueKey(
02313                     parametersHandle,
02314                     enumerateIndex,
02315                     KeyValueBasicInformation,
02316                     keyValueBasic,
02317                     <span class="keyword">sizeof</span>(dataBuffer),
02318                     &amp;length
02319                     );
02320         <span class="keywordflow">if</span> (status == STATUS_NO_MORE_ENTRIES) {
02321             status = STATUS_SUCCESS;
02322             <span class="keywordflow">break</span>;
02323         }
02324 
02325         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02326             <span class="keywordflow">goto</span> cleanup;
02327         }
02328 
02329         <span class="comment">//</span>
02330         <span class="comment">// We don't delete "NetCfgInstanceID", it won't change and</span>
02331         <span class="comment">// its presence signifies to the net class installer that</span>
02332         <span class="comment">// this is a replacement not a clean install.</span>
02333         <span class="comment">//</span>
02334 
02335         <span class="keywordflow">if</span> (_wcsicmp(keyValueBasic-&gt;Name, L<span class="stringliteral">"NetCfgInstanceID"</span>) != 0) {
02336 
02337             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;keyName, keyValueBasic-&gt;Name);
02338             status = ZwDeleteValueKey(
02339                         parametersHandle,
02340                         &amp;keyName
02341                         );
02342 
02343             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02344                 <span class="keywordflow">goto</span> cleanup;
02345             }
02346 
02347         } <span class="keywordflow">else</span> {
02348 
02349             enumerateIndex = 1;   <span class="comment">// leave NetCfgInstanceID at index 0</span>
02350         }
02351 
02352     }
02353 
02354     <span class="comment">//</span>
02355     <span class="comment">// Write a parameter called RemoteBootCard set to TRUE, this</span>
02356     <span class="comment">// is primarily so NDIS can recognize this as such.</span>
02357     <span class="comment">//</span>
02358 
02359     PiWstrToUnicodeString(&amp;unicodeName, L<span class="stringliteral">"RemoteBootCard"</span>);
02360     tmpValue = 1;
02361     ZwSetValueKey(parametersHandle,
02362                   &amp;unicodeName,
02363                   TITLE_INDEX_VALUE,
02364                   REG_DWORD,
02365                   &amp;tmpValue,
02366                   <span class="keyword">sizeof</span>(tmpValue)
02367                   );
02368 
02369 
02370     <span class="comment">//</span>
02371     <span class="comment">// Store any other parameters sent from the server.</span>
02372     <span class="comment">//</span>
02373 
02374     registryList = setupLoaderBlock-&gt;NetbootCardRegistry;
02375 
02376     <span class="keywordflow">if</span> (registryList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02377 
02378         STRING aString;
02379         UNICODE_STRING uString, uString2;
02380 
02381         <span class="comment">//</span>
02382         <span class="comment">// The registry list is a series of name\0type\0value\0, with</span>
02383         <span class="comment">// a final \0 at the end. It is in ANSI, not UNICODE.</span>
02384         <span class="comment">//</span>
02385         <span class="comment">// All values are stored under parametersHandle. Type is 1 for</span>
02386         <span class="comment">// DWORD and 2 for SZ.</span>
02387         <span class="comment">//</span>
02388 
02389         uString.Buffer = tempNameBuffer;
02390         uString.MaximumLength = <span class="keyword">sizeof</span>(tempNameBuffer);
02391 
02392         <span class="keywordflow">while</span> (*registryList != <span class="charliteral">'\0'</span>) {
02393 
02394             <span class="comment">//</span>
02395             <span class="comment">// First the name.</span>
02396             <span class="comment">//</span>
02397 
02398             <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>(&amp;aString, registryList);
02399             <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;uString, &amp;aString, FALSE);
02400 
02401             <span class="comment">//</span>
02402             <span class="comment">// Now the type.</span>
02403             <span class="comment">//</span>
02404 
02405             registryList += (<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(registryList) + 1);
02406 
02407             <span class="keywordflow">if</span> (*registryList == <span class="charliteral">'1'</span>) {
02408 
02409                 <span class="comment">//</span>
02410                 <span class="comment">// A DWORD, parse it.</span>
02411                 <span class="comment">//</span>
02412 
02413                 registryList += 2;   <span class="comment">// skip "1\0"</span>
02414                 tmpValue = 0;
02415 
02416                 <span class="keywordflow">while</span> (*registryList != <span class="charliteral">'\0'</span>) {
02417                     tmpValue = (tmpValue * 10) + (*registryList - <span class="charliteral">'0'</span>);
02418                     ++registryList;
02419                 }
02420 
02421                 ZwSetValueKey(parametersHandle,
02422                               &amp;uString,
02423                               TITLE_INDEX_VALUE,
02424                               REG_DWORD,
02425                               &amp;tmpValue,
02426                               <span class="keyword">sizeof</span>(tmpValue)
02427                               );
02428 
02429                 registryList += (<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(registryList) + 1);
02430 
02431             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*registryList == <span class="charliteral">'2'</span>) {
02432 
02433                 <span class="comment">//</span>
02434                 <span class="comment">// An SZ, convert to Unicode.</span>
02435                 <span class="comment">//</span>
02436 
02437                 registryList += 2;   <span class="comment">// skip "2\0"</span>
02438 
02439                 uString2.Buffer = tempValueBuffer;
02440                 uString2.MaximumLength = <span class="keyword">sizeof</span>(tempValueBuffer);
02441                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;aString, registryList);
02442                 <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;uString2, &amp;aString, FALSE);
02443 
02444                 ZwSetValueKey(parametersHandle,
02445                               &amp;uString,
02446                               TITLE_INDEX_VALUE,
02447                               REG_SZ,
02448                               uString2.Buffer,
02449                               uString2.Length + <span class="keyword">sizeof</span>(WCHAR)
02450                               );
02451 
02452                 registryList += (<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(registryList) + 1);
02453 
02454             } <span class="keywordflow">else</span> {
02455 
02456                 <span class="comment">//</span>
02457                 <span class="comment">// Not "1" or "2", so stop processing registryList.</span>
02458                 <span class="comment">//</span>
02459 
02460                 <span class="keywordflow">break</span>;
02461 
02462             }
02463 
02464         }
02465 
02466     }
02467 
02468     <span class="comment">//</span>
02469     <span class="comment">// Save the NET_CARD_INFO so we can check it next time.</span>
02470     <span class="comment">//</span>
02471 
02472     PiWstrToUnicodeString(&amp;unicodeName, L<span class="stringliteral">"NetCardInfo"</span>);
02473 
02474     ZwSetValueKey(remoteBootHandle,
02475                   &amp;unicodeName,
02476                   TITLE_INDEX_VALUE,
02477                   REG_BINARY,
02478                   setupLoaderBlock-&gt;NetbootCardInfo,
02479                   <span class="keyword">sizeof</span>(NET_CARD_INFO)
02480                   );
02481 
02482 
02483     <span class="comment">//</span>
02484     <span class="comment">// Save the hardware ID, driver name, and service name,</span>
02485     <span class="comment">// so the loader can read  those if the server is down</span>
02486     <span class="comment">// on subsequent boots.</span>
02487     <span class="comment">//</span>
02488 
02489     PiWstrToUnicodeString(&amp;unicodeName, L<span class="stringliteral">"HardwareId"</span>);
02490 
02491     ZwSetValueKey(remoteBootHandle,
02492                   &amp;unicodeName,
02493                   TITLE_INDEX_VALUE,
02494                   REG_SZ,
02495                   setupLoaderBlock-&gt;NetbootCardHardwareId,
02496                   (wcslen(setupLoaderBlock-&gt;NetbootCardHardwareId) + 1) * <span class="keyword">sizeof</span>(WCHAR)
02497                   );
02498 
02499     PiWstrToUnicodeString(&amp;unicodeName, L<span class="stringliteral">"DriverName"</span>);
02500 
02501     ZwSetValueKey(remoteBootHandle,
02502                   &amp;unicodeName,
02503                   TITLE_INDEX_VALUE,
02504                   REG_SZ,
02505                   setupLoaderBlock-&gt;NetbootCardDriverName,
02506                   (wcslen(setupLoaderBlock-&gt;NetbootCardDriverName) + 1) * <span class="keyword">sizeof</span>(WCHAR)
02507                   );
02508 
02509     PiWstrToUnicodeString(&amp;unicodeName, L<span class="stringliteral">"ServiceName"</span>);
02510 
02511     ZwSetValueKey(remoteBootHandle,
02512                   &amp;unicodeName,
02513                   TITLE_INDEX_VALUE,
02514                   REG_SZ,
02515                   setupLoaderBlock-&gt;NetbootCardServiceName,
02516                   (wcslen(setupLoaderBlock-&gt;NetbootCardServiceName) + 1) * <span class="keyword">sizeof</span>(WCHAR)
02517                   );
02518 
02519     <span class="comment">//</span>
02520     <span class="comment">// Save the device instance, in case we need to ID the card later.</span>
02521     <span class="comment">//</span>
02522 
02523     PiWstrToUnicodeString(&amp;unicodeName, L<span class="stringliteral">"DeviceInstance"</span>);
02524 
02525     ZwSetValueKey(remoteBootHandle,
02526                   &amp;unicodeName,
02527                   TITLE_INDEX_VALUE,
02528                   REG_SZ,
02529                   UnicodeDeviceInstance-&gt;Buffer,
02530                   UnicodeDeviceInstance-&gt;Length + <span class="keyword">sizeof</span>(WCHAR)
02531                   );
02532 
02533     <span class="comment">//</span>
02534     <span class="comment">// Make sure we only pick one card to setup this way!</span>
02535     <span class="comment">//</span>
02536 
02537     <a class="code" href="../../d3/d5/iodata_8c.html#a74">IopRemoteBootCardInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02538 
02539 
02540 cleanup:
02541     <span class="keywordflow">if</span> (instanceHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02542         ZwClose(instanceHandle);
02543     }
02544     <span class="keywordflow">if</span> (remoteBootHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02545         ZwClose(remoteBootHandle);
02546     }
02547     <span class="keywordflow">if</span> (parametersHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02548         ZwClose(parametersHandle);
02549     }
02550     <span class="keywordflow">if</span> (currentControlSetHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02551         ZwClose(currentControlSetHandle);
02552     }
02553 
02554     <span class="keywordflow">return</span> status;
02555 
02556 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a210" doxytag="iop.h::IopStartApcHardError" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopStartApcHardError           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>StartContext</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l06870">6870</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00070">IO_DISK_INCREMENT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02960">IoCompleteRequest</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00383">IopApcHardError()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00175">PsCreateSystemThread()</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08769">IoRaiseHardError()</a>.
<p>
<pre class="fragment"><div>06876                    :
06877 
06878     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked in an ExWorker thread when we need to <span class="keywordflow">do</span> a
06879     hard error pop-up, but <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>'s originating thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> at APC level,
06880     ie. <a class="code" href="../../d0/d5/io_8h.html#a524">IoPageRead</a>.  It starts a thread to hold <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pop-up.
06881 
06882 Arguments:
06883 
06884     StartContext - Startup context, contains a <a class="code" href="../../d5/d0/struct__IOP__APC__HARD__ERROR__PACKET.html">IOP_APC_HARD_ERROR_PACKET</a>.
06885 
06886 Return Value:
06887 
06888     None.
06889 
06890 --*/
06891 
06892 {
06893     HANDLE thread;
06894     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
06895 
06896     <span class="comment">//</span>
06897     <span class="comment">//  Create the hard error pop-up thread.  If for whatever reason we</span>
06898     <span class="comment">//  can't do this then just complete the Irp with the error.</span>
06899     <span class="comment">//</span>
06900 
06901     status = <a class="code" href="../../d2/d8/ps_2create_8c.html#a11">PsCreateSystemThread</a>( &amp;thread,
06902                                    0,
06903                                    (POBJECT_ATTRIBUTES)NULL,
06904                                    (HANDLE)0,
06905                                    (PCLIENT_ID)NULL,
06906                                    IopApcHardError,
06907                                    StartContext );
06908 
06909     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) ) {
06910 
06911 
06912         <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>( ((<a class="code" href="../../d5/d0/struct__IOP__APC__HARD__ERROR__PACKET.html">PIOP_APC_HARD_ERROR_PACKET</a>)StartContext)-&gt;Irp,
06913                            IO_DISK_INCREMENT );
06914         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( StartContext );
06915         <span class="keywordflow">return</span>;
06916     }
06917 
06918     <span class="comment">//</span>
06919     <span class="comment">//  Close thread handle</span>
06920     <span class="comment">//</span>
06921 
06922     ZwClose(thread);
06923 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a219" doxytag="iop.h::IopStartNetworkForRemoteBoot" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopStartNetworkForRemoteBoot           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LoaderBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/netboot_8c-source.html#l00770">770</a> of file <a class="el" href="../../d5/d5/netboot_8c-source.html">netboot.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00453">_SETUP_LOADER_BLOCK::DefaultRouter</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00511">_SETUP_LOADER_BLOCK::Flags</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06960">IoGetCurrentProcess()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l01546">IopAssignNetworkDriveLetter()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l04247">IopCacheNetbiosNameForIpAddress()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l04017">IopSetDefaultGateway()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00332">max</a>, <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00065">MAX_PATH</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00471">_SETUP_LOADER_BLOCK::NetbootCardDriverName</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00557">_SETUP_LOADER_BLOCK::NetBootSecret</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d2/d7/io_2create_8c-source.html#l00037">NtCreateFile()</a>, <a class="el" href="../../d2/d6/io_2devctrl_8c-source.html#l00034">NtDeviceIoControlFile()</a>, <a class="el" href="../../d9/d6/io_2fsctrl_8c-source.html#l00034">NtFsControlFile()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01935">RtlCreateUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00514">SETUPBLK_FLAGS_IS_TEXTMODE</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01862">_LOADER_PARAMETER_BLOCK::SetupLoaderBlock</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>.
<p>
<pre class="fragment"><div>00773 {
00774     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00775     HANDLE dgHandle;
00776     HANDLE keyHandle;
00777     OBJECT_ATTRIBUTES objectAttributes;
00778     IO_STATUS_BLOCK ioStatusBlock;
00779     UNICODE_STRING string;
00780     UNICODE_STRING computerName;
00781     UNICODE_STRING domainName;
00782     PUCHAR buffer;
00783     ULONG bufferLength;
00784     PLMR_REQUEST_PACKET rrp;
00785     PLMDR_REQUEST_PACKET drrp;
00786     WKSTA_INFO_502 wkstaConfig;
00787     WKSTA_TRANSPORT_INFO_0 wkstaTransportInfo;
00788     LARGE_INTEGER interval;
00789     ULONG length;
00790     PKEY_VALUE_PARTIAL_INFORMATION keyValue;
00791     BOOLEAN startDatagramReceiver;
00792     ULONG enumerateAttempts;
00793 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
00794 <span class="preprocessor"></span>    PWSTR NetHDCSCPartition;
00795     BOOLEAN leaveRdrHandleOpen;
00796     BOOLEAN pinNetDriver;
00797 <span class="preprocessor">#else</span>
00798 <span class="preprocessor"></span>    HANDLE RdrHandle;
00799 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
00800 <span class="preprocessor"></span>
00801     <span class="comment">//</span>
00802     <span class="comment">// Initialize for cleanup.</span>
00803     <span class="comment">//</span>
00804 
00805     buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00806     computerName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00807     domainName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00808     dgHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00809     RdrHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00810 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
00811 <span class="preprocessor"></span>    NetHDCSCPartition = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00812     leaveRdrHandleOpen = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00813     pinNetDriver = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00814 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
00815 <span class="preprocessor"></span>
00816     <span class="comment">//</span>
00817     <span class="comment">// Allocate a temporary buffer. It has to be big enough for all the</span>
00818     <span class="comment">// various FSCTLs we send down.</span>
00819     <span class="comment">//</span>
00820 
00821     bufferLength = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<span class="keyword">sizeof</span>(LMR_REQUEST_PACKET) + (MAX_PATH + 1) * <span class="keyword">sizeof</span>(WCHAR) +
00822                                                  (DNLEN + 1) * <span class="keyword">sizeof</span>(WCHAR),
00823                        <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<span class="keyword">sizeof</span>(LMDR_REQUEST_PACKET),
00824                            FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION, Data) + MAX_PATH));
00825     bufferLength = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(bufferLength, <span class="keyword">sizeof</span>(LMMR_RI_INITIALIZE_SECRET));
00826 
00827 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
00828 <span class="preprocessor"></span>    NetHDCSCPartition = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00829                             NonPagedPool,
00830                             (80 * <span class="keyword">sizeof</span>(WCHAR)) + bufferLength,
00831                             'bRoI'
00832                             );
00833     <span class="keywordflow">if</span> (NetHDCSCPartition == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00834         KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to allocate buffer\n"</span>));
00835         status = STATUS_INSUFFICIENT_RESOURCES;
00836         <span class="keywordflow">goto</span> cleanup;
00837     }
00838     buffer = (PUCHAR)(NetHDCSCPartition + 80);
00839 <span class="preprocessor">#else</span>
00840 <span class="preprocessor"></span>    buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPool, bufferLength, 'bRoI' );
00841     <span class="keywordflow">if</span> (buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00842         KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to allocate buffer\n"</span>));
00843         status = STATUS_INSUFFICIENT_RESOURCES;
00844         <span class="keywordflow">goto</span> cleanup;
00845     }
00846 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
00847 <span class="preprocessor"></span>
00848     rrp = (PLMR_REQUEST_PACKET)buffer;
00849     drrp = (PLMDR_REQUEST_PACKET)buffer;
00850 
00851     <span class="comment">//</span>
00852     <span class="comment">// Open the redirector and the datagram receiver.</span>
00853     <span class="comment">//</span>
00854 
00855     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"\\Device\\LanmanRedirector"</span> );
00856 
00857     InitializeObjectAttributes(
00858         &amp;objectAttributes,
00859         &amp;string,
00860         OBJ_CASE_INSENSITIVE,
00861         NULL,
00862         NULL
00863         );
00864 
00865     status = <a class="code" href="../../d1/d8/io_2create_8c.html#a0">NtCreateFile</a>(
00866                 &amp;RdrHandle,
00867                 GENERIC_READ | GENERIC_WRITE,
00868                 &amp;objectAttributes,
00869                 &amp;ioStatusBlock,
00870                 NULL,
00871                 0,
00872                 FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE,
00873                 FILE_OPEN,
00874                 FILE_SYNCHRONOUS_IO_NONALERT,
00875                 NULL,
00876                 0
00877                 );
00878     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00879         KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to open redirector: %x\n"</span>, status ));
00880         <span class="keywordflow">goto</span> cleanup;
00881     }
00882 
00883 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
00884 <span class="preprocessor"></span>    RdrHandleProcess = &amp;<a class="code" href="../../d4/d6/iosubs_8c.html#a70">IoGetCurrentProcess</a>()-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>;
00885 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
00886 <span class="preprocessor"></span>
00887     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, DD_BROWSER_DEVICE_NAME_U );
00888 
00889     InitializeObjectAttributes(
00890         &amp;objectAttributes,
00891         &amp;string,
00892         OBJ_CASE_INSENSITIVE,
00893         NULL,
00894         NULL
00895         );
00896 
00897     status = <a class="code" href="../../d1/d8/io_2create_8c.html#a0">NtCreateFile</a>(
00898                 &amp;dgHandle,
00899                 GENERIC_READ | GENERIC_WRITE,
00900                 &amp;objectAttributes,
00901                 &amp;ioStatusBlock,
00902                 NULL,
00903                 0,
00904                 FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE,
00905                 FILE_OPEN,
00906                 FILE_SYNCHRONOUS_IO_NONALERT,
00907                 NULL,
00908                 0
00909                 );
00910     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00911         KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to open datagram receiver: %x\n"</span>, status ));
00912         <span class="keywordflow">goto</span> cleanup;
00913     }
00914 
00915     <span class="comment">//</span>
00916     <span class="comment">// If the setup loader block has a disk secret in it provided by the</span>
00917     <span class="comment">// loader, pass this down to the redirector (do this before sending</span>
00918     <span class="comment">// the LMR_START, since that uses this information).</span>
00919     <span class="comment">//</span>
00920 
00921 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
00922 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o36">NetBootSecret</a>)
00923 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
00924 <span class="preprocessor"></span>    {
00925         PLMMR_RI_INITIALIZE_SECRET RbInit = (PLMMR_RI_INITIALIZE_SECRET)buffer;
00926 
00927         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o36">NetBootSecret</a> != NULL);
00928         RtlCopyMemory(
00929             &amp;RbInit-&gt;Secret,
00930             LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o36">NetBootSecret</a>,
00931             <span class="keyword">sizeof</span>(RI_SECRET));
00932 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
00933 <span class="preprocessor"></span>        RbInit-&gt;UsePassword2 = LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;NetBootUsePassword2;
00934 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
00935 <span class="preprocessor"></span>
00936         status = <a class="code" href="../../d8/d7/io_2fsctrl_8c.html#a0">NtFsControlFile</a>(
00937                     RdrHandle,
00938                     NULL,
00939                     NULL,
00940                     NULL,
00941                     &amp;ioStatusBlock,
00942                     FSCTL_LMMR_RI_INITIALIZE_SECRET,
00943                     buffer,
00944                     <span class="keyword">sizeof</span>(LMMR_RI_INITIALIZE_SECRET),
00945                     NULL,
00946                     0
00947                     );
00948 
00949         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00950             status = ioStatusBlock.Status;
00951         }
00952         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00953             KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to FSCTL(RB initialize) redirector: %x\n"</span>, status ));
00954             <span class="keywordflow">goto</span> cleanup;
00955         }
00956     }
00957 
00958     <span class="comment">//</span>
00959     <span class="comment">// Read the computer name and domain name from the registry so we</span>
00960     <span class="comment">// can give them to the datagram receiver. During textmode setup</span>
00961     <span class="comment">// the domain name will not be there, so we won't start the datagram</span>
00962     <span class="comment">// receiver, which is fine.</span>
00963     <span class="comment">//</span>
00964     <span class="comment">// BUGBUG: Figure out the correct location to read the domain name</span>
00965     <span class="comment">// from -- this one is a special hack in winnt.sif just for this.</span>
00966     <span class="comment">//</span>
00967 
00968     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\ComputerName\\ComputerName"</span> );
00969 
00970     InitializeObjectAttributes(
00971         &amp;objectAttributes,
00972         &amp;string,
00973         OBJ_CASE_INSENSITIVE,
00974         NULL,
00975         NULL
00976         );
00977 
00978     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( &amp;keyHandle, KEY_ALL_ACCESS, &amp;objectAttributes );
00979     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00980         KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to open ComputerName key: %x\n"</span>, status ));
00981         <span class="keywordflow">goto</span> cleanup;
00982     }
00983 
00984     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"ComputerName"</span> );
00985 
00986     keyValue = (PKEY_VALUE_PARTIAL_INFORMATION)buffer;
00987     RtlZeroMemory(buffer, bufferLength);
00988 
00989     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
00990                  keyHandle,
00991                  &amp;string,
00992                  KeyValuePartialInformation,
00993                  keyValue,
00994                  bufferLength,
00995                  &amp;length);
00996 
00997     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( keyHandle );
00998     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00999         KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to query ComputerName value: %x\n"</span>, status ));
01000         <span class="keywordflow">goto</span> cleanup;
01001     }
01002 
01003     <span class="keywordflow">if</span> ( !<a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;computerName, (PWSTR)keyValue-&gt;Data) ) {
01004         KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to create ComputerName string\n"</span> ));
01005         status = STATUS_INSUFFICIENT_RESOURCES;
01006         <span class="keywordflow">goto</span> cleanup;
01007     }
01008 
01009     domainName.Length = 0;
01010 
01011     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\ComputerName\\DomainName"</span> );
01012 
01013     InitializeObjectAttributes(
01014         &amp;objectAttributes,
01015         &amp;string,
01016         OBJ_CASE_INSENSITIVE,
01017         NULL,
01018         NULL
01019         );
01020 
01021     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( &amp;keyHandle, KEY_ALL_ACCESS, &amp;objectAttributes );
01022     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01023         KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to open DomainName key: %x\n"</span>, status ));
01024         startDatagramReceiver = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01025     } <span class="keywordflow">else</span> {
01026 
01027         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"DomainName"</span> );
01028 
01029         keyValue = (PKEY_VALUE_PARTIAL_INFORMATION)buffer;
01030         RtlZeroMemory(buffer, bufferLength);
01031 
01032         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
01033                      keyHandle,
01034                      &amp;string,
01035                      KeyValuePartialInformation,
01036                      keyValue,
01037                      bufferLength,
01038                      &amp;length);
01039 
01040         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( keyHandle );
01041         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01042             KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to query Domain value: %x\n"</span>, status ));
01043             startDatagramReceiver = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01044         } <span class="keywordflow">else</span> {
01045             <span class="keywordflow">if</span> ( !<a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;domainName, (PWSTR)keyValue-&gt;Data) ) {
01046                 KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to create DomainName string\n"</span> ));
01047                 status = STATUS_INSUFFICIENT_RESOURCES;
01048                 <span class="keywordflow">goto</span> cleanup;
01049             }
01050             startDatagramReceiver = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01051         }
01052     }
01053 
01054     <span class="comment">//</span>
01055     <span class="comment">// Tell the redir to start.</span>
01056     <span class="comment">//</span>
01057 
01058     rrp-&gt;Type = ConfigInformation;
01059     rrp-&gt;Version = REQUEST_PACKET_VERSION;
01060 
01061     rrp-&gt;Parameters.Start.RedirectorNameLength = computerName.Length;
01062     RtlCopyMemory(rrp-&gt;Parameters.Start.RedirectorName,
01063                   computerName.Buffer,
01064                   computerName.Length);
01065 
01066     rrp-&gt;Parameters.Start.DomainNameLength = domainName.Length;
01067     RtlCopyMemory(((PUCHAR)rrp-&gt;Parameters.Start.RedirectorName) + computerName.Length,
01068                   domainName.Buffer,
01069                   domainName.Length);
01070 
01071     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;computerName);
01072     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;domainName);
01073 
01074     wkstaConfig.wki502_char_wait = 3600;
01075     wkstaConfig.wki502_maximum_collection_count = 16;
01076     wkstaConfig.wki502_collection_time = 250;
01077     wkstaConfig.wki502_keep_conn = 600;
01078     wkstaConfig.wki502_max_cmds = 5;
01079     wkstaConfig.wki502_sess_timeout = 45;
01080     wkstaConfig.wki502_siz_char_buf = 512;
01081     wkstaConfig.wki502_max_threads = 17;
01082     wkstaConfig.wki502_lock_quota = 6144;
01083     wkstaConfig.wki502_lock_increment = 10;
01084     wkstaConfig.wki502_lock_maximum = 500;
01085     wkstaConfig.wki502_pipe_increment = 10;
01086     wkstaConfig.wki502_pipe_maximum = 500;
01087     wkstaConfig.wki502_cache_file_timeout = 40;
01088     wkstaConfig.wki502_dormant_file_limit = 45;
01089     wkstaConfig.wki502_read_ahead_throughput = MAXULONG;
01090     wkstaConfig.wki502_num_mailslot_buffers = 3;
01091     wkstaConfig.wki502_num_srv_announce_buffers = 20;
01092     wkstaConfig.wki502_max_illegal_datagram_events = 5;
01093     wkstaConfig.wki502_illegal_datagram_event_reset_frequency = 60;
01094     wkstaConfig.wki502_log_election_packets = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01095     wkstaConfig.wki502_use_opportunistic_locking = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01096     wkstaConfig.wki502_use_unlock_behind = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01097     wkstaConfig.wki502_use_close_behind = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01098     wkstaConfig.wki502_buf_named_pipes = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01099     wkstaConfig.wki502_use_lock_read_unlock = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01100     wkstaConfig.wki502_utilize_nt_caching = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01101     wkstaConfig.wki502_use_raw_read = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01102     wkstaConfig.wki502_use_raw_write = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01103     wkstaConfig.wki502_use_write_raw_data = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01104     wkstaConfig.wki502_use_encryption = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01105     wkstaConfig.wki502_buf_files_deny_write = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01106     wkstaConfig.wki502_buf_read_only_files = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01107     wkstaConfig.wki502_force_core_create_mode = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01108     wkstaConfig.wki502_use_512_byte_max_transfer = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01109 
01110     status = <a class="code" href="../../d8/d7/io_2fsctrl_8c.html#a0">NtFsControlFile</a>(
01111                 RdrHandle,
01112                 NULL,
01113                 NULL,
01114                 NULL,
01115                 &amp;ioStatusBlock,
01116                 FSCTL_LMR_START | 0x80000000,
01117                 rrp,
01118                 <span class="keyword">sizeof</span>(LMR_REQUEST_PACKET) +
01119                     rrp-&gt;Parameters.Start.RedirectorNameLength +
01120                     rrp-&gt;Parameters.Start.DomainNameLength,
01121                 &amp;wkstaConfig,
01122                 <span class="keyword">sizeof</span>(wkstaConfig)
01123                 );
01124 
01125     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01126         status = ioStatusBlock.Status;
01127     }
01128     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01129         KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to FSCTL(start) redirector: %x\n"</span>, status ));
01130         <span class="keywordflow">goto</span> cleanup;
01131     }
01132 
01133     <span class="keywordflow">if</span> (startDatagramReceiver) {
01134 
01135         <span class="comment">//</span>
01136         <span class="comment">// Tell the datagram receiver to start.</span>
01137         <span class="comment">//</span>
01138 
01139         drrp-&gt;Version = LMDR_REQUEST_PACKET_VERSION;
01140 
01141         drrp-&gt;Parameters.Start.NumberOfMailslotBuffers = 16;
01142         drrp-&gt;Parameters.Start.NumberOfServerAnnounceBuffers = 20;
01143         drrp-&gt;Parameters.Start.IllegalDatagramThreshold = 5;
01144         drrp-&gt;Parameters.Start.EventLogResetFrequency = 60;
01145         drrp-&gt;Parameters.Start.LogElectionPackets = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01146 
01147         drrp-&gt;Parameters.Start.IsLanManNt = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01148 
01149         status = <a class="code" href="../../d1/d7/io_2devctrl_8c.html#a0">NtDeviceIoControlFile</a>(
01150                     dgHandle,
01151                     NULL,
01152                     NULL,
01153                     NULL,
01154                     &amp;ioStatusBlock,
01155                     IOCTL_LMDR_START,
01156                     drrp,
01157                     <span class="keyword">sizeof</span>(LMDR_REQUEST_PACKET),
01158                     NULL,
01159                     0
01160                     );
01161 
01162         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01163             status = ioStatusBlock.Status;
01164         }
01165 
01166         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( dgHandle );
01167         dgHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01168 
01169         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01170             KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to IOCTL(start) datagram receiver: %x\n"</span>, status ));
01171             <span class="keywordflow">goto</span> cleanup;
01172         }
01173 
01174     } <span class="keywordflow">else</span> {
01175 
01176         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( dgHandle );
01177         dgHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01178 
01179         <span class="comment">//</span>
01180         <span class="comment">// Tell the redir to bind to the transports.</span>
01181         <span class="comment">//</span>
01182         <span class="comment">// Note: In the current redirector implementation, this call just</span>
01183         <span class="comment">// tells the redirector to register for TDI PnP notifications.</span>
01184         <span class="comment">// Starting the datagram receiver also does this, so we only issue</span>
01185         <span class="comment">// this FSCTL if we're not starting the datagram receiver.</span>
01186         <span class="comment">//</span>
01187 
01188         status = <a class="code" href="../../d8/d7/io_2fsctrl_8c.html#a0">NtFsControlFile</a>(
01189                     RdrHandle,
01190                     NULL,
01191                     NULL,
01192                     NULL,
01193                     &amp;ioStatusBlock,
01194                     FSCTL_LMR_BIND_TO_TRANSPORT | 0x80000000,
01195                     NULL,
01196                     0,
01197                     NULL,
01198                     0
01199                     );
01200 
01201         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01202             status = ioStatusBlock.Status;
01203         }
01204 
01205         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01206             KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to FSCTL(bind) redirector: %x\n"</span>, status ));
01207             <span class="keywordflow">goto</span> cleanup;
01208         }
01209     }
01210 
01211 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
01212 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (((LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; <a class="code" href="../../d3/d8/setupblk_8h.html#a26">SETUPBLK_FLAGS_IS_TEXTMODE</a>) == 0) &amp;&amp;
01213         ((LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; SETUPBLK_FLAGS_FORMAT_NEEDED) == 0)) {
01214 
01215         <span class="comment">//</span>
01216         <span class="comment">// Get the path to the boot partition on the disk for CSC and redirection</span>
01217         <span class="comment">// Note: On failure, this defaults to \Device\Harddisk0\Partition1</span>
01218         <span class="comment">//</span>
01219 
01220         IopGetHarddiskInfo(NetHDCSCPartition);
01221 
01222         <span class="comment">//</span>
01223         <span class="comment">// Tell the redirector to initialize remote boot redirection (back</span>
01224         <span class="comment">// to the local disk). Note that we only do this if we're NOT doing</span>
01225         <span class="comment">// textmode setup. During textmode, we let Setup do this so that it</span>
01226         <span class="comment">// can do so AFTER it has reformatted the local disk.</span>
01227         <span class="comment">//</span>
01228 
01229         status = <a class="code" href="../../d8/d7/io_2fsctrl_8c.html#a0">NtFsControlFile</a>(
01230                     RdrHandle,
01231                     NULL,
01232                     NULL,
01233                     NULL,
01234                     &amp;ioStatusBlock,
01235                     FSCTL_LMR_START_RBR,
01236                     NetHDCSCPartition,
01237                     wcslen(NetHDCSCPartition) * <span class="keyword">sizeof</span>(WCHAR),
01238                     NULL,
01239                     0
01240                     );
01241 
01242         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01243             status = ioStatusBlock.Status;
01244         }
01245 
01246         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01247             KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to FSCTL(RBR) redirector: %x\n"</span>, status ));
01248         }
01249     }
01250 
01251     <span class="keywordflow">if</span> ( (LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; SETUPBLK_FLAGS_DISCONNECTED) == 0 )
01252 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
01253 <span class="preprocessor"></span>    {
01254 
01255         <span class="comment">//</span>
01256         <span class="comment">// Loop until the redirector is bound to the transport. It may take a</span>
01257         <span class="comment">// while because TDI defers notification of binding to a worker thread.</span>
01258         <span class="comment">// We start with a half a second wait and double it each time, trying</span>
01259         <span class="comment">// five times total.</span>
01260         <span class="comment">//</span>
01261 
01262         interval.QuadPart = -500 * 1000 * 10;    <span class="comment">// 1/2 second, relative</span>
01263         enumerateAttempts = 0;
01264 
01265         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01266 
01267             <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a>(KernelMode, FALSE, &amp;interval);
01268 
01269             RtlZeroMemory(rrp, <span class="keyword">sizeof</span>(LMR_REQUEST_PACKET));
01270 
01271             rrp-&gt;Type = EnumerateTransports;
01272             rrp-&gt;Version = REQUEST_PACKET_VERSION;
01273 
01274             status = <a class="code" href="../../d8/d7/io_2fsctrl_8c.html#a0">NtFsControlFile</a>(
01275                         RdrHandle,
01276                         NULL,
01277                         NULL,
01278                         NULL,
01279                         &amp;ioStatusBlock,
01280                         FSCTL_LMR_ENUMERATE_TRANSPORTS,
01281                         rrp,
01282                         <span class="keyword">sizeof</span>(LMR_REQUEST_PACKET),
01283                         &amp;wkstaTransportInfo,
01284                         <span class="keyword">sizeof</span>(wkstaTransportInfo)
01285                         );
01286 
01287             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01288                 status = ioStatusBlock.Status;
01289             }
01290             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01291                 <span class="comment">//KdPrint(( "IopStartNetworkForRemoteBoot: Unable to FSCTL(enumerate) redirector: %x\n", status ));</span>
01292             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rrp-&gt;Parameters.Get.TotalBytesNeeded == 0) {
01293                 <span class="comment">//KdPrint(( "IopStartNetworkForRemoteBoot: FSCTL(enumerate) returned 0 entries\n" ));</span>
01294             } <span class="keywordflow">else</span> {
01295                 <span class="keywordflow">break</span>;
01296             }
01297 
01298             ++enumerateAttempts;
01299 
01300             <span class="keywordflow">if</span> (enumerateAttempts == 5) {
01301                 KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Redirector didn't start\n"</span> ));
01302                 status = STATUS_REDIRECTOR_NOT_STARTED;
01303                 <span class="keywordflow">goto</span> cleanup;
01304             }
01305 
01306             interval.QuadPart *= 2;
01307 
01308         }
01309     }
01310 
01311     <span class="comment">//</span>
01312     <span class="comment">// Prime the transport.</span>
01313     <span class="comment">//</span>
01314 
01315 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
01316 <span class="preprocessor"></span>    IopEnableRemoteBootSecurity(LoaderBlock);
01317 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
01318 <span class="preprocessor"></span>    <a class="code" href="../../d4/d6/netboot_8c.html#a7">IopSetDefaultGateway</a>(LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o24">DefaultRouter</a>);
01319     <a class="code" href="../../d4/d6/netboot_8c.html#a8">IopCacheNetbiosNameForIpAddress</a>(LoaderBlock);
01320 
01321 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
01322 <span class="preprocessor"></span>    <span class="comment">//</span>
01323     <span class="comment">// CSC needs to be initialized after binding to the transport because ResetCSC</span>
01324     <span class="comment">// (if needed) will try to enumerate the files and directories on the server.</span>
01325     <span class="comment">//</span>
01326 
01327     <span class="keywordflow">if</span> (((LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; <a class="code" href="../../d3/d8/setupblk_8h.html#a26">SETUPBLK_FLAGS_IS_TEXTMODE</a>) == 0) &amp;&amp;
01328         ((LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; SETUPBLK_FLAGS_FORMAT_NEEDED) == 0)
01329 <span class="preprocessor">#if 0</span>
01330 <span class="preprocessor"></span>        &amp;&amp; ((LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; SETUPBLK_FLAGS_DISABLE_CSC) != 0)
01331 <span class="preprocessor">#endif</span>
01332 <span class="preprocessor"></span>        ) {
01333 
01334         wcstombs(buffer, NetHDCSCPartition, wcslen(NetHDCSCPartition) + 1);
01335         strcat(buffer, REMOTE_BOOT_IMIRROR_PATH_A REMOTE_BOOT_CSC_SUBDIR_A);
01336 
01337         status = IopInitCsc( buffer );
01338 
01339         <span class="comment">//</span>
01340         <span class="comment">//  If we are connected and either we are part way through a reset of</span>
01341         <span class="comment">//  the csc or the init failed then reset the csc.</span>
01342         <span class="comment">//</span>
01343 
01344         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01345 
01346             <span class="keywordflow">if</span> (StartCsc == FLUSH_CSC ) {
01347 
01348                 <span class="keywordflow">if</span> ((LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; SETUPBLK_FLAGS_DISCONNECTED) == 0) {
01349 
01350                     <span class="comment">//</span>
01351                     <span class="comment">// CSC may have lost the pin information.</span>
01352                     <span class="comment">//</span>
01353 
01354                     status = IopResetCsc( buffer );
01355 
01356                     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01357                         KdPrint((<span class="stringliteral">"IopStartNetworkForRemoteBoot: reset of Csc failed %x\n"</span>, status));
01358                     }
01359                 } <span class="keywordflow">else</span> {
01360                     IoCscInitializationFailed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01361                 }
01362             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; SETUPBLK_FLAGS_PIN_NET_DRIVER) &amp;&amp;
01363                        (LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o27">NetbootCardDriverName</a>[0] != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>)) {
01364 
01365                 <span class="comment">//</span>
01366                 <span class="comment">// if we are connected and we're not repinning all files and</span>
01367                 <span class="comment">// we have a new net card driver to pin, then pin it below</span>
01368                 <span class="comment">// after we've created called IopAssignNetworkDriveLetter</span>
01369                 <span class="comment">//</span>
01370 
01371                 pinNetDriver = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01372             }
01373         }
01374 
01375         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01376             KdPrint((<span class="stringliteral">"IopStartNetworkForRemoteBoot: initialization of Csc failed %x\n"</span>, status));
01377             IoCscInitializationFailed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01378             SharedUserData-&gt;SystemFlags |= SYSTEM_FLAG_DISKLESS_CLIENT;
01379         }
01380 
01381     } <span class="keywordflow">else</span> {
01382         IoCscInitializationFailed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01383         SharedUserData-&gt;SystemFlags |= SYSTEM_FLAG_DISKLESS_CLIENT;
01384     }
01385 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
01386 <span class="preprocessor"></span>
01387     <a class="code" href="../../d4/d6/netboot_8c.html#a12">IopAssignNetworkDriveLetter</a>(LoaderBlock);
01388 
01389 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
01390 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (pinNetDriver) {
01391 
01392         <span class="comment">//</span>
01393         <span class="comment">//  Pin the new net card driver simply by opening it.  if it</span>
01394         <span class="comment">//  fails, it's not fatal, as we'll eventually pin it since</span>
01395         <span class="comment">//  the directory it's in is marked as system/inherit.</span>
01396         <span class="comment">//</span>
01397 
01398         HANDLE driverHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01399         PWCHAR fullDriverName;
01400 
01401         fullDriverName = (PWCHAR) <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
01402                             NonPagedPool,
01403                             <span class="keyword">sizeof</span>( L<span class="stringliteral">"\\SystemRoot\\System32\\Drivers\\"</span> ) +
01404                             <span class="keyword">sizeof</span>( LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o27">NetbootCardDriverName</a> ),
01405                             'bRoI'
01406                             );
01407 
01408         <span class="keywordflow">if</span> (fullDriverName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01409 
01410             wcscpy(fullDriverName, L<span class="stringliteral">"\\SystemRoot\\System32\\Drivers\\"</span>);
01411             wcscat(fullDriverName, LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o27">NetbootCardDriverName</a>);
01412 
01413             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, fullDriverName );
01414 
01415             InitializeObjectAttributes(
01416                 &amp;objectAttributes,
01417                 &amp;string,
01418                 OBJ_CASE_INSENSITIVE,
01419                 NULL,
01420                 NULL
01421                 );
01422 
01423             status = <a class="code" href="../../d1/d8/io_2create_8c.html#a0">NtCreateFile</a>(
01424                         &amp;driverHandle,
01425                         GENERIC_READ,
01426                         &amp;objectAttributes,
01427                         &amp;ioStatusBlock,
01428                         NULL,
01429                         FILE_ATTRIBUTE_NORMAL,
01430                         FILE_SHARE_READ,
01431                         FILE_OPEN,
01432                         FILE_SYNCHRONOUS_IO_NONALERT,
01433                         NULL,
01434                         0
01435                         );
01436             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01437 
01438                 <span class="comment">//</span>
01439                 <span class="comment">//  this is not a fatal error, the redir should pin it eventually</span>
01440                 <span class="comment">//</span>
01441 
01442                 KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to open new net driver: 0x%x\n"</span>, status ));
01443             }
01444             <span class="keywordflow">if</span> (driverHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01445                 <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( driverHandle );
01446             }
01447 
01448             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( fullDriverName );
01449 
01450         } <span class="keywordflow">else</span> {
01451 
01452             <span class="comment">//</span>
01453             <span class="comment">//  this is not a fatal error, the redir should pin it eventually</span>
01454             <span class="comment">//</span>
01455 
01456             KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to allocate buffer to pin netcard driver\n"</span> ));
01457         }
01458     }
01459 
01460     leaveRdrHandleOpen = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01461 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
01462 <span class="preprocessor"></span>
01463 cleanup:
01464 
01465     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;computerName );
01466     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;domainName );
01467 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
01468 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( NetHDCSCPartition != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01469         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NetHDCSCPartition );
01470     }
01471 <span class="preprocessor">#else</span>
01472 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01473         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( buffer );
01474     }
01475 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
01476 <span class="preprocessor"></span>
01477     <span class="keywordflow">if</span> ( dgHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01478         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( dgHandle );
01479     }
01480 
01481 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
01482 <span class="preprocessor"></span>    <span class="comment">//</span>
01483     <span class="comment">// If requested, exit with RdrHandle still set so that we can close CSC quickly.</span>
01484     <span class="comment">//</span>
01485 
01486     <span class="keywordflow">if</span> ( !leaveRdrHandleOpen &amp;&amp; (RdrHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
01487         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( RdrHandle );
01488         RdrHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01489     }
01490 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
01491 <span class="preprocessor"></span>
01492     <span class="keywordflow">return</span> status;
01493 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a220" doxytag="iop.h::IopStartTcpIpForRemoteBoot" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopStartTcpIpForRemoteBoot           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LoaderBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/netboot_8c-source.html#l01834">1834</a> of file <a class="el" href="../../d5/d5/netboot_8c-source.html">netboot.c</a>.
<p>
References <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00450">_SETUP_LOADER_BLOCK::IpAddress</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d2/d7/io_2create_8c-source.html#l00037">NtCreateFile()</a>, <a class="el" href="../../d2/d6/io_2devctrl_8c-source.html#l00034">NtDeviceIoControlFile()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01862">_LOADER_PARAMETER_BLOCK::SetupLoaderBlock</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00451">_SETUP_LOADER_BLOCK::SubnetMask</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>.
<p>
<pre class="fragment"><div>01837 {
01838     UNICODE_STRING IpString;
01839     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
01840     HANDLE handle;
01841     OBJECT_ATTRIBUTES objectAttributes;
01842     IO_STATUS_BLOCK ioStatusBlock;
01843     IP_SET_ADDRESS_REQUEST IpRequest;
01844 
01845     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;IpString, DD_IP_DEVICE_NAME );
01846 
01847     InitializeObjectAttributes(
01848         &amp;objectAttributes,
01849         &amp;IpString,
01850         OBJ_CASE_INSENSITIVE,
01851         NULL,
01852         NULL
01853         );
01854 
01855     IpRequest.Context = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)2;
01856     IpRequest.Address = LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o21">IpAddress</a>;
01857     IpRequest.SubnetMask = LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o22">SubnetMask</a>;
01858 
01859     status = <a class="code" href="../../d1/d8/io_2create_8c.html#a0">NtCreateFile</a>(
01860                 &amp;handle,
01861                 GENERIC_READ | GENERIC_WRITE,
01862                 &amp;objectAttributes,
01863                 &amp;ioStatusBlock,
01864                 NULL,
01865                 0,
01866                 FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE,
01867                 FILE_OPEN,
01868                 FILE_SYNCHRONOUS_IO_NONALERT,
01869                 NULL,
01870                 0
01871                 );
01872     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01873         KdPrint(( <span class="stringliteral">"IopStartTcpIpForRemoteBoot: Unable to open IP: %x\n"</span>, status ));
01874         <span class="keywordflow">goto</span> cleanup;
01875     }
01876 
01877     status = <a class="code" href="../../d1/d7/io_2devctrl_8c.html#a0">NtDeviceIoControlFile</a>(
01878                 handle,
01879                 NULL,
01880                 NULL,
01881                 NULL,
01882                 &amp;ioStatusBlock,
01883                 IOCTL_IP_SET_ADDRESS_DUP,
01884                 &amp;IpRequest,
01885                 <span class="keyword">sizeof</span>(IP_SET_ADDRESS_REQUEST),
01886                 NULL,
01887                 0
01888                 );
01889 
01890     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
01891 
01892     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01893         KdPrint(( <span class="stringliteral">"IopStartTcpIpForRemoteBoot: Unable to IOCTL IP: %x\n"</span>, status ));
01894         <span class="keywordflow">goto</span> cleanup;
01895     }
01896 
01897 cleanup:
01898 
01899     <span class="keywordflow">return</span> status;
01900 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a211" doxytag="iop.h::IopSynchronousApiServiceTail" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopSynchronousApiServiceTail           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN NTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnedStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Event</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RequestorMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>LocalIoStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l06926">6926</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00417">IopCancelAlertedRequest()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l06326">IopSetEaOrQuotaInformationFile()</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00386">NtFlushBuffersFile()</a>, <a class="el" href="../../d8/d1/qsea_8c-source.html#l00035">NtQueryEaFile()</a>, <a class="el" href="../../d1/d2/qsquota_8c-source.html#l00035">NtQueryQuotaInformationFile()</a>, <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00037">NtQueryVolumeInformationFile()</a>, <a class="el" href="../../d8/d1/qsea_8c-source.html#l00652">NtSetEaFile()</a>, <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00492">NtSetVolumeInformationFile()</a>, and <a class="el" href="../../d2/d4/lock_8c-source.html#l00458">NtUnlockFile()</a>.
<p>
<pre class="fragment"><div>06937                    :
06938 
06939     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when a synchronous API <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked <span class="keywordflow">for</span> a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
06940     that has been opened <span class="keywordflow">for</span> asynchronous I/O.  This function synchronizes
06941     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> completion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O operation on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
06942 
06943 Arguments:
06944 
06945     ReturnedStatus - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status that was returned from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call to
06946         <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>.
06947 
06948     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated kernel event to be used <span class="keywordflow">for</span> synchronization
06949         of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O operation.
06950 
06951     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet submitted to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver.
06952 
06953     RequestorMode - Processor mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation was
06954         requested.
06955 
06956     LocalIoStatus - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O status block used to capture <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span>
06957         status by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service itself.
06958 
06959     IoStatusBlock - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O status block supplied by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller of
06960         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system service.
06961 
06962 Return Value:
06963 
06964     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
06965 
06966 
06967 --*/
06968 
06969 {
06970     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
06971 
06972     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
06973 
06974     <span class="comment">//</span>
06975     <span class="comment">// This is a normal synchronous I/O operation, as opposed to a</span>
06976     <span class="comment">// serialized synchronous I/O operation.  For this case, wait for</span>
06977     <span class="comment">// the local event and copy the final status information back to</span>
06978     <span class="comment">// the caller.</span>
06979     <span class="comment">//</span>
06980 
06981     status = ReturnedStatus;
06982 
06983     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
06984 
06985         status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( Event,
06986                                         Executive,
06987                                         RequestorMode,
06988                                         FALSE,
06989                                         (PLARGE_INTEGER) NULL );
06990 
06991         <span class="keywordflow">if</span> (status == STATUS_ALERTED || status == STATUS_USER_APC) {
06992 
06993             <span class="comment">//</span>
06994             <span class="comment">// The wait request has ended either because the thread was</span>
06995             <span class="comment">// alerted or an APC was queued to this thread, because of</span>
06996             <span class="comment">// thread rundown or CTRL/C processing.  In either case, try</span>
06997             <span class="comment">// to bail out of this I/O request carefully so that the IRP</span>
06998             <span class="comment">// completes before this routine exists or the event will not</span>
06999             <span class="comment">// be around to set to the Signaled state.</span>
07000             <span class="comment">//</span>
07001 
07002             <a class="code" href="../../d0/d6/iop_8h.html#a151">IopCancelAlertedRequest</a>( Event, Irp );
07003 
07004         }
07005 
07006         status = LocalIoStatus-&gt;Status;
07007     }
07008 
07009     <span class="keywordflow">try</span> {
07010 
07011         *IoStatusBlock = *LocalIoStatus;
07012 
07013     } except(EXCEPTION_EXECUTE_HANDLER) {
07014 
07015         <span class="comment">//</span>
07016         <span class="comment">// An exception occurred attempting to write the caller's I/O</span>
07017         <span class="comment">// status block.  Simply change the final status of the operation</span>
07018         <span class="comment">// to the exception code.</span>
07019         <span class="comment">//</span>
07020 
07021         status = GetExceptionCode();
07022     }
07023 
07024     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Event );
07025 
07026     <span class="keywordflow">return</span> status;
07027 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a212" doxytag="iop.h::IopSynchronousServiceTail" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopSynchronousServiceTail           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DeferredIoCompletion</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RequestorMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SynchronousIo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/iop_8h.html#a25">TRANSFER_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TransferType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l07030">7030</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01492">FO_ALERTABLE_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00417">IopCancelAlertedRequest()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01019">IopCompleteRequest()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01103">IopQueueThreadIrp</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01157">IopReleaseFileObjectLock</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12345">IopUpdateOtherOperationCount()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12377">IopUpdateReadOperationCount()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12410">IopUpdateWriteOperationCount()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d6/iop_8h.html#a240a140">OtherTransfer</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01648">_IRP::PendingReturned</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00196">PKNORMAL_ROUTINE</a>, <a class="el" href="../../d0/d6/iop_8h.html#a240a138">ReadTransfer</a>, <a class="el" href="../../d2/d4/internal_8c.html#a2">SynchronousIo</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d0/d6/iop_8h.html#a25">TRANSFER_TYPE</a>, and <a class="el" href="../../d0/d6/iop_8h.html#a240a139">WriteTransfer</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l06326">IopSetEaOrQuotaInformationFile()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08084">IopXxxControlFile()</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00386">NtFlushBuffersFile()</a>, <a class="el" href="../../d2/d4/lock_8c-source.html#l00035">NtLockFile()</a>, <a class="el" href="../../d1/d7/dir_8c-source.html#l00821">NtNotifyChangeDirectoryFile()</a>, <a class="el" href="../../d1/d7/dir_8c-source.html#l00682">NtQueryDirectoryFile()</a>, <a class="el" href="../../d8/d1/qsea_8c-source.html#l00035">NtQueryEaFile()</a>, <a class="el" href="../../d1/d2/qsquota_8c-source.html#l00035">NtQueryQuotaInformationFile()</a>, <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00037">NtQueryVolumeInformationFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00036">NtReadFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00730">NtReadFileScatter()</a>, <a class="el" href="../../d8/d1/qsea_8c-source.html#l00652">NtSetEaFile()</a>, <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00492">NtSetVolumeInformationFile()</a>, <a class="el" href="../../d2/d4/lock_8c-source.html#l00458">NtUnlockFile()</a>, <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00035">NtWriteFile()</a>, and <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00801">NtWriteFileGather()</a>.
<p>
<pre class="fragment"><div>07042                    :
07043 
07044     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation of a system service.
07045     It queues <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread's queue, updates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> transfer count,
07046     calls <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver, and finally synchronizes completion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O.
07047 
07048 Arguments:
07049 
07050     DeviceObject - Device on which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to occur.
07051 
07052     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O operation.
07053 
07054     FileObject - <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> object <span class="keywordflow">for</span> <span class="keyword">this</span> open instantiation.
07055 
07056     DeferredIoCompletion - Indicates whether deferred completion <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> possible.
07057 
07058     RequestorMode - Mode in which request was <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a>.
07059 
07060     <a class="code" href="../../d2/d4/internal_8c.html#a2">SynchronousIo</a> - Indicates whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be synchronous.
07061 
07062     TransferType - Type of transfer being performed: read, write, or other.
07063 
07064 Return Value:
07065 
07066     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
07067 
07068 --*/
07069 
07070 {
07071     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
07072 
07073     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
07074 
07075     <span class="comment">//</span>
07076     <span class="comment">// Insert the packet at the head of the IRP list for the thread.</span>
07077     <span class="comment">//</span>
07078 
07079     <a class="code" href="../../d0/d6/iop_8h.html#a21">IopQueueThreadIrp</a>( Irp );
07080 
07081     <span class="comment">//</span>
07082     <span class="comment">// Update the operation count statistic for the current process.</span>
07083     <span class="comment">//</span>
07084 
07085     <span class="keywordflow">switch</span>( TransferType ) {
07086 
07087     <span class="keywordflow">case</span> <a class="code" href="../../d0/d6/iop_8h.html#a240a138">ReadTransfer</a>:
07088         <a class="code" href="../../d4/d6/iosubs_8c.html#a130">IopUpdateReadOperationCount</a>();
07089         <span class="keywordflow">break</span>;
07090 
07091     <span class="keywordflow">case</span> <a class="code" href="../../d0/d6/iop_8h.html#a240a139">WriteTransfer</a>:
07092         <a class="code" href="../../d4/d6/iosubs_8c.html#a131">IopUpdateWriteOperationCount</a>();
07093         <span class="keywordflow">break</span>;
07094 
07095     <span class="keywordflow">case</span> <a class="code" href="../../d0/d6/iop_8h.html#a240a140">OtherTransfer</a>:
07096         <a class="code" href="../../d4/d6/iosubs_8c.html#a129">IopUpdateOtherOperationCount</a>();
07097         <span class="keywordflow">break</span>;
07098     }
07099 
07100     <span class="comment">//</span>
07101     <span class="comment">// Now simply invoke the driver at its dispatch entry with the IRP.</span>
07102     <span class="comment">//</span>
07103 
07104     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( DeviceObject, Irp );
07105 
07106     <span class="comment">//</span>
07107     <span class="comment">// If deferred I/O completion is possible, check for pending returned</span>
07108     <span class="comment">// from the driver.  If the driver did not return pending, then the</span>
07109     <span class="comment">// packet has not actually been completed yet, so complete it here.</span>
07110     <span class="comment">//</span>
07111 
07112     <span class="keywordflow">if</span> (DeferredIoCompletion) {
07113 
07114         <span class="keywordflow">if</span> (status != STATUS_PENDING) {
07115 
07116             <span class="comment">//</span>
07117             <span class="comment">// The I/O operation was completed without returning a status of</span>
07118             <span class="comment">// pending.  This means that at this point, the IRP has not been</span>
07119             <span class="comment">// fully completed.  Complete it now.</span>
07120             <span class="comment">//</span>
07121 
07122             <a class="code" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> normalRoutine;
07123             PVOID normalContext;
07124             KIRQL irql;
07125 
07126             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o11">PendingReturned</a> );
07127 
07128             <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>( APC_LEVEL, &amp;irql );
07129             <a class="code" href="../../d0/d6/iop_8h.html#a157">IopCompleteRequest</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Apc,
07130                                 &amp;normalRoutine,
07131                                 &amp;normalContext,
07132                                 (PVOID *) &amp;FileObject,
07133                                 &amp;normalContext );
07134             <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>( irql );
07135         }
07136     }
07137 
07138     <span class="comment">//</span>
07139     <span class="comment">// If this operation was a synchronous I/O operation, check the return</span>
07140     <span class="comment">// status to determine whether or not to wait on the file object.  If</span>
07141     <span class="comment">// the file object is to be waited on, wait for the operation to complete</span>
07142     <span class="comment">// and obtain the final status from the file object itself.</span>
07143     <span class="comment">//</span>
07144 
07145     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4/internal_8c.html#a2">SynchronousIo</a>) {
07146 
07147         <span class="keywordflow">if</span> (status == STATUS_PENDING) {
07148 
07149             status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;FileObject-&gt;Event,
07150                                             Executive,
07151                                             RequestorMode,
07152                                             (BOOLEAN) ((FileObject-&gt;Flags &amp; FO_ALERTABLE_IO) != 0),
07153                                             (PLARGE_INTEGER) NULL );
07154 
07155             <span class="keywordflow">if</span> (status == STATUS_ALERTED || status == STATUS_USER_APC) {
07156 
07157                 <span class="comment">//</span>
07158                 <span class="comment">// The wait request has ended either because the thread was alerted</span>
07159                 <span class="comment">// or an APC was queued to this thread, because of thread rundown or</span>
07160                 <span class="comment">// CTRL/C processing.  In either case, try to bail out of this I/O</span>
07161                 <span class="comment">// request carefully so that the IRP completes before this routine</span>
07162                 <span class="comment">// exists so that synchronization with the file object will remain</span>
07163                 <span class="comment">// intact.</span>
07164                 <span class="comment">//</span>
07165 
07166                 <a class="code" href="../../d0/d6/iop_8h.html#a151">IopCancelAlertedRequest</a>( &amp;FileObject-&gt;Event, Irp );
07167 
07168             }
07169 
07170             status = FileObject-&gt;FinalStatus;
07171 
07172         }
07173 
07174         <a class="code" href="../../d0/d6/iop_8h.html#a22">IopReleaseFileObjectLock</a>( FileObject );
07175 
07176     }
07177 
07178     <span class="keywordflow">return</span> status;
07179 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a213" doxytag="iop.h::IopTimerDispatch" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopTimerDispatch           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d6/struct__KDPC.html">PKDPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Dpc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DeferredContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l07182">7182</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01036">_IO_TIMER::Context</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01037">_IO_TIMER::DeviceObject</a>, <a class="el" href="../../d0/d5/io_8h.html#a328">IO_TIMER</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00225">IopTimerCount</a>, <a class="el" href="../../d5/d3/alpha_2splocks_8c-source.html#l00050">IopTimerLock</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00222">IopTimerQueueHead</a>, <a class="el" href="../../d0/d5/io_8h.html#a329">PIO_TIMER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01033">_IO_TIMER::TimerFlag</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01035">_IO_TIMER::TimerRoutine</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>.
<p>
<pre class="fragment"><div>07191                    :
07192 
07193     This routine scans <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O system timer database and invokes each driver
07194     that has enabled a timer in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list, once every second.
07195 
07196 Arguments:
07197 
07198     Dpc - Supplies a pointer to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> DPC.
07199 
07200     DeferredContext - Optional deferred context;  not used.
07201 
07202     SystemArgument1 - Optional argument 1;  not used.
07203 
07204     SystemArgument2 - Optional argument 2;  not used.
07205 
07206 Return Value:
07207 
07208     None.
07209 
07210 --*/
07211 
07212 {
07213     PLIST_ENTRY timerEntry;
07214     <a class="code" href="../../d4/d9/struct__IO__TIMER.html">PIO_TIMER</a> timer;
07215     LARGE_INTEGER deltaTime;
07216     KIRQL irql;
07217     ULONG i;
07218 
07219     UNREFERENCED_PARAMETER( Dpc );
07220     UNREFERENCED_PARAMETER( DeferredContext );
07221     UNREFERENCED_PARAMETER( SystemArgument1 );
07222     UNREFERENCED_PARAMETER( SystemArgument2 );
07223 
07224     <span class="comment">//</span>
07225     <span class="comment">// Check to see whether or not there are any timers in the queue that</span>
07226     <span class="comment">// have been enabled.  If so, then walk the list and invoke all of the</span>
07227     <span class="comment">// drivers' routines.  Note that if the counter changes, which it can</span>
07228     <span class="comment">// because the spin lock is not owned, then a timer routine may be</span>
07229     <span class="comment">// missed.  However, this is acceptable, since the driver inserting the</span>
07230     <span class="comment">// entry could be context switched away from, etc.  Therefore, this is</span>
07231     <span class="comment">// not a critical resource for the most part.</span>
07232     <span class="comment">//</span>
07233 
07234     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/iodata_8c.html#a31">IopTimerCount</a>) {
07235 
07236         <span class="comment">//</span>
07237         <span class="comment">// There is at least one timer entry in the queue that is enabled.</span>
07238         <span class="comment">// Walk the queue and invoke each specified timer routine.</span>
07239         <span class="comment">//</span>
07240 
07241         ExAcquireSpinLock( &amp;IopTimerLock, &amp;irql );
07242         i = <a class="code" href="../../d3/d5/iodata_8c.html#a31">IopTimerCount</a>;
07243         timerEntry = <a class="code" href="../../d3/d5/iodata_8c.html#a28">IopTimerQueueHead</a>.Flink;
07244 
07245         <span class="comment">//</span>
07246         <span class="comment">// For each entry found that is enabled, invoke the driver's routine</span>
07247         <span class="comment">// with its specified context parameter.  The local count is used</span>
07248         <span class="comment">// to abort the queue traversal when there are more entries in the</span>
07249         <span class="comment">// queue, but they are not enabled.</span>
07250         <span class="comment">//</span>
07251 
07252         <span class="keywordflow">for</span> (timerEntry = <a class="code" href="../../d3/d5/iodata_8c.html#a28">IopTimerQueueHead</a>.Flink;
07253              (timerEntry != &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a28">IopTimerQueueHead</a>) &amp;&amp; i;
07254              timerEntry = timerEntry-&gt;Flink ) {
07255 
07256             timer = CONTAINING_RECORD( timerEntry, <a class="code" href="../../d4/d9/struct__IO__TIMER.html">IO_TIMER</a>, TimerList );
07257 
07258             <span class="keywordflow">if</span> (timer-&gt;<a class="code" href="../../d4/d9/struct__IO__TIMER.html#o1">TimerFlag</a>) {
07259                 timer-&gt;<a class="code" href="../../d4/d9/struct__IO__TIMER.html#o3">TimerRoutine</a>( timer-&gt;<a class="code" href="../../d4/d9/struct__IO__TIMER.html#o5">DeviceObject</a>, timer-&gt;<a class="code" href="../../d4/d9/struct__IO__TIMER.html#o4">Context</a> );
07260                 i--;
07261             }
07262         }
07263         ExReleaseSpinLock( &amp;IopTimerLock, irql );
07264     }
07265 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a214" doxytag="iop.h::IopTrackLink" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopTrackLink           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFILE_TRACKING_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>FileInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Event</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RequestorMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l07272">7272</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00127">ExAllocatePoolWithQuota</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00044">FILE_VOLUMEID_WITH_TYPE</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00044">IoFileObjectType</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02718">IopGetSetObjectId()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a184">IopGetVolumeId()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03134">IopIsSameMachine()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06010">IopMarshalIds()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06127">IopSendMessageToTrackService()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06716">IopSetRemoteLink()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00042">IsFileLocal</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00714">RtlCompareMemoryUlong()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00047">_TRACKING_BUFFER::TrackingInformation</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>.
<p>
<pre class="fragment"><div>07283                    :
07284 
07285     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to track a link.  It tracks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>'s Object
07286     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> so that links to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source will follow to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span>
07287     location of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target.
07288 
07289 Arguments:
07290 
07291     FileObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> referenced source <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.
07292 
07293     IoStatusBlock - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's I/O status block.
07294 
07295     FileInformation - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> buffer containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parameters <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d4/conexts_8c.html#a1">move</a> that was
07296         performed.
07297 
07298     Length - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FileInformation buffer.
07299 
07300     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> - An event to be set to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Signaled state once <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation has been
07301         performed, provided <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> was successful.
07302 
07303     RequestorMode - Requestor mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
07304 
07305 N.B. - Note that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> presence of an event indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> was
07306     opened <span class="keywordflow">for</span> asynchronous I/O, otherwise <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> was opened <span class="keywordflow">for</span> synchronous I/O.
07307 
07308 Return Value:
07309 
07310     The status returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> completion status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
07311 
07312 
07313 --*/
07314 
07315 {
07316     PFILE_TRACKING_INFORMATION trackingInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07317     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> dstFileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07318     <a class="code" href="../../d2/d4/internal_8c.html#a5">FILE_VOLUMEID_WITH_TYPE</a> SourceVolumeId;
07319     FILE_OBJECTID_BUFFER SourceObjectId;
07320     FILE_OBJECTID_BUFFER NormalizedObjectId;
07321     FILE_OBJECTID_BUFFER CrossVolumeObjectId;
07322     <a class="code" href="../../d2/d4/internal_8c.html#a5">FILE_VOLUMEID_WITH_TYPE</a> TargetVolumeId;
07323     FILE_OBJECTID_BUFFER TargetObjectId;
07324     <a class="code" href="../../d1/d2/struct__TRACKING__BUFFER.html">TRACKING_BUFFER</a> trackingBuffer;
07325     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
07326 
07327     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
07328 
07329     <span class="comment">//</span>
07330     <span class="comment">// Begin by capturing the caller's buffer, if required.</span>
07331     <span class="comment">//</span>
07332 
07333     <span class="keywordflow">if</span> (RequestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
07334 
07335         <span class="keywordflow">try</span> {
07336             trackingInfo = <a class="code" href="../../d5/d5/cc_8h.html#a11">ExAllocatePoolWithQuota</a>( PagedPool,
07337                                                     Length );
07338             RtlCopyMemory( trackingInfo, FileInformation, Length );
07339 
07340             <span class="keywordflow">if</span> (!trackingInfo-&gt;DestinationFile ||
07341                ((Length - FIELD_OFFSET( FILE_TRACKING_INFORMATION, ObjectInformation )) 
07342                 &lt; trackingInfo-&gt;ObjectInformationLength)) {
07343                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( trackingInfo );
07344                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
07345             }
07346 
07347         } except(EXCEPTION_EXECUTE_HANDLER) {
07348 
07349             <span class="comment">//</span>
07350             <span class="comment">// An exception was incurred while allocating the intermediary</span>
07351             <span class="comment">// system buffer or while copying the caller's data into the</span>
07352             <span class="comment">// buffer.  Cleanup and return an appropriate error status code.</span>
07353             <span class="comment">//</span>
07354 
07355             <span class="keywordflow">if</span> (trackingInfo) {
07356                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( trackingInfo );
07357             }
07358 
07359             <span class="keywordflow">return</span> GetExceptionCode();
07360         }
07361     } <span class="keywordflow">else</span> {
07362         trackingInfo = FileInformation;
07363     }
07364 
07365     <span class="comment">//</span>
07366     <span class="comment">// If a destination file handle was specified, convert it to a pointer to</span>
07367     <span class="comment">// a file object.</span>
07368     <span class="comment">//</span>
07369 
07370     <span class="keywordflow">if</span> (trackingInfo-&gt;DestinationFile) {
07371         status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( trackingInfo-&gt;DestinationFile,
07372                                             FILE_WRITE_DATA,
07373                                             IoFileObjectType,
07374                                             RequestorMode,
07375                                             (PVOID *) &amp;dstFileObject,
07376                                             NULL );
07377         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07378             <span class="keywordflow">if</span> (RequestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
07379                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( trackingInfo );
07380             }
07381             <span class="keywordflow">return</span> status;
07382         }
07383     }
07384 
07385     <span class="keywordflow">try</span> {
07386 
07387         <span class="comment">//</span>
07388         <span class="comment">// Determine whether this is a local or a remote link tracking</span>
07389         <span class="comment">// operation.</span>
07390         <span class="comment">//</span>
07391 
07392         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4/internal_8c.html#a0">IsFileLocal</a>( FileObject )) {
07393 
07394             <span class="comment">//</span>
07395             <span class="comment">// The source file, i.e., the one being moved, is a file local to</span>
07396             <span class="comment">// this system.  Determine the form of the target file and track</span>
07397             <span class="comment">// it accordingly.</span>
07398             <span class="comment">//</span>
07399 
07400             <span class="keywordflow">if</span> (trackingInfo-&gt;DestinationFile) {
07401 
07402                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4/internal_8c.html#a0">IsFileLocal</a>( dstFileObject )) {
07403 
07404                     BOOLEAN IdSetOnTarget = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07405 
07406                     <span class="comment">//</span>
07407                     <span class="comment">// The target file is specified as a handle and it is local.</span>
07408                     <span class="comment">// Simply perform the query and set locally.  Note that if</span>
07409                     <span class="comment">// the source file does not have an object ID, then no</span>
07410                     <span class="comment">// tracking will be performed, but it will appear as if the</span>
07411                     <span class="comment">// operation worked.</span>
07412                     <span class="comment">//</span>
07413 
07414                     status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( FileObject,
07415                                                 &amp;SourceObjectId,
07416                                                 <span class="keyword">sizeof</span>( SourceObjectId ),
07417                                                 FSCTL_GET_OBJECT_ID );
07418 
07419                     <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND) {
07420                         <span class="keywordflow">return</span>(STATUS_SUCCESS);
07421                     }
07422 
07423                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07424                         <span class="keywordflow">return</span> status;
07425                     }
07426 
07427                     <span class="comment">//</span>
07428                     <span class="comment">// If the extended info field is zero then this file</span>
07429                     <span class="comment">// has no interesting tracking information.</span>
07430                     <span class="comment">//</span>
07431                     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/string_8c.html#a17">RtlCompareMemoryUlong</a>(SourceObjectId.BirthObjectId,
07432                                        <span class="keyword">sizeof</span>(SourceObjectId.BirthObjectId),
07433                                        0) == <span class="keyword">sizeof</span>(SourceObjectId.BirthObjectId)) {
07434                             <span class="keywordflow">return</span> (STATUS_SUCCESS);
07435                     }
07436 
07437 
07438                     <span class="comment">//</span>
07439                     <span class="comment">// Get the volume ID of the source and destination</span>
07440                     <span class="comment">//</span>
07441 
07442                     status = <a class="code" href="../../d0/d6/iop_8h.html#a184">IopGetVolumeId</a>( dstFileObject,
07443                                              &amp;TargetVolumeId,
07444                                              <span class="keyword">sizeof</span>( TargetVolumeId ) );
07445                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07446                         <span class="keywordflow">return</span> status;
07447                     }
07448 
07449                     status = <a class="code" href="../../d0/d6/iop_8h.html#a184">IopGetVolumeId</a>( FileObject,
07450                                              &amp;SourceVolumeId,
07451                                              <span class="keyword">sizeof</span>( SourceVolumeId ) );
07452                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07453                         <span class="keywordflow">return</span> status;
07454                     }
07455 
07456                     <span class="comment">//</span>
07457                     <span class="comment">// Delete the ID from the source now, since the</span>
07458                     <span class="comment">// target may be on the same volume.  If there's a</span>
07459                     <span class="comment">// subsequent error, we'll try to restore it.</span>
07460                     <span class="comment">//</span>
07461 
07462                     status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( FileObject,
07463                                                 NULL,
07464                                                 0,
07465                                                 FSCTL_DELETE_OBJECT_ID );
07466                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07467                         <span class="keywordflow">return</span> status;
07468                     }
07469 
07470 
07471                     <span class="comment">//</span>
07472                     <span class="comment">// Set the ID on the target.  If it's a cross-volume</span>
07473                     <span class="comment">// move, set the bit that indicates same.</span>
07474                     <span class="comment">//</span>
07475 
07476                     CrossVolumeObjectId = TargetObjectId = SourceObjectId;
07477                     <span class="keywordflow">if</span>( !RtlEqualMemory( &amp;TargetVolumeId.VolumeId[0],
07478                                          &amp;SourceVolumeId.VolumeId[0],
07479                                          <span class="keyword">sizeof</span>(SourceVolumeId.VolumeId) )) {
07480                         CrossVolumeObjectId.BirthVolumeId[0] |= 1;
07481                     }
07482 
07483                     status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( dstFileObject,
07484                                                 &amp;CrossVolumeObjectId,
07485                                                 <span class="keyword">sizeof</span>( CrossVolumeObjectId ),
07486                                                 FSCTL_SET_OBJECT_ID );
07487 
07488                     <span class="keywordflow">if</span>( status == STATUS_DUPLICATE_NAME ||
07489                         status == STATUS_OBJECT_NAME_COLLISION ) {
07490 
07491                         <span class="comment">// This object ID is already in use on the target volume,</span>
07492                         <span class="comment">// or the dest file already has an object ID.</span>
07493                         <span class="comment">// Get the file's ID (or have NTFS generate a new one).</span>
07494 
07495                         status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( dstFileObject,
07496                                                     &amp;TargetObjectId,
07497                                                     <span class="keyword">sizeof</span>(TargetObjectId),
07498                                                     FSCTL_CREATE_OR_GET_OBJECT_ID );
07499                         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
07500 
07501                             <span class="comment">// Write the birth ID</span>
07502 
07503                             status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( dstFileObject,
07504                                                         &amp;CrossVolumeObjectId.ExtendedInfo[0],
07505                                                         <span class="keyword">sizeof</span>( CrossVolumeObjectId.ExtendedInfo ),
07506                                                         FSCTL_SET_OBJECT_ID_EXTENDED );
07507                         }
07508                     }
07509 
07510                     <span class="keywordflow">if</span>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
07511 
07512                         IdSetOnTarget = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07513 
07514                         <span class="comment">// If this was a cross-volume move, notify the tracking service.</span>
07515 
07516                         <span class="keywordflow">if</span>( !RtlEqualMemory( &amp;TargetVolumeId.VolumeId[0],
07517                                              &amp;SourceVolumeId.VolumeId[0],
07518                                              <span class="keyword">sizeof</span>(SourceVolumeId.VolumeId) )) {
07519 
07520                             <a class="code" href="../../d2/d4/internal_8c.html#a15">IopMarshalIds</a>( &amp;trackingBuffer, &amp;TargetVolumeId, &amp;TargetObjectId, trackingInfo );
07521 
07522                             <span class="comment">// Bit 0 must be reset before notifying tracking service</span>
07523                             NormalizedObjectId = SourceObjectId;
07524                             NormalizedObjectId.BirthVolumeId[0] &amp;= 0xfe;
07525 
07526                             status = <a class="code" href="../../d2/d4/internal_8c.html#a62">IopSendMessageToTrackService</a>( &amp;SourceVolumeId,
07527                                                                    &amp;NormalizedObjectId,
07528                                                                    &amp;trackingBuffer.<a class="code" href="../../d1/d2/struct__TRACKING__BUFFER.html#o0">TrackingInformation</a> );
07529                         }
07530                     }
07531 
07532                     <span class="comment">//</span>
07533                     <span class="comment">// If there was an error after the ObjectID was deleted</span>
07534                     <span class="comment">// from the source.  Try to restore it before returning.</span>
07535                     <span class="comment">//</span>
07536 
07537                     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
07538                         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> statusT = STATUS_SUCCESS;
07539 
07540                         <span class="keywordflow">if</span>( IdSetOnTarget ) {
07541 
07542                             <span class="keywordflow">if</span>( RtlEqualMemory( &amp;TargetObjectId.ObjectId,
07543                                                 &amp;SourceObjectId.ObjectId,
07544                                                 <span class="keyword">sizeof</span>(TargetObjectId.ObjectId) )) {
07545 
07546                                 <span class="comment">// This ID was set with FSCTL_SET_OBJECT_ID</span>
07547                                 statusT = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( dstFileObject,
07548                                                              NULL,
07549                                                              0,
07550                                                              FSCTL_DELETE_OBJECT_ID );
07551 
07552                             } <span class="keywordflow">else</span> {
07553 
07554                                 <span class="comment">// Restore the target's extended data.</span>
07555 
07556                                 statusT = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( dstFileObject,
07557                                                              &amp;TargetObjectId.ExtendedInfo[0],
07558                                                              <span class="keyword">sizeof</span>(TargetObjectId.ExtendedInfo),
07559                                                              FSCTL_SET_OBJECT_ID_EXTENDED );
07560                             }
07561                         }
07562 
07563                         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( statusT )) {
07564 
07565                             <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( FileObject,
07566                                                &amp;SourceObjectId,
07567                                                <span class="keyword">sizeof</span>(SourceObjectId),
07568                                                FSCTL_SET_OBJECT_ID );
07569                         }
07570 
07571                         <span class="keywordflow">return</span> status;
07572                     }
07573 
07574 
07575                 } <span class="keywordflow">else</span> {    <span class="comment">// if (IsFileLocal( dstFileObject ))</span>
07576 
07577                     <span class="comment">//</span>
07578                     <span class="comment">// The source file is local, but the destination file object</span>
07579                     <span class="comment">// is remote.  For this case query the target file's object</span>
07580                     <span class="comment">// ID and notify the link tracking system that the file has</span>
07581                     <span class="comment">// been moved across systems.</span>
07582                     <span class="comment">//</span>
07583 
07584                     <span class="comment">//</span>
07585                     <span class="comment">// Begin by ensuring that the source file has an object ID</span>
07586                     <span class="comment">// already.  If not, then just make it appear as if the</span>
07587                     <span class="comment">// operation worked.</span>
07588                     <span class="comment">//</span>
07589 
07590                     status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( FileObject,
07591                                                 &amp;SourceObjectId,
07592                                                 <span class="keyword">sizeof</span>( SourceObjectId ),
07593                                                 FSCTL_GET_OBJECT_ID );
07594                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07595                         <span class="keywordflow">return</span> STATUS_SUCCESS;
07596                     }
07597 
07598 
07599                     <span class="comment">//</span>
07600                     <span class="comment">// If the extended info field is zero then this file</span>
07601                     <span class="comment">// has no interesting tracking information.</span>
07602                     <span class="comment">//</span>
07603                     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/string_8c.html#a17">RtlCompareMemoryUlong</a>(&amp;SourceObjectId.BirthObjectId,
07604                                        <span class="keyword">sizeof</span>(SourceObjectId.BirthObjectId),
07605                                        0) == <span class="keyword">sizeof</span>(SourceObjectId.BirthObjectId)) {
07606                             <span class="keywordflow">return</span> (STATUS_SUCCESS);
07607                     }
07608 
07609                     <span class="comment">//</span>
07610                     <span class="comment">// Query the volume ID of the target.</span>
07611                     <span class="comment">//</span>
07612 
07613                     status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( dstFileObject,
07614                                                 &amp;TargetVolumeId,
07615                                                 <span class="keyword">sizeof</span>( FILE_VOLUMEID_WITH_TYPE ),
07616                                                 FSCTL_LMR_GET_LINK_TRACKING_INFORMATION );
07617                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07618                         <span class="keywordflow">return</span> status;
07619                     }
07620 
07621                     <span class="comment">//</span>
07622                     <span class="comment">// Query the object ID of the target.</span>
07623                     <span class="comment">//</span>
07624 
07625                     status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( dstFileObject,
07626                                                 &amp;TargetObjectId,
07627                                                 <span class="keyword">sizeof</span>( TargetObjectId ),
07628                                                 FSCTL_CREATE_OR_GET_OBJECT_ID );
07629                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07630                         <span class="keywordflow">return</span> status;
07631                     }
07632 
07633                     <span class="comment">//</span>
07634                     <span class="comment">// Notify the tracking system of the move.</span>
07635                     <span class="comment">//</span>
07636 
07637                     <a class="code" href="../../d2/d4/internal_8c.html#a15">IopMarshalIds</a>( &amp;trackingBuffer, &amp;TargetVolumeId, &amp;TargetObjectId, trackingInfo );
07638                     status = <a class="code" href="../../d0/d6/iop_8h.html#a214">IopTrackLink</a>( FileObject,
07639                                            IoStatusBlock,
07640                                            &amp;trackingBuffer.<a class="code" href="../../d1/d2/struct__TRACKING__BUFFER.html#o0">TrackingInformation</a>,
07641                                            FIELD_OFFSET( FILE_TRACKING_INFORMATION,
07642                                                 ObjectInformation ) +
07643                                                     trackingBuffer.<a class="code" href="../../d1/d2/struct__TRACKING__BUFFER.html#o0">TrackingInformation</a>.ObjectInformationLength,
07644                                            Event,
07645                                            KernelMode );
07646                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07647                         <span class="keywordflow">return</span> status;
07648                     }
07649 
07650                     <span class="comment">//</span>
07651                     <span class="comment">// Delete the ID from the source</span>
07652                     <span class="comment">//</span>
07653 
07654                     status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( FileObject,
07655                                                 NULL,
07656                                                 0,
07657                                                 FSCTL_DELETE_OBJECT_ID );
07658                     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07659                         <span class="keywordflow">return</span> status;
07660                     }
07661 
07662                     <span class="comment">//</span>
07663                     <span class="comment">// Set the Birth ID on the target, turning on the bit</span>
07664                     <span class="comment">// that indicates that this file has been involved in a cross-</span>
07665                     <span class="comment">// volume move.</span>
07666                     <span class="comment">//</span>
07667 
07668                     CrossVolumeObjectId = SourceObjectId;
07669                     CrossVolumeObjectId.BirthVolumeId[0] |= 1;
07670 
07671                     status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( dstFileObject,
07672                                                 &amp;CrossVolumeObjectId.ExtendedInfo[0],
07673                                                 <span class="keyword">sizeof</span>( CrossVolumeObjectId.ExtendedInfo ),
07674                                                 FSCTL_SET_OBJECT_ID_EXTENDED );
07675                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07676 
07677                         <span class="comment">// Try to restore the source</span>
07678                         <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( FileObject,
07679                                            &amp;SourceObjectId,
07680                                            <span class="keyword">sizeof</span>(SourceObjectId),
07681                                            FSCTL_SET_OBJECT_ID );
07682                         <span class="keywordflow">return</span> status;
07683                     }
07684 
07685 
07686                 }   <span class="comment">// if (IsFileLocal( dstFileObject ))</span>
07687 
07688             } <span class="keywordflow">else</span> {    <span class="comment">// if (trackingInfo-&gt;DestinationFile)</span>
07689 
07690                 <span class="comment">//</span>
07691                 <span class="comment">// A destination file handle was not specified.  Simply query</span>
07692                 <span class="comment">// the source file's object ID and call the link tracking code.</span>
07693                 <span class="comment">// Note that the function input buffer contains the volume ID</span>
07694                 <span class="comment">// and file object ID of the target.  Note also that it is</span>
07695                 <span class="comment">// assumed that the source file has an object ID.</span>
07696                 <span class="comment">//</span>
07697 
07698                 status = <a class="code" href="../../d0/d6/iop_8h.html#a184">IopGetVolumeId</a>( FileObject,
07699                                          &amp;SourceVolumeId,
07700                                          <span class="keyword">sizeof</span>( SourceVolumeId ) );
07701                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07702                     <span class="keywordflow">return</span> status;
07703                 }
07704 
07705                 status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( FileObject,
07706                                             &amp;SourceObjectId,
07707                                             <span class="keyword">sizeof</span>( SourceObjectId ),
07708                                             FSCTL_GET_OBJECT_ID );
07709                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07710                     <span class="keywordflow">return</span> status;
07711                 }
07712 
07713                 <span class="comment">//</span>
07714                 <span class="comment">// If the extended info field is zero then this file</span>
07715                 <span class="comment">// has no interesting tracking information.</span>
07716                 <span class="comment">//</span>
07717                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/string_8c.html#a17">RtlCompareMemoryUlong</a>(SourceObjectId.BirthObjectId,
07718                                        <span class="keyword">sizeof</span>(SourceObjectId.BirthObjectId),
07719                                        0) == <span class="keyword">sizeof</span>(SourceObjectId.BirthObjectId)) {
07720                             <span class="keywordflow">return</span> (STATUS_SUCCESS);
07721                 }
07722                 <span class="comment">//</span>
07723                 <span class="comment">// Inform the user-mode link tracking service that the file</span>
07724                 <span class="comment">// has been moved.</span>
07725                 <span class="comment">//</span>
07726 
07727                 NormalizedObjectId = SourceObjectId;
07728                 NormalizedObjectId.BirthVolumeId[0] &amp;= 0xfe;
07729 
07730                 status = <a class="code" href="../../d2/d4/internal_8c.html#a62">IopSendMessageToTrackService</a>( &amp;SourceVolumeId,
07731                                                        &amp;NormalizedObjectId,
07732                                                        FileInformation );
07733                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07734                     <span class="keywordflow">return</span> status;
07735                 }
07736 
07737             }   <span class="comment">// if (trackingInfo-&gt;DestinationFile) ... else</span>
07738 
07739         } <span class="keywordflow">else</span> {    <span class="comment">// if (IsFileLocal( FileObject ))</span>
07740 
07741             <span class="comment">//</span>
07742             <span class="comment">// The source file is remote.  For this case, remote the operation</span>
07743             <span class="comment">// to the system on which the source file is located.  Begin by</span>
07744             <span class="comment">// ensuring that the source file actually has an object ID.  If</span>
07745             <span class="comment">// not, then get out now since there is nothing to be done.</span>
07746             <span class="comment">//</span>
07747 
07748             status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( FileObject,
07749                                         &amp;SourceObjectId,
07750                                         <span class="keyword">sizeof</span>( SourceObjectId ),
07751                                         FSCTL_GET_OBJECT_ID );
07752 
07753             <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND)
07754             {
07755                 <span class="keywordflow">return</span> STATUS_SUCCESS;
07756             }
07757 
07758             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07759                 <span class="keywordflow">return</span> status;
07760             }
07761 
07762             <span class="comment">//</span>
07763             <span class="comment">// If the extended info field is zero then this file</span>
07764             <span class="comment">// has no interesting tracking information.</span>
07765             <span class="comment">//</span>
07766             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/string_8c.html#a17">RtlCompareMemoryUlong</a>(SourceObjectId.BirthObjectId,
07767                                       <span class="keyword">sizeof</span>(SourceObjectId.BirthObjectId),
07768                                       0) == <span class="keyword">sizeof</span>(SourceObjectId.BirthObjectId)) {
07769                 <span class="keywordflow">return</span> (STATUS_SUCCESS);
07770             }
07771             <span class="keywordflow">if</span> (trackingInfo-&gt;DestinationFile) {
07772 
07773                 <span class="comment">//</span>
07774                 <span class="comment">// A handle was specified for the destination file.  Determine</span>
07775                 <span class="comment">// whether it is local or remote.  If remote and both handles</span>
07776                 <span class="comment">// refer to the same machine, then ship the entire API to that</span>
07777                 <span class="comment">// machine and have it perform the operation.</span>
07778                 <span class="comment">//</span>
07779                 <span class="comment">// Otherwise, query the target file's object ID, and then redo</span>
07780                 <span class="comment">// the operation.  This will cause the API to be remoted to the</span>
07781                 <span class="comment">// machine where the source file resides.</span>
07782                 <span class="comment">//</span>
07783 
07784                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4/internal_8c.html#a0">IsFileLocal</a>( dstFileObject )) {
07785 
07786                     <span class="comment">//</span>
07787                     <span class="comment">// The source is remote and the destination is local, so</span>
07788                     <span class="comment">// query the object ID of the target and recursively track</span>
07789                     <span class="comment">// the link from the source file's remote node.</span>
07790                     <span class="comment">//</span>
07791 
07792                     status = <a class="code" href="../../d0/d6/iop_8h.html#a184">IopGetVolumeId</a>( dstFileObject,
07793                                              &amp;TargetVolumeId,
07794                                              <span class="keyword">sizeof</span>( TargetVolumeId ) );
07795                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07796                         <span class="keywordflow">return</span> status;
07797                     }
07798 
07799                     status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( dstFileObject,
07800                                                 &amp;TargetObjectId,
07801                                                 <span class="keyword">sizeof</span>( TargetObjectId ),
07802                                                 FSCTL_CREATE_OR_GET_OBJECT_ID );
07803                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07804                         <span class="keywordflow">return</span> status;
07805                     }
07806 
07807 
07808                     <span class="comment">//</span>
07809                     <span class="comment">// Notify the tracking system of the move.</span>
07810                     <span class="comment">//</span>
07811 
07812                     <a class="code" href="../../d2/d4/internal_8c.html#a15">IopMarshalIds</a>( &amp;trackingBuffer, &amp;TargetVolumeId, &amp;TargetObjectId, trackingInfo );
07813 
07814                     status = <a class="code" href="../../d0/d6/iop_8h.html#a214">IopTrackLink</a>( FileObject,
07815                                            IoStatusBlock,
07816                                            &amp;trackingBuffer.<a class="code" href="../../d1/d2/struct__TRACKING__BUFFER.html#o0">TrackingInformation</a>,
07817                                            FIELD_OFFSET( FILE_TRACKING_INFORMATION,
07818                                                 ObjectInformation ) +
07819                                                     trackingBuffer.<a class="code" href="../../d1/d2/struct__TRACKING__BUFFER.html#o0">TrackingInformation</a>.ObjectInformationLength,
07820                                            Event,
07821                                            KernelMode );
07822                     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
07823                         <span class="keywordflow">return</span> status;
07824                     }
07825 
07826                     <span class="comment">//</span>
07827                     <span class="comment">//  Delete the ID from the source</span>
07828                     <span class="comment">//</span>
07829 
07830                     status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( FileObject,
07831                                                 NULL,
07832                                                 0,
07833                                                 FSCTL_DELETE_OBJECT_ID );
07834                     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07835                         <span class="keywordflow">return</span> status;
07836                     }
07837 
07838                     <span class="comment">//</span>
07839                     <span class="comment">// Set the birth ID on the target, also turning on the bit</span>
07840                     <span class="comment">// that indicates that this file has moved across volumes.</span>
07841                     <span class="comment">//</span>
07842 
07843                     CrossVolumeObjectId = SourceObjectId;
07844                     CrossVolumeObjectId.BirthVolumeId[0] |= 1;
07845 
07846                     status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( dstFileObject,
07847                                                 &amp;CrossVolumeObjectId.ExtendedInfo[0],
07848                                                 <span class="keyword">sizeof</span>( CrossVolumeObjectId.ExtendedInfo ),
07849                                                 FSCTL_SET_OBJECT_ID_EXTENDED );
07850 
07851                     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07852 
07853                         <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( FileObject,
07854                                            &amp;SourceObjectId,
07855                                            <span class="keyword">sizeof</span>(SourceObjectId),
07856                                            FSCTL_SET_OBJECT_ID );
07857                         <span class="keywordflow">return</span> status;
07858                     }
07859 
07860                 }   <span class="comment">// if (IsFileLocal( dstFileObject ))</span>
07861 
07862                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a190">IopIsSameMachine</a>( FileObject, trackingInfo-&gt;DestinationFile)) {
07863 
07864                     <span class="comment">//</span>
07865                     <span class="comment">// The source and the target are remote from each other and from</span>
07866                     <span class="comment">// this machine.  Query the object ID of the target and recursively</span>
07867                     <span class="comment">// track the link from the source file's remote node.</span>
07868                     <span class="comment">//</span>
07869 
07870                     <span class="comment">//</span>
07871                     <span class="comment">// Query the volume ID of the target.</span>
07872                     <span class="comment">//</span>
07873 
07874                     status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( dstFileObject,
07875                                                 &amp;TargetVolumeId,
07876                                                 <span class="keyword">sizeof</span>( FILE_VOLUMEID_WITH_TYPE ),
07877                                                 FSCTL_LMR_GET_LINK_TRACKING_INFORMATION );
07878 
07879                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07880                         <span class="keywordflow">return</span> status;
07881                     }
07882 
07883                     <span class="comment">//</span>
07884                     <span class="comment">// Query the object ID of the target.</span>
07885                     <span class="comment">//</span>
07886 
07887                     status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( dstFileObject,
07888                                                 &amp;TargetObjectId,
07889                                                 <span class="keyword">sizeof</span>( TargetObjectId ),
07890                                                 FSCTL_CREATE_OR_GET_OBJECT_ID );
07891                     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07892                         <span class="keywordflow">return</span> status;
07893                     }
07894 
07895                     <span class="comment">//</span>
07896                     <span class="comment">// Notify the tracking system of the move.</span>
07897                     <span class="comment">//</span>
07898 
07899                     <a class="code" href="../../d2/d4/internal_8c.html#a15">IopMarshalIds</a>( &amp;trackingBuffer, &amp;TargetVolumeId, &amp;TargetObjectId, trackingInfo );
07900 
07901                     status = <a class="code" href="../../d0/d6/iop_8h.html#a214">IopTrackLink</a>( FileObject,
07902                                            IoStatusBlock,
07903                                            &amp;trackingBuffer.<a class="code" href="../../d1/d2/struct__TRACKING__BUFFER.html#o0">TrackingInformation</a>,
07904                                            FIELD_OFFSET( FILE_TRACKING_INFORMATION,
07905                                                 ObjectInformation ) +
07906                                                     trackingBuffer.<a class="code" href="../../d1/d2/struct__TRACKING__BUFFER.html#o0">TrackingInformation</a>.ObjectInformationLength,
07907                                            Event,
07908                                            KernelMode );
07909                     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07910                         <span class="keywordflow">return</span> status;
07911                     }
07912 
07913                     <span class="comment">//</span>
07914                     <span class="comment">// Set the birth ID on the target, turning on the bit that indicates</span>
07915                     <span class="comment">// that this file has moved across volumes.</span>
07916                     <span class="comment">//</span>
07917 
07918                     CrossVolumeObjectId = SourceObjectId;
07919                     CrossVolumeObjectId.BirthVolumeId[0] |= 1;
07920 
07921                     status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( dstFileObject,
07922                                                 &amp;CrossVolumeObjectId.ExtendedInfo[0],
07923                                                 <span class="keyword">sizeof</span>( CrossVolumeObjectId.ExtendedInfo ),
07924                                                 FSCTL_SET_OBJECT_ID_EXTENDED );
07925 
07926                     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07927                         <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( FileObject,
07928                                            &amp;SourceObjectId,
07929                                            <span class="keyword">sizeof</span>(SourceObjectId),
07930                                            FSCTL_SET_OBJECT_ID );
07931                         <span class="keywordflow">return</span> status;
07932                     }
07933 
07934                 } <span class="keywordflow">else</span> {    <span class="comment">// else if (!IopIsSameMachine( FileObject, trackingInfo-&gt;DestinationFile))</span>
07935 
07936                     <span class="comment">//</span>
07937                     <span class="comment">// Both the source and the target are remote and they're</span>
07938                     <span class="comment">// both on the same remote machine.  For this case, remote</span>
07939                     <span class="comment">// the entire API using the file object pointers.</span>
07940                     <span class="comment">//</span>
07941 
07942                     status = <a class="code" href="../../d0/d6/iop_8h.html#a209">IopSetRemoteLink</a>( FileObject, dstFileObject, trackingInfo );
07943 
07944                 }   <span class="comment">// else if (!IopIsSameMachine( FileObject, trackingInfo-&gt;DestinationFile)) ... else</span>
07945 
07946             } <span class="keywordflow">else</span> {    <span class="comment">// if (trackingInfo-&gt;DestinationFile)</span>
07947 
07948                 <span class="comment">//</span>
07949                 <span class="comment">// The source file is remote and the object ID of the target is</span>
07950                 <span class="comment">// contained w/in the tracking buffer.  Simply remote the API</span>
07951                 <span class="comment">// to the remote machine using the source file object pointer</span>
07952                 <span class="comment">// and the object ID of the target in the buffer.</span>
07953                 <span class="comment">//</span>
07954 
07955                 status = <a class="code" href="../../d0/d6/iop_8h.html#a209">IopSetRemoteLink</a>( FileObject, NULL, FileInformation );
07956 
07957             }   <span class="comment">// if (trackingInfo-&gt;DestinationFile) ... else</span>
07958         }   <span class="comment">// if (IsFileLocal( FileObject )) ... else</span>
07959 
07960     } finally {
07961 
07962         <span class="comment">//</span>
07963         <span class="comment">// Ensure that everything has been cleaned up.</span>
07964         <span class="comment">//</span>
07965 
07966         <span class="keywordflow">if</span> (RequestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> &amp;&amp; trackingInfo) {
07967             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( trackingInfo );
07968         }
07969 
07970         <span class="keywordflow">if</span> (dstFileObject ) {
07971             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( dstFileObject );
07972         }
07973 
07974         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( Event, 0, FALSE );
07975     }
07976 
07977     <span class="keywordflow">return</span> status;
07978 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a229" doxytag="iop.h::IopUpdateOtherOperationCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopUpdateOtherOperationCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12345">12345</a> of file <a class="el" href="../../d5/d5/iosubs_8c-source.html">iosubs.c</a>.
<p>
References <a class="el" href="../../d5/d8/ex_8h.html#a233">ExInterlockedAddLargeStatistic()</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00111">IoCountOperations</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02595">IoOtherOperationCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00638">THREAD_TO_PROCESS</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l04502">IoCreateFile()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00036">IopCloseFile()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00975">IopGetSetSecurityObject()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l07030">IopSynchronousServiceTail()</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00049">NtCancelIoFile()</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00298">NtDeleteFile()</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00629">NtQueryAttributesFile()</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00745">NtQueryFullAttributesFile()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00101">NtQueryInformationFile()</a>, and <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>.
<p>
<pre class="fragment"><div>12350                    :
12351 
12352     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to update <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation count <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current
12353     process to indicate that an I/O service other than a read or write
12354     has been invoked.
12355 
12356     There <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an implicit assumption that <span class="keyword">this</span> call <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context
12357     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> issuing thread.
12358 
12359 Arguments:
12360 
12361     None.
12362 
12363 Return Value:
12364 
12365     None.
12366 
12367 --*/
12368 {
12369     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a55">IoCountOperations</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
12370         <a class="code" href="../../d0/d5/io_8h.html#a382">IoOtherOperationCount</a> += 1;
12371         <a class="code" href="../../d5/d8/ex_8h.html#a233">ExInterlockedAddLargeStatistic</a>( &amp;<a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>(<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>())-&gt;OtherOperationCount, 1);
12372     }
12373 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a232" doxytag="iop.h::IopUpdateOtherTransferCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopUpdateOtherTransferCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>TransferCount</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12441">12441</a> of file <a class="el" href="../../d5/d5/iosubs_8c-source.html">iosubs.c</a>.
<p>
References <a class="el" href="../../d5/d8/ex_8h.html#a233">ExInterlockedAddLargeStatistic()</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00111">IoCountOperations</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02598">IoOtherTransferCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00638">THREAD_TO_PROCESS</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l01019">IopCompleteRequest()</a>, and <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>.
<p>
<pre class="fragment"><div>12446                    :
12447 
12448     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to update <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> transfer count <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current
12449     process <span class="keywordflow">for</span> an operation other than a read or write system service.
12450 
12451     There <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an implicit assumption that <span class="keyword">this</span> call <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context
12452     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> issuing thread. Also note that overflow <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> folded into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread's
12453     process.
12454 
12455 Arguments:
12456 
12457     TransferCount - The count of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes transferred.
12458 
12459 Return Value:
12460 
12461     None.
12462 
12463 --*/
12464 {
12465     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a55">IoCountOperations</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
12466         <a class="code" href="../../d5/d8/ex_8h.html#a233">ExInterlockedAddLargeStatistic</a>( &amp;IoOtherTransferCount, TransferCount );
12467         <a class="code" href="../../d5/d8/ex_8h.html#a233">ExInterlockedAddLargeStatistic</a>( &amp;<a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>(<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>())-&gt;OtherTransferCount, TransferCount);
12468     }
12469 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a230" doxytag="iop.h::IopUpdateReadOperationCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopUpdateReadOperationCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12377">12377</a> of file <a class="el" href="../../d5/d5/iosubs_8c-source.html">iosubs.c</a>.
<p>
References <a class="el" href="../../d5/d8/ex_8h.html#a233">ExInterlockedAddLargeStatistic()</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00111">IoCountOperations</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02593">IoReadOperationCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00638">THREAD_TO_PROCESS</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l07030">IopSynchronousServiceTail()</a>, and <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00036">NtReadFile()</a>.
<p>
<pre class="fragment"><div>12383                    :
12384 
12385     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to update <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> read operation count <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
12386     current process to indicate that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d5/io_2read_8c.html#a1">NtReadFile</a> system service has
12387     been invoked.
12388 
12389     There <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an implicit assumption that <span class="keyword">this</span> call <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context
12390     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> issuing thread.
12391 
12392 Arguments:
12393 
12394     None.
12395 
12396 Return Value:
12397 
12398     None.
12399 
12400 --*/
12401 {
12402     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a55">IoCountOperations</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
12403         <a class="code" href="../../d0/d5/io_8h.html#a380">IoReadOperationCount</a> += 1;
12404         <a class="code" href="../../d5/d8/ex_8h.html#a233">ExInterlockedAddLargeStatistic</a>( &amp;<a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>(<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>())-&gt;ReadOperationCount, 1);
12405     }
12406 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a233" doxytag="iop.h::IopUpdateReadTransferCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopUpdateReadTransferCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>TransferCount</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12473">12473</a> of file <a class="el" href="../../d5/d5/iosubs_8c-source.html">iosubs.c</a>.
<p>
References <a class="el" href="../../d5/d8/ex_8h.html#a233">ExInterlockedAddLargeStatistic()</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00111">IoCountOperations</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02596">IoReadTransferCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00638">THREAD_TO_PROCESS</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l01019">IopCompleteRequest()</a>, and <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00036">NtReadFile()</a>.
<p>
<pre class="fragment"><div>12478                    :
12479 
12480     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to update <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> read transfer count <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
12481     current process.
12482 
12483     There <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an implicit assumption that <span class="keyword">this</span> call <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context
12484     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> issuing thread. Also note that overflow <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> folded into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread's
12485     process.
12486 
12487 Arguments:
12488 
12489     TransferCount - The count of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes transferred.
12490 
12491 Return Value:
12492 
12493     None.
12494 
12495 --*/
12496 {
12497     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a55">IoCountOperations</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
12498         <a class="code" href="../../d5/d8/ex_8h.html#a233">ExInterlockedAddLargeStatistic</a>( &amp;IoReadTransferCount, TransferCount );
12499         <a class="code" href="../../d5/d8/ex_8h.html#a233">ExInterlockedAddLargeStatistic</a>( &amp;<a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>(<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>())-&gt;ReadTransferCount, TransferCount);
12500     }
12501 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a231" doxytag="iop.h::IopUpdateWriteOperationCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopUpdateWriteOperationCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12410">12410</a> of file <a class="el" href="../../d5/d5/iosubs_8c-source.html">iosubs.c</a>.
<p>
References <a class="el" href="../../d5/d8/ex_8h.html#a233">ExInterlockedAddLargeStatistic()</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00111">IoCountOperations</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02594">IoWriteOperationCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00638">THREAD_TO_PROCESS</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l07030">IopSynchronousServiceTail()</a>, and <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00035">NtWriteFile()</a>.
<p>
<pre class="fragment"><div>12415                    :
12416 
12417     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to update <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> write operation count <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
12418     current process to indicate that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d0/io_2write_8c.html#a0">NtWriteFile</a> service other has
12419     been invoked.
12420 
12421     There <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an implicit assumption that <span class="keyword">this</span> call <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context
12422     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> issuing thread.
12423 
12424 Arguments:
12425 
12426     None.
12427 
12428 Return Value:
12429 
12430     None.
12431 
12432 --*/
12433 {
12434     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a55">IoCountOperations</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
12435         <a class="code" href="../../d0/d5/io_8h.html#a381">IoWriteOperationCount</a> += 1;
12436         <a class="code" href="../../d5/d8/ex_8h.html#a233">ExInterlockedAddLargeStatistic</a>( &amp;<a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>(<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>())-&gt;WriteOperationCount, 1);
12437     }
12438 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a234" doxytag="iop.h::IopUpdateWriteTransferCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopUpdateWriteTransferCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>TransferCount</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12504">12504</a> of file <a class="el" href="../../d5/d5/iosubs_8c-source.html">iosubs.c</a>.
<p>
References <a class="el" href="../../d5/d8/ex_8h.html#a233">ExInterlockedAddLargeStatistic()</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00111">IoCountOperations</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02597">IoWriteTransferCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00638">THREAD_TO_PROCESS</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l01019">IopCompleteRequest()</a>, and <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00035">NtWriteFile()</a>.
<p>
<pre class="fragment"><div>12509                    :
12510 
12511     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to update <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> write transfer count <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
12512     current process.
12513 
12514     There <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an implicit assumption that <span class="keyword">this</span> call <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context
12515     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> issuing thread. Also note that overflow <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> folded into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread's
12516     process.
12517 
12518 Arguments:
12519 
12520     TransferCount - The count of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes transferred.
12521 
12522 Return Value:
12523 
12524     None.
12525 
12526 --*/
12527 {
12528     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a55">IoCountOperations</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
12529         <a class="code" href="../../d5/d8/ex_8h.html#a233">ExInterlockedAddLargeStatistic</a>( &amp;IoWriteTransferCount, TransferCount );
12530         <a class="code" href="../../d5/d8/ex_8h.html#a233">ExInterlockedAddLargeStatistic</a>( &amp;<a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>(<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>())-&gt;WriteTransferCount, TransferCount);
12531     }
12532 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a215" doxytag="iop.h::IopUserCompletion" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopUserCompletion           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Apc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l07981">7981</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06632">IoFreeIrp()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l01019">IopCompleteRequest()</a>.
<p>
<pre class="fragment"><div>07991                    :
07992 
07993     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> processing of an <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>.  Everything has
07994     been completed except that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's APC routine must be invoked.  The
07995     system will <span class="keywordflow">do</span> <span class="keyword">this</span> as soon as <span class="keyword">this</span> routine exits.  The <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> processing
07996     remaining to be completed by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O system <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a>
07997     Packet itself.
07998 
07999 Arguments:
08000 
08001     Apc - Supplies a pointer to kernel APC structure.
08002 
08003     NormalRoutine - Supplies a pointer to a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> normal function
08004         that was specified when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC was initialied.
08005 
08006     NormalContext - Supplies a pointer to a pointer to an arbitrary data
08007         structure that was specified when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC was initialized.
08008 
08009     SystemArgument1, SystemArgument2 - Supplies a set of two pointers to
08010         two arguments that contain untyped data.
08011 
08012 Return Value:
08013 
08014     None.
08015 
08016 Note:
08017 
08018     If no other processing <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ever needed, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC can be placed at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
08019     beginning of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>, then <span class="keyword">this</span> routine could be replaced by simply
08020     specifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> deallocation routine in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC instead
08021     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <span class="keyword">this</span> routine.
08022 
08023 Caution:
08024 
08025     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> also invoked as a general purpose rundown routine <span class="keywordflow">for</span> APCs.
08026     Should <span class="keyword">this</span> code ever need to directly access any of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> other parameters
08027     other than Apc, <span class="keyword">this</span> routine will need to be split into two separate
08028     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a>.  The rundown routine should perform exactly <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following code's
08029     functionality.
08030 
08031 --*/
08032 
08033 {
08034     UNREFERENCED_PARAMETER( NormalRoutine );
08035     UNREFERENCED_PARAMETER( NormalContext );
08036     UNREFERENCED_PARAMETER( SystemArgument1 );
08037     UNREFERENCED_PARAMETER( SystemArgument2 );
08038 
08039     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
08040 
08041     <span class="comment">//</span>
08042     <span class="comment">// Free the packet.</span>
08043     <span class="comment">//</span>
08044 
08045     <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>( CONTAINING_RECORD( Apc, IRP, Tail.Apc ) );
08046 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a216" doxytag="iop.h::IopXxxControlFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopXxxControlFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE Event&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PIO_APC_ROUTINE ApcRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID ApcContext&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>IoControlCode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID InputBuffer&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>InputBufferLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID OutputBuffer&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>OutputBufferLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceIoControl</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l08084">8084</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01661">_IRP::Cancel</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01701">_IRP::CancelRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00127">ExAllocatePoolWithQuota</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00030">ExEventObjectType</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00952">_FAST_IO_DISPATCH::FastIoDeviceControl</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01403">_DRIVER_OBJECT::FastIoDispatch</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01492">FO_ALERTABLE_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01501">FO_DIRECT_DEVICE_OPEN</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01491">FO_SYNCHRONOUS_IO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00057">_OBJECT_HANDLE_INFORMATION::GrantedAccess</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00805">IoAllocateMdl()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00044">IoFileObjectType</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06786">IoGetAttachedDevice()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00595">IopAcquireFastLock</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00181">IopAcquireFileObjectLock()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00604">IopAllocateIrp</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00284">IopAllocateIrpCleanup()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00768">IopApcRoutinePresent</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01934">IopExceptionCleanup()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01157">IopReleaseFileObjectLock</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l07030">IopSynchronousServiceTail()</a>, <a class="el" href="../../d2/d1/mm_8h.html#a344a168">IoReadAccess</a>, <a class="el" href="../../d6/d3/complete_8c-source.html#l00671">IoSetIoCompletion()</a>, <a class="el" href="../../d2/d1/mm_8h.html#a344a169">IoWriteAccess</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01554">IRP_BUFFERED_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01555">IRP_DEALLOCATE_BUFFER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01564">IRP_DEFER_IO_COMPLETION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01556">IRP_INPUT_OPERATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00069">IRP_MJ_DEVICE_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00068">IRP_MJ_FILE_SYSTEM_CONTROL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d2/d1/mm_8h.html#a141">LOCK_OPERATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01596">_IRP::MdlAddress</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00238">MmProbeAndLockPages()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a177">NonPagedPoolCacheAligned</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a240a140">OtherTransfer</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o24">_IRP::Overlay</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00547">PDRIVER_CANCEL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01648">_IRP::PendingReturned</a>, <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01518">ProbeForWriteIoStatusEx</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01641">_IRP::RequestorMode</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00515">SeComputeGrantedAccesses</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01711">_IRP::UserBuffer</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>.
<p>
Referenced by <a class="el" href="../../d2/d6/io_2devctrl_8c-source.html#l00034">NtDeviceIoControlFile()</a>, and <a class="el" href="../../d9/d6/io_2fsctrl_8c-source.html#l00034">NtFsControlFile()</a>.
<p>
<pre class="fragment"><div>08100                    :
08101 
08102     This service builds descriptors or MDLs <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supplied buffer(s) and
08103     passes the untyped data to the driver associated with the file handle.
08104     handle.  It is up to the driver to check the input data and function
08105     IoControlCode for validity, as well as to make the appropriate access
08106     checks.
08107 
08108 Arguments:
08109 
08110     FileHandle - Supplies a handle to the file on which the service is being
08111         performed.
08112 
08113     Event - Supplies an optional event to be set to the Signaled state when
08114         the service is complete.
08115 
08116     ApcRoutine - Supplies an optional APC routine to be executed when the
08117         service is complete.
08118 
08119     ApcContext - Supplies a context parameter to be passed to the ApcRoutine,
08120         if an ApcRoutine was specified.
08121 
08122     IoStatusBlock - Address of the caller's I/O status block.
08123 
08124     IoControlCode - Subfunction code to determine exactly what operation is
08125         being performed.
08126 
08127     InputBuffer - Optionally supplies an input buffer to be passed to the
08128         driver.  Whether or not the buffer is actually optional is dependent
08129         on the IoControlCode.
08130 
08131     InputBufferLength - Length of the InputBuffer in bytes.
08132 
08133     OutputBuffer - Optionally supplies an output buffer to receive information
08134         from the driver.  Whether or not the buffer is actually optional is
08135         dependent on the IoControlCode.
08136 
08137     OutputBufferLength - Length of the OutputBuffer in bytes.
08138 
08139     DeviceIoControl - Determines whether this is a Device or File System
08140         Control function.
08141 
08142 Return Value:
08143 
08144     The status returned is success if the control operation was properly
08145     queued to the I/O system.   Once the operation completes, the status
08146     can be determined by examining the Status field of the I/O status block.
08147 
08148 --*/
08149 
08150 {
08151     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
08152     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
08153     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
08154     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
08155     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> eventObject = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08156     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
08157     ULONG method;
08158     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a> handleInformation;
08159     BOOLEAN synchronousIo;
08160     IO_STATUS_BLOCK localIoStatus;
08161     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> fastIoDispatch;
08162     <a class="code" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> poolType;
08163     PULONG majorFunction;
08164     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> requestorMode;
08165 
08166     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
08167 
08168     <span class="comment">//</span>
08169     <span class="comment">// Get the method that the buffers are being passed by.</span>
08170     <span class="comment">//</span>
08171 
08172     method = IoControlCode &amp; 3;
08173 
08174     <span class="comment">//</span>
08175     <span class="comment">// Check the caller's parameters based on the mode of the caller.</span>
08176     <span class="comment">//</span>
08177 
08178     requestorMode = KeGetPreviousMode();
08179 
08180     <span class="keywordflow">if</span> (requestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
08181 
08182         <span class="comment">//</span>
08183         <span class="comment">// The caller's access mode is not kernel so probe each of the arguments</span>
08184         <span class="comment">// and capture them as necessary.  If any failures occur, the condition</span>
08185         <span class="comment">// handler will be invoked to handle them.  It will simply cleanup and</span>
08186         <span class="comment">// return an access violation status code back to the system service</span>
08187         <span class="comment">// dispatcher.</span>
08188         <span class="comment">//</span>
08189 
08190         <span class="keywordflow">try</span> {
08191 
08192             <span class="comment">//</span>
08193             <span class="comment">// The IoStatusBlock parameter must be writeable by the caller.</span>
08194             <span class="comment">//</span>
08195 
08196             <a class="code" href="../../d5/d8/ex_8h.html#a32">ProbeForWriteIoStatusEx</a>( IoStatusBlock , ApcRoutine);
08197 
08198             <span class="comment">//</span>
08199             <span class="comment">// The output buffer can be used in any one of the following three ways,</span>
08200             <span class="comment">// if it is specified:</span>
08201             <span class="comment">//</span>
08202             <span class="comment">//     0) It can be a normal, buffered output buffer.</span>
08203             <span class="comment">//</span>
08204             <span class="comment">//     1) It can be a DMA input buffer.</span>
08205             <span class="comment">//</span>
08206             <span class="comment">//     2) It can be a DMA output buffer.</span>
08207             <span class="comment">//</span>
08208             <span class="comment">// Which way the buffer is to be used it based on the low-order two bits</span>
08209             <span class="comment">// of the IoControlCode.</span>
08210             <span class="comment">//</span>
08211             <span class="comment">// If the method is 0 we probe the output buffer for write access.</span>
08212             <span class="comment">// If the method is not 3 we probe the input buffer for read access.</span>
08213             <span class="comment">//</span>
08214 
08215             <span class="keywordflow">if</span> (method == 0) {
08216                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT( OutputBuffer )) {
08217                     <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( OutputBuffer,
08218                                    OutputBufferLength,
08219                                    <span class="keyword">sizeof</span>( UCHAR ) );
08220                 } <span class="keywordflow">else</span> {
08221                     OutputBufferLength = 0;
08222                 }
08223             }
08224 
08225             <span class="keywordflow">if</span> (method != 3) {
08226                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT( InputBuffer )) {
08227                     <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( InputBuffer,
08228                                   InputBufferLength,
08229                                   <span class="keyword">sizeof</span>( UCHAR ) );
08230                 } <span class="keywordflow">else</span> {
08231                     InputBufferLength = 0;
08232                 }
08233             }
08234 
08235         } except(EXCEPTION_EXECUTE_HANDLER) {
08236 
08237             <span class="comment">//</span>
08238             <span class="comment">// An exception was incurred while attempting to probe or write</span>
08239             <span class="comment">// one of the caller's parameters.  Simply return an appropriate</span>
08240             <span class="comment">// error status code.</span>
08241             <span class="comment">//</span>
08242 
08243             <span class="keywordflow">return</span> GetExceptionCode();
08244 
08245         }
08246     }
08247 
08248     <span class="comment">//</span>
08249     <span class="comment">// There were no blatant errors so far, so reference the file object so</span>
08250     <span class="comment">// the target device object can be found.  Note that if the handle does</span>
08251     <span class="comment">// not refer to a file object, or if the caller does not have the required</span>
08252     <span class="comment">// access to the file, then it will fail.</span>
08253     <span class="comment">//</span>
08254 
08255     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( FileHandle,
08256                                         0L,
08257                                         IoFileObjectType,
08258                                         requestorMode,
08259                                         (PVOID *) &amp;fileObject,
08260                                         &amp;handleInformation );
08261     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
08262         <span class="keywordflow">return</span> status;
08263     }
08264 
08265     <span class="comment">//</span>
08266     <span class="comment">// If this file has an I/O completion port associated w/it, then ensure</span>
08267     <span class="comment">// that the caller did not supply an APC routine, as the two are mutually</span>
08268     <span class="comment">// exclusive methods for I/O completion notification.</span>
08269     <span class="comment">//</span>
08270 
08271     <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o26">CompletionContext</a> &amp;&amp; <a class="code" href="../../d0/d6/iop_8h.html#a19">IopApcRoutinePresent</a>( ApcRoutine )) {
08272         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
08273         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
08274     }
08275 
08276     <span class="comment">//</span>
08277     <span class="comment">// Now check the access type for this control code to ensure that the</span>
08278     <span class="comment">// caller has the appropriate access to this file object to perform the</span>
08279     <span class="comment">// operation.</span>
08280     <span class="comment">//</span>
08281 
08282     <span class="keywordflow">if</span> (requestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
08283 
08284         ULONG accessMode = (IoControlCode &gt;&gt; 14) &amp; 3;
08285 
08286         <span class="keywordflow">if</span> (accessMode != FILE_ANY_ACCESS) {
08287 
08288             <span class="comment">//</span>
08289             <span class="comment">// This I/O control requires that the caller have read, write,</span>
08290             <span class="comment">// or read/write access to the object.  If this is not the case,</span>
08291             <span class="comment">// then cleanup and return an appropriate error status code.</span>
08292             <span class="comment">//</span>
08293 
08294             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/se_8h.html#a9">SeComputeGrantedAccesses</a>( handleInformation.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o1">GrantedAccess</a>, accessMode ) != accessMode ) {
08295                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
08296                 <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
08297             }
08298         }
08299     }
08300 
08301     <span class="comment">//</span>
08302     <span class="comment">// Get the address of the event object and set the event to the Not-</span>
08303     <span class="comment">// Signaled state, if an event was specified.  Note here, too, that if</span>
08304     <span class="comment">// the handle does not refer to an event, or if the event cannot be</span>
08305     <span class="comment">// written, then the reference will fail.</span>
08306     <span class="comment">//</span>
08307 
08308     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Event )) {
08309         status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( Event,
08310                                             EVENT_MODIFY_STATE,
08311                                             ExEventObjectType,
08312                                             requestorMode,
08313                                             (PVOID *) &amp;eventObject,
08314                                             NULL );
08315         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
08316             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
08317             <span class="keywordflow">return</span> status;
08318         } <span class="keywordflow">else</span> {
08319             <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( eventObject );
08320         }
08321     }
08322 
08323     <span class="comment">//</span>
08324     <span class="comment">// Make a special check here to determine whether this is a synchronous</span>
08325     <span class="comment">// I/O operation.  If it is, then wait here until the file is owned by</span>
08326     <span class="comment">// the current thread.</span>
08327     <span class="comment">//</span>
08328 
08329     <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
08330         BOOLEAN interrupted;
08331 
08332         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a13">IopAcquireFastLock</a>( fileObject )) {
08333             status = <a class="code" href="../../d0/d6/iop_8h.html#a147">IopAcquireFileObjectLock</a>( fileObject,
08334                                                requestorMode,
08335                                                (BOOLEAN) ((fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; FO_ALERTABLE_IO) != 0),
08336                                                &amp;interrupted );
08337             <span class="keywordflow">if</span> (interrupted) {
08338                 <span class="keywordflow">if</span> (eventObject) {
08339                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( eventObject );
08340                 }
08341                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
08342                 <span class="keywordflow">return</span> status;
08343             }
08344         }
08345         synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
08346     } <span class="keywordflow">else</span> {
08347         synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08348     }
08349 
08350     <span class="comment">//</span>
08351     <span class="comment">// Get the address of the target device object.  If this file represents</span>
08352     <span class="comment">// a device that was opened directly, then simply use the device or its</span>
08353     <span class="comment">// attached device(s) directly.</span>
08354     <span class="comment">//</span>
08355 
08356     <span class="keywordflow">if</span> (!(fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a161">FO_DIRECT_DEVICE_OPEN</a>)) {
08357         deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( fileObject );
08358     } <span class="keywordflow">else</span> {
08359         deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a66">IoGetAttachedDevice</a>( fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a> );
08360     }
08361 
08362     <span class="keywordflow">if</span> (DeviceIoControl) {
08363 
08364         <span class="comment">//</span>
08365         <span class="comment">// Also get the address of the Fast I/O dispatch structure.</span>
08366         <span class="comment">//</span>
08367 
08368         fastIoDispatch = deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
08369 
08370         <span class="comment">//</span>
08371         <span class="comment">// Turbo device control support.  If the device has a fast I/O entry</span>
08372         <span class="comment">// point for DeviceIoControlFile, call the entry point and give it a</span>
08373         <span class="comment">// chance to try to complete the request.  Note if FastIoDeviceControl</span>
08374         <span class="comment">// returns FALSE or we get an I/O error, we simply fall through and</span>
08375         <span class="comment">// go the "long way" and create an Irp.</span>
08376         <span class="comment">//</span>
08377 
08378         <span class="keywordflow">if</span> (fastIoDispatch &amp;&amp; fastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o10">FastIoDeviceControl</a>) {
08379 
08380             <span class="comment">//</span>
08381             <span class="comment">// Before we actually call the fast I/O routine in the driver,</span>
08382             <span class="comment">// we must probe OutputBuffer if the method is 1 or 2.</span>
08383             <span class="comment">//</span>
08384 
08385             <span class="keywordflow">if</span> (requestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> &amp;&amp; ARGUMENT_PRESENT(OutputBuffer)) {
08386 
08387                 <span class="keywordflow">try</span> {
08388 
08389                     <span class="keywordflow">if</span> (method == 1) {
08390                         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( OutputBuffer,
08391                                       OutputBufferLength,
08392                                       <span class="keyword">sizeof</span>( UCHAR ) );
08393                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (method == 2) {
08394                         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( OutputBuffer,
08395                                        OutputBufferLength,
08396                                        <span class="keyword">sizeof</span>( UCHAR ) );
08397                     }
08398 
08399                 } except(EXCEPTION_EXECUTE_HANDLER) {
08400 
08401                     <span class="comment">//</span>
08402                     <span class="comment">// An exception was incurred while attempting to probe</span>
08403                     <span class="comment">// the output buffer.  Clean up and return an</span>
08404                     <span class="comment">// appropriate error status code.</span>
08405                     <span class="comment">//</span>
08406 
08407                     <span class="keywordflow">if</span> (synchronousIo) {
08408                         <a class="code" href="../../d0/d6/iop_8h.html#a22">IopReleaseFileObjectLock</a>( fileObject );
08409                     }
08410 
08411                     <span class="keywordflow">if</span> (eventObject) {
08412                         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( eventObject );
08413                     }
08414 
08415                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
08416 
08417                     <span class="keywordflow">return</span> GetExceptionCode();
08418                 }
08419             }
08420 
08421             <span class="comment">//</span>
08422             <span class="comment">// Call the driver's fast I/O routine.</span>
08423             <span class="comment">//</span>
08424 
08425             <span class="keywordflow">if</span> (fastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o10">FastIoDeviceControl</a>( fileObject,
08426                                                      TRUE,
08427                                                      InputBuffer,
08428                                                      InputBufferLength,
08429                                                      OutputBuffer,
08430                                                      OutputBufferLength,
08431                                                      IoControlCode,
08432                                                      &amp;localIoStatus,
08433                                                      deviceObject )) {
08434 
08435                 <span class="comment">//</span>
08436                 <span class="comment">// The driver successfully performed the I/O in it's</span>
08437                 <span class="comment">// fast device control routine.  Carefully return the</span>
08438                 <span class="comment">// I/O status.</span>
08439                 <span class="comment">//</span>
08440 
08441                 <span class="keywordflow">try</span> {
08442                     *IoStatusBlock = localIoStatus;
08443                 } except( EXCEPTION_EXECUTE_HANDLER ) {
08444                     localIoStatus.Status = GetExceptionCode();
08445                     localIoStatus.Information = 0;
08446                 }
08447 
08448                 <span class="comment">//</span>
08449                 <span class="comment">// If an event was specified, set it.</span>
08450                 <span class="comment">//</span>
08451 
08452                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Event )) {
08453                     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( eventObject, 0, FALSE );
08454                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( eventObject );
08455                 }
08456 
08457                 <span class="comment">//</span>
08458                 <span class="comment">// Note that the file object event need not be set to the</span>
08459                 <span class="comment">// Signaled state, as it is already set.  Release the</span>
08460                 <span class="comment">// file object lock, if necessary.</span>
08461                 <span class="comment">//</span>
08462 
08463                 <span class="keywordflow">if</span> (synchronousIo) {
08464                     <a class="code" href="../../d0/d6/iop_8h.html#a22">IopReleaseFileObjectLock</a>( fileObject );
08465                 }
08466 
08467                 <span class="comment">//</span>
08468                 <span class="comment">// If this file object has a completion port associated with it</span>
08469                 <span class="comment">// and this request has a non-NULL APC context then a completion</span>
08470                 <span class="comment">// message needs to be queued.</span>
08471                 <span class="comment">//</span>
08472 
08473                 <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o26">CompletionContext</a> &amp;&amp; ARGUMENT_PRESENT( ApcContext )) {
08474                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d5/d4/complete_8c.html#a6">IoSetIoCompletion</a>( fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o26">CompletionContext</a>-&gt;<a class="code" href="../../d2/d4/struct__IO__COMPLETION__CONTEXT.html#o0">Port</a>,
08475                                                        fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o26">CompletionContext</a>-&gt;<a class="code" href="../../d2/d4/struct__IO__COMPLETION__CONTEXT.html#o1">Key</a>,
08476                                                        ApcContext,
08477                                                        localIoStatus.Status,
08478                                                        localIoStatus.Information,
08479                                                        TRUE ))) {
08480                         localIoStatus.Status = STATUS_INSUFFICIENT_RESOURCES;
08481                     }
08482                 }
08483 
08484                 <span class="comment">//</span>
08485                 <span class="comment">// Cleanup and return.</span>
08486                 <span class="comment">//</span>
08487 
08488                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
08489                 <span class="keywordflow">return</span> localIoStatus.Status;
08490             }
08491         }
08492 
08493     }
08494 
08495     <span class="comment">//</span>
08496     <span class="comment">// Set the file object to the Not-Signaled state.</span>
08497     <span class="comment">//</span>
08498 
08499     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a> );
08500 
08501     <span class="comment">//</span>
08502     <span class="comment">// Allocate and initialize the I/O Request Packet (IRP) for this operation.</span>
08503 
08504     irp = <a class="code" href="../../d0/d6/iop_8h.html#a16">IopAllocateIrp</a>( deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>, TRUE );
08505 
08506     <span class="keywordflow">if</span> (!irp) {
08507 
08508         <span class="comment">//</span>
08509         <span class="comment">// An IRP could not be allocated.  Cleanup and return an appropriate</span>
08510         <span class="comment">// error status code.</span>
08511         <span class="comment">//</span>
08512 
08513         <a class="code" href="../../d0/d6/iop_8h.html#a148">IopAllocateIrpCleanup</a>( fileObject, eventObject );
08514 
08515         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
08516     }
08517     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = fileObject;
08518     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
08519     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.AuxiliaryBuffer = (PVOID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08520     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = requestorMode;
08521     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o11">PendingReturned</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08522     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08523     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o25">CancelRoutine</a> = (<a class="code" href="../../d0/d5/io_8h.html#a286">PDRIVER_CANCEL</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08524 
08525     <span class="comment">//</span>
08526     <span class="comment">// Fill in the service independent parameters in the IRP.</span>
08527     <span class="comment">//</span>
08528 
08529     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = eventObject;
08530     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = IoStatusBlock;
08531     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine = ApcRoutine;
08532     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcContext = ApcContext;
08533 
08534     <span class="comment">//</span>
08535     <span class="comment">// Get a pointer to the stack location for the first driver.  This will be</span>
08536     <span class="comment">// used to pass the original function codes and parameters.  Note that</span>
08537     <span class="comment">// setting the major function here also sets:</span>
08538     <span class="comment">//</span>
08539     <span class="comment">//      MinorFunction = 0;</span>
08540     <span class="comment">//      Flags = 0;</span>
08541     <span class="comment">//      Control = 0;</span>
08542     <span class="comment">//</span>
08543 
08544     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
08545     majorFunction = (PULONG) (&amp;irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a>);
08546     *majorFunction = DeviceIoControl ? <a class="code" href="../../d0/d5/io_8h.html#a27">IRP_MJ_DEVICE_CONTROL</a> : <a class="code" href="../../d0/d5/io_8h.html#a26">IRP_MJ_FILE_SYSTEM_CONTROL</a>;
08547     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = fileObject;
08548 
08549     <span class="comment">//</span>
08550     <span class="comment">// Copy the caller's parameters to the service-specific portion of the</span>
08551     <span class="comment">// IRP for those parameters that are the same for all three methods.</span>
08552     <span class="comment">//</span>
08553 
08554     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceIoControl.OutputBufferLength = OutputBufferLength;
08555     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceIoControl.InputBufferLength = InputBufferLength;
08556     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceIoControl.IoControlCode = IoControlCode;
08557 
08558     <span class="comment">//</span>
08559     <span class="comment">// Set the pool type based on the type of function being performed.</span>
08560     <span class="comment">//</span>
08561 
08562     poolType = DeviceIoControl ? <a class="code" href="../../d5/d8/ex_8h.html#a329a177">NonPagedPoolCacheAligned</a> : <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>;
08563 
08564     <span class="comment">//</span>
08565     <span class="comment">// Based on the method that the buffer are being passed, either allocate</span>
08566     <span class="comment">// buffers or build MDLs.  Note that in some cases no probing has taken</span>
08567     <span class="comment">// place so the exception handler must catch access violations.</span>
08568     <span class="comment">//</span>
08569 
08570     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08571     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = (PVOID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08572 
08573     <span class="keywordflow">switch</span> ( method ) {
08574 
08575     <span class="keywordflow">case</span> 0:
08576 
08577         <span class="comment">//</span>
08578         <span class="comment">// For this case, allocate a buffer that is large enough to contain</span>
08579         <span class="comment">// both the input and the output buffers.  Copy the input buffer to</span>
08580         <span class="comment">// the allocated buffer and set the appropriate IRP fields.</span>
08581         <span class="comment">//</span>
08582 
08583         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceIoControl.Type3InputBuffer = (PVOID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08584 
08585         <span class="keywordflow">try</span> {
08586 
08587             <span class="keywordflow">if</span> (InputBufferLength || OutputBufferLength) {
08588                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer =
08589                     <a class="code" href="../../d5/d5/cc_8h.html#a11">ExAllocatePoolWithQuota</a>( poolType,
08590                                              (InputBufferLength &gt; OutputBufferLength) ? InputBufferLength : OutputBufferLength );
08591 
08592                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT( InputBuffer )) {
08593                     RtlCopyMemory( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer,
08594                                    InputBuffer,
08595                                    InputBufferLength );
08596                 }
08597                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a178">IRP_BUFFERED_IO</a> | <a class="code" href="../../d0/d5/io_8h.html#a179">IRP_DEALLOCATE_BUFFER</a>;
08598                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o26">UserBuffer</a> = OutputBuffer;
08599                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT( OutputBuffer )) {
08600                     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a180">IRP_INPUT_OPERATION</a>;
08601                 }
08602             } <span class="keywordflow">else</span> {
08603                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = 0;
08604                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o26">UserBuffer</a> = (PVOID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08605             }
08606 
08607         } except(EXCEPTION_EXECUTE_HANDLER) {
08608 
08609             <span class="comment">//</span>
08610             <span class="comment">// An exception was incurred while either allocating the</span>
08611             <span class="comment">// the system buffer or moving the caller's data.  Determine</span>
08612             <span class="comment">// what actually happened, cleanup accordingly, and return</span>
08613             <span class="comment">// an appropriate error status code.</span>
08614             <span class="comment">//</span>
08615 
08616             <a class="code" href="../../d0/d6/iop_8h.html#a170">IopExceptionCleanup</a>( fileObject,
08617                                  irp,
08618                                  eventObject,
08619                                  (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL );
08620 
08621             <span class="keywordflow">return</span> GetExceptionCode();
08622         }
08623 
08624         <span class="keywordflow">break</span>;
08625 
08626     <span class="keywordflow">case</span> 1:
08627     <span class="keywordflow">case</span> 2:
08628 
08629         <span class="comment">//</span>
08630         <span class="comment">// For these two cases, allocate a buffer that is large enough to</span>
08631         <span class="comment">// contain the input buffer, if any, and copy the information to</span>
08632         <span class="comment">// the allocated buffer.  Then build an MDL for either read or write</span>
08633         <span class="comment">// access, depending on the method, for the output buffer.  Note</span>
08634         <span class="comment">// that the buffer length parameters have been jammed to zero for</span>
08635         <span class="comment">// users if the buffer parameter was not passed.  (Kernel callers</span>
08636         <span class="comment">// should be calling the service correctly in the first place.)</span>
08637         <span class="comment">//</span>
08638         <span class="comment">// Note also that it doesn't make a whole lot of sense to specify</span>
08639         <span class="comment">// either method #1 or #2 if the IOCTL does not require the caller</span>
08640         <span class="comment">// to specify an output buffer.</span>
08641         <span class="comment">//</span>
08642 
08643         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = 0;
08644         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceIoControl.Type3InputBuffer = (PVOID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08645 
08646         <span class="keywordflow">try</span> {
08647 
08648             <span class="keywordflow">if</span> (InputBufferLength &amp;&amp; ARGUMENT_PRESENT( InputBuffer )) {
08649                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer =
08650                     <a class="code" href="../../d5/d5/cc_8h.html#a11">ExAllocatePoolWithQuota</a>( poolType,
08651                                              InputBufferLength );
08652                 RtlCopyMemory( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer,
08653                                InputBuffer,
08654                                InputBufferLength );
08655                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a178">IRP_BUFFERED_IO</a> | <a class="code" href="../../d0/d5/io_8h.html#a179">IRP_DEALLOCATE_BUFFER</a>;
08656             }
08657 
08658             <span class="keywordflow">if</span> (OutputBufferLength != 0) {
08659                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a19">IoAllocateMdl</a>( OutputBuffer,
08660                                                  OutputBufferLength,
08661                                                  FALSE,
08662                                                  TRUE,
08663                                                  irp  );
08664                 <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08665                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
08666                 }
08667                 <a class="code" href="../../d5/d6/iosup_8c.html#a41">MmProbeAndLockPages</a>( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a>,
08668                                      requestorMode,
08669                                      (LOCK_OPERATION) ((method == 1) ? IoReadAccess : IoWriteAccess) );
08670             }
08671 
08672         } except(EXCEPTION_EXECUTE_HANDLER) {
08673 
08674             <span class="comment">//</span>
08675             <span class="comment">// An exception was incurred while either allocating the</span>
08676             <span class="comment">// system buffer, copying the caller's data, allocating the</span>
08677             <span class="comment">// MDL, or probing and locking the caller's buffer. Determine</span>
08678             <span class="comment">// what actually happened, cleanup accordingly, and return</span>
08679             <span class="comment">// an appropriate error status code.</span>
08680             <span class="comment">//</span>
08681 
08682             <a class="code" href="../../d0/d6/iop_8h.html#a170">IopExceptionCleanup</a>( fileObject,
08683                                  irp,
08684                                  eventObject,
08685                                  (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL );
08686 
08687             <span class="keywordflow">return</span> GetExceptionCode();
08688         }
08689 
08690         <span class="keywordflow">break</span>;
08691 
08692     <span class="keywordflow">case</span> 3:
08693 
08694         <span class="comment">//</span>
08695         <span class="comment">// For this case, do nothing.  Everything is up to the driver.</span>
08696         <span class="comment">// Simply give the driver a copy of the caller's parameters and</span>
08697         <span class="comment">// let the driver do everything itself.</span>
08698         <span class="comment">//</span>
08699 
08700         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = 0;
08701         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o26">UserBuffer</a> = OutputBuffer;
08702         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceIoControl.Type3InputBuffer = InputBuffer;
08703     }
08704 
08705     <span class="comment">//</span>
08706     <span class="comment">// Defer I/O completion for FSCTL requests, but not for IOCTL requests,</span>
08707     <span class="comment">// since file systems set pending properly but device driver do not.</span>
08708     <span class="comment">//</span>
08709 
08710     <span class="keywordflow">if</span> (!DeviceIoControl) {
08711         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a186">IRP_DEFER_IO_COMPLETION</a>;
08712     }
08713 
08714     <span class="comment">//</span>
08715     <span class="comment">// Queue the packet, call the driver, and synchronize appropriately with</span>
08716     <span class="comment">// I/O completion.</span>
08717     <span class="comment">//</span>
08718 
08719     <span class="keywordflow">return</span> <a class="code" href="../../d0/d6/iop_8h.html#a212">IopSynchronousServiceTail</a>( deviceObject,
08720                                       irp,
08721                                       fileObject,
08722                                       (BOOLEAN)!DeviceIoControl,
08723                                       requestorMode,
08724                                       synchronousIo,
08725                                       OtherTransfer );
08726 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a144" doxytag="iop.h::NTSTATUS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef NTSTATUS           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">FASTCALL *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PIO_CALL_DRIVER</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d7/menuddc_8c-source.html#l00362">__ClientLoadOLE()</a>, <a class="el" href="../../d6/d5/chartran_8c-source.html#l00016">__declspec()</a>, <a class="el" href="../../d9/d7/winsta_8c-source.html#l01264">_BuildNameList()</a>, <a class="el" href="../../d5/d7/kernel_2winprop_8c-source.html#l00141">_BuildPropList()</a>, <a class="el" href="../../d3/d9/server_2exitwin_8c-source.html#l01601">_EndTask()</a>, <a class="el" href="../../d3/d9/server_2exitwin_8c-source.html#l00050">_ExitWindowsEx()</a>, <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00626">_GetUserObjectInformation()</a>, <a class="el" href="../../d6/d3/kernel_2ddetrack_8c-source.html#l02256">_ImpersonateDdeClientWindow()</a>, <a class="el" href="../../d9/d7/winsta_8c-source.html#l01019">_OpenWindowStation()</a>, <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00764">_SetUserObjectInformation()</a>, <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00295">_UserTestForWinStaAccess()</a>, <a class="el" href="../../d6/d9/exports_8c-source.html#l00045">_UserTestTokenForInteractive()</a>, <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00555">AccessCheckObject()</a>, <a class="el" href="../../d4/d4/ssend_8c-source.html#l00695">AllocateCallbackData()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00789">AllocateConsole()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00269">AllocateConsoleHandle()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01390">AllocateIoHandle()</a>, <a class="el" href="../../d4/d4/ssend_8c-source.html#l00545">AllocCallbackMessage()</a>, <a class="el" href="../../d9/d8/dllinit_8c-source.html#l00656">AllocConsoleInternal()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01627">ApiPreamble()</a>, <a class="el" href="../../d9/d7/arbiter_8c-source.html#l02189">ArbAddAllocation()</a>, <a class="el" href="../../d9/d7/arbiter_8c-source.html#l02325">ArbAllocateEntry()</a>, <a class="el" href="../../d9/d7/arbiter_8c-source.html#l01414">ArbArbiterHandler()</a>, <a class="el" href="../../d9/d7/arbiter_8c-source.html#l02238">ArbBacktrackAllocation()</a>, <a class="el" href="../../d9/d7/arbiter_8c-source.html#l01252">ArbBootAllocation()</a>, <a class="el" href="../../d9/d7/arbiter_8c-source.html#l01622">ArbBuildAssignmentOrdering()</a>, <a class="el" href="../../d9/d7/arbiter_8c-source.html#l02065">ArbFindSuitableRange()</a>, <a class="el" href="../../d9/d7/arbiter_8c-source.html#l00192">ArbInitializeArbiterInstance()</a>, <a class="el" href="../../d9/d7/arbiter_8c-source.html#l00786">ArbpBuildAllocationStack()</a>, <a class="el" href="../../d9/d7/arbiter_8c-source.html#l00689">ArbpBuildAlternative()</a>, <a class="el" href="../../d9/d7/arbiter_8c-source.html#l02824">ArbpGetRegistryValue()</a>, <a class="el" href="../../d9/d7/arbiter_8c-source.html#l03120">ArbPruneOrdering()</a>, <a class="el" href="../../d9/d7/arbiter_8c-source.html#l03695">ArbQueryConflict()</a>, <a class="el" href="../../d9/d7/arbiter_8c-source.html#l01105">ArbRetestAllocation()</a>, <a class="el" href="../../d9/d7/arbiter_8c-source.html#l00506">ArbTestAllocation()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00882">bCheckAndDeleteTTF()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00996">bCleanConvertedTTFs()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00818">bLoadableFontDrivers()</a>, <a class="el" href="../../d6/d3/icadis_8c-source.html#l00112">BrokenConnection()</a>, <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l01259">BuildHimcList()</a>, <a class="el" href="../../d1/d7/clenum_8c-source.html#l00037">BuildHwndList()</a>, <a class="el" href="../../d1/d7/dir_8c-source.html#l00057">BuildQueryDirectoryIrp()</a>, <a class="el" href="../../d4/d9/csrstubs_8c-source.html#l00228">CallUserpRegisterLogonProcess()</a>, <a class="el" href="../../d4/d4/ssend_8c-source.html#l00736">CaptureAnsiCallbackData()</a>, <a class="el" href="../../d4/d4/ssend_8c-source.html#l00639">CaptureCallbackData()</a>, <a class="el" href="../../d4/d4/ssend_8c-source.html#l00839">CaptureUnicodeCallbackData()</a>, <a class="el" href="../../d6/d6/copysup_8c-source.html#l00031">CcCopyRead()</a>, <a class="el" href="../../d6/d6/copysup_8c-source.html#l01747">CcCopyReadExceptionFilter()</a>, <a class="el" href="../../d6/d6/copysup_8c-source.html#l01075">CcCopyWrite()</a>, <a class="el" href="../../d6/d6/copysup_8c-source.html#l00588">CcFastCopyRead()</a>, <a class="el" href="../../d6/d6/copysup_8c-source.html#l01482">CcFastCopyWrite()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l04411">CcFlushCache()</a>, <a class="el" href="../../d9/d4/logsup_8c-source.html#l00142">CcGetDirtyPages()</a>, <a class="el" href="../../d6/d2/vacbsup_8c-source.html#l00401">CcGetVacbMiss()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00387">CcInitializeCacheMap()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l06458">CcLogError()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l06024">CcMapAndCopy()</a>, <a class="el" href="../../d8/d4/mdlsup_8c-source.html#l00838">CcMdlWriteComplete2()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l01821">CcSetFileSizes()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l02717">CcSetValidData()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l03880">CcWriteBehind()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l02952">CcZeroData()</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00040">CdfsRecFsControl()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l01771">ChangeMemberState()</a>, <a class="el" href="../../d6/d6/strings_8c-source.html#l00046">CharLowerA()</a>, <a class="el" href="../../d6/d6/strings_8c-source.html#l00119">CharUpperA()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l00222">CheckAllowForeground()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00049">CheckClipboardAccess()</a>, <a class="el" href="../../d2/d6/w32_2ntuser_2kernel_2profile_8c-source.html#l00426">CheckDesktopPolicy()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00129">CheckRestricted()</a>, <a class="el" href="../../d3/d7/api_8c-source.html#l01169">CleanupSessionObjectDirectories()</a>, <a class="el" href="../../d8/d6/uclient_8c-source.html#l00033">ClientThread()</a>, <a class="el" href="../../d7/d7/clinit_8c-source.html#l01219">ClientThreadSetup()</a>, <a class="el" href="../../d6/d9/immhotky_8c-source.html#l00260">CliGetImeHotKeysFromRegistry()</a>, <a class="el" href="../../d6/d9/immhotky_8c-source.html#l00324">CliReadRegistryValue()</a>, <a class="el" href="../../d6/d9/immhotky_8c-source.html#l00353">CliSetSingleHotKey()</a>, <a class="el" href="../../d6/d8/w32_2ntuser_2kernel_2pnp_8c-source.html#l00885">CloseDevice()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02929">CloseOutputHandle()</a>, <a class="el" href="../../d0/d9/cmapi2_8c-source.html#l00031">CmDeleteKey()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l02394">CmDeleteKeyRecursive()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00092">CmDeleteValueKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00285">CmEnumerateKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00416">CmEnumerateValueKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00564">CmFlushKey()</a>, <a class="el" href="../../d6/d9/cmcontrl_8c-source.html#l00050">CmGetSystemControlValues()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02169">CmGetSystemDriverList()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01901">CmLoadKey()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00544">CmpAddAcpiAliasEntry()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02606">CmpAddAliasEntry()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02532">CmpAddDockingInfo()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00538">CmpAddDriverToList()</a>, <a class="el" href="../../d7/d0/cmhvlist_8c-source.html#l00042">CmpAddToHiveFileList()</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l01392">CmpAppendStringToMultiSz()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01853">CmpCacheLookup()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01032">CmpCheckNotifyAccess()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03262">CmpCloneControlSet()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01869">CmpCloneHwProfile()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00686">CmpCopyKeyPartial()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02786">CmpCreateControlSet()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00313">CmpCreateEvent()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l02529">CmpCreateHwProfileFriendlyName()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01252">CmpCreateLinkNode()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01074">CmpCreateObjectTypes()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l04155">CmpCreatePerfKeys()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l04234">CmpCreatePredefined()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01165">CmpCreateRegistryRoot()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01439">CmpCreateTemporaryHive()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00667">CmpDestroyHive()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00518">CmpDiskFullWarningWorker()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00033">CmpDoCreate()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00226">CmpDoCreateChild()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00227">CmpDoFileSetSize()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02195">CmpDoFlushAll()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00963">CmpDoOpen()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00772">CmpFileFlush()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00351">CmpFileRead()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00509">CmpFileSetSize()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00516">CmpFileWrite()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01282">CmpFilterAcpiDockingState()</a>, <a class="el" href="../../d0/d3/rules_8c-source.html#l02173">CmpFindACPITable()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01082">CmpFindControlSet()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01545">CmpFindMatchingDescriptorCell()</a>, <a class="el" href="../../d5/d2/cmtree_8c-source.html#l00033">CmpFindNameInList()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00108">CmpFindNLSData()</a>, <a class="el" href="../../d0/d3/rules_8c-source.html#l02430">CmpFindRSDTTable()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01693">CmpFindTagIndex()</a>, <a class="el" href="../../d5/d2/cmtree_8c-source.html#l00309">CmpFindValueByNameFromCache()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00076">CmpGetAcpiProfileInformation()</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00987">CmpGetAddRegInfData()</a>, <a class="el" href="../../d0/d3/rules_8c-source.html#l02635">CmpGetRegistryValue()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01476">CmpGetSymbolicLink()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01227">CmpHiveRootSecurityDescriptor()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02422">CmpInitHiveFromFile()</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00087">CmpInitializeHardwareConfiguration()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00726">CmpInitializeHiveList()</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00037">CmpInitializeMachineDependentConfiguration()</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00458">CmpInitializeRegistryNode()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02022">CmpInitializeSystemHive()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01845">CmpInterlockedFunction()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03863">CmpIsLastKnownGoodBoot()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00473">CmpIsLoadType()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01421">CmpLinkHiveToMaster()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03983">CmpLinkKeyToHive()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00484">CmpLoadHiveVolatile()</a>, <a class="el" href="../../d0/d3/rules_8c-source.html#l01854">CmpMapPhysicalAddress()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01150">CmpMergeKeyValues()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01513">CmpMoveBiosAliasTable()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03603">CmpNameFromAttributes()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00721">CmpOpenFileWithExtremePrejudice()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00046">CmpOpenHiveFiles()</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l01264">CmpOpenRegKey()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00311">CmpProcessAddRegLine()</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00776">CmpProcessBitRegLine()</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00658">CmpProcessDelRegLine()</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00258">CmpProcessReg()</a>, <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00110">CmpQueryKeyData()</a>, <a class="el" href="../../d6/d1/cmquery_8c-source.html#l00028">CmpQueryKeyName()</a>, <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00531">CmpQueryKeyValueData()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00847">CmpQuerySecurityDescriptorInfo()</a>, <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00166">CmpQuotaWarningWorker()</a>, <a class="el" href="../../d7/d0/cmhvlist_8c-source.html#l00188">CmpRemoveFromHiveFileList()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03458">CmpSaveBootControlSet()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01261">CmpSaveKeyByFileCopy()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00158">CmpSecurityMethod()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00397">CmpSetSecurityDescriptorInfo()</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00294">CmpSetupConfigurationTree()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01545">CmpSetVersionData()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00744">CmpSortDriverList()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01338">CmpSyncKeyValues()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l04077">CmpValidateAlternate()</a>, <a class="el" href="../../d6/d9/cmcontrl_8c-source.html#l00256">CmpWalkPath()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00647">CmQueryKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00940">CmQueryMultipleValueKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00804">CmQueryValueKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02293">CmReplaceKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00097">CmRestoreKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00862">CmSaveKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01047">CmSaveMergedKeys()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00805">CmSetAcpiHwProfile()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01841">CmSetLastWriteTimeKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01087">CmSetValueKey()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l03150">CommandNumberPopup()</a>, <a class="el" href="../../d5/d7/ex_8c-source.html#l00278">CommitReadOnlyMemory()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l02154">CommonCreateWindowStation()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l02336">CommonOpenWindowStation()</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l01955">ComPortDBAdd()</a>, <a class="el" href="../../d9/d8/dllinit_8c-source.html#l00470">ConDllInitialize()</a>, <a class="el" href="../../d9/d8/dllinit_8c-source.html#l00373">ConnectConsoleInternal()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01519">ConnectToEmulator()</a>, <a class="el" href="../../d6/d3/icadis_8c-source.html#l00042">ConnectToTerminalServer()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00737">ConServerDllInitialization()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00705">ConsoleAddProcessRoutine()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01091">ConsoleClientConnectRoutine()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01912">ConsoleClientShutdown()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l01946">ConsoleInputThread()</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l01345">ConvertInputToUnicode()</a>, <a class="el" href="../../d4/d9/w32_2ntcon_2fullscr_2vga_2misc_8c-source.html#l00031">ConvertOutputToOem()</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l01384">ConvertOutputToUnicode()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00603">ConvertToFullScreen()</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l01307">ConvertToOem()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00747">ConvertToWindowed()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l01237">CookedRead()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l01541">CookedReadWaitRoutine()</a>, <a class="el" href="../../d7/d2/rttrecpy_8c-source.html#l00114">Copy()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l03040">CopyFromCharPopup()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01596">CopyRestrictedFile()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01451">CopyStream()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l03096">CopyToCharPopup()</a>, <a class="el" href="../../d1/d6/server_2server_8c-source.html#l00705">CreateBSMEventSD()</a>, <a class="el" href="../../d6/d0/w32_2ntcon_2server_2bitmap_8c-source.html#l00027">CreateConsoleBitmap()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l03502">CreateCtrlThread()</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00299">CreateDAclToken()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l02455">CreateDesktopA()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l02696">CreateDesktopHeap()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01311">CreateDirectories()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l02210">CreateFtMember()</a>, <a class="el" href="../../d9/d7/winsta_8c-source.html#l00212">CreateGlobalAtomTable()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l00103">CreateInputBuffer()</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00230">CreateLocalMemHandle()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l00485">CreateScreenBuffer()</a>, <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00091">CreateSecurityDescriptor()</a>, <a class="el" href="../../d5/d7/ex_8c-source.html#l00131">CreateSystemThread()</a>, <a class="el" href="../../d6/d9/csrutil_8c-source.html#l00025">CsrClientCallServer()</a>, <a class="el" href="../../d2/d9/csrinit_8c-source.html#l00106">CsrClientConnectToServer()</a>, <a class="el" href="../../d5/d9/csrtask_8c-source.html#l00051">CsrIdentifyAlertableThread()</a>, <a class="el" href="../../d2/d9/csrinit_8c-source.html#l00076">CsrOneTimeInitialize()</a>, <a class="el" href="../../d2/d9/csrinit_8c-source.html#l00359">CsrpConnectToServer()</a>, <a class="el" href="../../d5/d9/csrtask_8c-source.html#l00073">CsrSetPriorityClass()</a>, <a class="el" href="../../d4/d0/ctxapi_8c-source.html#l00025">CtxUserGetWinstationInfo()</a>, <a class="el" href="../../d8/d2/dbgkproc_8c-source.html#l00211">DbgkCreateThread()</a>, <a class="el" href="../../d7/d2/dbgkport_8c-source.html#l00099">DbgkForwardException()</a>, <a class="el" href="../../d8/d2/dbgkproc_8c-source.html#l00136">DbgkpSectionHandleToFileHandle()</a>, <a class="el" href="../../d7/d2/dbgkport_8c-source.html#l00031">DbgkpSendApiMessage()</a>, <a class="el" href="../../d1/d4/rtl_2debug_8c-source.html#l00036">DbgPrint()</a>, <a class="el" href="../../d4/d9/dllssstb_8c-source.html#l00517">DbgSsHandleKmApiMsg()</a>, <a class="el" href="../../d4/d9/dllssstb_8c-source.html#l00429">DbgSsInitialize()</a>, <a class="el" href="../../d4/d9/dllssstb_8c-source.html#l00025">DbgSspConnectToDbg()</a>, <a class="el" href="../../d4/d9/dllssstb_8c-source.html#l00176">DbgSspCreateProcess()</a>, <a class="el" href="../../d4/d9/dllssstb_8c-source.html#l00126">DbgSspCreateThread()</a>, <a class="el" href="../../d4/d9/dllssstb_8c-source.html#l00077">DbgSspException()</a>, <a class="el" href="../../d4/d9/dllssstb_8c-source.html#l00281">DbgSspExitProcess()</a>, <a class="el" href="../../d4/d9/dllssstb_8c-source.html#l00233">DbgSspExitThread()</a>, <a class="el" href="../../d4/d9/dllssstb_8c-source.html#l00330">DbgSspLoadDll()</a>, <a class="el" href="../../d4/d9/dllssstb_8c-source.html#l00737">DbgSspSrvApiLoop()</a>, <a class="el" href="../../d4/d9/dllssstb_8c-source.html#l00379">DbgSspUnloadDll()</a>, <a class="el" href="../../d5/d9/dlluistb_8c-source.html#l00027">DbgUiConnectToDbg()</a>, <a class="el" href="../../d5/d9/dlluistb_8c-source.html#l00160">DbgUiContinue()</a>, <a class="el" href="../../d5/d9/dlluistb_8c-source.html#l00093">DbgUiWaitStateChange()</a>, <a class="el" href="../../d9/d4/debug3_8c-source.html#l00071">DebugService()</a>, <a class="el" href="../../d1/d0/rtdeltre_8c-source.html#l00103">Delete()</a>, <a class="el" href="../../d6/d8/w32_2ntuser_2kernel_2pnp_8c-source.html#l00248">DeviceCDROMNotify()</a>, <a class="el" href="../../d6/d8/w32_2ntuser_2kernel_2pnp_8c-source.html#l00310">DeviceClassCDROMNotify()</a>, <a class="el" href="../../d6/d8/w32_2ntuser_2kernel_2pnp_8c-source.html#l01025">DeviceNotify()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l00903">Directory()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l00267">DirectReadWaitRoutine()</a>, <a class="el" href="../../d3/d8/uipriv_8c-source.html#l00432">DisableAllPrivileges()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l01597">DiskDump()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01567">DisplayModeTransition()</a>, <a class="el" href="../../d2/d8/uipers_8c-source.html#l00345">DisplaySecurityContext()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l00270">DoCreateScreenBuffer()</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l00072">DoEventTest()</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l00312">DoExceptionTest()</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01260">DoInfoTest()</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01305">DoLuidTest()</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l00362">DoMutantTest()</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01445">DoPartyTest()</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l00591">DoSemaphoreTest()</a>, <a class="el" href="../../d3/d6/regtest_8c-source.html#l00045">DoTest()</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l00817">DoTimerTest()</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01510">DoZoneTest()</a>, <a class="el" href="../../d1/d3/dynres_8c-source.html#l00033">DrChangeDisplaySettings()</a>, <a class="el" href="../../d1/d3/dynres_8c-source.html#l00076">DrGetDeviceName()</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00067">DriverEntry()</a>, <a class="el" href="../../d1/d3/dynres_8c-source.html#l00097">DrSetDevMode()</a>, <a class="el" href="../../d3/d0/rtdmp_8c-source.html#l00126">Dump()</a>, <a class="el" href="../../d2/d0/hivedmp_8c-source.html#l00163">DumpKeys()</a>, <a class="el" href="../../d8/d8/uob_8c-source.html#l00039">DumpObjectDirs()</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00283">DumpSecurity()</a>, <a class="el" href="../../d2/d0/hivedmp_8c-source.html#l00238">DumpValues()</a>, <a class="el" href="../../d0/d4/edithive_8c-source.html#l00625">EhCreateChild()</a>, <a class="el" href="../../d0/d4/edithive_8c-source.html#l00156">EhOpenHive()</a>, <a class="el" href="../../d0/d4/edithive_8c-source.html#l00988">EhpAttachSecurity()</a>, <a class="el" href="../../d6/d9/pnpeisa_8c-source.html#l00059">EisaBuildEisaDeviceNode()</a>, <a class="el" href="../../d6/d9/pnpeisa_8c-source.html#l00201">EisaGetEisaDevicesResources()</a>, <a class="el" href="../../d3/d8/uipriv_8c-source.html#l00225">EnableAllPrivileges()</a>, <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00324">EndShutdown()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l07307">EnterHandleFlagsCrit()</a>, <a class="el" href="../../d1/d7/ntcftxt_8h-source.html#l01102">EnumDisplayDevices()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00278">ExAllocatePool()</a>, <a class="el" href="../../d1/d2/utxcpt2_8c-source.html#l00009">ExceptionTest()</a>, <a class="el" href="../../d3/d3/ex_2callback_8c-source.html#l00222">ExCreateCallback()</a>, <a class="el" href="../../d9/d0/zone_8c-source.html#l00212">ExInterlockedExtendZone()</a>, <a class="el" href="../../d4/d9/csrstubs_8c-source.html#l00084">ExitWindowsWorker()</a>, <a class="el" href="../../d4/d2/uuid_8c-source.html#l00378">ExpAllocateUuids()</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00971">ExpCreateWorkerThread()</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00853">ExpDetectWorkerThreadDeadlock()</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00067">ExpEventInitialization()</a>, <a class="el" href="../../d4/d7/eventpr_8c-source.html#l00070">ExpEventPairInitialization()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00666">ExpGetCurrentUserUILanguage()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l03939">ExpGetHandleInformation()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l03579">ExpGetLockInformation()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l03661">ExpGetLookasideInformation()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l04019">ExpGetObjectInformation()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l03846">ExpGetPoolInformation()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l04104">ExpGetPoolTagInfo()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l03060">ExpGetProcessInformation()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00486">ExpGetUILanguagePolicy()</a>, <a class="el" href="../../d3/d3/ex_2callback_8c-source.html#l00101">ExpInitializeCallbacks()</a>, <a class="el" href="../../d3/d4/mutant_8c-source.html#l00095">ExpMutantInitialization()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00079">ExpProfileInitialization()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l04328">ExpQueryLegacyDriverInformation()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l04185">ExpQueryModuleInformation()</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00085">ExpRaiseException()</a>, <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00349">ExpRaiseHardError()</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00196">ExpRaiseStatus()</a>, <a class="el" href="../../d3/d5/semphore_8c-source.html#l00064">ExpSemaphoreInitialization()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00585">ExpSetCurrentUserUILanguage()</a>, <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00064">ExpSystemErrorHandler()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00281">ExpTimerInitialization()</a>, <a class="el" href="../../d4/d2/uuid_8c-source.html#l00751">ExpUuidGetValues()</a>, <a class="el" href="../../d4/d2/uuid_8c-source.html#l00340">ExpUuidInitialization()</a>, <a class="el" href="../../d4/d2/uuid_8c-source.html#l00137">ExpUuidLoadSequenceNumber()</a>, <a class="el" href="../../d4/d2/uuid_8c-source.html#l00220">ExpUuidSaveSequenceNumber()</a>, <a class="el" href="../../d4/d2/uuid_8c-source.html#l00287">ExpUuidSaveSequenceNumberIf()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00769">ExpValidateLocale()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02506">ExpWaitForResource()</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00463">ExpWaitForResourceDdk()</a>, <a class="el" href="../../d4/d6/win32_8c-source.html#l00060">ExpWin32Initialization()</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00220">ExpWorkerInitialization()</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00431">ExpWorkerThreadBalanceManager()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02335">ExQuerySystemLockInformation()</a>, <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00700">ExRaiseHardError()</a>, <a class="el" href="../../d3/d3/ex_2callback_8c-source.html#l00378">ExRegisterCallback()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00984">ExSnapShotHandleTables()</a>, <a class="el" href="../../d4/d2/uuid_8c-source.html#l00841">ExUuidCreate()</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l01676">FalseUnicodeToRealUnicode()</a>, <a class="el" href="../../d6/d0/fat__rec_8c-source.html#l00043">FatRecFsControl()</a>, <a class="el" href="../../d0/d2/__priv_8h-source.html#l00041">FE_WriteRegionToScreenHW()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01423">FileExists()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l00053">FindActiveScreenBufferHandle()</a>, <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00454">FindPathForDevice()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l01990">FixDisk()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l00401">FlushAllButKeys()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l02535">FreeDesktop()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01455">FreeIoHandle()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l02949">FreeView()</a>, <a class="el" href="../../d3/d1/drawscrn_8c-source.html#l00489">FsgWriteToFrameBuffer()</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00233">FsRecCreate()</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00282">FsRecCreateAndRegisterDO()</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00446">FsRecFsControl()</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00703">FsRecGetDeviceSectors()</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00800">FsRecGetDeviceSectorSize()</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00579">FsRecLoadFileSystem()</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00907">FsRecReadBlock()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01678">FsRtlAcknowledgeOplockBreak()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l02402">FsRtlAcquireFileForCcFlush()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l02064">FsRtlAcquireFileForModWrite()</a>, <a class="el" href="../../d5/d4/name_8c-source.html#l00288">FsRtlAreNamesEqual()</a>, <a class="el" href="../../d8/d0/faulttol_8c-source.html#l00031">FsRtlBalanceReads()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00823">FsRtlCheckOplock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00507">FsRtlCompleteLockIrpReal()</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00418">FsRtlDeregisterUncProvider()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03241">FsRtlFastUnlockSingle()</a>, <a class="el" href="../../d5/d7/fsrtlpc_8c-source.html#l00323">FsRtlGetCompatibilityModeValue()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l02691">FsRtlGetFileSize()</a>, <a class="el" href="../../d2/d6/tunnel_8c-source.html#l01371">FsRtlGetTunnelParameterValue()</a>, <a class="el" href="../../d5/d4/name_8c-source.html#l00415">FsRtlIsNameInExpression()</a>, <a class="el" href="../../d4/d8/fsrtl_2pnp_8c-source.html#l00041">FsRtlNotifyVolumeEvent()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01937">FsRtlOpBatchBreakClosePending()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02111">FsRtlOplockBreakNotify()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02454">FsRtlOplockBreakToII()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02690">FsRtlOplockBreakToNone()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00581">FsRtlOplockFsctrl()</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00487">FsRtlpIsDfsEnabled()</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00183">FsRtlpOpenDev()</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00104">FsRtlpRegisterProviderWithMUP()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05721">FsRtlPrivateCancelFileLockIrp()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l04722">FsRtlPrivateCheckWaitingLocks()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05254">FsRtlPrivateFastUnlockAll()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03867">FsRtlPrivateLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03162">FsRtlPrivateRemoveLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01173">FsRtlProcessFileLock()</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00231">FsRtlpSetSymbolicLink()</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00247">FsRtlRegisterUncProvider()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l02483">FsRtlReleaseFileForCcFlush()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l02342">FsRtlReleaseFileForModWrite()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01299">FsRtlRequestExclusiveOplock()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01514">FsRtlRequestOplockII()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l02864">FsRtlSetFileSize()</a>, <a class="el" href="../../d8/d0/faulttol_8c-source.html#l00096">FsRtlSyncVolumes()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00995">FsRtlUninitializeFileLock()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03025">FsRtlWaitOnIrp()</a>, <a class="el" href="../../d2/d4/translate_8c-source.html#l00192">FstubTranslateResource()</a>, <a class="el" href="../../d7/d7/fsvga_8c-source.html#l00649">FsVgaConfiguration()</a>, <a class="el" href="../../d7/d7/fsvga_8c-source.html#l01213">FsVgaDeviceControl()</a>, <a class="el" href="../../d7/d7/fsvga_8c-source.html#l00722">FsVgaPeripheralCallout()</a>, <a class="el" href="../../d7/d7/fsvga_8c-source.html#l00858">FsVgaServiceParameters()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l00453">FtCreateKey()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l00411">FtDeleteKey()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l00557">FtDeleteValue()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l00357">FtOpenKey()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l01534">FtReturnValue()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l00602">FtSetValue()</a>, <a class="el" href="../../d5/d2/rtsetsec_8c-source.html#l00122">GenerateDescriptor()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l03729">GetActiveKeyboardName()</a>, <a class="el" href="../../d7/d7/clinit_8c-source.html#l00598">GetBadAppCmdLine()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l00263">GetChar()</a>, <a class="el" href="../../d3/d0/client_2cmdline_8c-source.html#l01256">GetConsoleInputExeNameA()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l02643">GetConsoleLangId()</a>, <a class="el" href="../../d6/d8/w32_2ntuser_2kernel_2pnp_8c-source.html#l00162">GetDeviceChangeInfo()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l02163">GetDiskInfo()</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00423">GetHardErrorText()</a>, <a class="el" href="../../d5/d2/rtsetsec_8c-source.html#l00273">GetMySid()</a>, <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00326">GetNextReparseVolumePath()</a>, <a class="el" href="../../d5/d7/ex_8c-source.html#l00050">GetProcessLuid()</a>, <a class="el" href="../../d6/d1/fekbdcom_8c-source.html#l00118">GetRealDllFileNameWorker()</a>, <a class="el" href="../../d1/d6/server_2server_8c-source.html#l01029">GetRegIntFromID()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l02210">GetRegistryValues()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l01983">GetServerIMEKeyboardLayout()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01844">GetSiteSidFromToken()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l05857">GetTaskName()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l03139">GetThreadConsoleDesktop()</a>, <a class="el" href="../../d1/d6/server_2server_8c-source.html#l01068">GetTimeouts()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l01837">GetUserObjectSecurity()</a>, <a class="el" href="../../d2/d2/dtbitmap_8c-source.html#l00067">GetVersionInfo()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l01022">HalpEnableAutomaticDriveLetterAssignment()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l03735">HalpGetFullGeometry()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l01171">HalpIsOldStyleFloppy()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l00934">HalpNextDriveLetter()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l00851">HalpNextMountLetter()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l00792">HalpQueryDriveLayout()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l00706">HalpQueryPartitionType()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l01078">HalpSetMountLetter()</a>, <a class="el" href="../../d1/d6/server_2server_8c-source.html#l00479">HandleMediaChangeEvent()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00704">HMGrowHandleTable()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00575">HMInitHandleTable()</a>, <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>, <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00100">HvLoadHive()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00536">HvpBuildMap()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00047">HvpBuildMapAndCopy()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00437">HvpEnlistBinInMap()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00304">HvpInitMap()</a>, <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00311">HvpReadFileImageAndBuildMap()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01433">HvWriteHive()</a>, <a class="el" href="../../d4/d0/layime_8c-source.html#l00038">ImmLoadLayout()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00561">InheritIoHandleTable()</a>, <a class="el" href="../../d0/d6/kernel_2server_8c-source.html#l01417">InitCreateObjectDirectory()</a>, <a class="el" href="../../d0/d6/kernel_2server_8c-source.html#l01229">InitCreateSharedSection()</a>, <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l02313">InitializeClientPfnArrays()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00057">InitializeConsoleHandleTable()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01335">InitializeInputHandle()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00400">InitializeIoHandleTable()</a>, <a class="el" href="../../d8/d1/power_8c-source.html#l00180">InitializePowerRequestList()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00879">InitializeRestrictedStuff()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l02631">InitializeScrollBuffer()</a>, <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00119">InitiateShutdown()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l02146">InitiateWin32kCleanup()</a>, <a class="el" href="../../d0/d6/kernel_2server_8c-source.html#l01654">InitMapSharedSection()</a>, <a class="el" href="../../d5/d7/ex_8c-source.html#l00191">InitSystemThread()</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00140">InitTask()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00626">InitWindowsStuff()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l01795">InputExceptionFilter()</a>, <a class="el" href="../../d3/d9/server_2exitwin_8c-source.html#l01865">InternalCreateCallbackThread()</a>, <a class="el" href="../../d1/d7/clenum_8c-source.html#l00398">InternalEnumObjects()</a>, <a class="el" href="../../d1/d7/clenum_8c-source.html#l00251">InternalEnumProps()</a>, <a class="el" href="../../d8/d6/io_2remlock_8c-source.html#l00114">IoAcquireRemoveLockEx()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00934">IoAsynchronousPageWrite()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01067">IoAttachDevice()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01193">IoAttachDeviceByPointer()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12535">IoCancelFileOpen()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02547">IoCheckFunctionAccess()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l03665">IoConnectInterrupt()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l03917">IoCreateController()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l04073">IoCreateDevice()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01071">IoCreateDriver()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l04502">IoCreateFile()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05299">IoCreateNotificationEvent()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05378">IoCreateStreamFileObject()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05535">IoCreateStreamFileObjectLite()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05675">IoCreateSymbolicLink()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05733">IoCreateSynchronizationEvent()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05813">IoCreateUnprotectedSymbolicLink()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06227">IoDeleteSymbolicLink()</a>, <a class="el" href="../../d8/d4/ioerr_8c-source.html#l01052">IoepCatMsgArg()</a>, <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00501">IoepExtractErrData()</a>, <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00612">IoepFireWMIEvent()</a>, <a class="el" href="../../d8/d4/ioerr_8c-source.html#l01200">IoepGetErrCaseDB()</a>, <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00936">IoepGetErrMessage()</a>, <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00680">IoepHandleErrCase()</a>, <a class="el" href="../../d8/d4/ioerr_8c-source.html#l01155">IoepUnicodeStringCatN()</a>, <a class="el" href="../../d5/d4/ioeapi_8c-source.html#l00882">IoErrFindErrCaseByID()</a>, <a class="el" href="../../d5/d4/ioeapi_8c-source.html#l00452">IoErrGetErrData()</a>, <a class="el" href="../../d5/d4/ioeapi_8c-source.html#l00985">IoErrGetLongErrMessage()</a>, <a class="el" href="../../d5/d4/ioeapi_8c-source.html#l01041">IoErrGetShortErrMessage()</a>, <a class="el" href="../../d5/d4/ioeapi_8c-source.html#l00939">IoErrHandleErrCase()</a>, <a class="el" href="../../d5/d4/ioeapi_8c-source.html#l00800">IoErrMatchErrCase()</a>, <a class="el" href="../../d5/d4/ioeapi_8c-source.html#l00383">IoErrRegisterErrHandlers()</a>, <a class="el" href="../../d5/d4/ioeapi_8c-source.html#l00698">IoErrRetrieveSavedData()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06463">IoFastQueryNetworkAttributes()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01300">IoFreeDumpStack()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11641">IoGetBootDiskInformation()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04946">IoGetDeviceInterfaceAlias()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l03419">IoGetDeviceInterfaces()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06998">IoGetDeviceObjectPointer()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00373">IoGetDeviceProperty()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08307">IoGetDmaAdapter()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09712">IoGetLegacyVetoList()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08120">IoGetRelatedTargetDevice()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01142">IoInitializeDumpStack()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07705">IoIsValidNameGraftingBuffer()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l03624">IoOpenDeviceInterfaceRegistryKey()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00810">IoOpenDeviceRegistryKey()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00181">IopAcquireFileObjectLock()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00117">IopAddDevicesToBootDriver()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00166">IopAddDevicesToBootDriverWorker()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l00314">IopAddRemoteBootValuesToRegistry()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08468">IoPageFileCreated()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07141">IopAllocateBootResources()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00542">IopAllocateErrorLogEntry()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00720">IopAllocateResources()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02575">IopAppendBuffer()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00546">IopAppendStringToValueKey()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02209">IopApplyFunctionToServiceInstances()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01844">IopApplyFunctionToSubKeys()</a>, <a class="el" href="../../d6/d8/arcsec_8c-source.html#l00168">IopApplySystemPartitionProt()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05016">IopArbitrateDeviceResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03084">IopAssign()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03292">IopAssignInner()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l01546">IopAssignNetworkDriveLetter()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01824">IopAssignResourcesToDevices()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00262">IopAsynchronousCall()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l09046">IopBootLog()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l09284">IopBootLogToFile()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02034">IopBuildCmResourceList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02320">IopBuildCmResourceLists()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l05137">IopBuildSymbolicLinkStrings()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00728">IopBusCheck()</a>, <a class="el" href="../../d9/d8/pnpbusno_8c-source.html#l00089">IopBusNumberInitialize()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l04247">IopCacheNetbiosNameForIpAddress()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04339">IopCallArbiter()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l02525">IopCallDriverAddDevice()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03165">IopCallDriverAddDeviceQueryRoutine()</a>, <a class="el" href="../../d5/d0/pnppower_8c-source.html#l00386">IopCaptureObjectName()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00084">IopChainDereferenceComplete()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04759">IopChangeDeviceObjectFromRegistryProperties()</a>, <a class="el" href="../../d5/d2/parse_8c-source.html#l00047">IopCheckDeviceAndDriver()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03933">IopChildToRootTranslation()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03960">IopCleanupDeviceRegistryValues()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00036">IopCloseFile()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06726">IopCombineLegacyResources()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04061">IopCompleteDumpInitialization()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01019">IopCompleteRequest()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01506">IopConnectLinkTrackingPort()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l09157">IopCopyBootLogRegistryToFile()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01047">IopCreateArcNames()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12098">IopCreateDefaultDeviceSecurityDescriptor()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00091">IopCreateMadeupNode()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01156">IopCreateRegistryKeyEx()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02155">IopCreateRootDirectories()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00417">IopDeleteFile()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05902">IopDeleteKeyRecursive()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05846">IopDeleteKeyRecursiveCallback()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05453">IopDeleteLegacyKey()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00232">IopDeleteLockedDeviceNode()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00557">IopDeleteLockedDeviceNodes()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06037">IopDeleteSessionSymLinks()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l01510">IopDetermineDefaultInterfaceType()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05675">IopDeviceCapabilitiesToRegistry()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l03708">IopDeviceInterfaceKeysFromSymbolicLink()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05633">IopDeviceNodeCapabilitiesToRegistry()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03759">IopDeviceObjectFromDeviceInstance()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03897">IopDeviceObjectToDeviceInstance()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03125">IopDisableDevice()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01623">IopDisassociateThreadIrp()</a>, <a class="el" href="../../d2/d4/ioassert_8c-source.html#l00463">IopDriverCorrectnessCheckUnderLock()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02779">IopDriverLoadingFailed()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l05353">IopDropReferenceString()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06528">IopDuplicateDetection()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00730">IopEjectDevice()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07775">IopEliminateBogusConflict()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01163">IopEnumerateDevice()</a>, <a class="el" href="../../d8/d6/errorlog_8c-source.html#l00566">IopErrorLogConnectPort()</a>, <a class="el" href="../../d8/d6/errorlog_8c-source.html#l00088">IopErrorLogThread()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l01028">IopExecuteHardwareProfileChange()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02063">IopfCallDriver()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l03255">IopFilterResourceRequirementsCall()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04592">IopFilterResourceRequirementsList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05911">IopFindLegacyDeviceNode()</a>, <a class="el" href="../../d5/d6/devnode_8c-source.html#l00179">IopForAllChildDeviceNodes()</a>, <a class="el" href="../../d5/d6/devnode_8c-source.html#l00127">IopForAllDeviceNodes()</a>, <a class="el" href="../../d5/d6/devnode_8c-source.html#l00237">IopForAllDeviceNodesCallback()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04252">IopFreeDCB()</a>, <a class="el" href="../../d4/d0/pnpmemio_8c-source.html#l00263">IopGenericTranslateOrdering()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01477">IopGetDeviceInstanceCsConfigFlags()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02707">IopGetDeviceInterfaces()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04081">IopGetDeviceResourcesFromRegistry()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01411">IopGetDriverDeviceList()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02072">IopGetDriverNameFromKeyNode()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04120">IopGetDriverTagPriority()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00384">IopGetDumpStack()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02256">IopGetFileName()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05334">IopGetGroupOrderIndex()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09565">IopGetLegacyVetoListDrivers()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04610">IopGetRegistryDwordWithFallback()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02462">IopGetRegistryKeyInformation()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04679">IopGetRegistrySecurityWithFallback()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02637">IopGetRegistryValues()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08036">IopGetRelatedTargetDevice()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01066">IopGetResourceRequirementsForAssignTable()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00680">IopGetRootDevices()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01591">IopGetServiceInstanceCsConfigFlags()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l01454">IopGetServiceType()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02718">IopGetSetObjectId()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00975">IopGetSetSecurityObject()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02851">IopGetVolumeId()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00103">IopHardwareProfileBeginTransition()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00572">IopHardwareProfileCancelRemovedDock()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00465">IopHardwareProfileCommitRemovedDock()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00370">IopHardwareProfileCommitStartedDock()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00160">IopHardwareProfileMarkDock()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00251">IopHardwareProfileQueryChange()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00827">IopHardwareProfileSendCancel()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02272">IopInitializeAttributesAndCreateObject()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08928">IopInitializeBootLogging()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02812">IopInitializeBuiltinDriver()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04580">IopInitializeDCB()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d2/d7/report_8c-source.html#l00066">IopInitializeResourceMap()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03146">IopInitializeSystemDrivers()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04710">IopInvalidateVolumesForDevice()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03181">IopIsAnyDeviceInstanceEnabled()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03443">IopIsDeviceInstanceEnabled()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l02009">IopIsFirmwareDisabled()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l01572">IopIsFirmwareMapperDevicePresent()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02286">IopIsReportedAlready()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03134">IopIsSameMachine()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06180">IopLegacyResourceAllocation()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04654">IopLoadBootFilterDriver()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00954">IopLoadDumpDriver()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04077">IopLoadFileSystemDriver()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04169">IopLoadUnloadDriver()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00725">IopLockDeviceRemovalRelations()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08729">IopLookupBusStringFromID()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01891">IopMakeGloballyUniqueId()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03479">IopMarkBootPartition()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02467">IopMarkDuplicateDevice()</a>, <a class="el" href="../../d4/d0/pnpmemio_8c-source.html#l00396">IopMemInitialize()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05198">IopMergeCmResourceLists()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05109">IopMergeFilteredResourceRequirementsList()</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00900">IopMergeRelationLists()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04282">IopMountVolume()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01596">IopNewDevice()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07330">IopNotifyDeviceClassChange()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06858">IopNotifyHwProfileChange()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08162">IopNotifySetupDeviceArrival()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04318">IopNotifySetupDevices()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07055">IopNotifyTargetDeviceChange()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09221">IoPnPDeliverServicePowerNotification()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01712">IopOpenCurrentHwProfileDeviceInstanceKey()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08501">IopOpenDeviceParametersSubkey()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05126">IopOpenLinkOrRenameTarget()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04741">IopOpenOrCreateDeviceInterfaceSubKeys()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01140">IopOpenRegistryKeyPersist()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01339">IopOpenServiceEnumKeys()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02640">IopOverwriteBuffer()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03868">IopParentToRawTranslation()</a>, <a class="el" href="../../d5/d2/parse_8c-source.html#l00202">IopParseDevice()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l05424">IopParseSymbolicLinkName()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02554">IopPlacement()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04946">IopPlacementForRebalance()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02649">IopPlacementForReservation()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00648">IopPnPDispatch()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09333">IopPnPHydraCallback()</a>, <a class="el" href="../../d4/d0/pnpmemio_8c-source.html#l01146">IopPortAddAllocation()</a>, <a class="el" href="../../d4/d0/pnpmemio_8c-source.html#l00890">IopPortBacktrackAllocation()</a>, <a class="el" href="../../d4/d0/pnpmemio_8c-source.html#l00959">IopPortFindSuitableRange()</a>, <a class="el" href="../../d4/d0/pnpmemio_8c-source.html#l01227">IopPortIsAliasedRangeAvailable()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00570">IopPowerDispatch()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00753">IopPrepareDriverLoading()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01417">IopProcessCompletedEject()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03762">IopProcessCriticalDevice()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04000">IopProcessCriticalDeviceRoutine()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01488">IopProcessNewChildren()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00917">IopProcessRelation()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09922">IopProcessSetInterfaceState()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00821">IopProcessStartDevices()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00912">IopProcessStartDevicesWorker()</a>, <a class="el" href="../../d6/d8/arcsec_8c-source.html#l00053">IopProtectSystemPartition()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02173">IopQueryCompatibleIds()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l08022">IopQueryConflictFillConflicts()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07876">IopQueryConflictFillString()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07717">IopQueryConflictList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l08336">IopQueryConflictListInternal()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03694">IopQueryDeviceCapabilities()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01762">IopQueryDeviceId()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01604">IopQueryDeviceRelations()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l03195">IopQueryDeviceSerialNumber()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02976">IopQueryDeviceState()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l03395">IopQueryDockRemovalInterface()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02793">IopQueryLegacyBusInformation()</a>, <a class="el" href="../../d5/d2/parse_8c-source.html#l01811">IopQueryName()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02885">IopQueryPnpBusInformation()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02733">IopQueryReconfiguration()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02617">IopQueryResourceHandlerInterface()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01820">IopQueryUniqueId()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05397">IopQueryXxxInformation()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05617">IopRaiseHardError()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04283">IopReadDeviceConfiguration()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04379">IopReadDumpRegistry()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07470">IopReallocateResources()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03612">IopReassignSystemRoot()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03686">IopReferenceDriverObjectByName()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l03929">IopRegisterDeviceInterface()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00263">IopReleaseDeviceResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02474">IopReleaseFilteredBootResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05757">IopReleaseResourcesInternal()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00927">IopRemoveDevice()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04414">IopRemoveDeviceInterfaces()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00449">IopRemoveStringFromValueKey()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06672">IopRequestHwProfileChangeNotification()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03376">IopReserve()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07291">IopReserveBootResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07198">IopReserveBootResourcesInternal()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06996">IopReserveLegacyBootResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01267">IopResourceRequirementsListToReqList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05660">IopRestoreResourcesInternal()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08822">IopSafebootDriverLoad()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06127">IopSendMessageToTrackService()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00931">IopServiceInstanceToDeviceInstance()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l04017">IopSetDefaultGateway()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01531">IopSetDeviceInstanceCsConfigFlags()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00877">IopSetDeviceSecurityDescriptors()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06326">IopSetEaOrQuotaInformationFile()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06660">IopSetLegacyDeviceInstance()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l05714">IopSetRegistryStringValue()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06716">IopSetRemoteLink()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08959">IopSetSecurityObjectFromRegistry()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01653">IopSetServiceInstanceCsConfigFlags()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03534">IopSetupArbiterAndTranslators()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l01982">IopSetupRemoteBootCard()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00994">IopStartAndEnumerateDevice()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06870">IopStartApcHardError()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01740">IopStartDriverDevices()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l00770">IopStartNetworkForRemoteBoot()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l01834">IopStartTcpIpForRemoteBoot()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03862">IopStoreSystemPartitionInformation()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06926">IopSynchronousApiServiceTail()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l07030">IopSynchronousServiceTail()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l04377">IopTCPQueryInformationEx()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l04458">IopTCPSetInformationEx()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04767">IopTestForReconfiguration()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l07272">IopTrackLink()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04129">IopTranslateAndAdjustReqDesc()</a>, <a class="el" href="../../d4/d0/pnpmemio_8c-source.html#l00155">IopTranslateBusAddress()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01755">IopUnloadAttachedDriver()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01572">IopUnlockDeviceRemovalRelations()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04140">IopUnregisterDeviceInterface()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00862">IopUpdateHardwareProfile()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04617">IopWaitForBootDevicesDeleted()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04508">IopWaitForBootDevicesStarted()</a>, <a class="el" href="../../d5/d0/pnppower_8c-source.html#l00422">IopWarmEjectDevice()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01931">IopWriteAllocatedResourcesToRegistry()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l03974">IopWriteIpAddressToRegistry()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03183">IopWritePageToDisk()</a>, <a class="el" href="../../d2/d7/report_8c-source.html#l00760">IopWriteResourceList()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03329">IopWriteSummaryDump()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03520">IopWriteSummaryHeader()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02795">IopWriteTriageDump()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08084">IopXxxControlFile()</a>, <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00070">IoQueryDeviceDescription()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l03835">IoRegisterDeviceInterface()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07495">IoRegisterPlugPlayNotification()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>, <a class="el" href="../../d2/d7/report_8c-source.html#l00193">IoReportHalResourceUsage()</a>, <a class="el" href="../../d2/d7/report_8c-source.html#l00469">IoReportResourceUsageInternal()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06017">IoReportTargetDeviceChange()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06118">IoReportTargetDeviceChangeAsynchronous()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04325">IoSetCrashDumpState()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l03563">IoSetDeviceInterfaceState()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09835">IoSetInformation()</a>, <a class="el" href="../../d6/d3/complete_8c-source.html#l00671">IoSetIoCompletion()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01291">IoSynchronousInvalidateDeviceRelations()</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00248">IovCallDriver()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11389">IoVerifyVolume()</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00524">IovInitializeTimer()</a>, <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l00433">IovpAssertIrpStackDownward()</a>, <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l00870">IovpAssertIrpStackUpward()</a>, <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l00191">IovpAssertNewRequest()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00948">IovpCallDriver2()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01416">IovpCompleteRequest2()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01901">IovpCompleteRequest5()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02499">IovpInternalCompleteAfterWait()</a>, <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00523">IovpSessionDataFinalizeSurrogate()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02751">IovpSwapSurrogateIrp()</a>, <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l01531">IovpThrowBogusSynchronousIrp()</a>, <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l01392">IovpThrowChaffAtStartedPdoStack()</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l01159">IovSpecialIrpCallDriver()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01519">IoWriteCrashDump()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01163">IsInterestingPath()</a>, <a class="el" href="../../d3/d9/server_2exitwin_8c-source.html#l02001">IsPrivileged()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l02001">IsTokenRestricted()</a>, <a class="el" href="../../d6/d1/fekbdcom_8c-source.html#l00199">KbdLayerRealDllFileForWBT()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l00847">KdpSendWaitContinue()</a>, <a class="el" href="../../d4/d0/biosc_8c-source.html#l00060">Ke386CallBios()</a>, <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00142">KeBalanceSetManager()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d4/d2/abiosc_8c-source.html#l00170">KeI386GetLid()</a>, <a class="el" href="../../d4/d2/abiosc_8c-source.html#l00308">KeI386ReleaseLid()</a>, <a class="el" href="../../d0/d3/ke_2i386_2vdm_8c-source.html#l01088">KeI386VdmInitialize()</a>, <a class="el" href="../../d1/d7/profobj_8c-source.html#l00163">KeQueryIntervalProfile()</a>, <a class="el" href="../../d0/d8/i386_2exceptn_8c-source.html#l01394">KeRaiseUserException()</a>, <a class="el" href="../../d9/d2/queueobj_8c-source.html#l00238">KeRemoveQueue()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d7/d8/kernlini_8c-source.html#l02008">KeSetup80387OrEmulate()</a>, <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00322">KeSwapProcessOrStack()</a>, <a class="el" href="../../d4/d3/ke_2alpha_2callback_8c-source.html#l00028">KeUserModeCallback()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00395">KeWaitForMultipleObjects()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d4/d4/i386_2trapc_8c-source.html#l00090">Ki386CheckDivideByZeroTrap()</a>, <a class="el" href="../../d1/d4/mtrramd_8c-source.html#l00294">KiAmdK6MtrrSetMemoryType()</a>, <a class="el" href="../../d6/d3/raisexcp_8c-source.html#l00099">KiContinue()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00275">KiInitializeMTRR()</a>, <a class="el" href="../../d7/d8/kernlini_8c-source.html#l01691">KiInitMachineDependent()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l03451">KillProcess()</a>, <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html#l00056">KiMemoryFault()</a>, <a class="el" href="../../d7/d8/kernlini_8c-source.html#l02297">KiMoveRegTree()</a>, <a class="el" href="../../d3/d6/waitsup_8c-source.html#l00277">KiWaitTest()</a>, <a class="el" href="../../d2/d2/ldrrsrc_8c-source.html#l01220">LdrAlternateResourcesEnabled()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00474">LdrDisableThreadCalloutsForDll()</a>, <a class="el" href="../../d2/d2/ldrrsrc_8c-source.html#l01039">LdrEnumResources()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00295">LdrGetDllHandle()</a>, <a class="el" href="../../d2/d2/ldrrsrc_8c-source.html#l01563">LdrLoadAlternateResourceModule()</a>, <a class="el" href="../../d2/d2/ldrrsrc_8c-source.html#l00096">LdrpAccessResourceData()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03283">LdrpCheckForKnownDll()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00832">LdrpCheckForLoadedDll()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02150">LdrpCreateDllSection()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03781">LdrpDphSnapImports()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00575">LdrpForkProcess()</a>, <a class="el" href="../../d2/d2/ldrrsrc_8c-source.html#l01312">LdrpGetFileVersion()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00851">LdrpGetProcedureAddress()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00157">LdrpInitializationFailure()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00186">LdrpInitialize()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00070">LdrpLoadDll()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00140">LdrpLoadImportModule()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l01261">LdrpMapDll()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00652">LdrpRunInitializeRoutines()</a>, <a class="el" href="../../d2/d2/ldrrsrc_8c-source.html#l00492">LdrpSearchResourceSection_U()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03417">LdrpSetProtection()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02258">LdrpSnapIAT()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02476">LdrpSnapThunk()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02802">LdrpUpdateLoadCount()</a>, <a class="el" href="../../d2/d2/ldrrsrc_8c-source.html#l01427">LdrpVerifyAlternateResourceModule()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00214">LdrpWalkImportDescriptor()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02277">LdrQueryApplicationCompatibilityGoo()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01796">LdrQueryImageFileExecutionOptions()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l01210">LdrQueryProcessModuleInformation()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00528">LdrUnloadDll()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l01069">LdrVerifyImageMatchesChecksum()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00706">LfsCloseLogFile()</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00058">LfsExceptionFilter()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l03193">LfsFindLastLsn()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00551">LfsFlushLfcb()</a>, <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00360">LfsFlushToLsn()</a>, <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00197">LfsForceWrite()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00150">LfsInitializeLogFile()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00366">LfsOpenLogFile()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00084">LfsPinOrMapData()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00072">LfsReadLogRecord()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00299">LfsReadNextLogRecord()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l01402">LfsReadRestart()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00046">LfsReadRestartArea()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00447">LfsSetBaseLsn()</a>, <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00039">LfsWrite()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00270">LfsWriteRestartArea()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l00966">List()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l02369">ListDrivers()</a>, <a class="el" href="../../d7/d7/clinit_8c-source.html#l00933">LoadAppDlls()</a>, <a class="el" href="../../d0/d7/menuddc_8c-source.html#l00281">LoadOLEOnce()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l04503">LockProcessByClientId()</a>, <a class="el" href="../../d8/d5/lpcinit_8c-source.html#l00076">LpcInitSystem()</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00558">LpcpAllocateFromPortZone()</a>, <a class="el" href="../../d6/d6/lpcreply_8c-source.html#l00915">LpcpCopyRequestData()</a>, <a class="el" href="../../d7/d5/lpccreat_8c-source.html#l00136">LpcpCreatePort()</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00397">LpcpExtendPortZone()</a>, <a class="el" href="../../d8/d5/lpcinit_8c-source.html#l00193">LpcpGetCreatorName()</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00287">LpcpInitializePortZone()</a>, <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l01407">LpcRequestWaitReplyPort()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l02460">main()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02348">MakeCursorVisible()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l02836">MapDesktop()</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l01600">MapperConstructRootEnumTree()</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l01091">MapperMarkKey()</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l02060">MapperPhantomizeDetectedComPorts()</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l01298">MapperSeedKey()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01407">MapViewOfSection()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l01105">MatchandCopyAlias()</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00124">MemPrintInitialize()</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00598">MemPrintWriteThread()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l10107">MESSAGECALL()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01485">MiAttemptPageFileExtension()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01940">MiAttemptPageFileReduction()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l03645">MiCallDllUnloadAndUnloadDll()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01095">MiCheckForCrashDump()</a>, <a class="el" href="../../d6/d2/acceschk_8c-source.html#l00194">MiCheckForUserStackOverflow()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00166">MiCheckPageFilePath()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03125">MiCheckPdeForPagedPool()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l02244">MiCheckSecuredVad()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01075">MiCleanSection()</a>, <a class="el" href="../../d9/d5/forksup_8c-source.html#l00100">MiCloneProcessAddressSpace()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l03553">MiCreateDataFileMap()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l01424">MiCreateImageFileMap()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l00603">MiDereferenceSegmentThread()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l00068">MiDispatchFault()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l04726">MiEmptyWorkingSet()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00941">MiEnsureAvailablePageOrWait()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l01014">MiFlushSectionInternal()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l03701">MiGatherPagefilePages()</a>, <a class="el" href="../../d6/d2/queryvm_8c-source.html#l00890">MiGetWorkingSetInfo()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l04868">MiGetWritablePagesInSection()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04911">MiIssuePageExtendRequest()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l05023">MiIssuePageExtendRequestNoWait()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l01474">MiLoadImageSection()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l05287">MiMakeOutswappedPageResident()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00764">MiMakeSystemAddressValid()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00996">MiMakeSystemAddressValidPfn()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00916">MiMakeSystemAddressValidPfnSystemWs()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00837">MiMakeSystemAddressValidPfnWs()</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l01779">MiMapCacheExceptionFilter()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04239">MiMappedPageWriter()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l01567">MiMapViewOfImageSection()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02831">MiModifiedPageWriterWorker()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l00344">MiProtectVirtualMemory()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l05956">MiReloadBootLoadedDrivers()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l01223">MiRemoveImageSessionWide()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l02748">MiRemoveUnusedSegments()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l03953">MiResolveImageReferences()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l01446">MiResolveProtoPteFault()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l00868">MiResolveTransitionFault()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l00768">MiSectionInitialization()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l00191">MiSegmentDelete()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l02144">MiSessionCommitImagePages()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l00394">MiSessionCreateInternal()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00572">MiSessionUnloadAllImages()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00936">MiSessionWideReserveImageAddress()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l01110">MiSetProtectionOnSection()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00119">MiShareSessionImage()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l04464">MiSnapThunk()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l02335">MiWaitForInPageComplete()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02234">MiWriteComplete()</a>, <a class="el" href="../../d5/d0/mmfault_8c-source.html#l00041">MmAccessFault()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l02450">MmAdjustWorkingSetSize()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l06717">MmCallDllInitialize()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l04820">MmCheckSystemImage()</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l01274">MmCopyToCachedPage()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00362">MmCopyVirtualMemory()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l04631">MmCreatePeb()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l00390">MmCreateSection()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l04843">MmDeleteTeb()</a>, <a class="el" href="../../d9/d9/extsect_8c-source.html#l00201">MmExtendSection()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00668">MmFlushSection()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00297">MmFlushVirtualMemory()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01392">MmGetCrashDumpInformation()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01721">MmGetFileNameForSection()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06797">MmGetSectionRange()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l06808">MmGetSystemRoutineAddress()</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l04046">MmGetVerifierInformation()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00911">MmInitializeProcessAddressSpace()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03415">MmMapIoSpace()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05161">MmMapUserAddressesToPage()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00753">MmMapViewOfSection()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00238">MmProbeAndLockPages()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00813">MmProbeAndLockProcessPages()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00437">MmRemovePhysicalMemory()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l00974">MmSessionCreate()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07311">MmSetBankedSection()</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l04226">MmSetVerifierInformation()</a>, <a class="el" href="../../d2/d8/shutdown_8c-source.html#l00041">MmShutdownSystem()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">MmUnloadSystemImage()</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00090">MmUnmapViewOfSection()</a>, <a class="el" href="../../d8/d0/zeropage_8c-source.html#l00029">MmZeroPageThread()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00405">MyCmpInitHiveFromFile()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01670">MyRegQueryValue()</a>, <a class="el" href="../../d8/d7/ntnap_8c-source.html#l00164">NapCreateDataSection()</a>, <a class="el" href="../../d6/d4/namesup_8c-source.html#l00056">NativeDosCharLength()</a>, <a class="el" href="../../d5/d1/fekbd_8c-source.html#l01092">NlsKbdInitializePerSystem()</a>, <a class="el" href="../../d1/d6/server_2server_8c-source.html#l00881">NotificationThread()</a>, <a class="el" href="../../d5/d5/lpccompl_8c-source.html#l00040">NtAcceptConnectPort()</a>, <a class="el" href="../../d7/d7/exatom_8c-source.html#l00045">NtAddAtom()</a>, <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l00432">NtAdjustGroupsToken()</a>, <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l00046">NtAdjustPrivilegesToken()</a>, <a class="el" href="../../d2/d1/psspnd_8c-source.html#l00267">NtAlertResumeThread()</a>, <a class="el" href="../../d2/d1/psspnd_8c-source.html#l00214">NtAlertThread()</a>, <a class="el" href="../../d1/d7/luid_8c-source.html#l00081">NtAllocateLocallyUniqueId()</a>, <a class="el" href="../../d9/d4/physical_8c-source.html#l00970">NtAllocateUserPhysicalPages()</a>, <a class="el" href="../../d4/d2/uuid_8c-source.html#l00617">NtAllocateUuids()</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l02965">NtAreMappedFilesTheSame()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l00266">NtAssignProcessToJobObject()</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00049">NtCancelIoFile()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00679">NtCancelTimer()</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00126">NtClearEvent()</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02492">NtCloseObjectAuditAlarm()</a>, <a class="el" href="../../d5/d5/lpccompl_8c-source.html#l00836">NtCompleteConnectPort()</a>, <a class="el" href="../../d5/d5/channel_8c-source.html#l00101">NtCreateChannel()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l00032">NtCreateDirectoryObject()</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00180">NtCreateEvent()</a>, <a class="el" href="../../d4/d7/eventpr_8c-source.html#l00131">NtCreateEventPair()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00253">NtCreateFile()</a>, <a class="el" href="../../d6/d3/complete_8c-source.html#l00051">NtCreateIoCompletion()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l00048">NtCreateJobObject()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d3/d4/mutant_8c-source.html#l00156">NtCreateMutant()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00297">NtCreatePagingFile()</a>, <a class="el" href="../../d7/d5/lpccreat_8c-source.html#l00045">NtCreatePort()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00843">NtCreateProcess()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00199">NtCreateProfile()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l00134">NtCreateSection()</a>, <a class="el" href="../../d3/d5/semphore_8c-source.html#l00123">NtCreateSemaphore()</a>, <a class="el" href="../../d2/d7/super_8c-source.html#l00056">NtCreateSuperSection()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00052">NtCreateSymbolicLinkObject()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00067">NtCreateThread()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00444">NtCreateTimer()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l01690">NtCreateToken()</a>, <a class="el" href="../../d7/d5/lpccreat_8c-source.html#l00087">NtCreateWaitablePort()</a>, <a class="el" href="../../d8/d5/delay_8c-source.html#l00033">NtDelayExecution()</a>, <a class="el" href="../../d7/d7/exatom_8c-source.html#l00260">NtDeleteAtom()</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00298">NtDeleteFile()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00411">NtDeleteKey()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02627">NtDeleteObjectAuditAlarm()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00504">NtDeleteValueKey()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00046">NtDuplicateToken()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00610">NtEnumerateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00756">NtEnumerateValueKey()</a>, <a class="el" href="../../d9/d9/extsect_8c-source.html#l00085">NtExtendSection()</a>, <a class="el" href="../../d6/d4/rdwr_8c-source.html#l00050">NTFastDOSIO()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01306">NtFilterToken()</a>, <a class="el" href="../../d7/d7/exatom_8c-source.html#l00152">NtFindAtom()</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00386">NtFlushBuffersFile()</a>, <a class="el" href="../../d6/d4/flushbuf_8c-source.html#l00142">NtFlushInstructionCache()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00904">NtFlushKey()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00055">NtFlushVirtualMemory()</a>, <a class="el" href="../../d9/d4/physical_8c-source.html#l01624">NtFreeUserPhysicalPages()</a>, <a class="el" href="../../d4/d6/freevm_8c-source.html#l00066">NtFreeVirtualMemory()</a>, <a class="el" href="../../d3/d7/ntfs__rec_8c-source.html#l00042">NtfsRecFsControl()</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00151">NtGetContextThread()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l03038">NtImpersonateAnonymousToken()</a>, <a class="el" href="../../d2/d6/lpcpriv_8c-source.html#l00032">NtImpersonateClientOfPort()</a>, <a class="el" href="../../d0/d0/psimpers_8c-source.html#l00026">NtImpersonateThread()</a>, <a class="el" href="../../d5/d5/channel_8c-source.html#l00236">NtListenChannel()</a>, <a class="el" href="../../d9/d5/lpclistn_8c-source.html#l00029">NtListenPort()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02881">NtLoadKey2()</a>, <a class="el" href="../../d2/d4/lock_8c-source.html#l00035">NtLockFile()</a>, <a class="el" href="../../d4/d4/lockvm_8c-source.html#l00033">NtLockVirtualMemory()</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00414">NtMakeTemporaryObject()</a>, <a class="el" href="../../d9/d4/physical_8c-source.html#l00085">NtMapUserPhysicalPages()</a>, <a class="el" href="../../d9/d4/physical_8c-source.html#l00498">NtMapUserPhysicalPagesScatter()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00199">NtMapViewOfSection()</a>, <a class="el" href="../../d2/d7/super_8c-source.html#l00311">NtMapViewOfSuperSection()</a>, <a class="el" href="../../d1/d7/dir_8c-source.html#l00821">NtNotifyChangeDirectoryFile()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>, <a class="el" href="../../d5/d5/channel_8c-source.html#l00348">NtOpenChannel()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l00144">NtOpenDirectoryObject()</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00313">NtOpenEvent()</a>, <a class="el" href="../../d4/d7/eventpr_8c-source.html#l00251">NtOpenEventPair()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00449">NtOpenFile()</a>, <a class="el" href="../../d6/d3/complete_8c-source.html#l00178">NtOpenIoCompletion()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l00188">NtOpenJobObject()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d3/d4/mutant_8c-source.html#l00280">NtOpenMutant()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02072">NtOpenObjectAuditAlarm()</a>, <a class="el" href="../../d8/d0/psopen_8c-source.html#l00030">NtOpenProcess()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00178">NtOpenProcessToken()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l04250">NtOpenSection()</a>, <a class="el" href="../../d3/d5/semphore_8c-source.html#l00260">NtOpenSemaphore()</a>, <a class="el" href="../../d2/d7/super_8c-source.html#l00237">NtOpenSuperSection()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00247">NtOpenSymbolicLinkObject()</a>, <a class="el" href="../../d8/d0/psopen_8c-source.html#l00280">NtOpenThread()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00458">NtOpenThreadToken()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00581">NtOpenTimer()</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00231">NtPrivilegeCheck()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00731">NtPrivilegedServiceAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00406">NtPrivilegeObjectAuditAlarm()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l00069">NtProtectVirtualMemory()</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00412">NtPulseEvent()</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00629">NtQueryAttributesFile()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00220">NtQueryDefaultLocale()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00447">NtQueryDefaultUILanguage()</a>, <a class="el" href="../../d1/d7/dir_8c-source.html#l00682">NtQueryDirectoryFile()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l00229">NtQueryDirectoryObject()</a>, <a class="el" href="../../d8/d1/qsea_8c-source.html#l00035">NtQueryEaFile()</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00514">NtQueryEvent()</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00745">NtQueryFullAttributesFile()</a>, <a class="el" href="../../d7/d7/exatom_8c-source.html#l00294">NtQueryInformationAtom()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00101">NtQueryInformationFile()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l00814">NtQueryInformationJobObject()</a>, <a class="el" href="../../d3/d6/lpcquery_8c-source.html#l00030">NtQueryInformationPort()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00531">NtQueryInformationProcess()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l02706">NtQueryInformationThread()</a>, <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l00034">NtQueryInformationToken()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00416">NtQueryInstallUILanguage()</a>, <a class="el" href="../../d6/d3/complete_8c-source.html#l00282">NtQueryIoCompletion()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02018">NtQueryKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03461">NtQueryMultipleValueKey()</a>, <a class="el" href="../../d3/d4/mutant_8c-source.html#l00380">NtQueryMutant()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00058">NtQueryObject()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l04090">NtQueryOpenSubKeys()</a>, <a class="el" href="../../d1/d2/qsquota_8c-source.html#l00035">NtQueryQuotaInformationFile()</a>, <a class="el" href="../../d5/d2/querysec_8c-source.html#l00031">NtQuerySection()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00255">NtQuerySecurityObject()</a>, <a class="el" href="../../d3/d5/semphore_8c-source.html#l00360">NtQuerySemaphore()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00333">NtQuerySymbolicLinkObject()</a>, <a class="el" href="../../d6/d7/sysenv_8c-source.html#l00045">NtQuerySystemEnvironmentValue()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00941">NtQuerySystemInformation()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00822">NtQueryTimer()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d6/d2/queryvm_8c-source.html#l00061">NtQueryVirtualMemory()</a>, <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00037">NtQueryVolumeInformationFile()</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00056">NtQueueApcThread()</a>, <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00532">NtRaiseHardError()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00036">NtReadFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00730">NtReadFileScatter()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00102">NtReadVirtualMemory()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01472">NtRegisterThreadTerminatePort()</a>, <a class="el" href="../../d3/d4/mutant_8c-source.html#l00521">NtReleaseMutant()</a>, <a class="el" href="../../d3/d5/semphore_8c-source.html#l00494">NtReleaseSemaphore()</a>, <a class="el" href="../../d6/d3/complete_8c-source.html#l00485">NtRemoveIoCompletion()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03336">NtReplaceKey()</a>, <a class="el" href="../../d6/d6/lpcreply_8c-source.html#l00044">NtReplyPort()</a>, <a class="el" href="../../d5/d6/lpcrecv_8c-source.html#l00029">NtReplyWaitReceivePort()</a>, <a class="el" href="../../d5/d6/lpcrecv_8c-source.html#l00635">NtReplyWaitReceivePortEx()</a>, <a class="el" href="../../d6/d6/lpcreply_8c-source.html#l00375">NtReplyWaitReplyPort()</a>, <a class="el" href="../../d5/d5/channel_8c-source.html#l00525">NtReplyWaitSendChannel()</a>, <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l00032">NtRequestPort()</a>, <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l00395">NtRequestWaitReplyPort()</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00648">NtResetEvent()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02348">NtRestoreKey()</a>, <a class="el" href="../../d2/d1/psspnd_8c-source.html#l00138">NtResumeThread()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02471">NtSaveKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02559">NtSaveMergedKeys()</a>, <a class="el" href="../../d6/d5/lpcconn_8c-source.html#l00084">NtSecureConnectPort()</a>, <a class="el" href="../../d5/d5/channel_8c-source.html#l00807">NtSendWaitReplyChannel()</a>, <a class="el" href="../../d5/d5/channel_8c-source.html#l01082">NtSetContextChannel()</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00352">NtSetContextThread()</a>, <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00886">NtSetDefaultHardErrorPort()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00258">NtSetDefaultLocale()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00741">NtSetDefaultUILanguage()</a>, <a class="el" href="../../d8/d1/qsea_8c-source.html#l00652">NtSetEaFile()</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00748">NtSetEvent()</a>, <a class="el" href="../../d4/d7/eventpr_8c-source.html#l00651">NtSetHighEventPair()</a>, <a class="el" href="../../d4/d7/eventpr_8c-source.html#l00532">NtSetHighWaitLowEventPair()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l01323">NtSetInformationJobObject()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03235">NtSetInformationKey()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00545">NtSetInformationObject()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l01510">NtSetInformationProcess()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l03103">NtSetInformationThread()</a>, <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00037">NtSetInformationToken()</a>, <a class="el" href="../../d6/d3/complete_8c-source.html#l00417">NtSetIoCompletion()</a>, <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l01235">NtSetLdtEntries()</a>, <a class="el" href="../../d4/d7/eventpr_8c-source.html#l00592">NtSetLowEventPair()</a>, <a class="el" href="../../d4/d7/eventpr_8c-source.html#l00472">NtSetLowWaitHighEventPair()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00046">NtSetSecurityObject()</a>, <a class="el" href="../../d6/d7/sysenv_8c-source.html#l00305">NtSetSystemEnvironmentValue()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l02264">NtSetSystemInformation()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00960">NtSetTimer()</a>, <a class="el" href="../../d4/d2/uuid_8c-source.html#l00532">NtSetUuidSeed()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>, <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00492">NtSetVolumeInformationFile()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00038">NtSignalAndWaitForSingleObject()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00517">NtStartProfile()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00680">NtStopProfile()</a>, <a class="el" href="../../d2/d1/psspnd_8c-source.html#l00033">NtSuspendThread()</a>, <a class="el" href="../../d3/d2/dbgctrl_8c-source.html#l00036">NtSystemDebugControl()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l02358">NtTerminateJobObject()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00227">NtTerminateProcess()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00461">NtTerminateThread()</a>, <a class="el" href="../../d9/d3/loadunld_8c-source.html#l00244">NtUnloadDriver()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03093">NtUnloadKey()</a>, <a class="el" href="../../d2/d4/lock_8c-source.html#l00458">NtUnlockFile()</a>, <a class="el" href="../../d4/d4/lockvm_8c-source.html#l00605">NtUnlockVirtualMemory()</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00033">NtUnmapViewOfSection()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l12710">NtUserBuildHimcList()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l08222">NtUserBuildHwndList()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l08365">NtUserBuildNameList()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l08333">NtUserBuildPropList()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l01118">NtUserCloseWindowStation()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l00870">NtUserConsoleControl()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l03336">NtUserCreateLocalMemHandle()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l00891">NtUserCreateWindowStation()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l00615">NtUserCtxDisplayIOCtl()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l09312">NtUserEnumDisplayDevices()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l09357">NtUserEnumDisplaySettings()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l02329">NtUserGetGuiResources()</a>, <a class="el" href="../../d0/d6/kernel_2server_8c-source.html#l02713">NtUserInitialize()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l01508">NtUserInitializeClientPfnArrays()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l03098">NtUserInitTask()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l07070">NtUserLockWindowStation()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l01235">NtUserOpenInputDesktop()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l01028">NtUserOpenWindowStation()</a>, <a class="el" href="../../d0/d6/kernel_2server_8c-source.html#l02788">NtUserProcessConnect()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l07532">NtUserQueryInformationThread()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l00521">NtUserRemoteConnect()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l00552">NtUserRemoteRedrawRectangle()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l00576">NtUserRemoteRedrawScreen()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l00599">NtUserRemoteStopScreenUpdates()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l01303">NtUserResolveDesktopForWOW()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l07606">NtUserSetInformationProcess()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l07575">NtUserSetInformationThread()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l01434">NtUserSetThreadDesktop()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l07110">NtUserSetWindowStationUser()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l07651">NtUserSoundSentry()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l01467">NtUserSwitchDesktop()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l07662">NtUserTestForInteractiveUser()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l07090">NtUserUnlockWindowStation()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l07905">NtUserUserHandleGrantAccess()</a>, <a class="el" href="../../d6/d3/vdmentry_8c-source.html#l00051">NtVdmControl()</a>, <a class="el" href="../../d4/d3/ke_2alpha_2callback_8c-source.html#l00143">NtW32Call()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00406">NtWaitForMultipleObjects()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00282">NtWaitForSingleObject()</a>, <a class="el" href="../../d4/d7/eventpr_8c-source.html#l00412">NtWaitHighEventPair()</a>, <a class="el" href="../../d4/d7/eventpr_8c-source.html#l00352">NtWaitLowEventPair()</a>, <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00035">NtWriteFile()</a>, <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00801">NtWriteFileGather()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00231">NtWriteVirtualMemory()</a>, <a class="el" href="../../d7/d0/yield_8c-source.html#l00029">NtYieldExecution()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01183">ObAssignObjectSecurityDescriptor()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01574">ObAssignSecurity()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00983">ObCheckCreateObjectAccess()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00392">ObCheckObjectAccess()</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00069">ObCreateObjectType()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00658">ObDupHandleProcedure()</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00478">ObEnumerateObjectsByType()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00745">ObGetHandleInformation()</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00800">ObGetObjectInformation()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01258">ObGetObjectSecurity()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00367">ObOpenObjectByPointer()</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00761">ObpAllocateObject()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00807">ObpCaptureHandleInformation()</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00248">ObpCaptureObjectCreateInformation()</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00438">ObpCaptureObjectName()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00602">ObpCheckObjectReference()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00778">ObpCheckTraverseAccess()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01349">ObpCreateDosDevicesDirectory()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02160">ObpCreateHandle()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02507">ObpCreateUnnamedHandle()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01805">ObpFreeDosDevicesProtection()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01545">ObpGetDosDevicesProtection()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00182">ObpHashSecurityDescriptor()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01232">ObpIncrementHandleCount()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01587">ObpIncrementUnnamedHandleCount()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00118">ObpInitSecurityDescriptorCache()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l01081">ObpLookupObjectName()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00501">ObpParseSymbolicLink()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l01121">ObpProcessDosDeviceSymbolicLink()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l01370">ObpRemoveObjectRoutine()</a>, <a class="el" href="../../d8/d9/obdevmap_8c-source.html#l00236">ObQueryDeviceMapInformation()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00713">ObQueryNameString()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l01319">ObQueryObjectAuditingByHandle()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01679">ObQuerySecurityDescriptorInfo()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l01216">ObQueryTypeInfo()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00844">ObReferenceObjectByName()</a>, <a class="el" href="../../d8/d9/obdevmap_8c-source.html#l00030">ObSetDeviceMap()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01748">ObSetSecurityDescriptorInfo()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00174">ObSetSecurityObjectByPointer()</a>, <a class="el" href="../../d4/d2/tob_8c-source.html#l00187">obtest()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00837">ObWaitForSingleObject()</a>, <a class="el" href="../../d3/d8/uipriv_8c-source.html#l00148">OpenAppropriateToken()</a>, <a class="el" href="../../d2/d6/w32_2ntuser_2kernel_2profile_8c-source.html#l00263">OpenCacheKeyEx()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l03192">OpenDesktopCompletion()</a>, <a class="el" href="../../d6/d8/w32_2ntuser_2kernel_2pnp_8c-source.html#l00807">OpenDevice()</a>, <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00225">OpenDeviceReparseIndex()</a>, <a class="el" href="../../d5/d7/ex_8c-source.html#l00017">OpenEffectiveToken()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l04019">OpenKeyboardLayoutFile()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l02391">ParseDesktop()</a>, <a class="el" href="../../d9/d7/winsta_8c-source.html#l00911">ParseWindowStation()</a>, <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00223">pIoQueryBusDescription()</a>, <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00565">pIoQueryDeviceDescription()</a>, <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l02089">PnPBiosCopyDeviceParamKey()</a>, <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l02663">PnPBiosCopyIoDecode()</a>, <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l01725">PnPBiosEliminateDupes()</a>, <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l00399">PnPBiosGetBiosInfo()</a>, <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l03008">PnPBiosMapper()</a>, <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l01126">PnPBiosTranslateInfo()</a>, <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l02289">PnPBiosWriteInfo()</a>, <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l00788">PnPCheckFixedIoOverrideDecodes()</a>, <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l00759">PnPGetDevnodeExcludeList()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l01410">PrependInputBuffer()</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00099">processargs()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l03272">ProcessCommandLine()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l02287">ProcessCommandListInput()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l02793">ProcessCommandNumberInput()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l02546">ProcessCopyFromCharInput()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l02677">ProcessCopyToCharInput()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l01657">ProcessCreateConsoleWindow()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l03865">ProcessCtrlEvents()</a>, <a class="el" href="../../d6/d8/w32_2ntuser_2kernel_2pnp_8c-source.html#l01191">ProcessDeviceChanges()</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01599">ProcessHardErrorRequest()</a>, <a class="el" href="../../d2/d6/ntcon_2server_2menu_8c-source.html#l00287">PropertiesDlgShow()</a>, <a class="el" href="../../d2/d6/ntcon_2server_2menu_8c-source.html#l00459">PropertiesUpdate()</a>, <a class="el" href="../../d9/d8/dllinit_8c-source.html#l01019">PropRoutine()</a>, <a class="el" href="../../d5/d7/ex_8c-source.html#l00464">ProtectHandle()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01483">PsAssignImpersonationToken()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l03964">PsConvertToGuiThread()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00915">PsCreateSystemProcess()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00175">PsCreateSystemThread()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l02396">PsEnforceExecutionTimeLimits()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00603">PsExitSpecialApc()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00650">PsImpersonateClient()</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00525">PsLocateSystemDll()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01966">PsLockProcess()</a>, <a class="el" href="../../d2/d9/pscid_8c-source.html#l00094">PsLookupProcessByProcessId()</a>, <a class="el" href="../../d2/d9/pscid_8c-source.html#l00027">PsLookupProcessThreadByCid()</a>, <a class="el" href="../../d2/d9/pscid_8c-source.html#l00146">PsLookupThreadByThreadId()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00586">PsOpenTokenOfJobObject()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00492">PsOpenTokenOfProcess()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00326">PsOpenTokenOfThread()</a>, <a class="el" href="../../d4/d1/i386_2psvdm_8c-source.html#l00730">Psp386CreateVdmIoListHead()</a>, <a class="el" href="../../d4/d1/i386_2psvdm_8c-source.html#l00477">Psp386InstallIoHandler()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l00439">PspAddProcessToJob()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l02262">PspApplyJobLimitsToProcess()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01256">PspAssignPrimaryToken()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l02680">PspCaptureTokenFilter()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00631">PspExitNormalApc()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01117">PspInitializeProcessSecurity()</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00745">PspInitializeSystemDll()</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00487">PspInitPhase1()</a>, <a class="el" href="../../d0/d0/kulookup_8c-source.html#l00026">PspLookupKernelUserEntryPoints()</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00679">PspMapSystemDll()</a>, <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l01061">PspQueryDescriptorThread()</a>, <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00108">PspQueryLdtInformation()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00291">PspQueryPooledQuotaLimits()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00209">PspQueryQuotaLimits()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00113">PspQueryWorkingSetWatch()</a>, <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00503">PspSetLdtInformation()</a>, <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00308">PspSetLdtSize()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00366">PspSetPrimaryToken()</a>, <a class="el" href="../../d4/d1/i386_2psvdm_8c-source.html#l00101">PspSetProcessIoHandlers()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l01211">PspSetQuotaLimits()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00384">PspTerminateProcess()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01755">PsSetCreateThreadNotifyRoutine()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l02344">PsSetLoadImageNotifyRoutine()</a>, <a class="el" href="../../d6/d8/w32_2ntuser_2kernel_2pnp_8c-source.html#l00761">QueryDeviceInfo()</a>, <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00149">QueryDeviceNameForPath()</a>, <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00094">QuerySymbolicLink()</a>, <a class="el" href="../../d8/d1/power_8c-source.html#l00076">QueuePowerRequest()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l03858">RawInputThread()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l00471">RawReadWaitRoutine()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l01778">ReadChars()</a>, <a class="el" href="../../d0/d6/client_2stream_8c-source.html#l00191">ReadConsoleInternal()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l00959">ReadInputBuffer()</a>, <a class="el" href="../../d7/d1/kbdlyout_8c-source.html#l00106">ReadLayoutFile()</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l01573">RealUnicodeToFalseUnicode()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l02061">RedrawCommandLine()</a>, <a class="el" href="../../d9/d7/winsta_8c-source.html#l01366">ReferenceWindowStation()</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l01096">RegGetKeyValue()</a>, <a class="el" href="../../d6/d8/w32_2ntuser_2kernel_2pnp_8c-source.html#l00929">RegisterForDeviceChangeNotifications()</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00259">RegLoadAsciiFileAsUnicode()</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00158">RegReadBinaryFile()</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00068">RegReadMultiSzFile()</a>, <a class="el" href="../../d7/d9/w32_2ntuser_2kernel_2misc_8c-source.html#l00020">RemoteConnect()</a>, <a class="el" href="../../d9/d7/fullscr_8c-source.html#l01733">RemoteDisableScreen()</a>, <a class="el" href="../../d5/d5/server_2sendmsg_8c-source.html#l00089">RemoteDoBroadcastSystemMessage()</a>, <a class="el" href="../../d7/d3/icamsg_8c-source.html#l00068">RemoteDoMessage()</a>, <a class="el" href="../../d5/d5/server_2sendmsg_8c-source.html#l00123">RemoteDoSendWindowMessage()</a>, <a class="el" href="../../d7/d9/w32_2ntuser_2kernel_2misc_8c-source.html#l00415">RemoteLogoff()</a>, <a class="el" href="../../d7/d3/icamsg_8c-source.html#l00167">RemoteMessageThread()</a>, <a class="el" href="../../d7/d9/w32_2ntuser_2kernel_2misc_8c-source.html#l00700">RemoteShadowCleanup()</a>, <a class="el" href="../../d7/d9/w32_2ntuser_2kernel_2misc_8c-source.html#l00635">RemoteShadowStart()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01355">RemoveConsole()</a>, <a class="el" href="../../d6/d3/icadis_8c-source.html#l00168">ReplyMessageToTerminalServer()</a>, <a class="el" href="../../d3/d8/uipriv_8c-source.html#l00322">ResetAllPrivileges()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01686">RevalidateConsole()</a>, <a class="el" href="../../d5/d0/hiveini_8c-source.html#l00031">RiInitializeRegistryFromAsciiFile()</a>, <a class="el" href="../../d8/d0/rtlassig_8c-source.html#l00360">RtlAbsoluteToSelfRelativeSD()</a>, <a class="el" href="../../d9/d6/rtl_2remlock_8c-source.html#l00091">RtlAcquireRemoveLockEx()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00515">RtlAcquireResourceExclusive()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00350">RtlAcquireResourceShared()</a>, <a class="el" href="../../d6/d3/rxact_8c-source.html#l01156">RtlAddActionToRXact()</a>, <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00516">RtlAddAtomToAtomTable()</a>, <a class="el" href="../../d3/d4/range_8c-source.html#l00340">RtlAddRange()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00639">RtlAdjustPrivilege()</a>, <a class="el" href="../../d2/d7/rtl_2handle_8c-source.html#l00060">RtlAllocateHandle()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l01316">RtlAllocateHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l02075">RtlAllocateHeapSlowly()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00171">RtlAnsiCharToUnicodeChar()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d6/d3/rxact_8c-source.html#l01240">RtlApplyRXact()</a>, <a class="el" href="../../d6/d3/rxact_8c-source.html#l01380">RtlApplyRXactNoFlush()</a>, <a class="el" href="../../d8/d6/lpcsvr_8c-source.html#l00712">RtlCallbackLpcClient()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01788">RtlCheckForOrphanedCriticalSections()</a>, <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l01257">RtlCheckRegistryKey()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01061">RtlConvertExclusiveToShared()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00851">RtlConvertSharedToExclusive()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01611">RtlConvertSidToUnicodeString()</a>, <a class="el" href="../../d1/d8/uilist_8c-source.html#l00072">RtlConvertUiListToApiList()</a>, <a class="el" href="../../d3/d4/range_8c-source.html#l01552">RtlCopyRangeList()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01260">RtlCreateAndSetSD()</a>, <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00262">RtlCreateAtomTable()</a>, <a class="el" href="../../d6/d6/environ_8c-source.html#l00035">RtlCreateEnvironment()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l00191">RtlCreateHeap()</a>, <a class="el" href="../../d8/d6/lpcsvr_8c-source.html#l00463">RtlCreateLpcServer()</a>, <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00110">RtlCreateProcessParameters()</a>, <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00316">RtlCreateQueryDebugBuffer()</a>, <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l01278">RtlCreateRegistryKey()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l00944">RtlCreateTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l00691">RtlCreateTimerQueue()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00544">RtlCreateUnicodeStringFromAsciiz()</a>, <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00813">RtlCreateUserProcess()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01624">RtlCreateUserSecurityObject()</a>, <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l01241">RtlCreateUserThread()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00204">RtlDebugCreateHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01572">RtlDebugUsageHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01338">RtlDebugZeroHeap()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01860">RtlDefaultNpAcl()</a>, <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00672">RtlDeleteAtomFromAtomTable()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01474">RtlDeleteCriticalSection()</a>, <a class="el" href="../../d3/d4/range_8c-source.html#l01197">RtlDeleteOwnersRanges()</a>, <a class="el" href="../../d3/d4/range_8c-source.html#l01071">RtlDeleteRange()</a>, <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l01299">RtlDeleteRegistryValue()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l01145">RtlDeleteTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l00809">RtlDeleteTimerQueueEx()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l00256">RtlDeregisterWaitEx()</a>, <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00304">RtlDestroyAtomTable()</a>, <a class="el" href="../../d6/d6/environ_8c-source.html#l00147">RtlDestroyEnvironment()</a>, <a class="el" href="../../d2/d7/rtl_2handle_8c-source.html#l00039">RtlDestroyHandleTable()</a>, <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00365">RtlDestroyProcessParameters()</a>, <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00399">RtlDestroyQueryDebugBuffer()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l02519">RtlDnsHostNameToComputerName()</a>, <a class="el" href="../../d6/d0/curdir_8c-source.html#l02033">RtlDoesFileExists_UEx()</a>, <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00344">RtlEmptyAtomTable()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02896">RtlEnumProcessHeaps()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01959">RtlEqualDomainName()</a>, <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l01325">RtlExpandEnvironmentStrings_U()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02132">RtlExtendHeap()</a>, <a class="el" href="../../d1/d7/message_8c-source.html#l00030">RtlFindMessage()</a>, <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l01453">RtlFormatCurrentUserKeyPath()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l02931">RtlFreeHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l03273">RtlFreeHeapSlowly()</a>, <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l01385">RtlFreeUserThreadStack()</a>, <a class="el" href="../../d3/d4/range_8c-source.html#l02124">RtlGetFirstRange()</a>, <a class="el" href="../../d6/d0/curdir_8c-source.html#l00920">RtlGetFullPathName_Ustr()</a>, <a class="el" href="../../d3/d4/range_8c-source.html#l02205">RtlGetLastRange()</a>, <a class="el" href="../../d6/d4/prodtype_8c-source.html#l00030">RtlGetNtProductType()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03446">RtlImpersonateSelf()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01266">RtlInitializeCriticalSectionAndSpinCount()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00247">RtlInitializeResource()</a>, <a class="el" href="../../d6/d3/rxact_8c-source.html#l00341">RtlInitializeRXact()</a>, <a class="el" href="../../d0/d3/cnvint_8c-source.html#l00632">RtlInt64ToUnicodeString()</a>, <a class="el" href="../../d0/d3/cnvint_8c-source.html#l00433">RtlIntegerToUnicodeString()</a>, <a class="el" href="../../d3/d4/range_8c-source.html#l02599">RtlInvertRangeList()</a>, <a class="el" href="../../d3/d4/range_8c-source.html#l01744">RtlIsRangeAvailable()</a>, <a class="el" href="../../d1/d0/base_8c-source.html#l00030">RtlLoadStringOrError()</a>, <a class="el" href="../../d2/d1/time_8c-source.html#l01306">RtlLocalTimeToSystemTime()</a>, <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00611">RtlLookupAtomInAtomTable()</a>, <a class="el" href="../../d6/d5/chartran_8c-source.html#l00490">RtlMBMessageWParamCharToWCS()</a>, <a class="el" href="../../d3/d4/range_8c-source.html#l02450">RtlMergeRangeLists()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l00680">RtlNewInstanceSecurityObject()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l00818">RtlNewSecurityGrantedAccess()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00716">RtlOemStringToCountedUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00439">RtlOemStringToUnicodeString()</a>, <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l01564">RtlOpenCurrentUser()</a>, <a class="el" href="../../d3/d4/range_8c-source.html#l00843">RtlpAddIntersectingRanges()</a>, <a class="el" href="../../d3/d4/range_8c-source.html#l00461">RtlpAddRange()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l05954">RtlpAllocateHeapUsageEntry()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l05225">RtlpAllocateTags()</a>, <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l00679">RtlpAllocDeallocQueryBuffer()</a>, <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l00281">RtlpCallQueryRegistryRoutine()</a>, <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00099">RtlpChangeQueryDebugBufferTarget()</a>, <a class="el" href="../../d6/d0/curdir_8c-source.html#l02341">RtlpCheckRelativeDrive()</a>, <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00260">RtlpCommitQueryDebugInfo()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l07033">RtlpCompareKnownAces()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l07209">RtlpCompareKnownObjectAces()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l06266">RtlpComputeMergedAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l05893">RtlpComputeMergedAcl2()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l07461">RtlpConvertAclToAutoInherit()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l06520">RtlpConvertToAutoInheritSecurityObject()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l04371">RtlpCopyAces()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01412">RtlpCreateCriticalSectionSem()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l08588">RtlpCreateServerAcl()</a>, <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00539">RtlpCreateStack()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l03962">RtlpCreateUnCommittedRange()</a>, <a class="el" href="../../d7/d3/pctohdr_8c-source.html#l00042">RtlPcToFileHeader()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00842">RtlpDebugPageHeapAllocateVM()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00877">RtlpDebugPageHeapCommitVM()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l01997">RtlpDebugPageHeapCreate()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00962">RtlpDebugPageHeapDecommitVM()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00737">RtlpDebugPageHeapRobustProtectVM()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l05527">RtlpDeCommitFreeBlock()</a>, <a class="el" href="../../d3/d4/range_8c-source.html#l01311">RtlpDeleteFromMergedRange()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l05893">RtlpDestroyTags()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l03906">RtlpDphShouldAllocateInPageHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l05024">RtlpExtendHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l04422">RtlpFindAndCommitPages()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03851">RtlpFindWaitThread()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03747">RtlpFireTimers()</a>, <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00783">RtlpFreeStack()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l05722">RtlpGenerateInheritAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l08795">RtlpGetDefaultsSubjectContext()</a>, <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00385">RtlpGetIntegerAtom()</a>, <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l00092">RtlpGetRegistryHandle()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04378">RtlpGetTimeRemaining()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05575">RtlpGetWaitEvent()</a>, <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00722">RtlPinAtomInAtomTable()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l05153">RtlpInheritAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l04716">RtlpInheritAcl2()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05694">RtlpInitializeEventCache()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l04732">RtlpInitializeHeapSegment()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05256">RtlpInitializeTimerThreadPool()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l02751">RtlpInitializeWaitThreadPool()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l01965">RtlpInitializeWorkerThreadPool()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l02370">RtlpIOWorkerThread()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l08362">RtlpIsDuplicateAce()</a>, <a class="el" href="../../d8/d6/lpcsvr_8c-source.html#l00260">RtlpLpcServerCallback()</a>, <a class="el" href="../../d8/d6/lpcsvr_8c-source.html#l00134">RtlpLpcWorkerThread()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l09057">RtlpNewSecurityObject()</a>, <a class="el" href="../../d2/d6/rtl_2registry_8c-source.html#l00465">RtlpNtEnumerateSubKey()</a>, <a class="el" href="../../d2/d6/rtl_2registry_8c-source.html#l00226">RtlpNtQueryValueKey()</a>, <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00493">RtlpOpenImageFile()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03172">RtlpProcessWaitCompletion()</a>, <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00032">RtlpQueryProcessDebugInformationRemote()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l01638">RtlpQueueIOWorkerRequest()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l01506">RtlpQueueWorkerRequest()</a>, <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l00643">RtlpRaiseException()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00258">RtlProtectHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00323">RtlpSerializeHeap()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l10195">RtlpSetSecurityObject()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l01820">RtlpStartIOWorkerThread()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l02677">RtlpStartThread()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l01763">RtlpStartWorkerThread()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01675">RtlpUnWaitCriticalSection()</a>, <a class="el" href="../../d6/d0/curdir_8c-source.html#l00839">RtlpValidateCurrentDirectory()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l02025">RtlpValidateHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00112">RtlpValidateHeapHeaders()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03544">RtlpValidOwnerSubjectContext()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01544">RtlpWaitForCriticalSection()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05503">RtlpWaitForEvent()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l02824">RtlpWaitThread()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l02137">RtlpWorkerThread()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l02104">RtlpWorkerThreadInitializeTimers()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l01872">RtlpWorkerThreadTimerCallback()</a>, <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00760">RtlQueryAtomInAtomTable()</a>, <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00874">RtlQueryAtomsInAtomTable()</a>, <a class="el" href="../../d6/d6/environ_8c-source.html#l00250">RtlQueryEnvironmentVariable_U()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00460">RtlQueryInformationAcl()</a>, <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00660">RtlQueryProcessBackTraceInformation()</a>, <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00469">RtlQueryProcessDebugInformation()</a>, <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00769">RtlQueryProcessHeapInformation()</a>, <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l01049">RtlQueryProcessLockInformation()</a>, <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00630">RtlQueryProcessModuleInformation()</a>, <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l00744">RtlQueryRegistryValues()</a>, <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l01656">RtlQueryTimeZoneInformation()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l00437">RtlQueueWorkItem()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00518">RtlReAllocateHeap()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l00077">RtlRegisterWait()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00680">RtlReleaseResource()</a>, <a class="el" href="../../d3/d5/rtl_2alpha_2context_8c-source.html#l00193">RtlRemoteCall()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00388">RtlRunEncodeUnicodeString()</a>, <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l01811">RtlSetActiveTimeBias()</a>, <a class="el" href="../../d6/d0/curdir_8c-source.html#l00225">RtlSetCurrentDirectory_U()</a>, <a class="el" href="../../d6/d6/environ_8c-source.html#l00173">RtlSetCurrentEnvironment()</a>, <a class="el" href="../../d6/d6/environ_8c-source.html#l00458">RtlSetEnvironmentVariable()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l00600">RtlSetIoCompletionCallback()</a>, <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l01724">RtlSetTimeZoneInformation()</a>, <a class="el" href="../../d8/d6/lpcsvr_8c-source.html#l00552">RtlShutdownLpcServer()</a>, <a class="el" href="../../d2/d1/time_8c-source.html#l01278">RtlSystemTimeToLocalTime()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00246">RtlUnicodeStringToAnsiString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00816">RtlUnicodeStringToCountedOemString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00528">RtlUnicodeStringToOemString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00350">RtlUpcaseUnicodeStringToAnsiString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00927">RtlUpcaseUnicodeStringToCountedOemString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00617">RtlUpcaseUnicodeStringToOemString()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l01058">RtlUpdateTimer()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02976">RtlUsageHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02680">RtlValidateProcessHeaps()</a>, <a class="el" href="../../d1/d5/version_8c-source.html#l00207">RtlVerifyVersionInfo()</a>, <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00580">RtlVolumeDeviceToDosName()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l03714">RtlWalkHeap()</a>, <a class="el" href="../../d6/d5/chartran_8c-source.html#l00361">RtlWCSMessageWParamCharToMB()</a>, <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l01220">RtlWriteRegistryValue()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l03762">RtlZeroHeap()</a>, <a class="el" href="../../d6/d3/rxact_8c-source.html#l01461">RXactpCommit()</a>, <a class="el" href="../../d6/d3/rxact_8c-source.html#l01717">RXactpOpenTargetKey()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l03226">ScrollRegion()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l02704">SeAccessCheckByType()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l00241">SeAssignPrimaryToken()</a>, <a class="el" href="../../d2/d4/seassign_8c-source.html#l00089">SeAssignSecurity()</a>, <a class="el" href="../../d2/d4/seassign_8c-source.html#l00228">SeAssignSecurityEx()</a>, <a class="el" href="../../d2/d4/seassign_8c-source.html#l00529">SeAssignWorldSecurityDescriptor()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02466">SeAuditProcessCreation()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00144">SeCaptureObjectTypeList()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l00953">SeCaptureSecurityQos()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01850">SeCaptureSidAndAttributesArray()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03826">SeCloseObjectAuditAlarm()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01227">SeCopyClientToken()</a>, <a class="el" href="../../d5/d4/seclient_8c-source.html#l00209">SeCreateClientSecurity()</a>, <a class="el" href="../../d5/d4/seclient_8c-source.html#l00712">SeCreateClientSecurityFromSubjectContext()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03892">SeDeleteObjectAuditAlarm()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l00346">SeExchangePrimaryToken()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01634">SeFilterToken()</a>, <a class="el" href="../../d5/d4/seclient_8c-source.html#l00636">SeImpersonateClientEx()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l02867">SeIsChildToken()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l02960">SeIsChildTokenByPointer()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l01010">SeMakeAnonymousLogonToken()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l00536">SeMakeSystemToken()</a>, <a class="el" href="../../d4/d8/ulpc_8h-source.html#l00208">SendRequest()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l01564">SepAccessCheck()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l01050">SepAccessCheckAndAuditAlarm()</a>, <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l01099">SepAdjustGroups()</a>, <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l00819">SepAdjustPrivileges()</a>, <a class="el" href="../../d1/d4/adtlog_8c-source.html#l00504">SepAdtCopyToLsaSharedMemory()</a>, <a class="el" href="../../d0/d4/adtinit_8c-source.html#l00425">SepAdtInitializeAuditingOptions()</a>, <a class="el" href="../../d0/d4/adtinit_8c-source.html#l00117">SepAdtInitializeBounds()</a>, <a class="el" href="../../d0/d4/adtinit_8c-source.html#l00242">SepAdtInitializeCrashOnFail()</a>, <a class="el" href="../../d0/d4/adtinit_8c-source.html#l00329">SepAdtInitializePrivilegeAuditing()</a>, <a class="el" href="../../d1/d4/adtlog_8c-source.html#l00052">SepAdtLogAuditRecord()</a>, <a class="el" href="../../d1/d4/adtlog_8c-source.html#l00153">SepAuditFailed()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l01582">SepClientOpenPipe()</a>, <a class="el" href="../../d5/d4/seclient_8c-source.html#l00062">SepCreateClientSecurity()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00049">SepCreateImpersonationTokenDacl()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l02213">SepCreateToken()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00362">SepDuplicateToken()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01939">SepFilterToken()</a>, <a class="el" href="../../d2/d4/seassign_8c-source.html#l00416">SepInheritAcl()</a>, <a class="el" href="../../d0/d5/seinit_8c-source.html#l00184">SepInitializationPhase1()</a>, <a class="el" href="../../d9/d4/seglobal_8c-source.html#l00651">SepInitSystemDacls()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00294">SepOpenTokenOfThread()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l00773">SepProbeAndCaptureQosData()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00259">SepProbeAndCaptureString_U()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02324">SepQueryNameString()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02400">SepQueryTypeString()</a>, <a class="el" href="../../d1/d9/rmmain_8c-source.html#l00907">SepRmCallLsa()</a>, <a class="el" href="../../d1/d9/rmmain_8c-source.html#l00309">SepRmCommandServerThread()</a>, <a class="el" href="../../d1/d9/rmmain_8c-source.html#l00466">SepRmCommandServerThreadInit()</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00122">SepRmCreateLogonSessionWrkr()</a>, <a class="el" href="../../d3/d9/rmvars_8c-source.html#l00095">SepRmDbInitialization()</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00200">SepRmDeleteLogonSessionWrkr()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l01377">SepServerCreatePipe()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l01520">SepServerDisconnectPipe()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l01482">SepServerImpersonatePipe()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l01443">SepServerListenPipe()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00647">SepServerRevertToSelf()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l01460">SepTokenInitialization()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l01330">SepTransceivePipe()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l01293">SepWritePipe()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00529">SeQueryAuthenticationIdSubjectContext()</a>, <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l01189">SeQueryInformationToken()</a>, <a class="el" href="../../d1/d9/rmmain_8c-source.html#l00060">SeRmInitPhase1()</a>, <a class="el" href="../../d9/d0/userver_8c-source.html#l00037">ServerHandleConnectionRequest()</a>, <a class="el" href="../../d9/d0/userver_8c-source.html#l00173">ServerThread()</a>, <a class="el" href="../../d7/d3/msgbox_8c-source.html#l00178">ServiceMessageBox()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l01327">SeSubProcessToken()</a>, <a class="el" href="../../d9/d3/ntcon_2client_2getset_8c-source.html#l01356">SetConsoleCP()</a>, <a class="el" href="../../d7/d3/client_2private_8c-source.html#l00225">SetConsoleDisplayMode()</a>, <a class="el" href="../../d3/d0/client_2cmdline_8c-source.html#l01313">SetConsoleInputExeNameA()</a>, <a class="el" href="../../d9/d3/ntcon_2client_2getset_8c-source.html#l01501">SetConsoleOutputCP()</a>, <a class="el" href="../../d7/d3/client_2private_8c-source.html#l00737">SetConsolePalette()</a>, <a class="el" href="../../d7/d3/client_2private_8c-source.html#l00191">SetConsolePaletteInternal()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l02136">SetCurrentCommandLine()</a>, <a class="el" href="../../d3/d9/tenv_8c-source.html#l00046">SetEnvironment()</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l01260">SetFont()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l06357">SetInformationProcess()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l00516">SetInputBufferSize()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l03336">SetRAMFont()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l03175">SetRAMFontCodePage()</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l01077">SetScreenBufferFont()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00955">SetUpConsole()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l01868">SetUserObjectSecurity()</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00908">SeUnregisterLogonSessionTerminatedRoutine()</a>, <a class="el" href="../../d6/d3/icadis_8c-source.html#l00228">ShadowHotkey()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00551">SmbTraceStart()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02020">SmbTraceThreadEntry()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02425">SmbTraceToClient()</a>, <a class="el" href="../../d5/d4/w32_2ntuser_2server_2debug_8c-source.html#l00028">SrvActivateDebugger()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l00608">SrvAddConsoleAlias()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01537">SrvAllocConsole()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02997">SrvCloseHandle()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00373">SrvConsoleMenuControl()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01346">SrvConsoleNotifyLastClose()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l01607">SrvCreateConsoleScreenBuffer()</a>, <a class="el" href="../../d2/d3/instdev_8c-source.html#l00037">SrvDeviceEvent()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02603">SrvDuplicateHandle()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l01393">SrvExpungeConsoleCommandHistory()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l01568">SrvFillConsoleOutput()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00524">SrvFlushConsoleInputBuffer()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01608">SrvFreeConsole()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00444">SrvGenerateConsoleCtrlEvent()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l00731">SrvGetConsoleAlias()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l00903">SrvGetConsoleAliases()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l00834">SrvGetConsoleAliasesLength()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l01029">SrvGetConsoleAliasExes()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l00994">SrvGetConsoleAliasExesLength()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l01500">SrvGetConsoleCommandHistory()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l01458">SrvGetConsoleCommandHistoryLength()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l01359">SrvGetConsoleCP()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00315">SrvGetConsoleCurrentFont()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00179">SrvGetConsoleCursorInfo()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l02355">SrvGetConsoleDisplayMode()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00233">SrvGetConsoleFontInfo()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00278">SrvGetConsoleFontSize()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l02232">SrvGetConsoleHardwareState()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l00556">SrvGetConsoleInput()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l01385">SrvGetConsoleKeyboardLayoutName()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l02680">SrvGetConsoleLangId()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00033">SrvGetConsoleMode()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00211">SrvGetConsoleMouseInfo()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00082">SrvGetConsoleNumberOfFonts()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00108">SrvGetConsoleNumberOfInputEvents()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00141">SrvGetConsoleScreenBufferInfo()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l04879">SrvGetConsoleTitle()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l01424">SrvGetConsoleWindow()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02747">SrvGetHandleInformation()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00555">SrvGetLargestConsoleWindowSize()</a>, <a class="el" href="../../d6/d0/w32_2ntcon_2server_2bitmap_8c-source.html#l00168">SrvInvalidateBitMapRect()</a>, <a class="el" href="../../d1/d6/server_2server_8c-source.html#l01121">SrvLogon()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l00080">SrvOpenConsole()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02263">SrvReadConsole()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l01207">SrvReadConsoleOutput()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l01448">SrvReadConsoleOutputString()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01094">SrvRegisterConsoleVDM()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00882">SrvScrollConsoleScreenBuffer()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00492">SrvSetConsoleActiveScreenBuffer()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l01575">SrvSetConsoleCommandHistoryMode()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l01229">SrvSetConsoleCP()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00213">SrvSetConsoleCursor()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00738">SrvSetConsoleCursorInfo()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00662">SrvSetConsoleCursorPosition()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00853">SrvSetConsoleDisplayMode()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l01118">SrvSetConsoleFont()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l02280">SrvSetConsoleHardwareState()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l01164">SrvSetConsoleIcon()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l02423">SrvSetConsoleKeyShortcuts()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l02376">SrvSetConsoleMenuClose()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00354">SrvSetConsoleMode()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l01424">SrvSetConsoleNumberOfCommands()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00432">SrvSetConsolePalette()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00608">SrvSetConsoleScreenBufferSize()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l01078">SrvSetConsoleTextAttribute()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l04929">SrvSetConsoleTitle()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00773">SrvSetConsoleWindowInfo()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02794">SrvSetHandleInformation()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00298">SrvShowConsoleCursor()</a>, <a class="el" href="../../d3/d4/srvvdm_8c-source.html#l00024">SrvVDMConsoleOperation()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01582">SrvVerifyConsoleIoHandle()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02463">SrvWriteConsole()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l00730">SrvWriteConsoleInput()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l01284">SrvWriteConsoleOutput()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l01508">SrvWriteConsoleOutputString()</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00191">SubstituteDeviceName()</a>, <a class="el" href="../../d4/d1/ofsmisc_8c-source.html#l00036">SynchronousNtFsControlFile()</a>, <a class="el" href="../../d3/d7/api_8c-source.html#l00279">TerminalServerRequestThread()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l04420">TerminateConsole()</a>, <a class="el" href="../../d4/d5/tseum_8c-source.html#l00502">TestAccessCheck()</a>, <a class="el" href="../../d4/d5/tseum_8c-source.html#l00282">TestAddAce()</a>, <a class="el" href="../../d2/d5/tse_8c-source.html#l00360">TestAssignSecurity()</a>, <a class="el" href="../../d2/d5/tse_8c-source.html#l00296">TestCaptureSecurityDescriptor()</a>, <a class="el" href="../../d8/d8/uob_8c-source.html#l00624">TestChild()</a>, <a class="el" href="../../d4/d5/tseum_8c-source.html#l00134">TestCreateAcl()</a>, <a class="el" href="../../d2/d5/tse_8c-source.html#l00205">TestDefaultObjectMethod()</a>, <a class="el" href="../../d4/d5/tseum_8c-source.html#l00402">TestDeleteAce()</a>, <a class="el" href="../../d4/d5/tseum_8c-source.html#l00451">TestGetAce()</a>, <a class="el" href="../../d8/d8/uob_8c-source.html#l00232">TestParent()</a>, <a class="el" href="../../d4/d5/tseum_8c-source.html#l00184">TestQueryInformationAcl()</a>, <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00801">TestSeAclRtl()</a>, <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00503">TestSeSecurityDescriptor()</a>, <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00042">TestSeSid()</a>, <a class="el" href="../../d4/d5/tseum_8c-source.html#l00239">TestSetInformationAcl()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l04885">TestTokenAdjustGroups()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l03929">TestTokenAdjustPrivileges()</a>, <a class="el" href="../../d2/d5/tse_8c-source.html#l00131">TestTokenCopy()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l07982">TestTokenImpersonation()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00167">TestTokenInitialize()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l01276">TestTokenOpenPrimary()</a>, <a class="el" href="../../d9/d6/udbgk_8c-source.html#l00049">ThreadThatExcepts()</a>, <a class="el" href="../../d9/d6/udbgk_8c-source.html#l00030">ThreadThatExits()</a>, <a class="el" href="../../d9/d6/udbgk_8c-source.html#l00069">UdbgTest1()</a>, <a class="el" href="../../d9/d6/udbgk_8c-source.html#l00280">UdbgTest2()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00108">UdfCommonCreate()</a>, <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00069">UdfCommonDevControl()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00255">UdfCommonDirControl()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00283">UdfCommonFsControl()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00046">UdfCommonLockControl()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00075">UdfCommonPnp()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00156">UdfCommonQueryInfo()</a>, <a class="el" href="../../d8/d5/volinfo_8c-source.html#l00082">UdfCommonQueryVolInfo()</a>, <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00385">UdfCommonSetInfo()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01955">UdfCompleteFcbOpen()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l00804">UdfCompletePcb()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00474">UdfCreateUserMdl()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03817">UdfDetermineVolumeBounding()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00966">UdfDismountVolume()</a>, <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00337">UdfDvdReadStructure()</a>, <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00227">UdfDvdTransferKey()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00448">UdfExceptionFilter()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03307">UdfFindAnchorVolumeDescriptor()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02558">UdfFindFileSetDescriptor()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02832">UdfFindVolumeDescriptors()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>, <a class="el" href="../../d1/d7/fspdisp_8c-source.html#l00038">UdfFspDispatch()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01003">UdfInitializeEnumeration()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l00367">UdfInitializePcb()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01271">UdfInvalidateVolumes()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01406">UdfLoadSparingTables()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00780">UdfLockVolume()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00621">UdfLockVolumeInternal()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01444">UdfMountVolume()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00201">UdfNonCachedRead()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01522">UdfOpenExistingFcb()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01244">UdfOpenObjectByFileId()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01632">UdfOpenObjectFromDirContext()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00470">UdfOplockRequest()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00573">UdfPerformDevIoCtrl()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00042">UdfPerformVerify()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00632">UdfPnpCancelRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00194">UdfPnpQueryRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00350">UdfPnpRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00500">UdfPnpSurpriseRemove()</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00417">UdfPurgeVolume()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l01232">UdfQueryAlternateNameInfo()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00334">UdfQueryDirectory()</a>, <a class="el" href="../../d8/d5/volinfo_8c-source.html#l00421">UdfQueryFsAttributeInfo()</a>, <a class="el" href="../../d8/d5/volinfo_8c-source.html#l00212">UdfQueryFsVolumeInfo()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l01158">UdfQueryNameInfo()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00634">UdfQueueClose()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00685">UdfReadSectors()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03457">UdfRecognizeVolume()</a>, <a class="el" href="../../d5/d7/udfs__rec_8c-source.html#l00060">UdfsRecFsControl()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00877">UdfUnlockVolume()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00732">UdfUnlockVolumeInternal()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01131">UdfUpcaseName()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00363">UdfUserFsctl()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00760">UdfVerifyFcbOperation()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00603">UdfVerifyVcb()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02043">UdfVerifyVolume()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>, <a class="el" href="../../d6/d8/w32_2ntuser_2kernel_2pnp_8c-source.html#l00981">UnregisterForDeviceChangeNotifications()</a>, <a class="el" href="../../d2/d9/w32_2ntuser_2kernel_2atom_8c-source.html#l00035">UserAddAtom()</a>, <a class="el" href="../../d1/d0/base_8c-source.html#l00102">UserBeep()</a>, <a class="el" href="../../d1/d6/server_2server_8c-source.html#l00357">UserClientConnect()</a>, <a class="el" href="../../d7/d7/clinit_8c-source.html#l00059">UserClientDllInitialize()</a>, <a class="el" href="../../d3/d9/server_2exitwin_8c-source.html#l00219">UserClientShutdown()</a>, <a class="el" href="../../d3/d8/w32_2ntuser_2kernel_2heap_8c-source.html#l00015">UserCommitDesktopMemory()</a>, <a class="el" href="../../d3/d8/w32_2ntuser_2kernel_2heap_8c-source.html#l00133">UserCommitSharedMemory()</a>, <a class="el" href="../../d3/d8/w32_2ntuser_2kernel_2heap_8c-source.html#l00189">UserCreateHeap()</a>, <a class="el" href="../../d2/d9/w32_2ntuser_2kernel_2atom_8c-source.html#l00084">UserDeleteAtom()</a>, <a class="el" href="../../d2/d9/w32_2ntuser_2kernel_2atom_8c-source.html#l00062">UserFindAtom()</a>, <a class="el" href="../../d2/d9/w32_2ntuser_2kernel_2atom_8c-source.html#l00101">UserGetAtomName()</a>, <a class="el" href="../../d0/d6/kernel_2server_8c-source.html#l02004">UserInitialize()</a>, <a class="el" href="../../d4/d7/job_8c-source.html#l00026">UserJobCallout()</a>, <a class="el" href="../../d8/d1/power_8c-source.html#l00455">UserPowerEventCallout()</a>, <a class="el" href="../../d8/d1/power_8c-source.html#l00608">UserPowerStateCallout()</a>, <a class="el" href="../../d2/d9/w32_2ntuser_2kernel_2atom_8c-source.html#l00018">UserRtlCreateAtomTable()</a>, <a class="el" href="../../d1/d6/server_2server_8c-source.html#l00192">UserServerDllInitialization()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l00404">UserSetConsoleProcessWindowStation()</a>, <a class="el" href="../../d0/d6/kernel_2server_8c-source.html#l02595">UserThreadCallout()</a>, <a class="el" href="../../d8/d2/validate_8c-source.html#l00092">ValidateHdesk()</a>, <a class="el" href="../../d8/d2/validate_8c-source.html#l00046">ValidateHwinsta()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01132">vCleanConvertedTTFs()</a>, <a class="el" href="../../d0/d3/ke_2i386_2vdm_8c-source.html#l00882">VdmCallStringIoHandler()</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00477">VdmDispatchInterrupts()</a>, <a class="el" href="../../d0/d3/ke_2i386_2vdm_8c-source.html#l00535">VdmDispatchIoToHandler()</a>, <a class="el" href="../../d1/d4/vdmnpx_8c-source.html#l00054">VdmDispatchIRQ13()</a>, <a class="el" href="../../d7/d3/vdmfault_8c-source.html#l00036">VdmDispatchPageFault()</a>, <a class="el" href="../../d0/d3/ke_2i386_2vdm_8c-source.html#l00777">VdmDispatchStringIoToHandler()</a>, <a class="el" href="../../d5/d4/vdmprint_8c-source.html#l00236">VdmFlushPrinterWriteData()</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01235">VdmpDelayInterrupt()</a>, <a class="el" href="../../d8/d3/vdminit_8c-source.html#l00019">VdmpInitialize()</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01922">VdmpIsThreadTerminating()</a>, <a class="el" href="../../d5/d4/vdmprint_8c-source.html#l00388">VdmpPrinterDirectIoClose()</a>, <a class="el" href="../../d5/d4/vdmprint_8c-source.html#l00295">VdmpPrinterInitialize()</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00232">VdmpQueueIntApcRoutine()</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00146">VdmpQueueInterrupt()</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00408">VdmpQueueIntNormalRoutine()</a>, <a class="el" href="../../d5/d4/vdmprint_8c-source.html#l00042">VdmPrinterStatus()</a>, <a class="el" href="../../d5/d4/vdmprint_8c-source.html#l00177">VdmPrinterWriteData()</a>, <a class="el" href="../../d8/d6/strtexec_8c-source.html#l00040">VdmpStartExecution()</a>, <a class="el" href="../../d4/d3/vdm_2vdm_8c-source.html#l00087">VdmQueryDirectoryFile()</a>, <a class="el" href="../../d7/d4/vdmtrace_8c-source.html#l00037">VdmTraceEvent()</a>, <a class="el" href="../../d0/d9/urtl_8c-source.html#l00080">VectorTest()</a>, <a class="el" href="../../d8/d1/power_8c-source.html#l00845">VideoPortCallout()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00138">vProcessFontEntry()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00577">vSweepFonts()</a>, <a class="el" href="../../d3/d7/api_8c-source.html#l01012">W32WinStationBroadcastSystemMessage()</a>, <a class="el" href="../../d3/d7/api_8c-source.html#l00504">W32WinStationDoConnect()</a>, <a class="el" href="../../d3/d7/api_8c-source.html#l00692">W32WinStationDoDisconnect()</a>, <a class="el" href="../../d3/d7/api_8c-source.html#l00996">W32WinStationDoMessage()</a>, <a class="el" href="../../d3/d7/api_8c-source.html#l00718">W32WinStationDoReconnect()</a>, <a class="el" href="../../d3/d7/api_8c-source.html#l00790">W32WinStationExitWindows()</a>, <a class="el" href="../../d3/d7/api_8c-source.html#l00979">W32WinStationNtSecurity()</a>, <a class="el" href="../../d3/d7/api_8c-source.html#l01152">W32WinStationPassthruDisable()</a>, <a class="el" href="../../d3/d7/api_8c-source.html#l01135">W32WinStationPassthruEnable()</a>, <a class="el" href="../../d3/d7/api_8c-source.html#l01028">W32WinStationSendWindowMessage()</a>, <a class="el" href="../../d3/d7/api_8c-source.html#l01116">W32WinStationShadowCleanup()</a>, <a class="el" href="../../d3/d7/api_8c-source.html#l01063">W32WinStationShadowSetup()</a>, <a class="el" href="../../d3/d7/api_8c-source.html#l01080">W32WinStationShadowStart()</a>, <a class="el" href="../../d3/d7/api_8c-source.html#l01099">W32WinStationShadowStop()</a>, <a class="el" href="../../d3/d7/api_8c-source.html#l00818">W32WinStationTerminate()</a>, <a class="el" href="../../d3/d7/api_8c-source.html#l01045">W32WinStationThinwireStats()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l01434">WaitForInputIdle()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l05671">WaitOnPseudoEvent()</a>, <a class="el" href="../../d5/d3/command_8c-source.html#l00035">Win32CommandChannelThread()</a>, <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l00773">Win32KDriverUnload()</a>, <a class="el" href="../../d0/d6/kernel_2server_8c-source.html#l02249">Win32UserInitialize()</a>, <a class="el" href="../../d2/d9/client_2help_8c-source.html#l01116">WinHelpW()</a>, <a class="el" href="../../d3/d7/api_8c-source.html#l00212">WinStationAPIInit()</a>, <a class="el" href="../../d3/d9/server_2exitwin_8c-source.html#l01791">WowExitTask()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l01095">WriteBuffer()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02529">WriteConsoleWaitRoutine()</a>, <a class="el" href="../../d1/d2/__stream_8h-source.html#l00046">WWSB_AdjustCursorPosition()</a>, <a class="el" href="../../d1/d2/__stream_8h-source.html#l01020">WWSB_DoSrvWriteConsole()</a>, <a class="el" href="../../d1/d2/__stream_8h-source.html#l00809">WWSB_DoWriteConsole()</a>, <a class="el" href="../../d1/d2/__stream_8h-source.html#l00203">WWSB_WriteChars()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l00190">xHalExamineMBR()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l00382">xHalGetPartialGeometry()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l01243">xHalIoAssignDriveLetters()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l03486">xHalIoClearPartitionTable()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l01739">xHalIoReadPartitionTable()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l02485">xHalIoSetPartitionInformation()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l02879">xHalIoWritePartitionTable()</a>, <a class="el" href="../../d2/d9/csrinit_8c-source.html#l00329">xProtectHandle()</a>, <a class="el" href="../../d2/d4/w32_2ntuser_2kernel_2debug_8c-source.html#l00032">xxxActivateDebugger()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l01101">xxxAllowSetForegroundWindow()</a>, <a class="el" href="../../d9/d6/menudd_8c-source.html#l00024">xxxClientLoadOLE()</a>, <a class="el" href="../../d9/d6/menudd_8c-source.html#l00044">xxxClientRegisterDragDrop()</a>, <a class="el" href="../../d9/d6/menudd_8c-source.html#l00053">xxxClientRevokeDragDrop()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l04332">xxxCloseDesktop()</a>, <a class="el" href="../../d3/d6/service_8c-source.html#l00025">xxxConnectService()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l06445">xxxConsoleControl()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l01797">xxxCreateDesktop()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l01343">xxxCreateDesktop2()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l01654">xxxCreateDisconnectDesktop()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l01501">xxxCreateThreadInfo()</a>, <a class="el" href="../../d9/d7/winsta_8c-source.html#l00243">xxxCreateWindowStation()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l04211">xxxGetThreadDesktop()</a>, <a class="el" href="../../d9/d3/w32_2ntuser_2kernel_2random_8c-source.html#l00276">xxxHardErrorControl()</a>, <a class="el" href="../../d0/d4/srvhook_8c-source.html#l00028">xxxHkCallHook()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l00140">xxxInitInput()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l04874">xxxInitProcessInfo()</a>, <a class="el" href="../../d9/d7/winsta_8c-source.html#l00026">xxxInitTerminal()</a>, <a class="el" href="../../d5/d8/minmax_8c-source.html#l01329">xxxMinMaximize()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l04271">xxxMsgWaitForMultipleObjects()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l03265">xxxOpenDesktop()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l05481">xxxPollAndWaitForSingleObject()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l05901">xxxQueryInformationThread()</a>, <a class="el" href="../../d6/d8/w32_2ntuser_2kernel_2pnp_8c-source.html#l00639">xxxRegisterForDeviceClassNotifications()</a>, <a class="el" href="../../d7/d9/w32_2ntuser_2kernel_2misc_8c-source.html#l00188">xxxRemoteDisconnect()</a>, <a class="el" href="../../d7/d9/w32_2ntuser_2kernel_2misc_8c-source.html#l00273">xxxRemoteReconnect()</a>, <a class="el" href="../../d7/d9/w32_2ntuser_2kernel_2misc_8c-source.html#l00606">xxxRemoteShadowSetup()</a>, <a class="el" href="../../d7/d9/w32_2ntuser_2kernel_2misc_8c-source.html#l00674">xxxRemoteShadowStop()</a>, <a class="el" href="../../d7/d9/w32_2ntuser_2kernel_2misc_8c-source.html#l00446">xxxRemoteStopScreenUpdates()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l04821">xxxResolveDesktop()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l04588">xxxResolveDesktopForWOW()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l05804">xxxRestoreCsrssThreadDesktop()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00609">xxxSendMessageEx()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l05713">xxxSetCsrssThreadDesktop()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l06114">xxxSetInformationThread()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l00120">xxxSetProcessInitState()</a>, <a class="el" href="../../d9/d7/winsta_8c-source.html#l01077">xxxSetProcessWindowStation()</a>, <a class="el" href="../../d7/d8/taskman_8c-source.html#l00252">xxxSleepTask()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l04382">xxxSleepThread()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l03358">xxxSwitchDesktop()</a>, <a class="el" href="../../d9/d2/ntuser_2kernel_2access_8c-source.html#l02314">xxxUpdatePerUserAccessPackSettings()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l04137">xxxUserDuplicateObject()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l00341">xxxUserNotifyConsoleApplication()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l00445">xxxUserNotifyProcessCreate()</a>, <a class="el" href="../../d8/d1/power_8c-source.html#l00274">xxxUserPowerEventCalloutWorker()</a>, <a class="el" href="../../d8/d1/power_8c-source.html#l00481">xxxUserPowerStateCalloutWorker()</a>, <a class="el" href="../../d0/d6/kernel_2server_8c-source.html#l02882">xxxUserProcessCallout()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l05310">xxxWaitForInputIdle()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00655">ZwDeleteFile()</a>, and <a class="el" href="../../d7/d2/queue_8c-source.html#l01147">zzzInitTask()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a145" doxytag="iop.h::VOID" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef VOID           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">FASTCALL *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PIO_COMPLETE_REQUEST</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d3/client_2ddetrack_8c-source.html#l00185">_ClientCopyDDEIn2()</a>, <a class="el" href="../../d7/d8/rtl_2wow_8c-source.html#l00893">_ClientToScreen()</a>, <a class="el" href="../../d9/d4/debug3_8c-source.html#l00041">_fptrap()</a>, <a class="el" href="../../d7/d8/rtl_2wow_8c-source.html#l00924">_GetClientRect()</a>, <a class="el" href="../../d7/d8/rtl_2wow_8c-source.html#l00967">_GetWindowRect()</a>, <a class="el" href="../../d3/d0/fareast_8c-source.html#l00238">_InitializeImmEntryTable()</a>, <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l01568">_LoadCursorsAndIcons()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02776">_QueryUserHandles()</a>, <a class="el" href="../../d5/d4/rare_8c-source.html#l03768">_ResetDblClk()</a>, <a class="el" href="../../d7/d8/rtl_2wow_8c-source.html#l00995">_ScreenToClient()</a>, <a class="el" href="../../d5/d4/rare_8c-source.html#l00264">_SetRipFlags()</a>, <a class="el" href="../../d0/d7/w32_2ntuser_2kernel_2cleanup_8c-source.html#l00218">_WOWCleanup()</a>, <a class="el" href="../../d0/d7/w32_2ntuser_2kernel_2cleanup_8c-source.html#l00099">_WOWModuleUnload()</a>, <a class="el" href="../../d1/d0/xact_8c-source.html#l00517">AbandonTransaction()</a>, <a class="el" href="../../d9/d2/ntuser_2kernel_2access_8c-source.html#l02289">AccessTimeOutReset()</a>, <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00136">AddHmodDependency()</a>, <a class="el" href="../../d2/d9/imehotky_8c-source.html#l00237">AddImeHotKey()</a>, <a class="el" href="../../d7/d1/kbdlyout_8c-source.html#l01140">AdjustPushStateForKL()</a>, <a class="el" href="../../d4/d7/handles_8c-source.html#l00263">ApplyFunctionToObjects()</a>, <a class="el" href="../../d4/d7/handles_8c-source.html#l00336">BestSetLastDDEMLError()</a>, <a class="el" href="../../d9/d1/mngray_8c-source.html#l00448">BltColor()</a>, <a class="el" href="../../d2/d4/caption_8c-source.html#l00401">BltMe4Times()</a>, <a class="el" href="../../d8/d0/ntuser_2kernel_2cursor_8c-source.html#l00299">BoundCursor()</a>, <a class="el" href="../../d9/d2/ntuser_2kernel_2access_8c-source.html#l01973">CalculateMouseTable()</a>, <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l05671">CancelInputState()</a>, <a class="el" href="../../d5/d4/caret_8c-source.html#l00454">CaretBlinkProc()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02070">CcDeallocateVacbLevel()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l00116">CcPinFileData()</a>, <a class="el" href="../../d8/d4/mdlsup_8c-source.html#l00466">CcPrepareMdlWrite()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l02331">CcPurgeCacheSection()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l02563">CcUnmapAndPurge()</a>, <a class="el" href="../../d8/d2/validate_8c-source.html#l00887">ChangeAcquireResourceType()</a>, <a class="el" href="../../d5/d8/clres_8c-source.html#l03203">ChangeDibColors()</a>, <a class="el" href="../../d7/d1/kbdlyout_8c-source.html#l00982">ChangeForegroundKeyboardTable()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l01771">ChangeMemberState()</a>, <a class="el" href="../../d1/d9/imefull_8c-source.html#l00208">CharHandlerFromConsole()</a>, <a class="el" href="../../d1/d9/imefull_8c-source.html#l00281">CharHandlerToConsole()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l01059">CheckAppStarting()</a>, <a class="el" href="../../d0/d7/kernel_2winmgr_8c-source.html#l00769">CheckPlacementBounds()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l04516">CheckValidLayoutName()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l00986">CheckWHFBits()</a>, <a class="el" href="../../d3/d6/class_8c-source.html#l00193">ClassFree()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l01761">CleanupDirtyDesktops()</a>, <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l00565">CleanupGDI()</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00623">CleanUpInstances()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l02087">CleanupResources()</a>, <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00057">ClearHungFlag()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l04700">ClearWakeBit()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l05223">ClearWakeMask()</a>, <a class="el" href="../../d6/d9/immhotky_8c-source.html#l00229">CliGetPreloadKeyboardLayouts()</a>, <a class="el" href="../../d6/d9/immhotky_8c-source.html#l00129">CliImmInitializeHotKeys()</a>, <a class="el" href="../../d6/d9/immhotky_8c-source.html#l00197">CliSetDefaultImeHotKeys()</a>, <a class="el" href="../../d6/d8/w32_2ntuser_2kernel_2pnp_8c-source.html#l00885">CloseDevice()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l07298">CloseProtectedHandle()</a>, <a class="el" href="../../d3/d7/swp_8c-source.html#l05495">ClrFTrueVis()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l02154">CommonCreateWindowStation()</a>, <a class="el" href="../../d6/d3/server_2msgbeep_8c-source.html#l00025">ConsolePlaySound()</a>, <a class="el" href="../../d7/d4/profassoc_8cpp-source.html#l00107">CProfileAssociationPage::ConstructAssociations()</a>, <a class="el" href="../../d7/d8/clwinnls_8c-source.html#l00209">ConvertImeProWtoA()</a>, <a class="el" href="../../d9/d3/sprite_8c-source.html#l00104">ConvertRedirectionDCs()</a>, <a class="el" href="../../d4/d4/ssend_8c-source.html#l00922">CopyOutputString()</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l00341">CreateSpb()</a>, <a class="el" href="../../d9/d9/badapp_8c-source.html#l00054">CtxBadAppDelay()</a>, <a class="el" href="../../d8/d0/ntuser_2kernel_2cursor_8c-source.html#l00154">DecCursorLevel()</a>, <a class="el" href="../../d0/d2/paint_8c-source.html#l01272">DecPaintCount()</a>, <a class="el" href="../../d9/d2/dc_8c-source.html#l00030">DecrementFreeDCECount()</a>, <a class="el" href="../../d9/d3/sprite_8c-source.html#l00037">DecrementRedirectedCount()</a>, <a class="el" href="../../d5/d1/timers_8c-source.html#l00644">DecTimerCount()</a>, <a class="el" href="../../d3/d7/swp_8c-source.html#l05156">DecVisWindows()</a>, <a class="el" href="../../d9/d2/dc_8c-source.html#l01596">DelayedDestroyCacheDC()</a>, <a class="el" href="../../d9/d2/dc_8c-source.html#l00549">DeleteHrgnClip()</a>, <a class="el" href="../../d3/d1/util_8c-source.html#l00123">DeleteLinkCount()</a>, <a class="el" href="../../d0/d2/paint_8c-source.html#l00132">DeleteMaybeSpecialRgn()</a>, <a class="el" href="../../d9/d3/sprite_8c-source.html#l00194">DeleteRedirectionBitmap()</a>, <a class="el" href="../../d3/d6/class_8c-source.html#l01735">DereferenceClass()</a>, <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l00528">DestroyBitmap()</a>, <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l00518">DestroyBrush()</a>, <a class="el" href="../../d6/d7/sftkbdc1_8c-source.html#l00410">DestroyC1Window()</a>, <a class="el" href="../../d5/d7/createw_8c-source.html#l02923">DestroyCacheDCEntries()</a>, <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l00538">DestroyDC()</a>, <a class="el" href="../../d8/d3/loadbits_8c-source.html#l00138">DestroyEmptyCursorObject()</a>, <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l00548">DestroyFont()</a>, <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l00696">DestroyHandleTableObjects()</a>, <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00464">DestroyImeModeSaver()</a>, <a class="el" href="../../d0/d9/imectl_8c-source.html#l01157">DestroyIMEUI()</a>, <a class="el" href="../../d7/d1/kbdlyout_8c-source.html#l01688">DestroyKL()</a>, <a class="el" href="../../d3/d6/class_8c-source.html#l01768">DestroyProcessesClasses()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02511">DestroyProcessesObjects()</a>, <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l00508">DestroyRegion()</a>, <a class="el" href="../../d4/d1/hotkeys_8c-source.html#l00056">DestroyThreadsHotKeys()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l03128">DestroyThreadsMessages()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02284">DestroyThreadsObjects()</a>, <a class="el" href="../../d5/d1/timers_8c-source.html#l00472">DestroyThreadsTimers()</a>, <a class="el" href="../../d4/d1/hotkeys_8c-source.html#l00093">DestroyWindowsHotKeys()</a>, <a class="el" href="../../d9/d7/winsta_8c-source.html#l00830">DestroyWindowStation()</a>, <a class="el" href="../../d5/d1/timers_8c-source.html#l00504">DestroyWindowsTimers()</a>, <a class="el" href="../../d8/d4/profassoc_8h-source.html#l00065">CProfileAssociationPage::DeviceListChanged()</a>, <a class="el" href="../../d7/d8/taskman_8c-source.html#l00594">DirectedScheduleTask()</a>, <a class="el" href="../../d8/d7/proppage_8h-source.html#l00065">CPropertyPage::DisableApplyButton()</a>, <a class="el" href="../../d7/d4/connect_8c-source.html#l00759">DisconnectConv()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02687">DisownClipboard()</a>, <a class="el" href="../../d8/d3/perf_8c-source.html#l00170">DoClientOutStuff()</a>, <a class="el" href="../../d2/d2/dtbitmap_8c-source.html#l00430">DoHTColorAdjust()</a>, <a class="el" href="../../d0/d2/paint_8c-source.html#l00972">DoQueuedSyncPaint()</a>, <a class="el" href="../../d2/d4/caption_8c-source.html#l00462">DrawCaptionIcon()</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l00674">DrawIconCallBack()</a>, <a class="el" href="../../d0/d1/rtl_2draw_8c-source.html#l01125">DrawPushButton()</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l00538">DrawSwitchWndHilite()</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l01467">DumpAllocatedPool()</a>, <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00714">DumpDDEMessage()</a>, <a class="el" href="../../d0/d9/urtl_8c-source.html#l00027">DumpIt()</a>, <a class="el" href="../../d6/d3/edecrare_8c-source.html#l01037">ECEnableDisableIME()</a>, <a class="el" href="../../d6/d3/edecrare_8c-source.html#l01150">ECImmSetCompositionFont()</a>, <a class="el" href="../../d6/d3/edecrare_8c-source.html#l01085">ECImmSetCompositionWindow()</a>, <a class="el" href="../../d6/d3/edecrare_8c-source.html#l01183">ECInitInsert()</a>, <a class="el" href="../../d8/d7/proppage_8h-source.html#l00061">CPropertyPage::EnableApplyButton()</a>, <a class="el" href="../../d6/d8/w32_2ntuser_2kernel_2pnp_8c-source.html#l00142">EnterMediaCrit()</a>, <a class="el" href="../../d8/d1/power_8c-source.html#l00038">EnterPowerCrit()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l05343">EnterWowCritSect()</a>, <a class="el" href="../../d2/d9/tdisp_8c-source.html#l00009">ErrorExit()</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00413">ExAllocatePool()</a>, <a class="el" href="../../d1/d2/utxcpt2_8c-source.html#l00009">ExceptionTest()</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00970">ExFreePool()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00146">ExLockHandleTableExclusive()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00114">ExLockHandleTableShared()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00209">ExUnlockHandleTableExclusive()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00178">ExUnlockHandleTableShared()</a>, <a class="el" href="../../d3/d0/fareast_8c-source.html#l00022">fakeImm_v1()</a>, <a class="el" href="../../d3/d0/fareast_8c-source.html#l00033">fakeImm_v2()</a>, <a class="el" href="../../d3/d0/fareast_8c-source.html#l00064">fakeImm_wv1()</a>, <a class="el" href="../../d6/d7/crecv_8c-source.html#l00107">FixupCallbackPointers()</a>, <a class="el" href="../../d1/d8/dlgbegin_8c-source.html#l00254">FixupDlgFaceName()</a>, <a class="el" href="../../d9/d2/ntuser_2kernel_2access_8c-source.html#l00201">FKActivationTimer()</a>, <a class="el" href="../../d9/d2/ntuser_2kernel_2access_8c-source.html#l00341">FKBounceKeyTimer()</a>, <a class="el" href="../../d0/d9/imectl_8c-source.html#l01296">FocusSetIMCContext()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02779">ForceEmptyClipboard()</a>, <a class="el" href="../../d0/d8/propvar_8h-source.html#l00232">CBufferAllocator::Free()</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l01252">FreeAllSpbs()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l02193">FreeCachedQueues()</a>, <a class="el" href="../../d7/d4/connect_8c-source.html#l01354">FreeConversationResources()</a>, <a class="el" href="../../d6/d3/kernel_2ddetrack_8c-source.html#l02042">FreeDdeConv()</a>, <a class="el" href="../../d1/d8/hdata_8c-source.html#l00491">FreeDDEData()</a>, <a class="el" href="../../d6/d3/kernel_2ddetrack_8c-source.html#l01919">FreeDDEHandle()</a>, <a class="el" href="../../d6/d3/kernel_2ddetrack_8c-source.html#l02285">FreeDdeXact()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l02535">FreeDesktop()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01976">FreeHook()</a>, <a class="el" href="../../d2/d9/imehotky_8c-source.html#l00252">FreeImeHotKeys()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l00198">FreeInputContext()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00126">FreeKernelEvent()</a>, <a class="el" href="../../d6/d3/kernel_2ddetrack_8c-source.html#l01943">FreeListFree()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l03106">FreeMessageList()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l04397">FreeQEntry()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l02168">FreeQueue()</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l01171">FreeSpb()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l02227">FreeThreadsWindowHooks()</a>, <a class="el" href="../../d5/d1/timers_8c-source.html#l00112">FreeTimer()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l02949">FreeView()</a>, <a class="el" href="../../d9/d7/winsta_8c-source.html#l00745">FreeWindowStation()</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00703">FsRecGetDeviceSectors()</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00800">FsRecGetDeviceSectorSize()</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00907">FsRecReadBlock()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l00054">FsRtlCopyRead()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l00330">FsRtlCopyWrite()</a>, <a class="el" href="../../d2/d6/tunnel_8c-source.html#l00382">FsRtlInitializeTunnels()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l01064">FsRtlMdlReadDev()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l01474">FsRtlPrepareMdlWriteDev()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01173">FsRtlProcessFileLock()</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00231">FsRtlpSetSymbolicLink()</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00247">FsRtlRegisterUncProvider()</a>, <a class="el" href="../../d5/d4/stackovf_8c-source.html#l00345">FsRtlWorkerThread()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l00453">FtCreateKey()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l00357">FtOpenKey()</a>, <a class="el" href="../../d0/d0/f3ahvoas_8c-source.html#l00626">FujitsuOyayubiControl()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l03729">GetActiveKeyboardName()</a>, <a class="el" href="../../d1/d0/xact_8c-source.html#l00368">GetConvContext()</a>, <a class="el" href="../../d2/d2/dtbitmap_8c-source.html#l00223">GetDefaultWallpaperName()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l05658">GetFlashWindowState()</a>, <a class="el" href="../../d3/d0/fareast_8c-source.html#l00213">GetImmFileName()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l01794">GetMouseCoord()</a>, <a class="el" href="../../d7/d8/softkbd_8c-source.html#l00065">GetSoftKeyboardDimension()</a>, <a class="el" href="../../d4/d0/layime_8c-source.html#l00095">GetSystemPathName()</a>, <a class="el" href="../../d1/d6/server_2server_8c-source.html#l01068">GetTimeouts()</a>, <a class="el" href="../../d2/d0/inctlpan_8c-source.html#l01030">GetWindowNCMetrics()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l03735">HalpGetFullGeometry()</a>, <a class="el" href="../../d1/d6/server_2server_8c-source.html#l00479">HandleMediaChangeEvent()</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01129">HardErrorHandler()</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01669">HardErrorInsert()</a>, <a class="el" href="../../d7/d3/icamsg_8c-source.html#l00282">HardErrorRemove()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02220">HMChangeOwnerPheProcess()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02112">HMChangeOwnerThread()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l05120">IdleTimerProc()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l01740">ImeCheckTopmost()</a>, <a class="el" href="../../d0/d9/imectl_8c-source.html#l01339">ImeMarkUsedContext()</a>, <a class="el" href="../../d1/d9/imefull_8c-source.html#l00030">ImeOpenClose()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l01770">ImeSetFutureOwner()</a>, <a class="el" href="../../d0/d9/imectl_8c-source.html#l01257">ImeSetImc()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l01995">ImeSetTopmost()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l01862">ImeSetTopmostChild()</a>, <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l01191">ImmSendNotification()</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00747">ImmUnlockClientImc()</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00824">ImmUnlockImeDpi()</a>, <a class="el" href="../../d8/d0/ntuser_2kernel_2cursor_8c-source.html#l00147">IncCursorLevel()</a>, <a class="el" href="../../d0/d2/paint_8c-source.html#l01248">IncPaintCount()</a>, <a class="el" href="../../d9/d2/dc_8c-source.html#l00041">IncrementFreeDCECount()</a>, <a class="el" href="../../d9/d3/sprite_8c-source.html#l00020">IncrementRedirectedCount()</a>, <a class="el" href="../../d3/d7/swp_8c-source.html#l05123">IncVisWindows()</a>, <a class="el" href="../../d8/d6/cldib_8c-source.html#l00616">InitDst8()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l00186">InitExtendedEditKeys()</a>, <a class="el" href="../../d0/d6/kernel_2server_8c-source.html#l00975">InitFunctionTables()</a>, <a class="el" href="../../d3/d0/fareast_8c-source.html#l00338">InitializeImmEntryTable()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l00428">InitKeyboard()</a>, <a class="el" href="../../d0/d6/kernel_2server_8c-source.html#l01738">InitLoadResources()</a>, <a class="el" href="../../d0/d6/kernel_2server_8c-source.html#l01049">InitMessageTables()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l00289">InitMice()</a>, <a class="el" href="../../d6/d7/sftkbdc1_8c-source.html#l00269">InitSKC1Bitmap()</a>, <a class="el" href="../../d6/d7/sftkbdc1_8c-source.html#l00033">InitSKC1ButtonPos()</a>, <a class="el" href="../../d0/d6/kernel_2server_8c-source.html#l00944">InitWindowMsgTable()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l01090">InputApc()</a>, <a class="el" href="../../d9/d8/update_8c-source.html#l00784">InternalInvalidate3()</a>, <a class="el" href="../../d1/d6/w32_2ntgdi_2icm_2mscms_2profile_8c-source.html#l02694">InternalOpenColorProfile()</a>, <a class="el" href="../../d9/d2/dc_8c-source.html#l00470">InvalidateDce()</a>, <a class="el" href="../../d9/d2/dc_8c-source.html#l01746">InvalidateGDIWindows()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01067">IoAttachDevice()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12535">IoCancelFileOpen()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l03917">IoCreateController()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l04073">IoCreateDevice()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05299">IoCreateNotificationEvent()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05733">IoCreateSynchronizationEvent()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01300">IoFreeDumpStack()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06998">IoGetDeviceObjectPointer()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00417">IopCancelAlertedRequest()</a>, <a class="el" href="../../d5/d2/parse_8c-source.html#l02048">IopCheckBackupRestorePrivilege()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00036">IopCloseFile()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01019">IopCompleteRequest()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00657">IopCompleteUnloadOrDelete()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02155">IopCreateRootDirectories()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00417">IopDeleteFile()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l03255">IopFilterResourceRequirementsCall()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00384">IopGetDumpStack()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02256">IopGetFileName()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00975">IopGetSetSecurityObject()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02977">IopHardErrorThread()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04710">IopInvalidateVolumesForDevice()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04077">IopLoadFileSystemDriver()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04169">IopLoadUnloadDriver()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04282">IopMountVolume()</a>, <a class="el" href="../../d5/d2/parse_8c-source.html#l00202">IopParseDevice()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05397">IopQueryXxxInformation()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05841">IopRaiseInformationalHardError()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06127">IopSendMessageToTrackService()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08769">IoRaiseHardError()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08909">IoRaiseInformationalHardError()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09324">IoRegisterFileSystem()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09835">IoSetInformation()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l10359">IoShutdownSystem()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11106">IoUnregisterFileSystem()</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l01296">IovAttachDeviceToDeviceStack()</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l01309">IovDeleteDevice()</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l01321">IovDetachDevice()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11389">IoVerifyVolume()</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l01279">IovInitializeIrp()</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00542">IovpCompleteRequest()</a>, <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l01531">IovpThrowBogusSynchronousIrp()</a>, <a class="el" href="../../d5/d1/timers_8c-source.html#l00661">JournalTimer()</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l01419">keybd_event()</a>, <a class="el" href="../../d9/d1/ia64_2initkr_8c-source.html#l00078">KiInitializeKernel()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l07258">LeaveDeviceInfoListCrit()</a>, <a class="el" href="../../d6/d8/w32_2ntuser_2kernel_2pnp_8c-source.html#l00147">LeaveMediaCrit()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l07239">LeaveMouseCrit()</a>, <a class="el" href="../../d8/d1/power_8c-source.html#l00043">LeavePowerCrit()</a>, <a class="el" href="../../d5/d0/ctxtinfo_8c-source.html#l03113">LFontAtoLFontW()</a>, <a class="el" href="../../d5/d0/ctxtinfo_8c-source.html#l03134">LFontWtoLFontA()</a>, <a class="el" href="../../d5/d3/kernel_2acons_8c-source.html#l00269">LinkCursor()</a>, <a class="el" href="../../d1/d0/xact_8c-source.html#l00846">LinkTransaction()</a>, <a class="el" href="../../d7/d7/clinit_8c-source.html#l00933">LoadAppDlls()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00360">LoadLinkInfo()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l03976">LoadPreloadKeyboardLayouts()</a>, <a class="el" href="../../d5/d7/ex_8c-source.html#l00368">LockObjectAssignment()</a>, <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l01142">LW_DriversInit()</a>, <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l01253">LW_LoadProfileInitData()</a>, <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l01268">LW_LoadResources()</a>, <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l01422">LW_LoadSomeStrings()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l02460">main()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l02836">MapDesktop()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l05695">MarkDCEInvalid()</a>, <a class="el" href="../../d6/d4/mdimenu_8c-source.html#l00775">MDIActivateDlgInit()</a>, <a class="el" href="../../d6/d4/mdimenu_8c-source.html#l00685">MDIActivateDlgSize()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00166">MiCheckPageFilePath()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l00603">MiDereferenceSegmentThread()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l02281">MiFlushDirtyBitsToPfn()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00708">MiFreeNonPagedPool()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00059">MiInsertPageInList()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04239">MiMappedPageWriter()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02669">MiModifiedPageWriter()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02831">MiModifiedPageWriterWorker()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l00344">MiProtectVirtualMemory()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03060">MiSetPageModified()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l01110">MiSetProtectionOnSection()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03253">MiUnmapLockedPagesInUserSpace()</a>, <a class="el" href="../../d9/d2/ntuser_2kernel_2access_8c-source.html#l01322">MKHideMouseCursor()</a>, <a class="el" href="../../d9/d2/ntuser_2kernel_2access_8c-source.html#l01279">MKShowMouseCursor()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05161">MmMapUserAddressesToPage()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05920">MmSetAddressRangeModified()</a>, <a class="el" href="../../d5/d2/mnstate_8c-source.html#l00165">MNFreePopup()</a>, <a class="el" href="../../d3/d4/perfutil_8c-source.html#l00131">MonCloseEventLog()</a>, <a class="el" href="../../d8/d2/monitor_8c-source.html#l00167">MonitorConv()</a>, <a class="el" href="../../d8/d2/monitor_8c-source.html#l00090">MonitorLink()</a>, <a class="el" href="../../d8/d2/monitor_8c-source.html#l00031">MonitorStringHandle()</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l01395">mouse_event()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00335">MungeClipData()</a>, <a class="el" href="../../d5/d1/fekbd_8c-source.html#l00110">NlsClearKeyStateToggle()</a>, <a class="el" href="../../d5/d1/fekbd_8c-source.html#l01092">NlsKbdInitializePerSystem()</a>, <a class="el" href="../../d5/d1/fekbd_8c-source.html#l01034">NlsKbdSendIMENotification()</a>, <a class="el" href="../../d5/d1/fekbd_8c-source.html#l01071">NlsKbdSendIMEProc()</a>, <a class="el" href="../../d5/d1/fekbd_8c-source.html#l00096">NlsSetKeyStateToggle()</a>, <a class="el" href="../../d2/d9/tdisp_8c-source.html#l00021">NotepadPrint()</a>, <a class="el" href="../../d1/d6/server_2server_8c-source.html#l00881">NotificationThread()</a>, <a class="el" href="../../d2/d1/psspnd_8c-source.html#l00214">NtAlertThread()</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00049">NtCancelIoFile()</a>, <a class="el" href="../../d4/d4/lockvm_8c-source.html#l00033">NtLockVirtualMemory()</a>, <a class="el" href="../../d9/d4/physical_8c-source.html#l00085">NtMapUserPhysicalPages()</a>, <a class="el" href="../../d9/d4/physical_8c-source.html#l00498">NtMapUserPhysicalPagesScatter()</a>, <a class="el" href="../../d9/d3/loadunld_8c-source.html#l00244">NtUnloadDriver()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l07752">NtUserAlterWindowStyle()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l07703">NtUserModifyUserStartupInfoFlags()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l13072">NtUserNotifyIMEStatus()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l03461">NtUserNotifyWinEvent()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l04500">NtUserSetDbgTag()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l04490">NtUserSetRipFlags()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l13037">NtUserSetThreadLayoutHandles()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l07777">NtUserSetThreadState()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00914">ObpAcquireDescriptorCacheReadLock()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00886">ObpAcquireDescriptorCacheWriteLock()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01232">ObpIncrementHandleCount()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01587">ObpIncrementUnnamedHandleCount()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00942">ObpReleaseDescriptorCacheLock()</a>, <a class="el" href="../../d3/d7/swp_8c-source.html#l05543">OffsetChildren()</a>, <a class="el" href="../../d5/d8/minmax_8c-source.html#l00324">ParkIcon()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00270">PasteScreenPalette()</a>, <a class="el" href="../../d5/d7/createw_8c-source.html#l02972">PatchThreadWindows()</a>, <a class="el" href="../../d9/d8/update_8c-source.html#l00239">PixieHack()</a>, <a class="el" href="../../d5/d3/kernel_2msgbeep_8c-source.html#l00108">PlayEventSound()</a>, <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l00759">PnPGetDevnodeExcludeList()</a>, <a class="el" href="../../d6/d3/kernel_2ddetrack_8c-source.html#l02001">PopState()</a>, <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l01254">PostMove()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l03387">PostQuitMessage()</a>, <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00572">ProcessAsyncDDEMsg()</a>, <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00059">ProcessDDEMLInitiate()</a>, <a class="el" href="../../d6/d8/w32_2ntuser_2kernel_2pnp_8c-source.html#l01191">ProcessDeviceChanges()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l02615">ProcessKeyboardInput()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l01137">ProcessMouseInput()</a>, <a class="el" href="../../d0/d7/w32_2ntuser_2kernel_2cleanup_8c-source.html#l00042">PseudoDestroyClassWindows()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00389">putc()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l00925">QueueMouseEvent()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l03858">RawInputThread()</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01567">Reader()</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01646">ReaderTurnedWriter()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l02534">ReceiverDied()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l01242">RecolorDeskPattern()</a>, <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l02769">RegisterLPK()</a>, <a class="el" href="../../d0/d6/register_8c-source.html#l00068">RegisterService()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l03437">RegisterSystemThread()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l02783">ReleaseEditDS()</a>, <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00158">RemoveHmodDependency()</a>, <a class="el" href="../../d7/d1/kbdlyout_8c-source.html#l00390">RemoveKeyboardLayoutFile()</a>, <a class="el" href="../../d9/d3/sprite_8c-source.html#l00207">RemoveRedirectionBitmap()</a>, <a class="el" href="../../d7/d1/kbdlyout_8c-source.html#l00944">ReorderKeyboardLayouts()</a>, <a class="el" href="../../d6/d8/w32_2ntuser_2kernel_2pnp_8c-source.html#l01535">RequestDeviceChange()</a>, <a class="el" href="../../d9/d2/dc_8c-source.html#l00073">ResetOrg()</a>, <a class="el" href="../../d9/d7/fullscr_8c-source.html#l00985">ResetSharedDesktops()</a>, <a class="el" href="../../d9/d7/fullscr_8c-source.html#l01127">ResetSystemColors()</a>, <a class="el" href="../../d6/d3/rxact_8c-source.html#l00833">RtlAbortRXact()</a>, <a class="el" href="../../d6/d3/rxact_8c-source.html#l01240">RtlApplyRXact()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l01133">RtlDestroyHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00179">RtlInitializeHeapManager()</a>, <a class="el" href="../../d6/d5/chartran_8c-source.html#l00608">RtlInitLargeAnsiString()</a>, <a class="el" href="../../d6/d5/chartran_8c-source.html#l00636">RtlInitLargeUnicodeString()</a>, <a class="el" href="../../d6/d0/curdir_8c-source.html#l00839">RtlpValidateCurrentDirectory()</a>, <a class="el" href="../../d8/d6/cldib_8c-source.html#l00479">Scale2424()</a>, <a class="el" href="../../d8/d6/cldib_8c-source.html#l00375">Scale424()</a>, <a class="el" href="../../d8/d6/cldib_8c-source.html#l00281">Scale48()</a>, <a class="el" href="../../d8/d6/cldib_8c-source.html#l00427">Scale824()</a>, <a class="el" href="../../d8/d6/cldib_8c-source.html#l00328">Scale88()</a>, <a class="el" href="../../d7/d4/mdiwin_8c-source.html#l00463">ScrollChildren()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01634">SeFilterToken()</a>, <a class="el" href="../../d5/d4/seclient_8c-source.html#l00593">SeImpersonateClient()</a>, <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00837">SelectInputContext()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l02364">SendMsgCleanup()</a>, <a class="el" href="../../d0/d9/imectl_8c-source.html#l01234">SendOpenStatusNotify()</a>, <a class="el" href="../../d0/d6/register_8c-source.html#l00030">SendRegisterMessageToClass()</a>, <a class="el" href="../../d9/d2/ntuser_2kernel_2access_8c-source.html#l02881">SetAccessEnabledFlag()</a>, <a class="el" href="../../d7/d4/connect_8c-source.html#l00876">SetCommonStateFlags()</a>, <a class="el" href="../../d1/d0/xact_8c-source.html#l00387">SetConvContext()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l02196">SetConvMode()</a>, <a class="el" href="../../d7/d7/clinit_8c-source.html#l01800">SetDbgTag()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l04509">SetDebugErrorLevel()</a>, <a class="el" href="../../d4/d1/hotkeys_8c-source.html#l00026">SetDebugHotKeys()</a>, <a class="el" href="../../d0/d0/miscutil_8c-source.html#l00024">SetDialogPointer()</a>, <a class="el" href="../../d6/d9/immhotky_8c-source.html#l00099">SetFeKeyboardFlags()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l02708">SetForegroundPriority()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l02648">SetForegroundPriorityProcess()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l02588">SetForegroundThread()</a>, <a class="el" href="../../d9/d2/ntuser_2kernel_2access_8c-source.html#l01212">SetGlobalCursorLevel()</a>, <a class="el" href="../../d4/d7/handles_8c-source.html#l00185">SetHandleData()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l04579">SetHandleInUse()</a>, <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00026">SetHungFlag()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l02932">SetKeyboardRate()</a>, <a class="el" href="../../d1/d3/instance_8c-source.html#l00137">SetLastDDEMLError()</a>, <a class="el" href="../../d8/d3/w32_2ntuser_2client_2random_8c-source.html#l00208">SetLastErrorEx()</a>, <a class="el" href="../../d3/d7/swp_8c-source.html#l05176">SetMinimize()</a>, <a class="el" href="../../d2/d0/inctlpan_8c-source.html#l01170">SetMinMetrics()</a>, <a class="el" href="../../d7/d7/clinit_8c-source.html#l01795">SetRipFlags()</a>, <a class="el" href="../../d0/d8/sysmet_8c-source.html#l00121">SetSysColor()</a>, <a class="el" href="../../d8/d7/proppage_8h-source.html#l00073">CPropertyPage::SettingChanged()</a>, <a class="el" href="../../d3/d7/swp_8c-source.html#l03498">SetTopmost()</a>, <a class="el" href="../../d8/d0/ntuser_2kernel_2cursor_8c-source.html#l00351">SetVDMCursorBounds()</a>, <a class="el" href="../../d3/d7/swp_8c-source.html#l05237">SetVisible()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l04578">SetWakeBit()</a>, <a class="el" href="../../d6/d7/sftkbdc1_8c-source.html#l00449">ShowSKC1Window()</a>, <a class="el" href="../../d7/d4/connect_8c-source.html#l01109">ShutdownConversation()</a>, <a class="el" href="../../d6/d7/sftkbdc1_8c-source.html#l00716">SKC1ButtonDown()</a>, <a class="el" href="../../d6/d7/sftkbdc1_8c-source.html#l00211">SKC1DrawBitmap()</a>, <a class="el" href="../../d6/d7/sftkbdc1_8c-source.html#l00117">SKC1DrawConvexRect()</a>, <a class="el" href="../../d6/d7/sftkbdc1_8c-source.html#l00601">SKC1DrawDragBorder()</a>, <a class="el" href="../../d6/d7/sftkbdc1_8c-source.html#l00240">SKC1DrawLabel()</a>, <a class="el" href="../../d6/d7/sftkbdc1_8c-source.html#l00147">SKC1InvertButton()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00551">SmbTraceStart()</a>, <a class="el" href="../../d9/d2/ntuser_2kernel_2access_8c-source.html#l02898">SoundSentryTimer()</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l00995">SpbCheck()</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l01040">SpbCheckDce()</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l01126">SpbCheckPwnd()</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l01081">SpbCheckRect()</a>, <a class="el" href="../../d5/d8/clres_8c-source.html#l00105">SplFreeResource()</a>, <a class="el" href="../../d9/d2/ntuser_2kernel_2access_8c-source.html#l00717">StopFilterKeysTimers()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00121">StubFreeSMS()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l01418">SwitchToThisWindow()</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l01542">SwitchWndCleanup()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l02801">TellWOWThehDlg()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l04420">TerminateConsole()</a>, <a class="el" href="../../d5/d1/timers_8c-source.html#l00746">TimersProc()</a>, <a class="el" href="../../d9/d7/fullscr_8c-source.html#l01251">TrackFullscreenMode()</a>, <a class="el" href="../../d9/d2/ntuser_2kernel_2access_8c-source.html#l01944">TurnOffMouseKeys()</a>, <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00637">UdfAddVmcbMapping()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01406">UdfLoadSparingTables()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01435">UdfMultipleAsync()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00573">UdfPerformDevIoCtrl()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00632">UdfPnpCancelRemove()</a>, <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00867">UdfRemoveVmcbMapping()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01642">UdfSingleAsync()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00603">UdfVerifyVcb()</a>, <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00553">UdfVmcbLbnToVbn()</a>, <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00461">UdfVmcbVbnToLbn()</a>, <a class="el" href="../../d5/d0/layout_8c-source.html#l00497">UIntToStr()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02442">UnblockWriteConsole()</a>, <a class="el" href="../../d7/d4/connect_8c-source.html#l01153">UnlinkConvFromOthers()</a>, <a class="el" href="../../d8/d3/loadbits_8c-source.html#l00057">UnlinkCursor()</a>, <a class="el" href="../../d1/d0/xact_8c-source.html#l00885">UnlinkTransaction()</a>, <a class="el" href="../../d5/d7/createw_8c-source.html#l02867">UnlinkWindow()</a>, <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l01642">UnloadCursorsAndIcons()</a>, <a class="el" href="../../d7/d9/immime_8c-source.html#l00212">UnloadIME()</a>, <a class="el" href="../../d3/d6/class_8c-source.html#l01092">UnlockAndFreeCPDs()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>, <a class="el" href="../../d5/d7/createw_8c-source.html#l02192">UnlockNotifyWindow()</a>, <a class="el" href="../../d5/d7/ex_8c-source.html#l00421">UnlockObjectAssignment()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l03017">UnmapDesktop()</a>, <a class="el" href="../../d7/d4/profassoc_8cpp-source.html#l00173">CProfileAssociationPage::UpdateDeviceListBox()</a>, <a class="el" href="../../d4/d7/job_8c-source.html#l00206">UpdateJob()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l02985">UpdateKeyLights()</a>, <a class="el" href="../../d9/d3/sprite_8c-source.html#l00141">UpdateLayeredSprite()</a>, <a class="el" href="../../d9/d2/dc_8c-source.html#l00415">UserAssociateHwnd()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l02475">UserDeleteW32Process()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l02385">UserDeleteW32Thread()</a>, <a class="el" href="../../d5/d7/ex_8c-source.html#l00448">UserDereferenceObject()</a>, <a class="el" href="../../d8/d2/validate_8c-source.html#l00472">UserEnterUserCritSec()</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01662">UserHardError()</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01686">UserHardErrorEx()</a>, <a class="el" href="../../d4/d0/usergdi_8c-source.html#l00072">UserKillTimer()</a>, <a class="el" href="../../d8/d2/validate_8c-source.html#l00477">UserLeaveUserCritSec()</a>, <a class="el" href="../../d0/d2/paint_8c-source.html#l01321">UserRedrawDesktop()</a>, <a class="el" href="../../d9/d3/sprite_8c-source.html#l00310">UserRemoveRedirectionBitmap()</a>, <a class="el" href="../../d7/d7/clinit_8c-source.html#l01620">UserRtlFreeMem()</a>, <a class="el" href="../../d7/d7/clinit_8c-source.html#l01626">UserRtlRaiseStatus()</a>, <a class="el" href="../../d9/d2/dc_8c-source.html#l00237">UserSetDCVisRgn()</a>, <a class="el" href="../../d9/d7/fullscr_8c-source.html#l00056">UserSetDelayedChangeBroadcastForAllDesktops()</a>, <a class="el" href="../../d1/d0/base_8c-source.html#l00083">UserSleep()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00701">UT_FreeCBFormat()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00546">vAddLocalType1Font()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00531">vAddRemoteType1Font()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00489">vAddType1Font()</a>, <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l02001">vCheckMMInstance()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01132">vCleanConvertedTTFs()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01237">vFontSweep()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01300">vLoadLocalT1Fonts()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01305">vLoadRemoteT1Fonts()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01277">vLoadT1Fonts()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00360">vMoveFileFromSystemToFontsDir()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00089">vNullTermWideString()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00138">vProcessFontEntry()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00450">vProcessType1FontEntry()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00577">vSweepFonts()</a>, <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l00773">Win32KDriverUnload()</a>, <a class="el" href="../../d3/d9/server_2exitwin_8c-source.html#l00676">WMCSCallback()</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01606">Writer()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l00190">xHalExamineMBR()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l00382">xHalGetPartialGeometry()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l03486">xHalIoClearPartitionTable()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l01739">xHalIoReadPartitionTable()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l02485">xHalIoSetPartitionInformation()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l02879">xHalIoWritePartitionTable()</a>, <a class="el" href="../../d9/d2/ntuser_2kernel_2access_8c-source.html#l02225">xxxAccessTimeOutTimer()</a>, <a class="el" href="../../d5/d8/minmax_8c-source.html#l00558">xxxAnimateCaption()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l02679">xxxBroadcastImeShowStatusChange()</a>, <a class="el" href="../../d1/d2/palette_8c-source.html#l00243">xxxBroadcastPaletteChanged()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l00472">xxxButtonEvent()</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l01635">xxxCancelCoolSwitch()</a>, <a class="el" href="../../d9/d2/movesize_8c-source.html#l01891">xxxCancelTracking()</a>, <a class="el" href="../../d9/d2/movesize_8c-source.html#l01826">xxxCancelTrackingForThread()</a>, <a class="el" href="../../d4/d4/w32_2ntuser_2kernel_2capture_8c-source.html#l00124">xxxCapture()</a>, <a class="el" href="../../d2/d7/w32_2ntuser_2kernel_2event_8c-source.html#l00064">xxxChangeMonitorFlags()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l02694">xxxCheckImeShowStatusInThread()</a>, <a class="el" href="../../d9/d3/sbctl_8c-source.html#l01913">xxxContScroll()</a>, <a class="el" href="../../d7/d6/classchg_8c-source.html#l00172">xxxCreateClassSmIcon()</a>, <a class="el" href="../../d6/d3/kernel_2ddetrack_8c-source.html#l00618">xxxDDETrackGetMessageHook()</a>, <a class="el" href="../../d6/d3/kernel_2ddetrack_8c-source.html#l00768">xxxDDETrackWindowDying()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l00114">xxxDesktopThread()</a>, <a class="el" href="../../d2/d3/ddemlsvr_8c-source.html#l00127">xxxDestroyThreadDDEObject()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l02552">xxxDestroyThreadInfo()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l01020">xxxDoButtonEvent()</a>, <a class="el" href="../../d0/d2/paint_8c-source.html#l01084">xxxDoSyncPaint()</a>, <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00253">xxxDoSysExpunge()</a>, <a class="el" href="../../d2/d4/caption_8c-source.html#l00986">xxxDrawCaptionBar()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00220">xxxDrawClipboard()</a>, <a class="el" href="../../d9/d2/movesize_8c-source.html#l01562">xxxDrawDragRect()</a>, <a class="el" href="../../d9/d2/dwp_8c-source.html#l00696">xxxDWP_DoNCActivate()</a>, <a class="el" href="../../d9/d2/ntuser_2kernel_2access_8c-source.html#l00423">xxxFKAcceptanceDelayTimer()</a>, <a class="el" href="../../d9/d2/ntuser_2kernel_2access_8c-source.html#l00374">xxxFKRepeatRateTimer()</a>, <a class="el" href="../../d1/d2/palette_8c-source.html#l00220">xxxFlushPalette()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l00405">xxxFocusSetInputContext()</a>, <a class="el" href="../../d7/d1/kbdlyout_8c-source.html#l00627">xxxFreeImeKeyboardLayouts()</a>, <a class="el" href="../../d7/d1/kbdlyout_8c-source.html#l01647">xxxFreeKeyboardLayouts()</a>, <a class="el" href="../../d6/d3/kernel_2ddetrack_8c-source.html#l01960">xxxFreeListFree()</a>, <a class="el" href="../../d5/d7/createw_8c-source.html#l02218">xxxFreeWindow()</a>, <a class="el" href="../../d3/d7/swp_8c-source.html#l03381">xxxHandleWindowPosChanged()</a>, <a class="el" href="../../d9/d2/ntuser_2kernel_2access_8c-source.html#l01149">xxxHardwareMouseKeyUp()</a>, <a class="el" href="../../d3/d9/kernel_2help_8c-source.html#l00073">xxxHelpLoop()</a>, <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00446">xxxHungAppDemon()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l00749">xxxImmActivateAndUnloadThreadsLayout()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l00921">xxxImmActivateLayout()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l01070">xxxImmUnloadLayout()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l00961">xxxImmUnloadThreadsLayout()</a>, <a class="el" href="../../d0/d2/paint_8c-source.html#l00885">xxxInternalDoSyncPaint()</a>, <a class="el" href="../../d9/d8/update_8c-source.html#l01302">xxxInternalInvalidate()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l03403">xxxInternalKeyEventDirect()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l01338">xxxKeyEvent()</a>, <a class="el" href="../../d0/d1/lboxctl2_8c-source.html#l02139">xxxLBoxCaretBlinker()</a>, <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l02184">xxxLW_LoadFonts()</a>, <a class="el" href="../../d2/d7/w32_2ntuser_2kernel_2event_8c-source.html#l00275">xxxMessageEvent()</a>, <a class="el" href="../../d9/d2/ntuser_2kernel_2access_8c-source.html#l01543">xxxMKMoveAccelCursorTimer()</a>, <a class="el" href="../../d9/d2/ntuser_2kernel_2access_8c-source.html#l01486">xxxMKMoveConstCursorTimer()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l03213">xxxMouseEventDirect()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l02020">xxxMoveEvent()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l01936">xxxMoveEventAbsolute()</a>, <a class="el" href="../../d9/d2/movesize_8c-source.html#l01053">xxxMoveSize()</a>, <a class="el" href="../../d9/d2/movesize_8c-source.html#l00844">xxxMS_FlushWigglies()</a>, <a class="el" href="../../d6/d4/statctl_8c-source.html#l01211">xxxNextAniIconStep()</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l01675">xxxNextWindow()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l02544">xxxNotifyImeShowStatus()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l02295">xxxNotifyIMEStatus()</a>, <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l01508">xxxODI_ColorInit()</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l02121">xxxOldNextWindow()</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l00808">xxxPaintIconsInSwitchWindow()</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l01012">xxxPaintSwitchWindow()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l03772">xxxProcessEventMessage()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l02791">xxxProcessKeyEvent()</a>, <a class="el" href="../../d3/d7/swp_8c-source.html#l01884">xxxProcessSetWindowPosEvent()</a>, <a class="el" href="../../d7/d9/w32_2ntuser_2kernel_2misc_8c-source.html#l00536">xxxPushKeyEvent()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l00863">xxxRealizeDesktop()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01964">xxxReceiveMessage()</a>, <a class="el" href="../../d3/d7/metrics_8c-source.html#l00075">xxxRecreateSmallIcons()</a>, <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00135">xxxRedrawHungWindow()</a>, <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00107">xxxRedrawHungWindowFrame()</a>, <a class="el" href="../../d9/d7/fullscr_8c-source.html#l01152">xxxResetDisplayDevice()</a>, <a class="el" href="../../d9/d3/sbctl_8c-source.html#l02123">xxxSBTrackLoop()</a>, <a class="el" href="../../d3/d7/swp_8c-source.html#l01669">xxxSendChangedMsgs()</a>, <a class="el" href="../../d0/d2/paint_8c-source.html#l00278">xxxSendChildNCPaint()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00783">xxxSendClipboardMessage()</a>, <a class="el" href="../../d0/d2/paint_8c-source.html#l00232">xxxSendNCPaint()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l02518">xxxSendOpenStatusNotify()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l06419">xxxSetConsoleCaretInfo()</a>, <a class="el" href="../../d7/d1/kbdlyout_8c-source.html#l00560">xxxSetPKLinThreads()</a>, <a class="el" href="../../d0/d2/paint_8c-source.html#l00740">xxxSimpleDoSyncPaint()</a>, <a class="el" href="../../d5/d4/rare_8c-source.html#l03797">xxxSimulateShiftF10()</a>, <a class="el" href="../../d6/d4/statctl_8c-source.html#l00246">xxxStaticLoadImage()</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l00253">xxxSwitchToThisWindow()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01002">xxxSystemBroadcastMessage()</a>, <a class="el" href="../../d5/d1/timers_8c-source.html#l00882">xxxSystemTimerProc()</a>, <a class="el" href="../../d9/d2/movesize_8c-source.html#l00274">xxxTM_MoveDragRect()</a>, <a class="el" href="../../d9/d2/ntuser_2kernel_2access_8c-source.html#l02040">xxxToggleKeysTimer()</a>, <a class="el" href="../../d9/d2/ntuser_2kernel_2access_8c-source.html#l01077">xxxTurnOffStickyKeys()</a>, <a class="el" href="../../d9/d2/ntuser_2kernel_2access_8c-source.html#l01108">xxxUnlatchStickyKeys()</a>, <a class="el" href="../../d9/d2/ntuser_2kernel_2access_8c-source.html#l01037">xxxUpdateModifierState()</a>, <a class="el" href="../../d9/d2/movesize_8c-source.html#l01485">xxxUpdateOtherThreadsWindows()</a>, <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l01685">xxxUpdateSystemCursorsFromRegistry()</a>, <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l01735">xxxUpdateSystemIconsFromRegistry()</a>, <a class="el" href="../../d9/d2/movesize_8c-source.html#l01523">xxxUpdateThreadsWindows()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l03136">xxxUserResetDisplayDevice()</a>, <a class="el" href="../../d0/d0/miscutil_8c-source.html#l00016">ZapActiveAndFocus()</a>, <a class="el" href="../../d8/d3/loadbits_8c-source.html#l00156">ZombieCursor()</a>, <a class="el" href="../../d8/d0/ntuser_2kernel_2cursor_8c-source.html#l00389">zzzAnimateCursor()</a>, <a class="el" href="../../d3/d7/swp_8c-source.html#l01955">zzzChangeStates()</a>, <a class="el" href="../../d8/d0/ntuser_2kernel_2cursor_8c-source.html#l00114">zzzInternalSetCursorPos()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l02318">zzzRegisterSystemThread()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l03823">zzzSetDesktop()</a>, <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l01363">zzzSetFMouseMoved()</a>, and <a class="el" href="../../d8/d0/ntuser_2kernel_2cursor_8c-source.html#l00496">zzzUpdateCursorImage()</a>.    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a23" doxytag="iop.h::BreakDiskByteOffset" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d0/d6/iop_8h.html#a23">BreakDiskByteOffset</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00057">57</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="iop.h::BreakPfn" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d0/d6/iop_8h.html#a24">BreakPfn</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00058">58</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a137" doxytag="iop.h::ExEventObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d4/d1/userk_8h.html#a786">ExEventObjectType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00561">561</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a96" doxytag="iop.h::IoAdapterObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d0/d6/iop_8h.html#a96">IoAdapterObjectType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00504">504</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01936">IopCreateObjectTypes()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a118" doxytag="iop.h::IoArcBootDeviceName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UNICODE_STRING <a class="el" href="../../d0/d6/iop_8h.html#a118">IoArcBootDeviceName</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00529">529</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00335">IoGetDumpStack()</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01047">IopCreateArcNames()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a119" doxytag="iop.h::IoArcHalDeviceName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UNICODE_STRING <a class="el" href="../../d0/d6/iop_8h.html#a119">IoArcHalDeviceName</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00530">530</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01047">IopCreateArcNames()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a97" doxytag="iop.h::IoCompletionObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d1/d1/psjob_8c.html#a0">IoCompletionObjectType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00505">505</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a98" doxytag="iop.h::IoControllerObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d0/d6/iop_8h.html#a98">IoControllerObjectType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00506">506</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l03917">IoCreateController()</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01936">IopCreateObjectTypes()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a103" doxytag="iop.h::IoDeviceHandlerObjectSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d0/d6/iop_8h.html#a103">IoDeviceHandlerObjectSize</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00511">511</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01936">IopCreateObjectTypes()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a101" doxytag="iop.h::IoDeviceHandlerObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d0/d6/iop_8h.html#a101">IoDeviceHandlerObjectType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00509">509</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01936">IopCreateObjectTypes()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a99" doxytag="iop.h::IoDeviceObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d4/d1/oblink_8c.html#a3">IoDeviceObjectType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00507">507</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a100" doxytag="iop.h::IoDriverObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d0/d6/iop_8h.html#a100">IoDriverObjectType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00508">508</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01071">IoCreateDriver()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01936">IopCreateObjectTypes()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09565">IopGetLegacyVetoListDrivers()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02272">IopInitializeAttributesAndCreateObject()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02812">IopInitializeBuiltinDriver()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03686">IopReferenceDriverObjectByName()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07495">IoRegisterPlugPlayNotification()</a>, and <a class="el" href="../../d9/d3/loadunld_8c-source.html#l00244">NtUnloadDriver()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a102" doxytag="iop.h::IoFileObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d3/d4/vdm_2vdm_8c.html#a2">IoFileObjectType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00510">510</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a120" doxytag="iop.h::IoLoaderArcBootDeviceName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PUCHAR <a class="el" href="../../d0/d6/iop_8h.html#a120">IoLoaderArcBootDeviceName</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00531">531</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01047">IopCreateArcNames()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a82" doxytag="iop.h::IopBootDriverReinitializeQueueHead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d0/d6/iop_8h.html#a82">IopBootDriverReinitializeQueueHead</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00489">489</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09200">IoRegisterBootDriverReinitialization()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a49" doxytag="iop.h::IopCancelSpinLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KSPIN_LOCK <a class="el" href="../../d0/d6/iop_8h.html#a49">IopCancelSpinLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00178">178</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a79" doxytag="iop.h::IopCdRomFileSystemQueueHead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d0/d6/iop_8h.html#a79">IopCdRomFileSystemQueueHead</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00486">486</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04710">IopInvalidateVolumesForDevice()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04282">IopMountVolume()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09324">IoRegisterFileSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a95" doxytag="iop.h::IopCompletionLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KSPIN_LOCK <a class="el" href="../../d0/d6/iop_8h.html#a95">IopCompletionLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00502">502</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a107" doxytag="iop.h::IopCompletionLookasideList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a> <a class="el" href="../../d0/d6/iop_8h.html#a107">IopCompletionLookasideList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00516">516</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a52" doxytag="iop.h::IopCompletionMapping" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> GENERIC_MAPPING <a class="el" href="../../d0/d6/iop_8h.html#a52">IopCompletionMapping</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00181">181</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01936">IopCreateObjectTypes()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="iop.h::IopCurrentHardError" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d7/d0/struct__IOP__HARD__ERROR__PACKET.html">PIOP_HARD_ERROR_PACKET</a> <a class="el" href="../../d0/d6/iop_8h.html#a40">IopCurrentHardError</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00153">153</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02977">IopHardErrorThread()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08909">IoRaiseInformationalHardError()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a75" doxytag="iop.h::IopDatabaseLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KSPIN_LOCK <a class="el" href="../../d0/d6/iop_8h.html#a75">IopDatabaseLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00482">482</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a76" doxytag="iop.h::IopDatabaseResource" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a> <a class="el" href="../../d0/d6/iop_8h.html#a76">IopDatabaseResource</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00483">483</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04710">IopInvalidateVolumesForDevice()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04282">IopMountVolume()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09324">IoRegisterFileSystem()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09422">IoRegisterFsRegistrationChange()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l10359">IoShutdownSystem()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11106">IoUnregisterFileSystem()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11178">IoUnregisterFsRegistrationChange()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a78" doxytag="iop.h::IopDiskFileSystemQueueHead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d0/d6/iop_8h.html#a78">IopDiskFileSystemQueueHead</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00485">485</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04710">IopInvalidateVolumesForDevice()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04282">IopMountVolume()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09324">IoRegisterFileSystem()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l10359">IoShutdownSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a83" doxytag="iop.h::IopDriverReinitializeQueueHead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d0/d6/iop_8h.html#a83">IopDriverReinitializeQueueHead</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00490">490</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03165">IopCallDriverAddDeviceQueryRoutine()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04169">IopLoadUnloadDriver()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09262">IoRegisterDriverReinitialization()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a121" doxytag="iop.h::IopDumpControlBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">PDUMP_CONTROL_BLOCK</a> <a class="el" href="../../d0/d6/iop_8h.html#a121">IopDumpControlBlock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00532">532</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02217">IoGetCrashDumpInformation()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04061">IopCompleteDumpInitialization()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04746">IopConfigureCrashDump()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03815">IopCreateSummaryDump()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04252">IopFreeDCB()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04580">IopInitializeDCB()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03638">IopWriteToDisk()</a>, and <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01519">IoWriteCrashDump()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a122" doxytag="iop.h::IopDumpControlBlockChecksum" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d0/d6/iop_8h.html#a122">IopDumpControlBlockChecksum</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00533">533</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04061">IopCompleteDumpInitialization()</a>, and <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01519">IoWriteCrashDump()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="iop.h::IopErrorLogAllocation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d0/d6/iop_8h.html#a47">IopErrorLogAllocation</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00176">176</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00542">IopAllocateErrorLogEntry()</a>, and <a class="el" href="../../d8/d6/errorlog_8c-source.html#l00088">IopErrorLogThread()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a48" doxytag="iop.h::IopErrorLogAllocationLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KSPIN_LOCK <a class="el" href="../../d0/d6/iop_8h.html#a48">IopErrorLogAllocationLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00177">177</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="iop.h::IopErrorLogDisabledThisBoot" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d0/d6/iop_8h.html#a44">IopErrorLogDisabledThisBoot</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00173">173</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11556">IoWriteErrorLogEntry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a46" doxytag="iop.h::IopErrorLogListHead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d9/d5/4_2kddata_8c.html#a8">IopErrorLogListHead</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00175">175</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="iop.h::IopErrorLogLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KSPIN_LOCK <a class="el" href="../../d0/d6/iop_8h.html#a45">IopErrorLogLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00174">174</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="iop.h::IopErrorLogPortPending" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d0/d6/iop_8h.html#a43">IopErrorLogPortPending</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00172">172</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/errorlog_8c-source.html#l00707">IopErrorLogGetEntry()</a>, <a class="el" href="../../d8/d6/errorlog_8c-source.html#l00760">IopErrorLogQueueRequest()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11556">IoWriteErrorLogEntry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a42" doxytag="iop.h::IopErrorLogWorkItem" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">WORK_QUEUE_ITEM</a> <a class="el" href="../../d0/d6/iop_8h.html#a42">IopErrorLogWorkItem</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00171">171</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/errorlog_8c-source.html#l00660">IopErrorLogDpc()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11556">IoWriteErrorLogEntry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a51" doxytag="iop.h::IopFileMapping" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> GENERIC_MAPPING <a class="el" href="../../d0/d6/iop_8h.html#a51">IopFileMapping</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00180">180</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07183">IoGetFileObjectGenericMapping()</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01936">IopCreateObjectTypes()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a86" doxytag="iop.h::IopFsNotifyChangeQueueHead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d0/d6/iop_8h.html#a86">IopFsNotifyChangeQueueHead</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00493">493</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09324">IoRegisterFileSystem()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09422">IoRegisterFsRegistrationChange()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11106">IoUnregisterFileSystem()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11178">IoUnregisterFsRegistrationChange()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="iop.h::IopHardError" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d0/struct__IOP__HARD__ERROR__QUEUE.html">IOP_HARD_ERROR_QUEUE</a> <a class="el" href="../../d0/d6/iop_8h.html#a39">IopHardError</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00152">152</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02977">IopHardErrorThread()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05841">IopRaiseInformationalHardError()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08909">IoRaiseInformationalHardError()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a104" doxytag="iop.h::IopLargeIrpLookasideList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a> <a class="el" href="../../d0/d6/iop_8h.html#a104">IopLargeIrpLookasideList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00513">513</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a94" doxytag="iop.h::IopLargeIrpStackLocations" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d0/d6/iop_8h.html#a94">IopLargeIrpStackLocations</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00501">501</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a127" doxytag="iop.h::IopLinkTrackingPacket" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d1/struct__LINK__TRACKING__PACKET.html">LINK_TRACKING_PACKET</a> <a class="el" href="../../d0/d6/iop_8h.html#a127">IopLinkTrackingPacket</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00540">540</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l06127">IopSendMessageToTrackService()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a126" doxytag="iop.h::IopLinkTrackingPortObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="el" href="../../d0/d6/iop_8h.html#a126">IopLinkTrackingPortObject</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00539">539</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l06127">IopSendMessageToTrackService()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a125" doxytag="iop.h::IopLinkTrackingServiceEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> <a class="el" href="../../d0/d6/iop_8h.html#a125">IopLinkTrackingServiceEvent</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00538">538</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01506">IopConnectLinkTrackingPort()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l06127">IopSendMessageToTrackService()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a124" doxytag="iop.h::IopLinkTrackingServiceObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID <a class="el" href="../../d0/d6/iop_8h.html#a124">IopLinkTrackingServiceObject</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00537">537</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l01506">IopConnectLinkTrackingPort()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l06127">IopSendMessageToTrackService()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a128" doxytag="iop.h::IopLoaderBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID <a class="el" href="../../d0/d6/iop_8h.html#a128">IopLoaderBlock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00542">542</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11641">IoGetBootDiskInformation()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a130" doxytag="iop.h::IopLookasideIrpFloat" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d0/d6/iop_8h.html#a130">IopLookasideIrpFloat</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00546">546</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00662">IopAllocateIrpPrivate()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06641">IopFreeIrp()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a131" doxytag="iop.h::IopLookasideIrpLimit" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d0/d6/iop_8h.html#a131">IopLookasideIrpLimit</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00547">547</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00662">IopAllocateIrpPrivate()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06641">IopFreeIrp()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a106" doxytag="iop.h::IopMdlLookasideList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a> <a class="el" href="../../d0/d6/iop_8h.html#a106">IopMdlLookasideList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00515">515</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a80" doxytag="iop.h::IopNetworkFileSystemQueueHead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d0/d6/iop_8h.html#a80">IopNetworkFileSystemQueueHead</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00487">487</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09324">IoRegisterFileSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a85" doxytag="iop.h::IopNotifyLastChanceShutdownQueueHead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d0/d6/iop_8h.html#a85">IopNotifyLastChanceShutdownQueueHead</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00492">492</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09487">IoRegisterLastChanceShutdownNotification()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l10359">IoShutdownSystem()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11239">IoUnregisterShutdownNotification()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a84" doxytag="iop.h::IopNotifyShutdownQueueHead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d0/d6/iop_8h.html#a84">IopNotifyShutdownQueueHead</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00491">491</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09550">IoRegisterShutdownNotification()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l10359">IoShutdownSystem()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11239">IoUnregisterShutdownNotification()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a115" doxytag="iop.h::IopQueryFsOperationAccess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d0/d6/iop_8h.html#a115">IopQueryFsOperationAccess</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00525">525</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02547">IoCheckFunctionAccess()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, and <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00037">NtQueryVolumeInformationFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a113" doxytag="iop.h::IopQueryFsOperationLength" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UCHAR <a class="el" href="../../d0/d6/iop_8h.html#a113">IopQueryFsOperationLength</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00523">523</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02820">IoCheckQuerySetVolumeInformation()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, and <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00037">NtQueryVolumeInformationFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a110" doxytag="iop.h::IopQueryOperationAccess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d0/d6/iop_8h.html#a110">IopQueryOperationAccess</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00520">520</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02547">IoCheckFunctionAccess()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, and <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00101">NtQueryInformationFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a108" doxytag="iop.h::IopQueryOperationLength" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UCHAR <a class="el" href="../../d0/d6/iop_8h.html#a108">IopQueryOperationLength</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00518">518</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02760">IoCheckQuerySetFileInformation()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, and <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00101">NtQueryInformationFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a112" doxytag="iop.h::IopQuerySetAlignmentRequirement" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UCHAR <a class="el" href="../../d0/d6/iop_8h.html#a112">IopQuerySetAlignmentRequirement</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00522">522</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/dir_8c-source.html#l00057">BuildQueryDirectoryIrp()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00101">NtQueryInformationFile()</a>, and <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a117" doxytag="iop.h::IopQuerySetFsAlignmentRequirement" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UCHAR <a class="el" href="../../d0/d6/iop_8h.html#a117">IopQuerySetFsAlignmentRequirement</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00527">527</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00037">NtQueryVolumeInformationFile()</a>, and <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00492">NtSetVolumeInformationFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a88" doxytag="iop.h::IopRegistrySemaphore" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d7/struct__KSEMAPHORE.html">KSEMAPHORE</a> <a class="el" href="../../d0/d6/iop_8h.html#a88">IopRegistrySemaphore</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00495">495</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07141">IopAllocateBootResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00720">IopAllocateResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06180">IopLegacyResourceAllocation()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07717">IopQueryConflictList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07470">IopReallocateResources()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a129" doxytag="iop.h::IopRemoteBootCardInitialized" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d0/d6/iop_8h.html#a129">IopRemoteBootCardInitialized</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00544">544</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/netboot_8c-source.html#l01982">IopSetupRemoteBootCard()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a77" doxytag="iop.h::IopSecurityResource" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a> <a class="el" href="../../d0/d6/iop_8h.html#a77">IopSecurityResource</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00484">484</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00975">IopGetSetSecurityObject()</a>, <a class="el" href="../../d5/d2/parse_8c-source.html#l00202">IopParseDevice()</a>, and <a class="el" href="../../d4/d0/objsup_8c-source.html#l00877">IopSetDeviceSecurityDescriptors()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a116" doxytag="iop.h::IopSetFsOperationAccess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d0/d6/iop_8h.html#a116">IopSetFsOperationAccess</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00526">526</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02547">IoCheckFunctionAccess()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, and <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00492">NtSetVolumeInformationFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a114" doxytag="iop.h::IopSetFsOperationLength" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UCHAR <a class="el" href="../../d0/d6/iop_8h.html#a114">IopSetFsOperationLength</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00524">524</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02820">IoCheckQuerySetVolumeInformation()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, and <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00492">NtSetVolumeInformationFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a111" doxytag="iop.h::IopSetOperationAccess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d0/d6/iop_8h.html#a111">IopSetOperationAccess</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00521">521</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02547">IoCheckFunctionAccess()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, and <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a109" doxytag="iop.h::IopSetOperationLength" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UCHAR <a class="el" href="../../d0/d6/iop_8h.html#a109">IopSetOperationLength</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00519">519</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02760">IoCheckQuerySetFileInformation()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, and <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a105" doxytag="iop.h::IopSmallIrpLookasideList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a> <a class="el" href="../../d0/d6/iop_8h.html#a105">IopSmallIrpLookasideList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00514">514</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a81" doxytag="iop.h::IopTapeFileSystemQueueHead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d0/d6/iop_8h.html#a81">IopTapeFileSystemQueueHead</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00488">488</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04710">IopInvalidateVolumesForDevice()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04282">IopMountVolume()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09324">IoRegisterFileSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a92" doxytag="iop.h::IopTimer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d8/struct__KTIMER.html">KTIMER</a> <a class="el" href="../../d0/d6/iop_8h.html#a92">IopTimer</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00499">499</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a93" doxytag="iop.h::IopTimerCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d0/d6/iop_8h.html#a93">IopTimerCount</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00500">500</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05936">IopRemoveTimerFromTimerList()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l07182">IopTimerDispatch()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l10863">IoStartTimer()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l10916">IoStopTimer()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a91" doxytag="iop.h::IopTimerDpc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d6/struct__KDPC.html">KDPC</a> <a class="el" href="../../d0/d6/iop_8h.html#a91">IopTimerDpc</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00498">498</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a89" doxytag="iop.h::IopTimerLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KSPIN_LOCK <a class="el" href="../../d0/d6/iop_8h.html#a89">IopTimerLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00496">496</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a90" doxytag="iop.h::IopTimerQueueHead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d0/d6/iop_8h.html#a90">IopTimerQueueHead</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00497">497</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07543">IoInitializeTimer()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l07182">IopTimerDispatch()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a123" doxytag="iop.h::IopUniqueDeviceObjectNumber" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG <a class="el" href="../../d0/d6/iop_8h.html#a123">IopUniqueDeviceObjectNumber</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00535">535</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l04073">IoCreateDevice()</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a132" doxytag="iop.h::IopVerifierOn" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d6/d6/ioverifier_8c.html#a16">IopVerifierOn</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00548">548</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02149">IoCancelIrp()</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00248">IovCallDriver()</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00297">IovCompleteRequest()</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00091">IoVerifierInit()</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00206">IovFreeIrpPrivate()</a>, and <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l01159">IovSpecialIrpCallDriver()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a50" doxytag="iop.h::IopVpbSpinLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KSPIN_LOCK <a class="el" href="../../d0/d6/iop_8h.html#a50">IopVpbSpinLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00179">179</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a87" doxytag="iop.h::IoStatisticsLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KSPIN_LOCK <a class="el" href="../../d0/d6/iop_8h.html#a87">IoStatisticsLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00494">494</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a136" doxytag="iop.h::pIoAllocateIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d6/iop_8h.html#a38">PIO_ALLOCATE_IRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a136">pIoAllocateIrp</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00553">553</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00652">IoAllocateIrp()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00953">IopSetIoRoutines()</a>, and <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00091">IoVerifierInit()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a133" doxytag="iop.h::pIofCallDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PIO_CALL_DRIVER <a class="el" href="../../d0/d6/iop_8h.html#a133">pIofCallDriver</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00550">550</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02135">IofCallDriver()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00953">IopSetIoRoutines()</a>, and <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00091">IoVerifierInit()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a134" doxytag="iop.h::pIofCompleteRequest" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PIO_COMPLETE_REQUEST <a class="el" href="../../d0/d6/iop_8h.html#a134">pIofCompleteRequest</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00551">551</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l03166">IofCompleteRequest()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00953">IopSetIoRoutines()</a>, and <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00091">IoVerifierInit()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a135" doxytag="iop.h::pIoFreeIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d6/iop_8h.html#a37">PIO_FREE_IRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a135">pIoFreeIrp</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/iop_8h-source.html#l00552">552</a> of file <a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06632">IoFreeIrp()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00953">IopSetIoRoutines()</a>, and <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00091">IoVerifierInit()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:20 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
