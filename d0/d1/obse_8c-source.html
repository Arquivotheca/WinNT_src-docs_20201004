<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: obse.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>obse.c</h1><a href="../../d9/d1/obse_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    obse.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Object Security API calls</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Steve Wood (stevewo) 31-Mar-1989</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d5/d1/obp_8h.html">obp.h</a>"</span>
00022 
00023 <span class="preprocessor">#if defined(ALLOC_PRAGMA) &amp;&amp; defined(NTOS_KERNEL_RUNTIME)</span>
00024 <span class="preprocessor"></span>
00025 <span class="preprocessor">#pragma alloc_text(PAGE,NtSetSecurityObject)</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtQuerySecurityObject)</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObAssignObjectSecurityDescriptor)</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObAssignSecurity)</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObCheckCreateObjectAccess)</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObCheckObjectAccess)</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObCheckObjectReference)</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObpCheckTraverseAccess)</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObGetObjectSecurity)</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObSetSecurityDescriptorInfo)</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObQuerySecurityDescriptorInfo)</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObReleaseObjectSecurity)</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObSetSecurityQuotaCharged)</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObValidateSecurityQuota)</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObpValidateAccessMask)</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObSetSecurityObjectByPointer)</span>
00041 <span class="preprocessor"></span>
00042 <span class="preprocessor">#endif</span>
00043 <span class="preprocessor"></span>
00044 
00045 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00046"></a><a class="code" href="../../d9/d1/obse_8c.html#a0">00046</a> <a class="code" href="../../d9/d1/obse_8c.html#a0">NtSetSecurityObject</a> (
00047     IN HANDLE Handle,
00048     IN SECURITY_INFORMATION SecurityInformation,
00049     IN PSECURITY_DESCRIPTOR SecurityDescriptor
00050     )
00051 
00052 <span class="comment">/*++</span>
00053 <span class="comment"></span>
00054 <span class="comment">Routine Description:</span>
00055 <span class="comment"></span>
00056 <span class="comment">    This routine is used to invoke an object's security routine.  It</span>
00057 <span class="comment">    is used to set the object's security state.</span>
00058 <span class="comment"></span>
00059 <span class="comment">Arguments:</span>
00060 <span class="comment"></span>
00061 <span class="comment">    Handle - Supplies the handle for the object being modified</span>
00062 <span class="comment"></span>
00063 <span class="comment">    SecurityInformation - Indicates the type of information we are</span>
00064 <span class="comment">        interested in setting. e.g., owner, group, dacl, or sacl.</span>
00065 <span class="comment"></span>
00066 <span class="comment">    SecurityDescriptor - Supplies the security descriptor for the</span>
00067 <span class="comment">        object being modified.</span>
00068 <span class="comment"></span>
00069 <span class="comment">Return Value:</span>
00070 <span class="comment"></span>
00071 <span class="comment">    An appropriate NTSTATUS value</span>
00072 <span class="comment"></span>
00073 <span class="comment">--*/</span>
00074 
00075 {
00076     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00077     PVOID Object;
00078     ACCESS_MASK DesiredAccess;
00079     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a> HandleInformation;
00080     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> RequestorMode;
00081     SECURITY_DESCRIPTOR_RELATIVE *CapturedDescriptor;
00082 
00083     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00084 
00085     <span class="comment">//</span>
00086     <span class="comment">//  Make sure the passed security descriptor is really there.</span>
00087     <span class="comment">//  SeCaptureSecurityDescriptor doesn't mind being passed a NULL</span>
00088     <span class="comment">//  SecurityDescriptor, and will just return NULL back.</span>
00089     <span class="comment">//</span>
00090 
00091     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( SecurityDescriptor )) {
00092 
00093         <span class="keywordflow">return</span>( STATUS_ACCESS_VIOLATION );
00094     }
00095 
00096     <span class="comment">//</span>
00097     <span class="comment">//  Establish the accesses needed to the object based upon the</span>
00098     <span class="comment">//  security information being modified.</span>
00099     <span class="comment">//</span>
00100 
00101     <a class="code" href="../../d0/d6/semethod_8c.html#a1">SeSetSecurityAccessMask</a>( SecurityInformation, &amp;DesiredAccess );
00102 
00103     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
00104                                         DesiredAccess,
00105                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00106                                         RequestorMode = KeGetPreviousMode(),
00107                                         &amp;Object,
00108                                         &amp;HandleInformation );
00109 
00110     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00111 
00112         <span class="comment">//</span>
00113         <span class="comment">//  Probe and capture the input security descriptor, and return</span>
00114         <span class="comment">//  right away if it is ill-formed.</span>
00115         <span class="comment">//</span>
00116         <span class="comment">//  Because the security descriptor is always captured the returned</span>
00117         <span class="comment">//  security descriptor is in self-relative format.</span>
00118         <span class="comment">//</span>
00119 
00120         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a1">SeCaptureSecurityDescriptor</a>( SecurityDescriptor,
00121                                               RequestorMode,
00122                                               <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00123                                               <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00124                                               (PSECURITY_DESCRIPTOR *)&amp;CapturedDescriptor );
00125 
00126         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00127 
00128             <span class="comment">//</span>
00129             <span class="comment">//  Now check for a valid combination of what the user wants to set</span>
00130             <span class="comment">//  and what was supplied in the input security descriptor.  If the</span>
00131             <span class="comment">//  caller wants to set the owner then the owner field of the</span>
00132             <span class="comment">//  security descriptor better not be null, likewise for the group</span>
00133             <span class="comment">//  setting.  If anything is missing we'll return and error.</span>
00134             <span class="comment">//</span>
00135 
00136             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(CapturedDescriptor-&gt;Control &amp; SE_SELF_RELATIVE);
00137 
00138             <span class="keywordflow">if</span> (((SecurityInformation &amp; OWNER_SECURITY_INFORMATION) &amp;&amp;
00139                 (CapturedDescriptor-&gt;Owner == 0))
00140 
00141                 ||
00142 
00143                 ((SecurityInformation &amp; GROUP_SECURITY_INFORMATION) &amp;&amp;
00144                 (CapturedDescriptor-&gt;Group == 0))) {
00145 
00146                 <a class="code" href="../../d2/d5/se_2capture_8c.html#a2">SeReleaseSecurityDescriptor</a>( (PSECURITY_DESCRIPTOR)CapturedDescriptor,
00147                                              RequestorMode,
00148                                              <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00149 
00150                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Object );
00151 
00152                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00153                 <span class="keywordflow">return</span>( STATUS_INVALID_SECURITY_DESCR );
00154             }
00155 
00156             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a1">ObSetSecurityObjectByPointer</a>( Object,
00157                                                    SecurityInformation,
00158                                                    CapturedDescriptor );
00159 
00160             <a class="code" href="../../d2/d5/se_2capture_8c.html#a2">SeReleaseSecurityDescriptor</a>( (PSECURITY_DESCRIPTOR)CapturedDescriptor,
00161                                          RequestorMode,
00162                                          <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00163         }
00164 
00165         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Object );
00166 
00167     }
00168 
00169     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00170 }
00171 
00172 
00173 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00174"></a><a class="code" href="../../d9/d1/obse_8c.html#a1">00174</a> <a class="code" href="../../d9/d1/obse_8c.html#a1">ObSetSecurityObjectByPointer</a> (
00175     IN PVOID Object,
00176     IN SECURITY_INFORMATION SecurityInformation,
00177     IN PSECURITY_DESCRIPTOR SecurityDescriptor
00178     )
00179 
00180 <span class="comment">/*++</span>
00181 <span class="comment"></span>
00182 <span class="comment">Routine Description:</span>
00183 <span class="comment"></span>
00184 <span class="comment">    This routine is used to invoke an object's security routine.  It</span>
00185 <span class="comment">    is used to set the object's security state.</span>
00186 <span class="comment"></span>
00187 <span class="comment">    This routine is accessible only to the kernel and assumes that all</span>
00188 <span class="comment">    necessary validation of parameters has been done by the caller.</span>
00189 <span class="comment"></span>
00190 <span class="comment">Arguments:</span>
00191 <span class="comment"></span>
00192 <span class="comment">    Object - Supplies the pointer for the object being modified</span>
00193 <span class="comment"></span>
00194 <span class="comment">    SecurityInformation - Indicates the type of information we are</span>
00195 <span class="comment">        interested in setting. e.g., owner, group, dacl, or sacl.</span>
00196 <span class="comment"></span>
00197 <span class="comment">    SecurityDescriptor - Supplies the security descriptor for the</span>
00198 <span class="comment">        object being modified.</span>
00199 <span class="comment"></span>
00200 <span class="comment">Return Value:</span>
00201 <span class="comment"></span>
00202 <span class="comment">    An appropriate NTSTATUS value</span>
00203 <span class="comment"></span>
00204 <span class="comment">--*/</span>
00205 
00206 {
00207     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00208     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00209     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
00210 
00211     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00212 
00213 <span class="comment">//    DbgPrint("ObSetSecurityObjectByPointer called for object %#08lx with info "</span>
00214 <span class="comment">//             "%x and descriptor %#08lx\n",</span>
00215 <span class="comment">//             Object, SecurityInformation, SecurityDescriptor);</span>
00216 
00217     <span class="comment">//</span>
00218     <span class="comment">//  Map the object body to an object header and the corresponding</span>
00219     <span class="comment">//  object type</span>
00220     <span class="comment">//</span>
00221 
00222     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
00223     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
00224 
00225     <span class="comment">//</span>
00226     <span class="comment">//  Make sure the passed security descriptor is really there.</span>
00227     <span class="comment">//</span>
00228 
00229     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ARGUMENT_PRESENT( SecurityDescriptor ));
00230 
00231     <span class="comment">//</span>
00232     <span class="comment">//  Now invoke the security procedure call back to set the security</span>
00233     <span class="comment">//  descriptor for the object</span>
00234     <span class="comment">//</span>
00235 
00236     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o17">SecurityProcedure</a>)
00237                 ( Object,
00238                   <a class="code" href="../../d0/d5/se_8h.html#a200a108">SetSecurityDescriptor</a>,
00239                   &amp;SecurityInformation,
00240                   SecurityDescriptor,
00241                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00242                   &amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o10">SecurityDescriptor</a>,
00243                   ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a>,
00244                   &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> );
00245 
00246 
00247 <span class="comment">//    DbgPrint("ObSetSecurityObjectByPointer: object security routine returned "</span>
00248 <span class="comment">//             "%#08lx\n", Status);</span>
00249 
00250     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00251 }
00252 
00253 
00254 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00255"></a><a class="code" href="../../d9/d1/obse_8c.html#a2">00255</a> <a class="code" href="../../d9/d1/obse_8c.html#a2">NtQuerySecurityObject</a> (
00256     IN HANDLE Handle,
00257     IN SECURITY_INFORMATION SecurityInformation,
00258     OUT PSECURITY_DESCRIPTOR SecurityDescriptor,
00259     IN ULONG Length,
00260     OUT PULONG LengthNeeded
00261     )
00262 
00263 <span class="comment">/*++</span>
00264 <span class="comment"></span>
00265 <span class="comment">Routine Description:</span>
00266 <span class="comment"></span>
00267 <span class="comment">    This routine is used to query the security descriptor for an</span>
00268 <span class="comment">    object.</span>
00269 <span class="comment"></span>
00270 <span class="comment">Arguments:</span>
00271 <span class="comment"></span>
00272 <span class="comment">    Handle - Supplies the handle for the object being investigated</span>
00273 <span class="comment"></span>
00274 <span class="comment">    SecurityInformation - Indicates the type of information we are</span>
00275 <span class="comment">        interested in getting. e.g., owner, group, dacl, or sacl.</span>
00276 <span class="comment"></span>
00277 <span class="comment">    SecurityDescriptor - Supplies a pointer to where the information</span>
00278 <span class="comment">        should be returned</span>
00279 <span class="comment"></span>
00280 <span class="comment">    Length - Supplies the size, in bytes, of the output buffer</span>
00281 <span class="comment"></span>
00282 <span class="comment">    LengthNeeded - Receives the length, in bytes, needed to store</span>
00283 <span class="comment">        the output security descriptor</span>
00284 <span class="comment"></span>
00285 <span class="comment">Return Value:</span>
00286 <span class="comment"></span>
00287 <span class="comment">    An appropriate NTSTATUS value</span>
00288 <span class="comment"></span>
00289 <span class="comment">--*/</span>
00290 
00291 {
00292     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00293     PVOID Object;
00294     ACCESS_MASK DesiredAccess;
00295     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a> HandleInformation;
00296     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> RequestorMode;
00297     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00298     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
00299 
00300     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00301 
00302     <span class="comment">//</span>
00303     <span class="comment">//  Probe output parameters</span>
00304     <span class="comment">//</span>
00305 
00306     RequestorMode = KeGetPreviousMode();
00307 
00308     <span class="keywordflow">if</span> (RequestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00309 
00310         <span class="keywordflow">try</span> {
00311 
00312             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>( LengthNeeded );
00313 
00314             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( SecurityDescriptor, Length, <span class="keyword">sizeof</span>(ULONG) );
00315 
00316         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00317 
00318             <span class="keywordflow">return</span> GetExceptionCode();
00319         }
00320     }
00321 
00322     <span class="comment">//</span>
00323     <span class="comment">//  Establish the accesses needed to the object based upon the</span>
00324     <span class="comment">//  security information being queried</span>
00325     <span class="comment">//</span>
00326 
00327     <a class="code" href="../../d0/d6/semethod_8c.html#a2">SeQuerySecurityAccessMask</a>( SecurityInformation, &amp;DesiredAccess );
00328 
00329     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
00330                                         DesiredAccess,
00331                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00332                                         RequestorMode,
00333                                         &amp;Object,
00334                                         &amp;HandleInformation );
00335 
00336     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00337 
00338         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00339     }
00340 
00341     <span class="comment">//</span>
00342     <span class="comment">//  Map the object body to an object header and the corresponding</span>
00343     <span class="comment">//  object type</span>
00344     <span class="comment">//</span>
00345 
00346     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
00347     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
00348 
00349     <span class="comment">//</span>
00350     <span class="comment">//  Invoke the object type's security callback routine to query</span>
00351     <span class="comment">//  the object.  This routine is assumed to have a try-except around</span>
00352     <span class="comment">//  the setting of the output security descriptor</span>
00353     <span class="comment">//</span>
00354 
00355     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o17">SecurityProcedure</a>)( Object,
00356                                                        <a class="code" href="../../d0/d5/se_8h.html#a200a109">QuerySecurityDescriptor</a>,
00357                                                        &amp;SecurityInformation,
00358                                                        SecurityDescriptor,
00359                                                        &amp;Length,
00360                                                        &amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o10">SecurityDescriptor</a>,
00361                                                        ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a>,
00362                                                        &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> );
00363 
00364     <span class="comment">//</span>
00365     <span class="comment">//  Indicate the length needed for the security descriptor.  This</span>
00366     <span class="comment">//  will be set even if the callback failed so the caller will know</span>
00367     <span class="comment">//  the number of bytes necessary</span>
00368     <span class="comment">//</span>
00369 
00370     <span class="keywordflow">try</span> {
00371 
00372         *LengthNeeded = Length;
00373 
00374     } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00375 
00376         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Object );
00377 
00378         <span class="keywordflow">return</span>(GetExceptionCode());
00379     }
00380 
00381     <span class="comment">//</span>
00382     <span class="comment">//  And return to our caller</span>
00383     <span class="comment">//</span>
00384 
00385     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Object );
00386 
00387     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00388 }
00389 
00390 
00391 BOOLEAN
<a name="l00392"></a><a class="code" href="../../d9/d1/obse_8c.html#a3">00392</a> <a class="code" href="../../d9/d1/obse_8c.html#a3">ObCheckObjectAccess</a> (
00393     IN PVOID Object,
00394     IN OUT <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState,
00395     IN BOOLEAN TypeMutexLocked,
00396     IN KPROCESSOR_MODE AccessMode,
00397     OUT PNTSTATUS AccessStatus
00398     )
00399 
00400 <span class="comment">/*++</span>
00401 <span class="comment"></span>
00402 <span class="comment">Routine Description:</span>
00403 <span class="comment"></span>
00404 <span class="comment">    This routine performs access validation on the passed object.  The</span>
00405 <span class="comment">    remaining desired access mask is extracted from the AccessState</span>
00406 <span class="comment">    parameter and passes to the appropriate security routine to perform the</span>
00407 <span class="comment">    access check.</span>
00408 <span class="comment"></span>
00409 <span class="comment">    If the access attempt is successful, SeAccessCheck returns a mask</span>
00410 <span class="comment">    containing the granted accesses.  The bits in this mask are turned</span>
00411 <span class="comment">    on in the PreviouslyGrantedAccess field of the AccessState, and</span>
00412 <span class="comment">    are turned off in the RemainingDesiredAccess field.</span>
00413 <span class="comment"></span>
00414 <span class="comment">Arguments:</span>
00415 <span class="comment"></span>
00416 <span class="comment">    Object - The object being examined.</span>
00417 <span class="comment"></span>
00418 <span class="comment">    AccessState - The ACCESS_STATE structure containing accumulated</span>
00419 <span class="comment">        information about the current attempt to gain access to the object.</span>
00420 <span class="comment"></span>
00421 <span class="comment">    TypeMutexLocked - Indicates whether the type mutex for this object's</span>
00422 <span class="comment">        type is locked.  The type mutex is used to protect the object's</span>
00423 <span class="comment">        security descriptor from being modified while it is being accessed.</span>
00424 <span class="comment"></span>
00425 <span class="comment">    AccessMode - The previous processor mode.</span>
00426 <span class="comment"></span>
00427 <span class="comment">    AccessStatus - Pointer to a variable to return the status code of the</span>
00428 <span class="comment">        access attempt.  In the case of failure this status code must be</span>
00429 <span class="comment">        propagated back to the user.</span>
00430 <span class="comment"></span>
00431 <span class="comment"></span>
00432 <span class="comment">Return Value:</span>
00433 <span class="comment"></span>
00434 <span class="comment">    BOOLEAN - TRUE if access is allowed and FALSE otherwise</span>
00435 <span class="comment"></span>
00436 <span class="comment">--*/</span>
00437 
00438 {
00439     ACCESS_MASK GrantedAccess = 0;
00440     BOOLEAN AccessAllowed;
00441     BOOLEAN MemoryAllocated;
00442     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00443     PSECURITY_DESCRIPTOR SecurityDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00444     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00445     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
00446     PPRIVILEGE_SET Privileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00447 
00448     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00449 
00450     <span class="comment">//</span>
00451     <span class="comment">//  Map the object body to an object header and the</span>
00452     <span class="comment">//  corresponding object type</span>
00453     <span class="comment">//</span>
00454 
00455     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
00456     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
00457 
00458     <span class="comment">//</span>
00459     <span class="comment">//  If the caller does not have the object type locked</span>
00460     <span class="comment">//  then lock it down</span>
00461     <span class="comment">//</span>
00462 
00463     <span class="keywordflow">if</span> (!TypeMutexLocked) {
00464 
00465         <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
00466     }
00467 
00468     <span class="comment">//</span>
00469     <span class="comment">//  Obtain the object's security descriptor</span>
00470     <span class="comment">//</span>
00471 
00472     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a8">ObGetObjectSecurity</a>( Object,
00473                                   &amp;SecurityDescriptor,
00474                                   &amp;MemoryAllocated );
00475 
00476     <span class="comment">//</span>
00477     <span class="comment">//  If we failed in getting the security descriptor then</span>
00478     <span class="comment">//  put the object type lock back where it was and return</span>
00479     <span class="comment">//  the error back to our caller</span>
00480     <span class="comment">//</span>
00481 
00482     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00483 
00484         <span class="keywordflow">if</span> (!TypeMutexLocked) {
00485 
00486             <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
00487         }
00488 
00489         *AccessStatus = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00490 
00491         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00492 
00493     } <span class="keywordflow">else</span> {
00494 
00495         <span class="comment">//</span>
00496         <span class="comment">//  Otherwise we've been successful at getting the</span>
00497         <span class="comment">//  object's security descriptor, but now make sure</span>
00498         <span class="comment">//  it is not null.</span>
00499 
00500         <span class="keywordflow">if</span> (SecurityDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00501 
00502             <span class="keywordflow">if</span> (!TypeMutexLocked) {
00503 
00504                 <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
00505             }
00506 
00507             *AccessStatus = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00508 
00509             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00510         }
00511     }
00512 
00513     <span class="comment">//</span>
00514     <span class="comment">//  We have a non-null security descriptor so now</span>
00515     <span class="comment">//  lock the caller's tokens until after auditing has been</span>
00516     <span class="comment">//  performed.</span>
00517     <span class="comment">//</span>
00518 
00519     <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
00520 
00521     <span class="comment">//</span>
00522     <span class="comment">//  Do the access check, and if we have some privileges then</span>
00523     <span class="comment">//  put those in the access state too.</span>
00524     <span class="comment">//</span>
00525 
00526     AccessAllowed = <a class="code" href="../../d0/d4/accessck_8c.html#a18">SeAccessCheck</a>( SecurityDescriptor,
00527                                    &amp;AccessState-&gt;SubjectSecurityContext,
00528                                    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,                        <span class="comment">// Tokens are locked</span>
00529                                    AccessState-&gt;RemainingDesiredAccess,
00530                                    AccessState-&gt;PreviouslyGrantedAccess,
00531                                    &amp;Privileges,
00532                                    &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>,
00533                                    AccessMode,
00534                                    &amp;GrantedAccess,
00535                                    AccessStatus );
00536 
00537     <span class="keywordflow">if</span> (Privileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00538 
00539         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/seastate_8c.html#a5">SeAppendPrivileges</a>( AccessState,
00540                                      Privileges );
00541 
00542         <a class="code" href="../../d0/d4/accessck_8c.html#a17">SeFreePrivileges</a>( Privileges );
00543     }
00544 
00545     <span class="comment">//</span>
00546     <span class="comment">//  If we were granted access then set that fact into</span>
00547     <span class="comment">//  what we've been granted and remove it from what remains</span>
00548     <span class="comment">//  to be granted.</span>
00549     <span class="comment">//</span>
00550 
00551     <span class="keywordflow">if</span> (AccessAllowed) {
00552 
00553         AccessState-&gt;PreviouslyGrantedAccess |= GrantedAccess;
00554         AccessState-&gt;RemainingDesiredAccess &amp;= ~(GrantedAccess | MAXIMUM_ALLOWED);
00555     }
00556 
00557     <span class="comment">//</span>
00558     <span class="comment">//  Audit the attempt to open the object, audit</span>
00559     <span class="comment">//  the creation of its handle later.</span>
00560     <span class="comment">//</span>
00561     <span class="comment">//  **** SecurityDescriptor cannot be null</span>
00562     <span class="comment">//</span>
00563 
00564     <span class="keywordflow">if</span> ( SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00565 
00566         <a class="code" href="../../d3/d5/seaudit_8c.html#a23">SeOpenObjectAuditAlarm</a>( &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o2">Name</a>,
00567                                 Object,
00568                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                    <span class="comment">// AbsoluteObjectName</span>
00569                                 SecurityDescriptor,
00570                                 AccessState,
00571                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                   <span class="comment">// ObjectCreated (FALSE, only open here)</span>
00572                                 AccessAllowed,
00573                                 AccessMode,
00574                                 &amp;AccessState-&gt;GenerateOnClose );
00575     }
00576 
00577     <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
00578 
00579     <span class="comment">//</span>
00580     <span class="comment">//  If the caller didn't lock the object type then we have to</span>
00581     <span class="comment">//  remove our lock on it.</span>
00582     <span class="comment">//</span>
00583 
00584     <span class="keywordflow">if</span> (!TypeMutexLocked) {
00585 
00586         <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
00587     }
00588 
00589     <span class="comment">//</span>
00590     <span class="comment">//  Free the security descriptor before returning to</span>
00591     <span class="comment">//  our caller</span>
00592     <span class="comment">//</span>
00593 
00594     <a class="code" href="../../d9/d1/obse_8c.html#a9">ObReleaseObjectSecurity</a>( SecurityDescriptor,
00595                              MemoryAllocated );
00596 
00597     <span class="keywordflow">return</span>( AccessAllowed );
00598 }
00599 
00600 
00601 BOOLEAN
<a name="l00602"></a><a class="code" href="../../d9/d1/obse_8c.html#a4">00602</a> <a class="code" href="../../d9/d1/obse_8c.html#a4">ObpCheckObjectReference</a> (
00603     IN PVOID Object,
00604     IN OUT <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState,
00605     IN BOOLEAN TypeMutexLocked,
00606     IN KPROCESSOR_MODE AccessMode,
00607     OUT PNTSTATUS AccessStatus
00608     )
00609 
00610 <span class="comment">/*++</span>
00611 <span class="comment"></span>
00612 <span class="comment">Routine Description:</span>
00613 <span class="comment"></span>
00614 <span class="comment">    The routine performs access validation on the passed object.  The</span>
00615 <span class="comment">    remaining desired access mask is extracted from the AccessState</span>
00616 <span class="comment">    parameter and passes to the appropriate security routine to</span>
00617 <span class="comment">    perform the access check.</span>
00618 <span class="comment"></span>
00619 <span class="comment">    If the access attempt is successful, SeAccessCheck returns a mask</span>
00620 <span class="comment">    containing the granted accesses.  The bits in this mask are turned</span>
00621 <span class="comment">    on in the PreviouslyGrantedAccess field of the AccessState, and</span>
00622 <span class="comment">    are turned off in the RemainingDesiredAccess field.</span>
00623 <span class="comment"></span>
00624 <span class="comment">    This routine differs from ObpCheckObjectAccess in that it calls</span>
00625 <span class="comment">    a different audit routine.</span>
00626 <span class="comment"></span>
00627 <span class="comment">Arguments:</span>
00628 <span class="comment"></span>
00629 <span class="comment">    Object - The object being examined.</span>
00630 <span class="comment"></span>
00631 <span class="comment">    AccessState - The ACCESS_STATE structure containing accumulated</span>
00632 <span class="comment">        information about the current attempt to gain access to the object.</span>
00633 <span class="comment"></span>
00634 <span class="comment">    TypeMutexLocked - Indicates whether the type mutex for this object's</span>
00635 <span class="comment">        type is locked.  The type mutex is used to protect the object's</span>
00636 <span class="comment">        security descriptor from being modified while it is being accessed.</span>
00637 <span class="comment"></span>
00638 <span class="comment">    AccessMode - The previous processor mode.</span>
00639 <span class="comment"></span>
00640 <span class="comment">    AccessStatus - Pointer to a variable to return the status code of the</span>
00641 <span class="comment">        access attempt.  In the case of failure this status code must be</span>
00642 <span class="comment">        propagated back to the user.</span>
00643 <span class="comment"></span>
00644 <span class="comment"></span>
00645 <span class="comment">Return Value:</span>
00646 <span class="comment"></span>
00647 <span class="comment">    BOOLEAN - TRUE if access is allowed and FALSE otherwise</span>
00648 <span class="comment"></span>
00649 <span class="comment">--*/</span>
00650 
00651 {
00652     BOOLEAN AccessAllowed;
00653     ACCESS_MASK GrantedAccess = 0;
00654     BOOLEAN MemoryAllocated;
00655     PSECURITY_DESCRIPTOR SecurityDescriptor;
00656     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00657     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00658     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
00659     PPRIVILEGE_SET Privileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00660 
00661     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00662 
00663     <span class="comment">//</span>
00664     <span class="comment">//  Map the object body to an object header and the</span>
00665     <span class="comment">//  corresponding object type</span>
00666     <span class="comment">//</span>
00667 
00668     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
00669     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
00670 
00671     <span class="comment">//</span>
00672     <span class="comment">//  If the caller does not have the object type locked</span>
00673     <span class="comment">//  then lock it down</span>
00674     <span class="comment">//</span>
00675 
00676     <span class="keywordflow">if</span> (!TypeMutexLocked) {
00677 
00678         <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
00679     }
00680 
00681     <span class="comment">//</span>
00682     <span class="comment">//  Obtain the object's security descriptor</span>
00683     <span class="comment">//</span>
00684 
00685     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a8">ObGetObjectSecurity</a>( Object,
00686                                   &amp;SecurityDescriptor,
00687                                   &amp;MemoryAllocated );
00688 
00689     <span class="comment">//</span>
00690     <span class="comment">//  If we failed in getting the security descriptor then</span>
00691     <span class="comment">//  put the object type lock back where it was and return</span>
00692     <span class="comment">//  the error back to our caller</span>
00693     <span class="comment">//</span>
00694 
00695     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00696 
00697         <span class="keywordflow">if</span> (!TypeMutexLocked) {
00698 
00699             <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
00700         }
00701 
00702         *AccessStatus = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00703 
00704         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00705     }
00706 
00707     <span class="comment">//</span>
00708     <span class="comment">//  Lock the caller's tokens until after auditing has been</span>
00709     <span class="comment">//  performed.</span>
00710     <span class="comment">//</span>
00711 
00712     <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
00713 
00714     <span class="comment">//</span>
00715     <span class="comment">//  Do the access check, and if we have some privileges then</span>
00716     <span class="comment">//  put those in the access state too.</span>
00717     <span class="comment">//</span>
00718 
00719     AccessAllowed = <a class="code" href="../../d0/d4/accessck_8c.html#a18">SeAccessCheck</a>( SecurityDescriptor,
00720                                    &amp;AccessState-&gt;SubjectSecurityContext,
00721                                    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,               <span class="comment">// Tokens are locked</span>
00722                                    AccessState-&gt;RemainingDesiredAccess,
00723                                    AccessState-&gt;PreviouslyGrantedAccess,
00724                                    &amp;Privileges,
00725                                    &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>,
00726                                    AccessMode,
00727                                    &amp;GrantedAccess,
00728                                    AccessStatus );
00729 
00730     <span class="keywordflow">if</span> (AccessAllowed) {
00731 
00732         AccessState-&gt;PreviouslyGrantedAccess |= GrantedAccess;
00733         AccessState-&gt;RemainingDesiredAccess &amp;= ~GrantedAccess;
00734     }
00735 
00736     <span class="comment">//</span>
00737     <span class="comment">//  If we have a security descriptor then call the security routine</span>
00738     <span class="comment">//  to audit this reference and then unlock the caller's token</span>
00739     <span class="comment">//</span>
00740 
00741     <span class="keywordflow">if</span> ( SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00742 
00743         <a class="code" href="../../d3/d5/seaudit_8c.html#a27">SeObjectReferenceAuditAlarm</a>( &amp;AccessState-&gt;OperationID,
00744                                      Object,
00745                                      SecurityDescriptor,
00746                                      &amp;AccessState-&gt;SubjectSecurityContext,
00747                                      AccessState-&gt;RemainingDesiredAccess | AccessState-&gt;PreviouslyGrantedAccess,
00748                                      ((<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">PAUX_ACCESS_DATA</a>)(AccessState-&gt;AuxData))-&gt;PrivilegesUsed,
00749                                      AccessAllowed,
00750                                      AccessMode );
00751     }
00752 
00753     <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
00754 
00755     <span class="comment">//</span>
00756     <span class="comment">//  If the caller didn't have the object type locked then remove</span>
00757     <span class="comment">//  our lock</span>
00758     <span class="comment">//</span>
00759 
00760     <span class="keywordflow">if</span> (!TypeMutexLocked) {
00761 
00762         <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
00763     }
00764 
00765     <span class="comment">//</span>
00766     <span class="comment">//  Finally free the security descriptor</span>
00767     <span class="comment">//  and return to our caller</span>
00768     <span class="comment">//</span>
00769 
00770     <a class="code" href="../../d9/d1/obse_8c.html#a9">ObReleaseObjectSecurity</a>( SecurityDescriptor,
00771                              MemoryAllocated );
00772 
00773     <span class="keywordflow">return</span>( AccessAllowed );
00774 }
00775 
00776 
00777 BOOLEAN
<a name="l00778"></a><a class="code" href="../../d9/d1/obse_8c.html#a5">00778</a> <a class="code" href="../../d9/d1/obse_8c.html#a5">ObpCheckTraverseAccess</a> (
00779     IN PVOID DirectoryObject,
00780     IN ACCESS_MASK TraverseAccess,
00781     IN <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState OPTIONAL,
00782     IN BOOLEAN TypeMutexLocked,
00783     IN KPROCESSOR_MODE PreviousMode,
00784     OUT PNTSTATUS AccessStatus
00785     )
00786 
00787 <span class="comment">/*++</span>
00788 <span class="comment"></span>
00789 <span class="comment">Routine Description:</span>
00790 <span class="comment"></span>
00791 <span class="comment">    This routine checks for traverse access to the given directory object.</span>
00792 <span class="comment"></span>
00793 <span class="comment">    Note that the contents of the AccessState structure are not</span>
00794 <span class="comment">    modified, since it is assumed that this access check is incidental</span>
00795 <span class="comment">    to another access operation.</span>
00796 <span class="comment"></span>
00797 <span class="comment">Arguments:</span>
00798 <span class="comment"></span>
00799 <span class="comment">    DirectoryObject - The object body of the object being examined.</span>
00800 <span class="comment"></span>
00801 <span class="comment">    TraverseAccess - The desired access to the object, most likely DIRECTORY</span>
00802 <span class="comment">        TRAVERSE access.</span>
00803 <span class="comment"></span>
00804 <span class="comment">    AccessState - Checks for traverse access will typically be incidental</span>
00805 <span class="comment">        to some other access attempt.  Information on the current state of</span>
00806 <span class="comment">        that access attempt is required so that the constituent access</span>
00807 <span class="comment">        attempts may be associated with each other in the audit log.</span>
00808 <span class="comment">        This is an OPTIONAL parameter, in which case the call will</span>
00809 <span class="comment">        success ONLY if the Directory Object grants World traverse</span>
00810 <span class="comment">        access rights.</span>
00811 <span class="comment"></span>
00812 <span class="comment">    TypeMutexLocked - Indicates whether the type mutex for this object's</span>
00813 <span class="comment">        type is locked.  The type mutex is used to protect the object's</span>
00814 <span class="comment">        security descriptor from being modified while it is being accessed.</span>
00815 <span class="comment"></span>
00816 <span class="comment">    PreviousMode - The previous processor mode.</span>
00817 <span class="comment"></span>
00818 <span class="comment">    AccessStatus - Pointer to a variable to return the status code of the</span>
00819 <span class="comment">        access attempt.  In the case of failure this status code must be</span>
00820 <span class="comment">        propagated back to the user.</span>
00821 <span class="comment"></span>
00822 <span class="comment">Return Value:</span>
00823 <span class="comment"></span>
00824 <span class="comment">    BOOLEAN - TRUE if access is allowed and FALSE otherwise.  AccessStatus</span>
00825 <span class="comment">    contains the status code to be passed back to the caller.  It is not</span>
00826 <span class="comment">    correct to simply pass back STATUS_ACCESS_DENIED, since this will have</span>
00827 <span class="comment">    to change with the advent of mandatory access control.</span>
00828 <span class="comment"></span>
00829 <span class="comment">--*/</span>
00830 
00831 {
00832     BOOLEAN AccessAllowed;
00833     ACCESS_MASK GrantedAccess = 0;
00834     PSECURITY_DESCRIPTOR SecurityDescriptor;
00835     BOOLEAN MemoryAllocated;
00836     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00837     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00838     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
00839     BOOLEAN SubjectContextLocked = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00840     PPRIVILEGE_SET Privileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00841 
00842     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00843 
00844     <span class="comment">//</span>
00845     <span class="comment">//  Map the object body to an object header and corresponding</span>
00846     <span class="comment">//  object type</span>
00847     <span class="comment">//</span>
00848 
00849     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( DirectoryObject );
00850     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
00851 
00852     <span class="comment">//</span>
00853     <span class="comment">//  If the caller hasn't locked down the object type then</span>
00854     <span class="comment">//  lock it down now</span>
00855     <span class="comment">//</span>
00856 
00857     <span class="keywordflow">if</span> (!TypeMutexLocked) {
00858 
00859         <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
00860     }
00861 
00862     <span class="comment">//</span>
00863     <span class="comment">//  Obtain the object's security descriptor and make it was</span>
00864     <span class="comment">//  successful</span>
00865     <span class="comment">//</span>
00866 
00867     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a8">ObGetObjectSecurity</a>( DirectoryObject,
00868                                   &amp;SecurityDescriptor,
00869                                   &amp;MemoryAllocated );
00870 
00871     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00872 
00873         <span class="keywordflow">if</span> (!TypeMutexLocked) {
00874 
00875             <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
00876         }
00877 
00878         *AccessStatus = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00879 
00880         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00881     }
00882 
00883     <span class="comment">//</span>
00884     <span class="comment">//  Check to see if WORLD has TRAVERSE access, by seeing if the</span>
00885     <span class="comment">//  token is restricted or the fast traverse check fails meaning</span>
00886     <span class="comment">//  that the world does not have traverse access</span>
00887     <span class="comment">//</span>
00888 
00889     <span class="keywordflow">if</span> (((AccessState-&gt;Flags &amp; <a class="code" href="../../d0/d5/se_8h.html#a5">TOKEN_IS_RESTRICTED</a>) != 0)
00890 
00891         ||
00892 
00893         (!<a class="code" href="../../d0/d4/accessck_8c.html#a22">SeFastTraverseCheck</a>( SecurityDescriptor,
00894                                DIRECTORY_TRAVERSE,
00895                                PreviousMode ))) {
00896 
00897         <span class="comment">//</span>
00898         <span class="comment">//  SeFastTraverseCheck could be modified to tell us that</span>
00899         <span class="comment">//  no one has any access to this directory.  However,</span>
00900         <span class="comment">//  we're going to have to fail this entire call if</span>
00901         <span class="comment">//  that is the case, so we really don't need to worry</span>
00902         <span class="comment">//  all that much about making it blindingly fast.</span>
00903         <span class="comment">//</span>
00904 
00905         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( AccessState )) {
00906 
00907             <span class="comment">//</span>
00908             <span class="comment">//  The world does not have traverse access and we have</span>
00909             <span class="comment">//  the client's access state so lock down the client's</span>
00910             <span class="comment">//  token and then do the access check, appending privileges</span>
00911             <span class="comment">//  if present.  The access check will give the answer</span>
00912             <span class="comment">//  we return back to our caller</span>
00913             <span class="comment">//</span>
00914 
00915             <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
00916 
00917             SubjectContextLocked = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00918 
00919             AccessAllowed = <a class="code" href="../../d0/d4/accessck_8c.html#a18">SeAccessCheck</a>( SecurityDescriptor,
00920                                            &amp;AccessState-&gt;SubjectSecurityContext,
00921                                            <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,             <span class="comment">// Tokens are locked</span>
00922                                            TraverseAccess,
00923                                            0,
00924                                            &amp;Privileges,
00925                                            &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>,
00926                                            PreviousMode,
00927                                            &amp;GrantedAccess,
00928                                            AccessStatus );
00929 
00930             <span class="keywordflow">if</span> (Privileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00931 
00932                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/seastate_8c.html#a5">SeAppendPrivileges</a>( AccessState,
00933                                              Privileges );
00934 
00935                 <a class="code" href="../../d0/d4/accessck_8c.html#a17">SeFreePrivileges</a>( Privileges );
00936             }
00937         }
00938 
00939     } <span class="keywordflow">else</span> {
00940 
00941         <span class="comment">//</span>
00942         <span class="comment">//  At this point the world has traverse access</span>
00943         <span class="comment">//</span>
00944 
00945         AccessAllowed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00946     }
00947 
00948     <span class="comment">//</span>
00949     <span class="comment">//  If the client's token is locked then now we can unlock it</span>
00950     <span class="comment">//</span>
00951     <span class="comment">//  **** this should be able to move up into the preceding clause</span>
00952     <span class="comment">//  where it is locked</span>
00953     <span class="comment">//</span>
00954 
00955     <span class="keywordflow">if</span> ( SubjectContextLocked ) {
00956 
00957         <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
00958     }
00959 
00960     <span class="comment">//</span>
00961     <span class="comment">//  If the caller did not lock the object type then we</span>
00962     <span class="comment">//  now need to unlock it</span>
00963     <span class="comment">//</span>
00964 
00965     <span class="keywordflow">if</span> (!TypeMutexLocked) {
00966 
00967         <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
00968     }
00969 
00970     <span class="comment">//</span>
00971     <span class="comment">//  Finally free the security descriptor</span>
00972     <span class="comment">//  and then return to our caller</span>
00973     <span class="comment">//</span>
00974 
00975     <a class="code" href="../../d9/d1/obse_8c.html#a9">ObReleaseObjectSecurity</a>( SecurityDescriptor,
00976                              MemoryAllocated );
00977 
00978     <span class="keywordflow">return</span>( AccessAllowed );
00979 }
00980 
00981 
00982 BOOLEAN
<a name="l00983"></a><a class="code" href="../../d9/d1/obse_8c.html#a6">00983</a> <a class="code" href="../../d9/d1/obse_8c.html#a6">ObCheckCreateObjectAccess</a> (
00984     IN PVOID DirectoryObject,
00985     IN ACCESS_MASK CreateAccess,
00986     IN <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState,
00987     IN PUNICODE_STRING ComponentName,
00988     IN BOOLEAN TypeMutexLocked,
00989     IN KPROCESSOR_MODE PreviousMode,
00990     OUT PNTSTATUS AccessStatus
00991     )
00992 
00993 <span class="comment">/*++</span>
00994 <span class="comment"></span>
00995 <span class="comment">Routine Description:</span>
00996 <span class="comment"></span>
00997 <span class="comment">    This routine checks to see if we are allowed to create an object in the</span>
00998 <span class="comment">    given directory, and performs auditing as appropriate.</span>
00999 <span class="comment"></span>
01000 <span class="comment">Arguments:</span>
01001 <span class="comment"></span>
01002 <span class="comment">    DirectoryObject - The directory object being examined.</span>
01003 <span class="comment"></span>
01004 <span class="comment">    CreateAccess - The access mask corresponding to create access for</span>
01005 <span class="comment">        this directory type.</span>
01006 <span class="comment"></span>
01007 <span class="comment">    AccessState - Checks for traverse access will typically be incidental</span>
01008 <span class="comment">        to some other access attempt.  Information on the current state of</span>
01009 <span class="comment">        that access attempt is required so that the constituent access</span>
01010 <span class="comment">        attempts may be associated with each other in the audit log.</span>
01011 <span class="comment"></span>
01012 <span class="comment">    ComponentName - Pointer to a Unicode string containing the name of</span>
01013 <span class="comment">        the object being created.</span>
01014 <span class="comment"></span>
01015 <span class="comment">    TypeMutexLocked - Indicates whether the type mutex for this object's</span>
01016 <span class="comment">        type is locked.  The type mutex is used to protect the object's</span>
01017 <span class="comment">        security descriptor from being modified while it is being accessed.</span>
01018 <span class="comment"></span>
01019 <span class="comment">    PreviousMode - The previous processor mode.</span>
01020 <span class="comment"></span>
01021 <span class="comment">    AccessStatus - Pointer to a variable to return the status code of the</span>
01022 <span class="comment">        access attempt.  In the case of failure this status code must be</span>
01023 <span class="comment">        propagated back to the user.</span>
01024 <span class="comment"></span>
01025 <span class="comment">Return Value:</span>
01026 <span class="comment"></span>
01027 <span class="comment">    BOOLEAN - TRUE if access is allowed and FALSE otherwise.  AccessStatus</span>
01028 <span class="comment">    contains the status code to be passed back to the caller.  It is not</span>
01029 <span class="comment">    correct to simply pass back STATUS_ACCESS_DENIED, since this will have</span>
01030 <span class="comment">    to change with the advent of mandatory access control.</span>
01031 <span class="comment"></span>
01032 <span class="comment">--*/</span>
01033 
01034 {
01035     BOOLEAN AccessAllowed;
01036     ACCESS_MASK GrantedAccess = 0;
01037     PSECURITY_DESCRIPTOR SecurityDescriptor;
01038     BOOLEAN MemoryAllocated;
01039     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01040     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01041     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
01042     PPRIVILEGE_SET Privileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01043     BOOLEAN AuditPerformed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01044 
01045     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01046 
01047     <span class="comment">//</span>
01048     <span class="comment">//  Map the object body to its object header and corresponding</span>
01049     <span class="comment">//  object type</span>
01050     <span class="comment">//</span>
01051 
01052     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( DirectoryObject );
01053     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
01054 
01055     <span class="comment">//</span>
01056     <span class="comment">//  If the caller didn't lock the object type down then</span>
01057     <span class="comment">//  we'll do it now</span>
01058     <span class="comment">//</span>
01059 
01060     <span class="keywordflow">if</span> (!TypeMutexLocked) {
01061 
01062         <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
01063     }
01064 
01065     <span class="comment">//</span>
01066     <span class="comment">//  Obtain the object's security descriptor and make it was</span>
01067     <span class="comment">//  successful</span>
01068     <span class="comment">//</span>
01069 
01070     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a8">ObGetObjectSecurity</a>( DirectoryObject,
01071                                   &amp;SecurityDescriptor,
01072                                   &amp;MemoryAllocated );
01073 
01074     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01075 
01076         <span class="keywordflow">if</span> (!TypeMutexLocked) {
01077 
01078             <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
01079         }
01080 
01081         *AccessStatus = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01082 
01083         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01084     }
01085 
01086     <span class="comment">//</span>
01087     <span class="comment">//  lock the caller's tokens until after auditing has been</span>
01088     <span class="comment">//  performed.</span>
01089     <span class="comment">//</span>
01090 
01091     <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
01092 
01093     <span class="comment">//</span>
01094     <span class="comment">//  if we have a security descriptor then do an access</span>
01095     <span class="comment">//  check to see if access is allowed and set in the</span>
01096     <span class="comment">//  privileges if necessary</span>
01097     <span class="comment">//</span>
01098 
01099     <span class="keywordflow">if</span> (SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01100 
01101         AccessAllowed = <a class="code" href="../../d0/d4/accessck_8c.html#a18">SeAccessCheck</a>( SecurityDescriptor,
01102                                        &amp;AccessState-&gt;SubjectSecurityContext,
01103                                        <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,            <span class="comment">// Tokens are locked</span>
01104                                        CreateAccess,
01105                                        0,
01106                                        &amp;Privileges,
01107                                        &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>,
01108                                        PreviousMode,
01109                                        &amp;GrantedAccess,
01110                                        AccessStatus );
01111 
01112         <span class="keywordflow">if</span> (Privileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01113 
01114             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/seastate_8c.html#a5">SeAppendPrivileges</a>( AccessState,
01115                                          Privileges );
01116 
01117             <a class="code" href="../../d0/d4/accessck_8c.html#a17">SeFreePrivileges</a>( Privileges );
01118         }
01119 
01120         <span class="comment">//</span>
01121         <span class="comment">//  This is wrong, but leave for reference.</span>
01122         <span class="comment">//</span>
01123         <span class="comment">//  if (AccessAllowed) {</span>
01124         <span class="comment">//</span>
01125         <span class="comment">//      AccessState-&gt;PreviouslyGrantedAccess |= GrantedAccess;</span>
01126         <span class="comment">//      AccessState-&gt;RemainingDesiredAccess &amp;= ~GrantedAccess;</span>
01127         <span class="comment">//  }</span>
01128         <span class="comment">//</span>
01129 
01130 <span class="preprocessor">#if 0</span>
01131 <span class="preprocessor"></span>        <a class="code" href="../../d3/d5/seaudit_8c.html#a26">SeCreateObjectAuditAlarm</a>( &amp;AccessState-&gt;OperationID,
01132                                   DirectoryObject,
01133                                   ComponentName,
01134                                   SecurityDescriptor,
01135                                   &amp;AccessState-&gt;SubjectSecurityContext,
01136                                   CreateAccess,
01137                                   AccessState-&gt;PrivilegesUsed,
01138                                   AccessAllowed,
01139                                   &amp;AuditPerformed,
01140                                   PreviousMode );
01141 
01142         <span class="keywordflow">if</span> ( AuditPerformed ) {
01143 
01144             AccessState-&gt;AuditHandleCreation = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01145         }
01146 <span class="preprocessor">#endif</span>
01147 <span class="preprocessor"></span>
01148     } <span class="keywordflow">else</span> {
01149 
01150         <span class="comment">//</span>
01151         <span class="comment">//  At this point there is not a security descriptor</span>
01152         <span class="comment">//  so we'll assume access is allowed</span>
01153         <span class="comment">//</span>
01154 
01155         AccessAllowed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01156     }
01157 
01158     <span class="comment">//</span>
01159     <span class="comment">//  Free the caller's token and if the caller didn't have the</span>
01160     <span class="comment">//  object type locked we need to free it.</span>
01161     <span class="comment">//</span>
01162 
01163     <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
01164 
01165     <span class="keywordflow">if</span> (!TypeMutexLocked) {
01166 
01167         <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
01168     }
01169 
01170     <span class="comment">//</span>
01171     <span class="comment">//  Finally free the security descriptor</span>
01172     <span class="comment">//  and return to our caller</span>
01173     <span class="comment">//</span>
01174 
01175     <a class="code" href="../../d9/d1/obse_8c.html#a9">ObReleaseObjectSecurity</a>( SecurityDescriptor,
01176                              MemoryAllocated );
01177 
01178     <span class="keywordflow">return</span>( AccessAllowed );
01179 }
01180 
01181 
01182 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01183"></a><a class="code" href="../../d9/d1/obse_8c.html#a7">01183</a> <a class="code" href="../../d9/d1/obse_8c.html#a7">ObAssignObjectSecurityDescriptor</a> (
01184     IN PVOID Object,
01185     IN PSECURITY_DESCRIPTOR SecurityDescriptor OPTIONAL,
01186     IN POOL_TYPE PoolType <span class="comment">// This field is currently ignored.</span>
01187     )
01188 
01189 <span class="comment">/*++</span>
01190 <span class="comment"></span>
01191 <span class="comment">Routine Description:</span>
01192 <span class="comment"></span>
01193 <span class="comment">    Takes a pointer to an object and sets the SecurityDescriptor field</span>
01194 <span class="comment">    in the object's header.</span>
01195 <span class="comment"></span>
01196 <span class="comment">Arguments:</span>
01197 <span class="comment"></span>
01198 <span class="comment">    Object - Supplies a pointer to the object</span>
01199 <span class="comment"></span>
01200 <span class="comment">    SecurityDescriptor - Supplies a pointer to the security descriptor</span>
01201 <span class="comment">        to be assigned to the object.  This pointer may be null if there</span>
01202 <span class="comment">        is no security on the object.</span>
01203 <span class="comment"></span>
01204 <span class="comment">    PoolType - Supplies the type of pool memory used to allocate the</span>
01205 <span class="comment">        security descriptor.  This field is currently ignored.</span>
01206 <span class="comment"></span>
01207 <span class="comment">Return Value:</span>
01208 <span class="comment"></span>
01209 <span class="comment">    An appropriate NTSTATUS value.</span>
01210 <span class="comment"></span>
01211 <span class="comment">--*/</span>
01212 
01213 {
01214     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01215     PSECURITY_DESCRIPTOR OutputSecurityDescriptor;
01216 
01217     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01218 
01219     <span class="comment">//</span>
01220     <span class="comment">//  If the security descriptor isn't supplied then we set the</span>
01221     <span class="comment">//  object header's security descriptor to null and return</span>
01222     <span class="comment">//  to our caller</span>
01223     <span class="comment">//</span>
01224 
01225     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(SecurityDescriptor)) {
01226 
01227         <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object )-&gt;SecurityDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01228 
01229         <span class="keywordflow">return</span>( STATUS_SUCCESS );
01230     }
01231 
01232     <span class="comment">//</span>
01233     <span class="comment">//  Log the new security descriptor into our security database and</span>
01234     <span class="comment">//  get back the real security descriptor to use</span>
01235     <span class="comment">//</span>
01236 
01237     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d1/obsdata_8c.html#a16">ObpLogSecurityDescriptor</a>( SecurityDescriptor, &amp;OutputSecurityDescriptor );
01238 
01239     <span class="comment">//</span>
01240     <span class="comment">//  If we've been successful so far then set the object's</span>
01241     <span class="comment">//  security descriptor to the newly allocated one.</span>
01242     <span class="comment">//</span>
01243 
01244     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01245 
01246         <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object )-&gt;SecurityDescriptor = OutputSecurityDescriptor;
01247     }
01248 
01249     <span class="comment">//</span>
01250     <span class="comment">//  And return to our caller</span>
01251     <span class="comment">//</span>
01252 
01253     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01254 }
01255 
01256 
01257 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01258"></a><a class="code" href="../../d9/d1/obse_8c.html#a8">01258</a> <a class="code" href="../../d9/d1/obse_8c.html#a8">ObGetObjectSecurity</a> (
01259     IN PVOID Object,
01260     OUT PSECURITY_DESCRIPTOR *SecurityDescriptor,
01261     OUT PBOOLEAN MemoryAllocated
01262     )
01263 
01264 <span class="comment">/*++</span>
01265 <span class="comment"></span>
01266 <span class="comment">Routine Description:</span>
01267 <span class="comment"></span>
01268 <span class="comment">    Given an object, this routine will find its security descriptor.</span>
01269 <span class="comment">    It will do this by calling the object's security method.</span>
01270 <span class="comment"></span>
01271 <span class="comment">    It is possible for an object not to have a security descriptor</span>
01272 <span class="comment">    at all.  Unnamed objects such as events that can only be referenced</span>
01273 <span class="comment">    by a handle are an example of an object that does not have a</span>
01274 <span class="comment">    security descriptor.</span>
01275 <span class="comment"></span>
01276 <span class="comment">Arguments:</span>
01277 <span class="comment"></span>
01278 <span class="comment">    Object - Supplies the object body being queried.</span>
01279 <span class="comment"></span>
01280 <span class="comment">    SecurityDescriptor - Returns a pointer to the object's security</span>
01281 <span class="comment">        descriptor.</span>
01282 <span class="comment"></span>
01283 <span class="comment">    MemoryAllocated - indicates whether we had to allocate pool</span>
01284 <span class="comment">        memory to hold the security descriptor or not.  This should</span>
01285 <span class="comment">        be passed back into ObReleaseObjectSecurity.</span>
01286 <span class="comment"></span>
01287 <span class="comment">Return Value:</span>
01288 <span class="comment"></span>
01289 <span class="comment">    STATUS_SUCCESS - The operation was successful.  Note that the</span>
01290 <span class="comment">        operation may be successful and still return a NULL security</span>
01291 <span class="comment">        descriptor.</span>
01292 <span class="comment"></span>
01293 <span class="comment">    STATUS_INSUFFICIENT_RESOURCES - Insufficient memory was available</span>
01294 <span class="comment">        to satisfy the request.</span>
01295 <span class="comment"></span>
01296 <span class="comment">--*/</span>
01297 
01298 {
01299     SECURITY_INFORMATION SecurityInformation;
01300     ULONG Length = 0;
01301     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01302     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
01303     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01304     KIRQL SaveIrql;
01305 
01306     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01307 
01308     <span class="comment">//</span>
01309     <span class="comment">//  Map the object body to its object header and corresponding</span>
01310     <span class="comment">//  object type</span>
01311     <span class="comment">//</span>
01312 
01313     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
01314     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
01315 
01316     <span class="comment">//</span>
01317     <span class="comment">//  If the object is one that uses the default object method,</span>
01318     <span class="comment">//  its security descriptor is contained in ob's security</span>
01319     <span class="comment">//  descriptor cache.</span>
01320     <span class="comment">//</span>
01321     <span class="comment">//  Reference it so that it doesn't go away out from under us.</span>
01322     <span class="comment">//</span>
01323 
01324     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/obp_8h.html#a13">ObpCentralizedSecurity</a>(ObjectType))  {
01325 
01326         *SecurityDescriptor = <a class="code" href="../../d8/d1/obsdata_8c.html#a18">ObpReferenceSecurityDescriptor</a>( Object );
01327 
01328         *MemoryAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01329 
01330         <span class="keywordflow">return</span>( STATUS_SUCCESS );
01331     }
01332 
01333     <span class="comment">//</span>
01334     <span class="comment">//  Request a complete security descriptor</span>
01335     <span class="comment">//</span>
01336 
01337     SecurityInformation = OWNER_SECURITY_INFORMATION |
01338                           GROUP_SECURITY_INFORMATION |
01339                           DACL_SECURITY_INFORMATION  |
01340                           SACL_SECURITY_INFORMATION;
01341 
01342     <span class="comment">//</span>
01343     <span class="comment">//  Call the security method with Length = 0 to find out</span>
01344     <span class="comment">//  how much memory we need to store the final result.</span>
01345     <span class="comment">//</span>
01346     <span class="comment">//  Note that the ObjectsSecurityDescriptor parameter is NULL,</span>
01347     <span class="comment">//  because we expect whoever is on the other end of this call</span>
01348     <span class="comment">//  to find the security descriptor for us.  We pass in a pool</span>
01349     <span class="comment">//  type to keep the compiler happy, it will not be used for a</span>
01350     <span class="comment">//  query operation.</span>
01351     <span class="comment">//</span>
01352 
01353 
01354     <a class="code" href="../../d5/d1/obp_8h.html#a0">ObpBeginTypeSpecificCallOut</a>( SaveIrql );
01355 
01356     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (*ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o17">SecurityProcedure</a>)( Object,
01357                                                         <a class="code" href="../../d0/d5/se_8h.html#a200a109">QuerySecurityDescriptor</a>,
01358                                                         &amp;SecurityInformation,
01359                                                         *SecurityDescriptor,
01360                                                         &amp;Length,
01361                                                         &amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o10">SecurityDescriptor</a>,         <span class="comment">// not used</span>
01362                                                         ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a>,
01363                                                         &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> );
01364 
01365     <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"Security"</span>, ObjectType, Object );
01366 
01367     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_BUFFER_TOO_SMALL) {
01368 
01369         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01370     }
01371 
01372     <span class="comment">//</span>
01373     <span class="comment">//  Now that we know how large the security descriptor is we</span>
01374     <span class="comment">//  can allocate space for it</span>
01375     <span class="comment">//</span>
01376 
01377     *SecurityDescriptor = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, Length, 'qSbO' );
01378 
01379     <span class="keywordflow">if</span> (*SecurityDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01380 
01381         <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
01382     }
01383 
01384     *MemoryAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01385 
01386     <span class="comment">//</span>
01387     <span class="comment">//  The security method will return an absolute format</span>
01388     <span class="comment">//  security descriptor that just happens to be in a self</span>
01389     <span class="comment">//  contained buffer (not to be confused with a self-relative</span>
01390     <span class="comment">//  security descriptor).</span>
01391     <span class="comment">//</span>
01392 
01393     <a class="code" href="../../d5/d1/obp_8h.html#a0">ObpBeginTypeSpecificCallOut</a>( SaveIrql );
01394 
01395     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (*ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o17">SecurityProcedure</a>)( Object,
01396                                                         <a class="code" href="../../d0/d5/se_8h.html#a200a109">QuerySecurityDescriptor</a>,
01397                                                         &amp;SecurityInformation,
01398                                                         *SecurityDescriptor,
01399                                                         &amp;Length,
01400                                                         &amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o10">SecurityDescriptor</a>,
01401                                                         ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a>,
01402                                                         &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> );
01403 
01404     <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"Security"</span>, ObjectType, Object );
01405 
01406     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01407 
01408         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( *SecurityDescriptor );
01409 
01410         *MemoryAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01411     }
01412 
01413     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01414 }
01415 
01416 
01417 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01418"></a><a class="code" href="../../d9/d1/obse_8c.html#a9">01418</a> <a class="code" href="../../d9/d1/obse_8c.html#a9">ObReleaseObjectSecurity</a> (
01419     IN PSECURITY_DESCRIPTOR SecurityDescriptor,
01420     IN BOOLEAN MemoryAllocated
01421     )
01422 
01423 <span class="comment">/*++</span>
01424 <span class="comment"></span>
01425 <span class="comment">Routine Description:</span>
01426 <span class="comment"></span>
01427 <span class="comment">    This function will free up any memory associated with a queried</span>
01428 <span class="comment">    security descriptor.  This undoes the function ObGetObjectSecurity</span>
01429 <span class="comment"></span>
01430 <span class="comment">Arguments:</span>
01431 <span class="comment"></span>
01432 <span class="comment">    SecurityDescriptor - Supplies a pointer to the security descriptor</span>
01433 <span class="comment">        to be freed.</span>
01434 <span class="comment"></span>
01435 <span class="comment">    MemoryAllocated - Supplies whether or not we should free the</span>
01436 <span class="comment">        memory pointed to by SecurityDescriptor.</span>
01437 <span class="comment"></span>
01438 <span class="comment">Return Value:</span>
01439 <span class="comment"></span>
01440 <span class="comment">    None.</span>
01441 <span class="comment"></span>
01442 <span class="comment">--*/</span>
01443 
01444 {
01445     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01446 
01447     <span class="comment">//</span>
01448     <span class="comment">//  Check if there is a security descriptor to actually free</span>
01449     <span class="comment">//</span>
01450 
01451     <span class="keywordflow">if</span> ( SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01452 
01453         <span class="comment">//</span>
01454         <span class="comment">//  If ObGetObjectSecurity allocated memory then we</span>
01455         <span class="comment">//  need to free it. Otherwise what the earlier routine did</span>
01456         <span class="comment">//  was reference the object to keep the security descriptor</span>
01457         <span class="comment">//  to keep it from going away</span>
01458         <span class="comment">//</span>
01459 
01460         <span class="keywordflow">if</span> (MemoryAllocated) {
01461 
01462             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( SecurityDescriptor );
01463 
01464         } <span class="keywordflow">else</span> {
01465 
01466             <a class="code" href="../../d8/d1/obsdata_8c.html#a20">ObpDereferenceSecurityDescriptor</a>( SecurityDescriptor );
01467         }
01468     }
01469 }
01470 
01471 
01472 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01473"></a><a class="code" href="../../d9/d1/obse_8c.html#a10">01473</a> <a class="code" href="../../d9/d1/obse_8c.html#a10">ObValidateSecurityQuota</a> (
01474     IN PVOID Object,
01475     IN ULONG NewSize
01476     )
01477 
01478 <span class="comment">/*++</span>
01479 <span class="comment"></span>
01480 <span class="comment">Routine Description:</span>
01481 <span class="comment"></span>
01482 <span class="comment">    This routine will check to see if the new security information</span>
01483 <span class="comment">    is larger than is allowed by the object's pre-allocated quota.</span>
01484 <span class="comment"></span>
01485 <span class="comment">Arguments:</span>
01486 <span class="comment"></span>
01487 <span class="comment">    Object - Supplies a pointer to the object whose information is to be</span>
01488 <span class="comment">        modified.</span>
01489 <span class="comment"></span>
01490 <span class="comment">    NewSize - Supplies the size of the proposed new security</span>
01491 <span class="comment">        information.</span>
01492 <span class="comment"></span>
01493 <span class="comment">Return Value:</span>
01494 <span class="comment"></span>
01495 <span class="comment">    STATUS_SUCCESS - New size is within alloted quota.</span>
01496 <span class="comment"></span>
01497 <span class="comment">    STATUS_QUOTA_EXCEEDED - The desired adjustment would have exceeded</span>
01498 <span class="comment">        the permitted security quota for this object.</span>
01499 <span class="comment"></span>
01500 <span class="comment">--*/</span>
01501 
01502 {
01503     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01504     <a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html">POBJECT_HEADER_QUOTA_INFO</a> QuotaInfo;
01505 
01506     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01507 
01508     <span class="comment">//</span>
01509     <span class="comment">//  Map the object body to its object header and corresponding</span>
01510     <span class="comment">//  quota information block</span>
01511     <span class="comment">//</span>
01512 
01513     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
01514     QuotaInfo = <a class="code" href="../../d4/d0/ob_8h.html#a10">OBJECT_HEADER_TO_QUOTA_INFO</a>( ObjectHeader );
01515 
01516     <span class="comment">//</span>
01517     <span class="comment">//  If there isn't any quota info and the new size is greater</span>
01518     <span class="comment">//  then the default security quota then if the object uses</span>
01519     <span class="comment">//  the default value then we've exceeded quota otherwise</span>
01520     <span class="comment">//  let the caller get the quota</span>
01521     <span class="comment">//</span>
01522 
01523     <span class="keywordflow">if</span> ((QuotaInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (NewSize &gt; <a class="code" href="../../d0/d5/se_8h.html#a0">SE_DEFAULT_SECURITY_QUOTA</a>)) {
01524 
01525         <span class="keywordflow">if</span> (!(ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a6">OB_FLAG_DEFAULT_SECURITY_QUOTA</a>)) {
01526 
01527             <span class="comment">//</span>
01528             <span class="comment">//  Should really charge quota here.</span>
01529             <span class="comment">//</span>
01530 
01531             <span class="keywordflow">return</span>( STATUS_SUCCESS );
01532         }
01533 
01534         <span class="keywordflow">return</span>( STATUS_QUOTA_EXCEEDED );
01535 
01536     <span class="comment">//</span>
01537     <span class="comment">//  If the quota is not null and the new size is greater than the</span>
01538     <span class="comment">//  allowed quota charge then if the charge is zero we grant the</span>
01539     <span class="comment">//  request otherwise we've exceeded quota.</span>
01540     <span class="comment">//</span>
01541     <span class="comment">//  **** this logic seems wierd</span>
01542     <span class="comment">//</span>
01543 
01544     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((QuotaInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (NewSize &gt; QuotaInfo-&gt;<a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html#o2">SecurityDescriptorCharge</a>)) {
01545 
01546         <span class="keywordflow">if</span> (QuotaInfo-&gt;<a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html#o2">SecurityDescriptorCharge</a> == 0) {
01547 
01548             <span class="comment">//</span>
01549             <span class="comment">//  Should really charge quota here.</span>
01550             <span class="comment">//</span>
01551 
01552             <span class="comment">//  QuotaInfo-&gt;SecurityDescriptorCharge = SeComputeSecurityQuota( NewSize );</span>
01553 
01554             <span class="keywordflow">return</span>( STATUS_SUCCESS );
01555         }
01556 
01557         <span class="keywordflow">return</span>( STATUS_QUOTA_EXCEEDED );
01558 
01559     <span class="comment">//</span>
01560     <span class="comment">//  Otherwise we have two cases.  (1) there isn't any quota info but</span>
01561     <span class="comment">//  the size is within limits or (2) there is a quota info block and</span>
01562     <span class="comment">//  the size is within the specified security descriptor charge so</span>
01563     <span class="comment">//  return success to our caller</span>
01564     <span class="comment">//</span>
01565 
01566     } <span class="keywordflow">else</span> {
01567 
01568         <span class="keywordflow">return</span>( STATUS_SUCCESS );
01569     }
01570 }
01571 
01572 
01573 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01574"></a><a class="code" href="../../d9/d1/obse_8c.html#a11">01574</a> <a class="code" href="../../d9/d1/obse_8c.html#a11">ObAssignSecurity</a> (
01575     IN <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState,
01576     IN PSECURITY_DESCRIPTOR ParentDescriptor OPTIONAL,
01577     IN PVOID Object,
01578     IN <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType
01579     )
01580 
01581 <span class="comment">/*++</span>
01582 <span class="comment"></span>
01583 <span class="comment">Routine Description:</span>
01584 <span class="comment"></span>
01585 <span class="comment">    This routine will assign a security descriptor to a newly created object.</span>
01586 <span class="comment">    It assumes that the AccessState parameter contains a captured security</span>
01587 <span class="comment">    descriptor.</span>
01588 <span class="comment"></span>
01589 <span class="comment">Arguments:</span>
01590 <span class="comment"></span>
01591 <span class="comment">     AccessState - The AccessState containing the security information</span>
01592 <span class="comment">        for this object creation.</span>
01593 <span class="comment"></span>
01594 <span class="comment">     ParentDescriptor - The security descriptor from the parent object, if</span>
01595 <span class="comment">        available.</span>
01596 <span class="comment"></span>
01597 <span class="comment">     Object - A pointer to the object being created.</span>
01598 <span class="comment"></span>
01599 <span class="comment">     ObjectType - Supplies the type of object being created.</span>
01600 <span class="comment"></span>
01601 <span class="comment">Return Value:</span>
01602 <span class="comment"></span>
01603 <span class="comment">    STATUS_SUCCESS - indicates the operation was successful.</span>
01604 <span class="comment"></span>
01605 <span class="comment">    STATUS_INVALID_OWNER - The owner SID provided as the owner of the</span>
01606 <span class="comment">        target security descriptor is not one the caller is authorized</span>
01607 <span class="comment">        to assign as the owner of an object.</span>
01608 <span class="comment"></span>
01609 <span class="comment">    STATUS_PRIVILEGE_NOT_HELD - The caller does not have the privilege</span>
01610 <span class="comment">        necessary to explicitly assign the specified system ACL.</span>
01611 <span class="comment">        SeSecurityPrivilege privilege is needed to explicitly assign</span>
01612 <span class="comment">        system ACLs to objects.</span>
01613 <span class="comment"></span>
01614 <span class="comment">--*/</span>
01615 
01616 {
01617     PSECURITY_DESCRIPTOR NewDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01618     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01619     KIRQL SaveIrql;
01620 
01621     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01622 
01623     <span class="comment">//</span>
01624     <span class="comment">//  SeAssignSecurity will construct the final version</span>
01625     <span class="comment">//  of the security  descriptor</span>
01626     <span class="comment">//</span>
01627 
01628     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d5/seassign_8c.html#a1">SeAssignSecurity</a>( ParentDescriptor,
01629                                AccessState-&gt;SecurityDescriptor,
01630                                &amp;NewDescriptor,
01631                                (BOOLEAN)(ObjectType == <a class="code" href="../../d5/d1/obp_8h.html#a42">ObpDirectoryObjectType</a>),
01632                                &amp;AccessState-&gt;SubjectSecurityContext,
01633                                &amp;ObjectType-&gt;TypeInfo.GenericMapping,
01634                                <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a> );
01635 
01636     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01637 
01638         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01639     }
01640 
01641     <a class="code" href="../../d5/d1/obp_8h.html#a0">ObpBeginTypeSpecificCallOut</a>( SaveIrql );
01642 
01643     <span class="comment">//</span>
01644     <span class="comment">//  Now invoke the security method callback to finish</span>
01645     <span class="comment">//  the assignment.</span>
01646     <span class="comment">//</span>
01647 
01648     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (*ObjectType-&gt;TypeInfo.SecurityProcedure)( Object,
01649                                                         <a class="code" href="../../d0/d5/se_8h.html#a200a111">AssignSecurityDescriptor</a>,
01650                                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01651                                                         NewDescriptor,
01652                                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01653                                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01654                                                         <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01655                                                         &amp;ObjectType-&gt;TypeInfo.GenericMapping );
01656 
01657     <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"Security"</span>, ObjectType, Object );
01658 
01659     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01660 
01661         <span class="comment">//</span>
01662         <span class="comment">// The attempt to assign the security descriptor to the object</span>
01663         <span class="comment">// failed.  Free the space used by the new security descriptor.</span>
01664         <span class="comment">//</span>
01665 
01666         <a class="code" href="../../d1/d5/seassign_8c.html#a3">SeDeassignSecurity</a>( &amp;NewDescriptor );
01667     }
01668 
01669     <span class="comment">//</span>
01670     <span class="comment">//  And return to our caller</span>
01671     <span class="comment">//</span>
01672 
01673     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01674 }
01675 
01676 
01677 
01678 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01679"></a><a class="code" href="../../d9/d1/obse_8c.html#a12">01679</a> <a class="code" href="../../d9/d1/obse_8c.html#a12">ObQuerySecurityDescriptorInfo</a>(
01680     IN PSECURITY_INFORMATION SecurityInformation,
01681     OUT PSECURITY_DESCRIPTOR SecurityDescriptor,
01682     IN OUT PULONG Length,
01683     IN PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor
01684     )
01685 <span class="comment">/*++</span>
01686 <span class="comment"></span>
01687 <span class="comment">Routine Description:</span>
01688 <span class="comment"></span>
01689 <span class="comment">    This routine will extract the desired information from the</span>
01690 <span class="comment">    passed security descriptor and return the information in</span>
01691 <span class="comment">    the passed buffer as a security descriptor in self-relative</span>
01692 <span class="comment">    format.</span>
01693 <span class="comment"></span>
01694 <span class="comment">    This routine assumes that all parameters are captured and</span>
01695 <span class="comment">    safe to reference.</span>
01696 <span class="comment"></span>
01697 <span class="comment">Arguments:</span>
01698 <span class="comment"></span>
01699 <span class="comment">    SecurityInformation - Specifies what information is being queried.</span>
01700 <span class="comment"></span>
01701 <span class="comment">    SecurityDescriptor - Supplies the buffer to output the requested</span>
01702 <span class="comment">        information into.</span>
01703 <span class="comment"></span>
01704 <span class="comment">        This buffer has been probed only to the size indicated by</span>
01705 <span class="comment">        the Length parameter.  Since it still points into user space,</span>
01706 <span class="comment">        it must always be accessed in a try clause.</span>
01707 <span class="comment"></span>
01708 <span class="comment">    Length - Supplies the address of a variable containing the length of</span>
01709 <span class="comment">        the security descriptor buffer.  Upon return this variable will</span>
01710 <span class="comment">        contain the length needed to store the requested information.</span>
01711 <span class="comment"></span>
01712 <span class="comment">    ObjectsSecurityDescriptor - Supplies the address of a pointer to</span>
01713 <span class="comment">        the objects security descriptor.  The passed security descriptor</span>
01714 <span class="comment">        must be in self-relative format.</span>
01715 <span class="comment"></span>
01716 <span class="comment">Return Value:</span>
01717 <span class="comment"></span>
01718 <span class="comment">    NTSTATUS - STATUS_SUCCESS if successful and an appropriate error value</span>
01719 <span class="comment">        otherwise</span>
01720 <span class="comment"></span>
01721 <span class="comment">--*/</span>
01722 {
01723     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01724 
01725     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01726 
01727     <span class="comment">//</span>
01728     <span class="comment">// Take the read lock on the security descriptor cache so we</span>
01729     <span class="comment">// don't collide with anyone who is modifying this security</span>
01730     <span class="comment">// descriptor (bug 347986).</span>
01731     <span class="comment">//</span>
01732 
01733     <a class="code" href="../../d8/d1/obsdata_8c.html#a24">ObpAcquireDescriptorCacheReadLock</a>();
01734 
01735     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/semethod_8c.html#a6">SeQuerySecurityDescriptorInfo</a>( SecurityInformation,
01736                                             SecurityDescriptor,
01737                                             Length,
01738                                             ObjectsSecurityDescriptor
01739                                             );
01740     <a class="code" href="../../d8/d1/obsdata_8c.html#a25">ObpReleaseDescriptorCacheLock</a>();
01741 
01742     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01743 }
01744 
01745 
01746 
01747 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01748"></a><a class="code" href="../../d9/d1/obse_8c.html#a13">01748</a> <a class="code" href="../../d9/d1/obse_8c.html#a13">ObSetSecurityDescriptorInfo</a> (
01749     IN PVOID Object,
01750     IN PSECURITY_INFORMATION SecurityInformation,
01751     IN OUT PSECURITY_DESCRIPTOR SecurityDescriptor,
01752     IN OUT PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor,
01753     IN POOL_TYPE PoolType,
01754     IN PGENERIC_MAPPING GenericMapping
01755     )
01756 
01757 <span class="comment">/*++</span>
01758 <span class="comment"></span>
01759 <span class="comment">Routine Description:</span>
01760 <span class="comment"></span>
01761 <span class="comment">    Sets the security descriptor on an already secure object.</span>
01762 <span class="comment"></span>
01763 <span class="comment">Arguments:</span>
01764 <span class="comment"></span>
01765 <span class="comment">    Object - Pointer to the object being modified.</span>
01766 <span class="comment"></span>
01767 <span class="comment">    SecurityInformation - Describes which information in the SecurityDescriptor parameter</span>
01768 <span class="comment">        is relevent.</span>
01769 <span class="comment"></span>
01770 <span class="comment">    SecurityDescriptor - Provides the new security information.</span>
01771 <span class="comment"></span>
01772 <span class="comment">    ObjectsSecurityDescriptor - Provides/returns the object's security descriptor.</span>
01773 <span class="comment"></span>
01774 <span class="comment">    PoolType - The pool the ObjectSecurityDescriptor is allocated from.</span>
01775 <span class="comment"></span>
01776 <span class="comment">    GenericMapping - Supplies the generic mapping for the object.</span>
01777 <span class="comment"></span>
01778 <span class="comment">Return Value:</span>
01779 <span class="comment"></span>
01780 <span class="comment">    An appropriate status value</span>
01781 <span class="comment"></span>
01782 <span class="comment">--*/</span>
01783 
01784 {
01785     PSECURITY_DESCRIPTOR OldDescriptor;
01786     PSECURITY_DESCRIPTOR NewDescriptor;
01787     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01788 
01789     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01790 
01791     <span class="comment">//</span>
01792     <span class="comment">//  Check the rest of our input and call the default set security</span>
01793     <span class="comment">//  method.  Also make sure no one is modifying the security descriptor</span>
01794     <span class="comment">//  while we're looking at it.</span>
01795     <span class="comment">//</span>
01796 
01797     <a class="code" href="../../d8/d1/obsdata_8c.html#a23">ObpAcquireDescriptorCacheWriteLock</a>();
01798 
01799     OldDescriptor = *ObjectsSecurityDescriptor;
01800     NewDescriptor = OldDescriptor;
01801 
01802     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/semethod_8c.html#a4">SeSetSecurityDescriptorInfo</a>( Object,
01803                                           SecurityInformation,
01804                                           SecurityDescriptor,
01805                                           &amp;NewDescriptor,
01806                                           PoolType,
01807                                           GenericMapping );
01808 
01809     <span class="comment">//</span>
01810     <span class="comment">//  Now if the object is an object directory object that</span>
01811     <span class="comment">//  participated in snapped symbolic links.  If so and the</span>
01812     <span class="comment">//  new security on the object does NOT allow world traverse</span>
01813     <span class="comment">//  access, then return an error, as it is too late to change</span>
01814     <span class="comment">//  the security on the object directory at this point.</span>
01815     <span class="comment">//</span>
01816 
01817     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )
01818 
01819             &amp;&amp;
01820 
01821         (<a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object )-&gt;Type == <a class="code" href="../../d5/d1/obp_8h.html#a42">ObpDirectoryObjectType</a>)
01822 
01823             &amp;&amp;
01824 
01825         (((<a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a>)Object)-&gt;SymbolicLinkUsageCount != 0)
01826 
01827             &amp;&amp;
01828 
01829         !<a class="code" href="../../d0/d4/accessck_8c.html#a22">SeFastTraverseCheck</a>( NewDescriptor, DIRECTORY_TRAVERSE, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a> )) {
01830 
01831         KdPrint(( <span class="stringliteral">"OB: Failing attempt the remove world traverse access from object directory\n"</span> ));
01832 
01833         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NewDescriptor );
01834 
01835         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
01836     }
01837 
01838     <span class="comment">//</span>
01839     <span class="comment">//  If we successfully set the new security descriptor then we</span>
01840     <span class="comment">//  need to log it in our database and get yet another pointer</span>
01841     <span class="comment">//  to the finaly security descriptor</span>
01842     <span class="comment">//</span>
01843 
01844     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01845 
01846         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d1/obsdata_8c.html#a16">ObpLogSecurityDescriptor</a>( NewDescriptor,
01847                                            ObjectsSecurityDescriptor );
01848 
01849         <a class="code" href="../../d8/d1/obsdata_8c.html#a25">ObpReleaseDescriptorCacheLock</a>();
01850 
01851         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01852 
01853             <span class="comment">//</span>
01854             <span class="comment">//  Dereference old SecurityDescriptor and insert new one</span>
01855             <span class="comment">//</span>
01856 
01857             <a class="code" href="../../d8/d1/obsdata_8c.html#a20">ObpDereferenceSecurityDescriptor</a>( OldDescriptor );
01858 
01859         } <span class="keywordflow">else</span> {
01860 
01861             <span class="comment">//</span>
01862             <span class="comment">//  We failed logging the new security descriptor.</span>
01863             <span class="comment">//  Clean up and fail the entire operation.</span>
01864             <span class="comment">//</span>
01865 
01866             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NewDescriptor );
01867         }
01868     } <span class="keywordflow">else</span> {
01869 
01870         <span class="comment">//</span>
01871         <span class="comment">//  Release the security descriptor lock</span>
01872         <span class="comment">//</span>
01873 
01874         <a class="code" href="../../d8/d1/obsdata_8c.html#a25">ObpReleaseDescriptorCacheLock</a>();
01875     }
01876 
01877     <span class="comment">//</span>
01878     <span class="comment">//  And return to our caller</span>
01879     <span class="comment">//</span>
01880 
01881     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01882 }
01883 
01884 
01885 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01886"></a><a class="code" href="../../d9/d1/obse_8c.html#a14">01886</a> <a class="code" href="../../d9/d1/obse_8c.html#a14">ObpValidateAccessMask</a> (
01887     <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState
01888     )
01889 
01890 <span class="comment">/*++</span>
01891 <span class="comment"></span>
01892 <span class="comment">Routine Description:</span>
01893 <span class="comment"></span>
01894 <span class="comment">    Checks the desired access mask of a passed object against the</span>
01895 <span class="comment">    passed security descriptor.</span>
01896 <span class="comment"></span>
01897 <span class="comment">Arguments:</span>
01898 <span class="comment"></span>
01899 <span class="comment">    AccessState - A pointer to the AccessState for the pending operation.</span>
01900 <span class="comment"></span>
01901 <span class="comment">Return Value:</span>
01902 <span class="comment"></span>
01903 <span class="comment">    Only returns STATUS_SUCCESS</span>
01904 <span class="comment"></span>
01905 <span class="comment">--*/</span>
01906 
01907 {
01908     SECURITY_DESCRIPTOR *SecurityDescriptor = AccessState-&gt;<a class="code" href="../../d2/d5/struct__ACCESS__STATE.html#o10">SecurityDescriptor</a>;
01909 
01910     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01911 
01912     <span class="comment">//</span>
01913     <span class="comment">//  First make sure the access state has a security descriptor.  If there</span>
01914     <span class="comment">//  is one and it has a system acl and the previously granted access did</span>
01915     <span class="comment">//  not include system security then add the fact that we want system</span>
01916     <span class="comment">//  security to the remaining desired access state.</span>
01917     <span class="comment">//</span>
01918 
01919     <span class="keywordflow">if</span> (SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01920 
01921         <span class="keywordflow">if</span> ( SecurityDescriptor-&gt;Control &amp; SE_SACL_PRESENT ) {
01922 
01923             <span class="keywordflow">if</span> ( !(AccessState-&gt;<a class="code" href="../../d2/d5/struct__ACCESS__STATE.html#o7">PreviouslyGrantedAccess</a> &amp; ACCESS_SYSTEM_SECURITY)) {
01924 
01925                 AccessState-&gt;<a class="code" href="../../d2/d5/struct__ACCESS__STATE.html#o6">RemainingDesiredAccess</a> |= ACCESS_SYSTEM_SECURITY;
01926             }
01927         }
01928     }
01929 
01930     <span class="keywordflow">return</span>( STATUS_SUCCESS );
01931 }
01932 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:06 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
