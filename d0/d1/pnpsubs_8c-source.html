<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pnpsubs.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pnpsubs.c</h1><a href="../../d9/d1/pnpsubs_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1995  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    pnpsubs.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the plug-and-play subroutines for the</span>
00012 <span class="comment">    I/O system.</span>
00013 <span class="comment"></span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Shie-Lin Tzong (shielint) 3-Jan-1995</span>
00018 <span class="comment"></span>
00019 <span class="comment">Environment:</span>
00020 <span class="comment"></span>
00021 <span class="comment">    Kernel mode</span>
00022 <span class="comment"></span>
00023 <span class="comment">Revision History:</span>
00024 <span class="comment"></span>
00025 <span class="comment"></span>
00026 <span class="comment">--*/</span>
00027 
00028 <span class="preprocessor">#include "<a class="code" href="../../d0/d6/iop_8h.html">iop.h</a>"</span>
00029 <span class="preprocessor">#pragma hdrstop</span>
00030 <span class="preprocessor"></span>
00031 <span class="preprocessor">#ifdef POOL_TAGGING</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#undef ExAllocatePool</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePool(a,b) ExAllocatePoolWithTag(a,b,'uspP')</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00035 <span class="preprocessor"></span>
00036 <span class="comment">//</span>
00037 <span class="comment">// Prototype of internal functions</span>
00038 <span class="comment">//</span>
00039 
00040 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00041 <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a0">IopDisableDevice</a>(
00042     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
00043     IN HANDLE Handle
00044     );
00045 
00046 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00047 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopCreateMadeupNode)</span>
00048 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopRemoveStringFromValueKey)</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopAppendStringToValueKey)</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopConcatenateUnicodeStrings)</span>
00051 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopPrepareDriverLoading)</span>
00052 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopServiceInstanceToDeviceInstance)</span>
00053 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopCreateRegistryKeyEx)</span>
00054 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopOpenRegistryKeyEx)</span>
00055 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopOpenServiceEnumKeys)</span>
00056 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopOpenCurrentHwProfileDeviceInstanceKey)</span>
00057 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopGetDeviceInstanceCsConfigFlags)</span>
00058 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopGetServiceInstanceCsConfigFlags)</span>
00059 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopSetServiceInstanceCsConfigFlags)</span>
00060 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopApplyFunctionToSubKeys)</span>
00061 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopRegMultiSzToUnicodeStrings)</span>
00062 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopApplyFunctionToServiceInstances)</span>
00063 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopIsDuplicatedDevices)</span>
00064 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopMarkDuplicateDevice)</span>
00065 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopFreeUnicodeStringList)</span>
00066 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDriverLoadingFailed)</span>
00067 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopIsAnyDeviceInstanceEnabled)</span>
00068 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopIsDeviceInstanceEnabled)</span>
00069 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDetermineResourceListSize)</span>
00070 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopReferenceDriverObjectByName)</span>
00071 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDeviceObjectFromDeviceInstance)</span>
00072 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDeviceObjectToDeviceInstance)</span>
00073 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopCleanupDeviceRegistryValues)</span>
00074 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopGetDeviceResourcesFromRegistry)</span>
00075 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopCmResourcesToIoResources)</span>
00076 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopReadDeviceConfiguration)</span>
00077 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopGetGroupOrderIndex)</span>
00078 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDeleteLegacyKey)</span>
00079 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopIsLegacyDriver)</span>
00080 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopFilterResourceRequirementsList)</span>
00081 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopMergeFilteredResourceRequirementsList)</span>
00082 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDisableDevice)</span>
00083 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopMergeCmResourceLists)</span>
00084 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDeviceCapabilitiesToRegistry)</span>
00085 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDeviceNodeCapabilitiesToRegistry)</span>
00086 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopRestartDeviceNode)</span>
00087 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDeleteKeyRecursive)</span>
00088 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00089 <span class="preprocessor"></span>
00090 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00091"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a1">00091</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a1">IopCreateMadeupNode</a>(
00092     IN PUNICODE_STRING ServiceKeyName,
00093     OUT PHANDLE ReturnedHandle,
00094     OUT PUNICODE_STRING KeyName,
00095     OUT PULONG InstanceNumber,
00096     IN BOOLEAN ResourceOwned
00097     )
00098 
00099 <span class="comment">/*++</span>
00100 <span class="comment"></span>
00101 <span class="comment">Routine Description:</span>
00102 <span class="comment"></span>
00103 <span class="comment">    This routine creates a new instance node under System\Enum\Root\*Madeup&lt;Name&gt;</span>
00104 <span class="comment">    key and all the required default value entries.  Also a value entry under</span>
00105 <span class="comment">    Service\ServiceKeyName\Enum is created to point to the newly created madeup</span>
00106 <span class="comment">    entry.  A handle and the keyname of the new key are returned to caller.</span>
00107 <span class="comment">    Caller must free the unicode string when he is done with it.</span>
00108 <span class="comment"></span>
00109 <span class="comment">Parameters:</span>
00110 <span class="comment"></span>
00111 <span class="comment">    ServiceKeyName - Supplies a pointer to the name of the subkey in the</span>
00112 <span class="comment">        system service list (HKEY_LOCAL_MACHINE\CurrentControlSet\Services)</span>
00113 <span class="comment">        that caused the driver to load. This is the RegistryPath parameter</span>
00114 <span class="comment">        to the DriverEntry routine.</span>
00115 <span class="comment"></span>
00116 <span class="comment">    ReturnedHandle - Supplies a variable to receive the handle of the</span>
00117 <span class="comment">        newly created key.</span>
00118 <span class="comment"></span>
00119 <span class="comment">    KeyName - Supplies a variable to receive the name of the newly created</span>
00120 <span class="comment">        key.</span>
00121 <span class="comment"></span>
00122 <span class="comment">    InstanceNumber - supplies a variable to receive the InstanceNumber value</span>
00123 <span class="comment">        entry created under service\name\enum subkey.</span>
00124 <span class="comment"></span>
00125 <span class="comment">    ResourceOwned - supplies a BOOLEAN variable to indicate if caller owns</span>
00126 <span class="comment">        the registry resource exclusively.</span>
00127 <span class="comment"></span>
00128 <span class="comment">Return Value:</span>
00129 <span class="comment"></span>
00130 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
00131 <span class="comment"></span>
00132 <span class="comment">--*/</span>
00133 
00134 {
00135     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
00136     UNICODE_STRING tmpKeyName, unicodeInstanceName, unicodeString;
00137     UNICODE_STRING rootKeyName, unicodeValueName, unicodeKeyName;
00138     HANDLE handle, enumRootHandle, hTreeHandle;
00139     ULONG instance;
00140     UCHAR unicodeBuffer[20];
00141     ULONG tmpValue, disposition = 0;
00142     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00143     PWSTR p;
00144     BOOLEAN releaseResource = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00145     BOOLEAN successful;
00146 
00147     <span class="keywordflow">if</span> (!ResourceOwned) {
00148         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00149         <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00150         releaseResource = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00151     }
00152 
00153     <span class="comment">//</span>
00154     <span class="comment">// Open LocalMachine\System\CurrentControlSet\Enum\Root</span>
00155     <span class="comment">//</span>
00156 
00157     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;enumRootHandle,
00158                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00159                                    &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a24">CmRegistryMachineSystemCurrentControlSetEnumRootName</a>,
00160                                    KEY_ALL_ACCESS
00161                                    );
00162 
00163     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00164         <span class="keywordflow">goto</span> local_exit0;
00165     }
00166 
00167     <span class="comment">//</span>
00168     <span class="comment">// Open, and create if not already exist, System\Enum\Root\LEGACY_&lt;ServiceName&gt;</span>
00169     <span class="comment">// First, try to find the ServiceName by extracting it from user supplied</span>
00170     <span class="comment">// ServiceKeyName.</span>
00171     <span class="comment">//</span>
00172 
00173     PiWstrToUnicodeString(&amp;tmpKeyName, REGSTR_KEY_MADEUP);
00174     successful = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a>( &amp;unicodeKeyName,
00175                                                &amp;tmpKeyName,
00176                                                ServiceKeyName);
00177 
00178     <span class="keywordflow">if</span> (!successful) {
00179         ZwClose(enumRootHandle);
00180         status = STATUS_INSUFFICIENT_RESOURCES;
00181         <span class="keywordflow">goto</span> local_exit0;
00182     }
00183 
00184     <a class="code" href="../../d6/d6/nls_8c.html#a31">RtlUpcaseUnicodeString</a>(&amp;unicodeKeyName, &amp;unicodeKeyName, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00185     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a376">IopFixupDeviceId</a>(unicodeKeyName.Buffer)) {
00186         status = STATUS_INVALID_PARAMETER;
00187         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeKeyName);
00188         <span class="keywordflow">goto</span> local_exit0;
00189     }
00190 
00191     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;handle,
00192                                      enumRootHandle,
00193                                      &amp;unicodeKeyName,
00194                                      KEY_ALL_ACCESS,
00195                                      REG_OPTION_NON_VOLATILE,
00196                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00197                                      );
00198     ZwClose(enumRootHandle);
00199     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00200         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeKeyName);
00201         <span class="keywordflow">goto</span> local_exit0;
00202     }
00203 
00204     instance = 1;
00205 
00206     PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_NEXT_INSTANCE);
00207     status = ZwSetValueKey(
00208                 handle,
00209                 &amp;unicodeValueName,
00210                 <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00211                 REG_DWORD,
00212                 &amp;instance,
00213                 <span class="keyword">sizeof</span>(instance)
00214                 );
00215 
00216     instance--;
00217     *InstanceNumber = instance;
00218     PiUlongToInstanceKeyUnicodeString(&amp;unicodeInstanceName,
00219                                       unicodeBuffer + <span class="keyword">sizeof</span>(WCHAR), <span class="comment">// reserve first WCHAR space</span>
00220                                       20 - <span class="keyword">sizeof</span>(WCHAR),
00221                                       instance
00222                                       );
00223     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( <a class="code" href="../../d5/d9/unc_8c.html#a7">ReturnedHandle</a>,
00224                                      handle,
00225                                      &amp;unicodeInstanceName,
00226                                      KEY_ALL_ACCESS,
00227                                      REG_OPTION_NON_VOLATILE,
00228                                      &amp;disposition
00229                                      );
00230     ZwClose(handle);
00231     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00232         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeKeyName);
00233         <span class="keywordflow">goto</span> local_exit0;
00234     }
00235 
00236     <span class="comment">//</span>
00237     <span class="comment">// Prepare newly created registry key name for returning to caller</span>
00238     <span class="comment">//</span>
00239 
00240     *(PWSTR)unicodeBuffer = OBJ_NAME_PATH_SEPARATOR;
00241     unicodeInstanceName.Buffer = (PWSTR)unicodeBuffer;
00242     unicodeInstanceName.Length += <span class="keyword">sizeof</span>(WCHAR);
00243     unicodeInstanceName.MaximumLength += <span class="keyword">sizeof</span>(WCHAR);
00244     PiWstrToUnicodeString(&amp;rootKeyName, REGSTR_KEY_ROOTENUM);
00245     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;tmpKeyName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span>);
00246     <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a>(&amp;unicodeString, &amp;tmpKeyName, &amp;unicodeKeyName);
00247     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeKeyName);
00248     <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a>(&amp;tmpKeyName, &amp;rootKeyName, &amp;unicodeString);
00249     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeString);
00250     <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a>(<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>, &amp;tmpKeyName, &amp;unicodeInstanceName);
00251 
00252     <span class="keywordflow">if</span> (disposition == REG_CREATED_NEW_KEY) {
00253 
00254         <span class="comment">//</span>
00255         <span class="comment">// Create all the default value entry for the newly created key.</span>
00256         <span class="comment">// Service = ServiceKeyName</span>
00257         <span class="comment">// FoundAtEnum = 1</span>
00258         <span class="comment">// Class = "LegacyDriver"</span>
00259         <span class="comment">// ClassGUID = GUID for legacy driver class</span>
00260         <span class="comment">// ConfigFlags = 0</span>
00261         <span class="comment">//</span>
00262         <span class="comment">// Create "Control" subkey with "NewlyCreated" value key</span>
00263         <span class="comment">//</span>
00264 
00265         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_KEY_CONTROL);
00266         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;handle,
00267                                          *<a class="code" href="../../d5/d9/unc_8c.html#a7">ReturnedHandle</a>,
00268                                          &amp;unicodeValueName,
00269                                          KEY_ALL_ACCESS,
00270                                          REG_OPTION_VOLATILE,
00271                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00272                                          );
00273         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00274             PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_NEWLY_CREATED);
00275             tmpValue = 0;
00276             ZwSetValueKey(handle,
00277                           &amp;unicodeValueName,
00278                           <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00279                           REG_DWORD,
00280                           &amp;tmpValue,
00281                           <span class="keyword">sizeof</span>(tmpValue)
00282                           );
00283             ZwClose(handle);
00284         }
00285 
00286         handle = *<a class="code" href="../../d5/d9/unc_8c.html#a7">ReturnedHandle</a>;
00287 
00288         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_SERVICE);
00289         p = (PWSTR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00290                                   ServiceKeyName-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL));
00291         <span class="keywordflow">if</span>(p) {
00292             RtlMoveMemory(p, ServiceKeyName-&gt;Buffer, ServiceKeyName-&gt;Length);
00293             p[ServiceKeyName-&gt;Length / <span class="keyword">sizeof</span> (WCHAR)] = UNICODE_NULL;
00294             ZwSetValueKey(
00295                         handle,
00296                         &amp;unicodeValueName,
00297                         <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00298                         REG_SZ,
00299                         p,
00300                         ServiceKeyName-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL)
00301                         );
00302             <span class="comment">//</span>
00303             <span class="comment">// We'll keep the null-terminated service name buffer around for a while,</span>
00304             <span class="comment">// because we may need it later on for the DeviceDesc in case the service</span>
00305             <span class="comment">// has no DisplayName.</span>
00306             <span class="comment">//</span>
00307             <span class="comment">// ExFreePool(p);</span>
00308         }
00309 
00310         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_LEGACY);
00311         tmpValue = 1;
00312         ZwSetValueKey(
00313                     handle,
00314                     &amp;unicodeValueName,
00315                     <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00316                     REG_DWORD,
00317                     &amp;tmpValue,
00318                     <span class="keyword">sizeof</span>(tmpValue)
00319                     );
00320 
00321         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_CONFIG_FLAGS);
00322         tmpValue = 0;
00323         ZwSetValueKey(
00324                     handle,
00325                     &amp;unicodeValueName,
00326                     <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00327                     REG_DWORD,
00328                     &amp;tmpValue,
00329                     <span class="keyword">sizeof</span>(tmpValue)
00330                     );
00331 
00332         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_CLASS);
00333         ZwSetValueKey(
00334                     handle,
00335                     &amp;unicodeValueName,
00336                     <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00337                     REG_SZ,
00338                     REGSTR_VALUE_LEGACY_DRIVER,
00339                     <span class="keyword">sizeof</span>(REGSTR_VALUE_LEGACY_DRIVER)
00340                     );
00341 
00342         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_CLASSGUID);
00343         ZwSetValueKey(
00344                     handle,
00345                     &amp;unicodeValueName,
00346                     <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00347                     REG_SZ,
00348                     REGSTR_VALUE_LEGACY_DRIVER_CLASS_GUID,
00349                     <span class="keyword">sizeof</span>(REGSTR_VALUE_LEGACY_DRIVER_CLASS_GUID)
00350                     );
00351 
00352 
00353         <span class="comment">//</span>
00354         <span class="comment">// Initialize DeviceDesc= value entry.  If the service key has a "DisplayName"</span>
00355         <span class="comment">// value entry, it is used as the DeviceDesc value.  Otherwise, the service key</span>
00356         <span class="comment">// name is used.</span>
00357         <span class="comment">//</span>
00358 
00359         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a>(ServiceKeyName,
00360                                         KEY_READ,
00361                                         &amp;handle,
00362                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00363                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00364                                         );
00365         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00366 
00367             keyValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00368             unicodeString.Length = 0;
00369             status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(handle,
00370                                          REGSTR_VALUE_DISPLAY_NAME,
00371                                          &amp;keyValueInformation
00372                                         );
00373             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00374                 <span class="keywordflow">if</span> (keyValueInformation-&gt;Type == REG_SZ) {
00375                     <span class="keywordflow">if</span> (keyValueInformation-&gt;DataLength &gt; <span class="keyword">sizeof</span>(UNICODE_NULL)) {
00376                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(&amp;unicodeString,
00377                                                        (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
00378                                                        keyValueInformation-&gt;DataLength
00379                                                        );
00380                     }
00381                 }
00382             }
00383             <span class="keywordflow">if</span> ((unicodeString.Length == 0) &amp;&amp; p) {
00384 
00385                 <span class="comment">//</span>
00386                 <span class="comment">// No DisplayName--use the service key name.</span>
00387                 <span class="comment">//</span>
00388 
00389                 unicodeString.Length = ServiceKeyName-&gt;Length;
00390                 unicodeString.MaximumLength = ServiceKeyName-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL);
00391                 unicodeString.Buffer = p;
00392             }
00393 
00394             <span class="keywordflow">if</span>(unicodeString.Length) {
00395                 PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_DEVICE_DESC);
00396                 ZwSetValueKey(*<a class="code" href="../../d5/d9/unc_8c.html#a7">ReturnedHandle</a>,
00397                               &amp;unicodeValueName,
00398                               <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00399                               REG_SZ,
00400                               unicodeString.Buffer,
00401                               unicodeString.Length + <span class="keyword">sizeof</span>(UNICODE_NULL)
00402                               );
00403             }
00404             <span class="keywordflow">if</span> (keyValueInformation) {
00405                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00406             }
00407             ZwClose(handle);
00408         }
00409 
00410         <span class="keywordflow">if</span>(p) {
00411             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(p);
00412         }
00413     }
00414 
00415     <span class="comment">//</span>
00416     <span class="comment">// Create new value entry under ServiceKeyName\Enum to reflect the newly</span>
00417     <span class="comment">// added made-up device instance node.</span>
00418     <span class="comment">//</span>
00419 
00420     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
00421     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00422     releaseResource = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00423 
00424     status = <a class="code" href="../../d6/d9/pnp_8h.html#a138">PpDeviceRegistration</a>( <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00425 
00426     <span class="keywordflow">if</span> (ResourceOwned) {
00427         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00428         <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00429     }
00430     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;tmpKeyName);
00431     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00432 
00433         <span class="comment">//</span>
00434         <span class="comment">// There is no registry key for the ServiceKeyName information.</span>
00435         <span class="comment">//</span>
00436 
00437         ZwClose(*<a class="code" href="../../d5/d9/unc_8c.html#a7">ReturnedHandle</a>);
00438         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>);
00439     }
00440 local_exit0:
00441     <span class="keywordflow">if</span> (releaseResource) {
00442         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
00443         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00444     }
00445     <span class="keywordflow">return</span> status;
00446 }
00447 
00448 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00449"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a2">00449</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a2">IopRemoveStringFromValueKey</a> (
00450     IN HANDLE Handle,
00451     IN PWSTR ValueName,
00452     IN PUNICODE_STRING String
00453     )
00454 
00455 <span class="comment">/*++</span>
00456 <span class="comment"></span>
00457 <span class="comment">Routine Description:</span>
00458 <span class="comment"></span>
00459 <span class="comment">    This routine remove a string from a value entry specified by ValueName</span>
00460 <span class="comment">    under an already opened registry handle.  Note, this routine will not</span>
00461 <span class="comment">    delete the ValueName entry even it becomes empty after the removal.</span>
00462 <span class="comment"></span>
00463 <span class="comment">Parameters:</span>
00464 <span class="comment"></span>
00465 <span class="comment">    Handle - Supplies the handle to a registry key whose value entry will</span>
00466 <span class="comment">        be modified.</span>
00467 <span class="comment"></span>
00468 <span class="comment">    ValueName - Supplies a unicode string to specify the value entry.</span>
00469 <span class="comment"></span>
00470 <span class="comment">    String - Supplies a unicode string to remove from value entry.</span>
00471 <span class="comment"></span>
00472 <span class="comment">Return Value:</span>
00473 <span class="comment"></span>
00474 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
00475 <span class="comment"></span>
00476 <span class="comment">--*/</span>
00477 
00478 {
00479     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
00480     UNICODE_STRING unicodeString;
00481     PWSTR nextString, currentString;
00482     ULONG length, leftLength;
00483     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00484     BOOLEAN found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00485 
00486     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length / <span class="keyword">sizeof</span>(WCHAR) == 0) {
00487         <span class="keywordflow">return</span> STATUS_SUCCESS;
00488     }
00489 
00490     <span class="comment">//</span>
00491     <span class="comment">// Read registry value entry data</span>
00492     <span class="comment">//</span>
00493 
00494     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>, <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>, &amp;keyValueInformation);
00495 
00496     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00497         <span class="keywordflow">return</span> status;
00498     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type != REG_MULTI_SZ) ||
00499                (keyValueInformation-&gt;DataLength == 0)) {
00500 
00501         status = (keyValueInformation-&gt;Type == REG_MULTI_SZ) ? STATUS_SUCCESS
00502                                                              : STATUS_INVALID_PARAMETER;
00503         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00504         <span class="keywordflow">return</span> status;
00505     }
00506 
00507     <span class="comment">//</span>
00508     <span class="comment">// Scan through the multi_sz string to find the matching string</span>
00509     <span class="comment">// and remove it.</span>
00510     <span class="comment">//</span>
00511 
00512     status = STATUS_SUCCESS;
00513     currentString = (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
00514     leftLength = keyValueInformation-&gt;DataLength;
00515     <span class="keywordflow">while</span> (!found &amp;&amp; leftLength &gt;= <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length + <span class="keyword">sizeof</span>(WCHAR)) {
00516         unicodeString.Buffer = currentString;
00517         length = wcslen( currentString ) * <span class="keyword">sizeof</span>( WCHAR );
00518         unicodeString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)length;
00519         length += <span class="keyword">sizeof</span>(UNICODE_NULL);
00520         unicodeString.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)length;
00521         nextString = currentString + length / <span class="keyword">sizeof</span>(WCHAR);
00522         leftLength -= length;
00523 
00524         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;unicodeString, <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00525             found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00526             RtlMoveMemory(currentString, nextString, leftLength);
00527             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeString, <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>);
00528             status = ZwSetValueKey(
00529                         <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
00530                         &amp;unicodeString,
00531                         <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00532                         REG_MULTI_SZ,
00533                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
00534                         keyValueInformation-&gt;DataLength - length
00535                         );
00536             <span class="keywordflow">break</span>;
00537         } <span class="keywordflow">else</span> {
00538             currentString = nextString;
00539         }
00540     }
00541     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00542     <span class="keywordflow">return</span> status;
00543 }
00544 
00545 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00546"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a3">00546</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a3">IopAppendStringToValueKey</a> (
00547     IN HANDLE Handle,
00548     IN PWSTR ValueName,
00549     IN PUNICODE_STRING String,
00550     IN BOOLEAN Create
00551     )
00552 
00553 <span class="comment">/*++</span>
00554 <span class="comment"></span>
00555 <span class="comment">Routine Description:</span>
00556 <span class="comment"></span>
00557 <span class="comment">    This routine appends a string to a value entry specified by ValueName</span>
00558 <span class="comment">    under an already opened registry handle.  If the ValueName is not present</span>
00559 <span class="comment">    and Create is TRUE, a new value entry will be created using the name</span>
00560 <span class="comment">    ValueName.</span>
00561 <span class="comment"></span>
00562 <span class="comment">Parameters:</span>
00563 <span class="comment"></span>
00564 <span class="comment">    Handle - Supplies the handle to a registry key whose value entry will</span>
00565 <span class="comment">        be modified.</span>
00566 <span class="comment"></span>
00567 <span class="comment">    ValueName - Supplies a pointer to a string to specify the value entry.</span>
00568 <span class="comment"></span>
00569 <span class="comment">    String - Supplies a unicode string to append to the value entry.</span>
00570 <span class="comment"></span>
00571 <span class="comment">    Create - Supplies a BOOLEAN variable to indicate if the ValueName</span>
00572 <span class="comment">        value entry should be created if it is not present.</span>
00573 <span class="comment"></span>
00574 <span class="comment">Return Value:</span>
00575 <span class="comment"></span>
00576 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
00577 <span class="comment"></span>
00578 <span class="comment">--*/</span>
00579 
00580 {
00581     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
00582     PWSTR destinationString, p;
00583     UNICODE_STRING unicodeValueName;
00584     ULONG size;
00585     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00586 
00587     <span class="keywordflow">if</span> ( !<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> || (<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length &lt; <span class="keyword">sizeof</span>(WCHAR)) ) {
00588         <span class="keywordflow">return</span> STATUS_SUCCESS;
00589     }
00590 
00591     <span class="comment">//</span>
00592     <span class="comment">// Read registry value entry data</span>
00593     <span class="comment">//</span>
00594 
00595     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>, <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>, &amp;keyValueInformation);
00596 
00597     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00598         <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND &amp;&amp; <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a>) {
00599 
00600             <span class="comment">//</span>
00601             <span class="comment">// if no valid entry exists and user said ok to create one</span>
00602             <span class="comment">//</span>
00603 
00604             keyValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00605         } <span class="keywordflow">else</span> {
00606             <span class="keywordflow">return</span> status;
00607         }
00608     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(keyValueInformation-&gt;Type != REG_MULTI_SZ) {
00609 
00610         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00611 
00612         <span class="keywordflow">if</span>(<a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a>) {
00613             keyValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00614         } <span class="keywordflow">else</span> {
00615             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
00616         }
00617 
00618     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(keyValueInformation-&gt;DataLength &lt; <span class="keyword">sizeof</span>(WCHAR) ||
00619               *(PWCHAR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation) == UNICODE_NULL) {  <span class="comment">// empty or one NULL WCHAR</span>
00620 
00621         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00622         keyValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00623     }
00624 
00625     <span class="comment">//</span>
00626     <span class="comment">// Allocate a buffer to hold new data for the specified key value entry</span>
00627     <span class="comment">// Make sure the buffer is at least an empty MULTI_SZ big.</span>
00628     <span class="comment">//</span>
00629 
00630     <span class="keywordflow">if</span> (keyValueInformation) {
00631         size = keyValueInformation-&gt;DataLength + <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length + <span class="keyword">sizeof</span> (UNICODE_NULL);
00632     } <span class="keywordflow">else</span> {
00633         size =  <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length + 2 * <span class="keyword">sizeof</span>(UNICODE_NULL);
00634     }
00635 
00636     destinationString = p = (PWSTR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, size);
00637     <span class="keywordflow">if</span> (destinationString == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00638         <span class="keywordflow">if</span> (keyValueInformation) {
00639             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00640         }
00641         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00642     }
00643 
00644     <span class="comment">//</span>
00645     <span class="comment">// Copy the existing data to our newly allocated buffer, if any</span>
00646     <span class="comment">//</span>
00647 
00648     <span class="keywordflow">if</span> (keyValueInformation) {
00649 
00650         <span class="comment">//</span>
00651         <span class="comment">// Note we  need to remove a UNICODE_NULL because the</span>
00652         <span class="comment">// MULTI_SZ has two terminating UNICODE_NULL.</span>
00653         <span class="comment">//</span>
00654 
00655         RtlMoveMemory(p,
00656                       <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
00657                       keyValueInformation-&gt;DataLength - <span class="keyword">sizeof</span>(WCHAR)
00658                       );
00659         p += keyValueInformation-&gt;DataLength / <span class="keyword">sizeof</span>(WCHAR) - 1;
00660 
00661         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00662     }
00663 
00664     <span class="comment">//</span>
00665     <span class="comment">// Append the user specified unicode string to our buffer</span>
00666     <span class="comment">//</span>
00667     RtlMoveMemory(p,
00668                   <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Buffer,
00669                   <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length
00670                   );
00671     p += <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length / <span class="keyword">sizeof</span>(WCHAR);
00672     *p = UNICODE_NULL;
00673     p++;
00674     *p = UNICODE_NULL;
00675 
00676     <span class="comment">//</span>
00677     <span class="comment">// Finally write the data to the specified registy value entry</span>
00678     <span class="comment">//</span>
00679 
00680     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeValueName, <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>);
00681     status = ZwSetValueKey(
00682                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
00683                 &amp;unicodeValueName,
00684                 <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00685                 REG_MULTI_SZ,
00686                 destinationString,
00687                 size
00688                 );
00689 
00690     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(destinationString);
00691     <span class="keywordflow">return</span> status;
00692 }
00693 
00694 BOOLEAN
<a name="l00695"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a4">00695</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a> (
00696     OUT PUNICODE_STRING Destination,
00697     IN  PUNICODE_STRING String1,
00698     IN  PUNICODE_STRING String2  OPTIONAL
00699     )
00700 
00701 <span class="comment">/*++</span>
00702 <span class="comment"></span>
00703 <span class="comment">Routine Description:</span>
00704 <span class="comment"></span>
00705 <span class="comment">    This routine returns a buffer containing the concatenation of the</span>
00706 <span class="comment">    two specified strings.  Since String2 is optional, this function may</span>
00707 <span class="comment">    also be used to make a copy of a unicode string.  Paged pool space</span>
00708 <span class="comment">    is allocated for the destination string.  Caller must release the</span>
00709 <span class="comment">    space once done with it.</span>
00710 <span class="comment"></span>
00711 <span class="comment">Parameters:</span>
00712 <span class="comment"></span>
00713 <span class="comment">    Destination - Supplies a variable to receive the handle of the</span>
00714 <span class="comment">        newly created key.</span>
00715 <span class="comment"></span>
00716 <span class="comment">    String1 - Supplies a pointer to the frist UNICODE_STRING.</span>
00717 <span class="comment"></span>
00718 <span class="comment">    String2 - Supplies an optional pointer to the second UNICODE_STRING.</span>
00719 <span class="comment"></span>
00720 <span class="comment">Return Value:</span>
00721 <span class="comment"></span>
00722 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
00723 <span class="comment"></span>
00724 <span class="comment">--*/</span>
00725 
00726 {
00727     ULONG length;
00728     PWSTR buffer;
00729 
00730     length = <a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL);
00731     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>)) {
00732         length += <a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>-&gt;Length;
00733     }
00734     buffer = (PWSTR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, length);
00735     <span class="keywordflow">if</span> (!buffer) {
00736         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00737     }
00738     Destination-&gt;Buffer = buffer;
00739     Destination-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)length - <span class="keyword">sizeof</span>(UNICODE_NULL);
00740     Destination-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)length;
00741     RtlMoveMemory (Destination-&gt;Buffer, <a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>-&gt;Buffer, <a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>-&gt;Length);
00742     <span class="keywordflow">if</span>(ARGUMENT_PRESENT(<a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>)) {
00743         RtlMoveMemory((PUCHAR)Destination-&gt;Buffer + <a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>-&gt;Length,
00744                       <a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>-&gt;Buffer,
00745                       <a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>-&gt;Length
00746                      );
00747     }
00748     buffer[length / <span class="keyword">sizeof</span>(WCHAR) - 1] = UNICODE_NULL;
00749     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00750 }
00751 
00752 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00753"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a5">00753</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a5">IopPrepareDriverLoading</a> (
00754     IN PUNICODE_STRING KeyName,
00755     IN HANDLE KeyHandle,
00756     IN PIMAGE_NT_HEADERS Header
00757     )
00758 
00759 <span class="comment">/*++</span>
00760 <span class="comment"></span>
00761 <span class="comment">Routine Description:</span>
00762 <span class="comment"></span>
00763 <span class="comment">    This routine first checks if the driver is loadable.  If its a</span>
00764 <span class="comment">    PnP driver, it will always be loaded (we trust it to do the right</span>
00765 <span class="comment">    things.)  If it is a legacy driver, we need to check if its device</span>
00766 <span class="comment">    has been disabled.  Once we decide to load the driver, the Enum</span>
00767 <span class="comment">    subkey of the service node will be checked for duplicates, if any.</span>
00768 <span class="comment"></span>
00769 <span class="comment">Parameters:</span>
00770 <span class="comment"></span>
00771 <span class="comment">    KeyName - Supplies a pointer to the driver's service key unicode string</span>
00772 <span class="comment"></span>
00773 <span class="comment">    KeyHandle - Supplies a handle to the driver service node in the registry</span>
00774 <span class="comment">        that describes the driver to be loaded.</span>
00775 <span class="comment"></span>
00776 <span class="comment">Return Value:</span>
00777 <span class="comment"></span>
00778 <span class="comment">    The function value is the final status of the load operation.</span>
00779 <span class="comment"></span>
00780 <span class="comment">--*/</span>
00781 
00782 {
00783     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00784     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
00785     ULONG tmp, count;
00786     HANDLE serviceEnumHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, sysEnumXxxHandle, controlHandle;
00787     UNICODE_STRING unicodeKeyName, unicodeValueName;
00788     BOOLEAN IsPlugPlayDriver;
00789 
00790     status = STATUS_SUCCESS;
00791     IsPlugPlayDriver = (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> &amp;&amp;
00792                         (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;OptionalHeader.DllCharacteristics &amp; IMAGE_DLLCHARACTERISTICS_WDM_DRIVER))? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00793 
00794     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a19">IopIsAnyDeviceInstanceEnabled</a>(<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>, KeyHandle, (BOOLEAN)(IsPlugPlayDriver ? <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))) {
00795 
00796         <span class="keywordflow">if</span> (IsPlugPlayDriver) {
00797 
00798             <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d0/pnpdata_8c.html#a15">PnPDetectionEnabled</a>) {
00799 
00800                 status = STATUS_PLUGPLAY_NO_DEVICE;
00801 
00802             }
00803 
00804         } <span class="keywordflow">else</span> {
00805 
00806             <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00807             <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00808 
00809             <span class="comment">//</span>
00810             <span class="comment">// First open registry ServiceKeyName\Enum branch</span>
00811             <span class="comment">//</span>
00812 
00813             PiWstrToUnicodeString(&amp;unicodeKeyName, REGSTR_KEY_ENUM);
00814             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;serviceEnumHandle,
00815                                              KeyHandle,
00816                                              &amp;unicodeKeyName,
00817                                              KEY_ALL_ACCESS,
00818                                              REG_OPTION_VOLATILE,
00819                                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00820                                              );
00821             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00822 
00823                 <span class="comment">//</span>
00824                 <span class="comment">// Find out how many device instances listed in the ServiceName's</span>
00825                 <span class="comment">// Enum key.</span>
00826                 <span class="comment">//</span>
00827 
00828                 count = 0;
00829                 status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> ( serviceEnumHandle,
00830                                                REGSTR_VALUE_COUNT,
00831                                                &amp;keyValueInformation);
00832                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00833 
00834                     <span class="keywordflow">if</span> (    keyValueInformation-&gt;Type == REG_DWORD &amp;&amp;
00835                             keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG)) {
00836 
00837                         count = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
00838 
00839                     }
00840 
00841                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00842 
00843                 }
00844                 <span class="keywordflow">if</span> (    <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ||
00845                         status == STATUS_OBJECT_PATH_NOT_FOUND ||
00846                         status == STATUS_OBJECT_NAME_NOT_FOUND) {
00847 
00848                     <span class="keywordflow">if</span> (count) {
00849 
00850                         status = STATUS_PLUGPLAY_NO_DEVICE;
00851 
00852                     } <span class="keywordflow">else</span> {
00853 
00854                         <span class="comment">//</span>
00855                         <span class="comment">// If there is no Enum key or instance under Enum for the</span>
00856                         <span class="comment">// legacy driver we will create a madeup node for it.</span>
00857                         <span class="comment">//</span>
00858 
00859                         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a1">IopCreateMadeupNode</a>(   <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,
00860                                                         &amp;sysEnumXxxHandle,
00861                                                         &amp;unicodeKeyName,
00862                                                         &amp;tmp,
00863                                                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00864                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00865 
00866                             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeKeyName);
00867 
00868                             <span class="comment">//</span>
00869                             <span class="comment">// Create and set Control\ActiveService value</span>
00870                             <span class="comment">//</span>
00871 
00872                             PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_KEY_CONTROL);
00873                             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;controlHandle,
00874                                                              sysEnumXxxHandle,
00875                                                              &amp;unicodeValueName,
00876                                                              KEY_ALL_ACCESS,
00877                                                              REG_OPTION_VOLATILE,
00878                                                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00879                                                              );
00880                             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00881 
00882                                 PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VAL_ACTIVESERVICE);
00883                                 ZwSetValueKey(  controlHandle,
00884                                                 &amp;unicodeValueName,
00885                                                 <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00886                                                 REG_SZ,
00887                                                 <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;Buffer,
00888                                                 <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL));
00889                                 ZwClose(controlHandle);
00890 
00891                             }
00892                             count++;
00893                             <span class="comment">//</span>
00894                             <span class="comment">// Don't forget to update the "Count=" and "NextInstance=" value entries</span>
00895                             <span class="comment">//</span>
00896 
00897                             PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_COUNT);
00898                             ZwSetValueKey(  serviceEnumHandle,
00899                                             &amp;unicodeValueName,
00900                                             <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00901                                             REG_DWORD,
00902                                             &amp;count,
00903                                             <span class="keyword">sizeof</span>(count));
00904 
00905                             PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_NEXT_INSTANCE);
00906                             ZwSetValueKey(  serviceEnumHandle,
00907                                             &amp;unicodeValueName,
00908                                             <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00909                                             REG_DWORD,
00910                                             &amp;count,
00911                                             <span class="keyword">sizeof</span>(count));
00912 
00913                             ZwClose(sysEnumXxxHandle);
00914                             status = STATUS_SUCCESS;
00915                         }
00916                     }
00917                 }
00918 
00919                 ZwClose(serviceEnumHandle);
00920             }
00921 
00922             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
00923             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00924         }
00925     }
00926 
00927     <span class="keywordflow">return</span> status;
00928 }
00929 
00930 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00931"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a6">00931</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a6">IopServiceInstanceToDeviceInstance</a> (
00932     IN  HANDLE ServiceKeyHandle OPTIONAL,
00933     IN  PUNICODE_STRING ServiceKeyName OPTIONAL,
00934     IN  ULONG ServiceInstanceOrdinal,
00935     OUT PUNICODE_STRING DeviceInstanceRegistryPath OPTIONAL,
00936     OUT PHANDLE DeviceInstanceHandle OPTIONAL,
00937     IN  ACCESS_MASK DesiredAccess
00938     )
00939 
00940 <span class="comment">/*++</span>
00941 <span class="comment"></span>
00942 <span class="comment">Routine Description:</span>
00943 <span class="comment"></span>
00944 <span class="comment">    This routine reads the service node enum entry to find the desired device instance</span>
00945 <span class="comment">    under the System\Enum tree.  It then optionally returns the registry path of the</span>
00946 <span class="comment">    specified device instance (relative to HKLM\System\Enum) and an open handle</span>
00947 <span class="comment">    to that registry key.</span>
00948 <span class="comment"></span>
00949 <span class="comment">    It is the caller's responsibility to close the handle returned if</span>
00950 <span class="comment">    DeviceInstanceHandle is supplied, and also to free the (PagedPool) memory</span>
00951 <span class="comment">    allocated for the unicode string buffer of DeviceInstanceRegistryPath, if</span>
00952 <span class="comment">    supplied.</span>
00953 <span class="comment"></span>
00954 <span class="comment">Parameters:</span>
00955 <span class="comment"></span>
00956 <span class="comment">    ServiceKeyHandle - Optionally, supplies a handle to the driver service node in the</span>
00957 <span class="comment">        registry that controls this device instance.  If this argument is not specified,</span>
00958 <span class="comment">        then ServiceKeyName is used to specify the service entry.</span>
00959 <span class="comment"></span>
00960 <span class="comment">    ServiceKeyName - Optionally supplies the name of the service entry that controls</span>
00961 <span class="comment">        the device instance. This must be specified if ServiceKeyHandle isn't given.</span>
00962 <span class="comment"></span>
00963 <span class="comment">    ServiceInstanceOrdinal - Supplies the instance value under the service entry's</span>
00964 <span class="comment">        volatile Enum subkey that references the desired device instance.</span>
00965 <span class="comment"></span>
00966 <span class="comment">    DeviceInstanceRegistryPath - Optionally, supplies a pointer to a unicode string</span>
00967 <span class="comment">        that will be initialized with the registry path (relative to HKLM\System\Enum)</span>
00968 <span class="comment">        to the device instance key.</span>
00969 <span class="comment"></span>
00970 <span class="comment">    DeviceInstanceHandle - Optionally, supplies a pointer to a variable that will</span>
00971 <span class="comment">        receive a handle to the opened device instance registry key.</span>
00972 <span class="comment"></span>
00973 <span class="comment">    DesiredAccess - If DeviceInstanceHandle is specified (i.e., the device instance</span>
00974 <span class="comment">        key is to be opened), then this variable specifies the access that is needed</span>
00975 <span class="comment">        to this key.</span>
00976 <span class="comment"></span>
00977 <span class="comment">Return Value:</span>
00978 <span class="comment"></span>
00979 <span class="comment">    NT status code indicating whether the function was successful.</span>
00980 <span class="comment"></span>
00981 <span class="comment">--*/</span>
00982 
00983 {
00984     WCHAR unicodeBuffer[20];
00985     UNICODE_STRING unicodeKeyName;
00986     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00987     HANDLE handle;
00988     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
00989 
00990     <span class="comment">//</span>
00991     <span class="comment">// Open registry ServiceKeyName\Enum branch</span>
00992     <span class="comment">//</span>
00993     <span class="keywordflow">if</span>(ARGUMENT_PRESENT(ServiceKeyHandle)) {
00994 
00995         PiWstrToUnicodeString(&amp;unicodeKeyName, REGSTR_KEY_ENUM);
00996         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
00997                                        ServiceKeyHandle,
00998                                        &amp;unicodeKeyName,
00999                                        KEY_READ
01000                                        );
01001     } <span class="keywordflow">else</span> {
01002 
01003         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a>(ServiceKeyName,
01004                                         KEY_READ,
01005                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01006                                         &amp;handle,
01007                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01008                                        );
01009     }
01010 
01011     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01012 
01013         <span class="comment">//</span>
01014         <span class="comment">// There is no registry key for the ServiceKeyName\Enum information.</span>
01015         <span class="comment">//</span>
01016 
01017         <span class="keywordflow">return</span> status;
01018     }
01019 
01020     <span class="comment">//</span>
01021     <span class="comment">// Read a path to System\Enum hardware tree branch specified by the service</span>
01022     <span class="comment">// instance ordinal</span>
01023     <span class="comment">//</span>
01024 
01025     swprintf(unicodeBuffer, REGSTR_VALUE_STANDARD_ULONG_FORMAT, ServiceInstanceOrdinal);
01026     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> ( handle,
01027                                    unicodeBuffer,
01028                                    &amp;keyValueInformation
01029                                    );
01030 
01031     ZwClose(handle);
01032     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01033         <span class="keywordflow">return</span> status;
01034     } <span class="keywordflow">else</span> {
01035         <span class="keywordflow">if</span>(keyValueInformation-&gt;Type == REG_SZ) {
01036             <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(&amp;unicodeKeyName,
01037                                            (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
01038                                            keyValueInformation-&gt;DataLength
01039                                           );
01040             <span class="keywordflow">if</span>(!unicodeKeyName.Length) {
01041                 status = STATUS_OBJECT_PATH_NOT_FOUND;
01042             }
01043         } <span class="keywordflow">else</span> {
01044             status = STATUS_INVALID_PLUGPLAY_DEVICE_PATH;
01045         }
01046 
01047         <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01048             <span class="keywordflow">goto</span> PrepareForReturn;
01049         }
01050     }
01051 
01052     <span class="comment">//</span>
01053     <span class="comment">// If the DeviceInstanceHandle argument was specified, open the device instance</span>
01054     <span class="comment">// key under HKLM\System\CurrentControlSet\Enum</span>
01055     <span class="comment">//</span>
01056 
01057     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(DeviceInstanceHandle)) {
01058 
01059         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
01060                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01061                                        &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a23">CmRegistryMachineSystemCurrentControlSetEnumName</a>,
01062                                        KEY_READ
01063                                        );
01064 
01065         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01066 
01067             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( DeviceInstanceHandle,
01068                                            handle,
01069                                            &amp;unicodeKeyName,
01070                                            DesiredAccess
01071                                            );
01072             ZwClose(handle);
01073         }
01074 
01075         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01076             <span class="keywordflow">goto</span> PrepareForReturn;
01077         }
01078     }
01079 
01080     <span class="comment">//</span>
01081     <span class="comment">// If the DeviceInstanceRegistryPath argument was specified, then store a</span>
01082     <span class="comment">// copy of the device instance path in the supplied unicode string variable.</span>
01083     <span class="comment">//</span>
01084     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(DeviceInstanceRegistryPath)) {
01085 
01086         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a>(DeviceInstanceRegistryPath,
01087                                           &amp;unicodeKeyName,
01088                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01089 
01090             <span class="keywordflow">if</span>(ARGUMENT_PRESENT(DeviceInstanceHandle)) {
01091                 ZwClose(*DeviceInstanceHandle);
01092             }
01093             status = STATUS_INSUFFICIENT_RESOURCES;
01094         }
01095     }
01096 
01097 PrepareForReturn:
01098 
01099     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
01100     <span class="keywordflow">return</span> status;
01101 }
01102 
01103 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01104"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">01104</a> <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>(
01105     OUT PHANDLE Handle,
01106     IN HANDLE BaseHandle OPTIONAL,
01107     IN PUNICODE_STRING KeyName,
01108     IN ACCESS_MASK DesiredAccess
01109     )
01110 
01111 <span class="comment">/*++</span>
01112 <span class="comment"></span>
01113 <span class="comment">Routine Description:</span>
01114 <span class="comment"></span>
01115 <span class="comment">    Opens a registry key using the name passed in based at the BaseHandle node.</span>
01116 <span class="comment">    This name may specify a key that is actually a registry path.</span>
01117 <span class="comment"></span>
01118 <span class="comment">Arguments:</span>
01119 <span class="comment"></span>
01120 <span class="comment">    Handle - Pointer to the handle which will contain the registry key that</span>
01121 <span class="comment">        was opened.</span>
01122 <span class="comment"></span>
01123 <span class="comment">    BaseHandle - Optional handle to the base path from which the key must be opened.</span>
01124 <span class="comment">        If KeyName specifies a registry path that must be created, then this parameter</span>
01125 <span class="comment">        must be specified, and KeyName must be a relative path.</span>
01126 <span class="comment"></span>
01127 <span class="comment">    KeyName - Name of the Key that must be opened/created (possibly a registry path)</span>
01128 <span class="comment"></span>
01129 <span class="comment">    DesiredAccess - Specifies the desired access that the caller needs to</span>
01130 <span class="comment">        the key.</span>
01131 <span class="comment"></span>
01132 <span class="comment">Return Value:</span>
01133 <span class="comment"></span>
01134 <span class="comment">   The function value is the final status of the operation.</span>
01135 <span class="comment"></span>
01136 <span class="comment">--*/</span>
01137 
01138 {
01139     OBJECT_ATTRIBUTES objectAttributes;
01140 
01141     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01142 
01143     InitializeObjectAttributes( &amp;objectAttributes,
01144                                 <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,
01145                                 OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,
01146                                 BaseHandle,
01147                                 (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01148                                 );
01149     <span class="comment">//</span>
01150     <span class="comment">// Simply attempt to open the path, as specified.</span>
01151     <span class="comment">//</span>
01152     <span class="keywordflow">return</span> ZwOpenKey( <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>, DesiredAccess, &amp;objectAttributes );
01153 }
01154 
01155 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01156"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">01156</a> <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>(
01157     OUT PHANDLE Handle,
01158     IN HANDLE BaseHandle OPTIONAL,
01159     IN PUNICODE_STRING KeyName,
01160     IN ACCESS_MASK DesiredAccess,
01161     IN ULONG CreateOptions,
01162     OUT PULONG Disposition OPTIONAL
01163     )
01164 
01165 <span class="comment">/*++</span>
01166 <span class="comment"></span>
01167 <span class="comment">Routine Description:</span>
01168 <span class="comment"></span>
01169 <span class="comment">    Opens or creates a registry key using the name</span>
01170 <span class="comment">    passed in based at the BaseHandle node. This name may specify a key</span>
01171 <span class="comment">    that is actually a registry path, in which case each intermediate subkey</span>
01172 <span class="comment">    will be created (if Create is TRUE).</span>
01173 <span class="comment"></span>
01174 <span class="comment">    NOTE: Creating a registry path (i.e., more than one of the keys in the path</span>
01175 <span class="comment">    do not presently exist) requires that a BaseHandle be specified.</span>
01176 <span class="comment"></span>
01177 <span class="comment">Arguments:</span>
01178 <span class="comment"></span>
01179 <span class="comment">    Handle - Pointer to the handle which will contain the registry key that</span>
01180 <span class="comment">        was opened.</span>
01181 <span class="comment"></span>
01182 <span class="comment">    BaseHandle - Optional handle to the base path from which the key must be opened.</span>
01183 <span class="comment">        If KeyName specifies a registry path that must be created, then this parameter</span>
01184 <span class="comment">        must be specified, and KeyName must be a relative path.</span>
01185 <span class="comment"></span>
01186 <span class="comment">    KeyName - Name of the Key that must be opened/created (possibly a registry path)</span>
01187 <span class="comment"></span>
01188 <span class="comment">    DesiredAccess - Specifies the desired access that the caller needs to</span>
01189 <span class="comment">        the key.</span>
01190 <span class="comment"></span>
01191 <span class="comment">    CreateOptions - Options passed to ZwCreateKey.</span>
01192 <span class="comment"></span>
01193 <span class="comment">    Disposition - If Create is TRUE, this optional pointer receives a ULONG indicating</span>
01194 <span class="comment">        whether the key was newly created:</span>
01195 <span class="comment"></span>
01196 <span class="comment">            REG_CREATED_NEW_KEY - A new Registry Key was created</span>
01197 <span class="comment">            REG_OPENED_EXISTING_KEY - An existing Registry Key was opened</span>
01198 <span class="comment"></span>
01199 <span class="comment">Return Value:</span>
01200 <span class="comment"></span>
01201 <span class="comment">   The function value is the final status of the operation.</span>
01202 <span class="comment"></span>
01203 <span class="comment">--*/</span>
01204 
01205 {
01206     OBJECT_ATTRIBUTES objectAttributes;
01207     ULONG disposition, baseHandleIndex = 0, keyHandleIndex = 1, closeBaseHandle;
01208     HANDLE handles[2];
01209     BOOLEAN continueParsing;
01210     PWCHAR pathEndPtr, pathCurPtr, pathBeginPtr;
01211     ULONG pathComponentLength;
01212     UNICODE_STRING unicodeString;
01213     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01214 
01215     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01216 
01217     InitializeObjectAttributes( &amp;objectAttributes,
01218                                 <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,
01219                                 OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,
01220                                 BaseHandle,
01221                                 (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01222                                 );
01223     <span class="comment">//</span>
01224     <span class="comment">// Attempt to create the path as specified. We have to try it this</span>
01225     <span class="comment">// way first, because it allows us to create a key without a BaseHandle</span>
01226     <span class="comment">// (if only the last component of the registry path is not present).</span>
01227     <span class="comment">//</span>
01228     status = ZwCreateKey(&amp;(handles[keyHandleIndex]),
01229                          DesiredAccess,
01230                          &amp;objectAttributes,
01231                          0,
01232                          (PUNICODE_STRING) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01233                          CreateOptions,
01234                          &amp;disposition
01235                          );
01236 
01237     <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND &amp;&amp; ARGUMENT_PRESENT(BaseHandle)) {
01238         <span class="comment">//</span>
01239         <span class="comment">// If we get to here, then there must be more than one element of the</span>
01240         <span class="comment">// registry path that does not currently exist.  We will now parse the</span>
01241         <span class="comment">// specified path, extracting each component and doing a ZwCreateKey on it.</span>
01242         <span class="comment">//</span>
01243         handles[baseHandleIndex] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01244         handles[keyHandleIndex] = BaseHandle;
01245         closeBaseHandle = 0;
01246         continueParsing = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01247         pathBeginPtr = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;Buffer;
01248         pathEndPtr = (PWCHAR)((PCHAR)pathBeginPtr + <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;Length);
01249         status = STATUS_SUCCESS;
01250 
01251         <span class="keywordflow">while</span>(continueParsing) {
01252             <span class="comment">//</span>
01253             <span class="comment">// There's more to do, so close the previous base handle (if necessary),</span>
01254             <span class="comment">// and replace it with the current key handle.</span>
01255             <span class="comment">//</span>
01256             <span class="keywordflow">if</span>(closeBaseHandle &gt; 1) {
01257                 ZwClose(handles[baseHandleIndex]);
01258             }
01259             baseHandleIndex = keyHandleIndex;
01260             keyHandleIndex = (keyHandleIndex + 1) &amp; 1;  <span class="comment">// toggle between 0 and 1.</span>
01261             handles[keyHandleIndex] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01262 
01263             <span class="comment">//</span>
01264             <span class="comment">// Extract next component out of the specified registry path.</span>
01265             <span class="comment">//</span>
01266             <span class="keywordflow">for</span>(pathCurPtr = pathBeginPtr;
01267                 ((pathCurPtr &lt; pathEndPtr) &amp;&amp; (*pathCurPtr != OBJ_NAME_PATH_SEPARATOR));
01268                 pathCurPtr++);
01269 
01270             <span class="keywordflow">if</span>((pathComponentLength = (ULONG)((PCHAR)pathCurPtr - (PCHAR)pathBeginPtr))) {
01271                 <span class="comment">//</span>
01272                 <span class="comment">// Then we have a non-empty path component (key name).  Attempt</span>
01273                 <span class="comment">// to create this key.</span>
01274                 <span class="comment">//</span>
01275                 unicodeString.Buffer = pathBeginPtr;
01276                 unicodeString.Length = unicodeString.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)pathComponentLength;
01277 
01278                 InitializeObjectAttributes(&amp;objectAttributes,
01279                                            &amp;unicodeString,
01280                                            OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,
01281                                            handles[baseHandleIndex],
01282                                            (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01283                                           );
01284                 status = ZwCreateKey(&amp;(handles[keyHandleIndex]),
01285                                      DesiredAccess,
01286                                      &amp;objectAttributes,
01287                                      0,
01288                                      (PUNICODE_STRING) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01289                                      CreateOptions,
01290                                      &amp;disposition
01291                                     );
01292                 <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01293                     <span class="comment">//</span>
01294                     <span class="comment">// Increment the closeBaseHandle value, which basically tells us whether</span>
01295                     <span class="comment">// the BaseHandle passed in has been 'shifted out' of our way, so that</span>
01296                     <span class="comment">// we should start closing our base handles when we're finished with them.</span>
01297                     <span class="comment">//</span>
01298                     closeBaseHandle++;
01299                 } <span class="keywordflow">else</span> {
01300                     continueParsing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01301                     <span class="keywordflow">continue</span>;
01302                 }
01303             } <span class="keywordflow">else</span> {
01304                 <span class="comment">//</span>
01305                 <span class="comment">// Either a path separator ('\') was included at the beginning of</span>
01306                 <span class="comment">// the path, or we hit 2 consecutive separators.</span>
01307                 <span class="comment">//</span>
01308                 status = STATUS_INVALID_PARAMETER;
01309                 continueParsing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01310                 <span class="keywordflow">continue</span>;
01311             }
01312 
01313             <span class="keywordflow">if</span>((pathCurPtr == pathEndPtr) ||
01314                ((pathBeginPtr = pathCurPtr + 1) == pathEndPtr)) {
01315                 <span class="comment">//</span>
01316                 <span class="comment">// Then we've reached the end of the path</span>
01317                 <span class="comment">//</span>
01318                 continueParsing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01319             }
01320         }
01321 
01322         <span class="keywordflow">if</span>(closeBaseHandle &gt; 1) {
01323             ZwClose(handles[baseHandleIndex]);
01324         }
01325     }
01326 
01327     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01328         *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = handles[keyHandleIndex];
01329 
01330         <span class="keywordflow">if</span>(ARGUMENT_PRESENT(Disposition)) {
01331             *Disposition = disposition;
01332         }
01333     }
01334 
01335     <span class="keywordflow">return</span> status;
01336 }
01337 
01338 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01339"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a9">01339</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a> (
01340     IN PUNICODE_STRING ServiceKeyName,
01341     IN ACCESS_MASK DesiredAccess,
01342     OUT PHANDLE ServiceHandle OPTIONAL,
01343     OUT PHANDLE ServiceEnumHandle OPTIONAL,
01344     IN BOOLEAN CreateEnum
01345     )
01346 
01347 <span class="comment">/*++</span>
01348 <span class="comment"></span>
01349 <span class="comment">Routine Description:</span>
01350 <span class="comment"></span>
01351 <span class="comment">    This routine opens the HKEY_LOCAL_MACHINE\CurrentControlSet\Services\</span>
01352 <span class="comment">    ServiceKeyName and its Enum subkey and returns handles for both key.</span>
01353 <span class="comment">    It is caller's responsibility to close the returned handles.</span>
01354 <span class="comment"></span>
01355 <span class="comment">Arguments:</span>
01356 <span class="comment"></span>
01357 <span class="comment">    ServiceKeyName - Supplies a pointer to the name of the subkey in the</span>
01358 <span class="comment">        system service list (HKEY_LOCAL_MACHINE\CurrentControlSet\Services)</span>
01359 <span class="comment">        that caused the driver to load. This is the RegistryPath parameter</span>
01360 <span class="comment">        to the DriverEntry routine.</span>
01361 <span class="comment"></span>
01362 <span class="comment">    DesiredAccess - Specifies the desired access to the keys.</span>
01363 <span class="comment"></span>
01364 <span class="comment">    ServiceHandle - Supplies a variable to receive a handle to ServiceKeyName.</span>
01365 <span class="comment">        A NULL ServiceHandle indicates caller does not want need the handle to</span>
01366 <span class="comment">        the ServiceKeyName.</span>
01367 <span class="comment"></span>
01368 <span class="comment">    ServiceEnumHandle - Supplies a variable to receive a handle to ServiceKeyName\Enum.</span>
01369 <span class="comment">        A NULL ServiceEnumHandle indicates caller does not need the handle to</span>
01370 <span class="comment">        the ServiceKeyName\Enum.</span>
01371 <span class="comment"></span>
01372 <span class="comment">    CreateEnum - Supplies a BOOLEAN variable to indicate should the Enum subkey be</span>
01373 <span class="comment">        created if not present.</span>
01374 <span class="comment"></span>
01375 <span class="comment">Return Value:</span>
01376 <span class="comment"></span>
01377 <span class="comment">    status</span>
01378 <span class="comment"></span>
01379 <span class="comment">--*/</span>
01380 
01381 {
01382     HANDLE handle, serviceHandle, enumHandle;
01383     UNICODE_STRING enumName;
01384     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01385 
01386     <span class="comment">//</span>
01387     <span class="comment">// Open System\CurrentControlSet\Services</span>
01388     <span class="comment">//</span>
01389 
01390     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
01391                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01392                                    &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a25">CmRegistryMachineSystemCurrentControlSetServices</a>,
01393                                    DesiredAccess
01394                                    );
01395 
01396     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01397         <span class="keywordflow">return</span> status;
01398     }
01399 
01400     <span class="comment">//</span>
01401     <span class="comment">// Open the registry ServiceKeyName key.</span>
01402     <span class="comment">//</span>
01403 
01404     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;serviceHandle,
01405                                    handle,
01406                                    ServiceKeyName,
01407                                    DesiredAccess
01408                                    );
01409 
01410     ZwClose(handle);
01411     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01412 
01413         <span class="comment">//</span>
01414         <span class="comment">// There is no registry key for the ServiceKeyName information.</span>
01415         <span class="comment">//</span>
01416 
01417         <span class="keywordflow">return</span> status;
01418     }
01419 
01420     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ServiceEnumHandle) || CreateEnum) {
01421 
01422         <span class="comment">//</span>
01423         <span class="comment">// Open registry ServiceKeyName\Enum branch if caller wants</span>
01424         <span class="comment">// the handle or wants to create it.</span>
01425         <span class="comment">//</span>
01426 
01427         PiWstrToUnicodeString(&amp;enumName, REGSTR_KEY_ENUM);
01428 
01429         <span class="keywordflow">if</span> (CreateEnum) {
01430             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;enumHandle,
01431                                              serviceHandle,
01432                                              &amp;enumName,
01433                                              DesiredAccess,
01434                                              REG_OPTION_VOLATILE,
01435                                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01436                                              );
01437         } <span class="keywordflow">else</span> {
01438             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;enumHandle,
01439                                            serviceHandle,
01440                                            &amp;enumName,
01441                                            DesiredAccess
01442                                            );
01443 
01444         }
01445 
01446         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01447 
01448             <span class="comment">//</span>
01449             <span class="comment">// There is no registry key for the ServiceKeyName\Enum information.</span>
01450             <span class="comment">//</span>
01451 
01452             ZwClose(serviceHandle);
01453             <span class="keywordflow">return</span> status;
01454         }
01455         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ServiceEnumHandle)) {
01456             *ServiceEnumHandle = enumHandle;
01457         } <span class="keywordflow">else</span> {
01458             ZwClose(enumHandle);
01459         }
01460     }
01461 
01462     <span class="comment">//</span>
01463     <span class="comment">// if caller wants to have the ServiceKey handle, we return it.  Otherwise</span>
01464     <span class="comment">// we close it.</span>
01465     <span class="comment">//</span>
01466 
01467     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ServiceHandle)) {
01468         *ServiceHandle = serviceHandle;
01469     } <span class="keywordflow">else</span> {
01470         ZwClose(serviceHandle);
01471     }
01472 
01473     <span class="keywordflow">return</span> STATUS_SUCCESS;
01474 }
01475 
01476 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01477"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a10">01477</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a9">IopGetDeviceInstanceCsConfigFlags</a>(
01478     IN PUNICODE_STRING DeviceInstance,
01479     OUT PULONG CsConfigFlags
01480     )
01481 
01482 <span class="comment">/*++</span>
01483 <span class="comment"></span>
01484 <span class="comment">Routine Description:</span>
01485 <span class="comment"></span>
01486 <span class="comment">    This routine retrieves the csconfig flags for the specified device.</span>
01487 <span class="comment"></span>
01488 <span class="comment">Arguments:</span>
01489 <span class="comment"></span>
01490 <span class="comment">    DeviceInstance - Supplies a pointer to the devnode's instance path</span>
01491 <span class="comment"></span>
01492 <span class="comment">    CsConfigFlags - Supplies a variable to receive the device's CsConfigFlags</span>
01493 <span class="comment"></span>
01494 <span class="comment">Return Value:</span>
01495 <span class="comment"></span>
01496 <span class="comment">    status</span>
01497 <span class="comment"></span>
01498 <span class="comment">--*/</span>
01499 
01500 {
01501     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01502     HANDLE handle1, handle2;
01503     UNICODE_STRING tempUnicodeString;
01504     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
01505 
01506     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01507 
01508     *CsConfigFlags = 0;
01509 
01510     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle1,
01511                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01512                                    &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a26">CmRegistryMachineSystemCurrentControlSetHardwareProfilesCurrent</a>,
01513                                    KEY_READ
01514                                    );
01515 
01516     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01517 
01518         <span class="keywordflow">return</span> status;
01519     }
01520 
01521     <span class="comment">//</span>
01522     <span class="comment">// Now, we must open the System\CCS\Enum key under this.</span>
01523     <span class="comment">//</span>
01524     <span class="comment">//</span>
01525     <span class="comment">// Open system\CurrentControlSet under current hardware profile key</span>
01526     <span class="comment">//</span>
01527 
01528     PiWstrToUnicodeString(&amp;tempUnicodeString, REGSTR_PATH_CURRENTCONTROLSET);
01529     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle2,
01530                                    handle1,
01531                                    &amp;tempUnicodeString,
01532                                    KEY_READ
01533                                    );
01534     ZwClose(handle1);
01535 
01536     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01537 
01538         <span class="keywordflow">return</span> status;
01539     }
01540 
01541     PiWstrToUnicodeString(&amp;tempUnicodeString, REGSTR_KEY_ENUM);
01542 
01543     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle1,
01544                                    handle2,
01545                                    &amp;tempUnicodeString,
01546                                    KEY_READ
01547                                    );
01548 
01549     ZwClose(handle2);
01550 
01551     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01552 
01553         <span class="keywordflow">return</span> status;
01554     }
01555 
01556 
01557     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle2,
01558                                    handle1,
01559                                    DeviceInstance,
01560                                    KEY_READ
01561                                    );
01562 
01563     ZwClose(handle1);
01564 
01565     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01566 
01567         <span class="keywordflow">return</span> status;
01568     }
01569 
01570 
01571     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( handle2,
01572                                   REGSTR_VALUE_CSCONFIG_FLAGS,
01573                                   &amp;keyValueInformation
01574                                   );
01575 
01576     ZwClose(handle2);
01577 
01578     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01579         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
01580             (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
01581 
01582             *CsConfigFlags = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
01583         }
01584         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
01585     }
01586 
01587     <span class="keywordflow">return</span> status;
01588 }
01589 
01590 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01591"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a11">01591</a> <a class="code" href="../../d9/d1/pnpsubs_8c.html#a11">IopGetServiceInstanceCsConfigFlags</a>(
01592     IN PUNICODE_STRING ServiceKeyName,
01593     IN ULONG Instance,
01594     OUT PULONG CsConfigFlags
01595     )
01596 
01597 <span class="comment">/*++</span>
01598 <span class="comment"></span>
01599 <span class="comment">Routine Description:</span>
01600 <span class="comment"></span>
01601 <span class="comment">    This routine retrieves the csconfig flags for the specified device</span>
01602 <span class="comment">    which is specified by the instance number under ServiceKeyName\Enum.</span>
01603 <span class="comment"></span>
01604 <span class="comment">Arguments:</span>
01605 <span class="comment"></span>
01606 <span class="comment">    ServiceKeyName - Supplies a pointer to the name of the subkey in the</span>
01607 <span class="comment">        system service list (HKEY_LOCAL_MACHINE\CurrentControlSet\Services)</span>
01608 <span class="comment">        that caused the driver to load.</span>
01609 <span class="comment"></span>
01610 <span class="comment">    Instance - Supplies the instance value under ServiceKeyName\Enum key</span>
01611 <span class="comment"></span>
01612 <span class="comment">    CsConfigFlags - Supplies a variable to receive the device's CsConfigFlags</span>
01613 <span class="comment"></span>
01614 <span class="comment">Return Value:</span>
01615 <span class="comment"></span>
01616 <span class="comment">    status</span>
01617 <span class="comment"></span>
01618 <span class="comment">--*/</span>
01619 
01620 {
01621     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01622     HANDLE handle;
01623     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
01624 
01625     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01626 
01627     *CsConfigFlags = 0;
01628 
01629     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a11">IopOpenCurrentHwProfileDeviceInstanceKey</a>(&amp;handle,
01630                                                       ServiceKeyName,
01631                                                       Instance,
01632                                                       KEY_READ,
01633                                                       <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01634                                                      );
01635     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01636         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(handle,
01637                                      REGSTR_VALUE_CSCONFIG_FLAGS,
01638                                      &amp;keyValueInformation
01639                                     );
01640         <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01641             <span class="keywordflow">if</span>((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
01642                (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
01643                 *CsConfigFlags = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
01644             }
01645             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
01646         }
01647         ZwClose(handle);
01648     }
01649     <span class="keywordflow">return</span> status;
01650 }
01651 
01652 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01653"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a12">01653</a> <a class="code" href="../../d9/d1/pnpsubs_8c.html#a12">IopSetServiceInstanceCsConfigFlags</a>(
01654     IN PUNICODE_STRING ServiceKeyName,
01655     IN ULONG Instance,
01656     IN ULONG CsConfigFlags
01657     )
01658 
01659 <span class="comment">/*++</span>
01660 <span class="comment"></span>
01661 <span class="comment">Routine Description:</span>
01662 <span class="comment"></span>
01663 <span class="comment">    This routine sets the csconfig flags for the specified device</span>
01664 <span class="comment">    which is specified by the instance number under ServiceKeyName\Enum.</span>
01665 <span class="comment"></span>
01666 <span class="comment">Arguments:</span>
01667 <span class="comment"></span>
01668 <span class="comment">    ServiceKeyName - Supplies a pointer to the name of the subkey in the</span>
01669 <span class="comment">        system service list (HKEY_LOCAL_MACHINE\CurrentControlSet\Services)</span>
01670 <span class="comment">        that caused the driver to load. This is the RegistryPath parameter</span>
01671 <span class="comment">        to the DriverEntry routine.</span>
01672 <span class="comment"></span>
01673 <span class="comment">    Instance - Supplies the instance value under ServiceKeyName\Enum key</span>
01674 <span class="comment"></span>
01675 <span class="comment">    CsConfigFlags - Supplies the device instance's new CsConfigFlags</span>
01676 <span class="comment"></span>
01677 <span class="comment">Return Value:</span>
01678 <span class="comment"></span>
01679 <span class="comment">    status</span>
01680 <span class="comment"></span>
01681 <span class="comment">--*/</span>
01682 
01683 {
01684     HANDLE handle;
01685     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01686     UNICODE_STRING tempUnicodeString;
01687 
01688     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01689 
01690     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a11">IopOpenCurrentHwProfileDeviceInstanceKey</a>(&amp;handle,
01691                                                       ServiceKeyName,
01692                                                       Instance,
01693                                                       KEY_READ | KEY_WRITE,
01694                                                       <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
01695                                                      );
01696     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01697 
01698         PiWstrToUnicodeString(&amp;tempUnicodeString, REGSTR_VALUE_CSCONFIG_FLAGS);
01699         status = ZwSetValueKey(handle,
01700                                &amp;tempUnicodeString,
01701                                <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
01702                                REG_DWORD,
01703                                &amp;CsConfigFlags,
01704                                <span class="keyword">sizeof</span>(CsConfigFlags)
01705                               );
01706         ZwClose(handle);
01707     }
01708     <span class="keywordflow">return</span> status;
01709 }
01710 
01711 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01712"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a13">01712</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a11">IopOpenCurrentHwProfileDeviceInstanceKey</a>(
01713     OUT PHANDLE Handle,
01714     IN  PUNICODE_STRING ServiceKeyName,
01715     IN  ULONG Instance,
01716     IN  ACCESS_MASK DesiredAccess,
01717     IN  BOOLEAN Create
01718     )
01719 
01720 <span class="comment">/*++</span>
01721 <span class="comment"></span>
01722 <span class="comment">Routine Description:</span>
01723 <span class="comment"></span>
01724 <span class="comment">    This routine sets the csconfig flags for the specified device</span>
01725 <span class="comment">    which is specified by the instance number under ServiceKeyName\Enum.</span>
01726 <span class="comment"></span>
01727 <span class="comment">Arguments:</span>
01728 <span class="comment"></span>
01729 <span class="comment">    ServiceKeyName - Supplies a pointer to the name of the subkey in the</span>
01730 <span class="comment">        system service list (HKEY_LOCAL_MACHINE\CurrentControlSet\Services)</span>
01731 <span class="comment">        that caused the driver to load. This is the RegistryPath parameter</span>
01732 <span class="comment">        to the DriverEntry routine.</span>
01733 <span class="comment"></span>
01734 <span class="comment">    Instance - Supplies the instance value under ServiceKeyName\Enum key</span>
01735 <span class="comment"></span>
01736 <span class="comment">    DesiredAccess - Specifies the desired access that the caller needs to</span>
01737 <span class="comment">        the key.</span>
01738 <span class="comment"></span>
01739 <span class="comment">    Create - Determines if the key is to be created if it does not exist.</span>
01740 <span class="comment"></span>
01741 <span class="comment">Return Value:</span>
01742 <span class="comment"></span>
01743 <span class="comment">    status</span>
01744 <span class="comment"></span>
01745 <span class="comment">--*/</span>
01746 
01747 {
01748     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01749     UNICODE_STRING tempUnicodeString;
01750     HANDLE profileHandle, profileEnumHandle, tmpHandle;
01751 
01752     <span class="comment">//</span>
01753     <span class="comment">// See if we can open current hardware profile</span>
01754     <span class="comment">//</span>
01755 
01756     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a>) {
01757         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;profileHandle,
01758                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01759                                          &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a26">CmRegistryMachineSystemCurrentControlSetHardwareProfilesCurrent</a>,
01760                                          KEY_READ,
01761                                          REG_OPTION_NON_VOLATILE,
01762                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01763                                          );
01764     } <span class="keywordflow">else</span> {
01765         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;profileHandle,
01766                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01767                                        &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a26">CmRegistryMachineSystemCurrentControlSetHardwareProfilesCurrent</a>,
01768                                        KEY_READ
01769                                        );
01770     }
01771 
01772     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01773         <span class="comment">//</span>
01774         <span class="comment">// Now, we must open the System\CCS\Enum key under this.</span>
01775         <span class="comment">//</span>
01776         <span class="comment">//</span>
01777         <span class="comment">// Open system\CurrentControlSet under current hardware profile key</span>
01778         <span class="comment">//</span>
01779 
01780         PiWstrToUnicodeString(&amp;tempUnicodeString, REGSTR_PATH_CURRENTCONTROLSET);
01781         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;tmpHandle,
01782                                        profileHandle,
01783                                        &amp;tempUnicodeString,
01784                                        DesiredAccess
01785                                        );
01786         ZwClose(profileHandle);
01787         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01788             <span class="keywordflow">return</span> status;
01789         }
01790 
01791         PiWstrToUnicodeString(&amp;tempUnicodeString, REGSTR_KEY_ENUM);
01792 
01793         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a>) {
01794             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;profileEnumHandle,
01795                                              tmpHandle,
01796                                              &amp;tempUnicodeString,
01797                                              KEY_READ,
01798                                              REG_OPTION_NON_VOLATILE,
01799                                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01800                                              );
01801         } <span class="keywordflow">else</span> {
01802             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;profileEnumHandle,
01803                                            tmpHandle,
01804                                            &amp;tempUnicodeString,
01805                                            KEY_READ
01806                                            );
01807         }
01808 
01809         ZwClose(tmpHandle);
01810         <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01811 
01812             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a6">IopServiceInstanceToDeviceInstance</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01813                                                         ServiceKeyName,
01814                                                         Instance,
01815                                                         &amp;tempUnicodeString,
01816                                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01817                                                         0
01818                                                        );
01819             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01820                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a>) {
01821                     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
01822                                                      profileEnumHandle,
01823                                                      &amp;tempUnicodeString,
01824                                                      DesiredAccess,
01825                                                      REG_OPTION_NON_VOLATILE,
01826                                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01827                                                      );
01828                 } <span class="keywordflow">else</span> {
01829                     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
01830                                                    profileEnumHandle,
01831                                                    &amp;tempUnicodeString,
01832                                                    DesiredAccess
01833                                                    );
01834                 }
01835                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;tempUnicodeString);
01836             }
01837             ZwClose(profileEnumHandle);
01838         }
01839     }
01840     <span class="keywordflow">return</span> status;
01841 }
01842 
01843 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01844"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a14">01844</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a12">IopApplyFunctionToSubKeys</a>(
01845     IN     HANDLE BaseHandle OPTIONAL,
01846     IN     PUNICODE_STRING KeyName OPTIONAL,
01847     IN     ACCESS_MASK DesiredAccess,
01848     IN     ULONG Flags,
01849     IN     PIOP_SUBKEY_CALLBACK_ROUTINE SubKeyCallbackRoutine,
01850     IN OUT PVOID Context
01851     )
01852 
01853 <span class="comment">/*++</span>
01854 <span class="comment"></span>
01855 <span class="comment">Routine Description:</span>
01856 <span class="comment"></span>
01857 <span class="comment">    This routine enumerates all subkeys under the specified key, and calls</span>
01858 <span class="comment">    the specified callback routine for each subkey.</span>
01859 <span class="comment"></span>
01860 <span class="comment">Arguments:</span>
01861 <span class="comment"></span>
01862 <span class="comment">    BaseHandle - Optional handle to the base registry path. If KeyName is also</span>
01863 <span class="comment">        specified, then KeyName represents a subkey under this path.  If KeyName</span>
01864 <span class="comment">        is not specified, the subkeys are enumerated under this handle.  If this</span>
01865 <span class="comment">        parameter is not specified, then the full path to the base key must be</span>
01866 <span class="comment">        given in KeyName.</span>
01867 <span class="comment"></span>
01868 <span class="comment">    KeyName - Optional name of the key whose subkeys are to be enumerated.</span>
01869 <span class="comment"></span>
01870 <span class="comment">    DesiredAccess - Specifies the desired access that the callback routine</span>
01871 <span class="comment">        needs to the subkeys.  If no desired access is specified (i.e.,</span>
01872 <span class="comment">        DesiredAccess is zero), then no handle will be opened for the</span>
01873 <span class="comment">        subkeys, and the callback will be passed a NULL for its SubKeyHandle</span>
01874 <span class="comment">        parameter.</span>
01875 <span class="comment"></span>
01876 <span class="comment">    Flags - Controls the behavior of subkey enumeration.  Currently, the</span>
01877 <span class="comment">        following flags are defined:</span>
01878 <span class="comment"></span>
01879 <span class="comment">        FUNCTIONSUBKEY_FLAG_IGNORE_NON_CRITICAL_ERRORS - Specifies whether this</span>
01880 <span class="comment">            function should immediately terminate on all errors, or only on</span>
01881 <span class="comment">            critical ones.  An example of a non-critical error is when an</span>
01882 <span class="comment">            enumerated subkey cannot be opened for the desired access.</span>
01883 <span class="comment"></span>
01884 <span class="comment">        FUNCTION_SUBKEY_DELETE_SUBKEYS - Specifies that each subkey should be</span>
01885 <span class="comment">            deleted after the specified SubKeyCallBackRoutine has been performed</span>
01886 <span class="comment">            on it.  Note that this is NOT a recursive delete on each of the</span>
01887 <span class="comment">            subkeys, just an attempt to delete the subkey itself.  It the subkey</span>
01888 <span class="comment">            contains children, this will fail.</span>
01889 <span class="comment"></span>
01890 <span class="comment">    SubKeyCallbackRoutine - Supplies a pointer to a function that will</span>
01891 <span class="comment">        be called for each subkey found under the</span>
01892 <span class="comment">        specified key.  The prototype of the function</span>
01893 <span class="comment">        is as follows:</span>
01894 <span class="comment"></span>
01895 <span class="comment">            typedef BOOLEAN (*PIOP_SUBKEY_CALLBACK_ROUTINE) (</span>
01896 <span class="comment">                IN     HANDLE SubKeyHandle,</span>
01897 <span class="comment">                IN     PUNICODE_STRING SubKeyName,</span>
01898 <span class="comment">                IN OUT PVOID Context</span>
01899 <span class="comment">                );</span>
01900 <span class="comment"></span>
01901 <span class="comment">        where SubKeyHandle is the handle to an enumerated subkey under the</span>
01902 <span class="comment">        specified key, SubKeyName is its name, and Context is a pointer to</span>
01903 <span class="comment">        user-defined data.</span>
01904 <span class="comment"></span>
01905 <span class="comment">        This function should return TRUE to continue enumeration, or</span>
01906 <span class="comment">        FALSE to terminate it.</span>
01907 <span class="comment"></span>
01908 <span class="comment">    Context - Supplies a pointer to user-defined data that will be passed</span>
01909 <span class="comment">        in to the callback routine at each subkey invocation.</span>
01910 <span class="comment"></span>
01911 <span class="comment">Return Value:</span>
01912 <span class="comment"></span>
01913 <span class="comment">    NT status code indicating whether the subkeys were successfully</span>
01914 <span class="comment">    enumerated.  Note that this does not provide information on the</span>
01915 <span class="comment">    success or failure of the callback routine--if desired, this</span>
01916 <span class="comment">    information should be stored in the Context structure.</span>
01917 <span class="comment"></span>
01918 <span class="comment">--*/</span>
01919 
01920 {
01921     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01922     BOOLEAN CloseHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, ContinueEnumeration;
01923     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>, SubKeyHandle;
01924     ULONG i, RequiredBufferLength;
01925     PKEY_BASIC_INFORMATION KeyInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01926     <span class="comment">// Use an initial key name buffer size large enough for a 20-character key</span>
01927     <span class="comment">// (+ terminating NULL)</span>
01928     ULONG KeyInformationLength = <span class="keyword">sizeof</span>(KEY_BASIC_INFORMATION) + (20 * <span class="keyword">sizeof</span>(WCHAR));
01929     UNICODE_STRING SubKeyName;
01930 
01931     <span class="keywordflow">if</span>(ARGUMENT_PRESENT(<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>)) {
01932 
01933         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
01934                                        BaseHandle,
01935                                        <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,
01936                                        KEY_READ
01937                                        );
01938         <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01939             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01940         } <span class="keywordflow">else</span> {
01941             CloseHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01942         }
01943 
01944     } <span class="keywordflow">else</span> {
01945 
01946         <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = BaseHandle;
01947     }
01948 
01949     <span class="comment">//</span>
01950     <span class="comment">// Enumerate the subkeys until we run out of them.</span>
01951     <span class="comment">//</span>
01952     i = 0;
01953     SubKeyHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01954 
01955     <span class="keywordflow">while</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01956 
01957         <span class="keywordflow">if</span>(!KeyInformation) {
01958 
01959             KeyInformation = (PKEY_BASIC_INFORMATION)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01960                                                                     KeyInformationLength
01961                                                                    );
01962             <span class="keywordflow">if</span>(!KeyInformation) {
01963                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
01964                 <span class="keywordflow">break</span>;
01965             }
01966         }
01967 
01968         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwEnumerateKey(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
01969                                 i,
01970                                 KeyBasicInformation,
01971                                 KeyInformation,
01972                                 KeyInformationLength,
01973                                 &amp;RequiredBufferLength
01974                                );
01975 
01976         <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01977             <span class="keywordflow">if</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_OVERFLOW) {
01978                 <span class="comment">//</span>
01979                 <span class="comment">// Try again with larger buffer.</span>
01980                 <span class="comment">//</span>
01981                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyInformation);
01982                 KeyInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01983                 KeyInformationLength = RequiredBufferLength;
01984                 <span class="keywordflow">continue</span>;
01985 
01986             } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NO_MORE_ENTRIES) {
01987                 <span class="comment">//</span>
01988                 <span class="comment">// break out of loop</span>
01989                 <span class="comment">//</span>
01990                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01991                 <span class="keywordflow">break</span>;
01992 
01993             } <span class="keywordflow">else</span> {
01994                 <span class="comment">//</span>
01995                 <span class="comment">// This is a non-critical error.</span>
01996                 <span class="comment">//</span>
01997                 <span class="keywordflow">if</span>(Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a90">FUNCTIONSUBKEY_FLAG_IGNORE_NON_CRITICAL_ERRORS</a>) {
01998                     <span class="keywordflow">goto</span> ContinueWithNextSubKey;
01999                 } <span class="keywordflow">else</span> {
02000                     <span class="keywordflow">break</span>;
02001                 }
02002             }
02003         }
02004 
02005         <span class="comment">//</span>
02006         <span class="comment">// Initialize a unicode string with this key name.  Note that this string</span>
02007         <span class="comment">// WILL NOT be NULL-terminated.</span>
02008         <span class="comment">//</span>
02009         SubKeyName.Length = SubKeyName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)KeyInformation-&gt;NameLength;
02010         SubKeyName.Buffer = KeyInformation-&gt;Name;
02011 
02012         <span class="comment">//</span>
02013         <span class="comment">// If DesiredAccess is non-zero, open a handle to this subkey.</span>
02014         <span class="comment">//</span>
02015         <span class="keywordflow">if</span>(DesiredAccess) {
02016             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;SubKeyHandle,
02017                                            <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
02018                                            &amp;SubKeyName,
02019                                            DesiredAccess
02020                                            );
02021             <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02022                 <span class="comment">//</span>
02023                 <span class="comment">// This is a non-critical error.</span>
02024                 <span class="comment">//</span>
02025                 <span class="keywordflow">if</span>(Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a90">FUNCTIONSUBKEY_FLAG_IGNORE_NON_CRITICAL_ERRORS</a>) {
02026                     <span class="keywordflow">goto</span> ContinueWithNextSubKey;
02027                 } <span class="keywordflow">else</span> {
02028                     <span class="keywordflow">break</span>;
02029                 }
02030             }
02031         }
02032 
02033         <span class="comment">//</span>
02034         <span class="comment">// Invoke the supplied callback function for this subkey.</span>
02035         <span class="comment">//</span>
02036         ContinueEnumeration = SubKeyCallbackRoutine(SubKeyHandle, &amp;SubKeyName, Context);
02037 
02038         <span class="keywordflow">if</span> (DesiredAccess) {
02039             <span class="keywordflow">if</span> (ContinueEnumeration &amp;&amp;
02040                 (Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a91">FUNCTIONSUBKEY_FLAG_DELETE_SUBKEYS</a>)) {
02041                 <span class="comment">//</span>
02042                 <span class="comment">// Delete the key when asked to, only if the callback routine</span>
02043                 <span class="comment">// was successful, otherwise we may not be able to.</span>
02044                 <span class="comment">//</span>
02045                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwDeleteKey(SubKeyHandle);
02046             }
02047             ZwClose(SubKeyHandle);
02048         }
02049 
02050         <span class="keywordflow">if</span>(!ContinueEnumeration) {
02051             <span class="comment">//</span>
02052             <span class="comment">// Enumeration has been aborted.</span>
02053             <span class="comment">//</span>
02054             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02055             <span class="keywordflow">break</span>;
02056 
02057         }
02058 
02059 ContinueWithNextSubKey:
02060         <span class="keywordflow">if</span> (!(Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a91">FUNCTIONSUBKEY_FLAG_DELETE_SUBKEYS</a>)) {
02061             <span class="comment">//</span>
02062             <span class="comment">// Only increment the enumeration index for non-deleted subkeys</span>
02063             <span class="comment">//</span>
02064             i++;
02065         }
02066     }
02067 
02068     <span class="keywordflow">if</span>(KeyInformation) {
02069         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyInformation);
02070     }
02071 
02072     <span class="keywordflow">if</span>(CloseHandle) {
02073         ZwClose(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
02074     }
02075 
02076     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02077 }
02078 
02079 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02080"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a15">02080</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a13">IopRegMultiSzToUnicodeStrings</a>(
02081     IN  PKEY_VALUE_FULL_INFORMATION KeyValueInformation,
02082     OUT PUNICODE_STRING *UnicodeStringList,
02083     OUT PULONG UnicodeStringCount
02084     )
02085 
02086 <span class="comment">/*++</span>
02087 <span class="comment"></span>
02088 <span class="comment">Routine Description:</span>
02089 <span class="comment"></span>
02090 <span class="comment">    This routine takes a KEY_VALUE_FULL_INFORMATION structure containing</span>
02091 <span class="comment">    a REG_MULTI_SZ value, and allocates an array of UNICODE_STRINGs,</span>
02092 <span class="comment">    initializing each one to a copy of one of the strings in the value entry.</span>
02093 <span class="comment">    All the resulting UNICODE_STRINGs will be NULL terminated</span>
02094 <span class="comment">    (MaximumLength = Length + sizeof(UNICODE_NULL)).</span>
02095 <span class="comment"></span>
02096 <span class="comment">    It is the responsibility of the caller to free the buffers for each</span>
02097 <span class="comment">    unicode string, as well as the buffer containing the UNICODE_STRING</span>
02098 <span class="comment">    array. This may be done by calling IopFreeUnicodeStringList.</span>
02099 <span class="comment"></span>
02100 <span class="comment">Arguments:</span>
02101 <span class="comment"></span>
02102 <span class="comment">    KeyValueInformation - Supplies the buffer containing the REG_MULTI_SZ</span>
02103 <span class="comment">        value entry data.</span>
02104 <span class="comment"></span>
02105 <span class="comment">    UnicodeStringList - Receives a pointer to an array of UNICODE_STRINGs, each</span>
02106 <span class="comment">        initialized with a copy of one of the strings in the REG_MULTI_SZ.</span>
02107 <span class="comment"></span>
02108 <span class="comment">    UnicodeStringCount - Receives the number of strings in the</span>
02109 <span class="comment">        UnicodeStringList.</span>
02110 <span class="comment"></span>
02111 <span class="comment">Returns:</span>
02112 <span class="comment"></span>
02113 <span class="comment">    NT status code indicating whether the function was successful.</span>
02114 <span class="comment"></span>
02115 <span class="comment">--*/</span>
02116 
02117 {
02118     PWCHAR p, BufferEnd, StringStart;
02119     ULONG StringCount, i, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>;
02120 
02121     <span class="comment">//</span>
02122     <span class="comment">// First, make sure this is really a REG_MULTI_SZ value.</span>
02123     <span class="comment">//</span>
02124     <span class="keywordflow">if</span>(KeyValueInformation-&gt;Type != REG_MULTI_SZ) {
02125         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
02126     }
02127 
02128     <span class="comment">//</span>
02129     <span class="comment">// Make a preliminary pass through the buffer to count the number of strings</span>
02130     <span class="comment">// There will always be at least one string returned (possibly empty).</span>
02131     <span class="comment">//</span>
02132     StringCount = 0;
02133     p = (PWCHAR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(KeyValueInformation);
02134     BufferEnd = (PWCHAR)((PUCHAR)p + KeyValueInformation-&gt;DataLength);
02135     <span class="keywordflow">while</span>(p != BufferEnd) {
02136         <span class="keywordflow">if</span>(!*p) {
02137             StringCount++;
02138             <span class="keywordflow">if</span>(((p + 1) == BufferEnd) || !*(p + 1)) {
02139                 <span class="keywordflow">break</span>;
02140             }
02141         }
02142         p++;
02143     }
02144     <span class="keywordflow">if</span>(p == BufferEnd) {
02145         StringCount++;
02146     }
02147 
02148     *UnicodeStringList = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>(UNICODE_STRING) * StringCount);
02149     <span class="keywordflow">if</span>(!(*UnicodeStringList)) {
02150         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02151     }
02152 
02153     <span class="comment">//</span>
02154     <span class="comment">// Now, make a second pass through the buffer making copies of each string.</span>
02155     <span class="comment">//</span>
02156     i = 0;
02157     StringStart = p = (PWCHAR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(KeyValueInformation);
02158     <span class="keywordflow">while</span>(p != BufferEnd) {
02159         <span class="keywordflow">if</span>(!*p) {
02160             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a> = (ULONG)((PUCHAR)p - (PUCHAR)StringStart) + <span class="keyword">sizeof</span>(UNICODE_NULL);
02161             (*UnicodeStringList)[i].Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>);
02162 
02163             <span class="keywordflow">if</span>(!((*UnicodeStringList)[i].Buffer)) {
02164                 <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a17">IopFreeUnicodeStringList</a>(*UnicodeStringList, i);
02165                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02166             }
02167 
02168             RtlMoveMemory((*UnicodeStringList)[i].<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, StringStart, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>);
02169 
02170             (*UnicodeStringList)[i].Length =
02171                 ((*UnicodeStringList)[i].MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>)
02172                 - <span class="keyword">sizeof</span>(UNICODE_NULL);
02173 
02174             i++;
02175 
02176             <span class="keywordflow">if</span>(((p + 1) == BufferEnd) || !*(p + 1)) {
02177                 <span class="keywordflow">break</span>;
02178             } <span class="keywordflow">else</span> {
02179                 StringStart = p + 1;
02180             }
02181         }
02182         p++;
02183     }
02184     <span class="keywordflow">if</span>(p == BufferEnd) {
02185         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a> = (ULONG)((PUCHAR)p - (PUCHAR)StringStart);
02186         (*UnicodeStringList)[i].Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
02187                                                         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a> + <span class="keyword">sizeof</span>(UNICODE_NULL)
02188                                                        );
02189         <span class="keywordflow">if</span>(!((*UnicodeStringList)[i].Buffer)) {
02190             <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a17">IopFreeUnicodeStringList</a>(*UnicodeStringList, i);
02191             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02192         }
02193         <span class="keywordflow">if</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>) {
02194             RtlMoveMemory((*UnicodeStringList)[i].<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, StringStart, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>);
02195         }
02196         (*UnicodeStringList)[i].Buffer[CB_TO_CWC(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>)] = UNICODE_NULL;
02197 
02198         (*UnicodeStringList)[i].MaximumLength =
02199                 ((*UnicodeStringList)[i].Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>)
02200                 + <span class="keyword">sizeof</span>(UNICODE_NULL);
02201     }
02202 
02203     *UnicodeStringCount = StringCount;
02204 
02205     <span class="keywordflow">return</span> STATUS_SUCCESS;
02206 }
02207 
02208 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02209"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a16">02209</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a14">IopApplyFunctionToServiceInstances</a>(
02210     IN     HANDLE ServiceKeyHandle OPTIONAL,
02211     IN     PUNICODE_STRING ServiceKeyName OPTIONAL,
02212     IN     ACCESS_MASK DesiredAccess,
02213     IN     BOOLEAN IgnoreNonCriticalErrors,
02214     IN     PIOP_SUBKEY_CALLBACK_ROUTINE DevInstCallbackRoutine,
02215     IN OUT PVOID Context,
02216     OUT    PULONG ServiceInstanceOrdinal OPTIONAL
02217     )
02218 
02219 <span class="comment">/*++</span>
02220 <span class="comment"></span>
02221 <span class="comment">Routine Description:</span>
02222 <span class="comment"></span>
02223 <span class="comment">    This routine enumerates all device instances referenced by the instance</span>
02224 <span class="comment">    ordinal entries under a service's volatile Enum key, and calls</span>
02225 <span class="comment">    the specified callback routine for each instance's corresponding subkey</span>
02226 <span class="comment">    under HKLM\System\Enum.</span>
02227 <span class="comment"></span>
02228 <span class="comment">Arguments:</span>
02229 <span class="comment"></span>
02230 <span class="comment">    ServiceKeyHandle - Optional handle to the service entry. If this parameter</span>
02231 <span class="comment">        is not specified, then the service key name must be given in</span>
02232 <span class="comment">        ServiceKeyName (if both parameters are specified, then ServiceKeyHandle</span>
02233 <span class="comment">        is used, and ServiceKeyName is ignored).</span>
02234 <span class="comment"></span>
02235 <span class="comment">    ServiceKeyName - Optional name of the service entry key (under</span>
02236 <span class="comment">        HKLM\CurrentControlSet\Services). If this parameter is not specified,</span>
02237 <span class="comment">        then ServiceKeyHandle must contain a handle to the desired service key.</span>
02238 <span class="comment"></span>
02239 <span class="comment">    DesiredAccess - Specifies the desired access that the callback routine</span>
02240 <span class="comment">        needs to the enumerated device instance keys.  If no desired access is</span>
02241 <span class="comment">        specified (i.e., DesiredAccess is zero), then no handle will be opened</span>
02242 <span class="comment">        for the device instance keys, and the callback will be passed a NULL for</span>
02243 <span class="comment">        its DeviceInstanceHandle parameter.</span>
02244 <span class="comment"></span>
02245 <span class="comment">    IgnoreNonCriticalErrors - Specifies whether this function should</span>
02246 <span class="comment">        immediately terminate on all errors, or only on critical ones.</span>
02247 <span class="comment">        An example of a non-critical error is when an enumerated device instance</span>
02248 <span class="comment">        key cannot be opened for the desired access.</span>
02249 <span class="comment"></span>
02250 <span class="comment">    DevInstCallbackRoutine - Supplies a pointer to a function that will</span>
02251 <span class="comment">        be called for each device instance key referenced by a service instance</span>
02252 <span class="comment">        entry under the service's volatile Enum subkey. The prototype of the</span>
02253 <span class="comment">        function is as follows:</span>
02254 <span class="comment"></span>
02255 <span class="comment">            typedef BOOLEAN (*PIOP_SUBKEY_CALLBACK_ROUTINE) (</span>
02256 <span class="comment">                IN     HANDLE DeviceInstanceHandle,</span>
02257 <span class="comment">                IN     PUNICODE_STRING DeviceInstancePath,</span>
02258 <span class="comment">                IN OUT PVOID Context</span>
02259 <span class="comment">                );</span>
02260 <span class="comment"></span>
02261 <span class="comment">        where DeviceInstanceHandle is the handle to an enumerated device instance</span>
02262 <span class="comment">        key, DeviceInstancePath is the registry path (relative to</span>
02263 <span class="comment">        HKLM\System\Enum) to this device instance, and Context is a pointer to</span>
02264 <span class="comment">        user-defined data.</span>
02265 <span class="comment"></span>
02266 <span class="comment">        This function should return TRUE to continue enumeration, or</span>
02267 <span class="comment">        FALSE to terminate it.</span>
02268 <span class="comment"></span>
02269 <span class="comment">    Context - Supplies a pointer to user-defined data that will be passed</span>
02270 <span class="comment">        in to the callback routine at each device instance key invocation.</span>
02271 <span class="comment"></span>
02272 <span class="comment">    ServiceInstanceOrdinal - Optionally, receives the service instance ordinal (1 based)</span>
02273 <span class="comment">        that terminated the enumeration, or the total number of instances enumerated</span>
02274 <span class="comment">        if the enumeration completed without being aborted.</span>
02275 <span class="comment"></span>
02276 <span class="comment">Return Value:</span>
02277 <span class="comment"></span>
02278 <span class="comment">    NT status code indicating whether the device instance keys were successfully</span>
02279 <span class="comment">    enumerated.  Note that this does not provide information on the success or</span>
02280 <span class="comment">    failure of the callback routine--if desired, this information should be</span>
02281 <span class="comment">    stored in the Context structure.</span>
02282 <span class="comment"></span>
02283 <span class="comment">--*/</span>
02284 
02285 {
02286     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02287     HANDLE ServiceEnumHandle, SystemEnumHandle, DeviceInstanceHandle;
02288     UNICODE_STRING TempUnicodeString;
02289     ULONG ServiceInstanceCount, i, junk;
02290     PKEY_VALUE_FULL_INFORMATION KeyValueInformation;
02291     WCHAR ValueNameString[20];
02292     BOOLEAN ContinueEnumeration;
02293 
02294     <span class="comment">//</span>
02295     <span class="comment">// First, open up the volatile Enum subkey under the specified service entry.</span>
02296     <span class="comment">//</span>
02297 
02298     <span class="keywordflow">if</span>(ARGUMENT_PRESENT(ServiceKeyHandle)) {
02299         PiWstrToUnicodeString(&amp;TempUnicodeString, REGSTR_KEY_ENUM);
02300         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;ServiceEnumHandle,
02301                                        ServiceKeyHandle,
02302                                        &amp;TempUnicodeString,
02303                                        KEY_READ
02304                                        );
02305     } <span class="keywordflow">else</span> {
02306         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a>(ServiceKeyName,
02307                                         KEY_READ,
02308                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02309                                         &amp;ServiceEnumHandle,
02310                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
02311                                        );
02312     }
02313     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02314         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02315     }
02316 
02317     <span class="comment">//</span>
02318     <span class="comment">// Find out how many instances are referenced in the service's Enum key.</span>
02319     <span class="comment">//</span>
02320 
02321     ServiceInstanceCount = 0;   <span class="comment">// assume none.</span>
02322 
02323     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(ServiceEnumHandle,
02324                                  REGSTR_VALUE_COUNT,
02325                                  &amp;KeyValueInformation
02326                                 );
02327     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02328 
02329         <span class="keywordflow">if</span>((KeyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
02330            (KeyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
02331 
02332             ServiceInstanceCount = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(KeyValueInformation);
02333 
02334         }
02335         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyValueInformation);
02336 
02337     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_OBJECT_NAME_NOT_FOUND) {
02338         <span class="keywordflow">goto</span> PrepareForReturn;
02339     } <span class="keywordflow">else</span> {
02340         <span class="comment">//</span>
02341         <span class="comment">// If 'Count' value entry not found, consider this to mean there are simply</span>
02342         <span class="comment">// no device instance controlled by this service.</span>
02343         <span class="comment">//</span>
02344         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02345     }
02346 
02347     <span class="comment">//</span>
02348     <span class="comment">// Now, enumerate each service instance, and call the specified callback function</span>
02349     <span class="comment">// for the corresponding device instance.</span>
02350     <span class="comment">//</span>
02351 
02352     <span class="keywordflow">if</span> (ServiceInstanceCount) {
02353 
02354         <span class="keywordflow">if</span> (DesiredAccess) {
02355             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;SystemEnumHandle,
02356                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02357                                            &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a23">CmRegistryMachineSystemCurrentControlSetEnumName</a>,
02358                                            KEY_READ
02359                                            );
02360             <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02361                 <span class="keywordflow">goto</span> PrepareForReturn;
02362             }
02363         } <span class="keywordflow">else</span> {
02364             <span class="comment">//</span>
02365             <span class="comment">// Set DeviceInstanceHandle to NULL, since we won't be opening up the</span>
02366             <span class="comment">// device instance keys.</span>
02367             <span class="comment">//</span>
02368             DeviceInstanceHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02369         }
02370         KeyValueInformation = (PKEY_VALUE_FULL_INFORMATION)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
02371                                                               <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
02372                                                               <a class="code" href="../../d9/d0/pnpiop_8h.html#a86">PNP_SCRATCH_BUFFER_SIZE</a>);
02373         <span class="keywordflow">if</span> (!KeyValueInformation) {
02374             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
02375             <span class="keywordflow">goto</span> PrepareForReturn;
02376         }
02377         i = 0;
02378         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02379             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwEnumerateValueKey (           <span class="comment">// i was initialized to zero above.</span>
02380                             ServiceEnumHandle,
02381                             i++,
02382                             KeyValueFullInformation,
02383                             KeyValueInformation,
02384                             <a class="code" href="../../d9/d0/pnpiop_8h.html#a86">PNP_SCRATCH_BUFFER_SIZE</a>,
02385                             &amp;junk
02386                             );
02387 
02388             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02389                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NO_MORE_ENTRIES) {
02390                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02391                     <span class="keywordflow">break</span>;
02392                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(IgnoreNonCriticalErrors) {
02393                     <span class="keywordflow">continue</span>;
02394                 } <span class="keywordflow">else</span> {
02395                     <span class="keywordflow">break</span>;
02396                 }
02397             }
02398 
02399             <span class="keywordflow">if</span> (KeyValueInformation-&gt;Type != REG_SZ) {
02400                 <span class="keywordflow">continue</span>;
02401             }
02402 
02403             ContinueEnumeration = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02404             TempUnicodeString.Length = 0;
02405             <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(&amp;TempUnicodeString,
02406                                            (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(KeyValueInformation),
02407                                            KeyValueInformation-&gt;DataLength
02408                                            );
02409             <span class="keywordflow">if</span> (TempUnicodeString.Length) {
02410 
02411                 <span class="comment">//</span>
02412                 <span class="comment">// We have retrieved a (non-empty) string for this service instance.</span>
02413                 <span class="comment">// If the user specified a non-zero value for the DesiredAccess</span>
02414                 <span class="comment">// parameter, we will attempt to open up the corresponding device</span>
02415                 <span class="comment">// instance key under HKLM\System\Enum.</span>
02416                 <span class="comment">//</span>
02417                 <span class="keywordflow">if</span> (DesiredAccess) {
02418                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;DeviceInstanceHandle,
02419                                                    SystemEnumHandle,
02420                                                    &amp;TempUnicodeString,
02421                                                    DesiredAccess
02422                                                    );
02423                 }
02424 
02425                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02426                     <span class="comment">//</span>
02427                     <span class="comment">// Invoke the specified callback routine for this device instance.</span>
02428                     <span class="comment">//</span>
02429                     ContinueEnumeration = DevInstCallbackRoutine(DeviceInstanceHandle,
02430                                                                  &amp;TempUnicodeString,
02431                                                                  Context
02432                                                                 );
02433                     <span class="keywordflow">if</span> (DesiredAccess) {
02434                         ZwClose(DeviceInstanceHandle);
02435                     }
02436                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IgnoreNonCriticalErrors) {
02437                     <span class="keywordflow">continue</span>;
02438                 } <span class="keywordflow">else</span> {
02439                     <span class="keywordflow">break</span>;
02440                 }
02441             } <span class="keywordflow">else</span> {
02442                 <span class="keywordflow">continue</span>;
02443             }
02444             <span class="keywordflow">if</span> (!ContinueEnumeration) {
02445                 <span class="keywordflow">break</span>;
02446             }
02447         }
02448 
02449         <span class="keywordflow">if</span>(DesiredAccess) {
02450             ZwClose(SystemEnumHandle);
02451         }
02452         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyValueInformation);
02453     }
02454 
02455     <span class="keywordflow">if</span>(ARGUMENT_PRESENT(ServiceInstanceOrdinal)) {
02456         *ServiceInstanceOrdinal = i;
02457     }
02458 
02459 PrepareForReturn:
02460 
02461     ZwClose(ServiceEnumHandle);
02462 
02463     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02464 }
02465 
02466 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02467"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a17">02467</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a15">IopMarkDuplicateDevice</a> (
02468     IN PUNICODE_STRING TargetKeyName,
02469     IN ULONG TargetInstance,
02470     IN PUNICODE_STRING SourceKeyName,
02471     IN ULONG SourceInstance
02472     )
02473 
02474 <span class="comment">/*++</span>
02475 <span class="comment"></span>
02476 <span class="comment">Routine Description:</span>
02477 <span class="comment"></span>
02478 <span class="comment">    This routine marks the device instance specified by TargetKeyName and TargetInstance</span>
02479 <span class="comment">    as DuplicateOf the device specified by SourceKeyName and SourceInstance.</span>
02480 <span class="comment"></span>
02481 <span class="comment">Arguments:</span>
02482 <span class="comment"></span>
02483 <span class="comment">    TargetKeyName - supplies a pointer to the name of service key which will be marked</span>
02484 <span class="comment">        as duplicate.</span>
02485 <span class="comment"></span>
02486 <span class="comment">    TargetInstance - the instance number of the target device.</span>
02487 <span class="comment"></span>
02488 <span class="comment">    SourceKeyName - supplies a pointer to the name of service key.</span>
02489 <span class="comment"></span>
02490 <span class="comment">    SourceInstance - the instance number of the source device.</span>
02491 <span class="comment"></span>
02492 <span class="comment"></span>
02493 <span class="comment">Returns:</span>
02494 <span class="comment"></span>
02495 <span class="comment">    NTSTATUS code.</span>
02496 <span class="comment"></span>
02497 <span class="comment">--*/</span>
02498 
02499 {
02500     HANDLE handle;
02501     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02502     UNICODE_STRING sourceDeviceString, unicodeValueName;
02503 
02504     <span class="comment">//</span>
02505     <span class="comment">// Open the handle of the target device instance.</span>
02506     <span class="comment">//</span>
02507 
02508     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a6">IopServiceInstanceToDeviceInstance</a>(
02509                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02510                        TargetKeyName,
02511                        TargetInstance,
02512                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02513                        &amp;handle,
02514                        0
02515                        );
02516     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02517         <span class="keywordflow">return</span> status;
02518     }
02519 
02520     <span class="comment">//</span>
02521     <span class="comment">// Get the name of the source device instance</span>
02522     <span class="comment">//</span>
02523 
02524     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a6">IopServiceInstanceToDeviceInstance</a>(
02525                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02526                        SourceKeyName,
02527                        SourceInstance,
02528                        &amp;sourceDeviceString,
02529                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02530                        0
02531                        );
02532     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02533         <span class="keywordflow">return</span> status;
02534     }
02535 
02536     <span class="comment">//</span>
02537     <span class="comment">// Write the name of the source device to the DuplicateOf value entry of</span>
02538     <span class="comment">// target device key.</span>
02539     <span class="comment">//</span>
02540 
02541     PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_DUPLICATEOF);
02542     status = ZwSetValueKey(
02543                 handle,
02544                 &amp;unicodeValueName,
02545                 <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
02546                 REG_SZ,
02547                 &amp;sourceDeviceString,
02548                 sourceDeviceString.Length + <span class="keyword">sizeof</span>(WCHAR)
02549                 );
02550     <span class="keywordflow">return</span> status;
02551 }
02552 
02553 BOOLEAN
<a name="l02554"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a18">02554</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a16">IopIsDuplicatedDevices</a>(
02555     IN PCM_RESOURCE_LIST Configuration1,
02556     IN PCM_RESOURCE_LIST Configuration2,
02557     IN <a class="code" href="../../d6/d2/struct__HAL__BUS__INFORMATION.html">PHAL_BUS_INFORMATION</a> BusInfo1 OPTIONAL,
02558     IN <a class="code" href="../../d6/d2/struct__HAL__BUS__INFORMATION.html">PHAL_BUS_INFORMATION</a> BusInfo2 OPTIONAL
02559     )
02560 
02561 <span class="comment">/*++</span>
02562 <span class="comment"></span>
02563 <span class="comment">Routine Description:</span>
02564 <span class="comment"></span>
02565 <span class="comment">    This routine compares two set of configurations and bus information to</span>
02566 <span class="comment">    determine if the resources indicate the same device.  If BusInfo1 and</span>
02567 <span class="comment">    BusInfo2 both are absent, it means caller wants to compare the raw</span>
02568 <span class="comment">    resources.</span>
02569 <span class="comment"></span>
02570 <span class="comment">Arguments:</span>
02571 <span class="comment"></span>
02572 <span class="comment">    Configuration1 - Supplies a pointer to the first set of resource.</span>
02573 <span class="comment"></span>
02574 <span class="comment">    Configuration2 - Supplies a pointer to the second set of resource.</span>
02575 <span class="comment"></span>
02576 <span class="comment">    BusInfo1 - Supplies a pointer to the first set of bus information.</span>
02577 <span class="comment"></span>
02578 <span class="comment">    BusInfo2 - Supplies a pointer to the second set of bus information.</span>
02579 <span class="comment"></span>
02580 <span class="comment">Return Value:</span>
02581 <span class="comment"></span>
02582 <span class="comment">    returns TRUE if the two set of resources indicate the same device;</span>
02583 <span class="comment">    otherwise a value of FALSE is returned.</span>
02584 <span class="comment"></span>
02585 <span class="comment">--*/</span>
02586 
02587 {
02588     PCM_PARTIAL_RESOURCE_LIST list1, list2;
02589     PCM_PARTIAL_RESOURCE_DESCRIPTOR descriptor1, descriptor2;
02590 
02591     ULONG i, j;
02592     ULONG pass = 0;
02593 
02594     <span class="comment">//</span>
02595     <span class="comment">// The BusInfo for both resources must be both present or not present.</span>
02596     <span class="comment">//</span>
02597 
02598     <span class="keywordflow">if</span> ((ARGUMENT_PRESENT(BusInfo1) &amp;&amp; !ARGUMENT_PRESENT(BusInfo2)) ||
02599         (!ARGUMENT_PRESENT(BusInfo1) &amp;&amp; ARGUMENT_PRESENT(BusInfo2))) {
02600 
02601         <span class="comment">//</span>
02602         <span class="comment">// Unable to determine.</span>
02603         <span class="comment">//</span>
02604 
02605         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02606     }
02607 
02608     <span class="comment">//</span>
02609     <span class="comment">// Next check resources used by the two devices.</span>
02610     <span class="comment">// Currently, we *only* check the Io ports.</span>
02611     <span class="comment">//</span>
02612 
02613     <span class="keywordflow">if</span> (Configuration1-&gt;Count == 0 || Configuration2-&gt;Count == 0) {
02614 
02615         <span class="comment">//</span>
02616         <span class="comment">// If any one of the configuration data is empty, we assume</span>
02617         <span class="comment">// the devices are not duplicates.</span>
02618         <span class="comment">//</span>
02619 
02620         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02621     }
02622 
02623 RedoScan:
02624 
02625     list1 = &amp;(Configuration1-&gt;List[0].PartialResourceList);
02626     list2 = &amp;(Configuration2-&gt;List[0].PartialResourceList);
02627 
02628     <span class="keywordflow">for</span>(i = 0, descriptor1 = list1-&gt;PartialDescriptors;
02629         i &lt; list1-&gt;Count;
02630         i++, descriptor1++) {
02631 
02632         <span class="comment">//</span>
02633         <span class="comment">// If this is an i/o port or a memory range then look for a match</span>
02634         <span class="comment">// in the other list.</span>
02635         <span class="comment">//</span>
02636 
02637         <span class="keywordflow">if</span>((descriptor1-&gt;Type == CmResourceTypePort) ||
02638            (descriptor1-&gt;Type == CmResourceTypeMemory)) {
02639 
02640             <span class="keywordflow">for</span>(j = 0, descriptor2 = list2-&gt;PartialDescriptors;
02641                 j &lt; list2-&gt;Count;
02642                 j++, descriptor2++) {
02643 
02644                 <span class="comment">//</span>
02645                 <span class="comment">// If the types match then check to see if both addresses</span>
02646                 <span class="comment">// match as well.  If bus info was provided then go ahead</span>
02647                 <span class="comment">// and translate the ranges first.</span>
02648                 <span class="comment">//</span>
02649 
02650                 <span class="keywordflow">if</span>(descriptor1-&gt;Type == descriptor2-&gt;Type) {
02651 
02652                     PHYSICAL_ADDRESS range1, range1Translated;
02653                     PHYSICAL_ADDRESS range2, range2Translated;
02654                     ULONG range1IoSpace, range2IoSpace;
02655 
02656                     range1 = descriptor1-&gt;u.Generic.Start;
02657                     range2 = descriptor2-&gt;u.Generic.Start;
02658 
02659                     <span class="keywordflow">if</span>((range1.QuadPart == 0) ||
02660                        (BusInfo1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
02661                        (<a class="code" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress</a>(
02662                             BusInfo1-&gt;BusType,
02663                             BusInfo1-&gt;BusNumber,
02664                             range1,
02665                             &amp;range1IoSpace,
02666                             &amp;range1Translated) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
02667 
02668                         range1Translated = range1;
02669                         range1IoSpace =
02670                             (descriptor1-&gt;Type == CmResourceTypePort) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> :
02671                                                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02672                     }
02673 
02674                     <span class="keywordflow">if</span>((range2.QuadPart == 0) ||
02675                        (BusInfo2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
02676                        (<a class="code" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress</a>(
02677                             BusInfo2-&gt;BusType,
02678                             BusInfo2-&gt;BusNumber,
02679                             range2,
02680                             &amp;range2IoSpace,
02681                             &amp;range2Translated) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
02682 
02683                         range2Translated = range2;
02684                         range2IoSpace =
02685                             (descriptor2-&gt;Type == CmResourceTypePort) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> :
02686                                                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02687                     }
02688 
02689                     <span class="comment">//</span>
02690                     <span class="comment">// If the ranges are in the same space and start at the</span>
02691                     <span class="comment">// same location then break out and go on to the next</span>
02692                     <span class="comment">// range</span>
02693                     <span class="comment">//</span>
02694 
02695                     <span class="keywordflow">if</span>((range1Translated.QuadPart == range2Translated.QuadPart) &amp;&amp;
02696                        (range1IoSpace == range2IoSpace)) {
02697 
02698                         <span class="keywordflow">break</span>;
02699                     }
02700                 }
02701             }
02702 
02703             <span class="comment">//</span>
02704             <span class="comment">// If we made it all the way through the resource list without</span>
02705             <span class="comment">// finding a match then these are not duplicates.</span>
02706             <span class="comment">//</span>
02707 
02708             <span class="keywordflow">if</span>(j == list2-&gt;Count) {
02709                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02710             }
02711         }
02712     }
02713 
02714     <span class="comment">//</span>
02715     <span class="comment">// If every resource in list 1 exists in list 2 then we also need to make</span>
02716     <span class="comment">// sure that every resource in list 2 exists in list 1.</span>
02717     <span class="comment">//</span>
02718 
02719     <span class="keywordflow">if</span>(pass == 0) {
02720 
02721         PVOID tmp ;
02722 
02723         tmp = Configuration2;
02724         Configuration2 = Configuration1;
02725         Configuration1 = tmp;
02726 
02727         tmp = BusInfo2;
02728         BusInfo2 = BusInfo1;
02729         BusInfo1 = tmp;
02730 
02731         pass = 1;
02732 
02733         <span class="keywordflow">goto</span> RedoScan;
02734     }
02735 
02736     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02737 }
02738 
02739 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02740"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a19">02740</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a17">IopFreeUnicodeStringList</a>(
02741     IN PUNICODE_STRING UnicodeStringList,
02742     IN ULONG StringCount
02743     )
02744 
02745 <span class="comment">/*++</span>
02746 <span class="comment"></span>
02747 <span class="comment">Routine Description:</span>
02748 <span class="comment"></span>
02749 <span class="comment">    This routine frees the buffer for each UNICODE_STRING in the specified list</span>
02750 <span class="comment">    (there are StringCount of them), and then frees the memory used for the</span>
02751 <span class="comment">    string list itself.</span>
02752 <span class="comment"></span>
02753 <span class="comment">Arguments:</span>
02754 <span class="comment"></span>
02755 <span class="comment">    UnicodeStringList - Supplies a pointer to an array of UNICODE_STRINGs.</span>
02756 <span class="comment"></span>
02757 <span class="comment">    StringCount - Supplies the number of strings in the UnicodeStringList array.</span>
02758 <span class="comment"></span>
02759 <span class="comment">Returns:</span>
02760 <span class="comment"></span>
02761 <span class="comment">    None.</span>
02762 <span class="comment"></span>
02763 <span class="comment">--*/</span>
02764 
02765 {
02766     ULONG i;
02767 
02768     <span class="keywordflow">if</span>(UnicodeStringList) {
02769         <span class="keywordflow">for</span>(i = 0; i &lt; StringCount; i++) {
02770             <span class="keywordflow">if</span>(UnicodeStringList[i].Buffer) {
02771                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(UnicodeStringList[i].<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
02772             }
02773         }
02774         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(UnicodeStringList);
02775     }
02776 }
02777 
02778 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02779"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a20">02779</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a18">IopDriverLoadingFailed</a>(
02780     IN HANDLE ServiceHandle OPTIONAL,
02781     IN PUNICODE_STRING ServiceName OPTIONAL
02782     )
02783 
02784 <span class="comment">/*++</span>
02785 <span class="comment"></span>
02786 <span class="comment">Routine Description:</span>
02787 <span class="comment"></span>
02788 <span class="comment">    This routine is invoked when driver failed to start.  All the device</span>
02789 <span class="comment">    instances controlled by this driver/service are marked as failing to</span>
02790 <span class="comment">    start.</span>
02791 <span class="comment"></span>
02792 <span class="comment">Arguments:</span>
02793 <span class="comment"></span>
02794 <span class="comment">    ServiceKeyHandle - Optionally, supplies a handle to the driver service node in the</span>
02795 <span class="comment">        registry that controls this device instance.  If this argument is not specified,</span>
02796 <span class="comment">        then ServiceKeyName is used to specify the service entry.</span>
02797 <span class="comment"></span>
02798 <span class="comment">    ServiceKeyName - Optionally supplies the name of the service entry that controls</span>
02799 <span class="comment">        the device instance. This must be specified if ServiceKeyHandle isn't given.</span>
02800 <span class="comment"></span>
02801 <span class="comment">Returns:</span>
02802 <span class="comment"></span>
02803 <span class="comment">    None.</span>
02804 <span class="comment"></span>
02805 <span class="comment">--*/</span>
02806 
02807 {
02808     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02809     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
02810     BOOLEAN closeHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, deletePdo;
02811     HANDLE handle, serviceEnumHandle, controlHandle;
02812     HANDLE sysEnumHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02813     ULONG deviceFlags, count, newCount, i, j;
02814     UNICODE_STRING unicodeValueName, deviceInstanceName;
02815     WCHAR unicodeBuffer[20];
02816 
02817     <span class="comment">//</span>
02818     <span class="comment">// Open registry ServiceKeyName\Enum branch</span>
02819     <span class="comment">//</span>
02820 
02821     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(ServiceHandle)) {
02822         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a>(ServiceName,
02823                                         KEY_READ,
02824                                         &amp;ServiceHandle,
02825                                         &amp;serviceEnumHandle,
02826                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
02827                                         );
02828         closeHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02829     } <span class="keywordflow">else</span> {
02830         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_KEY_ENUM);
02831         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;serviceEnumHandle,
02832                                        ServiceHandle,
02833                                        &amp;unicodeValueName,
02834                                        KEY_READ
02835                                        );
02836     }
02837     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02838 
02839         <span class="comment">//</span>
02840         <span class="comment">// No Service Enum key? no device instance.  Return FALSE.</span>
02841         <span class="comment">//</span>
02842 
02843         <span class="keywordflow">return</span> status;
02844     }
02845 
02846     <span class="comment">//</span>
02847     <span class="comment">// Set "STARTFAILED" flags.  So, we won't load it again.</span>
02848     <span class="comment">//</span>
02849 
02850     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeValueName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"INITSTARTFAILED"</span>);
02851     deviceFlags = 1;
02852     ZwSetValueKey(
02853                 serviceEnumHandle,
02854                 &amp;unicodeValueName,
02855                 <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
02856                 REG_DWORD,
02857                 &amp;deviceFlags,
02858                 <span class="keyword">sizeof</span>(deviceFlags)
02859                 );
02860 
02861     <span class="comment">//</span>
02862     <span class="comment">// Find out how many device instances listed in the ServiceName's</span>
02863     <span class="comment">// Enum key.</span>
02864     <span class="comment">//</span>
02865 
02866     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> ( serviceEnumHandle,
02867                                    REGSTR_VALUE_COUNT,
02868                                    &amp;keyValueInformation
02869                                    );
02870     count = 0;
02871     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02872         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
02873             (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
02874 
02875             count = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
02876         }
02877         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
02878     }
02879     <span class="keywordflow">if</span> (count == 0) {
02880         ZwClose(serviceEnumHandle);
02881         <span class="keywordflow">if</span> (closeHandle) {
02882             ZwClose(ServiceHandle);
02883         }
02884         <span class="keywordflow">return</span> status;
02885     }
02886 
02887     <span class="comment">//</span>
02888     <span class="comment">// Open HTREE\ROOT\0 key so later we can remove device instance key</span>
02889     <span class="comment">// from its AttachedComponents value name.</span>
02890     <span class="comment">//</span>
02891 
02892     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;sysEnumHandle,
02893                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02894                                    &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a23">CmRegistryMachineSystemCurrentControlSetEnumName</a>,
02895                                    KEY_ALL_ACCESS
02896                                    );
02897 
02898     <span class="comment">//</span>
02899     <span class="comment">// Walk through each registered device instance to mark its Problem and</span>
02900     <span class="comment">// StatusFlags as fail to start and reset its ActiveService</span>
02901     <span class="comment">//</span>
02902 
02903     newCount = count;
02904     <span class="keywordflow">for</span> (i = 0; i &lt; count; i++) {
02905         deletePdo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02906         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a6">IopServiceInstanceToDeviceInstance</a> (
02907                      ServiceHandle,
02908                      ServiceName,
02909                      i,
02910                      &amp;deviceInstanceName,
02911                      &amp;handle,
02912                      KEY_ALL_ACCESS
02913                      );
02914 
02915         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02916 
02917             <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
02918             <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
02919 
02920             <span class="comment">//</span>
02921             <span class="comment">// If the device instance is a detected device reported during driver's</span>
02922             <span class="comment">// DriverEntry we need to clean it up.</span>
02923             <span class="comment">//</span>
02924 
02925             deviceObject = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a>(handle, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02926             <span class="keywordflow">if</span> (deviceObject) {
02927                 deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
02928                 <span class="keywordflow">if</span> (deviceNode) {
02929 
02930                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a279">IopReleaseDeviceResources</a>(deviceNode, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02931 
02932                     <span class="keywordflow">if</span> ((deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>) &amp;&amp; (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>)) {
02933 
02934                         <span class="comment">//</span>
02935                         <span class="comment">// Now mark this one deleted.</span>
02936                         <span class="comment">//</span>
02937                         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>;
02938 
02939                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_DEVICE_NOT_THERE);
02940                         deletePdo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02941                     }
02942                 }
02943                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceObject);  <span class="comment">// added via IopDeviceObjectFromDeviceInstance</span>
02944             }
02945 
02946             <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
02947             <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02948 
02949             PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_KEY_CONTROL);
02950             controlHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02951             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;controlHandle,
02952                                            handle,
02953                                            &amp;unicodeValueName,
02954                                            KEY_ALL_ACCESS
02955                                            );
02956             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02957 
02958                 status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(controlHandle,
02959                                              REGSTR_VALUE_NEWLY_CREATED,
02960                                              &amp;keyValueInformation);
02961                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02962                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
02963                 }
02964                 <span class="keywordflow">if</span> ((status != STATUS_OBJECT_NAME_NOT_FOUND) &amp;&amp;
02965                     (status != STATUS_OBJECT_PATH_NOT_FOUND)) {
02966 
02967                     <span class="comment">//</span>
02968                     <span class="comment">// Remove the instance value name from service enum key</span>
02969                     <span class="comment">//</span>
02970 
02971                     PiUlongToUnicodeString(&amp;unicodeValueName, unicodeBuffer, 20, i);
02972                     status = ZwDeleteValueKey (serviceEnumHandle, &amp;unicodeValueName);
02973                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02974 
02975                         <span class="comment">//</span>
02976                         <span class="comment">// If we can successfaully remove the instance value entry</span>
02977                         <span class="comment">// from service enum key, we then remove the device instance key</span>
02978                         <span class="comment">// Otherwise, we go thru normal path to mark driver loading failed</span>
02979                         <span class="comment">// in the device instance key.</span>
02980                         <span class="comment">//</span>
02981 
02982                         newCount--;
02983 
02984                         ZwDeleteKey(controlHandle);
02985                         ZwDeleteKey(handle);
02986 
02987 
02988                         <span class="comment">//</span>
02989                         <span class="comment">// We also want to delete the ROOT\LEGACY_&lt;driver&gt; key</span>
02990                         <span class="comment">//</span>
02991 
02992                         <span class="keywordflow">if</span> (sysEnumHandle) {
02993                             deviceInstanceName.Length -= 5 * <span class="keyword">sizeof</span>(WCHAR);
02994                             deviceInstanceName.Buffer[deviceInstanceName.Length / <span class="keyword">sizeof</span>(WCHAR)] =
02995                                                  UNICODE_NULL;
02996                             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
02997                                                            sysEnumHandle,
02998                                                            &amp;deviceInstanceName,
02999                                                            KEY_ALL_ACCESS
03000                                                            );
03001                             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03002                                 ZwDeleteKey(handle);
03003                             }
03004                         }
03005 
03006                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceInstanceName.Buffer);
03007 
03008                         <span class="comment">//</span>
03009                         <span class="comment">// If there is a PDO for this device, remove it</span>
03010                         <span class="comment">//</span>
03011 
03012                         <span class="keywordflow">if</span> (deletePdo) {
03013                             <a class="code" href="../../d4/d6/iosubs_8c.html#a55">IoDeleteDevice</a>(deviceObject);
03014                         }
03015 
03016                         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
03017                         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03018 
03019                         <span class="keywordflow">continue</span>;
03020                     }
03021                 }
03022             }
03023 
03024             <span class="comment">//</span>
03025             <span class="comment">// Reset Control\ActiveService value name.</span>
03026             <span class="comment">//</span>
03027 
03028             <span class="keywordflow">if</span> (controlHandle) {
03029                 PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VAL_ACTIVESERVICE);
03030                 ZwDeleteValueKey(controlHandle, &amp;unicodeValueName);
03031                 ZwClose(controlHandle);
03032             }
03033 
03034             ZwClose(handle);
03035             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceInstanceName.Buffer);
03036 
03037             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
03038             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03039 
03040         }
03041     }
03042 
03043     <span class="comment">//</span>
03044     <span class="comment">// If some instance value entry is deleted, we need to update the count of instance</span>
03045     <span class="comment">// value entries and rearrange the instance value entries under service enum key.</span>
03046     <span class="comment">//</span>
03047 
03048     <span class="keywordflow">if</span> (newCount != count) {
03049 
03050         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
03051         <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03052 
03053         <span class="keywordflow">if</span> (newCount != 0) {
03054             j = 0;
03055             i = 0;
03056             <span class="keywordflow">while</span> (i &lt; count) {
03057                 PiUlongToUnicodeString(&amp;unicodeValueName, unicodeBuffer, 20, i);
03058                 status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(serviceEnumHandle,
03059                                              unicodeValueName.Buffer,
03060                                              &amp;keyValueInformation
03061                                              );
03062                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03063                     <span class="keywordflow">if</span> (i != j) {
03064 
03065                         <span class="comment">//</span>
03066                         <span class="comment">// Need to change the instance i to instance j</span>
03067                         <span class="comment">//</span>
03068 
03069                         ZwDeleteValueKey(serviceEnumHandle, &amp;unicodeValueName);
03070 
03071                         PiUlongToUnicodeString(&amp;unicodeValueName, unicodeBuffer, 20, j);
03072                         ZwSetValueKey (serviceEnumHandle,
03073                                        &amp;unicodeValueName,
03074                                        <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
03075                                        REG_SZ,
03076                                        (PVOID)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
03077                                        keyValueInformation-&gt;DataLength
03078                                        );
03079                     }
03080                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03081                     j++;
03082                 }
03083                 i++;
03084             }
03085         }
03086 
03087         <span class="comment">//</span>
03088         <span class="comment">// Don't forget to update the "Count=" and "NextInstance=" value entries</span>
03089         <span class="comment">//</span>
03090 
03091         PiWstrToUnicodeString( &amp;unicodeValueName, REGSTR_VALUE_COUNT);
03092 
03093         ZwSetValueKey(serviceEnumHandle,
03094                       &amp;unicodeValueName,
03095                       <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
03096                       REG_DWORD,
03097                       &amp;newCount,
03098                       <span class="keyword">sizeof</span> (newCount)
03099                       );
03100         PiWstrToUnicodeString( &amp;unicodeValueName, REGSTR_VALUE_NEXT_INSTANCE);
03101 
03102         ZwSetValueKey(serviceEnumHandle,
03103                       &amp;unicodeValueName,
03104                       <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
03105                       REG_DWORD,
03106                       &amp;newCount,
03107                       <span class="keyword">sizeof</span> (newCount)
03108                       );
03109 
03110         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
03111         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03112     }
03113     ZwClose(serviceEnumHandle);
03114     <span class="keywordflow">if</span> (closeHandle) {
03115         ZwClose(ServiceHandle);
03116     }
03117     <span class="keywordflow">if</span> (sysEnumHandle) {
03118         ZwClose(sysEnumHandle);
03119     }
03120 
03121     <span class="keywordflow">return</span> STATUS_SUCCESS;
03122 }
03123 
03124 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03125"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a0">03125</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a0">IopDisableDevice</a>(
03126     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
03127     IN HANDLE Handle
03128     )
03129 
03130 <span class="comment">/*++</span>
03131 <span class="comment"></span>
03132 <span class="comment">Routine Description:</span>
03133 <span class="comment"></span>
03134 <span class="comment">    This routine tries to ask a bus driver stopping decoding resources</span>
03135 <span class="comment"></span>
03136 <span class="comment">Arguments:</span>
03137 <span class="comment"></span>
03138 <span class="comment">    DeviceNode - Specifies the device to be disabled.</span>
03139 <span class="comment"></span>
03140 <span class="comment">    Handle - specifies the device instance handle.</span>
03141 <span class="comment"></span>
03142 <span class="comment">Returns:</span>
03143 <span class="comment"></span>
03144 <span class="comment">    None.</span>
03145 <span class="comment"></span>
03146 <span class="comment">--*/</span>
03147 
03148 {
03149     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03150 
03151     <span class="comment">//</span>
03152     <span class="comment">// If the device has boot config, we will query-remove and remove the device to free</span>
03153     <span class="comment">// the boot config if possible.</span>
03154     <span class="comment">//</span>
03155 
03156     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a21">IopRemoveDevice</a> (DeviceNode-&gt;PhysicalDeviceObject, <a class="code" href="../../d0/d5/io_8h.html#a66">IRP_MN_QUERY_REMOVE_DEVICE</a>);
03157 
03158     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03159 
03160         status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a21">IopRemoveDevice</a> (DeviceNode-&gt;PhysicalDeviceObject, <a class="code" href="../../d0/d5/io_8h.html#a67">IRP_MN_REMOVE_DEVICE</a>);
03161         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
03162         <a class="code" href="../../d9/d0/pnpiop_8h.html#a279">IopReleaseDeviceResources</a>(DeviceNode, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03163 
03164     } <span class="keywordflow">else</span> {
03165 
03166         <a class="code" href="../../d0/d1/pnpirp_8c.html#a21">IopRemoveDevice</a> (DeviceNode-&gt;PhysicalDeviceObject, <a class="code" href="../../d0/d5/io_8h.html#a68">IRP_MN_CANCEL_REMOVE_DEVICE</a>);
03167     }
03168 
03169     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(DeviceNode)) {
03170         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_NOT_CONFIGURED) ||
03171                <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_FAILED_INSTALL) ||
03172                <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_REINSTALL));
03173 
03174         <a class="code" href="../../d9/d0/pnpiop_8h.html#a79">IopClearDevNodeProblem</a>(DeviceNode);
03175     }
03176 
03177     <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(DeviceNode, CM_PROB_DISABLED);
03178 }
03179 
03180 BOOLEAN
<a name="l03181"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a21">03181</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a19">IopIsAnyDeviceInstanceEnabled</a>(
03182     IN PUNICODE_STRING ServiceKeyName,
03183     IN HANDLE ServiceHandle OPTIONAL,
03184     IN BOOLEAN LegacyIncluded
03185     )
03186 
03187 <span class="comment">/*++</span>
03188 <span class="comment"></span>
03189 <span class="comment">Routine Description:</span>
03190 <span class="comment"></span>
03191 <span class="comment">    This routine checks if any of the devices instances is turned on for the specified</span>
03192 <span class="comment">    service. This routine is used for Pnp Driver only and is temporary function to support</span>
03193 <span class="comment">    SUR.</span>
03194 <span class="comment"></span>
03195 <span class="comment">Arguments:</span>
03196 <span class="comment"></span>
03197 <span class="comment">    ServiceKeyName - Specifies the service key unicode name</span>
03198 <span class="comment"></span>
03199 <span class="comment">    ServiceHandle - Optionally supplies a handle to the service key to be checked.</span>
03200 <span class="comment"></span>
03201 <span class="comment">    LegacyIncluded - TRUE, a legacy device instance key is counted as a device instance.</span>
03202 <span class="comment">                     FALSE, a legacy device instance key is not counted.</span>
03203 <span class="comment"></span>
03204 <span class="comment">Returns:</span>
03205 <span class="comment"></span>
03206 <span class="comment">    A BOOLEAN value.</span>
03207 <span class="comment"></span>
03208 <span class="comment">--*/</span>
03209 
03210 {
03211     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03212     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
03213     HANDLE serviceEnumHandle, handle, controlHandle;
03214     ULONG i, count, deviceFlags;
03215     UNICODE_STRING unicodeName;
03216     BOOLEAN enabled, setProblem, closeHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03217     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> physicalDeviceObject;
03218     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
03219 
03220     <span class="comment">//</span>
03221     <span class="comment">// Open registry ServiceKeyName\Enum branch</span>
03222     <span class="comment">//</span>
03223 
03224     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(ServiceHandle)) {
03225         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a>(ServiceKeyName,
03226                                         KEY_READ,
03227                                         &amp;ServiceHandle,
03228                                         &amp;serviceEnumHandle,
03229                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
03230                                         );
03231         closeHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03232     } <span class="keywordflow">else</span> {
03233         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_ENUM);
03234         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;serviceEnumHandle,
03235                                        ServiceHandle,
03236                                        &amp;unicodeName,
03237                                        KEY_READ
03238                                        );
03239     }
03240     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03241 
03242         <span class="comment">//</span>
03243         <span class="comment">// No Service Enum key? no device instance.  Return FALSE.</span>
03244         <span class="comment">//</span>
03245 
03246         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03247     }
03248 
03249     <span class="comment">//</span>
03250     <span class="comment">// Find out how many device instances listed in the ServiceName's</span>
03251     <span class="comment">// Enum key.</span>
03252     <span class="comment">//</span>
03253 
03254     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> ( serviceEnumHandle,
03255                                    REGSTR_VALUE_COUNT,
03256                                    &amp;keyValueInformation
03257                                    );
03258     ZwClose(serviceEnumHandle);
03259     count = 0;
03260     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03261         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
03262             (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
03263 
03264             count = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03265         }
03266         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03267     }
03268     <span class="keywordflow">if</span> (count == 0) {
03269         <span class="keywordflow">if</span> (closeHandle) {
03270             ZwClose(ServiceHandle);
03271         }
03272         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03273     }
03274 
03275     <span class="comment">//</span>
03276     <span class="comment">// Walk through each registered device instance to check it is enabled.</span>
03277     <span class="comment">//</span>
03278 
03279     enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03280     <span class="keywordflow">for</span> (i = 0; i &lt; count; i++) {
03281 
03282         <span class="comment">//</span>
03283         <span class="comment">// Get device instance handle.  If it fails, we will skip this device</span>
03284         <span class="comment">// instance.</span>
03285         <span class="comment">//</span>
03286 
03287         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a6">IopServiceInstanceToDeviceInstance</a> (
03288                      ServiceHandle,
03289                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03290                      i,
03291                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03292                      &amp;handle,
03293                      KEY_ALL_ACCESS
03294                      );
03295         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03296             <span class="keywordflow">continue</span>;
03297         }
03298 
03299         physicalDeviceObject = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a>(handle, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03300         <span class="keywordflow">if</span> (physicalDeviceObject) {
03301             deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)physicalDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
03302             <span class="keywordflow">if</span> (deviceNode &amp;&amp; (<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(deviceNode, CM_PROB_DISABLED) || <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(deviceNode, CM_PROB_HARDWARE_DISABLED))) {
03303                 ZwClose(handle);
03304                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(physicalDeviceObject);
03305                 <span class="keywordflow">continue</span>;
03306             }
03307         } <span class="keywordflow">else</span> {
03308             deviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03309         }
03310 
03311         <span class="comment">//</span>
03312         <span class="comment">// Check if the device instance has been disabled.</span>
03313         <span class="comment">// First check global flag: CONFIGFLAG and then CSCONFIGFLAG.</span>
03314         <span class="comment">//</span>
03315 
03316         deviceFlags = 0;
03317         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(handle,
03318                                      REGSTR_VALUE_CONFIG_FLAGS,
03319                                      &amp;keyValueInformation);
03320         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03321             <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
03322                 (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
03323 
03324                 deviceFlags = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03325             }
03326             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03327         }
03328 
03329         <span class="keywordflow">if</span> (deviceFlags &amp; CONFIGFLAG_DISABLED) {
03330 
03331             <span class="comment">//</span>
03332             <span class="comment">// Convert this flag into the hardware profile-specific version, so it'll</span>
03333             <span class="comment">// look the same as the CsConfigFlags we retrieve below.</span>
03334             <span class="comment">//</span>
03335 
03336             deviceFlags = CSCONFIGFLAG_DISABLED;
03337 
03338         } <span class="keywordflow">else</span> {
03339 
03340             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a11">IopGetServiceInstanceCsConfigFlags</a>( ServiceKeyName,
03341                                                          i,
03342                                                          &amp;deviceFlags
03343                                                          );
03344 
03345             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03346                 deviceFlags = 0;
03347             }
03348         }
03349 
03350         <span class="comment">//</span>
03351         <span class="comment">// If the device is disabled (either globally, or specifically for this</span>
03352         <span class="comment">// hardware profile), then mark the devnode as DNF_DISABLED.</span>
03353         <span class="comment">//</span>
03354 
03355         <span class="keywordflow">if</span> ((deviceFlags &amp; CSCONFIGFLAG_DISABLED) || (deviceFlags &amp; CSCONFIGFLAG_DO_NOT_START)) {
03356 
03357             <span class="keywordflow">if</span> (deviceNode) {
03358                 <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a0">IopDisableDevice</a>(deviceNode, handle);
03359             }
03360         }
03361 
03362         <span class="keywordflow">if</span> (physicalDeviceObject) {
03363             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(physicalDeviceObject);
03364         }
03365 
03366         <span class="comment">//</span>
03367         <span class="comment">// Finally, we need to set the STATUSFLAGS of the device instance to</span>
03368         <span class="comment">// indicate if the driver is successfully started.</span>
03369         <span class="comment">//</span>
03370 
03371         <span class="keywordflow">if</span> (!(deviceFlags &amp; (CSCONFIGFLAG_DISABLED | CSCONFIGFLAG_DO_NOT_CREATE | CSCONFIGFLAG_DO_NOT_START))) {
03372 
03373             ULONG legacy;
03374 
03375             <span class="comment">//</span>
03376             <span class="comment">// Check should legacy instance key be counted as an enabled device</span>
03377             <span class="comment">//</span>
03378 
03379             <span class="keywordflow">if</span> (LegacyIncluded == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03380 
03381                 <span class="comment">//</span>
03382                 <span class="comment">// The legacy variable must be initialized to zero.  Because the device</span>
03383                 <span class="comment">// instance key may be an enumerated device.  In this case, there is no</span>
03384                 <span class="comment">// legacy value name.</span>
03385                 <span class="comment">//</span>
03386 
03387                 legacy = 0;
03388                 status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(handle,
03389                                              REGSTR_VALUE_LEGACY,
03390                                              &amp;keyValueInformation
03391                                              );
03392                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03393                     <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
03394                         (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
03395                         legacy = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03396                     }
03397                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03398                 }
03399             } <span class="keywordflow">else</span> {
03400                 legacy = 0;
03401             }
03402 
03403             <span class="keywordflow">if</span> (legacy == 0) {
03404 
03405                 <span class="comment">//</span>
03406                 <span class="comment">// Mark that the driver has at least a device instance to work with.</span>
03407                 <span class="comment">//</span>
03408 
03409                 PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_CONTROL);
03410                 status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;controlHandle,
03411                                                  handle,
03412                                                  &amp;unicodeName,
03413                                                  KEY_ALL_ACCESS,
03414                                                  REG_OPTION_VOLATILE,
03415                                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
03416                                                  );
03417                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03418                     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_ACTIVESERVICE);
03419                     ZwSetValueKey(
03420                                 controlHandle,
03421                                 &amp;unicodeName,
03422                                 <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
03423                                 REG_SZ,
03424                                 ServiceKeyName-&gt;Buffer,
03425                                 ServiceKeyName-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL)
03426                                 );
03427 
03428                     ZwClose(controlHandle);
03429                 }
03430                 enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03431             }
03432         }
03433         ZwClose(handle);
03434     }
03435 
03436     <span class="keywordflow">if</span> (closeHandle) {
03437         ZwClose(ServiceHandle);
03438     }
03439     <span class="keywordflow">return</span> enabled;
03440 }
03441 
03442 BOOLEAN
<a name="l03443"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a22">03443</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a20">IopIsDeviceInstanceEnabled</a>(
03444     IN HANDLE DeviceInstanceHandle      OPTIONAL,
03445     IN PUNICODE_STRING DeviceInstance,
03446     IN BOOLEAN DisableIfEnabled
03447     )
03448 
03449 <span class="comment">/*++</span>
03450 <span class="comment"></span>
03451 <span class="comment">Routine Description:</span>
03452 <span class="comment"></span>
03453 <span class="comment">    This routine checks if the specified devices instances is enabled.</span>
03454 <span class="comment"></span>
03455 <span class="comment">Arguments:</span>
03456 <span class="comment"></span>
03457 <span class="comment">    DeviceInstanceHandle - Optionally supplies a handle to the device instance</span>
03458 <span class="comment">        key to be checked.</span>
03459 <span class="comment"></span>
03460 <span class="comment">    DeviceInstance - Specifies the device instance key unicode name.  Caller</span>
03461 <span class="comment">        must at least specified DeviceInstanceHandle or DeviceInstance.</span>
03462 <span class="comment"></span>
03463 <span class="comment">    DisableIfEnabled - If this flag is set, and the device should be disabled</span>
03464 <span class="comment">        but is currently disabled, then the device is disabled.</span>
03465 <span class="comment"></span>
03466 <span class="comment">Returns:</span>
03467 <span class="comment"></span>
03468 <span class="comment">    A BOOLEAN value.</span>
03469 <span class="comment"></span>
03470 <span class="comment">--*/</span>
03471 
03472 {
03473     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03474     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
03475     HANDLE handle, handle1;
03476     ULONG deviceFlags;
03477     BOOLEAN enabled, closeHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03478     UNICODE_STRING unicodeString;
03479     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03480     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03481 
03482     <span class="comment">//</span>
03483     <span class="comment">// Open registry ServiceKeyName\Enum branch</span>
03484     <span class="comment">//</span>
03485 
03486     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(DeviceInstanceHandle)) {
03487         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
03488                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03489                                        &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a23">CmRegistryMachineSystemCurrentControlSetEnumName</a>,
03490                                        KEY_READ
03491                                        );
03492 
03493         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03494 
03495             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;DeviceInstanceHandle,
03496                                            handle,
03497                                            DeviceInstance,
03498                                            KEY_READ
03499                                            );
03500             ZwClose(handle);
03501         }
03502 
03503         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03504             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03505         }
03506         closeHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03507     }
03508 
03509     enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03510 
03511     <span class="comment">//</span>
03512     <span class="comment">// First check the device node</span>
03513     <span class="comment">//</span>
03514 
03515     deviceObject = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a>(DeviceInstanceHandle, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03516     <span class="keywordflow">if</span> (deviceObject) {
03517         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
03518         <span class="keywordflow">if</span> (deviceNode &amp;&amp; (<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(deviceNode, CM_PROB_DISABLED) || <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(deviceNode, CM_PROB_DISABLED))) {
03519             enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03520             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
03521         }
03522     }
03523 
03524     <span class="comment">//</span>
03525     <span class="comment">// Check if the device instance has been disabled.</span>
03526     <span class="comment">// First check global flag: CONFIGFLAG and then CSCONFIGFLAG.</span>
03527     <span class="comment">//</span>
03528 
03529     deviceFlags = 0;
03530     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(DeviceInstanceHandle,
03531                                  REGSTR_VALUE_CONFIG_FLAGS,
03532                                  &amp;keyValueInformation);
03533     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03534         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
03535             (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
03536             deviceFlags = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03537         }
03538         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03539     }
03540     <span class="keywordflow">if</span> (!(deviceFlags &amp; CONFIGFLAG_DISABLED)) {
03541         enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03542 
03543         <span class="comment">//</span>
03544         <span class="comment">// See if we can open current hardware profile</span>
03545         <span class="comment">//</span>
03546         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle1,
03547                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03548                                        &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a26">CmRegistryMachineSystemCurrentControlSetHardwareProfilesCurrent</a>,
03549                                        KEY_READ
03550                                        );
03551 
03552         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; DeviceInstance != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03553 
03554             <span class="comment">//</span>
03555             <span class="comment">// Now, we must open the System\CCS\Enum key under this.</span>
03556             <span class="comment">//</span>
03557             <span class="comment">//</span>
03558             <span class="comment">// Open system\CurrentControlSet under current hardware profile key</span>
03559             <span class="comment">//</span>
03560 
03561             PiWstrToUnicodeString(&amp;unicodeString, REGSTR_PATH_CURRENTCONTROLSET);
03562             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
03563                                            handle1,
03564                                            &amp;unicodeString,
03565                                            KEY_READ
03566                                            );
03567             ZwClose(handle1);
03568             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03569                 PiWstrToUnicodeString(&amp;unicodeString, REGSTR_KEY_ENUM);
03570                 status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle1,
03571                                                handle,
03572                                                &amp;unicodeString,
03573                                                KEY_READ
03574                                                );
03575                 ZwClose(handle);
03576                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03577                     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
03578                                                    handle1,
03579                                                    DeviceInstance,
03580                                                    KEY_READ
03581                                                    );
03582                     ZwClose(handle1);
03583                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03584                         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(
03585                                         handle,
03586                                         REGSTR_VALUE_CSCONFIG_FLAGS,
03587                                         &amp;keyValueInformation
03588                                         );
03589                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03590                             <span class="keywordflow">if</span>((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
03591                                (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
03592                                deviceFlags = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03593                             }
03594                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03595                         }
03596                         ZwClose(handle);
03597                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03598                             <span class="keywordflow">if</span> ((deviceFlags &amp; CSCONFIGFLAG_DISABLED) ||
03599                                 (deviceFlags &amp; CSCONFIGFLAG_DO_NOT_CREATE) ||
03600                                 (deviceFlags &amp; CSCONFIGFLAG_DO_NOT_START)) {
03601                                 enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03602                             }
03603                         }
03604                     }
03605                 }
03606             }
03607         }
03608     } <span class="keywordflow">else</span> {
03609         enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03610     }
03611 
03612     <span class="comment">//</span>
03613     <span class="comment">// If the device is disabled and has device node associated with it.</span>
03614     <span class="comment">// disable the device.</span>
03615     <span class="comment">//</span>
03616 
03617     <span class="keywordflow">if</span> (enabled == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> &amp;&amp; deviceNode &amp;&amp; DisableIfEnabled) {
03618         <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a0">IopDisableDevice</a>(deviceNode, DeviceInstanceHandle);
03619     }
03620 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
03621     <span class="keywordflow">if</span> (deviceObject) {
03622         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceObject);
03623     }
03624     <span class="keywordflow">if</span> (closeHandle) {
03625         ZwClose(DeviceInstanceHandle);
03626     }
03627     <span class="keywordflow">return</span> enabled;
03628 }
03629 
03630 ULONG
<a name="l03631"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a23">03631</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(
03632     IN PCM_RESOURCE_LIST ResourceList
03633     )
03634 
03635 <span class="comment">/*++</span>
03636 <span class="comment"></span>
03637 <span class="comment">Routine Description:</span>
03638 <span class="comment"></span>
03639 <span class="comment">    This routine determines size of the passed in ResourceList</span>
03640 <span class="comment">    structure.</span>
03641 <span class="comment"></span>
03642 <span class="comment">Arguments:</span>
03643 <span class="comment"></span>
03644 <span class="comment">    Configuration1 - Supplies a pointer to the resource list.</span>
03645 <span class="comment"></span>
03646 <span class="comment">Return Value:</span>
03647 <span class="comment"></span>
03648 <span class="comment">    size of the resource list structure.</span>
03649 <span class="comment"></span>
03650 <span class="comment">--*/</span>
03651 
03652 {
03653     ULONG totalSize, listSize, descriptorSize, i, j;
03654     PCM_FULL_RESOURCE_DESCRIPTOR fullResourceDesc;
03655     PCM_PARTIAL_RESOURCE_DESCRIPTOR partialDescriptor;
03656 
03657     <span class="keywordflow">if</span> (!ResourceList) {
03658         totalSize = 0;
03659     } <span class="keywordflow">else</span> {
03660         totalSize = FIELD_OFFSET(CM_RESOURCE_LIST, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>);
03661         fullResourceDesc = &amp;ResourceList-&gt;List[0];
03662         <span class="keywordflow">for</span> (i = 0; i &lt; ResourceList-&gt;Count; i++) {
03663             listSize = FIELD_OFFSET(CM_FULL_RESOURCE_DESCRIPTOR,
03664                                     PartialResourceList) +
03665                        FIELD_OFFSET(CM_PARTIAL_RESOURCE_LIST,
03666                                     PartialDescriptors);
03667             partialDescriptor = &amp;fullResourceDesc-&gt;PartialResourceList.PartialDescriptors[0];
03668             <span class="keywordflow">for</span> (j = 0; j &lt; fullResourceDesc-&gt;PartialResourceList.Count; j++) {
03669                 descriptorSize = <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_DESCRIPTOR);
03670                 <span class="keywordflow">if</span> (partialDescriptor-&gt;Type == CmResourceTypeDeviceSpecific) {
03671                     descriptorSize += partialDescriptor-&gt;u.DeviceSpecificData.DataSize;
03672                 }
03673                 listSize += descriptorSize;
03674                 partialDescriptor = (PCM_PARTIAL_RESOURCE_DESCRIPTOR)
03675                                         ((PUCHAR)partialDescriptor + descriptorSize);
03676             }
03677             totalSize += listSize;
03678             fullResourceDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)
03679                                       ((PUCHAR)fullResourceDesc + listSize);
03680         }
03681     }
03682     <span class="keywordflow">return</span> totalSize;
03683 }
03684 
03685 <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>
<a name="l03686"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a24">03686</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a22">IopReferenceDriverObjectByName</a> (
03687     IN PUNICODE_STRING DriverName
03688     )
03689 
03690 <span class="comment">/*++</span>
03691 <span class="comment"></span>
03692 <span class="comment">Routine Description:</span>
03693 <span class="comment"></span>
03694 <span class="comment">    This routine references a driver object by a given driver name.</span>
03695 <span class="comment"></span>
03696 <span class="comment">Arguments:</span>
03697 <span class="comment"></span>
03698 <span class="comment">    DriverName - supplies a pointer to the name of the driver whose driver object is</span>
03699 <span class="comment">        to be referenced.</span>
03700 <span class="comment"></span>
03701 <span class="comment">Returns:</span>
03702 <span class="comment"></span>
03703 <span class="comment">    A pointer to a DRIVER_OBJECT if succeeds.  Otherwise, a NULL value.</span>
03704 <span class="comment"></span>
03705 <span class="comment">--*/</span>
03706 
03707 {
03708     OBJECT_ATTRIBUTES objectAttributes;
03709     HANDLE driverHandle;
03710     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03711     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
03712 
03713     <span class="comment">//</span>
03714     <span class="comment">// Make sure the driver name is valid.</span>
03715     <span class="comment">//</span>
03716 
03717     <span class="keywordflow">if</span> (DriverName-&gt;Length == 0) {
03718         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03719     }
03720 
03721     InitializeObjectAttributes(&amp;objectAttributes,
03722                                DriverName,
03723                                OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,
03724                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03725                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
03726                                );
03727     status = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>(&amp;objectAttributes,
03728                                 <a class="code" href="../../d3/d5/iodata_8c.html#a36">IoDriverObjectType</a>,
03729                                 <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
03730                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03731                                 FILE_READ_ATTRIBUTES,
03732                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03733                                 &amp;driverHandle
03734                                 );
03735     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03736 
03737         <span class="comment">//</span>
03738         <span class="comment">// Now reference the driver object.</span>
03739         <span class="comment">//</span>
03740 
03741         status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(driverHandle,
03742                                            0,
03743                                            <a class="code" href="../../d3/d5/iodata_8c.html#a36">IoDriverObjectType</a>,
03744                                            <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
03745                                            &amp;driverObject,
03746                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
03747                                            );
03748         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(driverHandle);
03749     }
03750 
03751     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03752         <span class="keywordflow">return</span> driverObject;
03753     } <span class="keywordflow">else</span> {
03754         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03755     }
03756 }
03757 
03758 <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>
<a name="l03759"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a25">03759</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a>(
03760     IN HANDLE DeviceInstanceHandle      OPTIONAL,
03761     IN PUNICODE_STRING DeviceInstance   OPTIONAL
03762     )
03763 
03764 <span class="comment">/*++</span>
03765 <span class="comment"></span>
03766 <span class="comment">Routine Description:</span>
03767 <span class="comment"></span>
03768 <span class="comment">    This routine receives a DeviceInstance path (or DeviceInstance handle) and</span>
03769 <span class="comment">    returns a reference to a bus device object for the DeviceInstance.</span>
03770 <span class="comment"></span>
03771 <span class="comment">    Note, caller must owner the PpRegistryDeviceResource before calling the function,</span>
03772 <span class="comment"></span>
03773 <span class="comment">Arguments:</span>
03774 <span class="comment"></span>
03775 <span class="comment">    DeviceInstanceHandle - Supplies a handle to the registry Device Instance key.</span>
03776 <span class="comment">        If this parameter is NULL, DeviceInstance must specify the registry path.</span>
03777 <span class="comment"></span>
03778 <span class="comment">    DeviceInstance - supplies a UNICODE_STRING to specify the device instance path.</span>
03779 <span class="comment">        if this parameter is NULL, DeviceInstanceHandle must specify the handle</span>
03780 <span class="comment">        to its registry key.</span>
03781 <span class="comment"></span>
03782 <span class="comment">Returns:</span>
03783 <span class="comment"></span>
03784 <span class="comment">    A reference to the desired bus device object.</span>
03785 <span class="comment"></span>
03786 <span class="comment">--*/</span>
03787 
03788 {
03789     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03790     HANDLE handle, deviceHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03791     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceReference = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03792     UNICODE_STRING unicodeName;
03793     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
03794     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
03795 
03796     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03797 
03798     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(DeviceInstanceHandle)) {
03799 
03800         <span class="comment">//</span>
03801         <span class="comment">// Treat HTREE\ROOT\0 specially</span>
03802         <span class="comment">//</span>
03803         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_ROOT_DEVNODE);
03804 
03805         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;unicodeName, DeviceInstance, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03806 
03807             deviceReference = <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>;
03808             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceReference);
03809             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(deviceReference);
03810 
03811             <span class="keywordflow">return</span> deviceReference;
03812         }
03813 
03814         <span class="comment">//</span>
03815         <span class="comment">// first open System\CCS\Enum key and then the device instance key.</span>
03816         <span class="comment">//</span>
03817 
03818         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
03819                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03820                                        &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a23">CmRegistryMachineSystemCurrentControlSetEnumName</a>,
03821                                        KEY_READ
03822                                        );
03823 
03824         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03825             <span class="keywordflow">return</span> deviceReference;
03826         }
03827 
03828         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceInstance);
03829         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;deviceHandle,
03830                                        handle,
03831                                        DeviceInstance,
03832                                        KEY_READ
03833                                        );
03834         ZwClose(handle);
03835         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03836             <span class="keywordflow">return</span> deviceReference;
03837         }
03838         DeviceInstanceHandle = deviceHandle;
03839     }
03840 
03841     <span class="comment">//</span>
03842     <span class="comment">// Read the address of device object</span>
03843     <span class="comment">//</span>
03844 
03845     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_CONTROL);
03846     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
03847                                    DeviceInstanceHandle,
03848                                    &amp;unicodeName,
03849                                    KEY_READ
03850                                    );
03851     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03852         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
03853     }
03854 
03855     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (handle,
03856                                   REGSTR_VALUE_DEVICE_REFERENCE,
03857                                   &amp;keyValueInformation);
03858     ZwClose(handle);
03859     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03860         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
03861             (keyValueInformation-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG_PTR))) {
03862 
03863             deviceReference = *(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03864         }
03865         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03866     }
03867     <span class="keywordflow">if</span> (!deviceReference) {
03868         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
03869     }
03870 
03871     <span class="comment">//</span>
03872     <span class="comment">// Make sure the address of the device object is not clobbered,</span>
03873     <span class="comment">// unfortunately if the address is truly bogus we will bugcheck since</span>
03874     <span class="comment">// try/except doesn't work for kernel addresses.</span>
03875     <span class="comment">//</span>
03876 
03877     <span class="keywordflow">if</span> (deviceReference-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o0">Type</a> != <a class="code" href="../../d0/d5/io_8h.html#a2">IO_TYPE_DEVICE</a>) {
03878         deviceReference = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03879     } <span class="keywordflow">else</span> {
03880         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceReference-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
03881         <span class="keywordflow">if</span> (deviceNode &amp;&amp; (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a> == deviceReference)) {
03882             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(deviceReference);
03883         } <span class="keywordflow">else</span> {
03884             deviceReference = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03885         }
03886     }
03887 
03888 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
03889     <span class="keywordflow">if</span> (deviceHandle) {
03890         ZwClose(deviceHandle);
03891     }
03892     <span class="keywordflow">return</span> deviceReference;
03893 
03894 }
03895 
03896 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03897"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a26">03897</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">IopDeviceObjectToDeviceInstance</a> (
03898     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
03899     IN PHANDLE DeviceInstanceHandle,
03900     IN  ACCESS_MASK DesiredAccess
03901     )
03902 
03903 <span class="comment">/*++</span>
03904 <span class="comment"></span>
03905 <span class="comment">Routine Description:</span>
03906 <span class="comment"></span>
03907 <span class="comment">    This routine receives a DeviceObject pointer and returns a handle to the device</span>
03908 <span class="comment">    instance path under registry System\ENUM key.</span>
03909 <span class="comment"></span>
03910 <span class="comment">    Note, caller must owner the PpRegistryDeviceResource before calling the function,</span>
03911 <span class="comment"></span>
03912 <span class="comment">Arguments:</span>
03913 <span class="comment"></span>
03914 <span class="comment">    DeviceObject - supplies a pointer to a physical device object.</span>
03915 <span class="comment"></span>
03916 <span class="comment">    DeviceInstanceHandle - Supplies a variable to receive the handle to the registry</span>
03917 <span class="comment">             device instance key.</span>
03918 <span class="comment"></span>
03919 <span class="comment">    DesiredAccess - specifies the access that is needed to this key.</span>
03920 <span class="comment"></span>
03921 <span class="comment">Returns:</span>
03922 <span class="comment"></span>
03923 <span class="comment">    NTSTATUS code to indicate success or failure.</span>
03924 <span class="comment"></span>
03925 <span class="comment">--*/</span>
03926 
03927 {
03928     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03929     HANDLE handle;
03930     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
03931 
03932     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03933 
03934     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
03935                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03936                                    &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a23">CmRegistryMachineSystemCurrentControlSetEnumName</a>,
03937                                    KEY_READ
03938                                    );
03939 
03940     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03941         <span class="keywordflow">return</span> status;
03942     }
03943 
03944     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>) DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
03945     <span class="keywordflow">if</span> (deviceNode &amp;&amp; (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Length != 0)) {
03946         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( DeviceInstanceHandle,
03947                                        handle,
03948                                        &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>,
03949                                        DesiredAccess
03950                                        );
03951     } <span class="keywordflow">else</span> {
03952         status = STATUS_INVALID_DEVICE_REQUEST;
03953     }
03954     ZwClose(handle);
03955 
03956     <span class="keywordflow">return</span> status;
03957 }
03958 
03959 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03960"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a27">03960</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a25">IopCleanupDeviceRegistryValues</a> (
03961     IN PUNICODE_STRING InstancePath,
03962     IN BOOLEAN KeepReference
03963     )
03964 
03965 <span class="comment">/*++</span>
03966 <span class="comment"></span>
03967 <span class="comment">Routine Description:</span>
03968 <span class="comment"></span>
03969 <span class="comment">    This routine cleans up a device instance key when the device is no</span>
03970 <span class="comment">    longer present/enumerated.  If the device is registered to a Service</span>
03971 <span class="comment">    the Service's enum key will also been cleaned up.</span>
03972 <span class="comment"></span>
03973 <span class="comment">    Note the caller must lock the RegistryDeciceResource</span>
03974 <span class="comment"></span>
03975 <span class="comment">Arguments:</span>
03976 <span class="comment"></span>
03977 <span class="comment">    InstancePath - supplies a pointer to the name of the device instance key.</span>
03978 <span class="comment"></span>
03979 <span class="comment">    KeepReference - supplies a boolean value to indicate if we should remove the</span>
03980 <span class="comment">        device instance path to device object mapping.</span>
03981 <span class="comment"></span>
03982 <span class="comment">Return Value:</span>
03983 <span class="comment"></span>
03984 <span class="comment">    status</span>
03985 <span class="comment"></span>
03986 <span class="comment">--*/</span>
03987 
03988 {
03989     HANDLE handle, instanceHandle;
03990     UNICODE_STRING unicodeValueName;
03991     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03992     ULONG count = 0;
03993     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
03994 
03995     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03996 
03997     <span class="comment">//</span>
03998     <span class="comment">// Open System\CurrentControlSet\Enum</span>
03999     <span class="comment">//</span>
04000 
04001     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
04002                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04003                                    &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a23">CmRegistryMachineSystemCurrentControlSetEnumName</a>,
04004                                    KEY_ALL_ACCESS
04005                                    );
04006 
04007     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04008         <span class="keywordflow">return</span> status;
04009     }
04010 
04011     <span class="comment">//</span>
04012     <span class="comment">// Open the device instance key</span>
04013     <span class="comment">//</span>
04014 
04015     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;instanceHandle,
04016                                    handle,
04017                                    InstancePath,
04018                                    KEY_ALL_ACCESS
04019                                    );
04020 
04021     ZwClose(handle);
04022     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04023 
04024         <span class="comment">//</span>
04025         <span class="comment">// There is no registry key for the ServiceKeyName information.</span>
04026         <span class="comment">//</span>
04027 
04028         <span class="keywordflow">return</span> status;
04029     }
04030 
04031     <span class="comment">//</span>
04032     <span class="comment">// Delete the DeviceReference value name under Control key</span>
04033     <span class="comment">//</span>
04034 
04035     <span class="keywordflow">if</span> (!KeepReference) {
04036 
04037         <span class="comment">//</span>
04038         <span class="comment">// BUGBUG (lonnym)--verify that removal of the following code fragment is valid.</span>
04039         <span class="comment">//</span>
04040 <span class="preprocessor">#if 0</span>
04041 <span class="preprocessor"></span>        <span class="comment">//</span>
04042         <span class="comment">// Set the 'FoundAtEnum' value to false.</span>
04043         <span class="comment">//</span>
04044 
04045         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_FOUNDATENUM);
04046         tmpValue = 0;
04047         ZwSetValueKey(instanceHandle,
04048                       &amp;unicodeValueName,
04049                       <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
04050                       REG_DWORD,
04051                       &amp;tmpValue,
04052                       <span class="keyword">sizeof</span>(tmpValue)
04053                       );
04054 <span class="preprocessor">#endif // (lonnym, verify removal to here)</span>
04055 <span class="preprocessor"></span>
04056         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_KEY_CONTROL);
04057         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
04058                                        instanceHandle,
04059                                        &amp;unicodeValueName,
04060                                        KEY_ALL_ACCESS
04061                                        );
04062         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04063             PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_DEVICE_REFERENCE);
04064             ZwDeleteValueKey(handle, &amp;unicodeValueName);
04065             ZwClose(handle);
04066         }
04067 
04068         <span class="comment">//</span>
04069         <span class="comment">// Deregister the device from its controlling service's service enum key</span>
04070         <span class="comment">//</span>
04071 
04072         status = PiDeviceRegistration( InstancePath, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
04073     }
04074 
04075     ZwClose(instanceHandle);
04076 
04077     <span class="keywordflow">return</span> status;
04078 }
04079 
04080 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04081"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a28">04081</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a26">IopGetDeviceResourcesFromRegistry</a> (
04082     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
04083     IN ULONG ResourceType,
04084     IN ULONG Preference,
04085     OUT PVOID *Resource,
04086     OUT PULONG Length
04087     )
04088 
04089 <span class="comment">/*++</span>
04090 <span class="comment"></span>
04091 <span class="comment">Routine Description:</span>
04092 <span class="comment"></span>
04093 <span class="comment">    This routine determines the resources decoded by the device specified.</span>
04094 <span class="comment">    If the device object is a madeup device, we will try to read the resources</span>
04095 <span class="comment">    from registry.  Otherwise, we need to traverse the internal assigned resource</span>
04096 <span class="comment">    list to compose the resource list.</span>
04097 <span class="comment"></span>
04098 <span class="comment">Arguments:</span>
04099 <span class="comment"></span>
04100 <span class="comment">    DeviceObject - supplies a pointer to a device object whose registry</span>
04101 <span class="comment">        values are to be cleaned up.</span>
04102 <span class="comment"></span>
04103 <span class="comment">    ResourceType - 0 for CM_RESOURCE_LIST and 1 for IO_RESOURCE_REQUIREMENTS_LIS</span>
04104 <span class="comment"></span>
04105 <span class="comment">    Flags - specify the preference.</span>
04106 <span class="comment"></span>
04107 <span class="comment">    Resource - Specified a variable to receive the required resources.</span>
04108 <span class="comment"></span>
04109 <span class="comment">    Length - Specified a variable to receive the length of the resource structure.</span>
04110 <span class="comment"></span>
04111 <span class="comment">Return Value:</span>
04112 <span class="comment"></span>
04113 <span class="comment">    status</span>
04114 <span class="comment"></span>
04115 <span class="comment">--*/</span>
04116 
04117 {
04118     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
04119     HANDLE handle, handlex;
04120     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04121     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
04122     PCM_RESOURCE_LIST cmResource;
04123     PIO_RESOURCE_REQUIREMENTS_LIST ioResource;
04124     ULONG length;
04125     UNICODE_STRING unicodeName;
04126     PWCHAR valueName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04127 
04128     *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04129     *Length = 0;
04130 
04131     <span class="comment">//</span>
04132     <span class="comment">// Open the LogConfig key of the device instance.</span>
04133     <span class="comment">//</span>
04134 
04135     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">IopDeviceObjectToDeviceInstance</a>(DeviceObject, &amp;handlex, KEY_READ);
04136     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04137         <span class="keywordflow">return</span> status;
04138     }
04139 
04140     <span class="keywordflow">if</span> (ResourceType == <a class="code" href="../../d9/d0/pnpiop_8h.html#a60">QUERY_RESOURCE_LIST</a>) {
04141 
04142         <span class="comment">//</span>
04143         <span class="comment">// Caller is asking for CM_RESOURCE_LIST</span>
04144         <span class="comment">//</span>
04145 
04146         <span class="keywordflow">if</span> (Preference &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a62">REGISTRY_ALLOC_CONFIG</a>) {
04147 
04148             <span class="comment">//</span>
04149             <span class="comment">// Try alloc config first</span>
04150             <span class="comment">//</span>
04151 
04152             PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_CONTROL);
04153             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
04154                                            handlex,
04155                                            &amp;unicodeName,
04156                                            KEY_READ
04157                                            );
04158             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04159                 status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a27">IopReadDeviceConfiguration</a> (handle, <a class="code" href="../../d9/d0/pnpiop_8h.html#a62">REGISTRY_ALLOC_CONFIG</a>, (PCM_RESOURCE_LIST *)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, Length);
04160                 ZwClose(handle);
04161                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04162                     ZwClose(handlex);
04163                     <span class="keywordflow">return</span> status;
04164                 }
04165             }
04166         }
04167 
04168         handle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04169         <span class="keywordflow">if</span> (Preference &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a63">REGISTRY_FORCED_CONFIG</a>) {
04170 
04171             PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_LOG_CONF);
04172             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
04173                                            handlex,
04174                                            &amp;unicodeName,
04175                                            KEY_READ
04176                                            );
04177             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04178                 status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a27">IopReadDeviceConfiguration</a> (handle, <a class="code" href="../../d9/d0/pnpiop_8h.html#a63">REGISTRY_FORCED_CONFIG</a>, (PCM_RESOURCE_LIST *)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, Length);
04179                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04180                     ZwClose(handle);
04181                     ZwClose(handlex);
04182                     <span class="keywordflow">return</span> status;
04183                 }
04184             } <span class="keywordflow">else</span> {
04185                 ZwClose(handlex);
04186                 <span class="keywordflow">return</span> status;
04187             }
04188         }
04189         <span class="keywordflow">if</span> (Preference &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a64">REGISTRY_BOOT_CONFIG</a>) {
04190 
04191             <span class="comment">//</span>
04192             <span class="comment">// Try alloc config first</span>
04193             <span class="comment">//</span>
04194 
04195             <span class="keywordflow">if</span> (handle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04196                 PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_LOG_CONF);
04197                 status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
04198                                                handlex,
04199                                                &amp;unicodeName,
04200                                                KEY_READ
04201                                                );
04202                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04203                     ZwClose(handlex);
04204                     <span class="keywordflow">return</span> status;
04205                 }
04206             }
04207             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a27">IopReadDeviceConfiguration</a>( handle,
04208                                                  <a class="code" href="../../d9/d0/pnpiop_8h.html#a64">REGISTRY_BOOT_CONFIG</a>,
04209                                                  (PCM_RESOURCE_LIST *)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>,
04210                                                  Length);
04211         }
04212         <span class="keywordflow">if</span> (handle) {
04213             ZwClose(handle);
04214         }
04215     } <span class="keywordflow">else</span> {
04216 
04217         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_LOG_CONF);
04218         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
04219                                        handlex,
04220                                        &amp;unicodeName,
04221                                        KEY_READ
04222                                        );
04223         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04224 
04225             <span class="keywordflow">if</span> (Preference &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a65">REGISTRY_OVERRIDE_CONFIGVECTOR</a>) {
04226                 valueName = REGSTR_VALUE_OVERRIDE_CONFIG_VECTOR;
04227             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Preference &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a66">REGISTRY_BASIC_CONFIGVECTOR</a>) {
04228                 valueName = REGSTR_VALUE_BASIC_CONFIG_VECTOR;
04229             }
04230             <span class="keywordflow">if</span> (valueName) {
04231 
04232                 <span class="comment">//</span>
04233                 <span class="comment">// Try to read device's configuration vector</span>
04234                 <span class="comment">//</span>
04235 
04236                 status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (handle,
04237                                               valueName,
04238                                               &amp;keyValueInformation);
04239                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04240 
04241                     <span class="comment">//</span>
04242                     <span class="comment">// Try to read what caller wants.</span>
04243                     <span class="comment">//</span>
04244 
04245                     <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_RESOURCE_REQUIREMENTS_LIST) &amp;&amp;
04246                         (keyValueInformation-&gt;DataLength != 0)) {
04247 
04248                         *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
04249                                                    keyValueInformation-&gt;DataLength);
04250                         <span class="keywordflow">if</span> (*Resource) {
04251                             PIO_RESOURCE_REQUIREMENTS_LIST ioResource;
04252 
04253                             *Length = keyValueInformation-&gt;DataLength;
04254                             RtlMoveMemory(*<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>,
04255                                           <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
04256                                           keyValueInformation-&gt;DataLength);
04257 
04258                             <span class="comment">//</span>
04259                             <span class="comment">// Process the io resource requirements list to change undefined</span>
04260                             <span class="comment">// interface type to our default type.</span>
04261                             <span class="comment">//</span>
04262 
04263                             ioResource = *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>;
04264                             <span class="keywordflow">if</span> (ioResource-&gt;InterfaceType == InterfaceTypeUndefined) {
04265                                 ioResource-&gt;BusNumber = 0;
04266                                 ioResource-&gt;InterfaceType = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
04267                             }
04268                         } <span class="keywordflow">else</span> {
04269                             status = STATUS_INVALID_PARAMETER_2;
04270                         }
04271                     }
04272                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
04273                 }
04274             }
04275             ZwClose(handle);
04276         }
04277     }
04278     ZwClose(handlex);
04279     <span class="keywordflow">return</span> status;
04280 }
04281 
04282 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04283"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a29">04283</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a27">IopReadDeviceConfiguration</a> (
04284     IN HANDLE Handle,
04285     IN ULONG Flags,
04286     OUT PCM_RESOURCE_LIST *CmResource,
04287     OUT PULONG Length
04288     )
04289 
04290 <span class="comment">/*++</span>
04291 <span class="comment"></span>
04292 <span class="comment">Routine Description:</span>
04293 <span class="comment"></span>
04294 <span class="comment">    This routine read the specified ALLOC config or ForcedConfig or Boot config.</span>
04295 <span class="comment"></span>
04296 <span class="comment">Arguments:</span>
04297 <span class="comment"></span>
04298 <span class="comment">    Hanle - supplies a handle to the registry key to read resources.</span>
04299 <span class="comment"></span>
04300 <span class="comment">Return Value:</span>
04301 <span class="comment"></span>
04302 <span class="comment">    status</span>
04303 <span class="comment"></span>
04304 <span class="comment">--*/</span>
04305 
04306 {
04307     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04308     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
04309     PWCHAR valueName;
04310 
04311     *CmResource = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04312     *Length = 0;
04313 
04314     <span class="keywordflow">if</span> (Flags == <a class="code" href="../../d9/d0/pnpiop_8h.html#a62">REGISTRY_ALLOC_CONFIG</a>) {
04315         valueName = REGSTR_VALUE_ALLOC_CONFIG;
04316     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Flags == <a class="code" href="../../d9/d0/pnpiop_8h.html#a63">REGISTRY_FORCED_CONFIG</a>) {
04317         valueName = REGSTR_VALUE_FORCED_CONFIG;
04318     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Flags == <a class="code" href="../../d9/d0/pnpiop_8h.html#a64">REGISTRY_BOOT_CONFIG</a>) {
04319         valueName = REGSTR_VALUE_BOOT_CONFIG;
04320     } <span class="keywordflow">else</span> {
04321         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
04322     }
04323 
04324     <span class="comment">//</span>
04325     <span class="comment">// Read the registry value of the desired value name</span>
04326     <span class="comment">//</span>
04327 
04328     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
04329                                   valueName,
04330                                   &amp;keyValueInformation);
04331     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04332 
04333         <span class="comment">//</span>
04334         <span class="comment">// Try to read what caller wants.</span>
04335         <span class="comment">//</span>
04336 
04337         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_RESOURCE_LIST) &amp;&amp;
04338             (keyValueInformation-&gt;DataLength != 0)) {
04339             *CmResource = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
04340                                          keyValueInformation-&gt;DataLength);
04341             <span class="keywordflow">if</span> (*CmResource) {
04342                 <span class="keywordflow">if</span> (*CmResource) {
04343                     *Length = keyValueInformation-&gt;DataLength;
04344                     RtlMoveMemory(*CmResource,
04345                                   <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
04346                                   keyValueInformation-&gt;DataLength);
04347                 } <span class="keywordflow">else</span> {
04348                     status = STATUS_INSUFFICIENT_RESOURCES;
04349                 }
04350             }
04351             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
04352             <span class="keywordflow">if</span> (*CmResource) {
04353                 PCM_RESOURCE_LIST resourceList;
04354                 PCM_FULL_RESOURCE_DESCRIPTOR cmFullDesc;
04355                 PCM_PARTIAL_RESOURCE_DESCRIPTOR cmPartDesc;
04356                 ULONG j, k, size, count;
04357 
04358                 <span class="comment">//</span>
04359                 <span class="comment">// Process the resource list read from Registry to change undefined</span>
04360                 <span class="comment">// interface type to our default interface type.</span>
04361                 <span class="comment">//</span>
04362 
04363                 resourceList = *CmResource;
04364                 cmFullDesc = &amp;resourceList-&gt;List[0];
04365                 <span class="keywordflow">for</span> (j = 0; j &lt; resourceList-&gt;Count; j++) {
04366                     <span class="keywordflow">if</span> (cmFullDesc-&gt;InterfaceType == InterfaceTypeUndefined) {
04367                         cmFullDesc-&gt;BusNumber = 0;
04368                         cmFullDesc-&gt;InterfaceType = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
04369                     }
04370                     cmPartDesc = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
04371                     <span class="keywordflow">for</span> (k = 0; k &lt; cmFullDesc-&gt;PartialResourceList.Count; k++) {
04372                         size = 0;
04373                         <span class="keywordflow">switch</span> (cmPartDesc-&gt;Type) {
04374                         <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
04375                              size = cmPartDesc-&gt;u.DeviceSpecificData.DataSize;
04376                              <span class="keywordflow">break</span>;
04377                         }
04378                         cmPartDesc++;
04379                         cmPartDesc = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmPartDesc + size);
04380                     }
04381                     cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmPartDesc;
04382                 }
04383             }
04384         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (keyValueInformation-&gt;Type != REG_RESOURCE_LIST) {
04385             status = STATUS_UNSUCCESSFUL;
04386         }
04387     }
04388     <span class="keywordflow">return</span> status;
04389 }
04390 
04391 PIO_RESOURCE_REQUIREMENTS_LIST
<a name="l04392"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a30">04392</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a28">IopCmResourcesToIoResources</a> (
04393     IN ULONG SlotNumber,
04394     IN PCM_RESOURCE_LIST CmResourceList,
04395     IN ULONG Priority
04396     )
04397 
04398 <span class="comment">/*++</span>
04399 <span class="comment"></span>
04400 <span class="comment">Routine Description:</span>
04401 <span class="comment"></span>
04402 <span class="comment">    This routines converts the input CmResourceList to IO_RESOURCE_REQUIREMENTS_LIST.</span>
04403 <span class="comment"></span>
04404 <span class="comment">Arguments:</span>
04405 <span class="comment"></span>
04406 <span class="comment">    SlotNumber - supplies the SlotNumber the resources refer to.</span>
04407 <span class="comment"></span>
04408 <span class="comment">    CmResourceList - the cm resource list to convert.</span>
04409 <span class="comment"></span>
04410 <span class="comment">    Priority - specifies the priority of the logconfig</span>
04411 <span class="comment"></span>
04412 <span class="comment">Return Value:</span>
04413 <span class="comment"></span>
04414 <span class="comment">    returns a IO_RESOURCE_REQUIREMENTS_LISTST if succeeds.  Otherwise a NULL value is</span>
04415 <span class="comment">    returned.</span>
04416 <span class="comment"></span>
04417 <span class="comment">--*/</span>
04418 {
04419     PIO_RESOURCE_REQUIREMENTS_LIST ioResReqList;
04420     ULONG count = 0, size, i, j;
04421     PCM_FULL_RESOURCE_DESCRIPTOR cmFullDesc;
04422     PCM_PARTIAL_RESOURCE_DESCRIPTOR cmPartDesc;
04423     PIO_RESOURCE_DESCRIPTOR ioDesc;
04424 
04425     <span class="comment">//</span>
04426     <span class="comment">// First determine number of descriptors required.</span>
04427     <span class="comment">//</span>
04428 
04429     cmFullDesc = &amp;CmResourceList-&gt;List[0];
04430     <span class="keywordflow">for</span> (i = 0; i &lt; CmResourceList-&gt;Count; i++) {
04431         count += cmFullDesc-&gt;PartialResourceList.Count;
04432         cmPartDesc = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
04433         <span class="keywordflow">for</span> (j = 0; j &lt; cmFullDesc-&gt;PartialResourceList.Count; j++) {
04434             size = 0;
04435             <span class="keywordflow">switch</span> (cmPartDesc-&gt;Type) {
04436             <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
04437                  size = cmPartDesc-&gt;u.DeviceSpecificData.DataSize;
04438                  count--;
04439                  <span class="keywordflow">break</span>;
04440             }
04441             cmPartDesc++;
04442             cmPartDesc = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmPartDesc + size);
04443         }
04444         cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmPartDesc;
04445     }
04446 
04447     <span class="keywordflow">if</span> (count == 0) {
04448         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04449     }
04450 
04451     <span class="comment">//</span>
04452     <span class="comment">// Count the extra descriptors for InterfaceType and BusNumber information.</span>
04453     <span class="comment">//</span>
04454 
04455     count += CmResourceList-&gt;Count - 1;
04456 
04457     <span class="comment">//</span>
04458     <span class="comment">// Allocate heap space for IO RESOURCE REQUIREMENTS LIST</span>
04459     <span class="comment">//</span>
04460 
04461     count++;           <span class="comment">// add one for CmResourceTypeConfigData</span>
04462     ioResReqList = (PIO_RESOURCE_REQUIREMENTS_LIST)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
04463                        <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
04464                        <span class="keyword">sizeof</span>(IO_RESOURCE_REQUIREMENTS_LIST) +
04465                            count * <span class="keyword">sizeof</span>(IO_RESOURCE_DESCRIPTOR)
04466                        );
04467     <span class="keywordflow">if</span> (!ioResReqList) {
04468         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04469     }
04470 
04471     <span class="comment">//</span>
04472     <span class="comment">// Parse the cm resource descriptor and build its corresponding IO resource descriptor</span>
04473     <span class="comment">//</span>
04474 
04475     ioResReqList-&gt;InterfaceType = CmResourceList-&gt;List[0].InterfaceType;
04476     ioResReqList-&gt;BusNumber = CmResourceList-&gt;List[0].BusNumber;
04477     ioResReqList-&gt;SlotNumber = SlotNumber;
04478     ioResReqList-&gt;Reserved[0] = 0;
04479     ioResReqList-&gt;Reserved[1] = 0;
04480     ioResReqList-&gt;Reserved[2] = 0;
04481     ioResReqList-&gt;AlternativeLists = 1;
04482     ioResReqList-&gt;List[0].Version = 1;
04483     ioResReqList-&gt;List[0].Revision = 1;
04484     ioResReqList-&gt;List[0].Count = count;
04485 
04486     <span class="comment">//</span>
04487     <span class="comment">// Generate a CmResourceTypeConfigData descriptor</span>
04488     <span class="comment">//</span>
04489 
04490     ioDesc = &amp;ioResReqList-&gt;List[0].Descriptors[0];
04491     ioDesc-&gt;Option = IO_RESOURCE_PREFERRED;
04492     ioDesc-&gt;Type = CmResourceTypeConfigData;
04493     ioDesc-&gt;ShareDisposition = CmResourceShareShared;
04494     ioDesc-&gt;Flags = 0;
04495     ioDesc-&gt;Spare1 = 0;
04496     ioDesc-&gt;Spare2 = 0;
04497     ioDesc-&gt;u.ConfigData.Priority = Priority;
04498     ioDesc++;
04499 
04500     cmFullDesc = &amp;CmResourceList-&gt;List[0];
04501     <span class="keywordflow">for</span> (i = 0; i &lt; CmResourceList-&gt;Count; i++) {
04502         <span class="keywordflow">if</span> (i != 0) {
04503 
04504             <span class="comment">//</span>
04505             <span class="comment">// Set up descriptor to remember the InterfaceType and BusNumber.</span>
04506             <span class="comment">//</span>
04507 
04508             ioDesc-&gt;Option = IO_RESOURCE_PREFERRED;
04509             ioDesc-&gt;Type = <a class="code" href="../../d9/d0/pnpiop_8h.html#a74">CmResourceTypeReserved</a>;
04510             ioDesc-&gt;ShareDisposition = CmResourceShareUndetermined;
04511             ioDesc-&gt;Flags = 0;
04512             ioDesc-&gt;Spare1 = 0;
04513             ioDesc-&gt;Spare2 = 0;
04514             <span class="keywordflow">if</span> (cmFullDesc-&gt;InterfaceType == InterfaceTypeUndefined) {
04515                 ioDesc-&gt;u.DevicePrivate.Data[0] = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
04516             } <span class="keywordflow">else</span> {
04517                 ioDesc-&gt;u.DevicePrivate.Data[0] = cmFullDesc-&gt;InterfaceType;
04518             }
04519             ioDesc-&gt;u.DevicePrivate.Data[1] = cmFullDesc-&gt;BusNumber;
04520             ioDesc-&gt;u.DevicePrivate.Data[2] = 0;
04521             ioDesc++;
04522         }
04523         cmPartDesc = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
04524         <span class="keywordflow">for</span> (j = 0; j &lt; cmFullDesc-&gt;PartialResourceList.Count; j++) {
04525             ioDesc-&gt;Option = IO_RESOURCE_PREFERRED;
04526             ioDesc-&gt;Type = cmPartDesc-&gt;Type;
04527             ioDesc-&gt;ShareDisposition = cmPartDesc-&gt;ShareDisposition;
04528             ioDesc-&gt;Flags = cmPartDesc-&gt;Flags;
04529             ioDesc-&gt;Spare1 = 0;
04530             ioDesc-&gt;Spare2 = 0;
04531 
04532             size = 0;
04533             <span class="keywordflow">switch</span> (cmPartDesc-&gt;Type) {
04534             <span class="keywordflow">case</span> CmResourceTypePort:
04535                  ioDesc-&gt;u.Port.MinimumAddress = cmPartDesc-&gt;u.Port.Start;
04536                  ioDesc-&gt;u.Port.MaximumAddress.QuadPart = cmPartDesc-&gt;u.Port.Start.QuadPart +
04537                                                              cmPartDesc-&gt;u.Port.Length - 1;
04538                  ioDesc-&gt;u.Port.Alignment = 1;
04539                  ioDesc-&gt;u.Port.Length = cmPartDesc-&gt;u.Port.Length;
04540                  ioDesc++;
04541                  <span class="keywordflow">break</span>;
04542             <span class="keywordflow">case</span> CmResourceTypeInterrupt:
04543 <span class="preprocessor">#if defined(_X86_)</span>
04544 <span class="preprocessor"></span>                ioDesc-&gt;u.Interrupt.MinimumVector = ioDesc-&gt;u.Interrupt.MaximumVector =
04545                    cmPartDesc-&gt;u.Interrupt.Level;
04546 <span class="preprocessor">#else</span>
04547 <span class="preprocessor"></span>                 ioDesc-&gt;u.Interrupt.MinimumVector = ioDesc-&gt;u.Interrupt.MaximumVector =
04548                     cmPartDesc-&gt;u.Interrupt.Vector;
04549 <span class="preprocessor">#endif</span>
04550 <span class="preprocessor"></span>                 ioDesc++;
04551                  <span class="keywordflow">break</span>;
04552             <span class="keywordflow">case</span> CmResourceTypeMemory:
04553                  ioDesc-&gt;u.Memory.MinimumAddress = cmPartDesc-&gt;u.Memory.Start;
04554                  ioDesc-&gt;u.Memory.MaximumAddress.QuadPart = cmPartDesc-&gt;u.Memory.Start.QuadPart +
04555                                                                cmPartDesc-&gt;u.Memory.Length - 1;
04556                  ioDesc-&gt;u.Memory.Alignment = 1;
04557                  ioDesc-&gt;u.Memory.Length = cmPartDesc-&gt;u.Memory.Length;
04558                  ioDesc++;
04559                  <span class="keywordflow">break</span>;
04560             <span class="keywordflow">case</span> CmResourceTypeDma:
04561                  ioDesc-&gt;u.Dma.MinimumChannel = cmPartDesc-&gt;u.Dma.Channel;
04562                  ioDesc-&gt;u.Dma.MaximumChannel = cmPartDesc-&gt;u.Dma.Channel;
04563                  ioDesc++;
04564                  <span class="keywordflow">break</span>;
04565             <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
04566                  size = cmPartDesc-&gt;u.DeviceSpecificData.DataSize;
04567                  <span class="keywordflow">break</span>;
04568             <span class="keywordflow">case</span> CmResourceTypeBusNumber:
04569                  ioDesc-&gt;u.BusNumber.MinBusNumber = cmPartDesc-&gt;u.BusNumber.Start;
04570                  ioDesc-&gt;u.BusNumber.MaxBusNumber = cmPartDesc-&gt;u.BusNumber.Start +
04571                                                     cmPartDesc-&gt;u.BusNumber.Length - 1;
04572                  ioDesc-&gt;u.BusNumber.Length = cmPartDesc-&gt;u.BusNumber.Length;
04573                  ioDesc++;
04574                  <span class="keywordflow">break</span>;
04575             <span class="keywordflow">default</span>:
04576                  ioDesc-&gt;u.DevicePrivate.Data[0] = cmPartDesc-&gt;u.DevicePrivate.Data[0];
04577                  ioDesc-&gt;u.DevicePrivate.Data[1] = cmPartDesc-&gt;u.DevicePrivate.Data[1];
04578                  ioDesc-&gt;u.DevicePrivate.Data[2] = cmPartDesc-&gt;u.DevicePrivate.Data[2];
04579                  ioDesc++;
04580                  <span class="keywordflow">break</span>;
04581             }
04582             cmPartDesc++;
04583             cmPartDesc = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmPartDesc + size);
04584         }
04585         cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmPartDesc;
04586     }
04587     ioResReqList-&gt;ListSize = (ULONG)((ULONG_PTR)ioDesc - (ULONG_PTR)ioResReqList);
04588     <span class="keywordflow">return</span> ioResReqList;
04589 }
04590 
04591 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04592"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a31">04592</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a29">IopFilterResourceRequirementsList</a> (
04593     IN PIO_RESOURCE_REQUIREMENTS_LIST IoList,
04594     IN PCM_RESOURCE_LIST CmList,
04595     IN OUT PIO_RESOURCE_REQUIREMENTS_LIST *FilteredList,
04596     OUT PBOOLEAN ExactMatch
04597     )
04598 
04599 <span class="comment">/*++</span>
04600 <span class="comment"></span>
04601 <span class="comment">Routine Description:</span>
04602 <span class="comment"></span>
04603 <span class="comment">    This routines adjusts the input IoList based on input BootConfig.</span>
04604 <span class="comment"></span>
04605 <span class="comment"></span>
04606 <span class="comment">Arguments:</span>
04607 <span class="comment"></span>
04608 <span class="comment">    IoList - supplies the pointer to an IoResourceRequirementsList</span>
04609 <span class="comment"></span>
04610 <span class="comment">    CmList - supplies the pointer to a BootConfig.</span>
04611 <span class="comment"></span>
04612 <span class="comment">    FilteredList - Supplies a variable to receive the filtered resource</span>
04613 <span class="comment">             requirements list.</span>
04614 <span class="comment"></span>
04615 <span class="comment">Return Value:</span>
04616 <span class="comment"></span>
04617 <span class="comment">    A NTSTATUS code to indicate the result of the function.</span>
04618 <span class="comment"></span>
04619 <span class="comment">--*/</span>
04620 {
04621     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04622     PIO_RESOURCE_REQUIREMENTS_LIST ioList, newList;
04623     PIO_RESOURCE_LIST ioResourceList, newIoResourceList, selectedResourceList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04624     PIO_RESOURCE_DESCRIPTOR ioResourceDescriptor, ioResourceDescriptorEnd;
04625     PIO_RESOURCE_DESCRIPTOR newIoResourceDescriptor, configDataDescriptor;
04626     LONG ioResourceDescriptorCount = 0;
04627     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> version;
04628     PCM_FULL_RESOURCE_DESCRIPTOR cmFullDesc;
04629     PCM_PARTIAL_RESOURCE_DESCRIPTOR cmDescriptor;
04630     ULONG cmDescriptorCount = 0;
04631     ULONG size, i, j, oldCount, phase;
04632     LONG k, alternativeLists;
04633     BOOLEAN exactMatch;
04634 
04635     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04636 
04637     *FilteredList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04638     *ExactMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04639 
04640     <span class="comment">//</span>
04641     <span class="comment">// Make sure there is some resource requirements to be filtered.</span>
04642     <span class="comment">// If no, we will convert CmList/BootConfig to an IoResourceRequirementsList</span>
04643     <span class="comment">//</span>
04644 
04645     <span class="keywordflow">if</span> (IoList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || IoList-&gt;AlternativeLists == 0) {
04646         <span class="keywordflow">if</span> (CmList &amp;&amp; CmList-&gt;Count != 0) {
04647             *FilteredList = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a28">IopCmResourcesToIoResources</a> (0, CmList, LCPRI_BOOTCONFIG);
04648         }
04649         <span class="keywordflow">return</span> STATUS_SUCCESS;
04650     }
04651 
04652     <span class="comment">//</span>
04653     <span class="comment">// Make a copy of the Io Resource Requirements List</span>
04654     <span class="comment">//</span>
04655 
04656     ioList = (PIO_RESOURCE_REQUIREMENTS_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, IoList-&gt;ListSize);
04657     <span class="keywordflow">if</span> (ioList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04658         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
04659     }
04660 
04661     RtlMoveMemory(ioList, IoList, IoList-&gt;ListSize);
04662 
04663     <span class="comment">//</span>
04664     <span class="comment">// If there is no BootConfig, simply return the copy of the input Io list.</span>
04665     <span class="comment">//</span>
04666 
04667     <span class="keywordflow">if</span> (CmList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || CmList-&gt;Count == 0) {
04668         *FilteredList = ioList;
04669         <span class="keywordflow">return</span> STATUS_SUCCESS;
04670     }
04671 
04672     <span class="comment">//</span>
04673     <span class="comment">// First determine minimum number of descriptors required.</span>
04674     <span class="comment">//</span>
04675 
04676     cmFullDesc = &amp;CmList-&gt;List[0];
04677     <span class="keywordflow">for</span> (i = 0; i &lt; CmList-&gt;Count; i++) {
04678         cmDescriptorCount += cmFullDesc-&gt;PartialResourceList.Count;
04679         cmDescriptor = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
04680         <span class="keywordflow">for</span> (j = 0; j &lt; cmFullDesc-&gt;PartialResourceList.Count; j++) {
04681             size = 0;
04682             <span class="keywordflow">switch</span> (cmDescriptor-&gt;Type) {
04683             <span class="keywordflow">case</span> CmResourceTypeConfigData:
04684             <span class="keywordflow">case</span> CmResourceTypeDevicePrivate:
04685                  cmDescriptorCount--;
04686                  <span class="keywordflow">break</span>;
04687             <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
04688                  size = cmDescriptor-&gt;u.DeviceSpecificData.DataSize;
04689                  cmDescriptorCount--;
04690                  <span class="keywordflow">break</span>;
04691             <span class="keywordflow">default</span>:
04692 
04693                  <span class="comment">//</span>
04694                  <span class="comment">// Invalid cmresource list.  Ignore it and use io resources</span>
04695                  <span class="comment">//</span>
04696 
04697                  <span class="keywordflow">if</span> (cmDescriptor-&gt;Type == CmResourceTypeNull ||
04698                      cmDescriptor-&gt;Type &gt;= CmResourceTypeMaximum) {
04699                      cmDescriptorCount--;
04700                  }
04701             }
04702             cmDescriptor++;
04703             cmDescriptor = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmDescriptor + size);
04704         }
04705         cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmDescriptor;
04706     }
04707 
04708     <span class="keywordflow">if</span> (cmDescriptorCount == 0) {
04709         *FilteredList = ioList;
04710         <span class="keywordflow">return</span> STATUS_SUCCESS;
04711     }
04712 
04713     <span class="comment">//</span>
04714     <span class="comment">// cmDescriptorCount is the number of BootConfig Descriptors needs.</span>
04715     <span class="comment">//</span>
04716     <span class="comment">// For each IO list Alternative ...</span>
04717     <span class="comment">//</span>
04718 
04719     ioResourceList = ioList-&gt;List;
04720     k = ioList-&gt;AlternativeLists;
04721     <span class="keywordflow">while</span> (--k &gt;= 0) {
04722         ioResourceDescriptor = ioResourceList-&gt;Descriptors;
04723         ioResourceDescriptorEnd = ioResourceDescriptor + ioResourceList-&gt;Count;
04724         <span class="keywordflow">while</span> (ioResourceDescriptor &lt; ioResourceDescriptorEnd) {
04725             ioResourceDescriptor-&gt;Spare1 = 0;
04726             ioResourceDescriptor++;
04727         }
04728         ioResourceList = (PIO_RESOURCE_LIST) ioResourceDescriptorEnd;
04729     }
04730 
04731     ioResourceList = ioList-&gt;List;
04732     k = alternativeLists = ioList-&gt;AlternativeLists;
04733     <span class="keywordflow">while</span> (--k &gt;= 0) {
04734         version = ioResourceList-&gt;Version;
04735         <span class="keywordflow">if</span> (version == 0xffff) {  <span class="comment">// Convert bogus version to valid number</span>
04736             version = 1;
04737         }
04738 
04739         <span class="comment">//</span>
04740         <span class="comment">// We use Version field to store number of BootConfig found.</span>
04741         <span class="comment">// Count field to store new number of descriptor in the alternative list.</span>
04742         <span class="comment">//</span>
04743 
04744         ioResourceList-&gt;Version = 0;
04745         oldCount = ioResourceList-&gt;Count;
04746 
04747         ioResourceDescriptor = ioResourceList-&gt;Descriptors;
04748         ioResourceDescriptorEnd = ioResourceDescriptor + ioResourceList-&gt;Count;
04749 
04750         <span class="keywordflow">if</span> (ioResourceDescriptor == ioResourceDescriptorEnd) {
04751 
04752             <span class="comment">//</span>
04753             <span class="comment">// An alternative list with zero descriptor count</span>
04754             <span class="comment">//</span>
04755 
04756             ioResourceList-&gt;Version = 0xffff;  <span class="comment">// Mark it as invalid</span>
04757             ioList-&gt;AlternativeLists--;
04758             <span class="keywordflow">continue</span>;
04759         }
04760 
04761         exactMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04762 
04763         <span class="comment">//</span>
04764         <span class="comment">// For each Cm Resource descriptor ... except DevicePrivate and</span>
04765         <span class="comment">// DeviceSpecific...</span>
04766         <span class="comment">//</span>
04767 
04768         cmFullDesc = &amp;CmList-&gt;List[0];
04769         <span class="keywordflow">for</span> (i = 0; i &lt; CmList-&gt;Count; i++) {
04770             cmDescriptor = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
04771             <span class="keywordflow">for</span> (j = 0; j &lt; cmFullDesc-&gt;PartialResourceList.Count; j++) {
04772                 size = 0;
04773                 <span class="keywordflow">switch</span> (cmDescriptor-&gt;Type) {
04774                 <span class="keywordflow">case</span> CmResourceTypeDevicePrivate:
04775                      <span class="keywordflow">break</span>;
04776                 <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
04777                      size = cmDescriptor-&gt;u.DeviceSpecificData.DataSize;
04778                      <span class="keywordflow">break</span>;
04779                 <span class="keywordflow">default</span>:
04780                     <span class="keywordflow">if</span> (cmDescriptor-&gt;Type == CmResourceTypeNull ||
04781                         cmDescriptor-&gt;Type &gt;= CmResourceTypeMaximum) {
04782                         <span class="keywordflow">break</span>;
04783                     }
04784 
04785                     <span class="comment">//</span>
04786                     <span class="comment">// Check CmDescriptor against current Io Alternative list</span>
04787                     <span class="comment">//</span>
04788 
04789                     <span class="keywordflow">for</span> (phase = 0; phase &lt; 2; phase++) {
04790                         ioResourceDescriptor = ioResourceList-&gt;Descriptors;
04791                         <span class="keywordflow">while</span> (ioResourceDescriptor &lt; ioResourceDescriptorEnd) {
04792                             <span class="keywordflow">if</span> ((ioResourceDescriptor-&gt;Type == cmDescriptor-&gt;Type) &amp;&amp;
04793                                 (ioResourceDescriptor-&gt;Spare1 == 0)) {
04794                                 ULONGLONG min1, max1, min2, max2;
04795                                 ULONG len1 = 1, len2 = 1, align1, align2;
04796                                 UCHAR share1, share2;
04797 
04798                                 share2 = ioResourceDescriptor-&gt;ShareDisposition;
04799                                 share1 = cmDescriptor-&gt;ShareDisposition;
04800                                 <span class="keywordflow">if</span> ((share1 == CmResourceShareUndetermined) ||
04801                                     (share1 &gt; CmResourceShareShared)) {
04802                                     share1 = share2;
04803                                 }
04804                                 <span class="keywordflow">if</span> ((share2 == CmResourceShareUndetermined) ||
04805                                     (share2 &gt; CmResourceShareShared)) {
04806                                     share2 = share1;
04807                                 }
04808                                 align1 = align2 = 1;
04809 
04810                                 <span class="keywordflow">switch</span> (cmDescriptor-&gt;Type) {
04811                                 <span class="keywordflow">case</span> CmResourceTypePort:
04812                                 <span class="keywordflow">case</span> CmResourceTypeMemory:
04813                                     min1 = cmDescriptor-&gt;u.Port.Start.QuadPart;
04814                                     max1 = cmDescriptor-&gt;u.Port.Start.QuadPart + cmDescriptor-&gt;u.Port.Length - 1;
04815                                     len1 = cmDescriptor-&gt;u.Port.Length;
04816                                     min2 = ioResourceDescriptor-&gt;u.Port.MinimumAddress.QuadPart;
04817                                     max2 = ioResourceDescriptor-&gt;u.Port.MaximumAddress.QuadPart;
04818                                     len2 = ioResourceDescriptor-&gt;u.Port.Length;
04819                                     align2 = ioResourceDescriptor-&gt;u.Port.Alignment;
04820                                     <span class="keywordflow">break</span>;
04821                                 <span class="keywordflow">case</span> CmResourceTypeInterrupt:
04822                                     max1 = min1 = cmDescriptor-&gt;u.Interrupt.Vector;
04823                                     min2 = ioResourceDescriptor-&gt;u.Interrupt.MinimumVector;
04824                                     max2 = ioResourceDescriptor-&gt;u.Interrupt.MaximumVector;
04825                                     <span class="keywordflow">break</span>;
04826                                 <span class="keywordflow">case</span> CmResourceTypeDma:
04827                                     min1 = max1 =cmDescriptor-&gt;u.Dma.Channel;
04828                                     min2 = ioResourceDescriptor-&gt;u.Dma.MinimumChannel;
04829                                     max2 = ioResourceDescriptor-&gt;u.Dma.MaximumChannel;
04830                                     <span class="keywordflow">break</span>;
04831                                 <span class="keywordflow">case</span> CmResourceTypeBusNumber:
04832                                     min1 = cmDescriptor-&gt;u.BusNumber.Start;
04833                                     max1 = cmDescriptor-&gt;u.BusNumber.Start + cmDescriptor-&gt;u.BusNumber.Length - 1;
04834                                     len1 = cmDescriptor-&gt;u.BusNumber.Length;
04835                                     min2 = ioResourceDescriptor-&gt;u.BusNumber.MinBusNumber;
04836                                     max2 = ioResourceDescriptor-&gt;u.BusNumber.MaxBusNumber;
04837                                     len2 = ioResourceDescriptor-&gt;u.BusNumber.Length;
04838                                     <span class="keywordflow">break</span>;
04839                                 <span class="keywordflow">default</span>:
04840                                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
04841                                     <span class="keywordflow">break</span>;
04842                                 }
04843                                 <span class="keywordflow">if</span> (phase == 0) {
04844                                     <span class="keywordflow">if</span> (share1 == share2 &amp;&amp; min2 == min1 &amp;&amp; max2 &gt;= max1 &amp;&amp; len2 &gt;= len1) {
04845 
04846                                         <span class="comment">//</span>
04847                                         <span class="comment">// For phase 0 match, we want near exact match...</span>
04848                                         <span class="comment">//</span>
04849 
04850                                         <span class="keywordflow">if</span> (max2 != max1) {
04851                                             exactMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04852                                         }
04853                                         ioResourceList-&gt;Version++;
04854                                         ioResourceDescriptor-&gt;Spare1 = 0x80;
04855                                         <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE) {
04856                                             PIO_RESOURCE_DESCRIPTOR ioDesc;
04857 
04858                                             ioDesc = ioResourceDescriptor;
04859                                             ioDesc--;
04860                                             <span class="keywordflow">while</span> (ioDesc &gt;= ioResourceList-&gt;Descriptors) {
04861                                                 ioDesc-&gt;Type = CmResourceTypeNull;
04862                                                 ioResourceList-&gt;Count--;
04863                                                 <span class="keywordflow">if</span> (ioDesc-&gt;Option == IO_RESOURCE_ALTERNATIVE) {
04864                                                     ioDesc--;
04865                                                 } <span class="keywordflow">else</span> {
04866                                                     <span class="keywordflow">break</span>;
04867                                                 }
04868                                             }
04869                                         }
04870                                         ioResourceDescriptor-&gt;Option = IO_RESOURCE_PREFERRED;
04871                                         ioResourceDescriptor-&gt;Flags = cmDescriptor-&gt;Flags;
04872                                         <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Type == CmResourceTypePort ||
04873                                             ioResourceDescriptor-&gt;Type == CmResourceTypeMemory) {
04874                                             ioResourceDescriptor-&gt;u.Port.MinimumAddress.QuadPart = min1;
04875                                             ioResourceDescriptor-&gt;u.Port.MaximumAddress.QuadPart = min1 + len2 - 1;
04876                                             ioResourceDescriptor-&gt;u.Port.Alignment = 1;
04877                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Type == CmResourceTypeBusNumber) {
04878                                             ioResourceDescriptor-&gt;u.BusNumber.MinBusNumber = (ULONG)min1;
04879                                             ioResourceDescriptor-&gt;u.BusNumber.MaxBusNumber = (ULONG)(min1 + len2 - 1);
04880                                         }
04881                                         ioResourceDescriptor++;
04882                                         <span class="keywordflow">while</span> (ioResourceDescriptor &lt; ioResourceDescriptorEnd) {
04883                                             <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE) {
04884                                                 ioResourceDescriptor-&gt;Type = CmResourceTypeNull;
04885                                                 ioResourceDescriptor++;
04886                                                 ioResourceList-&gt;Count--;
04887                                             } <span class="keywordflow">else</span> {
04888                                                 <span class="keywordflow">break</span>;
04889                                             }
04890                                         }
04891                                         phase = 1;   <span class="comment">// skip phase 1</span>
04892                                         <span class="keywordflow">break</span>;
04893                                     } <span class="keywordflow">else</span> {
04894                                         ioResourceDescriptor++;
04895                                     }
04896                                 } <span class="keywordflow">else</span> {
04897                                     exactMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04898                                     <span class="keywordflow">if</span> (share1 == share2 &amp;&amp; min2 &lt;= min1 &amp;&amp; max2 &gt;= max1 &amp;&amp; len2 &gt;= len1 &amp;&amp;
04899                                         (min1 &amp; (align2 - 1)) == 0) {
04900 
04901                                         <span class="comment">//</span>
04902                                         <span class="comment">// Io range covers Cm range ... Change the Io range to what is specified</span>
04903                                         <span class="comment">// in BootConfig.</span>
04904                                         <span class="comment">//</span>
04905                                         <span class="comment">//</span>
04906 
04907                                         <span class="keywordflow">switch</span> (cmDescriptor-&gt;Type) {
04908                                         <span class="keywordflow">case</span> CmResourceTypePort:
04909                                         <span class="keywordflow">case</span> CmResourceTypeMemory:
04910                                             ioResourceDescriptor-&gt;u.Port.MinimumAddress.QuadPart = min1;
04911                                             ioResourceDescriptor-&gt;u.Port.MaximumAddress.QuadPart = min1 + len2 - 1;
04912                                             <span class="keywordflow">break</span>;
04913                                         <span class="keywordflow">case</span> CmResourceTypeInterrupt:
04914                                         <span class="keywordflow">case</span> CmResourceTypeDma:
04915                                             ioResourceDescriptor-&gt;u.Interrupt.MinimumVector = (ULONG)min1;
04916                                             ioResourceDescriptor-&gt;u.Interrupt.MaximumVector = (ULONG)max1;
04917                                             <span class="keywordflow">break</span>;
04918                                         <span class="keywordflow">case</span> CmResourceTypeBusNumber:
04919                                             ioResourceDescriptor-&gt;u.BusNumber.MinBusNumber = (ULONG)min1;
04920                                             ioResourceDescriptor-&gt;u.BusNumber.MaxBusNumber = (ULONG)(min1 + len2 - 1);
04921                                             <span class="keywordflow">break</span>;
04922                                         }
04923                                         ioResourceList-&gt;Version++;
04924                                         ioResourceDescriptor-&gt;Spare1 = 0x80;
04925                                         ioResourceDescriptor-&gt;Flags = cmDescriptor-&gt;Flags;
04926                                         <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE) {
04927                                             PIO_RESOURCE_DESCRIPTOR ioDesc;
04928 
04929                                             ioDesc = ioResourceDescriptor;
04930                                             ioDesc--;
04931                                             <span class="keywordflow">while</span> (ioDesc &gt;= ioResourceList-&gt;Descriptors) {
04932                                                 ioDesc-&gt;Type = CmResourceTypeNull;
04933                                                 ioResourceList-&gt;Count--;
04934                                                 <span class="keywordflow">if</span> (ioDesc-&gt;Option == IO_RESOURCE_ALTERNATIVE) {
04935                                                     ioDesc--;
04936                                                 } <span class="keywordflow">else</span> {
04937                                                     <span class="keywordflow">break</span>;
04938                                                 }
04939                                             }
04940                                         }
04941                                         ioResourceDescriptor-&gt;Option = IO_RESOURCE_PREFERRED;
04942                                         ioResourceDescriptor++;
04943                                         <span class="keywordflow">while</span> (ioResourceDescriptor &lt; ioResourceDescriptorEnd) {
04944                                             <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE) {
04945                                                 ioResourceDescriptor-&gt;Type = CmResourceTypeNull;
04946                                                 ioResourceList-&gt;Count--;
04947                                                 ioResourceDescriptor++;
04948                                             } <span class="keywordflow">else</span> {
04949                                                 <span class="keywordflow">break</span>;
04950                                             }
04951                                         }
04952                                         <span class="keywordflow">break</span>;
04953                                     } <span class="keywordflow">else</span> {
04954                                         ioResourceDescriptor++;
04955                                     }
04956                                 }
04957                             } <span class="keywordflow">else</span> {
04958                                 ioResourceDescriptor++;
04959                             }
04960                         } <span class="comment">// Don't add any instruction after this ...</span>
04961                     } <span class="comment">// phase</span>
04962                 } <span class="comment">// switch</span>
04963 
04964                 <span class="comment">//</span>
04965                 <span class="comment">// Move to next Cm Descriptor</span>
04966                 <span class="comment">//</span>
04967 
04968                 cmDescriptor++;
04969                 cmDescriptor = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmDescriptor + size);
04970             }
04971 
04972             <span class="comment">//</span>
04973             <span class="comment">// Move to next Cm List</span>
04974             <span class="comment">//</span>
04975 
04976             cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmDescriptor;
04977         }
04978 
04979         <span class="keywordflow">if</span> (ioResourceList-&gt;Version != (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)cmDescriptorCount) {
04980 
04981             <span class="comment">//</span>
04982             <span class="comment">// If the current alternative list does not cover all the boot config</span>
04983             <span class="comment">// descriptors, make it as invalid.</span>
04984             <span class="comment">//</span>
04985 
04986             ioResourceList-&gt;Version = 0xffff;
04987             ioList-&gt;AlternativeLists--;
04988         } <span class="keywordflow">else</span> {
04989             <span class="keywordflow">if</span> ((ioResourceList-&gt;Count == cmDescriptorCount) ||
04990                 (ioResourceList-&gt;Count == (cmDescriptorCount + 1) &amp;&amp;
04991                  ioResourceList-&gt;Descriptors[0].Type == CmResourceTypeConfigData)) {
04992                 <span class="keywordflow">if</span> (selectedResourceList) {
04993                     ioResourceList-&gt;Version = 0xffff;
04994                     ioList-&gt;AlternativeLists--;
04995                 } <span class="keywordflow">else</span> {
04996                     selectedResourceList = ioResourceList;
04997                     ioResourceDescriptorCount += ioResourceList-&gt;Count;
04998                     ioResourceList-&gt;Version = version;
04999                     <span class="keywordflow">if</span> (exactMatch) {
05000                         *ExactMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05001                     }
05002                 }
05003             } <span class="keywordflow">else</span> {
05004                 ioResourceDescriptorCount += ioResourceList-&gt;Count;
05005                 ioResourceList-&gt;Version = version;
05006             }
05007         }
05008         ioResourceList-&gt;Count = oldCount;
05009 
05010         <span class="comment">//</span>
05011         <span class="comment">// Move to next Io alternative list.</span>
05012         <span class="comment">//</span>
05013 
05014         ioResourceList = (PIO_RESOURCE_LIST) ioResourceDescriptorEnd;
05015     }
05016 
05017     <span class="comment">//</span>
05018     <span class="comment">// If there is not any valid alternative, convert CmList to Io list.</span>
05019     <span class="comment">//</span>
05020 
05021     <span class="keywordflow">if</span> (ioList-&gt;AlternativeLists == 0) {
05022          *FilteredList = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a28">IopCmResourcesToIoResources</a> (0, CmList, LCPRI_BOOTCONFIG);
05023         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ioList);
05024         <span class="keywordflow">return</span> STATUS_SUCCESS;
05025     }
05026 
05027     <span class="comment">//</span>
05028     <span class="comment">// we have finished filtering the resource requirements list.  Now allocate memory</span>
05029     <span class="comment">// and rebuild a new list.</span>
05030     <span class="comment">//</span>
05031 
05032     size = <span class="keyword">sizeof</span>(IO_RESOURCE_REQUIREMENTS_LIST) +
05033                <span class="keyword">sizeof</span>(IO_RESOURCE_LIST) * (ioList-&gt;AlternativeLists - 1) +
05034                <span class="keyword">sizeof</span>(IO_RESOURCE_DESCRIPTOR) * (ioResourceDescriptorCount);
05035     newList = (PIO_RESOURCE_REQUIREMENTS_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, size);
05036     <span class="keywordflow">if</span> (newList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05037         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ioList);
05038         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05039     }
05040 
05041     <span class="comment">//</span>
05042     <span class="comment">// Walk through the io resource requirements list and pick up any valid descriptor.</span>
05043     <span class="comment">//</span>
05044 
05045     newList-&gt;ListSize = size;
05046     newList-&gt;InterfaceType = CmList-&gt;List-&gt;InterfaceType;
05047     newList-&gt;BusNumber = CmList-&gt;List-&gt;BusNumber;
05048     newList-&gt;SlotNumber = ioList-&gt;SlotNumber;
05049     <span class="keywordflow">if</span> (ioList-&gt;AlternativeLists &gt; 1) {
05050         *ExactMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05051     }
05052     newList-&gt;AlternativeLists = ioList-&gt;AlternativeLists;
05053     ioResourceList = ioList-&gt;List;
05054     newIoResourceList = newList-&gt;List;
05055     <span class="keywordflow">while</span> (--alternativeLists &gt;= 0) {
05056         ioResourceDescriptor = ioResourceList-&gt;Descriptors;
05057         ioResourceDescriptorEnd = ioResourceDescriptor + ioResourceList-&gt;Count;
05058         <span class="keywordflow">if</span> (ioResourceList-&gt;Version == 0xffff) {
05059             ioResourceList = (PIO_RESOURCE_LIST)ioResourceDescriptorEnd;
05060             <span class="keywordflow">continue</span>;
05061         }
05062         newIoResourceList-&gt;Version = ioResourceList-&gt;Version;
05063         newIoResourceList-&gt;Revision = ioResourceList-&gt;Revision;
05064 
05065         newIoResourceDescriptor = newIoResourceList-&gt;Descriptors;
05066         <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Type != CmResourceTypeConfigData) {
05067             newIoResourceDescriptor-&gt;Option = IO_RESOURCE_PREFERRED;
05068             newIoResourceDescriptor-&gt;Type = CmResourceTypeConfigData;
05069             newIoResourceDescriptor-&gt;ShareDisposition = CmResourceShareShared;
05070             newIoResourceDescriptor-&gt;Flags = 0;
05071             newIoResourceDescriptor-&gt;Spare1 = 0;
05072             newIoResourceDescriptor-&gt;Spare2 = 0;
05073             newIoResourceDescriptor-&gt;u.ConfigData.Priority = LCPRI_BOOTCONFIG;
05074             configDataDescriptor = newIoResourceDescriptor;
05075             newIoResourceDescriptor++;
05076         } <span class="keywordflow">else</span> {
05077             newList-&gt;ListSize -= <span class="keyword">sizeof</span>(IO_RESOURCE_DESCRIPTOR);
05078             configDataDescriptor = newIoResourceDescriptor;
05079         }
05080 
05081         <span class="keywordflow">while</span> (ioResourceDescriptor &lt; ioResourceDescriptorEnd) {
05082             <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Type != CmResourceTypeNull) {
05083                 *newIoResourceDescriptor = *ioResourceDescriptor;
05084                 newIoResourceDescriptor++;
05085             }
05086             ioResourceDescriptor++;
05087         }
05088         newIoResourceList-&gt;Count = (ULONG)(newIoResourceDescriptor - newIoResourceList-&gt;Descriptors);
05089 
05090         <span class="comment">//if (newIoResourceList-&gt;Count == (cmDescriptorCount + 1)) {</span>
05091         configDataDescriptor-&gt;u.ConfigData.Priority =  LCPRI_BOOTCONFIG;
05092         <span class="comment">//}</span>
05093 
05094         <span class="comment">//</span>
05095         <span class="comment">// Move to next Io alternative list.</span>
05096         <span class="comment">//</span>
05097 
05098         newIoResourceList = (PIO_RESOURCE_LIST) newIoResourceDescriptor;
05099         ioResourceList = (PIO_RESOURCE_LIST) ioResourceDescriptorEnd;
05100     }
05101     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((PUCHAR)newIoResourceList == ((PUCHAR)newList + newList-&gt;ListSize));
05102 
05103     *FilteredList = newList;
05104     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ioList);
05105     <span class="keywordflow">return</span> STATUS_SUCCESS;
05106 }
05107 
05108 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l05109"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a32">05109</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a30">IopMergeFilteredResourceRequirementsList</a> (
05110     IN PIO_RESOURCE_REQUIREMENTS_LIST IoList1,
05111     IN PIO_RESOURCE_REQUIREMENTS_LIST IoList2,
05112     IN OUT PIO_RESOURCE_REQUIREMENTS_LIST *MergedList
05113     )
05114 
05115 <span class="comment">/*++</span>
05116 <span class="comment"></span>
05117 <span class="comment">Routine Description:</span>
05118 <span class="comment"></span>
05119 <span class="comment">    This routines merges two IoLists into one.</span>
05120 <span class="comment"></span>
05121 <span class="comment"></span>
05122 <span class="comment">Arguments:</span>
05123 <span class="comment"></span>
05124 <span class="comment">    IoList1 - supplies the pointer to the first IoResourceRequirementsList</span>
05125 <span class="comment"></span>
05126 <span class="comment">    IoList2 - supplies the pointer to the second IoResourceRequirementsList</span>
05127 <span class="comment"></span>
05128 <span class="comment">    MergedList - Supplies a variable to receive the merged resource</span>
05129 <span class="comment">             requirements list.</span>
05130 <span class="comment"></span>
05131 <span class="comment">Return Value:</span>
05132 <span class="comment"></span>
05133 <span class="comment">    A NTSTATUS code to indicate the result of the function.</span>
05134 <span class="comment"></span>
05135 <span class="comment">--*/</span>
05136 {
05137     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
05138     PIO_RESOURCE_REQUIREMENTS_LIST ioList, newList;
05139     ULONG size;
05140     PUCHAR p;
05141 
05142     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05143 
05144     *MergedList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05145 
05146     <span class="comment">//</span>
05147     <span class="comment">// First handle the easy cases that both IO Lists are empty or any one of</span>
05148     <span class="comment">// them is empty.</span>
05149     <span class="comment">//</span>
05150 
05151     <span class="keywordflow">if</span> ((IoList1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || IoList1-&gt;AlternativeLists == 0) &amp;&amp;
05152         (IoList2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || IoList2-&gt;AlternativeLists == 0)) {
05153         <span class="keywordflow">return</span> status;
05154     }
05155     ioList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05156     <span class="keywordflow">if</span> (IoList1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || IoList1-&gt;AlternativeLists == 0) {
05157         ioList = IoList2;
05158     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IoList2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || IoList2-&gt;AlternativeLists == 0) {
05159         ioList = IoList1;
05160     }
05161     <span class="keywordflow">if</span> (ioList) {
05162         newList = (PIO_RESOURCE_REQUIREMENTS_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, ioList-&gt;ListSize);
05163         <span class="keywordflow">if</span> (newList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05164             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05165         }
05166         RtlMoveMemory(newList, ioList, ioList-&gt;ListSize);
05167         *MergedList = newList;
05168         <span class="keywordflow">return</span> status;
05169     }
05170 
05171     <span class="comment">//</span>
05172     <span class="comment">// Do real work...</span>
05173     <span class="comment">//</span>
05174 
05175     size = IoList1-&gt;ListSize + IoList2-&gt;ListSize - FIELD_OFFSET(IO_RESOURCE_REQUIREMENTS_LIST, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>);
05176     newList = (PIO_RESOURCE_REQUIREMENTS_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
05177                           <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
05178                           size
05179                           );
05180     <span class="keywordflow">if</span> (newList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05181         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05182     }
05183     p = (PUCHAR)newList;
05184     RtlMoveMemory(p, IoList1, IoList1-&gt;ListSize);
05185     p += IoList1-&gt;ListSize;
05186     RtlMoveMemory(p,
05187                   &amp;IoList2-&gt;List[0],
05188                   size - IoList1-&gt;ListSize
05189                   );
05190     newList-&gt;ListSize = size;
05191     newList-&gt;AlternativeLists += IoList2-&gt;AlternativeLists;
05192     *MergedList = newList;
05193     <span class="keywordflow">return</span> status;
05194 
05195 }
05196 
05197 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l05198"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a33">05198</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a31">IopMergeCmResourceLists</a> (
05199     IN PCM_RESOURCE_LIST List1,
05200     IN PCM_RESOURCE_LIST List2,
05201     IN OUT PCM_RESOURCE_LIST *MergedList
05202     )
05203 
05204 <span class="comment">/*++</span>
05205 <span class="comment"></span>
05206 <span class="comment">Routine Description:</span>
05207 <span class="comment"></span>
05208 <span class="comment">    This routines merges two IoLists into one.</span>
05209 <span class="comment"></span>
05210 <span class="comment"></span>
05211 <span class="comment">Arguments:</span>
05212 <span class="comment"></span>
05213 <span class="comment">    IoList1 - supplies the pointer to the first CmResourceList</span>
05214 <span class="comment"></span>
05215 <span class="comment">    IoList2 - supplies the pointer to the second CmResourceList</span>
05216 <span class="comment"></span>
05217 <span class="comment">    MergedList - Supplies a variable to receive the merged resource</span>
05218 <span class="comment">             list.</span>
05219 <span class="comment"></span>
05220 <span class="comment">Return Value:</span>
05221 <span class="comment"></span>
05222 <span class="comment">    A NTSTATUS code to indicate the result of the function.</span>
05223 <span class="comment"></span>
05224 <span class="comment">--*/</span>
05225 {
05226     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
05227     PCM_RESOURCE_LIST cmList, newList;
05228     ULONG size, size1, size2;
05229     PUCHAR p;
05230 
05231     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05232 
05233     *MergedList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05234 
05235     <span class="comment">//</span>
05236     <span class="comment">// First handle the easy cases that both IO Lists are empty or any one of</span>
05237     <span class="comment">// them is empty.</span>
05238     <span class="comment">//</span>
05239 
05240     <span class="keywordflow">if</span> ((List1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || List1-&gt;Count == 0) &amp;&amp;
05241         (List2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || List2-&gt;Count == 0)) {
05242         <span class="keywordflow">return</span> status;
05243     }
05244 
05245     cmList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05246     <span class="keywordflow">if</span> (List1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || List1-&gt;Count == 0) {
05247         cmList = List2;
05248     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (List2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || List2-&gt;Count == 0) {
05249         cmList = List1;
05250     }
05251     <span class="keywordflow">if</span> (cmList) {
05252         size =  <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(cmList);
05253         newList = (PCM_RESOURCE_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, size);
05254         <span class="keywordflow">if</span> (newList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05255             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05256         }
05257         RtlMoveMemory(newList, cmList, size);
05258         *MergedList = newList;
05259         <span class="keywordflow">return</span> status;
05260     }
05261 
05262     <span class="comment">//</span>
05263     <span class="comment">// Do real work...</span>
05264     <span class="comment">//</span>
05265 
05266     size1 =  <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(List1);
05267     size2 =  <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(List2);
05268     size = size1 + size2;
05269     newList = (PCM_RESOURCE_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
05270                           <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
05271                           size
05272                           );
05273     <span class="keywordflow">if</span> (newList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05274         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05275     }
05276     p = (PUCHAR)newList;
05277     RtlMoveMemory(p, List1, size1);
05278     p += size1;
05279     RtlMoveMemory(p,
05280                   &amp;List2-&gt;List[0],
05281                   size2 - FIELD_OFFSET(CM_RESOURCE_LIST, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>)
05282                   );
05283     newList-&gt;Count = List1-&gt;Count + List2-&gt;Count;
05284     *MergedList = newList;
05285     <span class="keywordflow">return</span> status;
05286 
05287 }
05288 
05289 BOOLEAN
<a name="l05290"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a34">05290</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a32">IopIsLegacyDriver</a> (
05291     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject
05292     )
05293 
05294 <span class="comment">/*++</span>
05295 <span class="comment"></span>
05296 <span class="comment">Routine Description:</span>
05297 <span class="comment"></span>
05298 <span class="comment">    This routine checks if the driver object specifies a legacy driver.</span>
05299 <span class="comment"></span>
05300 <span class="comment">Arguments:</span>
05301 <span class="comment"></span>
05302 <span class="comment">    DriverObject - supplies a pointer to the driver object to be checked.</span>
05303 <span class="comment"></span>
05304 <span class="comment">Return Value:</span>
05305 <span class="comment"></span>
05306 <span class="comment">    BOOLEAN</span>
05307 <span class="comment"></span>
05308 <span class="comment">--*/</span>
05309 
05310 {
05311 
05312     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05313 
05314     <span class="comment">//</span>
05315     <span class="comment">// If AddDevice entry is not empty it is a wdm driver</span>
05316     <span class="comment">//</span>
05317 
05318     <span class="keywordflow">if</span> (DriverObject-&gt;DriverExtension-&gt;AddDevice) {
05319         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05320     }
05321 
05322     <span class="comment">//</span>
05323     <span class="comment">// Else if LEGACY flag is set in the driver object, it's a legacy driver.</span>
05324     <span class="comment">//</span>
05325 
05326     <span class="keywordflow">if</span> (DriverObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a144">DRVO_LEGACY_DRIVER</a>) {
05327         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05328     } <span class="keywordflow">else</span> {
05329         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05330     }
05331 }
05332 
05333 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>
<a name="l05334"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a35">05334</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a33">IopGetGroupOrderIndex</a> (
05335     IN HANDLE ServiceHandle
05336     )
05337 
05338 <span class="comment">/*++</span>
05339 <span class="comment"></span>
05340 <span class="comment">Routine Description:</span>
05341 <span class="comment"></span>
05342 <span class="comment">    This routine reads the Group value of the service key, finds its position in the</span>
05343 <span class="comment">    ServiceOrderList.  If ServiceHandle is NULL or unrecognized group value, it returns</span>
05344 <span class="comment">    a value with max group order + 1.</span>
05345 <span class="comment">    if any.</span>
05346 <span class="comment"></span>
05347 <span class="comment">Parameters:</span>
05348 <span class="comment"></span>
05349 <span class="comment">    ServiceHandle - supplies a handle to the service key.</span>
05350 <span class="comment"></span>
05351 <span class="comment">Return Value:</span>
05352 <span class="comment"></span>
05353 <span class="comment">    group order index.</span>
05354 <span class="comment"></span>
05355 <span class="comment">--*/</span>
05356 
05357 {
05358     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05359     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
05360     UNICODE_STRING *groupTable, group;
05361     HANDLE handle;
05362     ULONG count, index;
05363 
05364     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05365 
05366     <span class="comment">//</span>
05367     <span class="comment">// Open System\CurrentControlSet\Control\ServiceOrderList</span>
05368     <span class="comment">//</span>
05369 
05370     PiWstrToUnicodeString(&amp;group, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\ServiceGroupOrder"</span>);
05371     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
05372                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05373                                    &amp;group,
05374                                    KEY_READ
05375                                    );
05376 
05377     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
05378         <span class="keywordflow">return</span> <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>;
05379     }
05380 
05381     <span class="comment">//</span>
05382     <span class="comment">// Read and build a unicode string array containing all the group names.</span>
05383     <span class="comment">//</span>
05384 
05385     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (handle,
05386                                   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"List"</span>,
05387                                   &amp;keyValueInformation);
05388     ZwClose(handle);
05389     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05390 
05391         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_MULTI_SZ) &amp;&amp;
05392             (keyValueInformation-&gt;DataLength != 0)) {
05393 
05394             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a13">IopRegMultiSzToUnicodeStrings</a>(keyValueInformation, &amp;groupTable, &amp;count);
05395         } <span class="keywordflow">else</span> {
05396             status = STATUS_UNSUCCESSFUL;
05397         }
05398         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
05399     }
05400 
05401     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05402         <span class="keywordflow">return</span> <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>;
05403     }
05404 
05405     <span class="keywordflow">if</span> (ServiceHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05406         <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a17">IopFreeUnicodeStringList</a>(groupTable, count);
05407         <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(count + 1);
05408     }
05409 
05410 
05411     <span class="comment">//</span>
05412     <span class="comment">// Read service key's Group value</span>
05413     <span class="comment">//</span>
05414 
05415     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (ServiceHandle,
05416                                   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Group"</span>,
05417                                   &amp;keyValueInformation);
05418     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05419 
05420         <span class="comment">//</span>
05421         <span class="comment">// Try to read what caller wants.</span>
05422         <span class="comment">//</span>
05423 
05424         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_SZ) &amp;&amp;
05425             (keyValueInformation-&gt;DataLength != 0)) {
05426             <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(&amp;group,
05427                                            (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
05428                                            keyValueInformation-&gt;DataLength
05429                                            );
05430         }
05431     } <span class="keywordflow">else</span> {
05432 
05433         <span class="comment">//</span>
05434         <span class="comment">// If we failed to read the Group value, or no Group value...</span>
05435         <span class="comment">//</span>
05436 
05437         <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a17">IopFreeUnicodeStringList</a>(groupTable, count);
05438         <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)count;
05439     }
05440 
05441     index = 0;
05442     <span class="keywordflow">for</span> (index = 0; index &lt; count; index++) {
05443         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;group, &amp;groupTable[index], <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
05444             <span class="keywordflow">break</span>;
05445         }
05446     }
05447     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
05448     <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a17">IopFreeUnicodeStringList</a>(groupTable, count);
05449     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)index;
05450 }
05451 
05452 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l05453"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a36">05453</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a34">IopDeleteLegacyKey</a>(
05454     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject
05455     )
05456 
05457 <span class="comment">/*++</span>
05458 <span class="comment"></span>
05459 <span class="comment">Routine Description:</span>
05460 <span class="comment"></span>
05461 <span class="comment">    This routine checks if the Legacy= value of the driver's legacy_xxx key</span>
05462 <span class="comment">    is one.  If yes, it deletes the Legacy key.</span>
05463 <span class="comment"></span>
05464 <span class="comment">Parameters:</span>
05465 <span class="comment"></span>
05466 <span class="comment">    DriverObject - supplies a pointer to the driver object.</span>
05467 <span class="comment"></span>
05468 <span class="comment">Return Value:</span>
05469 <span class="comment"></span>
05470 <span class="comment">    None.  If anything fails in this routine, the legacy key stays.</span>
05471 <span class="comment"></span>
05472 <span class="comment">--*/</span>
05473 
05474 {
05475     WCHAR buffer[100];
05476     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05477     UNICODE_STRING deviceName, instanceName, unicodeName, *serviceName;
05478     ULONG length;
05479     HANDLE handle, handle1, handlex, enumHandle;
05480     ULONG legacy;
05481     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
05482     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
05483     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
05484 
05485     serviceName = &amp;DriverObject-&gt;DriverExtension-&gt;ServiceKeyName;
05486 
05487     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
05488     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
05489 
05490     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;enumHandle,
05491                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05492                                    &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a23">CmRegistryMachineSystemCurrentControlSetEnumName</a>,
05493                                    KEY_ALL_ACCESS
05494                                    );
05495 
05496     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05497         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
05498     }
05499 
05500     length = _snwprintf(buffer, <span class="keyword">sizeof</span>(buffer) / <span class="keyword">sizeof</span>(WCHAR), <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ROOT\\LEGACY_%s"</span>, serviceName-&gt;Buffer);
05501     deviceName.MaximumLength = <span class="keyword">sizeof</span>(buffer);
05502     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(length &lt;= <span class="keyword">sizeof</span>(buffer) - 10);
05503     deviceName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(length * <span class="keyword">sizeof</span>(WCHAR));
05504     deviceName.Buffer = buffer;
05505 
05506     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle1,
05507                                    enumHandle,
05508                                    &amp;deviceName,
05509                                    KEY_ALL_ACCESS
05510                                    );
05511 
05512     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05513 
05514         deviceName.Buffer[deviceName.Length / <span class="keyword">sizeof</span>(WCHAR)] =
05515                    OBJ_NAME_PATH_SEPARATOR;
05516         deviceName.Length += <span class="keyword">sizeof</span>(WCHAR);
05517         PiUlongToInstanceKeyUnicodeString(
05518                                 &amp;instanceName,
05519                                 buffer + deviceName.Length / <span class="keyword">sizeof</span>(WCHAR),
05520                                 <span class="keyword">sizeof</span>(buffer) - deviceName.Length,
05521                                 0
05522                                 );
05523         deviceName.Length += instanceName.Length;
05524 
05525 
05526         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
05527                                        handle1,
05528                                        &amp;instanceName,
05529                                        KEY_ALL_ACCESS
05530                                        );
05531         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05532             legacy = 1;
05533             status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (handle,
05534                                           REGSTR_VALUE_LEGACY,
05535                                           &amp;keyValueInformation);
05536             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05537                 <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
05538                     (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
05539                     legacy = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
05540                 }
05541                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
05542             }
05543             <span class="keywordflow">if</span> (legacy != 0) {
05544 
05545                 <span class="comment">//</span>
05546                 <span class="comment">// We also want to delete the madeup device node</span>
05547                 <span class="comment">//</span>
05548 
05549                 deviceObject = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a>(handle, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05550                 <span class="keywordflow">if</span> (deviceObject) {
05551 
05552                     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> devNodex, devNodey;
05553 
05554                     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
05555                     <span class="keywordflow">if</span> (deviceNode != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>)) {
05556 
05557                         <span class="comment">//</span>
05558                         <span class="comment">// Now mark this one deleted.</span>
05559                         <span class="comment">//</span>
05560                         <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(deviceNode)) {
05561                             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>;
05562                             <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_DEVICE_NOT_THERE);
05563                         }
05564 
05565                         <span class="comment">//</span>
05566                         <span class="comment">// This is actually doing nothing because DeviceNode-&gt;ResourceList is NULL.</span>
05567                         <span class="comment">//</span>
05568 
05569                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a279">IopReleaseDeviceResources</a>(deviceNode, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05570                         devNodex = deviceNode;
05571                         <span class="keywordflow">while</span> (devNodex) {
05572                             devNodey = devNodex;
05573                             devNodex = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)devNodey-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o34">OverUsed2</a>.NextResourceDeviceNode;
05574                             devNodey-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o34">OverUsed2</a>.NextResourceDeviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05575                             devNodey-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o32">OverUsed1</a>.LegacyDeviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05576                         }
05577 
05578                         deviceNode-&gt;Flags &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>;  <span class="comment">// remove its boot config if any</span>
05579                         <a class="code" href="../../d4/d6/iosubs_8c.html#a55">IoDeleteDevice</a>(deviceObject);
05580                     }
05581                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceObject);  <span class="comment">// added via IopDeviceObjectFromDeviceInstance</span>
05582                 }
05583 
05584                 PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_CONTROL);
05585                 status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handlex,
05586                                                handle,
05587                                                &amp;unicodeName,
05588                                                KEY_ALL_ACCESS
05589                                                );
05590                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05591                     ZwDeleteKey(handlex);
05592                 }
05593                 PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_LOG_CONF);
05594                 status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handlex,
05595                                                handle,
05596                                                &amp;unicodeName,
05597                                                KEY_ALL_ACCESS
05598                                                );
05599                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05600                     ZwDeleteKey(handlex);
05601                 }
05602 
05603                 ZwClose(enumHandle);
05604 
05605                 <span class="comment">//</span>
05606                 <span class="comment">// We need to call IopCleanupDeviceRegistryValue even we are going to</span>
05607                 <span class="comment">// delete it.  Because, it also cleans up related value names in other</span>
05608                 <span class="comment">// keys.</span>
05609                 <span class="comment">//</span>
05610 
05611                 <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a25">IopCleanupDeviceRegistryValues</a>(&amp;deviceName, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05612                 ZwDeleteKey(handle);
05613                 ZwDeleteKey(handle1);
05614             } <span class="keywordflow">else</span> {
05615                 ZwClose(handle);
05616                 ZwClose(handle1);
05617                 ZwClose(enumHandle);
05618             }
05619         } <span class="keywordflow">else</span> {
05620             ZwClose(handle1);
05621             ZwClose(enumHandle);
05622         }
05623     } <span class="keywordflow">else</span> {
05624         ZwClose(enumHandle);
05625     }
05626 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
05627     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
05628     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
05629     <span class="keywordflow">return</span>;
05630 }
05631 
05632 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l05633"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a37">05633</a> <a class="code" href="../../d9/d1/pnpsubs_8c.html#a37">IopDeviceNodeCapabilitiesToRegistry</a> (
05634     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode
05635     )
05636 
05637 <span class="comment">/*++</span>
05638 <span class="comment"></span>
05639 <span class="comment">Routine Description:</span>
05640 <span class="comment"></span>
05641 <span class="comment">    Called after start to refresh Capability flags</span>
05642 <span class="comment"></span>
05643 <span class="comment">Arguments:</span>
05644 <span class="comment"></span>
05645 <span class="comment">    DeviceObject - supplies a pointer to a device object whose registry</span>
05646 <span class="comment">        values are to be updated.</span>
05647 <span class="comment"></span>
05648 <span class="comment">Return Value:</span>
05649 <span class="comment"></span>
05650 <span class="comment">    status</span>
05651 <span class="comment"></span>
05652 <span class="comment">--*/</span>
05653 
05654 {
05655     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05656     <a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">DEVICE_CAPABILITIES</a> capabilities;
05657 
05658     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05659 
05660     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05661 
05662     <span class="comment">//</span>
05663     <span class="comment">// Open the device instance key</span>
05664     <span class="comment">//</span>
05665 
05666     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a330">IopQueryDeviceCapabilities</a>(DeviceNode, &amp;capabilities);
05667     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05668         <span class="keywordflow">return</span> status;
05669     }
05670 
05671     <span class="keywordflow">return</span> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a35">IopDeviceCapabilitiesToRegistry</a>(DeviceNode,&amp;capabilities);
05672 }
05673 
05674 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l05675"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a38">05675</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a35">IopDeviceCapabilitiesToRegistry</a> (
05676     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
05677     IN <a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">PDEVICE_CAPABILITIES</a> Capabilities
05678     )
05679 
05680 <span class="comment">/*++</span>
05681 <span class="comment"></span>
05682 <span class="comment">Routine Description:</span>
05683 <span class="comment"></span>
05684 <span class="comment">    This routine updates device capabilities, must be called after a valid device instance key has been created</span>
05685 <span class="comment">    Called directly from IopProcessNewDeviceNode, and indirecly via IopDeviceNodeCapabilitiesToRegistry</span>
05686 <span class="comment">    after device is started.</span>
05687 <span class="comment"></span>
05688 <span class="comment">Arguments:</span>
05689 <span class="comment"></span>
05690 <span class="comment">    DeviceObject - supplies a pointer to a device object whose registry</span>
05691 <span class="comment">        values are to be updated.</span>
05692 <span class="comment"></span>
05693 <span class="comment">Return Value:</span>
05694 <span class="comment"></span>
05695 <span class="comment">    status</span>
05696 <span class="comment"></span>
05697 <span class="comment">--*/</span>
05698 
05699 {
05700     HANDLE handle;
05701     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05702     UNICODE_STRING unicodeName;
05703     ULONG tmpValue;
05704 
05705     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05706 
05707     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05708     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Capabilities != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05709 
05710     <span class="comment">//</span>
05711     <span class="comment">// Open the device instance key</span>
05712     <span class="comment">//</span>
05713     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">IopDeviceObjectToDeviceInstance</a>(DeviceNode-&gt;PhysicalDeviceObject, &amp;handle, KEY_ALL_ACCESS);
05714     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05715         <span class="keywordflow">return</span> status;
05716     }
05717 
05718     <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a>) {
05719         Capabilities-&gt;SurpriseRemovalOK = 0;
05720     }
05721 
05722     <span class="comment">//</span>
05723     <span class="comment">// Assert the bit fields are completely contained in a ULONG. This is a</span>
05724     <span class="comment">// public structure, so it shouldn't ever change, but paranoia is a good</span>
05725     <span class="comment">// thing...</span>
05726     <span class="comment">//</span>
05727     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((FIELD_OFFSET(<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">DEVICE_CAPABILITIES</a>, Address) -
05728             FIELD_OFFSET(<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">DEVICE_CAPABILITIES</a>, <a class="code" href="../../d2/d5/editreg_8c.html#a50">Version</a>) -
05729             <a class="code" href="../../d9/d0/pnpiop_8h.html#a100">FIELD_SIZE</a>  (<a class="code" href="../../d0/d5/io_8h.html#a365">DEVICE_CAPABILITIES</a>, <a class="code" href="../../d2/d5/editreg_8c.html#a50">Version</a>)) == <span class="keyword">sizeof</span>(ULONG));
05730 
05731     DeviceNode-&gt;CapabilityFlags =
05732         *((PULONG) (((PUCHAR) Capabilities) +
05733         FIELD_OFFSET(<a class="code" href="../../d0/d5/io_8h.html#a365">DEVICE_CAPABILITIES</a>, <a class="code" href="../../d2/d5/editreg_8c.html#a50">Version</a>) +
05734         <a class="code" href="../../d9/d0/pnpiop_8h.html#a100">FIELD_SIZE</a>(<a class="code" href="../../d0/d5/io_8h.html#a365">DEVICE_CAPABILITIES</a>, <a class="code" href="../../d2/d5/editreg_8c.html#a50">Version</a>)));
05735 
05736     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_CAPABILITIES);
05737     tmpValue = (Capabilities-&gt;LockSupported)          |
05738                (Capabilities-&gt;EjectSupported    &lt;&lt; 1) |
05739                (Capabilities-&gt;WarmEjectSupported&lt;&lt; 1) |
05740                (Capabilities-&gt;Removable         &lt;&lt; 2) |
05741                (Capabilities-&gt;DockDevice        &lt;&lt; 3) |
05742                (Capabilities-&gt;UniqueID          &lt;&lt; 4) |
05743                (Capabilities-&gt;SilentInstall     &lt;&lt; 5) |
05744                (Capabilities-&gt;RawDeviceOK       &lt;&lt; 6) |
05745                (Capabilities-&gt;SurpriseRemovalOK &lt;&lt; 7) |
05746                (Capabilities-&gt;HardwareDisabled  &lt;&lt; 8) |
05747                (Capabilities-&gt;NonDynamic        &lt;&lt; 9);
05748 
05749     status = ZwSetValueKey(
05750                   handle,
05751                   &amp;unicodeName,
05752                   <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
05753                   REG_DWORD,
05754                   &amp;tmpValue,
05755                   <span class="keyword">sizeof</span>(tmpValue)
05756                   );
05757 
05758     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_UI_NUMBER);
05759     tmpValue = Capabilities-&gt;UINumber;
05760     <span class="keywordflow">if</span>(tmpValue != (ULONG)-1) {
05761         ZwSetValueKey(handle,
05762                       &amp;unicodeName,
05763                       <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
05764                       REG_DWORD,
05765                       &amp;tmpValue,
05766                       <span class="keyword">sizeof</span>(tmpValue)
05767                       );
05768     } <span class="keywordflow">else</span> {
05769         ZwDeleteValueKey(handle, &amp;unicodeName);
05770     }
05771 
05772     ZwClose(handle);
05773     <span class="keywordflow">return</span> status;
05774 }
05775 
05776 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l05777"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a39">05777</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a36">IopRestartDeviceNode</a>(
05778     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode
05779     )
05780 {
05781     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05782 
05783     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(DeviceNode) ||
05784             (DeviceNode-&gt;Flags &amp; (<a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a> |
05785                                  <a class="code" href="../../d9/d0/pnpiop_8h.html#a11">DNF_ADDED</a> |
05786                                  <a class="code" href="../../d9/d0/pnpiop_8h.html#a18">DNF_RESOURCE_ASSIGNED</a> |
05787                                  <a class="code" href="../../d9/d0/pnpiop_8h.html#a19">DNF_RESOURCE_REPORTED</a>)) ||
05788             (DeviceNode-&gt;UserFlags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a37">DNUF_WILL_BE_REMOVED</a>)));
05789 
05790     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a>);
05791 
05792     <span class="keywordflow">if</span> (!(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a>)) {
05793         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
05794     }
05795 
05796     DeviceNode-&gt;UserFlags &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a39">DNUF_NEED_RESTART</a>;
05797 
05798 <span class="preprocessor">#if DBG_SCOPE</span>
05799 <span class="preprocessor"></span>    DeviceNode-&gt;FailureStatus = 0;
05800     <span class="keywordflow">if</span> (DeviceNode-&gt;PreviousResourceList) {
05801         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;PreviousResourceList);
05802         DeviceNode-&gt;PreviousResourceList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05803     }
05804     <span class="keywordflow">if</span> (DeviceNode-&gt;PreviousResourceRequirements) {
05805         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;PreviousResourceRequirements);
05806         DeviceNode-&gt;PreviousResourceRequirements = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05807     }
05808 <span class="preprocessor">#endif</span>
05809 <span class="preprocessor"></span>
05810     <span class="comment">//</span>
05811     <span class="comment">// Free any existing devnode strings so we can recreate them</span>
05812     <span class="comment">// during enumeration.</span>
05813     <span class="comment">//</span>
05814 
05815     <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a8">DNF_PROCESSED</a>) {
05816 
05817         DeviceNode-&gt;Flags &amp;= ~(<a class="code" href="../../d9/d0/pnpiop_8h.html#a8">DNF_PROCESSED</a> |
05818                                <a class="code" href="../../d9/d0/pnpiop_8h.html#a28">DNF_ENUMERATION_REQUEST_QUEUED</a> |
05819                                <a class="code" href="../../d9/d0/pnpiop_8h.html#a15">DNF_NO_RESOURCE_REQUIRED</a> |
05820                                <a class="code" href="../../d9/d0/pnpiop_8h.html#a20">DNF_RESOURCE_REQUIREMENTS_CHANGED</a>);
05821 
05822         <span class="keywordflow">if</span> (DeviceNode-&gt;ServiceName.Length != 0) {
05823             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;ServiceName.Buffer);
05824             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;DeviceNode-&gt;ServiceName, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05825         }
05826 
05827         <span class="keywordflow">if</span> (DeviceNode-&gt;ResourceRequirements != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05828             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;ResourceRequirements);
05829             DeviceNode-&gt;ResourceRequirements = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05830             DeviceNode-&gt;Flags &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a16">DNF_RESOURCE_REQUIREMENTS_NEED_FILTERED</a>;
05831         }
05832     }
05833 
05834     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode-&gt;ServiceName.Length == 0 &amp;&amp;
05835            DeviceNode-&gt;ServiceName.MaximumLength == 0 &amp;&amp;
05836            DeviceNode-&gt;ServiceName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05837 
05838     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(DeviceNode-&gt;Flags &amp;
05839            ~(<a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a> |
05840              <a class="code" href="../../d9/d0/pnpiop_8h.html#a13">DNF_BOOT_CONFIG_RESERVED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a15">DNF_NO_RESOURCE_REQUIRED</a>)));
05841 
05842     <span class="keywordflow">return</span> STATUS_SUCCESS;
05843 }
05844 
05845 BOOLEAN
<a name="l05846"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a40">05846</a> <a class="code" href="../../d9/d1/pnpsubs_8c.html#a40">IopDeleteKeyRecursiveCallback</a>(
05847     IN HANDLE KeyHandle,
05848     IN PUNICODE_STRING KeyName,
05849     IN OUT PVOID Context
05850     )
05851 <span class="comment">/*++</span>
05852 <span class="comment"></span>
05853 <span class="comment">Routine Description:</span>
05854 <span class="comment"></span>
05855 <span class="comment">    This is a callback routine to IopApplyFunctionToSubkeys, that gets called</span>
05856 <span class="comment">    through IopDeleteKeyRecursive.  This routine prepares a given key for</span>
05857 <span class="comment">    deletion by deleting all of its subkeys.  This is done, using</span>
05858 <span class="comment">    IopApplyFunctionToSubkeys, with instructions to delete all enumerated</span>
05859 <span class="comment">    subkeys, and calling this routine as a callback routine, if necessary, until</span>
05860 <span class="comment">    no subkeys remain.  KeyHandle can then be successfully deleted by the</span>
05861 <span class="comment">    caller.</span>
05862 <span class="comment"></span>
05863 <span class="comment">Arguments:</span>
05864 <span class="comment"></span>
05865 <span class="comment">    KeyHandle - Handle to a subkey that has been enumerated by</span>
05866 <span class="comment">        IopApplyFunctionToSubkeys.</span>
05867 <span class="comment"></span>
05868 <span class="comment">    KeyName - Name of the subkey whose handle is specified by KeyHandle.</span>
05869 <span class="comment"></span>
05870 <span class="comment">    Context - Supplies a pointer to user-defined data that will be passed</span>
05871 <span class="comment">        in to the callback routine at each subkey invocation.</span>
05872 <span class="comment"></span>
05873 <span class="comment">Return Value:</span>
05874 <span class="comment"></span>
05875 <span class="comment">    BOOLEAN that returns whether or not the given key can be safely deleted.</span>
05876 <span class="comment"></span>
05877 <span class="comment">--*/</span>
05878 {
05879     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
05880 
05881     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05882 
05883     UNREFERENCED_PARAMETER(<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>);
05884 
05885     <span class="comment">//</span>
05886     <span class="comment">// delete any subkeys, recursively if necessary</span>
05887     <span class="comment">//</span>
05888     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a12">IopApplyFunctionToSubKeys</a>(
05889         KeyHandle,
05890         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05891         KEY_ALL_ACCESS,
05892         <a class="code" href="../../d9/d0/pnpiop_8h.html#a90">FUNCTIONSUBKEY_FLAG_IGNORE_NON_CRITICAL_ERRORS</a> |
05893         <a class="code" href="../../d9/d0/pnpiop_8h.html#a91">FUNCTIONSUBKEY_FLAG_DELETE_SUBKEYS</a>,
05894         <a class="code" href="../../d9/d1/pnpsubs_8c.html#a40">IopDeleteKeyRecursiveCallback</a>,
05895         Context);
05896 
05897     *((<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> *)Context) = status;
05898     <span class="keywordflow">return</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
05899 }
05900 
05901 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l05902"></a><a class="code" href="../../d9/d1/pnpsubs_8c.html#a41">05902</a> <a class="code" href="../../d9/d1/pnpsubs_8c.html#a41">IopDeleteKeyRecursive</a>(
05903     IN HANDLE ParentKey OPTIONAL,
05904     IN PWCHAR KeyName
05905     )
05906 <span class="comment">/*++</span>
05907 <span class="comment"></span>
05908 <span class="comment">Routine Description:</span>
05909 <span class="comment"></span>
05910 <span class="comment">    Recursively deletes all subkeys of KeyName, then deletes KeyName.</span>
05911 <span class="comment"></span>
05912 <span class="comment">Arguments:</span>
05913 <span class="comment"></span>
05914 <span class="comment">    ParentKey - Handle to the parent key of KeyName.  If NULL then KeyName is</span>
05915 <span class="comment">        expected to start with \Registry.</span>
05916 <span class="comment"></span>
05917 <span class="comment">    KeyName - Name of subkey to delete, as a NULL terminated UNICODE string.</span>
05918 <span class="comment"></span>
05919 <span class="comment">Return Value:</span>
05920 <span class="comment"></span>
05921 <span class="comment">    STATUS_SUCCESS if no errors, otherwise the appropriate error.</span>
05922 <span class="comment"></span>
05923 <span class="comment">--*/</span>
05924 {
05925     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>       status = STATUS_SUCCESS;
05926     BOOLEAN        result;
05927     HANDLE         hKey;
05928     UNICODE_STRING unicodeKeyName;
05929 
05930     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05931 
05932     <span class="comment">//</span>
05933     <span class="comment">// Attempt to open the key name we were given</span>
05934     <span class="comment">//</span>
05935     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeKeyName, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>);
05936     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hKey,
05937                                    ParentKey,
05938                                    &amp;unicodeKeyName,
05939                                    KEY_ALL_ACCESS
05940                                    );
05941     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05942         <span class="comment">//</span>
05943         <span class="comment">// Recusively delete all subkeys</span>
05944         <span class="comment">//</span>
05945         result = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a40">IopDeleteKeyRecursiveCallback</a>(hKey,
05946                                                &amp;unicodeKeyName,
05947                                                (PVOID)&amp;status);
05948         <span class="keywordflow">if</span> (result) {
05949             <span class="comment">//</span>
05950             <span class="comment">// It is safe to delete this key</span>
05951             <span class="comment">//</span>
05952             status = ZwDeleteKey(hKey);
05953         }
05954         ZwClose(hKey);
05955     }
05956 
05957     <span class="keywordflow">return</span> status;
05958 }
05959 
05960 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:23 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
