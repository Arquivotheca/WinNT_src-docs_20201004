<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pnpirp.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pnpirp.c File Reference</h1><code>#include "<a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>"</code><br>

<p>
<a href="../../d1/d0/pnpirp_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html">_DEVICE_COMPLETION_CONTEXT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d2/struct__LOCK__MOUNTABLE__DEVICE__CONTEXT.html">_LOCK_MOUNTABLE_DEVICE_CONTEXT</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a0">PnpIrpStatusTracking</a>(<a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>, IrpCode, Device)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a1">HASH_UNICODE_STRING</a>(_pustr, _phash)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a2">MAX_PARENT_PREFIX</a>&nbsp;&nbsp;&nbsp;(8 + 8 + 8 + 2)</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html">_DEVICE_COMPLETION_CONTEXT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a5">DEVICE_COMPLETION_CONTEXT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html">_DEVICE_COMPLETION_CONTEXT</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a6">PDEVICE_COMPLETION_CONTEXT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d2/struct__LOCK__MOUNTABLE__DEVICE__CONTEXT.html">_LOCK_MOUNTABLE_DEVICE_CONTEXT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a7">LOCK_MOUNTABLE_DEVICE_CONTEXT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d2/struct__LOCK__MOUNTABLE__DEVICE__CONTEXT.html">_LOCK_MOUNTABLE_DEVICE_CONTEXT</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a8">PLOCK_MOUNTABLE_DEVICE_CONTEXT</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a9">IopAsynchronousCall</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> TopStackLocation, IN <a class="el" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html">PDEVICE_COMPLETION_CONTEXT</a> CompletionContext, IN PVOID CompletionRoutine)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a10">IopDeviceEjectComplete</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a11">IopDeviceStartComplete</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a12">IopDeviceRelationsComplete</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a13">IopFindMountableDevice</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a14">IopLockMountedDeviceForRemove</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN ULONG IrpMinorCode, OUT <a class="el" href="../../d7/d2/struct__LOCK__MOUNTABLE__DEVICE__CONTEXT.html">PLOCK_MOUNTABLE_DEVICE_CONTEXT</a> Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a15">IopUnlockMountedDeviceForRemove</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN ULONG IrpMinorCode, IN <a class="el" href="../../d7/d2/struct__LOCK__MOUNTABLE__DEVICE__CONTEXT.html">PLOCK_MOUNTABLE_DEVICE_CONTEXT</a> Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a16">IopFilterResourceRequirementsCall</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN PIO_RESOURCE_REQUIREMENTS_LIST ResReqList, OUT PVOID *Information)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a17">IopUncacheInterfaceInformation</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> TopStackLocation, OUT PVOID *Information)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a19">IopStartDevice</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a20">IopEjectDevice</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN OUT <a class="el" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html">PPENDING_RELATIONS_LIST_ENTRY</a> PendingEntry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a21">IopRemoveDevice</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> TargetDevice, IN ULONG IrpMinorCode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a22">IopQueryDeviceRelations</a> (IN <a class="el" href="../../d0/d5/io_8h.html#a358">DEVICE_RELATION_TYPE</a> Relations, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN BOOLEAN AsyncOk, OUT <a class="el" href="../../d0/d5/struct__DEVICE__RELATIONS.html">PDEVICE_RELATIONS</a> *DeviceRelations)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a23">IopQueryDeviceId</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, OUT PWCHAR *DeviceId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a24">IopQueryUniqueId</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, OUT PWCHAR *UniqueId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a25">IopMakeGloballyUniqueId</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN PWCHAR UniqueId, OUT PWCHAR *GloballyUniqueId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a26">IopQueryCompatibleIds</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d5/io_8h.html#a604">BUS_QUERY_ID_TYPE</a> IdType, OUT PWCHAR *CompatibleIds, OUT ULONG *Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a27">IopQueryDeviceResources</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN ULONG ResourceType, OUT PVOID *<a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>, OUT ULONG *Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a28">IopQueryResourceHandlerInterface</a> (IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a126">RESOURCE_HANDLER_TYPE</a> HandlerType, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN UCHAR ResourceType, IN OUT PVOID *Interface)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a29">IopQueryReconfiguration</a> (IN UCHAR Request, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a30">IopQueryLegacyBusInformation</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, OUT LPGUID InterfaceGuid, OPTIONAL OUT INTERFACE_TYPE *<a class="el" href="../../d6/d0/cmdat_8c.html#a4">InterfaceType</a>, OPTIONAL OUT ULONG *<a class="el" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a31">IopQueryPnpBusInformation</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, OUT LPGUID InterfaceGuid, OPTIONAL OUT INTERFACE_TYPE *<a class="el" href="../../d6/d0/cmdat_8c.html#a4">InterfaceType</a>, OPTIONAL OUT ULONG *<a class="el" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a32">IopQueryDeviceState</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a33">IopIncDisableableDepends</a> (IN OUT <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a34">IopDecDisableableDepends</a> (IN OUT <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a35">IopQueryDeviceSerialNumber</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, OUT PWCHAR *SerialNumber)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a36">IopQueryDockRemovalInterface</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN OUT PDOCK_INTERFACE *DockInterface)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a3">PnpIrpMask</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/pnpirp_8c.html#a4">IrpName</a> []</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a1" doxytag="pnpirp.c::HASH_UNICODE_STRING" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HASH_UNICODE_STRING          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_pustr,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>_phash&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                             \
    PWCHAR _p = (_pustr)-&gt;Buffer;                                           \
    PWCHAR _ep = _p + ((_pustr)-&gt;Length/<span class="keyword">sizeof</span>(WCHAR));                     \
    ULONG _chHolder =0;                                                     \
                                                                            \
    <span class="keywordflow">while</span>( _p &lt; _ep ) {                                                     \
        _chHolder = 37 * _chHolder + (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) (*_p++);                \
    }                                                                       \
                                                                            \
    *(_phash) = <a class="code" href="../../d4/d1/userk_8h.html#a259">abs</a>(314159269 * _chHolder) % 1000000007;                    \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00072">72</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01891">IopMakeGloballyUniqueId()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="pnpirp.c::MAX_PARENT_PREFIX" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MAX_PARENT_PREFIX&nbsp;&nbsp;&nbsp;(8 + 8 + 8 + 2)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00085">85</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01891">IopMakeGloballyUniqueId()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="pnpirp.c::PnpIrpStatusTracking" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PnpIrpStatusTracking          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IrpCode,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Device&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/pnpirp_8c.html#a3">PnpIrpMask</a> &amp; (1 &lt;&lt; IrpCode)) {                                   \
        <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) || <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {           \
            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" ++ %s Driver ( %wZ ) return status %08lx\n"</span>,      \
                     IrpName[IrpCode],                                   \
                     &amp;Device-&gt;DriverObject-&gt;DriverName,                  \
                     Status);                                            \
        }                                                                \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00026">26</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01496">IopDeviceRelationsComplete()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01370">IopDeviceStartComplete()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l03255">IopFilterResourceRequirementsCall()</a>, and <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a5" doxytag="pnpirp.c::DEVICE_COMPLETION_CONTEXT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html">_DEVICE_COMPLETION_CONTEXT</a>  <a class="el" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html">DEVICE_COMPLETION_CONTEXT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="pnpirp.c::LOCK_MOUNTABLE_DEVICE_CONTEXT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d2/struct__LOCK__MOUNTABLE__DEVICE__CONTEXT.html">_LOCK_MOUNTABLE_DEVICE_CONTEXT</a>  <a class="el" href="../../d7/d2/struct__LOCK__MOUNTABLE__DEVICE__CONTEXT.html">LOCK_MOUNTABLE_DEVICE_CONTEXT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="pnpirp.c::PDEVICE_COMPLETION_CONTEXT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html">_DEVICE_COMPLETION_CONTEXT</a> * <a class="el" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html">PDEVICE_COMPLETION_CONTEXT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01496">IopDeviceRelationsComplete()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01370">IopDeviceStartComplete()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01604">IopQueryDeviceRelations()</a>, and <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="pnpirp.c::PLOCK_MOUNTABLE_DEVICE_CONTEXT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d2/struct__LOCK__MOUNTABLE__DEVICE__CONTEXT.html">_LOCK_MOUNTABLE_DEVICE_CONTEXT</a> * <a class="el" href="../../d7/d2/struct__LOCK__MOUNTABLE__DEVICE__CONTEXT.html">PLOCK_MOUNTABLE_DEVICE_CONTEXT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a9" doxytag="pnpirp.c::IopAsynchronousCall" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopAsynchronousCall           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TopStackLocation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html">PDEVICE_COMPLETION_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CompletionContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>CompletionRoutine</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00262">262</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01072">_VPB::DeviceObject</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00652">IoAllocateIrp()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06786">IoGetAttachedDevice()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03913">IoSetCompletionRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00110">IRP_SYSTEM_RESTRICTED</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01641">_IRP::RequestorMode</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00690">SPECIALIRP_WATERMARK_IRP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01186">_DEVICE_OBJECT::Vpb</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01054">VPB_MOUNTED</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01604">IopQueryDeviceRelations()</a>, and <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>.
<p>
<pre class="fragment"><div>00271                    :
00272 
00273     This function sends an  Asynchronous irp to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> top level device
00274     object which roots on DeviceObject.
00275 
00276 Parameters:
00277 
00278     DeviceObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device being removed.
00279 
00280     TopStackLocation - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parameter block <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> irp.
00281 
00282     CompletionContext -
00283 
00284     CompletionRoutine -
00285 
00286 Return Value:
00287 
00288     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
00289 
00290 --*/
00291 
00292 {
00293     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00294     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00295     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00296     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00297 
00298     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00299 
00300     <span class="comment">//</span>
00301     <span class="comment">// If the target device object has a VPB associated with it and a file</span>
00302     <span class="comment">// system is mounted, make the filesystem's volume device object the</span>
00303     <span class="comment">// irp target.</span>
00304     <span class="comment">//</span>
00305     <span class="comment">// BUGBUG - I don't think we need to do this.  The filesystem</span>
00306     <span class="comment">// driver should attach to the PDO chain or registered for device</span>
00307     <span class="comment">// change registration.</span>
00308     <span class="comment">//</span>
00309 
00310     <span class="keywordflow">if</span> ((TargetDevice-&gt;Vpb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (TargetDevice-&gt;Vpb-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a116">VPB_MOUNTED</a>)) {
00311         deviceObject = TargetDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o10">Vpb</a>-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o4">DeviceObject</a>;
00312     } <span class="keywordflow">else</span> {
00313         deviceObject = TargetDevice;
00314     }
00315 
00316     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceObject != NULL);
00317 
00318     <span class="comment">//</span>
00319     <span class="comment">// Get a pointer to the topmost device object in the stack of devices,</span>
00320     <span class="comment">// beginning with the deviceObject.</span>
00321     <span class="comment">//</span>
00322 
00323     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a66">IoGetAttachedDevice</a>(deviceObject);
00324 
00325     <span class="comment">//</span>
00326     <span class="comment">// Allocate an I/O Request Packet (IRP) for this device removal operation.</span>
00327     <span class="comment">//</span>
00328 
00329     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>( (CCHAR) (deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>), FALSE );
00330     <span class="keywordflow">if</span> (!irp) {
00331         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00332     }
00333 
00334     <a class="code" href="../../d9/d4/trackirp_8h.html#a86">SPECIALIRP_WATERMARK_IRP</a>(irp, IRP_SYSTEM_RESTRICTED);
00335 
00336     <span class="comment">//</span>
00337     <span class="comment">// Initialize it to failure.</span>
00338     <span class="comment">//</span>
00339 
00340     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = STATUS_NOT_SUPPORTED;
00341     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = 0;
00342 
00343     <span class="comment">//</span>
00344     <span class="comment">// Get a pointer to the next stack location in the packet.  This location</span>
00345     <span class="comment">// will be used to pass the function codes and parameters to the first</span>
00346     <span class="comment">// driver.</span>
00347     <span class="comment">//</span>
00348 
00349     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a> (irp);
00350 
00351     <span class="comment">//</span>
00352     <span class="comment">// Fill in the IRP according to this request.</span>
00353     <span class="comment">//</span>
00354 
00355     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00356     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
00357     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00358     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00359 
00360     <span class="comment">//</span>
00361     <span class="comment">// Copy in the caller-supplied stack location contents</span>
00362     <span class="comment">//</span>
00363 
00364     *irpSp = *TopStackLocation;
00365 <span class="preprocessor">#if DBG</span>
00366 <span class="preprocessor"></span>    CompletionContext-&gt;Id = irp;
00367 <span class="preprocessor">#endif</span>
00368 <span class="preprocessor"></span>    <a class="code" href="../../d0/d5/io_8h.html#a237">IoSetCompletionRoutine</a>(irp,
00369                            CompletionRoutine,
00370                            CompletionContext,  <span class="comment">/* Completion context */</span>
00371                            TRUE,               <span class="comment">/* Invoke on success  */</span>
00372                            TRUE,               <span class="comment">/* Invoke on error    */</span>
00373                            TRUE                <span class="comment">/* Invoke on cancel   */</span>
00374                            );
00375 
00376     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject, irp );
00377     <span class="keywordflow">return</span> status;
00378 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="pnpirp.c::IopDecDisableableDepends" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopDecDisableableDepends           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceNode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l03152">3152</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02976">IopQueryDeviceState()</a>, and <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00927">IopRemoveDevice()</a>.
<p>
<pre class="fragment"><div>03157                    :
03158 
03159     Decrements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DisableableDepends field of <span class="keyword">this</span> devicenode
03160     and potentially every parent device node up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree
03161     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> parent devicenode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> decremented <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> child in question
03162     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> decremented from 1 to 0
03163 
03164 Parameters:
03165 
03166     DeviceNode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> depends <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be decremented
03167 
03168 Return Value:
03169 
03170     none.
03171 
03172 --*/
03173 {
03174 
03175     <span class="keywordflow">while</span> (DeviceNode != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03176 
03177         LONG newval;
03178 
03179         newval = InterlockedDecrement(&amp; DeviceNode-&gt;DisableableDepends);
03180         <span class="keywordflow">if</span> (newval != 0) {
03181             <span class="comment">//</span>
03182             <span class="comment">// we are still non-disableable, so we don't have to bother parent</span>
03183             <span class="comment">//</span>
03184             <span class="keywordflow">break</span>;
03185         }
03186 
03187         DeviceNode = DeviceNode -&gt;Parent;
03188 
03189     }
03190 
03191 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="pnpirp.c::IopDeviceEjectComplete" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopDeviceEjectComplete           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00896">896</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d8/ex_8h.html#a332a206">DelayedWorkQueue</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00090">_PENDING_RELATIONS_LIST_ENTRY::EjectIrp</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01961">ExInitializeWorkItem</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00375">ExQueueWorkItem()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06632">IoFreeIrp()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01417">IopProcessCompletedEject()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00086">_PENDING_RELATIONS_LIST_ENTRY::WorkItem</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00730">IopEjectDevice()</a>.
<p>
<pre class="fragment"><div>00901 {
00902     <a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html">PPENDING_RELATIONS_LIST_ENTRY</a> entry = (<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html">PPENDING_RELATIONS_LIST_ENTRY</a>)Context;
00903     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> ejectIrp;
00904 
00905     ejectIrp = InterlockedExchangePointer(&amp;entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o5">EjectIrp</a>, NULL);
00906 
00907     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ejectIrp == NULL || ejectIrp == Irp);
00908 
00909     <span class="comment">//</span>
00910     <span class="comment">// Queue a work item to finish up the eject.  We queue a work item because</span>
00911     <span class="comment">// we are probably running at dispatch level in some random context.</span>
00912     <span class="comment">//</span>
00913 
00914     <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>( &amp;entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o1">WorkItem</a>,
00915                           IopProcessCompletedEject,
00916                           entry);
00917 
00918     <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>( &amp;entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o1">WorkItem</a>, DelayedWorkQueue );
00919 
00920     <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>( Irp );
00921 
00922     <span class="keywordflow">return</span> STATUS_MORE_PROCESSING_REQUIRED;
00923 
00924 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="pnpirp.c::IopDeviceRelationsComplete" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopDeviceRelationsComplete           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01496">1496</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00515">DNF_BEING_ENUMERATED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00529">DNF_ENUMERATION_REQUEST_PENDING</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00508">DNF_IO_INVALIDATE_DEVICE_RELATIONS_PENDING</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02274">ERESOURCE_THREAD</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06632">IoFreeIrp()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00068">IopPnPSpinLock</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01285">IopReleaseEnumerationLockForThread</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00207">IopRequestDeviceAction()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00168">IRP_MN_QUERY_DEVICE_RELATIONS</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html#o32">_DEVICE_NODE::OverUsed1</a>, <a class="el" href="../../d0/d1/pnpirp_8c.html#a6">PDEVICE_COMPLETION_CONTEXT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00151">_DEVICE_NODE::PhysicalDeviceObject</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00026">PnpIrpStatusTracking</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a391a218">ReenumerateDeviceTree</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a391a221">RestartEnumeration</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01604">IopQueryDeviceRelations()</a>.
<p>
<pre class="fragment"><div>01504                    :
01505 
01506     Completion function <span class="keywordflow">for</span> a QueryDeviceRelations <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>. T
01507 
01508 Arguments:
01509 
01510     DeviceObject - <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
01511     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>          - SetPower irp which has completed
01512     Context      - a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DEVICE_CHANGE_COMPLETION_CONTEXT.
01513 
01514 Return Value:
01515 
01516     STATUS_MORE_PROCESSING_REQUIRED <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned to <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>
01517     to signify that <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a> should not <span class="keywordflow">continue</span> processing
01518     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>.
01519 
01520 --*/
01521 {
01522     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = ((<a class="code" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html">PDEVICE_COMPLETION_CONTEXT</a>)Context)-&gt;DeviceNode;
01523     <a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a> LockingThread = ((<a class="code" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html">PDEVICE_COMPLETION_CONTEXT</a>)Context)-&gt;Thread;
01524     KIRQL oldIrql;
01525     BOOLEAN requestEnumeration = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01526 
01527 <span class="preprocessor">#if DBG</span>
01528 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (((<a class="code" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html">PDEVICE_COMPLETION_CONTEXT</a>)Context)-&gt;Id != (PVOID)<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>) {
01529         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
01530         <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a> (Irp);
01531         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Context);
01532         <span class="keywordflow">return</span> STATUS_MORE_PROCESSING_REQUIRED;
01533     }
01534 <span class="preprocessor">#endif</span>
01535 <span class="preprocessor"></span>
01536     <a class="code" href="../../d0/d1/pnpirp_8c.html#a0">PnpIrpStatusTracking</a>(<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status, IRP_MN_QUERY_DEVICE_RELATIONS, deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
01537     ExAcquireSpinLock(&amp;IopPnPSpinLock, &amp;oldIrql);
01538     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a>  &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a27">DNF_BEING_ENUMERATED</a>;
01539 
01540     <span class="comment">//</span>
01541     <span class="comment">// Read state from Irp.</span>
01542     <span class="comment">//</span>
01543 
01544     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status) &amp;&amp; (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information)) {
01545 
01546         <span class="comment">//</span>
01547         <span class="comment">// It is VERY important that we set PendingDeviceRealtions field before</span>
01548         <span class="comment">// checking DNF_ENUMERATION_REQUEST_PENDING.</span>
01549         <span class="comment">//</span>
01550 
01551         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o32">OverUsed1</a>.PendingDeviceRelations == NULL);
01552         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o32">OverUsed1</a>.PendingDeviceRelations = (<a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html">PDEVICE_RELATIONS</a>)<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information;
01553     }
01554 
01555     <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a29">DNF_ENUMERATION_REQUEST_PENDING</a>) {
01556         ExReleaseSpinLock(&amp;IopPnPSpinLock, oldIrql);
01557 
01558         <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o32">OverUsed1</a>.PendingDeviceRelations) {
01559 
01560             <span class="comment">//</span>
01561             <span class="comment">// If the query_device_relations irp returns something, we will</span>
01562             <span class="comment">// make a request to process the childrens.</span>
01563             <span class="comment">//</span>
01564 
01565             <a class="code" href="../../d9/d0/pnpiop_8h.html#a305">IopRequestDeviceAction</a>( deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>,
01566                                     RestartEnumeration,
01567                                     NULL,
01568                                     NULL );
01569         } <span class="keywordflow">else</span> {
01570             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a29">DNF_ENUMERATION_REQUEST_PENDING</a>;
01571         }
01572     } <span class="keywordflow">else</span> {
01573         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a29">DNF_ENUMERATION_REQUEST_PENDING</a>;
01574         ExReleaseSpinLock(&amp;IopPnPSpinLock, oldIrql);
01575     }
01576 
01577     <a class="code" href="../../d9/d0/pnpiop_8h.html#a97">IopReleaseEnumerationLockForThread</a>(NULL, LockingThread);
01578 
01579     <span class="comment">//</span>
01580     <span class="comment">// Irp processing is complete, free the irp and then return</span>
01581     <span class="comment">// more_processing_required which causes IoCompleteRequest to</span>
01582     <span class="comment">// stop "completing" this irp any future.</span>
01583     <span class="comment">//</span>
01584 
01585     <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a> (Irp);
01586     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Context);
01587 
01588     ExAcquireSpinLock(&amp;IopPnPSpinLock, &amp;oldIrql);
01589     <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a26">DNF_IO_INVALIDATE_DEVICE_RELATIONS_PENDING</a>) {
01590         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a26">DNF_IO_INVALIDATE_DEVICE_RELATIONS_PENDING</a>;
01591         requestEnumeration = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01592     }
01593     ExReleaseSpinLock(&amp;IopPnPSpinLock, oldIrql);
01594     <span class="keywordflow">if</span> (requestEnumeration) {
01595         <a class="code" href="../../d9/d0/pnpiop_8h.html#a305">IopRequestDeviceAction</a>( DeviceObject,
01596                                 ReenumerateDeviceTree,
01597                                 NULL,
01598                                 NULL );
01599     }
01600     <span class="keywordflow">return</span> STATUS_MORE_PROCESSING_REQUIRED;
01601 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="pnpirp.c::IopDeviceStartComplete" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopDeviceStartComplete           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01370">1370</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00500">DNF_NEED_ENUMERATION_ONLY</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00427">DNF_START_REQUEST_PENDING</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">DNF_STARTED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00480">DNF_STOPPED</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a205">DOCK_ARRIVING</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a203">DOCK_NOTDOCKDEVICE</a>, <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html#o42">_DEVICE_NODE::DockInfo</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02274">ERESOURCE_THREAD</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06632">IoFreeIrp()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00068">IopPnPSpinLock</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01285">IopReleaseEnumerationLockForThread</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00207">IopRequestDeviceAction()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01708">IopRequestDeviceRemoval()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00835">IopSetDevNodeProblem</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01481">IoRequestDeviceEject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00160">IRP_MN_START_DEVICE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d1/pnpirp_8c.html#a6">PDEVICE_COMPLETION_CONTEXT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00151">_DEVICE_NODE::PhysicalDeviceObject</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00026">PnpIrpStatusTracking</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a391a218">ReenumerateDeviceTree</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00820">SAVE_FAILURE_INFO</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>.
<p>
<pre class="fragment"><div>01378                    :
01379 
01380     Completion function <span class="keywordflow">for</span> an Async <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>.
01381 
01382 Arguments:
01383 
01384     DeviceObject - <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
01385     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>          - SetPower irp which has completed
01386     Context      - a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DEVICE_CHANGE_COMPLETION_CONTEXT.
01387 
01388 Return Value:
01389 
01390     STATUS_MORE_PROCESSING_REQUIRED <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned to <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>
01391     to signify that <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a> should not <span class="keywordflow">continue</span> processing
01392     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>.
01393 
01394 --*/
01395 {
01396     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = ((<a class="code" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html">PDEVICE_COMPLETION_CONTEXT</a>)Context)-&gt;DeviceNode;
01397     <a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a> LockingThread = ((<a class="code" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html">PDEVICE_COMPLETION_CONTEXT</a>)Context)-&gt;Thread;
01398     ULONG oldFlags;
01399     KIRQL oldIrql;
01400 
01401     <span class="comment">//</span>
01402     <span class="comment">// Read state from Irp.</span>
01403     <span class="comment">//</span>
01404 
01405 <span class="preprocessor">#if DBG</span>
01406 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (((<a class="code" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html">PDEVICE_COMPLETION_CONTEXT</a>)Context)-&gt;Id != (PVOID)<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>) {
01407         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
01408         <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a> (Irp);
01409         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Context);
01410 
01411         <span class="keywordflow">return</span> STATUS_MORE_PROCESSING_REQUIRED;
01412     }
01413 <span class="preprocessor">#endif</span>
01414 <span class="preprocessor"></span>
01415     <a class="code" href="../../d0/d1/pnpirp_8c.html#a0">PnpIrpStatusTracking</a>(<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status, IRP_MN_START_DEVICE, deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
01416     ExAcquireSpinLock(&amp;IopPnPSpinLock, &amp;oldIrql);
01417 
01418     oldFlags = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a>;
01419     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a14">DNF_START_REQUEST_PENDING</a>;
01420     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status)) {
01421 
01422         <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a22">DNF_STOPPED</a>) {
01423 
01424             <span class="comment">//</span>
01425             <span class="comment">// If the start is initiated by rebalancing, do NOT do enumeration</span>
01426             <span class="comment">//</span>
01427 
01428             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a22">DNF_STOPPED</a>;
01429             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>;
01430 
01431             ExReleaseSpinLock(&amp;IopPnPSpinLock, oldIrql);
01432         } <span class="keywordflow">else</span> {
01433 
01434             <span class="comment">//</span>
01435             <span class="comment">// Otherwise, we need to queue a request to enumerate the device if DNF_START_REQUEST_PENDING</span>
01436             <span class="comment">// is set.  (IopStartDevice sets the flag if status of start irp returns pending.)</span>
01437             <span class="comment">//</span>
01438             <span class="comment">//</span>
01439 
01440             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a25">DNF_NEED_ENUMERATION_ONLY</a> + <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>;
01441 
01442             ExReleaseSpinLock(&amp;IopPnPSpinLock, oldIrql);
01443 
01444             <span class="keywordflow">if</span> (oldFlags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a14">DNF_START_REQUEST_PENDING</a>) {
01445                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a305">IopRequestDeviceAction</a>( deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>,
01446                                         ReenumerateDeviceTree,
01447                                         NULL,
01448                                         NULL );
01449             }
01450         }
01451 
01452     } <span class="keywordflow">else</span> {
01453 
01454         <span class="comment">//</span>
01455         <span class="comment">// The start failed.  We will remove the device</span>
01456         <span class="comment">//</span>
01457 
01458         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~(<a class="code" href="../../d9/d0/pnpiop_8h.html#a22">DNF_STOPPED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>);
01459 
01460         ExReleaseSpinLock(&amp;IopPnPSpinLock, oldIrql);
01461         <a class="code" href="../../d9/d0/pnpiop_8h.html#a76">SAVE_FAILURE_INFO</a>(deviceNode, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status);
01462 
01463         <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_FAILED_START);
01464 
01465         <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus == <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a203">DOCK_NOTDOCKDEVICE</a>) {
01466 
01467             <a class="code" href="../../d9/d0/pnpiop_8h.html#a306">IopRequestDeviceRemoval</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>, CM_PROB_FAILED_START);
01468         } <span class="keywordflow">else</span> {
01469 
01470             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus == DOCK_ARRIVING);
01471 
01472             <span class="comment">//</span>
01473             <span class="comment">// ADRIAO BUGBUG 05/12/1999 -</span>
01474             <span class="comment">//     We never go down this path, but if we fix it a function</span>
01475             <span class="comment">// similar to IopRequestDeviceEjectWorker needs to be queued, one</span>
01476             <span class="comment">// that passes in "FALSE" for the kernel initiated parameter.</span>
01477             <span class="comment">//</span>
01478             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
01479             <a class="code" href="../../d8/d0/pnpioapi_8c.html#a80">IoRequestDeviceEject</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
01480         }
01481     }
01482     <a class="code" href="../../d9/d0/pnpiop_8h.html#a97">IopReleaseEnumerationLockForThread</a>(NULL, LockingThread);
01483 
01484     <span class="comment">//</span>
01485     <span class="comment">// Irp processing is complete, free the irp and then return</span>
01486     <span class="comment">// more_processing_required which causes IoCompleteRequest to</span>
01487     <span class="comment">// stop "completing" this irp any future.</span>
01488     <span class="comment">//</span>
01489 
01490     <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a> (Irp);
01491     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Context);
01492     <span class="keywordflow">return</span> STATUS_MORE_PROCESSING_REQUIRED;
01493 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="pnpirp.c::IopEjectDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopEjectDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html">PPENDING_RELATIONS_LIST_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PendingEntry</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00730">730</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d5/d8/ex_8h.html#a332a206">DelayedWorkQueue</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01961">ExInitializeWorkItem</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00375">ExQueueWorkItem()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00652">IoAllocateIrp()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06786">IoGetAttachedDevice()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00896">IopDeviceEjectComplete()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01417">IopProcessCompletedEject()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01234">IopQueuePendingEject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03913">IoSetCompletionRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00178">IRP_MN_EJECT</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00110">IRP_SYSTEM_RESTRICTED</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a160">PpNotifyUserModeRemovalSafe()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01641">_IRP::RequestorMode</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00690">SPECIALIRP_WATERMARK_IRP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>.
<p>
<pre class="fragment"><div>00737                    :
00738 
00739     This function sends an eject device irp to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> top level device
00740     object which roots on DeviceObject.
00741 
00742 Parameters:
00743 
00744     DeviceObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device being
00745                    removed.
00746 
00747 Return Value:
00748 
00749     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
00750 
00751 --*/
00752 
00753 {
00754     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00755     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00756     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
00757     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00758     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00759 
00760     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00761 
00762     <span class="keywordflow">if</span> (PendingEntry-&gt;LightestSleepState != PowerSystemWorking) {
00763 
00764         <span class="comment">//</span>
00765         <span class="comment">// We have to warm eject.</span>
00766         <span class="comment">//</span>
00767         <span class="keywordflow">if</span> (PendingEntry-&gt;DockInterface) {
00768 
00769             PendingEntry-&gt;DockInterface-&gt;ProfileDepartureSetMode(
00770                 PendingEntry-&gt;DockInterface-&gt;Context,
00771                 PDS_UPDATE_ON_EJECT
00772                 );
00773         }
00774 
00775         PendingEntry-&gt;EjectIrp = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00776 
00777         InitializeListHead( &amp;PendingEntry-&gt;Link );
00778 
00779         <a class="code" href="../../d9/d0/pnpiop_8h.html#a317">IopQueuePendingEject</a>(PendingEntry);
00780 
00781         <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>( &amp;PendingEntry-&gt;WorkItem,
00782                               IopProcessCompletedEject,
00783                               PendingEntry);
00784 
00785         <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>( &amp;PendingEntry-&gt;WorkItem, DelayedWorkQueue );
00786         <span class="keywordflow">return</span> STATUS_SUCCESS;
00787     }
00788 
00789     <span class="keywordflow">if</span> (PendingEntry-&gt;DockInterface) {
00790 
00791         <span class="comment">//</span>
00792         <span class="comment">// Notify dock that now is a good time to update it's hardware profile.</span>
00793         <span class="comment">//</span>
00794         PendingEntry-&gt;DockInterface-&gt;ProfileDepartureSetMode(
00795             PendingEntry-&gt;DockInterface-&gt;Context,
00796             PDS_UPDATE_ON_INTERFACE
00797             );
00798 
00799         PendingEntry-&gt;DockInterface-&gt;ProfileDepartureUpdate(
00800             PendingEntry-&gt;DockInterface-&gt;Context
00801             );
00802 
00803         <span class="keywordflow">if</span> (PendingEntry-&gt;DisplaySafeRemovalDialog) {
00804 
00805             <a class="code" href="../../d6/d9/pnp_8h.html#a160">PpNotifyUserModeRemovalSafe</a>(DeviceObject);
00806             PendingEntry-&gt;DisplaySafeRemovalDialog = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00807         }
00808     }
00809 
00810     <span class="comment">//</span>
00811     <span class="comment">// Get a pointer to the topmost device object in the stack of devices,</span>
00812     <span class="comment">// beginning with the deviceObject.</span>
00813     <span class="comment">//</span>
00814 
00815     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a66">IoGetAttachedDevice</a>(DeviceObject);
00816 
00817     <span class="comment">//</span>
00818     <span class="comment">// Allocate an I/O Request Packet (IRP) for this device removal operation.</span>
00819     <span class="comment">//</span>
00820 
00821     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>( (CCHAR) (deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>), FALSE );
00822     <span class="keywordflow">if</span> (!irp) {
00823 
00824         PendingEntry-&gt;EjectIrp = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00825 
00826         InitializeListHead( &amp;PendingEntry-&gt;Link );
00827 
00828         <a class="code" href="../../d9/d0/pnpiop_8h.html#a317">IopQueuePendingEject</a>(PendingEntry);
00829 
00830         <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>( &amp;PendingEntry-&gt;WorkItem,
00831                               IopProcessCompletedEject,
00832                               PendingEntry);
00833 
00834         <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>( &amp;PendingEntry-&gt;WorkItem, DelayedWorkQueue );
00835 
00836         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00837     }
00838 
00839     <a class="code" href="../../d9/d4/trackirp_8h.html#a86">SPECIALIRP_WATERMARK_IRP</a>(irp, IRP_SYSTEM_RESTRICTED);
00840 
00841     <span class="comment">//</span>
00842     <span class="comment">// Initialize it to failure.</span>
00843     <span class="comment">//</span>
00844 
00845     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = STATUS_NOT_SUPPORTED;
00846     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = 0;
00847 
00848     <span class="comment">//</span>
00849     <span class="comment">// Get a pointer to the next stack location in the packet.  This location</span>
00850     <span class="comment">// will be used to pass the function codes and parameters to the first</span>
00851     <span class="comment">// driver.</span>
00852     <span class="comment">//</span>
00853 
00854     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>(irp);
00855 
00856     <span class="comment">//</span>
00857     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
00858     <span class="comment">//</span>
00859 
00860     RtlZeroMemory(irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
00861 
00862     <span class="comment">//</span>
00863     <span class="comment">// Set the function codes.</span>
00864     <span class="comment">//</span>
00865 
00866     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
00867     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a81">IRP_MN_EJECT</a>;
00868 
00869     <span class="comment">//</span>
00870     <span class="comment">// Fill in the IRP according to this request.</span>
00871     <span class="comment">//</span>
00872 
00873     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00874     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
00875     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00876     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00877 
00878     PendingEntry-&gt;EjectIrp = irp;
00879 
00880     <a class="code" href="../../d9/d0/pnpiop_8h.html#a317">IopQueuePendingEject</a>(PendingEntry);
00881 
00882     <a class="code" href="../../d0/d5/io_8h.html#a237">IoSetCompletionRoutine</a>(irp,
00883                            IopDeviceEjectComplete,
00884                            PendingEntry,       <span class="comment">/* Completion context */</span>
00885                            TRUE,               <span class="comment">/* Invoke on success  */</span>
00886                            TRUE,               <span class="comment">/* Invoke on error    */</span>
00887                            TRUE                <span class="comment">/* Invoke on cancel   */</span>
00888                            );
00889 
00890     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject, irp );
00891 
00892     <span class="keywordflow">return</span> status;
00893 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="pnpirp.c::IopFilterResourceRequirementsCall" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopFilterResourceRequirementsCall           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PIO_RESOURCE_REQUIREMENTS_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>ResReqList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Information</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l03255">3255</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00652">IoAllocateIrp()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06786">IoGetAttachedDevice()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01103">IopQueueThreadIrp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00174">IRP_MN_FILTER_RESOURCE_REQUIREMENTS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00110">IRP_SYSTEM_RESTRICTED</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00026">PnpIrpStatusTracking</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00690">SPECIALIRP_WATERMARK_IRP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>.
<p>
<pre class="fragment"><div>03263                    :
03264 
03265     This function sends a synchronous filter resource requirements irp to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03266     top level device object which roots on DeviceObject.
03267 
03268 Parameters:
03269 
03270     DeviceObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device being removed.
03271 
03272     ResReqList   - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource requirements requiring
03273                    filtering.
03274 
03275     Information  - Supplies a pointer to a variable that receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned
03276                    information of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> irp.
03277 
03278 Return Value:
03279 
03280     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
03281 
03282 --*/
03283 
03284 {
03285     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
03286     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
03287     IO_STATUS_BLOCK statusBlock;
03288     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
03289     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03290     PULONG_PTR returnInfo = (PULONG_PTR)Information;
03291     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
03292 
03293     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03294 
03295     <span class="comment">//</span>
03296     <span class="comment">// Get a pointer to the topmost device object in the stack of devices,</span>
03297     <span class="comment">// beginning with the deviceObject.</span>
03298     <span class="comment">//</span>
03299 
03300     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a66">IoGetAttachedDevice</a>(DeviceObject);
03301 
03302     <span class="comment">//</span>
03303     <span class="comment">// Begin by allocating the IRP for this request.  Do not charge quota to</span>
03304     <span class="comment">// the current process for this IRP.</span>
03305     <span class="comment">//</span>
03306 
03307     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>(deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>, FALSE);
03308     <span class="keywordflow">if</span> (irp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>){
03309 
03310         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
03311     }
03312 
03313     <a class="code" href="../../d9/d4/trackirp_8h.html#a86">SPECIALIRP_WATERMARK_IRP</a>(irp, IRP_SYSTEM_RESTRICTED);
03314 
03315     <span class="comment">//</span>
03316     <span class="comment">// Initialize it to success. This is a special hack for WDM (ie 9x)</span>
03317     <span class="comment">// compatibility. The driver verifier is in on this one.</span>
03318     <span class="comment">//</span>
03319 
03320     <span class="keywordflow">if</span> (ResReqList) {
03321 
03322         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = statusBlock.Status = STATUS_SUCCESS;
03323         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = statusBlock.Information = (ULONG_PTR) ResReqList;
03324 
03325     } <span class="keywordflow">else</span> {
03326 
03327         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = statusBlock.Status = STATUS_NOT_SUPPORTED;
03328     }
03329 
03330     <span class="comment">//</span>
03331     <span class="comment">// Set the pointer to the status block and initialized event.</span>
03332     <span class="comment">//</span>
03333 
03334     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event,
03335                        SynchronizationEvent,
03336                        FALSE );
03337 
03338     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;statusBlock;
03339     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = &amp;event;
03340 
03341     <span class="comment">//</span>
03342     <span class="comment">// Set the address of the current thread</span>
03343     <span class="comment">//</span>
03344 
03345     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
03346 
03347     <span class="comment">//</span>
03348     <span class="comment">// Queue this irp onto the current thread</span>
03349     <span class="comment">//</span>
03350 
03351     <a class="code" href="../../d0/d6/iop_8h.html#a21">IopQueueThreadIrp</a>(irp);
03352 
03353     <span class="comment">//</span>
03354     <span class="comment">// Get a pointer to the stack location of the first driver which will be</span>
03355     <span class="comment">// invoked.  This is where the function codes and parameters are set.</span>
03356     <span class="comment">//</span>
03357 
03358     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>(irp);
03359 
03360     <span class="comment">//</span>
03361     <span class="comment">// Setup the stack location contents</span>
03362     <span class="comment">//</span>
03363 
03364     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a78">IRP_MN_FILTER_RESOURCE_REQUIREMENTS</a>;
03365     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
03366     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.FilterResourceRequirements.IoResourceRequirementList = ResReqList;
03367 
03368     <span class="comment">//</span>
03369     <span class="comment">// Call the driver</span>
03370     <span class="comment">//</span>
03371 
03372     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>(deviceObject, irp);
03373 
03374     <a class="code" href="../../d0/d1/pnpirp_8c.html#a0">PnpIrpStatusTracking</a>(status, IRP_MN_FILTER_RESOURCE_REQUIREMENTS, deviceObject);
03375 
03376     <span class="comment">//</span>
03377     <span class="comment">// If a driver returns STATUS_PENDING, we will wait for it to complete</span>
03378     <span class="comment">//</span>
03379 
03380     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
03381         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
03382                                       Executive,
03383                                       KernelMode,
03384                                       FALSE,
03385                                       (PLARGE_INTEGER) NULL );
03386         status = statusBlock.Status;
03387     }
03388 
03389     *returnInfo = (ULONG_PTR) statusBlock.Information;
03390 
03391     <span class="keywordflow">return</span> status;
03392 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="pnpirp.c::IopFindMountableDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> IopFindMountableDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01316">1316</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01181">_DEVICE_OBJECT::AttachedDevice</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01158">DO_DEVICE_HAS_NAME</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01184">_DEVICE_OBJECT::Flags</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01186">_DEVICE_OBJECT::Vpb</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00927">IopRemoveDevice()</a>.
<p>
<pre class="fragment"><div>01321                    :
01322 
01323     This routine will scan up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device stack and find a device which could
01324     finds with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d5/io_8h.html#a119">VPB_REMOVE_PENDING</a> bit (or clear it in the <span class="keywordflow">case</span> of cancel)
01325     and increment (or decrement in the <span class="keywordflow">case</span> of cancel) <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count
01326     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d7/struct__VPB.html">VPB</a>.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to ensure that no <span class="keyword">new</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system can get mounted on
01327     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device stack <span class="keywordflow">while</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remove operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in place.
01328 
01329     The search will terminate once all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> attached device objects have been
01330     marked, or once a mounted device object has been marked.
01331 
01332 Arguments:
01333 
01334     DeviceObject - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDO we are attempting to remove
01335 
01336     IrpMinorCode - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remove-<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> operation we are going to perform
01337 
01338     Context - a context block which must be passed in to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unlock operation
01339 
01340 Return Value:
01341 
01342     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object stack which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remove request should be
01343     sent to.  If a mounted <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system was found, <span class="keyword">this</span> will be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lowest
01344     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system device object in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mounted stack.  Otherwise <span class="keyword">this</span> will be
01345     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDO which was passed in.
01346 
01347 --*/
01348 
01349 {
01350     <a class="code" href="../../d7/d7/struct__VPB.html">PVPB</a> vpb;
01351 
01352     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> mountableDevice = DeviceObject;
01353 
01354     <span class="keywordflow">while</span> (mountableDevice != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01355 
01356         <span class="keywordflow">if</span> ((mountableDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a127">DO_DEVICE_HAS_NAME</a>) &amp;&amp;
01357            (mountableDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o10">Vpb</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01358 
01359             <span class="keywordflow">return</span> mountableDevice;
01360         }
01361 
01362         mountableDevice = mountableDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
01363     }
01364 
01365     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01366 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="pnpirp.c::IopIncDisableableDepends" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopIncDisableableDepends           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceNode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l03109">3109</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02976">IopQueryDeviceState()</a>.
<p>
<pre class="fragment"><div>03114                    :
03115 
03116     Increments <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DisableableDepends field of <span class="keyword">this</span> devicenode
03117     and potentially every parent device node up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree
03118     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> parent devicenode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> incremented <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> child in question
03119     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> incremented from 0 to 1
03120 
03121 Parameters:
03122 
03123     DeviceNode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> depends <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be incremented
03124 
03125 Return Value:
03126 
03127     none.
03128 
03129 --*/
03130 {
03131 
03132     <span class="keywordflow">while</span> (DeviceNode != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03133 
03134         LONG newval;
03135 
03136         newval = InterlockedIncrement(&amp; DeviceNode-&gt;DisableableDepends);
03137         <span class="keywordflow">if</span> (newval != 1) {
03138             <span class="comment">//</span>
03139             <span class="comment">// we were already non-disableable, so we don't have to bother parent</span>
03140             <span class="comment">//</span>
03141             <span class="keywordflow">break</span>;
03142         }
03143 
03144         DeviceNode = DeviceNode -&gt;Parent;
03145 
03146     }
03147 
03148 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="pnpirp.c::IopLockMountedDeviceForRemove" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> IopLockMountedDeviceForRemove           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpMinorCode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d7/d2/struct__LOCK__MOUNTABLE__DEVICE__CONTEXT.html">PLOCK_MOUNTABLE_DEVICE_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01080">1080</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01181">_DEVICE_OBJECT::AttachedDevice</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01205">_DEVICE_OBJECT::DeviceLock</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01072">_VPB::DeviceObject</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01070">_VPB::Flags</a>, <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00056">IO_NO_INCREMENT</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00134">IoAcquireVpbSpinLock()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00054">IopDatabaseLock</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09644">IoReleaseVpbSpinLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00163">IRP_MN_CANCEL_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00161">IRP_MN_QUERY_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00162">IRP_MN_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00184">IRP_MN_SURPRISE_REMOVAL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01186">_DEVICE_OBJECT::Vpb</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01054">VPB_MOUNTED</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01057">VPB_REMOVE_PENDING</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00927">IopRemoveDevice()</a>.
<p>
<pre class="fragment"><div>01088                    :
01089 
01090     This routine will scan up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device stack and mark each unmounted <a class="code" href="../../d7/d7/struct__VPB.html">VPB</a> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
01091     finds with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d5/io_8h.html#a119">VPB_REMOVE_PENDING</a> bit (or clear it in the <span class="keywordflow">case</span> of cancel)
01092     and increment (or decrement in the <span class="keywordflow">case</span> of cancel) <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count
01093     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d7/struct__VPB.html">VPB</a>.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to ensure that no <span class="keyword">new</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system can get mounted on
01094     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device stack <span class="keywordflow">while</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remove operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in place.
01095 
01096     The search will terminate once all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> attached device objects have been
01097     marked, or once a mounted device object has been marked.
01098 
01099 Arguments:
01100 
01101     DeviceObject - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDO we are attempting to remove
01102 
01103     IrpMinorCode - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remove-<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> operation we are going to perform
01104 
01105     Context - a context block which must be passed in to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unlock operation
01106 
01107 Return Value:
01108 
01109     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object stack which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remove request should be
01110     sent to.  If a mounted <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system was found, <span class="keyword">this</span> will be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lowest
01111     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system device object in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mounted stack.  Otherwise <span class="keyword">this</span> will be
01112     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDO which was passed in.
01113 
01114 --*/
01115 
01116 {
01117     <a class="code" href="../../d7/d7/struct__VPB.html">PVPB</a> vpb;
01118 
01119     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> device = DeviceObject;
01120     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> fsDevice = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01121 
01122     BOOLEAN isRemovePendingSet;
01123     KIRQL oldIrql;
01124 
01125     RtlZeroMemory(Context, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d2/struct__LOCK__MOUNTABLE__DEVICE__CONTEXT.html">LOCK_MOUNTABLE_DEVICE_CONTEXT</a>));
01126     Context-&gt;MountedDevice = DeviceObject;
01127 
01128     <span class="keywordflow">do</span> {
01129 
01130         <span class="comment">//</span>
01131         <span class="comment">// Walk up each device object in the stack.  For each one, if a VPB</span>
01132         <span class="comment">// exists, grab the database resource exclusive followed by the</span>
01133         <span class="comment">// device lock.  Then acquire the Vpb spinlock and perform the</span>
01134         <span class="comment">// appropriate magic on the device object.</span>
01135         <span class="comment">//</span>
01136 
01137         <span class="comment">//</span>
01138         <span class="comment">// NOTE - Its unfortunate that the locking order includes grabbing</span>
01139         <span class="comment">// the device specific lock first followed by the global lock.</span>
01140         <span class="comment">//</span>
01141 
01142         <span class="keywordflow">if</span>(device-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o10">Vpb</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01143 
01144             <span class="comment">//</span>
01145             <span class="comment">// Grab the device lock.  This will ensure that there are no mount</span>
01146             <span class="comment">// or verify operations in progress.</span>
01147             <span class="comment">//</span>
01148 
01149             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;(device-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o22">DeviceLock</a>),
01150                                   Executive,
01151                                   KernelMode,
01152                                   FALSE,
01153                                   NULL);
01154 
01155             <span class="comment">//</span>
01156             <span class="comment">// Now set the remove pending flag, which will prevent new mounts</span>
01157             <span class="comment">// from occuring on this stack once the current (if existant)</span>
01158             <span class="comment">// filesystem dismounts. Filesystems will preserve the flag across</span>
01159             <span class="comment">// vpb swaps.</span>
01160             <span class="comment">//</span>
01161 
01162             <a class="code" href="../../d4/d6/iosubs_8c.html#a10">IoAcquireVpbSpinLock</a>(&amp;oldIrql);
01163 
01164             vpb = device-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o10">Vpb</a>;
01165 
01166             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(vpb != NULL);
01167 
01168             <span class="keywordflow">switch</span>(IrpMinorCode) {
01169 
01170                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a66">IRP_MN_QUERY_REMOVE_DEVICE</a>:
01171                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a87">IRP_MN_SURPRISE_REMOVAL</a>:
01172                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a67">IRP_MN_REMOVE_DEVICE</a>: {
01173 
01174                     vpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o2">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a119">VPB_REMOVE_PENDING</a>;
01175                     <span class="keywordflow">break</span>;
01176                 }
01177 
01178                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a68">IRP_MN_CANCEL_REMOVE_DEVICE</a>: {
01179 
01180                     vpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o2">Flags</a> &amp;= ~<a class="code" href="../../d0/d5/io_8h.html#a119">VPB_REMOVE_PENDING</a>;
01181                     <span class="keywordflow">break</span>;
01182                 }
01183 
01184                 <span class="keywordflow">default</span>:
01185                     <span class="keywordflow">break</span>;
01186             }
01187 
01188             <span class="comment">//</span>
01189             <span class="comment">// Note the device object that has the filesystem stack attached.</span>
01190             <span class="comment">// We must remember the vpb we referenced that had the fs because</span>
01191             <span class="comment">// it may be swapped off of the storage device during a dismount</span>
01192             <span class="comment">// operation.</span>
01193             <span class="comment">//</span>
01194 
01195             <span class="keywordflow">if</span>(vpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o2">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a116">VPB_MOUNTED</a>) {
01196 
01197                 Context-&gt;MountedDevice = device;
01198                 fsDevice = vpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o4">DeviceObject</a>;
01199             }
01200 
01201             <a class="code" href="../../d4/d6/iosubs_8c.html#a102">IoReleaseVpbSpinLock</a>(oldIrql);
01202             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;(device-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o22">DeviceLock</a>), IO_NO_INCREMENT, FALSE);
01203 
01204             <span class="comment">//</span>
01205             <span class="comment">// Stop if we hit a device with a mounted filesystem.</span>
01206             <span class="comment">//</span>
01207 
01208             <span class="keywordflow">if</span> (Context-&gt;MountedDevice != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01209 
01210                 <span class="comment">//</span>
01211                 <span class="comment">// We found and setup a mounted device.  Time to return.</span>
01212                 <span class="comment">//</span>
01213 
01214                 <span class="keywordflow">break</span>;
01215             }
01216         }
01217 
01218         ExAcquireFastLock( &amp;IopDatabaseLock, &amp;oldIrql );
01219         device = device-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
01220         ExReleaseFastLock( &amp;IopDatabaseLock, oldIrql );
01221 
01222     } <span class="keywordflow">while</span> (device != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01223 
01224     <span class="keywordflow">if</span>(fsDevice != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01225 
01226         <span class="keywordflow">return</span> fsDevice;
01227     }
01228 
01229     <span class="keywordflow">return</span> Context-&gt;MountedDevice;
01230 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="pnpirp.c::IopMakeGloballyUniqueId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopMakeGloballyUniqueId           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>UniqueId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PWCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>GloballyUniqueId</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01891">1891</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00072">HASH_UNICODE_STRING</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00177">_DEVICE_NODE::InstancePath</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00117">_DEVICE_NODE::Level</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00332">max</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00085">MAX_PARENT_PREFIX</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00105">_DEVICE_NODE::Parent</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00036">PpRegistryDeviceResource</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01038">RtlUpcaseUnicodeString()</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>.
<p>
<pre class="fragment"><div>01896 {
01897     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01898     ULONG length;
01899     PWSTR <span class="keywordtype">id</span>, Prefix = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01900     HANDLE enumKey;
01901     HANDLE instanceKey;
01902     UCHAR keyBuffer[FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION, Data) + <span class="keyword">sizeof</span>(ULONG)];
01903     PKEY_VALUE_PARTIAL_INFORMATION keyValue, stringValueBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01904     UNICODE_STRING valueName;
01905     ULONG uniqueIdValue, Hash, hashInstance;
01906     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> parentNode;
01907 
01908     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01909 
01910     <span class="comment">//</span>
01911     <span class="comment">// We need to build an instance id to uniquely identify this</span>
01912     <span class="comment">// device.  We will accomplish this by producing a prefix that will be</span>
01913     <span class="comment">// prepended to the non-unique device id supplied.</span>
01914     <span class="comment">//</span>
01915 
01916     <span class="comment">//</span>
01917     <span class="comment">// To 'unique-ify' the child's instance ID, we will retrieve</span>
01918     <span class="comment">// the unique "UniqueParentID" number that has been assigned</span>
01919     <span class="comment">// to the parent and use it to construct a prefix.  This is</span>
01920     <span class="comment">// the legacy mechanism supported here so that existing device</span>
01921     <span class="comment">// settings are not lost on upgrade.</span>
01922     <span class="comment">//</span>
01923 
01924     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01925     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
01926 
01927     parentNode = ((<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode)-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>;
01928 
01929     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;enumKey,
01930                                    NULL,
01931                                    &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
01932                                    KEY_READ | KEY_WRITE
01933                                    );
01934 
01935     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01936         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopQueryUniqueId:\tUnable to open HKLM\\SYSTEM\\CCS\\ENUM (status %08lx)\n"</span>,
01937                  status
01938                 );
01939         <span class="keywordflow">goto</span> clean0;
01940     }
01941 
01942     <span class="comment">//</span>
01943     <span class="comment">// Open the instance key for this devnode</span>
01944     <span class="comment">//</span>
01945     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;instanceKey,
01946                                    enumKey,
01947                                    &amp;parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>,
01948                                    KEY_READ | KEY_WRITE
01949                                    );
01950 
01951     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01952         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopQueryUniqueId:\tUnable to open registry key for %wZ (status %08lx)\n"</span>,
01953                  &amp;parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>,
01954                  status
01955                 );
01956         <span class="keywordflow">goto</span> clean1;
01957     }
01958 
01959     <span class="comment">//</span>
01960     <span class="comment">// Attempt to retrieve the "UniqueParentID" value from the device</span>
01961     <span class="comment">// instance key.</span>
01962     <span class="comment">//</span>
01963     keyValue = (PKEY_VALUE_PARTIAL_INFORMATION)keyBuffer;
01964     PiWstrToUnicodeString(&amp;valueName, REGSTR_VALUE_UNIQUE_PARENT_ID);
01965 
01966     status = ZwQueryValueKey(instanceKey,
01967                              &amp;valueName,
01968                              KeyValuePartialInformation,
01969                              keyValue,
01970                              <span class="keyword">sizeof</span>(keyBuffer),
01971                              &amp;length
01972                              );
01973 
01974     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01975         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(keyValue-&gt;Type == REG_DWORD);
01976         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(keyValue-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG));
01977         <span class="keywordflow">if</span> ((keyValue-&gt;Type != REG_DWORD) ||
01978             (keyValue-&gt;DataLength != <span class="keyword">sizeof</span>(ULONG))) {
01979             status = STATUS_INVALID_PARAMETER;
01980             <span class="keywordflow">goto</span> clean2;
01981         }
01982 
01983         uniqueIdValue = *(PULONG)(keyValue-&gt;Data);
01984 
01985         <span class="comment">//</span>
01986         <span class="comment">// OK, we have a unique parent ID number to prefix to the</span>
01987         <span class="comment">// instance ID.</span>
01988         Prefix = (PWSTR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, 9 * <span class="keyword">sizeof</span>(WCHAR));
01989         <span class="keywordflow">if</span> (!Prefix) {
01990             status = STATUS_INSUFFICIENT_RESOURCES;
01991             <span class="keywordflow">goto</span> clean2;
01992         }
01993         swprintf(Prefix, L<span class="stringliteral">"%x"</span>, uniqueIdValue);
01994     } <span class="keywordflow">else</span> {
01995 
01996         <span class="comment">//</span>
01997         <span class="comment">// This is the current mechanism for finding existing</span>
01998         <span class="comment">// device instance prefixes and calculating new ones if</span>
01999         <span class="comment">// required.</span>
02000         <span class="comment">//</span>
02001 
02002         <span class="comment">//</span>
02003         <span class="comment">// Attempt to retrieve the "ParentIdPrefix" value from the device</span>
02004         <span class="comment">// instance key.</span>
02005         <span class="comment">//</span>
02006 
02007         PiWstrToUnicodeString(&amp;valueName, REGSTR_VALUE_PARENT_ID_PREFIX);
02008         length = (<a class="code" href="../../d0/d1/pnpirp_8c.html#a2">MAX_PARENT_PREFIX</a> + 1) * <span class="keyword">sizeof</span>(WCHAR) +
02009             FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION, Data);
02010         stringValueBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool,
02011                                            length);
02012         <span class="keywordflow">if</span> (stringValueBuffer) {
02013             status = ZwQueryValueKey(instanceKey,
02014                                      &amp;valueName,
02015                                      KeyValuePartialInformation,
02016                                      stringValueBuffer,
02017                                      length,
02018                                      &amp;length);
02019         }
02020         <span class="keywordflow">else</span> {
02021             status = STATUS_INSUFFICIENT_RESOURCES;
02022             <span class="keywordflow">goto</span> clean2;
02023         }
02024 
02025         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02026 
02027             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(stringValueBuffer-&gt;Type == REG_SZ);
02028             <span class="keywordflow">if</span> (stringValueBuffer-&gt;Type != REG_SZ) {
02029                 status = STATUS_INVALID_PARAMETER;
02030                 <span class="keywordflow">goto</span> clean2;
02031             }
02032 
02033             <span class="comment">//</span>
02034             <span class="comment">// Parent has already been assigned a "ParentIdPrefix".</span>
02035             <span class="comment">//</span>
02036 
02037             Prefix = (PWSTR) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool,
02038                                             stringValueBuffer-&gt;DataLength);
02039             <span class="keywordflow">if</span> (!Prefix)
02040             {
02041                 status = STATUS_INSUFFICIENT_RESOURCES;
02042                 <span class="keywordflow">goto</span> clean2;
02043             }
02044             wcscpy(Prefix, (PWSTR) stringValueBuffer-&gt;Data);
02045         }
02046         <span class="keywordflow">else</span>
02047         {
02048             <span class="comment">//</span>
02049             <span class="comment">// Parent has not been assigned a "ParentIdPrefix".</span>
02050             <span class="comment">// Compute the prefix:</span>
02051             <span class="comment">//    * Compute Hash</span>
02052             <span class="comment">//    * Look for value of the form:</span>
02053             <span class="comment">//        NextParentId.&lt;level&gt;.&lt;hash&gt;:REG_DWORD: &lt;NextInstance&gt;</span>
02054             <span class="comment">//      under CCS\Enum.  If not present, create it.</span>
02055             <span class="comment">//    * Assign the new "ParentIdPrefix" which will be of</span>
02056             <span class="comment">//      of the form:</span>
02057             <span class="comment">//        &lt;level&gt;&amp;&lt;hash&gt;&amp;&lt;instance&gt;</span>
02058             <span class="comment">//</span>
02059 
02060             <span class="comment">// Allocate a buffer once for the NextParentId... value</span>
02061             <span class="comment">// and for the prefix.</span>
02062             length = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(wcslen(REGSTR_VALUE_NEXT_PARENT_ID) + 2 + 8 + 8,
02063                          MAX_PARENT_PREFIX) + 1;
02064 
02065             <span class="comment">// Device instances are case in-sensitive.  Upcase before</span>
02066             <span class="comment">// performing hash to ensure that the hash is case-insensitve.</span>
02067             status = <a class="code" href="../../d6/d6/nls_8c.html#a31">RtlUpcaseUnicodeString</a>(&amp;valueName,
02068                                             &amp;parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>,
02069                                             TRUE);
02070             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
02071             {
02072                 <span class="keywordflow">goto</span> clean2;
02073             }
02074             <a class="code" href="../../d0/d1/pnpirp_8c.html#a1">HASH_UNICODE_STRING</a>(&amp;valueName, &amp;Hash);
02075             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;valueName);
02076 
02077             Prefix = (PWSTR) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool,
02078                                             length * <span class="keyword">sizeof</span>(WCHAR));
02079             <span class="keywordflow">if</span> (!Prefix) {
02080                 status = STATUS_INSUFFICIENT_RESOURCES;
02081                 <span class="keywordflow">goto</span> clean2;
02082             }
02083 
02084             <span class="comment">// Check for existence of "NextParentId...." value and update.</span>
02085             swprintf(Prefix, L<span class="stringliteral">"%s.%x.%x"</span>, REGSTR_VALUE_NEXT_PARENT_ID,
02086                      Hash, parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o4">Level</a>);
02087             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;valueName, Prefix);
02088             keyValue = (PKEY_VALUE_PARTIAL_INFORMATION)keyBuffer;
02089             status = ZwQueryValueKey(enumKey,
02090                                      &amp;valueName,
02091                                      KeyValuePartialInformation,
02092                                      keyValue,
02093                                      <span class="keyword">sizeof</span>(keyBuffer),
02094                                      &amp;length
02095                                      );
02096             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; (keyValue-&gt;Type == REG_DWORD) &amp;&amp;
02097                 (keyValue-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG))) {
02098                 hashInstance = *(PULONG)(keyValue-&gt;Data);
02099             }
02100             <span class="keywordflow">else</span> {
02101                 hashInstance = 0;
02102             }
02103 
02104             hashInstance++;
02105 
02106             status = ZwSetValueKey(enumKey,
02107                                    &amp;valueName,
02108                                    TITLE_INDEX_VALUE,
02109                                    REG_DWORD,
02110                                    &amp;hashInstance,
02111                                    <span class="keyword">sizeof</span>(hashInstance)
02112                                    );
02113 
02114             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02115                 <span class="keywordflow">goto</span> clean2;
02116             }
02117 
02118             hashInstance--;
02119 
02120             <span class="comment">// Create actual ParentIdPrefix string</span>
02121             PiWstrToUnicodeString(&amp;valueName, REGSTR_VALUE_PARENT_ID_PREFIX);
02122             length = swprintf(Prefix, L<span class="stringliteral">"%x&amp;%x&amp;%x"</span>, parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o4">Level</a>,
02123                      Hash, hashInstance) + 1;
02124             status = ZwSetValueKey(instanceKey,
02125                                    &amp;valueName,
02126                                    TITLE_INDEX_VALUE,
02127                                    REG_SZ,
02128                                    Prefix,
02129                                    length * <span class="keyword">sizeof</span>(WCHAR)
02130                                    );
02131             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
02132             {
02133                 <span class="keywordflow">goto</span> clean2;
02134             }
02135         }
02136     }
02137 
02138     <span class="comment">// Construct the instance id from the non-unique id (if any)</span>
02139     <span class="comment">// provided by the child and the prefix we've constructed.</span>
02140     length = wcslen(Prefix) + (UniqueId ? wcslen(UniqueId) : 0) + 2;
02141     <span class="keywordtype">id</span> = (PWSTR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, length * <span class="keyword">sizeof</span>(WCHAR));
02142     <span class="keywordflow">if</span> (!<span class="keywordtype">id</span>) {
02143         status = STATUS_INSUFFICIENT_RESOURCES;
02144     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (UniqueId) {
02145         swprintf(<span class="keywordtype">id</span>, L<span class="stringliteral">"%s&amp;%s"</span>, Prefix, UniqueId);
02146     } <span class="keywordflow">else</span> {
02147         wcscpy(<span class="keywordtype">id</span>, Prefix);
02148     }
02149 
02150 clean2:
02151     ZwClose(instanceKey);
02152 
02153 clean1:
02154     ZwClose(enumKey);
02155 
02156 clean0:
02157     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
02158     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02159 
02160     <span class="keywordflow">if</span> (stringValueBuffer) {
02161         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(stringValueBuffer);
02162     }
02163 
02164     <span class="keywordflow">if</span> (Prefix) {
02165         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Prefix);
02166     }
02167 
02168     *GloballyUniqueId = <span class="keywordtype">id</span>;
02169     <span class="keywordflow">return</span> status;
02170 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="pnpirp.c::IopQueryCompatibleIds" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryCompatibleIds           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/io_8h.html#a604">BUS_QUERY_ID_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IdType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PWCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>CompatibleIds</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT ULONG *&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02173">2173</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d0/d5/io_8h.html#a604a423">BusQueryCompatibleIDs</a>, <a class="el" href="../../d0/d5/io_8h.html#a604a422">BusQueryHardwareIDs</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00180">IRP_MN_QUERY_ID</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00994">IopStartAndEnumerateDevice()</a>.
<p>
<pre class="fragment"><div>02182                    :
02183 
02184     This routine sends irp to query HardwareIds or CompatibleIds.  This rotine
02185     queries MULTISZ Ids.
02186 
02187 Parameters:
02188 
02189     DeviceObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device being queried/
02190 
02191     IdType - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Id <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> interested.  Only HardwareIDs and CompatibleIDs
02192              are supported by <span class="keyword">this</span> routine.
02193 
02194     CompatibleId - Supplies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned Ids.
02195                    This must be freed by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
02196 
02197     Length - Supplies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IDs.
02198 
02199 Return Value:
02200 
02201     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
02202 
02203 --*/
02204 {
02205     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
02206     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02207 
02208     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02209 
02210     *Length = 0;
02211     <span class="keywordflow">if</span> ((IdType != <a class="code" href="../../d0/d5/io_8h.html#a604a422">BusQueryHardwareIDs</a>) &amp;&amp; (IdType != <a class="code" href="../../d0/d5/io_8h.html#a604a423">BusQueryCompatibleIDs</a>)) {
02212         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
02213     }
02214 
02215     <span class="comment">//</span>
02216     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
02217     <span class="comment">//</span>
02218 
02219     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
02220 
02221     <span class="comment">//</span>
02222     <span class="comment">// Set the function codes.</span>
02223     <span class="comment">//</span>
02224 
02225     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
02226     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a83">IRP_MN_QUERY_ID</a>;
02227 
02228     <span class="comment">//</span>
02229     <span class="comment">// Set the pointer to the resource list</span>
02230     <span class="comment">//</span>
02231 
02232     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryId.IdType = IdType;
02233 
02234     <span class="comment">//</span>
02235     <span class="comment">// Make the call and return.</span>
02236     <span class="comment">//</span>
02237 
02238     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(DeviceObject, &amp;irpSp, CompatibleIds);
02239 
02240     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; *CompatibleIds) {
02241 
02242         <span class="comment">//</span>
02243         <span class="comment">// The Compatible IDs and Hardware IDs are multi_sz,</span>
02244         <span class="comment">// try to determine its size.</span>
02245         <span class="comment">//</span>
02246 
02247         PWCHAR wp;
02248 
02249         <span class="keywordflow">for</span> (wp = *CompatibleIds;
02250              (*wp != UNICODE_NULL) || (*(wp + 1) != UNICODE_NULL);
02251              wp++) {
02252 
02253             *Length += 2;
02254         }
02255         *Length += 4;
02256     }
02257 
02258     <span class="keywordflow">return</span> status;
02259 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="pnpirp.c::IopQueryDeviceId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryDeviceId           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PWCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceId</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01762">1762</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d0/d5/io_8h.html#a604a421">BusQueryDeviceID</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00180">IRP_MN_QUERY_ID</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>.
<p>
<pre class="fragment"><div>01769                    :
01770 
01771     This routine sends a query device <span class="keywordtype">id</span> irp to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device object.
01772 
01773 Parameters:
01774 
01775     DeviceObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device being queried/
01776 
01777     DeviceId - Supplies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned Id.
01778                This must be freed by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
01779 
01780 Return Value:
01781 
01782     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
01783 
01784 --*/
01785 {
01786     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
01787     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01788 
01789     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01790 
01791     <span class="comment">//</span>
01792     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
01793     <span class="comment">//</span>
01794 
01795     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
01796 
01797     <span class="comment">//</span>
01798     <span class="comment">// Set the function codes.</span>
01799     <span class="comment">//</span>
01800 
01801     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
01802     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a83">IRP_MN_QUERY_ID</a>;
01803 
01804     <span class="comment">//</span>
01805     <span class="comment">// Set the pointer to the resource list</span>
01806     <span class="comment">//</span>
01807 
01808     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryId.IdType = <a class="code" href="../../d0/d5/io_8h.html#a604a421">BusQueryDeviceID</a>;
01809 
01810     <span class="comment">//</span>
01811     <span class="comment">// Make the call and return.</span>
01812     <span class="comment">//</span>
01813 
01814     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(DeviceObject, &amp;irpSp, DeviceId);
01815 
01816     <span class="keywordflow">return</span> status;
01817 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="pnpirp.c::IopQueryDeviceRelations" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryDeviceRelations           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d5/io_8h.html#a358">DEVICE_RELATION_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Relations</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AsyncOk</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d0/d5/struct__DEVICE__RELATIONS.html">PDEVICE_RELATIONS</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceRelations</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01604">1604</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d0/d5/io_8h.html#a602a412">BusRelations</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00092">_DEVICE_COMPLETION_CONTEXT::DeviceNode</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00515">DNF_BEING_ENUMERATED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00529">DNF_ENUMERATION_REQUEST_PENDING</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00522">DNF_ENUMERATION_REQUEST_QUEUED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00508">DNF_IO_INVALIDATE_DEVICE_RELATIONS_PENDING</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02455">ExGetCurrentResourceThread</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01266">IopAcquireEnumerationLock</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00262">IopAsynchronousCall()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01496">IopDeviceRelationsComplete()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00068">IopPnPSpinLock</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00207">IopRequestDeviceAction()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00168">IRP_MN_QUERY_DEVICE_RELATIONS</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00094">_DEVICE_COMPLETION_CONTEXT::IrpMinorCode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html#o32">_DEVICE_NODE::OverUsed1</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d0/d1/pnpirp_8c.html#a6">PDEVICE_COMPLETION_CONTEXT</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a391a218">ReenumerateDeviceTree</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00093">_DEVICE_COMPLETION_CONTEXT::Thread</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01163">IopEnumerateDevice()</a>, and <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00917">IopProcessRelation()</a>.
<p>
<pre class="fragment"><div>01613                    :
01614 
01615     This routine sends query device relation irp to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device object.
01616 
01617 Parameters:
01618 
01619     Relations - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of relation interested.
01620 
01621     DeviceObjet - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device being queried.
01622 
01623     AsyncOk - Specifies <span class="keywordflow">if</span> we can perform Async QueryDeviceRelations
01624 
01625     DeviceRelations - Supplies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned
01626                       relation information. This must be freed by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
01627 
01628 Return Value:
01629 
01630     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
01631 
01632 --*/
01633 
01634 {
01635     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
01636     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01637     <a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html">PDEVICE_RELATIONS</a> deviceRelations;
01638     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
01639     <a class="code" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html">PDEVICE_COMPLETION_CONTEXT</a> completionContext;
01640     BOOLEAN requestEnumeration = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01641     KIRQL oldIrql;
01642 
01643     <span class="comment">//</span>
01644     <span class="comment">// Do not allow two bus relations at the same time</span>
01645     <span class="comment">//</span>
01646 
01647     <span class="keywordflow">if</span> (Relations == <a class="code" href="../../d0/d5/io_8h.html#a602a412">BusRelations</a>) {
01648         ExAcquireSpinLock(&amp;IopPnPSpinLock, &amp;oldIrql);
01649         <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a27">DNF_BEING_ENUMERATED</a>) {
01650             ExReleaseSpinLock(&amp;IopPnPSpinLock, oldIrql);
01651             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01652         }
01653         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a28">DNF_ENUMERATION_REQUEST_QUEUED</a>;
01654         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a>  |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a27">DNF_BEING_ENUMERATED</a>;
01655         ExReleaseSpinLock(&amp;IopPnPSpinLock, oldIrql);
01656     }
01657 
01658     <span class="comment">//</span>
01659     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
01660     <span class="comment">//</span>
01661 
01662     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
01663 
01664     <span class="comment">//</span>
01665     <span class="comment">// Set the function codes.</span>
01666     <span class="comment">//</span>
01667 
01668     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
01669     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a72">IRP_MN_QUERY_DEVICE_RELATIONS</a>;
01670 
01671     <span class="comment">//</span>
01672     <span class="comment">// Set the pointer to the resource list</span>
01673     <span class="comment">//</span>
01674 
01675     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDeviceRelations.Type = Relations;
01676 
01677     <span class="comment">//</span>
01678     <span class="comment">// Make the call and return.</span>
01679     <span class="comment">//</span>
01680 
01681     <span class="keywordflow">if</span> (AsyncOk &amp;&amp; Relations == <a class="code" href="../../d0/d5/io_8h.html#a602a412">BusRelations</a>) {
01682         completionContext = (<a class="code" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html">PDEVICE_COMPLETION_CONTEXT</a>) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
01683                               NonPagedPool,
01684                               <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html">DEVICE_COMPLETION_CONTEXT</a>));
01685         <span class="keywordflow">if</span> (completionContext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01686             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;   <span class="comment">// BUGBUG - Should try it again.</span>
01687         }
01688 
01689         completionContext-&gt;<a class="code" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html#o0">DeviceNode</a> = deviceNode;
01690         completionContext-&gt;<a class="code" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html#o2">IrpMinorCode</a> = <a class="code" href="../../d0/d5/io_8h.html#a72">IRP_MN_QUERY_DEVICE_RELATIONS</a>;
01691         completionContext-&gt;<a class="code" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html#o1">Thread</a> = <a class="code" href="../../d5/d8/ex_8h.html#a67">ExGetCurrentResourceThread</a>();
01692 
01693         <span class="comment">//</span>
01694         <span class="comment">// Make the call and return.</span>
01695         <span class="comment">//</span>
01696 
01697         <a class="code" href="../../d9/d0/pnpiop_8h.html#a95">IopAcquireEnumerationLock</a>(NULL);  <span class="comment">// To block IopAcquireTreeLock();</span>
01698         status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a9">IopAsynchronousCall</a>(DeviceObject, &amp;irpSp, completionContext, IopDeviceRelationsComplete);
01699         <span class="keywordflow">if</span> (status == STATUS_PENDING) {
01700             KIRQL oldIrql;
01701 
01702             ExAcquireSpinLock(&amp;IopPnPSpinLock, &amp;oldIrql);
01703 
01704             <span class="comment">//</span>
01705             <span class="comment">// Check if the completion routine completes before we setting</span>
01706             <span class="comment">// the DNF_ENUMERATION_REQUEST_PENDING flags.</span>
01707             <span class="comment">//</span>
01708 
01709             <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a29">DNF_ENUMERATION_REQUEST_PENDING</a>) {
01710                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a29">DNF_ENUMERATION_REQUEST_PENDING</a>;
01711                 *DeviceRelations = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o32">OverUsed1</a>.PendingDeviceRelations;
01712                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o32">OverUsed1</a>.PendingDeviceRelations = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01713                 status = STATUS_SUCCESS;
01714             } <span class="keywordflow">else</span> {
01715 
01716                 <span class="comment">//</span>
01717                 <span class="comment">// Set DNF_ENUMERATION_REQUEST_PENDING such that the completion routine knows it</span>
01718                 <span class="comment">// needs to request enumeration when the Q_bus_relations completed successfully.</span>
01719                 <span class="comment">//</span>
01720 
01721                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a29">DNF_ENUMERATION_REQUEST_PENDING</a>;
01722             }
01723 
01724             ExReleaseSpinLock(&amp;IopPnPSpinLock, oldIrql);
01725         } <span class="keywordflow">else</span> {
01726             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a29">DNF_ENUMERATION_REQUEST_PENDING</a>;
01727             *DeviceRelations = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o32">OverUsed1</a>.PendingDeviceRelations;
01728             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o32">OverUsed1</a>.PendingDeviceRelations = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01729         }
01730         <span class="keywordflow">return</span> status;
01731     } <span class="keywordflow">else</span> {
01732         status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(DeviceObject, &amp;irpSp, DeviceRelations);
01733 
01734         <span class="comment">//</span>
01735         <span class="comment">// To prevent the scenario that a driver calls IoInvalidateDeviceRelations while servicing</span>
01736         <span class="comment">// an Async Q-D-R irp, and receives another q-d-r irp before first one completed, we will</span>
01737         <span class="comment">// set a flag when it calls IoInvalidateDeviceRelations and delay queuing the request till</span>
01738         <span class="comment">// the original one is completed.</span>
01739         <span class="comment">//</span>
01740 
01741         <span class="keywordflow">if</span> (Relations == <a class="code" href="../../d0/d5/io_8h.html#a602a412">BusRelations</a>) {
01742             ExAcquireSpinLock(&amp;IopPnPSpinLock, &amp;oldIrql);
01743             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a>  &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a27">DNF_BEING_ENUMERATED</a>;
01744             <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a26">DNF_IO_INVALIDATE_DEVICE_RELATIONS_PENDING</a>) {
01745                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a26">DNF_IO_INVALIDATE_DEVICE_RELATIONS_PENDING</a>;
01746                 requestEnumeration = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01747             }
01748             ExReleaseSpinLock(&amp;IopPnPSpinLock, oldIrql);
01749             <span class="keywordflow">if</span> (requestEnumeration) {
01750                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a305">IopRequestDeviceAction</a>( DeviceObject,
01751                                         ReenumerateDeviceTree,
01752                                         NULL,
01753                                         NULL );
01754             }
01755         }
01756     }
01757 
01758     <span class="keywordflow">return</span> status;
01759 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="pnpirp.c::IopQueryDeviceResources" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryDeviceResources           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Resource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT ULONG *&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">2262</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00370">DNF_MADEUP</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00440">DNF_RESOURCE_REQUIREMENTS_NEED_FILTERED</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l04279">IopCmResourcesToIoResources()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03523">IopDetermineResourceListSize()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03776">IopDeviceObjectToDeviceInstance()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l03255">IopFilterResourceRequirementsCall()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l04479">IopFilterResourceRequirementsList()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03967">IopGetDeviceResourcesFromRegistry()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l04996">IopMergeFilteredResourceRequirementsList()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00172">IRP_MN_QUERY_RESOURCE_REQUIREMENTS</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00171">IRP_MN_QUERY_RESOURCES</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00740">QUERY_RESOURCE_LIST</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00741">QUERY_RESOURCE_REQUIREMENTS</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00743">REGISTRY_ALLOC_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00747">REGISTRY_BASIC_CONFIGVECTOR</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00745">REGISTRY_BOOT_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00744">REGISTRY_FORCED_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00746">REGISTRY_OVERRIDE_CONFIGVECTOR</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00201">_DEVICE_NODE::ResourceRequirements</a>, and <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01066">IopGetResourceRequirementsForAssignTable()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, and <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00263">IopReleaseDeviceResources()</a>.
<p>
<pre class="fragment"><div>02271                    :
02272 
02273     This routine sends irp to queries resources or resource requirements list
02274     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device object.
02275 
02276     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a detected device, its resources will be read from
02277     registry.  Otherwise, an irp <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> sent to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bus driver to query its resources.
02278 
02279 Parameters:
02280 
02281     DeviceObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device being queries.
02282 
02283     ResourceType - 0 <span class="keywordflow">for</span> device resources and 1 <span class="keywordflow">for</span> resource requirements list.
02284 
02285     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - Supplies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned resources
02286 
02287     Length - Supplies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned
02288              resources or resource requirements list.
02289 
02290 Return Value:
02291 
02292     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
02293 
02294 --*/
02295 {
02296     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
02297     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
02298     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02299     PIO_RESOURCE_REQUIREMENTS_LIST resReqList, newResources;
02300     ULONG junk;
02301     PCM_RESOURCE_LIST cmList;
02302     PIO_RESOURCE_REQUIREMENTS_LIST filteredList, mergedList;
02303     BOOLEAN exactMatch;
02304 
02305     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02306 
02307 <span class="preprocessor">#if DBG</span>
02308 <span class="preprocessor"></span>
02309     <span class="keywordflow">if</span> ((ResourceType != <a class="code" href="../../d9/d0/pnpiop_8h.html#a60">QUERY_RESOURCE_LIST</a>) &amp;&amp;
02310         (ResourceType != <a class="code" href="../../d9/d0/pnpiop_8h.html#a61">QUERY_RESOURCE_REQUIREMENTS</a>)) {
02311         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
02312     }
02313 <span class="preprocessor">#endif</span>
02314 <span class="preprocessor"></span>
02315     *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02316     *Length = 0;
02317 
02318     <span class="comment">//</span>
02319     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
02320     <span class="comment">//</span>
02321 
02322     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
02323 
02324     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>) DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
02325 
02326     <span class="keywordflow">if</span> (ResourceType == <a class="code" href="../../d9/d0/pnpiop_8h.html#a60">QUERY_RESOURCE_LIST</a>) {
02327 
02328         <span class="comment">//</span>
02329         <span class="comment">// caller is asked for RESOURCE_LIST.  If this is a madeup device, we will</span>
02330         <span class="comment">// read it from registry.  Otherwise, we ask drivers.</span>
02331         <span class="comment">//</span>
02332 
02333         <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>) {
02334 
02335             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a26">IopGetDeviceResourcesFromRegistry</a>(
02336                              DeviceObject,
02337                              ResourceType,
02338                              REGISTRY_ALLOC_CONFIG + REGISTRY_FORCED_CONFIG + REGISTRY_BOOT_CONFIG,
02339                              Resource,
02340                              Length);
02341             <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND) {
02342                 status = STATUS_SUCCESS;
02343             }
02344             <span class="keywordflow">return</span> status;
02345         } <span class="keywordflow">else</span> {
02346             irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a75">IRP_MN_QUERY_RESOURCES</a>;
02347             irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
02348             status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(DeviceObject, &amp;irpSp, Resource);
02349             <span class="keywordflow">if</span> (status == STATUS_NOT_SUPPORTED) {
02350 
02351                 <span class="comment">//</span>
02352                 <span class="comment">// If driver doesn't implement this request, it</span>
02353                 <span class="comment">// doesn't consume any resources.</span>
02354                 <span class="comment">//</span>
02355 
02356                 *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02357                 status = STATUS_SUCCESS;
02358             }
02359             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02360                 *Length = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>((PCM_RESOURCE_LIST)*Resource);
02361             }
02362             <span class="keywordflow">return</span> status;
02363         }
02364     } <span class="keywordflow">else</span> {
02365 
02366         <span class="comment">//</span>
02367         <span class="comment">// Caller is asked for resource requirements list.  We will check:</span>
02368         <span class="comment">// if there is a ForcedConfig, it will be converted to resource requirements</span>
02369         <span class="comment">//     list and return.  Otherwise,</span>
02370         <span class="comment">// If there is an OVerrideConfigVector, we will use it as our</span>
02371         <span class="comment">//     FilterConfigVector.  Otherwise we ask driver for the config vector and</span>
02372         <span class="comment">//     use it as our FilterConfigVector.</span>
02373         <span class="comment">//     Finaly, we pass the FilterConfigVector to driver stack to let drivers</span>
02374         <span class="comment">//     filter the requirements.</span>
02375         <span class="comment">//</span>
02376 
02377         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a26">IopGetDeviceResourcesFromRegistry</a>(
02378                          DeviceObject,
02379                          QUERY_RESOURCE_LIST,
02380                          REGISTRY_FORCED_CONFIG,
02381                          Resource,
02382                          &amp;junk);
02383         <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND) {
02384             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a26">IopGetDeviceResourcesFromRegistry</a>(
02385                              DeviceObject,
02386                              QUERY_RESOURCE_REQUIREMENTS,
02387                              REGISTRY_OVERRIDE_CONFIGVECTOR,
02388                              &amp;resReqList,
02389                              &amp;junk);
02390             <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND) {
02391                 <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>) {
02392                     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a26">IopGetDeviceResourcesFromRegistry</a>(
02393                                      DeviceObject,
02394                                      QUERY_RESOURCE_REQUIREMENTS,
02395                                      REGISTRY_BASIC_CONFIGVECTOR,
02396                                      &amp;resReqList,
02397                                      &amp;junk);
02398                     <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND) {
02399                         status = STATUS_SUCCESS;
02400                         resReqList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02401                     }
02402                 } <span class="keywordflow">else</span> {
02403 
02404                     <span class="comment">//</span>
02405                     <span class="comment">// We are going to ask the bus driver ...</span>
02406                     <span class="comment">//</span>
02407 
02408                     <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o16">ResourceRequirements</a>) {
02409                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; DNF_RESOURCE_REQUIREMENTS_NEED_FILTERED);
02410                         resReqList = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o16">ResourceRequirements</a>-&gt;ListSize);
02411                         <span class="keywordflow">if</span> (resReqList) {
02412                             RtlMoveMemory(resReqList,
02413                                          deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o16">ResourceRequirements</a>,
02414                                          deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o16">ResourceRequirements</a>-&gt;ListSize
02415                                          );
02416                             status = STATUS_SUCCESS;
02417                         } <span class="keywordflow">else</span> {
02418                             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02419                         }
02420                     } <span class="keywordflow">else</span> {
02421                         irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a76">IRP_MN_QUERY_RESOURCE_REQUIREMENTS</a>;
02422                         irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
02423                         status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(DeviceObject, &amp;irpSp, &amp;resReqList);
02424                         <span class="keywordflow">if</span> (status == STATUS_NOT_SUPPORTED) {
02425 
02426                             <span class="comment">//</span>
02427                             <span class="comment">// If driver doesn't implement this request, it</span>
02428                             <span class="comment">// doesn't require any resources.</span>
02429                             <span class="comment">//</span>
02430 
02431                             status = STATUS_SUCCESS;
02432                             resReqList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02433 
02434                         }
02435                     }
02436                 }
02437                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02438                     <span class="keywordflow">return</span> status;
02439                 }
02440             }
02441 
02442             <span class="comment">//</span>
02443             <span class="comment">// For devices with boot config, we need to filter the resource requirements</span>
02444             <span class="comment">// list against boot config.</span>
02445             <span class="comment">//</span>
02446 
02447             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a26">IopGetDeviceResourcesFromRegistry</a>(
02448                              DeviceObject,
02449                              QUERY_RESOURCE_LIST,
02450                              REGISTRY_BOOT_CONFIG,
02451                              &amp;cmList,
02452                              &amp;junk);
02453             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp;
02454                 (!cmList || cmList-&gt;Count == 0 || cmList-&gt;List[0].InterfaceType != PCIBus)) {
02455                 status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a29">IopFilterResourceRequirementsList</a> (
02456                              resReqList,
02457                              cmList,
02458                              &amp;filteredList,
02459                              &amp;exactMatch);
02460                 <span class="keywordflow">if</span> (cmList) {
02461                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(cmList);
02462                 }
02463                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02464                     <span class="keywordflow">if</span> (resReqList) {
02465                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(resReqList);
02466                     }
02467                     <span class="keywordflow">return</span> status;
02468                 } <span class="keywordflow">else</span> {
02469 
02470                     <span class="comment">//</span>
02471                     <span class="comment">// For non-root-enumerated devices, we merge filtered config with basic config</span>
02472                     <span class="comment">// vectors to form a new res req list.  For root-enumerated devices, we don't</span>
02473                     <span class="comment">// consider Basic config vector.</span>
02474                     <span class="comment">//</span>
02475 
02476                     <span class="keywordflow">if</span> (!(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>) &amp;&amp;
02477                         (exactMatch == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> || resReqList-&gt;AlternativeLists &gt; 1)) {
02478                         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a30">IopMergeFilteredResourceRequirementsList</a> (
02479                                  filteredList,
02480                                  resReqList,
02481                                  &amp;mergedList
02482                                  );
02483                         <span class="keywordflow">if</span> (resReqList) {
02484                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(resReqList);
02485                         }
02486                         <span class="keywordflow">if</span> (filteredList) {
02487                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(filteredList);
02488                         }
02489                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02490                             resReqList = mergedList;
02491                         } <span class="keywordflow">else</span> {
02492                             <span class="keywordflow">return</span> status;
02493                         }
02494                     } <span class="keywordflow">else</span> {
02495                         <span class="keywordflow">if</span> (resReqList) {
02496                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(resReqList);
02497                         }
02498                         resReqList = filteredList;
02499                     }
02500                 }
02501             }
02502 
02503         } <span class="keywordflow">else</span> {
02504             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
02505 
02506             <span class="comment">//</span>
02507             <span class="comment">// We have Forced Config.  Convert it to resource requirements and return it.</span>
02508             <span class="comment">//</span>
02509 
02510             <span class="keywordflow">if</span> (*Resource) {
02511                 resReqList = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a28">IopCmResourcesToIoResources</a> (0, (PCM_RESOURCE_LIST)*Resource, LCPRI_FORCECONFIG);
02512                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(*Resource);
02513                 <span class="keywordflow">if</span> (resReqList) {
02514                     *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> = (PVOID)resReqList;
02515                     *Length = resReqList-&gt;ListSize;
02516                 } <span class="keywordflow">else</span> {
02517                     *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02518                     *Length = 0;
02519                     status = STATUS_INSUFFICIENT_RESOURCES;
02520                     <span class="keywordflow">return</span> status;
02521                 }
02522             } <span class="keywordflow">else</span> {
02523                 resReqList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02524             }
02525         }
02526 
02527         <span class="comment">//</span>
02528         <span class="comment">// If we are here, we have a resource requirements list for drivers to examine ...</span>
02529         <span class="comment">// NOTE: Per Lonny's request, we let drivers filter ForcedConfig</span>
02530         <span class="comment">//</span>
02531 
02532         status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a16">IopFilterResourceRequirementsCall</a>(
02533             DeviceObject,
02534             resReqList,
02535             &amp;newResources
02536             );
02537 
02538         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02539             UNICODE_STRING unicodeName;
02540             HANDLE handle, handlex;
02541 
02542 <span class="preprocessor">#if DBG</span>
02543 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (newResources == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; resReqList) {
02544                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"PnpMgr: Non-NULL resource requirements list filtered to NULL\n"</span>);
02545             }
02546 <span class="preprocessor">#endif</span>
02547 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (newResources) {
02548 
02549                 *Length = newResources-&gt;ListSize;
02550                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(*Length);
02551 
02552                 <span class="comment">//</span>
02553                 <span class="comment">// Make our own copy of the allocation. We do this so that the</span>
02554                 <span class="comment">// verifier doesn't believe the driver has leaked memory if</span>
02555                 <span class="comment">// unloaded.</span>
02556                 <span class="comment">//</span>
02557 
02558                 *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> = (PVOID) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, *Length);
02559                 <span class="keywordflow">if</span> (*<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02560 
02561                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(newResources);
02562                     <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02563                 }
02564 
02565                 RtlCopyMemory(*Resource, newResources, *Length);
02566                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(newResources);
02567 
02568             } <span class="keywordflow">else</span> {
02569                 *Length = 0;
02570                 *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02571             }
02572 
02573             <span class="comment">//</span>
02574             <span class="comment">// Write filtered res req to registry</span>
02575             <span class="comment">//</span>
02576 
02577             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">IopDeviceObjectToDeviceInstance</a>(DeviceObject, &amp;handlex, KEY_ALL_ACCESS);
02578             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02579                 PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_CONTROL);
02580                 status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
02581                                                handlex,
02582                                                &amp;unicodeName,
02583                                                KEY_READ
02584                                                );
02585                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02586                     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VALUE_FILTERED_CONFIG_VECTOR);
02587                     ZwSetValueKey(handle,
02588                                   &amp;unicodeName,
02589                                   TITLE_INDEX_VALUE,
02590                                   REG_RESOURCE_REQUIREMENTS_LIST,
02591                                   *Resource,
02592                                   *Length
02593                                   );
02594                     ZwClose(handle);
02595                     ZwClose(handlex);
02596                 }
02597             }
02598         } <span class="keywordflow">else</span> {
02599 
02600             <span class="comment">//</span>
02601             <span class="comment">// ADRIAO BUGBUG 05/26/1999 -</span>
02602             <span class="comment">//     Why do we not bubble up non-STATUS_NOT_SUPPORTED failure</span>
02603             <span class="comment">// codes?</span>
02604             <span class="comment">//</span>
02605             *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> = resReqList;
02606             <span class="keywordflow">if</span> (resReqList) {
02607                 *Length = resReqList-&gt;ListSize;
02608             } <span class="keywordflow">else</span> {
02609                 *Length = 0;
02610             }
02611         }
02612         <span class="keywordflow">return</span> STATUS_SUCCESS;
02613     }
02614 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="pnpirp.c::IopQueryDeviceSerialNumber" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryDeviceSerialNumber           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PWCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>SerialNumber</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l03195">3195</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d5/io_8h.html#a604a425">BusQueryDeviceSerialNumber</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00180">IRP_MN_QUERY_ID</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00370">IopHardwareProfileCommitStartedDock()</a>, and <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00160">IopHardwareProfileMarkDock()</a>.
<p>
<pre class="fragment"><div>03202                    :
03203 
03204     This routine retrieves a hardware serial number <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device object.
03205     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine fails, SerialNumber <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> guarenteed to be to <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
03206 
03207 Parameters:
03208 
03209     DeviceObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device being queried
03210 
03211     SerialNumber - Supplies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned Id.
03212                    This must be freed by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
03213 
03214 Return Value:
03215 
03216     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
03217 
03218 --*/
03219 {
03220     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
03221     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03222 
03223     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03224 
03225     *SerialNumber = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03226 
03227     <span class="comment">//</span>
03228     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
03229     <span class="comment">//</span>
03230 
03231     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
03232 
03233     <span class="comment">//</span>
03234     <span class="comment">// Set the function codes.</span>
03235     <span class="comment">//</span>
03236 
03237     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
03238     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a83">IRP_MN_QUERY_ID</a>;
03239     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryId.IdType = <a class="code" href="../../d0/d5/io_8h.html#a604a425">BusQueryDeviceSerialNumber</a>;
03240 
03241     <span class="comment">//</span>
03242     <span class="comment">// Make the call and return.</span>
03243     <span class="comment">//</span>
03244 
03245     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(DeviceObject, &amp;irpSp, SerialNumber);
03246 
03247     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) || (*SerialNumber == NULL));
03248     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03249         *SerialNumber = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03250     }
03251     <span class="keywordflow">return</span> status;
03252 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="pnpirp.c::IopQueryDeviceState" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryDeviceState           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02976">2976</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00544">DNF_HAS_PRIVATE_PROBLEM</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00595">DNUF_DONT_SHOW_IN_UI</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00610">DNUF_NOT_DISABLEABLE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l03152">IopDecDisableableDepends()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l03109">IopIncDisableableDepends()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01708">IopRequestDeviceRemoval()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06439">IopResourceRequirementsChanged()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00181">IRP_MN_QUERY_PNP_DEVICE_STATE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02001">PNP_DEVICE_DISABLED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02002">PNP_DEVICE_DONT_DISPLAY_IN_UI</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02003">PNP_DEVICE_FAILED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02006">PNP_DEVICE_NOT_DISABLEABLE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02004">PNP_DEVICE_REMOVED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02005">PNP_DEVICE_RESOURCE_REQUIREMENTS_CHANGED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01999">PNP_DEVICE_STATE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00136">_DEVICE_NODE::UserFlags</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06387">IopInvalidateDeviceStateWorker()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00994">IopStartAndEnumerateDevice()</a>.
<p>
<pre class="fragment"><div>02982                    :
02983 
02984     This routine sends query device state irp to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device object.
02985 
02986 Parameters:
02987 
02988     DeviceObjet - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device being queried.
02989 
02990 Return Value:
02991 
02992     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
02993 
02994 --*/
02995 
02996 {
02997     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
02998     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
02999     <a class="code" href="../../d0/d5/io_8h.html#a370">PNP_DEVICE_STATE</a> deviceState;
03000     <a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html">PDEVICE_RELATIONS</a> deviceRelations;
03001     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> userEvent;
03002     ULONG eventResult;
03003     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03004 
03005     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03006 
03007     <span class="comment">//</span>
03008     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
03009     <span class="comment">//</span>
03010 
03011     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
03012 
03013     <span class="comment">//</span>
03014     <span class="comment">// Set the function codes.</span>
03015     <span class="comment">//</span>
03016 
03017     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
03018     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a84">IRP_MN_QUERY_PNP_DEVICE_STATE</a>;
03019 
03020     <span class="comment">//</span>
03021     <span class="comment">// Make the call.</span>
03022     <span class="comment">//</span>
03023 
03024     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(DeviceObject, &amp;irpSp, (PVOID *)&amp;deviceState);
03025 
03026     <span class="comment">//</span>
03027     <span class="comment">// Now perform the appropriate action based on the returned state</span>
03028     <span class="comment">//</span>
03029 
03030     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03031 
03032         deviceNode = DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
03033 
03034         <span class="keywordflow">if</span> (deviceState != 0) {
03035 
03036             <span class="comment">//</span>
03037             <span class="comment">// everything here can only be turned on (state set)</span>
03038             <span class="comment">//</span>
03039 
03040             <span class="keywordflow">if</span> (deviceState &amp; <a class="code" href="../../d0/d5/io_8h.html#a214">PNP_DEVICE_DONT_DISPLAY_IN_UI</a>) {
03041 
03042                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o7">UserFlags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a38">DNUF_DONT_SHOW_IN_UI</a>;
03043             }
03044 
03045             <span class="keywordflow">if</span> (deviceState &amp; <a class="code" href="../../d0/d5/io_8h.html#a218">PNP_DEVICE_NOT_DISABLEABLE</a>) {
03046 
03047                 <span class="keywordflow">if</span> ((deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o7">UserFlags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a40">DNUF_NOT_DISABLEABLE</a>)==0) {
03048                     <span class="comment">//</span>
03049                     <span class="comment">// this node itself is not disableable</span>
03050                     <span class="comment">//</span>
03051                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o7">UserFlags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a40">DNUF_NOT_DISABLEABLE</a>;
03052                     <span class="comment">//</span>
03053                     <span class="comment">// propagate up tree</span>
03054                     <span class="comment">//</span>
03055                     <a class="code" href="../../d0/d1/pnpirp_8c.html#a33">IopIncDisableableDepends</a>(deviceNode);
03056 
03057                 }
03058             }
03059 
03060             <span class="keywordflow">if</span> (deviceState &amp; (<a class="code" href="../../d0/d5/io_8h.html#a213">PNP_DEVICE_DISABLED</a> | <a class="code" href="../../d0/d5/io_8h.html#a216">PNP_DEVICE_REMOVED</a>)) {
03061 
03062                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a306">IopRequestDeviceRemoval</a>( DeviceObject,
03063                                          (deviceState &amp; PNP_DEVICE_DISABLED) ?
03064                                             CM_PROB_HARDWARE_DISABLED : CM_PROB_DEVICE_NOT_THERE
03065                                          );
03066 
03067             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (deviceState &amp; <a class="code" href="../../d0/d5/io_8h.html#a217">PNP_DEVICE_RESOURCE_REQUIREMENTS_CHANGED</a>) {
03068 
03069                 <span class="keywordflow">if</span> (deviceState &amp; <a class="code" href="../../d0/d5/io_8h.html#a215">PNP_DEVICE_FAILED</a>) {
03070 
03071                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a278">IopResourceRequirementsChanged</a>(DeviceObject, TRUE);
03072 
03073                 } <span class="keywordflow">else</span> {
03074 
03075                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a278">IopResourceRequirementsChanged</a>(DeviceObject, FALSE);
03076 
03077                 }
03078             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (deviceState &amp; <a class="code" href="../../d0/d5/io_8h.html#a215">PNP_DEVICE_FAILED</a>) {
03079 
03080                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a31">DNF_HAS_PRIVATE_PROBLEM</a>;
03081 
03082                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a306">IopRequestDeviceRemoval</a>(DeviceObject, 0);
03083             }
03084         } <span class="keywordflow">else</span> {
03085 
03086             <span class="comment">//</span>
03087             <span class="comment">// handle things that can be turned off (state cleared)</span>
03088             <span class="comment">//</span>
03089 
03090             <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o7">UserFlags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a40">DNUF_NOT_DISABLEABLE</a>) {
03091                 <span class="comment">//</span>
03092                 <span class="comment">// this node itself is now disableable</span>
03093                 <span class="comment">//</span>
03094                 <span class="comment">//</span>
03095                 <span class="comment">// check tree</span>
03096                 <span class="comment">//</span>
03097                 <a class="code" href="../../d0/d1/pnpirp_8c.html#a34">IopDecDisableableDepends</a>(deviceNode);
03098             }
03099 
03100             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o7">UserFlags</a> &amp;= ~(<a class="code" href="../../d9/d0/pnpiop_8h.html#a38">DNUF_DONT_SHOW_IN_UI</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a40">DNUF_NOT_DISABLEABLE</a>);
03101         }
03102     }
03103 
03104     <span class="keywordflow">return</span> status;
03105 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="pnpirp.c::IopQueryDockRemovalInterface" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryDockRemovalInterface           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PDOCK_INTERFACE *&nbsp;</td>
          <td class="mdname" nowrap> <em>DockInterface</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l03395">3395</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d1/d1/config_2test_2init386_8c-source.html#l00027">dummy()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00169">IRP_MN_QUERY_INTERFACE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01941">_INTERFACE::Size</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01942">_INTERFACE::Version</a>.
<p>
<pre class="fragment"><div>03402                    :
03403 
03404     This routine queries <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified DeviceObject <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dock removal
03405     interface. We use <span class="keyword">this</span> interface to send pseudo-remove's. We use <span class="keyword">this</span>
03406     to solve <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> removal orderings problem.
03407 
03408 Parameters:
03409 
03410     DeviceObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Device object to be queried.
03411 
03412     Interface - supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired interface.
03413 
03414 Return Value:
03415 
03416     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
03417 
03418 --*/
03419 {
03420     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
03421     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03422     PVOID <a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>;
03423     <a class="code" href="../../d8/d3/struct__INTERFACE.html">PINTERFACE</a> interface;
03424     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> size;
03425     GUID interfaceType;
03426 
03427     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03428 
03429     size = <span class="keyword">sizeof</span>(DOCK_INTERFACE);
03430     interfaceType = GUID_DOCK_INTERFACE;
03431     interface = (<a class="code" href="../../d8/d3/struct__INTERFACE.html">PINTERFACE</a>) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, size);
03432     <span class="keywordflow">if</span> (interface == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03433         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
03434     }
03435 
03436     RtlZeroMemory(interface, size);
03437     interface-&gt;<a class="code" href="../../d8/d3/struct__INTERFACE.html#o0">Size</a> = size;
03438 
03439     <span class="comment">//</span>
03440     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
03441     <span class="comment">//</span>
03442 
03443     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
03444 
03445     <span class="comment">//</span>
03446     <span class="comment">// Set the function codes.</span>
03447     <span class="comment">//</span>
03448 
03449     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
03450     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a73">IRP_MN_QUERY_INTERFACE</a>;
03451 
03452     <span class="comment">//</span>
03453     <span class="comment">// Set the pointer to the resource list</span>
03454     <span class="comment">//</span>
03455 
03456     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.InterfaceType = &amp;interfaceType;
03457     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.Size = interface-&gt;<a class="code" href="../../d8/d3/struct__INTERFACE.html#o0">Size</a>;
03458     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.Version = interface-&gt;<a class="code" href="../../d8/d3/struct__INTERFACE.html#o1">Version</a> = 0;
03459     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.Interface = interface;
03460     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.InterfaceSpecificData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03461 
03462     <span class="comment">//</span>
03463     <span class="comment">// Make the call and return.</span>
03464     <span class="comment">//</span>
03465 
03466     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(DeviceObject, &amp;irpSp, &amp;dummy);
03467     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03468         *DockInterface = (PDOCK_INTERFACE) interface;
03469     } <span class="keywordflow">else</span> {
03470         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(interface);
03471     }
03472     <span class="keywordflow">return</span> status;
03473 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="pnpirp.c::IopQueryLegacyBusInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryLegacyBusInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT LPGUID&nbsp;</td>
          <td class="mdname" nowrap> <em>InterfaceGuid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OPTIONAL OUT INTERFACE_TYPE *&nbsp;</td>
          <td class="mdname" nowrap> <em>InterfaceType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OPTIONAL OUT ULONG *<a class="el" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02793">2793</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00110">_LEGACY_BUS_INFORMATION::BusNumber</a>, <a class="el" href="../../d3/d6/hal_8h-source.html#l01170">BusNumber</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00108">_LEGACY_BUS_INFORMATION::BusTypeGuid</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00050">InterfaceType</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00186">IRP_MN_QUERY_LEGACY_BUS_INFORMATION</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00109">_LEGACY_BUS_INFORMATION::LegacyBusType</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00185">_DEVICE_NODE::ServiceName</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l02525">IopCallDriverAddDevice()</a>.
<p>
<pre class="fragment"><div>02802                    :
02803 
02804     This routine queries <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified DeviceObject <span class="keywordflow">for</span> its legacy bus
02805     information.
02806 
02807 Parameters:
02808 
02809     DeviceObject - The device object to be queried.
02810 
02811     InterfaceGuid = Supplies a pointer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device's interface <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>
02812         GUID.
02813 
02814     Interface = Supplies a pointer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device's interface <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
02815 
02816     <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> = Supplies a pointer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device's bus number.
02817 
02818 Return Value:
02819 
02820     Returns <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>.
02821 
02822 --*/
02823 {
02824     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
02825     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02826     <a class="code" href="../../d9/d9/struct__LEGACY__BUS__INFORMATION.html">PLEGACY_BUS_INFORMATION</a> busInfo;
02827 
02828     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02829 
02830     <span class="comment">//</span>
02831     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
02832     <span class="comment">//</span>
02833 
02834     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
02835 
02836     <span class="comment">//</span>
02837     <span class="comment">// Set the function codes.</span>
02838     <span class="comment">//</span>
02839 
02840     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
02841     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a88">IRP_MN_QUERY_LEGACY_BUS_INFORMATION</a>;
02842 
02843     <span class="comment">//</span>
02844     <span class="comment">// Make the call and return.</span>
02845     <span class="comment">//</span>
02846 
02847     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(DeviceObject, &amp;irpSp, &amp;busInfo);
02848     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02849 
02850         <span class="keywordflow">if</span> (busInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02851 
02852             <span class="comment">//</span>
02853             <span class="comment">// The device driver LIED to us.  Bad, bad, bad device driver.</span>
02854             <span class="comment">//</span>
02855 
02856             <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
02857 
02858             deviceNode = DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
02859 
02860             <span class="keywordflow">if</span> (deviceNode &amp;&amp; deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o14">ServiceName</a>.Buffer) {
02861 
02862                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*** IopQueryLegacyBusInformation - Driver %wZ returned STATUS_SUCCESS\n"</span>, &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o14">ServiceName</a>);
02863                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    for IRP_MN_QUERY_LEGACY_BUS_INFORMATION, and a NULL POINTER.\n"</span>);
02864             }
02865 
02866             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(busInfo != NULL);
02867 
02868         } <span class="keywordflow">else</span> {
02869             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(InterfaceGuid)) {
02870                 *InterfaceGuid = busInfo-&gt;<a class="code" href="../../d9/d9/struct__LEGACY__BUS__INFORMATION.html#o0">BusTypeGuid</a>;
02871             }
02872             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(InterfaceType)) {
02873                 *<a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> = busInfo-&gt;<a class="code" href="../../d9/d9/struct__LEGACY__BUS__INFORMATION.html#o1">LegacyBusType</a>;
02874             }
02875             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(BusNumber)) {
02876                 *<a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> = busInfo-&gt;<a class="code" href="../../d9/d9/struct__LEGACY__BUS__INFORMATION.html#o2">BusNumber</a>;
02877             }
02878             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(busInfo);
02879         }
02880     }
02881     <span class="keywordflow">return</span> status;
02882 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="pnpirp.c::IopQueryPnpBusInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryPnpBusInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT LPGUID&nbsp;</td>
          <td class="mdname" nowrap> <em>InterfaceGuid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OPTIONAL OUT INTERFACE_TYPE *&nbsp;</td>
          <td class="mdname" nowrap> <em>InterfaceType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OPTIONAL OUT ULONG *<a class="el" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02885">2885</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00096">_PNP_BUS_INFORMATION::BusNumber</a>, <a class="el" href="../../d3/d6/hal_8h-source.html#l01170">BusNumber</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00094">_PNP_BUS_INFORMATION::BusTypeGuid</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00050">InterfaceType</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00182">IRP_MN_QUERY_BUS_INFORMATION</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00095">_PNP_BUS_INFORMATION::LegacyBusType</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00185">_DEVICE_NODE::ServiceName</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>.
<p>
<pre class="fragment"><div>02894                    :
02895 
02896     This routine queries <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified DeviceObject <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified ResourceType
02897     resource translator.
02898 
02899 Parameters:
02900 
02901     HandlerType - specifies Arbiter or Translator
02902 
02903     DeviceObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Device object to be queried.
02904 
02905     ResourceType - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of translator.
02906 
02907     Interface - supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired interface.
02908 
02909 Return Value:
02910 
02911     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
02912 
02913 --*/
02914 {
02915     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
02916     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02917     <a class="code" href="../../d8/d6/struct__PNP__BUS__INFORMATION.html">PPNP_BUS_INFORMATION</a> busInfo;
02918 
02919     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02920 
02921     <span class="comment">//</span>
02922     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
02923     <span class="comment">//</span>
02924 
02925     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
02926 
02927     <span class="comment">//</span>
02928     <span class="comment">// Set the function codes.</span>
02929     <span class="comment">//</span>
02930 
02931     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
02932     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a85">IRP_MN_QUERY_BUS_INFORMATION</a>;
02933 
02934     <span class="comment">//</span>
02935     <span class="comment">// Make the call and return.</span>
02936     <span class="comment">//</span>
02937 
02938     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(DeviceObject, &amp;irpSp, &amp;busInfo);
02939     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02940 
02941         <span class="keywordflow">if</span> (busInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02942 
02943             <span class="comment">//</span>
02944             <span class="comment">// The device driver LIED to us.  Bad, bad, bad device driver.</span>
02945             <span class="comment">//</span>
02946 
02947             <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
02948 
02949             deviceNode = DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
02950 
02951             <span class="keywordflow">if</span> (deviceNode &amp;&amp; deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o14">ServiceName</a>.Buffer) {
02952 
02953                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*** IopQueryPnpBusInformation - Driver %wZ returned STATUS_SUCCESS\n"</span>, &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o14">ServiceName</a>);
02954                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    for IRP_MN_QUERY_BUS_INFORMATION, and a NULL POINTER.\n"</span>);
02955             }
02956 
02957             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(busInfo != NULL);
02958 
02959         } <span class="keywordflow">else</span> {
02960             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(InterfaceGuid)) {
02961                 *InterfaceGuid = busInfo-&gt;<a class="code" href="../../d8/d6/struct__PNP__BUS__INFORMATION.html#o0">BusTypeGuid</a>;
02962             }
02963             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(InterfaceType)) {
02964                 *<a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> = busInfo-&gt;<a class="code" href="../../d8/d6/struct__PNP__BUS__INFORMATION.html#o1">LegacyBusType</a>;
02965             }
02966             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(BusNumber)) {
02967                 *<a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> = busInfo-&gt;<a class="code" href="../../d8/d6/struct__PNP__BUS__INFORMATION.html#o2">BusNumber</a>;
02968             }
02969             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(busInfo);
02970         }
02971     }
02972     <span class="keywordflow">return</span> status;
02973 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="pnpirp.c::IopQueryReconfiguration" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryReconfiguration           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN UCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Request</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02733">2733</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d1/config_2test_2init386_8c-source.html#l00027">dummy()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00166">IRP_MN_CANCEL_STOP_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00165">IRP_MN_QUERY_STOP_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00164">IRP_MN_STOP_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d6/d3/kernel_2ddetrack_8c-source.html#l01221">Request()</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04767">IopTestForReconfiguration()</a>.
<p>
<pre class="fragment"><div>02740                    :
02741 
02742     This routine queries <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified DeviceObject <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified ResourceType
02743     resource translator.
02744 
02745 Parameters:
02746 
02747     HandlerType - specifies Arbiter or Translator
02748 
02749     DeviceObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Device object to be queried.
02750 
02751     ResourceType - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of translator.
02752 
02753     Interface - supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired interface.
02754 
02755 Return Value:
02756 
02757     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
02758 
02759 --*/
02760 {
02761     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
02762     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02763     PVOID <a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>;
02764 
02765     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02766 
02767     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Request == IRP_MN_QUERY_STOP_DEVICE ||
02768             Request == IRP_MN_STOP_DEVICE ||
02769             Request == IRP_MN_CANCEL_STOP_DEVICE);
02770 
02771     <span class="comment">//</span>
02772     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
02773     <span class="comment">//</span>
02774 
02775     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
02776 
02777     <span class="comment">//</span>
02778     <span class="comment">// Set the function codes.</span>
02779     <span class="comment">//</span>
02780 
02781     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
02782     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a>;
02783 
02784     <span class="comment">//</span>
02785     <span class="comment">// Make the call and return.</span>
02786     <span class="comment">//</span>
02787 
02788     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(DeviceObject, &amp;irpSp, &amp;dummy);
02789     <span class="keywordflow">return</span> status;
02790 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="pnpirp.c::IopQueryResourceHandlerInterface" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryResourceHandlerInterface           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a126">RESOURCE_HANDLER_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>HandlerType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Interface</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02617">2617</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01164">DO_BUS_ENUMERATED_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d1/d1/config_2test_2init386_8c-source.html#l00027">dummy()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00195">_DEVICE_NODE::DuplicatePDO</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00169">IRP_MN_QUERY_INTERFACE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a390a216">ResourceArbiter</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a390a217">ResourceLegacyDeviceDetection</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a390a215">ResourceTranslator</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01941">_INTERFACE::Size</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01942">_INTERFACE::Version</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06528">IopDuplicateDetection()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03534">IopSetupArbiterAndTranslators()</a>.
<p>
<pre class="fragment"><div>02626                    :
02627 
02628     This routine queries <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified DeviceObject <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified ResourceType
02629     resource translator.
02630 
02631 Parameters:
02632 
02633     HandlerType - specifies Arbiter or Translator
02634 
02635     DeviceObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Device object to be queried.
02636 
02637     ResourceType - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of translator.
02638 
02639     Interface - supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired interface.
02640 
02641 Return Value:
02642 
02643     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
02644 
02645 --*/
02646 {
02647     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
02648     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02649     PVOID <a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>;
02650     <a class="code" href="../../d8/d3/struct__INTERFACE.html">PINTERFACE</a> interface;
02651     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> size;
02652     GUID interfaceType;
02653     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
02654 
02655     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02656 
02657     <span class="comment">//</span>
02658     <span class="comment">// If this device object is created by pnp mgr for legacy resource allocation,</span>
02659     <span class="comment">// skip it.</span>
02660     <span class="comment">//</span>
02661 
02662     <span class="keywordflow">if</span> ((deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o15">DuplicatePDO</a> == (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>) ||
02663         !(DeviceObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a133">DO_BUS_ENUMERATED_DEVICE</a>)) {
02664         <span class="keywordflow">return</span> STATUS_NOT_SUPPORTED;
02665     }
02666 
02667     <span class="keywordflow">switch</span> (HandlerType) {
02668     <span class="keywordflow">case</span> <a class="code" href="../../d9/d0/pnpiop_8h.html#a390a215">ResourceTranslator</a>:
02669         size = <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html">TRANSLATOR_INTERFACE</a>) + 4;  <span class="comment">// Pnptest</span>
02670         <span class="comment">//size = sizeof(TRANSLATOR_INTERFACE);</span>
02671         interfaceType = GUID_TRANSLATOR_INTERFACE_STANDARD;
02672         <span class="keywordflow">break</span>;
02673 
02674     <span class="keywordflow">case</span> <a class="code" href="../../d9/d0/pnpiop_8h.html#a390a216">ResourceArbiter</a>:
02675         size = <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html">ARBITER_INTERFACE</a>);
02676         interfaceType = GUID_ARBITER_INTERFACE_STANDARD;
02677         <span class="keywordflow">break</span>;
02678 
02679     <span class="keywordflow">case</span> <a class="code" href="../../d9/d0/pnpiop_8h.html#a390a217">ResourceLegacyDeviceDetection</a>:
02680         size = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d0/struct__LEGACY__DEVICE__DETECTION__INTERFACE.html">LEGACY_DEVICE_DETECTION_INTERFACE</a>);
02681         interfaceType = GUID_LEGACY_DEVICE_DETECTION_STANDARD;
02682         <span class="keywordflow">break</span>;
02683 
02684     <span class="keywordflow">default</span>:
02685         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
02686     }
02687 
02688     interface = (<a class="code" href="../../d8/d3/struct__INTERFACE.html">PINTERFACE</a>) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, size);
02689     <span class="keywordflow">if</span> (interface == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02690         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02691     }
02692 
02693     RtlZeroMemory(interface, size);
02694     interface-&gt;<a class="code" href="../../d8/d3/struct__INTERFACE.html#o0">Size</a> = size;
02695 
02696     <span class="comment">//</span>
02697     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
02698     <span class="comment">//</span>
02699 
02700     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
02701 
02702     <span class="comment">//</span>
02703     <span class="comment">// Set the function codes.</span>
02704     <span class="comment">//</span>
02705 
02706     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
02707     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a73">IRP_MN_QUERY_INTERFACE</a>;
02708 
02709     <span class="comment">//</span>
02710     <span class="comment">// Set the pointer to the resource list</span>
02711     <span class="comment">//</span>
02712 
02713     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.InterfaceType = &amp;interfaceType;
02714     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.Size = interface-&gt;<a class="code" href="../../d8/d3/struct__INTERFACE.html#o0">Size</a>;
02715     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.Version = interface-&gt;<a class="code" href="../../d8/d3/struct__INTERFACE.html#o1">Version</a> = 0;
02716     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.Interface = interface;
02717     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.InterfaceSpecificData = (PVOID) ResourceType;
02718 
02719     <span class="comment">//</span>
02720     <span class="comment">// Make the call and return.</span>
02721     <span class="comment">//</span>
02722 
02723     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(DeviceObject, &amp;irpSp, &amp;dummy);
02724     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02725         *Interface = interface;
02726     } <span class="keywordflow">else</span> {
02727         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(interface);
02728     }
02729     <span class="keywordflow">return</span> status;
02730 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="pnpirp.c::IopQueryUniqueId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryUniqueId           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PWCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>UniqueId</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01820">1820</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d0/d5/io_8h.html#a604a424">BusQueryInstanceID</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00180">IRP_MN_QUERY_ID</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>.
<p>
<pre class="fragment"><div>01827                    :
01828 
01829 
01830     This routine generates a unique <span class="keywordtype">id</span> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device object.
01831 
01832 Parameters:
01833 
01834     DeviceObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device being queried
01835 
01836     UniqueId - Supplies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned Id.
01837                This must be freed by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
01838 
01839     GloballyUnique - Indicates (from a previous call to query capabilities
01840                      whether the <span class="keywordtype">id</span> is globally unique.
01841 Return Value:
01842 
01843     NTSTATUS code.
01844 
01845 --*/
01846 {
01847     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
01848     NTSTATUS status;
01849 
01850     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01851 
01852     *UniqueId = NULL;
01853 
01854     <span class="comment">//</span>
01855     <span class="comment">// First ask for for InstanceId.</span>
01856     <span class="comment">//</span>
01857 
01858     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
01859     <span class="comment">//</span>
01860 
01861     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
01862 
01863     <span class="comment">//</span>
01864     <span class="comment">// Set the function codes.</span>
01865     <span class="comment">//</span>
01866 
01867     irpSp.MajorFunction = IRP_MJ_PNP;
01868     irpSp.MinorFunction = IRP_MN_QUERY_ID;
01869 
01870     <span class="comment">//</span>
01871     <span class="comment">// Set the pointer to the resource list</span>
01872     <span class="comment">//</span>
01873 
01874     irpSp.Parameters.QueryId.IdType = BusQueryInstanceID;
01875 
01876     <span class="comment">//</span>
01877     <span class="comment">// Make the call and return.</span>
01878     <span class="comment">//</span>
01879 
01880     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a291">IopSynchronousCall</a>(DeviceObject, &amp;irpSp, UniqueId);
01881 
01882     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01883         *UniqueId = NULL;
01884     }
01885 
01886     <span class="keywordflow">return</span> status;
01887 
01888 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="pnpirp.c::IopRemoveDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopRemoveDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetDevice</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpMinorCode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00927">927</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00147">ASSERTMSG</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00408">DNF_ADDED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00493">DNF_LEGACY_DRIVER</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00500">DNF_NEED_ENUMERATION_ONLY</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00402">DNF_NEED_QUERY_IDS</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">DNF_STARTED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00610">DNUF_NOT_DISABLEABLE</a>, <a class="el" href="../../d1/d1/config_2test_2init386_8c-source.html#l00027">dummy()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l03152">IopDecDisableableDepends()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01316">IopFindMountableDevice()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04710">IopInvalidateVolumesForDevice()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01080">IopLockMountedDeviceForRemove()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00191">IopUncacheInterfaceInformation()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01233">IopUnlockMountedDeviceForRemove()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00163">IRP_MN_CANCEL_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00178">IRP_MN_EJECT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00161">IRP_MN_QUERY_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00162">IRP_MN_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00184">IRP_MN_SURPRISE_REMOVAL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00136">_DEVICE_NODE::UserFlags</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00232">IopDeleteLockedDeviceNode()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03125">IopDisableDevice()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>.
<p>
<pre class="fragment"><div>00934                    :
00935 
00936     This function sends a requested DeviceRemoval related irp to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> top level device
00937     object which roots on TargetDevice.  If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a <a class="code" href="../../d7/d7/struct__VPB.html">VPB</a> associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00938     TargetDevice, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding filesystem's VDO will be used.  Otherwise
00939     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> irp will be sent directly to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target device/ or its assocated device
00940     object.
00941 
00942 Parameters:
00943 
00944     TargetDevice - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device being removed.
00945 
00946     Operation - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation requested.
00947         The following <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> codes are used with <a class="code" href="../../d0/d5/io_8h.html#a37">IRP_MJ_DEVICE_CHANGE</a> <span class="keywordflow">for</span> removing
00948         devices:
00949             <a class="code" href="../../d0/d5/io_8h.html#a66">IRP_MN_QUERY_REMOVE_DEVICE</a>
00950             <a class="code" href="../../d0/d5/io_8h.html#a68">IRP_MN_CANCEL_REMOVE_DEVICE</a>
00951             <a class="code" href="../../d0/d5/io_8h.html#a67">IRP_MN_REMOVE_DEVICE</a>
00952             <a class="code" href="../../d0/d5/io_8h.html#a81">IRP_MN_EJECT</a>
00953 Return Value:
00954 
00955     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
00956 
00957 --*/
00958 {
00959     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00960     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00961     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
00962     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00963 
00964     BOOLEAN isMountable = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00965     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> mountedDevice;
00966 
00967     PVOID <a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>;
00968     <a class="code" href="../../d7/d2/struct__LOCK__MOUNTABLE__DEVICE__CONTEXT.html">LOCK_MOUNTABLE_DEVICE_CONTEXT</a> lockContext;
00969 
00970     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00971 
00972     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IrpMinorCode == IRP_MN_QUERY_REMOVE_DEVICE ||
00973            IrpMinorCode == IRP_MN_CANCEL_REMOVE_DEVICE ||
00974            IrpMinorCode == IRP_MN_REMOVE_DEVICE ||
00975            IrpMinorCode == IRP_MN_SURPRISE_REMOVAL ||
00976            IrpMinorCode == IRP_MN_EJECT);
00977 
00978     <span class="keywordflow">if</span> (IrpMinorCode == <a class="code" href="../../d0/d5/io_8h.html#a67">IRP_MN_REMOVE_DEVICE</a> ||
00979         IrpMinorCode == <a class="code" href="../../d0/d5/io_8h.html#a66">IRP_MN_QUERY_REMOVE_DEVICE</a>) {
00980         <a class="code" href="../../d0/d1/pnpirp_8c.html#a17">IopUncacheInterfaceInformation</a>(TargetDevice);
00981     }
00982 
00983     <span class="comment">//</span>
00984     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
00985     <span class="comment">//</span>
00986 
00987     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
00988 
00989     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
00990     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = (UCHAR)IrpMinorCode;
00991 
00992     <span class="comment">//</span>
00993     <span class="comment">// BUGBUG - this should probably go at a higher level but then it goes</span>
00994     <span class="comment">// in way too many places.  The only thing we do to the VPB is make sure</span>
00995     <span class="comment">// that it won't go away while the operation is in the file system and</span>
00996     <span class="comment">// that no one new can mount on the device if the FS decides to bail out.</span>
00997     <span class="comment">//</span>
00998 
00999     <span class="comment">//</span>
01000     <span class="comment">// Check to see if there's a VPB anywhere in the device stack.  If there</span>
01001     <span class="comment">// is then we'll have to lock the stack.</span>
01002     <span class="comment">//</span>
01003 
01004     mountedDevice = <a class="code" href="../../d0/d1/pnpirp_8c.html#a13">IopFindMountableDevice</a>(TargetDevice);
01005 
01006     <span class="keywordflow">if</span> (mountedDevice != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01007 
01008         <span class="comment">//</span>
01009         <span class="comment">// This routine will cause any mount operations on the VPB to fail.</span>
01010         <span class="comment">// It will also release the VPB spinlock.</span>
01011         <span class="comment">//</span>
01012 
01013         mountedDevice = <a class="code" href="../../d0/d1/pnpirp_8c.html#a14">IopLockMountedDeviceForRemove</a>(TargetDevice,
01014                                                       IrpMinorCode,
01015                                                       &amp;lockContext);
01016 
01017         isMountable = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01018 
01019     } <span class="keywordflow">else</span> {
01020         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>(<span class="stringliteral">"Mass storage device does not have VPB - this is odd"</span>,
01021                   !((TargetDevice-&gt;Type == FILE_DEVICE_DISK) ||
01022                     (TargetDevice-&gt;Type == FILE_DEVICE_CD_ROM) ||
01023                     (TargetDevice-&gt;Type == FILE_DEVICE_TAPE) ||
01024                     (TargetDevice-&gt;Type == FILE_DEVICE_VIRTUAL_DISK)));
01025 
01026         mountedDevice = TargetDevice;
01027     }
01028 
01029     <span class="comment">//</span>
01030     <span class="comment">// Make the call and return.</span>
01031     <span class="comment">//</span>
01032 
01033     <span class="keywordflow">if</span> (IrpMinorCode == <a class="code" href="../../d0/d5/io_8h.html#a87">IRP_MN_SURPRISE_REMOVAL</a> || IrpMinorCode == <a class="code" href="../../d0/d5/io_8h.html#a67">IRP_MN_REMOVE_DEVICE</a>) {
01034         <span class="comment">//</span>
01035         <span class="comment">// if device was not disableable, we cleanup the tree</span>
01036         <span class="comment">// and debug-trace that we surprise-removed a non-disableable device</span>
01037         <span class="comment">//</span>
01038         <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = TargetDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
01039 
01040         <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o7">UserFlags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a40">DNUF_NOT_DISABLEABLE</a>) {
01041             <span class="comment">//</span>
01042             <span class="comment">// this device was marked as disableable, update the depends</span>
01043             <span class="comment">// before this device disappears</span>
01044             <span class="comment">// (by momentarily marking this node as disableable)</span>
01045             <span class="comment">//</span>
01046             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o7">UserFlags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a40">DNUF_NOT_DISABLEABLE</a>;
01047             <a class="code" href="../../d0/d1/pnpirp_8c.html#a34">IopDecDisableableDepends</a>(deviceNode);
01048         }
01049     }
01050 
01051     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(mountedDevice, &amp;irpSp, &amp;dummy);
01052 
01053     <span class="keywordflow">if</span> (isMountable) {
01054 
01055         <a class="code" href="../../d0/d1/pnpirp_8c.html#a15">IopUnlockMountedDeviceForRemove</a>(TargetDevice,
01056                                         IrpMinorCode,
01057                                         &amp;lockContext);
01058 
01059         <span class="comment">//</span>
01060         <span class="comment">// Succesful query should follow up with invalidation of all volumes</span>
01061         <span class="comment">// which have been on this device but which are not currently mounted.</span>
01062         <span class="comment">//</span>
01063 
01064         <span class="keywordflow">if</span> (IrpMinorCode == <a class="code" href="../../d0/d5/io_8h.html#a66">IRP_MN_QUERY_REMOVE_DEVICE</a> &amp;&amp; <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01065 
01066             status = <a class="code" href="../../d0/d6/iop_8h.html#a189">IopInvalidateVolumesForDevice</a>( TargetDevice );
01067         }
01068     }
01069 
01070     <span class="keywordflow">if</span> (IrpMinorCode == <a class="code" href="../../d0/d5/io_8h.html#a67">IRP_MN_REMOVE_DEVICE</a>) {
01071         ((<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)TargetDevice-&gt;DeviceObjectExtension-&gt;DeviceNode)-&gt;Flags &amp;=
01072             ~(<a class="code" href="../../d9/d0/pnpiop_8h.html#a11">DNF_ADDED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a24">DNF_LEGACY_DRIVER</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a10">DNF_NEED_QUERY_IDS</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a25">DNF_NEED_ENUMERATION_ONLY</a>);
01073     }
01074 
01075     <span class="keywordflow">return</span> status;
01076 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="pnpirp.c::IopStartDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopStartDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">510</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00092">_DEVICE_COMPLETION_CONTEXT::DeviceNode</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00500">DNF_NEED_ENUMERATION_ONLY</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00459">DNF_RESOURCE_REPORTED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00427">DNF_START_REQUEST_PENDING</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">DNF_STARTED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00480">DNF_STOPPED</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a205">DOCK_ARRIVING</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a203">DOCK_NOTDOCKDEVICE</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a204">DOCK_QUIESCENT</a>, <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html#o42">_DEVICE_NODE::DockInfo</a>, <a class="el" href="../../d1/d1/config_2test_2init386_8c-source.html#l00027">dummy()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02455">ExGetCurrentResourceThread</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01266">IopAcquireEnumerationLock</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00262">IopAsynchronousCall()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01370">IopDeviceStartComplete()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09866">IopDoDeferredSetInterfaceState()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00825">IopDoesDevNodeHaveProblem</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00103">IopHardwareProfileBeginTransition()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00666">IopHardwareProfileCancelTransition()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00370">IopHardwareProfileCommitStartedDock()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00160">IopHardwareProfileMarkDock()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00251">IopHardwareProfileQueryChange()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00068">IopPnPSpinLock</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01708">IopRequestDeviceRemoval()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00835">IopSetDevNodeProblem</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00191">IopUncacheInterfaceInformation()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00160">IRP_MN_START_DEVICE</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00094">_DEVICE_COMPLETION_CONTEXT::IrpMinorCode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d0/d1/pnpirp_8c.html#a6">PDEVICE_COMPLETION_CONTEXT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00151">_DEVICE_NODE::PhysicalDeviceObject</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00173">PnpAsyncOk</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a158">PpSetTargetDeviceRemove()</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a388a210">PROFILE_PERHAPS_IN_PNPEVENT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00161">_DEVICE_NODE::ResourceList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00163">_DEVICE_NODE::ResourceListTranslated</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00820">SAVE_FAILURE_INFO</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00093">_DEVICE_COMPLETION_CONTEXT::Thread</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07470">IopReallocateResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00994">IopStartAndEnumerateDevice()</a>.
<p>
<pre class="fragment"><div>00516                    :
00517 
00518     This function sends a start device irp to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> top level device
00519     object which roots on DeviceObject.
00520 
00521 Parameters:
00522 
00523     DeviceObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device
00524                    being removed.
00525 
00526 Return Value:
00527 
00528     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
00529 
00530 --*/
00531 
00532 {
00533     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
00534     PVOID <a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>;
00535     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
00536     <a class="code" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html">PDEVICE_COMPLETION_CONTEXT</a> completionContext;
00537     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00538     PNP_VETO_TYPE  vetoType;
00539 
00540 <span class="comment">//    PAGED_CODE();</span>
00541 
00542     <span class="comment">//</span>
00543     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
00544     <span class="comment">//</span>
00545 
00546     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
00547 
00548     <span class="comment">//</span>
00549     <span class="comment">// Set the function codes.</span>
00550     <span class="comment">//</span>
00551 
00552     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
00553     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a65">IRP_MN_START_DEVICE</a>;
00554 
00555     <span class="comment">//</span>
00556     <span class="comment">// Set the pointers for the raw and translated resource lists</span>
00557     <span class="comment">//</span>
00558 
00559     <span class="keywordflow">if</span> (!(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a19">DNF_RESOURCE_REPORTED</a>)) {
00560         irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.StartDevice.AllocatedResources = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>;
00561         irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.StartDevice.AllocatedResourcesTranslated = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o11">ResourceListTranslated</a>;
00562     }
00563 
00564     <span class="keywordflow">if</span> (!(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a22">DNF_STOPPED</a>)) {
00565         <a class="code" href="../../d0/d1/pnpirp_8c.html#a17">IopUncacheInterfaceInformation</a>(DeviceObject);
00566     }
00567 
00568     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a24">PnpAsyncOk</a>) {
00569 
00570         <span class="comment">//</span>
00571         <span class="comment">// ADRIAO BUGBUG 11/18/98 -</span>
00572         <span class="comment">//     The dock code has not been duplicated in the async case, but as</span>
00573         <span class="comment">// PnpAsync support is totally broken and disabled anyway, this should</span>
00574         <span class="comment">// not matter right now.</span>
00575         <span class="comment">//</span>
00576         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
00577         completionContext = (<a class="code" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html">PDEVICE_COMPLETION_CONTEXT</a>) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
00578                               NonPagedPool,
00579                               <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html">DEVICE_COMPLETION_CONTEXT</a>));
00580         <span class="keywordflow">if</span> (completionContext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00581             <span class="keywordflow">return</span>;   <span class="comment">// BUGBUG - Should try it again *explicitly*</span>
00582         }
00583 
00584         completionContext-&gt;<a class="code" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html#o0">DeviceNode</a> = deviceNode;
00585         completionContext-&gt;<a class="code" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html#o2">IrpMinorCode</a> = <a class="code" href="../../d0/d5/io_8h.html#a65">IRP_MN_START_DEVICE</a>;
00586         completionContext-&gt;<a class="code" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html#o1">Thread</a> = <a class="code" href="../../d5/d8/ex_8h.html#a67">ExGetCurrentResourceThread</a>();
00587 
00588         <span class="comment">//</span>
00589         <span class="comment">// Make the call and return.</span>
00590         <span class="comment">//</span>
00591 
00592         <a class="code" href="../../d9/d0/pnpiop_8h.html#a95">IopAcquireEnumerationLock</a>(NULL);  <span class="comment">// To block IopAcquireTreeLock();</span>
00593         status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a9">IopAsynchronousCall</a>(DeviceObject, &amp;irpSp, completionContext, IopDeviceStartComplete);
00594         <span class="keywordflow">if</span> (status == STATUS_PENDING) {
00595 
00596             KIRQL oldIrql;
00597 
00598             <span class="comment">//</span>
00599             <span class="comment">// Set DNF_START_REQUEST_PENDING flag such that the completion routine knows it</span>
00600             <span class="comment">// needs to request enumeration when the start completed successfully.</span>
00601             <span class="comment">//</span>
00602 
00603             ExAcquireSpinLock(&amp;IopPnPSpinLock, &amp;oldIrql);
00604 
00605             <span class="keywordflow">if</span> (!(<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(deviceNode) || (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>))) {
00606                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a14">DNF_START_REQUEST_PENDING</a>;
00607             }
00608             ExReleaseSpinLock(&amp;IopPnPSpinLock, oldIrql);
00609         }
00610     } <span class="keywordflow">else</span> {
00611 
00612         <span class="keywordflow">if</span> ((deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a22">DNF_STOPPED</a>)||
00613             (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus == <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a203">DOCK_NOTDOCKDEVICE</a>)) {
00614 
00615 
00616             <span class="comment">//</span>
00617             <span class="comment">// This is either the rebalance case in which we are restarting a</span>
00618             <span class="comment">// temporarily stopped device, or we are starting a non-dock device,</span>
00619             <span class="comment">// and it was previously off.</span>
00620             <span class="comment">//</span>
00621             status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(DeviceObject, &amp;irpSp, &amp;dummy);
00622 
00623         } <span class="keywordflow">else</span> {
00624 
00625             <span class="comment">//</span>
00626             <span class="comment">// This is a dock so we a little bit of work before starting it.</span>
00627             <span class="comment">// Take the profile change semaphore. We do this whenever a dock</span>
00628             <span class="comment">// is in our list, even if no query is going to occur.</span>
00629             <span class="comment">//</span>
00630             <a class="code" href="../../d9/d0/pnpiop_8h.html#a377">IopHardwareProfileBeginTransition</a>(FALSE);
00631 
00632             <span class="comment">//</span>
00633             <span class="comment">// Tell the profile code what dock device object may be bringing the</span>
00634             <span class="comment">// new hardware profile online.</span>
00635             <span class="comment">//</span>
00636             <a class="code" href="../../d9/d0/pnpiop_8h.html#a378">IopHardwareProfileMarkDock</a>(deviceNode, DOCK_ARRIVING);
00637 
00638             <span class="comment">//</span>
00639             <span class="comment">// Ask everyone if this is really a good idea right now. Note that</span>
00640             <span class="comment">// PiProcessStart calls IopNewDevice calls IopStartAndEnumerateDevice</span>
00641             <span class="comment">// who calls this function on that thread. Therefore we may indded be</span>
00642             <span class="comment">// in an event, although this would probably be a fairly rare event</span>
00643             <span class="comment">// for a dock.</span>
00644             <span class="comment">//</span>
00645             status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a379">IopHardwareProfileQueryChange</a>(
00646                 FALSE,
00647                 PROFILE_PERHAPS_IN_PNPEVENT,
00648                 &amp;vetoType,
00649                 NULL
00650                 );
00651 
00652             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00653 
00654                 status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(DeviceObject, &amp;irpSp, &amp;dummy);
00655             }
00656 
00657             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00658 
00659                 <span class="comment">//</span>
00660                 <span class="comment">// Commit the current Hardware Profile as necessary.</span>
00661                 <span class="comment">//</span>
00662                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a380">IopHardwareProfileCommitStartedDock</a>(deviceNode);
00663 
00664             } <span class="keywordflow">else</span> {
00665 
00666                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a383">IopHardwareProfileCancelTransition</a>();
00667             }
00668         }
00669 
00670         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00671             ULONG Problem = CM_PROB_FAILED_START;
00672 
00673             <a class="code" href="../../d9/d0/pnpiop_8h.html#a76">SAVE_FAILURE_INFO</a>(deviceNode, status);
00674 
00675             <span class="comment">//</span>
00676             <span class="comment">// Handle certain problems determined by the status code</span>
00677             <span class="comment">//</span>
00678             <span class="keywordflow">switch</span> (status) {
00679                 <span class="keywordflow">case</span> STATUS_PNP_REBOOT_REQUIRED:
00680                     Problem = CM_PROB_NEED_RESTART;
00681                     <span class="keywordflow">break</span>;
00682 
00683                 <span class="keywordflow">default</span>:
00684                     Problem = CM_PROB_FAILED_START;
00685             }
00686             <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, Problem);
00687 
00688             <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus == <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a203">DOCK_NOTDOCKDEVICE</a>) {
00689 
00690                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a306">IopRequestDeviceRemoval</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>, CM_PROB_FAILED_START);
00691             } <span class="keywordflow">else</span> {
00692 
00693                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus == DOCK_QUIESCENT);
00694 
00695                 <a class="code" href="../../d6/d9/pnp_8h.html#a158">PpSetTargetDeviceRemove</a>( deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>,
00696                                          FALSE,
00697                                          TRUE,
00698                                          TRUE,
00699                                          CM_PROB_DEVICE_NOT_THERE,
00700                                          NULL,
00701                                          NULL,
00702                                          NULL,
00703                                          NULL);
00704             }
00705 
00706         } <span class="keywordflow">else</span> {
00707 
00708             <a class="code" href="../../d9/d0/pnpiop_8h.html#a356">IopDoDeferredSetInterfaceState</a>(deviceNode);
00709 
00710             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>;
00711 
00712             <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a22">DNF_STOPPED</a>) {
00713 
00714                 <span class="comment">//</span>
00715                 <span class="comment">// If the start is initiated by rebalancing, do NOT do enumeration</span>
00716                 <span class="comment">//</span>
00717 
00718                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a22">DNF_STOPPED</a>;
00719 
00720             } <span class="keywordflow">else</span> {
00721 
00722                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a25">DNF_NEED_ENUMERATION_ONLY</a>;
00723 
00724             }
00725         }
00726     }
00727 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="pnpirp.c::IopSynchronousCall" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopSynchronousCall           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TopStackLocation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Information</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">381</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00652">IoAllocateIrp()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06786">IoGetAttachedDevice()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01103">IopQueueThreadIrp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00110">IRP_SYSTEM_RESTRICTED</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00026">PnpIrpStatusTracking</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00690">SPECIALIRP_WATERMARK_IRP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01300">IoFreeDumpStack()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01163">IopEnumerateDevice()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00384">IopGetDumpStack()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08036">IopGetRelatedTargetDevice()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02173">IopQueryCompatibleIds()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03694">IopQueryDeviceCapabilities()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01762">IopQueryDeviceId()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01604">IopQueryDeviceRelations()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l03195">IopQueryDeviceSerialNumber()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02976">IopQueryDeviceState()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l03395">IopQueryDockRemovalInterface()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02793">IopQueryLegacyBusInformation()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02885">IopQueryPnpBusInformation()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02733">IopQueryReconfiguration()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02617">IopQueryResourceHandlerInterface()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01820">IopQueryUniqueId()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00927">IopRemoveDevice()</a>, and <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>.
<p>
<pre class="fragment"><div>00389                    :
00390 
00391     This function sends a synchronous irp to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> top level device
00392     object which roots on DeviceObject.
00393 
00394 Parameters:
00395 
00396     DeviceObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device being removed.
00397 
00398     TopStackLocation - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parameter block <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> irp.
00399 
00400     Information - Supplies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned
00401                   information of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> irp.
00402 
00403 Return Value:
00404 
00405     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
00406 
00407 --*/
00408 
00409 {
00410     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00411     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00412     IO_STATUS_BLOCK statusBlock;
00413     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
00414     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00415     PULONG_PTR returnInfo = (PULONG_PTR)Information;
00416     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00417 
00418     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00419 
00420     <span class="comment">//</span>
00421     <span class="comment">// Get a pointer to the topmost device object in the stack of devices,</span>
00422     <span class="comment">// beginning with the deviceObject.</span>
00423     <span class="comment">//</span>
00424 
00425     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a66">IoGetAttachedDevice</a>(DeviceObject);
00426 
00427     <span class="comment">//</span>
00428     <span class="comment">// Begin by allocating the IRP for this request.  Do not charge quota to</span>
00429     <span class="comment">// the current process for this IRP.</span>
00430     <span class="comment">//</span>
00431 
00432     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>(deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>, FALSE);
00433     <span class="keywordflow">if</span> (irp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>){
00434 
00435         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00436     }
00437 
00438     <a class="code" href="../../d9/d4/trackirp_8h.html#a86">SPECIALIRP_WATERMARK_IRP</a>(irp, IRP_SYSTEM_RESTRICTED);
00439 
00440     <span class="comment">//</span>
00441     <span class="comment">// Initialize it to failure.</span>
00442     <span class="comment">//</span>
00443 
00444     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = statusBlock.Status = STATUS_NOT_SUPPORTED;
00445     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = statusBlock.Information = 0;
00446 
00447     <span class="comment">//</span>
00448     <span class="comment">// Set the pointer to the status block and initialized event.</span>
00449     <span class="comment">//</span>
00450 
00451     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event,
00452                        SynchronizationEvent,
00453                        FALSE );
00454 
00455     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;statusBlock;
00456     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = &amp;event;
00457 
00458     <span class="comment">//</span>
00459     <span class="comment">// Set the address of the current thread</span>
00460     <span class="comment">//</span>
00461 
00462     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00463 
00464     <span class="comment">//</span>
00465     <span class="comment">// Queue this irp onto the current thread</span>
00466     <span class="comment">//</span>
00467 
00468     <a class="code" href="../../d0/d6/iop_8h.html#a21">IopQueueThreadIrp</a>(irp);
00469 
00470     <span class="comment">//</span>
00471     <span class="comment">// Get a pointer to the stack location of the first driver which will be</span>
00472     <span class="comment">// invoked.  This is where the function codes and parameters are set.</span>
00473     <span class="comment">//</span>
00474 
00475     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>(irp);
00476 
00477     <span class="comment">//</span>
00478     <span class="comment">// Copy in the caller-supplied stack location contents</span>
00479     <span class="comment">//</span>
00480 
00481     *irpSp = *TopStackLocation;
00482 
00483     <span class="comment">//</span>
00484     <span class="comment">// Call the driver</span>
00485     <span class="comment">//</span>
00486 
00487     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>(deviceObject, irp);
00488 
00489     <a class="code" href="../../d0/d1/pnpirp_8c.html#a0">PnpIrpStatusTracking</a>(status, TopStackLocation-&gt;MinorFunction, deviceObject);
00490 
00491     <span class="comment">//</span>
00492     <span class="comment">// If a driver returns STATUS_PENDING, we will wait for it to complete</span>
00493     <span class="comment">//</span>
00494 
00495     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
00496         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
00497                                       Executive,
00498                                       KernelMode,
00499                                       FALSE,
00500                                       (PLARGE_INTEGER) NULL );
00501         status = statusBlock.Status;
00502     }
00503 
00504     *returnInfo = (ULONG_PTR) statusBlock.Information;
00505 
00506     <span class="keywordflow">return</span> status;
00507 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="pnpirp.c::IopUncacheInterfaceInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopUncacheInterfaceInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00191">191</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01943">_INTERFACE::Context</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00239">_DEVICE_NODE::DeviceArbiterList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00246">_DEVICE_NODE::DeviceTranslatorList</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01945">_INTERFACE::InterfaceDereference</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00267">_DEVICE_NODE::NoArbiterMask</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00253">_DEVICE_NODE::NoTranslatorMask</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00274">_DEVICE_NODE::QueryArbiterMask</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00260">_DEVICE_NODE::QueryTranslatorMask</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00732">_PI_RESOURCE_TRANSLATOR_ENTRY::TranslatorInterface</a>.
<p>
Referenced by <a class="el" href="../../d5/d6/devnode_8c-source.html#l00297">IopDestroyDeviceNode()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06387">IopInvalidateDeviceStateWorker()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00927">IopRemoveDevice()</a>, and <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>.
<p>
<pre class="fragment"><div>00197                    :
00198 
00199     This function removes all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cached translators and arbiters information
00200     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object.
00201 
00202 Parameters:
00203 
00204     DeviceObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device being removed.
00205 
00206 Return Value:
00207 
00208     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
00209 
00210 --*/
00211 
00212 {
00213     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
00214     PLIST_ENTRY listHead, nextEntry, entry;
00215     <a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html">PPI_RESOURCE_TRANSLATOR_ENTRY</a> handlerEntry;
00216     <a class="code" href="../../d8/d3/struct__INTERFACE.html">PINTERFACE</a> interface;
00217 
00218     <span class="comment">//</span>
00219     <span class="comment">// Dereference all the arbiters on this PDO.</span>
00220     <span class="comment">//</span>
00221 
00222     listHead = &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o24">DeviceArbiterList</a>;
00223     nextEntry = listHead-&gt;Flink;
00224     <span class="keywordflow">while</span> (nextEntry != listHead) {
00225         entry = nextEntry;
00226         nextEntry = nextEntry-&gt;Flink;
00227         handlerEntry = CONTAINING_RECORD(entry, <a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html">PI_RESOURCE_TRANSLATOR_ENTRY</a>, DeviceTranslatorList);
00228         <span class="keywordflow">if</span> (interface = (<a class="code" href="../../d8/d3/struct__INTERFACE.html">PINTERFACE</a>)handlerEntry-&gt;<a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html#o2">TranslatorInterface</a>) {
00229             (interface-&gt;<a class="code" href="../../d8/d3/struct__INTERFACE.html#o4">InterfaceDereference</a>)(interface-&gt;<a class="code" href="../../d8/d3/struct__INTERFACE.html#o2">Context</a>);
00230             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(interface);
00231         }
00232         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(entry);
00233     }
00234     InitializeListHead(&amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o24">DeviceArbiterList</a>);
00235 
00236     <span class="comment">//</span>
00237     <span class="comment">// Dereference all the translators on this PDO.</span>
00238     <span class="comment">//</span>
00239 
00240     listHead = &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o25">DeviceTranslatorList</a>;
00241     nextEntry = listHead-&gt;Flink;
00242     <span class="keywordflow">while</span> (nextEntry != listHead) {
00243         entry = nextEntry;
00244         nextEntry = nextEntry-&gt;Flink;
00245         handlerEntry = CONTAINING_RECORD(entry, <a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html">PI_RESOURCE_TRANSLATOR_ENTRY</a>, DeviceTranslatorList);
00246         <span class="keywordflow">if</span> (interface = (<a class="code" href="../../d8/d3/struct__INTERFACE.html">PINTERFACE</a>)handlerEntry-&gt;<a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html#o2">TranslatorInterface</a>) {
00247             (interface-&gt;<a class="code" href="../../d8/d3/struct__INTERFACE.html#o4">InterfaceDereference</a>)(interface-&gt;<a class="code" href="../../d8/d3/struct__INTERFACE.html#o2">Context</a>);
00248             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(interface);
00249         }
00250         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(entry);
00251     }
00252 
00253     InitializeListHead(&amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o25">DeviceTranslatorList</a>);
00254 
00255     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o28">NoArbiterMask</a> = 0;
00256     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o29">QueryArbiterMask</a> = 0;
00257     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o26">NoTranslatorMask</a> = 0;
00258     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o27">QueryTranslatorMask</a> = 0;
00259 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="pnpirp.c::IopUnlockMountedDeviceForRemove" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopUnlockMountedDeviceForRemove           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpMinorCode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d2/struct__LOCK__MOUNTABLE__DEVICE__CONTEXT.html">PLOCK_MOUNTABLE_DEVICE_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01233">1233</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01181">_DEVICE_OBJECT::AttachedDevice</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01205">_DEVICE_OBJECT::DeviceLock</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01070">_VPB::Flags</a>, <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00056">IO_NO_INCREMENT</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00134">IoAcquireVpbSpinLock()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00054">IopDatabaseLock</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09644">IoReleaseVpbSpinLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00162">IRP_MN_REMOVE_DEVICE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01186">_DEVICE_OBJECT::Vpb</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01057">VPB_REMOVE_PENDING</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00927">IopRemoveDevice()</a>.
<p>
<pre class="fragment"><div>01238 {
01239     <a class="code" href="../../d7/d7/struct__VPB.html">PVPB</a> vpb;
01240     BOOLEAN removePendingSet;
01241 
01242     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> device = DeviceObject;
01243 
01244     <span class="keywordflow">do</span> {
01245 
01246         KIRQL oldIrql;
01247 
01248         <span class="comment">//</span>
01249         <span class="comment">// Walk up each device object in the stack.  For each one, if a VPB</span>
01250         <span class="comment">// exists, grab the database resource exclusive followed by the</span>
01251         <span class="comment">// device lock.  Then acquire the Vpb spinlock and perform the</span>
01252         <span class="comment">// appropriate magic on the device object.</span>
01253         <span class="comment">//</span>
01254 
01255         <span class="comment">//</span>
01256         <span class="comment">// NOTE - It's unfortunate that the locking order includes grabing</span>
01257         <span class="comment">// the device specific lock first followed by the global lock.</span>
01258         <span class="comment">//</span>
01259 
01260         <span class="keywordflow">if</span> (device-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o10">Vpb</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01261 
01262             <span class="comment">//</span>
01263             <span class="comment">// Grab the device lock.  This will ensure that there are no mount</span>
01264             <span class="comment">// or verify operations in progress, which in turn will ensure</span>
01265             <span class="comment">// that any mounted file system won't go away.</span>
01266             <span class="comment">//</span>
01267 
01268             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;(device-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o22">DeviceLock</a>),
01269                                   Executive,
01270                                   KernelMode,
01271                                   FALSE,
01272                                   NULL);
01273 
01274             <span class="comment">//</span>
01275             <span class="comment">// Now decrement the reference count in the VPB.  If the remove</span>
01276             <span class="comment">// pending flag has been set in the VPB (if this is a QUERY or a</span>
01277             <span class="comment">// REMOVE) then even on a dismount no new file system will be</span>
01278             <span class="comment">// allowed onto the device.</span>
01279             <span class="comment">//</span>
01280 
01281             <a class="code" href="../../d4/d6/iosubs_8c.html#a10">IoAcquireVpbSpinLock</a>(&amp;oldIrql);
01282 
01283             <span class="keywordflow">if</span> (IrpMinorCode == <a class="code" href="../../d0/d5/io_8h.html#a67">IRP_MN_REMOVE_DEVICE</a>) {
01284 
01285                 device-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o10">Vpb</a>-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o2">Flags</a> &amp;= ~<a class="code" href="../../d0/d5/io_8h.html#a119">VPB_REMOVE_PENDING</a>;
01286             }
01287 
01288             <a class="code" href="../../d4/d6/iosubs_8c.html#a102">IoReleaseVpbSpinLock</a>(oldIrql);
01289 
01290             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;(device-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o22">DeviceLock</a>), IO_NO_INCREMENT, FALSE);
01291         }
01292 
01293         <span class="comment">//</span>
01294         <span class="comment">// Continue up the chain until we know we hit the device the fs</span>
01295         <span class="comment">// mounted on, if any.</span>
01296         <span class="comment">//</span>
01297 
01298         <span class="keywordflow">if</span> (Context-&gt;MountedDevice == device) {
01299 
01300             <span class="keywordflow">break</span>;
01301 
01302         } <span class="keywordflow">else</span> {
01303 
01304             ExAcquireFastLock( &amp;IopDatabaseLock, &amp;oldIrql );
01305             device = device-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
01306             ExReleaseFastLock( &amp;IopDatabaseLock, oldIrql );
01307         }
01308 
01309     } <span class="keywordflow">while</span> (device != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01310 
01311     <span class="keywordflow">return</span>;
01312 }
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a4" doxytag="pnpirp.c::IrpName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PCHAR <a class="el" href="../../d0/d1/pnpirp_8c.html#a4">IrpName</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div> {
    <span class="stringliteral">"IRP_MN_START_DEVICE - "</span>,                 
    <span class="stringliteral">"IRP_MN_QUERY_REMOVE_DEVICE - "</span>,          
    <span class="stringliteral">"IRP_MN_REMOVE_DEVICE - "</span>,                
    <span class="stringliteral">"IRP_MN_CANCEL_REMOVE_DEVICE - "</span>,         
    <span class="stringliteral">"IRP_MN_STOP_DEVICE - "</span>,                  
    <span class="stringliteral">"IRP_MN_QUERY_STOP_DEVICE - "</span>,            
    <span class="stringliteral">"IRP_MN_CANCEL_STOP_DEVICE - "</span>,           
    <span class="stringliteral">"IRP_MN_QUERY_DEVICE_RELATIONS - "</span>,       
    <span class="stringliteral">"IRP_MN_QUERY_INTERFACE - "</span>,              
    <span class="stringliteral">"IRP_MN_QUERY_CAPABILITIES - "</span>,           
    <span class="stringliteral">"IRP_MN_QUERY_RESOURCES - "</span>,              
    <span class="stringliteral">"IRP_MN_QUERY_RESOURCE_REQUIREMENTS - "</span>,  
    <span class="stringliteral">"IRP_MN_QUERY_DEVICE_TEXT - "</span>,            
    <span class="stringliteral">"IRP_MN_FILTER_RESOURCE_REQUIREMENTS - "</span>, 
    <span class="stringliteral">"INVALID_IRP_CODE - "</span>,                    
    <span class="stringliteral">"IRP_MN_READ_CONFIG - "</span>,                  
    <span class="stringliteral">"IRP_MN_WRITE_CONFIG - "</span>,                 
    <span class="stringliteral">"IRP_MN_EJECT - "</span>,                        
    <span class="stringliteral">"IRP_MN_SET_LOCK - "</span>,                     
    <span class="stringliteral">"IRP_MN_QUERY_ID - "</span>,                     
    <span class="stringliteral">"IRP_MN_QUERY_PNP_DEVICE_STATE - "</span>,       
    <span class="stringliteral">"IRP_MN_QUERY_BUS_INFORMATION - "</span>,        
    <span class="stringliteral">"IRP_MN_DEVICE_USAGE_NOTIFICATION - "</span>,    
    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00037">37</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="pnpirp.c::PnpIrpMask" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d0/d1/pnpirp_8c.html#a3">PnpIrpMask</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00036">36</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:14 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
