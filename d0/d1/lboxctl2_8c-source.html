<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: lboxctl2.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>lboxctl2.c</h1><a href="../../d9/d1/lboxctl2_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/***************************************************************************\</span>
00002 <span class="comment">*</span>
00003 <span class="comment">*  LBOXCTL2.C -</span>
00004 <span class="comment">*</span>
00005 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00006 <span class="comment">*</span>
00007 <span class="comment">*      List box handling routines</span>
00008 <span class="comment">*</span>
00009 <span class="comment">* 18-Dec-1990 ianja    Ported from Win 3.0 sources</span>
00010 <span class="comment">* 14-Feb-1991 mikeke   Added Revalidation code</span>
00011 <span class="comment">\***************************************************************************/</span>
00012 
00013 <span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00014 <span class="preprocessor">#pragma hdrstop</span>
00015 <span class="preprocessor"></span>
<a name="l00016"></a><a class="code" href="../../d9/d1/lboxctl2_8c.html#a0">00016</a> <span class="preprocessor">#define LB_KEYDOWN WM_USER+1</span>
<a name="l00017"></a><a class="code" href="../../d9/d1/lboxctl2_8c.html#a1">00017</a> <span class="preprocessor"></span><span class="preprocessor">#define NOMODIFIER  0  </span><span class="comment">/* No modifier is down */</span>
<a name="l00018"></a><a class="code" href="../../d9/d1/lboxctl2_8c.html#a2">00018</a> <span class="preprocessor">#define SHIFTDOWN   1  </span><span class="comment">/* Shift alone */</span>
<a name="l00019"></a><a class="code" href="../../d9/d1/lboxctl2_8c.html#a3">00019</a> <span class="preprocessor">#define CTLDOWN     2  </span><span class="comment">/* Ctl alone */</span>
<a name="l00020"></a><a class="code" href="../../d9/d1/lboxctl2_8c.html#a4">00020</a> <span class="preprocessor">#define SHCTLDOWN   (SHIFTDOWN + CTLDOWN)  </span><span class="comment">/* Ctrl + Shift */</span>
00021 
00022 <span class="comment">/*</span>
00023 <span class="comment"> * Variables for incremental type search support</span>
00024 <span class="comment"> */</span>
<a name="l00025"></a><a class="code" href="../../d9/d1/lboxctl2_8c.html#a5">00025</a> <span class="preprocessor">#define MAX_TYPESEARCH  256</span>
00026 <span class="preprocessor"></span>
00027 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d1/lboxctl2_8c.html#a7">LBGetDC</a>(<a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb);
00028 <span class="keywordtype">void</span> <a class="code" href="../../d9/d1/lboxctl2_8c.html#a8">LBReleaseDC</a>(<a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb);
00029 
00030 <span class="comment">/***************************************************************************\</span>
00031 <span class="comment">*</span>
00032 <span class="comment">*  LBInvalidateRect()</span>
00033 <span class="comment">*</span>
00034 <span class="comment">*  If the listbox is visible, invalidates a rectangle in the listbox.</span>
00035 <span class="comment">*  If the listbox is not visible, sets the defer update flag for the listbox</span>
00036 <span class="comment">*</span>
00037 <span class="comment">\***************************************************************************/</span>
<a name="l00038"></a><a class="code" href="../../d6/d0/usercli_8h.html#a711">00038</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/usercli_8h.html#a711">xxxLBInvalidateRect</a>(<a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb, LPRECT lprc, BOOL fErase)
00039 {
00040     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
00041 
00042     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a108">IsLBoxVisible</a>(plb)) {
00043         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a206">NtUserInvalidateRect</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>), lprc, fErase);
00044         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00045     }
00046 
00047     <span class="keywordflow">if</span> (!plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o19">fRedraw</a>)
00048         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o20">fDeferUpdate</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00049 
00050     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00051 }
00052 
00053 <span class="comment">/***************************************************************************\</span>
00054 <span class="comment">*</span>
00055 <span class="comment">*  LBGetBrush()</span>
00056 <span class="comment">*</span>
00057 <span class="comment">*  Gets background brush &amp; colors for listbox.</span>
00058 <span class="comment">*</span>
00059 <span class="comment">\***************************************************************************/</span>
<a name="l00060"></a><a class="code" href="../../d9/d1/lboxctl2_8c.html#a10">00060</a> HBRUSH <a class="code" href="../../d9/d1/lboxctl2_8c.html#a10">xxxLBGetBrush</a>(<a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb, HBRUSH *phbrOld)
00061 {
00062     HBRUSH  hbr;
00063     HBRUSH  hbrOld;
00064     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndParent;
00065 
00066     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
00067 
00068     SetBkMode(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o59">hdc</a>, OPAQUE);
00069 
00070     <span class="comment">//</span>
00071     <span class="comment">// Get brush &amp; colors</span>
00072     <span class="comment">//</span>
00073     <span class="keywordflow">if</span> ((plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00074         (<a class="code" href="../../d6/d0/usercli_8h.html#a27">REBASEPWND</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>, spwndParent) == <a class="code" href="../../d3/d9/client_2wow_8c.html#a3">_GetDesktopWindow</a>())) {
00075         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o0">spwndParent</a>, &amp;tlpwndParent);
00076         hbr = <a class="code" href="../../d6/d0/usercli_8h.html#a236">GetControlColor</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o0">spwndParent</a>), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>),
00077                               plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o59">hdc</a>, WM_CTLCOLORLISTBOX);
00078         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndParent);
00079     } <span class="keywordflow">else</span>
00080         hbr = <a class="code" href="../../d6/d0/usercli_8h.html#a235">GetControlBrush</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>), plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o59">hdc</a>, WM_CTLCOLORLISTBOX);
00081 
00082     <span class="comment">//</span>
00083     <span class="comment">// Select brush into dc</span>
00084     <span class="comment">//</span>
00085     <span class="keywordflow">if</span> (hbr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00086         hbrOld = SelectObject(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o59">hdc</a>, hbr);
00087         <span class="keywordflow">if</span> (phbrOld)
00088             *phbrOld = hbrOld;
00089     }
00090 
00091     <span class="keywordflow">return</span>(hbr);
00092 }
00093 
00094 
00095 <span class="comment">/***************************************************************************\</span>
00096 <span class="comment">*</span>
00097 <span class="comment">*  LBInitDC()</span>
00098 <span class="comment">*</span>
00099 <span class="comment">*  Initializes dc for listbox</span>
00100 <span class="comment">*</span>
00101 <span class="comment">\***************************************************************************/</span>
<a name="l00102"></a><a class="code" href="../../d9/d1/lboxctl2_8c.html#a11">00102</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/d1/lboxctl2_8c.html#a11">LBInitDC</a>(<a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb)
00103 {
00104     RECT    rc;
00105 
00106     <span class="comment">// Set font</span>
00107     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o55">hFont</a>)
00108         SelectObject(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o59">hdc</a>, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o55">hFont</a>);
00109 
00110     <span class="comment">// Set clipping area</span>
00111     <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a19">_GetClientRect</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>, &amp;rc);
00112     IntersectClipRect(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o59">hdc</a>, rc.left, rc.top, rc.right, rc.bottom);
00113 
00114     OffsetWindowOrgEx(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o59">hdc</a>, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o56">xOrigin</a>, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00115 }
00116 
00117 
00118 <span class="comment">/***************************************************************************\</span>
00119 <span class="comment">* LBGetDC</span>
00120 <span class="comment">*</span>
00121 <span class="comment">* Returns a DC which can be used by a list box even if parentDC is in effect</span>
00122 <span class="comment">*</span>
00123 <span class="comment">* History:</span>
00124 <span class="comment">\***************************************************************************/</span>
00125 
<a name="l00126"></a><a class="code" href="../../d9/d1/lboxctl2_8c.html#a7">00126</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d1/lboxctl2_8c.html#a7">LBGetDC</a>(
00127     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb)
00128 {
00129     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o59">hdc</a>)
00130         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00131 
00132     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o59">hdc</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a250">NtUserGetDC</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>));
00133 
00134     <a class="code" href="../../d9/d1/lboxctl2_8c.html#a11">LBInitDC</a>(plb);
00135 
00136     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00137 }
00138 
00139 <span class="comment">/***************************************************************************\</span>
00140 <span class="comment">*</span>
00141 <span class="comment">*  LBTermDC()</span>
00142 <span class="comment">*</span>
00143 <span class="comment">*  Cleans up when done with listbox dc.</span>
00144 <span class="comment">*</span>
00145 <span class="comment">\***************************************************************************/</span>
<a name="l00146"></a><a class="code" href="../../d9/d1/lboxctl2_8c.html#a12">00146</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/d1/lboxctl2_8c.html#a12">LBTermDC</a>(<a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb)
00147 {
00148     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o55">hFont</a>)
00149         SelectObject(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o59">hdc</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a28">ghFontSys</a>);
00150 }
00151 
00152 
00153 
00154 <span class="comment">/***************************************************************************\</span>
00155 <span class="comment">* LBReleaseDC</span>
00156 <span class="comment">*</span>
00157 <span class="comment">* History:</span>
00158 <span class="comment">\***************************************************************************/</span>
00159 
<a name="l00160"></a><a class="code" href="../../d9/d1/lboxctl2_8c.html#a8">00160</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/d1/lboxctl2_8c.html#a8">LBReleaseDC</a>(
00161     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb)
00162 {
00163     <a class="code" href="../../d9/d1/lboxctl2_8c.html#a12">LBTermDC</a>(plb);
00164     <a class="code" href="../../d6/d0/usercli_8h.html#a211">NtUserReleaseDC</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>), plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o59">hdc</a>);
00165     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o59">hdc</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00166 }
00167 
00168 
00169 <span class="comment">/***************************************************************************\</span>
00170 <span class="comment">* LBGetItemRect</span>
00171 <span class="comment">*</span>
00172 <span class="comment">* Return the rectangle that the item will be drawn in with respect to the</span>
00173 <span class="comment">* listbox window.  Returns TRUE if any portion of the item's rectangle</span>
00174 <span class="comment">* is visible (ie. in the listbox client rect) else returns FALSE.</span>
00175 <span class="comment">*</span>
00176 <span class="comment">* History:</span>
00177 <span class="comment">\***************************************************************************/</span>
00178 
<a name="l00179"></a><a class="code" href="../../d6/d0/usercli_8h.html#a744">00179</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/usercli_8h.html#a744">LBGetItemRect</a>(
00180     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
00181     INT sItem,
00182     LPRECT lprc)
00183 {
00184     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> sTmp;
00185     <span class="keywordtype">int</span> clientbottom;
00186 
00187     <span class="comment">/*</span>
00188 <span class="comment">     * Always allow an item number of 0 so that we can draw the caret which</span>
00189 <span class="comment">     * indicates the listbox has the focus even though it is empty.</span>
00190 <span class="comment"></span>
00191 <span class="comment">     * FreeHand 3.1 passes in -1 as the itemNumber and expects</span>
00192 <span class="comment">     * a non-null rectangle. So we check for -1 specifically.</span>
00193 <span class="comment">     * BUGTAG: Fix for Bug #540 --Win95B-- SANKAR -- 2/20/95 --</span>
00194 <span class="comment">     */</span>
00195 
00196     <span class="keywordflow">if</span> (sItem &amp;&amp; (sItem != -1) &amp;&amp; ((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)sItem &gt;= (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>))
00197     {
00198         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a35">SetRectEmpty</a>(lprc);
00199         RIPERR0(ERROR_INVALID_INDEX, RIP_VERBOSE, <span class="stringliteral">""</span>);
00200         <span class="keywordflow">return</span> (LB_ERR);
00201     }
00202 
00203     <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a19">_GetClientRect</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>, lprc);
00204 
00205     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o34">fMultiColumn</a>) {
00206 
00207         <span class="comment">/*</span>
00208 <span class="comment">         * itemHeight * sItem mod number ItemsPerColumn (itemsPerColumn)</span>
00209 <span class="comment">         */</span>
00210         lprc-&gt;top = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o13">cyChar</a> * (sItem % plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o15">itemsPerColumn</a>);
00211         lprc-&gt;bottom = lprc-&gt;top + plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o13">cyChar</a>  <span class="comment">/*+(plb-&gt;OwnerDraw ? 0 : 1)*/</span>;
00212 
00213         UserAssert(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o15">itemsPerColumn</a>);
00214 
00215         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o47">fRightAlign</a>) {
00216             lprc-&gt;right = lprc-&gt;right - plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o14">cxColumn</a> *
00217                  ((sItem / plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o15">itemsPerColumn</a>) - (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a> / plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o15">itemsPerColumn</a>));
00218 
00219             lprc-&gt;left = lprc-&gt;right - plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o14">cxColumn</a>;
00220         } <span class="keywordflow">else</span> {
00221             <span class="comment">/*</span>
00222 <span class="comment">             * Remember, this is integer division here...</span>
00223 <span class="comment">             */</span>
00224             lprc-&gt;left += plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o14">cxColumn</a> *
00225                       ((sItem / plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o15">itemsPerColumn</a>) - (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a> / plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o15">itemsPerColumn</a>));
00226 
00227             lprc-&gt;right = lprc-&gt;left + plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o14">cxColumn</a>;
00228         }
00229     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a63">OWNERDRAWVAR</a>) {
00230 
00231         <span class="comment">/*</span>
00232 <span class="comment">         * Var height owner draw</span>
00233 <span class="comment">         */</span>
00234         lprc-&gt;right += plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o56">xOrigin</a>;
00235         clientbottom = lprc-&gt;bottom;
00236 
00237         <span class="keywordflow">if</span> (sItem &gt;= plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a>) {
00238             <span class="keywordflow">for</span> (sTmp = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a>; sTmp &lt; sItem; sTmp++) {
00239                 lprc-&gt;top = lprc-&gt;top + <a class="code" href="../../d6/d0/usercli_8h.html#a746">LBGetVariableHeightItemHeight</a>(plb, sTmp);
00240             }
00241 
00242             <span class="comment">/*</span>
00243 <span class="comment">             * If item number is 0, it may be we are asking for the rect</span>
00244 <span class="comment">             * associated with a nonexistant item so that we can draw a caret</span>
00245 <span class="comment">             * indicating focus on an empty listbox.</span>
00246 <span class="comment">             */</span>
00247             lprc-&gt;bottom = lprc-&gt;top + (sItem &lt; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> ? <a class="code" href="../../d6/d0/usercli_8h.html#a746">LBGetVariableHeightItemHeight</a>(plb, sItem) : plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o13">cyChar</a>);
00248             <span class="keywordflow">return</span> (lprc-&gt;top &lt; clientbottom);
00249         } <span class="keywordflow">else</span> {
00250 
00251             <span class="comment">/*</span>
00252 <span class="comment">             * Item we want the rect of is before plb-&gt;iTop.  Thus, negative</span>
00253 <span class="comment">             * offsets for the rect and it is never visible.</span>
00254 <span class="comment">             */</span>
00255             <span class="keywordflow">for</span> (sTmp = sItem; sTmp &lt; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a>; sTmp++) {
00256                 lprc-&gt;top = lprc-&gt;top - <a class="code" href="../../d6/d0/usercli_8h.html#a746">LBGetVariableHeightItemHeight</a>(plb, sTmp);
00257             }
00258             lprc-&gt;bottom = lprc-&gt;top + <a class="code" href="../../d6/d0/usercli_8h.html#a746">LBGetVariableHeightItemHeight</a>(plb, sItem);
00259             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00260         }
00261     } <span class="keywordflow">else</span> {
00262 
00263         <span class="comment">/*</span>
00264 <span class="comment">         * For fixed height listboxes</span>
00265 <span class="comment">         */</span>
00266         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o47">fRightAlign</a> &amp;&amp; !(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o34">fMultiColumn</a> || plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a>) &amp;&amp; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o38">fHorzBar</a>)
00267             lprc-&gt;right += plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o56">xOrigin</a> + (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o50">xRightOrigin</a> - plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o56">xOrigin</a>);
00268         <span class="keywordflow">else</span>
00269             lprc-&gt;right += plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o56">xOrigin</a>;
00270         lprc-&gt;top = (sItem - plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a>) * plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o13">cyChar</a>;
00271         lprc-&gt;bottom = lprc-&gt;top + plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o13">cyChar</a>;
00272     }
00273 
00274     <span class="keywordflow">return</span> (sItem &gt;= plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a>) &amp;&amp;
00275             (sItem &lt; (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a> + <a class="code" href="../../d6/d0/usercli_8h.html#a713">CItemInWindow</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)));
00276 }
00277 
00278 
00279 <span class="comment">/***************************************************************************\</span>
00280 <span class="comment">*</span>
00281 <span class="comment">*  LBPrintCallback</span>
00282 <span class="comment">*</span>
00283 <span class="comment">*  Called back from DrawState()</span>
00284 <span class="comment">*</span>
00285 <span class="comment">\***************************************************************************/</span>
<a name="l00286"></a><a class="code" href="../../d9/d1/lboxctl2_8c.html#a14">00286</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> CALLBACK <a class="code" href="../../d9/d1/lboxctl2_8c.html#a14">LBPrintCallback</a>(HDC hdc, LPWSTR lpstr, <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb, <span class="keywordtype">int</span> cx, <span class="keywordtype">int</span> cy)
00287 {
00288     <span class="keywordtype">int</span>     xStart;
00289     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>    cLen;
00290     RECT    rc;
00291     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>    oldAlign;
00292 
00293     <span class="keywordflow">if</span> (!lpstr) {
00294         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00295     }
00296 
00297     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o34">fMultiColumn</a>)
00298         xStart = 0;
00299     <span class="keywordflow">else</span>
00300         xStart = 2;
00301 
00302     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o47">fRightAlign</a>) {
00303         oldAlign = SetTextAlign(hdc, TA_RIGHT | GetTextAlign(hdc));
00304         xStart = cx - xStart;
00305     }
00306 
00307     cLen = wcslen(lpstr);
00308 
00309     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o33">fUseTabStops</a>) {
00310         <a class="code" href="../../d6/d0/usercli_8h.html#a422">TabTextOut</a>(hdc, xStart, 0, lpstr, cLen,
00311             (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o54">iTabPixelPositions</a> ? plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o54">iTabPixelPositions</a>[0] : 0),
00312             (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o54">iTabPixelPositions</a> ? (LPINT)&amp;plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o54">iTabPixelPositions</a>[1] : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>),
00313             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o47">fRightAlign</a> ? cx : 0, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, GetTextCharset(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o59">hdc</a>));
00314     } <span class="keywordflow">else</span> {
00315         rc.left     = 0;
00316         rc.top      = 0;
00317         rc.right    = cx;
00318         rc.bottom   = <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
00319 
00320         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a>)
00321             ExtTextOut(hdc, xStart, 0, ETO_OPAQUE, &amp;rc, lpstr, cLen, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00322         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o34">fMultiColumn</a>)
00323             ExtTextOut(hdc, xStart, 0, ETO_CLIPPED, &amp;rc, lpstr, cLen, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00324         <span class="keywordflow">else</span> {
00325             ExtTextOut(hdc, xStart, 0, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, lpstr, cLen, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00326 
00327             <span class="comment">/*</span>
00328 <span class="comment">             * When the listbox is in the incremental search mode and the item</span>
00329 <span class="comment">             * is highlighted (so we only draw in the current item), draw the</span>
00330 <span class="comment">             * caret for search indication.</span>
00331 <span class="comment">             */</span>
00332             <span class="keywordflow">if</span> ((plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o61">iTypeSearch</a> != 0) &amp;&amp; (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a> == 0) &amp;&amp;
00333                     (GetBkColor(hdc) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(HIGHLIGHT))) {
00334                 SIZE size;
00335                 GetTextExtentPointW(hdc, lpstr, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o61">iTypeSearch</a>, &amp;size);
00336                 PatBlt(hdc, xStart + size.cx - 1, 1, 1, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> - 2, DSTINVERT);
00337             }
00338         }
00339     }
00340 
00341     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o47">fRightAlign</a>)
00342         SetTextAlign(hdc, oldAlign);
00343 
00344     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00345 }
00346 
00347 
00348 <span class="comment">/***************************************************************************\</span>
00349 <span class="comment">* xxxLBDrawLBItem</span>
00350 <span class="comment">*</span>
00351 <span class="comment">* History:</span>
00352 <span class="comment">\***************************************************************************/</span>
00353 
<a name="l00354"></a><a class="code" href="../../d9/d1/lboxctl2_8c.html#a15">00354</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/d1/lboxctl2_8c.html#a15">xxxLBDrawLBItem</a>(
00355     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
00356     INT sItem,
00357     LPRECT lprect,
00358     BOOL fHilite,
00359     HBRUSH hbr)
00360 {
00361     LPWSTR lpstr;
00362     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> rgbSave;
00363     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> rgbBkSave;
00364     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>    uFlags;
00365     HDC     hdc = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o59">hdc</a>;
00366     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>  oldAlign;
00367 
00368     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
00369 
00370     <span class="comment">/*</span>
00371 <span class="comment">     * If the item is selected, then fill with highlight color</span>
00372 <span class="comment">     */</span>
00373     <span class="keywordflow">if</span> (fHilite) {
00374         <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>(hdc, lprect, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(HIGHLIGHT));
00375         rgbBkSave = SetBkColor(hdc, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(HIGHLIGHT));
00376         rgbSave = SetTextColor(hdc, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(HIGHLIGHTTEXT));
00377     } <span class="keywordflow">else</span> {
00378 
00379         <span class="comment">/*</span>
00380 <span class="comment">         * If fUseTabStops, we must fill the background, because later we use</span>
00381 <span class="comment">         * LBTabTheTextOutForWimps(), which fills the background only partially</span>
00382 <span class="comment">         * Fix for Bug #1509 -- 01/25/91 -- SANKAR --</span>
00383 <span class="comment">         */</span>
00384         <span class="keywordflow">if</span> ((hbr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; ((sItem == plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>) || (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o33">fUseTabStops</a>))) {
00385             <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>(hdc, lprect, hbr);
00386         }
00387     }
00388 
00389     uFlags = DST_COMPLEX;
00390     lpstr = <a class="code" href="../../d6/d0/usercli_8h.html#a715">GetLpszItem</a>(plb, sItem);
00391 
00392     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a651">WFDISABLED</a>)) {
00393         <span class="keywordflow">if</span> ((COLORREF)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(GRAYTEXT) != GetBkColor(hdc))
00394             SetTextColor(hdc, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(GRAYTEXT));
00395         <span class="keywordflow">else</span>
00396             uFlags |= DSS_UNION;
00397     }
00398 
00399     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o47">fRightAlign</a>)
00400         uFlags |= DSS_RIGHT;
00401 
00402     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o48">fRtoLReading</a>)
00403         oldAlign = SetTextAlign(hdc, TA_RTLREADING | GetTextAlign(hdc));
00404 
00405     DrawState(hdc, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(WINDOWTEXT),
00406         (DRAWSTATEPROC)<a class="code" href="../../d9/d1/lboxctl2_8c.html#a14">LBPrintCallback</a>,
00407         (LPARAM)lpstr,
00408         (WPARAM)plb,
00409         lprect-&gt;left,
00410         lprect-&gt;top,
00411         lprect-&gt;right-lprect-&gt;left,
00412         lprect-&gt;bottom-lprect-&gt;top,
00413         uFlags);
00414 
00415     <span class="keywordflow">if</span> (plb-&gt;fRtoLReading)
00416         SetTextAlign(hdc, oldAlign);
00417 
00418     <span class="keywordflow">if</span> (fHilite) {
00419         SetTextColor(hdc, rgbSave);
00420         SetBkColor(hdc, rgbBkSave);
00421     }
00422 }
00423 
00424 
00425 <span class="comment">/***************************************************************************\</span>
00426 <span class="comment">*</span>
00427 <span class="comment">* LBSetCaret()</span>
00428 <span class="comment">*</span>
00429 <span class="comment">\***************************************************************************/</span>
<a name="l00430"></a><a class="code" href="../../d6/d0/usercli_8h.html#a695">00430</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(<a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb, BOOL fSetCaret)
00431 {
00432     RECT    rc;
00433     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fNewDC;
00434 
00435     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o26">fCaret</a> &amp;&amp; ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>) plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o28">fCaretOn</a> != !!fSetCaret)) {
00436         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a108">IsLBoxVisible</a>(plb)) {
00437             <span class="comment">/* Turn the caret (located at plb-&gt;iSelBase) on */</span>
00438             fNewDC = <a class="code" href="../../d9/d1/lboxctl2_8c.html#a7">LBGetDC</a>(plb);
00439 
00440             <a class="code" href="../../d6/d0/usercli_8h.html#a744">LBGetItemRect</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>, &amp;rc);
00441 
00442             <span class="keywordflow">if</span> (fNewDC) {
00443                 SetBkColor(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o59">hdc</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a273">WINDOW</a>));
00444                 SetTextColor(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o59">hdc</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(WINDOWTEXT));
00445             }
00446 
00447             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a>) {
00448                 <span class="comment">/* Fill in the drawitem struct */</span>
00449                 <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> itemState = (fSetCaret) ? ODS_FOCUS : 0;
00450 
00451                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a687">IsSelected</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>, <a class="code" href="../../d6/d0/usercli_8h.html#a248">HILITEONLY</a>))
00452                     itemState |= ODS_SELECTED;
00453 
00454                 <a class="code" href="../../d6/d0/usercli_8h.html#a701">xxxLBoxDrawItem</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>, ODA_FOCUS, itemState, &amp;rc);
00455             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>, <a class="code" href="../../d1/d0/inc_2user_8h.html#a622">WEFPUIFOCUSHIDDEN</a>)) {
00456                 COLORREF crBk = SetBkColor(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o59">hdc</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a273">WINDOW</a>));
00457                 COLORREF crText = SetTextColor(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o59">hdc</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(WINDOWTEXT));
00458 
00459                 <a class="code" href="../../d3/d9/clrect_8c.html#a0">DrawFocusRect</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o59">hdc</a>, &amp;rc);
00460 
00461                 SetBkColor(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o59">hdc</a>, crBk);
00462                 SetTextColor(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o59">hdc</a>, crText);
00463             }
00464 
00465             <span class="keywordflow">if</span> (fNewDC)
00466                 <a class="code" href="../../d9/d1/lboxctl2_8c.html#a8">LBReleaseDC</a>(plb);
00467         }
00468         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o28">fCaretOn</a> = !!fSetCaret;
00469     }
00470 }
00471 
00472 
00473 <span class="comment">/***************************************************************************\</span>
00474 <span class="comment">* IsSelected</span>
00475 <span class="comment">*</span>
00476 <span class="comment">* History:</span>
00477 <span class="comment">* 16-Apr-1992 beng      The NODATA listbox case</span>
00478 <span class="comment">\***************************************************************************/</span>
00479 
<a name="l00480"></a><a class="code" href="../../d6/d0/usercli_8h.html#a687">00480</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/usercli_8h.html#a687">IsSelected</a>(
00481     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
00482     INT sItem,
00483     UINT wOpFlags)
00484 {
00485     LPBYTE lp;
00486 
00487     <span class="keywordflow">if</span> ((sItem &gt;= plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>) || (sItem &lt; 0)) {
00488         RIPERR0(ERROR_INVALID_INDEX, RIP_VERBOSE, <span class="stringliteral">""</span>);
00489 <span class="comment">//        return LB_ERR;</span>
00490         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00491     }
00492 
00493     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a114">SINGLESEL</a>) {
00494         <span class="keywordflow">return</span> (sItem == plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a>);
00495     }
00496 
00497     lp = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o8">rgpch</a> + sItem +
00498              (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> * (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o30">fHasStrings</a>
00499                                 ? <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagLBItem.html">LBItem</a>)
00500                                 : (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o31">fHasData</a>
00501                                     ? <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d9/structtagLBODItem.html">LBODItem</a>)
00502                                     : 0)));
00503     sItem = *lp;
00504 
00505     <span class="keywordflow">if</span> (wOpFlags == <a class="code" href="../../d6/d0/usercli_8h.html#a248">HILITEONLY</a>) {
00506         sItem &gt;&gt;= 4;
00507     } <span class="keywordflow">else</span> {
00508         sItem &amp;= 0x0F;  <span class="comment">/* SELONLY */</span>
00509     }
00510 
00511     <span class="keywordflow">return</span> sItem;
00512 }
00513 
00514 
00515 <span class="comment">/***************************************************************************\</span>
00516 <span class="comment">* CItemInWindow</span>
00517 <span class="comment">*</span>
00518 <span class="comment">* Returns the number of items which can fit in a list box.  It</span>
00519 <span class="comment">* includes the partially visible one at the bottom if fPartial is TRUE. For</span>
00520 <span class="comment">* var height ownerdraw, return the number of items visible starting at iTop</span>
00521 <span class="comment">* and going to the bottom of the client rect.</span>
00522 <span class="comment">*</span>
00523 <span class="comment">* History:</span>
00524 <span class="comment">\***************************************************************************/</span>
00525 
<a name="l00526"></a><a class="code" href="../../d6/d0/usercli_8h.html#a713">00526</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> <a class="code" href="../../d6/d0/usercli_8h.html#a713">CItemInWindow</a>(
00527     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
00528     BOOL fPartial)
00529 {
00530     RECT rect;
00531 
00532     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a63">OWNERDRAWVAR</a>) {
00533         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a741">CItemInWindowVarOwnerDraw</a>(plb, fPartial);
00534     }
00535 
00536     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o34">fMultiColumn</a>) {
00537         <span class="keywordflow">return</span> plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o15">itemsPerColumn</a> * (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o16">numberOfColumns</a> + (fPartial ? 1 : 0));
00538     }
00539 
00540     <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a19">_GetClientRect</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>, &amp;rect);
00541 
00542     <span class="comment">/*</span>
00543 <span class="comment">     * fPartial must be considered only if the listbox height is not an</span>
00544 <span class="comment">     * integral multiple of character height.</span>
00545 <span class="comment">     * A part of the fix for Bug #3727 -- 01/14/91 -- SANKAR --</span>
00546 <span class="comment">     */</span>
00547     UserAssert(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o13">cyChar</a>);
00548     <span class="keywordflow">return</span> (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)((rect.bottom / plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o13">cyChar</a>) +
00549             ((rect.bottom % plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o13">cyChar</a>)? (fPartial ? 1 : 0) : 0));
00550 }
00551 
00552 
00553 <span class="comment">/***************************************************************************\</span>
00554 <span class="comment">* xxxLBoxCtlScroll</span>
00555 <span class="comment">*</span>
00556 <span class="comment">* Handles vertical scrolling of the listbox</span>
00557 <span class="comment">*</span>
00558 <span class="comment">* History:</span>
00559 <span class="comment">\***************************************************************************/</span>
00560 
<a name="l00561"></a><a class="code" href="../../d9/d1/lboxctl2_8c.html#a19">00561</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a705">xxxLBoxCtlScroll</a>(
00562     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
00563     INT cmd,
00564     <span class="keywordtype">int</span> yAmt)
00565 {
00566     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> iTopNew;
00567     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> cItemPageScroll;
00568     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwTime = 0;
00569 
00570     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
00571 
00572     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o34">fMultiColumn</a>) {
00573 
00574         <span class="comment">/*</span>
00575 <span class="comment">         * Don't allow vertical scrolling on a multicolumn list box.  Needed</span>
00576 <span class="comment">         * in case app sends WM_VSCROLL messages to the listbox.</span>
00577 <span class="comment">         */</span>
00578         <span class="keywordflow">return</span>;
00579     }
00580 
00581     cItemPageScroll = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o5">cItemFullMax</a>;
00582 
00583     <span class="keywordflow">if</span> (cItemPageScroll &gt; 1)
00584         cItemPageScroll--;
00585 
00586     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>) {
00587         iTopNew = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a>;
00588         <span class="keywordflow">switch</span> (cmd) {
00589         <span class="keywordflow">case</span> SB_LINEUP:
00590             dwTime = yAmt;
00591             iTopNew--;
00592             <span class="keywordflow">break</span>;
00593 
00594         <span class="keywordflow">case</span> SB_LINEDOWN:
00595             dwTime = yAmt;
00596             iTopNew++;
00597             <span class="keywordflow">break</span>;
00598 
00599         <span class="keywordflow">case</span> SB_PAGEUP:
00600             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a63">OWNERDRAWVAR</a>) {
00601                 iTopNew = <a class="code" href="../../d6/d0/usercli_8h.html#a742">LBPage</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00602             } <span class="keywordflow">else</span> {
00603                 iTopNew -= cItemPageScroll;
00604             }
00605             <span class="keywordflow">break</span>;
00606 
00607         <span class="keywordflow">case</span> SB_PAGEDOWN:
00608             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a63">OWNERDRAWVAR</a>) {
00609                 iTopNew = <a class="code" href="../../d6/d0/usercli_8h.html#a742">LBPage</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00610             } <span class="keywordflow">else</span> {
00611                 iTopNew += cItemPageScroll;
00612             }
00613             <span class="keywordflow">break</span>;
00614 
00615         <span class="keywordflow">case</span> SB_THUMBTRACK:
00616         <span class="keywordflow">case</span> SB_THUMBPOSITION: {
00617 
00618             <span class="comment">/*</span>
00619 <span class="comment">             * If the listbox contains more than 0xFFFF items</span>
00620 <span class="comment">             * it means that the scrolbar can return a position</span>
00621 <span class="comment">             * that cannot fit in a WORD (16 bits), so use</span>
00622 <span class="comment">             * GetScrollInfo (which is slower) in this case.</span>
00623 <span class="comment">             */</span>
00624             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> &lt; 0xFFFF) {
00625                 iTopNew = yAmt;
00626             } <span class="keywordflow">else</span> {
00627                 SCROLLINFO si;
00628 
00629                 si.cbSize   = <span class="keyword">sizeof</span>(SCROLLINFO);
00630                 si.fMask    = SIF_TRACKPOS;
00631 
00632                 <a class="code" href="../../d3/d8/winmgrc_8c.html#a21">GetScrollInfo</a>( <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>), SB_VERT, &amp;si);
00633 
00634                 iTopNew = si.nTrackPos;
00635             }
00636             <span class="keywordflow">break</span>;
00637         }
00638         <span class="keywordflow">case</span> SB_TOP:
00639             iTopNew = 0;
00640             <span class="keywordflow">break</span>;
00641 
00642         <span class="keywordflow">case</span> SB_BOTTOM:
00643             iTopNew = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> - 1;
00644             <span class="keywordflow">break</span>;
00645 
00646         <span class="keywordflow">case</span> SB_ENDSCROLL:
00647             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o49">fSmoothScroll</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00648             <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00649             <a class="code" href="../../d6/d0/usercli_8h.html#a706">xxxLBShowHideScrollBars</a>(plb);
00650             <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00651             <span class="keywordflow">return</span>;
00652         }
00653 
00654         <a class="code" href="../../d6/d0/usercli_8h.html#a731">xxxNewITopEx</a>(plb, iTopNew, dwTime);
00655     }
00656 }
00657 
00658 <span class="comment">/***************************************************************************\</span>
00659 <span class="comment">* LBGetScrollFlags</span>
00660 <span class="comment">*</span>
00661 <span class="comment">\***************************************************************************/</span>
00662 
<a name="l00663"></a><a class="code" href="../../d9/d1/lboxctl2_8c.html#a20">00663</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d9/d1/lboxctl2_8c.html#a20">LBGetScrollFlags</a>(<a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb, DWORD dwTime)
00664 {
00665     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;
00666 
00667     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/queue_8c.html#a34">GetAppCompatFlags</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp; GACF_NOSMOOTHSCROLLING)
00668         <span class="keywordflow">goto</span> NoSmoothScrolling;
00669 
00670     <span class="keywordflow">if</span> (dwTime != 0) {
00671         <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> = MAKELONG(SW_SCROLLWINDOW | SW_SMOOTHSCROLL | SW_SCROLLCHILDREN, dwTime);
00672     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a382">TEST_EffectPUSIF</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a367">PUSIF_LISTBOXSMOOTHSCROLLING</a>) &amp;&amp; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o49">fSmoothScroll</a>) {
00673         <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> = SW_SCROLLWINDOW | SW_SMOOTHSCROLL | SW_SCROLLCHILDREN;
00674         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o49">fSmoothScroll</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00675     } <span class="keywordflow">else</span> {
00676 NoSmoothScrolling:
00677         <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> = SW_SCROLLWINDOW | SW_INVALIDATE | SW_ERASE | SW_SCROLLCHILDREN;
00678     }
00679 
00680     <span class="keywordflow">return</span> <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;
00681 }
00682 
00683 <span class="comment">/***************************************************************************\</span>
00684 <span class="comment">* xxxLBoxCtlHScroll</span>
00685 <span class="comment">*</span>
00686 <span class="comment">* Supports horizontal scrolling of listboxes</span>
00687 <span class="comment">*</span>
00688 <span class="comment">* History:</span>
00689 <span class="comment">\***************************************************************************/</span>
00690 
<a name="l00691"></a><a class="code" href="../../d9/d1/lboxctl2_8c.html#a21">00691</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a703">xxxLBoxCtlHScroll</a>(
00692     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
00693     INT cmd,
00694     <span class="keywordtype">int</span> xAmt)
00695 {
00696     <span class="keywordtype">int</span> newOrigin = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o56">xOrigin</a>;
00697     <span class="keywordtype">int</span> oldOrigin = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o56">xOrigin</a>;
00698     <span class="keywordtype">int</span> windowWidth;
00699     RECT rc;
00700     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwTime = 0;
00701 
00702     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
00703 
00704     <span class="comment">/*</span>
00705 <span class="comment">     * Update the window so that we don't run into problems with invalid</span>
00706 <span class="comment">     * regions during the horizontal scroll.</span>
00707 <span class="comment">     */</span>
00708     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o34">fMultiColumn</a>) {
00709 
00710         <span class="comment">/*</span>
00711 <span class="comment">         * Handle multicolumn scrolling in a separate segment</span>
00712 <span class="comment">         */</span>
00713         <a class="code" href="../../d6/d0/usercli_8h.html#a704">xxxLBoxCtlHScrollMultiColumn</a>(plb, cmd, xAmt);
00714         <span class="keywordflow">return</span>;
00715     }
00716 
00717     <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a19">_GetClientRect</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>, &amp;rc);
00718     windowWidth = rc.right;
00719 
00720     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>) {
00721 
00722         <span class="keywordflow">switch</span> (cmd) {
00723         <span class="keywordflow">case</span> SB_LINEUP:
00724             dwTime = xAmt;
00725             newOrigin -= plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o12">cxChar</a>;
00726             <span class="keywordflow">break</span>;
00727 
00728         <span class="keywordflow">case</span> SB_LINEDOWN:
00729             dwTime = xAmt;
00730             newOrigin += plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o12">cxChar</a>;
00731             <span class="keywordflow">break</span>;
00732 
00733         <span class="keywordflow">case</span> SB_PAGEUP:
00734             newOrigin -= (windowWidth / 3) * 2;
00735             <span class="keywordflow">break</span>;
00736 
00737         <span class="keywordflow">case</span> SB_PAGEDOWN:
00738             newOrigin += (windowWidth / 3) * 2;
00739             <span class="keywordflow">break</span>;
00740 
00741         <span class="keywordflow">case</span> SB_THUMBTRACK:
00742         <span class="keywordflow">case</span> SB_THUMBPOSITION:
00743             newOrigin = xAmt;
00744             <span class="keywordflow">break</span>;
00745 
00746         <span class="keywordflow">case</span> SB_TOP:
00747             newOrigin = 0;
00748             <span class="keywordflow">break</span>;
00749 
00750         <span class="keywordflow">case</span> SB_BOTTOM:
00751             newOrigin = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o57">maxWidth</a>;
00752             <span class="keywordflow">break</span>;
00753 
00754         <span class="keywordflow">case</span> SB_ENDSCROLL:
00755             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o49">fSmoothScroll</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00756             <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00757             <a class="code" href="../../d6/d0/usercli_8h.html#a706">xxxLBShowHideScrollBars</a>(plb);
00758             <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00759             <span class="keywordflow">return</span>;
00760         }
00761 
00762         <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00763         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o56">xOrigin</a> = newOrigin;
00764         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o56">xOrigin</a> = <a class="code" href="../../d6/d0/usercli_8h.html#a739">xxxSetLBScrollParms</a>(plb, SB_HORZ);
00765 
00766         <span class="keywordflow">if</span> ((cmd == SB_BOTTOM) &amp;&amp; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o47">fRightAlign</a>) {
00767             <span class="comment">/*</span>
00768 <span class="comment">             * so we know where to draw from.</span>
00769 <span class="comment">             */</span>
00770             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o50">xRightOrigin</a> = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o56">xOrigin</a>;
00771         }
00772 
00773         <span class="keywordflow">if</span>(oldOrigin != plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o56">xOrigin</a>)  {
00774             HWND hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
00775             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;
00776 
00777             <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> = <a class="code" href="../../d9/d1/lboxctl2_8c.html#a20">LBGetScrollFlags</a>(plb, dwTime);
00778             <a class="code" href="../../d3/d8/winmgrc_8c.html#a38">ScrollWindowEx</a>(hwnd, oldOrigin-plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o56">xOrigin</a>,
00779                 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;rc, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
00780             <a class="code" href="../../d3/d8/client_8c.html#a140">UpdateWindow</a>(hwnd);
00781         }
00782 
00783         <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00784     } <span class="keywordflow">else</span> {
00785         <span class="comment">// this is a less-than-ideal fix for ImageMind ScreenSaver (Win95</span>
00786         <span class="comment">// B#8252) but it works and it doesn't hurt anybody -- JEFFBOG 10/28/94</span>
00787         <a class="code" href="../../d6/d0/usercli_8h.html#a739">xxxSetLBScrollParms</a>(plb, SB_HORZ);
00788     }
00789 }
00790 
00791 
00792 <span class="comment">/***************************************************************************\</span>
00793 <span class="comment">* xxxLBoxCtlPaint</span>
00794 <span class="comment">*</span>
00795 <span class="comment">* History:</span>
00796 <span class="comment">\***************************************************************************/</span>
00797 
<a name="l00798"></a><a class="code" href="../../d6/d0/usercli_8h.html#a710">00798</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a710">xxxLBPaint</a>(
00799     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
00800     HDC hdc,
00801     LPRECT lprcBounds)
00802 {
00803     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> i;
00804     RECT rect;
00805     RECT    scratchRect;
00806     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fHilite;
00807     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> iLastItem;
00808     HBRUSH hbrSave = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00809     HBRUSH hbrControl;
00810     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fCaretOn;
00811     RECT    rcBounds;
00812     HDC     hdcSave;
00813 
00814     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
00815 
00816     <span class="keywordflow">if</span> (lprcBounds == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00817         lprcBounds = &amp;rcBounds;
00818         <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a19">_GetClientRect</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>, lprcBounds);
00819     }
00820 
00821     hdcSave = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o59">hdc</a>;
00822     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o59">hdc</a> = hdc;
00823 
00824     <span class="comment">// Initialize dc.</span>
00825     <a class="code" href="../../d9/d1/lboxctl2_8c.html#a11">LBInitDC</a>(plb);
00826 
00827     <span class="comment">// Turn caret off</span>
00828     <span class="keywordflow">if</span> (fCaretOn = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o28">fCaretOn</a>)
00829         <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00830 
00831     hbrSave = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00832     hbrControl = <a class="code" href="../../d9/d1/lboxctl2_8c.html#a10">xxxLBGetBrush</a>(plb, &amp;hbrSave);
00833 
00834     <span class="comment">// Get listbox's client</span>
00835     <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a19">_GetClientRect</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>, &amp;rect);
00836 
00837     <span class="comment">// Adjust width of client rect for scrolled amount</span>
00838     <span class="comment">// fix for #140, t-arthb</span>
00839     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o47">fRightAlign</a> &amp;&amp; !(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o34">fMultiColumn</a> || plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a>) &amp;&amp; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o38">fHorzBar</a>)
00840         rect.right += plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o56">xOrigin</a> + (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o50">xRightOrigin</a> - plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o56">xOrigin</a>);
00841     <span class="keywordflow">else</span>
00842         rect.right += plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o56">xOrigin</a>;
00843 
00844     <span class="comment">// Get the index of the last item visible on the screen. This is also</span>
00845     <span class="comment">// valid for var height ownerdraw.</span>
00846     iLastItem = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a> + <a class="code" href="../../d6/d0/usercli_8h.html#a713">CItemInWindow</a>(plb,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00847     iLastItem = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(iLastItem, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> - 1);
00848 
00849     <span class="comment">// Fill in the background of the listbox if it's an empty listbox</span>
00850     <span class="comment">// or if we're doing a control print</span>
00851     <span class="keywordflow">if</span> (iLastItem == -1)
00852         <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o59">hdc</a>, &amp;rect, hbrControl);
00853 
00854 
00855     <span class="comment">// Allow AnimateWindow() catch the apps that do not use our DC when</span>
00856     <span class="comment">// drawing the list box</span>
00857     SetBoundsRect(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o59">hdc</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, DCB_RESET | DCB_ENABLE);
00858 
00859     <span class="keywordflow">for</span> (i = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a>; i &lt;= iLastItem; i++) {
00860 
00861         <span class="comment">/*</span>
00862 <span class="comment">         * Note that rect contains the clientrect from when we did the</span>
00863 <span class="comment">         * _GetClientRect so the width is correct.  We just need to adjust</span>
00864 <span class="comment">         * the top and bottom of the rectangle to the item of interest.</span>
00865 <span class="comment">         */</span>
00866         rect.bottom = rect.top + plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o13">cyChar</a>;
00867 
00868         <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)i &lt; (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>) {
00869 
00870             <span class="comment">/*</span>
00871 <span class="comment">             * If var height, get the rectangle for the item.</span>
00872 <span class="comment">             */</span>
00873             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a63">OWNERDRAWVAR</a> || plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o34">fMultiColumn</a>) {
00874                 <a class="code" href="../../d6/d0/usercli_8h.html#a744">LBGetItemRect</a>(plb, i, &amp;rect);
00875             }
00876 
00877             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;scratchRect, lprcBounds, &amp;rect)) {
00878                 fHilite = !plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o41">fNoSel</a> &amp;&amp; <a class="code" href="../../d6/d0/usercli_8h.html#a687">IsSelected</a>(plb, i, <a class="code" href="../../d6/d0/usercli_8h.html#a248">HILITEONLY</a>);
00879 
00880                 <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a>) {
00881 
00882                     <span class="comment">/*</span>
00883 <span class="comment">                     * Fill in the drawitem struct</span>
00884 <span class="comment">                     */</span>
00885                     <a class="code" href="../../d6/d0/usercli_8h.html#a701">xxxLBoxDrawItem</a>(plb, i, ODA_DRAWENTIRE,
00886                             (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(fHilite ? ODS_SELECTED : 0), &amp;rect);
00887                 } <span class="keywordflow">else</span> {
00888                     <a class="code" href="../../d9/d1/lboxctl2_8c.html#a15">xxxLBDrawLBItem</a>(plb, i, &amp;rect, fHilite, hbrControl);
00889                 }
00890             }
00891         }
00892         rect.top = rect.bottom;
00893     }
00894 
00895     <span class="keywordflow">if</span> (hbrSave != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00896         SelectObject(hdc, hbrSave);
00897 
00898     <span class="keywordflow">if</span> (fCaretOn)
00899         <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00900 
00901     <a class="code" href="../../d9/d1/lboxctl2_8c.html#a12">LBTermDC</a>(plb);
00902 
00903     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o59">hdc</a> = hdcSave;
00904 }
00905 
00906 
00907 <span class="comment">/***************************************************************************\</span>
00908 <span class="comment">* ISelFromPt</span>
00909 <span class="comment">*</span>
00910 <span class="comment">* In the loword, returns the closest item number the pt is on. The high</span>
00911 <span class="comment">* word is 0 if the point is within bounds of the listbox client rect and is</span>
00912 <span class="comment">* 1 if it is outside the bounds.  This will allow us to make the invertrect</span>
00913 <span class="comment">* disappear if the mouse is outside the listbox yet we can still show the</span>
00914 <span class="comment">* outline around the item that would be selected if the mouse is brought back</span>
00915 <span class="comment">* in bounds...</span>
00916 <span class="comment">*</span>
00917 <span class="comment">* History:</span>
00918 <span class="comment">\***************************************************************************/</span>
00919 
<a name="l00920"></a><a class="code" href="../../d6/d0/usercli_8h.html#a686">00920</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/usercli_8h.html#a686">ISelFromPt</a>(
00921     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
00922     POINT pt,
00923     LPDWORD piItem)
00924 {
00925     RECT rect;
00926     <span class="keywordtype">int</span> y;
00927     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> mouseHighWord = 0;
00928     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> sItem;
00929     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> sTmp;
00930 
00931     <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a19">_GetClientRect</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>, &amp;rect);
00932 
00933     <span class="keywordflow">if</span> (pt.y &lt; 0) {
00934 
00935         <span class="comment">/*</span>
00936 <span class="comment">         * Mouse is out of bounds above listbox</span>
00937 <span class="comment">         */</span>
00938         *piItem = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a>;
00939         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00940     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((y = pt.y) &gt; rect.bottom) {
00941         y = rect.bottom;
00942         mouseHighWord = 1;
00943     }
00944 
00945     <span class="keywordflow">if</span> (pt.x &lt; 0 || pt.x &gt; rect.right)
00946         mouseHighWord = 1;
00947 
00948     <span class="comment">/*</span>
00949 <span class="comment">     * Now just need to check if y mouse coordinate intersects item's rectangle</span>
00950 <span class="comment">     */</span>
00951     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a> != <a class="code" href="../../d6/d0/usercli_8h.html#a63">OWNERDRAWVAR</a>) {
00952         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o34">fMultiColumn</a>) {
00953             <span class="keywordflow">if</span> (y &lt; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o15">itemsPerColumn</a> * plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o13">cyChar</a>) {
00954                 <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o47">fRightAlign</a>)
00955                     sItem = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a> + (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)((y / plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o13">cyChar</a>) +
00956                             ((rect.right - pt.x) / plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o14">cxColumn</a>) * plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o15">itemsPerColumn</a>);
00957                 <span class="keywordflow">else</span>
00958                     sItem = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a> + (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)((y / plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o13">cyChar</a>) +
00959                             (pt.x / plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o14">cxColumn</a>) * plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o15">itemsPerColumn</a>);
00960 
00961             } <span class="keywordflow">else</span> {
00962 
00963                 <span class="comment">/*</span>
00964 <span class="comment">                 * User clicked in blank space at the bottom of a column.</span>
00965 <span class="comment">                 * Just select the last item in the column.</span>
00966 <span class="comment">                 */</span>
00967                 mouseHighWord = 1;
00968                 sItem = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a> + (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o15">itemsPerColumn</a> - 1) +
00969                         (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)((pt.x / plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o14">cxColumn</a>) * plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o15">itemsPerColumn</a>);
00970             }
00971         } <span class="keywordflow">else</span> {
00972             sItem = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a> + (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)(y / plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o13">cyChar</a>);
00973         }
00974     } <span class="keywordflow">else</span> {
00975 
00976         <span class="comment">/*</span>
00977 <span class="comment">         * VarHeightOwnerdraw so we gotta do this the hardway...   Set the x</span>
00978 <span class="comment">         * coordinate of the mouse down point to be inside the listbox client</span>
00979 <span class="comment">         * rectangle since we no longer care about it.  This lets us use the</span>
00980 <span class="comment">         * point in rect calls.</span>
00981 <span class="comment">         */</span>
00982         pt.x = 8;
00983         pt.y = y;
00984         <span class="keywordflow">for</span> (sTmp = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a>; sTmp &lt; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>; sTmp++) {
00985             (<span class="keywordtype">void</span>)<a class="code" href="../../d6/d0/usercli_8h.html#a744">LBGetItemRect</a>(plb, sTmp, &amp;rect);
00986             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(&amp;rect, pt)) {
00987                 *piItem = sTmp;
00988                 <span class="keywordflow">return</span> mouseHighWord;
00989             }
00990         }
00991 
00992         <span class="comment">/*</span>
00993 <span class="comment">         * Point was at the empty area at the bottom of a not full listbox</span>
00994 <span class="comment">         */</span>
00995         *piItem = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> - 1;
00996         <span class="keywordflow">return</span> mouseHighWord;
00997     }
00998 
00999     <span class="comment">/*</span>
01000 <span class="comment">     * Check if user clicked on the blank area at the bottom of a not full list.</span>
01001 <span class="comment">     * Assumes &gt; 0 items in the listbox.</span>
01002 <span class="comment">     */</span>
01003     <span class="keywordflow">if</span> (sItem &gt; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> - 1) {
01004         mouseHighWord = 1;
01005         sItem = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> - 1;
01006     }
01007 
01008     *piItem = sItem;
01009     <span class="keywordflow">return</span> mouseHighWord;
01010 }
01011 
01012 
01013 <span class="comment">/***************************************************************************\</span>
01014 <span class="comment">* SetSelected</span>
01015 <span class="comment">*</span>
01016 <span class="comment">* This is used for button initiated changes of selection state.</span>
01017 <span class="comment">*</span>
01018 <span class="comment">*  fSelected : TRUE  if the item is to be set as selected, FALSE otherwise</span>
01019 <span class="comment">*</span>
01020 <span class="comment">*  wOpFlags : HILITEONLY = Modify only the Display state (hi-nibble)</span>
01021 <span class="comment">*             SELONLY    = Modify only the Selection state (lo-nibble)</span>
01022 <span class="comment">*             HILITEANDSEL = Modify both of them;</span>
01023 <span class="comment">*</span>
01024 <span class="comment">* History:</span>
01025 <span class="comment">* 16-Apr-1992 beng      The NODATA listbox case</span>
01026 <span class="comment">\***************************************************************************/</span>
01027 
<a name="l01028"></a><a class="code" href="../../d6/d0/usercli_8h.html#a694">01028</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a694">SetSelected</a>(
01029     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
01030     INT iSel,
01031     BOOL fSelected,
01032     UINT wOpFlags)
01033 {
01034     LPSTR lp;
01035     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> cMask;
01036     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> cSelStatus;
01037 
01038     <span class="keywordflow">if</span> (iSel &lt; 0 || iSel &gt;= plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>)
01039         <span class="keywordflow">return</span>;
01040 
01041     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a114">SINGLESEL</a>) {
01042         <span class="keywordflow">if</span> (fSelected)
01043             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a> = iSel;
01044     } <span class="keywordflow">else</span> {
01045         cSelStatus = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)fSelected;
01046         <span class="keywordflow">switch</span> (wOpFlags) {
01047         <span class="keywordflow">case</span> <a class="code" href="../../d6/d0/usercli_8h.html#a248">HILITEONLY</a>:
01048 
01049             <span class="comment">/*</span>
01050 <span class="comment">             * Mask out lo-nibble</span>
01051 <span class="comment">             */</span>
01052             cSelStatus = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)(cSelStatus &lt;&lt; 4);
01053             cMask = 0x0F;
01054             <span class="keywordflow">break</span>;
01055         <span class="keywordflow">case</span> <a class="code" href="../../d6/d0/usercli_8h.html#a249">SELONLY</a>:
01056 
01057             <span class="comment">/*</span>
01058 <span class="comment">             * Mask out hi-nibble</span>
01059 <span class="comment">             */</span>
01060             cMask = 0xF0;
01061             <span class="keywordflow">break</span>;
01062         <span class="keywordflow">case</span> <a class="code" href="../../d6/d0/usercli_8h.html#a250">HILITEANDSEL</a>:
01063 
01064             <span class="comment">/*</span>
01065 <span class="comment">             * Mask the byte fully</span>
01066 <span class="comment">             */</span>
01067             cSelStatus |= (cSelStatus &lt;&lt; 4);
01068             cMask = 0;
01069             <span class="keywordflow">break</span>;
01070         }
01071         lp = (LPSTR)(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o8">rgpch</a>) + iSel +
01072                 (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> * (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o30">fHasStrings</a>
01073                                 ? <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagLBItem.html">LBItem</a>)
01074                                 : (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o31">fHasData</a> ? <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d9/structtagLBODItem.html">LBODItem</a>) : 0)));
01075 
01076         *lp = (*lp &amp; cMask) | cSelStatus;
01077     }
01078 }
01079 
01080 
01081 <span class="comment">/***************************************************************************\</span>
01082 <span class="comment">* LastFullVisible</span>
01083 <span class="comment">*</span>
01084 <span class="comment">* Returns the last fully visible item in the listbox. This is valid</span>
01085 <span class="comment">* for ownerdraw var height and fixed height listboxes.</span>
01086 <span class="comment">*</span>
01087 <span class="comment">* History:</span>
01088 <span class="comment">\***************************************************************************/</span>
01089 
<a name="l01090"></a><a class="code" href="../../d6/d0/usercli_8h.html#a727">01090</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> <a class="code" href="../../d6/d0/usercli_8h.html#a727">LastFullVisible</a>(
01091     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb)
01092 {
01093     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> iLastItem;
01094 
01095     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a63">OWNERDRAWVAR</a> || plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o34">fMultiColumn</a>) {
01096         iLastItem = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a> + <a class="code" href="../../d6/d0/usercli_8h.html#a713">CItemInWindow</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) - 1;
01097         iLastItem = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(iLastItem, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a>);
01098     } <span class="keywordflow">else</span> {
01099         iLastItem = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a> + plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o5">cItemFullMax</a> - 1, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> - 1);
01100     }
01101     <span class="keywordflow">return</span> iLastItem;
01102 }
01103 
01104 
01105 <span class="comment">/***************************************************************************\</span>
01106 <span class="comment">* xxxInvertLBItem</span>
01107 <span class="comment">*</span>
01108 <span class="comment">* History:</span>
01109 <span class="comment">\***************************************************************************/</span>
01110 
<a name="l01111"></a><a class="code" href="../../d6/d0/usercli_8h.html#a717">01111</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a717">xxxInvertLBItem</a>(
01112     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
01113     INT i,
01114     BOOL fHilite)  <span class="comment">/* The new selection state of the item */</span>
01115 {
01116     RECT rect;
01117     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fCaretOn;
01118     HBRUSH hbrControl;
01119     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fNewDC;
01120 
01121     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
01122 
01123     <span class="comment">// Skip if item isn't showing.</span>
01124     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o41">fNoSel</a> || (i &lt; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a>) || (i &gt;= (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a> + <a class="code" href="../../d6/d0/usercli_8h.html#a713">CItemInWindow</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))))
01125         <span class="keywordflow">return</span>;
01126 
01127     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a108">IsLBoxVisible</a>(plb)) {
01128         <a class="code" href="../../d6/d0/usercli_8h.html#a744">LBGetItemRect</a>(plb, i, &amp;rect);
01129 
01130         <span class="comment">/*</span>
01131 <span class="comment">         * Only turn off the caret if it is on.  This avoids annoying caret</span>
01132 <span class="comment">         * flicker when nesting xxxCaretOns and xxxCaretOffs.</span>
01133 <span class="comment">         */</span>
01134         <span class="keywordflow">if</span> (fCaretOn = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o28">fCaretOn</a>) {
01135             <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01136         }
01137 
01138         fNewDC = <a class="code" href="../../d9/d1/lboxctl2_8c.html#a7">LBGetDC</a>(plb);
01139 
01140         hbrControl = <a class="code" href="../../d9/d1/lboxctl2_8c.html#a10">xxxLBGetBrush</a>(plb, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01141 
01142         <span class="keywordflow">if</span> (!plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a>) {
01143             <span class="keywordflow">if</span> (!fHilite) {
01144                 <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o59">hdc</a>, &amp;rect, hbrControl);
01145                 hbrControl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01146             }
01147 
01148             <a class="code" href="../../d9/d1/lboxctl2_8c.html#a15">xxxLBDrawLBItem</a>(plb, i, &amp;rect, fHilite, hbrControl);
01149         } <span class="keywordflow">else</span> {
01150 
01151             <span class="comment">/*</span>
01152 <span class="comment">             * We are ownerdraw so fill in the drawitem struct and send off</span>
01153 <span class="comment">             * to the owner.</span>
01154 <span class="comment">             */</span>
01155             <a class="code" href="../../d6/d0/usercli_8h.html#a701">xxxLBoxDrawItem</a>(plb, i, ODA_SELECT,
01156                     (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(fHilite ? ODS_SELECTED : 0), &amp;rect);
01157         }
01158 
01159         <span class="keywordflow">if</span> (fNewDC)
01160             <a class="code" href="../../d9/d1/lboxctl2_8c.html#a8">LBReleaseDC</a>(plb);
01161 
01162         <span class="comment">/*</span>
01163 <span class="comment">         * Turn the caret back on only if it was originally on.</span>
01164 <span class="comment">         */</span>
01165         <span class="keywordflow">if</span> (fCaretOn) {
01166             <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01167         }
01168     }
01169 }
01170 
01171 
01172 <span class="comment">/***************************************************************************\</span>
01173 <span class="comment">* xxxResetWorld</span>
01174 <span class="comment">*</span>
01175 <span class="comment">* Resets everyone's selection and hilite state except items in the</span>
01176 <span class="comment">* range sStItem to sEndItem (Both inclusive).</span>
01177 <span class="comment">*</span>
01178 <span class="comment">* History:</span>
01179 <span class="comment">\***************************************************************************/</span>
01180 
<a name="l01181"></a><a class="code" href="../../d6/d0/usercli_8h.html#a733">01181</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a733">xxxResetWorld</a>(
01182     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
01183     INT iStart,
01184     INT iEnd,
01185     BOOL fSelect)
01186 {
01187     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> i;
01188     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> iLastInWindow;
01189     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fCaretOn;
01190 
01191     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
01192 
01193     <span class="comment">/*</span>
01194 <span class="comment">     * If iStart and iEnd are not in correct order we swap them</span>
01195 <span class="comment">     */</span>
01196 
01197     <span class="keywordflow">if</span> (iStart &gt; iEnd) {
01198         i = iStart;
01199         iStart = iEnd;
01200         iEnd = i;
01201     }
01202 
01203     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a114">SINGLESEL</a>) {
01204         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a> != -1 &amp;&amp; ((plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a> &lt; iStart) || (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a> &gt; iEnd))) {
01205             <a class="code" href="../../d6/d0/usercli_8h.html#a717">xxxInvertLBItem</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a>, fSelect);
01206             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a> = -1;
01207         }
01208         <span class="keywordflow">return</span>;
01209     }
01210 
01211     iLastInWindow = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a> + <a class="code" href="../../d6/d0/usercli_8h.html#a713">CItemInWindow</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01212 
01213     <span class="keywordflow">if</span> (fCaretOn = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o28">fCaretOn</a>)
01214         <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01215 
01216     <span class="keywordflow">for</span> (i = 0; i &lt; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>; i++) {
01217         <span class="keywordflow">if</span> (i == iStart)
01218             <span class="comment">// skip range to be preserved</span>
01219             i = iEnd;
01220         <span class="keywordflow">else</span> {
01221             <span class="keywordflow">if</span> ((plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a> &lt;= i) &amp;&amp; (i &lt;= iLastInWindow) &amp;&amp;
01222                 (fSelect != <a class="code" href="../../d6/d0/usercli_8h.html#a687">IsSelected</a>(plb, i, <a class="code" href="../../d6/d0/usercli_8h.html#a248">HILITEONLY</a>)))
01223                 <span class="comment">// Only invert the item if it is visible and present Selection</span>
01224                 <span class="comment">// state is different from what is required.</span>
01225                 <a class="code" href="../../d6/d0/usercli_8h.html#a717">xxxInvertLBItem</a>(plb, i, fSelect);
01226 
01227             <span class="comment">// Set all items outside of preserved range to unselected</span>
01228             <a class="code" href="../../d6/d0/usercli_8h.html#a694">SetSelected</a>(plb, i, fSelect, <a class="code" href="../../d6/d0/usercli_8h.html#a250">HILITEANDSEL</a>);
01229         }
01230     }
01231 
01232     <span class="keywordflow">if</span> (fCaretOn)
01233         <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01234 
01235 }
01236 
01237 
01238 <span class="comment">/***************************************************************************\</span>
01239 <span class="comment">* xxxNotifyOwner</span>
01240 <span class="comment">*</span>
01241 <span class="comment">* History:</span>
01242 <span class="comment">\***************************************************************************/</span>
01243 
<a name="l01244"></a><a class="code" href="../../d6/d0/usercli_8h.html#a732">01244</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a732">xxxNotifyOwner</a>(
01245     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
01246     INT sEvt)
01247 {
01248     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndParent;
01249 
01250     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
01251 
01252     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o0">spwndParent</a>, &amp;tlpwndParent);
01253     <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o0">spwndParent</a>), WM_COMMAND,
01254             MAKELONG(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>), sEvt), (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>));
01255     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndParent);
01256 }
01257 
01258 
01259 <span class="comment">/***************************************************************************\</span>
01260 <span class="comment">* xxxSetISelBase</span>
01261 <span class="comment">*</span>
01262 <span class="comment">* History:</span>
01263 <span class="comment">\***************************************************************************/</span>
01264 
<a name="l01265"></a><a class="code" href="../../d6/d0/usercli_8h.html#a693">01265</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a693">xxxSetISelBase</a>(
01266     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
01267     INT sItem)
01268 {
01269     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
01270 
01271     <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01272     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a> = sItem;
01273     <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01274 
01275     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
01276         <a class="code" href="../../d6/d0/usercli_8h.html#a716">xxxInsureVisible</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01277         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/rtl_2wow_8c.html#a17">_IsWindowVisible</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>)) {
01278             <a class="code" href="../../d6/d0/usercli_8h.html#a409">LBEvent</a>(plb, EVENT_OBJECT_FOCUS, sItem);
01279         }
01280     }
01281 }
01282 
01283 
01284 <span class="comment">/***************************************************************************\</span>
01285 <span class="comment">* xxxTrackMouse</span>
01286 <span class="comment">*</span>
01287 <span class="comment">* History:</span>
01288 <span class="comment">\***************************************************************************/</span>
01289 
<a name="l01290"></a><a class="code" href="../../d6/d0/usercli_8h.html#a734">01290</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a734">xxxTrackMouse</a>(
01291     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
01292     UINT wMsg,
01293     POINT pt)
01294 {
01295     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> iSelFromPt;
01296     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> iSelTemp;
01297     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> mousetemp;
01298     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fMouseInRect;
01299     RECT rcClient;
01300     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> wModifiers = 0;
01301     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSelected;
01302     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uEvent = 0;
01303     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> trackPtRetn;
01304     HWND hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
01305     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndEdit;
01306     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndParent;
01307 
01308     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
01309 
01310     <span class="comment">/*</span>
01311 <span class="comment">     * Optimization:  do nothing if mouse not captured</span>
01312 <span class="comment">     */</span>
01313     <span class="keywordflow">if</span> ((wMsg != WM_LBUTTONDOWN) &amp;&amp; (wMsg != WM_LBUTTONDBLCLK)) {
01314         <span class="keywordflow">if</span> (!plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o25">fCaptured</a>) {
01315             <span class="keywordflow">return</span>;
01316         }
01317         <span class="comment">/*</span>
01318 <span class="comment">         * If we are processing a WM_MOUSEMOVE but the mouse has not moved from</span>
01319 <span class="comment">         * the previous point, then we may be dealing with a mouse "jiggle" sent</span>
01320 <span class="comment">         * from the kernel (see zzzInvalidateDCCache).  If we process this, we will</span>
01321 <span class="comment">         * snap the listbox selection back to where the mouse cursor is pointing,</span>
01322 <span class="comment">         * even if the user has not touched the mouse.  FritzS: NT5 bug 220722.</span>
01323 <span class="comment">         *  Some apps (like MSMoney98) rely on this, so added the bLastRITWasKeyboard</span>
01324 <span class="comment">         * check.  MCostea #244450</span>
01325 <span class="comment">         */</span>
01326         <span class="keywordflow">if</span> ((wMsg == WM_MOUSEMOVE) &amp;&amp; RtlEqualMemory(&amp;pt, &amp;(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o17">ptPrev</a>), <span class="keyword">sizeof</span>(POINT))
01327             &amp;&amp; <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;bLastRITWasKeyboard) {
01328                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxTrackMouse ignoring WM_MOUSEMOVE with no mouse movement"</span>);
01329                 <span class="keywordflow">return</span>;
01330         }
01331     }
01332 
01333     mousetemp = <a class="code" href="../../d6/d0/usercli_8h.html#a686">ISelFromPt</a>(plb, pt, &amp;iSelFromPt);
01334 
01335     <span class="comment">/*</span>
01336 <span class="comment">     * If we allow the user to cancel his selection then fMouseInRect is true if</span>
01337 <span class="comment">     * the mouse is in the listbox client area otherwise it is false.  If we</span>
01338 <span class="comment">     * don't allow the user to cancel his selection, then fMouseInRect will</span>
01339 <span class="comment">     * always be true.  This allows us to implement cancelable selection</span>
01340 <span class="comment">     * listboxes ie.  The selection reverts to the origional one if the user</span>
01341 <span class="comment">     * releases the mouse outside of the listbox.</span>
01342 <span class="comment">     */</span>
01343     fMouseInRect = !mousetemp || !plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o58">pcbox</a>;
01344 
01345     <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a19">_GetClientRect</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>, &amp;rcClient);
01346 
01347     <span class="keywordflow">switch</span> (wMsg) {
01348     <span class="keywordflow">case</span> WM_LBUTTONDBLCLK:
01349     <span class="keywordflow">case</span> WM_LBUTTONDOWN:
01350         <span class="comment">/*</span>
01351 <span class="comment">         * We want to divert mouse clicks.  If the user clicks outside</span>
01352 <span class="comment">         * of a dropped down listbox, we want to popup it up, using</span>
01353 <span class="comment">         * the current selection.</span>
01354 <span class="comment">         */</span>
01355         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o25">fCaptured</a>) {
01356             <span class="comment">/*</span>
01357 <span class="comment">             * If plb-&gt;pcbox is NULL, this is a listbox that</span>
01358 <span class="comment">             * received a WM_LBUTTONDOWN again w/o receiving</span>
01359 <span class="comment">             * a WM_LBUTTONUP for the previous WM_LBUTTONDOWN</span>
01360 <span class="comment">             * bug</span>
01361 <span class="comment">             */</span>
01362             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o58">pcbox</a> &amp;&amp; mousetemp) {
01363                 <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a18">_ClientToScreen</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>, &amp;pt);
01364 
01365                 <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(&amp;plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>, pt)) {
01366                     <span class="comment">/*</span>
01367 <span class="comment">                     * Cancel selection if clicked outside of combo;</span>
01368 <span class="comment">                     * Accept if clicked on combo button or item.</span>
01369 <span class="comment">                     */</span>
01370                     <a class="code" href="../../d6/d0/usercli_8h.html#a667">xxxCBHideListBoxWindow</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o58">pcbox</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01371                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(&amp;plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>, pt)) {
01372                     <span class="comment">/*</span>
01373 <span class="comment">                     * Let it pass through.  Save, restore capture in</span>
01374 <span class="comment">                     * case user is clicking on scrollbar.</span>
01375 <span class="comment">                     */</span>
01376                     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o25">fCaptured</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01377                     <a class="code" href="../../d6/d0/usercli_8h.html#a225">NtUserReleaseCapture</a>();
01378 
01379                     <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>, WM_NCLBUTTONDOWN,
01380                         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1225">FindNCHit</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>, POINTTOPOINTS(pt)),
01381                         MAKELONG(pt.x, pt.y), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01382 
01383                     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a221">NtUserSetCapture</a>(hwnd);
01384                     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o25">fCaptured</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01385                 }
01386 
01387                 <span class="keywordflow">break</span>;
01388             }
01389 
01390             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o25">fCaptured</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01391             <a class="code" href="../../d6/d0/usercli_8h.html#a225">NtUserReleaseCapture</a>();
01392         }
01393 
01394         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o58">pcbox</a>) {
01395 
01396             <span class="comment">/*</span>
01397 <span class="comment">             * If this listbox is in a combo box, set the focus to the combo</span>
01398 <span class="comment">             * box window so that the edit control/static text is also</span>
01399 <span class="comment">             * activated</span>
01400 <span class="comment">             */</span>
01401             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o58">pcbox</a>-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>, &amp;tlpwndEdit);
01402             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a225">NtUserSetFocus</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o58">pcbox</a>-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>));
01403             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndEdit);
01404         } <span class="keywordflow">else</span> {
01405 
01406             <span class="comment">/*</span>
01407 <span class="comment">             * Get the focus if the listbox is clicked in and we don't</span>
01408 <span class="comment">             * already have the focus.  If we don't have the focus after</span>
01409 <span class="comment">             * this, run away...</span>
01410 <span class="comment">             */</span>
01411             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a225">NtUserSetFocus</a>(hwnd);
01412             <span class="keywordflow">if</span> (!plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o26">fCaret</a>)
01413                 <span class="keywordflow">return</span>;
01414         }
01415 
01416         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o29">fAddSelMode</a>) {
01417 
01418             <span class="comment">/*</span>
01419 <span class="comment">             * If it is in "Add" mode, quit it using shift f8 key...</span>
01420 <span class="comment">             * However, since we can't send shift key state, we have to turn</span>
01421 <span class="comment">             * this off directly...</span>
01422 <span class="comment">             */</span>
01423 
01424             <span class="comment">/*</span>
01425 <span class="comment">             *SendMessage(HW(plb-&gt;spwnd),WM_KEYDOWN, (UINT)VK_F8, 0L);</span>
01426 <span class="comment">             */</span>
01427 
01428             <span class="comment">/*</span>
01429 <span class="comment">             * Switch off the Caret blinking</span>
01430 <span class="comment">             */</span>
01431             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a208">NtUserKillTimer</a>(hwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a58">IDSYS_CARET</a>);
01432 
01433             <span class="comment">/*</span>
01434 <span class="comment">             * Make sure the caret does not vanish</span>
01435 <span class="comment">             */</span>
01436             <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01437             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o29">fAddSelMode</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01438         }
01439 
01440         <span class="keywordflow">if</span> (!plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>) {
01441 
01442             <span class="comment">/*</span>
01443 <span class="comment">             * Don't even bother handling the mouse if no items in the</span>
01444 <span class="comment">             * listbox since the code below assumes &gt;0 items in the</span>
01445 <span class="comment">             * listbox.  We will just get the focus (the statement above) if</span>
01446 <span class="comment">             * we don't already have it.</span>
01447 <span class="comment">             */</span>
01448             <span class="keywordflow">break</span>;
01449         }
01450 
01451         <span class="keywordflow">if</span> (mousetemp) {
01452 
01453             <span class="comment">/*</span>
01454 <span class="comment">             * Mouse down occurred in a empty spot.  Just ignore it.</span>
01455 <span class="comment">             */</span>
01456             <span class="keywordflow">break</span>;
01457         }
01458 
01459         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o27">fDoubleClick</a> = (wMsg == WM_LBUTTONDBLCLK);
01460 
01461         <span class="keywordflow">if</span> (!plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o27">fDoubleClick</a>) {
01462 
01463             <span class="comment">/*</span>
01464 <span class="comment">             * This hack put in for the shell.  Tell the shell where in the</span>
01465 <span class="comment">             * listbox the user clicked and at what item number.  The shell</span>
01466 <span class="comment">             * can return 0 to continue normal mouse tracking or TRUE to</span>
01467 <span class="comment">             * abort mouse tracking.</span>
01468 <span class="comment">             */</span>
01469             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o0">spwndParent</a>, &amp;tlpwndParent);
01470             trackPtRetn = (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)<a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o0">spwndParent</a>), WM_LBTRACKPOINT,
01471                     (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)iSelFromPt, MAKELONG(pt.x+plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o56">xOrigin</a>, pt.y));
01472             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndParent);
01473             <span class="keywordflow">if</span> (trackPtRetn) {
01474                 <span class="keywordflow">if</span> (trackPtRetn == 2) {
01475 
01476                     <span class="comment">/*</span>
01477 <span class="comment">                     * Ignore double clicks</span>
01478 <span class="comment">                     */</span>
01479                     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a173">NtUserCallNoParam</a>(SFI__RESETDBLCLK);
01480                 }
01481                 <span class="keywordflow">return</span>;
01482             }
01483         }
01484 
01485         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o58">pcbox</a>) {
01486 
01487             <span class="comment">/*</span>
01488 <span class="comment">             * Save the last selection if this is a combo box.  So that it</span>
01489 <span class="comment">             * can be restored if user decides to cancel the selection by up</span>
01490 <span class="comment">             * clicking outside the listbox.</span>
01491 <span class="comment">             */</span>
01492             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o51">iLastSelection</a> = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a>;
01493         }
01494 
01495         <span class="comment">/*</span>
01496 <span class="comment">         * Save for timer</span>
01497 <span class="comment">         */</span>
01498         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o17">ptPrev</a> = pt;
01499 
01500         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o24">fMouseDown</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01501         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a221">NtUserSetCapture</a>(hwnd);
01502         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o25">fCaptured</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01503 
01504         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o27">fDoubleClick</a>) {
01505 
01506             <span class="comment">/*</span>
01507 <span class="comment">             * Double click.  Fake a button up and exit</span>
01508 <span class="comment">             */</span>
01509             <a class="code" href="../../d6/d0/usercli_8h.html#a734">xxxTrackMouse</a>(plb, WM_LBUTTONUP, pt);
01510             <span class="keywordflow">return</span>;
01511         }
01512 
01513         <span class="comment">/*</span>
01514 <span class="comment">         * Set the system timer so that we can autoscroll if the mouse is</span>
01515 <span class="comment">         * outside the bounds of the listbox rectangle</span>
01516 <span class="comment">         */</span>
01517         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a230">NtUserSetTimer</a>(hwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a56">IDSYS_SCROLL</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;dtScroll, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01518 
01519 
01520 
01521         <span class="comment">/*</span>
01522 <span class="comment">         * If extended multiselection listbox, are any modifier key pressed?</span>
01523 <span class="comment">         */</span>
01524         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a116">EXTENDEDSEL</a>) {
01525             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(VK_SHIFT) &lt; 0)
01526                 wModifiers = <a class="code" href="../../d9/d1/lboxctl2_8c.html#a2">SHIFTDOWN</a>;
01527             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(VK_CONTROL) &lt; 0)
01528                 wModifiers += <a class="code" href="../../d9/d1/lboxctl2_8c.html#a3">CTLDOWN</a>;
01529 
01530             <span class="comment">/*</span>
01531 <span class="comment">             * Please Note that (SHIFTDOWN + CTLDOWN) == (SHCTLDOWN)</span>
01532 <span class="comment">             */</span>
01533         }
01534 
01535 
01536         <span class="keywordflow">switch</span> (wModifiers) {
01537         <span class="keywordflow">case</span> <a class="code" href="../../d9/d1/lboxctl2_8c.html#a1">NOMODIFIER</a>:
01538 MouseMoveHandler:
01539             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a> != iSelFromPt) {
01540                 <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01541             }
01542 
01543             <span class="comment">/*</span>
01544 <span class="comment">             * We only look at the mouse if the point it is pointing to is</span>
01545 <span class="comment">             * not selected.  Since we are not in ExtendedSelMode, anywhere</span>
01546 <span class="comment">             * the mouse points, we have to set the selection to that item.</span>
01547 <span class="comment">             * Hence, if the item isn't selected, it means the mouse never</span>
01548 <span class="comment">             * pointed to it before so we can select it.  We ignore already</span>
01549 <span class="comment">             * selected items so that we avoid flashing the inverted</span>
01550 <span class="comment">             * selection rectangle.  Also, we could get WM_SYSTIMER simulated</span>
01551 <span class="comment">             * mouse moves which would cause flashing otherwise...</span>
01552 <span class="comment">             */</span>
01553 
01554             iSelTemp = (fMouseInRect ? iSelFromPt : -1);
01555 
01556             <span class="comment">/*</span>
01557 <span class="comment">             * If the LB is either SingleSel or Extended multisel, clear all</span>
01558 <span class="comment">             * old selections except the new one being made.</span>
01559 <span class="comment">             */</span>
01560             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a> != <a class="code" href="../../d6/d0/usercli_8h.html#a115">MULTIPLESEL</a>) {
01561                 <a class="code" href="../../d6/d0/usercli_8h.html#a733">xxxResetWorld</a>(plb, iSelTemp, iSelTemp, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01562                 <span class="comment">/*</span>
01563 <span class="comment">                 * This will be TRUE if iSelTemp isn't -1 (like below)</span>
01564 <span class="comment">                 * and also if it is but there is a current selection.</span>
01565 <span class="comment">                 */</span>
01566                 <span class="keywordflow">if</span> ((iSelTemp == -1) &amp;&amp; (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a> != -1)) {
01567                     uEvent = EVENT_OBJECT_SELECTIONREMOVE;
01568                 }
01569             }
01570 
01571             fSelected = <a class="code" href="../../d6/d0/usercli_8h.html#a687">IsSelected</a>(plb, iSelTemp, <a class="code" href="../../d6/d0/usercli_8h.html#a248">HILITEONLY</a>);
01572             <span class="keywordflow">if</span> (iSelTemp != -1) {
01573 
01574                 <span class="comment">/*</span>
01575 <span class="comment">                 * If it is MULTIPLESEL, then toggle; For others, only if</span>
01576 <span class="comment">                 * not selected already, select it.</span>
01577 <span class="comment">                 */</span>
01578                 <span class="keywordflow">if</span> (((plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a115">MULTIPLESEL</a>) &amp;&amp; (wMsg != WM_LBUTTONDBLCLK)) || !fSelected) {
01579                     <a class="code" href="../../d6/d0/usercli_8h.html#a694">SetSelected</a>(plb, iSelTemp, !fSelected, <a class="code" href="../../d6/d0/usercli_8h.html#a250">HILITEANDSEL</a>);
01580 
01581                     <span class="comment">/*</span>
01582 <span class="comment">                     * And invert it</span>
01583 <span class="comment">                     */</span>
01584                     <a class="code" href="../../d6/d0/usercli_8h.html#a717">xxxInvertLBItem</a>(plb, iSelTemp, !fSelected);
01585                     fSelected = !fSelected;  <span class="comment">/* Set the new state */</span>
01586                     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a115">MULTIPLESEL</a>) {
01587                         uEvent = (fSelected ? EVENT_OBJECT_SELECTIONADD :
01588                                 EVENT_OBJECT_SELECTIONREMOVE);
01589                     } <span class="keywordflow">else</span> {
01590                         uEvent = EVENT_OBJECT_SELECTION;
01591                     }
01592                 }
01593             }
01594 
01595             <span class="comment">/*</span>
01596 <span class="comment">             * We have to set iSel in case this is a multisel lb.</span>
01597 <span class="comment">             */</span>
01598             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a> = iSelTemp;
01599 
01600             <span class="comment">/*</span>
01601 <span class="comment">             * Set the new anchor point</span>
01602 <span class="comment">             */</span>
01603             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a> = iSelFromPt;
01604             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o53">iLastMouseMove</a> = iSelFromPt;
01605             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o32">fNewItemState</a> = fSelected;
01606 
01607             <span class="keywordflow">break</span>;
01608         <span class="keywordflow">case</span> <a class="code" href="../../d9/d1/lboxctl2_8c.html#a2">SHIFTDOWN</a>:
01609 
01610             <span class="comment">/*</span>
01611 <span class="comment">             * This is so that we can handle click and drag for multisel</span>
01612 <span class="comment">             * listboxes using Shift modifier key .</span>
01613 <span class="comment">             */</span>
01614             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o53">iLastMouseMove</a> = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a> = iSelFromPt;
01615 
01616 
01617 
01618             <span class="comment">/*</span>
01619 <span class="comment">             * Check if an anchor point already exists</span>
01620 <span class="comment">             */</span>
01621             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a> == -1) {
01622                 plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a> = iSelFromPt;
01623 
01624                 <span class="comment">/*</span>
01625 <span class="comment">                 * Reset all the previous selections</span>
01626 <span class="comment">                 */</span>
01627                 <a class="code" href="../../d6/d0/usercli_8h.html#a733">xxxResetWorld</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a>, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01628 
01629                 <span class="comment">/*</span>
01630 <span class="comment">                 * Select the current position</span>
01631 <span class="comment">                 */</span>
01632                 <a class="code" href="../../d6/d0/usercli_8h.html#a694">SetSelected</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d0/usercli_8h.html#a250">HILITEANDSEL</a>);
01633                 <a class="code" href="../../d6/d0/usercli_8h.html#a717">xxxInvertLBItem</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01634                 <span class="comment">/*</span>
01635 <span class="comment">                 * We are changing the selction to this item only</span>
01636 <span class="comment">                 */</span>
01637                 uEvent = EVENT_OBJECT_SELECTION;
01638             } <span class="keywordflow">else</span> {
01639 
01640                 <span class="comment">/*</span>
01641 <span class="comment">                 * Reset all the previous selections</span>
01642 <span class="comment">                 */</span>
01643                 <a class="code" href="../../d6/d0/usercli_8h.html#a733">xxxResetWorld</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a>, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01644 
01645                 <span class="comment">/*</span>
01646 <span class="comment">                 * Select all items from anchor point upto current click pt</span>
01647 <span class="comment">                 */</span>
01648                 <a class="code" href="../../d6/d0/usercli_8h.html#a712">xxxAlterHilite</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a>, iSelFromPt, <a class="code" href="../../d6/d0/usercli_8h.html#a251">HILITE</a>, <a class="code" href="../../d6/d0/usercli_8h.html#a248">HILITEONLY</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01649                 uEvent = EVENT_OBJECT_SELECTIONWITHIN;
01650             }
01651             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o32">fNewItemState</a> = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01652             <span class="keywordflow">break</span>;
01653 
01654         <span class="keywordflow">case</span> <a class="code" href="../../d9/d1/lboxctl2_8c.html#a3">CTLDOWN</a>:
01655 
01656             <span class="comment">/*</span>
01657 <span class="comment">             * This is so that we can handle click and drag for multisel</span>
01658 <span class="comment">             * listboxes using Control modifier key.</span>
01659 <span class="comment">             */</span>
01660 
01661             <span class="comment">/*</span>
01662 <span class="comment">             * Reset the anchor point to the current point</span>
01663 <span class="comment">             */</span>
01664             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a> = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o53">iLastMouseMove</a> = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a> = iSelFromPt;
01665 
01666             <span class="comment">/*</span>
01667 <span class="comment">             * The state we will be setting items to</span>
01668 <span class="comment">             */</span>
01669             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o32">fNewItemState</a> = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)!<a class="code" href="../../d6/d0/usercli_8h.html#a687">IsSelected</a>(plb, iSelFromPt, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)<a class="code" href="../../d6/d0/usercli_8h.html#a248">HILITEONLY</a>);
01670 
01671             <span class="comment">/*</span>
01672 <span class="comment">             * Toggle the current point</span>
01673 <span class="comment">             */</span>
01674             <a class="code" href="../../d6/d0/usercli_8h.html#a694">SetSelected</a>(plb, iSelFromPt, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o32">fNewItemState</a>, <a class="code" href="../../d6/d0/usercli_8h.html#a250">HILITEANDSEL</a>);
01675             <a class="code" href="../../d6/d0/usercli_8h.html#a717">xxxInvertLBItem</a>(plb, iSelFromPt, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o32">fNewItemState</a>);
01676             uEvent = (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o32">fNewItemState</a> ? EVENT_OBJECT_SELECTIONADD :
01677                     EVENT_OBJECT_SELECTIONREMOVE);
01678             <span class="keywordflow">break</span>;
01679 
01680         <span class="keywordflow">case</span> <a class="code" href="../../d9/d1/lboxctl2_8c.html#a4">SHCTLDOWN</a>:
01681 
01682             <span class="comment">/*</span>
01683 <span class="comment">             * This is so that we can handle click and drag for multisel</span>
01684 <span class="comment">             * listboxes using Shift and Control modifier keys.</span>
01685 <span class="comment">             */</span>
01686 
01687             <span class="comment">/*</span>
01688 <span class="comment">             * Preserve all the previous selections</span>
01689 <span class="comment">             */</span>
01690 
01691             <span class="comment">/*</span>
01692 <span class="comment">             * Deselect only the selection connected with the last</span>
01693 <span class="comment">             * anchor point; If the last anchor point is associated with a</span>
01694 <span class="comment">             * de-selection, then do not do it</span>
01695 <span class="comment">             */</span>
01696             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o32">fNewItemState</a>) {
01697                 <a class="code" href="../../d6/d0/usercli_8h.html#a712">xxxAlterHilite</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a>, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o53">iLastMouseMove</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d0/usercli_8h.html#a250">HILITEANDSEL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01698             }
01699             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o53">iLastMouseMove</a> = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a> = iSelFromPt;
01700 
01701             <span class="comment">/*</span>
01702 <span class="comment">             * Check if an anchor point already exists</span>
01703 <span class="comment">             */</span>
01704             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a> == -1) {
01705 
01706                 <span class="comment">/*</span>
01707 <span class="comment">                 * No existing anchor point; Make the current pt as anchor</span>
01708 <span class="comment">                 */</span>
01709                 plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a> = iSelFromPt;
01710             }
01711 
01712             <span class="comment">/*</span>
01713 <span class="comment">             * If one exists preserve the most recent anchor point</span>
01714 <span class="comment">             */</span>
01715 
01716             <span class="comment">/*</span>
01717 <span class="comment">             * The state we will be setting items to</span>
01718 <span class="comment">             */</span>
01719             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o32">fNewItemState</a> = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)<a class="code" href="../../d6/d0/usercli_8h.html#a687">IsSelected</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a>, <a class="code" href="../../d6/d0/usercli_8h.html#a248">HILITEONLY</a>);
01720 
01721             <span class="comment">/*</span>
01722 <span class="comment">             * Select all items from anchor point upto current click pt</span>
01723 <span class="comment">             */</span>
01724             <a class="code" href="../../d6/d0/usercli_8h.html#a712">xxxAlterHilite</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a>, iSelFromPt, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o32">fNewItemState</a>, <a class="code" href="../../d6/d0/usercli_8h.html#a248">HILITEONLY</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01725             uEvent = EVENT_OBJECT_SELECTIONWITHIN;
01726             <span class="keywordflow">break</span>;
01727         }
01728 
01729         <span class="comment">/*</span>
01730 <span class="comment">         * Set the new base point (the outline frame caret).  We do the check</span>
01731 <span class="comment">         * first to avoid flashing the caret unnecessarly.</span>
01732 <span class="comment">         */</span>
01733         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a> != iSelFromPt) {
01734 
01735             <span class="comment">/*</span>
01736 <span class="comment">             * Since xxxSetISelBase always turns on the caret, we don't need to</span>
01737 <span class="comment">             * do it here...</span>
01738 <span class="comment">             */</span>
01739             <a class="code" href="../../d6/d0/usercli_8h.html#a693">xxxSetISelBase</a>(plb, iSelFromPt);
01740         }
01741 
01742         <span class="comment">/*</span>
01743 <span class="comment">         * SetISelBase will change the focus and send a focus event.</span>
01744 <span class="comment">         * Then we send the selection event.</span>
01745 <span class="comment">         */</span>
01746         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>() &amp;&amp; uEvent) {
01747             <a class="code" href="../../d6/d0/usercli_8h.html#a409">LBEvent</a>(plb, uEvent, iSelFromPt);
01748         }
01749         <span class="keywordflow">if</span> (wMsg == WM_LBUTTONDOWN &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a613">WEFDRAGOBJECT</a>)) {
01750             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a298">NtUserDragDetect</a>(hwnd, pt)) {
01751 
01752                 <span class="comment">/*</span>
01753 <span class="comment">                 * User is trying to drag object...</span>
01754 <span class="comment">                 */</span>
01755 
01756                 <span class="comment">/*</span>
01757 <span class="comment">                 *  Fake an up click so that the item is selected...</span>
01758 <span class="comment">                 */</span>
01759                 <a class="code" href="../../d6/d0/usercli_8h.html#a734">xxxTrackMouse</a>(plb, WM_LBUTTONUP, pt);
01760 
01761                 <span class="comment">/*</span>
01762 <span class="comment">                 * Notify parent</span>
01763 <span class="comment">                 * #ifndef WIN16 (32-bit Windows), plb-&gt;iSelBase gets</span>
01764 <span class="comment">                 * zero-extended to LONG wParam automatically by the compiler.</span>
01765 <span class="comment">                 */</span>
01766                 <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o0">spwndParent</a>, &amp;tlpwndParent);
01767                 <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o0">spwndParent</a>), WM_BEGINDRAG, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>,
01768                         (LPARAM)hwnd);
01769                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndParent);
01770             } <span class="keywordflow">else</span> {
01771                 <a class="code" href="../../d6/d0/usercli_8h.html#a734">xxxTrackMouse</a>(plb, WM_LBUTTONUP, pt);
01772             }
01773             <span class="keywordflow">return</span>;
01774         }
01775         <span class="keywordflow">break</span>;
01776 
01777     <span class="keywordflow">case</span> WM_MOUSEMOVE: {
01778         <span class="keywordtype">int</span> dist;
01779         <span class="keywordtype">int</span> iTimer;
01780 
01781         <span class="comment">/*</span>
01782 <span class="comment">         * Save for timer.</span>
01783 <span class="comment">         */</span>
01784         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o17">ptPrev</a> = pt;
01785         <span class="comment">/*</span>
01786 <span class="comment">         * Autoscroll listbox if mouse button is held down and mouse is</span>
01787 <span class="comment">         * moved outside of the listbox</span>
01788 <span class="comment">         */</span>
01789         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o24">fMouseDown</a>) {
01790             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o34">fMultiColumn</a>) {
01791                 <span class="keywordflow">if</span> ((pt.x &lt; 0) || (pt.x &gt;= rcClient.right - 1)) {
01792                     <span class="comment">/*</span>
01793 <span class="comment">                     * Reset timer interval based on distance from listbox.</span>
01794 <span class="comment">                     * use a longer default interval because each multicolumn</span>
01795 <span class="comment">                     * scrolling increment is larger</span>
01796 <span class="comment">                     */</span>
01797                     dist = pt.x &lt; 0 ? -pt.x : (pt.x - rcClient.right + 1);
01798                     iTimer = ((<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;dtScroll * 3) / 2) - ((WORD) dist &lt;&lt; 4);
01799 
01800                     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o47">fRightAlign</a>)
01801                         <a class="code" href="../../d6/d0/usercli_8h.html#a704">xxxLBoxCtlHScrollMultiColumn</a>(plb, (pt.x &lt; 0 ? SB_LINEDOWN : SB_LINEUP), 0);
01802                     <span class="keywordflow">else</span>
01803                         <a class="code" href="../../d6/d0/usercli_8h.html#a704">xxxLBoxCtlHScrollMultiColumn</a>(plb, (pt.x &lt; 0 ? SB_LINEUP : SB_LINEDOWN), 0);
01804 
01805                     <span class="keywordflow">goto</span> SetTimerAndSel;
01806                 }
01807             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pt.y &lt; 0) || (pt.y &gt;= rcClient.bottom - 1)) {
01808                 <span class="comment">/*</span>
01809 <span class="comment">                 * Reset timer interval based on distance from listbox.</span>
01810 <span class="comment">                 */</span>
01811                 dist = pt.y &lt; 0 ? -pt.y : (pt.y - rcClient.bottom + 1);
01812                 iTimer = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;dtScroll - ((WORD) dist &lt;&lt; 4);
01813 
01814                 <a class="code" href="../../d6/d0/usercli_8h.html#a705">xxxLBoxCtlScroll</a>(plb, (pt.y &lt; 0 ? SB_LINEUP : SB_LINEDOWN), 0);
01815 SetTimerAndSel:
01816                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a230">NtUserSetTimer</a>(hwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a56">IDSYS_SCROLL</a>, <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(iTimer, 1), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01817                 <a class="code" href="../../d6/d0/usercli_8h.html#a686">ISelFromPt</a>(plb, pt, &amp;iSelFromPt);
01818             }
01819         } <span class="keywordflow">else</span> {
01820             <span class="comment">/*</span>
01821 <span class="comment">             * Ignore if not in client since we don't autoscroll</span>
01822 <span class="comment">             */</span>
01823             <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(&amp;rcClient, pt))
01824                 <span class="keywordflow">break</span>;
01825         }
01826 
01827         <span class="keywordflow">switch</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a>) {
01828         <span class="keywordflow">case</span> <a class="code" href="../../d6/d0/usercli_8h.html#a114">SINGLESEL</a>:
01829 
01830             <span class="comment">/*</span>
01831 <span class="comment">             * If it is a single selection or plain multisel list box</span>
01832 <span class="comment">             */</span>
01833             <span class="keywordflow">goto</span> MouseMoveHandler;
01834             <span class="keywordflow">break</span>;
01835 
01836         <span class="keywordflow">case</span> <a class="code" href="../../d6/d0/usercli_8h.html#a115">MULTIPLESEL</a>:
01837         <span class="keywordflow">case</span> <a class="code" href="../../d6/d0/usercli_8h.html#a116">EXTENDEDSEL</a>:
01838 
01839             <span class="comment">/*</span>
01840 <span class="comment">             * Handle mouse movement with extended selection of items</span>
01841 <span class="comment">             */</span>
01842             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a> != iSelFromPt) {
01843                 <a class="code" href="../../d6/d0/usercli_8h.html#a693">xxxSetISelBase</a>(plb, iSelFromPt);
01844 
01845                 <span class="comment">/*</span>
01846 <span class="comment">                 * If this is an extended Multi sel list box, then</span>
01847 <span class="comment">                 * adjust the display of the range due to the mouse move</span>
01848 <span class="comment">                 */</span>
01849                 <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a116">EXTENDEDSEL</a>) {
01850                     <a class="code" href="../../d6/d0/usercli_8h.html#a718">xxxLBBlockHilite</a>(plb, iSelFromPt, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01851                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>())
01852                         <a class="code" href="../../d6/d0/usercli_8h.html#a409">LBEvent</a>(plb, EVENT_OBJECT_SELECTIONWITHIN, iSelFromPt);
01853                 }
01854                 plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o53">iLastMouseMove</a> = iSelFromPt;
01855             }
01856             <span class="keywordflow">break</span>;
01857         }
01858         <span class="keywordflow">break</span>;
01859     }
01860     <span class="keywordflow">case</span> WM_LBUTTONUP:
01861         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o24">fMouseDown</a>)
01862             <a class="code" href="../../d6/d0/usercli_8h.html#a740">xxxLBButtonUp</a>(plb, <a class="code" href="../../d6/d0/usercli_8h.html#a118">LBUP_RELEASECAPTURE</a> | <a class="code" href="../../d6/d0/usercli_8h.html#a120">LBUP_NOTIFY</a> |
01863                 (mousetemp ? <a class="code" href="../../d6/d0/usercli_8h.html#a119">LBUP_RESETSELECTION</a> : 0) |
01864                 (fMouseInRect ? <a class="code" href="../../d6/d0/usercli_8h.html#a121">LBUP_SUCCESS</a> : 0));
01865     }
01866 }
01867 
01868 <span class="comment">/***************************************************************************\</span>
01869 <span class="comment">*</span>
01870 <span class="comment">*  LBButtonUp()</span>
01871 <span class="comment">*</span>
01872 <span class="comment">*  Called in response to both WM_CAPTURECHANGED and WM_LBUTTONUP.</span>
01873 <span class="comment">*</span>
01874 <span class="comment">\***************************************************************************/</span>
<a name="l01875"></a><a class="code" href="../../d6/d0/usercli_8h.html#a740">01875</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a740">xxxLBButtonUp</a>(<a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb, UINT uFlags)
01876 {
01877 
01878     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
01879 
01880     <span class="comment">/*</span>
01881 <span class="comment">     * If the list box is an Extended listbox, then change the select status</span>
01882 <span class="comment">     * of all items between the anchor and the last mouse position to the</span>
01883 <span class="comment">     * newItemState</span>
01884 <span class="comment">     */</span>
01885     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a116">EXTENDEDSEL</a>)
01886         <a class="code" href="../../d6/d0/usercli_8h.html#a712">xxxAlterHilite</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a>, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o53">iLastMouseMove</a>,
01887             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o32">fNewItemState</a>, <a class="code" href="../../d6/d0/usercli_8h.html#a249">SELONLY</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01888 
01889     <span class="comment">/*</span>
01890 <span class="comment">     * This is a combo box and user upclicked outside the listbox</span>
01891 <span class="comment">     * so we want to restore the original selection.</span>
01892 <span class="comment">     */</span>
01893     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o58">pcbox</a> &amp;&amp; (uFlags &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a119">LBUP_RESETSELECTION</a>)) {
01894         <span class="keywordtype">int</span> iSelOld;
01895 
01896         iSelOld = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a>;
01897 
01898         <span class="keywordflow">if</span> (iSelOld &gt;= 0)
01899             <a class="code" href="../../d6/d0/usercli_8h.html#a717">xxxInvertLBItem</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01900 
01901         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a> = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o51">iLastSelection</a>;
01902         <a class="code" href="../../d6/d0/usercli_8h.html#a717">xxxInvertLBItem</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01903 
01904         <span class="comment">/*</span>
01905 <span class="comment">         * Note that we always send selection events before we tell the</span>
01906 <span class="comment">         * app.  This is on purpose--the app may turn around and select</span>
01907 <span class="comment">         * something else when notified.  In which case our event would</span>
01908 <span class="comment">         * be out of order.</span>
01909 <span class="comment">         */</span>
01910         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>())
01911             <a class="code" href="../../d6/d0/usercli_8h.html#a409">LBEvent</a>(plb, EVENT_OBJECT_SELECTION, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a>);
01912 
01913         <span class="comment">/*</span>
01914 <span class="comment">         * On win-95 and NT4 the check used to be !(uFlags &amp; LBUP_NOTIFY) which</span>
01915 <span class="comment">         * is a bug because we would notify even when the lb is not LBUP_NOTIFY</span>
01916 <span class="comment">         */</span>
01917         <span class="keywordflow">if</span> ((uFlags &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a120">LBUP_NOTIFY</a>) &amp;&amp; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o23">fNotify</a> &amp;&amp; (iSelOld != plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a>))
01918             <a class="code" href="../../d6/d0/usercli_8h.html#a732">xxxNotifyOwner</a>(plb, LBN_SELCHANGE);
01919     }
01920 
01921     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a208">NtUserKillTimer</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a56">IDSYS_SCROLL</a>);
01922     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o24">fMouseDown</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01923     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o25">fCaptured</a>) {
01924         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o25">fCaptured</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01925         <span class="keywordflow">if</span> (uFlags &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a118">LBUP_RELEASECAPTURE</a>)
01926             <a class="code" href="../../d6/d0/usercli_8h.html#a225">NtUserReleaseCapture</a>();
01927     }
01928     <span class="comment">/*</span>
01929 <span class="comment">     * Don't scroll item as long as any part of it is visible</span>
01930 <span class="comment">     */</span>
01931     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a> &lt; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a> ||
01932         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a> &gt; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a> + <a class="code" href="../../d6/d0/usercli_8h.html#a713">CItemInWindow</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
01933         <a class="code" href="../../d6/d0/usercli_8h.html#a716">xxxInsureVisible</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01934 
01935     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o23">fNotify</a>) {
01936         <span class="keywordflow">if</span> (uFlags &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a120">LBUP_NOTIFY</a>)  {
01937             <span class="keywordflow">if</span> (uFlags &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a121">LBUP_SUCCESS</a>) {
01938                 <span class="comment">/*</span>
01939 <span class="comment">                 * ArtMaster needs this SELCHANGE notification now!</span>
01940 <span class="comment">                 */</span>
01941                 <span class="keywordflow">if</span> ((plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o27">fDoubleClick</a>) &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a592">WFWIN31COMPAT</a>))
01942                     <a class="code" href="../../d6/d0/usercli_8h.html#a732">xxxNotifyOwner</a>(plb, LBN_SELCHANGE);
01943 
01944                 <span class="comment">/*</span>
01945 <span class="comment">                 * Notify owner of click or double click on selection</span>
01946 <span class="comment">                 */</span>
01947                 <a class="code" href="../../d6/d0/usercli_8h.html#a732">xxxNotifyOwner</a>(plb, (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o27">fDoubleClick</a>) ? LBN_DBLCLK : LBN_SELCHANGE);
01948             } <span class="keywordflow">else</span> {
01949                 <span class="comment">/*</span>
01950 <span class="comment">                 * Notify owner that the attempted selection was cancelled.</span>
01951 <span class="comment">                 */</span>
01952                 <a class="code" href="../../d6/d0/usercli_8h.html#a732">xxxNotifyOwner</a>(plb, LBN_SELCANCEL);
01953             }
01954         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (uFlags &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a122">LBUP_SELCHANGE</a>) {
01955             <span class="comment">/*</span>
01956 <span class="comment">             * Did we do some semi-selecting with mouse moves, then hit Enter?</span>
01957 <span class="comment">             * If so, we need to make sure the app knows that something was</span>
01958 <span class="comment">             * really truly selected.</span>
01959 <span class="comment">             */</span>
01960             UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>));
01961             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o51">iLastSelection</a> != plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a>)
01962                 <a class="code" href="../../d6/d0/usercli_8h.html#a732">xxxNotifyOwner</a>(plb, LBN_SELCHANGE);
01963 
01964         }
01965     }
01966 
01967 }
01968 
01969 
01970 <span class="comment">/***************************************************************************\</span>
01971 <span class="comment">* IncrementISel</span>
01972 <span class="comment">*</span>
01973 <span class="comment">* History:</span>
01974 <span class="comment">\***************************************************************************/</span>
01975 
<a name="l01976"></a><a class="code" href="../../d9/d1/lboxctl2_8c.html#a32">01976</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> <a class="code" href="../../d9/d1/lboxctl2_8c.html#a32">IncrementISel</a>(
01977     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
01978     INT iSel,
01979     INT sInc)
01980 {
01981 
01982     <span class="comment">/*</span>
01983 <span class="comment">     * Assumes cMac &gt; 0, return iSel+sInc in range [0..cmac).</span>
01984 <span class="comment">     */</span>
01985     iSel += sInc;
01986     <span class="keywordflow">if</span> (iSel &lt; 0) {
01987         <span class="keywordflow">return</span> 0;
01988     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iSel &gt;= plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>) {
01989         <span class="keywordflow">return</span> plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> - 1;
01990     }
01991     <span class="keywordflow">return</span> iSel;
01992 }
01993 
01994 
01995 <span class="comment">/***************************************************************************\</span>
01996 <span class="comment">* NewITop</span>
01997 <span class="comment">*</span>
01998 <span class="comment">\***************************************************************************/</span>
01999 
<a name="l02000"></a><a class="code" href="../../d6/d0/usercli_8h.html#a730">02000</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a730">xxxNewITop</a>(<a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb, INT iTopNew)
02001 {
02002     <a class="code" href="../../d6/d0/usercli_8h.html#a731">xxxNewITopEx</a>(plb, iTopNew, 0);
02003 }
02004 
02005 
02006 <span class="comment">/***************************************************************************\</span>
02007 <span class="comment">* xxxNewITopEx</span>
02008 <span class="comment">*</span>
02009 <span class="comment">* History:</span>
02010 <span class="comment">\***************************************************************************/</span>
02011 
<a name="l02012"></a><a class="code" href="../../d6/d0/usercli_8h.html#a731">02012</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a731">xxxNewITopEx</a>(
02013     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
02014     INT iTopNew,
02015     DWORD dwTime)
02016 {
02017     <span class="keywordtype">int</span>     iTopOld;
02018     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fCaretOn;
02019     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fMulti = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o34">fMultiColumn</a>;
02020 
02021     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
02022 
02023     <span class="comment">// Always try to turn off caret whether or not redraw is on</span>
02024     <span class="keywordflow">if</span> (fCaretOn = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o28">fCaretOn</a>)
02025         <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02026 
02027     iTopOld = (fMulti) ? (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a> / plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o15">itemsPerColumn</a>) : plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a>;
02028     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a> = iTopNew;
02029     iTopNew = <a class="code" href="../../d6/d0/usercli_8h.html#a739">xxxSetLBScrollParms</a>(plb, (fMulti) ? SB_HORZ : SB_VERT);
02030     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a> = (fMulti) ? (iTopNew * plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o15">itemsPerColumn</a>) : iTopNew;
02031 
02032     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a108">IsLBoxVisible</a>(plb)) {
02033         <span class="keywordflow">return</span>;
02034     }
02035 
02036     <span class="keywordflow">if</span> (iTopNew != iTopOld) {
02037         <span class="keywordtype">int</span>     xAmt, yAmt;
02038         RECT    rc;
02039         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;
02040 
02041         <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a19">_GetClientRect</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>, &amp;rc);
02042 
02043         <span class="keywordflow">if</span> (fMulti) {
02044             yAmt = 0;
02045             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a259">abs</a>(iTopNew - iTopOld) &gt; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o16">numberOfColumns</a>)
02046                 <span class="comment">// Handle scrolling a large number of columns properly so that</span>
02047                 <span class="comment">// we don't overflow the size of a rect.</span>
02048                 xAmt = 32000;
02049             <span class="keywordflow">else</span> {
02050                 xAmt = (iTopOld - iTopNew) * plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o14">cxColumn</a>;
02051                 <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o47">fRightAlign</a>)
02052                     xAmt = -xAmt;
02053             }
02054         } <span class="keywordflow">else</span> {
02055             xAmt = 0;
02056             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a63">OWNERDRAWVAR</a>) {
02057                 <span class="comment">//</span>
02058                 <span class="comment">// Have to fake iTopOld for OWNERDRAWVAR listboxes so that</span>
02059                 <span class="comment">// the scrolling amount calculations work properly.</span>
02060                 <span class="comment">//</span>
02061                 plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a> = iTopOld;
02062                 yAmt = <a class="code" href="../../d6/d0/usercli_8h.html#a702">LBCalcVarITopScrollAmt</a>(plb, iTopOld, iTopNew);
02063                 plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a> = iTopNew;
02064             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a259">abs</a>(iTopNew - iTopOld) &gt; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o5">cItemFullMax</a>)
02065                 yAmt = 32000;
02066             <span class="keywordflow">else</span>
02067                 yAmt = (iTopOld - iTopNew) * plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o13">cyChar</a>;
02068         }
02069 
02070         <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> = <a class="code" href="../../d9/d1/lboxctl2_8c.html#a20">LBGetScrollFlags</a>(plb, dwTime);
02071         <a class="code" href="../../d3/d8/winmgrc_8c.html#a38">ScrollWindowEx</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>), xAmt, yAmt, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;rc, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02072                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
02073         <a class="code" href="../../d3/d8/client_8c.html#a140">UpdateWindow</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>));
02074     }
02075 
02076     <span class="comment">// Note that although we turn off the caret regardless of redraw, we</span>
02077     <span class="comment">// only turn it on if redraw is true. Slimy thing to fixup many</span>
02078     <span class="comment">// caret related bugs...</span>
02079     <span class="keywordflow">if</span> (fCaretOn)
02080         <span class="comment">// Turn the caret back on only if we turned it off. This avoids</span>
02081         <span class="comment">// annoying caret flicker.</span>
02082         <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02083 }
02084 
02085 
02086 <span class="comment">/***************************************************************************\</span>
02087 <span class="comment">* xxxInsureVisible</span>
02088 <span class="comment">*</span>
02089 <span class="comment">* History:</span>
02090 <span class="comment">\***************************************************************************/</span>
02091 
<a name="l02092"></a><a class="code" href="../../d6/d0/usercli_8h.html#a716">02092</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a716">xxxInsureVisible</a>(
02093     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
02094     INT iSel,
02095     BOOL fPartial)  <span class="comment">/* It is ok for the item to be partially visible */</span>
02096 {
02097     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> sLastVisibleItem;
02098 
02099     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
02100 
02101     <span class="keywordflow">if</span> (iSel &lt; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a>) {
02102         <a class="code" href="../../d6/d0/usercli_8h.html#a730">xxxNewITop</a>(plb, iSel);
02103     } <span class="keywordflow">else</span> {
02104         <span class="keywordflow">if</span> (fPartial) {
02105 
02106             <span class="comment">/*</span>
02107 <span class="comment">             * 1 must be subtracted to get the last visible item</span>
02108 <span class="comment">             * A part of the fix for Bug #3727 -- 01/14/91 -- SANKAR</span>
02109 <span class="comment">             */</span>
02110             sLastVisibleItem = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a> + <a class="code" href="../../d6/d0/usercli_8h.html#a713">CItemInWindow</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) - (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)1;
02111         } <span class="keywordflow">else</span> {
02112             sLastVisibleItem = <a class="code" href="../../d6/d0/usercli_8h.html#a727">LastFullVisible</a>(plb);
02113         }
02114 
02115         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a> != <a class="code" href="../../d6/d0/usercli_8h.html#a63">OWNERDRAWVAR</a>) {
02116             <span class="keywordflow">if</span> (iSel &gt; sLastVisibleItem) {
02117                 <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o34">fMultiColumn</a>) {
02118                     <a class="code" href="../../d6/d0/usercli_8h.html#a730">xxxNewITop</a>(plb,
02119                         ((iSel / plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o15">itemsPerColumn</a>) -
02120                         <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o16">numberOfColumns</a>-1,0)) * plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o15">itemsPerColumn</a>);
02121                 } <span class="keywordflow">else</span> {
02122                     <a class="code" href="../../d6/d0/usercli_8h.html#a730">xxxNewITop</a>(plb, (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)<a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(0, iSel - sLastVisibleItem + plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a>));
02123                 }
02124             }
02125         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iSel &gt; sLastVisibleItem)
02126             <a class="code" href="../../d6/d0/usercli_8h.html#a730">xxxNewITop</a>(plb, <a class="code" href="../../d6/d0/usercli_8h.html#a742">LBPage</a>(plb, iSel, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>));
02127     }
02128 }
02129 
02130 <span class="comment">/***************************************************************************\</span>
02131 <span class="comment">* xxxLBoxCaretBlinker</span>
02132 <span class="comment">*</span>
02133 <span class="comment">* Timer callback function toggles Caret</span>
02134 <span class="comment">* Since it is a callback, it is APIENTRY</span>
02135 <span class="comment">*</span>
02136 <span class="comment">* History:</span>
02137 <span class="comment">\***************************************************************************/</span>
02138 
<a name="l02139"></a><a class="code" href="../../d9/d1/lboxctl2_8c.html#a36">02139</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d1/lboxctl2_8c.html#a36">xxxLBoxCaretBlinker</a>(
02140     HWND hwnd,
02141     UINT wMsg,
02142     UINT_PTR nIDEvent,
02143     DWORD dwTime)
02144 {
02145     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
02146     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb;
02147 
02148     <span class="comment">/*</span>
02149 <span class="comment">     * Standard parameters for a timer callback function that aren't used.</span>
02150 <span class="comment">     * Mentioned here to avoid compiler warnings</span>
02151 <span class="comment">     */</span>
02152     UNREFERENCED_PARAMETER(wMsg);
02153     UNREFERENCED_PARAMETER(nIDEvent);
02154     UNREFERENCED_PARAMETER(dwTime);
02155 
02156     pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd);
02157     plb = ((<a class="code" href="../../d9/d9/structtagLBWND.html">PLBWND</a>)pwnd)-&gt;pLBIV;
02158 
02159     <span class="comment">/*</span>
02160 <span class="comment">     * leave caret on, don't blink it off (prevents rapid blinks?)</span>
02161 <span class="comment">     */</span>
02162     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a30">ISREMOTESESSION</a>() &amp;&amp; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o28">fCaretOn</a>) {
02163         <span class="keywordflow">return</span>;
02164     }
02165 
02166     <span class="comment">/*</span>
02167 <span class="comment">     * Check if the Caret is ON, if so, switch it OFF</span>
02168 <span class="comment">     */</span>
02169     <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, !plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o28">fCaretOn</a>);
02170     <span class="keywordflow">return</span>;
02171 }
02172 
02173 
02174 <span class="comment">/***************************************************************************\</span>
02175 <span class="comment">* xxxLBoxCtlKeyInput</span>
02176 <span class="comment">*</span>
02177 <span class="comment">* If msg == LB_KEYDOWN, vKey is the number of the item to go to,</span>
02178 <span class="comment">* otherwise it is the virtual key.</span>
02179 <span class="comment">*</span>
02180 <span class="comment">* History:</span>
02181 <span class="comment">\***************************************************************************/</span>
02182 
<a name="l02183"></a><a class="code" href="../../d6/d0/usercli_8h.html#a709">02183</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a709">xxxLBoxCtlKeyInput</a>(
02184     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
02185     UINT msg,
02186     UINT vKey)
02187 {
02188     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> i;
02189     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> iNewISel;
02190     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> cItemPageScroll;
02191     <a class="code" href="../../d7/d9/structtagCBox.html">PCBOX</a> pcbox;
02192     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fDropDownComboBox;
02193     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fExtendedUIComboBoxClosed;
02194     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> hScrollBar = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a640">WFHSCROLL</a>);
02195     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> wModifiers = 0;
02196     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSelectKey = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;  <span class="comment">/* assume it is a navigation key */</span>
02197     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uEvent = 0;
02198     HWND hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
02199     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndParent;
02200     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
02201 
02202     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
02203 
02204     pcbox = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o58">pcbox</a>;
02205 
02206     <span class="comment">/*</span>
02207 <span class="comment">     * Is this a dropdown style combo box/listbox ?</span>
02208 <span class="comment">     */</span>
02209     fDropDownComboBox = pcbox &amp;&amp; (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o10">CBoxStyle</a> &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a57">SDROPPABLE</a>);
02210 
02211     <span class="comment">/*</span>
02212 <span class="comment">     *Is this an extended ui combo box which is closed?</span>
02213 <span class="comment">     */</span>
02214     fExtendedUIComboBoxClosed = fDropDownComboBox &amp;&amp; pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o18">fExtendedUI</a> &amp;&amp;
02215                               !pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o15">fLBoxVisible</a>;
02216 
02217     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o24">fMouseDown</a> || (!plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> &amp;&amp; vKey != VK_F4)) {
02218 
02219         <span class="comment">/*</span>
02220 <span class="comment">         * Ignore keyboard input if we are in the middle of a mouse down deal or</span>
02221 <span class="comment">         * if there are no items in the listbox. Note that we let F4's go</span>
02222 <span class="comment">         * through for combo boxes so that the use can pop up and down empty</span>
02223 <span class="comment">         * combo boxes.</span>
02224 <span class="comment">         */</span>
02225         <span class="keywordflow">return</span>;
02226     }
02227 
02228     <span class="comment">/*</span>
02229 <span class="comment">     * Modifiers are considered only in EXTENDED sel list boxes.</span>
02230 <span class="comment">     */</span>
02231     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a116">EXTENDEDSEL</a>) {
02232 
02233         <span class="comment">/*</span>
02234 <span class="comment">         * If multiselection listbox, are any modifiers used ?</span>
02235 <span class="comment">         */</span>
02236         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(VK_SHIFT) &lt; 0)
02237             wModifiers = <a class="code" href="../../d9/d1/lboxctl2_8c.html#a2">SHIFTDOWN</a>;
02238         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(VK_CONTROL) &lt; 0)
02239             wModifiers += <a class="code" href="../../d9/d1/lboxctl2_8c.html#a3">CTLDOWN</a>;
02240 
02241         <span class="comment">/*</span>
02242 <span class="comment">         * Please Note that (SHIFTDOWN + CTLDOWN) == (SHCTLDOWN)</span>
02243 <span class="comment">         */</span>
02244     }
02245 
02246     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> == <a class="code" href="../../d9/d1/lboxctl2_8c.html#a0">LB_KEYDOWN</a>) {
02247 
02248         <span class="comment">/*</span>
02249 <span class="comment">         * This is a listbox "go to specified item" message which means we want</span>
02250 <span class="comment">         * to go to a particular item number (given by vKey) directly.  ie.  the</span>
02251 <span class="comment">         * user has typed a character and we want to go to the item which</span>
02252 <span class="comment">         * starts with that character.</span>
02253 <span class="comment">         */</span>
02254         iNewISel = (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)vKey;
02255         <span class="keywordflow">goto</span> TrackKeyDown;
02256     }
02257 
02258     cItemPageScroll = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o5">cItemFullMax</a>;
02259 
02260     <span class="keywordflow">if</span> (cItemPageScroll &gt; 1)
02261         cItemPageScroll--;
02262 
02263     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o36">fWantKeyboardInput</a>) {
02264 
02265         <span class="comment">/*</span>
02266 <span class="comment">         * Note: msg must not be LB_KEYDOWN here or we'll be in trouble...</span>
02267 <span class="comment">         */</span>
02268         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o0">spwndParent</a>, &amp;tlpwndParent);
02269         iNewISel = (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)<a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o0">spwndParent</a>), WM_VKEYTOITEM,
02270                 MAKELONG(vKey, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>), (LPARAM)hwnd);
02271         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndParent);
02272 
02273         <span class="keywordflow">if</span> (iNewISel == -2) {
02274 
02275             <span class="comment">/*</span>
02276 <span class="comment">             * Don't move the selection...</span>
02277 <span class="comment">             */</span>
02278             <span class="keywordflow">return</span>;
02279         }
02280         <span class="keywordflow">if</span> (iNewISel != -1) {
02281 
02282             <span class="comment">/*</span>
02283 <span class="comment">             * Jump directly to the item provided by the app</span>
02284 <span class="comment">             */</span>
02285             <span class="keywordflow">goto</span> TrackKeyDown;
02286         }
02287 
02288         <span class="comment">/*</span>
02289 <span class="comment">         * else do default processing of the character.</span>
02290 <span class="comment">         */</span>
02291     }
02292 
02293     <span class="keywordflow">switch</span> (vKey) {
02294     <span class="comment">// LATER IanJa: not language independent!!!</span>
02295     <span class="comment">// We could use VkKeyScan() to find out which is the '\' key</span>
02296     <span class="comment">// This is VK_OEM_5 '\|' for US English only.</span>
02297     <span class="comment">// Germans, Italians etc. have to type CTRL+^ (etc) for this.</span>
02298     <span class="comment">// This is documented as File Manager behaviour for 3.0, but apparently</span>
02299     <span class="comment">// not for 3.1., although functionality remains. We should still fix it,</span>
02300     <span class="comment">// although German (etc?) '\' is generated with AltGr (Ctrl-Alt) (???)</span>
02301     <span class="keywordflow">case</span> <a class="code" href="../../d6/d0/usercli_8h.html#a253">VERKEY_BACKSLASH</a>:  <span class="comment">/* '\' character for US English */</span>
02302 
02303         <span class="comment">/*</span>
02304 <span class="comment">         * Check if this is CONTROL-\ ; If so Deselect all items</span>
02305 <span class="comment">         */</span>
02306         <span class="keywordflow">if</span> ((wModifiers &amp; <a class="code" href="../../d9/d1/lboxctl2_8c.html#a3">CTLDOWN</a>) &amp;&amp; (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a> != <a class="code" href="../../d6/d0/usercli_8h.html#a114">SINGLESEL</a>)) {
02307             <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02308             <a class="code" href="../../d6/d0/usercli_8h.html#a733">xxxResetWorld</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02309 
02310             <span class="comment">/*</span>
02311 <span class="comment">             * And select the current item</span>
02312 <span class="comment">             */</span>
02313             <a class="code" href="../../d6/d0/usercli_8h.html#a694">SetSelected</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d0/usercli_8h.html#a250">HILITEANDSEL</a>);
02314             <a class="code" href="../../d6/d0/usercli_8h.html#a717">xxxInvertLBItem</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02315             uEvent = EVENT_OBJECT_SELECTION;
02316             <span class="keywordflow">goto</span> CaretOnAndNotify;
02317         }
02318         <span class="keywordflow">return</span>;
02319         <span class="keywordflow">break</span>;
02320 
02321     <span class="keywordflow">case</span> VK_DIVIDE:     <span class="comment">/* NumPad '/' character on enhanced keyboard */</span>
02322     <span class="comment">// LATER IanJa: not language independent!!!</span>
02323     <span class="comment">// We could use VkKeyScan() to find out which is the '/' key</span>
02324     <span class="comment">// This is VK_OEM_2 '/?' for US English only.</span>
02325     <span class="comment">// Germans, Italians etc. have to type CTRL+# (etc) for this.</span>
02326     <span class="keywordflow">case</span> <a class="code" href="../../d6/d0/usercli_8h.html#a252">VERKEY_SLASH</a>:  <span class="comment">/* '/' character */</span>
02327 
02328         <span class="comment">/*</span>
02329 <span class="comment">         * Check if this is CONTROL-/ ; If so select all items</span>
02330 <span class="comment">         */</span>
02331         <span class="keywordflow">if</span> ((wModifiers &amp; <a class="code" href="../../d9/d1/lboxctl2_8c.html#a3">CTLDOWN</a>) &amp;&amp; (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a> != <a class="code" href="../../d6/d0/usercli_8h.html#a114">SINGLESEL</a>)) {
02332             <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02333             <a class="code" href="../../d6/d0/usercli_8h.html#a733">xxxResetWorld</a>(plb, -1, -1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02334 
02335             uEvent = EVENT_OBJECT_SELECTIONWITHIN;
02336 
02337 CaretOnAndNotify:
02338             <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02339             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
02340                 <a class="code" href="../../d6/d0/usercli_8h.html#a409">LBEvent</a>(plb, uEvent, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>);
02341             }
02342             <a class="code" href="../../d6/d0/usercli_8h.html#a732">xxxNotifyOwner</a>(plb, LBN_SELCHANGE);
02343         }
02344         <span class="keywordflow">return</span>;
02345         <span class="keywordflow">break</span>;
02346 
02347     <span class="keywordflow">case</span> VK_F8:
02348 
02349         <span class="comment">/*</span>
02350 <span class="comment">         * The "Add" mode is possible only in Multiselection listboxes...  Get</span>
02351 <span class="comment">         * into it via SHIFT-F8...  (Yes, sometimes these UI people are sillier</span>
02352 <span class="comment">         * than your "typical dumb user"...)</span>
02353 <span class="comment">         */</span>
02354         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a> != <a class="code" href="../../d6/d0/usercli_8h.html#a114">SINGLESEL</a> &amp;&amp; wModifiers == <a class="code" href="../../d9/d1/lboxctl2_8c.html#a2">SHIFTDOWN</a>) {
02355 
02356             <span class="comment">/*</span>
02357 <span class="comment">             * We have to make the caret blink! Do something...</span>
02358 <span class="comment">             */</span>
02359             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o29">fAddSelMode</a>) {
02360 
02361                 <span class="comment">/*</span>
02362 <span class="comment">                 * Switch off the Caret blinking</span>
02363 <span class="comment">                 */</span>
02364                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a208">NtUserKillTimer</a>(hwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a58">IDSYS_CARET</a>);
02365 
02366                 <span class="comment">/*</span>
02367 <span class="comment">                 * Make sure the caret does not vanish</span>
02368 <span class="comment">                 */</span>
02369                 <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02370             } <span class="keywordflow">else</span> {
02371 
02372                 <span class="comment">/*</span>
02373 <span class="comment">                 * Create a timer to make the caret blink</span>
02374 <span class="comment">                 */</span>
02375                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a230">NtUserSetTimer</a>(hwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a58">IDSYS_CARET</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;dtCaretBlink,
02376                         <a class="code" href="../../d9/d1/lboxctl2_8c.html#a36">xxxLBoxCaretBlinker</a>);
02377             }
02378 
02379             <span class="comment">/*</span>
02380 <span class="comment">             * Toggle the Add mode flag</span>
02381 <span class="comment">             */</span>
02382             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o29">fAddSelMode</a> = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)!plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o29">fAddSelMode</a>;
02383         }
02384         <span class="keywordflow">return</span>;
02385     <span class="keywordflow">case</span> VK_SPACE:  <span class="comment">/* Selection key is space */</span>
02386         i = 0;
02387         fSelectKey = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02388         <span class="keywordflow">break</span>;
02389 
02390     <span class="keywordflow">case</span> VK_PRIOR:
02391         <span class="keywordflow">if</span> (fExtendedUIComboBoxClosed) {
02392 
02393             <span class="comment">/*</span>
02394 <span class="comment">             * Disable movement keys for TandyT.</span>
02395 <span class="comment">             */</span>
02396             <span class="keywordflow">return</span>;
02397         }
02398 
02399         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a63">OWNERDRAWVAR</a>) {
02400             i = <a class="code" href="../../d6/d0/usercli_8h.html#a742">LBPage</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) - plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>;
02401         } <span class="keywordflow">else</span> {
02402             i = -cItemPageScroll;
02403         }
02404         <span class="keywordflow">break</span>;
02405 
02406     <span class="keywordflow">case</span> VK_NEXT:
02407         <span class="keywordflow">if</span> (fExtendedUIComboBoxClosed) {
02408 
02409             <span class="comment">/*</span>
02410 <span class="comment">             * Disable movement keys for TandyT.</span>
02411 <span class="comment">             */</span>
02412             <span class="keywordflow">return</span>;
02413         }
02414 
02415         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a63">OWNERDRAWVAR</a>) {
02416             i = <a class="code" href="../../d6/d0/usercli_8h.html#a742">LBPage</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) - plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>;
02417         } <span class="keywordflow">else</span> {
02418             i = cItemPageScroll;
02419         }
02420         <span class="keywordflow">break</span>;
02421 
02422     <span class="keywordflow">case</span> VK_HOME:
02423         <span class="keywordflow">if</span> (fExtendedUIComboBoxClosed) {
02424 
02425             <span class="comment">/*</span>
02426 <span class="comment">             * Disable movement keys for TandyT.</span>
02427 <span class="comment">             */</span>
02428             <span class="keywordflow">return</span>;
02429         }
02430 
02431         i = (INT_MIN/2)+1;  <span class="comment">/* A very big negative number */</span>
02432         <span class="keywordflow">break</span>;
02433 
02434     <span class="keywordflow">case</span> VK_END:
02435         <span class="keywordflow">if</span> (fExtendedUIComboBoxClosed) {
02436 
02437             <span class="comment">/*</span>
02438 <span class="comment">             * Disable movement keys for TandyT.</span>
02439 <span class="comment">             */</span>
02440             <span class="keywordflow">return</span>;
02441         }
02442 
02443         i = (INT_MAX/2)-1;  <span class="comment">/* A very big positive number */</span>
02444         <span class="keywordflow">break</span>;
02445 
02446     <span class="keywordflow">case</span> VK_LEFT:
02447         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o34">fMultiColumn</a>) {
02448             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o47">fRightAlign</a>
02449 <span class="preprocessor">#ifdef USE_MIRRORING</span>
02450 <span class="preprocessor"></span>                                 ^ (!!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>, WEFLAYOUTRTL))
02451 
02452 <span class="preprocessor">#endif</span>
02453 <span class="preprocessor"></span>               )
02454                 <span class="keywordflow">goto</span> ReallyRight;
02455 ReallyLeft:
02456             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a> / plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o15">itemsPerColumn</a> == 0) {
02457                 i = 0;
02458             } <span class="keywordflow">else</span> {
02459                 i = -plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o15">itemsPerColumn</a>;
02460             }
02461             <span class="keywordflow">break</span>;
02462         }
02463 
02464         <span class="keywordflow">if</span> (hScrollBar) {
02465             <span class="keywordflow">goto</span> HandleHScrolling;
02466         } <span class="keywordflow">else</span> {
02467 
02468             <span class="comment">/*</span>
02469 <span class="comment">             * Fall through and handle this as if the up arrow was pressed.</span>
02470 <span class="comment">             */</span>
02471 
02472             vKey = VK_UP;
02473         }
02474 
02475         <span class="comment">/*</span>
02476 <span class="comment">         * Fall through</span>
02477 <span class="comment">         */</span>
02478 
02479     <span class="keywordflow">case</span> VK_UP:
02480         <span class="keywordflow">if</span> (fExtendedUIComboBoxClosed)
02481             <span class="comment">// Disable movement keys for TandyT.</span>
02482             <span class="keywordflow">return</span>;
02483 
02484         i = -1;
02485         <span class="keywordflow">break</span>;
02486 
02487     <span class="keywordflow">case</span> VK_RIGHT:
02488         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o34">fMultiColumn</a>) {
02489             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o47">fRightAlign</a>
02490 <span class="preprocessor">#ifdef USE_MIRRORING</span>
02491 <span class="preprocessor"></span>                                 ^ (!!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>, WEFLAYOUTRTL))
02492 
02493 <span class="preprocessor">#endif</span>
02494 <span class="preprocessor"></span>               )
02495                 <span class="keywordflow">goto</span> ReallyLeft;
02496 ReallyRight:
02497             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a> / plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o15">itemsPerColumn</a> == plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> / plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o15">itemsPerColumn</a>) {
02498                 i = 0;
02499             } <span class="keywordflow">else</span> {
02500                 i = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o15">itemsPerColumn</a>;
02501             }
02502             <span class="keywordflow">break</span>;
02503         }
02504         <span class="keywordflow">if</span> (hScrollBar) {
02505 HandleHScrolling:
02506             <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(hwnd, WM_HSCROLL,
02507                     (vKey == VK_RIGHT ? SB_LINEDOWN : SB_LINEUP), 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
02508             <span class="keywordflow">return</span>;
02509         } <span class="keywordflow">else</span> {
02510 
02511             <span class="comment">/*</span>
02512 <span class="comment">             * Fall through and handle this as if the down arrow was</span>
02513 <span class="comment">             * pressed.</span>
02514 <span class="comment">             */</span>
02515             vKey = VK_DOWN;
02516         }
02517 
02518         <span class="comment">/*</span>
02519 <span class="comment">         * Fall through</span>
02520 <span class="comment">         */</span>
02521 
02522     <span class="keywordflow">case</span> VK_DOWN:
02523         <span class="keywordflow">if</span> (fExtendedUIComboBoxClosed) {
02524 
02525             <span class="comment">/*</span>
02526 <span class="comment">             * If the combo box is closed, down arrow should open it.</span>
02527 <span class="comment">             */</span>
02528             <span class="keywordflow">if</span> (!pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o15">fLBoxVisible</a>) {
02529 
02530                 <span class="comment">/*</span>
02531 <span class="comment">                 * If the listbox isn't visible, just show it</span>
02532 <span class="comment">                 */</span>
02533                 <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>, &amp;tlpwnd);
02534                 <a class="code" href="../../d6/d0/usercli_8h.html#a668">xxxCBShowListBoxWindow</a>(pcbox, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02535                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
02536             }
02537             <span class="keywordflow">return</span>;
02538         }
02539         i = 1;
02540         <span class="keywordflow">break</span>;
02541 
02542     <span class="keywordflow">case</span> VK_ESCAPE:
02543     <span class="keywordflow">case</span> VK_RETURN:
02544         <span class="keywordflow">if</span> (!fDropDownComboBox || !pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o15">fLBoxVisible</a>)
02545             <span class="keywordflow">return</span>;
02546 
02547         <span class="comment">// |  If this is a dropped listbox for a combobox and the ENTER  |</span>
02548         <span class="comment">// |  key is pressed, close up the listbox, so FALLTHRU          |</span>
02549         <span class="comment">// V                                                             V</span>
02550 
02551     <span class="keywordflow">case</span> VK_F4:
02552         <span class="keywordflow">if</span> (fDropDownComboBox &amp;&amp; !pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o18">fExtendedUI</a>) {
02553 
02554             <span class="comment">/*</span>
02555 <span class="comment">             * If we are a dropdown combo box/listbox we want to process</span>
02556 <span class="comment">             * this key.  BUT for TandtT, we don't do anything on VK_F4 if we</span>
02557 <span class="comment">             * are in extended ui mode.</span>
02558 <span class="comment">             */</span>
02559             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>, &amp;tlpwnd);
02560             <span class="keywordflow">if</span> (!pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o15">fLBoxVisible</a>) {
02561 
02562                 <span class="comment">/*</span>
02563 <span class="comment">                 * If the listbox isn't visible, just show it</span>
02564 <span class="comment">                 */</span>
02565                 <a class="code" href="../../d6/d0/usercli_8h.html#a668">xxxCBShowListBoxWindow</a>(pcbox, (vKey != VK_ESCAPE));
02566             } <span class="keywordflow">else</span> {
02567 
02568                 <span class="comment">/*</span>
02569 <span class="comment">                 * Ok, the listbox is visible.  So hide the listbox window.</span>
02570 <span class="comment">                 */</span>
02571                 <a class="code" href="../../d6/d0/usercli_8h.html#a667">xxxCBHideListBoxWindow</a>(pcbox, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, (vKey != VK_ESCAPE));
02572             }
02573             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
02574         }
02575 
02576         <span class="comment">/*</span>
02577 <span class="comment">         * Fall through to the return</span>
02578 <span class="comment">         */</span>
02579 
02580     <span class="keywordflow">default</span>:
02581         <span class="keywordflow">return</span>;
02582     }
02583 
02584     <span class="comment">/*</span>
02585 <span class="comment">     * Find out what the new selection should be</span>
02586 <span class="comment">     */</span>
02587     iNewISel = <a class="code" href="../../d9/d1/lboxctl2_8c.html#a32">IncrementISel</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>, i);
02588 
02589 
02590     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a114">SINGLESEL</a>) {
02591         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a> == iNewISel) {
02592 
02593             <span class="comment">/*</span>
02594 <span class="comment">             * If we are single selection and the keystroke is moving us to an</span>
02595 <span class="comment">             * item which is already selected, we don't have to do anything...</span>
02596 <span class="comment">             */</span>
02597             <span class="keywordflow">return</span>;
02598         }
02599 
02600         uEvent = EVENT_OBJECT_SELECTION;
02601 
02602         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o61">iTypeSearch</a> = 0;
02603         <span class="keywordflow">if</span> ((vKey == VK_UP || vKey == VK_DOWN) &amp;&amp;
02604                 !<a class="code" href="../../d6/d0/usercli_8h.html#a687">IsSelected</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>, <a class="code" href="../../d6/d0/usercli_8h.html#a248">HILITEONLY</a>)) {
02605 
02606             <span class="comment">/*</span>
02607 <span class="comment">             * If the caret is on an unselected item and the user just hits the</span>
02608 <span class="comment">             * up or down arrow key (ie. with no shift or ctrl modifications),</span>
02609 <span class="comment">             * then we will just select the item the cursor is at. This is</span>
02610 <span class="comment">             * needed for proper behavior in combo boxes but do we always want</span>
02611 <span class="comment">             * to run this code??? Note that this is only used in single</span>
02612 <span class="comment">             * selection list boxes since it doesn't make sense in the</span>
02613 <span class="comment">             * multiselection case. Note that an LB_KEYDOWN message must not be</span>
02614 <span class="comment">             * checked here because the vKey will be an item number not a</span>
02615 <span class="comment">             * VK_and we will goof. Thus, trackkeydown label is below this to</span>
02616 <span class="comment">             * fix a bug caused by it being above this...</span>
02617 <span class="comment">             */</span>
02618             iNewISel = (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a> == -1) ? 0 : plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>;
02619         }
02620     }
02621 
02622 TrackKeyDown:
02623 
02624     <a class="code" href="../../d6/d0/usercli_8h.html#a693">xxxSetISelBase</a>(plb, iNewISel);
02625 
02626     <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02627 
02628     <span class="keywordflow">if</span> (wModifiers &amp; <a class="code" href="../../d9/d1/lboxctl2_8c.html#a2">SHIFTDOWN</a>) {
02629         <span class="comment">// Check if iMouseDown is un-initialised</span>
02630         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a> == -1)
02631             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a> = iNewISel;
02632         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o53">iLastMouseMove</a> == -1)
02633             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o53">iLastMouseMove</a> = iNewISel;
02634 
02635         <span class="comment">// Check if we are in ADD mode</span>
02636         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o29">fAddSelMode</a>) {
02637             <span class="comment">/* Preserve all the pre-existing selections except the</span>
02638 <span class="comment">             * ones connected with the last anchor point; If the last</span>
02639 <span class="comment">             * Preserve all the previous selections</span>
02640 <span class="comment">            */</span>
02641             <span class="comment">/* Deselect only the selection connected with the last</span>
02642 <span class="comment">             * anchor point; If the last anchor point is associated</span>
02643 <span class="comment">             * with de-selection, then do not do it</span>
02644 <span class="comment">            */</span>
02645 
02646             <span class="keywordflow">if</span> (!plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o32">fNewItemState</a>)
02647                 plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o53">iLastMouseMove</a> = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a>;
02648 
02649             <span class="comment">/* We haven't done anything here because, LBBlockHilite()</span>
02650 <span class="comment">             * will take care of wiping out the selection between</span>
02651 <span class="comment">             * Anchor point and iLastMouseMove and select the block</span>
02652 <span class="comment">             * between anchor point and current cursor location</span>
02653 <span class="comment">            */</span>
02654         } <span class="keywordflow">else</span> {
02655             <span class="comment">/* We are not in ADD mode */</span>
02656             <span class="comment">/* Remove all selections except between the anchor point</span>
02657 <span class="comment">             * and last mouse move because it will be taken care of in</span>
02658 <span class="comment">             * LBBlockHilite</span>
02659 <span class="comment">            */</span>
02660             <a class="code" href="../../d6/d0/usercli_8h.html#a733">xxxResetWorld</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a>, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o53">iLastMouseMove</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02661         }
02662 
02663         uEvent = EVENT_OBJECT_SELECTIONWITHIN;
02664 
02665         <span class="comment">/* LBBlockHilite takes care to deselect the block between</span>
02666 <span class="comment">         * the anchor point and iLastMouseMove and select the block</span>
02667 <span class="comment">         * between the anchor point and the current cursor location</span>
02668 <span class="comment">        */</span>
02669         <span class="comment">/* Toggle all items to the same selection state as the item</span>
02670 <span class="comment">         * item at the anchor point) from the anchor point to the</span>
02671 <span class="comment">         * current cursor location.</span>
02672 <span class="comment">        */</span>
02673         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o32">fNewItemState</a> = <a class="code" href="../../d6/d0/usercli_8h.html#a687">IsSelected</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a>, <a class="code" href="../../d6/d0/usercli_8h.html#a249">SELONLY</a>);
02674         <a class="code" href="../../d6/d0/usercli_8h.html#a718">xxxLBBlockHilite</a>(plb, iNewISel, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02675 
02676         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o53">iLastMouseMove</a> = iNewISel;
02677         <span class="comment">/* Preserve the existing anchor point */</span>
02678     } <span class="keywordflow">else</span> {
02679         <span class="comment">/* Check if this is in ADD mode */</span>
02680         <span class="keywordflow">if</span> ((plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o29">fAddSelMode</a>) || (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a115">MULTIPLESEL</a>)) {
02681             <span class="comment">/* Preserve all pre-exisiting selections */</span>
02682             <span class="keywordflow">if</span> (fSelectKey) {
02683                 <span class="comment">/* Toggle the selection state of the current item */</span>
02684                 plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o32">fNewItemState</a> = !<a class="code" href="../../d6/d0/usercli_8h.html#a687">IsSelected</a>(plb, iNewISel, <a class="code" href="../../d6/d0/usercli_8h.html#a249">SELONLY</a>);
02685                 <a class="code" href="../../d6/d0/usercli_8h.html#a694">SetSelected</a>(plb, iNewISel, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o32">fNewItemState</a>, <a class="code" href="../../d6/d0/usercli_8h.html#a250">HILITEANDSEL</a>);
02686 
02687                 <a class="code" href="../../d6/d0/usercli_8h.html#a717">xxxInvertLBItem</a>(plb, iNewISel, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o32">fNewItemState</a>);
02688 
02689                 <span class="comment">/* Set the anchor point at the current location */</span>
02690                 plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o53">iLastMouseMove</a> = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a> = iNewISel;
02691                 uEvent = (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o32">fNewItemState</a> ? EVENT_OBJECT_SELECTIONADD :
02692                         EVENT_OBJECT_SELECTIONREMOVE);
02693             }
02694         } <span class="keywordflow">else</span> {
02695             <span class="comment">/* We are NOT in ADD mode */</span>
02696             <span class="comment">/* Remove all existing selections except iNewISel, to</span>
02697 <span class="comment">             * avoid flickering.</span>
02698 <span class="comment">            */</span>
02699             <a class="code" href="../../d6/d0/usercli_8h.html#a733">xxxResetWorld</a>(plb, iNewISel, iNewISel, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02700 
02701             <span class="comment">/* Select the current item */</span>
02702             <a class="code" href="../../d6/d0/usercli_8h.html#a694">SetSelected</a>(plb, iNewISel, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d0/usercli_8h.html#a250">HILITEANDSEL</a>);
02703             <a class="code" href="../../d6/d0/usercli_8h.html#a717">xxxInvertLBItem</a>(plb, iNewISel, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02704 
02705             <span class="comment">/* Set the anchor point at the current location */</span>
02706             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o53">iLastMouseMove</a> = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a> = iNewISel;
02707             uEvent = EVENT_OBJECT_SELECTION;
02708         }
02709     }
02710 
02711     <span class="comment">/*</span>
02712 <span class="comment">     * Move the cursor to the new location</span>
02713 <span class="comment">     */</span>
02714     <a class="code" href="../../d6/d0/usercli_8h.html#a716">xxxInsureVisible</a>(plb, iNewISel, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02715     <a class="code" href="../../d6/d0/usercli_8h.html#a706">xxxLBShowHideScrollBars</a>(plb);
02716 
02717     <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02718 
02719     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>() &amp;&amp; uEvent) {
02720         <a class="code" href="../../d6/d0/usercli_8h.html#a409">LBEvent</a>(plb, uEvent, iNewISel);
02721     }
02722 
02723     <span class="comment">/*</span>
02724 <span class="comment">     * Should we notify our parent?</span>
02725 <span class="comment">     */</span>
02726     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o23">fNotify</a>) {
02727         <span class="keywordflow">if</span> (fDropDownComboBox &amp;&amp; pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o15">fLBoxVisible</a>) {
02728 
02729             <span class="comment">/*</span>
02730 <span class="comment">             * If we are in a drop down combo box/listbox and the listbox is</span>
02731 <span class="comment">             * visible, we need to set the fKeyboardSelInListBox bit so that the</span>
02732 <span class="comment">             * combo box code knows not to hide the listbox since the selchange</span>
02733 <span class="comment">             * message is caused by the user keyboarding through...</span>
02734 <span class="comment">             */</span>
02735             pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o17">fKeyboardSelInListBox</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02736             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o51">iLastSelection</a> = iNewISel;
02737         }
02738         <a class="code" href="../../d6/d0/usercli_8h.html#a732">xxxNotifyOwner</a>(plb, LBN_SELCHANGE);
02739     }
02740 }
02741 
02742 
02743 <span class="comment">/***************************************************************************\</span>
02744 <span class="comment">* Compare</span>
02745 <span class="comment">*</span>
02746 <span class="comment">* Is lpstr1 equal/prefix/less-than/greater-than lsprst2 (case-insensitive) ?</span>
02747 <span class="comment">*</span>
02748 <span class="comment">* LATER IanJa: this assume a longer string is never a prefix of a longer one.</span>
02749 <span class="comment">* Also assumes that removing 1 or more characters from the end of a string will</span>
02750 <span class="comment">* give a string tahs sort before the original.  These assumptions are not valid</span>
02751 <span class="comment">* for all languages.  We nedd better support from NLS. (Consider French</span>
02752 <span class="comment">* accents, Spanish c/ch, ligatures, German sharp-s/SS, etc.)</span>
02753 <span class="comment">*</span>
02754 <span class="comment">* History:</span>
02755 <span class="comment">\***************************************************************************/</span>
02756 
<a name="l02757"></a><a class="code" href="../../d9/d1/lboxctl2_8c.html#a38">02757</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> <a class="code" href="../../d9/d1/lboxctl2_8c.html#a38">Compare</a>(
02758     LPCWSTR pwsz1,
02759     LPCWSTR pwsz2,
02760     DWORD dwLocaleId)
02761 {
02762     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> len1 = wcslen(pwsz1);
02763     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> len2 = wcslen(pwsz2);
02764     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> result;
02765 
02766     <span class="comment">/*</span>
02767 <span class="comment">     * CompareStringW returns:</span>
02768 <span class="comment">     *    1 = pwsz1  &lt;  pwsz2</span>
02769 <span class="comment">     *    2 = pwsz1  == pwsz2</span>
02770 <span class="comment">     *    3 = pwsz1  &gt;  pwsz2</span>
02771 <span class="comment">     */</span>
02772     result = CompareStringW((LCID)dwLocaleId, NORM_IGNORECASE,
02773             pwsz1, <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(len1,len2), pwsz2, <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(len1, len2));
02774 
02775     <span class="keywordflow">if</span> (result == CSTR_LESS_THAN) {
02776        <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a112">LT</a>;
02777     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (result == CSTR_EQUAL) {
02778         <span class="keywordflow">if</span> (len1 == len2) {
02779             <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a110">EQ</a>;
02780         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (len1 &lt; len2) {
02781             <span class="comment">/*</span>
02782 <span class="comment">             * LATER IanJa: should not assume shorter string is a prefix</span>
02783 <span class="comment">             * Spanish "c" and "ch", ligatures, German sharp-s/SS etc.</span>
02784 <span class="comment">             */</span>
02785             <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a111">PREFIX</a>;
02786         }
02787     }
02788     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a113">GT</a>;
02789 }
02790 
02791 <span class="comment">/***************************************************************************\</span>
02792 <span class="comment">* xxxFindString</span>
02793 <span class="comment">*</span>
02794 <span class="comment">* Scans for a string in the listbox prefixed by or equal to lpstr.</span>
02795 <span class="comment">* For OWNERDRAW listboxes without strings and without the sort style, we</span>
02796 <span class="comment">* try to match the long app supplied values.</span>
02797 <span class="comment">*</span>
02798 <span class="comment">* History:</span>
02799 <span class="comment">* 16-Apr-1992 beng      The NODATA case</span>
02800 <span class="comment">\***************************************************************************/</span>
02801 
<a name="l02802"></a><a class="code" href="../../d6/d0/usercli_8h.html#a683">02802</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> <a class="code" href="../../d6/d0/usercli_8h.html#a683">xxxFindString</a>(
02803     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
02804     LPWSTR lpstr,
02805     INT sStart,
02806     INT code,
02807     BOOL fWrap)
02808 {
02809     <span class="comment">/*</span>
02810 <span class="comment">     * Search for a prefix match (case-insensitive equal/prefix)</span>
02811 <span class="comment">     * sStart == -1 means start from beginning, else start looking at sStart+1</span>
02812 <span class="comment">     * assumes cMac &gt; 0.</span>
02813 <span class="comment">     */</span>
02814     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> sInd;  <span class="comment">/* index of string */</span>
02815     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> sStop;          <span class="comment">/* index to stop searching at */</span>
02816     <a class="code" href="../../d6/d9/structtagLBItem.html">lpLBItem</a> pRg;
02817     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndParent;
02818     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> sortResult;
02819 
02820 <span class="comment">/*</span>
02821 <span class="comment"> * Owner-Draw version of pRg</span>
02822 <span class="comment"> */</span>
02823 <span class="preprocessor">#define pODRg ((lpLBODItem)pRg)</span>
02824 <span class="preprocessor"></span>    COMPAREITEMSTRUCT cis;
02825     LPWSTR listboxString;
02826 
02827     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
02828 
02829     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o30">fHasStrings</a> &amp;&amp; (!lpstr || !*lpstr))
02830         <span class="keywordflow">return</span> LB_ERR;
02831 
02832     <span class="keywordflow">if</span> (!plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o31">fHasData</a>) {
02833         RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"FindString called on NODATA lb"</span>);
02834         <span class="keywordflow">return</span> LB_ERR;
02835     }
02836 
02837     <span class="keywordflow">if</span> ((sInd = sStart + 1) &gt;= plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>)
02838         sInd = (fWrap ? 0 : plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> - 1);
02839 
02840     sStop = (fWrap ? sInd : 0);
02841 
02842     <span class="comment">/*</span>
02843 <span class="comment">     * If at end and no wrap, stop right away</span>
02844 <span class="comment">     */</span>
02845     <span class="keywordflow">if</span> (((sStart &gt;= plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> - 1) &amp;&amp; !fWrap) || (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> &lt; 1)) {
02846         <span class="keywordflow">return</span> LB_ERR;
02847     }
02848 
02849     <span class="comment">/*</span>
02850 <span class="comment">     * Apps could pass in an invalid sStart like -2 and we would blow up.</span>
02851 <span class="comment">     * Win 3.1 would not so we need to fixup sInd to be zero</span>
02852 <span class="comment">     */</span>
02853     <span class="keywordflow">if</span> (sInd &lt; 0)
02854         sInd = 0;
02855 
02856     pRg = (<a class="code" href="../../d6/d9/structtagLBItem.html">lpLBItem</a>)(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o8">rgpch</a>);
02857 
02858     <span class="keywordflow">do</span> {
02859         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o30">fHasStrings</a>) {
02860 
02861             <span class="comment">/*</span>
02862 <span class="comment">             * Searching for string matches.</span>
02863 <span class="comment">             */</span>
02864             listboxString = (LPWSTR)((LPBYTE)plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o9">hStrings</a> + pRg[sInd].<a class="code" href="../../d6/d9/structtagLBItem.html#o0">offsz</a>);
02865 
02866             <span class="keywordflow">if</span> (code == <a class="code" href="../../d6/d0/usercli_8h.html#a111">PREFIX</a> &amp;&amp;
02867                 listboxString &amp;&amp;
02868                 *lpstr != TEXT(<span class="charliteral">'['</span>) &amp;&amp;
02869                 *listboxString == TEXT(<span class="charliteral">'['</span>)) {
02870 
02871                 <span class="comment">/*</span>
02872 <span class="comment">                 * If we are looking for a prefix string and the first items</span>
02873 <span class="comment">                 * in this string are [- then we ignore them.  This is so</span>
02874 <span class="comment">                 * that in a directory listbox, the user can goto drives</span>
02875 <span class="comment">                 * by selecting the drive letter.</span>
02876 <span class="comment">                 */</span>
02877                 listboxString++;
02878                 <span class="keywordflow">if</span> (*listboxString == TEXT(<span class="charliteral">'-'</span>))
02879                     listboxString++;
02880             }
02881 
02882             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/lboxctl2_8c.html#a38">Compare</a>(lpstr, listboxString, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o60">dwLocaleId</a>) &lt;= code) {
02883                <span class="keywordflow">goto</span> FoundIt;
02884             }
02885 
02886         } <span class="keywordflow">else</span> {
02887             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o22">fSort</a>) {
02888 
02889                 <span class="comment">/*</span>
02890 <span class="comment">                 * Send compare item messages to the parent for sorting</span>
02891 <span class="comment">                 */</span>
02892                 cis.CtlType = ODT_LISTBOX;
02893                 cis.CtlID = PtrToUlong(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>);
02894                 cis.hwndItem = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
02895                 cis.itemID1 = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1;
02896                 cis.itemData1 = (ULONG_PTR)lpstr;
02897                 cis.itemID2 = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)sInd;
02898                 cis.itemData2 = <a class="code" href="../../d9/d1/lboxctl2_8c.html#a6">pODRg</a>[sInd].itemData;
02899                 cis.dwLocaleId = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o60">dwLocaleId</a>;
02900 
02901                 <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o0">spwndParent</a>, &amp;tlpwndParent);
02902                 sortResult = (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)<a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o0">spwndParent</a>), WM_COMPAREITEM,
02903                         cis.CtlID, (LPARAM)&amp;cis);
02904                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndParent);
02905 
02906 
02907                 <span class="keywordflow">if</span> (sortResult == -1) {
02908                    sortResult = <a class="code" href="../../d6/d0/usercli_8h.html#a112">LT</a>;
02909                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sortResult == 1) {
02910                    sortResult = <a class="code" href="../../d6/d0/usercli_8h.html#a113">GT</a>;
02911                 } <span class="keywordflow">else</span> {
02912                    sortResult = <a class="code" href="../../d6/d0/usercli_8h.html#a110">EQ</a>;
02913                 }
02914 
02915                 <span class="keywordflow">if</span> (sortResult &lt;= code) {
02916                     <span class="keywordflow">goto</span> FoundIt;
02917                 }
02918             } <span class="keywordflow">else</span> {
02919 
02920                 <span class="comment">/*</span>
02921 <span class="comment">                 * Searching for app supplied long data matches.</span>
02922 <span class="comment">                 */</span>
02923                 <span class="keywordflow">if</span> ((ULONG_PTR)lpstr == <a class="code" href="../../d9/d1/lboxctl2_8c.html#a6">pODRg</a>[sInd].itemData)
02924                     <span class="keywordflow">goto</span> FoundIt;
02925             }
02926         }
02927 
02928         <span class="comment">/*</span>
02929 <span class="comment">         * Wrap round to beginning of list</span>
02930 <span class="comment">         */</span>
02931         <span class="keywordflow">if</span> (++sInd == plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>)
02932             sInd = 0;
02933     } <span class="keywordflow">while</span> (sInd != sStop);
02934 
02935     sInd = -1;
02936 
02937 FoundIt:
02938     <span class="keywordflow">return</span> sInd;
02939 }
02940 
02941 
02942 <span class="comment">/***************************************************************************\</span>
02943 <span class="comment">* xxxLBoxCtlCharInput</span>
02944 <span class="comment">*</span>
02945 <span class="comment">* History:</span>
02946 <span class="comment">\***************************************************************************/</span>
02947 
<a name="l02948"></a><a class="code" href="../../d6/d0/usercli_8h.html#a708">02948</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a708">xxxLBoxCtlCharInput</a>(
02949     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
02950     UINT  inputChar,
02951     BOOL  fAnsi)
02952 {
02953     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> iSel;
02954     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fControl;
02955     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndParent;
02956 
02957     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
02958 
02959     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> == 0 || plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o24">fMouseDown</a>) {
02960 
02961         <span class="comment">/*</span>
02962 <span class="comment">         * Get out if we are in the middle of mouse routines or if we have no</span>
02963 <span class="comment">         * items in the listbox, we just return without doing anything.</span>
02964 <span class="comment">         */</span>
02965         <span class="keywordflow">return</span>;
02966     }
02967 
02968     fControl = (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(VK_CONTROL) &lt; 0);
02969 
02970     <span class="keywordflow">switch</span> (inputChar) {
02971     <span class="keywordflow">case</span> VK_ESCAPE:
02972         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o61">iTypeSearch</a> = 0;
02973         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o62">pszTypeSearch</a>)
02974             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o62">pszTypeSearch</a>[0] = 0;
02975         <span class="keywordflow">break</span>;
02976 
02977     <span class="keywordflow">case</span> VK_BACK:
02978         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o61">iTypeSearch</a>) {
02979             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o62">pszTypeSearch</a>[plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o61">iTypeSearch</a>--] = 0;
02980             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o22">fSort</a>) {
02981                 iSel = -1;
02982                 <span class="keywordflow">goto</span> TypeSearch;
02983             }
02984         }
02985         <span class="keywordflow">break</span>;
02986 
02987     <span class="keywordflow">case</span> VK_SPACE:
02988         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o29">fAddSelMode</a> || plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a115">MULTIPLESEL</a>)
02989             <span class="keywordflow">break</span>;
02990         <span class="comment">/* Otherwise, for single/extended selection listboxes not in add</span>
02991 <span class="comment">         * selection mode, let the  space go thru as a type search character</span>
02992 <span class="comment">         * FALL THRU</span>
02993 <span class="comment">         */</span>
02994 
02995     <span class="keywordflow">default</span>:
02996 
02997         <span class="comment">/*</span>
02998 <span class="comment">         * Move selection to first item beginning with the character the</span>
02999 <span class="comment">         * user typed.  We don't want do this if we are using owner draw.</span>
03000 <span class="comment">         */</span>
03001 
03002         <span class="keywordflow">if</span> (fAnsi &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a125">IS_DBCS_ENABLED</a>() &amp;&amp; IsDBCSLeadByteEx(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a118">THREAD_CODEPAGE</a>(), (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)inputChar)) {
03003             WCHAR wch;
03004             LPWSTR lpwstr = &amp;wch;
03005 
03006             inputChar = <a class="code" href="../../d6/d0/usercli_8h.html#a460">DbcsCombine</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>), (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)inputChar);
03007             RIPMSG1(RIP_VERBOSE, <span class="stringliteral">"xxxLBoxCtlCharInput: combined DBCS. 0x%04x"</span>, inputChar);
03008 
03009             <span class="keywordflow">if</span> (inputChar == 0) {
03010                 RIPMSG1(RIP_WARNING, <span class="stringliteral">"xxxLBoxCtlCharInput: cannot combine two DBCS. LB=0x%02x"</span>,
03011                         inputChar);
03012                 <span class="keywordflow">break</span>;
03013             }
03014             <span class="comment">// If it is DBCS, let's ignore the ctrl status.</span>
03015             fControl = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03016 
03017             <span class="comment">// Convert DBCS to UNICODE.</span>
03018             <span class="comment">// Note: Leading byte is in the low byte, trailing byte is in high byte.</span>
03019             <span class="comment">// Let's assume Little Endian CPUs only, so inputChar can directly be</span>
03020             <span class="comment">// input for MBSToWCSEx as an ANSI string.</span>
03021             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/chartran_8c.html#a3">MBToWCSEx</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a118">THREAD_CODEPAGE</a>(), (LPCSTR)&amp;inputChar, 2, &amp;lpwstr, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) == 0) {
03022                 RIPMSG1(RIP_WARNING, <span class="stringliteral">"xxxLBoxCtlCharInput: cannot convert 0x%04x to UNICODE."</span>,
03023                         inputChar);
03024                 <span class="keywordflow">break</span>;
03025             }
03026             inputChar = wch;
03027         }
03028 
03029         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o30">fHasStrings</a>) {
03030             <span class="comment">// Incremental Type Search processing</span>
03031             <span class="comment">//</span>
03032             <span class="comment">// update szTypeSearch string and then move to the first item from</span>
03033             <span class="comment">// the current selection whose prefix matches szTypeSearch</span>
03034             <span class="comment">//</span>
03035             <span class="comment">// the szTypeSearch will continue to grow until a "long enough"</span>
03036             <span class="comment">// gap between key entries is encountered -- at which point any</span>
03037             <span class="comment">// more searching will start over</span>
03038 
03039             <span class="comment">/*</span>
03040 <span class="comment">             * Undo CONTROL-char to char</span>
03041 <span class="comment">             */</span>
03042             <span class="keywordflow">if</span> (fControl &amp;&amp; inputChar &lt; 0x20)
03043                 inputChar += 0x40;
03044 
03045             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o61">iTypeSearch</a> == <a class="code" href="../../d9/d1/lboxctl2_8c.html#a5">MAX_TYPESEARCH</a>) {
03046                 <a class="code" href="../../d6/d0/usercli_8h.html#a219">NtUserMessageBeep</a>(0);
03047                 <span class="keywordflow">break</span>;
03048             }
03049             iSel = -1;
03050 
03051             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o62">pszTypeSearch</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03052                 plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o62">pszTypeSearch</a> = (LPWSTR)<a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(HEAP_ZERO_MEMORY, <span class="keyword">sizeof</span>(WCHAR) * (<a class="code" href="../../d9/d1/lboxctl2_8c.html#a5">MAX_TYPESEARCH</a> + 1));
03053 
03054             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o62">pszTypeSearch</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03055                 <a class="code" href="../../d6/d0/usercli_8h.html#a219">NtUserMessageBeep</a>(0);
03056                 <span class="keywordflow">break</span>;
03057             }
03058 
03059             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o62">pszTypeSearch</a>[plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o61">iTypeSearch</a>++] = (WCHAR) inputChar;
03060             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o62">pszTypeSearch</a>[plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o61">iTypeSearch</a>]   = 0;
03061 
03062 TypeSearch:
03063             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o22">fSort</a>) {
03064                 <span class="comment">// Set timer to determine when to kill incremental searching</span>
03065                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a230">NtUserSetTimer</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a52">IDSYS_LBSEARCH</a>,
03066                                <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;dtLBSearch, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03067             } <span class="keywordflow">else</span> {
03068                 <span class="comment">// If this is not a sorted listbox, no incremental search.</span>
03069                 plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o61">iTypeSearch</a> = 0;
03070                 iSel = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>;
03071             }
03072 
03073 
03074             <span class="comment">/*</span>
03075 <span class="comment">             * Search for the item beginning with the given character starting</span>
03076 <span class="comment">             * at iSel+1.  We will wrap the search to the beginning of the</span>
03077 <span class="comment">             * listbox if we don't find the item.   If SHIFT is down and we are</span>
03078 <span class="comment">             * a multiselection lb, then the item's state will be set to</span>
03079 <span class="comment">             * plb-&gt;fNewItemState according to the current mode.</span>
03080 <span class="comment">             */</span>
03081             iSel = <a class="code" href="../../d6/d0/usercli_8h.html#a683">xxxFindString</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o62">pszTypeSearch</a>, iSel, <a class="code" href="../../d6/d0/usercli_8h.html#a111">PREFIX</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03082             <span class="keywordflow">if</span> (iSel == -1) {
03083                 <span class="comment">// no match found -- check for prefix match</span>
03084                 <span class="comment">// (i.e. "p" find FIRST item that starts with 'p',</span>
03085                 <span class="comment">//       "pp" find NEXT item that starts with 'p')</span>
03086                 <span class="keywordflow">if</span>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o61">iTypeSearch</a>)
03087                 {
03088                     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o61">iTypeSearch</a>--;
03089                     <span class="keywordflow">if</span> ((plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o61">iTypeSearch</a> == 1) &amp;&amp; (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o62">pszTypeSearch</a>[0] == plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o62">pszTypeSearch</a>[1]))
03090                     {
03091                         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o62">pszTypeSearch</a>[1] = 0;
03092                         iSel = <a class="code" href="../../d6/d0/usercli_8h.html#a683">xxxFindString</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o62">pszTypeSearch</a>, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>, <a class="code" href="../../d6/d0/usercli_8h.html#a111">PREFIX</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03093                     }
03094                 }
03095             }
03096             <span class="comment">// if match is found -- select it</span>
03097             <span class="keywordflow">if</span> (iSel != -1)
03098             {
03099 CtlKeyInput:
03100                 <a class="code" href="../../d6/d0/usercli_8h.html#a709">xxxLBoxCtlKeyInput</a>(plb, <a class="code" href="../../d9/d1/lboxctl2_8c.html#a0">LB_KEYDOWN</a>, iSel);
03101 
03102             }
03103         } <span class="keywordflow">else</span> {
03104             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o0">spwndParent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03105                 <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o0">spwndParent</a>, &amp;tlpwndParent);
03106                 iSel = (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)<a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o0">spwndParent</a>, WM_CHARTOITEM,
03107                         MAKELONG(inputChar, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>), (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>), fAnsi);
03108                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndParent);
03109             } <span class="keywordflow">else</span>
03110                 iSel = -1;
03111 
03112             <span class="keywordflow">if</span> (iSel != -1 &amp;&amp; iSel != -2)
03113                 <span class="keywordflow">goto</span> CtlKeyInput;
03114 
03115         }
03116         <span class="keywordflow">break</span>;
03117     }
03118 }
03119 
03120 
03121 <span class="comment">/***************************************************************************\</span>
03122 <span class="comment">* LBoxGetSelItems</span>
03123 <span class="comment">*</span>
03124 <span class="comment">* effects: For multiselection listboxes, this returns the total number of</span>
03125 <span class="comment">* selection items in the listbox if fCountOnly is true.  or it fills an array</span>
03126 <span class="comment">* (lParam) with the items numbers of the first wParam selected items.</span>
03127 <span class="comment">*</span>
03128 <span class="comment">* History:</span>
03129 <span class="comment">\***************************************************************************/</span>
03130 
<a name="l03131"></a><a class="code" href="../../d9/d1/lboxctl2_8c.html#a41">03131</a> <span class="keywordtype">int</span> <a class="code" href="../../d6/d0/usercli_8h.html#a691">LBoxGetSelItems</a>(
03132     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
03133     BOOL fCountOnly,
03134     <span class="keywordtype">int</span> wParam,
03135     LPINT lParam)
03136 {
03137     <span class="keywordtype">int</span> i;
03138     <span class="keywordtype">int</span> itemsselected = 0;
03139 
03140     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a114">SINGLESEL</a>)
03141         <span class="keywordflow">return</span> LB_ERR;
03142 
03143     <span class="keywordflow">for</span> (i = 0; i &lt; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>; i++) {
03144         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a687">IsSelected</a>(plb, i, <a class="code" href="../../d6/d0/usercli_8h.html#a249">SELONLY</a>)) {
03145             <span class="keywordflow">if</span> (!fCountOnly) {
03146                 <span class="keywordflow">if</span> (itemsselected &lt; wParam)
03147                     *lParam++ = i;
03148                 <span class="keywordflow">else</span> {
03149 
03150                     <span class="comment">/*</span>
03151 <span class="comment">                     * That's all the items we can fit in the array.</span>
03152 <span class="comment">                     */</span>
03153                     <span class="keywordflow">return</span> itemsselected;
03154                 }
03155             }
03156             itemsselected++;
03157         }
03158     }
03159 
03160     <span class="keywordflow">return</span> itemsselected;
03161 }
03162 
03163 
03164 <span class="comment">/***************************************************************************\</span>
03165 <span class="comment">* xxxLBSetRedraw</span>
03166 <span class="comment">*</span>
03167 <span class="comment">* Handle WM_SETREDRAW message</span>
03168 <span class="comment">*</span>
03169 <span class="comment">* History:</span>
03170 <span class="comment">\***************************************************************************/</span>
03171 
<a name="l03172"></a><a class="code" href="../../d6/d0/usercli_8h.html#a738">03172</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a738">xxxLBSetRedraw</a>(
03173     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
03174     BOOL fRedraw)
03175 {
03176     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
03177 
03178     <span class="keywordflow">if</span> (fRedraw)
03179         fRedraw = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03180 
03181     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o19">fRedraw</a> != (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)fRedraw) {
03182         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o19">fRedraw</a> = !!fRedraw;
03183 
03184         <span class="keywordflow">if</span> (fRedraw) {
03185             <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03186             <a class="code" href="../../d6/d0/usercli_8h.html#a706">xxxLBShowHideScrollBars</a>(plb);
03187 
03188             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o20">fDeferUpdate</a>) {
03189                 plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o20">fDeferUpdate</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03190                 <a class="code" href="../../d6/d0/usercli_8h.html#a239">RedrawWindow</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03191                         RDW_INVALIDATE | RDW_ERASE |
03192                         RDW_FRAME | RDW_ALLCHILDREN);
03193             }
03194         }
03195     }
03196 }
03197 
03198 <span class="comment">/***************************************************************************\</span>
03199 <span class="comment">* xxxLBSelRange</span>
03200 <span class="comment">*</span>
03201 <span class="comment">* Selects the range of items between i and j, inclusive.</span>
03202 <span class="comment">*</span>
03203 <span class="comment">* History:</span>
03204 <span class="comment">\***************************************************************************/</span>
03205 
<a name="l03206"></a><a class="code" href="../../d9/d1/lboxctl2_8c.html#a43">03206</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a689">xxxLBSelRange</a>(
03207     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
03208     <span class="keywordtype">int</span> iStart,
03209     <span class="keywordtype">int</span> iEnd,
03210     BOOL fnewstate)
03211 {
03212     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> temp;
03213     RECT rc;
03214 
03215     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
03216 
03217     <span class="keywordflow">if</span> (iStart &gt; iEnd) {
03218         temp = iEnd;
03219         iEnd = iStart;
03220         iStart = temp;
03221     }
03222 
03223     <span class="comment">/*</span>
03224 <span class="comment">     * We don't want to loop through items that don't exist.</span>
03225 <span class="comment">     */</span>
03226     iEnd = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>, iEnd);
03227     iStart = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(iStart, 0);
03228     <span class="keywordflow">if</span> (iStart &gt; iEnd)
03229         <span class="keywordflow">return</span>;
03230 
03231 
03232     <span class="comment">/*</span>
03233 <span class="comment">     * iEnd could be equal to MAXINT which is why we test temp and iEnd</span>
03234 <span class="comment">     * as DWORDs.</span>
03235 <span class="comment">     */</span>
03236     <span class="keywordflow">for</span> (temp = iStart; temp &lt;= (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)iEnd; temp++) {
03237 
03238         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a687">IsSelected</a>(plb, temp, <a class="code" href="../../d6/d0/usercli_8h.html#a249">SELONLY</a>) != fnewstate) {
03239             <a class="code" href="../../d6/d0/usercli_8h.html#a694">SetSelected</a>(plb, temp, fnewstate, <a class="code" href="../../d6/d0/usercli_8h.html#a250">HILITEANDSEL</a>);
03240             <a class="code" href="../../d6/d0/usercli_8h.html#a744">LBGetItemRect</a>(plb, temp, &amp;rc);
03241 
03242             <a class="code" href="../../d6/d0/usercli_8h.html#a711">xxxLBInvalidateRect</a>(plb, (LPRECT)&amp;rc, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03243         }
03244 
03245     }
03246     UserAssert(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a>);
03247     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
03248         <a class="code" href="../../d6/d0/usercli_8h.html#a409">LBEvent</a>(plb, EVENT_OBJECT_SELECTIONWITHIN, iStart);
03249     }
03250 }
03251 
03252 
03253 <span class="comment">/***************************************************************************\</span>
03254 <span class="comment">* xxxLBSetCurSel</span>
03255 <span class="comment">*</span>
03256 <span class="comment">* History:</span>
03257 <span class="comment">\***************************************************************************/</span>
03258 
<a name="l03259"></a><a class="code" href="../../d9/d1/lboxctl2_8c.html#a44">03259</a> <span class="keywordtype">int</span> <a class="code" href="../../d6/d0/usercli_8h.html#a690">xxxLBSetCurSel</a>(
03260     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
03261     <span class="keywordtype">int</span> iSel)
03262 {
03263     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
03264 
03265     <span class="keywordflow">if</span> (!(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a> || iSel &lt; -1 || iSel &gt;= plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>)) {
03266         <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03267         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a> != -1) {
03268 
03269             <span class="comment">/*</span>
03270 <span class="comment">             * This prevents scrolling when iSel == -1</span>
03271 <span class="comment">             */</span>
03272             <span class="keywordflow">if</span> (iSel != -1)
03273                 <a class="code" href="../../d6/d0/usercli_8h.html#a716">xxxInsureVisible</a>(plb, iSel, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03274 
03275             <span class="comment">/*</span>
03276 <span class="comment">             * Turn off old selection</span>
03277 <span class="comment">             */</span>
03278             <a class="code" href="../../d6/d0/usercli_8h.html#a717">xxxInvertLBItem</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03279         }
03280 
03281         <span class="keywordflow">if</span> (iSel != -1) {
03282             <a class="code" href="../../d6/d0/usercli_8h.html#a716">xxxInsureVisible</a>(plb, iSel, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03283             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a> = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a> = iSel;
03284 
03285             <span class="comment">/*</span>
03286 <span class="comment">             * Highlight new selection</span>
03287 <span class="comment">             */</span>
03288             <a class="code" href="../../d6/d0/usercli_8h.html#a717">xxxInvertLBItem</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03289         } <span class="keywordflow">else</span> {
03290             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a> = -1;
03291             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>)
03292                 plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a> = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>-1);
03293             <span class="keywordflow">else</span>
03294                 plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a> = 0;
03295         }
03296 
03297         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
03298             <span class="comment">/*</span>
03299 <span class="comment">             * Send both focus and selection events</span>
03300 <span class="comment">             */</span>
03301             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/rtl_2wow_8c.html#a17">_IsWindowVisible</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>)) {
03302                 <a class="code" href="../../d6/d0/usercli_8h.html#a409">LBEvent</a>(plb, EVENT_OBJECT_FOCUS, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>);
03303                 <a class="code" href="../../d6/d0/usercli_8h.html#a409">LBEvent</a>(plb, EVENT_OBJECT_SELECTION, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a>);
03304             }
03305         }
03306 
03307         <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03308         <span class="keywordflow">return</span> plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a>;
03309     }
03310 
03311     <span class="keywordflow">return</span> LB_ERR;
03312 }
03313 
03314 
03315 <span class="comment">/***************************************************************************\</span>
03316 <span class="comment">* LBSetItemData</span>
03317 <span class="comment">*</span>
03318 <span class="comment">* Makes the item at index contain the data given.</span>
03319 <span class="comment">*</span>
03320 <span class="comment">* History:</span>
03321 <span class="comment">* 16-Apr-1992 beng      The NODATA listbox case</span>
03322 <span class="comment">\***************************************************************************/</span>
03323 
<a name="l03324"></a><a class="code" href="../../d9/d1/lboxctl2_8c.html#a45">03324</a> <span class="keywordtype">int</span> <a class="code" href="../../d6/d0/usercli_8h.html#a724">LBSetItemData</a>(
03325     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
03326     <span class="keywordtype">int</span> index,
03327     LONG_PTR data)
03328 {
03329     LPSTR lpItemText;
03330 
03331     <span class="comment">/*</span>
03332 <span class="comment">     * v-ronaar: fix bug #25865, don't allow negative indices!</span>
03333 <span class="comment">     */</span>
03334     <span class="keywordflow">if</span> ((index != -1) &amp;&amp; ((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>) index &gt;= (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>) plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>)) {
03335         RIPERR1(ERROR_INVALID_INDEX, RIP_WARNING, <span class="stringliteral">"LBSetItemData with invalid index %x"</span>, index);
03336         <span class="keywordflow">return</span> LB_ERR;
03337     }
03338 
03339     <span class="comment">/*</span>
03340 <span class="comment">     * No-data listboxes just ignore all LB_SETITEMDATA calls</span>
03341 <span class="comment">     */</span>
03342     <span class="keywordflow">if</span> (!plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o31">fHasData</a>) {
03343         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03344     }
03345 
03346     lpItemText = (LPSTR)plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o8">rgpch</a>;
03347 
03348     <span class="keywordflow">if</span> (index == -1) {
03349 
03350         <span class="comment">/*</span>
03351 <span class="comment">         * index == -1 means set the data to all the items</span>
03352 <span class="comment">         */</span>
03353         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o30">fHasStrings</a>) {
03354             <span class="keywordflow">for</span> (index = 0; index &lt; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>; index++) {
03355 
03356                 ((<a class="code" href="../../d6/d9/structtagLBItem.html">lpLBItem</a>)lpItemText)-&gt;itemData = data;
03357                 lpItemText += <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagLBItem.html">LBItem</a>);
03358             }
03359         } <span class="keywordflow">else</span> {
03360             <span class="keywordflow">for</span> (index = 0; index &lt; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>; index++) {
03361 
03362                 ((<a class="code" href="../../d8/d9/structtagLBODItem.html">lpLBODItem</a>)lpItemText)-&gt;itemData = data;
03363                 lpItemText += <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d9/structtagLBODItem.html">LBODItem</a>);
03364             }
03365         }
03366         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03367     }
03368 
03369     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o30">fHasStrings</a>) {
03370 
03371         lpItemText = (LPSTR)(lpItemText + (index * <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagLBItem.html">LBItem</a>)));
03372         ((<a class="code" href="../../d6/d9/structtagLBItem.html">lpLBItem</a>)lpItemText)-&gt;itemData = data;
03373     } <span class="keywordflow">else</span> {
03374 
03375         lpItemText = (LPSTR)(lpItemText + (index * <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d9/structtagLBODItem.html">LBODItem</a>)));
03376         ((<a class="code" href="../../d8/d9/structtagLBODItem.html">lpLBODItem</a>)lpItemText)-&gt;itemData = data;
03377     }
03378     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03379 }
03380 
03381 <span class="comment">/***************************************************************************\</span>
03382 <span class="comment">* xxxCheckRedraw</span>
03383 <span class="comment">*</span>
03384 <span class="comment">* History:</span>
03385 <span class="comment">\***************************************************************************/</span>
03386 
<a name="l03387"></a><a class="code" href="../../d6/d0/usercli_8h.html#a714">03387</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a714">xxxCheckRedraw</a>(
03388     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
03389     BOOL fConditional,
03390     INT sItem)
03391 {
03392     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
03393 
03394     <span class="keywordflow">if</span> (fConditional &amp;&amp; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> &amp;&amp;
03395             (sItem &gt; (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a> + <a class="code" href="../../d6/d0/usercli_8h.html#a713">CItemInWindow</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))))
03396         <span class="keywordflow">return</span>;
03397 
03398     <span class="comment">/*</span>
03399 <span class="comment">     * Don't do anything if the parent is not visible.</span>
03400 <span class="comment">     */</span>
03401     <a class="code" href="../../d6/d0/usercli_8h.html#a711">xxxLBInvalidateRect</a>(plb, (LPRECT)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03402 }
03403 
03404 
03405 <span class="comment">/***************************************************************************\</span>
03406 <span class="comment">* xxxCaretDestroy</span>
03407 <span class="comment">*</span>
03408 <span class="comment">* History:</span>
03409 <span class="comment">\***************************************************************************/</span>
03410 
<a name="l03411"></a><a class="code" href="../../d6/d0/usercli_8h.html#a696">03411</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a696">xxxCaretDestroy</a>(
03412     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb)
03413 {
03414     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
03415 
03416     <span class="comment">/*</span>
03417 <span class="comment">     * We're losing the focus.  Act like up clicks are happening so we release</span>
03418 <span class="comment">     * capture, set the current selection, notify the parent, etc.</span>
03419 <span class="comment">     */</span>
03420     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o25">fCaptured</a>)
03421 
03422         <span class="comment">/*</span>
03423 <span class="comment">         * If we have the capture and we lost the focus, that means we already</span>
03424 <span class="comment">         * changed the selection and we have to notify also the parent about</span>
03425 <span class="comment">         * this. So we need to add also the LBUP_SUCCESS flag in this case.</span>
03426 <span class="comment">         */</span>
03427 
03428         <a class="code" href="../../d6/d0/usercli_8h.html#a740">xxxLBButtonUp</a>(plb, <a class="code" href="../../d6/d0/usercli_8h.html#a118">LBUP_RELEASECAPTURE</a> | <a class="code" href="../../d6/d0/usercli_8h.html#a120">LBUP_NOTIFY</a> |
03429             (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o24">fMouseDown</a> ? <a class="code" href="../../d6/d0/usercli_8h.html#a121">LBUP_SUCCESS</a> : 0));
03430 
03431     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o29">fAddSelMode</a>) {
03432 
03433         <span class="comment">/*</span>
03434 <span class="comment">         * Switch off the Caret blinking</span>
03435 <span class="comment">         */</span>
03436         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a208">NtUserKillTimer</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a58">IDSYS_CARET</a>);
03437 
03438         <span class="comment">/*</span>
03439 <span class="comment">         * Make sure the caret goes away</span>
03440 <span class="comment">         */</span>
03441         <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03442         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o29">fAddSelMode</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03443     }
03444 
03445     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o26">fCaret</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03446 }
03447 
03448 
03449 <span class="comment">/***************************************************************************\</span>
03450 <span class="comment">* xxxLbSetSel</span>
03451 <span class="comment">*</span>
03452 <span class="comment">* History:</span>
03453 <span class="comment">\***************************************************************************/</span>
03454 
<a name="l03455"></a><a class="code" href="../../d6/d0/usercli_8h.html#a692">03455</a> LONG <a class="code" href="../../d6/d0/usercli_8h.html#a692">xxxLBSetSel</a>(
03456     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
03457     BOOL fSelect,  <span class="comment">/* New state to set selection to */</span>
03458     INT iSel)
03459 {
03460     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> sItem;
03461     RECT rc;
03462     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uEvent = 0;
03463 
03464     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
03465 
03466     <span class="comment">/*</span>
03467 <span class="comment">    * Bug 17656. WinZip's accelerator key for 'DeSelect All' sends a LB_SETSEL</span>
03468 <span class="comment">    * message with lparam = 0x0000ffff instead of 0xffffffff(-1). If iSel</span>
03469 <span class="comment">    * is equal to  0x0000ffff and there are less than 0xffff elements in the</span>
03470 <span class="comment">    * list we set iSel equal to 0xffffffff.</span>
03471 <span class="comment">    */</span>
03472     <span class="keywordflow">if</span> ((iSel == (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)0xffff) &amp;&amp; (iSel &gt;= plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>)) {
03473         iSel = -1;
03474         RIPMSG0(RIP_WARNING, <span class="stringliteral">"Sign extending iSel=0xffff to 0xffffffff"</span>);
03475     }
03476 
03477 
03478     <span class="keywordflow">if</span> ((plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a114">SINGLESEL</a>) || (iSel != -1 &amp;&amp; iSel &gt;= plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>)) {
03479         RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING,
03480                 <span class="stringliteral">"xxxLBSetSel:Invalid iSel or SINGLESEL listbox"</span>);
03481         <span class="keywordflow">return</span> LB_ERR;
03482     }
03483 
03484     <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03485 
03486     <span class="keywordflow">if</span> (iSel == -1<span class="comment">/*(INT)0xffff*/</span>) {
03487 
03488         <span class="comment">/*</span>
03489 <span class="comment">         * Set/clear selection from all items if -1</span>
03490 <span class="comment">         */</span>
03491         <span class="keywordflow">for</span> (sItem = 0; sItem &lt; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>; sItem++) {
03492             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a687">IsSelected</a>(plb, sItem, <a class="code" href="../../d6/d0/usercli_8h.html#a249">SELONLY</a>) != fSelect) {
03493                 <a class="code" href="../../d6/d0/usercli_8h.html#a694">SetSelected</a>(plb, sItem, fSelect, <a class="code" href="../../d6/d0/usercli_8h.html#a250">HILITEANDSEL</a>);
03494                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a744">LBGetItemRect</a>(plb, sItem, &amp;rc)) {
03495                     <a class="code" href="../../d6/d0/usercli_8h.html#a711">xxxLBInvalidateRect</a>(plb, &amp;rc, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03496                 }
03497             }
03498         }
03499         <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03500         uEvent = EVENT_OBJECT_SELECTIONWITHIN;
03501     } <span class="keywordflow">else</span> {
03502         <span class="keywordflow">if</span> (fSelect) {
03503 
03504             <span class="comment">/*</span>
03505 <span class="comment">             * Check if the item if fully hidden and scroll it into view if it</span>
03506 <span class="comment">             * is.  Note that we don't want to scroll partially visible items</span>
03507 <span class="comment">             * into full view because this breaks the shell...</span>
03508 <span class="comment">             */</span>
03509             <a class="code" href="../../d6/d0/usercli_8h.html#a716">xxxInsureVisible</a>(plb, iSel, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03510             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a> = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a> = iSel;
03511 
03512             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a> = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o53">iLastMouseMove</a> = iSel;
03513             uEvent = EVENT_OBJECT_FOCUS;
03514         } <span class="keywordflow">else</span> {
03515             uEvent = EVENT_OBJECT_SELECTIONREMOVE;
03516         }
03517         <a class="code" href="../../d6/d0/usercli_8h.html#a694">SetSelected</a>(plb, iSel, fSelect, <a class="code" href="../../d6/d0/usercli_8h.html#a250">HILITEANDSEL</a>);
03518 
03519         <span class="comment">/*</span>
03520 <span class="comment">         * Note that we set the caret on bit directly so that we avoid flicker</span>
03521 <span class="comment">         * when drawing this item.  ie.  We turn on the caret, redraw the item and</span>
03522 <span class="comment">         * turn it back on again.</span>
03523 <span class="comment">         */</span>
03524         <span class="keywordflow">if</span> (!fSelect &amp;&amp; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a> != iSel) {
03525             <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03526         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o26">fCaret</a>) {
03527             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o28">fCaretOn</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03528         }
03529 
03530         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a744">LBGetItemRect</a>(plb, iSel, &amp;rc)) {
03531             <a class="code" href="../../d6/d0/usercli_8h.html#a711">xxxLBInvalidateRect</a>(plb, &amp;rc, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03532         }
03533     }
03534 
03535     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>() &amp;&amp; <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a17">_IsWindowVisible</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>)) {
03536         <span class="keywordflow">if</span> (uEvent == EVENT_OBJECT_FOCUS) {
03537             <a class="code" href="../../d6/d0/usercli_8h.html#a409">LBEvent</a>(plb, uEvent, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>);
03538             uEvent = EVENT_OBJECT_SELECTION;
03539         }
03540         <a class="code" href="../../d6/d0/usercli_8h.html#a409">LBEvent</a>(plb, uEvent, iSel);
03541     }
03542 
03543     <span class="keywordflow">return</span> 0;
03544 }
03545 
03546 
03547 <span class="comment">/***************************************************************************\</span>
03548 <span class="comment">* xxxLBoxDrawItem</span>
03549 <span class="comment">*</span>
03550 <span class="comment">* This fills the draw item struct with some constant data for the given</span>
03551 <span class="comment">* item.  The caller will only have to modify a small part of this data</span>
03552 <span class="comment">* for specific needs.</span>
03553 <span class="comment">*</span>
03554 <span class="comment">* History:</span>
03555 <span class="comment">* 16-Apr-1992 beng      The NODATA case</span>
03556 <span class="comment">\***************************************************************************/</span>
03557 
<a name="l03558"></a><a class="code" href="../../d6/d0/usercli_8h.html#a701">03558</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a701">xxxLBoxDrawItem</a>(
03559     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
03560     INT item,
03561     UINT itemAction,
03562     UINT itemState,
03563     LPRECT lprect)
03564 {
03565     DRAWITEMSTRUCT dis;
03566     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndParent;
03567 
03568     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
03569 
03570     <span class="comment">/*</span>
03571 <span class="comment">     * Fill the DRAWITEMSTRUCT with the unchanging constants</span>
03572 <span class="comment">     */</span>
03573 
03574     dis.CtlType = ODT_LISTBOX;
03575     dis.CtlID = PtrToUlong(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>);
03576 
03577     <span class="comment">/*</span>
03578 <span class="comment">     * Use -1 if an invalid item number is being used.  This is so that the app</span>
03579 <span class="comment">     * can detect if it should draw the caret (which indicates the lb has the</span>
03580 <span class="comment">     * focus) in an empty listbox</span>
03581 <span class="comment">     */</span>
03582     dis.itemID = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(item &lt; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> ? item : -1);
03583     dis.itemAction = itemAction;
03584     dis.hwndItem = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
03585     dis.hDC = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o59">hdc</a>;
03586     dis.itemState = itemState |
03587             (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a651">WFDISABLED</a>) ? ODS_DISABLED : 0);
03588 
03589     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>, <a class="code" href="../../d1/d0/inc_2user_8h.html#a622">WEFPUIFOCUSHIDDEN</a>)) {
03590         dis.itemState |= ODS_NOFOCUSRECT;
03591     }
03592     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>, <a class="code" href="../../d1/d0/inc_2user_8h.html#a623">WEFPUIACCELHIDDEN</a>)) {
03593         dis.itemState |= ODS_NOACCEL;
03594     }
03595 
03596     <span class="comment">/*</span>
03597 <span class="comment">     * Set the app supplied data</span>
03598 <span class="comment">     */</span>
03599     <span class="keywordflow">if</span> (!plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> || !plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o31">fHasData</a>) {
03600 
03601         <span class="comment">/*</span>
03602 <span class="comment">         * If no strings or no items, just use 0 for data.  This is so that we</span>
03603 <span class="comment">         * can display a caret when there are no items in the listbox.</span>
03604 <span class="comment">         *</span>
03605 <span class="comment">         * Lazy-eval listboxes of course have no data to pass - only itemID.</span>
03606 <span class="comment">         */</span>
03607         dis.itemData = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
03608     } <span class="keywordflow">else</span> {
03609         dis.itemData = <a class="code" href="../../d6/d0/usercli_8h.html#a721">LBGetItemData</a>(plb, item);
03610     }
03611 
03612     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;dis.rcItem, lprect);
03613 
03614     <span class="comment">/*</span>
03615 <span class="comment">     * Set the window origin to the horizontal scroll position.  This is so that</span>
03616 <span class="comment">     * text can always be drawn at 0,0 and the view region will only start at</span>
03617 <span class="comment">     * the horizontal scroll offset. We pass this as wParam</span>
03618 <span class="comment">     */</span>
03619     <span class="comment">/*</span>
03620 <span class="comment">     * Note:  Only pass the itemID in wParam for 3.1 or newer apps.  We break</span>
03621 <span class="comment">     * ccMail otherwise.</span>
03622 <span class="comment">     */</span>
03623 
03624     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o0">spwndParent</a>, &amp;tlpwndParent);
03625     <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o0">spwndParent</a>), WM_DRAWITEM,
03626             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o0">spwndParent</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a592">WFWIN31COMPAT</a>) ? dis.CtlID : 0,
03627             (LPARAM)&amp;dis);
03628     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndParent);
03629 }
03630 
03631 
03632 <span class="comment">/***************************************************************************\</span>
03633 <span class="comment">* xxxLBBlockHilite</span>
03634 <span class="comment">*</span>
03635 <span class="comment">*       In Extended selection mode for multiselection listboxes, when</span>
03636 <span class="comment">*   mouse is draged to a new position, the range being marked should be</span>
03637 <span class="comment">*   properly sized(parts of which will be highlighted/dehighlighted).</span>
03638 <span class="comment">*   NOTE: This routine assumes that iSelFromPt and LasMouseMove are not</span>
03639 <span class="comment">*          equal because only in that case this needs to be called;</span>
03640 <span class="comment">*   NOTE: This routine calculates the region whose display attribute is to</span>
03641 <span class="comment">*          be changed in an optimised way. Instead of de-highlighting the</span>
03642 <span class="comment">*          the old range completely and highlight the new range, it omits</span>
03643 <span class="comment">*          the regions that overlap and repaints only the non-pverlapping</span>
03644 <span class="comment">*          area.</span>
03645 <span class="comment">*   fKeyBoard = TRUE if this is called for Keyboard interface</span>
03646 <span class="comment">*                FALSE if called from Mouse interface routines</span>
03647 <span class="comment">*</span>
03648 <span class="comment">* History:</span>
03649 <span class="comment">\***************************************************************************/</span>
03650 
<a name="l03651"></a><a class="code" href="../../d6/d0/usercli_8h.html#a718">03651</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a718">xxxLBBlockHilite</a>(
03652     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
03653     INT iSelFromPt,
03654     BOOL fKeyBoard)
03655 {
03656     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> sCurPosOffset;
03657     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> sLastPosOffset;
03658     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> sHiliteOrSel;
03659     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fUseSelStatus;
03660     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> DeHiliteStatus;
03661 
03662     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
03663 
03664     <span class="keywordflow">if</span> (fKeyBoard) {
03665 
03666         <span class="comment">/*</span>
03667 <span class="comment">         * Set both Hilite and Selection states</span>
03668 <span class="comment">         */</span>
03669         sHiliteOrSel = <a class="code" href="../../d6/d0/usercli_8h.html#a250">HILITEANDSEL</a>;
03670 
03671         <span class="comment">/*</span>
03672 <span class="comment">         * Do not use the Selection state while de-hiliting</span>
03673 <span class="comment">         */</span>
03674         fUseSelStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03675         DeHiliteStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03676     } <span class="keywordflow">else</span> {
03677 
03678         <span class="comment">/*</span>
03679 <span class="comment">         * Set/Reset only the Hilite state</span>
03680 <span class="comment">         */</span>
03681         sHiliteOrSel = <a class="code" href="../../d6/d0/usercli_8h.html#a248">HILITEONLY</a>;
03682 
03683         <span class="comment">/*</span>
03684 <span class="comment">         * Use the selection state for de-hilighting</span>
03685 <span class="comment">         */</span>
03686         fUseSelStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03687         DeHiliteStatus = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o32">fNewItemState</a>;
03688     }
03689 
03690 
03691 
03692     <span class="comment">/*</span>
03693 <span class="comment">     * The idea of the routine is to :</span>
03694 <span class="comment">     *          1.  De-hilite the old range (iMouseDown to iLastMouseDown)  and</span>
03695 <span class="comment">     *          2.  Hilite the new range (iMouseDwon to iSelFromPt)</span>
03696 <span class="comment">     */</span>
03697 
03698     <span class="comment">/*</span>
03699 <span class="comment">     * Offset of current mouse position from the anchor point</span>
03700 <span class="comment">     */</span>
03701     sCurPosOffset = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a> - iSelFromPt;
03702 
03703     <span class="comment">/*</span>
03704 <span class="comment">     * Offset of last mouse position from the anchor point</span>
03705 <span class="comment">     */</span>
03706     sLastPosOffset = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a> - plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o53">iLastMouseMove</a>;
03707 
03708     <span class="comment">/*</span>
03709 <span class="comment">     * Check if both current position and last position lie on the same</span>
03710 <span class="comment">     * side of the anchor point.</span>
03711 <span class="comment">     */</span>
03712     <span class="keywordflow">if</span> ((sCurPosOffset * sLastPosOffset) &gt;= 0) {
03713 
03714         <span class="comment">/*</span>
03715 <span class="comment">         * Yes they are on the same side; So, highlight/dehighlight only</span>
03716 <span class="comment">         * the difference.</span>
03717 <span class="comment">         */</span>
03718         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a259">abs</a>(sCurPosOffset) &gt; <a class="code" href="../../d4/d1/userk_8h.html#a259">abs</a>(sLastPosOffset)) {
03719             <a class="code" href="../../d6/d0/usercli_8h.html#a712">xxxAlterHilite</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o53">iLastMouseMove</a>, iSelFromPt,
03720                     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o32">fNewItemState</a>, sHiliteOrSel, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03721         } <span class="keywordflow">else</span> {
03722             <a class="code" href="../../d6/d0/usercli_8h.html#a712">xxxAlterHilite</a>(plb, iSelFromPt, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o53">iLastMouseMove</a>, DeHiliteStatus,
03723                     sHiliteOrSel, fUseSelStatus);
03724         }
03725     } <span class="keywordflow">else</span> {
03726         <a class="code" href="../../d6/d0/usercli_8h.html#a712">xxxAlterHilite</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a>, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o53">iLastMouseMove</a>,
03727                 DeHiliteStatus, sHiliteOrSel, fUseSelStatus);
03728         <a class="code" href="../../d6/d0/usercli_8h.html#a712">xxxAlterHilite</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a>, iSelFromPt,
03729                 plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o32">fNewItemState</a>, sHiliteOrSel, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03730     }
03731 }
03732 
03733 
03734 <span class="comment">/***************************************************************************\</span>
03735 <span class="comment">* xxxAlterHilite</span>
03736 <span class="comment">*</span>
03737 <span class="comment">* Changes the hilite state of (i..j] (ie. excludes i, includes j in case</span>
03738 <span class="comment">* you've forgotten this silly notation) to fHilite. It inverts this changes</span>
03739 <span class="comment">* the hilite state.</span>
03740 <span class="comment">*</span>
03741 <span class="comment">*  OpFlags:  HILITEONLY      Only change the display state of the items</span>
03742 <span class="comment">*            SELONLY         Only Change the selection state of the items</span>
03743 <span class="comment">*            HILITEANDSELECT Do both.</span>
03744 <span class="comment">*  fHilite:</span>
03745 <span class="comment">*            HILITE/TRUE</span>
03746 <span class="comment">*            DEHILITE/FALSE</span>
03747 <span class="comment">*  fSelStatus:</span>
03748 <span class="comment">*            if TRUE, use the selection state of the item to hilite/dehilite</span>
03749 <span class="comment">*            if FALSE, use the fHilite parameter to hilite/dehilite</span>
03750 <span class="comment">*</span>
03751 <span class="comment">* History:</span>
03752 <span class="comment">\***************************************************************************/</span>
03753 
<a name="l03754"></a><a class="code" href="../../d6/d0/usercli_8h.html#a712">03754</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a712">xxxAlterHilite</a>(
03755     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
03756     INT i,
03757     INT j,
03758     BOOL fHilite,
03759     INT OpFlags,
03760     BOOL fSelStatus)
03761 {
03762     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> <a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a>;
03763     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> <a class="code" href="../../d2/d3/fetypes_8h.html#a457a417">high</a>;
03764     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> sLastInWindow;
03765     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fCaretOn;
03766     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSelected;
03767 
03768     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
03769 
03770     sLastInWindow = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a> + <a class="code" href="../../d6/d0/usercli_8h.html#a713">CItemInWindow</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03771     sLastInWindow = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(sLastInWindow, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> - 1);
03772     <a class="code" href="../../d2/d3/fetypes_8h.html#a457a417">high</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(i, j) + 1;
03773 
03774     <span class="keywordflow">if</span> (fCaretOn = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o28">fCaretOn</a>) {
03775         <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03776     }
03777 
03778     <span class="keywordflow">for</span> (<a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a> = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(i, j); <a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a> &lt; <a class="code" href="../../d2/d3/fetypes_8h.html#a457a417">high</a>; <a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a>++) {
03779         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a> != i) {
03780             <span class="keywordflow">if</span> (OpFlags &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a248">HILITEONLY</a>) {
03781                 <span class="keywordflow">if</span> (fSelStatus) {
03782                     fSelected = <a class="code" href="../../d6/d0/usercli_8h.html#a687">IsSelected</a>(plb, <a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a>, <a class="code" href="../../d6/d0/usercli_8h.html#a249">SELONLY</a>);
03783                 } <span class="keywordflow">else</span> {
03784                     fSelected = fHilite;
03785                 }
03786                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a687">IsSelected</a>(plb, <a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a>, <a class="code" href="../../d6/d0/usercli_8h.html#a248">HILITEONLY</a>) != fSelected) {
03787                     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a> &lt;= <a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a> &amp;&amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a> &lt;= sLastInWindow) {
03788 
03789                         <span class="comment">/*</span>
03790 <span class="comment">                         * Invert the item only if it is visible</span>
03791 <span class="comment">                         */</span>
03792                         <a class="code" href="../../d6/d0/usercli_8h.html#a717">xxxInvertLBItem</a>(plb, <a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a>, fSelected);
03793                     }
03794                     <a class="code" href="../../d6/d0/usercli_8h.html#a694">SetSelected</a>(plb, <a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a>, fSelected, <a class="code" href="../../d6/d0/usercli_8h.html#a248">HILITEONLY</a>);
03795                 }
03796             }
03797 
03798             <span class="keywordflow">if</span> (OpFlags &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a249">SELONLY</a>) {
03799                 <a class="code" href="../../d6/d0/usercli_8h.html#a694">SetSelected</a>(plb, <a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a>, fHilite, <a class="code" href="../../d6/d0/usercli_8h.html#a249">SELONLY</a>);
03800             }
03801         }
03802     }
03803 
03804     <span class="keywordflow">if</span> (fCaretOn) {
03805         <a class="code" href="../../d6/d0/usercli_8h.html#a695">xxxLBSetCaret</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03806     }
03807 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:36 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
