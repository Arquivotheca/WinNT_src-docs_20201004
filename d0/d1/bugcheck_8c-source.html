<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: bugcheck.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>bugcheck.c</h1><a href="../../d9/d1/bugcheck_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989-1993  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    stubs.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements bug check and system shutdown code.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Mark Lucovsky (markl) 30-Aug-1990</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Kernel mode only.</span>
00020 <span class="comment"></span>
00021 <span class="comment">Revision History:</span>
00022 <span class="comment"></span>
00023 <span class="comment">--*/</span>
00024 
00025 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
<a name="l00026"></a><a class="code" href="../../d9/d1/bugcheck_8c.html#a0">00026</a> <span class="preprocessor">#define NOEXTAPI</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#include "wdbgexts.h"</span>
00028 <span class="preprocessor">#include &lt;<a class="code" href="../../d0/d1/inbv_8h.html">inbv.h</a>&gt;</span>
00029 
00030 <span class="comment">//</span>
00031 <span class="comment">//</span>
00032 <span class="comment">//</span>
00033 
<a name="l00034"></a><a class="code" href="../../d9/d1/bugcheck_8c.html#a2">00034</a> <span class="keyword">extern</span> KDDEBUGGER_DATA64 <a class="code" href="../../d8/d5/kddata_8c.html#a50">KdDebuggerDataBlock</a>;
00035 
<a name="l00036"></a><a class="code" href="../../d9/d1/bugcheck_8c.html#a3">00036</a> <span class="keyword">extern</span> PVOID <a class="code" href="../../d9/d1/bugcheck_8c.html#a3">ExPoolCodeStart</a>;
<a name="l00037"></a><a class="code" href="../../d9/d1/bugcheck_8c.html#a4">00037</a> <span class="keyword">extern</span> PVOID <a class="code" href="../../d9/d1/bugcheck_8c.html#a4">ExPoolCodeEnd</a>;
<a name="l00038"></a><a class="code" href="../../d9/d1/bugcheck_8c.html#a5">00038</a> <span class="keyword">extern</span> PVOID <a class="code" href="../../d9/d1/bugcheck_8c.html#a5">MmPoolCodeStart</a>;
<a name="l00039"></a><a class="code" href="../../d9/d1/bugcheck_8c.html#a6">00039</a> <span class="keyword">extern</span> PVOID <a class="code" href="../../d9/d1/bugcheck_8c.html#a6">MmPoolCodeEnd</a>;
<a name="l00040"></a><a class="code" href="../../d9/d1/bugcheck_8c.html#a7">00040</a> <span class="keyword">extern</span> PVOID <a class="code" href="../../d9/d1/bugcheck_8c.html#a7">MmPteCodeStart</a>;
<a name="l00041"></a><a class="code" href="../../d9/d1/bugcheck_8c.html#a8">00041</a> <span class="keyword">extern</span> PVOID <a class="code" href="../../d9/d1/bugcheck_8c.html#a8">MmPteCodeEnd</a>;
00042 
00043 <span class="preprocessor">#if defined (i386)</span>
00044 <span class="preprocessor"></span><span class="preprocessor">#define PROGRAM_COUNTER(_trapframe)   ((_trapframe)-&gt;Eip)</span>
00045 <span class="preprocessor"></span><span class="preprocessor">#elif defined (ALPHA)</span>
00046 <span class="preprocessor"></span><span class="preprocessor">#define PROGRAM_COUNTER(_trapframe)   ((_trapframe)-&gt;Fir)</span>
00047 <span class="preprocessor"></span><span class="preprocessor">#elif defined (_IA64_)</span>
00048 <span class="preprocessor"></span><span class="preprocessor">#define PROGRAM_COUNTER(_trapframe)   ((_trapframe)-&gt;StIIP)</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#error ("unknown processor type")</span>
00051 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00052 <span class="preprocessor"></span>
00053 <span class="comment">//</span>
00054 <span class="comment">// Define forward referenced prototypes.</span>
00055 <span class="comment">//</span>
00056 
00057 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00058 <a class="code" href="../../d9/d1/bugcheck_8c.html#a12">KiScanBugCheckCallbackList</a> (
00059     VOID
00060     );
00061 
00062 <span class="comment">//</span>
00063 <span class="comment">// Define bug count recursion counter and a context buffer.</span>
00064 <span class="comment">//</span>
00065 
<a name="l00066"></a><a class="code" href="../../d9/d1/bugcheck_8c.html#a9">00066</a> ULONG <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a3">KeBugCheckCount</a> = 1;
00067 
00068 
00069 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00070"></a><a class="code" href="../../d9/d1/bugcheck_8c.html#a13">00070</a> <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a> (
00071     IN ULONG BugCheckCode
00072     )
00073 
00074 <span class="comment">/*++</span>
00075 <span class="comment"></span>
00076 <span class="comment">Routine Description:</span>
00077 <span class="comment"></span>
00078 <span class="comment">    This function crashes the system in a controlled manner.</span>
00079 <span class="comment"></span>
00080 <span class="comment">Arguments:</span>
00081 <span class="comment"></span>
00082 <span class="comment">    BugCheckCode - Supplies the reason for the bug check.</span>
00083 <span class="comment"></span>
00084 <span class="comment">Return Value:</span>
00085 <span class="comment"></span>
00086 <span class="comment">    None.</span>
00087 <span class="comment"></span>
00088 <span class="comment">--*/</span>
00089 {
00090     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(BugCheckCode,0,0,0,0);
00091 }
00092 
<a name="l00093"></a><a class="code" href="../../d9/d1/bugcheck_8c.html#a10">00093</a> ULONG_PTR <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a2">KiBugCheckData</a>[5];
<a name="l00094"></a><a class="code" href="../../d9/d1/bugcheck_8c.html#a11">00094</a> PUNICODE_STRING <a class="code" href="../../d9/d1/bugcheck_8c.html#a11">KiBugCheckDriver</a>;
00095 
00096 BOOLEAN
<a name="l00097"></a><a class="code" href="../../d9/d1/bugcheck_8c.html#a14">00097</a> <a class="code" href="../../d9/d1/bugcheck_8c.html#a14">KeGetBugMessageText</a>(
00098     IN ULONG MessageId,
00099     IN PANSI_STRING ReturnedString OPTIONAL
00100     )
00101 {
00102     ULONG   i;
00103     PUCHAR  s;
00104     PMESSAGE_RESOURCE_BLOCK MessageBlock;
00105     PUCHAR <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00106     BOOLEAN Result;
00107 
00108     Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00109     <span class="keywordflow">try</span> {
00110         <span class="keywordflow">if</span> (KiBugCodeMessages != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00111             <a class="code" href="../../d8/d8/sysload_8c.html#a65">MmMakeKernelResourceSectionWritable</a> ();
00112             MessageBlock = &amp;KiBugCodeMessages-&gt;Blocks[0];
00113             <span class="keywordflow">for</span> (i = KiBugCodeMessages-&gt;NumberOfBlocks; i; i -= 1) {
00114                 <span class="keywordflow">if</span> (MessageId &gt;= MessageBlock-&gt;LowId &amp;&amp;
00115                     MessageId &lt;= MessageBlock-&gt;HighId) {
00116 
00117                     s = (PCHAR)KiBugCodeMessages + MessageBlock-&gt;OffsetToEntries;
00118                     <span class="keywordflow">for</span> (i = MessageId - MessageBlock-&gt;LowId; i; i -= 1) {
00119                         s += ((PMESSAGE_RESOURCE_ENTRY)s)-&gt;Length;
00120                     }
00121 
00122                     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = ((PMESSAGE_RESOURCE_ENTRY)s)-&gt;Text;
00123 
00124                     i = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) - 1;
00125                     <span class="keywordflow">while</span> (i &gt; 0 &amp;&amp; (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[i] == <span class="charliteral">'\n'</span>  ||
00126                                      <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[i] == <span class="charliteral">'\r'</span>  ||
00127                                      <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[i] == 0
00128                                     )
00129                           ) {
00130                         <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( ReturnedString )) {
00131                             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[i] = 0;
00132                         }
00133                         i -= 1;
00134                     }
00135 
00136                     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( ReturnedString )) {
00137                         <a class="code" href="../../d0/d1/inbv_8h.html#a9">InbvDisplayString</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00138                         }
00139                     <span class="keywordflow">else</span> {
00140                         ReturnedString-&gt;Buffer = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00141                         ReturnedString-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(i+1);
00142                         ReturnedString-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(i+1);
00143                     }
00144                     Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00145                     <span class="keywordflow">break</span>;
00146                 }
00147                 MessageBlock += 1;
00148             }
00149         }
00150     } except ( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00151         ;
00152     }
00153 
00154     <span class="keywordflow">return</span> Result;
00155 }
00156 
00157 
00158 
00159 PCHAR
<a name="l00160"></a><a class="code" href="../../d9/d1/bugcheck_8c.html#a15">00160</a> <a class="code" href="../../d9/d1/bugcheck_8c.html#a15">KeBugCheckUnicodeToAnsi</a>(
00161     IN PUNICODE_STRING UnicodeString,
00162     OUT PCHAR AnsiBuffer,
00163     IN ULONG MaxAnsiLength
00164     )
00165 {
00166     PCHAR Dst;
00167     PWSTR Src;
00168     ULONG Length;
00169 
00170     Length = UnicodeString-&gt;Length / <span class="keyword">sizeof</span>( WCHAR );
00171     <span class="keywordflow">if</span> (Length &gt;= MaxAnsiLength) {
00172         Length = MaxAnsiLength - 1;
00173         }
00174     Src = UnicodeString-&gt;Buffer;
00175     Dst = AnsiBuffer;
00176     <span class="keywordflow">while</span> (Length--) {
00177         *Dst++ = (UCHAR)*Src++;
00178         }
00179     *Dst = <span class="charliteral">'\0'</span>;
00180     <span class="keywordflow">return</span> AnsiBuffer;
00181 }
00182 
00183 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00184"></a><a class="code" href="../../d9/d1/bugcheck_8c.html#a16">00184</a> <a class="code" href="../../d9/d1/bugcheck_8c.html#a16">KiBugCheckDebugBreak</a> (
00185     IN ULONG    BreakStatus
00186     )
00187 {
00188     <span class="keywordflow">do</span> {
00189         <span class="keywordflow">try</span> {
00190 
00191             <span class="comment">//</span>
00192             <span class="comment">// Issue a breakpoint</span>
00193             <span class="comment">//</span>
00194 
00195             DbgBreakPointWithStatus (BreakStatus);
00196 
00197         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00198 
00199             <span class="comment">//</span>
00200             <span class="comment">// Failure to issue breakpoint, halt the system</span>
00201             <span class="comment">//</span>
00202 
00203             <span class="keywordflow">try</span> {
00204 
00205                 <a class="code" href="../../d2/d7/hal_8h.html#a43">HalHaltSystem</a>();
00206 
00207             } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00208 
00209                 <span class="keywordflow">for</span> (;;) {
00210                 }
00211             }
00212 
00213             <span class="keywordflow">for</span> (;;) {
00214             }
00215         }
00216     } <span class="keywordflow">while</span> (BreakStatus != DBG_STATUS_BUGCHECK_FIRST);
00217 }
00218 
00219 PVOID
<a name="l00220"></a><a class="code" href="../../d9/d1/bugcheck_8c.html#a17">00220</a> <a class="code" href="../../d8/d0/ppc_2dmpstate_8c.html#a4">KiPcToFileHeader</a>(
00221     IN PVOID PcValue,
00222     OUT PLDR_DATA_TABLE_ENTRY *DataTableEntry,
00223     IN LOGICAL DriversOnly,
00224     OUT PBOOLEAN InKernelOrHal
00225     )
00226 
00227 <span class="comment">/*++</span>
00228 <span class="comment"></span>
00229 <span class="comment">Routine Description:</span>
00230 <span class="comment"></span>
00231 <span class="comment">    This function returns the base of an image that contains the</span>
00232 <span class="comment">    specified PcValue. An image contains the PcValue if the PcValue</span>
00233 <span class="comment">    is within the ImageBase, and the ImageBase plus the size of the</span>
00234 <span class="comment">    virtual image.</span>
00235 <span class="comment"></span>
00236 <span class="comment">Arguments:</span>
00237 <span class="comment"></span>
00238 <span class="comment">    PcValue - Supplies a PcValue.</span>
00239 <span class="comment"></span>
00240 <span class="comment">    DataTableEntry - Supplies a pointer to a variable that receives the</span>
00241 <span class="comment">        address of the data table entry that describes the image.</span>
00242 <span class="comment"></span>
00243 <span class="comment">    DriversOnly - Supplies TRUE if the kernel and HAL should be skipped.</span>
00244 <span class="comment"></span>
00245 <span class="comment">    InKernelOrHal - Set to TRUE if the PcValue is in the kernel or the HAL.</span>
00246 <span class="comment">        This only has meaning if DriversOnly is FALSE.</span>
00247 <span class="comment"></span>
00248 <span class="comment">Return Value:</span>
00249 <span class="comment"></span>
00250 <span class="comment">    NULL - No image was found that contains the PcValue.</span>
00251 <span class="comment"></span>
00252 <span class="comment">    NON-NULL - Returns the base address of the image that contains the</span>
00253 <span class="comment">        PcValue.</span>
00254 <span class="comment"></span>
00255 <span class="comment">--*/</span>
00256 
00257 {
00258     ULONG i;
00259     PLIST_ENTRY ModuleListHead;
00260     PLDR_DATA_TABLE_ENTRY Entry;
00261     PLIST_ENTRY Next;
00262     ULONG_PTR Bounds;
00263     PVOID ReturnBase, Base;
00264 
00265     <span class="comment">//</span>
00266     <span class="comment">// If the module list has been initialized, then scan the list to</span>
00267     <span class="comment">// locate the appropriate entry.</span>
00268     <span class="comment">//</span>
00269 
00270     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a130">KeLoaderBlock</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00271         ModuleListHead = &amp;<a class="code" href="../../d4/d9/ke_8h.html#a130">KeLoaderBlock</a>-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o0">LoadOrderListHead</a>;
00272 
00273     } <span class="keywordflow">else</span> {
00274         ModuleListHead = &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>;
00275     }
00276 
00277     *InKernelOrHal = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00278 
00279     ReturnBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00280     Next = ModuleListHead-&gt;Flink;
00281     <span class="keywordflow">if</span> (Next != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00282         i = 0;
00283         <span class="keywordflow">while</span> (Next != ModuleListHead) {
00284             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/ppc_2debugsup_8c.html#a0">MmDbgReadCheck</a>(Next) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00285                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00286             }
00287             i += 1;
00288             <span class="keywordflow">if</span> ((i &lt;= 2) &amp;&amp; (DriversOnly == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00289                 Next = Next-&gt;Flink;
00290                 <span class="keywordflow">continue</span>;
00291             }
00292 
00293             Entry = CONTAINING_RECORD(Next,
00294                                       LDR_DATA_TABLE_ENTRY,
00295                                       InLoadOrderLinks);
00296 
00297             Next = Next-&gt;Flink;
00298             Base = Entry-&gt;DllBase;
00299             Bounds = (ULONG_PTR)Base + Entry-&gt;SizeOfImage;
00300             <span class="keywordflow">if</span> ((ULONG_PTR)PcValue &gt;= (ULONG_PTR)Base &amp;&amp; (ULONG_PTR)PcValue &lt; Bounds) {
00301                 *DataTableEntry = Entry;
00302                 ReturnBase = Base;
00303                 <span class="keywordflow">if</span> (i &lt;= 2) {
00304                     *InKernelOrHal = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00305                 }
00306                 <span class="keywordflow">break</span>;
00307             }
00308         }
00309     }
00310 
00311     <span class="keywordflow">return</span> ReturnBase;
00312 }
00313 
00314 
00315 
00316 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00317"></a><a class="code" href="../../d9/d1/bugcheck_8c.html#a18">00317</a> <a class="code" href="../../d9/d1/bugcheck_8c.html#a18">KiDumpParameterImages</a>(
00318     IN PCHAR Buffer,
00319     IN PULONG_PTR BugCheckParameters,
00320     IN ULONG NumberOfParameters,
00321     IN <a class="code" href="../../d4/d9/ke_8h.html#a116">PKE_BUGCHECK_UNICODE_TO_ANSI</a> UnicodeToAnsiRoutine
00322     )
00323 
00324 <span class="comment">/*++</span>
00325 <span class="comment"></span>
00326 <span class="comment">Routine Description:</span>
00327 <span class="comment"></span>
00328 <span class="comment">    This function formats and displays the image names of boogcheck parameters</span>
00329 <span class="comment">    that happen to match an address in an image.</span>
00330 <span class="comment"></span>
00331 <span class="comment">Arguments:</span>
00332 <span class="comment"></span>
00333 <span class="comment">    Buffer - Supplies a pointer to a buffer to be used to output machine</span>
00334 <span class="comment">        state information.</span>
00335 <span class="comment"></span>
00336 <span class="comment">    BugCheckParameters - Supplies additional bugcheck information.</span>
00337 <span class="comment"></span>
00338 <span class="comment">    NumberOfParameters - sizeof BugCheckParameters array.</span>
00339 <span class="comment"></span>
00340 <span class="comment">    UnicodeToAnsiRoutine - Supplies a pointer to a routine to convert Unicode</span>
00341 <span class="comment">        strings to Ansi strings without touching paged translation tables.</span>
00342 <span class="comment"></span>
00343 <span class="comment">Return Value:</span>
00344 <span class="comment"></span>
00345 <span class="comment">    None.</span>
00346 <span class="comment"></span>
00347 <span class="comment">--*/</span>
00348 
00349 {
00350     PUNICODE_STRING BugCheckDriver;
00351     PLIST_ENTRY ModuleListHead;
00352     PLIST_ENTRY Next;
00353     ULONG i;
00354     PLDR_DATA_TABLE_ENTRY DataTableEntry;
00355     PVOID ImageBase;
00356     UCHAR AnsiBuffer[ 32 ];
00357     ULONG DateStamp;
00358     PIMAGE_NT_HEADERS NtHeaders;
00359     BOOLEAN <a class="code" href="../../d2/d2/ex_2pool_8c.html#a41">FirstPrint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00360     BOOLEAN InKernelOrHal;
00361 
00362     <span class="comment">//</span>
00363     <span class="comment">// At this point the context record contains the machine state at the</span>
00364     <span class="comment">// call to bug check.</span>
00365     <span class="comment">//</span>
00366     <span class="comment">// Put out the system version and the title line with the PSR and FSR.</span>
00367     <span class="comment">//</span>
00368 
00369     <span class="comment">//</span>
00370     <span class="comment">// Check to see if any BugCheckParameters are valid code addresses.</span>
00371     <span class="comment">// If so, print them for the user.</span>
00372     <span class="comment">//</span>
00373 
00374     <span class="keywordflow">for</span> (i = 0; i &lt; NumberOfParameters; i += 1) {
00375         ImageBase = <a class="code" href="../../d8/d0/ppc_2dmpstate_8c.html#a4">KiPcToFileHeader</a>((PVOID) BugCheckParameters[i],
00376                                      &amp;DataTableEntry,
00377                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00378                                      &amp;InKernelOrHal);
00379         <span class="keywordflow">if</span> (ImageBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00380             BugCheckDriver = <a class="code" href="../../d8/d8/sysload_8c.html#a58">MmLocateUnloadedDriver</a> ((PVOID)BugCheckParameters[i]);
00381             <span class="keywordflow">if</span> (BugCheckDriver == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00382                 <span class="keywordflow">continue</span>;
00383             }
00384             ImageBase = (PVOID)BugCheckParameters[i];
00385             DateStamp = 0;
00386             (*UnicodeToAnsiRoutine) (BugCheckDriver,
00387                                      AnsiBuffer,
00388                                      <span class="keyword">sizeof</span> (AnsiBuffer));
00389         }
00390         <span class="keywordflow">else</span> {
00391             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/ppc_2debugsup_8c.html#a0">MmDbgReadCheck</a>(DataTableEntry-&gt;DllBase) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00392 
00393                 NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(DataTableEntry-&gt;DllBase);
00394                 DateStamp = NtHeaders-&gt;FileHeader.TimeDateStamp;
00395 
00396             } <span class="keywordflow">else</span> {
00397                 DateStamp = 0;
00398             }
00399             (*UnicodeToAnsiRoutine)( &amp;DataTableEntry-&gt;BaseDllName,
00400                                      AnsiBuffer,
00401                                      <span class="keyword">sizeof</span>( AnsiBuffer ));
00402         }
00403 
00404         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <span class="stringliteral">"%s** Address %p base at %p, DateStamp %08lx - %-12.12s\n"</span>,
00405             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a41">FirstPrint</a> ? <span class="stringliteral">"\n*"</span>:<span class="stringliteral">"*"</span>,
00406                 BugCheckParameters[i],
00407                 ImageBase,
00408                 DateStamp,
00409                 AnsiBuffer);
00410 
00411         <a class="code" href="../../d0/d1/inbv_8h.html#a9">InbvDisplayString</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00412         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a41">FirstPrint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00413     }
00414 
00415     <span class="keywordflow">return</span>;
00416 }
00417 
00418 <span class="comment">//</span>
00419 <span class="comment">// MessageId: POWER_FAILURE_SIMULATE</span>
00420 <span class="comment">//</span>
00421 <span class="comment">// MessageText:</span>
00422 <span class="comment">//</span>
00423 <span class="comment">//  POWER_FAILURE_SIMULATE</span>
00424 <span class="comment">//</span>
<a name="l00425"></a><a class="code" href="../../d9/d1/bugcheck_8c.html#a1">00425</a> <span class="preprocessor">#define POWER_FAILURE_SIMULATE           ((ULONG)0x000000E5L)</span>
00426 <span class="preprocessor"></span>
00427 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00428"></a><a class="code" href="../../d9/d1/bugcheck_8c.html#a19">00428</a> <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (
00429     IN ULONG BugCheckCode,
00430     IN ULONG_PTR BugCheckParameter1,
00431     IN ULONG_PTR BugCheckParameter2,
00432     IN ULONG_PTR BugCheckParameter3,
00433     IN ULONG_PTR BugCheckParameter4
00434     )
00435 
00436 <span class="comment">/*++</span>
00437 <span class="comment"></span>
00438 <span class="comment">Routine Description:</span>
00439 <span class="comment"></span>
00440 <span class="comment">    This function crashes the system in a controlled manner.</span>
00441 <span class="comment"></span>
00442 <span class="comment">Arguments:</span>
00443 <span class="comment"></span>
00444 <span class="comment">    BugCheckCode - Supplies the reason for the bug check.</span>
00445 <span class="comment"></span>
00446 <span class="comment">    BugCheckParameter1-4 - Supplies additional bug check information</span>
00447 <span class="comment"></span>
00448 <span class="comment">Return Value:</span>
00449 <span class="comment"></span>
00450 <span class="comment">    None.</span>
00451 <span class="comment"></span>
00452 <span class="comment">--*/</span>
00453 
00454 {
00455     UCHAR <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[100];
00456     ULONG_PTR BugCheckParameters[4];
00457     CONTEXT ContextSave;
00458     ULONG PssMessage;
00459     PCHAR HardErrorCaption;
00460     PCHAR HardErrorMessage;
00461     KIRQL OldIrql;
00462     PKTRAP_FRAME TrapInformation;
00463     PVOID ExecutionAddress;
00464     PVOID ImageBase;
00465     PVOID VirtualAddress;
00466     PLDR_DATA_TABLE_ENTRY DataTableEntry;
00467     UCHAR AnsiBuffer[32];
00468     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00469     BOOLEAN InKernelOrHal;
00470     BOOLEAN DontCare;
00471 
00472 <span class="preprocessor">#if !defined(NT_UP)</span>
00473 <span class="preprocessor"></span>
00474     ULONG TargetSet;
00475 
00476 <span class="preprocessor">#endif</span>
00477 <span class="preprocessor"></span>    BOOLEAN hardErrorCalled;
00478 
00479     <span class="comment">//</span>
00480     <span class="comment">// Try to simulate a power failure for Cluster testing</span>
00481     <span class="comment">//</span>
00482 
00483     <span class="keywordflow">if</span> (BugCheckCode == <a class="code" href="../../d9/d1/bugcheck_8c.html#a1">POWER_FAILURE_SIMULATE</a>) {
00484         <a class="code" href="../../d9/d1/bugcheck_8c.html#a12">KiScanBugCheckCallbackList</a>();
00485         <a class="code" href="../../d2/d7/hal_8h.html#a177">HalReturnToFirmware</a>(<a class="code" href="../../d4/d9/ke_8h.html#a411a244">HalRebootRoutine</a>);
00486     }
00487 
00488     <span class="comment">//</span>
00489     <span class="comment">// Capture the callers context as closely as possible into the debugger's</span>
00490     <span class="comment">// processor state area of the Prcb.</span>
00491     <span class="comment">//</span>
00492     <span class="comment">// N.B. There may be some prologue code that shuffles registers such that</span>
00493     <span class="comment">//      they get destroyed.</span>
00494     <span class="comment">//</span>
00495 
00496 <span class="preprocessor">#if defined(i386)</span>
00497 <span class="preprocessor"></span>    KiSetHardwareTrigger();
00498 <span class="preprocessor">#else</span>
00499 <span class="preprocessor"></span>    <a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a12">KiHardwareTrigger</a> = 1;
00500 <span class="preprocessor">#endif</span>
00501 <span class="preprocessor"></span>
00502     RtlCaptureContext(&amp;<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;ProcessorState.ContextFrame);
00503     <a class="code" href="../../d9/d6/ppc_2ipi_8c.html#a1">KiSaveProcessorControlState</a>(&amp;<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;ProcessorState);
00504 
00505     <span class="comment">//</span>
00506     <span class="comment">// This is necessary on machines where the virtual unwind that happens</span>
00507     <span class="comment">// during KeDumpMachineState() destroys the context record.</span>
00508     <span class="comment">//</span>
00509 
00510     ContextSave = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;ProcessorState.ContextFrame;
00511 
00512     <span class="comment">//</span>
00513     <span class="comment">// If we are called by hard error then we don't want to dump the</span>
00514     <span class="comment">// processor state on the machine.</span>
00515     <span class="comment">//</span>
00516     <span class="comment">// We know that we are called by hard error because the bug check</span>
00517     <span class="comment">// code will be FATAL_UNHANDLED_HARD_ERROR.  If this is so then the</span>
00518     <span class="comment">// error status passed to harderr is the first parameter, and a pointer</span>
00519     <span class="comment">// to the parameter array from hard error is passed as the second</span>
00520     <span class="comment">// argument.</span>
00521     <span class="comment">//</span>
00522     <span class="comment">// The third argument is the OemCaption to be printed.</span>
00523     <span class="comment">// The last argument is the OemMessage to be printed.</span>
00524     <span class="comment">//</span>
00525 
00526     <span class="keywordflow">if</span> (BugCheckCode == FATAL_UNHANDLED_HARD_ERROR) {
00527 
00528         PULONG_PTR parameterArray;
00529 
00530         hardErrorCalled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00531 
00532         HardErrorCaption = (PCHAR)BugCheckParameter3;
00533         HardErrorMessage = (PCHAR)BugCheckParameter4;
00534         parameterArray = (PULONG_PTR)BugCheckParameter2;
00535         BugCheckCode = (ULONG)BugCheckParameter1;
00536         BugCheckParameter1 = parameterArray[0];
00537         BugCheckParameter2 = parameterArray[1];
00538         BugCheckParameter3 = parameterArray[2];
00539         BugCheckParameter4 = parameterArray[3];
00540 
00541     } <span class="keywordflow">else</span> {
00542 
00543         hardErrorCalled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00544 
00545         <span class="keywordflow">switch</span> (BugCheckCode) {
00546 
00547             <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/halmips_8h.html#a12">IRQL_NOT_LESS_OR_EQUAL</a>:
00548 
00549                 ExecutionAddress = (PVOID)BugCheckParameter4;
00550 
00551                 <span class="keywordflow">if</span> (ExecutionAddress &gt;= <a class="code" href="../../d9/d1/bugcheck_8c.html#a3">ExPoolCodeStart</a> &amp;&amp; ExecutionAddress &lt; <a class="code" href="../../d9/d1/bugcheck_8c.html#a4">ExPoolCodeEnd</a>) {
00552                     BugCheckCode = DRIVER_CORRUPTED_EXPOOL;
00553                 }
00554                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ExecutionAddress &gt;= <a class="code" href="../../d9/d1/bugcheck_8c.html#a5">MmPoolCodeStart</a> &amp;&amp; ExecutionAddress &lt; <a class="code" href="../../d9/d1/bugcheck_8c.html#a6">MmPoolCodeEnd</a>) {
00555                     BugCheckCode = DRIVER_CORRUPTED_MMPOOL;
00556                 }
00557                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ExecutionAddress &gt;= <a class="code" href="../../d9/d1/bugcheck_8c.html#a7">MmPteCodeStart</a> &amp;&amp; ExecutionAddress &lt; <a class="code" href="../../d9/d1/bugcheck_8c.html#a8">MmPteCodeEnd</a>) {
00558                     BugCheckCode = DRIVER_CORRUPTED_SYSPTES;
00559                 }
00560                 <span class="keywordflow">else</span> {
00561                     ImageBase = <a class="code" href="../../d8/d0/ppc_2dmpstate_8c.html#a4">KiPcToFileHeader</a> (ExecutionAddress,
00562                                                   &amp;DataTableEntry,
00563                                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00564                                                   &amp;InKernelOrHal);
00565                     <span class="keywordflow">if</span> (InKernelOrHal == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00566 
00567                         <span class="comment">//</span>
00568                         <span class="comment">// The kernel faulted at raised IRQL.  Quite often this</span>
00569                         <span class="comment">// is a driver that has unloaded without deleting its</span>
00570                         <span class="comment">// lookaside lists or other resources.  Or its resources</span>
00571                         <span class="comment">// are marked pagable and shouldn't be.  Detect both</span>
00572                         <span class="comment">// cases here and identify the offending driver</span>
00573                         <span class="comment">// whenever possible.</span>
00574                         <span class="comment">//</span>
00575 
00576                         VirtualAddress = (PVOID)BugCheckParameter1;
00577 
00578                         ImageBase = <a class="code" href="../../d8/d0/ppc_2dmpstate_8c.html#a4">KiPcToFileHeader</a> (VirtualAddress,
00579                                                       &amp;DataTableEntry,
00580                                                       <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00581                                                       &amp;InKernelOrHal);
00582 
00583                         <span class="keywordflow">if</span> (ImageBase != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00584                             <a class="code" href="../../d9/d1/bugcheck_8c.html#a11">KiBugCheckDriver</a> = &amp;DataTableEntry-&gt;BaseDllName;
00585                             BugCheckCode = DRIVER_PORTION_MUST_BE_NONPAGED;
00586                         }
00587                         <span class="keywordflow">else</span> {
00588                             <a class="code" href="../../d9/d1/bugcheck_8c.html#a11">KiBugCheckDriver</a> = <a class="code" href="../../d8/d8/sysload_8c.html#a58">MmLocateUnloadedDriver</a> (VirtualAddress);
00589                             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/bugcheck_8c.html#a11">KiBugCheckDriver</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00590                                 BugCheckCode = SYSTEM_SCAN_AT_RAISED_IRQL_CAUGHT_IMPROPER_DRIVER_UNLOAD;
00591                             }
00592                         }
00593                     }
00594                     <span class="keywordflow">else</span> {
00595                         BugCheckCode = DRIVER_IRQL_NOT_LESS_OR_EQUAL;
00596                     }
00597                 }
00598                 <span class="keywordflow">break</span>;
00599 
00600             <span class="keywordflow">case</span> ATTEMPTED_WRITE_TO_READONLY_MEMORY:
00601 
00602                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a11">KiBugCheckDriver</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00603                 TrapInformation = (PKTRAP_FRAME)BugCheckParameter3;
00604 
00605                 <span class="comment">//</span>
00606                 <span class="comment">// Extract the execution address from the trap frame to</span>
00607                 <span class="comment">// identify the component.</span>
00608                 <span class="comment">//</span>
00609 
00610                 <span class="keywordflow">if</span> (TrapInformation != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00611                     ExecutionAddress = (PVOID)PROGRAM_COUNTER (TrapInformation);
00612                     ImageBase = <a class="code" href="../../d8/d0/ppc_2dmpstate_8c.html#a4">KiPcToFileHeader</a> (ExecutionAddress,
00613                                                   &amp;DataTableEntry,
00614                                                   <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00615                                                   &amp;InKernelOrHal);
00616 
00617                     <span class="keywordflow">if</span> (ImageBase != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00618                         <a class="code" href="../../d9/d1/bugcheck_8c.html#a11">KiBugCheckDriver</a> = &amp;DataTableEntry-&gt;BaseDllName;
00619                     }
00620                 }
00621 
00622                 <span class="keywordflow">break</span>;
00623 
00624             <span class="keywordflow">case</span> DRIVER_LEFT_LOCKED_PAGES_IN_PROCESS:
00625 
00626                 ExecutionAddress = (PVOID)BugCheckParameter1;
00627 
00628                 ImageBase = <a class="code" href="../../d8/d0/ppc_2dmpstate_8c.html#a4">KiPcToFileHeader</a> (ExecutionAddress,
00629                                               &amp;DataTableEntry,
00630                                               <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00631                                               &amp;InKernelOrHal);
00632 
00633                 <span class="keywordflow">if</span> (ImageBase != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00634                     <a class="code" href="../../d9/d1/bugcheck_8c.html#a11">KiBugCheckDriver</a> = &amp;DataTableEntry-&gt;BaseDllName;
00635                 }
00636                 <span class="keywordflow">else</span> {
00637                     <a class="code" href="../../d9/d1/bugcheck_8c.html#a11">KiBugCheckDriver</a> = <a class="code" href="../../d8/d8/sysload_8c.html#a58">MmLocateUnloadedDriver</a> (ExecutionAddress);
00638                 }
00639 
00640                 BugCheckParameter4 = (ULONG_PTR)<a class="code" href="../../d9/d1/bugcheck_8c.html#a11">KiBugCheckDriver</a>;
00641 
00642                 <span class="keywordflow">break</span>;
00643 
00644             <span class="keywordflow">case</span> DRIVER_USED_EXCESSIVE_PTES:
00645 
00646                 DataTableEntry = (PLDR_DATA_TABLE_ENTRY)BugCheckParameter1;
00647                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a11">KiBugCheckDriver</a> = &amp;DataTableEntry-&gt;BaseDllName;
00648 
00649                 <span class="keywordflow">break</span>;
00650 
00651             <span class="keywordflow">case</span> PAGE_FAULT_IN_NONPAGED_AREA:
00652 
00653                 ExecutionAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00654                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a11">KiBugCheckDriver</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00655 
00656                 VirtualAddress = (PVOID)BugCheckParameter1;
00657 
00658                 TrapInformation = (PKTRAP_FRAME)BugCheckParameter3;
00659 
00660                 <span class="comment">//</span>
00661                 <span class="comment">// Extract the execution address from the trap frame to</span>
00662                 <span class="comment">// identify the component.</span>
00663                 <span class="comment">//</span>
00664 
00665                 <span class="keywordflow">if</span> (TrapInformation != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00666 
00667                     ExecutionAddress = (PVOID)PROGRAM_COUNTER (TrapInformation);
00668                     BugCheckParameter3 = (ULONG_PTR)ExecutionAddress;
00669 
00670                     <a class="code" href="../../d8/d0/ppc_2dmpstate_8c.html#a4">KiPcToFileHeader</a> (ExecutionAddress,
00671                                       &amp;DataTableEntry,
00672                                       <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00673                                       &amp;InKernelOrHal);
00674 
00675                     ImageBase = <a class="code" href="../../d8/d0/ppc_2dmpstate_8c.html#a4">KiPcToFileHeader</a> (ExecutionAddress,
00676                                                   &amp;DataTableEntry,
00677                                                   <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00678                                                   &amp;DontCare);
00679 
00680                     <span class="keywordflow">if</span> (ImageBase != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00681                         <a class="code" href="../../d9/d1/bugcheck_8c.html#a11">KiBugCheckDriver</a> = &amp;DataTableEntry-&gt;BaseDllName;
00682                     }
00683                 }
00684                 <span class="keywordflow">else</span> {
00685 
00686                     <span class="comment">//</span>
00687                     <span class="comment">// No trap frame, so no execution address either.</span>
00688                     <span class="comment">//</span>
00689 
00690                     BugCheckParameter3 = 0;
00691                 }
00692 
00693                 Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00694 
00695                 <span class="keywordflow">if</span> ((VirtualAddress &gt;= <a class="code" href="../../d2/d1/mm_8h.html#a160">MmSpecialPoolStart</a>) &amp;&amp;
00696                     (VirtualAddress &lt; <a class="code" href="../../d2/d1/mm_8h.html#a161">MmSpecialPoolEnd</a>)) {
00697 
00698                     <span class="comment">//</span>
00699                     <span class="comment">// Update the bugcheck number so the administrator gets</span>
00700                     <span class="comment">// useful feedback that enabling special pool has enabled</span>
00701                     <span class="comment">// the system to locate the corruptor.</span>
00702                     <span class="comment">//</span>
00703 
00704                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d6/allocpag_8c.html#a66">MmIsSpecialPoolAddressFree</a> (VirtualAddress) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00705                         <span class="keywordflow">if</span> (InKernelOrHal == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00706                             BugCheckCode = PAGE_FAULT_IN_FREED_SPECIAL_POOL;
00707                         }
00708                         <span class="keywordflow">else</span> {
00709                             BugCheckCode = DRIVER_PAGE_FAULT_IN_FREED_SPECIAL_POOL;
00710                         }
00711                     }
00712                     <span class="keywordflow">else</span> {
00713                         <span class="keywordflow">if</span> (InKernelOrHal == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00714                             BugCheckCode = PAGE_FAULT_BEYOND_END_OF_ALLOCATION;
00715                         }
00716                         <span class="keywordflow">else</span> {
00717                             BugCheckCode = DRIVER_PAGE_FAULT_BEYOND_END_OF_ALLOCATION;
00718                         }
00719                     }
00720                 }
00721                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ExecutionAddress == VirtualAddress) &amp;&amp;
00722                         (<a class="code" href="../../d1/d6/allocpag_8c.html#a65">MmIsHydraAddress</a> (VirtualAddress) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp;
00723                         ((Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o4">Teb</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (<a class="code" href="../../d2/d1/mm_8h.html#a10">IS_SYSTEM_ADDRESS</a>(Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o4">Teb</a>)))) {
00724                     <span class="comment">//</span>
00725                     <span class="comment">// This is a driver reference to session space from a</span>
00726                     <span class="comment">// worker thread.  Since the system process has no session</span>
00727                     <span class="comment">// space this is illegal and the driver must be fixed.</span>
00728                     <span class="comment">//</span>
00729 
00730                     BugCheckCode = TERMINAL_SERVER_DRIVER_MADE_INCORRECT_MEMORY_REFERENCE;
00731                 }
00732                 <span class="keywordflow">else</span> {
00733                     <a class="code" href="../../d9/d1/bugcheck_8c.html#a11">KiBugCheckDriver</a> = <a class="code" href="../../d8/d8/sysload_8c.html#a58">MmLocateUnloadedDriver</a> (VirtualAddress);
00734                     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/bugcheck_8c.html#a11">KiBugCheckDriver</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00735                         BugCheckCode = DRIVER_UNLOADED_WITHOUT_CANCELLING_PENDING_OPERATIONS;
00736                     }
00737                 }
00738 
00739                 <span class="keywordflow">break</span>;
00740 
00741             <span class="keywordflow">default</span>:
00742                 <span class="keywordflow">break</span>;
00743         }
00744     }
00745 
00746     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/bugcheck_8c.html#a11">KiBugCheckDriver</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00747         <a class="code" href="../../d9/d1/bugcheck_8c.html#a15">KeBugCheckUnicodeToAnsi</a> (<a class="code" href="../../d9/d1/bugcheck_8c.html#a11">KiBugCheckDriver</a>,
00748                                  AnsiBuffer,
00749                                  <span class="keyword">sizeof</span> (AnsiBuffer));
00750     }
00751 
00752     <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a2">KiBugCheckData</a>[0] = BugCheckCode;
00753     <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a2">KiBugCheckData</a>[1] = BugCheckParameter1;
00754     <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a2">KiBugCheckData</a>[2] = BugCheckParameter2;
00755     <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a2">KiBugCheckData</a>[3] = BugCheckParameter3;
00756     <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a2">KiBugCheckData</a>[4] = BugCheckParameter4;
00757 
00758     BugCheckParameters[0] = BugCheckParameter1;
00759     BugCheckParameters[1] = BugCheckParameter2;
00760     BugCheckParameters[2] = BugCheckParameter3;
00761     BugCheckParameters[3] = BugCheckParameter4;
00762 
00763     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/kd_8h.html#a7">KdPitchDebugger</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
00764         <a class="code" href="../../d8/d5/kddata_8c.html#a50">KdDebuggerDataBlock</a>.SavedContext = (ULONG_PTR) &amp;ContextSave;
00765     }
00766 
00767     <span class="comment">//</span>
00768     <span class="comment">// If the user manually crashed the machine, skips the DbgPrints and</span>
00769     <span class="comment">// go to the crashdump.</span>
00770     <span class="comment">// Trying to do DbgPrint causes us to reeeter the debugger which causes</span>
00771     <span class="comment">// some problems.</span>
00772     <span class="comment">//</span>
00773     <span class="comment">// Otherwise, if the debugger is enabled, print out the information and</span>
00774     <span class="comment">// stop.</span>
00775     <span class="comment">//</span>
00776 
00777     <span class="keywordflow">if</span> ((BugCheckCode != MANUALLY_INITIATED_CRASH) &amp;&amp;
00778         (<a class="code" href="../../d7/d3/kd_8h.html#a13">KdDebuggerEnabled</a>)) {
00779 
00780         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n*** Fatal System Error: 0x%08lx\n"</span>
00781                  <span class="stringliteral">"                       (0x%p,0x%p,0x%p,0x%p)\n\n"</span>,
00782                  BugCheckCode,
00783                  BugCheckParameter1,
00784                  BugCheckParameter2,
00785                  BugCheckParameter3,
00786                  BugCheckParameter4);
00787 
00788         <span class="comment">//</span>
00789         <span class="comment">// If the debugger is not actually connected, or the user manually</span>
00790         <span class="comment">// crashed the machine by typing .crash in the debugger, proceed to</span>
00791         <span class="comment">// "blue screen" the system.</span>
00792         <span class="comment">//</span>
00793         <span class="comment">// The call to DbgPrint above will have set the state of</span>
00794         <span class="comment">// KdDebuggerNotPresent if the debugger has become disconnected</span>
00795         <span class="comment">// since the system was booted.</span>
00796         <span class="comment">//</span>
00797 
00798         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/kd_8h.html#a12">KdDebuggerNotPresent</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00799 
00800             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/bugcheck_8c.html#a11">KiBugCheckDriver</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00801                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"The %s driver may be at fault.\n"</span>, AnsiBuffer);
00802             }
00803 
00804             <span class="keywordflow">if</span> (hardErrorCalled != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00805                 <span class="keywordflow">if</span> (HardErrorCaption) {
00806                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(HardErrorCaption);
00807                 }
00808                 <span class="keywordflow">if</span> (HardErrorMessage) {
00809                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(HardErrorMessage);
00810                 }
00811             }
00812 
00813             <a class="code" href="../../d9/d1/bugcheck_8c.html#a16">KiBugCheckDebugBreak</a> (DBG_STATUS_BUGCHECK_FIRST);
00814         }
00815     }
00816 
00817     <span class="comment">//</span>
00818     <span class="comment">// Freeze execution of the system by disabling interrupts and looping.</span>
00819     <span class="comment">//</span>
00820 
00821     <a class="code" href="../../d0/d0/ki_8h.html#a106">KiDisableInterrupts</a>();
00822     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a57">HIGH_LEVEL</a>, &amp;OldIrql);
00823 
00824     <span class="comment">//</span>
00825     <span class="comment">// Don't attempt to display message more than once.</span>
00826     <span class="comment">//</span>
00827 
00828     <span class="keywordflow">if</span> (InterlockedDecrement (&amp;<a class="code" href="../../d6/d8/ex_2harderr_8c.html#a3">KeBugCheckCount</a>) == 0) {
00829 
00830 <span class="preprocessor">#if !defined(NT_UP)</span>
00831 <span class="preprocessor"></span>
00832         <span class="comment">//</span>
00833         <span class="comment">// Attempt to get the other processors frozen now, but don't wait</span>
00834         <span class="comment">// for them to freeze (in case someone is stuck).</span>
00835         <span class="comment">//</span>
00836 
00837         TargetSet = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a> &amp; ~<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;SetMember;
00838         <span class="keywordflow">if</span> (TargetSet != 0) {
00839             <a class="code" href="../../d0/d0/ki_8h.html#a90">KiIpiSend</a>((KAFFINITY) TargetSet, <a class="code" href="../../d0/d0/ki_8h.html#a18">IPI_FREEZE</a>);
00840 
00841             <span class="comment">//</span>
00842             <span class="comment">// Give the other processors one second to flush their data caches.</span>
00843             <span class="comment">//</span>
00844             <span class="comment">// N.B. This cannot be synchronized since the reason for the bug</span>
00845             <span class="comment">//      may be one of the other processors failed.</span>
00846             <span class="comment">//</span>
00847 
00848             <a class="code" href="../../d2/d7/hal_8h.html#a206">KeStallExecutionProcessor</a>(1000 * 1000);
00849         }
00850 
00851 <span class="preprocessor">#endif</span>
00852 <span class="preprocessor"></span>
00853         <span class="comment">//</span>
00854         <span class="comment">// Enable InbvDisplayString calls to make it through to bootvid driver.</span>
00855         <span class="comment">//</span>
00856 
00857         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/inbv_8h.html#a18">InbvIsBootDriverInstalled</a>()) {
00858 
00859             <a class="code" href="../../d0/d1/inbv_8h.html#a4">InbvAcquireDisplayOwnership</a>();
00860 
00861             <a class="code" href="../../d0/d1/inbv_8h.html#a6">InbvResetDisplay</a>();
00862             <a class="code" href="../../d0/d1/inbv_8h.html#a8">InbvSolidColorFill</a>(0,0,639,479,4); <span class="comment">// make the screen blue</span>
00863             <a class="code" href="../../d0/d1/inbv_8h.html#a27">InbvSetTextColor</a>(15);
00864             <a class="code" href="../../d0/d1/inbv_8h.html#a3">InbvInstallDisplayStringFilter</a>((<a class="code" href="../../d0/d1/inbv_8h.html#a1">INBV_DISPLAY_STRING_FILTER</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00865             <a class="code" href="../../d0/d1/inbv_8h.html#a17">InbvEnableDisplayString</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);     <span class="comment">// enable display string</span>
00866             <a class="code" href="../../d0/d1/inbv_8h.html#a26">InbvSetScrollRegion</a>(0,0,639,479);  <span class="comment">// set to use entire screen</span>
00867         }
00868 
00869         <span class="keywordflow">if</span> (!hardErrorCalled) {
00870             <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>((<span class="keywordtype">char</span> *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00871                     <span class="stringliteral">"\n*** STOP: 0x%08lX (0x%p,0x%p,0x%p,0x%p)\n"</span>,
00872                     BugCheckCode,
00873                     BugCheckParameter1,
00874                     BugCheckParameter2,
00875                     BugCheckParameter3,
00876                     BugCheckParameter4
00877                     );
00878             <a class="code" href="../../d0/d1/inbv_8h.html#a9">InbvDisplayString</a>((<span class="keywordtype">char</span> *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00879 
00880             <a class="code" href="../../d9/d1/bugcheck_8c.html#a14">KeGetBugMessageText</a>(BugCheckCode, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00881             <a class="code" href="../../d0/d1/inbv_8h.html#a9">InbvDisplayString</a>(<span class="stringliteral">"\n"</span>);
00882 
00883             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/bugcheck_8c.html#a11">KiBugCheckDriver</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00884 
00885                 <span class="comment">//</span>
00886                 <span class="comment">// Output the driver name.</span>
00887                 <span class="comment">//</span>
00888 
00889                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a14">KeGetBugMessageText</a>(BUGCODE_ID_DRIVER, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00890                 <a class="code" href="../../d0/d1/inbv_8h.html#a9">InbvDisplayString</a>(AnsiBuffer);
00891                 <a class="code" href="../../d0/d1/inbv_8h.html#a9">InbvDisplayString</a>(<span class="stringliteral">"\n"</span>);
00892             }
00893 
00894         } <span class="keywordflow">else</span> {
00895             <span class="keywordflow">if</span> (HardErrorCaption) {
00896                 <a class="code" href="../../d0/d1/inbv_8h.html#a9">InbvDisplayString</a>(HardErrorCaption);
00897             }
00898             <span class="keywordflow">if</span> (HardErrorMessage) {
00899                 <a class="code" href="../../d0/d1/inbv_8h.html#a9">InbvDisplayString</a>(HardErrorMessage);
00900             }
00901         }
00902 
00903         <span class="comment">//</span>
00904         <span class="comment">// Process the bug check callback list.</span>
00905         <span class="comment">//</span>
00906 
00907         <a class="code" href="../../d9/d1/bugcheck_8c.html#a12">KiScanBugCheckCallbackList</a>();
00908 
00909         <span class="comment">//</span>
00910         <span class="comment">// If the debugger is not enabled, then dump the machine state and</span>
00911         <span class="comment">// attempt to enable the debugger.</span>
00912         <span class="comment">//</span>
00913 
00914         <span class="keywordflow">if</span> (!hardErrorCalled) {
00915 
00916             <a class="code" href="../../d9/d1/bugcheck_8c.html#a18">KiDumpParameterImages</a>(
00917                 (<span class="keywordtype">char</span> *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00918                 BugCheckParameters,
00919                 4,
00920                 <a class="code" href="../../d7/d4/flunkirp_8c.html#a2">KeBugCheckUnicodeToAnsi</a>);
00921 
00922         }
00923 
00924         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/kd_8h.html#a13">KdDebuggerEnabled</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> &amp;&amp; <a class="code" href="../../d7/d3/kd_8h.html#a7">KdPitchDebugger</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
00925             <a class="code" href="../../d5/d6/4_2kdinit_8c.html#a4">KdInitSystem</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00926 
00927         } <span class="keywordflow">else</span> {
00928             <a class="code" href="../../d0/d1/inbv_8h.html#a9">InbvDisplayString</a>(<span class="stringliteral">"\n"</span>);
00929         }
00930 
00931         <span class="comment">//</span>
00932         <span class="comment">// Write a crash dump and optionally reboot if the system has been</span>
00933         <span class="comment">// so configured.</span>
00934         <span class="comment">//</span>
00935 
00936         <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;ProcessorState.ContextFrame = ContextSave;
00937 
00938         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d3/dumpctl_8c.html#a43">IoWriteCrashDump</a>(BugCheckCode,
00939                               BugCheckParameter1,
00940                               BugCheckParameter2,
00941                               BugCheckParameter3,
00942                               BugCheckParameter4,
00943                               &amp;ContextSave
00944                               )) {
00945             <span class="comment">//</span>
00946             <span class="comment">// If no crashdump take, display the PSS message.</span>
00947             <span class="comment">//</span>
00948 
00949             <span class="keywordflow">switch</span> ( BugCheckCode ) {
00950 
00951                 <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/halmips_8h.html#a12">IRQL_NOT_LESS_OR_EQUAL</a>:
00952                 <span class="keywordflow">case</span> DRIVER_IRQL_NOT_LESS_OR_EQUAL:
00953                 <span class="keywordflow">case</span> DRIVER_CORRUPTED_EXPOOL:
00954                 <span class="keywordflow">case</span> DRIVER_CORRUPTED_MMPOOL:
00955                 <span class="keywordflow">case</span> DRIVER_PORTION_MUST_BE_NONPAGED:
00956                 <span class="keywordflow">case</span> SYSTEM_SCAN_AT_RAISED_IRQL_CAUGHT_IMPROPER_DRIVER_UNLOAD:
00957                     PssMessage = BUGCODE_PSS_MESSAGE_A;
00958                     <span class="keywordflow">break</span>;
00959 
00960                 <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/halmips_8h.html#a13">KMODE_EXCEPTION_NOT_HANDLED</a>:
00961                     PssMessage = BUGCODE_PSS_MESSAGE_1E;
00962                     <span class="keywordflow">break</span>;
00963 
00964                 <span class="keywordflow">case</span> FAT_FILE_SYSTEM:
00965                 <span class="keywordflow">case</span> NTFS_FILE_SYSTEM:
00966                     PssMessage = BUGCODE_PSS_MESSAGE_23;
00967                     <span class="keywordflow">break</span>;
00968 
00969                 <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/halmips_8h.html#a2">DATA_BUS_ERROR</a>:
00970                     PssMessage = BUGCODE_PSS_MESSAGE_2E;
00971                     <span class="keywordflow">break</span>;
00972 
00973                 <span class="keywordflow">case</span> NO_MORE_SYSTEM_PTES:
00974                     PssMessage = BUGCODE_PSS_MESSAGE_3F;
00975                     <span class="keywordflow">break</span>;
00976 
00977                 <span class="keywordflow">case</span> INACCESSIBLE_BOOT_DEVICE:
00978                     PssMessage = BUGCODE_PSS_MESSAGE_7B;
00979                     <span class="keywordflow">break</span>;
00980 
00981                 <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/halmips_8h.html#a23">UNEXPECTED_KERNEL_MODE_TRAP</a>:
00982                     PssMessage = BUGCODE_PSS_MESSAGE_7F;
00983                     <span class="keywordflow">break</span>;
00984 
00985                 <span class="keywordflow">case</span> STATUS_SYSTEM_IMAGE_BAD_SIGNATURE:
00986                     PssMessage = BUGCODE_PSS_MESSAGE_SIGNATURE;
00987                     <span class="keywordflow">break</span>;
00988 
00989                 <span class="keywordflow">case</span> ACPI_BIOS_ERROR:
00990                     PssMessage = BUGCODE_PSS_MESSAGE_A5;
00991                     <span class="keywordflow">break</span>;
00992 
00993                 <span class="keywordflow">case</span> ACPI_BIOS_FATAL_ERROR:
00994                     PssMessage = ACPI_BIOS_FATAL_ERROR;
00995                     <span class="keywordflow">break</span>;
00996 
00997                 <span class="keywordflow">default</span>:
00998                     PssMessage = BUGCODE_PSS_MESSAGE;
00999                     <span class="keywordflow">break</span>;
01000                 }
01001 
01002             <a class="code" href="../../d9/d1/bugcheck_8c.html#a14">KeGetBugMessageText</a>(PssMessage, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01003         }
01004     }
01005 
01006     <span class="comment">//</span>
01007     <span class="comment">// Attempt to enter the kernel debugger.</span>
01008     <span class="comment">//</span>
01009 
01010     <a class="code" href="../../d9/d1/bugcheck_8c.html#a16">KiBugCheckDebugBreak</a> (DBG_STATUS_BUGCHECK_SECOND);
01011     <span class="keywordflow">return</span>;
01012 }
01013 
01014 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01015"></a><a class="code" href="../../d9/d1/bugcheck_8c.html#a20">01015</a> <a class="code" href="../../d9/d1/bugcheck_8c.html#a20">KeEnterKernelDebugger</a> (
01016     VOID
01017     )
01018 
01019 <span class="comment">/*++</span>
01020 <span class="comment"></span>
01021 <span class="comment">Routine Description:</span>
01022 <span class="comment"></span>
01023 <span class="comment">    This function crashes the system in a controlled manner attempting</span>
01024 <span class="comment">    to invoke the kernel debugger.</span>
01025 <span class="comment"></span>
01026 <span class="comment">Arguments:</span>
01027 <span class="comment"></span>
01028 <span class="comment">    None.</span>
01029 <span class="comment"></span>
01030 <span class="comment">Return Value:</span>
01031 <span class="comment"></span>
01032 <span class="comment">    None.</span>
01033 <span class="comment"></span>
01034 <span class="comment">--*/</span>
01035 
01036 {
01037 
01038 <span class="preprocessor">#if !defined(i386)</span>
01039 <span class="preprocessor"></span>    KIRQL OldIrql;
01040 <span class="preprocessor">#endif</span>
01041 <span class="preprocessor"></span>
01042     <span class="comment">//</span>
01043     <span class="comment">// Freeze execution of the system by disabling interrupts and looping.</span>
01044     <span class="comment">//</span>
01045 
01046     <a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a12">KiHardwareTrigger</a> = 1;
01047     <a class="code" href="../../d0/d0/ki_8h.html#a106">KiDisableInterrupts</a>();
01048 <span class="preprocessor">#if !defined(i386)</span>
01049 <span class="preprocessor"></span>    <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a57">HIGH_LEVEL</a>, &amp;OldIrql);
01050 <span class="preprocessor">#endif</span>
01051 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (InterlockedDecrement (&amp;<a class="code" href="../../d6/d8/ex_2harderr_8c.html#a3">KeBugCheckCount</a>) == 0) {
01052         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/kd_8h.html#a13">KdDebuggerEnabled</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01053             <span class="keywordflow">if</span> ( <a class="code" href="../../d7/d3/kd_8h.html#a7">KdPitchDebugger</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
01054                 <a class="code" href="../../d5/d6/4_2kdinit_8c.html#a4">KdInitSystem</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01055             }
01056         }
01057     }
01058 
01059     <a class="code" href="../../d9/d1/bugcheck_8c.html#a16">KiBugCheckDebugBreak</a> (DBG_STATUS_FATAL);
01060 }
01061 
01062 <a class="code" href="../../d0/d9/ntosdef_8h.html#a29">NTKERNELAPI</a>
01063 BOOLEAN
<a name="l01064"></a><a class="code" href="../../d9/d1/bugcheck_8c.html#a21">01064</a> <a class="code" href="../../d9/d1/bugcheck_8c.html#a21">KeDeregisterBugCheckCallback</a> (
01065     IN <a class="code" href="../../d4/d5/struct__KBUGCHECK__CALLBACK__RECORD.html">PKBUGCHECK_CALLBACK_RECORD</a> CallbackRecord
01066     )
01067 
01068 <span class="comment">/*++</span>
01069 <span class="comment"></span>
01070 <span class="comment">Routine Description:</span>
01071 <span class="comment"></span>
01072 <span class="comment">    This function deregisters a bug check callback record.</span>
01073 <span class="comment"></span>
01074 <span class="comment">Arguments:</span>
01075 <span class="comment"></span>
01076 <span class="comment">    CallbackRecord - Supplies a pointer to a bug check callback record.</span>
01077 <span class="comment"></span>
01078 <span class="comment">Return Value:</span>
01079 <span class="comment"></span>
01080 <span class="comment">    If the specified bug check callback record is successfully deregistered,</span>
01081 <span class="comment">    then a value of TRUE is returned. Otherwise, a value of FALSE is returned.</span>
01082 <span class="comment"></span>
01083 <span class="comment">--*/</span>
01084 
01085 {
01086 
01087     BOOLEAN Deregister;
01088     KIRQL OldIrql;
01089 
01090     <span class="comment">//</span>
01091     <span class="comment">// Raise IRQL to HIGH_LEVEL and acquire the bug check callback list</span>
01092     <span class="comment">// spinlock.</span>
01093     <span class="comment">//</span>
01094 
01095     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a57">HIGH_LEVEL</a>, &amp;OldIrql);
01096     KiAcquireSpinLock(&amp;<a class="code" href="../../d4/d9/ke_8h.html#a128">KeBugCheckCallbackLock</a>);
01097 
01098     <span class="comment">//</span>
01099     <span class="comment">// If the specified callback record is currently registered, then</span>
01100     <span class="comment">// deregister the callback record.</span>
01101     <span class="comment">//</span>
01102 
01103     Deregister = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01104     <span class="keywordflow">if</span> (CallbackRecord-&gt;State == <a class="code" href="../../d4/d9/ke_8h.html#a410a237">BufferInserted</a>) {
01105         CallbackRecord-&gt;State = <a class="code" href="../../d4/d9/ke_8h.html#a410a236">BufferEmpty</a>;
01106         RemoveEntryList(&amp;CallbackRecord-&gt;Entry);
01107         Deregister = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01108     }
01109 
01110     <span class="comment">//</span>
01111     <span class="comment">// Release the bug check callback spinlock, lower IRQL to its previous</span>
01112     <span class="comment">// value, and return whether the callback record was successfully</span>
01113     <span class="comment">// deregistered.</span>
01114     <span class="comment">//</span>
01115 
01116     KiReleaseSpinLock(&amp;<a class="code" href="../../d4/d9/ke_8h.html#a128">KeBugCheckCallbackLock</a>);
01117     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
01118     <span class="keywordflow">return</span> Deregister;
01119 }
01120 
01121 <a class="code" href="../../d0/d9/ntosdef_8h.html#a29">NTKERNELAPI</a>
01122 BOOLEAN
<a name="l01123"></a><a class="code" href="../../d9/d1/bugcheck_8c.html#a22">01123</a> <a class="code" href="../../d9/d1/bugcheck_8c.html#a22">KeRegisterBugCheckCallback</a> (
01124     IN <a class="code" href="../../d4/d5/struct__KBUGCHECK__CALLBACK__RECORD.html">PKBUGCHECK_CALLBACK_RECORD</a> CallbackRecord,
01125     IN <a class="code" href="../../d4/d9/ke_8h.html#a113">PKBUGCHECK_CALLBACK_ROUTINE</a> CallbackRoutine,
01126     IN PVOID Buffer,
01127     IN ULONG Length,
01128     IN PUCHAR Component
01129     )
01130 
01131 <span class="comment">/*++</span>
01132 <span class="comment"></span>
01133 <span class="comment">Routine Description:</span>
01134 <span class="comment"></span>
01135 <span class="comment">    This function registers a bug check callback record. If the system</span>
01136 <span class="comment">    crashes, then the specified function will be called during bug check</span>
01137 <span class="comment">    processing so it may dump additional state in the specified bug check</span>
01138 <span class="comment">    buffer.</span>
01139 <span class="comment"></span>
01140 <span class="comment">    N.B. Bug check callback routines are called in reverse order of</span>
01141 <span class="comment">         registration, i.e., in LIFO order.</span>
01142 <span class="comment"></span>
01143 <span class="comment">Arguments:</span>
01144 <span class="comment"></span>
01145 <span class="comment">    CallbackRecord - Supplies a pointer to a callback record.</span>
01146 <span class="comment"></span>
01147 <span class="comment">    CallbackRoutine - Supplies a pointer to the callback routine.</span>
01148 <span class="comment"></span>
01149 <span class="comment">    Buffer - Supplies a pointer to the bug check buffer.</span>
01150 <span class="comment"></span>
01151 <span class="comment">    Length - Supplies the length of the bug check buffer in bytes.</span>
01152 <span class="comment"></span>
01153 <span class="comment">    Component - Supplies a pointer to a zero terminated component</span>
01154 <span class="comment">        identifier.</span>
01155 <span class="comment"></span>
01156 <span class="comment">Return Value:</span>
01157 <span class="comment"></span>
01158 <span class="comment">    If the specified bug check callback record is successfully registered,</span>
01159 <span class="comment">    then a value of TRUE is returned. Otherwise, a value of FALSE is returned.</span>
01160 <span class="comment"></span>
01161 <span class="comment">--*/</span>
01162 
01163 {
01164 
01165     BOOLEAN Inserted;
01166     KIRQL OldIrql;
01167 
01168     <span class="comment">//</span>
01169     <span class="comment">// Raise IRQL to HIGH_LEVEL and acquire the bug check callback list</span>
01170     <span class="comment">// spinlock.</span>
01171     <span class="comment">//</span>
01172 
01173     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a57">HIGH_LEVEL</a>, &amp;OldIrql);
01174     KiAcquireSpinLock(&amp;<a class="code" href="../../d4/d9/ke_8h.html#a128">KeBugCheckCallbackLock</a>);
01175 
01176     <span class="comment">//</span>
01177     <span class="comment">// If the specified callback record is currently not registered, then</span>
01178     <span class="comment">// register the callback record.</span>
01179     <span class="comment">//</span>
01180 
01181     Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01182     <span class="keywordflow">if</span> (CallbackRecord-&gt;State == <a class="code" href="../../d4/d9/ke_8h.html#a410a236">BufferEmpty</a>) {
01183         CallbackRecord-&gt;CallbackRoutine = CallbackRoutine;
01184         CallbackRecord-&gt;Buffer = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
01185         CallbackRecord-&gt;Length = Length;
01186         CallbackRecord-&gt;Component = Component;
01187         CallbackRecord-&gt;Checksum =
01188             ((ULONG_PTR)CallbackRoutine + (ULONG_PTR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + Length + (ULONG_PTR)Component);
01189 
01190         CallbackRecord-&gt;State = <a class="code" href="../../d4/d9/ke_8h.html#a410a237">BufferInserted</a>;
01191         InsertHeadList(&amp;<a class="code" href="../../d4/d9/ke_8h.html#a127">KeBugCheckCallbackListHead</a>, &amp;CallbackRecord-&gt;Entry);
01192         Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01193     }
01194 
01195     <span class="comment">//</span>
01196     <span class="comment">// Release the bug check callback spinlock, lower IRQL to its previous</span>
01197     <span class="comment">// value, and return whether the callback record was successfully</span>
01198     <span class="comment">// registered.</span>
01199     <span class="comment">//</span>
01200 
01201     KiReleaseSpinLock(&amp;<a class="code" href="../../d4/d9/ke_8h.html#a128">KeBugCheckCallbackLock</a>);
01202     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
01203     <span class="keywordflow">return</span> Inserted;
01204 }
01205 
01206 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01207"></a><a class="code" href="../../d9/d1/bugcheck_8c.html#a12">01207</a> <a class="code" href="../../d9/d1/bugcheck_8c.html#a12">KiScanBugCheckCallbackList</a> (
01208     VOID
01209     )
01210 
01211 <span class="comment">/*++</span>
01212 <span class="comment"></span>
01213 <span class="comment">Routine Description:</span>
01214 <span class="comment"></span>
01215 <span class="comment">    This function scans the bug check callback list and calls each bug</span>
01216 <span class="comment">    check callback routine so it can dump component specific information</span>
01217 <span class="comment">    that may identify the cause of the bug check.</span>
01218 <span class="comment"></span>
01219 <span class="comment">    N.B. The scan of the bug check callback list is performed VERY</span>
01220 <span class="comment">        carefully. Bug check callback routines are called at HIGH_LEVEL</span>
01221 <span class="comment">        and may not acquire ANY resources.</span>
01222 <span class="comment"></span>
01223 <span class="comment">Arguments:</span>
01224 <span class="comment"></span>
01225 <span class="comment">    None.</span>
01226 <span class="comment"></span>
01227 <span class="comment">Return Value:</span>
01228 <span class="comment"></span>
01229 <span class="comment">    None.</span>
01230 <span class="comment"></span>
01231 <span class="comment">--*/</span>
01232 
01233 {
01234 
01235     <a class="code" href="../../d4/d5/struct__KBUGCHECK__CALLBACK__RECORD.html">PKBUGCHECK_CALLBACK_RECORD</a> CallbackRecord;
01236     ULONG_PTR Checksum;
01237     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01238     PLIST_ENTRY LastEntry;
01239     PLIST_ENTRY ListHead;
01240     PLIST_ENTRY NextEntry;
01241     PUCHAR Source;
01242 
01243     <span class="comment">//</span>
01244     <span class="comment">// If the bug check callback listhead is not initialized, then the</span>
01245     <span class="comment">// bug check has occured before the system has gotten far enough</span>
01246     <span class="comment">// in the initialization code to enable anyone to register a callback.</span>
01247     <span class="comment">//</span>
01248 
01249     ListHead = &amp;<a class="code" href="../../d4/d9/ke_8h.html#a127">KeBugCheckCallbackListHead</a>;
01250     <span class="keywordflow">if</span> ((ListHead-&gt;Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (ListHead-&gt;Blink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01251 
01252         <span class="comment">//</span>
01253         <span class="comment">// Scan the bug check callback list.</span>
01254         <span class="comment">//</span>
01255 
01256         LastEntry = ListHead;
01257         NextEntry = ListHead-&gt;Flink;
01258         <span class="keywordflow">while</span> (NextEntry != ListHead) {
01259 
01260             <span class="comment">//</span>
01261             <span class="comment">// The next entry address must be aligned properly, the</span>
01262             <span class="comment">// callback record must be readable, and the callback record</span>
01263             <span class="comment">// must have back link to the last entry.</span>
01264             <span class="comment">//</span>
01265 
01266             <span class="keywordflow">if</span> (((ULONG_PTR)NextEntry &amp; (<span class="keyword">sizeof</span>(ULONG_PTR) - 1)) != 0) {
01267                 <span class="keywordflow">return</span>;
01268 
01269             } <span class="keywordflow">else</span> {
01270                 CallbackRecord = CONTAINING_RECORD(NextEntry,
01271                                                    <a class="code" href="../../d4/d5/struct__KBUGCHECK__CALLBACK__RECORD.html">KBUGCHECK_CALLBACK_RECORD</a>,
01272                                                    Entry);
01273 
01274                 Source = (PUCHAR)CallbackRecord;
01275                 <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/struct__KBUGCHECK__CALLBACK__RECORD.html">KBUGCHECK_CALLBACK_RECORD</a>); <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
01276                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/ppc_2debugsup_8c.html#a0">MmDbgReadCheck</a>((PVOID)Source) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01277                         <span class="keywordflow">return</span>;
01278                     }
01279 
01280                     Source += 1;
01281                 }
01282 
01283                 <span class="keywordflow">if</span> (CallbackRecord-&gt;<a class="code" href="../../d4/d5/struct__KBUGCHECK__CALLBACK__RECORD.html#o0">Entry</a>.Blink != LastEntry) {
01284                     <span class="keywordflow">return</span>;
01285                 }
01286 
01287                 <span class="comment">//</span>
01288                 <span class="comment">// If the callback record has a state of inserted and the</span>
01289                 <span class="comment">// computed checksum matches the callback record checksum,</span>
01290                 <span class="comment">// then call the specified bug check callback routine.</span>
01291                 <span class="comment">//</span>
01292 
01293                 Checksum = (ULONG_PTR)CallbackRecord-&gt;<a class="code" href="../../d4/d5/struct__KBUGCHECK__CALLBACK__RECORD.html#o1">CallbackRoutine</a>;
01294                 Checksum += (ULONG_PTR)CallbackRecord-&gt;<a class="code" href="../../d4/d5/struct__KBUGCHECK__CALLBACK__RECORD.html#o2">Buffer</a>;
01295                 Checksum += CallbackRecord-&gt;<a class="code" href="../../d4/d5/struct__KBUGCHECK__CALLBACK__RECORD.html#o3">Length</a>;
01296                 Checksum += (ULONG_PTR)CallbackRecord-&gt;<a class="code" href="../../d4/d5/struct__KBUGCHECK__CALLBACK__RECORD.html#o4">Component</a>;
01297                 <span class="keywordflow">if</span> ((CallbackRecord-&gt;<a class="code" href="../../d4/d5/struct__KBUGCHECK__CALLBACK__RECORD.html#o6">State</a> == <a class="code" href="../../d4/d9/ke_8h.html#a410a237">BufferInserted</a>) &amp;&amp;
01298                     (CallbackRecord-&gt;<a class="code" href="../../d4/d5/struct__KBUGCHECK__CALLBACK__RECORD.html#o5">Checksum</a> == Checksum)) {
01299 
01300                     <span class="comment">//</span>
01301                     <span class="comment">// Call the specified bug check callback routine and</span>
01302                     <span class="comment">// handle any exceptions that occur.</span>
01303                     <span class="comment">//</span>
01304 
01305                     CallbackRecord-&gt;<a class="code" href="../../d4/d5/struct__KBUGCHECK__CALLBACK__RECORD.html#o6">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a410a238">BufferStarted</a>;
01306                     <span class="keywordflow">try</span> {
01307                         (CallbackRecord-&gt;<a class="code" href="../../d4/d5/struct__KBUGCHECK__CALLBACK__RECORD.html#o1">CallbackRoutine</a>)(CallbackRecord-&gt;<a class="code" href="../../d4/d5/struct__KBUGCHECK__CALLBACK__RECORD.html#o2">Buffer</a>,
01308                                                           CallbackRecord-&gt;<a class="code" href="../../d4/d5/struct__KBUGCHECK__CALLBACK__RECORD.html#o3">Length</a>);
01309 
01310                         CallbackRecord-&gt;<a class="code" href="../../d4/d5/struct__KBUGCHECK__CALLBACK__RECORD.html#o6">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a410a239">BufferFinished</a>;
01311 
01312                     } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01313                         CallbackRecord-&gt;<a class="code" href="../../d4/d5/struct__KBUGCHECK__CALLBACK__RECORD.html#o6">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a410a240">BufferIncomplete</a>;
01314                     }
01315                 }
01316             }
01317 
01318             LastEntry = NextEntry;
01319             NextEntry = NextEntry-&gt;Flink;
01320         }
01321     }
01322 
01323     <span class="keywordflow">return</span>;
01324 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:19 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
