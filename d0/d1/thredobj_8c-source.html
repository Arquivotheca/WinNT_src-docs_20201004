<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: thredobj.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>thredobj.c</h1><a href="../../d9/d1/thredobj_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    threadobj.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the machine independent functions to manipulate</span>
00012 <span class="comment">    the kernel thread object. Functions are provided to initialize, ready,</span>
00013 <span class="comment">    alert, test alert, boost priority, enable APC queuing, disable APC</span>
00014 <span class="comment">    queuing, confine, set affinity, set priority, suspend, resume, alert</span>
00015 <span class="comment">    resume, terminate, read thread state, freeze, unfreeze, query data</span>
00016 <span class="comment">    alignment handling mode, force resume, and enter and leave critical</span>
00017 <span class="comment">    regions for thread objects.</span>
00018 <span class="comment"></span>
00019 <span class="comment">Author:</span>
00020 <span class="comment"></span>
00021 <span class="comment">    David N. Cutler (davec) 4-Mar-1989</span>
00022 <span class="comment"></span>
00023 <span class="comment">Environment:</span>
00024 <span class="comment"></span>
00025 <span class="comment">    Kernel mode only.</span>
00026 <span class="comment"></span>
00027 <span class="comment">Revision History:</span>
00028 <span class="comment"></span>
00029 <span class="comment">--*/</span>
00030 
00031 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00032 
00033 <span class="comment">//</span>
00034 <span class="comment">// The following assert macro is used to check that an input thread object is</span>
00035 <span class="comment">// really a kthread and not something else, like deallocated pool.</span>
00036 <span class="comment">//</span>
00037 
<a name="l00038"></a><a class="code" href="../../d9/d1/thredobj_8c.html#a0">00038</a> <span class="preprocessor">#define ASSERT_THREAD(E) {                    \</span>
00039 <span class="preprocessor">    ASSERT((E)-&gt;Header.Type == ThreadObject); \</span>
00040 <span class="preprocessor">}</span>
00041 <span class="preprocessor"></span>
00042 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00043"></a><a class="code" href="../../d9/d1/thredobj_8c.html#a1">00043</a> <a class="code" href="../../d9/d1/thredobj_8c.html#a1">KeInitializeThread</a> (
00044     IN <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread,
00045     IN PVOID KernelStack,
00046     IN PKSYSTEM_ROUTINE SystemRoutine,
00047     IN PKSTART_ROUTINE StartRoutine OPTIONAL,
00048     IN PVOID StartContext OPTIONAL,
00049     IN PCONTEXT ContextFrame OPTIONAL,
00050     IN PVOID Teb OPTIONAL,
00051     IN <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process
00052     )
00053 
00054 <span class="comment">/*++</span>
00055 <span class="comment"></span>
00056 <span class="comment">Routine Description:</span>
00057 <span class="comment"></span>
00058 <span class="comment">    This function initializes a thread object. The priority, affinity,</span>
00059 <span class="comment">    and initial quantum are taken from the parent process object. The</span>
00060 <span class="comment">    thread object is inserted at the end of the thread list for the</span>
00061 <span class="comment">    parent process.</span>
00062 <span class="comment"></span>
00063 <span class="comment">    N.B. This routine is carefully written so that if an access violation</span>
00064 <span class="comment">        occurs while reading the specified context frame, then no kernel</span>
00065 <span class="comment">        data structures will have been modified. It is the responsibility</span>
00066 <span class="comment">        of the caller to handle the exception and provide necessary clean</span>
00067 <span class="comment">        up.</span>
00068 <span class="comment"></span>
00069 <span class="comment">    N.B. It is assumed that the thread object is zeroed.</span>
00070 <span class="comment"></span>
00071 <span class="comment">Arguments:</span>
00072 <span class="comment"></span>
00073 <span class="comment">    Thread - Supplies a pointer to a dispatcher object of type thread.</span>
00074 <span class="comment"></span>
00075 <span class="comment">    KernelStack - Supplies a pointer to the base of a kernel stack on which</span>
00076 <span class="comment">        the context frame for the thread is to be constructed.</span>
00077 <span class="comment"></span>
00078 <span class="comment">    SystemRoutine - Supplies a pointer to the system function that is to be</span>
00079 <span class="comment">        called when the thread is first scheduled for execution.</span>
00080 <span class="comment"></span>
00081 <span class="comment">    StartRoutine - Supplies an optional pointer to a function that is to be</span>
00082 <span class="comment">        called after the system has finished initializing the thread. This</span>
00083 <span class="comment">        parameter is specified if the thread is a system thread and will</span>
00084 <span class="comment">        execute totally in kernel mode.</span>
00085 <span class="comment"></span>
00086 <span class="comment">    StartContext - Supplies an optional pointer to an arbitrary data structure</span>
00087 <span class="comment">        which will be passed to the StartRoutine as a parameter. This</span>
00088 <span class="comment">        parameter is specified if the thread is a system thread and will</span>
00089 <span class="comment">        execute totally in kernel mode.</span>
00090 <span class="comment"></span>
00091 <span class="comment">    ContextFrame - Supplies an optional pointer a context frame which contains</span>
00092 <span class="comment">        the initial user mode state of the thread. This parameter is specified</span>
00093 <span class="comment">        if the thread is a user thread and will execute in user mode. If this</span>
00094 <span class="comment">        parameter is not specified, then the Teb parameter is ignored.</span>
00095 <span class="comment"></span>
00096 <span class="comment">    Teb - Supplies an optional pointer to the user mode thread environment</span>
00097 <span class="comment">        block. This parameter is specified if the thread is a user thread and</span>
00098 <span class="comment">        will execute in user mode. This parameter is ignored if the ContextFrame</span>
00099 <span class="comment">        parameter is not specified.</span>
00100 <span class="comment"></span>
00101 <span class="comment">    Process - Supplies a pointer to a control object of type process.</span>
00102 <span class="comment"></span>
00103 <span class="comment">Return Value:</span>
00104 <span class="comment"></span>
00105 <span class="comment">    None.</span>
00106 <span class="comment"></span>
00107 <span class="comment">--*/</span>
00108 
00109 {
00110 
00111     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00112     KIRQL OldIrql;
00113     <a class="code" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer;
00114     <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">PKWAIT_BLOCK</a> WaitBlock;
00115 
00116     <span class="comment">//</span>
00117     <span class="comment">// Initialize the standard dispatcher object header and set the initial</span>
00118     <span class="comment">// state of the thread object.</span>
00119     <span class="comment">//</span>
00120 
00121     Thread-&gt;Header.Type = <a class="code" href="../../d4/d9/ke_8h.html#a402a163">ThreadObject</a>;
00122     Thread-&gt;Header.Size = <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__KTHREAD.html">KTHREAD</a>) / <span class="keyword">sizeof</span>(LONG);
00123     InitializeListHead(&amp;Thread-&gt;Header.WaitListHead);
00124 
00125     <span class="comment">//</span>
00126     <span class="comment">// Initialize the owned mutant listhead.</span>
00127     <span class="comment">//</span>
00128 
00129     InitializeListHead(&amp;Thread-&gt;MutantListHead);
00130 
00131     <span class="comment">//</span>
00132     <span class="comment">// Initialize the thread field of all builtin wait blocks.</span>
00133     <span class="comment">//</span>
00134 
00135     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; (<a class="code" href="../../d4/d9/ke_8h.html#a6">THREAD_WAIT_OBJECTS</a> + 1); <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00136         Thread-&gt;WaitBlock[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Thread = Thread;
00137     }
00138 
00139     <span class="comment">//</span>
00140     <span class="comment">// Initialize the alerted, preempted, debugactive, autoalignment,</span>
00141     <span class="comment">// kernel stack resident, enable kernel stack swap, and process</span>
00142     <span class="comment">// ready queue boolean values.</span>
00143     <span class="comment">//</span>
00144     <span class="comment">// N.B. Only nonzero values are initialized.</span>
00145     <span class="comment">//</span>
00146 
00147     Thread-&gt;AutoAlignment = Process-&gt;AutoAlignment;
00148     Thread-&gt;EnableStackSwap = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00149     Thread-&gt;KernelStackResident = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00150 
00151     <span class="comment">//</span>
00152     <span class="comment">// Set the system service table pointer to the address of the static</span>
00153     <span class="comment">// system service descriptor table. If the thread is later converted</span>
00154     <span class="comment">// to a Win32 thread this pointer will be change to a pointer to the</span>
00155     <span class="comment">// shadow system service descriptor table.</span>
00156     <span class="comment">//</span>
00157 
00158     Thread-&gt;ServiceTable = (PVOID)&amp;<a class="code" href="../../d4/d9/ke_8h.html#a145">KeServiceDescriptorTable</a>[0];
00159 
00160     <span class="comment">//</span>
00161     <span class="comment">// Initialize the APC state pointers, the current APC state, the saved</span>
00162     <span class="comment">// APC state, and enable APC queuing.</span>
00163     <span class="comment">//</span>
00164 
00165     Thread-&gt;ApcStatePointer[0] = &amp;Thread-&gt;ApcState;
00166     Thread-&gt;ApcStatePointer[1] = &amp;Thread-&gt;SavedApcState;
00167     InitializeListHead(&amp;Thread-&gt;ApcState.ApcListHead[<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>]);
00168     InitializeListHead(&amp;Thread-&gt;ApcState.ApcListHead[<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>]);
00169     Thread-&gt;ApcState.Process = Process;
00170     Thread-&gt;ApcQueueable = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00171 
00172     <span class="comment">//</span>
00173     <span class="comment">// Initialize the kernel mode suspend APC and the suspend semaphore object.</span>
00174     <span class="comment">// and the builtin wait timeout timer object.</span>
00175     <span class="comment">//</span>
00176 
00177     <a class="code" href="../../d5/d7/apcobj_8c.html#a1">KeInitializeApc</a>(&amp;Thread-&gt;SuspendApc,
00178                     Thread,
00179                     <a class="code" href="../../d4/d9/ke_8h.html#a403a181">OriginalApcEnvironment</a>,
00180                     (<a class="code" href="../../d0/d9/ntosdef_8h.html#a42">PKKERNEL_ROUTINE</a>)<a class="code" href="../../d0/d0/ki_8h.html#a135">KiSuspendNop</a>,
00181                     (<a class="code" href="../../d0/d9/ntosdef_8h.html#a43">PKRUNDOWN_ROUTINE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00182                     <a class="code" href="../../d0/d0/ki_8h.html#a136">KiSuspendThread</a>,
00183                     <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00184                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00185 
00186     <a class="code" href="../../d1/d6/semphobj_8c.html#a1">KeInitializeSemaphore</a>(&amp;Thread-&gt;SuspendSemaphore, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, 2<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00187 
00188     <span class="comment">//</span>
00189     <span class="comment">// Initialize the builtin timer trimer wait wait block.</span>
00190     <span class="comment">//</span>
00191     <span class="comment">// N.B. This is the only time the wait block is initialized sincs this</span>
00192     <span class="comment">//      information is constant.</span>
00193     <span class="comment">//</span>
00194 
00195     Timer = &amp;Thread-&gt;Timer;
00196     <a class="code" href="../../d3/d2/timerobj_8c.html#a1">KeInitializeTimer</a>(Timer);
00197     WaitBlock = &amp;Thread-&gt;WaitBlock[<a class="code" href="../../d4/d9/ke_8h.html#a9">TIMER_WAIT_BLOCK</a>];
00198     WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o2">Object</a> = Timer;
00199     WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o4">WaitKey</a> = (CSHORT)STATUS_TIMEOUT;
00200     WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o5">WaitType</a> = WaitAny;
00201     WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o0">WaitListEntry</a>.Flink = &amp;Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o5">WaitListHead</a>;
00202     WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o0">WaitListEntry</a>.Blink = &amp;Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o5">WaitListHead</a>;
00203 
00204     <span class="comment">//</span>
00205     <span class="comment">// Initialize the APC queue spinlock.</span>
00206     <span class="comment">//</span>
00207 
00208     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;Thread-&gt;ApcQueueLock);
00209 
00210     <span class="comment">//</span>
00211     <span class="comment">// Initialize the Thread Environment Block (TEB) pointer (can be NULL).</span>
00212     <span class="comment">//</span>
00213 
00214     Thread-&gt;Teb = Teb;
00215 
00216     <span class="comment">//</span>
00217     <span class="comment">// Set the initial kernel stack and the initial thread context.</span>
00218     <span class="comment">//</span>
00219 
00220     Thread-&gt;InitialStack = KernelStack;
00221     Thread-&gt;StackBase = KernelStack;
00222     Thread-&gt;StackLimit = (PVOID)((ULONG_PTR)KernelStack - KERNEL_STACK_SIZE);
00223     <a class="code" href="../../d8/d1/ppc_2thredini_8c.html#a2">KiInitializeContextThread</a>(Thread,
00224                               SystemRoutine,
00225                               StartRoutine,
00226                               StartContext,
00227                               ContextFrame);
00228 
00229     <span class="comment">//</span>
00230     <span class="comment">// Set the base thread priority, the thread priority, the thread affinity,</span>
00231     <span class="comment">// the thread quantum, and the scheduling state.</span>
00232     <span class="comment">//</span>
00233 
00234     Thread-&gt;BasePriority = Process-&gt;BasePriority;
00235     Thread-&gt;Priority = Thread-&gt;BasePriority;
00236     Thread-&gt;Affinity = Process-&gt;Affinity;
00237     Thread-&gt;UserAffinity = Process-&gt;Affinity;
00238     Thread-&gt;SystemAffinityActive = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00239     Thread-&gt;Quantum = Process-&gt;ThreadQuantum;
00240     Thread-&gt;State = <a class="code" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a>;
00241     Thread-&gt;DisableBoost = Process-&gt;DisableBoost;
00242 
00243 <span class="preprocessor">#ifdef i386</span>
00244 <span class="preprocessor"></span>
00245     Thread-&gt;Iopl = Process-&gt;Iopl;
00246 
00247 <span class="preprocessor">#endif</span>
00248 <span class="preprocessor"></span>
00249     <span class="comment">//</span>
00250     <span class="comment">// Lock the dispatcher database, insert the thread in the process</span>
00251     <span class="comment">// thread list, increment the kernel stack count, and unlock the</span>
00252     <span class="comment">// dispatcher database.</span>
00253     <span class="comment">//</span>
00254     <span class="comment">// N.B. The distinguished value MAXSHORT is used to signify that no</span>
00255     <span class="comment">//      threads have been created for a process.</span>
00256     <span class="comment">//</span>
00257 
00258     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00259     InsertTailList(&amp;Process-&gt;ThreadListHead, &amp;Thread-&gt;ThreadListEntry);
00260     <span class="keywordflow">if</span> (Process-&gt;StackCount == MAXSHORT) {
00261         Process-&gt;StackCount = 1;
00262 
00263     } <span class="keywordflow">else</span> {
00264         Process-&gt;StackCount += 1;
00265     }
00266 
00267     <span class="comment">//</span>
00268     <span class="comment">// Initialize the ideal processor number for the thread.</span>
00269     <span class="comment">//</span>
00270     <span class="comment">//  N.B. This must be done under the dispatcher lock to prevent byte</span>
00271     <span class="comment">//      granularity problems on Alpha.</span>
00272     <span class="comment">//</span>
00273 
00274     Process-&gt;ThreadSeed += 1;
00275     Thread-&gt;IdealProcessor = (UCHAR)(Process-&gt;ThreadSeed % <a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>);
00276     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00277     <span class="keywordflow">return</span>;
00278 }
00279 
00280 BOOLEAN
<a name="l00281"></a><a class="code" href="../../d9/d1/thredobj_8c.html#a2">00281</a> <a class="code" href="../../d9/d1/thredobj_8c.html#a2">KeAlertThread</a> (
00282     IN <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread,
00283     IN KPROCESSOR_MODE AlertMode
00284     )
00285 
00286 <span class="comment">/*++</span>
00287 <span class="comment"></span>
00288 <span class="comment">Routine Description:</span>
00289 <span class="comment"></span>
00290 <span class="comment">    This function attempts to alert a thread and cause its execution to</span>
00291 <span class="comment">    be continued if it is currently in an alertable Wait state. Otherwise</span>
00292 <span class="comment">    it just sets the alerted variable for the specified processor mode.</span>
00293 <span class="comment"></span>
00294 <span class="comment">Arguments:</span>
00295 <span class="comment"></span>
00296 <span class="comment">    Thread  - Supplies a pointer to a dispatcher object of type thread.</span>
00297 <span class="comment"></span>
00298 <span class="comment">    AlertMode - Supplies the processor mode for which the thread is</span>
00299 <span class="comment">        to be alerted.</span>
00300 <span class="comment"></span>
00301 <span class="comment">Return Value:</span>
00302 <span class="comment"></span>
00303 <span class="comment">    The previous state of the alerted variable for the specified processor</span>
00304 <span class="comment">    mode.</span>
00305 <span class="comment"></span>
00306 <span class="comment">--*/</span>
00307 
00308 {
00309 
00310     BOOLEAN Alerted;
00311     KIRQL OldIrql;
00312 
00313     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a1">ASSERT_THREAD</a>(Thread);
00314     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00315 
00316     <span class="comment">//</span>
00317     <span class="comment">// Raise IRQL to dispatcher level, lock dispatcher database, and lock</span>
00318     <span class="comment">// APC queue.</span>
00319     <span class="comment">//</span>
00320 
00321     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00322     KiAcquireSpinLock(&amp;Thread-&gt;ApcQueueLock);
00323 
00324     <span class="comment">//</span>
00325     <span class="comment">// Capture the current state of the alerted variable for the specified</span>
00326     <span class="comment">// processor mode.</span>
00327     <span class="comment">//</span>
00328 
00329     Alerted = Thread-&gt;Alerted[AlertMode];
00330 
00331     <span class="comment">//</span>
00332     <span class="comment">// If the alerted state for the specified processor mode is Not-Alerted,</span>
00333     <span class="comment">// then attempt to alert the thread.</span>
00334     <span class="comment">//</span>
00335 
00336     <span class="keywordflow">if</span> (Alerted == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00337 
00338         <span class="comment">//</span>
00339         <span class="comment">// If the thread is currently in a Wait state, the Wait is alertable,</span>
00340         <span class="comment">// and the specified processor mode is less than or equal to the Wait</span>
00341         <span class="comment">// mode, then the thread is unwaited with a status of "alerted".</span>
00342         <span class="comment">//</span>
00343 
00344         <span class="keywordflow">if</span> ((Thread-&gt;State == <a class="code" href="../../d4/d9/ke_8h.html#a406a196">Waiting</a>) &amp;&amp; (Thread-&gt;Alertable == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp;
00345             (AlertMode &lt;= Thread-&gt;WaitMode)) {
00346             <a class="code" href="../../d2/d7/waitsup_8c.html#a0">KiUnwaitThread</a>(Thread, STATUS_ALERTED, <a class="code" href="../../d0/d0/ki_8h.html#a0">ALERT_INCREMENT</a>);
00347 
00348         } <span class="keywordflow">else</span> {
00349             Thread-&gt;Alerted[AlertMode] = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00350         }
00351     }
00352 
00353     <span class="comment">//</span>
00354     <span class="comment">// Unlock APC queue, unlock dispatcher database, lower IRQL to its</span>
00355     <span class="comment">// previous value, and return the previous alerted state for the</span>
00356     <span class="comment">// specified mode.</span>
00357     <span class="comment">//</span>
00358 
00359     KiReleaseSpinLock(&amp;Thread-&gt;ApcQueueLock);
00360     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00361     <span class="keywordflow">return</span> Alerted;
00362 }
00363 
00364 ULONG
<a name="l00365"></a><a class="code" href="../../d9/d1/thredobj_8c.html#a3">00365</a> <a class="code" href="../../d9/d1/thredobj_8c.html#a3">KeAlertResumeThread</a> (
00366     IN <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread
00367     )
00368 
00369 <span class="comment">/*++</span>
00370 <span class="comment"></span>
00371 <span class="comment">Routine Description:</span>
00372 <span class="comment"></span>
00373 <span class="comment">    This function attempts to alert a thread in kernel mode and cause its</span>
00374 <span class="comment">    execution to be continued if it is currently in an alertable Wait state.</span>
00375 <span class="comment">    In addition, a resume operation is performed on the specified thread.</span>
00376 <span class="comment"></span>
00377 <span class="comment">Arguments:</span>
00378 <span class="comment"></span>
00379 <span class="comment">    Thread  - Supplies a pointer to a dispatcher object of type thread.</span>
00380 <span class="comment"></span>
00381 <span class="comment">Return Value:</span>
00382 <span class="comment"></span>
00383 <span class="comment">    The previous suspend count.</span>
00384 <span class="comment"></span>
00385 <span class="comment">--*/</span>
00386 
00387 {
00388 
00389     ULONG OldCount;
00390     KIRQL OldIrql;
00391 
00392     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a1">ASSERT_THREAD</a>(Thread);
00393     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00394 
00395     <span class="comment">//</span>
00396     <span class="comment">// Raise IRQL to dispatcher level, lock dispatcher database, and lock</span>
00397     <span class="comment">// APC queue.</span>
00398     <span class="comment">//</span>
00399 
00400     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00401     KiAcquireSpinLock(&amp;Thread-&gt;ApcQueueLock);
00402 
00403     <span class="comment">//</span>
00404     <span class="comment">// If the kernel mode alerted state is FALSE, then attempt to alert</span>
00405     <span class="comment">// the thread for kernel mode.</span>
00406     <span class="comment">//</span>
00407 
00408     <span class="keywordflow">if</span> (Thread-&gt;Alerted[<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>] == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00409 
00410         <span class="comment">//</span>
00411         <span class="comment">// If the thread is currently in a Wait state and the Wait is alertable,</span>
00412         <span class="comment">// then the thread is unwaited with a status of "alerted". Else set the</span>
00413         <span class="comment">// kernel mode alerted variable.</span>
00414         <span class="comment">//</span>
00415 
00416         <span class="keywordflow">if</span> ((Thread-&gt;State == <a class="code" href="../../d4/d9/ke_8h.html#a406a196">Waiting</a>) &amp;&amp; (Thread-&gt;Alertable == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00417             <a class="code" href="../../d2/d7/waitsup_8c.html#a0">KiUnwaitThread</a>(Thread, STATUS_ALERTED, <a class="code" href="../../d0/d0/ki_8h.html#a0">ALERT_INCREMENT</a>);
00418 
00419         } <span class="keywordflow">else</span> {
00420             Thread-&gt;Alerted[<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>] = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00421         }
00422     }
00423 
00424     <span class="comment">//</span>
00425     <span class="comment">// Capture the current suspend count.</span>
00426     <span class="comment">//</span>
00427 
00428     OldCount = Thread-&gt;SuspendCount;
00429 
00430     <span class="comment">//</span>
00431     <span class="comment">// If the thread is currently suspended, then decrement its suspend count.</span>
00432     <span class="comment">//</span>
00433 
00434     <span class="keywordflow">if</span> (OldCount != 0) {
00435         Thread-&gt;SuspendCount -= 1;
00436 
00437         <span class="comment">//</span>
00438         <span class="comment">// If the resultant suspend count is zero and the freeze count is</span>
00439         <span class="comment">// zero, then resume the thread by releasing its suspend semaphore.</span>
00440         <span class="comment">//</span>
00441 
00442         <span class="keywordflow">if</span> ((Thread-&gt;SuspendCount == 0) &amp;&amp; (Thread-&gt;FreezeCount == 0)) {
00443             Thread-&gt;SuspendSemaphore.Header.SignalState += 1;
00444             <a class="code" href="../../d2/d7/waitsup_8c.html#a3">KiWaitTest</a>(&amp;Thread-&gt;SuspendSemaphore, <a class="code" href="../../d0/d0/ki_8h.html#a2">RESUME_INCREMENT</a>);
00445         }
00446     }
00447 
00448     <span class="comment">//</span>
00449     <span class="comment">// Unlock APC queue, unlock dispatcher database, lower IRQL to its</span>
00450     <span class="comment">// previous value, and return the previous suspend count.</span>
00451     <span class="comment">//</span>
00452 
00453     KiReleaseSpinLock(&amp;Thread-&gt;ApcQueueLock);
00454     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00455     <span class="keywordflow">return</span> OldCount;
00456 }
00457 
00458 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00459"></a><a class="code" href="../../d9/d1/thredobj_8c.html#a4">00459</a> <a class="code" href="../../d9/d1/thredobj_8c.html#a4">KeBoostPriorityThread</a> (
00460     IN <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread,
00461     IN KPRIORITY Increment
00462     )
00463 
00464 <span class="comment">/*++</span>
00465 <span class="comment"></span>
00466 <span class="comment">Routine Description:</span>
00467 <span class="comment"></span>
00468 <span class="comment">    This function boosts the priority of the specified thread using the</span>
00469 <span class="comment">    same algorithm used when a thread gets a boost from a wait operation.</span>
00470 <span class="comment"></span>
00471 <span class="comment">Arguments:</span>
00472 <span class="comment"></span>
00473 <span class="comment">    Thread  - Supplies a pointer to a dispatcher object of type thread.</span>
00474 <span class="comment"></span>
00475 <span class="comment">    Increment - Supplies the priority increment that is to be applied to</span>
00476 <span class="comment">        the thread's priority.</span>
00477 <span class="comment"></span>
00478 <span class="comment">Return Value:</span>
00479 <span class="comment"></span>
00480 <span class="comment">    None.</span>
00481 <span class="comment"></span>
00482 <span class="comment">--*/</span>
00483 
00484 {
00485 
00486     KIRQL OldIrql;
00487 
00488     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00489 
00490     <span class="comment">//</span>
00491     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00492     <span class="comment">//</span>
00493 
00494     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00495 
00496     <span class="comment">//</span>
00497     <span class="comment">// If the thread does not run at a realtime priority level, then boost</span>
00498     <span class="comment">// the thread priority.</span>
00499     <span class="comment">//</span>
00500 
00501     <span class="keywordflow">if</span> (Thread-&gt;Priority &lt; LOW_REALTIME_PRIORITY) {
00502         <a class="code" href="../../d0/d0/ki_8h.html#a14">KiBoostPriorityThread</a>(Thread, <a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a>);
00503     }
00504 
00505     <span class="comment">//</span>
00506     <span class="comment">// Unlock dispatcher database and lower IRQL to its previous</span>
00507     <span class="comment">// value.</span>
00508     <span class="comment">//</span>
00509 
00510     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00511     <span class="keywordflow">return</span>;
00512 }
00513 
00514 KAFFINITY
<a name="l00515"></a><a class="code" href="../../d9/d1/thredobj_8c.html#a5">00515</a> <a class="code" href="../../d9/d1/thredobj_8c.html#a5">KeConfineThread</a> (
00516     VOID
00517     )
00518 
00519 <span class="comment">/*++</span>
00520 <span class="comment"></span>
00521 <span class="comment">Routine Description:</span>
00522 <span class="comment"></span>
00523 <span class="comment">    This function confines the execution of the current thread to the current</span>
00524 <span class="comment">    processor.</span>
00525 <span class="comment"></span>
00526 <span class="comment">Arguments:</span>
00527 <span class="comment"></span>
00528 <span class="comment">    Thread  - Supplies a pointer to a dispatcher object of type thread.</span>
00529 <span class="comment"></span>
00530 <span class="comment">Return Value:</span>
00531 <span class="comment"></span>
00532 <span class="comment">    The previous affinity value.</span>
00533 <span class="comment"></span>
00534 <span class="comment">--*/</span>
00535 
00536 {
00537 
00538     KAFFINITY Affinity;
00539     KIRQL OldIrql;
00540     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00541 
00542     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00543 
00544     <span class="comment">//</span>
00545     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00546     <span class="comment">//</span>
00547 
00548     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00549     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00550 
00551     <span class="comment">//</span>
00552     <span class="comment">// Capture the current affinity and compute new affinity value by</span>
00553     <span class="comment">// shifting a one bit left by the current processor number.</span>
00554     <span class="comment">//</span>
00555 
00556     Affinity = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o41">Affinity</a>;
00557     Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o41">Affinity</a> = (KAFFINITY)(1 &lt;&lt; Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o45">NextProcessor</a>);
00558 
00559     <span class="comment">//</span>
00560     <span class="comment">// Unlock dispatcher database and lower IRQL to its previous</span>
00561     <span class="comment">// value.</span>
00562     <span class="comment">//</span>
00563 
00564     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00565 
00566     <span class="comment">//</span>
00567     <span class="comment">// Return the previous affinity value.</span>
00568     <span class="comment">//</span>
00569 
00570     <span class="keywordflow">return</span> Affinity;
00571 }
00572 
00573 BOOLEAN
<a name="l00574"></a><a class="code" href="../../d9/d1/thredobj_8c.html#a6">00574</a> <a class="code" href="../../d9/d1/thredobj_8c.html#a6">KeDisableApcQueuingThread</a> (
00575     IN <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread
00576     )
00577 
00578 <span class="comment">/*++</span>
00579 <span class="comment"></span>
00580 <span class="comment">Routine Description:</span>
00581 <span class="comment"></span>
00582 <span class="comment">    This function disables the queuing of APC's to the specified thread.</span>
00583 <span class="comment"></span>
00584 <span class="comment">Arguments:</span>
00585 <span class="comment"></span>
00586 <span class="comment">    Thread  - Supplies a pointer to a dispatcher object of type thread.</span>
00587 <span class="comment"></span>
00588 <span class="comment">Return Value:</span>
00589 <span class="comment"></span>
00590 <span class="comment">    The previous value of the APC queuing state variable.</span>
00591 <span class="comment"></span>
00592 <span class="comment">--*/</span>
00593 
00594 {
00595 
00596     BOOLEAN ApcQueueable;
00597     KIRQL OldIrql;
00598 
00599     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a1">ASSERT_THREAD</a>(Thread);
00600     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00601 
00602     <span class="comment">//</span>
00603     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00604     <span class="comment">//</span>
00605 
00606     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00607 
00608     <span class="comment">//</span>
00609     <span class="comment">// Capture the current state of the APC queueable state variable and</span>
00610     <span class="comment">// set its state to FALSE.</span>
00611     <span class="comment">//</span>
00612 
00613     ApcQueueable = Thread-&gt;ApcQueueable;
00614     Thread-&gt;ApcQueueable = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00615 
00616     <span class="comment">//</span>
00617     <span class="comment">// Unlock dispatcher database and lower IRQL to its previous</span>
00618     <span class="comment">// value.</span>
00619     <span class="comment">//</span>
00620 
00621     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00622 
00623     <span class="comment">//</span>
00624     <span class="comment">// Return the previous APC queueable state.</span>
00625     <span class="comment">//</span>
00626 
00627     <span class="keywordflow">return</span> ApcQueueable;
00628 }
00629 
00630 BOOLEAN
<a name="l00631"></a><a class="code" href="../../d9/d1/thredobj_8c.html#a7">00631</a> <a class="code" href="../../d9/d1/thredobj_8c.html#a7">KeEnableApcQueuingThread</a> (
00632     IN <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread
00633     )
00634 
00635 <span class="comment">/*++</span>
00636 <span class="comment"></span>
00637 <span class="comment">Routine Description:</span>
00638 <span class="comment"></span>
00639 <span class="comment">    This function enables the queuing of APC's to the specified thread.</span>
00640 <span class="comment"></span>
00641 <span class="comment">Arguments:</span>
00642 <span class="comment"></span>
00643 <span class="comment">    Thread  - Supplies a pointer to a dispatcher object of type thread.</span>
00644 <span class="comment"></span>
00645 <span class="comment">Return Value:</span>
00646 <span class="comment"></span>
00647 <span class="comment">    The previous value of the APC queuing state variable.</span>
00648 <span class="comment"></span>
00649 <span class="comment">--*/</span>
00650 
00651 {
00652 
00653     BOOLEAN ApcQueueable;
00654     KIRQL OldIrql;
00655 
00656     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a1">ASSERT_THREAD</a>(Thread);
00657     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00658 
00659     <span class="comment">//</span>
00660     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00661     <span class="comment">//</span>
00662 
00663     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00664 
00665     <span class="comment">//</span>
00666     <span class="comment">// Capture the current state of the APC queueable state variable and</span>
00667     <span class="comment">// set its state to TRUE.</span>
00668     <span class="comment">//</span>
00669 
00670     ApcQueueable = Thread-&gt;ApcQueueable;
00671     Thread-&gt;ApcQueueable = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00672 
00673     <span class="comment">//</span>
00674     <span class="comment">// Unlock dispatcher database and lower IRQL to its previous</span>
00675     <span class="comment">// value.</span>
00676     <span class="comment">//</span>
00677 
00678     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00679 
00680     <span class="comment">//</span>
00681     <span class="comment">// Return previous APC queueable state.</span>
00682     <span class="comment">//</span>
00683 
00684     <span class="keywordflow">return</span> ApcQueueable;
00685 }
00686 
00687 ULONG
<a name="l00688"></a><a class="code" href="../../d9/d1/thredobj_8c.html#a8">00688</a> <a class="code" href="../../d9/d1/thredobj_8c.html#a8">KeForceResumeThread</a> (
00689     IN <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread
00690     )
00691 
00692 <span class="comment">/*++</span>
00693 <span class="comment"></span>
00694 <span class="comment">Routine Description:</span>
00695 <span class="comment"></span>
00696 <span class="comment">    This function forces resumption of thread execution if the thread is</span>
00697 <span class="comment">    suspended. If the specified thread is not suspended, then no operation</span>
00698 <span class="comment">    is performed.</span>
00699 <span class="comment"></span>
00700 <span class="comment">Arguments:</span>
00701 <span class="comment"></span>
00702 <span class="comment">    Thread  - Supplies a pointer to a dispatcher object of type thread.</span>
00703 <span class="comment"></span>
00704 <span class="comment">Return Value:</span>
00705 <span class="comment"></span>
00706 <span class="comment">    The sum of the previous suspend count and the freeze count.</span>
00707 <span class="comment"></span>
00708 <span class="comment">--*/</span>
00709 
00710 {
00711 
00712     ULONG OldCount;
00713     KIRQL OldIrql;
00714 
00715     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a1">ASSERT_THREAD</a>(Thread);
00716     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00717 
00718     <span class="comment">//</span>
00719     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00720     <span class="comment">//</span>
00721 
00722     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00723 
00724     <span class="comment">//</span>
00725     <span class="comment">// Capture the current suspend count.</span>
00726     <span class="comment">//</span>
00727 
00728     OldCount = Thread-&gt;SuspendCount + Thread-&gt;FreezeCount;
00729 
00730     <span class="comment">//</span>
00731     <span class="comment">// If the thread is currently suspended, then force resumption of</span>
00732     <span class="comment">// thread execution.</span>
00733     <span class="comment">//</span>
00734 
00735     <span class="keywordflow">if</span> (OldCount != 0) {
00736         Thread-&gt;FreezeCount = 0;
00737         Thread-&gt;SuspendCount = 0;
00738         Thread-&gt;SuspendSemaphore.Header.SignalState += 1;
00739         <a class="code" href="../../d2/d7/waitsup_8c.html#a3">KiWaitTest</a>(&amp;Thread-&gt;SuspendSemaphore, <a class="code" href="../../d0/d0/ki_8h.html#a2">RESUME_INCREMENT</a>);
00740     }
00741 
00742     <span class="comment">//</span>
00743     <span class="comment">// Unlock dispatcher database and lower IRQL to its previous</span>
00744     <span class="comment">// value.</span>
00745     <span class="comment">//</span>
00746 
00747     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00748 
00749     <span class="comment">//</span>
00750     <span class="comment">// Return the previous suspend count.</span>
00751     <span class="comment">//</span>
00752 
00753     <span class="keywordflow">return</span> OldCount;
00754 }
00755 
00756 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00757"></a><a class="code" href="../../d9/d1/thredobj_8c.html#a9">00757</a> <a class="code" href="../../d9/d1/thredobj_8c.html#a9">KeFreezeAllThreads</a> (
00758     VOID
00759     )
00760 
00761 <span class="comment">/*++</span>
00762 <span class="comment"></span>
00763 <span class="comment">Routine Description:</span>
00764 <span class="comment"></span>
00765 <span class="comment">    This function suspends the execution of all thread in the current</span>
00766 <span class="comment">    process except the current thread. If the freeze count overflows</span>
00767 <span class="comment">    the maximum suspend count, then a condition is raised.</span>
00768 <span class="comment"></span>
00769 <span class="comment">Arguments:</span>
00770 <span class="comment"></span>
00771 <span class="comment">    None.</span>
00772 <span class="comment"></span>
00773 <span class="comment">Return Value:</span>
00774 <span class="comment"></span>
00775 <span class="comment">    None.</span>
00776 <span class="comment"></span>
00777 <span class="comment">--*/</span>
00778 
00779 {
00780 
00781     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> CurrentThread;
00782     PLIST_ENTRY ListHead;
00783     PLIST_ENTRY NextEntry;
00784     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00785     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00786     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> EThread;
00787     ULONG OldCount;
00788     KIRQL OldIrql;
00789 
00790     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00791 
00792     <span class="comment">//</span>
00793     <span class="comment">// Get the address of the current thread object, the current process</span>
00794     <span class="comment">// object, raise IRQL to dispatch level, lock dispatcher database,</span>
00795     <span class="comment">// and freeze the execution of all threads in the process except the</span>
00796     <span class="comment">// current thread.</span>
00797     <span class="comment">//</span>
00798 
00799     CurrentThread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00800     Process = CurrentThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>;
00801     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00802 
00803     <span class="comment">//</span>
00804     <span class="comment">// If the freeze count of the current thread is not zero, then there</span>
00805     <span class="comment">// is another thread that is trying to freeze this thread. Unlock the</span>
00806     <span class="comment">// dispatcher, lower IRQL to its previous value, allow the suspend</span>
00807     <span class="comment">// APC to occur, then raise IRQL to dispatch level, lock the dispatcher</span>
00808     <span class="comment">// database, and try again.</span>
00809     <span class="comment">//</span>
00810 
00811     <span class="keywordflow">while</span> (CurrentThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o65">FreezeCount</a> != 0) {
00812         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00813         <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00814     }
00815 
00816     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00817 
00818     <span class="comment">//</span>
00819     <span class="comment">// Freeze all threads except the current thread.</span>
00820     <span class="comment">//</span>
00821 
00822     ListHead = &amp;Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o8">ThreadListHead</a>;
00823     NextEntry = ListHead-&gt;Flink;
00824     <span class="keywordflow">do</span> {
00825 
00826         <span class="comment">//</span>
00827         <span class="comment">// Get the address of the next thread and suspend it if it is</span>
00828         <span class="comment">// not the current thread.</span>
00829         <span class="comment">//</span>
00830 
00831         Thread = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d8/struct__KTHREAD.html">KTHREAD</a>, ThreadListEntry);
00832         <span class="keywordflow">if</span> (Thread != CurrentThread) {
00833 
00834             EThread = (<a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>) Thread;
00835             <span class="keywordflow">if</span> ( EThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o37">ThreadListEntry</a>.Flink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00836                 ;
00837             } <span class="keywordflow">else</span> {
00838 
00839                 <span class="comment">//</span>
00840                 <span class="comment">// Increment the freeze count. If the thread was not previously</span>
00841                 <span class="comment">// suspended, then queue the thread's suspend APC.</span>
00842                 <span class="comment">//</span>
00843 
00844                 OldCount = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o65">FreezeCount</a>;
00845 
00846                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OldCount != MAXIMUM_SUSPEND_COUNT);
00847 
00848                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o65">FreezeCount</a> += 1;
00849                 <span class="keywordflow">if</span> ((OldCount == 0) &amp;&amp; (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o66">SuspendCount</a> == 0)) {
00850                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/ki_8h.html#a123">KiInsertQueueApc</a>(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o62">SuspendApc</a>, <a class="code" href="../../d0/d0/ki_8h.html#a2">RESUME_INCREMENT</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00851                         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o63">SuspendSemaphore</a>.<a class="code" href="../../d8/d7/struct__KSEMAPHORE.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o4">SignalState</a> -= 1;
00852                     }
00853                 }
00854             }
00855         }
00856         NextEntry = NextEntry-&gt;Flink;
00857     } <span class="keywordflow">while</span> (NextEntry != ListHead);
00858 
00859     <span class="comment">//</span>
00860     <span class="comment">// Unlock dispatcher database and lower IRQL to its previous</span>
00861     <span class="comment">// value.</span>
00862     <span class="comment">//</span>
00863 
00864     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00865     <span class="keywordflow">return</span>;
00866 }
00867 
00868 BOOLEAN
<a name="l00869"></a><a class="code" href="../../d9/d1/thredobj_8c.html#a10">00869</a> <a class="code" href="../../d9/d1/thredobj_8c.html#a10">KeQueryAutoAlignmentThread</a> (
00870     IN <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread
00871     )
00872 
00873 <span class="comment">/*++</span>
00874 <span class="comment"></span>
00875 <span class="comment">Routine Description:</span>
00876 <span class="comment"></span>
00877 <span class="comment">    This function returns the data alignment handling mode for the specified</span>
00878 <span class="comment">    thread.</span>
00879 <span class="comment"></span>
00880 <span class="comment">Arguments:</span>
00881 <span class="comment"></span>
00882 <span class="comment">    None.</span>
00883 <span class="comment"></span>
00884 <span class="comment">Return Value:</span>
00885 <span class="comment"></span>
00886 <span class="comment">    A value of TRUE is returned if data alignment exceptions are being</span>
00887 <span class="comment">    automatically handled by the kernel. Otherwise, a value of FALSE</span>
00888 <span class="comment">    is returned.</span>
00889 <span class="comment"></span>
00890 <span class="comment">--*/</span>
00891 
00892 {
00893 
00894     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a1">ASSERT_THREAD</a>(Thread);
00895 
00896     <span class="comment">//</span>
00897     <span class="comment">// Return the data alignment handling mode for the thread.</span>
00898     <span class="comment">//</span>
00899 
00900     <span class="keywordflow">return</span> Thread-&gt;AutoAlignment;
00901 }
00902 
00903 LONG
<a name="l00904"></a><a class="code" href="../../d9/d1/thredobj_8c.html#a11">00904</a> <a class="code" href="../../d9/d1/thredobj_8c.html#a11">KeQueryBasePriorityThread</a> (
00905     IN <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread
00906     )
00907 
00908 <span class="comment">/*++</span>
00909 <span class="comment"></span>
00910 <span class="comment">Routine Description:</span>
00911 <span class="comment"></span>
00912 <span class="comment">    This function returns the base priority increment of the specified</span>
00913 <span class="comment">    thread.</span>
00914 <span class="comment"></span>
00915 <span class="comment">Arguments:</span>
00916 <span class="comment"></span>
00917 <span class="comment">    Thread  - Supplies a pointer to a dispatcher object of type thread.</span>
00918 <span class="comment"></span>
00919 <span class="comment">Return Value:</span>
00920 <span class="comment"></span>
00921 <span class="comment">    The base priority increment of the specified thread.</span>
00922 <span class="comment"></span>
00923 <span class="comment">--*/</span>
00924 
00925 {
00926 
00927     LONG <a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a>;
00928     KIRQL OldIrql;
00929     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00930 
00931     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a1">ASSERT_THREAD</a>(Thread);
00932     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00933 
00934     <span class="comment">//</span>
00935     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00936     <span class="comment">//</span>
00937 
00938     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00939 
00940     <span class="comment">//</span>
00941     <span class="comment">// If priority saturation occured the last time the thread base priority</span>
00942     <span class="comment">// was set, then return the saturation increment value. Otherwise, compute</span>
00943     <span class="comment">// the increment value as the difference between the thread base priority</span>
00944     <span class="comment">// and the process base priority.</span>
00945     <span class="comment">//</span>
00946 
00947     Process = Thread-&gt;ApcStatePointer[0]-&gt;Process;
00948     <a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a> = Thread-&gt;BasePriority - Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o12">BasePriority</a>;
00949     <span class="keywordflow">if</span> (Thread-&gt;Saturation != 0) {
00950         <a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a> = ((HIGH_PRIORITY + 1) / 2) * Thread-&gt;Saturation;
00951     }
00952 
00953     <span class="comment">//</span>
00954     <span class="comment">// Unlock dispatcher database and lower IRQL to its previous</span>
00955     <span class="comment">// value.</span>
00956     <span class="comment">//</span>
00957 
00958     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00959 
00960     <span class="comment">//</span>
00961     <span class="comment">// Return the previous thread base priority increment.</span>
00962     <span class="comment">//</span>
00963 
00964     <span class="keywordflow">return</span> <a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a>;
00965 }
00966 
00967 KPRIORITY
<a name="l00968"></a><a class="code" href="../../d9/d1/thredobj_8c.html#a12">00968</a> <a class="code" href="../../d9/d1/thredobj_8c.html#a12">KeQueryPriorityThread</a> (
00969     IN <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread
00970     )
00971 
00972 <span class="comment">/*++</span>
00973 <span class="comment"></span>
00974 <span class="comment">Routine Description:</span>
00975 <span class="comment"></span>
00976 <span class="comment">    This function returns the current priority of the specified thread.</span>
00977 <span class="comment"></span>
00978 <span class="comment">Arguments:</span>
00979 <span class="comment"></span>
00980 <span class="comment">    Thread  - Supplies a pointer to a dispatcher object of type thread.</span>
00981 <span class="comment"></span>
00982 <span class="comment">Return Value:</span>
00983 <span class="comment"></span>
00984 <span class="comment">    The current priority of the specified thread.</span>
00985 <span class="comment"></span>
00986 <span class="comment">--*/</span>
00987 
00988 {
00989     <span class="keywordflow">return</span> Thread-&gt;Priority;
00990 }
00991 
00992 BOOLEAN
<a name="l00993"></a><a class="code" href="../../d9/d1/thredobj_8c.html#a13">00993</a> <a class="code" href="../../d9/d1/thredobj_8c.html#a13">KeReadStateThread</a> (
00994     IN <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread
00995     )
00996 
00997 <span class="comment">/*++</span>
00998 <span class="comment"></span>
00999 <span class="comment">Routine Description:</span>
01000 <span class="comment"></span>
01001 <span class="comment">    This function reads the current signal state of a thread object.</span>
01002 <span class="comment"></span>
01003 <span class="comment">Arguments:</span>
01004 <span class="comment"></span>
01005 <span class="comment">    Thread - Supplies a pointer to a dispatcher object of type thread.</span>
01006 <span class="comment"></span>
01007 <span class="comment">Return Value:</span>
01008 <span class="comment"></span>
01009 <span class="comment">    The current signal state of the thread object.</span>
01010 <span class="comment"></span>
01011 <span class="comment">--*/</span>
01012 
01013 {
01014 
01015     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a1">ASSERT_THREAD</a>(Thread);
01016 
01017     <span class="comment">//</span>
01018     <span class="comment">// Return current signal state of thread object.</span>
01019     <span class="comment">//</span>
01020 
01021     <span class="keywordflow">return</span> (BOOLEAN)Thread-&gt;Header.SignalState;
01022 }
01023 
01024 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01025"></a><a class="code" href="../../d9/d1/thredobj_8c.html#a14">01025</a> <a class="code" href="../../d9/d1/thredobj_8c.html#a14">KeReadyThread</a> (
01026     IN <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread
01027     )
01028 
01029 <span class="comment">/*++</span>
01030 <span class="comment"></span>
01031 <span class="comment">Routine Description:</span>
01032 <span class="comment"></span>
01033 <span class="comment">    This function readies a thread for execution. If the thread's process</span>
01034 <span class="comment">    is currently not in the balance set, then the thread is inserted in the</span>
01035 <span class="comment">    thread's process' ready queue. Else if the thread is higher priority than</span>
01036 <span class="comment">    another thread that is currently running on a processor then the thread</span>
01037 <span class="comment">    is selected for execution on that processor. Else the thread is inserted</span>
01038 <span class="comment">    in the dispatcher ready queue selected by its priority.</span>
01039 <span class="comment"></span>
01040 <span class="comment">Arguments:</span>
01041 <span class="comment"></span>
01042 <span class="comment">    Thread  - Supplies a pointer to a dispatcher object of type thread.</span>
01043 <span class="comment"></span>
01044 <span class="comment">Return Value:</span>
01045 <span class="comment"></span>
01046 <span class="comment">    None.</span>
01047 <span class="comment"></span>
01048 <span class="comment">--*/</span>
01049 
01050 {
01051 
01052     KIRQL OldIrql;
01053 
01054     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a1">ASSERT_THREAD</a>(Thread);
01055     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
01056 
01057     <span class="comment">//</span>
01058     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
01059     <span class="comment">//</span>
01060 
01061     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
01062 
01063     <span class="comment">//</span>
01064     <span class="comment">// Ready the specified thread for execution.</span>
01065     <span class="comment">//</span>
01066 
01067     <a class="code" href="../../d0/d2/thredsup_8c.html#a3">KiReadyThread</a>(Thread);
01068 
01069     <span class="comment">//</span>
01070     <span class="comment">// Unlock dispatcher database and lower IRQL to its previous</span>
01071     <span class="comment">// value.</span>
01072     <span class="comment">//</span>
01073 
01074     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
01075     <span class="keywordflow">return</span>;
01076 }
01077 
01078 ULONG
<a name="l01079"></a><a class="code" href="../../d9/d1/thredobj_8c.html#a15">01079</a> <a class="code" href="../../d9/d1/thredobj_8c.html#a15">KeResumeThread</a> (
01080     IN <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread
01081     )
01082 
01083 <span class="comment">/*++</span>
01084 <span class="comment"></span>
01085 <span class="comment">Routine Description:</span>
01086 <span class="comment"></span>
01087 <span class="comment">    This function resumes the execution of a suspended thread. If the</span>
01088 <span class="comment">    specified thread is not suspended, then no operation is performed.</span>
01089 <span class="comment"></span>
01090 <span class="comment">Arguments:</span>
01091 <span class="comment"></span>
01092 <span class="comment">    Thread  - Supplies a pointer to a dispatcher object of type thread.</span>
01093 <span class="comment"></span>
01094 <span class="comment">Return Value:</span>
01095 <span class="comment"></span>
01096 <span class="comment">    The previous suspend count.</span>
01097 <span class="comment"></span>
01098 <span class="comment">--*/</span>
01099 
01100 {
01101 
01102     ULONG OldCount;
01103     KIRQL OldIrql;
01104 
01105     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a1">ASSERT_THREAD</a>(Thread);
01106     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
01107 
01108     <span class="comment">//</span>
01109     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
01110     <span class="comment">//</span>
01111 
01112     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
01113 
01114     <span class="comment">//</span>
01115     <span class="comment">// Capture the current suspend count.</span>
01116     <span class="comment">//</span>
01117 
01118     OldCount = Thread-&gt;SuspendCount;
01119 
01120     <span class="comment">//</span>
01121     <span class="comment">// If the thread is currently suspended, then decrement its suspend count.</span>
01122     <span class="comment">//</span>
01123 
01124     <span class="keywordflow">if</span> (OldCount != 0) {
01125         Thread-&gt;SuspendCount -= 1;
01126 
01127         <span class="comment">//</span>
01128         <span class="comment">// If the resultant suspend count is zero and the freeze count is</span>
01129         <span class="comment">// zero, then resume the thread by releasing its suspend semaphore.</span>
01130         <span class="comment">//</span>
01131 
01132         <span class="keywordflow">if</span> ((Thread-&gt;SuspendCount == 0) &amp;&amp; (Thread-&gt;FreezeCount == 0)) {
01133             Thread-&gt;SuspendSemaphore.Header.SignalState += 1;
01134             <a class="code" href="../../d2/d7/waitsup_8c.html#a3">KiWaitTest</a>(&amp;Thread-&gt;SuspendSemaphore, <a class="code" href="../../d0/d0/ki_8h.html#a2">RESUME_INCREMENT</a>);
01135         }
01136     }
01137 
01138     <span class="comment">//</span>
01139     <span class="comment">// Unlock dispatcher database and lower IRQL to its previous</span>
01140     <span class="comment">// value.</span>
01141     <span class="comment">//</span>
01142 
01143     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
01144 
01145     <span class="comment">//</span>
01146     <span class="comment">// Return the previous suspend count.</span>
01147     <span class="comment">//</span>
01148 
01149     <span class="keywordflow">return</span> OldCount;
01150 }
01151 
01152 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01153"></a><a class="code" href="../../d9/d1/thredobj_8c.html#a16">01153</a> <a class="code" href="../../d9/d1/thredobj_8c.html#a16">KeRevertToUserAffinityThread</a> (
01154     VOID
01155     )
01156 
01157 <span class="comment">/*++</span>
01158 <span class="comment"></span>
01159 <span class="comment">Routine Description:</span>
01160 <span class="comment"></span>
01161 <span class="comment">    This function setss the affinity of the current thread to its user</span>
01162 <span class="comment">    affinity.</span>
01163 <span class="comment"></span>
01164 <span class="comment">Arguments:</span>
01165 <span class="comment"></span>
01166 <span class="comment">    None.</span>
01167 <span class="comment"></span>
01168 <span class="comment">Return Value:</span>
01169 <span class="comment"></span>
01170 <span class="comment">    None.</span>
01171 <span class="comment"></span>
01172 <span class="comment">--*/</span>
01173 
01174 {
01175 
01176     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> CurrentThread;
01177     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> NextThread;
01178     KIRQL OldIrql;
01179     PKPRCB Prcb;
01180 
01181     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
01182     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;SystemAffinityActive != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01183 
01184     <span class="comment">//</span>
01185     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
01186     <span class="comment">//</span>
01187 
01188     CurrentThread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
01189     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
01190 
01191     <span class="comment">//</span>
01192     <span class="comment">// Set the current affinity to the user affinity.</span>
01193     <span class="comment">//</span>
01194     <span class="comment">// If the current processor is not in the new affinity set and another</span>
01195     <span class="comment">// thread has not already been selected for execution on the current</span>
01196     <span class="comment">// processor, then select a new thread for the current processor.</span>
01197     <span class="comment">//</span>
01198 
01199     CurrentThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o41">Affinity</a> = CurrentThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o31">UserAffinity</a>;
01200     CurrentThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o32">SystemAffinityActive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01201     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
01202     <span class="keywordflow">if</span> (((Prcb-&gt;SetMember &amp; CurrentThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o41">Affinity</a>) == 0) &amp;&amp;
01203         (Prcb-&gt;NextThread == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01204         NextThread = <a class="code" href="../../d0/d2/thredsup_8c.html#a4">KiSelectNextThread</a>(CurrentThread);
01205         NextThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o8">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a406a194">Standby</a>;
01206         Prcb-&gt;NextThread = NextThread;
01207     }
01208 
01209     <span class="comment">//</span>
01210     <span class="comment">// Unlock dispatcher database and lower IRQL to its previous value.</span>
01211     <span class="comment">//</span>
01212 
01213     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
01214     <span class="keywordflow">return</span>;
01215 }
01216 
01217 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01218"></a><a class="code" href="../../d9/d1/thredobj_8c.html#a17">01218</a> <a class="code" href="../../d9/d1/thredobj_8c.html#a17">KeRundownThread</a> (
01219     )
01220 
01221 <span class="comment">/*++</span>
01222 <span class="comment"></span>
01223 <span class="comment">Routine Description:</span>
01224 <span class="comment"></span>
01225 <span class="comment">    This function is called by the executive to rundown thread structures</span>
01226 <span class="comment">    which must be guarded by the dispatcher database lock and which must</span>
01227 <span class="comment">    be processed before actually terminating the thread. An example of such</span>
01228 <span class="comment">    a structure is the mutant ownership list that is anchored in the kernel</span>
01229 <span class="comment">    thread object.</span>
01230 <span class="comment"></span>
01231 <span class="comment">Arguments:</span>
01232 <span class="comment"></span>
01233 <span class="comment">    None.</span>
01234 <span class="comment"></span>
01235 <span class="comment">Return Value:</span>
01236 <span class="comment"></span>
01237 <span class="comment">    None.</span>
01238 <span class="comment"></span>
01239 <span class="comment">--*/</span>
01240 
01241 {
01242 
01243     <a class="code" href="../../d3/d7/struct__KMUTANT.html">PKMUTANT</a> Mutant;
01244     PLIST_ENTRY NextEntry;
01245     KIRQL OldIrql;
01246     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
01247 
01248     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
01249 
01250     <span class="comment">//</span>
01251     <span class="comment">// Rundown possible associated channel object or receive buffer.</span>
01252     <span class="comment">//</span>
01253 
01254 <span class="preprocessor">#if 0</span>
01255 <span class="preprocessor"></span>
01256     <a class="code" href="../../d0/d0/ki_8h.html#a88">KiRundownChannel</a>();
01257 
01258 <span class="preprocessor">#endif</span>
01259 <span class="preprocessor"></span>
01260     <span class="comment">//</span>
01261     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
01262     <span class="comment">//</span>
01263 
01264     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
01265     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
01266 
01267     <span class="comment">//</span>
01268     <span class="comment">// Scan the list of owned mutant objects and release the mutant objects</span>
01269     <span class="comment">// with an abandoned status. If the mutant is a kernel mutex, then bug</span>
01270     <span class="comment">// check.</span>
01271     <span class="comment">//</span>
01272 
01273     NextEntry = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o1">MutantListHead</a>.Flink;
01274     <span class="keywordflow">while</span> (NextEntry != &amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o1">MutantListHead</a>) {
01275         Mutant = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d3/d7/struct__KMUTANT.html">KMUTANT</a>, MutantListEntry);
01276         <span class="keywordflow">if</span> (Mutant-&gt;<a class="code" href="../../d3/d7/struct__KMUTANT.html#o4">ApcDisable</a> != 0) {
01277             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(THREAD_TERMINATE_HELD_MUTEX,
01278                          (ULONG_PTR)Thread,
01279                          (ULONG_PTR)Mutant, 0, 0);
01280         }
01281 
01282         RemoveEntryList(&amp;Mutant-&gt;<a class="code" href="../../d3/d7/struct__KMUTANT.html#o1">MutantListEntry</a>);
01283         Mutant-&gt;<a class="code" href="../../d3/d7/struct__KMUTANT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o4">SignalState</a> = 1;
01284         Mutant-&gt;<a class="code" href="../../d3/d7/struct__KMUTANT.html#o3">Abandoned</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01285         Mutant-&gt;<a class="code" href="../../d3/d7/struct__KMUTANT.html#o2">OwnerThread</a> = (<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01286         <span class="keywordflow">if</span> (IsListEmpty(&amp;Mutant-&gt;<a class="code" href="../../d3/d7/struct__KMUTANT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o5">WaitListHead</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01287             <a class="code" href="../../d2/d7/waitsup_8c.html#a3">KiWaitTest</a>(Mutant, <a class="code" href="../../d7/d8/exboosts_8h.html#a15">MUTANT_INCREMENT</a>);
01288         }
01289 
01290         NextEntry = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o1">MutantListHead</a>.Flink;
01291     }
01292 
01293     <span class="comment">//</span>
01294     <span class="comment">// Release dispatcher database lock and lower IRQL to its previous value.</span>
01295     <span class="comment">//</span>
01296 
01297     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
01298     <span class="keywordflow">return</span>;
01299 }
01300 
01301 KAFFINITY
<a name="l01302"></a><a class="code" href="../../d9/d1/thredobj_8c.html#a18">01302</a> <a class="code" href="../../d9/d1/thredobj_8c.html#a18">KeSetAffinityThread</a> (
01303     IN <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread,
01304     IN KAFFINITY Affinity
01305     )
01306 
01307 <span class="comment">/*++</span>
01308 <span class="comment"></span>
01309 <span class="comment">Routine Description:</span>
01310 <span class="comment"></span>
01311 <span class="comment">    This function sets the affinity of a specified thread to a new</span>
01312 <span class="comment">    value. If the new affinity is not a proper subset of the parent</span>
01313 <span class="comment">    process affinity, or is null, then an error condition is raised.</span>
01314 <span class="comment">    If the specified thread is running on, or about to run on, a</span>
01315 <span class="comment">    processor for which it is no longer able to run, then the target</span>
01316 <span class="comment">    processor is rescheduled. If the specified thread is in a ready</span>
01317 <span class="comment">    state and is not in the parent process ready queue, then it is</span>
01318 <span class="comment">    rereadied to reevaluate any additional processors it may run on.</span>
01319 <span class="comment"></span>
01320 <span class="comment">Arguments:</span>
01321 <span class="comment"></span>
01322 <span class="comment">    Thread  - Supplies a pointer to a dispatcher object of type thread.</span>
01323 <span class="comment"></span>
01324 <span class="comment">    Affinity - Supplies the new of set of processors on which the thread</span>
01325 <span class="comment">        can run.</span>
01326 <span class="comment"></span>
01327 <span class="comment">Return Value:</span>
01328 <span class="comment"></span>
01329 <span class="comment">    The previous affinity of the specified thread.</span>
01330 <span class="comment"></span>
01331 <span class="comment">--*/</span>
01332 
01333 {
01334 
01335     KAFFINITY OldAffinity;
01336     KIRQL OldIrql;
01337     PKPRCB Prcb;
01338     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
01339     ULONG Processor;
01340     KPRIORITY ThreadPriority;
01341     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> Thread1;
01342 
01343     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a1">ASSERT_THREAD</a>(Thread);
01344     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
01345 
01346     <span class="comment">//</span>
01347     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
01348     <span class="comment">//</span>
01349 
01350     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
01351 
01352     <span class="comment">//</span>
01353     <span class="comment">// Capture the current affinity of the specified thread and get address</span>
01354     <span class="comment">// of parent process object;</span>
01355     <span class="comment">//</span>
01356 
01357     OldAffinity = Thread-&gt;UserAffinity;
01358     Process = Thread-&gt;ApcStatePointer[0]-&gt;Process;
01359 
01360     <span class="comment">//</span>
01361     <span class="comment">// If new affinity is not a proper subset of the parent process affinity,</span>
01362     <span class="comment">// or the new affinity is null, then bugcheck.</span>
01363     <span class="comment">//</span>
01364 
01365     <span class="keywordflow">if</span> (((Affinity &amp; Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o10">Affinity</a>) != (Affinity)) || (!Affinity)) {
01366         <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a9">INVALID_AFFINITY_SET</a>);
01367     }
01368 
01369     <span class="comment">//</span>
01370     <span class="comment">// Set the thread user affinity to the specified value.</span>
01371     <span class="comment">//</span>
01372     <span class="comment">// If the thread is not current executing with system affinity active,</span>
01373     <span class="comment">// then set the thread current affinity and switch on the thread state.</span>
01374     <span class="comment">//</span>
01375 
01376     Thread-&gt;UserAffinity = Affinity;
01377     <span class="keywordflow">if</span> (Thread-&gt;SystemAffinityActive == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01378         Thread-&gt;Affinity = Affinity;
01379         <span class="keywordflow">switch</span> (Thread-&gt;State) {
01380 
01381             <span class="comment">//</span>
01382             <span class="comment">// Ready State.</span>
01383             <span class="comment">//</span>
01384             <span class="comment">// If the thread is not in the process ready queue, then remove</span>
01385             <span class="comment">// it from its current dispatcher ready queue and reready it for</span>
01386             <span class="comment">// execution.</span>
01387             <span class="comment">//</span>
01388 
01389         <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/ke_8h.html#a406a192">Ready</a>:
01390             <span class="keywordflow">if</span> (Thread-&gt;ProcessReadyQueue == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01391                 RemoveEntryList(&amp;Thread-&gt;WaitListEntry);
01392                 ThreadPriority = Thread-&gt;Priority;
01393                 <span class="keywordflow">if</span> (IsListEmpty(&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a0">KiDispatcherReadyListHead</a>[ThreadPriority]) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01394                     <a class="code" href="../../d0/d0/ki_8h.html#a6">ClearMember</a>(ThreadPriority, <a class="code" href="../../d5/d9/kernldat_8c.html#a2">KiReadySummary</a>);
01395                 }
01396 
01397                 <a class="code" href="../../d0/d2/thredsup_8c.html#a3">KiReadyThread</a>(Thread);
01398             }
01399 
01400             <span class="keywordflow">break</span>;
01401 
01402             <span class="comment">//</span>
01403             <span class="comment">// Standby State.</span>
01404             <span class="comment">//</span>
01405             <span class="comment">// If the target processor is not in the new affinity set, then</span>
01406             <span class="comment">// set the next thread to null for the target processor, select</span>
01407             <span class="comment">// a new thread to run on the target processor, and reready the</span>
01408             <span class="comment">// thread for execution.</span>
01409             <span class="comment">//</span>
01410 
01411         <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/ke_8h.html#a406a194">Standby</a>:
01412             Processor = Thread-&gt;NextProcessor;
01413             Prcb = <a class="code" href="../../d4/d9/ke_8h.html#a139">KiProcessorBlock</a>[Processor];
01414             <span class="keywordflow">if</span> ((Prcb-&gt;SetMember &amp; Affinity) == 0) {
01415                 Prcb-&gt;NextThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01416                 Thread1 = <a class="code" href="../../d0/d2/thredsup_8c.html#a4">KiSelectNextThread</a>(Thread);
01417                 Thread1-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o8">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a406a194">Standby</a>;
01418                 Prcb-&gt;NextThread = Thread1;
01419                 <a class="code" href="../../d0/d2/thredsup_8c.html#a3">KiReadyThread</a>(Thread);
01420             }
01421 
01422             <span class="keywordflow">break</span>;
01423 
01424             <span class="comment">//</span>
01425             <span class="comment">// Running State.</span>
01426             <span class="comment">//</span>
01427             <span class="comment">// If the target processor is not in the new affinity set and</span>
01428             <span class="comment">// another thread has not already been selected for execution</span>
01429             <span class="comment">// on the target processor, then select a new thread for the</span>
01430             <span class="comment">// target processor, and cause the target processor to be</span>
01431             <span class="comment">// redispatched.</span>
01432             <span class="comment">//</span>
01433 
01434         <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/ke_8h.html#a406a193">Running</a>:
01435             Processor = Thread-&gt;NextProcessor;
01436             Prcb = <a class="code" href="../../d4/d9/ke_8h.html#a139">KiProcessorBlock</a>[Processor];
01437             <span class="keywordflow">if</span> (((Prcb-&gt;SetMember &amp; Affinity) == 0) &amp;&amp;
01438                 (Prcb-&gt;NextThread == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01439                 Thread1 = <a class="code" href="../../d0/d2/thredsup_8c.html#a4">KiSelectNextThread</a>(Thread);
01440                 Thread1-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o8">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a406a194">Standby</a>;
01441                 Prcb-&gt;NextThread = Thread1;
01442                 <a class="code" href="../../d0/d0/ki_8h.html#a24">KiRequestDispatchInterrupt</a>(Processor);
01443             }
01444 
01445             <span class="keywordflow">break</span>;
01446 
01447             <span class="comment">//</span>
01448             <span class="comment">// Initialized, Terminated, Waiting, Transition case - For these</span>
01449             <span class="comment">// states it is sufficient to just set the new thread affinity.</span>
01450             <span class="comment">//</span>
01451 
01452         <span class="keywordflow">default</span>:
01453             <span class="keywordflow">break</span>;
01454         }
01455     }
01456 
01457     <span class="comment">//</span>
01458     <span class="comment">// Unlock dispatcher database, lower IRQL to its previous value, and</span>
01459     <span class="comment">// return the previous user affinity.</span>
01460     <span class="comment">//</span>
01461 
01462     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
01463     <span class="keywordflow">return</span> OldAffinity;
01464 }
01465 
01466 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01467"></a><a class="code" href="../../d9/d1/thredobj_8c.html#a19">01467</a> <a class="code" href="../../d9/d1/thredobj_8c.html#a19">KeSetSystemAffinityThread</a> (
01468     IN KAFFINITY Affinity
01469     )
01470 
01471 <span class="comment">/*++</span>
01472 <span class="comment"></span>
01473 <span class="comment">Routine Description:</span>
01474 <span class="comment"></span>
01475 <span class="comment">    This function set the system affinity of the current thread.</span>
01476 <span class="comment"></span>
01477 <span class="comment">Arguments:</span>
01478 <span class="comment"></span>
01479 <span class="comment">    Affinity - Supplies the new of set of processors on which the thread</span>
01480 <span class="comment">        can run.</span>
01481 <span class="comment"></span>
01482 <span class="comment">Return Value:</span>
01483 <span class="comment"></span>
01484 <span class="comment">    None.</span>
01485 <span class="comment"></span>
01486 <span class="comment">--*/</span>
01487 
01488 {
01489 
01490     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> CurrentThread;
01491     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> NextThread;
01492     KIRQL OldIrql;
01493     PKPRCB Prcb;
01494 
01495     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
01496     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Affinity &amp; <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>) != 0);
01497 
01498     <span class="comment">//</span>
01499     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
01500     <span class="comment">//</span>
01501 
01502     CurrentThread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
01503     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
01504 
01505     <span class="comment">//</span>
01506     <span class="comment">// Set the current affinity to the specified affinity.</span>
01507     <span class="comment">//</span>
01508     <span class="comment">// If the current processor is not in the new affinity set and another</span>
01509     <span class="comment">// thread has not already been selected for execution on the current</span>
01510     <span class="comment">// processor, then select a new thread for the current processor.</span>
01511     <span class="comment">//</span>
01512 
01513     CurrentThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o41">Affinity</a> = Affinity;
01514     CurrentThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o32">SystemAffinityActive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01515     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
01516     <span class="keywordflow">if</span> (((Prcb-&gt;SetMember &amp; CurrentThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o41">Affinity</a>) == 0) &amp;&amp;
01517         (Prcb-&gt;NextThread == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01518         NextThread = <a class="code" href="../../d0/d2/thredsup_8c.html#a4">KiSelectNextThread</a>(CurrentThread);
01519         NextThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o8">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a406a194">Standby</a>;
01520         Prcb-&gt;NextThread = NextThread;
01521     }
01522 
01523     <span class="comment">//</span>
01524     <span class="comment">// Unlock dispatcher database and lower IRQL to its previous value.</span>
01525     <span class="comment">//</span>
01526 
01527     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
01528     <span class="keywordflow">return</span>;
01529 }
01530 
01531 LONG
<a name="l01532"></a><a class="code" href="../../d9/d1/thredobj_8c.html#a20">01532</a> <a class="code" href="../../d9/d1/thredobj_8c.html#a20">KeSetBasePriorityThread</a> (
01533     IN <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread,
01534     IN LONG Increment
01535     )
01536 
01537 <span class="comment">/*++</span>
01538 <span class="comment"></span>
01539 <span class="comment">Routine Description:</span>
01540 <span class="comment"></span>
01541 <span class="comment">    This function sets the base priority of the specified thread to a</span>
01542 <span class="comment">    new value.  The new base priority for the thread is the process base</span>
01543 <span class="comment">    priority plus the increment.</span>
01544 <span class="comment"></span>
01545 <span class="comment">Arguments:</span>
01546 <span class="comment"></span>
01547 <span class="comment">    Thread  - Supplies a pointer to a dispatcher object of type thread.</span>
01548 <span class="comment"></span>
01549 <span class="comment">    Increment - Supplies the base priority increment of the subject thread.</span>
01550 <span class="comment"></span>
01551 <span class="comment">        N.B. If the absolute value of the increment is such that saturation</span>
01552 <span class="comment">             of the base priority is forced, then subsequent changes to the</span>
01553 <span class="comment">             parent process base priority will not change the base priority</span>
01554 <span class="comment">             of the thread.</span>
01555 <span class="comment"></span>
01556 <span class="comment">Return Value:</span>
01557 <span class="comment"></span>
01558 <span class="comment">    The previous base priority increment of the specified thread.</span>
01559 <span class="comment"></span>
01560 <span class="comment">--*/</span>
01561 
01562 {
01563 
01564     KPRIORITY NewBase;
01565     KPRIORITY NewPriority;
01566     KPRIORITY OldBase;
01567     LONG OldIncrement;
01568     KIRQL OldIrql;
01569     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
01570 
01571     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a1">ASSERT_THREAD</a>(Thread);
01572     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
01573 
01574     <span class="comment">//</span>
01575     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
01576     <span class="comment">//</span>
01577 
01578     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
01579 
01580     <span class="comment">//</span>
01581     <span class="comment">// Capture the base priority of the specified thread and determine</span>
01582     <span class="comment">// whether saturation if being forced.</span>
01583     <span class="comment">//</span>
01584 
01585     Process = Thread-&gt;ApcStatePointer[0]-&gt;Process;
01586     OldBase = Thread-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o12">BasePriority</a>;
01587     OldIncrement = OldBase - Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o12">BasePriority</a>;
01588     <span class="keywordflow">if</span> (Thread-&gt;Saturation != 0) {
01589         OldIncrement = ((HIGH_PRIORITY + 1) / 2) * Thread-&gt;Saturation;
01590     }
01591 
01592     Thread-&gt;Saturation = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01593     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a259">abs</a>(<a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a>) &gt;= (HIGH_PRIORITY + 1) / 2) {
01594         Thread-&gt;Saturation = (<a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a> &gt; 0) ? 1 : -1;
01595     }
01596 
01597     <span class="comment">//</span>
01598     <span class="comment">// Set the base priority of the specified thread. If the thread's process</span>
01599     <span class="comment">// is in the realtime class, then limit the change to the realtime class.</span>
01600     <span class="comment">// Otherwise, limit the change to the variable class.</span>
01601     <span class="comment">//</span>
01602 
01603     NewBase = Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o12">BasePriority</a> + <a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a>;
01604     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o12">BasePriority</a> &gt;= LOW_REALTIME_PRIORITY) {
01605         <span class="keywordflow">if</span> (NewBase &lt; LOW_REALTIME_PRIORITY) {
01606             NewBase = LOW_REALTIME_PRIORITY;
01607 
01608         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NewBase &gt; HIGH_PRIORITY) {
01609             NewBase = HIGH_PRIORITY;
01610         }
01611 
01612         <span class="comment">//</span>
01613         <span class="comment">// Set the new priority of the thread to the new base priority.</span>
01614         <span class="comment">//</span>
01615 
01616         NewPriority = NewBase;
01617 
01618     } <span class="keywordflow">else</span> {
01619         <span class="keywordflow">if</span> (NewBase &gt;= LOW_REALTIME_PRIORITY) {
01620             NewBase = LOW_REALTIME_PRIORITY - 1;
01621 
01622         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NewBase &lt;= LOW_PRIORITY) {
01623             NewBase = 1;
01624         }
01625 
01626         <span class="comment">//</span>
01627         <span class="comment">// Compute the new thread priority. If the new priority is outside</span>
01628         <span class="comment">// the variable class, then set the new priority to the highest</span>
01629         <span class="comment">// variable priority.</span>
01630         <span class="comment">//</span>
01631 
01632         <span class="keywordflow">if</span> (Thread-&gt;Saturation != 0) {
01633             NewPriority = NewBase;
01634 
01635         } <span class="keywordflow">else</span> {
01636             NewPriority = Thread-&gt;Priority +
01637                             (NewBase - OldBase) - Thread-&gt;PriorityDecrement;
01638 
01639             <span class="keywordflow">if</span> (NewPriority &gt;= LOW_REALTIME_PRIORITY) {
01640                 NewPriority = LOW_REALTIME_PRIORITY - 1;
01641             }
01642         }
01643     }
01644 
01645     <span class="comment">//</span>
01646     <span class="comment">// Set the new base priority and clear the priority decrement. If the</span>
01647     <span class="comment">// new priority is not equal to the old priority, then set the new thread</span>
01648     <span class="comment">// priority.</span>
01649     <span class="comment">//</span>
01650 
01651     Thread-&gt;BasePriority = (SCHAR)NewBase;
01652     Thread-&gt;DecrementCount = 0;
01653     Thread-&gt;PriorityDecrement = 0;
01654     <span class="keywordflow">if</span> (NewPriority != Thread-&gt;Priority) {
01655         Thread-&gt;Quantum = Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o13">ThreadQuantum</a>;
01656         <a class="code" href="../../d0/d2/thredsup_8c.html#a5">KiSetPriorityThread</a>(Thread, NewPriority);
01657     }
01658 
01659     <span class="comment">//</span>
01660     <span class="comment">// Unlock dispatcher database and lower IRQL to its previous</span>
01661     <span class="comment">// value.</span>
01662     <span class="comment">//</span>
01663 
01664     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
01665 
01666     <span class="comment">//</span>
01667     <span class="comment">// Return the previous thread base priority.</span>
01668     <span class="comment">//</span>
01669 
01670     <span class="keywordflow">return</span> OldIncrement;
01671 }
01672 
01673 LOGICAL
<a name="l01674"></a><a class="code" href="../../d9/d1/thredobj_8c.html#a21">01674</a> <a class="code" href="../../d9/d1/thredobj_8c.html#a21">KeSetDisableBoostThread</a> (
01675     IN <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread,
01676     IN LOGICAL Disable
01677     )
01678 
01679 <span class="comment">/*++</span>
01680 <span class="comment"></span>
01681 <span class="comment">Routine Description:</span>
01682 <span class="comment"></span>
01683 <span class="comment">    This function disables priority boosts for the specified thread.</span>
01684 <span class="comment"></span>
01685 <span class="comment">Arguments:</span>
01686 <span class="comment"></span>
01687 <span class="comment">    Thread  - Supplies a pointer to a dispatcher object of type thread.</span>
01688 <span class="comment"></span>
01689 <span class="comment">    Disable - Supplies a logical value that determines whether priority</span>
01690 <span class="comment">        boosts for the thread are disabled or enabled.</span>
01691 <span class="comment"></span>
01692 <span class="comment">Return Value:</span>
01693 <span class="comment"></span>
01694 <span class="comment">    The previous value of the disable boost state variable.</span>
01695 <span class="comment"></span>
01696 <span class="comment">--*/</span>
01697 
01698 {
01699 
01700     LOGICAL DisableBoost;
01701     KIRQL OldIrql;
01702 
01703     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a1">ASSERT_THREAD</a>(Thread);
01704     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
01705 
01706     <span class="comment">//</span>
01707     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
01708     <span class="comment">//</span>
01709 
01710     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
01711 
01712     <span class="comment">//</span>
01713     <span class="comment">// Capture the current state of the disable boost variable and set its</span>
01714     <span class="comment">// state to TRUE.</span>
01715     <span class="comment">//</span>
01716 
01717     DisableBoost = Thread-&gt;DisableBoost;
01718     Thread-&gt;DisableBoost = (BOOLEAN)Disable;
01719 
01720     <span class="comment">//</span>
01721     <span class="comment">// Unlock dispatcher database and lower IRQL to its previous</span>
01722     <span class="comment">// value.</span>
01723     <span class="comment">//</span>
01724 
01725     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
01726 
01727     <span class="comment">//</span>
01728     <span class="comment">// Return the previous disable boost state.</span>
01729     <span class="comment">//</span>
01730 
01731     <span class="keywordflow">return</span> DisableBoost;
01732 }
01733 
01734 CCHAR
<a name="l01735"></a><a class="code" href="../../d9/d1/thredobj_8c.html#a22">01735</a> <a class="code" href="../../d9/d1/thredobj_8c.html#a22">KeSetIdealProcessorThread</a> (
01736     IN <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread,
01737     IN CCHAR Processor
01738     )
01739 
01740 <span class="comment">/*++</span>
01741 <span class="comment"></span>
01742 <span class="comment">Routine Description:</span>
01743 <span class="comment"></span>
01744 <span class="comment">    This function sets the ideal processor for the specified thread execution.</span>
01745 <span class="comment"></span>
01746 <span class="comment">Arguments:</span>
01747 <span class="comment"></span>
01748 <span class="comment">    Thread - Supplies a pointer to the thread whose ideal processor number is</span>
01749 <span class="comment">        set to the specfied value.</span>
01750 <span class="comment"></span>
01751 <span class="comment">    Processor - Supplies the number of the ideal processor (the distinguished</span>
01752 <span class="comment">        value MAXIMUM_PROCESSORS indicates that there is no ideal processor).</span>
01753 <span class="comment"></span>
01754 <span class="comment">Return Value:</span>
01755 <span class="comment"></span>
01756 <span class="comment">    The previous ideal processor number.</span>
01757 <span class="comment"></span>
01758 <span class="comment">--*/</span>
01759 
01760 {
01761 
01762     CCHAR OldProcessor;
01763     KIRQL OldIrql;
01764     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
01765 
01766     <span class="comment">//</span>
01767     <span class="comment">// Capture the previous ideal processor value, set the new ideal</span>
01768     <span class="comment">// processor value, and return the old ideal processor value for the</span>
01769     <span class="comment">// current thread;</span>
01770     <span class="comment">//</span>
01771     <span class="comment">// Note that this is done under the dispatcher lock in order to</span>
01772     <span class="comment">// synchronize the updates with the other fields that share the</span>
01773     <span class="comment">// same DWORD. Otherwise there is a granularity problem on Alpha.</span>
01774     <span class="comment">//</span>
01775 
01776     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Processor &lt;= <a class="code" href="../../d9/d5/ndismain_8h.html#a183">MAXIMUM_PROCESSORS</a>);
01777 
01778     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
01779     OldProcessor = Thread-&gt;IdealProcessor;
01780     <span class="keywordflow">if</span> (Processor &lt; <a class="code" href="../../d9/d5/ndismain_8h.html#a183">MAXIMUM_PROCESSORS</a>) {
01781         Thread-&gt;IdealProcessor = Processor;
01782 
01783     } <span class="keywordflow">else</span> {
01784         Process = Thread-&gt;ApcState.Process;
01785         Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o16">ThreadSeed</a> += 1;
01786         Thread-&gt;IdealProcessor = (UCHAR)(Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o16">ThreadSeed</a> % <a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>);
01787     }
01788 
01789     <span class="comment">//</span>
01790     <span class="comment">// Unlock dispatcher database and lower IRQL to its previous</span>
01791     <span class="comment">// value.</span>
01792     <span class="comment">//</span>
01793 
01794     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
01795     <span class="keywordflow">return</span> OldProcessor;
01796 }
01797 
01798 BOOLEAN
<a name="l01799"></a><a class="code" href="../../d9/d1/thredobj_8c.html#a23">01799</a> <a class="code" href="../../d9/d1/thredobj_8c.html#a23">KeSetKernelStackSwapEnable</a> (
01800     IN BOOLEAN Enable
01801     )
01802 
01803 <span class="comment">/*++</span>
01804 <span class="comment"></span>
01805 <span class="comment">Routine Description:</span>
01806 <span class="comment"></span>
01807 <span class="comment">    This function sets the kernel stack swap enable value for the current</span>
01808 <span class="comment">    thread and returns the old swap enable value.</span>
01809 <span class="comment"></span>
01810 <span class="comment">Arguments:</span>
01811 <span class="comment"></span>
01812 <span class="comment">    Enable - Supplies the new kernel stack swap enable value.</span>
01813 <span class="comment"></span>
01814 <span class="comment">Return Value:</span>
01815 <span class="comment"></span>
01816 <span class="comment">    The previous kernel stack swap enable value.</span>
01817 <span class="comment"></span>
01818 <span class="comment">--*/</span>
01819 
01820 {
01821 
01822     BOOLEAN OldState;
01823     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
01824 
01825     <span class="comment">//</span>
01826     <span class="comment">// Capture the previous kernel stack swap enable value, set the new</span>
01827     <span class="comment">// swap enable value, and return the old swap enable value for the</span>
01828     <span class="comment">// current thread;</span>
01829     <span class="comment">//</span>
01830 
01831     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
01832     OldState = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o51">EnableStackSwap</a>;
01833     Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o51">EnableStackSwap</a> = Enable;
01834     <span class="keywordflow">return</span> OldState;
01835 }
01836 
01837 KPRIORITY
<a name="l01838"></a><a class="code" href="../../d9/d1/thredobj_8c.html#a24">01838</a> <a class="code" href="../../d9/d1/thredobj_8c.html#a24">KeSetPriorityThread</a> (
01839     IN <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread,
01840     IN KPRIORITY Priority
01841     )
01842 
01843 <span class="comment">/*++</span>
01844 <span class="comment"></span>
01845 <span class="comment">Routine Description:</span>
01846 <span class="comment"></span>
01847 <span class="comment">    This function sets the priority of the specified thread to a new value.</span>
01848 <span class="comment">    If the new thread priority is lower than the old thread priority, then</span>
01849 <span class="comment">    resecheduling may take place if the thread is currently running on, or</span>
01850 <span class="comment">    about to run on, a processor.</span>
01851 <span class="comment"></span>
01852 <span class="comment">Arguments:</span>
01853 <span class="comment"></span>
01854 <span class="comment">    Thread  - Supplies a pointer to a dispatcher object of type thread.</span>
01855 <span class="comment"></span>
01856 <span class="comment">    Priority - Supplies the new priority of the subject thread.</span>
01857 <span class="comment"></span>
01858 <span class="comment">Return Value:</span>
01859 <span class="comment"></span>
01860 <span class="comment">    The previous priority of the specified thread.</span>
01861 <span class="comment"></span>
01862 <span class="comment">--*/</span>
01863 
01864 {
01865 
01866     KIRQL OldIrql;
01867     KPRIORITY OldPriority;
01868     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
01869 
01870     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a1">ASSERT_THREAD</a>(Thread);
01871     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
01872     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((Priority != 0) || (Thread-&gt;BasePriority == 0)) &amp;&amp;
01873            (Priority &lt;= HIGH_PRIORITY));
01874 
01875     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeIsExecutingDpc() == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01876 
01877     <span class="comment">//</span>
01878     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
01879     <span class="comment">//</span>
01880 
01881     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
01882 
01883     <span class="comment">//</span>
01884     <span class="comment">// Capture the current thread priority, set the thread priority to the</span>
01885     <span class="comment">// the new value, and replenish the thread quantum. It is assumed that</span>
01886     <span class="comment">// the priority would not be set unless the thread had already lost it</span>
01887     <span class="comment">// initial quantum.</span>
01888     <span class="comment">//</span>
01889 
01890     OldPriority = Thread-&gt;Priority;
01891     Process = Thread-&gt;ApcStatePointer[0]-&gt;Process;
01892     Thread-&gt;Quantum = Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o13">ThreadQuantum</a>;
01893     Thread-&gt;DecrementCount = 0;
01894     Thread-&gt;PriorityDecrement = 0;
01895     <a class="code" href="../../d0/d2/thredsup_8c.html#a5">KiSetPriorityThread</a>(Thread, Priority);
01896 
01897     <span class="comment">//</span>
01898     <span class="comment">// Unlock dispatcher database and lower IRQL to its previous</span>
01899     <span class="comment">// value.</span>
01900     <span class="comment">//</span>
01901 
01902     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
01903 
01904     <span class="comment">//</span>
01905     <span class="comment">// Return the previous thread priority.</span>
01906     <span class="comment">//</span>
01907 
01908     <span class="keywordflow">return</span> OldPriority;
01909 }
01910 
01911 ULONG
<a name="l01912"></a><a class="code" href="../../d9/d1/thredobj_8c.html#a25">01912</a> <a class="code" href="../../d9/d1/thredobj_8c.html#a25">KeSuspendThread</a> (
01913     IN <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread
01914     )
01915 
01916 <span class="comment">/*++</span>
01917 <span class="comment"></span>
01918 <span class="comment">Routine Description:</span>
01919 <span class="comment"></span>
01920 <span class="comment">    This function suspends the execution of a thread. If the suspend count</span>
01921 <span class="comment">    overflows the maximum suspend count, then a condition is raised.</span>
01922 <span class="comment"></span>
01923 <span class="comment">Arguments:</span>
01924 <span class="comment"></span>
01925 <span class="comment">    Thread  - Supplies a pointer to a dispatcher object of type thread.</span>
01926 <span class="comment"></span>
01927 <span class="comment">Return Value:</span>
01928 <span class="comment"></span>
01929 <span class="comment">    The previous suspend count.</span>
01930 <span class="comment"></span>
01931 <span class="comment">--*/</span>
01932 
01933 {
01934 
01935     ULONG OldCount;
01936     KIRQL OldIrql;
01937 
01938     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a1">ASSERT_THREAD</a>(Thread);
01939     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
01940 
01941     <span class="comment">//</span>
01942     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
01943     <span class="comment">//</span>
01944 
01945     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
01946 
01947     <span class="comment">//</span>
01948     <span class="comment">// Capture the current suspend count.</span>
01949     <span class="comment">//</span>
01950 
01951     OldCount = Thread-&gt;SuspendCount;
01952 
01953     <span class="comment">//</span>
01954     <span class="comment">// If the suspend count is at its maximum value, then unlock dispatcher</span>
01955     <span class="comment">// database, lower IRQL to its previous value, and raise an error</span>
01956     <span class="comment">// condition.</span>
01957     <span class="comment">//</span>
01958 
01959     <span class="keywordflow">if</span> (OldCount == MAXIMUM_SUSPEND_COUNT) {
01960 
01961         <span class="comment">//</span>
01962         <span class="comment">// Unlock the dispatcher database and raise an exception.</span>
01963         <span class="comment">//</span>
01964 
01965         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
01966         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_SUSPEND_COUNT_EXCEEDED);
01967     }
01968 
01969     <span class="comment">//</span>
01970     <span class="comment">// Increment the suspend count. If the thread was not previously suspended,</span>
01971     <span class="comment">// then queue the thread's suspend APC.</span>
01972     <span class="comment">//</span>
01973 
01974     Thread-&gt;SuspendCount += 1;
01975     <span class="keywordflow">if</span> ((OldCount == 0) &amp;&amp; (Thread-&gt;FreezeCount == 0)) {
01976         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/ki_8h.html#a123">KiInsertQueueApc</a>(&amp;Thread-&gt;SuspendApc, <a class="code" href="../../d0/d0/ki_8h.html#a2">RESUME_INCREMENT</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01977             Thread-&gt;SuspendSemaphore.Header.SignalState -= 1;
01978         }
01979     }
01980 
01981     <span class="comment">//</span>
01982     <span class="comment">// Unlock dispatcher database and lower IRQL to its previous</span>
01983     <span class="comment">// value.</span>
01984     <span class="comment">//</span>
01985 
01986     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
01987 
01988     <span class="comment">//</span>
01989     <span class="comment">// Return the previous suspend count.</span>
01990     <span class="comment">//</span>
01991 
01992     <span class="keywordflow">return</span> OldCount;
01993 }
01994 
01995 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01996"></a><a class="code" href="../../d9/d1/thredobj_8c.html#a26">01996</a> <a class="code" href="../../d9/d1/thredobj_8c.html#a26">KeTerminateThread</a> (
01997     IN KPRIORITY Increment
01998     )
01999 
02000 <span class="comment">/*++</span>
02001 <span class="comment"></span>
02002 <span class="comment">Routine Description:</span>
02003 <span class="comment"></span>
02004 <span class="comment">    This function terminates the execution of the current thread, sets the</span>
02005 <span class="comment">    signal state of the thread to Signaled, and attempts to satisfy as many</span>
02006 <span class="comment">    Waits as possible. The scheduling state of the thread is set to terminated,</span>
02007 <span class="comment">    and a new thread is selected to run on the current processor. There is no</span>
02008 <span class="comment">    return from this function.</span>
02009 <span class="comment"></span>
02010 <span class="comment">Arguments:</span>
02011 <span class="comment"></span>
02012 <span class="comment">    None.</span>
02013 <span class="comment"></span>
02014 <span class="comment">Return Value:</span>
02015 <span class="comment"></span>
02016 <span class="comment">    None.</span>
02017 <span class="comment"></span>
02018 <span class="comment">--*/</span>
02019 
02020 {
02021 
02022     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> NextThread;
02023     KIRQL OldIrql;
02024     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
02025     <a class="code" href="../../d7/d7/struct__KQUEUE.html">PRKQUEUE</a> Queue;
02026     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> Thread;
02027 
02028     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
02029 
02030     <span class="comment">//</span>
02031     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
02032     <span class="comment">//</span>
02033 
02034     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
02035     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
02036 
02037     <span class="comment">//</span>
02038     <span class="comment">// Insert the thread in the reaper list.</span>
02039     <span class="comment">//</span>
02040     <span class="comment">// If a reaper thread is not currently active, then insert a work item in</span>
02041     <span class="comment">// the hyper critical work queue.</span>
02042     <span class="comment">//</span>
02043     <span class="comment">// N.B. This code has knowledge of the reaper data structures and how</span>
02044     <span class="comment">//      worker threads are implemented.</span>
02045     <span class="comment">//</span>
02046     <span class="comment">// N.B. The dispatcher database lock is used to synchronize access to the</span>
02047     <span class="comment">//      reaper list.</span>
02048     <span class="comment">//</span>
02049 
02050     InsertTailList(&amp;<a class="code" href="../../d1/d9/ps_8h.html#a64">PsReaperListHead</a>, &amp;((<a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>)Thread)-&gt;TerminationPortList);
02051     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a63">PsReaperActive</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02052         <a class="code" href="../../d1/d9/ps_8h.html#a63">PsReaperActive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02053         <a class="code" href="../../d8/d3/queueobj_8c.html#a8">KiInsertQueue</a>(&amp;<a class="code" href="../../d1/d9/worker_8c.html#a12">ExWorkerQueue</a>[<a class="code" href="../../d5/d8/ex_8h.html#a332a207">HyperCriticalWorkQueue</a>].WorkerQueue,
02054                       &amp;<a class="code" href="../../d1/d9/ps_8h.html#a65">PsReaperWorkItem</a>.<a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html#o0">List</a>,
02055                       <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02056     }
02057 
02058     <span class="comment">//</span>
02059     <span class="comment">// If the current thread is processing a queue entry, then remove</span>
02060     <span class="comment">// the thrread from the queue object thread list and attempt to</span>
02061     <span class="comment">// activate another thread that is blocked on the queue object.</span>
02062     <span class="comment">//</span>
02063 
02064     Queue = Thread-&gt;Queue;
02065     <span class="keywordflow">if</span> (Queue != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02066         RemoveEntryList(&amp;Thread-&gt;QueueListEntry);
02067         <a class="code" href="../../d8/d3/queueobj_8c.html#a7">KiActivateWaiterQueue</a>(Queue);
02068     }
02069 
02070     <span class="comment">//</span>
02071     <span class="comment">// Set the state of the current thread object to Signaled, and attempt</span>
02072     <span class="comment">// to satisfy as many Waits as possible.</span>
02073     <span class="comment">//</span>
02074 
02075     Thread-&gt;Header.SignalState = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02076     <span class="keywordflow">if</span> (IsListEmpty(&amp;Thread-&gt;Header.WaitListHead) != <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02077         <a class="code" href="../../d2/d7/waitsup_8c.html#a3">KiWaitTest</a>((PVOID)Thread, <a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a>);
02078     }
02079 
02080     <span class="comment">//</span>
02081     <span class="comment">// Remove thread from its parent process' thread list.</span>
02082     <span class="comment">//</span>
02083 
02084     RemoveEntryList(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o37">ThreadListEntry</a>);
02085 
02086     <span class="comment">//</span>
02087     <span class="comment">// Set thread scheduling state to terminated, decrement the process'</span>
02088     <span class="comment">// stack count, select a new thread to run on the current processor,</span>
02089     <span class="comment">// and swap context to the new thread.</span>
02090     <span class="comment">//</span>
02091 
02092     Thread-&gt;State = <a class="code" href="../../d4/d9/ke_8h.html#a406a195">Terminated</a>;
02093     Process = Thread-&gt;ApcState.Process;
02094     Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o11">StackCount</a> -= 1;
02095     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o11">StackCount</a> == 0) {
02096         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o8">ThreadListHead</a>.Flink != &amp;Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o8">ThreadListHead</a>) {
02097             Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o15">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a405a188">ProcessInTransition</a>;
02098             InsertTailList(&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a49">KiProcessOutSwapListHead</a>, &amp;Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o7">SwapListEntry</a>);
02099             <a class="code" href="../../d5/d9/kernldat_8c.html#a47">KiSwapEvent</a>.<a class="code" href="../../d2/d6/struct__KEVENT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o4">SignalState</a> = 1;
02100             <span class="keywordflow">if</span> (IsListEmpty(&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a47">KiSwapEvent</a>.<a class="code" href="../../d2/d6/struct__KEVENT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o5">WaitListHead</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02101                 <a class="code" href="../../d2/d7/waitsup_8c.html#a3">KiWaitTest</a>(&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a47">KiSwapEvent</a>, <a class="code" href="../../d0/d0/ki_8h.html#a1">BALANCE_INCREMENT</a>);
02102             }
02103         }
02104     }
02105 
02106     <span class="comment">//</span>
02107     <span class="comment">// Rundown any architectural specific structures</span>
02108     <span class="comment">//</span>
02109 
02110     <a class="code" href="../../d9/d9/mips_8h.html#a2">KiRundownThread</a>(Thread);
02111 
02112     <span class="comment">//</span>
02113     <span class="comment">// Get off the processor for the last time.</span>
02114     <span class="comment">//</span>
02115 
02116     <a class="code" href="../../d0/d0/ki_8h.html#a138">KiSwapThread</a>();
02117     <span class="keywordflow">return</span>;
02118 }
02119 
02120 BOOLEAN
<a name="l02121"></a><a class="code" href="../../d9/d1/thredobj_8c.html#a27">02121</a> <a class="code" href="../../d9/d1/thredobj_8c.html#a27">KeTestAlertThread</a> (
02122     IN KPROCESSOR_MODE AlertMode
02123     )
02124 
02125 <span class="comment">/*++</span>
02126 <span class="comment"></span>
02127 <span class="comment">Routine Description:</span>
02128 <span class="comment"></span>
02129 <span class="comment">    This function tests to determine if the alerted variable for the</span>
02130 <span class="comment">    specified processor mode has a value of TRUE or whether a user mode</span>
02131 <span class="comment">    APC should be delivered to the current thread.</span>
02132 <span class="comment"></span>
02133 <span class="comment">Arguments:</span>
02134 <span class="comment"></span>
02135 <span class="comment">    AlertMode - Supplies the processor mode which is to be tested</span>
02136 <span class="comment">        for an alerted condition.</span>
02137 <span class="comment"></span>
02138 <span class="comment">Return Value:</span>
02139 <span class="comment"></span>
02140 <span class="comment">    The previous state of the alerted variable for the specified processor</span>
02141 <span class="comment">    mode.</span>
02142 <span class="comment"></span>
02143 <span class="comment">--*/</span>
02144 
02145 {
02146 
02147     BOOLEAN Alerted;
02148     KIRQL OldIrql;
02149     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
02150 
02151     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
02152 
02153     <span class="comment">//</span>
02154     <span class="comment">// Raise IRQL to dispatcher level, lock dispatcher database, and lock</span>
02155     <span class="comment">// APC queue.</span>
02156     <span class="comment">//</span>
02157 
02158     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
02159     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
02160     KiAcquireSpinLock(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o38">ApcQueueLock</a>);
02161 
02162     <span class="comment">//</span>
02163     <span class="comment">// If the current thread is alerted for the specified processor mode,</span>
02164     <span class="comment">// then clear the alerted state. Else if the specified processor mode</span>
02165     <span class="comment">// is user and the current thread's user mode APC queue contains an entry,</span>
02166     <span class="comment">// then set user APC pending.</span>
02167     <span class="comment">//</span>
02168 
02169     Alerted = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o9">Alerted</a>[AlertMode];
02170     <span class="keywordflow">if</span> (Alerted == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02171         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o9">Alerted</a>[AlertMode] = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02172 
02173     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((AlertMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) &amp;&amp;
02174               (IsListEmpty(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o0">ApcListHead</a>[<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>]) != <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
02175         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o4">UserApcPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02176     }
02177 
02178     <span class="comment">//</span>
02179     <span class="comment">// Unlock APC queue, unlock dispatcher database, lower IRQL to its</span>
02180     <span class="comment">// previous value, and return the previous alerted state for the</span>
02181     <span class="comment">// specified mode.</span>
02182     <span class="comment">//</span>
02183 
02184     KiReleaseSpinLock(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o38">ApcQueueLock</a>);
02185     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
02186     <span class="keywordflow">return</span> Alerted;
02187 }
02188 
02189 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02190"></a><a class="code" href="../../d9/d1/thredobj_8c.html#a28">02190</a> <a class="code" href="../../d9/d1/thredobj_8c.html#a28">KeThawAllThreads</a> (
02191     VOID
02192     )
02193 
02194 <span class="comment">/*++</span>
02195 <span class="comment"></span>
02196 <span class="comment">Routine Description:</span>
02197 <span class="comment"></span>
02198 <span class="comment">    This function resumes the execution of all suspended froozen threads</span>
02199 <span class="comment">    in the current process.</span>
02200 <span class="comment"></span>
02201 <span class="comment">Arguments:</span>
02202 <span class="comment"></span>
02203 <span class="comment">    None.</span>
02204 <span class="comment"></span>
02205 <span class="comment">Return Value:</span>
02206 <span class="comment"></span>
02207 <span class="comment">    None.</span>
02208 <span class="comment"></span>
02209 <span class="comment">--*/</span>
02210 
02211 {
02212 
02213     PLIST_ENTRY ListHead;
02214     PLIST_ENTRY NextEntry;
02215     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
02216     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
02217     ULONG OldCount;
02218     KIRQL OldIrql;
02219 
02220     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
02221 
02222     <span class="comment">//</span>
02223     <span class="comment">// Get the address of the current current process object, raise IRQL</span>
02224     <span class="comment">// to dispatch level, lock dispatcher database, and thaw the execution</span>
02225     <span class="comment">// of all threads in the current process that have been frozzen.</span>
02226     <span class="comment">//</span>
02227 
02228     Process = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ApcState.Process;
02229     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
02230     ListHead = &amp;Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o8">ThreadListHead</a>;
02231     NextEntry = ListHead-&gt;Flink;
02232     <span class="keywordflow">do</span> {
02233 
02234         <span class="comment">//</span>
02235         <span class="comment">// Get the address of the next thread and thaw its execution if</span>
02236         <span class="comment">// if was previously froozen.</span>
02237         <span class="comment">//</span>
02238 
02239         Thread = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d8/struct__KTHREAD.html">KTHREAD</a>, ThreadListEntry);
02240         OldCount = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o65">FreezeCount</a>;
02241         <span class="keywordflow">if</span> (OldCount != 0) {
02242             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o65">FreezeCount</a> -= 1;
02243 
02244             <span class="comment">//</span>
02245             <span class="comment">// If the resultant suspend count is zero and the freeze count is</span>
02246             <span class="comment">// zero, then resume the thread by releasing its suspend semaphore.</span>
02247             <span class="comment">//</span>
02248 
02249             <span class="keywordflow">if</span> ((Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o66">SuspendCount</a> == 0) &amp;&amp; (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o65">FreezeCount</a> == 0)) {
02250                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o63">SuspendSemaphore</a>.<a class="code" href="../../d8/d7/struct__KSEMAPHORE.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o4">SignalState</a> += 1;
02251                 <a class="code" href="../../d2/d7/waitsup_8c.html#a3">KiWaitTest</a>(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o63">SuspendSemaphore</a>, <a class="code" href="../../d0/d0/ki_8h.html#a2">RESUME_INCREMENT</a>);
02252             }
02253         }
02254 
02255         NextEntry = NextEntry-&gt;Flink;
02256     } <span class="keywordflow">while</span> (NextEntry != ListHead);
02257 
02258     <span class="comment">//</span>
02259     <span class="comment">// Unlock dispatcher database and lower IRQL to its previous</span>
02260     <span class="comment">// value.</span>
02261     <span class="comment">//</span>
02262 
02263     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
02264     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02265     <span class="keywordflow">return</span>;
02266 }
02267 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:59 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
