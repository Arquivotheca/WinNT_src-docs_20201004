<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: obinit.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>obinit.c File Reference</h1><code>#include "<a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>"</code><br>

<p>
<a href="../../d1/d0/obinit_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html">_OBP_FIND_HANDLE_DATA</a></td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html">_OBP_FIND_HANDLE_DATA</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/obinit_8c.html#a12">OBP_FIND_HANDLE_DATA</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html">_OBP_FIND_HANDLE_DATA</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/obinit_8c.html#a13">POBP_FIND_HANDLE_DATA</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/obinit_8c.html#a14">ObpCreateDosDevicesDirectory</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/obinit_8c.html#a15">ObpGetDosDevicesProtection</a> (PSECURITY_DESCRIPTOR SecurityDescriptor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/obinit_8c.html#a16">ObpFreeDosDevicesProtection</a> (PSECURITY_DESCRIPTOR SecurityDescriptor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/obinit_8c.html#a17">ObInitSystem</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/obinit_8c.html#a18">ObDupHandleProcedure</a> (<a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, <a class="el" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> ObjectTableEntry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/obinit_8c.html#a19">ObAuditInheritedHandleProcedure</a> (IN <a class="el" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> ObjectTableEntry, IN HANDLE HandleId, IN PVOID EnumParameter)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/obinit_8c.html#a20">ObInitProcess</a> (<a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ParentProcess OPTIONAL, <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> NewProcess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/obinit_8c.html#a21">ObInitProcess2</a> (<a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> NewProcess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/obinit_8c.html#a22">ObDestroyHandleProcedure</a> (IN HANDLE HandleIndex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/obinit_8c.html#a23">ObKillProcess</a> (BOOLEAN AcquireLock, <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/obinit_8c.html#a24">ObpEnumFindHandleProcedure</a> (<a class="el" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> ObjectTableEntry, HANDLE HandleId, PVOID EnumParameter)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/obinit_8c.html#a25">ObFindHandleForObject</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN PVOID Object OPTIONAL, IN <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType OPTIONAL, IN <a class="el" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">POBJECT_HANDLE_INFORMATION</a> HandleInformation OPTIONAL, OUT PHANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>GENERIC_MAPPING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/obinit_8c.html#a0">ObpTypeMapping</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>GENERIC_MAPPING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/obinit_8c.html#a1">ObpDirectoryMapping</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>GENERIC_MAPPING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/obinit_8c.html#a2">ObpSymbolicLinkMapping</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html">EPROCESS_QUOTA_BLOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/obinit_8c.html#a3">PspDefaultQuotaBlock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d7/struct__KMUTANT.html">KMUTANT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/obinit_8c.html#a4">ObpInitKillMutant</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/obinit_8c.html#a5">ObpProtectionMode</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/obinit_8c.html#a6">ObpAuditBaseDirectories</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/obinit_8c.html#a7">ObpAuditBaseObjects</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UNICODE_STRING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/obinit_8c.html#a8">ObpDosDevicesShortName</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULARGE_INTEGER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/obinit_8c.html#a9">ObpDosDevicesShortNamePrefix</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULARGE_INTEGER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/obinit_8c.html#a10">ObpDosDevicesShortNameRoot</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d4/struct__DEVICE__MAP.html">PDEVICE_MAP</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/obinit_8c.html#a11">ObSystemDeviceMap</a></td></tr>

</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a12" doxytag="obinit.c::OBP_FIND_HANDLE_DATA" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html">_OBP_FIND_HANDLE_DATA</a>  <a class="el" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html">OBP_FIND_HANDLE_DATA</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="obinit.c::POBP_FIND_HANDLE_DATA" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html">_OBP_FIND_HANDLE_DATA</a> * <a class="el" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html">POBP_FIND_HANDLE_DATA</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d1/d0/obinit_8c-source.html#l01127">ObpEnumFindHandleProcedure()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a19" doxytag="obinit.c::ObAuditInheritedHandleProcedure" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN ObAuditInheritedHandleProcedure           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTableEntry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>EnumParameter</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/obinit_8c-source.html#l00759">759</a> of file <a class="el" href="../../d1/d0/obinit_8c-source.html">obinit.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00408">OBJ_AUDIT_OBJECT_CLOSE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00305">_SE_PROCESS_AUDIT_INFO::Parent</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00304">_SE_PROCESS_AUDIT_INFO::Process</a>, <a class="el" href="../../d0/d5/se_8h.html#a32">PSE_PROCESS_AUDIT_INFO</a>, and <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02573">SeAuditHandleDuplication()</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/obinit_8c-source.html#l00815">ObInitProcess()</a>.
<p>
<pre class="fragment"><div>00767                    :
00768 
00769     <a class="code" href="../../d0/d8/ex_2handle_8c.html#a19">ExEnumHandleTable</a> worker routine to generate audits when handles are
00770     inherited.  An audit <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> generated <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle attributes indicate
00771     that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be audited on close.
00772 
00773 Arguments:
00774 
00775     ObjectTableEntry - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle table entry of interest.
00776 
00777     HandleId - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle.
00778 
00779     EnumParameter - Supplies information about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source and target processes.
00780 
00781 Return Value:
00782 
00783     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, which tells <a class="code" href="../../d0/d8/ex_2handle_8c.html#a19">ExEnumHandleTable</a> to <span class="keywordflow">continue</span> iterating through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00784     handle table.
00785 
00786 --*/
00787 
00788 {
00789     <a class="code" href="../../d3/d0/struct__SE__PROCESS__AUDIT__INFO.html">PSE_PROCESS_AUDIT_INFO</a> ProcessAuditInfo = EnumParameter;
00790 
00791     <span class="comment">//</span>
00792     <span class="comment">//  Check if we have to do an audit</span>
00793     <span class="comment">//</span>
00794 
00795     <span class="keywordflow">if</span> (!(ObjectTableEntry-&gt;ObAttributes &amp; <a class="code" href="../../d7/d7/ntapi_8c.html#a2">OBJ_AUDIT_OBJECT_CLOSE</a>)) {
00796 
00797         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00798     }
00799 
00800     <span class="comment">//</span>
00801     <span class="comment">//  Do the audit then return for more</span>
00802     <span class="comment">//</span>
00803 
00804     <a class="code" href="../../d7/d6/sepaudit_8c.html#a20">SeAuditHandleDuplication</a>( HandleId,
00805                               HandleId,
00806                               ProcessAuditInfo-&gt;<a class="code" href="../../d3/d0/struct__SE__PROCESS__AUDIT__INFO.html#o1">Parent</a>,
00807                               ProcessAuditInfo-&gt;<a class="code" href="../../d3/d0/struct__SE__PROCESS__AUDIT__INFO.html#o0">Process</a> );
00808 
00809     <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00810 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="obinit.c::ObDestroyHandleProcedure" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ObDestroyHandleProcedure           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>HandleIndex</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/obinit_8c-source.html#l00991">991</a> of file <a class="el" href="../../d1/d0/obinit_8c-source.html">obinit.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/obinit_8c-source.html#l01022">ObKillProcess()</a>.
<p>
<pre class="fragment"><div>00997                    :
00998 
00999     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to close a handle but takes as input a
01000     handle table index that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> first translates to an handle
01001     before calling close.  Note that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle index <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> really
01002     just <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle table entries.
01003 
01004 Arguments:
01005 
01006     HandleIndex - Supplies a handle index <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle being closed.
01007 
01008 Return Value:
01009 
01010     None.
01011 
01012 --*/
01013 
01014 {
01015     ZwClose( HandleIndex );
01016 
01017     <span class="keywordflow">return</span>;
01018 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="obinit.c::ObDupHandleProcedure" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN ObDupHandleProcedure           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTableEntry</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/obinit_8c-source.html#l00658">658</a> of file <a class="el" href="../../d1/d0/obinit_8c-source.html">obinit.c</a>.
<p>
References <a class="el" href="../../d5/d9/ob_8h-source.html#l00313">_OBJECT_HEADER::Body</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02690">_HANDLE_TABLE_ENTRY::GrantedAccess</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02694">_HANDLE_TABLE_ENTRY::GrantedAccessIndex</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00370">NtGlobalFlag</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02674">_HANDLE_TABLE_ENTRY::ObAttributes</a>, <a class="el" href="../../d4/d0/ob_8h.html#a100a61">ObInheritHandle</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00289">OBJ_HANDLE_ATTRIBUTES</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02672">_HANDLE_TABLE_ENTRY::Object</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01232">ObpIncrementHandleCount()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00143">ObpIncrPointerCount</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00171">_ACCESS_STATE::PreviouslyGrantedAccess</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/obinit_8c-source.html#l00815">ObInitProcess()</a>.
<p>
<pre class="fragment"><div>00665                    :
00666 
00667     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> worker routine <span class="keywordflow">for</span> <a class="code" href="../../d0/d8/ex_2handle_8c.html#a20">ExDupHandleTable</a> and
00668     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked via <a class="code" href="../../d4/d0/ob_8h.html#a64">ObInitProcess</a>.
00669 
00670 Arguments:
00671 
00672     Process - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> process
00673 
00674     ObjectTableEntry - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly
00675         created handle table entry
00676 
00677 Return Value:
00678 
00679     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> item can be inserted in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> table
00680         and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
00681 
00682 --*/
00683 
00684 {
00685     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00686     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00687     PVOID Object;
00688     <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">ACCESS_STATE</a> AccessState;
00689 
00690     <span class="comment">//</span>
00691     <span class="comment">//  If the object table should not inherited then return false</span>
00692     <span class="comment">//</span>
00693 
00694     <span class="keywordflow">if</span> (!(ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o1">ObAttributes</a> &amp; OBJ_INHERIT)) {
00695 
00696         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00697     }
00698 
00699     <span class="comment">//</span>
00700     <span class="comment">//  Get a pointer to the object header and body</span>
00701     <span class="comment">//</span>
00702 
00703     ObjectHeader = (<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>)(((ULONG_PTR)(ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a>)) &amp; ~<a class="code" href="../../d5/d1/obp_8h.html#a17">OBJ_HANDLE_ATTRIBUTES</a>);
00704 
00705     Object = &amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o11">Body</a>;
00706 
00707     <span class="comment">//</span>
00708     <span class="comment">//  If we are tracing the call stacks for cached security indices then we do got a</span>
00709     <span class="comment">//  translation to do otherwise the table entry contains straight away the granted</span>
00710     <span class="comment">//  access mask</span>
00711     <span class="comment">//</span>
00712 
00713 <span class="preprocessor">#if i386 &amp;&amp; !FPO</span>
00714 <span class="preprocessor"></span>
00715     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_KERNEL_STACK_TRACE_DB) {
00716 
00717         AccessState.<a class="code" href="../../d2/d5/struct__ACCESS__STATE.html#o7">PreviouslyGrantedAccess</a> = ObpTranslateGrantedAccessIndex( ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o3">GrantedAccessIndex</a> );
00718 
00719     } <span class="keywordflow">else</span> {
00720 
00721         AccessState.<a class="code" href="../../d2/d5/struct__ACCESS__STATE.html#o7">PreviouslyGrantedAccess</a> = ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a>;
00722     }
00723 
00724 <span class="preprocessor">#else</span>
00725 <span class="preprocessor"></span>
00726     AccessState.<a class="code" href="../../d2/d5/struct__ACCESS__STATE.html#o7">PreviouslyGrantedAccess</a> = ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a>;
00727 
00728 <span class="preprocessor">#endif // i386 &amp;&amp; !FPO</span>
00729 <span class="preprocessor"></span>
00730     <span class="comment">//</span>
00731     <span class="comment">//  Increment the handle count on the object because we've just added</span>
00732     <span class="comment">//  another handle to it.</span>
00733     <span class="comment">//</span>
00734 
00735     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a77">ObpIncrementHandleCount</a>( ObInheritHandle,
00736                                       Process,
00737                                       Object,
00738                                       ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>,
00739                                       &amp;AccessState,
00740                                       KernelMode,     <span class="comment">// BUGBUG this is probably wrong</span>
00741                                       0 );
00742 
00743     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00744 
00745         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00746     }
00747 
00748     <span class="comment">//</span>
00749     <span class="comment">//  Likewise we need to increment the pointer count to the object</span>
00750     <span class="comment">//</span>
00751 
00752     <a class="code" href="../../d5/d1/obp_8h.html#a3">ObpIncrPointerCount</a>( ObjectHeader );
00753 
00754     <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00755 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="obinit.c::ObFindHandleForObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN ObFindHandleForObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID Object&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">POBJECT_HANDLE_INFORMATION</a> HandleInformation&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/obinit_8c-source.html#l01234">1234</a> of file <a class="el" href="../../d1/d0/obinit_8c-source.html">obinit.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00634">ExEnumHandleTable()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01122">_OBP_FIND_HANDLE_DATA::HandleInformation</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00178">KeReleaseMutant()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01120">_OBP_FIND_HANDLE_DATA::ObjectHeader</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01121">_OBP_FIND_HANDLE_DATA::ObjectType</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01127">ObpEnumFindHandleProcedure()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00034">ObpInitKillMutant</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d6/desktop_8c-source.html#l04171">xxxUserFindHandleForObject()</a>.
<p>
<pre class="fragment"><div>01244                    :
01245 
01246     This routine searches <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle table <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process,
01247     looking <span class="keywordflow">for</span> a handle table entry that matches <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed parameters.
01248     If an an Object pointer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must match.  If an
01249     ObjectType <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must match.  If HandleInformation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01250     specified, then both <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> HandleAttributes and GrantedAccess mask
01251     must match.  If all three match parameters are <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, then will
01252     match <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first allocated handle <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process that
01253     matches <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified object pointer.
01254 
01255 Arguments:
01256 
01257     Process - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process whose object table <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be searched.
01258 
01259     Object - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object pointer to look <span class="keywordflow">for</span>.
01260 
01261     ObjectType - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> to look <span class="keywordflow">for</span>.
01262 
01263     HandleInformation - Specifies additional match criteria to look <span class="keywordflow">for</span>.
01264 
01265     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> location to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle value whose handle
01266         entry matches <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supplied object pointer and optional match criteria.
01267 
01268 Return Value:
01269 
01270     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> a match was found and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
01271 
01272 --*/
01273 
01274 {
01275     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">HANDLE_TABLE_ENTRY</a> ObjectTableEntry;
01276     <a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html">OBP_FIND_HANDLE_DATA</a> EnumParameter;
01277     BOOLEAN Result;
01278 
01279     Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01280 
01281     <span class="comment">//</span>
01282     <span class="comment">//  Lock the object object name space</span>
01283     <span class="comment">//</span>
01284 
01285     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01286 
01287     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;ObpInitKillMutant,
01288                            Executive,
01289                            KernelMode,
01290                            FALSE,
01291                            NULL );
01292 
01293     <span class="comment">//</span>
01294     <span class="comment">//  We only do the work if the process has an object table meaning</span>
01295     <span class="comment">//  it isn't going away</span>
01296     <span class="comment">//</span>
01297 
01298     <span class="keywordflow">if</span> (Process-&gt;ObjectTable != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01299 
01300         <span class="comment">//</span>
01301         <span class="comment">//  Set the match parameters that our caller supplied</span>
01302         <span class="comment">//</span>
01303 
01304         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Object )) {
01305 
01306             EnumParameter.<a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html#o0">ObjectHeader</a> = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
01307 
01308         } <span class="keywordflow">else</span> {
01309 
01310             EnumParameter.<a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html#o0">ObjectHeader</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01311         }
01312 
01313         EnumParameter.<a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html#o1">ObjectType</a> = ObjectType;
01314         EnumParameter.<a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html#o2">HandleInformation</a> = HandleInformation;
01315 
01316         <span class="comment">//</span>
01317         <span class="comment">//  Call the routine the enumerate the object table, this will</span>
01318         <span class="comment">//  return true if we get match.  The enumeration routine really</span>
01319         <span class="comment">//  returns a index into the object table entries we need to</span>
01320         <span class="comment">//  translate it to a real handle before returning.</span>
01321         <span class="comment">//</span>
01322 
01323         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/ex_8h.html#a293">ExEnumHandleTable</a>( Process-&gt;ObjectTable,
01324                                ObpEnumFindHandleProcedure,
01325                                &amp;EnumParameter,
01326                                Handle )) {
01327 
01328             Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01329         }
01330     }
01331 
01332     <span class="comment">//</span>
01333     <span class="comment">//  Unlock the object name space and return to our caller</span>
01334     <span class="comment">//</span>
01335 
01336     <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a>( &amp;ObpInitKillMutant, 0, FALSE, FALSE );
01337 
01338     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01339 
01340     <span class="keywordflow">return</span> Result;
01341 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="obinit.c::ObInitProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObInitProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ParentProcess&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NewProcess</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/obinit_8c-source.html#l00815">815</a> of file <a class="el" href="../../d1/d0/obinit_8c-source.html">obinit.c</a>.
<p>
References <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00457">ExCreateHandleTable()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00765">ExDupHandleTable()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00634">ExEnumHandleTable()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00178">KeReleaseMutant()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a180">MaxPoolType</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00759">ObAuditInheritedHandleProcedure()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00658">ObDupHandleProcedure()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00201">_EPROCESS::ObjectTable</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00034">ObpInitKillMutant</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00305">_SE_PROCESS_AUDIT_INFO::Parent</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00304">_SE_PROCESS_AUDIT_INFO::Process</a>, <a class="el" href="../../d0/d5/se_8h.html#a31">SE_PROCESS_AUDIT_INFO</a>, and <a class="el" href="../../d1/d4/se_8h-source.html#l01709">SeDetailedAuditing</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>.
<p>
<pre class="fragment"><div>00822                    :
00823 
00824     This function initializes a process object table.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ParentProcess
00825     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified, then all object handles with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> OBJ_INHERIT attribute are
00826     copied from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent object table to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> process' object table.
00827     The HandleCount field of each object copied <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> incremented by one.  Both
00828     object table mutexes remained locked <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> duration of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> copy
00829     operation.
00830 
00831 Arguments:
00832 
00833     ParentProcess - optional pointer to a process object that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00834         parent process to inherit object handles from.
00835 
00836     NewProcess - pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process object being initialized.
00837 
00838 Return Value:
00839 
00840     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code.
00841 
00842     The following errors can occur:
00843 
00844     - insufficient memory
00845 
00846 --*/
00847 
00848 {
00849     <a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> OldObjectTable;
00850     <a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> NewObjectTable;
00851     ULONG PoolCharges[ <a class="code" href="../../d5/d8/ex_8h.html#a329a180">MaxPoolType</a> ];
00852     <a class="code" href="../../d3/d0/struct__SE__PROCESS__AUDIT__INFO.html">SE_PROCESS_AUDIT_INFO</a> ProcessAuditInfo;
00853 
00854     RtlZeroMemory( PoolCharges, <span class="keyword">sizeof</span>( PoolCharges ) );
00855 
00856     <span class="comment">//</span>
00857     <span class="comment">//  If we have a parent process then we need to lock it down</span>
00858     <span class="comment">//  check that it is not going away and then make a copy</span>
00859     <span class="comment">//  of its handle table.  If there isn't a parent then</span>
00860     <span class="comment">//  we'll start with an empty handle table.</span>
00861     <span class="comment">//</span>
00862 
00863     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ParentProcess )) {
00864 
00865         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00866         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;ObpInitKillMutant,
00867                                Executive,
00868                                KernelMode,
00869                                FALSE,
00870                                NULL );
00871 
00872         OldObjectTable = ParentProcess-&gt;ObjectTable;
00873 
00874         <span class="keywordflow">if</span> ( !OldObjectTable ) {
00875 
00876             <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a>( &amp;ObpInitKillMutant, 0, FALSE, FALSE );
00877             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00878 
00879             <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
00880         }
00881 
00882         NewObjectTable = <a class="code" href="../../d5/d8/ex_8h.html#a294">ExDupHandleTable</a>( NewProcess,
00883                                            OldObjectTable,
00884                                            ObDupHandleProcedure );
00885 
00886     } <span class="keywordflow">else</span> {
00887 
00888         OldObjectTable = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00889         NewObjectTable = <a class="code" href="../../d5/d8/ex_8h.html#a290">ExCreateHandleTable</a>( NewProcess );
00890     }
00891 
00892     <span class="comment">//</span>
00893     <span class="comment">//  Check that we really have a new handle table otherwise</span>
00894     <span class="comment">//  we must be out of resources</span>
00895     <span class="comment">//</span>
00896 
00897     <span class="keywordflow">if</span> (NewObjectTable) {
00898 
00899         <span class="comment">//</span>
00900         <span class="comment">//  Set the new processes object table and if we are</span>
00901         <span class="comment">//  auditing then enumerate the new table calling</span>
00902         <span class="comment">//  the audit procedure</span>
00903         <span class="comment">//</span>
00904 
00905         NewProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o20">ObjectTable</a> = NewObjectTable;
00906 
00907         <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d5/se_8h.html#a106">SeDetailedAuditing</a> ) {
00908 
00909             ProcessAuditInfo.<a class="code" href="../../d3/d0/struct__SE__PROCESS__AUDIT__INFO.html#o0">Process</a> = NewProcess;
00910             ProcessAuditInfo.<a class="code" href="../../d3/d0/struct__SE__PROCESS__AUDIT__INFO.html#o1">Parent</a>  = ParentProcess;
00911 
00912             <a class="code" href="../../d5/d8/ex_8h.html#a293">ExEnumHandleTable</a>( NewObjectTable,
00913                                ObAuditInheritedHandleProcedure,
00914                                (PVOID)&amp;ProcessAuditInfo,
00915                                (PHANDLE)NULL );
00916         }
00917 
00918         <span class="comment">//</span>
00919         <span class="comment">//  Free the old table if it exists and then</span>
00920         <span class="comment">//  return our caller</span>
00921         <span class="comment">//</span>
00922 
00923         <span class="keywordflow">if</span> ( OldObjectTable ) {
00924 
00925             <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a>( &amp;ObpInitKillMutant, 0, FALSE, FALSE );
00926             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00927         }
00928 
00929         <span class="keywordflow">return</span>( STATUS_SUCCESS );
00930 
00931     } <span class="keywordflow">else</span> {
00932 
00933         <span class="comment">//</span>
00934         <span class="comment">//  We're out of resources to null out the new object table field,</span>
00935         <span class="comment">//  unlock the old object table, and tell our caller that this</span>
00936         <span class="comment">//  didn't work</span>
00937         <span class="comment">//</span>
00938 
00939         NewProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o20">ObjectTable</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00940 
00941         <span class="keywordflow">if</span> ( OldObjectTable ) {
00942 
00943             <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a>( &amp;ObpInitKillMutant, 0, FALSE, FALSE );
00944             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00945         }
00946 
00947         <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
00948     }
00949 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="obinit.c::ObInitProcess2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ObInitProcess2           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>NewProcess</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/obinit_8c-source.html#l00953">953</a> of file <a class="el" href="../../d1/d0/obinit_8c-source.html">obinit.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02975">ExSetHandleTableOrder</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00201">_EPROCESS::ObjectTable</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00282">_EPROCESS::SubSystemVersion</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>.
<p>
<pre class="fragment"><div>00959                    :
00960 
00961     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called after an image <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> has been mapped into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address
00962     space of a newly created process.  Allows <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object manager to set LIFO/FIFO
00963     ordering <span class="keywordflow">for</span> handle allocation based on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SubSystemVersion number in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00964     image.
00965 
00966 Arguments:
00967 
00968     NewProcess - pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process object being initialized.
00969 
00970 Return Value:
00971 
00972     None.
00973 
00974 --*/
00975 
00976 {
00977     <span class="comment">//</span>
00978     <span class="comment">//  Set LIFO ordering of handles for images &lt;= SubSystemVersion 3.50</span>
00979     <span class="comment">//</span>
00980 
00981     <span class="keywordflow">if</span> (NewProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o20">ObjectTable</a>) {
00982 
00983         <a class="code" href="../../d5/d8/ex_8h.html#a78">ExSetHandleTableOrder</a>( NewProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o20">ObjectTable</a>, (BOOLEAN)(NewProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o71">SubSystemVersion</a> &lt;= 0x332) );
00984     }
00985 
00986     <span class="keywordflow">return</span>;
00987 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="obinit.c::ObInitSystem" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN ObInitSystem           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">117</a> of file <a class="el" href="../../d1/d0/obinit_8c-source.html">obinit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00313">_OBJECT_HEADER::Body</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00331">_OBJECT_HEADER_NAME_INFO::Directory</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00457">ExCreateHandleTable()</a>, <a class="el" href="../../d0/d5/ex_2lookasid_8c-source.html#l00408">ExInitializeNPagedLookasideList()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00209">ExInitializeResourceLite()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00070">InitializationPhase</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00040">KeInitializeMutant()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02776">KeNumberProcessors</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02782">KiProcessorBlock</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00755">_NPAGED_LOOKASIDE_LIST::L</a>, <a class="el" href="../../d5/d8/ex_8h.html#a331a200">LookasideCreateInfoList</a>, <a class="el" href="../../d5/d8/ex_8h.html#a331a201">LookasideNameBufferList</a>, <a class="el" href="../../d2/d1/mm_8h.html#a140">MM_SYSTEMSIZE</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l03087">MmIsThisAnNtAsSystem()</a>, <a class="el" href="../../d2/d1/mm_8h.html#a343a167">MmLargeSystem</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l03073">MmQuerySystemSize()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00332">_OBJECT_HEADER_NAME_INFO::Name</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d8/ex_8h.html#a104">NPAGED_LOOKASIDE_LIST</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l00032">NtCreateDirectoryObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00069">ObCreateObjectType()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00368">OBJECT_HEADER_TO_NAME_INFO</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00390">OBJECT_NAME_BUFFER_SIZE</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00071">ObpAuditBaseDirectories</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00072">ObpAuditBaseObjects</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01349">ObpCreateDosDevicesDirectory()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00384">ObpCreateInfoLookasideList</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00088">ObpDefaultObject</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00904">ObpDeleteSymbolicLink()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00098">ObpDeviceMapLock</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00034">ObpDirectoryMapping</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00367">ObpDirectoryObjectType</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00189">ObpEnterRootDirectoryMutex</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00034">ObpInitKillMutant</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00118">ObpInitSecurityDescriptorCache()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l00903">ObpInsertDirectoryEntry()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00399">ObpKernelHandleTable</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00202">ObpLeaveRootDirectoryMutex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00087">ObpLock</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l00705">ObpLookupDirectoryEntry()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00392">ObpNameBufferLookasideList</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00501">ObpParseSymbolicLink()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00090">ObpRemoveObjectQueue</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00377">ObpRootDirectoryMutex</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00046">ObpRootDirectoryObject</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00047">ObpSymbolicLinkMapping</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00368">ObpSymbolicLinkObjectType</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00371">ObpTypeDirectoryObject</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00027">ObpTypeMapping</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00047">ObpTypeObjectType</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00114">_EPROCESS_QUOTA_BLOCK::PagefileLimit</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00046">PspDefaultQuotaBlock</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00107">_EPROCESS_QUOTA_BLOCK::QuotaLock</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00111">_EPROCESS_QUOTA_BLOCK::QuotaPoolLimit</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00108">_EPROCESS_QUOTA_BLOCK::ReferenceCount</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01849">RtlAddAuditAccessAce()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00099">RtlCreateAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01945">RtlCreateSecurityDescriptor()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00996">RtlGetAce()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02543">RtlSetDaclSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02756">RtlSetSaclSecurityDescriptor()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01659">SePublicDefaultUnrestrictedDacl</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01652">SePublicDefaultUnrestrictedSd</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01609">SeWorldSid</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00188">_OBJECT_TYPE::TypeList</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>00123                    :
00124 
00125     This function performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system initialization <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
00126     manager.  The object manager data structures are <span class="keyword">self</span> describing
00127     with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root directory, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> and
00128     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.  The initialization code then constructs
00129     these objects by hand to get <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ball rolling.
00130 
00131 Arguments:
00132 
00133     None.
00134 
00135 Return Value:
00136 
00137     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> successful and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> an error occurred.
00138 
00139     The following errors can occur:
00140 
00141     - insufficient memory
00142 
00143 --*/
00144 
00145 {
00146     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> CreateInfoMaxDepth;
00147     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> NameBufferMaxDepth;
00148     ULONG RegionSegmentSize;
00149     <a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html">OBJECT_TYPE_INITIALIZER</a> ObjectTypeInitializer;
00150     UNICODE_STRING TypeTypeName;
00151     UNICODE_STRING SymbolicLinkTypeName;
00152     UNICODE_STRING DosDevicesDirectoryName;
00153     UNICODE_STRING DirectoryTypeName;
00154     UNICODE_STRING RootDirectoryName;
00155     UNICODE_STRING TypeDirectoryName;
00156     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00157     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00158     HANDLE RootDirectoryHandle;
00159     HANDLE TypeDirectoryHandle;
00160     PLIST_ENTRY Next, Head;
00161     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectTypeHeader;
00162     <a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html">POBJECT_HEADER_CREATOR_INFO</a> CreatorInfo;
00163     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> NameInfo;
00164     <a class="code" href="../../d2/d1/mm_8h.html#a140">MM_SYSTEMSIZE</a> SystemSize;
00165     SECURITY_DESCRIPTOR AuditSd;
00166     PSECURITY_DESCRIPTOR EffectiveSd;
00167     PACL    AuditAllAcl;
00168     UCHAR   AuditAllBuffer[250];  <span class="comment">// Ample room for the ACL</span>
00169     ULONG   AuditAllLength;
00170     PACE_HEADER Ace;
00171     <a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">PNPAGED_LOOKASIDE_LIST</a> Lookaside;
00172     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00173     PKPRCB Prcb;
00174 
00175     <span class="comment">//</span>
00176     <span class="comment">//  Determine the the size of the object creation and the name buffer</span>
00177     <span class="comment">//  lookaside lists.</span>
00178     <span class="comment">//</span>
00179 
00180     SystemSize = <a class="code" href="../../d5/d1/mminit_8c.html#a57">MmQuerySystemSize</a>();
00181 
00182     <span class="keywordflow">if</span> (SystemSize == <a class="code" href="../../d2/d1/mm_8h.html#a343a167">MmLargeSystem</a>) {
00183 
00184         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/mminit_8c.html#a58">MmIsThisAnNtAsSystem</a>()) {
00185 
00186             CreateInfoMaxDepth = 64;
00187             NameBufferMaxDepth = 32;
00188 
00189         } <span class="keywordflow">else</span> {
00190 
00191             CreateInfoMaxDepth = 32;
00192             NameBufferMaxDepth = 16;
00193         }
00194 
00195     } <span class="keywordflow">else</span> {
00196 
00197         CreateInfoMaxDepth = 3;
00198         NameBufferMaxDepth = 3;
00199     }
00200 
00201     <span class="comment">//</span>
00202     <span class="comment">//  PHASE 0 Initialization</span>
00203     <span class="comment">//</span>
00204 
00205     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/init_8h.html#a21">InitializationPhase</a> == 0) {
00206 
00207         <span class="comment">//</span>
00208         <span class="comment">//  Initialize the object creation lookaside list.</span>
00209         <span class="comment">//</span>
00210 
00211         <a class="code" href="../../d5/d8/ex_8h.html#a246">ExInitializeNPagedLookasideList</a>( &amp;ObpCreateInfoLookasideList,
00212                                          NULL,
00213                                          NULL,
00214                                          0,
00215                                          <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html">OBJECT_CREATE_INFORMATION</a>),
00216                                          'iCbO',
00217                                          CreateInfoMaxDepth );
00218 
00219         <span class="comment">//</span>
00220         <span class="comment">//  Initialize the name buffer lookaside list.</span>
00221         <span class="comment">//</span>
00222 
00223         <a class="code" href="../../d5/d8/ex_8h.html#a246">ExInitializeNPagedLookasideList</a>( &amp;ObpNameBufferLookasideList,
00224                                          NULL,
00225                                          NULL,
00226                                          0,
00227                                          OBJECT_NAME_BUFFER_SIZE,
00228                                          'mNbO',
00229                                          NameBufferMaxDepth );
00230 
00231         <span class="comment">//</span>
00232         <span class="comment">//  Initialize the system create info and name buffer lookaside lists</span>
00233         <span class="comment">//  for the current processor.</span>
00234         <span class="comment">//</span>
00235         <span class="comment">// N.B. Temporarily during the initialization of the system both</span>
00236         <span class="comment">//      lookaside list pointers in the processor block point to</span>
00237         <span class="comment">//      the same lookaside list structure. Later in initialization</span>
00238         <span class="comment">//      another lookaside list structure is allocated and filled</span>
00239         <span class="comment">//      for the per processor list.</span>
00240         <span class="comment">//</span>
00241 
00242         Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00243         Prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a200">LookasideCreateInfoList</a>].L = &amp;<a class="code" href="../../d5/d1/obp_8h.html#a52">ObpCreateInfoLookasideList</a>;
00244         Prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a200">LookasideCreateInfoList</a>].P = &amp;<a class="code" href="../../d5/d1/obp_8h.html#a52">ObpCreateInfoLookasideList</a>;
00245         Prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a201">LookasideNameBufferList</a>].<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a> = &amp;<a class="code" href="../../d5/d1/obp_8h.html#a53">ObpNameBufferLookasideList</a>;
00246         Prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a201">LookasideNameBufferList</a>].P = &amp;<a class="code" href="../../d5/d1/obp_8h.html#a53">ObpNameBufferLookasideList</a>;
00247 
00248         <span class="comment">//</span>
00249         <span class="comment">//  Initialize the object removal queue listhead.</span>
00250         <span class="comment">//</span>
00251 
00252         <a class="code" href="../../d5/d1/obp_8h.html#a36">ObpRemoveObjectQueue</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00253 
00254         <span class="comment">//</span>
00255         <span class="comment">//  Initialize security descriptor cache</span>
00256         <span class="comment">//</span>
00257 
00258         <a class="code" href="../../d8/d1/obsdata_8c.html#a13">ObpInitSecurityDescriptorCache</a>();
00259 
00260         <a class="code" href="../../d3/d5/mutntobj_8c.html#a1">KeInitializeMutant</a>( &amp;ObpInitKillMutant, FALSE );
00261         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;ObpDefaultObject, NotificationEvent, TRUE );
00262         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;ObpLock );
00263         <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;GrantedAccess = PROCESS_ALL_ACCESS;
00264         <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;GrantedAccess = THREAD_ALL_ACCESS;
00265 
00266         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;ObpDeviceMapLock );
00267 
00268         <span class="comment">//</span>
00269         <span class="comment">//  Initialize the quota block and have the eprocess structure</span>
00270         <span class="comment">//  point to it.</span>
00271         <span class="comment">//</span>
00272 
00273         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;<a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>);
00274         <a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o1">ReferenceCount</a> = 1;
00275         <a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o4">QuotaPoolLimit</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>] = (ULONG)-1;
00276         <a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o4">QuotaPoolLimit</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>] = (ULONG)-1;
00277         <a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o7">PagefileLimit</a> = (ULONG)-1;
00278 
00279         <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;QuotaBlock = &amp;<a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>;
00280 
00281         <span class="comment">//</span>
00282         <span class="comment">//  Initialize the handle table for the system process and also the global</span>
00283         <span class="comment">//  kernel handle table</span>
00284         <span class="comment">//</span>
00285 
00286         <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ObjectTable = <a class="code" href="../../d5/d8/ex_8h.html#a290">ExCreateHandleTable</a>( NULL );
00287         <a class="code" href="../../d5/d1/obp_8h.html#a54">ObpKernelHandleTable</a> = <a class="code" href="../../d5/d8/ex_8h.html#a290">ExCreateHandleTable</a>( NULL );
00288 
00289         <span class="comment">//</span>
00290         <span class="comment">//  Create an object type for the "Type" object.  This is the start of</span>
00291         <span class="comment">//  of the object types and goes in the ObpTypeDirectoryObject.</span>
00292         <span class="comment">//</span>
00293 
00294         RtlZeroMemory( &amp;ObjectTypeInitializer, <span class="keyword">sizeof</span>( ObjectTypeInitializer ) );
00295         ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o0">Length</a> = <span class="keyword">sizeof</span>( ObjectTypeInitializer );
00296         ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o3">InvalidAttributes</a> = OBJ_OPENLINK;
00297         ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a> = <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>;
00298 
00299         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;TypeTypeName, L<span class="stringliteral">"Type"</span> );
00300         ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o5">ValidAccessMask</a> = OBJECT_TYPE_ALL_ACCESS;
00301         ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> = <a class="code" href="../../d0/d1/obinit_8c.html#a0">ObpTypeMapping</a>;
00302         ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o11">DefaultNonPagedPoolCharge</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">OBJECT_TYPE</a> );
00303         ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o8">MaintainTypeList</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00304         ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o1">UseDefaultObject</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00305         <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>( &amp;TypeTypeName,
00306                             &amp;ObjectTypeInitializer,
00307                             (PSECURITY_DESCRIPTOR)NULL,
00308                             &amp;ObpTypeObjectType );
00309 
00310         <span class="comment">//</span>
00311         <span class="comment">//  Create the object type for the "Directory" object.</span>
00312         <span class="comment">//</span>
00313 
00314         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;DirectoryTypeName, L<span class="stringliteral">"Directory"</span> );
00315         ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o11">DefaultNonPagedPoolCharge</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">OBJECT_DIRECTORY</a> );
00316         ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o5">ValidAccessMask</a> = DIRECTORY_ALL_ACCESS;
00317         ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> = <a class="code" href="../../d0/d1/obinit_8c.html#a1">ObpDirectoryMapping</a>;
00318         ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o1">UseDefaultObject</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00319         ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o8">MaintainTypeList</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00320         <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>( &amp;DirectoryTypeName,
00321                             &amp;ObjectTypeInitializer,
00322                             (PSECURITY_DESCRIPTOR)NULL,
00323                             &amp;ObpDirectoryObjectType );
00324 
00325         <span class="comment">//</span>
00326         <span class="comment">//  Create the object type for the "SymbolicLink" object.</span>
00327         <span class="comment">//</span>
00328 
00329         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;SymbolicLinkTypeName, L<span class="stringliteral">"SymbolicLink"</span> );
00330         ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o11">DefaultNonPagedPoolCharge</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html">OBJECT_SYMBOLIC_LINK</a> );
00331         ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o5">ValidAccessMask</a> = SYMBOLIC_LINK_ALL_ACCESS;
00332         ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> = <a class="code" href="../../d0/d1/obinit_8c.html#a2">ObpSymbolicLinkMapping</a>;
00333         ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o15">DeleteProcedure</a> = <a class="code" href="../../d4/d1/oblink_8c.html#a9">ObpDeleteSymbolicLink</a>;
00334         ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o16">ParseProcedure</a> = <a class="code" href="../../d4/d1/oblink_8c.html#a8">ObpParseSymbolicLink</a>;
00335         <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>( &amp;SymbolicLinkTypeName,
00336                             &amp;ObjectTypeInitializer,
00337                             (PSECURITY_DESCRIPTOR)NULL,
00338                             &amp;ObpSymbolicLinkObjectType );
00339 
00340         <span class="comment">//</span>
00341         <span class="comment">//  Initialize the resource that protects the object name space directory structure</span>
00342         <span class="comment">//</span>
00343 
00344         <a class="code" href="../../d5/d8/ex_8h.html#a266">ExInitializeResourceLite</a>( &amp;ObpRootDirectoryMutex );
00345 
00346 <span class="preprocessor">#if i386 &amp;&amp; !FPO</span>
00347 <span class="preprocessor"></span>
00348         <span class="comment">//</span>
00349         <span class="comment">//  Initialize the cached granted access structure.  These variables are used</span>
00350         <span class="comment">//  in place of the access mask in the object table entry.</span>
00351         <span class="comment">//</span>
00352 
00353         ObpCurCachedGrantedAccessIndex = 0;
00354         ObpMaxCachedGrantedAccessIndex = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> / <span class="keyword">sizeof</span>( ACCESS_MASK );
00355         ObpCachedGrantedAccesses = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPool, PAGE_SIZE, 'gAbO' );
00356 
00357 <span class="preprocessor">#endif // i386 &amp;&amp; !FPO</span>
00358 <span class="preprocessor"></span>
00359     } <span class="comment">// End of Phase 0 Initialization</span>
00360 
00361 
00362     <span class="comment">//</span>
00363     <span class="comment">//  PHASE 1 Initialization</span>
00364     <span class="comment">//</span>
00365 
00366     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/init_8h.html#a21">InitializationPhase</a> == 1) {
00367 
00368         <span class="comment">//</span>
00369         <span class="comment">//  Initialize the per processor nonpaged lookaside lists and descriptors.</span>
00370         <span class="comment">//</span>
00371 
00372         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; (ULONG)<a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00373             Prcb = <a class="code" href="../../d4/d9/ke_8h.html#a139">KiProcessorBlock</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00374 
00375             <span class="comment">//</span>
00376             <span class="comment">//  Initialize the create information per processor lookaside pointers.</span>
00377             <span class="comment">//</span>
00378 
00379             Prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a200">LookasideCreateInfoList</a>].L = &amp;<a class="code" href="../../d5/d1/obp_8h.html#a52">ObpCreateInfoLookasideList</a>;
00380             Lookaside = (<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">PNPAGED_LOOKASIDE_LIST</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPool,
00381                                                                        <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a>),
00382                                                                        'ICbO');
00383 
00384             <span class="keywordflow">if</span> (Lookaside != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00385                 <a class="code" href="../../d5/d8/ex_8h.html#a246">ExInitializeNPagedLookasideList</a>( Lookaside,
00386                                                  NULL,
00387                                                  NULL,
00388                                                  0,
00389                                                  <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html">OBJECT_CREATE_INFORMATION</a>),
00390                                                  'ICbO',
00391                                                  CreateInfoMaxDepth );
00392 
00393             } <span class="keywordflow">else</span> {
00394                 Lookaside = &amp;<a class="code" href="../../d5/d1/obp_8h.html#a52">ObpCreateInfoLookasideList</a>;
00395             }
00396 
00397             Prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a200">LookasideCreateInfoList</a>].P = Lookaside;
00398 
00399             <span class="comment">//</span>
00400             <span class="comment">//  Initialize the name buffer per processor lookaside pointers.</span>
00401             <span class="comment">//</span>
00402 
00403             Prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a201">LookasideNameBufferList</a>].<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a> = &amp;<a class="code" href="../../d5/d1/obp_8h.html#a53">ObpNameBufferLookasideList</a>;
00404             Lookaside = (<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">PNPAGED_LOOKASIDE_LIST</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPool,
00405                                                                        <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a>),
00406                                                                        'MNbO');
00407 
00408             <span class="keywordflow">if</span> (Lookaside != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00409                 <a class="code" href="../../d5/d8/ex_8h.html#a246">ExInitializeNPagedLookasideList</a>( Lookaside,
00410                                                  NULL,
00411                                                  NULL,
00412                                                  0,
00413                                                  OBJECT_NAME_BUFFER_SIZE,
00414                                                  'MNbO',
00415                                                  NameBufferMaxDepth);
00416 
00417             } <span class="keywordflow">else</span> {
00418                 Lookaside = &amp;<a class="code" href="../../d5/d1/obp_8h.html#a53">ObpNameBufferLookasideList</a>;
00419             }
00420 
00421             Prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a201">LookasideNameBufferList</a>].P = Lookaside;
00422         }
00423 
00424         EffectiveSd = <a class="code" href="../../d0/d5/se_8h.html#a68">SePublicDefaultUnrestrictedSd</a>;
00425 
00426         <span class="comment">//</span>
00427         <span class="comment">//  This code is only executed if base auditing is turned on.</span>
00428         <span class="comment">//</span>
00429 
00430         <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a15">ObpAuditBaseDirectories</a> != 0) || (<a class="code" href="../../d8/d0/cmdat3_8c.html#a16">ObpAuditBaseObjects</a> != 0)) {
00431 
00432             <span class="comment">//</span>
00433             <span class="comment">//  build an SACL to audit</span>
00434             <span class="comment">//</span>
00435 
00436             AuditAllAcl = (PACL)AuditAllBuffer;
00437             AuditAllLength = (ULONG)<span class="keyword">sizeof</span>(ACL) +
00438                                ((ULONG)<span class="keyword">sizeof</span>(SYSTEM_AUDIT_ACE)) +
00439                                <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(SeWorldSid);
00440 
00441             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>(AuditAllBuffer)   &gt;   AuditAllLength );
00442 
00443             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( AuditAllAcl, AuditAllLength, ACL_REVISION2);
00444 
00445             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) );
00446 
00447             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a20">RtlAddAuditAccessAce</a> ( AuditAllAcl,
00448                                             ACL_REVISION2,
00449                                             GENERIC_ALL,
00450                                             SeWorldSid,
00451                                             TRUE,  TRUE ); <span class="comment">//Audit success and failure</span>
00452             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) );
00453 
00454             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a>( AuditAllAcl, 0,  (PVOID)&amp;Ace );
00455 
00456             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) );
00457 
00458             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a15">ObpAuditBaseDirectories</a> != 0) {
00459 
00460                 Ace-&gt;AceFlags |= (CONTAINER_INHERIT_ACE | INHERIT_ONLY_ACE);
00461             }
00462 
00463             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a16">ObpAuditBaseObjects</a> != 0) {
00464 
00465                 Ace-&gt;AceFlags |= (OBJECT_INHERIT_ACE    |
00466                                   CONTAINER_INHERIT_ACE |
00467                                   INHERIT_ONLY_ACE);
00468             }
00469 
00470             <span class="comment">//</span>
00471             <span class="comment">//  Now create a security descriptor that looks just like</span>
00472             <span class="comment">//  the public default, but has auditing in it as well.</span>
00473             <span class="comment">//</span>
00474 
00475             EffectiveSd = (PSECURITY_DESCRIPTOR)&amp;AuditSd;
00476             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>( EffectiveSd,
00477                                                   SECURITY_DESCRIPTOR_REVISION1 );
00478 
00479             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) );
00480 
00481             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>( EffectiveSd,
00482                                                    TRUE,        <span class="comment">// DaclPresent</span>
00483                                                    SePublicDefaultUnrestrictedDacl,
00484                                                    FALSE );     <span class="comment">// DaclDefaulted</span>
00485 
00486             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) );
00487 
00488             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a62">RtlSetSaclSecurityDescriptor</a>( EffectiveSd,
00489                                                    TRUE,        <span class="comment">// DaclPresent</span>
00490                                                    AuditAllAcl,
00491                                                    FALSE );     <span class="comment">// DaclDefaulted</span>
00492 
00493             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) );
00494         }
00495 
00496         <span class="comment">//</span>
00497         <span class="comment">//  We only need to use the EffectiveSd on the root.  The SACL</span>
00498         <span class="comment">//  will be inherited by all other objects.</span>
00499         <span class="comment">//</span>
00500 
00501         <span class="comment">//</span>
00502         <span class="comment">//  Create an directory object for the root directory</span>
00503         <span class="comment">//</span>
00504 
00505         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;RootDirectoryName, L<span class="stringliteral">"\\"</span> );
00506 
00507         InitializeObjectAttributes( &amp;ObjectAttributes,
00508                                     &amp;RootDirectoryName,
00509                                     OBJ_CASE_INSENSITIVE |
00510                                     OBJ_PERMANENT,
00511                                     NULL,
00512                                     EffectiveSd );
00513 
00514         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d0/obdir_8c.html#a0">NtCreateDirectoryObject</a>( &amp;RootDirectoryHandle,
00515                                           DIRECTORY_ALL_ACCESS,
00516                                           &amp;ObjectAttributes );
00517 
00518         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00519 
00520             <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00521         }
00522 
00523         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( RootDirectoryHandle,
00524                                             0,
00525                                             ObpDirectoryObjectType,
00526                                             KernelMode,
00527                                             (PVOID *)&amp;ObpRootDirectoryObject,
00528                                             NULL );
00529 
00530         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00531 
00532             <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00533         }
00534 
00535         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( RootDirectoryHandle );
00536 
00537         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00538 
00539             <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00540         }
00541 
00542         <span class="comment">//</span>
00543         <span class="comment">//  Create an directory object for the directory of object types</span>
00544         <span class="comment">//</span>
00545 
00546         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;TypeDirectoryName, L<span class="stringliteral">"\\ObjectTypes"</span> );
00547 
00548         InitializeObjectAttributes( &amp;ObjectAttributes,
00549                                     &amp;TypeDirectoryName,
00550                                     OBJ_CASE_INSENSITIVE |
00551                                     OBJ_PERMANENT,
00552                                     NULL,
00553                                     NULL );
00554 
00555         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d0/obdir_8c.html#a0">NtCreateDirectoryObject</a>( &amp;TypeDirectoryHandle,
00556                                           DIRECTORY_ALL_ACCESS,
00557                                           &amp;ObjectAttributes );
00558 
00559         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00560 
00561             <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00562         }
00563 
00564         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( TypeDirectoryHandle,
00565                                             0,
00566                                             ObpDirectoryObjectType,
00567                                             KernelMode,
00568                                             (PVOID *)&amp;ObpTypeDirectoryObject,
00569                                             NULL );
00570 
00571         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00572 
00573             <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00574         }
00575 
00576         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( TypeDirectoryHandle );
00577 
00578         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00579 
00580             <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00581         }
00582 
00583         <span class="comment">//</span>
00584         <span class="comment">//  Lock the object directory name space</span>
00585         <span class="comment">//</span>
00586 
00587         <a class="code" href="../../d5/d1/obp_8h.html#a10">ObpEnterRootDirectoryMutex</a>();
00588 
00589         <span class="comment">//</span>
00590         <span class="comment">//  For every object type that has already been created we will</span>
00591         <span class="comment">//  insert it in the type directory.  We do this looking down the</span>
00592         <span class="comment">//  linked list of type objects and for every one that has a name</span>
00593         <span class="comment">//  and isn't already in a directory we'll look the name up and</span>
00594         <span class="comment">//  then put it in the directory.  Be sure to skip the first</span>
00595         <span class="comment">//  entry in the type object types lists.</span>
00596         <span class="comment">//</span>
00597 
00598         Head = &amp;<a class="code" href="../../d8/d5/kddata_8c.html#a10">ObpTypeObjectType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o1">TypeList</a>;
00599         Next = Head-&gt;Flink;
00600 
00601         <span class="keywordflow">while</span> (Next != Head) {
00602 
00603             <span class="comment">//</span>
00604             <span class="comment">//  Right after the creator info is the object header.  Get\</span>
00605             <span class="comment">//  the object header and then see if there is a name</span>
00606             <span class="comment">//</span>
00607 
00608             CreatorInfo = CONTAINING_RECORD( Next,
00609                                              <a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html">OBJECT_HEADER_CREATOR_INFO</a>,
00610                                              TypeList );
00611 
00612             ObjectTypeHeader = (<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>)(CreatorInfo+1);
00613 
00614             NameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>( ObjectTypeHeader );
00615 
00616             <span class="comment">//</span>
00617             <span class="comment">//  Check if we have a name and we're not in a directory</span>
00618             <span class="comment">//</span>
00619 
00620 
00621             <span class="keywordflow">if</span> ((NameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00622 
00623                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d1/obp_8h.html#a68">ObpLookupDirectoryEntry</a>( ObpTypeDirectoryObject,
00624                                               &amp;NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>,
00625                                               OBJ_CASE_INSENSITIVE )) {
00626 
00627                     <a class="code" href="../../d5/d1/obp_8h.html#a69">ObpInsertDirectoryEntry</a>( ObpTypeDirectoryObject,
00628                                              &amp;ObjectTypeHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o11">Body</a> );
00629                 }
00630             }
00631 
00632             Next = Next-&gt;Flink;
00633         }
00634 
00635         <span class="comment">//</span>
00636         <span class="comment">//  Unlock the object directory name space</span>
00637         <span class="comment">//</span>
00638 
00639         <a class="code" href="../../d5/d1/obp_8h.html#a11">ObpLeaveRootDirectoryMutex</a>();
00640 
00641         <span class="comment">//</span>
00642         <span class="comment">//  Create \DosDevices object directory for drive letters and Win32 device names</span>
00643         <span class="comment">//</span>
00644 
00645         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d1/obinit_8c.html#a14">ObpCreateDosDevicesDirectory</a>();
00646 
00647         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00648 
00649             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00650         }
00651     }
00652 
00653     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00654 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="obinit.c::ObKillProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ObKillProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AcquireLock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/obinit_8c-source.html#l01022">1022</a> of file <a class="el" href="../../d1/d0/obinit_8c-source.html">obinit.c</a>.
<p>
References <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00560">ExDestroyHandleTable()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l10281">IoSetThreadHardErrorMode()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00178">KeReleaseMutant()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00991">ObDestroyHandleProcedure()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00201">_EPROCESS::ObjectTable</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00034">ObpInitKillMutant</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00071">ObpValidateIrql</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01232">PspExitProcess()</a>, and <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>.
<p>
<pre class="fragment"><div>01028                    :
01029 
01030     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called whenever a process <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> destroyed.  It loops over
01031     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process' object table and closes all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handles.
01032 
01033 Arguments:
01034 
01035     AcquireLock - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> there are other pointers to <span class="keyword">this</span> process and therefore
01036         <span class="keyword">this</span> operation needs to be <span class="keyword">synchronized</span>.  False <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being called
01037         from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Process <span class="keyword">delete</span> routine and therefore <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> pointer
01038         to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process.
01039 
01040     Process - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being destroyed.
01041 
01042 Return Value:
01043 
01044     None.
01045 
01046 --*/
01047 
01048 {
01049     PVOID ObjectTable;
01050     BOOLEAN PreviousIOHardError;
01051 
01052     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01053 
01054     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>( <span class="stringliteral">"ObKillProcess"</span> );
01055 
01056     <span class="comment">//</span>
01057     <span class="comment">//  Check if we need to get the lock</span>
01058     <span class="comment">//</span>
01059 
01060     <span class="keywordflow">if</span> (AcquireLock) {
01061 
01062         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01063 
01064         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;ObpInitKillMutant,
01065                                Executive,
01066                                KernelMode,
01067                                FALSE,
01068                                NULL );
01069     }
01070 
01071     <span class="comment">//</span>
01072     <span class="comment">//  If the process does NOT have an object table, return</span>
01073     <span class="comment">//</span>
01074 
01075     ObjectTable = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o20">ObjectTable</a>;
01076 
01077     <span class="keywordflow">if</span> (ObjectTable != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01078         
01079         PreviousIOHardError = <a class="code" href="../../d4/d6/iosubs_8c.html#a108">IoSetThreadHardErrorMode</a>(FALSE); 
01080         
01081         <span class="comment">//</span>
01082         <span class="comment">//  For each valid entry in the object table, close the handle</span>
01083         <span class="comment">//  that points to that entry.</span>
01084         <span class="comment">//</span>
01085 
01086         <a class="code" href="../../d5/d8/ex_8h.html#a292">ExDestroyHandleTable</a>( ObjectTable, ObDestroyHandleProcedure );
01087 
01088         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o20">ObjectTable</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01089         
01090         <a class="code" href="../../d4/d6/iosubs_8c.html#a108">IoSetThreadHardErrorMode</a>( PreviousIOHardError ); 
01091     }
01092 
01093     <span class="comment">//</span>
01094     <span class="comment">//  Release the lock</span>
01095     <span class="comment">//</span>
01096 
01097     <span class="keywordflow">if</span> (AcquireLock) {
01098 
01099         <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a>( &amp;ObpInitKillMutant, 0, FALSE, FALSE );
01100 
01101         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01102     }
01103 
01104     <span class="comment">//</span>
01105     <span class="comment">//  And return to our caller</span>
01106     <span class="comment">//</span>
01107 
01108     <span class="keywordflow">return</span>;
01109 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="obinit.c::ObpCreateDosDevicesDirectory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObpCreateDosDevicesDirectory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/obinit_8c-source.html#l01349">1349</a> of file <a class="el" href="../../d1/d0/obinit_8c-source.html">obinit.c</a>.
<p>
References <a class="el" href="../../d4/d2/tob_8c-source.html#l00063">DirectoryHandle</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l00032">NtCreateDirectoryObject()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00052">NtCreateSymbolicLinkObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00110">ObpDosDevicesShortName</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00111">ObpDosDevicesShortNamePrefix</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00112">ObpDosDevicesShortNameRoot</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01805">ObpFreeDosDevicesProtection()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01545">ObpGetDosDevicesProtection()</a>, <a class="el" href="../../d8/d9/obdevmap_8c-source.html#l00030">ObSetDeviceMap()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01763">RtlCopyUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01935">RtlCreateUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>.
<p>
<pre class="fragment"><div>01355                    :
01356 
01357     This routine creates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dos devices and sets
01358     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device map <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system process.
01359 
01360 Arguments:
01361 
01362     None.
01363 
01364 Return Value:
01365 
01366     STATUS_SUCCESS or an appropriate error
01367 
01368 --*/
01369 
01370 {
01371     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01372     UNICODE_STRING NameString;
01373     UNICODE_STRING LinkNameString;
01374     UNICODE_STRING TargetString;
01375     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
01376     HANDLE <a class="code" href="../../d3/d3/tob_8c.html#a23">DirectoryHandle</a>;
01377     HANDLE SymbolicLinkHandle;
01378     SECURITY_DESCRIPTOR DosDevicesSD;
01379 
01380     <span class="comment">//</span>
01381     <span class="comment">//  Create the security descriptor to use for the \?? directory</span>
01382     <span class="comment">//</span>
01383 
01384     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d1/obinit_8c.html#a15">ObpGetDosDevicesProtection</a>( &amp;DosDevicesSD );
01385 
01386     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01387 
01388         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01389     }
01390 
01391     <span class="comment">//</span>
01392     <span class="comment">//  Create the root directory object for the \?? directory.</span>
01393     <span class="comment">//</span>
01394 
01395     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;NameString, L<span class="stringliteral">"\\??"</span> );
01396 
01397     InitializeObjectAttributes( &amp;ObjectAttributes,
01398                                 &amp;NameString,
01399                                 OBJ_PERMANENT,
01400                                 (HANDLE) NULL,
01401                                 &amp;DosDevicesSD );
01402 
01403     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d0/obdir_8c.html#a0">NtCreateDirectoryObject</a>( &amp;DirectoryHandle,
01404                                       DIRECTORY_ALL_ACCESS,
01405                                       &amp;ObjectAttributes );
01406 
01407     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01408 
01409         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01410     }
01411 
01412     <span class="comment">//</span>
01413     <span class="comment">//  Create a device map that will control this directory.  It will be</span>
01414     <span class="comment">//  stored in the each EPROCESS for use by ObpLookupObjectName when</span>
01415     <span class="comment">//  translating names that begin with \??\</span>
01416     <span class="comment">//</span>
01417 
01418     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d0/obdevmap_8c.html#a0">ObSetDeviceMap</a>( NULL, DirectoryHandle );
01419 
01420 
01421     <span class="comment">//</span>
01422     <span class="comment">//  Now create a symbolic link, \??\GLOBALROOT, that points to \</span>
01423     <span class="comment">//  WorkStation service needs some mechanism to access a session specific</span>
01424     <span class="comment">//  DosDevicesDirectory. DosPathToSessionPath API will take a DosPath</span>
01425     <span class="comment">//  e.g (C:) and convert it into session specific path</span>
01426     <span class="comment">//  (e.g GLOBALROOT\Sessions\6\DosDevices\C:). The GLOBALROOT symbolic</span>
01427     <span class="comment">//  link is used to escape out of the current process's DosDevices directory</span>
01428     <span class="comment">//</span>
01429 
01430     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;LinkNameString, L<span class="stringliteral">"GLOBALROOT"</span> );
01431     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;TargetString, L<span class="stringliteral">""</span> );
01432 
01433     InitializeObjectAttributes( &amp;ObjectAttributes,
01434                                 &amp;LinkNameString,
01435                                 OBJ_PERMANENT,
01436                                 DirectoryHandle,
01437                                 &amp;DosDevicesSD );
01438 
01439     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/oblink_8c.html#a5">NtCreateSymbolicLinkObject</a>( &amp;SymbolicLinkHandle,
01440                                          SYMBOLIC_LINK_ALL_ACCESS,
01441                                          &amp;ObjectAttributes,
01442                                          &amp;TargetString );
01443 
01444     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01445 
01446         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( SymbolicLinkHandle );
01447     }
01448 
01449     <span class="comment">//</span>
01450     <span class="comment">//  Create a symbolic link, \??\Global, that points to \??</span>
01451     <span class="comment">//  Drivers loaded dynamically create the symbolic link in the global</span>
01452     <span class="comment">//  DosDevices directory. User mode components need some way to access this</span>
01453     <span class="comment">//  symbolic link in the global dosdevices directory. The Global symbolic</span>
01454     <span class="comment">//  link is used to escape out of the current sessions's DosDevices directory</span>
01455     <span class="comment">//  and use the global dosdevices directory. e.g CreateFile("\\\\.\\Global\\NMDev"..);</span>
01456     <span class="comment">//</span>
01457 
01458     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;LinkNameString, L<span class="stringliteral">"Global"</span> );
01459     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;TargetString, L<span class="stringliteral">"\\??"</span> );
01460 
01461     InitializeObjectAttributes( &amp;ObjectAttributes,
01462                                 &amp;LinkNameString,
01463                                 OBJ_PERMANENT,
01464                                 DirectoryHandle,
01465                                 &amp;DosDevicesSD );
01466 
01467     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/oblink_8c.html#a5">NtCreateSymbolicLinkObject</a>( &amp;SymbolicLinkHandle,
01468                                          SYMBOLIC_LINK_ALL_ACCESS,
01469                                          &amp;ObjectAttributes,
01470                                          &amp;TargetString );
01471 
01472     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01473 
01474         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( SymbolicLinkHandle );
01475     }
01476 
01477 
01478     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( DirectoryHandle );
01479 
01480     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01481 
01482         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01483     }
01484 
01485     <span class="comment">//</span>
01486     <span class="comment">//  Now copy the \?? string to a ULONGLONG aligned global variable</span>
01487     <span class="comment">//  for use by ObpLookupObjectName for quick comparisons.</span>
01488     <span class="comment">//</span>
01489 
01490     <a class="code" href="../../d0/d1/obinit_8c.html#a8">ObpDosDevicesShortName</a>.Buffer = (PWSTR)&amp;<a class="code" href="../../d0/d1/obinit_8c.html#a9">ObpDosDevicesShortNamePrefix</a>.QuadPart;
01491     <a class="code" href="../../d0/d1/obinit_8c.html#a8">ObpDosDevicesShortName</a>.Length = 0;
01492     <a class="code" href="../../d0/d1/obinit_8c.html#a8">ObpDosDevicesShortName</a>.MaximumLength = <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d1/obinit_8c.html#a9">ObpDosDevicesShortNamePrefix</a> );
01493 
01494     <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>( &amp;ObpDosDevicesShortName, &amp;NameString );
01495 
01496     <a class="code" href="../../d0/d1/obinit_8c.html#a8">ObpDosDevicesShortName</a>.Buffer[ 3 ] = UNICODE_NULL;
01497     <a class="code" href="../../d0/d1/obinit_8c.html#a10">ObpDosDevicesShortNameRoot</a>.QuadPart = <a class="code" href="../../d0/d1/obinit_8c.html#a9">ObpDosDevicesShortNamePrefix</a>.QuadPart;
01498 
01499     <span class="comment">//</span>
01500     <span class="comment">//  Now create a symbolic link, \DosDevices, that points to \??</span>
01501     <span class="comment">//  for backwards compatibility with old drivers that use the old</span>
01502     <span class="comment">//  name.</span>
01503     <span class="comment">//</span>
01504 
01505     <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>( &amp;NameString, L<span class="stringliteral">"\\DosDevices"</span> );
01506 
01507     InitializeObjectAttributes( &amp;ObjectAttributes,
01508                                 &amp;NameString,
01509                                 OBJ_PERMANENT,
01510                                 (HANDLE) NULL,
01511                                 &amp;DosDevicesSD );
01512 
01513     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/oblink_8c.html#a5">NtCreateSymbolicLinkObject</a>( &amp;SymbolicLinkHandle,
01514                                          SYMBOLIC_LINK_ALL_ACCESS,
01515                                          &amp;ObjectAttributes,
01516                                          &amp;ObpDosDevicesShortName );
01517 
01518     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01519 
01520         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( SymbolicLinkHandle );
01521     }
01522 
01523     <span class="comment">//</span>
01524     <span class="comment">//  Finish setting up the global variable for ObpLookupObjectName</span>
01525     <span class="comment">//</span>
01526 
01527     <a class="code" href="../../d0/d1/obinit_8c.html#a8">ObpDosDevicesShortName</a>.Buffer[ 3 ] = OBJ_NAME_PATH_SEPARATOR;
01528     <a class="code" href="../../d0/d1/obinit_8c.html#a8">ObpDosDevicesShortName</a>.Length += <span class="keyword">sizeof</span>( OBJ_NAME_PATH_SEPARATOR );
01529 
01530     <span class="comment">//</span>
01531     <span class="comment">//  All done with the security descriptor for \??</span>
01532     <span class="comment">//</span>
01533 
01534     <a class="code" href="../../d0/d1/obinit_8c.html#a16">ObpFreeDosDevicesProtection</a>( &amp;DosDevicesSD );
01535 
01536     <span class="keywordflow">return</span> STATUS_SUCCESS;
01537 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="obinit.c::ObpEnumFindHandleProcedure" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN ObpEnumFindHandleProcedure           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTableEntry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>EnumParameter</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/obinit_8c-source.html#l01127">1127</a> of file <a class="el" href="../../d1/d0/obinit_8c-source.html">obinit.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00057">_OBJECT_HANDLE_INFORMATION::GrantedAccess</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02690">_HANDLE_TABLE_ENTRY::GrantedAccess</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02694">_HANDLE_TABLE_ENTRY::GrantedAccessIndex</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00056">_OBJECT_HANDLE_INFORMATION::HandleAttributes</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01122">_OBP_FIND_HANDLE_DATA::HandleInformation</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00370">NtGlobalFlag</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00289">OBJ_HANDLE_ATTRIBUTES</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02672">_HANDLE_TABLE_ENTRY::Object</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01120">_OBP_FIND_HANDLE_DATA::ObjectHeader</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01121">_OBP_FIND_HANDLE_DATA::ObjectType</a>, <a class="el" href="../../d0/d1/obinit_8c.html#a13">POBP_FIND_HANDLE_DATA</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/obinit_8c-source.html#l01234">ObFindHandleForObject()</a>.
<p>
<pre class="fragment"><div>01135                    :
01136 
01137     Call back routine when enumerating an object table to find a handle
01138     <span class="keywordflow">for</span> a particular object
01139 
01140 Arguments:
01141 
01142     HandleTableEntry - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle table entry
01143         being examined.
01144 
01145     HandleId - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual handle value <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> preceding entry
01146 
01147     EnumParameter - Supplies context <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a>.
01148 
01149 Return Value:
01150 
01151     Returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> a match <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> found and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration should stop.  Returns <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01152     otherwise, so <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration will <span class="keywordflow">continue</span>.
01153 
01154 --*/
01155 
01156 {
01157     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01158     ACCESS_MASK GrantedAccess;
01159     ULONG HandleAttributes;
01160     <a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html">POBP_FIND_HANDLE_DATA</a> MatchCriteria = EnumParameter;
01161 
01162     <span class="comment">//</span>
01163     <span class="comment">//  Get the object header from the table entry and see if</span>
01164     <span class="comment">//  object types and headers match if specified.</span>
01165     <span class="comment">//</span>
01166 
01167     ObjectHeader = (<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>)((ULONG_PTR)ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a> &amp; ~<a class="code" href="../../d5/d1/obp_8h.html#a17">OBJ_HANDLE_ATTRIBUTES</a>);
01168 
01169     <span class="keywordflow">if</span> ((MatchCriteria-&gt;<a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html#o0">ObjectHeader</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01170         (MatchCriteria-&gt;<a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html#o0">ObjectHeader</a> != ObjectHeader)) {
01171 
01172         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01173     }
01174 
01175     <span class="keywordflow">if</span> ((MatchCriteria-&gt;<a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html#o1">ObjectType</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01176         (MatchCriteria-&gt;<a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html#o1">ObjectType</a> != ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>)) {
01177 
01178         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01179     }
01180 
01181     <span class="comment">//</span>
01182     <span class="comment">//  Check if we have handle information that we need to compare</span>
01183     <span class="comment">//</span>
01184 
01185     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( MatchCriteria-&gt;<a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html#o2">HandleInformation</a> )) {
01186 
01187         <span class="comment">//</span>
01188         <span class="comment">//  If we are tracing the call stacks for cached security indices then we do got a</span>
01189         <span class="comment">//  translation to do otherwise the table entry contains straight away the granted</span>
01190         <span class="comment">//  access mask</span>
01191         <span class="comment">//</span>
01192 
01193 <span class="preprocessor">#if i386 &amp;&amp; !FPO</span>
01194 <span class="preprocessor"></span>
01195         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_KERNEL_STACK_TRACE_DB) {
01196 
01197             GrantedAccess = ObpTranslateGrantedAccessIndex( ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o3">GrantedAccessIndex</a> );
01198 
01199         } <span class="keywordflow">else</span> {
01200 
01201             GrantedAccess = ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a>;
01202         }
01203 <span class="preprocessor">#else</span>
01204 <span class="preprocessor"></span>
01205         GrantedAccess = ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a>;
01206 
01207 <span class="preprocessor">#endif // i386 &amp;&amp; !FPO</span>
01208 <span class="preprocessor"></span>
01209         <span class="comment">//</span>
01210         <span class="comment">//  Get the handle attributes from table entry and see if the</span>
01211         <span class="comment">//  fields match.  If they do not match we will return false to</span>
01212         <span class="comment">//  continue the search.</span>
01213         <span class="comment">//</span>
01214 
01215         HandleAttributes = (ULONG)((ULONG_PTR)ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a> &amp; <a class="code" href="../../d5/d1/obp_8h.html#a17">OBJ_HANDLE_ATTRIBUTES</a>);
01216 
01217         <span class="keywordflow">if</span> (MatchCriteria-&gt;<a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html#o2">HandleInformation</a>-&gt;<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o0">HandleAttributes</a> != HandleAttributes ||
01218             MatchCriteria-&gt;<a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html#o2">HandleInformation</a>-&gt;<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o1">GrantedAccess</a> != GrantedAccess ) {
01219 
01220             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01221         }
01222     }
01223 
01224     <span class="comment">//</span>
01225     <span class="comment">//  We found something that matches our criteria so return true to</span>
01226     <span class="comment">//  our caller to stop the enumeration</span>
01227     <span class="comment">//</span>
01228 
01229     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01230 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="obinit.c::ObpFreeDosDevicesProtection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ObpFreeDosDevicesProtection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SecurityDescriptor</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/obinit_8c-source.html#l01805">1805</a> of file <a class="el" href="../../d1/d0/obinit_8c-source.html">obinit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00161">Dacl</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02665">RtlGetDaclSecurityDescriptor()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/obinit_8c-source.html#l01349">ObpCreateDosDevicesDirectory()</a>.
<p>
<pre class="fragment"><div>01811                    :
01812 
01813     This routine frees memory allocated via <a class="code" href="../../d0/d1/obinit_8c.html#a15">ObpGetDosDevicesProtection</a>().
01814 
01815 Arguments:
01816 
01817     SecurityDescriptor - The address of a security descriptor initialized by
01818         <a class="code" href="../../d0/d1/obinit_8c.html#a15">ObpGetDosDevicesProtection</a>().
01819 
01820 Return Value:
01821 
01822     None.
01823 
01824 --*/
01825 
01826 {
01827     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01828     PACL <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>;
01829     BOOLEAN DaclPresent, Defaulted;
01830 
01831     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a61">RtlGetDaclSecurityDescriptor</a> ( SecurityDescriptor,
01832                                             &amp;DaclPresent,
01833                                             &amp;Dacl,
01834                                             &amp;Defaulted );
01835 
01836     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) );
01837     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( DaclPresent );
01838     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Dacl != NULL );
01839 
01840     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( (PVOID)Dacl );
01841 
01842     <span class="keywordflow">return</span>;
01843 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="obinit.c::ObpGetDosDevicesProtection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObpGetDosDevicesProtection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SecurityDescriptor</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
DaclDefaulted<p>
DaclDefaulted 
<p>
Definition at line <a class="el" href="../../d1/d0/obinit_8c-source.html#l01545">1545</a> of file <a class="el" href="../../d1/d0/obinit_8c-source.html">obinit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00070">ObpProtectionMode</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01607">RtlAddAccessAllowedAce()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00099">RtlCreateAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01945">RtlCreateSecurityDescriptor()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00996">RtlGetAce()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01350">RtlLengthSid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02543">RtlSetDaclSecurityDescriptor()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01630">SeAliasAdminsSid</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01611">SeCreatorOwnerSid</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01628">SeLocalSystemSid</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01609">SeWorldSid</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/obinit_8c-source.html#l01349">ObpCreateDosDevicesDirectory()</a>.
<p>
<pre class="fragment"><div>01551                    :
01552 
01553     This routine builds a security descriptor <span class="keywordflow">for</span> use in creating
01554     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> \DosDevices object directory.  The protection of \DosDevices
01555     must establish inheritable protection which will dictate how
01556     dos devices created via <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DefineDosDevice() and
01557     IoCreateUnprotectedSymbolicLink() apis can be managed.
01558 
01559     The protection assigned is dependent upon an administrable registry
01560     key:
01561 
01562         Key: \hkey_local_machine\System\CurrentControlSet\Control\Session Manager
01563         Value: [REG_DWORD] ProtectionMode
01564 
01565     If this value is 0x1, then
01566 
01567             Administrators may control all Dos devices,
01568             Anyone may create new Dos devices (such as net drives
01569                 or additional printers),
01570             Anyone may use any Dos device,
01571             The creator of a Dos device may delete it.
01572             Note that this protects system-defined LPTs and COMs so that only
01573                 administrators may redirect them.  However, anyone may add
01574                 additional printers and direct them to wherever they would
01575                 like.
01576 
01577            This is achieved with the following protection for the DosDevices
01578            Directory object:
01579 
01580                     Grant:  World:   Execute | Read         (No Inherit)
01581                     Grant:  System:  All Access             (No Inherit)
01582                     Grant:  World:   Execute                (Inherit Only)
01583                     Grant:  Admins:  All Access             (Inherit Only)
01584                     Grant:  System:  All Access             (Inherit Only)
01585                     Grant:  Owner:   All Access             (Inherit Only)
01586 
01587     If this value is 0x0, or not present, then
01588 
01589             Administrators may control all Dos devices,
01590             Anyone may create new Dos devices (such as net drives
01591                 or additional printers),
01592             Anyone may use any Dos device,
01593             Anyone may delete Dos devices created with either DefineDosDevice()
01594                 or IoCreateUnprotectedSymbolicLink().  This is how network drives
01595                 and LPTs are created (but not COMs).
01596 
01597            This is achieved with the following protection for the DosDevices
01598            Directory object:
01599 
01600                     Grant:  World:   Execute | Read | Write (No Inherit)
01601                     Grant:  System:  All Access             (No Inherit)
01602                     Grant:  World:   All Access             (Inherit Only)
01603 
01604 
01605 Arguments:
01606 
01607     SecurityDescriptor - The address of a security descriptor to be
01608         initialized and filled in.  When this security descriptor is no
01609         longer needed, you should call ObpFreeDosDevicesProtection() to
01610         free the protection information.
01611 
01612 
01613 Return Value:
01614 
01615     Returns one of the following status codes:
01616 
01617         STATUS_SUCCESS - normal, successful completion.
01618 
01619         STATUS_NO_MEMORY - not enough memory
01620 
01621 
01622 --*/
01623 
01624 {
01625     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01626     ULONG aceIndex, aclLength;
01627     PACL dacl;
01628     PACE_HEADER ace;
01629     ACCESS_MASK accessMask;
01630 
01631     UCHAR inheritOnlyFlags = (OBJECT_INHERIT_ACE    |
01632                               CONTAINER_INHERIT_ACE |
01633                               INHERIT_ONLY_ACE
01634                              );
01635 
01636     <span class="comment">//</span>
01637     <span class="comment">//  NOTE:  This routine expects the value of ObpProtectionMode to have been set</span>
01638     <span class="comment">//</span>
01639 
01640     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>( SecurityDescriptor, SECURITY_DESCRIPTOR_REVISION );
01641 
01642     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) );
01643 
01644     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a14">ObpProtectionMode</a> &amp; 0x00000001) {
01645 
01646         <span class="comment">//</span>
01647         <span class="comment">//  Dacl:</span>
01648         <span class="comment">//          Grant:  World:   Execute | Read         (No Inherit)</span>
01649         <span class="comment">//          Grant:  System:  All Access             (No Inherit)</span>
01650         <span class="comment">//          Grant:  World:   Execute                (Inherit Only)</span>
01651         <span class="comment">//          Grant:  Admins:  All Access             (Inherit Only)</span>
01652         <span class="comment">//          Grant:  System:  All Access             (Inherit Only)</span>
01653         <span class="comment">//          Grant:  Owner:   All Access             (Inherit Only)</span>
01654         <span class="comment">//</span>
01655 
01656         aclLength = <span class="keyword">sizeof</span>( ACL )                           +
01657                     6 * <span class="keyword">sizeof</span>( ACCESS_ALLOWED_ACE )        +
01658                     (2*<a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>( SeWorldSid ))          +
01659                     (2*<a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>( SeLocalSystemSid ))    +
01660                     <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>( SeAliasAdminsSid )        +
01661                     <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>( SeCreatorOwnerSid );
01662 
01663         dacl = (PACL)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, aclLength );
01664 
01665         <span class="keywordflow">if</span> (dacl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01666 
01667             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01668         }
01669 
01670         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( dacl, aclLength, ACL_REVISION2);
01671         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) );
01672 
01673         <span class="comment">//</span>
01674         <span class="comment">//  Non-inheritable ACEs first</span>
01675         <span class="comment">//      World</span>
01676         <span class="comment">//      System</span>
01677         <span class="comment">//</span>
01678 
01679         aceIndex = 0;
01680         accessMask = (GENERIC_READ | GENERIC_EXECUTE);
01681         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> ( dacl, ACL_REVISION2, accessMask, SeWorldSid );
01682         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) );
01683         aceIndex++;
01684         accessMask = (GENERIC_ALL);
01685         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> ( dacl, ACL_REVISION2, accessMask, SeLocalSystemSid );
01686         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) );
01687 
01688         <span class="comment">//</span>
01689         <span class="comment">//  Inheritable ACEs at the end of the ACL</span>
01690         <span class="comment">//          World</span>
01691         <span class="comment">//          Admins</span>
01692         <span class="comment">//          System</span>
01693         <span class="comment">//          Owner</span>
01694         <span class="comment">//</span>
01695 
01696         aceIndex++;
01697         accessMask = (GENERIC_EXECUTE);
01698         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> ( dacl, ACL_REVISION2, accessMask, SeWorldSid );
01699         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) );
01700         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a>( dacl, aceIndex, (PVOID)&amp;ace );
01701         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) );
01702         ace-&gt;AceFlags |= inheritOnlyFlags;
01703 
01704         aceIndex++;
01705         accessMask = (GENERIC_ALL);
01706         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> ( dacl, ACL_REVISION2, accessMask, SeAliasAdminsSid );
01707         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) );
01708         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a>( dacl, aceIndex, (PVOID)&amp;ace );
01709         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) );
01710         ace-&gt;AceFlags |= inheritOnlyFlags;
01711 
01712         aceIndex++;
01713         accessMask = (GENERIC_ALL);
01714         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> ( dacl, ACL_REVISION2, accessMask, SeLocalSystemSid );
01715         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) );
01716         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a>( dacl, aceIndex, (PVOID)&amp;ace );
01717         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) );
01718         ace-&gt;AceFlags |= inheritOnlyFlags;
01719 
01720         aceIndex++;
01721         accessMask = (GENERIC_ALL);
01722         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> ( dacl, ACL_REVISION2, accessMask, SeCreatorOwnerSid );
01723         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) );
01724         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a>( dacl, aceIndex, (PVOID)&amp;ace );
01725         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) );
01726         ace-&gt;AceFlags |= inheritOnlyFlags;
01727 
01728         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>( SecurityDescriptor,
01729                                                TRUE,               <span class="comment">//DaclPresent,</span>
01730                                                dacl,               <span class="comment">//Dacl</span>
01731                                                FALSE );            
01732 
01733         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) );
01734 
01735     } <span class="keywordflow">else</span> {
01736 
01737         <span class="comment">//</span>
01738         <span class="comment">//  DACL:</span>
01739         <span class="comment">//          Grant:  World:   Execute | Read | Write (No Inherit)</span>
01740         <span class="comment">//          Grant:  System:  All Access             (No Inherit)</span>
01741         <span class="comment">//          Grant:  World:   All Access             (Inherit Only)</span>
01742         <span class="comment">//</span>
01743 
01744         aclLength = <span class="keyword">sizeof</span>( ACL )                           +
01745                     3 * <span class="keyword">sizeof</span>( ACCESS_ALLOWED_ACE )        +
01746                     (2*<a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>( SeWorldSid ))          +
01747                     <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>( SeLocalSystemSid );
01748 
01749         dacl = (PACL)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, aclLength );
01750 
01751         <span class="keywordflow">if</span> (dacl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01752 
01753             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01754         }
01755 
01756         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( dacl, aclLength, ACL_REVISION2);
01757         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) );
01758 
01759         <span class="comment">//</span>
01760         <span class="comment">//  Non-inheritable ACEs first</span>
01761         <span class="comment">//      World</span>
01762         <span class="comment">//      System</span>
01763         <span class="comment">//</span>
01764 
01765         aceIndex = 0;
01766         accessMask = (GENERIC_READ | GENERIC_WRITE | GENERIC_EXECUTE);
01767         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> ( dacl, ACL_REVISION2, accessMask, SeWorldSid );
01768         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) );
01769 
01770         aceIndex++;
01771         accessMask = (GENERIC_ALL);
01772         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> ( dacl, ACL_REVISION2, accessMask, SeLocalSystemSid );
01773         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) );
01774 
01775         <span class="comment">//</span>
01776         <span class="comment">//  Inheritable ACEs at the end of the ACL</span>
01777         <span class="comment">//          World</span>
01778         <span class="comment">//</span>
01779 
01780         aceIndex++;
01781         accessMask = (GENERIC_ALL);
01782         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> ( dacl, ACL_REVISION2, accessMask, SeWorldSid );
01783         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) );
01784         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a>( dacl, aceIndex, (PVOID)&amp;ace );
01785         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) );
01786         ace-&gt;AceFlags |= inheritOnlyFlags;
01787 
01788         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>( SecurityDescriptor,
01789                                                TRUE,               <span class="comment">//DaclPresent,</span>
01790                                                dacl,               <span class="comment">//Dacl</span>
01791                                                FALSE );            
01792 
01793         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) );
01794     }
01795 
01796     <span class="keywordflow">return</span> STATUS_SUCCESS;
01797 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a6" doxytag="obinit.c::ObpAuditBaseDirectories" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d0/d1/obinit_8c.html#a6">ObpAuditBaseDirectories</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/obinit_8c-source.html#l00103">103</a> of file <a class="el" href="../../d1/d0/obinit_8c-source.html">obinit.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="obinit.c::ObpAuditBaseObjects" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d0/d1/obinit_8c.html#a7">ObpAuditBaseObjects</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/obinit_8c-source.html#l00104">104</a> of file <a class="el" href="../../d1/d0/obinit_8c-source.html">obinit.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="obinit.c::ObpDirectoryMapping" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> GENERIC_MAPPING <a class="el" href="../../d0/d1/obinit_8c.html#a1">ObpDirectoryMapping</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div> {
    STANDARD_RIGHTS_READ |
        DIRECTORY_QUERY |
        DIRECTORY_TRAVERSE,
    STANDARD_RIGHTS_WRITE |
        DIRECTORY_CREATE_OBJECT |
        DIRECTORY_CREATE_SUBDIRECTORY,
    STANDARD_RIGHTS_EXECUTE |
        DIRECTORY_QUERY |
        DIRECTORY_TRAVERSE,
    DIRECTORY_ALL_ACCESS
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d0/obinit_8c-source.html#l00034">34</a> of file <a class="el" href="../../d1/d0/obinit_8c-source.html">obinit.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="obinit.c::ObpDosDevicesShortName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UNICODE_STRING <a class="el" href="../../d5/d1/obp_8h.html#a49">ObpDosDevicesShortName</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/obinit_8c-source.html#l00110">110</a> of file <a class="el" href="../../d1/d0/obinit_8c-source.html">obinit.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/obinit_8c-source.html#l01349">ObpCreateDosDevicesDirectory()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l01081">ObpLookupObjectName()</a>, and <a class="el" href="../../d5/d0/oblink_8c-source.html#l01121">ObpProcessDosDeviceSymbolicLink()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="obinit.c::ObpDosDevicesShortNamePrefix" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULARGE_INTEGER <a class="el" href="../../d5/d1/obp_8h.html#a47">ObpDosDevicesShortNamePrefix</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/obinit_8c-source.html#l00111">111</a> of file <a class="el" href="../../d1/d0/obinit_8c-source.html">obinit.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/obinit_8c-source.html#l01349">ObpCreateDosDevicesDirectory()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l01081">ObpLookupObjectName()</a>, and <a class="el" href="../../d5/d0/oblink_8c-source.html#l01121">ObpProcessDosDeviceSymbolicLink()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="obinit.c::ObpDosDevicesShortNameRoot" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULARGE_INTEGER <a class="el" href="../../d5/d1/obp_8h.html#a48">ObpDosDevicesShortNameRoot</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/obinit_8c-source.html#l00112">112</a> of file <a class="el" href="../../d1/d0/obinit_8c-source.html">obinit.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/obinit_8c-source.html#l01349">ObpCreateDosDevicesDirectory()</a>, and <a class="el" href="../../d9/d9/obdir_8c-source.html#l01081">ObpLookupObjectName()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="obinit.c::ObpInitKillMutant" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d7/struct__KMUTANT.html">KMUTANT</a> <a class="el" href="../../d9/d1/psquery_8c.html#a3">ObpInitKillMutant</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/obinit_8c-source.html#l00095">95</a> of file <a class="el" href="../../d1/d0/obinit_8c-source.html">obinit.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="obinit.c::ObpProtectionMode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d0/d1/obinit_8c.html#a5">ObpProtectionMode</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/obinit_8c-source.html#l00102">102</a> of file <a class="el" href="../../d1/d0/obinit_8c-source.html">obinit.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/obinit_8c-source.html#l01545">ObpGetDosDevicesProtection()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="obinit.c::ObpSymbolicLinkMapping" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> GENERIC_MAPPING <a class="el" href="../../d0/d1/obinit_8c.html#a2">ObpSymbolicLinkMapping</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div> {
    STANDARD_RIGHTS_READ |
        SYMBOLIC_LINK_QUERY,
    STANDARD_RIGHTS_WRITE,
    STANDARD_RIGHTS_EXECUTE |
        SYMBOLIC_LINK_QUERY,
    SYMBOLIC_LINK_ALL_ACCESS
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d0/obinit_8c-source.html#l00047">47</a> of file <a class="el" href="../../d1/d0/obinit_8c-source.html">obinit.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="obinit.c::ObpTypeMapping" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> GENERIC_MAPPING <a class="el" href="../../d0/d1/obinit_8c.html#a0">ObpTypeMapping</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div> {
    STANDARD_RIGHTS_READ,
    STANDARD_RIGHTS_WRITE,
    STANDARD_RIGHTS_EXECUTE,
    OBJECT_TYPE_ALL_ACCESS
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d0/obinit_8c-source.html#l00027">27</a> of file <a class="el" href="../../d1/d0/obinit_8c-source.html">obinit.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="obinit.c::ObSystemDeviceMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d4/struct__DEVICE__MAP.html">PDEVICE_MAP</a> <a class="el" href="../../d0/d1/obinit_8c.html#a11">ObSystemDeviceMap</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/obinit_8c-source.html#l00113">113</a> of file <a class="el" href="../../d1/d0/obinit_8c-source.html">obinit.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/obdevmap_8c-source.html#l00343">ObInheritDeviceMap()</a>, <a class="el" href="../../d8/d9/obdevmap_8c-source.html#l00236">ObQueryDeviceMapInformation()</a>, and <a class="el" href="../../d8/d9/obdevmap_8c-source.html#l00030">ObSetDeviceMap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="obinit.c::PspDefaultQuotaBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html">EPROCESS_QUOTA_BLOCK</a> <a class="el" href="../../d8/d1/psp_8h.html#a37">PspDefaultQuotaBlock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/obinit_8c-source.html#l00088">88</a> of file <a class="el" href="../../d1/d0/obinit_8c-source.html">obinit.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:58 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
