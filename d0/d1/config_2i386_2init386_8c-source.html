<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: init386.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>init386.c</h1><a href="../../d9/d1/config_2i386_2init386_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990, 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment"></span>
00006 <span class="comment">Module Name:</span>
00007 <span class="comment"></span>
00008 <span class="comment">    init386.c</span>
00009 <span class="comment"></span>
00010 <span class="comment">Abstract:</span>
00011 <span class="comment"></span>
00012 <span class="comment">    This module is responsible to build any x86 specific entries in</span>
00013 <span class="comment">    the hardware tree of registry.</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Ken Reneris (kenr) 04-Aug-1992</span>
00018 <span class="comment"></span>
00019 <span class="comment"></span>
00020 <span class="comment">Environment:</span>
00021 <span class="comment"></span>
00022 <span class="comment">    Kernel mode.</span>
00023 <span class="comment"></span>
00024 <span class="comment">Revision History:</span>
00025 <span class="comment"></span>
00026 <span class="comment">    shielint - add BIOS date and version detection.</span>
00027 <span class="comment"></span>
00028 <span class="comment">--*/</span>
00029 
00030 <span class="preprocessor">#include "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00031 <span class="preprocessor">#include "stdio.h"</span>
00032 
00033 <span class="preprocessor">#ifdef _WANT_MACHINE_IDENTIFICATION</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#include "string.h"</span>
00035 <span class="preprocessor">#include "stdlib.h"</span>
00036 <span class="preprocessor">#include "ntverp.h"</span>
00037 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/rules_8h.html">rules.h</a>"</span>
00038 <span class="preprocessor">#endif</span>
00039 <span class="preprocessor"></span>
00040 <span class="comment">//</span>
00041 <span class="comment">// Title Index is set to 0.</span>
00042 <span class="comment">// (from ..\cmconfig.c)</span>
00043 <span class="comment">//</span>
00044 
<a name="l00045"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a0">00045</a> <span class="preprocessor">#define TITLE_INDEX_VALUE 0</span>
00046 <span class="preprocessor"></span>
<a name="l00047"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a16">00047</a> <span class="keyword">extern</span> PCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a16">SearchStrings</a>[];
<a name="l00048"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a17">00048</a> <span class="keyword">extern</span> PCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a17">BiosBegin</a>;
<a name="l00049"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">00049</a> <span class="keyword">extern</span> PCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
<a name="l00050"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">00050</a> <span class="keyword">extern</span> PCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
<a name="l00051"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a20">00051</a> <span class="keyword">extern</span> UCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a20">CmpID1</a>[];
<a name="l00052"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a21">00052</a> <span class="keyword">extern</span> UCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a21">CmpID2</a>[];
<a name="l00053"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a22">00053</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a22">CmpVendorID</a>[];
<a name="l00054"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a23">00054</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a23">CmpProcessorNameString</a>[];
<a name="l00055"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a24">00055</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a24">CmpFeatureBits</a>[];
<a name="l00056"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a25">00056</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a25">CmpMHz</a>[];
<a name="l00057"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a26">00057</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a26">CmpUpdateSignature</a>[];
<a name="l00058"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a27">00058</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a27">CmPhysicalAddressExtension</a>[];
<a name="l00059"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a28">00059</a> <span class="keyword">extern</span> UCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a28">CmpCyrixID</a>[];
<a name="l00060"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a29">00060</a> <span class="keyword">extern</span> UCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a29">CmpIntelID</a>[];
<a name="l00061"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a30">00061</a> <span class="keyword">extern</span> UCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a30">CmpAmdID</a>[];
00062 
00063 <span class="comment">//</span>
00064 <span class="comment">// Bios date and version definitions</span>
00065 <span class="comment">//</span>
00066 
<a name="l00067"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a1">00067</a> <span class="preprocessor">#define BIOS_DATE_LENGTH 11</span>
<a name="l00068"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a2">00068</a> <span class="preprocessor"></span><span class="preprocessor">#define MAXIMUM_BIOS_VERSION_LENGTH 128</span>
<a name="l00069"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a3">00069</a> <span class="preprocessor"></span><span class="preprocessor">#define SYSTEM_BIOS_START 0xF0000</span>
<a name="l00070"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a4">00070</a> <span class="preprocessor"></span><span class="preprocessor">#define SYSTEM_BIOS_LENGTH 0x10000</span>
<a name="l00071"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a5">00071</a> <span class="preprocessor"></span><span class="preprocessor">#define INT10_VECTOR 0x10</span>
<a name="l00072"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a6">00072</a> <span class="preprocessor"></span><span class="preprocessor">#define VIDEO_BIOS_START 0xC0000</span>
<a name="l00073"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a7">00073</a> <span class="preprocessor"></span><span class="preprocessor">#define VIDEO_BIOS_LENGTH 0x8000</span>
<a name="l00074"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a8">00074</a> <span class="preprocessor"></span><span class="preprocessor">#define VERSION_DATA_LENGTH PAGE_SIZE</span>
00075 <span class="preprocessor"></span>
00076 <span class="comment">//</span>
00077 <span class="comment">// Extended CPUID function definitions</span>
00078 <span class="comment">//</span>
00079 
<a name="l00080"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a9">00080</a> <span class="preprocessor">#define CPUID_PROCESSOR_NAME_STRING_SZ  49</span>
<a name="l00081"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a10">00081</a> <span class="preprocessor"></span><span class="preprocessor">#define CPUID_EXTFN_BASE                0x80000000</span>
<a name="l00082"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a11">00082</a> <span class="preprocessor"></span><span class="preprocessor">#define CPUID_EXTFN_PROCESSOR_NAME      0x80000002</span>
00083 <span class="preprocessor"></span>
00084 <span class="comment">//</span>
00085 <span class="comment">// CPU Stepping mismatch.</span>
00086 <span class="comment">//</span>
00087 
<a name="l00088"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a31">00088</a> UCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a31">CmProcessorMismatch</a>;
00089 
<a name="l00090"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a12">00090</a> <span class="preprocessor">#define CM_PROCESSOR_MISMATCH_VENDOR    0x01</span>
<a name="l00091"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a13">00091</a> <span class="preprocessor"></span><span class="preprocessor">#define CM_PROCESSOR_MISMATCH_STEPPING  0x02</span>
<a name="l00092"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a14">00092</a> <span class="preprocessor"></span><span class="preprocessor">#define CM_PROCESSOR_MISMATCH_L2        0x04</span>
00093 <span class="preprocessor"></span>
00094 
<a name="l00095"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a32">00095</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a9">CmpConfigurationAreaSize</a>;
<a name="l00096"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a33">00096</a> <span class="keyword">extern</span> PCM_FULL_RESOURCE_DESCRIPTOR <a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a>;
00097 
00098 
00099 BOOLEAN
00100 <a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a28">CmpGetBiosVersion</a> (
00101     PCHAR SearchArea,
00102     ULONG SearchLength,
00103     PCHAR VersionString
00104     );
00105 
00106 BOOLEAN
00107 <a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a29">CmpGetBiosDate</a> (
00108     PCHAR SearchArea,
00109     ULONG SearchLength,
00110     PCHAR DateString,
00111     BOOLEAN SystemBiosDate
00112     );
00113 
00114 ULONG
00115 <a class="code" href="../../d9/d1/cyrix_8c.html#a24">Ke386CyrixId</a> (
00116     VOID
00117     );
00118 
00119 <span class="preprocessor">#ifdef _WANT_MACHINE_IDENTIFICATION</span>
00120 <span class="preprocessor"></span>
00121 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00122 CmpPerformMachineIdentification(
00123     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
00124     );
00125 
00126 <span class="preprocessor">#endif    </span>
00127 <span class="preprocessor"></span>
00128 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00129 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpGetBiosDate)</span>
00130 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpGetBiosVersion)</span>
00131 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpInitializeMachineDependentConfiguration)</span>
00132 <span class="preprocessor"></span>
00133 <span class="preprocessor">#ifdef _WANT_MACHINE_IDENTIFICATION</span>
00134 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpPerformMachineIdentification)</span>
00135 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00136 <span class="preprocessor"></span>
00137 <span class="preprocessor">#endif</span>
00138 <span class="preprocessor"></span>
00139 
00140 BOOLEAN
<a name="l00141"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a35">00141</a> <a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a29">CmpGetBiosDate</a> (
00142     PCHAR SearchArea,
00143     ULONG SearchLength,
00144     PCHAR DateString,
00145     BOOLEAN SystemBiosDate
00146     )
00147 
00148 <span class="comment">/*++</span>
00149 <span class="comment"></span>
00150 <span class="comment">Routine Description:</span>
00151 <span class="comment"></span>
00152 <span class="comment">    This routine finds the most recent date in the computer/video</span>
00153 <span class="comment">    card's ROM.  When GetRomDate encounters a datae, it checks the</span>
00154 <span class="comment">    previously found date to see if the new date is more recent.</span>
00155 <span class="comment"></span>
00156 <span class="comment">Arguments:</span>
00157 <span class="comment"></span>
00158 <span class="comment">    SearchArea - the area to search for a date.</span>
00159 <span class="comment"></span>
00160 <span class="comment">    SearchLength - Length of search.</span>
00161 <span class="comment"></span>
00162 <span class="comment">    DateString - Supplies a pointer to a fixed length memory to receive</span>
00163 <span class="comment">                 the date string.</span>
00164 <span class="comment"></span>
00165 <span class="comment">Return Value:</span>
00166 <span class="comment"></span>
00167 <span class="comment">    NT_SUCCESS if a date is found.</span>
00168 <span class="comment"></span>
00169 <span class="comment">--*/</span>
00170 
00171 {
00172     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>    prevDate[<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a1">BIOS_DATE_LENGTH</a>]; <span class="comment">// Newest date found so far (CCYY/MM/DD)</span>
00173     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>    currDate[<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a1">BIOS_DATE_LENGTH</a>]; <span class="comment">// Date currently being examined (CCYY/MM/DD)</span>
00174     PCHAR   start;                      <span class="comment">// Start of the current search area.</span>
00175     PCHAR   end;                        <span class="comment">// End of the search area.    </span>
00176     ULONG   year;                       <span class="comment">// YY</span>
00177     ULONG   month;                      <span class="comment">// MM</span>
00178     ULONG   day;                        <span class="comment">// DD</span>
00179     ULONG   count;
00180 
00181 <span class="preprocessor">#define IS_DIGIT(c) ((c) &gt;= '0' &amp;&amp; (c) &lt;= '9')</span>
00182 <span class="preprocessor"></span>
00183     <span class="comment">//</span>
00184     <span class="comment">// Initialize previous date</span>
00185     <span class="comment">//</span>
00186 
00187     RtlZeroMemory(prevDate, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a1">BIOS_DATE_LENGTH</a>);
00188 
00189     <span class="comment">//</span>
00190     <span class="comment">// We need to look ahead 5 characters to determine the </span>
00191     <span class="comment">// validity of the date pattern.</span>
00192     <span class="comment">//</span>
00193 
00194     start = SearchArea + 2;
00195     end = SearchArea + SearchLength - 5;
00196 
00197     <span class="comment">//</span>
00198     <span class="comment">// Process the entire search area.</span>
00199     <span class="comment">//</span>
00200     
00201     <span class="keywordflow">while</span> (start &lt; end) {
00202         
00203         <span class="comment">//</span>
00204         <span class="comment">// We consider the following byte pattern as a potential date.</span>
00205         <span class="comment">// We are assuming the following date pattern Month/Day/Year.</span>
00206         <span class="comment">// "n/nn/nn" where n is any digit. We allow month to be single</span>
00207         <span class="comment">// digit only.</span>
00208         <span class="comment">//</span>
00209 
00210         <span class="keywordflow">if</span> (    start[0] == <span class="charliteral">'/'</span> &amp;&amp; start[3] == <span class="charliteral">'/'</span> &amp;&amp;
00211                 <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a15">IS_DIGIT</a>(*(start - 1)) &amp;&amp;
00212                 <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a15">IS_DIGIT</a>(start[1]) &amp;&amp; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a15">IS_DIGIT</a>(start[2]) &amp;&amp;    
00213                 <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a15">IS_DIGIT</a>(start[4]) &amp;&amp; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a15">IS_DIGIT</a>(start[5])) {
00214             
00215             <span class="comment">//</span>
00216             <span class="comment">// Copy MM/DD part into the currDate.</span>
00217             <span class="comment">//</span>
00218 
00219             RtlMoveMemory(&amp;currDate[5], start - 2, 5);
00220 
00221             <span class="comment">//</span>
00222             <span class="comment">// Handle single digit month correctly.</span>
00223             <span class="comment">//</span>
00224 
00225             <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a15">IS_DIGIT</a>(currDate[5])) {
00226                 currDate[5] = <span class="charliteral">'0'</span>;
00227             }
00228             
00229             <span class="comment">//</span>
00230             <span class="comment">// Copy the year YY into currDate</span>
00231             <span class="comment">//</span>
00232 
00233             currDate[2] = start[4];
00234             currDate[3] = start[5];
00235             currDate[4] = currDate[7] = currDate[10] = <span class="charliteral">'\0'</span>;
00236 
00237             <span class="comment">//</span>
00238             <span class="comment">// Do basic validation for the date.</span>
00239             <span class="comment">// Only one field (YY) can be 0.</span>
00240             <span class="comment">// Only one field (YY) can be greater than 31.</span>
00241             <span class="comment">// We assume the ROM date to be in the format MM/DD/YY.        </span>
00242             <span class="comment">//</span>
00243 
00244             year = strtoul(&amp;currDate[2], <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16);
00245             month = strtoul(&amp;currDate[5], <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16);
00246             day = strtoul(&amp;currDate[8], <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16);
00247 
00248             <span class="comment">//</span>
00249             <span class="comment">// Count the number of fields that are 0.</span>
00250             <span class="comment">//</span>
00251 
00252             count = ((day == 0)? 1 : 0) + ((month == 0)? 1 : 0) + ((year == 0)? 1 : 0);
00253             <span class="keywordflow">if</span> (count &lt;= 1) {
00254 
00255                 <span class="comment">//</span>
00256                 <span class="comment">// Count number of field that are greater than 31.</span>
00257                 <span class="comment">//</span>
00258 
00259                 count = ((day &gt; 0x31)? 1 : 0) + ((month &gt; 0x31)? 1 : 0) + ((year &gt; 0x31)? 1 : 0);
00260                 <span class="keywordflow">if</span> (count &lt;= 1) {
00261 
00262                     <span class="comment">//</span>
00263                     <span class="comment">// See if the ROM already has a 4 digit date. We do this only for System ROM</span>
00264                     <span class="comment">// since they have a consistent date format.</span>
00265                     <span class="comment">//</span>
00266 
00267                     <span class="keywordflow">if</span> (SystemBiosDate &amp;&amp; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a15">IS_DIGIT</a>(start[6]) &amp;&amp; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a15">IS_DIGIT</a>(start[7]) &amp;&amp;
00268                         (memcmp(&amp;start[4], <span class="stringliteral">"19"</span>, 2) == 0 || memcmp(&amp;start[4], <span class="stringliteral">"20"</span>, 2) == 0)) {
00269 
00270                         currDate[0] = start[4];
00271                         currDate[1] = start[5];
00272                         currDate[2] = start[6];
00273                         currDate[3] = start[7];
00274 
00275                     } <span class="keywordflow">else</span> {
00276                         
00277                         <span class="comment">//</span>
00278                         <span class="comment">// Internally, we treat year as a 4 digit quantity</span>
00279                         <span class="comment">// for comparison to determine the newest date.</span>
00280                         <span class="comment">// We treat year YY &lt; 80 as 20YY, otherwise 19YY.                </span>
00281                         <span class="comment">//</span>
00282 
00283                         <span class="keywordflow">if</span> (year &lt; 0x80) {
00284                             currDate[0] = <span class="charliteral">'2'</span>;
00285                             currDate[1] = <span class="charliteral">'0'</span>;
00286                         } <span class="keywordflow">else</span> {
00287                             currDate[0] = <span class="charliteral">'1'</span>;
00288                             currDate[1] = <span class="charliteral">'9'</span>;
00289                         }
00290                     }
00291 
00292                     <span class="comment">//</span>
00293                     <span class="comment">// Add the '/' delimiters into the date.</span>
00294                     <span class="comment">//</span>
00295 
00296                     currDate[4] = currDate[7] = <span class="charliteral">'/'</span>;
00297 
00298                     <span class="comment">//</span>
00299                     <span class="comment">// Compare the dates, and save the newer one.</span>
00300                     <span class="comment">//</span>
00301 
00302                     <span class="keywordflow">if</span> (memcmp (prevDate, currDate, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a1">BIOS_DATE_LENGTH</a> - 1) &lt; 0) {
00303                         RtlMoveMemory(prevDate, currDate, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a1">BIOS_DATE_LENGTH</a> - 1);
00304                     }
00305 
00306                     <span class="comment">//</span>
00307                     <span class="comment">// Next search should start at the second '/'.</span>
00308                     <span class="comment">//</span>
00309 
00310                     start += 2;            
00311                 }
00312             }
00313         }
00314         start++;
00315     }
00316 
00317     <span class="keywordflow">if</span> (prevDate[0] != <span class="charliteral">'\0'</span>) {
00318 
00319         <span class="comment">//</span>
00320         <span class="comment">// Convert from the internal CCYY/MM/DD format to</span>
00321         <span class="comment">// return MM/DD//YY format.</span>
00322         <span class="comment">//</span>
00323 
00324         RtlMoveMemory(DateString, &amp;prevDate[5], 5);
00325         DateString[5] = <span class="charliteral">'/'</span>;
00326         DateString[6] = prevDate[2];
00327         DateString[7] = prevDate[3];
00328         DateString[8] = <span class="charliteral">'\0'</span>;
00329 
00330         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00331     }
00332     
00333     <span class="comment">//</span>
00334     <span class="comment">// If we did not find a date, return an empty string.</span>
00335     <span class="comment">//</span>
00336 
00337     DateString[0] = <span class="charliteral">'\0'</span>;
00338     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00339 }
00340 
00341 BOOLEAN
<a name="l00342"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a34">00342</a> <a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a28">CmpGetBiosVersion</a> (
00343     PCHAR SearchArea,
00344     ULONG SearchLength,
00345     PCHAR VersionString
00346     )
00347 
00348 <span class="comment">/*++</span>
00349 <span class="comment"></span>
00350 <span class="comment">Routine Description:</span>
00351 <span class="comment"></span>
00352 <span class="comment">    This routine finds the version number stored in ROM, if any.</span>
00353 <span class="comment"></span>
00354 <span class="comment">Arguments:</span>
00355 <span class="comment"></span>
00356 <span class="comment">    SearchArea - the area to search for the version.</span>
00357 <span class="comment"></span>
00358 <span class="comment">    SearchLength - Length of search</span>
00359 <span class="comment"></span>
00360 <span class="comment">    VersionString - Supplies a pointer to a fixed length memory to receive</span>
00361 <span class="comment">                 the version string.</span>
00362 <span class="comment"></span>
00363 <span class="comment">Return Value:</span>
00364 <span class="comment"></span>
00365 <span class="comment">    TRUE if a version number is found.  Else a value of FALSE is returned.</span>
00366 <span class="comment"></span>
00367 <span class="comment">--*/</span>
00368 {
00369     PCHAR <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>;
00370     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Length;
00371     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> i;
00372     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a2">MAXIMUM_BIOS_VERSION_LENGTH</a>];
00373     PCHAR BufferPointer;
00374 
00375         <span class="keywordflow">if</span> (SearchArea != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00376 
00377         <span class="comment">//</span>
00378         <span class="comment">// If caller does not specify the search area, we will search</span>
00379         <span class="comment">// the area left from previous search.</span>
00380         <span class="comment">//</span>
00381 
00382         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a17">BiosBegin</a> = SearchArea;
00383         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> = SearchArea + 1;
00384         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = SearchArea + SearchLength - 2;
00385     }
00386 
00387     <span class="keywordflow">while</span> (1) {
00388 
00389          <span class="comment">//</span>
00390          <span class="comment">// Search for a period with a digit on either side</span>
00391          <span class="comment">//</span>
00392 
00393          <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00394          <span class="keywordflow">while</span> (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> &lt;= <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>) {
00395              <span class="keywordflow">if</span> (*<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> == <span class="charliteral">'.'</span> &amp;&amp; *(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>+1) &gt;= <span class="charliteral">'0'</span> &amp;&amp; *(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>+1) &lt;= <span class="charliteral">'9'</span> &amp;&amp;
00396                  *(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>-1) &gt;= <span class="charliteral">'0'</span> &amp;&amp; *(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>-1) &lt;= <span class="charliteral">'9'</span>) {
00397                  <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
00398                  <span class="keywordflow">break</span>;
00399              } <span class="keywordflow">else</span> {
00400                  <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>++;
00401              }
00402          }
00403 
00404          <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> &gt; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>) {
00405              <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00406          } <span class="keywordflow">else</span> {
00407              <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> += 2;
00408          }
00409 
00410          Length = 0;
00411          <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a2">MAXIMUM_BIOS_VERSION_LENGTH</a> - 1] = <span class="charliteral">'\0'</span>;
00412          BufferPointer = &amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a2">MAXIMUM_BIOS_VERSION_LENGTH</a> - 1];
00413 
00414          <span class="comment">//</span>
00415          <span class="comment">// Search for the beginning of the string</span>
00416          <span class="comment">//</span>
00417 
00418          <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>--;
00419          <span class="keywordflow">while</span> (Length &lt; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a2">MAXIMUM_BIOS_VERSION_LENGTH</a> - 8 &amp;&amp;
00420                 <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> &gt;= <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a17">BiosBegin</a> &amp;&amp;
00421                 *<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> &gt;= <span class="charliteral">' '</span> &amp;&amp; *<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> &lt;= 127 &amp;&amp;
00422                 *<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> != <span class="charliteral">'$'</span>) {
00423              --BufferPointer;
00424              *BufferPointer = *<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>;
00425              --<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>, ++Length;
00426          }
00427          ++<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>;
00428 
00429          <span class="comment">//</span>
00430          <span class="comment">// Can one of the search strings be found</span>
00431          <span class="comment">//</span>
00432 
00433          <span class="keywordflow">for</span> (i = 0; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a16">SearchStrings</a>[i]; i++) {
00434              <span class="keywordflow">if</span> (strstr(BufferPointer, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a16">SearchStrings</a>[i])) {
00435                  <span class="keywordflow">goto</span> Found;
00436              }
00437          }
00438     }
00439 
00440 Found:
00441 
00442     <span class="comment">//</span>
00443     <span class="comment">// Skip leading white space</span>
00444     <span class="comment">//</span>
00445 
00446     <span class="keywordflow">for</span> (; *<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> == <span class="charliteral">' '</span>; ++<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>)
00447       ;
00448 
00449     <span class="comment">//</span>
00450     <span class="comment">// Copy the string to user supplied buffer</span>
00451     <span class="comment">//</span>
00452 
00453     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a2">MAXIMUM_BIOS_VERSION_LENGTH</a> - 1 &amp;&amp;
00454          <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> &lt;= (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> + 1) &amp;&amp;
00455          *<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> &gt;= <span class="charliteral">' '</span> &amp;&amp; *<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> &lt;= 127 &amp;&amp; *<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> != <span class="charliteral">'$'</span>;
00456          ++i, ++<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>) {
00457          VersionString[i] = *<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>;
00458     }
00459     VersionString[i] = <span class="charliteral">'\0'</span>;
00460     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00461 }
00462 
00463 
00464 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00465"></a><a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a37">00465</a> <a class="code" href="../../d6/d1/config_2ppc_2init_8c.html#a0">CmpInitializeMachineDependentConfiguration</a>(
00466     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
00467     )
00468 <span class="comment">/*++</span>
00469 <span class="comment"></span>
00470 <span class="comment">Routine Description:</span>
00471 <span class="comment"></span>
00472 <span class="comment">    This routine creates x86 specific entries in the registry.</span>
00473 <span class="comment"></span>
00474 <span class="comment">Arguments:</span>
00475 <span class="comment"></span>
00476 <span class="comment">    LoaderBlock - supplies a pointer to the LoaderBlock passed in from the</span>
00477 <span class="comment">                  OS Loader.</span>
00478 <span class="comment"></span>
00479 <span class="comment">Returns:</span>
00480 <span class="comment"></span>
00481 <span class="comment">    NTSTATUS code for sucess or reason of failure.</span>
00482 <span class="comment"></span>
00483 <span class="comment">--*/</span>
00484 {
00485     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00486     ULONG VideoBiosStart;
00487     UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
00488     UNICODE_STRING <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
00489     UNICODE_STRING ValueData;
00490     ANSI_STRING AnsiString;
00491     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00492     ULONG Disposition;
00493     HANDLE ParentHandle;
00494     HANDLE BaseHandle, NpxHandle;
00495     HANDLE CurrentControlSet;
00496     <a class="code" href="../../d5/d8/struct__CONFIGURATION__COMPONENT__DATA.html">CONFIGURATION_COMPONENT_DATA</a> CurrentEntry;
00497     PUCHAR VendorID;
00498     UCHAR  <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a2">MAXIMUM_BIOS_VERSION_LENGTH</a>];
00499     PKPRCB Prcb;
00500     ULONG  i, Junk;
00501     ULONG VersionsLength = 0, Length;
00502     PCHAR VersionStrings, VersionPointer;
00503     UNICODE_STRING SectionName;
00504     ULONG ViewSize;
00505     LARGE_INTEGER ViewBase;
00506     PVOID BaseAddress;
00507     HANDLE SectionHandle;
00508     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> DeviceIndexTable[<a class="code" href="../../d1/d2/cmp_8h.html#a68">NUMBER_TYPES</a>];
00509     ULONG CpuIdFunction;
00510     ULONG MaxExtFn;
00511     PULONG NameString = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00512     ULONG   P0L2Size = 0;
00513     ULONG   ThisProcessorL2Size;
00514     <span class="keyword">struct </span>{
00515         <span class="keyword">union </span>{
00516             UCHAR   Bytes[<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a9">CPUID_PROCESSOR_NAME_STRING_SZ</a>];
00517             ULONG   DWords[1];
00518         } u;
00519     } ProcessorNameString;
00520 
00521 <span class="preprocessor">#ifdef _WANT_MACHINE_IDENTIFICATION</span>
00522 <span class="preprocessor"></span>    HANDLE  BiosInfo;
00523 <span class="preprocessor">#endif    </span>
00524 <span class="preprocessor"></span>
00525     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d1/d2/cmp_8h.html#a68">NUMBER_TYPES</a>; i++) {
00526         DeviceIndexTable[i] = 0;
00527     }
00528 
00529     InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00530                                 &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a29">CmRegistryMachineSystemCurrentControlSetControlSessionManagerMemoryManagement</a>,
00531                                 OBJ_CASE_INSENSITIVE,
00532                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00533                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00534                                );
00535 
00536     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( &amp;BaseHandle,
00537                         KEY_READ | KEY_WRITE,
00538                         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>
00539                       );
00540 
00541     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00542 
00543         ULONG paeEnabled;
00544 
00545         <span class="keywordflow">if</span> (SharedUserData-&gt;ProcessorFeatures[PF_PAE_ENABLED] == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00546             paeEnabled = 0;
00547         } <span class="keywordflow">else</span> {
00548             paeEnabled = 1;
00549         }
00550 
00551         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00552                               <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a27">CmPhysicalAddressExtension</a> );
00553 
00554            
00555         <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>( BaseHandle,
00556                        &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00557                        <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00558                        REG_DWORD,
00559                        &amp;paeEnabled,
00560                        <span class="keyword">sizeof</span>(paeEnabled) );
00561 
00562         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( BaseHandle );
00563    }
00564 
00565             
00566 
00567 
00568 
00569     InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00570                                 &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a17">CmRegistryMachineHardwareDescriptionSystemName</a>,
00571                                 OBJ_CASE_INSENSITIVE,
00572                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00573                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00574                               );
00575 
00576     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( &amp;ParentHandle,
00577                         KEY_READ,
00578                         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>
00579                       );
00580 
00581     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00582         <span class="comment">// Something is really wrong...</span>
00583         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00584     }
00585 
00586 <span class="preprocessor">#ifdef _WANT_MACHINE_IDENTIFICATION</span>
00587 <span class="preprocessor"></span>
00588     InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00589                                 &amp;CmRegistryMachineSystemCurrentControlSetControlBiosInfo,
00590                                 OBJ_CASE_INSENSITIVE,
00591                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00592                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00593                               );
00594 
00595     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(   &amp;BiosInfo,
00596                             KEY_ALL_ACCESS,
00597                             &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00598                             0,
00599                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00600                             REG_OPTION_NON_VOLATILE,
00601                             &amp;Disposition
00602                         );
00603 
00604     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {    
00605         <span class="comment">// Something is really wrong...</span>
00606         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00607     }
00608 
00609 <span class="preprocessor">#endif</span>
00610 <span class="preprocessor"></span>
00611     <span class="comment">//</span>
00612     <span class="comment">// On an ARC machine the processor(s) are included in the hardware</span>
00613     <span class="comment">// configuration passed in from bootup.  Since there's no standard</span>
00614     <span class="comment">// way to get all the ARC information for each processor in an MP</span>
00615     <span class="comment">// machine via pc-ROMs the information will be added here (if it's</span>
00616     <span class="comment">// not already present).</span>
00617     <span class="comment">//</span>
00618 
00619     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,
00620                           <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CentralProcessor"</span>
00621                         );
00622 
00623     InitializeObjectAttributes(
00624         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00625         &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,
00626         0,
00627         ParentHandle,
00628         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00629         );
00630 
00631     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.Attributes |= OBJ_CASE_INSENSITIVE;
00632 
00633     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(
00634                 &amp;BaseHandle,
00635                 KEY_READ | KEY_WRITE,
00636                 &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00637                 <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00638                 &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a1">CmClassName</a>[<a class="code" href="../../d1/d9/arc_8h.html#a314a180">ProcessorClass</a>],
00639                 0,
00640                 &amp;Disposition
00641                 );
00642 
00643     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (BaseHandle);
00644 
00645     <span class="keywordflow">if</span> (Disposition == REG_CREATED_NEW_KEY) {
00646 
00647         <span class="comment">//</span>
00648         <span class="comment">// The ARC rom didn't add the processor(s) into the registry.</span>
00649         <span class="comment">// Do it now.</span>
00650         <span class="comment">//</span>
00651 
00652         <a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a> = (PCM_FULL_RESOURCE_DESCRIPTOR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
00653                                             <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00654                                             <a class="code" href="../../d4/d0/cmconfig_8c.html#a9">CmpConfigurationAreaSize</a>
00655                                             );
00656 
00657         <span class="comment">//</span>
00658         <span class="comment">// if (CmpConfigurationData == 0) {</span>
00659         <span class="comment">//     &lt;do something useful&gt;</span>
00660         <span class="comment">//     Note: we don't actually use it so it doesn't matter for now</span>
00661         <span class="comment">//     since it isn't used until the free.  go figure.</span>
00662         <span class="comment">// }</span>
00663         <span class="comment">//</span>
00664 
00665         <span class="keywordflow">for</span> (i=0; i &lt; (ULONG)<a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>; i++) {
00666             Prcb = <a class="code" href="../../d4/d9/ke_8h.html#a139">KiProcessorBlock</a>[i];
00667 
00668             RtlZeroMemory (&amp;CurrentEntry, <span class="keyword">sizeof</span> CurrentEntry);
00669             CurrentEntry.ComponentEntry.Class = <a class="code" href="../../d1/d9/arc_8h.html#a314a180">ProcessorClass</a>;
00670             CurrentEntry.ComponentEntry.Type = <a class="code" href="../../d1/d9/arc_8h.html#a315a188">CentralProcessor</a>;
00671             CurrentEntry.ComponentEntry.Key = i;
00672             CurrentEntry.ComponentEntry.AffinityMask = 1 &lt;&lt; i;
00673 
00674             CurrentEntry.ComponentEntry.Identifier = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00675             <span class="keywordflow">if</span> (Prcb-&gt;CpuID == 0) {
00676 
00677                 <span class="comment">//</span>
00678                 <span class="comment">// Old style stepping format</span>
00679                 <span class="comment">//</span>
00680 
00681                 <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a20">CmpID1</a>,
00682                     Prcb-&gt;CpuType,
00683                     (Prcb-&gt;CpuStep &gt;&gt; 8) + <span class="charliteral">'A'</span>,
00684                     Prcb-&gt;CpuStep &amp; 0xff
00685                     );
00686 
00687             } <span class="keywordflow">else</span> {
00688 
00689                 <span class="comment">//</span>
00690                 <span class="comment">// New style stepping format</span>
00691                 <span class="comment">//</span>
00692 
00693                 <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a21">CmpID2</a>,
00694                     Prcb-&gt;CpuType,
00695                     (Prcb-&gt;CpuStep &gt;&gt; 8),
00696                     Prcb-&gt;CpuStep &amp; 0xff
00697                     );
00698             }
00699 
00700             CurrentEntry.ComponentEntry.IdentifierLength =
00701                 <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) + 1;
00702 
00703             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a274">CmpInitializeRegistryNode</a>(
00704                 &amp;CurrentEntry,
00705                 ParentHandle,
00706                 &amp;BaseHandle,
00707                 -1,
00708                 (ULONG)-1,
00709                 DeviceIndexTable
00710                 );
00711 
00712             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00713                 <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00714             }
00715 
00716 
00717             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/i386_8h.html#a23">KeI386NpxPresent</a>) {
00718                 RtlZeroMemory (&amp;CurrentEntry, <span class="keyword">sizeof</span> CurrentEntry);
00719                 CurrentEntry.ComponentEntry.Class = <a class="code" href="../../d1/d9/arc_8h.html#a314a180">ProcessorClass</a>;
00720                 CurrentEntry.ComponentEntry.Type = <a class="code" href="../../d1/d9/arc_8h.html#a315a189">FloatingPointProcessor</a>;
00721                 CurrentEntry.ComponentEntry.Key = i;
00722                 CurrentEntry.ComponentEntry.AffinityMask = 1 &lt;&lt; i;
00723 
00724                 CurrentEntry.ComponentEntry.Identifier = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00725 
00726                 <span class="keywordflow">if</span> (Prcb-&gt;CpuType == 3) {
00727 
00728                     <span class="comment">//</span>
00729                     <span class="comment">// 386 processors have 387's installed, else</span>
00730                     <span class="comment">// use processor identifier as the NPX identifier</span>
00731                     <span class="comment">//</span>
00732 
00733                     strcpy (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <span class="stringliteral">"80387"</span>);
00734                 }
00735 
00736                 CurrentEntry.ComponentEntry.IdentifierLength =
00737                     <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) + 1;
00738 
00739                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a274">CmpInitializeRegistryNode</a>(
00740                     &amp;CurrentEntry,
00741                     ParentHandle,
00742                     &amp;NpxHandle,
00743                     -1,
00744                     (ULONG)-1,
00745                     DeviceIndexTable
00746                     );
00747 
00748                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00749                     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(BaseHandle);
00750                     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00751                 }
00752 
00753                 <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(NpxHandle);
00754             }
00755 
00756             <span class="comment">//</span>
00757             <span class="comment">// If processor supports Cpu Indentification then</span>
00758             <span class="comment">// go obtain that information for the registry</span>
00759             <span class="comment">//</span>
00760 
00761             VendorID = Prcb-&gt;CpuID ? Prcb-&gt;VendorString : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00762 
00763             <span class="comment">//</span>
00764             <span class="comment">// Move to target processor and get other related</span>
00765             <span class="comment">// processor information for the registery</span>
00766             <span class="comment">//</span>
00767 
00768             <a class="code" href="../../d9/d1/thredobj_8c.html#a19">KeSetSystemAffinityThread</a>(Prcb-&gt;SetMember);
00769 
00770             <span class="keywordflow">if</span> (!Prcb-&gt;CpuID) {
00771 
00772                 <span class="comment">//</span>
00773                 <span class="comment">// Test for Cyrix processor</span>
00774                 <span class="comment">//</span>
00775 
00776                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/cyrix_8c.html#a24">Ke386CyrixId</a> ()) {
00777                     VendorID = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a28">CmpCyrixID</a>;
00778                 }
00779             } <span class="keywordflow">else</span> {
00780 
00781                 <span class="comment">//</span>
00782                 <span class="comment">// If this processor has extended CPUID functions, get</span>
00783                 <span class="comment">// the ProcessorNameString.  Although the Intel books</span>
00784                 <span class="comment">// say that for CpuID functions &gt; than the valued</span>
00785                 <span class="comment">// returned for function 0 will return undefined results,</span>
00786                 <span class="comment">// we have a guarantee from Intel that that result will</span>
00787                 <span class="comment">// never have the highest order bit set.  This enables</span>
00788                 <span class="comment">// us to determine if the extended functions are supported</span>
00789                 <span class="comment">// by issuing CpuID function 0x80000000.</span>
00790                 <span class="comment">//</span>
00791                 <span class="comment">// Note:  It is not known that this is true for all x86</span>
00792                 <span class="comment">// clones.  If/when we find exceptions we will support</span>
00793                 <span class="comment">// them.  In the mean time we are asking the clone makers</span>
00794                 <span class="comment">// to guarantee this behavior.</span>
00795                 <span class="comment">//</span>
00796 
00797                 <a class="code" href="../../d5/d3/i386_8h.html#a50">CPUID</a>(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a10">CPUID_EXTFN_BASE</a>, &amp;MaxExtFn, &amp;Junk, &amp;Junk, &amp;Junk);
00798 
00799                 <span class="keywordflow">if</span> (MaxExtFn &gt;= (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a11">CPUID_EXTFN_PROCESSOR_NAME</a> + 2)) {
00800 
00801                     <span class="comment">//</span>
00802                     <span class="comment">// This processor supports extended CPUID functions</span>
00803                     <span class="comment">// up to and (at least) including processor name string.</span>
00804                     <span class="comment">//</span>
00805                     <span class="comment">// Each CPUID call for the processor name string will</span>
00806                     <span class="comment">// return 16 bytes, 48 bytes in all, zero terminated.</span>
00807                     <span class="comment">//</span>
00808 
00809                     NameString = &amp;ProcessorNameString.u.DWords[0];
00810 
00811                     <span class="keywordflow">for</span> (CpuIdFunction = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a11">CPUID_EXTFN_PROCESSOR_NAME</a>;
00812                          CpuIdFunction &lt;= (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a11">CPUID_EXTFN_PROCESSOR_NAME</a>+2);
00813                          CpuIdFunction++) {
00814 
00815                         <a class="code" href="../../d5/d3/i386_8h.html#a50">CPUID</a>(CpuIdFunction,
00816                               NameString,
00817                               NameString + 1,
00818                               NameString + 2,
00819                               NameString + 3);
00820                         NameString += 4;
00821                     }
00822 
00823                     <span class="comment">//</span>
00824                     <span class="comment">// Enforce 0 byte terminator.</span>
00825                     <span class="comment">//</span>
00826 
00827                     ProcessorNameString.u.Bytes[<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a9">CPUID_PROCESSOR_NAME_STRING_SZ</a>-1] = 0;
00828                 }
00829             }
00830 
00831             ThisProcessorL2Size = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a1">KeGetPcr</a>()-&gt;SecondLevelCacheSize;
00832 
00833             <span class="comment">//</span>
00834             <span class="comment">// Restore thread's affinity to all processors</span>
00835             <span class="comment">//</span>
00836 
00837             <a class="code" href="../../d9/d1/thredobj_8c.html#a16">KeRevertToUserAffinityThread</a>();
00838 
00839             <span class="keywordflow">if</span> (NameString) {
00840 
00841                 <span class="comment">//</span>
00842                 <span class="comment">// Add Processor Name String to the registery</span>
00843                 <span class="comment">//</span>
00844 
00845                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00846                     &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00847                     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a23">CmpProcessorNameString</a>
00848                     );
00849 
00850                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(
00851                     &amp;AnsiString,
00852                     ProcessorNameString.u.Bytes
00853                     );
00854 
00855                 <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
00856                     &amp;ValueData,
00857                     &amp;AnsiString,
00858                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00859                     );
00860 
00861                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00862                             BaseHandle,
00863                             &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00864                             <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00865                             REG_SZ,
00866                             ValueData.Buffer,
00867                             ValueData.Length + <span class="keyword">sizeof</span>( UNICODE_NULL )
00868                             );
00869 
00870                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;ValueData);
00871             }
00872 
00873             <span class="keywordflow">if</span> (VendorID) {
00874 
00875                 <span class="comment">//</span>
00876                 <span class="comment">// Add Vendor Indentifier to the registery</span>
00877                 <span class="comment">//</span>
00878 
00879                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00880                     &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00881                     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a22">CmpVendorID</a>
00882                     );
00883 
00884                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(
00885                     &amp;AnsiString,
00886                     VendorID
00887                     );
00888 
00889                 <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
00890                     &amp;ValueData,
00891                     &amp;AnsiString,
00892                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00893                     );
00894 
00895                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00896                             BaseHandle,
00897                             &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00898                             <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00899                             REG_SZ,
00900                             ValueData.Buffer,
00901                             ValueData.Length + <span class="keyword">sizeof</span>( UNICODE_NULL )
00902                             );
00903 
00904                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;ValueData);
00905             }
00906 
00907             <span class="keywordflow">if</span> (Prcb-&gt;FeatureBits) {
00908                 <span class="comment">//</span>
00909                 <span class="comment">// Add processor feature bits to the registery</span>
00910                 <span class="comment">//</span>
00911 
00912                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00913                     &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00914                     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a24">CmpFeatureBits</a>
00915                     );
00916 
00917                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00918                             BaseHandle,
00919                             &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00920                             <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00921                             REG_DWORD,
00922                             &amp;Prcb-&gt;FeatureBits,
00923                             sizeof (Prcb-&gt;FeatureBits)
00924                             );
00925             }
00926 
00927             <span class="keywordflow">if</span> (Prcb-&gt;MHz) {
00928                 <span class="comment">//</span>
00929                 <span class="comment">// Add processor MHz to the registery</span>
00930                 <span class="comment">//</span>
00931 
00932                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00933                     &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00934                     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a25">CmpMHz</a>
00935                     );
00936 
00937                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00938                             BaseHandle,
00939                             &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00940                             <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00941                             REG_DWORD,
00942                             &amp;Prcb-&gt;MHz,
00943                             sizeof (Prcb-&gt;MHz)
00944                             );
00945             }
00946 
00947             <span class="keywordflow">if</span> (Prcb-&gt;UpdateSignature.QuadPart) {
00948                 <span class="comment">//</span>
00949                 <span class="comment">// Add processor MHz to the registery</span>
00950                 <span class="comment">//</span>
00951 
00952                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00953                     &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00954                     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a26">CmpUpdateSignature</a>
00955                     );
00956 
00957                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00958                             BaseHandle,
00959                             &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00960                             <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00961                             REG_BINARY,
00962                             &amp;Prcb-&gt;UpdateSignature,
00963                             sizeof (Prcb-&gt;UpdateSignature)
00964                             );
00965             }
00966 
00967             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(BaseHandle);
00968 
00969             <span class="comment">//</span>
00970             <span class="comment">// Check processor steppings.</span>
00971             <span class="comment">//</span>
00972 
00973             <span class="keywordflow">if</span> (i == 0) {
00974 
00975                 P0L2Size = ThisProcessorL2Size;
00976 
00977             } <span class="keywordflow">else</span> {
00978 
00979                 <span class="comment">//</span>
00980                 <span class="comment">// Check all processors against processor 0. Compare</span>
00981                 <span class="comment">//     CPUID supported,</span>
00982                 <span class="comment">//     Vendor ID String</span>
00983                 <span class="comment">//     Family and Stepping</span>
00984                 <span class="comment">//     L2 cache size.</span>
00985                 <span class="comment">//</span>
00986 
00987                 <span class="keywordflow">if</span> (Prcb-&gt;CpuID) {
00988                     <span class="keywordflow">if</span> (strcmp(Prcb-&gt;VendorString,
00989                                <a class="code" href="../../d4/d9/ke_8h.html#a139">KiProcessorBlock</a>[0]-&gt;VendorString)) {
00990                         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a31">CmProcessorMismatch</a> |= <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a12">CM_PROCESSOR_MISMATCH_VENDOR</a>;
00991                     }
00992                     <span class="keywordflow">if</span> (ThisProcessorL2Size != P0L2Size) {
00993                         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a31">CmProcessorMismatch</a> |= <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a14">CM_PROCESSOR_MISMATCH_L2</a>;
00994                     }
00995                     <span class="keywordflow">if</span> ((Prcb-&gt;CpuType != <a class="code" href="../../d4/d9/ke_8h.html#a139">KiProcessorBlock</a>[0]-&gt;CpuType) ||
00996                         (Prcb-&gt;CpuStep != <a class="code" href="../../d4/d9/ke_8h.html#a139">KiProcessorBlock</a>[0]-&gt;CpuStep)) {
00997                         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a31">CmProcessorMismatch</a> |= <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a13">CM_PROCESSOR_MISMATCH_STEPPING</a>;
00998                     }
00999                 } <span class="keywordflow">else</span> {
01000 
01001                     <span class="comment">//</span>
01002                     <span class="comment">// If this processor doesn't support CPUID, P0</span>
01003                     <span class="comment">// shouldn't support it either.</span>
01004                     <span class="comment">//</span>
01005 
01006                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a139">KiProcessorBlock</a>[0]-&gt;CpuID) {
01007                         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a31">CmProcessorMismatch</a> |= <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a13">CM_PROCESSOR_MISMATCH_STEPPING</a>;
01008                     }
01009                 }
01010             }
01011         }
01012 
01013         <span class="keywordflow">if</span> (0 != <a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a>) {
01014             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)<a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a>);
01015         }
01016     }
01017 
01018     <span class="comment">//</span>
01019     <span class="comment">// Next we try to collect System BIOS date and version strings.</span>
01020     <span class="comment">// BUGBUG This code should be moved to ntdetect.com after product 1.</span>
01021     <span class="comment">//</span>
01022 
01023     <span class="comment">//</span>
01024     <span class="comment">// Open a physical memory section to map in physical memory.</span>
01025     <span class="comment">//</span>
01026 
01027     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
01028         &amp;SectionName,
01029         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Device\\PhysicalMemory"</span>
01030         );
01031 
01032     InitializeObjectAttributes(
01033         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01034         &amp;SectionName,
01035         OBJ_CASE_INSENSITIVE,
01036         (HANDLE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01037         (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01038         );
01039 
01040     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenSection(
01041         &amp;SectionHandle,
01042         SECTION_ALL_ACCESS,
01043         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>
01044         );
01045 
01046     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01047 
01048         <span class="comment">//</span>
01049         <span class="comment">// If fail, forget the bios data and version</span>
01050         <span class="comment">//</span>
01051 
01052         <span class="keywordflow">goto</span> AllDone;
01053     }
01054 
01055     <span class="comment">//</span>
01056     <span class="comment">// Examine the first page of physical memory for int 10 segment</span>
01057     <span class="comment">// address.</span>
01058     <span class="comment">//</span>
01059 
01060     BaseAddress = 0;
01061     ViewSize = 0x1000;
01062     ViewBase.LowPart = 0;
01063     ViewBase.HighPart = 0;
01064 
01065     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> =ZwMapViewOfSection(
01066         SectionHandle,
01067         NtCurrentProcess(),
01068         &amp;BaseAddress,
01069         0,
01070         ViewSize,
01071         &amp;ViewBase,
01072         &amp;ViewSize,
01073         ViewUnmap,
01074         MEM_DOS_LIM,
01075         PAGE_READWRITE
01076         );
01077 
01078     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01079         VideoBiosStart = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a6">VIDEO_BIOS_START</a>;
01080     } <span class="keywordflow">else</span> {
01081         VideoBiosStart = (*((PULONG)BaseAddress + <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a5">INT10_VECTOR</a>) &amp; 0xFFFF0000) &gt;&gt; 12;
01082         VideoBiosStart += (*((PULONG)BaseAddress + <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a5">INT10_VECTOR</a>) &amp; 0x0000FFFF);
01083         VideoBiosStart &amp;= 0xffff8000;
01084         <span class="keywordflow">if</span> (VideoBiosStart &lt; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a6">VIDEO_BIOS_START</a>) {
01085             VideoBiosStart = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a6">VIDEO_BIOS_START</a>;
01086         }
01087         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwUnmapViewOfSection(
01088             NtCurrentProcess(),
01089             BaseAddress
01090             );
01091     }
01092 
01093     VersionStrings = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a8">VERSION_DATA_LENGTH</a>);
01094     BaseAddress = 0;
01095     ViewSize = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a4">SYSTEM_BIOS_LENGTH</a>;
01096     ViewBase.LowPart = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a3">SYSTEM_BIOS_START</a>;
01097     ViewBase.HighPart = 0;
01098 
01099     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> =ZwMapViewOfSection(
01100         SectionHandle,
01101         NtCurrentProcess(),
01102         &amp;BaseAddress,
01103         0,
01104         ViewSize,
01105         &amp;ViewBase,
01106         &amp;ViewSize,
01107         ViewUnmap,
01108         MEM_DOS_LIM,
01109         PAGE_READWRITE
01110         );
01111 
01112     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01113         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a29">CmpGetBiosDate</a>(BaseAddress, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a4">SYSTEM_BIOS_LENGTH</a>, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
01114 
01115             <span class="comment">//</span>
01116             <span class="comment">// Convert ascii date string to unicode string and</span>
01117             <span class="comment">// store it in registry.</span>
01118             <span class="comment">//</span>
01119 
01120             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
01121                 &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
01122                 <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SystemBiosDate"</span>
01123                 );
01124 
01125             <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(
01126                 &amp;AnsiString,
01127                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>
01128                 );
01129 
01130             <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
01131                 &amp;ValueData,
01132                 &amp;AnsiString,
01133                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
01134                 );
01135 
01136             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
01137                         ParentHandle,
01138                         &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
01139                         <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
01140                         REG_SZ,
01141                         ValueData.Buffer,
01142                         ValueData.Length + <span class="keyword">sizeof</span>( UNICODE_NULL )
01143                         );
01144 
01145             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;ValueData);
01146 
01147 <span class="preprocessor">#ifdef _WANT_MACHINE_IDENTIFICATION</span>
01148 <span class="preprocessor"></span>
01149             memcpy(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, (PCHAR)BaseAddress + 0xFFF5, 8);
01150             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[8] = <span class="charliteral">'\0'</span>;
01151 
01152             <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(  
01153                 &amp;AnsiString,
01154                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>
01155                 );
01156 
01157             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(   
01158                         &amp;ValueData,
01159                         &amp;AnsiString,
01160                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
01161                         );
01162                                                 
01163             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01164             
01165                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>( 
01166                             BiosInfo,
01167                             &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
01168                             <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
01169                             REG_SZ,
01170                             ValueData.Buffer,
01171                             ValueData.Length + <span class="keyword">sizeof</span>( UNICODE_NULL )
01172                             );
01173                                     
01174                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;ValueData);
01175             }
01176             
01177             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (BiosInfo);
01178             
01179 <span class="preprocessor">#endif</span>
01180 <span class="preprocessor"></span>            
01181         }
01182 
01183         <span class="keywordflow">if</span> (VersionStrings &amp;&amp; <a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a28">CmpGetBiosVersion</a>(BaseAddress, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a4">SYSTEM_BIOS_LENGTH</a>, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)) {
01184             VersionPointer = VersionStrings;
01185             <span class="keywordflow">do</span> {
01186 
01187                 <span class="comment">//</span>
01188                 <span class="comment">// Try to detect ALL the possible BIOS version strings.</span>
01189                 <span class="comment">// Convert them to unicode strings and copy them to our</span>
01190                 <span class="comment">// VersionStrings buffer.</span>
01191                 <span class="comment">//</span>
01192 
01193                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(
01194                     &amp;AnsiString,
01195                     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>
01196                     );
01197 
01198                 <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
01199                     &amp;ValueData,
01200                     &amp;AnsiString,
01201                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
01202                     );
01203 
01204                 Length = ValueData.Length + <span class="keyword">sizeof</span>(UNICODE_NULL);
01205                 RtlMoveMemory(VersionPointer,
01206                               ValueData.Buffer,
01207                               Length
01208                               );
01209                 VersionsLength += Length;
01210                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;ValueData);
01211                 <span class="keywordflow">if</span> (VersionsLength + (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a2">MAXIMUM_BIOS_VERSION_LENGTH</a> +
01212                     <span class="keyword">sizeof</span>(UNICODE_NULL)) * 2 &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) {
01213                     <span class="keywordflow">break</span>;
01214                 }
01215                 VersionPointer += Length;
01216             } <span class="keywordflow">while</span> (<a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a28">CmpGetBiosVersion</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>));
01217 
01218             <span class="keywordflow">if</span> (VersionsLength != 0) {
01219 
01220                 <span class="comment">//</span>
01221                 <span class="comment">// Append a UNICODE_NULL to the end of VersionStrings</span>
01222                 <span class="comment">//</span>
01223 
01224                 *(PWSTR)VersionPointer = UNICODE_NULL;
01225                 VersionsLength += <span class="keyword">sizeof</span>(UNICODE_NULL);
01226 
01227                 <span class="comment">//</span>
01228                 <span class="comment">// If any version string is found, we set up a ValueName and</span>
01229                 <span class="comment">// initialize its value to the string(s) we found.</span>
01230                 <span class="comment">//</span>
01231 
01232                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
01233                     &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
01234                     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SystemBiosVersion"</span>
01235                     );
01236 
01237                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
01238                             ParentHandle,
01239                             &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
01240                             <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
01241                             REG_MULTI_SZ,
01242                             VersionStrings,
01243                             VersionsLength
01244                             );
01245             }
01246         }
01247         ZwUnmapViewOfSection(NtCurrentProcess(), BaseAddress);
01248     }
01249 
01250     <span class="comment">//</span>
01251     <span class="comment">// Next we try to collect Video BIOS date and version strings.</span>
01252     <span class="comment">//</span>
01253 
01254     BaseAddress = 0;
01255     ViewSize = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a7">VIDEO_BIOS_LENGTH</a>;
01256     ViewBase.LowPart = VideoBiosStart;
01257     ViewBase.HighPart = 0;
01258 
01259     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> =ZwMapViewOfSection(
01260         SectionHandle,
01261         NtCurrentProcess(),
01262         &amp;BaseAddress,
01263         0,
01264         ViewSize,
01265         &amp;ViewBase,
01266         &amp;ViewSize,
01267         ViewUnmap,
01268         MEM_DOS_LIM,
01269         PAGE_READWRITE
01270         );
01271 
01272     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01273         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a29">CmpGetBiosDate</a>(BaseAddress, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a7">VIDEO_BIOS_LENGTH</a>, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
01274 
01275             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
01276                 &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
01277                 <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"VideoBiosDate"</span>
01278                 );
01279 
01280             <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(
01281                 &amp;AnsiString,
01282                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>
01283                 );
01284 
01285             <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
01286                 &amp;ValueData,
01287                 &amp;AnsiString,
01288                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
01289                 );
01290 
01291             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
01292                         ParentHandle,
01293                         &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
01294                         <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
01295                         REG_SZ,
01296                         ValueData.Buffer,
01297                         ValueData.Length + <span class="keyword">sizeof</span>( UNICODE_NULL )
01298                         );
01299 
01300             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;ValueData);
01301         }
01302 
01303         <span class="keywordflow">if</span> (VersionStrings &amp;&amp; <a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a28">CmpGetBiosVersion</a>(BaseAddress, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a7">VIDEO_BIOS_LENGTH</a>, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)) {
01304             VersionPointer = VersionStrings;
01305             <span class="keywordflow">do</span> {
01306 
01307                 <span class="comment">//</span>
01308                 <span class="comment">// Try to detect ALL the possible BIOS version strings.</span>
01309                 <span class="comment">// Convert them to unicode strings and copy them to our</span>
01310                 <span class="comment">// VersionStrings buffer.</span>
01311                 <span class="comment">//</span>
01312 
01313                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(
01314                     &amp;AnsiString,
01315                     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>
01316                     );
01317 
01318                 <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
01319                     &amp;ValueData,
01320                     &amp;AnsiString,
01321                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
01322                     );
01323 
01324                 Length = ValueData.Length + <span class="keyword">sizeof</span>(UNICODE_NULL);
01325                 RtlMoveMemory(VersionPointer,
01326                               ValueData.Buffer,
01327                               Length
01328                               );
01329                 VersionsLength += Length;
01330                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;ValueData);
01331                 <span class="keywordflow">if</span> (VersionsLength + (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a2">MAXIMUM_BIOS_VERSION_LENGTH</a> +
01332                     <span class="keyword">sizeof</span>(UNICODE_NULL)) * 2 &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) {
01333                     <span class="keywordflow">break</span>;
01334                 }
01335                 VersionPointer += Length;
01336             } <span class="keywordflow">while</span> (<a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a28">CmpGetBiosVersion</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>));
01337 
01338             <span class="keywordflow">if</span> (VersionsLength != 0) {
01339 
01340                 <span class="comment">//</span>
01341                 <span class="comment">// Append a UNICODE_NULL to the end of VersionStrings</span>
01342                 <span class="comment">//</span>
01343 
01344                 *(PWSTR)VersionPointer = UNICODE_NULL;
01345                 VersionsLength += <span class="keyword">sizeof</span>(UNICODE_NULL);
01346 
01347                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
01348                     &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
01349                     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"VideoBiosVersion"</span>
01350                     );
01351 
01352                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
01353                             ParentHandle,
01354                             &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
01355                             <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
01356                             REG_MULTI_SZ,
01357                             VersionStrings,
01358                             VersionsLength
01359                             );
01360             }
01361         }
01362         ZwUnmapViewOfSection(NtCurrentProcess(), BaseAddress);
01363     }
01364     ZwClose(SectionHandle);
01365     <span class="keywordflow">if</span> (VersionStrings) {
01366         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)VersionStrings);
01367     }
01368 
01369 AllDone:
01370 
01371     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (ParentHandle);
01372 
01373     <span class="comment">//</span>
01374     <span class="comment">// Add any other x86 specific code here...</span>
01375     <span class="comment">//</span>
01376 
01377 <span class="preprocessor">#ifdef _WANT_MACHINE_IDENTIFICATION</span>
01378 <span class="preprocessor"></span>
01379     <span class="comment">//</span>
01380     <span class="comment">// Do machine identification.</span>
01381     <span class="comment">//</span>
01382     
01383     CmpPerformMachineIdentification(LoaderBlock);
01384     
01385 <span class="preprocessor">#endif    </span>
01386 <span class="preprocessor"></span>
01387     <span class="keywordflow">return</span> STATUS_SUCCESS;
01388 }
01389 
01390 <span class="preprocessor">#ifdef _WANT_MACHINE_IDENTIFICATION</span>
01391 <span class="preprocessor"></span>
01392 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01393 CmpPerformMachineIdentification(
01394     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
01395     )
01396 {    
01397     ULONG   majorVersion;
01398     ULONG   minorVersion;
01399     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>    versionBuffer[64];
01400     PCHAR   major;
01401     PCHAR   minor;
01402 
01403     <span class="keywordflow">if</span> (LoaderBlock-&gt;Extension &amp;&amp; LoaderBlock-&gt;Extension-&gt;Size &gt;= <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d2/struct__LOADER__PARAMETER__EXTENSION.html">LOADER_PARAMETER_EXTENSION</a>)) {
01404        
01405         major = strcpy(versionBuffer, VER_PRODUCTVERSION_STR);
01406         minor = strchr(major, <span class="charliteral">'.'</span>);
01407         *minor++ = <span class="charliteral">'\0'</span>;
01408         majorVersion = atoi(major);
01409         minorVersion = atoi(minor);
01410         <span class="keywordflow">if</span> (    LoaderBlock-&gt;Extension-&gt;MajorVersion &gt; majorVersion ||
01411                 (LoaderBlock-&gt;Extension-&gt;MajorVersion == majorVersion &amp;&amp; 
01412                     LoaderBlock-&gt;Extension-&gt;MinorVersion &gt;= minorVersion)) {
01413             
01414             <span class="keywordflow">if</span> (LoaderBlock-&gt;Extension-&gt;InfFileImage &amp;&amp; LoaderBlock-&gt;Extension-&gt;InfFileSize) {
01415 
01416                 <a class="code" href="../../d0/d4/rules_8h.html#a1">CmpMatchInfList</a>(
01417                     LoaderBlock-&gt;Extension-&gt;InfFileImage, 
01418                     LoaderBlock-&gt;Extension-&gt;InfFileSize,
01419                     <span class="stringliteral">"MachineDescription"</span>
01420                     ); 
01421             }        
01422         }
01423     }
01424 }
01425 
01426 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:22 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
