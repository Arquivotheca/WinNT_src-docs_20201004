<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: mmrtl.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>mmrtl.c</h1><a href="../../d9/d1/mmrtl_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: mmrtl.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Multimonitor APIs.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 29-Mar-1997 adams     Created.</span>
00010 <span class="comment">\***************************************************************************/</span>
00011 
<a name="l00012"></a><a class="code" href="../../d9/d1/mmrtl_8c.html#a0">00012</a> <span class="preprocessor">#define Int32x32To32(x, y) ((x) * (y))</span>
00013 <span class="preprocessor"></span>
00014 <span class="comment">/*</span>
00015 <span class="comment"> * There is no object locking in the client, so the monitor object can</span>
00016 <span class="comment"> * go away at any time. Therefore to be safe, we need an exception handler.</span>
00017 <span class="comment"> */</span>
00018 <span class="preprocessor">#ifdef _USERK_</span>
00019 <span class="preprocessor"></span><span class="preprocessor">#define BEGIN_EXCEPTION_HANDLER</span>
00020 <span class="preprocessor"></span><span class="preprocessor">#define END_EXCEPTION_HANDLER</span>
00021 <span class="preprocessor"></span><span class="preprocessor">#define END_EXCEPTION_HANDLER_EMPTY</span>
00022 <span class="preprocessor"></span><span class="preprocessor">#else // _USERK_</span>
<a name="l00023"></a><a class="code" href="../../d9/d1/mmrtl_8c.html#a1">00023</a> <span class="preprocessor"></span><span class="preprocessor">#define BEGIN_EXCEPTION_HANDLER try {</span>
<a name="l00024"></a><a class="code" href="../../d9/d1/mmrtl_8c.html#a2">00024</a> <span class="preprocessor"></span><span class="preprocessor">#define END_EXCEPTION_HANDLER \</span>
00025 <span class="preprocessor">    } except (W32ExceptionHandler(TRUE, RIP_WARNING)) { \</span>
00026 <span class="preprocessor">        pMonitorResult = NULL; \</span>
00027 <span class="preprocessor">    }</span>
<a name="l00028"></a><a class="code" href="../../d9/d1/mmrtl_8c.html#a3">00028</a> <span class="preprocessor"></span><span class="preprocessor">#define END_EXCEPTION_HANDLER_EMPTY \</span>
00029 <span class="preprocessor">    } except (W32ExceptionHandler(TRUE, RIP_WARNING)) { \</span>
00030 <span class="preprocessor">    }</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#endif // _USERK_</span>
00032 <span class="preprocessor"></span>
00033 
00034 <span class="comment">/***************************************************************************\</span>
00035 <span class="comment">* _MonitorFromPoint</span>
00036 <span class="comment">*</span>
00037 <span class="comment">* Calculate the monitor that a point is in or is nearest to.</span>
00038 <span class="comment">*</span>
00039 <span class="comment">* Arguments:</span>
00040 <span class="comment">*     pt      - The point.</span>
00041 <span class="comment">*     dwFlags - One of:</span>
00042 <span class="comment">*         MONITOR_DEFAULTTONULL - If the point isn't in a monitor,</span>
00043 <span class="comment">*             return NULL.</span>
00044 <span class="comment">*</span>
00045 <span class="comment">*         MONITOR_DEFAULTTOPRIMARY - If the point isn't in a monitor,</span>
00046 <span class="comment">*             return the primary monitor.</span>
00047 <span class="comment">*</span>
00048 <span class="comment">*         MONITOR_DEFAULTTONEAREST - Return the monitor nearest the point.</span>
00049 <span class="comment">*</span>
00050 <span class="comment">* History:</span>
00051 <span class="comment">* 22-Sep-1996 adams     Created.</span>
00052 <span class="comment">* 29-Mar-1997 adams     Moved to rtl.</span>
00053 <span class="comment">\***************************************************************************/</span>
00054 
00055 <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>
<a name="l00056"></a><a class="code" href="../../d9/d1/mmrtl_8c.html#a6">00056</a> <a class="code" href="../../d9/d1/mmrtl_8c.html#a6">_MonitorFromPoint</a>(POINT pt, DWORD dwFlags)
00057 {
00058     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>        pMonitor, pMonitorResult;
00059     <span class="keywordtype">int</span>             dx;
00060     <span class="keywordtype">int</span>             dy;
00061 
00062     UserAssert(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> == MONITOR_DEFAULTTONULL ||
00063                <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> == MONITOR_DEFAULTTOPRIMARY ||
00064                <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> == MONITOR_DEFAULTTONEAREST);
00065 
00066     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a792">GetDispInfo</a>()-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o11">cMonitors</a> == 1 &amp;&amp; <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> != MONITOR_DEFAULTTONULL)
00067         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a793">GetPrimaryMonitor</a>();
00068 
00069     <span class="keywordflow">switch</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>) {
00070     <span class="keywordflow">case</span> MONITOR_DEFAULTTONULL:
00071     <span class="keywordflow">case</span> MONITOR_DEFAULTTOPRIMARY:
00072         <span class="comment">/*</span>
00073 <span class="comment">         * Return the monitor the point is in.</span>
00074 <span class="comment">         */</span>
00075 
00076         <a class="code" href="../../d9/d1/mmrtl_8c.html#a1">BEGIN_EXCEPTION_HANDLER</a>
00077 
00078         <span class="keywordflow">for</span> (   pMonitor = <a class="code" href="../../d4/d1/userk_8h.html#a751">REBASESHAREDPTRALWAYS</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a792">GetDispInfo</a>()-&gt;pMonitorFirst);
00079                 pMonitor;
00080                 pMonitor = <a class="code" href="../../d4/d1/userk_8h.html#a750">REBASESHAREDPTR</a>(pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o1">pMonitorNext</a>)) {
00081 
00082             <span class="keywordflow">if</span> (!(pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o2">dwMONFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a525">MONF_VISIBLE</a>))
00083                 <span class="keywordflow">continue</span>;
00084 
00085             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(&amp;((<a class="code" href="../../d0/d2/structtagMONITOR.html">MONITOR</a> *)pMonitor)-&gt;rcMonitor, pt)) {
00086                 <span class="keywordflow">return</span> pMonitor;
00087             }
00088         }
00089 
00090         <a class="code" href="../../d9/d1/mmrtl_8c.html#a3">END_EXCEPTION_HANDLER_EMPTY</a>
00091 
00092         <span class="comment">/*</span>
00093 <span class="comment">         * Return what the user wants if it's not found.</span>
00094 <span class="comment">         */</span>
00095         <span class="keywordflow">switch</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>) {
00096         <span class="keywordflow">case</span> MONITOR_DEFAULTTONULL:
00097             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00098 
00099         <span class="keywordflow">case</span> MONITOR_DEFAULTTOPRIMARY:
00100             <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a793">GetPrimaryMonitor</a>();
00101 
00102         <span class="keywordflow">default</span>:
00103             UserAssertMsg0(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <span class="stringliteral">"Logic error in _MonitorFromPoint"</span>);
00104             <span class="keywordflow">break</span>;
00105         }
00106 
00107     <span class="keywordflow">case</span> MONITOR_DEFAULTTONEAREST:
00108 
00109 <span class="preprocessor">#define MONITORFROMPOINTALGORITHM(SUMSQUARESMAX, SUMSQUARESTYPE, POINTMULTIPLY)     \</span>
00110 <span class="preprocessor">        SUMSQUARESTYPE  sumsquare;                                                  \</span>
00111 <span class="preprocessor">        SUMSQUARESTYPE  leastsumsquare;                                             \</span>
00112 <span class="preprocessor">        leastsumsquare = SUMSQUARESMAX;                                             \</span>
00113 <span class="preprocessor">        for (   pMonitor = REBASESHAREDPTRALWAYS(GetDispInfo()-&gt;pMonitorFirst);     \</span>
00114 <span class="preprocessor">                pMonitor;                                                           \</span>
00115 <span class="preprocessor">                pMonitor = REBASESHAREDPTR(pMonitor-&gt;pMonitorNext)) {               \</span>
00116 <span class="preprocessor">                                                                                    \</span>
00117 <span class="preprocessor">            if (!(pMonitor-&gt;dwMONFlags &amp; MONF_VISIBLE))                             \</span>
00118 <span class="preprocessor">                continue;                                                           \</span>
00119 <span class="preprocessor">                                                                                    \</span>
00120 <span class="preprocessor">            </span><span class="comment">/*                                                                      \</span>
00121 <span class="comment">             * Determine distance from monitor along x axis.                        \</span>
00122 <span class="comment">             */</span>                                                                     \
00123             if (pt.x &lt; pMonitor-&gt;rcMonitor.left) {                                  \
00124                 dx = pMonitor-&gt;rcMonitor.left - pt.x;                               \
00125             } else if (pt.x &lt; pMonitor-&gt;rcMonitor.right) {                          \
00126                 dx = 0;                                                             \
00127             } else {                                                                \
00128                 <span class="comment">/*                                                                  \</span>
00129 <span class="comment">                 * Monitor rectangles do not include the rightmost edge.            \</span>
00130 <span class="comment">                 */</span>                                                                 \
00131                 dx = pt.x - (pMonitor-&gt;rcMonitor.right - 1);                        \
00132             }                                                                       \
00133                                                                                     \
00134             <span class="comment">/*                                                                      \</span>
00135 <span class="comment">             * Skip this monitor if dx is greater than dx^2 + dy^2.                 \</span>
00136 <span class="comment">             * We do this check to avoid multiplication operations.                 \</span>
00137 <span class="comment">             */</span>                                                                     \
00138             if ((SUMSQUARESTYPE) dx &gt;= leastsumsquare)                              \
00139                 continue;                                                           \
00140                                                                                     \
00141             <span class="comment">/*                                                                      \</span>
00142 <span class="comment">             * Determine distance from monitor along y axis.                        \</span>
00143 <span class="comment">             */</span>                                                                     \
00144             if (pt.y &lt; pMonitor-&gt;rcMonitor.top) {                                   \
00145                 dy = pMonitor-&gt;rcMonitor.top - pt.y;                                \
00146             } else if (pt.y &lt; pMonitor-&gt;rcMonitor.bottom) {                         \
00147                 <span class="comment">/*                                                                  \</span>
00148 <span class="comment">                 * The point is in the monitor and we're done                       \</span>
00149 <span class="comment">                 * if both dx and dy are zero.                                      \</span>
00150 <span class="comment">                 */</span>                                                                 \
00151                 if (dx == 0)                                                        \
00152                     return pMonitor;                                                \
00153                                                                                     \
00154                 dy = 0;                                                             \
00155             } else {                                                                \
00156                 dy = pt.y - (pMonitor-&gt;rcMonitor.bottom - 1);                       \
00157             }                                                                       \
00158                                                                                     \
00159             <span class="comment">/*                                                                      \</span>
00160 <span class="comment">             * Calculate dx^2. Skip this monitor if dx is greater                   \</span>
00161 <span class="comment">             * than dx^2 + dy^2. We do this check to avoid                          \</span>
00162 <span class="comment">             * multiplication operations.                                           \</span>
00163 <span class="comment">             */</span>                                                                     \
00164             sumsquare = POINTMULTIPLY(dx, dx);                                      \
00165             if (sumsquare &gt;= leastsumsquare)                                        \
00166                 continue;                                                           \
00167                                                                                     \
00168             <span class="comment">/*                                                                      \</span>
00169 <span class="comment">             * Skip this monitor if dx^2 + y is greater than dx^2 + dy^2.           \</span>
00170 <span class="comment">             * We do this check to avoid multiplication operations.                 \</span>
00171 <span class="comment">             */</span>                                                                     \
00172             if (sumsquare + (SUMSQUARESTYPE) dy &gt;= leastsumsquare)                  \
00173                 continue;                                                           \
00174                                                                                     \
00175             <span class="comment">/*                                                                      \</span>
00176 <span class="comment">             * Compute dx^2 + dy^2. Skip this monitor if it's not the least.        \</span>
00177 <span class="comment">             */</span>                                                                     \
00178             sumsquare += (SUMSQUARESTYPE) POINTMULTIPLY(dy, dy);                    \
00179             if (sumsquare &gt;= leastsumsquare)                                        \
00180                 continue;                                                           \
00181                                                                                     \
00182             <span class="comment">/*                                                                      \</span>
00183 <span class="comment">             * This is the closest monitor so far.                                  \</span>
00184 <span class="comment">             */</span>                                                                     \
00185             leastsumsquare = sumsquare;                                             \
00186             pMonitorResult = pMonitor;                                              \
00187         }
00188 
00189 <span class="preprocessor">#if DBG</span>
00190 <span class="preprocessor"></span>        pMonitorResult = (<a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>) -1;
00191 <span class="preprocessor">#endif</span>
00192 <span class="preprocessor"></span>
00193         <span class="keywordflow">if</span> (    pt.x &lt; SHRT_MIN || SHRT_MAX &lt; pt.x ||
00194                 pt.y &lt; SHRT_MIN || SHRT_MAX &lt; pt.y) {
00195 
00196             <a class="code" href="../../d9/d1/mmrtl_8c.html#a1">BEGIN_EXCEPTION_HANDLER</a>
00197             <a class="code" href="../../d9/d1/mmrtl_8c.html#a4">MONITORFROMPOINTALGORITHM</a>(_UI64_MAX, ULONGLONG, Int32x32To64)
00198             <a class="code" href="../../d9/d1/mmrtl_8c.html#a2">END_EXCEPTION_HANDLER</a>
00199 
00200         } <span class="keywordflow">else</span> {
00201 
00202             <a class="code" href="../../d9/d1/mmrtl_8c.html#a1">BEGIN_EXCEPTION_HANDLER</a>
00203             <a class="code" href="../../d9/d1/mmrtl_8c.html#a4">MONITORFROMPOINTALGORITHM</a>(UINT_MAX, <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>, <a class="code" href="../../d9/d1/mmrtl_8c.html#a0">Int32x32To32</a>)
00204             <a class="code" href="../../d9/d1/mmrtl_8c.html#a2">END_EXCEPTION_HANDLER</a>
00205 
00206         }
00207 
00208         UserAssert(pMonitorResult != (<a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>) -1);
00209         <span class="keywordflow">return</span> pMonitorResult;
00210 
00211     <span class="keywordflow">default</span>:
00212         UserAssert(0 &amp;&amp; <span class="stringliteral">"Logic error in _MonitorFromPoint, shouldn't have gotten here."</span>);
00213         <span class="keywordflow">break</span>;
00214     }
00215 
00216     UserAssert(0 &amp;&amp; <span class="stringliteral">"Logic error in _MonitorFromPoint, shouldn't have gotten here."</span>);
00217     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00218 }
00219 
00220 
<a name="l00221"></a><a class="code" href="../../d9/d1/mmrtl_8c.html#a7">00221</a> 
00222 <span class="comment">/***************************************************************************\</span>
00223 <span class="comment">* _MonitorFromRect</span>
00224 <span class="comment">*</span>
00225 <span class="comment">* Calculate the monitor that a rect is in or is nearest to.</span>
00226 <span class="comment">*</span>
00227 <span class="comment">* Arguments:</span>
00228 <span class="comment">*     lprc    - The rect.</span>
00229 <span class="comment">*     dwFlags - One of:</span>
00230 <span class="comment">*         MONITOR_DEFAULTTONULL - If the rect doesn't intersect a monitor,</span>
00231 <span class="comment">*             return NULL.</span>
00232 <span class="comment">*</span>
00233 <span class="comment">*         MONITOR_DEFAULTTOPRIMARY - If the rect doesn't intersect a monitor,</span>
00234 <span class="comment">*             return the primary monitor.</span>
00235 <span class="comment">*</span>
00236 <span class="comment">*         MONITOR_DEFAULTTONEAREST - Return the monitor nearest the rect.</span>
00237 <span class="comment">*</span>
00238 <span class="comment">* History:</span>
00239 <span class="comment">* 22-Sep-1996 adams     Created.</span>
00240 <span class="comment">* 29-Mar-1997 adams     Moved to rtl.</span>
00241 <span class="comment">\***************************************************************************/</span>
00242 
00243 <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>
00244 <a class="code" href="../../d9/d1/mmrtl_8c.html#a7">_MonitorFromRect</a>(LPCRECT lprc, DWORD dwFlags)
00245 {
00246     <a class="code" href="../../d9/d3/structtagDISPLAYINFO.html">PDISPLAYINFO</a>    pDispInfo;
00247     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>        pMonitor, pMonitorResult;
00248     RECT            rc;
00249     <span class="keywordtype">int</span>             area, areaMost;
00250 
00251     UserAssert(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> == MONITOR_DEFAULTTONULL ||
00252                <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> == MONITOR_DEFAULTTOPRIMARY ||
00253                <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> == MONITOR_DEFAULTTONEAREST);
00254 
00255     <span class="comment">/*</span>
00256 <span class="comment">     * Special case the most common case - 1 monitor.</span>
00257 <span class="comment">     */</span>
00258     pDispInfo = <a class="code" href="../../d6/d0/usercli_8h.html#a792">GetDispInfo</a>();
00259     <span class="keywordflow">if</span> (pDispInfo-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o11">cMonitors</a> == 1 &amp;&amp; <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> != MONITOR_DEFAULTTONULL)
00260         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a793">GetPrimaryMonitor</a>();
00261 
00262     <span class="comment">/*</span>
00263 <span class="comment">     * If rect is empty, use topleft point.</span>
00264 <span class="comment">     */</span>
00265     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/rect_8c.html#a4">IsRectEmpty</a>(lprc)) {
00266         <span class="keywordflow">return</span> <a class="code" href="../../d9/d1/mmrtl_8c.html#a6">_MonitorFromPoint</a>(*(LPPOINT)lprc, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
00267     }
00268 
00269     <span class="comment">/*</span>
00270 <span class="comment">     * Return the primary monitor if the rectangle covers the desktop.</span>
00271 <span class="comment">     */</span>
00272     <span class="keywordflow">if</span> (    lprc-&gt;left   &lt;= pDispInfo-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o14">rcScreen</a>.left &amp;&amp;
00273             lprc-&gt;top    &lt;= pDispInfo-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o14">rcScreen</a>.top &amp;&amp;
00274             lprc-&gt;right  &gt;= pDispInfo-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o14">rcScreen</a>.right &amp;&amp;
00275             lprc-&gt;bottom &gt;= pDispInfo-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o14">rcScreen</a>.bottom) {
00276 
00277         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a793">GetPrimaryMonitor</a>();
00278     }
00279 
00280     <span class="comment">/*</span>
00281 <span class="comment">     * Calculate the nearest rectangle by determining which</span>
00282 <span class="comment">     * monitor has the greatest intersection with the rectangle.</span>
00283 <span class="comment">     */</span>
00284 
00285     <a class="code" href="../../d9/d1/mmrtl_8c.html#a1">BEGIN_EXCEPTION_HANDLER</a>
00286 
00287     areaMost = 0;
00288     <span class="keywordflow">for</span> (   pMonitor = <a class="code" href="../../d4/d1/userk_8h.html#a751">REBASESHAREDPTRALWAYS</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a792">GetDispInfo</a>()-&gt;pMonitorFirst);
00289             pMonitor;
00290             pMonitor = <a class="code" href="../../d4/d1/userk_8h.html#a750">REBASESHAREDPTR</a>(pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o1">pMonitorNext</a>)) {
00291 
00292         <span class="keywordflow">if</span> (!(pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o2">dwMONFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a525">MONF_VISIBLE</a>))
00293             <span class="keywordflow">continue</span>;
00294 
00295         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rc, lprc, &amp;((<a class="code" href="../../d0/d2/structtagMONITOR.html">MONITOR</a> *)pMonitor)-&gt;rcMonitor)) {
00296             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a34">EqualRect</a>(&amp;rc, lprc))
00297                 <span class="keywordflow">return</span> pMonitor;
00298 
00299             <span class="comment">/*</span>
00300 <span class="comment">             * Calculate the area of the intersection. Note that</span>
00301 <span class="comment">             * the intersection must be in 16bit coordinats, since</span>
00302 <span class="comment">             * we limit monitor rects to 16bit coordinate space.</span>
00303 <span class="comment">             * So the result of any area calculation will fit in</span>
00304 <span class="comment">             * in an int.</span>
00305 <span class="comment">             */</span>
00306             area = (rc.right - rc.left) * (rc.bottom - rc.top);
00307             <span class="keywordflow">if</span> (area &gt; areaMost) {
00308                 areaMost = area;
00309                 pMonitorResult = pMonitor;
00310             }
00311         }
00312     }
00313 
00314     <a class="code" href="../../d9/d1/mmrtl_8c.html#a2">END_EXCEPTION_HANDLER</a>
00315 
00316     UserAssert(areaMost &gt;= 0);
00317     <span class="keywordflow">if</span> (areaMost &gt; 0)
00318         <span class="keywordflow">return</span> pMonitorResult;
00319 
00320 
00321     <span class="keywordflow">switch</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>) {
00322     <span class="keywordflow">case</span> MONITOR_DEFAULTTONULL:
00323         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00324 
00325     <span class="keywordflow">case</span> MONITOR_DEFAULTTOPRIMARY:
00326         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a793">GetPrimaryMonitor</a>();
00327 
00328     <span class="keywordflow">case</span> MONITOR_DEFAULTTONEAREST:
00329         {
00330             <span class="keywordtype">int</span> dx, dy;
00331 
00332 <span class="preprocessor">#define MONITORFROMRECTALGORITHM(SUMSQUARESMAX, SUMSQUARESTYPE, POINTMULTIPLY)      \</span>
00333 <span class="preprocessor">            SUMSQUARESTYPE  sumsquare;                                              \</span>
00334 <span class="preprocessor">            SUMSQUARESTYPE  leastsumsquare;                                         \</span>
00335 <span class="preprocessor">            leastsumsquare = SUMSQUARESMAX;                                         \</span>
00336 <span class="preprocessor">            for (   pMonitor = REBASESHAREDPTRALWAYS(GetDispInfo()-&gt;pMonitorFirst); \</span>
00337 <span class="preprocessor">                    pMonitor;                                                       \</span>
00338 <span class="preprocessor">                    pMonitor = REBASESHAREDPTR(pMonitor-&gt;pMonitorNext)) {           \</span>
00339 <span class="preprocessor">                                                                                    \</span>
00340 <span class="preprocessor">                if (!(pMonitor-&gt;dwMONFlags &amp; MONF_VISIBLE))                         \</span>
00341 <span class="preprocessor">                    continue;                                                       \</span>
00342 <span class="preprocessor">                                                                                    \</span>
00343 <span class="preprocessor">                </span><span class="comment">/*                                                                  \</span>
00344 <span class="comment">                 * Determine distance from monitor along x axis.                    \</span>
00345 <span class="comment">                 */</span>                                                                 \
00346                 if (lprc-&gt;right &lt;= pMonitor-&gt;rcMonitor.left) {                      \
00347                     <span class="comment">/*                                                              \</span>
00348 <span class="comment">                     * Add 1 because rectangles do not include the rightmost edge.  \</span>
00349 <span class="comment">                     */</span>                                                             \
00350                     dx = pMonitor-&gt;rcMonitor.left - lprc-&gt;right + 1;                \
00351                 } else if (lprc-&gt;left &lt; pMonitor-&gt;rcMonitor.right) {                \
00352                     dx = 0;                                                         \
00353                 } else {                                                            \
00354                     <span class="comment">/*                                                              \</span>
00355 <span class="comment">                     * Add 1 because rectangles do not include the rightmost edge.  \</span>
00356 <span class="comment">                     */</span>                                                             \
00357                     dx = lprc-&gt;left - (pMonitor-&gt;rcMonitor.right - 1);              \
00358                 }                                                                   \
00359                                                                                     \
00360                 <span class="comment">/*                                                                  \</span>
00361 <span class="comment">                 * Skip this monitor if dx is greater than dx^2 + dy^2.             \</span>
00362 <span class="comment">                 * We do this check to avoid multiplication operations.             \</span>
00363 <span class="comment">                 */</span>                                                                 \
00364                 if ((SUMSQUARESTYPE) dx &gt;= leastsumsquare)                          \
00365                     continue;                                                       \
00366                                                                                     \
00367                 <span class="comment">/*                                                                  \</span>
00368 <span class="comment">                 * Determine distance from monitor along y axis.                    \</span>
00369 <span class="comment">                 */</span>                                                                 \
00370                 if (lprc-&gt;bottom &lt;= pMonitor-&gt;rcMonitor.top) {                      \
00371                     <span class="comment">/*                                                              \</span>
00372 <span class="comment">                     * Add 1 because rectangles do not include the bottommost edge. \</span>
00373 <span class="comment">                     */</span>                                                             \
00374                     dy = pMonitor-&gt;rcMonitor.top - lprc-&gt;bottom + 1;                \
00375                 } else if (lprc-&gt;top &lt; pMonitor-&gt;rcMonitor.bottom) {                \
00376                     UserAssert(dx != 0 &amp;&amp; "This rectangle intersects a monitor, so we shouldn't be here."); \
00377                     dy = 0;                                                         \
00378                 } else {                                                            \
00379                     <span class="comment">/*                                                              \</span>
00380 <span class="comment">                     * Add 1 because rectangles do not include the bottommost edge. \</span>
00381 <span class="comment">                     */</span>                                                             \
00382                     dy = lprc-&gt;top - pMonitor-&gt;rcMonitor.bottom + 1;                \
00383                 }                                                                   \
00384                                                                                     \
00385                 <span class="comment">/*                                                                  \</span>
00386 <span class="comment">                 * Calculate dx^2. Skip this monitor if dx is greater               \</span>
00387 <span class="comment">                 * than dx^2 + dy^2. We do this check to avoid                      \</span>
00388 <span class="comment">                 * multiplication operations.                                       \</span>
00389 <span class="comment">                 */</span>                                                                 \
00390                 sumsquare = POINTMULTIPLY(dx, dx);                                  \
00391                 if (sumsquare &gt;= leastsumsquare)                                    \
00392                     continue;                                                       \
00393                                                                                     \
00394                 <span class="comment">/*                                                                  \</span>
00395 <span class="comment">                 * Skip this monitor if dx^2 + y is greater than dx^2 + dy^2.       \</span>
00396 <span class="comment">                 * We do this check to avoid multiplication operations.             \</span>
00397 <span class="comment">                 */</span>                                                                 \
00398                 if (sumsquare + (SUMSQUARESTYPE) dy &gt;= leastsumsquare)              \
00399                     continue;                                                       \
00400                                                                                     \
00401                 <span class="comment">/*                                                                  \</span>
00402 <span class="comment">                 * Compute dx^2 + dy^2. Skip this monitor if it's not the least.    \</span>
00403 <span class="comment">                 */</span>                                                                 \
00404                 sumsquare += (SUMSQUARESTYPE) POINTMULTIPLY(dy, dy);                \
00405                 if (sumsquare &gt;= leastsumsquare)                                    \
00406                     continue;                                                       \
00407                                                                                     \
00408                 <span class="comment">/*                                                                  \</span>
00409 <span class="comment">                 * This is the closest monitor so far.                              \</span>
00410 <span class="comment">                 */</span>                                                                 \
00411                 leastsumsquare = sumsquare;                                         \
00412                 pMonitorResult = pMonitor;                                          \
00413             }
00414 
00415 <span class="preprocessor">#if DBG</span>
00416 <span class="preprocessor"></span>            pMonitorResult = (<a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>) -1;
00417 <span class="preprocessor">#endif</span>
00418 <span class="preprocessor"></span>
00419             <span class="keywordflow">if</span> (    lprc-&gt;left &lt; SHRT_MIN || SHRT_MAX &lt; lprc-&gt;left ||
00420                     lprc-&gt;top &lt; SHRT_MIN || SHRT_MAX &lt; lprc-&gt;top ||
00421                     lprc-&gt;right &lt; SHRT_MIN || SHRT_MAX &lt; lprc-&gt;right ||
00422                     lprc-&gt;bottom &lt; SHRT_MIN || SHRT_MAX &lt; lprc-&gt;bottom) {
00423 
00424                 <a class="code" href="../../d9/d1/mmrtl_8c.html#a1">BEGIN_EXCEPTION_HANDLER</a>
00425                 <a class="code" href="../../d9/d1/mmrtl_8c.html#a5">MONITORFROMRECTALGORITHM</a>(_UI64_MAX, ULONGLONG, Int32x32To64)
<a name="l00426"></a><a class="code" href="../../d9/d1/mmrtl_8c.html#a8">00426</a>                 END_EXCEPTION_HANDLER
00427 
00428             } else {
00429 
00430                 <a class="code" href="../../d9/d1/mmrtl_8c.html#a1">BEGIN_EXCEPTION_HANDLER</a>
00431                 <a class="code" href="../../d9/d1/mmrtl_8c.html#a5">MONITORFROMRECTALGORITHM</a>(UINT_MAX, <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>, <a class="code" href="../../d9/d1/mmrtl_8c.html#a0">Int32x32To32</a>)
00432                 <a class="code" href="../../d9/d1/mmrtl_8c.html#a2">END_EXCEPTION_HANDLER</a>
00433 
00434             }
00435 
00436             UserAssert(pMonitorResult != (<a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>) -1);
00437             <span class="keywordflow">return</span> pMonitorResult;
00438         }
00439 
00440     <span class="keywordflow">default</span>:
00441         UserAssertMsg0(0, <span class="stringliteral">"Logic error in _MonitorFromWindow, shouldn't have gotten here."</span>);
00442         <span class="keywordflow">break</span>;
00443     }
00444 
00445     UserAssertMsg0(0, <span class="stringliteral">"Logic error in _MonitorFromWindow, shouldn't have gotten here."</span>);
00446     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00447 }
00448 
00449 
00450 
00451 <span class="comment">/***************************************************************************\</span>
00452 <span class="comment">* _MonitorFromWindow</span>
00453 <span class="comment">*</span>
00454 <span class="comment">* Calculate the monitor that a window is in or is nearest to. We use</span>
00455 <span class="comment">* the center of the window to determine its location. If the window</span>
00456 <span class="comment">* is minimized, use its normal position.</span>
00457 <span class="comment">*</span>
00458 <span class="comment">* Arguments:</span>
00459 <span class="comment">*     pwnd    - The window.</span>
00460 <span class="comment">*     dwFlags - One of:</span>
00461 <span class="comment">*         MONITOR_DEFAULTTONULL - If the window doesn't intersect a monitor,</span>
00462 <span class="comment">*             return NULL.</span>
00463 <span class="comment">*</span>
00464 <span class="comment">*         MONITOR_DEFAULTTOPRIMARY - If the window doesn't intersect a monitor,</span>
00465 <span class="comment">*             return the primary monitor.</span>
00466 <span class="comment">*</span>
00467 <span class="comment">*         MONITOR_DEFAULTTONEAREST - Return the monitor nearest the window.</span>
00468 <span class="comment">*</span>
00469 <span class="comment">* History:</span>
00470 <span class="comment">* 22-Sep-1996 adams     Created.</span>
00471 <span class="comment">* 29-Mar-1997 adams     Moved to rtl.</span>
00472 <span class="comment">\***************************************************************************/</span>
00473 
00474 <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>
00475 <a class="code" href="../../d9/d1/mmrtl_8c.html#a8">_MonitorFromWindow</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, DWORD dwFlags)
00476 {
00477     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>            pwndParent;
00478 
00479     UserAssert(dwFlags == MONITOR_DEFAULTTONULL ||
00480                dwFlags == MONITOR_DEFAULTTOPRIMARY ||
00481                dwFlags == MONITOR_DEFAULTTONEAREST);
00482 
00483     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a792">GetDispInfo</a>()-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o11">cMonitors</a> == 1 &amp;&amp; <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> != MONITOR_DEFAULTTONULL) {
00484         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a793">GetPrimaryMonitor</a>();
00485     }
00486 
00487     <span class="keywordflow">if</span> (!pwnd)
00488         <span class="keywordflow">goto</span> NoWindow;
00489 
00490     <span class="comment">/*</span>
00491 <span class="comment">     * Handle minimized windows.</span>
00492 <span class="comment">     */</span>
00493     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFMINIMIZED))
00494     {
00495 <span class="preprocessor">#ifdef _USERK_</span>
00496 <span class="preprocessor"></span>        <a class="code" href="../../d0/d0/structtagCHECKPOINT.html">CHECKPOINT</a> *    pcp;
00497 
00498         pcp = (<a class="code" href="../../d0/d0/structtagCHECKPOINT.html">CHECKPOINT</a> *)<a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pwnd, PROP_CHECKPOINT, PROPF_INTERNAL);
00499         <span class="keywordflow">if</span> (pcp) {
00500             <span class="keywordflow">return</span> <a class="code" href="../../d9/d1/mmrtl_8c.html#a7">_MonitorFromRect</a>(&amp;pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o0">rcNormal</a>, dwFlags);
00501         }
00502 <span class="preprocessor">#else</span>
00503 <span class="preprocessor"></span>        WINDOWPLACEMENT wp;
00504         HWND            hwnd;
00505 
00506         wp.length = <span class="keyword">sizeof</span>(wp);
00507         hwnd = (HWND)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pwnd);
00508         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a238">GetWindowPlacement</a>(hwnd, &amp;wp)) {
00509             <span class="keywordflow">return</span> <a class="code" href="../../d9/d1/mmrtl_8c.html#a7">_MonitorFromRect</a>(&amp;wp.rcNormalPosition, dwFlags);
00510         }
00511 
00512         <span class="comment">/*</span>
00513 <span class="comment">         * (adams) If GetWindowPlacement fails, then either there was not enough</span>
00514 <span class="comment">         * memory to allocate a CHECKPOINT, or the window was destroyed</span>
00515 <span class="comment">         * and the API failed. If the later, the following code my be</span>
00516 <span class="comment">         * playing with invalid memory. Although on the client side we</span>
00517 <span class="comment">         * can never guarantee that a window is valid, it seems especially</span>
00518 <span class="comment">         * likely that it is invalid here. So do another revalidation</span>
00519 <span class="comment">         * by calling IsWindow.</span>
00520 <span class="comment">         */</span>
00521         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(hwnd))
00522             <span class="keywordflow">goto</span> NoWindow;
00523 <span class="preprocessor">#endif</span>
00524 <span class="preprocessor"></span>
00525         UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd) != FNID_DESKTOP);
00526         pwndParent = <a class="code" href="../../d6/d0/usercli_8h.html#a27">REBASEPWND</a>(pwnd, spwndParent);
00527         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwndParent) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a196">FNID_DESKTOP</a>) {
00528             <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a793">GetPrimaryMonitor</a>();
00529         }
00530 
00531         <span class="comment">/*</span>
00532 <span class="comment">         * Otherwise, if we are a child window, fall thru below to use the</span>
00533 <span class="comment">         * window rect, which actually means something for non-toplevel dudes.</span>
00534 <span class="comment">         */</span>
00535     }
00536 
00537     <span class="keywordflow">return</span> <a class="code" href="../../d9/d1/mmrtl_8c.html#a7">_MonitorFromRect</a>(&amp;((<a class="code" href="../../d6/d9/structtagWND.html">WND</a> *)pwnd)-&gt;rcWindow, dwFlags);
00538 
00539 NoWindow:
00540     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; (MONITOR_DEFAULTTOPRIMARY | MONITOR_DEFAULTTONEAREST)) {
00541         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a793">GetPrimaryMonitor</a>();
00542     }
00543 
00544     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00545 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:50 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
