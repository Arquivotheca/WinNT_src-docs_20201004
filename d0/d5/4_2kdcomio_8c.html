<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: 4/kdcomio.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>kdcomio.c File Reference</h1><code>#include "<a class="el" href="../../d2/d6/4_2kdp_8h-source.html">kdp.h</a>"</code><br>

<p>
<a href="../../d1/d4/4_2kdcomio_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/4_2kdcomio_8c.html#a0">KdpComputeChecksum</a> (IN PUCHAR <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN ULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/4_2kdcomio_8c.html#a1">KdpReceiveString</a> (OUT PCHAR Destination, IN ULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/4_2kdcomio_8c.html#a2">KdpSendString</a> (IN PCHAR Source, IN ULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/4_2kdcomio_8c.html#a3">KdpSendControlPacket</a> (IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> PacketType, IN ULONG PacketId OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/4_2kdcomio_8c.html#a4">KdpReceivePacketLeader</a> (IN ULONG PacketType, OUT PULONG PacketLeader)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/4_2kdcomio_8c.html#a5">KdpReceivePacket</a> (IN ULONG PacketType, OUT PSTRING MessageHeader, OUT PSTRING MessageData, OUT PULONG DataLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/4_2kdcomio_8c.html#a6">KdpSendPacket</a> (IN ULONG PacketType, IN PSTRING MessageHeader, IN PSTRING MessageData OPTIONAL)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a0" doxytag="4/kdcomio.c::KdpComputeChecksum" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG KdpComputeChecksum           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00342">KdpReceivePacket()</a>, and <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00683">KdpSendPacket()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="4/kdcomio.c::KdpReceivePacket" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG KdpReceivePacket           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PacketType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>MessageHeader</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>MessageData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DataLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/4_2kdcomio_8c-source.html#l00343">343</a> of file <a class="el" href="../../d1/d4/4_2kdcomio_8c-source.html">4/kdcomio.c</a>.
<p>
References <a class="el" href="../../d8/d2/kd_8h-source.html#l00032">CP_GET_ERROR</a>, <a class="el" href="../../d8/d2/kd_8h-source.html#l00031">CP_GET_NODATA</a>, <a class="el" href="../../d8/d2/kd_8h-source.html#l00030">CP_GET_SUCCESS</a>, <a class="el" href="../../d1/d6/kdp_8h-source.html#l00062">KDP_PACKET_RECEIVED</a>, <a class="el" href="../../d1/d6/kdp_8h-source.html#l00064">KDP_PACKET_RESEND</a>, <a class="el" href="../../d1/d6/kdp_8h-source.html#l00063">KDP_PACKET_TIMEOUT</a>, <a class="el" href="../../d0/d5/4_2kdcomio_8c.html#a0">KdpComputeChecksum()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00264">KdpNextPacketIdToSend</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00258">KdpNumberRetries</a>, <a class="el" href="../../d2/d7/hal_8h.html#a200">KdPortGetByte()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00265">KdpPacketIdExpected</a>, <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00095">KdpReceivePacketLeader()</a>, <a class="el" href="../../d0/d5/4_2kdcomio_8c.html#a1">KdpReceiveString()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00257">KdpRetryCount</a>, <a class="el" href="../../d0/d5/4_2kdcomio_8c.html#a3">KdpSendControlPacket()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d1/d5/kddbgio_8c-source.html#l00110">KdpPromptString()</a>, <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00683">KdpSendPacket()</a>, and <a class="el" href="../../d9/d2/kdapi_8c-source.html#l00847">KdpSendWaitContinue()</a>.
<p>
<pre class="fragment"><div>00352                    :
00353 
00354     This routine receives a packet from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> host machine that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> running
00355     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel debugger <a class="code" href="../../d1/d9/icmui_8def.html#a6">UI</a>.  This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ALWAYS called after packet being
00356     sent by caller.  It first waits <span class="keywordflow">for</span> ACK packet <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> packet sent and
00357     then waits <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> packet desired.
00358 
00359     N.B. If caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> KdPrintString, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parameter PacketType <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00360        PACKET_TYPE_KD_ACKNOWLEDGE.  In <span class="keyword">this</span> <span class="keywordflow">case</span>, <span class="keyword">this</span> routine will <span class="keywordflow">return</span>
00361        right after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ack packet <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> received.
00362 
00363 Arguments:
00364 
00365     PacketType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of packet that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> excepted.
00366 
00367     MessageHeader - Supplies a pointer to a string descriptor <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input
00368         message.
00369 
00370     MessageData - Supplies a pointer to a string descriptor <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input data.
00371 
00372     DataLength - Supplies pointer to ULONG to receive length of recv. data.
00373 
00374 Return Value:
00375 
00376     <a class="code" href="../../d0/d7/kdp_8h.html#a11">KDP_PACKET_RESEND</a> - <span class="keywordflow">if</span> resend <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required.
00377     KDP_PAKCET_TIMEOUT - <span class="keywordflow">if</span> timeout.
00378     <a class="code" href="../../d0/d7/kdp_8h.html#a9">KDP_PACKET_RECEIVED</a> - <span class="keywordflow">if</span> packet received.
00379 
00380 --*/
00381 
00382 {
00383 
00384     UCHAR Input;
00385     ULONG MessageLength;
00386     KD_PACKET PacketHeader;
00387     ULONG ReturnCode;
00388     ULONG Checksum;
00389 
00390 WaitForPacketLeader:
00391 
00392     <span class="comment">//</span>
00393     <span class="comment">// Read Packet Leader</span>
00394     <span class="comment">//</span>
00395 
00396     ReturnCode = <a class="code" href="../../d1/d7/4_2kdp_8h.html#a148">KdpReceivePacketLeader</a>(PacketType, &amp;PacketHeader.PacketLeader);
00397 
00398     <span class="comment">//</span>
00399     <span class="comment">// If we can successfully read packet leader, it has high possibility that</span>
00400     <span class="comment">// kernel debugger is alive.  So reset count.</span>
00401     <span class="comment">//</span>
00402 
00403     <span class="keywordflow">if</span> (ReturnCode != <a class="code" href="../../d0/d7/kdp_8h.html#a10">KDP_PACKET_TIMEOUT</a>) {
00404         <a class="code" href="../../d8/d5/kddata_8c.html#a88">KdpNumberRetries</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a87">KdpRetryCount</a>;
00405     }
00406     <span class="keywordflow">if</span> (ReturnCode != <a class="code" href="../../d0/d7/kdp_8h.html#a9">KDP_PACKET_RECEIVED</a>) {
00407         <span class="keywordflow">return</span> ReturnCode;
00408     }
00409 
00410     <span class="comment">//</span>
00411     <span class="comment">// Read packet type.</span>
00412     <span class="comment">//</span>
00413 
00414     ReturnCode = <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a1">KdpReceiveString</a>((PCHAR)&amp;PacketHeader.PacketType,
00415                                   <span class="keyword">sizeof</span>(PacketHeader.PacketType));
00416     <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d7/d3/kd_8h.html#a1">CP_GET_NODATA</a>) {
00417         <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a10">KDP_PACKET_TIMEOUT</a>;
00418     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d7/d3/kd_8h.html#a2">CP_GET_ERROR</a>) {
00419         <span class="keywordflow">if</span> (PacketHeader.PacketLeader == CONTROL_PACKET_LEADER) {
00420 
00421             <span class="comment">//</span>
00422             <span class="comment">// If read error and it is for a control packet, simply</span>
00423             <span class="comment">// preptend that we have not seen this packet.  Hopefully</span>
00424             <span class="comment">// we will receive the packet we desire which automatically acks</span>
00425             <span class="comment">// the packet we just sent.</span>
00426             <span class="comment">//</span>
00427 
00428             <span class="keywordflow">goto</span> WaitForPacketLeader;
00429         } <span class="keywordflow">else</span> {
00430 
00431             <span class="comment">//</span>
00432             <span class="comment">// if read error while reading data packet, we have to ask</span>
00433             <span class="comment">// kernel debugger to resend us the packet.</span>
00434             <span class="comment">//</span>
00435 
00436             <span class="keywordflow">goto</span> SendResendPacket;
00437         }
00438     }
00439 
00440     <span class="comment">//</span>
00441     <span class="comment">// if the packet we received is a resend request, we return true and</span>
00442     <span class="comment">// let caller resend the packet.</span>
00443     <span class="comment">//</span>
00444 
00445     <span class="keywordflow">if</span> ( PacketHeader.PacketLeader == CONTROL_PACKET_LEADER &amp;&amp;
00446          PacketHeader.PacketType == PACKET_TYPE_KD_RESEND ) {
00447         <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a11">KDP_PACKET_RESEND</a>;
00448     }
00449 
00450     <span class="comment">//</span>
00451     <span class="comment">// Read data length.</span>
00452     <span class="comment">//</span>
00453 
00454     ReturnCode = <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a1">KdpReceiveString</a>((PCHAR)&amp;PacketHeader.ByteCount,
00455                                   <span class="keyword">sizeof</span>(PacketHeader.ByteCount));
00456     <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d7/d3/kd_8h.html#a1">CP_GET_NODATA</a>) {
00457         <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a10">KDP_PACKET_TIMEOUT</a>;
00458     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d7/d3/kd_8h.html#a2">CP_GET_ERROR</a>) {
00459         <span class="keywordflow">if</span> (PacketHeader.PacketLeader == CONTROL_PACKET_LEADER) {
00460             <span class="keywordflow">goto</span> WaitForPacketLeader;
00461         } <span class="keywordflow">else</span> {
00462             <span class="keywordflow">goto</span> SendResendPacket;
00463         }
00464     }
00465 
00466     <span class="comment">//</span>
00467     <span class="comment">// Read Packet Id.</span>
00468     <span class="comment">//</span>
00469 
00470     ReturnCode = <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a1">KdpReceiveString</a>((PCHAR)&amp;PacketHeader.PacketId,
00471                                   <span class="keyword">sizeof</span>(PacketHeader.PacketId));
00472 
00473     <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d7/d3/kd_8h.html#a1">CP_GET_NODATA</a>) {
00474         <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a10">KDP_PACKET_TIMEOUT</a>;
00475     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d7/d3/kd_8h.html#a2">CP_GET_ERROR</a>) {
00476         <span class="keywordflow">if</span> (PacketHeader.PacketLeader == CONTROL_PACKET_LEADER) {
00477             <span class="keywordflow">goto</span> WaitForPacketLeader;
00478         } <span class="keywordflow">else</span> {
00479             <span class="keywordflow">goto</span> SendResendPacket;
00480         }
00481     }
00482 
00483     <span class="comment">//</span>
00484     <span class="comment">// Read packet checksum.</span>
00485     <span class="comment">//</span>
00486 
00487     ReturnCode = <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a1">KdpReceiveString</a>((PCHAR)&amp;PacketHeader.Checksum,
00488                                   <span class="keyword">sizeof</span>(PacketHeader.Checksum));
00489     <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d7/d3/kd_8h.html#a1">CP_GET_NODATA</a>) {
00490         <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a10">KDP_PACKET_TIMEOUT</a>;
00491     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d7/d3/kd_8h.html#a2">CP_GET_ERROR</a>) {
00492         <span class="keywordflow">if</span> (PacketHeader.PacketLeader == CONTROL_PACKET_LEADER) {
00493             <span class="keywordflow">goto</span> WaitForPacketLeader;
00494         } <span class="keywordflow">else</span> {
00495             <span class="keywordflow">goto</span> SendResendPacket;
00496         }
00497     }
00498 
00499     <span class="comment">//</span>
00500     <span class="comment">// A complete packet header is received.  Check its validity and</span>
00501     <span class="comment">// perform appropriate action depending on packet type.</span>
00502     <span class="comment">//</span>
00503 
00504     <span class="keywordflow">if</span> (PacketHeader.PacketLeader == CONTROL_PACKET_LEADER ) {
00505         <span class="keywordflow">if</span> (PacketHeader.PacketType == PACKET_TYPE_KD_ACKNOWLEDGE ) {
00506 
00507             <span class="comment">//</span>
00508             <span class="comment">// If we received an expected ACK packet and we are not</span>
00509             <span class="comment">// waiting for any new packet, update outgoing packet id</span>
00510             <span class="comment">// and return.  If we are NOT waiting for ACK packet</span>
00511             <span class="comment">// we will keep on waiting.  If the ACK packet</span>
00512             <span class="comment">// is not for the packet we send, ignore it and keep on waiting.</span>
00513             <span class="comment">//</span>
00514 
00515             <span class="keywordflow">if</span> (PacketHeader.PacketId !=
00516                 (<a class="code" href="../../d8/d5/kddata_8c.html#a92">KdpNextPacketIdToSend</a> &amp; ~SYNC_PACKET_ID))  {
00517                 <span class="keywordflow">goto</span> WaitForPacketLeader;
00518             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PacketType == PACKET_TYPE_KD_ACKNOWLEDGE) {
00519                 <a class="code" href="../../d8/d5/kddata_8c.html#a92">KdpNextPacketIdToSend</a> ^= 1;
00520                 <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a9">KDP_PACKET_RECEIVED</a>;
00521             } <span class="keywordflow">else</span> {
00522                 <span class="keywordflow">goto</span> WaitForPacketLeader;
00523             }
00524         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PacketHeader.PacketType == PACKET_TYPE_KD_RESET) {
00525 
00526             <span class="comment">//</span>
00527             <span class="comment">// if we received Reset packet, reset the packet control variables</span>
00528             <span class="comment">// and resend earlier packet.</span>
00529             <span class="comment">//</span>
00530 
00531             <a class="code" href="../../d8/d5/kddata_8c.html#a92">KdpNextPacketIdToSend</a> = INITIAL_PACKET_ID;
00532             <a class="code" href="../../d8/d5/kddata_8c.html#a93">KdpPacketIdExpected</a> = INITIAL_PACKET_ID;
00533             <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a3">KdpSendControlPacket</a>(PACKET_TYPE_KD_RESET, 0L);
00534             <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a11">KDP_PACKET_RESEND</a>;
00535         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PacketHeader.PacketType == PACKET_TYPE_KD_RESEND) {
00536             <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a11">KDP_PACKET_RESEND</a>;
00537         } <span class="keywordflow">else</span> {
00538 
00539             <span class="comment">//</span>
00540             <span class="comment">// Invalid packet header, ignore it.</span>
00541             <span class="comment">//</span>
00542 
00543             <span class="keywordflow">goto</span> WaitForPacketLeader;
00544         }
00545 
00546     <span class="comment">//</span>
00547     <span class="comment">// The packet header is for data packet (not control packet).</span>
00548     <span class="comment">//</span>
00549 
00550     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PacketType == PACKET_TYPE_KD_ACKNOWLEDGE) {
00551 
00552         <span class="comment">//</span>
00553         <span class="comment">// if we are waiting for ACK packet ONLY</span>
00554         <span class="comment">// and we receive a data packet header, check if the packet id</span>
00555         <span class="comment">// is what we expected.  If yes, assume the acknowledge is lost (but</span>
00556         <span class="comment">// sent), ask sender to resend and return with PACKET_RECEIVED.</span>
00557         <span class="comment">//</span>
00558 
00559         <span class="keywordflow">if</span> (PacketHeader.PacketId == <a class="code" href="../../d8/d5/kddata_8c.html#a93">KdpPacketIdExpected</a>) {
00560             <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a3">KdpSendControlPacket</a>(PACKET_TYPE_KD_RESEND, 0L);
00561             <a class="code" href="../../d8/d5/kddata_8c.html#a92">KdpNextPacketIdToSend</a> ^= 1;
00562             <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a9">KDP_PACKET_RECEIVED</a>;
00563         } <span class="keywordflow">else</span> {
00564             <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a3">KdpSendControlPacket</a>(PACKET_TYPE_KD_ACKNOWLEDGE,
00565                                  PacketHeader.PacketId
00566                                  );
00567             <span class="keywordflow">goto</span> WaitForPacketLeader;
00568         }
00569     }
00570 
00571     <span class="comment">//</span>
00572     <span class="comment">// we are waiting for data packet and we received the packet header</span>
00573     <span class="comment">// for data packet. Perform the following checkings to make sure</span>
00574     <span class="comment">// it is the packet we are waiting for.</span>
00575     <span class="comment">//</span>
00576 
00577     <span class="comment">//</span>
00578     <span class="comment">// Check ByteCount received is valid</span>
00579     <span class="comment">//</span>
00580 
00581     MessageLength = MessageHeader-&gt;MaximumLength;
00582     <span class="keywordflow">if</span> ((PacketHeader.ByteCount &gt; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)PACKET_MAX_SIZE) ||
00583         (PacketHeader.ByteCount &lt; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)MessageLength)) {
00584         <span class="keywordflow">goto</span> SendResendPacket;
00585     }
00586     *DataLength = PacketHeader.ByteCount - MessageLength;
00587 
00588     <span class="comment">//</span>
00589     <span class="comment">// Read the message header.</span>
00590     <span class="comment">//</span>
00591 
00592     ReturnCode = <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a1">KdpReceiveString</a>(MessageHeader-&gt;Buffer, MessageLength);
00593     <span class="keywordflow">if</span> (ReturnCode != <a class="code" href="../../d7/d3/kd_8h.html#a0">CP_GET_SUCCESS</a>) {
00594         <span class="keywordflow">goto</span> SendResendPacket;
00595     }
00596     MessageHeader-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)MessageLength;
00597 
00598     <span class="comment">//</span>
00599     <span class="comment">// Read the message data.</span>
00600     <span class="comment">//</span>
00601 
00602     ReturnCode = <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a1">KdpReceiveString</a>(MessageData-&gt;Buffer, *DataLength);
00603     <span class="keywordflow">if</span> (ReturnCode != <a class="code" href="../../d7/d3/kd_8h.html#a0">CP_GET_SUCCESS</a>) {
00604         <span class="keywordflow">goto</span> SendResendPacket;
00605     }
00606     MessageData-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)*DataLength;
00607 
00608     <span class="comment">//</span>
00609     <span class="comment">// Read packet trailing byte</span>
00610     <span class="comment">//</span>
00611 
00612     ReturnCode = <a class="code" href="../../d2/d7/hal_8h.html#a200">KdPortGetByte</a>(&amp;Input);
00613     <span class="keywordflow">if</span> (ReturnCode != <a class="code" href="../../d7/d3/kd_8h.html#a0">CP_GET_SUCCESS</a> || Input != PACKET_TRAILING_BYTE) {
00614         <span class="keywordflow">goto</span> SendResendPacket;
00615     }
00616 
00617     <span class="comment">//</span>
00618     <span class="comment">// Check PacketType is what we are waiting for.</span>
00619     <span class="comment">//</span>
00620 
00621     <span class="keywordflow">if</span> (PacketType != PacketHeader.PacketType) {
00622         <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a3">KdpSendControlPacket</a>(PACKET_TYPE_KD_ACKNOWLEDGE,
00623                              PacketHeader.PacketId
00624                              );
00625         <span class="keywordflow">goto</span> WaitForPacketLeader;
00626     }
00627 
00628     <span class="comment">//</span>
00629     <span class="comment">// Check PacketId is valid.</span>
00630     <span class="comment">//</span>
00631 
00632     <span class="keywordflow">if</span> (PacketHeader.PacketId == INITIAL_PACKET_ID ||
00633         PacketHeader.PacketId == (INITIAL_PACKET_ID ^ 1)) {
00634         <span class="keywordflow">if</span> (PacketHeader.PacketId != <a class="code" href="../../d8/d5/kddata_8c.html#a93">KdpPacketIdExpected</a>) {
00635             <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a3">KdpSendControlPacket</a>(PACKET_TYPE_KD_ACKNOWLEDGE,
00636                                  PacketHeader.PacketId
00637                                  );
00638             <span class="keywordflow">goto</span> WaitForPacketLeader;
00639         }
00640     } <span class="keywordflow">else</span> {
00641         <span class="keywordflow">goto</span> SendResendPacket;
00642     }
00643 
00644     <span class="comment">//</span>
00645     <span class="comment">// Check checksum is valid.</span>
00646     <span class="comment">//</span>
00647 
00648     Checksum = <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a0">KdpComputeChecksum</a>(
00649                             MessageHeader-&gt;Buffer,
00650                             MessageHeader-&gt;Length
00651                             );
00652 
00653     Checksum += <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a0">KdpComputeChecksum</a>(
00654                             MessageData-&gt;Buffer,
00655                             MessageData-&gt;Length
00656                             );
00657     <span class="keywordflow">if</span> (Checksum != PacketHeader.Checksum) {
00658         <span class="keywordflow">goto</span> SendResendPacket;
00659     }
00660 
00661     <span class="comment">//</span>
00662     <span class="comment">// Send Acknowledge byte and the Id of the packet received.</span>
00663     <span class="comment">// Then, update the ExpectId for next incoming packet.</span>
00664     <span class="comment">//</span>
00665 
00666     <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a3">KdpSendControlPacket</a>(PACKET_TYPE_KD_ACKNOWLEDGE,
00667                          PacketHeader.PacketId
00668                          );
00669 
00670     <span class="comment">//</span>
00671     <span class="comment">// We have successfully received the packet so update the</span>
00672     <span class="comment">// packet control variables and return sucess.</span>
00673     <span class="comment">//</span>
00674 
00675     <a class="code" href="../../d8/d5/kddata_8c.html#a93">KdpPacketIdExpected</a> ^= 1;
00676     <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a9">KDP_PACKET_RECEIVED</a>;
00677 
00678 SendResendPacket:
00679     <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a3">KdpSendControlPacket</a>(PACKET_TYPE_KD_RESEND, 0L);
00680     <span class="keywordflow">goto</span> WaitForPacketLeader;
00681 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="4/kdcomio.c::KdpReceivePacketLeader" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> KdpReceivePacketLeader           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PacketType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PacketLeader</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/4_2kdcomio_8c-source.html#l00095">95</a> of file <a class="el" href="../../d1/d4/4_2kdcomio_8c-source.html">4/kdcomio.c</a>.
<p>
References <a class="el" href="../../d8/d2/kd_8h-source.html#l00032">CP_GET_ERROR</a>, <a class="el" href="../../d8/d2/kd_8h-source.html#l00031">CP_GET_NODATA</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d8/d2/kd_8h-source.html#l00133">KdDebuggerNotPresent</a>, <a class="el" href="../../d1/d6/kdp_8h-source.html#l00062">KDP_PACKET_RECEIVED</a>, <a class="el" href="../../d1/d6/kdp_8h-source.html#l00064">KDP_PACKET_RESEND</a>, <a class="el" href="../../d1/d6/kdp_8h-source.html#l00063">KDP_PACKET_TIMEOUT</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00260">KdpControlCPending</a>, <a class="el" href="../../d2/d7/hal_8h.html#a200">KdPortGetByte()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00342">KdpReceivePacket()</a>.
<p>
<pre class="fragment"><div>00102                    :
00103 
00104     This routine waits <span class="keywordflow">for</span> a packet header leader.
00105 
00106 Arguments:
00107 
00108     PacketType - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of packet we are expecting.
00109 
00110     PacketLeader - supplies a pointer to a ulong variable to receive
00111                    packet leader bytes.
00112 
00113 Return Value:
00114 
00115     <a class="code" href="../../d0/d7/kdp_8h.html#a11">KDP_PACKET_RESEND</a> - <span class="keywordflow">if</span> resend <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required.
00116     KDP_PAKCET_TIMEOUT - <span class="keywordflow">if</span> timeout.
00117     <a class="code" href="../../d0/d7/kdp_8h.html#a9">KDP_PACKET_RECEIVED</a> - <span class="keywordflow">if</span> packet received.
00118 
00119 --*/
00120 
00121 {
00122 
00123     UCHAR Input, PreviousByte = 0;
00124     ULONG PacketId = 0;
00125     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00126     ULONG ReturnCode;
00127     BOOLEAN BreakinDetected = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00128 
00129     <span class="comment">//</span>
00130     <span class="comment">// NOTE - With all the interrupts being off, it is very hard</span>
00131     <span class="comment">// to implement the actual timeout code. (Maybe, by reading the CMOS.)</span>
00132     <span class="comment">// Here we use a loop count to wait about 3 seconds.  The CpGetByte</span>
00133     <span class="comment">// will return with error code = CP_GET_NODATA if it cannot find data</span>
00134     <span class="comment">// byte within 1 second. Kernel debugger's timeout period is 5 seconds.</span>
00135     <span class="comment">//</span>
00136 
00137     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
00138     <span class="keywordflow">do</span> {
00139         ReturnCode = <a class="code" href="../../d2/d7/hal_8h.html#a200">KdPortGetByte</a>(&amp;Input);
00140         <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d7/d3/kd_8h.html#a1">CP_GET_NODATA</a>) {
00141             <span class="keywordflow">if</span> (BreakinDetected) {
00142                 <a class="code" href="../../d8/d5/kddata_8c.html#a89">KdpControlCPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00143                 <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a11">KDP_PACKET_RESEND</a>;
00144             } <span class="keywordflow">else</span> {
00145                 <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a10">KDP_PACKET_TIMEOUT</a>;
00146             }
00147         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d7/d3/kd_8h.html#a2">CP_GET_ERROR</a>) {
00148             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
00149             <span class="keywordflow">continue</span>;
00150         } <span class="keywordflow">else</span> {                    <span class="comment">// if (ReturnCode == CP_GET_SUCCESS)</span>
00151             <span class="keywordflow">if</span> ( Input == PACKET_LEADER_BYTE ||
00152                  Input == CONTROL_PACKET_LEADER_BYTE ) {
00153                 <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> == 0 ) {
00154                     PreviousByte = Input;
00155                     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++;
00156                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Input == PreviousByte ) {
00157                     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++;
00158                 } <span class="keywordflow">else</span> {
00159                     PreviousByte = Input;
00160                     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 1;
00161                 }
00162             } <span class="keywordflow">else</span> {
00163 
00164                 <span class="comment">//</span>
00165                 <span class="comment">// If we detect breakin character, we need to verify it</span>
00166                 <span class="comment">// validity.  (It is possible that we missed a packet leader</span>
00167                 <span class="comment">// and the breakin character is simply a data byte in the</span>
00168                 <span class="comment">// packet.)</span>
00169                 <span class="comment">// Since kernel debugger send out breakin character ONLY</span>
00170                 <span class="comment">// when it is waiting for State Change packet.  The breakin</span>
00171                 <span class="comment">// character should not be followed by any other character</span>
00172                 <span class="comment">// except packet leader byte.</span>
00173                 <span class="comment">//</span>
00174 
00175                 <span class="keywordflow">if</span> ( Input == BREAKIN_PACKET_BYTE ) {
00176                     BreakinDetected = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00177                 } <span class="keywordflow">else</span> {
00178 
00179                     <span class="comment">//</span>
00180                     <span class="comment">// The following statement is ABSOLUTELY necessary.</span>
00181                     <span class="comment">//</span>
00182 
00183                     BreakinDetected = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00184                 }
00185                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
00186             }
00187         }
00188     } <span class="keywordflow">while</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; 4 );
00189 
00190     <span class="keywordflow">if</span> (BreakinDetected) {
00191         <a class="code" href="../../d8/d5/kddata_8c.html#a89">KdpControlCPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00192     }
00193 
00194     <span class="comment">//</span>
00195     <span class="comment">// return the packet leader and FALSE to indicate no resend is needed.</span>
00196     <span class="comment">//</span>
00197 
00198     <span class="keywordflow">if</span> ( Input == PACKET_LEADER_BYTE ) {
00199         *PacketLeader = PACKET_LEADER;
00200     } <span class="keywordflow">else</span> {
00201         *PacketLeader = CONTROL_PACKET_LEADER;
00202     }
00203 
00204     <a class="code" href="../../d7/d3/kd_8h.html#a12">KdDebuggerNotPresent</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00205     SharedUserData-&gt;KdDebuggerEnabled |= 0x00000002;
00206     <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a9">KDP_PACKET_RECEIVED</a>;
00207 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="4/kdcomio.c::KdpReceiveString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG KdpReceiveString           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Destination</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00342">KdpReceivePacket()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="4/kdcomio.c::KdpSendControlPacket" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpSendControlPacket           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PacketType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG PacketId&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00342">KdpReceivePacket()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="4/kdcomio.c::KdpSendPacket" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpSendPacket           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PacketType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>MessageHeader</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING MessageData&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/4_2kdcomio_8c-source.html#l00684">684</a> of file <a class="el" href="../../d1/d4/4_2kdcomio_8c-source.html">4/kdcomio.c</a>.
<p>
References <a class="el" href="../../d8/d2/kd_8h-source.html#l00133">KdDebuggerNotPresent</a>, <a class="el" href="../../d1/d6/kdp_8h-source.html#l00062">KDP_PACKET_RECEIVED</a>, <a class="el" href="../../d1/d6/kdp_8h-source.html#l00063">KDP_PACKET_TIMEOUT</a>, <a class="el" href="../../d0/d5/4_2kdcomio_8c.html#a0">KdpComputeChecksum()</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00137">KdpDefaultRetries</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00264">KdpNextPacketIdToSend</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00258">KdpNumberRetries</a>, <a class="el" href="../../d2/d7/hal_8h.html#a202">KdPortPutByte()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00265">KdpPacketIdExpected</a>, <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00342">KdpReceivePacket()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00257">KdpRetryCount</a>, <a class="el" href="../../d0/d5/4_2kdcomio_8c.html#a2">KdpSendString()</a>, <a class="el" href="../../d4/d6/class_8h-source.html#l00054">MAXIMUM_RETRIES</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l03633">KdpCheckLowMemory()</a>, <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html#l01057">KdpGetBusData()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l01461">KdpGetContext()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l02838">KdpGetVersion()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l02959">KdpNotSupported()</a>, <a class="el" href="../../d1/d5/kddbgio_8c-source.html#l00030">KdpPrintString()</a>, <a class="el" href="../../d1/d5/kddbgio_8c-source.html#l00110">KdpPromptString()</a>, <a class="el" href="../../d2/d4/alpha_2kdcpuapi_8c-source.html#l00212">KdpReadControlSpace()</a>, <a class="el" href="../../d2/d4/alpha_2kdcpuapi_8c-source.html#l00499">KdpReadIoSpace()</a>, <a class="el" href="../../d2/d4/alpha_2kdcpuapi_8c-source.html#l00623">KdpReadIoSpaceExtended()</a>, <a class="el" href="../../d3/d4/i386_2kdcpuapi_8c-source.html#l01095">KdpReadMachineSpecificRegister()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l02534">KdpReadPhysicalMemory()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l01139">KdpReadVirtualMemory()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l01215">KdpReadVirtualMemory64()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l01632">KdpRestoreBreakpoint()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l03157">KdpRestoreBreakPointEx()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l03328">KdpSearchMemory()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l00847">KdpSendWaitContinue()</a>, <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html#l01136">KdpSetBusData()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l01521">KdpSetContext()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l01580">KdpWriteBreakpoint()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l03035">KdpWriteBreakPointEx()</a>, <a class="el" href="../../d2/d4/alpha_2kdcpuapi_8c-source.html#l00451">KdpWriteControlSpace()</a>, <a class="el" href="../../d2/d4/alpha_2kdcpuapi_8c-source.html#l00779">KdpWriteIoSpace()</a>, <a class="el" href="../../d2/d4/alpha_2kdcpuapi_8c-source.html#l00899">KdpWriteIoSpaceExtended()</a>, <a class="el" href="../../d3/d4/i386_2kdcpuapi_8c-source.html#l01153">KdpWriteMachineSpecificRegister()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l02680">KdpWritePhysicalMemory()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l01308">KdpWriteVirtualMemory()</a>, and <a class="el" href="../../d9/d2/kdapi_8c-source.html#l01375">KdpWriteVirtualMemory64()</a>.
<p>
<pre class="fragment"><div>00692                    :
00693 
00694     This routine sends a packet to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> host machine that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> running <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00695     kernel debugger and waits <span class="keywordflow">for</span> an ACK.
00696 
00697 Arguments:
00698 
00699     PacketType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of packet to send.
00700 
00701     MessageHeader - Supplies a pointer to a string descriptor that describes
00702         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message information.
00703 
00704     MessageData - Supplies a pointer to a string descriptor that describes
00705         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> optional message data.
00706 
00707 Return Value:
00708 
00709     None.
00710 
00711 --*/
00712 
00713 {
00714 
00715     KD_PACKET PacketHeader;
00716     ULONG MessageDataLength;
00717     ULONG ReturnCode;
00718     PDBGKD_DEBUG_IO DebugIo;
00719     PDBGKD_WAIT_STATE_CHANGE64 StateChange;
00720 
00721     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(MessageData) ) {
00722         MessageDataLength = MessageData-&gt;Length;
00723         PacketHeader.Checksum = <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a0">KdpComputeChecksum</a>(
00724                                         MessageData-&gt;Buffer,
00725                                         MessageData-&gt;Length
00726                                         );
00727     } <span class="keywordflow">else</span> {
00728         MessageDataLength = 0;
00729         PacketHeader.Checksum = 0;
00730     }
00731 
00732     PacketHeader.Checksum += <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a0">KdpComputeChecksum</a> (
00733                                     MessageHeader-&gt;Buffer,
00734                                     MessageHeader-&gt;Length
00735                                     );
00736 
00737     <span class="comment">//</span>
00738     <span class="comment">// Initialize and send the packet header.</span>
00739     <span class="comment">//</span>
00740 
00741     PacketHeader.PacketLeader = PACKET_LEADER;
00742     PacketHeader.ByteCount = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(MessageHeader-&gt;Length + MessageDataLength);
00743     PacketHeader.PacketType = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)PacketType;
00744     <a class="code" href="../../d8/d5/kddata_8c.html#a88">KdpNumberRetries</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a87">KdpRetryCount</a>;
00745     <span class="keywordflow">do</span> {
00746         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a88">KdpNumberRetries</a> == 0) {
00747 
00748             <span class="comment">//</span>
00749             <span class="comment">// If the packet is not for reporting exception, we give up</span>
00750             <span class="comment">// and declare debugger not present.</span>
00751             <span class="comment">//</span>
00752 
00753             <span class="keywordflow">if</span> (PacketType == PACKET_TYPE_KD_DEBUG_IO) {
00754                 DebugIo = (PDBGKD_DEBUG_IO)MessageHeader-&gt;Buffer;
00755                 <span class="keywordflow">if</span> (DebugIo-&gt;ApiNumber == DbgKdPrintStringApi) {
00756                     <a class="code" href="../../d7/d3/kd_8h.html#a12">KdDebuggerNotPresent</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00757                     SharedUserData-&gt;KdDebuggerEnabled &amp;= ~0x00000002;
00758                     <a class="code" href="../../d8/d5/kddata_8c.html#a92">KdpNextPacketIdToSend</a> = INITIAL_PACKET_ID | SYNC_PACKET_ID;
00759                     <a class="code" href="../../d8/d5/kddata_8c.html#a93">KdpPacketIdExpected</a> = INITIAL_PACKET_ID;
00760                     <span class="keywordflow">return</span>;
00761                 }
00762             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PacketType == PACKET_TYPE_KD_STATE_CHANGE64) {
00763                 StateChange = (PDBGKD_WAIT_STATE_CHANGE64)MessageHeader-&gt;Buffer;
00764                 <span class="keywordflow">if</span> (StateChange-&gt;NewState == DbgKdLoadSymbolsStateChange) {
00765                     <a class="code" href="../../d7/d3/kd_8h.html#a12">KdDebuggerNotPresent</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00766                     SharedUserData-&gt;KdDebuggerEnabled &amp;= ~0x00000002;
00767                     <a class="code" href="../../d8/d5/kddata_8c.html#a92">KdpNextPacketIdToSend</a> = INITIAL_PACKET_ID | SYNC_PACKET_ID;
00768                     <a class="code" href="../../d8/d5/kddata_8c.html#a93">KdpPacketIdExpected</a> = INITIAL_PACKET_ID;
00769                     <span class="keywordflow">return</span>;
00770                 }
00771             }
00772         }
00773 
00774         <span class="comment">//</span>
00775         <span class="comment">// Setting PacketId has to be in the do loop in case Packet Id was</span>
00776         <span class="comment">// reset.</span>
00777         <span class="comment">//</span>
00778 
00779         PacketHeader.PacketId = <a class="code" href="../../d8/d5/kddata_8c.html#a92">KdpNextPacketIdToSend</a>;
00780         <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a2">KdpSendString</a>((PCHAR)&amp;PacketHeader, <span class="keyword">sizeof</span>(KD_PACKET));
00781 
00782         <span class="comment">//</span>
00783         <span class="comment">// Output message header.</span>
00784         <span class="comment">//</span>
00785 
00786         <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a2">KdpSendString</a>(MessageHeader-&gt;Buffer, MessageHeader-&gt;Length);
00787 
00788         <span class="comment">//</span>
00789         <span class="comment">// Output message data.</span>
00790         <span class="comment">//</span>
00791 
00792         <span class="keywordflow">if</span> ( MessageDataLength ) {
00793             <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a2">KdpSendString</a>(MessageData-&gt;Buffer, MessageData-&gt;Length);
00794         }
00795 
00796         <span class="comment">//</span>
00797         <span class="comment">// Output a packet trailing byte</span>
00798         <span class="comment">//</span>
00799 
00800         <a class="code" href="../../d2/d7/hal_8h.html#a202">KdPortPutByte</a>(PACKET_TRAILING_BYTE);
00801 
00802         <span class="comment">//</span>
00803         <span class="comment">// Wait for the Ack Packet</span>
00804         <span class="comment">//</span>
00805 
00806         ReturnCode = <a class="code" href="../../d1/d7/4_2kdp_8h.html#a112">KdpReceivePacket</a>(
00807                          PACKET_TYPE_KD_ACKNOWLEDGE,
00808                          NULL,
00809                          NULL,
00810                          NULL
00811                          );
00812         <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d0/d7/kdp_8h.html#a10">KDP_PACKET_TIMEOUT</a>) {
00813             <a class="code" href="../../d8/d5/kddata_8c.html#a88">KdpNumberRetries</a>--;
00814         }
00815     } <span class="keywordflow">while</span> (ReturnCode != <a class="code" href="../../d0/d7/kdp_8h.html#a9">KDP_PACKET_RECEIVED</a>);
00816 
00817     <span class="comment">//</span>
00818     <span class="comment">// Reset Sync bit in packet id.  The packet we sent may have Sync bit set</span>
00819     <span class="comment">//</span>
00820 
00821     <a class="code" href="../../d8/d5/kddata_8c.html#a92">KdpNextPacketIdToSend</a> &amp;= ~SYNC_PACKET_ID;
00822 
00823     <span class="comment">//</span>
00824     <span class="comment">// Since we are able to talk to debugger, the retrycount is set to</span>
00825     <span class="comment">// maximum value.</span>
00826     <span class="comment">//</span>
00827 
00828     <a class="code" href="../../d8/d5/kddata_8c.html#a87">KdpRetryCount</a> = <a class="code" href="../../d8/d0/cmdat3_8c.html#a70">KdpDefaultRetries</a> ;
00829 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="4/kdcomio.c::KdpSendString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpSendString           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Source</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00297">KdpSendControlPacket()</a>, and <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00683">KdpSendPacket()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:25 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
