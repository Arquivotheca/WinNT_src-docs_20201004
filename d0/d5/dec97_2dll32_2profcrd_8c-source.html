<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: profcrd.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>profcrd.c</h1><a href="../../d9/d5/dec97_2dll32_2profcrd_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/dec97_2dll32_2generic_8h.html">generic.h</a>"</span>
00002 <span class="preprocessor">#include "<a class="code" href="../../d6/d8/dec97_2dll32_2icmstr_8h.html">icmstr.h</a>"</span>
00003 
00004 <span class="comment">//#pragma code_seg(_ICM3SEG)</span>
00005 
<a name="l00006"></a><a class="code" href="../../d9/d5/dec97_2dll32_2profcrd_8c.html#a1">00006</a> <span class="preprocessor">#define MAXCOLOR8  255</span>
00007 <span class="preprocessor"></span>
00008 <span class="preprocessor">#pragma optimize("", off)</span>
00009 <span class="preprocessor"></span>
00010 <span class="keyword">static</span> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>
00011 <a class="code" href="../../d2/d9/ps2_8c.html#a237">CreateHostInputOutputArray</a> (MEMPTR lpMem, PMEMPTR ppArray,
00012        SINT numChan, SINT tableSize, SINT Offset, CSIG Tag, MEMPTR Buff);
00013 <span class="keyword">static</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00014 <a class="code" href="../../d2/d9/ps2_8c.html#a240">CheckInputOutputTable</a>(LPHOSTCLUT lpHostClut, <span class="keywordtype">float</span> far *fTemp, BOOL, BOOL);
00015 <span class="keyword">static</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00016 <a class="code" href="../../d2/d9/ps2_8c.html#a241">CheckColorLookupTable</a>(LPHOSTCLUT lpHostClut, <span class="keywordtype">float</span> far *fTemp);
00017 <span class="keyword">static</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00018 <a class="code" href="../../d2/d9/ps2_8c.html#a243">DoHostConversionCRD</a> (LPHOSTCLUT lpHostCRD, LPHOSTCLUT lpHostCSA,
00019        <span class="keywordtype">float</span> far *Input, <span class="keywordtype">float</span> far *Output, 
00020        CSIG ColorSpace, BOOL bCheckOutputTable);
00021 <span class="keyword">static</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00022 <a class="code" href="../../d2/d9/ps2_8c.html#a242">DoHostConversionCSA</a> (LPHOSTCLUT lpHostClut, <span class="keywordtype">float</span> far *Input, <span class="keywordtype">float</span> far *Output);
00023 <span class="keyword">static</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00024 <a class="code" href="../../d2/d9/ps2_8c.html#a199">GetCRDInputOutputArraySize</a>(CHANDLE cp, DWORD Intent, 
00025        LPSINT lpInTbSize, LPSINT lpOutTbSize, 
00026        LPCSIG lpIntentTag, LPSINT lpGrids);
00027 <span class="keyword">static</span> <span class="keywordtype">void</span>
00028 <a class="code" href="../../d2/d9/ps2_8c.html#a248">LabToXYZ</a>(<span class="keywordtype">float</span> far *Input, <span class="keywordtype">float</span> far *Output, <span class="keywordtype">float</span> far *whitePoint);
00029 
00030 <span class="comment">/***************************************************************************</span>
00031 <span class="comment">*                           CreateHostInputOutputArray</span>
00032 <span class="comment">*  function:</span>
00033 <span class="comment">*    this is the function which creates the output array from the data</span>
00034 <span class="comment">*    supplied in the ColorProfile's LUT8 or LUT16 tag.</span>
00035 <span class="comment">*  parameters:</span>
00036 <span class="comment">*    MEMPTR     lpMem        : The buffer to save output array.</span>
00037 <span class="comment">*    LPHOSTCLUT lpHostClut   : </span>
00038 <span class="comment">*    SINT       nOutputCh    : Number of input channel.</span>
00039 <span class="comment">*    SINT       nOutputTable : The size of each input table. </span>
00040 <span class="comment">*    SINT       Offset       : The position of source output data(in icc profile).</span>
00041 <span class="comment">*    CSIG       Tag          : To determin the Output table is 8 or 16 bits.</span>
00042 <span class="comment">*    MEMPTR     Buff         : The buffer that contains source data(copyed from icc profile)</span>
00043 <span class="comment">*</span>
00044 <span class="comment">*  returns:</span>
00045 <span class="comment">*       SINT    Returns number of bytes of Output Array</span>
00046 <span class="comment">*</span>
00047 <span class="comment">***************************************************************************/</span>
00048 
00049 <span class="keyword">static</span> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>
<a name="l00050"></a><a class="code" href="../../d9/d5/dec97_2dll32_2profcrd_8c.html#a2">00050</a> <a class="code" href="../../d2/d9/ps2_8c.html#a237">CreateHostInputOutputArray</a> (MEMPTR lpMem, PMEMPTR ppArray,
00051                             SINT numChan, SINT tableSize, 
00052                             SINT Offset, CSIG Tag, MEMPTR Buff)
00053 {
00054     <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>    i, j;
00055     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> lpMemPtr16;
00056     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>  lpMemPtr8;
00057     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>  lpTable;
00058 
00059     <span class="keywordflow">if</span> (Tag == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a91">icSigLut8Type</a>)
00060         lpMemPtr8 = lpMem;
00061     <span class="keywordflow">else</span>
00062         lpMemPtr16 = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)lpMem;
00063 
00064     <span class="keywordflow">for</span> (i = 0; i &lt; numChan; i++)
00065     {
00066         <span class="keywordflow">if</span> (Tag == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a91">icSigLut8Type</a>)
00067         {
00068             ppArray[i] = lpMemPtr8;
00069             lpTable = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>) (((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a37">lpcpLut8Type</a>) Buff)-&gt;lut.data) +
00070                 <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> +
00071                 tableSize * i;
00072             MemCopy(lpMemPtr8, lpTable, tableSize);
00073                 lpMemPtr8 += tableSize;
00074         }
00075         <span class="keywordflow">else</span>
00076         {
00077             ppArray[i] = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>)lpMemPtr16;
00078             lpTable = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>) (((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a36">lpcpLut16Type</a>) Buff)-&gt;lut.data) +
00079                 2 * <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> +
00080                 2 * tableSize * i;
00081             <span class="keywordflow">for</span> (j = 0; j &lt; tableSize; j++)
00082             {
00083                 *lpMemPtr16++ = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a2">ui16toSINT</a> (lpTable);
00084                 lpTable += <span class="keyword">sizeof</span> (<a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a185">icUInt16Number</a>);
00085             }
00086         }
00087     }
00088     <span class="keywordflow">if</span> (Tag == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a91">icSigLut8Type</a>)
00089         <span class="keywordflow">return</span> ((<a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>) ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>)lpMemPtr8 - lpMem));
00090     <span class="keywordflow">else</span>
00091         <span class="keywordflow">return</span> ((<a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>) ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>)lpMemPtr16 - lpMem));
00092 
00093 }
00094 
00095 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00096"></a><a class="code" href="../../d9/d5/dec97_2dll32_2profcrd_8c.html#a9">00096</a> <a class="code" href="../../d7/d4/jul98_2test_2getcsa_8h.html#a7">GetCLUTinfo</a>(CSIG LutTag, MEMPTR lpLut, LPSINT nInputCh, LPSINT nOutputCh, 
00097             LPSINT nGrids, LPSINT nInputTable, LPSINT nOutputTable, LPSINT size)
00098 {
00099     <span class="keywordflow">if</span> (LutTag == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a91">icSigLut8Type</a>)
00100     {
00101         *nInputCh = <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a1">ui8toSINT</a> (((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a37">lpcpLut8Type</a>) lpLut)-&gt;lut.inputChan);
00102         *nOutputCh = <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a1">ui8toSINT</a> (((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a37">lpcpLut8Type</a>) lpLut)-&gt;lut.outputChan);
00103         *nGrids = <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a1">ui8toSINT</a> (((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a37">lpcpLut8Type</a>) lpLut)-&gt;lut.clutPoints);
00104         *nInputTable = 256<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00105         *nOutputTable = 256<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00106         *size = 1;  <span class="comment">// one byte for each input\output table entry</span>
00107     } <span class="keywordflow">else</span>
00108     {
00109         *nInputCh = <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a1">ui8toSINT</a> (((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a36">lpcpLut16Type</a>) lpLut)-&gt;lut.inputChan);
00110         *nOutputCh = <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a1">ui8toSINT</a> (((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a36">lpcpLut16Type</a>) lpLut)-&gt;lut.outputChan);
00111         *nGrids = <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a1">ui8toSINT</a> (((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a36">lpcpLut16Type</a>) lpLut)-&gt;lut.clutPoints);
00112         *nInputTable = <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a2">ui16toSINT</a> (((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a36">lpcpLut16Type</a>) lpLut)-&gt;lut.inputEnt);
00113         *nOutputTable = <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a2">ui16toSINT</a> (((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a36">lpcpLut16Type</a>) lpLut)-&gt;lut.outputEnt);
00114         *size = 2;  <span class="comment">// two bytes for each input\output table entry</span>
00115     }
00116 }
00117 
00118 <span class="comment">/***************************************************************************</span>
00119 <span class="comment">*                           GetHostCSA</span>
00120 <span class="comment">*  function:</span>
00121 <span class="comment">*    this is the function which creates a Host CSA</span>
00122 <span class="comment">*  parameters:</span>
00123 <span class="comment">*       CHANDLE cp       --  Color Profile handle </span>
00124 <span class="comment">*       MEMPTR lpMem     --  Pointer to the memory block. If this point is NULL,</span>
00125 <span class="comment">*                            require buffer size.</span>
00126 <span class="comment">*       LPDWORD lpcbSize --  Size of the memory block</span>
00127 <span class="comment">*       CSIG InputIntent --</span>
00128 <span class="comment">*       SINT Index       --  to the icc profile tag that contains the data of Intent</span>
00129 <span class="comment">*       int  Type        --  DEF or DEFG</span>
00130 <span class="comment">*  returns:</span>
00131 <span class="comment">*       BOOL        --  TRUE if the function was successful,</span>
00132 <span class="comment">*                       FALSE otherwise.</span>
00133 <span class="comment">***************************************************************************/</span>
00134 <span class="keyword">static</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00135"></a><a class="code" href="../../d9/d5/dec97_2dll32_2profcrd_8c.html#a10">00135</a> <a class="code" href="../../d2/d9/ps2_8c.html#a200">GetHostCSA</a> (CHANDLE cp, MEMPTR lpMem, LPDWORD lpcbSize,
00136             CSIG InputIntent, SINT Index, <span class="keywordtype">int</span> Type)
00137 {
00138     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a17">CSIG</a>    PCS, LutTag;
00139     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a17">CSIG</a>    IntentSig;
00140     <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>    nInputCh, nOutputCh, nGrids, SecondGrids;
00141     <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>    nInputTable, nOutputTable, nNumbers;
00142     <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>    i, j, k;
00143     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>  lpTable;
00144     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>  lpOldMem = lpMem;
00145     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>  lpLut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00146     HGLOBAL hLut = 0;
00147     <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>    LutSize;
00148     <a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a> lpHostClut;
00149 
00150     <span class="comment">// Check if we can generate the CS.</span>
00151     <span class="comment">// If we cannot find the required tag - we will return false</span>
00152     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9/ps2_8c.html#a40">GetCPConnSpace</a> (cp, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a27">LPCSIG</a>) &amp; PCS) ||
00153         (PCS != <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a110">icSigLabData</a>) &amp;&amp; (PCS != <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a109">icSigXYZData</a>) ||
00154         !<a class="code" href="../../d8/d9/jul98_2test_2csprof_8h.html#a15">GetCPTagSig</a> (cp, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a27">LPCSIG</a>) &amp; IntentSig))
00155     {
00156         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00157     }
00158     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d9/jul98_2test_2csprof_8h.html#a16">GetCPElementType</a> (cp, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a27">LPCSIG</a>) &amp; LutTag) ||
00159         ((LutTag != <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a91">icSigLut8Type</a>) &amp;&amp; (LutTag != <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a90">icSigLut16Type</a>)) ||
00160         !<a class="code" href="../../d2/d9/ps2_8c.html#a194">GetCPElementSize</a> (cp, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a25">LPSINT</a>) &amp; LutSize) ||
00161         !<a class="code" href="../../d2/d1/object_8c.html#a7">MemAlloc</a> (LutSize, (HGLOBAL <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *) &amp;hLut, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a29">LPMEMPTR</a>) &amp; lpLut) ||
00162         !<a class="code" href="../../d8/d9/jul98_2test_2csprof_8h.html#a19">GetCPElement</a> (cp, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, lpLut, LutSize))
00163     {
00164         <span class="keywordflow">if</span> (0 != hLut)
00165         {
00166             <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a> (hLut);
00167         }
00168         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00169     }
00170 
00171     <span class="comment">// Estimate the memory size required to hold CS</span>
00172     <a class="code" href="../../d7/d4/jul98_2test_2getcsa_8h.html#a7">GetCLUTinfo</a>(LutTag, lpLut, &amp;nInputCh, &amp;nOutputCh, 
00173                 &amp;nGrids, &amp;nInputTable, &amp;nOutputTable, &amp;i);
00174 
00175     <span class="keywordflow">if</span> (!(nOutputCh == 3) ||
00176         !((nInputCh == 3) &amp;&amp; (Type == <a class="code" href="../../d2/d9/aug98_2dll32_2csprof_8h.html#a0">TYPE_CIEBASEDDEF</a>)) &amp;&amp;
00177         !((nInputCh == 4) &amp;&amp; (Type == <a class="code" href="../../d2/d9/aug98_2dll32_2csprof_8h.html#a1">TYPE_CIEBASEDDEFG</a>)))
00178     {
00179         <a class="code" href="../../d8/d9/jul98_2test_2csprof_8h.html#a39">SetCPLastError</a> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a48a47">CP_POSTSCRIPT_ERR</a>);
00180         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a> (hLut);
00181         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00182     }
00183         
00184     <span class="comment">// First Pass. This is a size request</span>
00185     <span class="keywordflow">if</span> (lpMem == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)                  
00186     {
00187         <span class="keywordflow">if</span> (Type == <a class="code" href="../../d2/d9/aug98_2dll32_2csprof_8h.html#a1">TYPE_CIEBASEDDEFG</a>)
00188             *lpcbSize = nOutputCh * nGrids * nGrids * nGrids * nGrids;
00189         <span class="keywordflow">else</span>
00190             *lpcbSize = nOutputCh * nGrids * nGrids * nGrids;
00191         *lpcbSize = *lpcbSize             +   <span class="comment">// size of RenderTable 8-bits only</span>
00192             nInputCh * nInputTable * i    +   <span class="comment">// size of input table 8/16-bits</span>
00193             nOutputCh * nOutputTable * i  +   <span class="comment">// size of output table 8/16-bits</span>
00194             <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d6/structtagHOSTCLUT.html">HOSTCLUT</a>) + 1024;          <span class="comment">// data structure + extra safe space</span>
00195         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a> (hLut);
00196         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00197     }
00198 
00199     <span class="comment">// Second pass. constructure real HostCSA</span>
00200     lpHostClut = (<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a>)lpMem;
00201     lpMem += <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d6/structtagHOSTCLUT.html">HOSTCLUT</a>);
00202     lpHostClut-&gt;size = <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d6/structtagHOSTCLUT.html">HOSTCLUT</a>);
00203     lpHostClut-&gt;pcs = PCS;
00204     lpHostClut-&gt;intent = InputIntent;
00205     lpHostClut-&gt;lutBits = (LutTag == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a91">icSigLut8Type</a>)? 8:16;
00206 
00207     <span class="comment">// Get info about Illuminant White Point from the header</span>
00208     <a class="code" href="../../d2/d9/ps2_8c.html#a191">GetCPWhitePoint</a> (cp, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a26">LPSFLOAT</a>)lpHostClut-&gt;whitePoint);          <span class="comment">// .. Illuminant</span>
00209 
00210     lpHostClut-&gt;inputChan = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)nInputCh;
00211     lpHostClut-&gt;outputChan = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)nOutputCh;
00212     lpHostClut-&gt;clutPoints = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)nGrids;
00213     lpHostClut-&gt;inputEnt = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)nInputTable;
00214     lpHostClut-&gt;outputEnt = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)nOutputTable;
00215     <span class="comment">// Input Array</span>
00216     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a237">CreateHostInputOutputArray</a> (lpMem, lpHostClut-&gt;inputArray, 
00217              nInputCh, nInputTable, 0, LutTag, lpLut);
00218 
00219     <span class="keywordflow">if</span> (Type == <a class="code" href="../../d2/d9/aug98_2dll32_2csprof_8h.html#a1">TYPE_CIEBASEDDEFG</a>)
00220     {
00221         i = nInputTable * nInputCh +
00222             nGrids * nGrids * nGrids * nGrids * nOutputCh;
00223     } <span class="keywordflow">else</span>
00224     {
00225         i = nInputTable * nInputCh +
00226             nGrids * nGrids * nGrids * nOutputCh;
00227     }
00228     <span class="comment">// ourput array</span>
00229     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a237">CreateHostInputOutputArray</a> (lpMem, lpHostClut-&gt;outputArray, 
00230              nOutputCh, nOutputTable, i, LutTag, lpLut);
00231  <span class="comment">//********** /Table</span>
00232 
00233     lpHostClut-&gt;clut = lpMem;
00234     nNumbers = nGrids * nGrids * nOutputCh;
00235     SecondGrids = 1;
00236     <span class="keywordflow">if</span> (Type == <a class="code" href="../../d2/d9/aug98_2dll32_2csprof_8h.html#a1">TYPE_CIEBASEDDEFG</a>)
00237     {
00238         SecondGrids = nGrids;
00239     }
00240     <span class="keywordflow">for</span> (i = 0; i &lt; nGrids; i++)        <span class="comment">// Nh strings should be sent</span>
00241     {
00242         <span class="keywordflow">for</span> (k = 0; k &lt; SecondGrids; k++)
00243         {
00244             <span class="keywordflow">if</span> (LutTag == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a91">icSigLut8Type</a>)
00245             {
00246                 lpTable = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>) (((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a37">lpcpLut8Type</a>) lpLut)-&gt;lut.data) +
00247                     nInputTable * nInputCh +
00248                     nNumbers * (i * SecondGrids + k);
00249             } <span class="keywordflow">else</span>
00250             {
00251                 lpTable = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>) (((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a36">lpcpLut16Type</a>) lpLut)-&gt;lut.data) +
00252                     2 * nInputTable * nInputCh +
00253                     2 * nNumbers * (i * SecondGrids + k);
00254             }
00255 
00256             <span class="keywordflow">if</span> (LutTag == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a91">icSigLut8Type</a>)
00257             {
00258                 <span class="comment">// Copy 8-bit data.</span>
00259                 MemCopy(lpMem, lpTable, nNumbers);
00260                 lpMem += nNumbers;
00261             }
00262             <span class="keywordflow">else</span>
00263             {
00264                 <span class="comment">// convert 16 bit integer to right format. then copy only 8 bits.</span>
00265                 <span class="keywordflow">for</span> (j = 0; j &lt; nNumbers; j++)
00266                 {
00267                     *lpMem++ = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a2">ui16toSINT</a> (lpTable) / 256);
00268                     lpTable += <span class="keyword">sizeof</span> (<a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a185">icUInt16Number</a>);
00269                 }
00270             }
00271         }
00272     }
00273 
00274     *lpcbSize = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) (lpMem - lpOldMem);
00275 
00276     <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a> (hLut);
00277     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00278 }
00279 
00280 
00281 <span class="comment">/***************************************************************************</span>
00282 <span class="comment">*                        GetHostCSA_Intent</span>
00283 <span class="comment">*  function:</span>
00284 <span class="comment">*       This is the function which creates the Host DEF or DEFGColorSpace array</span>
00285 <span class="comment">*       based on Intent.</span>
00286 <span class="comment">*  parameters:</span>
00287 <span class="comment">*       cp          --  Color Profile handle</span>
00288 <span class="comment">*       lpBuffer    --  Pointer to the memory block. If this point is NULL,</span>
00289 <span class="comment">*                       require buffer size.</span>
00290 <span class="comment">*       lpcbSize    --  Size of the memory block</span>
00291 <span class="comment">*       Intent      --  Intent.</span>
00292 <span class="comment">*       Type        --  CieBasedDEF or CieBasedDEF.</span>
00293 <span class="comment">*  returns:</span>
00294 <span class="comment">*       BOOL        --  TRUE if the function was successful,</span>
00295 <span class="comment">*                       FALSE otherwise.</span>
00296 <span class="comment">***************************************************************************/</span>
00297 
00298 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00299"></a><a class="code" href="../../d1/d6/jul98_2dll32_2profcrd_8c.html#a4">00299</a> <a class="code" href="../../d1/d6/jul98_2dll32_2profcrd_8c.html#a4">GetHostCSA_Intent</a> (CHANDLE cp, MEMPTR lpBuffer, LPDWORD lpcbSize,
00300                    CSIG Intent, <span class="keywordtype">int</span> Type)
00301 {
00302     <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00303     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> Success = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00304     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a17">CSIG</a> AToBxTag;
00305 
00306     <span class="keywordflow">switch</span> (<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a28">Intent</a>)
00307     {
00308         <span class="keywordflow">case</span> <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a142">icPerceptual</a>:
00309             AToBxTag = <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a17">icSigAToB0Tag</a>;
00310             <span class="keywordflow">break</span>;
00311         <span class="keywordflow">case</span> <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a143">icRelativeColorimetric</a>:
00312         <span class="keywordflow">case</span> <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a145">icAbsoluteColorimetric</a>:
00313             <span class="comment">// use RelativeColorimetric data to build it.</span>
00314             AToBxTag = <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a18">icSigAToB1Tag</a>;
00315             <span class="keywordflow">break</span>;
00316         <span class="keywordflow">case</span> <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a144">icSaturation</a>:
00317             AToBxTag = <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a19">icSigAToB2Tag</a>;
00318             <span class="keywordflow">break</span>;
00319         <span class="keywordflow">default</span>:
00320             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00321             <span class="keywordflow">break</span>;
00322     }
00323     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9/ps2_8c.html#a189">DoesCPTagExist</a> (cp, AToBxTag) &amp;&amp;
00324         <a class="code" href="../../d8/d9/jul98_2test_2csprof_8h.html#a12">GetCPTagIndex</a> (cp, AToBxTag, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a25">LPSINT</a>) &amp; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>))
00325     {
00326         Success = <a class="code" href="../../d2/d9/ps2_8c.html#a200">GetHostCSA</a>(cp, lpBuffer, lpcbSize, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a28">Intent</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, Type);
00327     }
00328 
00329     <span class="keywordflow">return</span> Success;
00330 }
00331 <span class="comment">/***************************************************************************</span>
00332 <span class="comment">*                            GetHostColorSpaceArray</span>
00333 <span class="comment">*  function:</span>
00334 <span class="comment">*    This is the main function which creates the Host CSA</span>
00335 <span class="comment">*    from the data supplied in the Profile.</span>
00336 <span class="comment">*  parameters:</span>
00337 <span class="comment">*       cp          --  Color Profile handle</span>
00338 <span class="comment">*       InputIntent --  Intent.</span>
00339 <span class="comment">*       lpBuffer    --  Pointer to the memory block. If this point is NULL,</span>
00340 <span class="comment">*                       require buffer size.</span>
00341 <span class="comment">*       lpcbSize    --  Size of the memory block</span>
00342 <span class="comment">*  returns:</span>
00343 <span class="comment">*       BOOL        --  TRUE if the function was successful,</span>
00344 <span class="comment">*                       FALSE otherwise.</span>
00345 <span class="comment">***************************************************************************/</span>
00346 <span class="keyword">static</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00347"></a><a class="code" href="../../d9/d5/dec97_2dll32_2profcrd_8c.html#a12">00347</a> <a class="code" href="../../d2/d9/ps2_8c.html#a202">GetHostColorSpaceArray</a> (CHANDLE cp, DWORD InputIntent,
00348                        MEMPTR  lpBuffer, LPDWORD lpcbSize)
00349 {
00350     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a17">CSIG</a> ColorSpace, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a28">Intent</a>;
00351     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> Success = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00352 
00353     <span class="keywordflow">if</span> (!cp)
00354         <span class="keywordflow">return</span> Success;
00355 
00356     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9/ps2_8c.html#a41">GetCPDevSpace</a> (cp, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a27">LPCSIG</a>) &amp; ColorSpace) ||
00357         !<a class="code" href="../../d2/d9/ps2_8c.html#a42">GetCPRenderIntent</a> (cp, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a27">LPCSIG</a>) &amp; <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a28">Intent</a>))
00358     {
00359         <span class="keywordflow">return</span> Success;
00360     }
00361     <span class="keywordflow">if</span> (InputIntent == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a146">icUseRenderingIntent</a>)
00362         InputIntent = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a28">Intent</a>;
00363 
00364     <span class="keywordflow">if</span> (!Success)
00365     {
00366         <span class="keywordflow">switch</span> (ColorSpace)
00367         {
00368             <span class="keywordflow">case</span> <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a114">icSigRgbData</a>:
00369                 Success = <a class="code" href="../../d1/d6/jul98_2dll32_2profcrd_8c.html#a4">GetHostCSA_Intent</a> (cp, lpBuffer, lpcbSize,
00370                           (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a17">CSIG</a>) InputIntent, <a class="code" href="../../d2/d9/aug98_2dll32_2csprof_8h.html#a0">TYPE_CIEBASEDDEF</a>);
00371                 <span class="keywordflow">break</span>;
00372             <span class="keywordflow">case</span> <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a118">icSigCmykData</a>:
00373                 Success = <a class="code" href="../../d1/d6/jul98_2dll32_2profcrd_8c.html#a4">GetHostCSA_Intent</a> (cp, lpBuffer, lpcbSize,
00374                           (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a17">CSIG</a>) InputIntent, <a class="code" href="../../d2/d9/aug98_2dll32_2csprof_8h.html#a1">TYPE_CIEBASEDDEFG</a>);
00375                 <span class="keywordflow">break</span>;
00376             <span class="keywordflow">default</span>:
00377                 <span class="keywordflow">break</span>;
00378         }
00379     }
00380     <span class="keywordflow">return</span> Success;
00381 }
00382 
00383 <span class="comment">//===========================================================================</span>
00384 
00385 <span class="comment">/***************************************************************************</span>
00386 <span class="comment">*                             CreateHostLutCRD</span>
00387 <span class="comment">*  function:</span>
00388 <span class="comment">*    this is the function which creates the Host CRD</span>
00389 <span class="comment">*    from the data supplied in the ColorProfile's LUT8 or LUT16 tag.</span>
00390 <span class="comment">*  parameters:</span>
00391 <span class="comment">*       cp          --  Color Profile handle</span>
00392 <span class="comment">*       Index       --  Index of the tag</span>
00393 <span class="comment">*       lpMem       --  Pointer to the memory block.If this point is NULL,</span>
00394 <span class="comment">*                       require buffer size.</span>
00395 <span class="comment">*       InputIntent --  Intent.</span>
00396 <span class="comment">*</span>
00397 <span class="comment">*  returns:</span>
00398 <span class="comment">*       SINT        --  Size of Host CRD.</span>
00399 <span class="comment">***************************************************************************/</span>
00400 
00401 <span class="keyword">static</span> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a> 
<a name="l00402"></a><a class="code" href="../../d9/d5/dec97_2dll32_2profcrd_8c.html#a13">00402</a> <a class="code" href="../../d2/d9/ps2_8c.html#a235">CreateHostLutCRD</a> (CHANDLE cp, SINT Index, MEMPTR lpMem, DWORD InputIntent)
00403 {
00404     <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>     nInputCh, nOutputCh, nGrids;
00405     <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>     nInputTable, nOutputTable, nNumbers;
00406     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a17">CSIG</a>     Tag, PCS;
00407     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a17">CSIG</a>     IntentSig;
00408 
00409     <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>     Ret;
00410     <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>     i, j;
00411     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>   lpTable;
00412 
00413     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>   Buff = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00414     <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>     MemSize = 0;
00415     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>   lpOldMem = lpMem;
00416     HGLOBAL  hMem;
00417     <a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a>  lpHostClut;
00418 
00419     <span class="comment">// Check if we can generate the CRD</span>
00420     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d9/jul98_2test_2csprof_8h.html#a15">GetCPTagSig</a> (cp, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a27">LPCSIG</a>) &amp; IntentSig) ||
00421         !<a class="code" href="../../d8/d9/jul98_2test_2csprof_8h.html#a16">GetCPElementType</a> (cp, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a27">LPCSIG</a>) &amp; Tag) ||
00422         ((Tag != <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a91">icSigLut8Type</a>) &amp;&amp; (Tag != <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a90">icSigLut16Type</a>)) ||
00423         !<a class="code" href="../../d2/d9/ps2_8c.html#a40">GetCPConnSpace</a> (cp, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a27">LPCSIG</a>) &amp; PCS) ||
00424         !<a class="code" href="../../d2/d9/ps2_8c.html#a194">GetCPElementSize</a> (cp, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a25">LPSINT</a>) &amp; MemSize) ||
00425         !<a class="code" href="../../d2/d1/object_8c.html#a7">MemAlloc</a> (MemSize, (HGLOBAL <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *)&amp;hMem, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a29">LPMEMPTR</a>) &amp; Buff) ||
00426         !<a class="code" href="../../d8/d9/jul98_2test_2csprof_8h.html#a19">GetCPElement</a> (cp, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, Buff, MemSize))
00427     {
00428         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != Buff)
00429         {
00430             <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a> (hMem);
00431         }
00432         <span class="keywordflow">return</span> (0);
00433     }
00434 
00435     <a class="code" href="../../d7/d4/jul98_2test_2getcsa_8h.html#a7">GetCLUTinfo</a>(Tag, Buff, &amp;nInputCh, &amp;nOutputCh, 
00436                 &amp;nGrids, &amp;nInputTable, &amp;nOutputTable, &amp;i);
00437 
00438     <span class="keywordflow">if</span> (((nOutputCh != 3) &amp;&amp; (nOutputCh != 4)) ||
00439         (nInputCh != 3))
00440     {
00441         <a class="code" href="../../d8/d9/jul98_2test_2csprof_8h.html#a39">SetCPLastError</a> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a48a47">CP_POSTSCRIPT_ERR</a>);
00442         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a> (hMem);
00443         <span class="keywordflow">return</span> (0);
00444     }
00445 
00446     <span class="comment">// First Pass. This is a size request</span>
00447     <span class="keywordflow">if</span> (lpMem == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)       
00448     {
00449         Ret = nInputCh * nInputTable * i         +  <span class="comment">// Input table 8/16-bits</span>
00450             nOutputCh * nOutputTable * i         +  <span class="comment">// Output table 8/16-bits</span>
00451             nOutputCh * nGrids * nGrids * nGrids +  <span class="comment">// CLUT 8-bits only</span>
00452             <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d6/structtagHOSTCLUT.html">HOSTCLUT</a>)                     +  <span class="comment">// Data structure </span>
00453             1024;                                   <span class="comment">// safe</span>
00454 
00455         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a> (hMem);
00456         <span class="keywordflow">return</span> (Ret);
00457     }
00458          
00459     <span class="comment">// Second Pass. Get a HostCRD</span>
00460     lpHostClut = (<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a>)lpMem;
00461     lpMem += <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d6/structtagHOSTCLUT.html">HOSTCLUT</a>);
00462     lpHostClut-&gt;size = <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d6/structtagHOSTCLUT.html">HOSTCLUT</a>);
00463     lpHostClut-&gt;pcs = PCS;
00464     lpHostClut-&gt;intent = InputIntent;
00465     lpHostClut-&gt;lutBits = (Tag == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a91">icSigLut8Type</a>)? 8:16;
00466 
00467     <a class="code" href="../../d2/d9/ps2_8c.html#a191">GetCPWhitePoint</a> (cp, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a26">LPSFLOAT</a>)lpHostClut-&gt;whitePoint);          <span class="comment">// .. Illuminant</span>
00468 
00469     <span class="comment">// Support absolute whitePoint</span>
00470     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9/ps2_8c.html#a192">GetCPMediaWhitePoint</a> (cp, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a26">LPSFLOAT</a>)lpHostClut-&gt;mediaWP)) <span class="comment">// .. Media WhitePoint</span>
00471     {
00472         lpHostClut-&gt;mediaWP[0] = lpHostClut-&gt;whitePoint[0];
00473         lpHostClut-&gt;mediaWP[1] = lpHostClut-&gt;whitePoint[1];
00474         lpHostClut-&gt;mediaWP[2] = lpHostClut-&gt;whitePoint[2];
00475     }
00476     lpHostClut-&gt;inputChan = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)nInputCh;
00477     lpHostClut-&gt;outputChan = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)nOutputCh;
00478     lpHostClut-&gt;clutPoints = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)nGrids;
00479     lpHostClut-&gt;inputEnt = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)nInputTable;
00480     lpHostClut-&gt;outputEnt = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)nOutputTable;
00481 
00482 <span class="comment">//******** Input array</span>
00483     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a237">CreateHostInputOutputArray</a> (lpMem, lpHostClut-&gt;inputArray, 
00484              nInputCh, nInputTable, 0, Tag, Buff);
00485 <span class="comment">//******** the offset to the position of output array.</span>
00486     i = nInputTable * nInputCh +
00487         nGrids * nGrids * nGrids * nOutputCh;
00488 <span class="comment">//******** Output array</span>
00489     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a237">CreateHostInputOutputArray</a> (lpMem, lpHostClut-&gt;outputArray, 
00490              nOutputCh, nOutputTable, i, Tag, Buff);
00491 <span class="comment">//******** Matrix.</span>
00492     <span class="keywordflow">if</span> (PCS == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a109">icSigXYZData</a>)
00493     {
00494         <span class="keywordflow">if</span> (Tag == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a91">icSigLut8Type</a>)
00495         {
00496             lpTable = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>) &amp; ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a37">lpcpLut8Type</a>) Buff)-&gt;lut.e00;
00497         } <span class="keywordflow">else</span>
00498         {
00499             lpTable = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>) &amp; ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a36">lpcpLut16Type</a>) Buff)-&gt;lut.e00;
00500         }
00501         <span class="keywordflow">for</span> (i = 0; i &lt; 9; i++)
00502         {
00503             lpHostClut-&gt;e[i] = (<span class="keywordtype">float</span>)((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a9">si16f16toSFLOAT</a> (lpTable)) / <a class="code" href="../../d2/d9/aug98_2dll32_2csprof_8h.html#a3">CIEXYZRange</a>);
00504             lpTable += <span class="keyword">sizeof</span> (<a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a192">icS15Fixed16Number</a>);
00505         }
00506     }
00507 <span class="comment">//********** RenderTable</span>
00508     nNumbers = nGrids * nGrids * nOutputCh;
00509     lpHostClut-&gt;clut = lpMem;
00510     <span class="keywordflow">for</span> (i = 0; i &lt; nGrids; i++)        <span class="comment">// Na strings should be sent</span>
00511     {
00512         <span class="keywordflow">if</span> (Tag == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a91">icSigLut8Type</a>)
00513         {
00514             lpTable = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>) (((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a37">lpcpLut8Type</a>) Buff)-&gt;lut.data) +
00515                 nInputTable * nInputCh +
00516                 nNumbers * i;
00517         } <span class="keywordflow">else</span>
00518         {
00519             lpTable = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>) (((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a36">lpcpLut16Type</a>) Buff)-&gt;lut.data) +
00520                 2 * nInputTable * nInputCh +
00521                 2 * nNumbers * i;
00522         }
00523         <span class="keywordflow">if</span> (Tag == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a91">icSigLut8Type</a>)
00524         {
00525             MemCopy(lpMem, lpTable, nNumbers);
00526             lpMem += nNumbers;
00527         }
00528         <span class="keywordflow">else</span>
00529         {
00530             <span class="keywordflow">for</span> (j = 0; j &lt; nNumbers; j++)
00531             {
00532                 *lpMem++ = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a2">ui16toSINT</a> (lpTable) / 256);
00533                 lpTable += <span class="keyword">sizeof</span> (<a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a185">icUInt16Number</a>);
00534             }
00535         }
00536     }
00537 
00538     <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a> (hMem);
00539     <span class="keywordflow">return</span> ((<a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>) ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) (lpMem - lpOldMem)));
00540 }
00541 
00542 <span class="comment">/***************************************************************************</span>
00543 <span class="comment">*                      GetHostColorRenderingDictionary</span>
00544 <span class="comment">*  function:</span>
00545 <span class="comment">*    this is the main function which creates the Host CRD</span>
00546 <span class="comment">*  parameters:</span>
00547 <span class="comment">*       cp          --  Color Profile handle</span>
00548 <span class="comment">*       Intent      --  Intent.</span>
00549 <span class="comment">*       lpMem       --  Pointer to the memory block.If this point is NULL,</span>
00550 <span class="comment">*                       require buffer size.</span>
00551 <span class="comment">*       lpcbSize    --  size of memory block.</span>
00552 <span class="comment">*</span>
00553 <span class="comment">*  returns:</span>
00554 <span class="comment">*       SINT        --  !=0 if the function was successful,</span>
00555 <span class="comment">*                         0 otherwise.</span>
00556 <span class="comment">*                       Returns number of bytes required/transferred</span>
00557 <span class="comment">***************************************************************************/</span>
00558 <span class="keyword">static</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00559"></a><a class="code" href="../../d9/d5/dec97_2dll32_2profcrd_8c.html#a14">00559</a> <a class="code" href="../../d2/d9/ps2_8c.html#a201">GetHostColorRenderingDictionary</a> (CHANDLE cp, DWORD Intent,
00560                                 MEMPTR lpMem, LPDWORD lpcbSize)
00561 {
00562     <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00563     <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a> Ret;
00564     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a17">CSIG</a> BToAxTag;
00565 
00566     <span class="keywordflow">if</span> (!cp)
00567         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00568 
00569     <span class="keywordflow">if</span> ((lpMem == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (*lpcbSize == 0))
00570     {
00571         lpMem = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00572         *lpcbSize = 0;
00573     }
00574     Ret = 0;
00575 
00576     <span class="keywordflow">switch</span> (<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a28">Intent</a>)
00577     {
00578         <span class="keywordflow">case</span> <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a142">icPerceptual</a>:
00579             BToAxTag = <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a23">icSigBToA0Tag</a>;
00580             <span class="keywordflow">break</span>;
00581 
00582         <span class="keywordflow">case</span> <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a143">icRelativeColorimetric</a>:
00583         <span class="keywordflow">case</span> <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a145">icAbsoluteColorimetric</a>:
00584             <span class="comment">// Use RelativeColorimetric to calculate this CRD.</span>
00585             BToAxTag = <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a24">icSigBToA1Tag</a>;
00586             <span class="keywordflow">break</span>;
00587 
00588         <span class="keywordflow">case</span> <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a144">icSaturation</a>:
00589             BToAxTag = <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a25">icSigBToA2Tag</a>;
00590             <span class="keywordflow">break</span>;
00591 
00592         <span class="keywordflow">default</span>:
00593            *lpcbSize = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) Ret;
00594             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00595     }
00596 
00597     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9/ps2_8c.html#a189">DoesCPTagExist</a> (cp, BToAxTag) &amp;&amp;
00598         <a class="code" href="../../d8/d9/jul98_2test_2csprof_8h.html#a12">GetCPTagIndex</a> (cp, BToAxTag, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a25">LPSINT</a>) &amp; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>))
00599     {
00600         Ret = <a class="code" href="../../d2/d9/ps2_8c.html#a235">CreateHostLutCRD</a> (cp, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, lpMem, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a28">Intent</a>);
00601     }
00602 
00603     *lpcbSize = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) Ret;
00604     <span class="keywordflow">return</span> (Ret &gt; 0);
00605 }
00606 
00607 <span class="comment">//========================================================================</span>
00608 <span class="comment">/***************************************************************************</span>
00609 <span class="comment">*                               g</span>
00610 <span class="comment">*  function:</span>
00611 <span class="comment">*    Calculate function y = g(x). used in Lab-&gt;XYZ conversion</span>
00612 <span class="comment">*    y = g(x):      g(x) = x*x*x             if x &gt;= 6/29</span>
00613 <span class="comment">*                   g(x) = 108/841*(x-4/29)  otherwise</span>
00614 <span class="comment">*  parameters:</span>
00615 <span class="comment">*       f           --  x</span>
00616 <span class="comment">*  returns:</span>
00617 <span class="comment">*       SINT        --  y</span>
00618 <span class="comment">***************************************************************************/</span>
00619 
<a name="l00620"></a><a class="code" href="../../d9/d5/dec97_2dll32_2profcrd_8c.html#a15">00620</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d2/d9/ps2_8c.html#a244">g</a>(<span class="keywordtype">float</span> f)
00621 {
00622     <span class="keywordtype">float</span> frc;
00623     <span class="keywordflow">if</span> (f &gt;= (6/29))
00624     {
00625         frc = f * f * f;
00626     }
00627     <span class="keywordflow">else</span>
00628     {
00629         frc = f - (4.0f / 29.0f) * (108.0f / 841.0f);
00630     }
00631     <span class="keywordflow">return</span> frc;
00632 }
00633 
00634 <span class="comment">/***************************************************************************</span>
00635 <span class="comment">*                          inverse_g</span>
00636 <span class="comment">*  function:</span>
00637 <span class="comment">*    Calculate inverse function y = g(x). used in XYZ-&gt;Lab conversion</span>
00638 <span class="comment">*  parameters:</span>
00639 <span class="comment">*       f           --  y</span>
00640 <span class="comment">*  returns:</span>
00641 <span class="comment">*       SINT        --  x</span>
00642 <span class="comment">***************************************************************************/</span>
<a name="l00643"></a><a class="code" href="../../d9/d5/dec97_2dll32_2profcrd_8c.html#a16">00643</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d2/d9/ps2_8c.html#a245">inverse_g</a>(<span class="keywordtype">float</span> f)
00644 {
00645     <span class="keywordtype">double</span> frc;
00646     <span class="keywordflow">if</span> (f &gt;= (6.0*6.0*6.0)/(29.0*29.0*29.0))
00647     {
00648         frc = pow(f, 1.0 / 3.0);
00649     }
00650     <span class="keywordflow">else</span>
00651     {
00652         frc = f * (841.0 / 108.0) + (4.0 / 29.0);
00653     }
00654     <span class="keywordflow">return</span> (<span class="keywordtype">float</span>)frc;
00655 }
00656 
00657 <span class="comment">//========================================================================</span>
00658 
00659 <span class="keyword">static</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00660"></a><a class="code" href="../../d9/d5/dec97_2dll32_2profcrd_8c.html#a17">00660</a> <a class="code" href="../../d2/d9/ps2_8c.html#a246">TableInterp3</a>(LPHOSTCLUT lpHostClut, <span class="keywordtype">float</span> far *fTemp)
00661 {
00662     <span class="keywordtype">int</span>    tmpA, tmpBC;
00663     <span class="keywordtype">int</span>    cellA, cellB, cellC;
00664     <span class="keywordtype">float</span>  a, b, <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
00665     <span class="keywordtype">short</span>  Grids;
00666     <span class="keywordtype">short</span>  outputChan;
00667     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a> v000, v001, v010, v011;
00668     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a> v100, v101, v110, v111;
00669     <span class="keywordtype">float</span>  vx0x, vx1x;
00670     <span class="keywordtype">float</span>  v0xx, v1xx;
00671     <span class="keywordtype">int</span>    idx;
00672 
00673     cellA = (<span class="keywordtype">int</span>)(fTemp[0]);
00674     a = fTemp[0] - cellA;
00675 
00676     cellB = (<span class="keywordtype">int</span>)(fTemp[1]);
00677     b = fTemp[1] - cellB;
00678 
00679     cellC = (<span class="keywordtype">int</span>)(fTemp[2]);
00680     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> = fTemp[2] - cellC;
00681 
00682     Grids = lpHostClut-&gt;clutPoints;
00683     outputChan = lpHostClut-&gt;outputChan;
00684     tmpA  = outputChan * Grids * Grids; 
00685     tmpBC = outputChan * (Grids * cellB + cellC);
00686 
00687     <span class="comment">// Calculate 8 surrounding cells.</span>
00688     v000 = lpHostClut-&gt;clut + tmpA * cellA + tmpBC;
00689     v001 = (cellC &lt; (Grids - 1))? v000 + outputChan : v000;
00690     v010 = (cellB &lt; (Grids - 1))? v000 + outputChan * Grids : v000;
00691     v011 = (cellC &lt; (Grids - 1))? v010 + outputChan : v010 ;
00692 
00693     v100 = (cellA &lt; (Grids - 1))? v000 + tmpA : v000;
00694     v101 = (cellC &lt; (Grids - 1))? v100 + outputChan : v100;
00695     v110 = (cellB &lt; (Grids - 1))? v100 + outputChan * Grids : v100;
00696     v111 = (cellC &lt; (Grids - 1))? v110 + outputChan : v110;
00697 
00698     <span class="keywordflow">for</span> (idx = 0; idx &lt; outputChan; idx++)
00699     {
00700         <span class="comment">// Calculate the average of 4 bottom cells.</span>
00701         vx0x = *v000 + <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> * (<span class="keywordtype">int</span>)((<span class="keywordtype">int</span>)*v001 - (<span class="keywordtype">int</span>)*v000);
00702         vx1x = *v010 + <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> * (<span class="keywordtype">int</span>)((<span class="keywordtype">int</span>)*v011 - (<span class="keywordtype">int</span>)*v010);
00703         v0xx = vx0x + b * (vx1x - vx0x);
00704 
00705         <span class="comment">// Calculate the average of 4 upper cells.</span>
00706         vx0x = *v100 + <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> * (<span class="keywordtype">int</span>)((<span class="keywordtype">int</span>)*v101 - (<span class="keywordtype">int</span>)*v100);
00707         vx1x = *v110 + <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> * (<span class="keywordtype">int</span>)((<span class="keywordtype">int</span>)*v111 - (<span class="keywordtype">int</span>)*v110);
00708         v1xx = vx0x + b * (vx1x - vx0x);
00709 
00710         <span class="comment">// Calculate the bottom and upper average.</span>
00711         fTemp[idx] = (v0xx + a * (v1xx - v0xx)) / <a class="code" href="../../d8/d5/aug98_2dll32_2profcrd_8c.html#a1">MAXCOLOR8</a>;
00712 
00713         <span class="keywordflow">if</span> ( idx &lt; (outputChan - 1))
00714         {
00715             v000++;
00716             v001++;
00717             v010++;
00718             v011++;
00719             v100++;
00720             v101++;
00721             v110++;
00722             v111++;
00723         }
00724     }
00725 
00726     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00727 }
00728 
00729 <span class="keyword">static</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00730"></a><a class="code" href="../../d9/d5/dec97_2dll32_2profcrd_8c.html#a18">00730</a> <a class="code" href="../../d2/d9/ps2_8c.html#a247">TableInterp4</a>(LPHOSTCLUT lpHostClut, <span class="keywordtype">float</span> far *fTemp)
00731 {
00732     <span class="keywordtype">int</span>    tmpH, tmpI, tmpJK;
00733     <span class="keywordtype">int</span>    cellH, cellI, cellJ, cellK;
00734     <span class="keywordtype">float</span>  h, i, j, k;
00735     <span class="keywordtype">short</span>  Grids;
00736     <span class="keywordtype">short</span>  outputChan;
00737     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a> v0000, v0001, v0010, v0011;
00738     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a> v0100, v0101, v0110, v0111;
00739     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a> v1000, v1001, v1010, v1011;
00740     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a> v1100, v1101, v1110, v1111;
00741     <span class="keywordtype">float</span>  vxx0x, vxx1x;
00742     <span class="keywordtype">float</span>  vx0xx, vx1xx;
00743     <span class="keywordtype">float</span>  v0xxx, v1xxx;
00744     <span class="keywordtype">int</span>    idx;
00745 
00746     cellH = (<span class="keywordtype">int</span>)(fTemp[0]);
00747     h = fTemp[0] - cellH;
00748 
00749     cellI = (<span class="keywordtype">int</span>)(fTemp[1]);
00750     i = fTemp[1] - cellI;
00751 
00752     cellJ = (<span class="keywordtype">int</span>)(fTemp[2]);
00753     j = fTemp[2] - cellJ;
00754 
00755     cellK = (<span class="keywordtype">int</span>)(fTemp[3]);
00756     k = fTemp[3] - cellK;
00757 
00758     Grids = lpHostClut-&gt;clutPoints;
00759     outputChan = lpHostClut-&gt;outputChan;
00760     tmpI  = outputChan * Grids * Grids;
00761     tmpH  = tmpI * Grids; 
00762     tmpJK = outputChan * (Grids * cellJ + cellK);
00763 
00764     <span class="comment">// Calculate 16 surrounding cells.</span>
00765     v0000 = lpHostClut-&gt;clut + tmpH * cellH + tmpI * cellI + tmpJK;
00766     v0001 = (cellK &lt; (Grids - 1))? v0000 + outputChan : v0000;
00767     v0010 = (cellJ &lt; (Grids - 1))? v0000 + outputChan * Grids : v0000;
00768     v0011 = (cellK &lt; (Grids - 1))? v0010 + outputChan : v0010;
00769 
00770     v0100 = (cellI &lt; (Grids - 1))? v0000 + tmpI : v0000;
00771     v0101 = (cellK &lt; (Grids - 1))? v0100 + outputChan : v0100;
00772     v0110 = (cellJ &lt; (Grids - 1))? v0100 + outputChan * Grids : v0100;
00773     v0111 = (cellK &lt; (Grids - 1))? v0110 + outputChan : v0110;
00774 
00775     v1000 = (cellH &lt; (Grids - 1))? v0000 + tmpH : v0000;
00776     v1001 = (cellK &lt; (Grids - 1))? v1000 + outputChan : v1000;
00777     v1010 = (cellJ &lt; (Grids - 1))? v1000 + outputChan * Grids : v1000;
00778     v1011 = (cellK &lt; (Grids - 1))? v1010 + outputChan : v1010;
00779 
00780     v1100 = (cellI &lt; (Grids - 1))? v1000 + tmpI : v1000;
00781     v1101 = (cellK &lt; (Grids - 1))? v1100 + outputChan : v1100;
00782     v1110 = (cellJ &lt; (Grids - 1))? v1100 + outputChan * Grids : v1100;
00783     v1111 = (cellK &lt; (Grids - 1))? v1110 + outputChan : v1110;
00784 
00785     <span class="keywordflow">for</span> (idx = 0; idx &lt; outputChan; idx++)
00786     {
00787         <span class="comment">// Calculate the average of 8 bottom cells.</span>
00788         vxx0x = *v0000 + k * (<span class="keywordtype">int</span>)((<span class="keywordtype">int</span>)*v0001 - (<span class="keywordtype">int</span>)*v0000);
00789         vxx1x = *v0010 + k * (<span class="keywordtype">int</span>)((<span class="keywordtype">int</span>)*v0011 - (<span class="keywordtype">int</span>)*v0010);
00790         vx0xx = vxx0x + j * (vxx1x - vxx0x);
00791         vxx0x = *v0100 + k * (<span class="keywordtype">int</span>)((<span class="keywordtype">int</span>)*v0101 - (<span class="keywordtype">int</span>)*v0100);
00792         vxx1x = *v0110 + k * (<span class="keywordtype">int</span>)((<span class="keywordtype">int</span>)*v0111 - (<span class="keywordtype">int</span>)*v0110);
00793         vx1xx = vxx0x + j * (vxx1x - vxx0x);
00794         v0xxx = vx0xx + i * (vx1xx - vx0xx);
00795 
00796         <span class="comment">// Calculate the average of 8 upper cells.</span>
00797         vxx0x = *v1000 + k * (<span class="keywordtype">int</span>)((<span class="keywordtype">int</span>)*v1001 - (<span class="keywordtype">int</span>)*v1000);
00798         vxx1x = *v1010 + k * (<span class="keywordtype">int</span>)((<span class="keywordtype">int</span>)*v1011 - (<span class="keywordtype">int</span>)*v1010);
00799         vx0xx = vxx0x + j * (vxx1x - vxx0x);
00800         vxx0x = *v1100 + k * (<span class="keywordtype">int</span>)((<span class="keywordtype">int</span>)*v1101 - (<span class="keywordtype">int</span>)*v1100);
00801         vxx1x = *v1110 + k * (<span class="keywordtype">int</span>)((<span class="keywordtype">int</span>)*v1111 - (<span class="keywordtype">int</span>)*v1110);
00802         vx1xx = vxx0x + j * (vxx1x - vxx0x);
00803         v1xxx = vx0xx + i * (vx1xx - vx0xx);
00804 
00805         <span class="comment">// Calculate the bottom and upper average.</span>
00806         fTemp[idx] = (v0xxx + h * (v1xxx - v0xxx)) / <a class="code" href="../../d8/d5/aug98_2dll32_2profcrd_8c.html#a1">MAXCOLOR8</a>;
00807 
00808         <span class="keywordflow">if</span> ( idx &lt; (outputChan - 1))
00809         {
00810             v0000++;
00811             v0001++;
00812             v0010++;
00813             v0011++;
00814             v0100++;
00815             v0101++;
00816             v0110++;
00817             v0111++;
00818             v1000++;
00819             v1001++;
00820             v1010++;
00821             v1011++;
00822             v1100++;
00823             v1101++;
00824             v1110++;
00825             v1111++;
00826         }
00827     }
00828 
00829     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00830 }
00831 
00832 
00833 <span class="comment">/***************************************************************************</span>
00834 <span class="comment">*                         CheckColorLookupTable</span>
00835 <span class="comment">*  function:</span>
00836 <span class="comment">*    This function check RenderTable.</span>
00837 <span class="comment">*  parameters:</span>
00838 <span class="comment">*       LPHOSTCLUT lpHostClut -- </span>
00839 <span class="comment">*       float far  *fTemp     --  Input (in range [0 gred-1]) /</span>
00840 <span class="comment">*                                 output(in range [0 1)</span>
00841 <span class="comment">*  returns:</span>
00842 <span class="comment">*       BOOL                  -- TRUE</span>
00843 <span class="comment">***************************************************************************/</span>
00844 
00845 <span class="keyword">static</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00846"></a><a class="code" href="../../d9/d5/dec97_2dll32_2profcrd_8c.html#a4">00846</a> <a class="code" href="../../d2/d9/ps2_8c.html#a241">CheckColorLookupTable</a>(LPHOSTCLUT lpHostClut, <span class="keywordtype">float</span> far *fTemp) 
00847 {
00848     <span class="keywordflow">if</span> (lpHostClut-&gt;inputChan == 3)
00849     {
00850         <a class="code" href="../../d2/d9/ps2_8c.html#a246">TableInterp3</a>(lpHostClut, fTemp);
00851     }
00852     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(lpHostClut-&gt;inputChan == 4)
00853     {
00854         <a class="code" href="../../d2/d9/ps2_8c.html#a247">TableInterp4</a>(lpHostClut, fTemp);
00855     }
00856     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00857 }
00858 
00859 <span class="comment">/***************************************************************************</span>
00860 <span class="comment">*                         CheckInputOutputTable</span>
00861 <span class="comment">*  function:</span>
00862 <span class="comment">*    This function check inputTable.</span>
00863 <span class="comment">*  parameters:</span>
00864 <span class="comment">*       LPHOSTCLUT lpHostClut -- </span>
00865 <span class="comment">*       float far  *fTemp     --  Input / output data</span>
00866 <span class="comment">*  returns:</span>
00867 <span class="comment">*       BOOL                  -- TRUE</span>
00868 <span class="comment">***************************************************************************/</span>
00869 <span class="keyword">static</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00870"></a><a class="code" href="../../d9/d5/dec97_2dll32_2profcrd_8c.html#a3">00870</a> <a class="code" href="../../d2/d9/ps2_8c.html#a240">CheckInputOutputTable</a>(LPHOSTCLUT lpHostClut, <span class="keywordtype">float</span> far *fTemp, 
00871                       BOOL bCSA, BOOL bInputTable) 
00872 {
00873     <span class="keywordtype">int</span>     i;
00874     <span class="keywordtype">short</span>   Grids;
00875     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>  floor1, ceiling1;
00876     <span class="keywordtype">float</span>   fIndex;
00877     <span class="keywordtype">int</span>     numChan;
00878     <span class="keywordtype">int</span>     numEnt;
00879     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a20">PMEMPTR</a> ppArray;
00880 
00881     <span class="keywordflow">if</span> (bInputTable)
00882     {
00883         numChan = lpHostClut-&gt;inputChan;
00884         numEnt = lpHostClut-&gt;inputEnt - 1;
00885         ppArray = lpHostClut-&gt;inputArray;
00886     }
00887     <span class="keywordflow">else</span>
00888     {
00889         numChan = lpHostClut-&gt;outputChan;
00890         numEnt = lpHostClut-&gt;outputEnt - 1;
00891         ppArray = lpHostClut-&gt;outputArray;
00892     }
00893 
00894     Grids = lpHostClut-&gt;clutPoints;
00895     <span class="keywordflow">for</span> (i = 0; (i &lt;= <a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a0">MAXCHANNELS</a>) &amp;&amp; (i &lt; numChan); i++)
00896     {
00897         fTemp[i] = (fTemp[i] &lt; 0)? 0: ((fTemp[i] &gt; 1)? 1: fTemp[i]);
00898         fIndex = fTemp[i] * numEnt;
00899         <span class="keywordflow">if</span> (lpHostClut-&gt;lutBits == 8)
00900         {
00901             floor1 = ppArray[i][(<span class="keywordtype">int</span>)fIndex];
00902             ceiling1 = ppArray[i][((<span class="keywordtype">int</span>)fIndex) + 1];
00903             fTemp[i] = (<span class="keywordtype">float</span>)(floor1 + (ceiling1 - floor1) * (fIndex - floor(fIndex)));
00904             <span class="keywordflow">if</span> (bCSA &amp;&amp; !bInputTable)
00905                 fTemp[i] = (<span class="keywordtype">float</span>)(fTemp[i] / 127.0);
00906             <span class="keywordflow">else</span>
00907                 fTemp[i] = (<span class="keywordtype">float</span>)(fTemp[i] / 255.0);
00908         }
00909         <span class="keywordflow">else</span>
00910         {
00911             floor1 = ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)(ppArray[i]))[(<span class="keywordtype">int</span>)fIndex];
00912             ceiling1 = ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)(ppArray[i]))[((<span class="keywordtype">int</span>)fIndex) + 1];
00913             fTemp[i] = (<span class="keywordtype">float</span>)(floor1 + (ceiling1 - floor1) * (fIndex - floor(fIndex)));
00914             <span class="keywordflow">if</span> (bCSA &amp;&amp; !bInputTable)
00915                 fTemp[i] = (<span class="keywordtype">float</span>)(fTemp[i] / 32767.0);
00916             <span class="keywordflow">else</span>
00917                 fTemp[i] = (<span class="keywordtype">float</span>)(fTemp[i] / 65535.0);
00918 
00919         }
00920         <span class="keywordflow">if</span> (bInputTable)
00921         {
00922             fTemp[i] *= (Grids - 1);
00923             <span class="keywordflow">if</span> (fTemp[i] &gt; (Grids - 1))
00924                 fTemp[i] = (<span class="keywordtype">float</span>)(Grids - 1);
00925         }
00926     }
00927     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00928 }
00929 
00930 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00931"></a><a class="code" href="../../d9/d5/dec97_2dll32_2profcrd_8c.html#a8">00931</a> <a class="code" href="../../d2/d9/ps2_8c.html#a248">LabToXYZ</a>(<span class="keywordtype">float</span> far *Input, <span class="keywordtype">float</span> far *Output, <span class="keywordtype">float</span> far *whitePoint)
00932 {
00933     <span class="keywordtype">float</span>   fL, fa, fb;
00934 
00935     fL = (Input[0] * 50 + 16) / 116;
00936     fa = (Input[1] * 128 - 128) / 500;
00937     fb = (Input[2] * 128 - 128) / 200;
00938     Output[0] = whitePoint[0] * <a class="code" href="../../d2/d9/ps2_8c.html#a244">g</a>(fL + fa);
00939     Output[1] = whitePoint[1] * <a class="code" href="../../d2/d9/ps2_8c.html#a244">g</a>(fL);
00940     Output[2] = whitePoint[2] * <a class="code" href="../../d2/d9/ps2_8c.html#a244">g</a>(fL - fb);
00941 }
00942 
00943 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00944"></a><a class="code" href="../../d9/d5/dec97_2dll32_2profcrd_8c.html#a19">00944</a> <a class="code" href="../../d2/d9/ps2_8c.html#a249">XYZToLab</a>(<span class="keywordtype">float</span> far *Input, <span class="keywordtype">float</span> far *Output, <span class="keywordtype">float</span> far *whitePoint)
00945 {
00946     <span class="keywordtype">float</span>   fL, fa, fb;
00947 
00948     fL = <a class="code" href="../../d2/d9/ps2_8c.html#a245">inverse_g</a>(Input[0] / whitePoint[0]);
00949     fa = <a class="code" href="../../d2/d9/ps2_8c.html#a245">inverse_g</a>(Input[1] / whitePoint[1]);
00950     fb = <a class="code" href="../../d2/d9/ps2_8c.html#a245">inverse_g</a>(Input[2] / whitePoint[2]);
00951     Output[0] = (fa * 116 - 16) / 100;
00952     Output[1] = (fL * 500 - fa * 500 + 128) / 255;
00953     Output[2] = (fa * 200 - fb * 200 + 128) / 255;
00954 }
00955 
00956 <span class="comment">/***************************************************************************</span>
00957 <span class="comment">*                         DoHostConversionCRD</span>
00958 <span class="comment">*  function:</span>
00959 <span class="comment">*    This function converts XYZ/Lab to RGB/CMYK by using HostCRD</span>
00960 <span class="comment">*  parameters:</span>
00961 <span class="comment">*       LPHOSTCLUT lpHostCRD  -- pointer to a HostCRD</span>
00962 <span class="comment">*       LPHOSTCLUT lpHostCSA  -- pointer to a HostCSA</span>
00963 <span class="comment">*       float far *Input      -- Input XYZ/Lab</span>
00964 <span class="comment">*       float far *Output     -- Output RGB/CMYK</span>
00965 <span class="comment">*  returns:</span>
00966 <span class="comment">*       BOOL                  -- TRUE</span>
00967 <span class="comment">***************************************************************************/</span>
00968 <span class="keyword">static</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00969"></a><a class="code" href="../../d9/d5/dec97_2dll32_2profcrd_8c.html#a5">00969</a> <a class="code" href="../../d2/d9/ps2_8c.html#a243">DoHostConversionCRD</a> (LPHOSTCLUT lpHostCRD, LPHOSTCLUT lpHostCSA,
00970                      <span class="keywordtype">float</span> far *Input, <span class="keywordtype">float</span> far *Output,
00971                      CSIG ColorSpace, BOOL bCheckOutputTable)
00972 {
00973     <span class="keywordtype">float</span>   fTemp[<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a0">MAXCHANNELS</a>];
00974     <span class="keywordtype">float</span>   fTemp1[<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a0">MAXCHANNELS</a>];
00975     <span class="keywordtype">int</span>     i, j;
00976 
00980     <span class="comment">// When sampling the deviceCRD, skip the input table.</span>
00981     <span class="comment">// If lpHostCSA is not NULL, the current CRD is targetCRD, we</span>
00982     <span class="comment">// need to do input table conversion</span>
00983     <span class="keywordflow">if</span> (lpHostCSA)
00984     {
00985         <span class="comment">// Convert Lab to XYZ  in range [ 0 whitePoint ]</span>
00986         <span class="keywordflow">if</span> ((lpHostCRD-&gt;pcs == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a109">icSigXYZData</a>) &amp;&amp; 
00987             (lpHostCSA-&gt;pcs == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a110">icSigLabData</a>))
00988         {
00989             <a class="code" href="../../d2/d9/ps2_8c.html#a248">LabToXYZ</a>(Input, fTemp1, lpHostCRD-&gt;whitePoint);
00990         }
00991         <span class="comment">// Convert XYZ to Lab in range [ 0 1]</span>
00992         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((lpHostCRD-&gt;pcs == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a110">icSigLabData</a>) &amp;&amp; 
00993                  (lpHostCSA-&gt;pcs == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a109">icSigXYZData</a>))
00994         {
00995             <a class="code" href="../../d2/d9/ps2_8c.html#a249">XYZToLab</a>(Input, fTemp, lpHostCSA-&gt;whitePoint);
00996         }
00997         <span class="comment">// Convert Lab to range [ 0 1]</span>
00998         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((lpHostCRD-&gt;pcs == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a110">icSigLabData</a>) &amp;&amp; 
00999                  (lpHostCSA-&gt;pcs == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a110">icSigLabData</a>))
01000         {
01001             <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++)
01002                 fTemp[i] = Input[i] / 2;
01003         }
01004         <span class="comment">// Convert XYZ to XYZ (based on white point) to range [0 1]</span>
01005         <span class="keywordflow">else</span>
01006         {
01007             <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++)
01008                 fTemp1[i] = Input[i] * lpHostCRD-&gt;whitePoint[i] / lpHostCSA-&gt;whitePoint[i];
01009         }
01010         <span class="comment">// Matrix, used for XYZ data only.</span>
01011         <span class="keywordflow">if</span> (lpHostCRD-&gt;pcs == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a109">icSigXYZData</a>)
01012         {
01013             <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++)
01014             {
01015                 j = i*3;
01016                 fTemp[i] =  lpHostCRD-&gt;e[j ]    * fTemp1[0] +
01017                             lpHostCRD-&gt;e[j + 1] * fTemp1[1] +
01018                             lpHostCRD-&gt;e[j + 2] * fTemp1[2];
01019             }
01020         }
01021 
01022         <span class="comment">//Search input Table</span>
01023         <a class="code" href="../../d2/d9/ps2_8c.html#a240">CheckInputOutputTable</a>(lpHostCRD, fTemp, 0, 1);
01024     }
01025     <span class="comment">// If the current CRD is device CRD, we do not need to do input</span>
01026     <span class="comment">// table conversion.</span>
01027     <span class="keywordflow">else</span>
01028     {
01029         <span class="keywordtype">short</span>   Grids;
01030         Grids = lpHostCRD-&gt;clutPoints;
01031         <span class="comment">// Sample data may be XYZ or Lab. It depends on Target icc profile.</span>
01032         <span class="comment">// If the PCS of the target icc profile is XYZ, input data will be XYZ.</span>
01033         <span class="comment">// If the PCS of the target icc profile is Lab, input data will be Lab.</span>
01034 
01035         <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++)
01036         {
01037             fTemp[i] = Input[i]* (Grids - 1);
01038             <span class="keywordflow">if</span> (fTemp[i] &gt; (Grids - 1))
01039                 fTemp[i] = (<span class="keywordtype">float</span>)(Grids - 1);
01040         }
01041     }   <span class="comment">// bCheckInputTable</span>
01042 
01043     <span class="comment">// Rendering table</span>
01044     <a class="code" href="../../d2/d9/ps2_8c.html#a241">CheckColorLookupTable</a>(lpHostCRD, fTemp);
01045 
01049     <span class="keywordflow">if</span> (bCheckOutputTable)
01050     {
01051         <span class="comment">//Output Table</span>
01052         <a class="code" href="../../d2/d9/ps2_8c.html#a240">CheckInputOutputTable</a>(lpHostCRD, fTemp, 0, 0);
01053     }
01054     <span class="keywordflow">for</span> (i = 0; (i &lt;= <a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a0">MAXCHANNELS</a>) &amp;&amp; (i &lt; lpHostCRD-&gt;outputChan); i++)
01055     {
01056         Output[i] = fTemp[i];
01057     }
01058 
01059     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01060 }
01061 
01062 <span class="comment">/***************************************************************************</span>
01063 <span class="comment">*                         DoHostConversionCSA</span>
01064 <span class="comment">*  function:</span>
01065 <span class="comment">*    This function converts RGB/CMYK to XYZ/Lab by using HostCSA</span>
01066 <span class="comment">*  parameters:</span>
01067 <span class="comment">*       LPHOSTCLUT lpHostCLUT -- pointer to a HostCSA</span>
01068 <span class="comment">*       float far *Input      -- Input XYZ/Lab</span>
01069 <span class="comment">*       float far *Output     -- Output RGB/CMYK</span>
01070 <span class="comment">*  returns:</span>
01071 <span class="comment">*       BOOL                  -- TRUE</span>
01072 <span class="comment">***************************************************************************/</span>
01073 
01074 <span class="keyword">static</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l01075"></a><a class="code" href="../../d9/d5/dec97_2dll32_2profcrd_8c.html#a6">01075</a> <a class="code" href="../../d2/d9/ps2_8c.html#a242">DoHostConversionCSA</a> (LPHOSTCLUT lpHostClut, <span class="keywordtype">float</span> far *Input, <span class="keywordtype">float</span> far *Output)
01076 {
01077     <span class="keywordtype">float</span>   fTemp[<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a0">MAXCHANNELS</a>];
01078     <span class="keywordtype">int</span>     i;
01079 
01083     <span class="keywordflow">for</span> (i = 0; (i &lt;= <a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a0">MAXCHANNELS</a>) &amp;&amp; (i &lt; lpHostClut-&gt;inputChan); i++)
01084     {
01085         fTemp[i] = Input[i];
01086     }
01087     <span class="comment">//Search input Table</span>
01088     <a class="code" href="../../d2/d9/ps2_8c.html#a240">CheckInputOutputTable</a>(lpHostClut, fTemp, 1, 1);
01089 
01090     <span class="comment">// Rendering table</span>
01091     <a class="code" href="../../d2/d9/ps2_8c.html#a241">CheckColorLookupTable</a>(lpHostClut, fTemp);
01092 
01093     <span class="comment">//Output Table</span>
01094     <a class="code" href="../../d2/d9/ps2_8c.html#a240">CheckInputOutputTable</a>(lpHostClut, fTemp, 1, 0 );
01095 
01099     <span class="keywordflow">for</span> (i = 0; (i &lt;= <a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a0">MAXCHANNELS</a>) &amp;&amp; (i &lt; lpHostClut-&gt;outputChan); i++)
01100     {
01101         Output[i] = fTemp[i];
01102     }
01103     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01104 }                               
01105 
01106 <span class="keyword">static</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l01107"></a><a class="code" href="../../d9/d5/dec97_2dll32_2profcrd_8c.html#a7">01107</a> <a class="code" href="../../d2/d9/ps2_8c.html#a199">GetCRDInputOutputArraySize</a>(CHANDLE cp, DWORD Intent, 
01108     LPSINT lpInTbSize, LPSINT lpOutTbSize, 
01109     LPCSIG lpIntentTag, LPSINT lpGrids)
01110 {
01111     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a17">CSIG</a>    Tag;
01112     <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>    <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01113     <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>    Ret = 0;
01114     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>  Buff = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01115     <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>    MemSize = 0;
01116     HGLOBAL hMem;
01117     <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>    outputChan, outputEnt;
01118     <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>    inputChan, inputEnt;
01119     <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>    Grids;
01120     <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>    i;
01121 
01122     <span class="keywordflow">switch</span> (<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a28">Intent</a>)
01123     {
01124         <span class="keywordflow">case</span> <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a142">icPerceptual</a>:
01125             *lpIntentTag = <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a23">icSigBToA0Tag</a>;
01126             <span class="keywordflow">break</span>;
01127 
01128         <span class="keywordflow">case</span> <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a143">icRelativeColorimetric</a>:
01129         <span class="keywordflow">case</span> <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a145">icAbsoluteColorimetric</a>:
01130             *lpIntentTag = <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a24">icSigBToA1Tag</a>;
01131             <span class="keywordflow">break</span>;
01132 
01133         <span class="keywordflow">case</span> <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a144">icSaturation</a>:
01134             *lpIntentTag = <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a25">icSigBToA2Tag</a>;
01135             <span class="keywordflow">break</span>;
01136 
01137         <span class="keywordflow">default</span>:
01138             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01139     }
01140     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9/ps2_8c.html#a189">DoesCPTagExist</a> (cp, *lpIntentTag) ||
01141         !<a class="code" href="../../d8/d9/jul98_2test_2csprof_8h.html#a12">GetCPTagIndex</a> (cp, *lpIntentTag, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a25">LPSINT</a>) &amp; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>) ||
01142         !<a class="code" href="../../d8/d9/jul98_2test_2csprof_8h.html#a16">GetCPElementType</a> (cp, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a27">LPCSIG</a>) &amp; Tag) ||
01143         ((Tag != <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a91">icSigLut8Type</a>) &amp;&amp; (Tag != <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a90">icSigLut16Type</a>)) ||
01144         !<a class="code" href="../../d2/d9/ps2_8c.html#a194">GetCPElementSize</a> (cp, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a25">LPSINT</a>) &amp; MemSize) ||
01145         !<a class="code" href="../../d2/d1/object_8c.html#a7">MemAlloc</a> (MemSize, (HGLOBAL <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *)&amp;hMem, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a29">LPMEMPTR</a>) &amp; Buff) ||
01146         !<a class="code" href="../../d8/d9/jul98_2test_2csprof_8h.html#a19">GetCPElement</a> (cp, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, Buff, MemSize))
01147     {
01148         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != Buff)
01149         {
01150             <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a> (hMem);
01151         }
01152         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01153     }
01154 
01155     <span class="keywordflow">if</span> (lpInTbSize)
01156     {
01157         <a class="code" href="../../d7/d4/jul98_2test_2getcsa_8h.html#a7">GetCLUTinfo</a>(Tag, Buff, &amp;inputChan, &amp;outputChan, 
01158                 &amp;Grids, &amp;inputEnt, &amp;outputEnt, &amp;i);
01159 
01160         <span class="keywordflow">if</span> (inputChan != 3)
01161         {
01162             <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a> (hMem);
01163             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01164         }
01165 
01166         *lpInTbSize = inputChan * inputEnt * 6;  <span class="comment">// Number of INT bytes</span>
01167         *lpGrids = Grids;
01168     }
01169 
01170     <span class="keywordflow">if</span> (lpOutTbSize)
01171     {
01172         <a class="code" href="../../d7/d4/jul98_2test_2getcsa_8h.html#a7">GetCLUTinfo</a>(Tag, Buff, &amp;inputChan, &amp;outputChan, 
01173                 &amp;Grids, &amp;inputEnt, &amp;outputEnt, &amp;i);
01174 
01175         <span class="keywordflow">if</span> ((outputChan != 3) &amp;&amp; (outputChan != 4))
01176         {
01177             <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a> (hMem);
01178             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01179         }
01180         *lpOutTbSize = outputChan * outputEnt * 6; <span class="comment">// Number of INT bytes</span>
01181         *lpGrids = Grids;
01182     }
01183 
01184     <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a> (hMem);
01185     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01186 }
01187 
01188 <span class="comment">/***************************************************************************</span>
01189 <span class="comment">*                         CreateOutputArray</span>
01190 <span class="comment">*  function:</span>
01191 <span class="comment">*       Create CSA/CRD output arrays from the data supplied in icc profile's</span>
01192 <span class="comment">*       LUT8 or LUT16 tags.</span>
01193 <span class="comment">*  parameters:</span>
01194 <span class="comment">*       MEMPTR  lpMem        -- a pointer to a buffer which will contain the arrays. </span>
01195 <span class="comment">*       SINT    nOutputCh    -- Number of output channel. if lpHostClut, no meaning.</span>
01196 <span class="comment">*       SINT    nOutputTable -- saze of each array.  if lpHostClut, no meaning.</span>
01197 <span class="comment">*       SINT    Offset       -- offset of Buff, point to the 1st byte of output array in CLUT.</span>
01198 <span class="comment">*                               if lpHostClut, no meaning.</span>
01199 <span class="comment">*       MEMPTR  Intent       -- </span>
01200 <span class="comment">*       CSIG    Tag          -- LUT8 or LUT16</span>
01201 <span class="comment">*       MEMPTR  Buff         -- point to a buffer which contain LUT8 or LUT16.</span>
01202 <span class="comment">*                               if NULL, use lpHostClut.</span>
01203 <span class="comment">*       BOOL    AllowBinary  --</span>
01204 <span class="comment">*       MEMPTR  lpHostClut   -- point to host CSA/CRD. if NULL, use Buff.</span>
01205 <span class="comment">*  returns:</span>
01206 <span class="comment">*       SINT                 -- The size of output array created.</span>
01207 <span class="comment">***************************************************************************/</span>
01208 
01209 <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>
<a name="l01210"></a><a class="code" href="../../d9/d5/dec97_2dll32_2profcrd_8c.html#a20">01210</a> <a class="code" href="../../d2/d9/ps2_8c.html#a216">CreateOutputArray</a> (MEMPTR lpMem, SINT nOutputCh, 
01211     SINT nOutputTable, SINT Offset, MEMPTR Intent, 
01212     CSIG Tag, MEMPTR Buff, BOOL AllowBinary, MEMPTR lpHostClut)
01213 {
01214     <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a> i, j;
01215     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a> lpOldMem;
01216     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a> lpTable;
01217     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a> lpLineStart;
01218     lpOldMem = lpMem;
01219 
01220     <span class="keywordflow">if</span> (lpHostClut)
01221     {
01222         nOutputCh = (<a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>)(((<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a>)lpHostClut)-&gt;outputChan);
01223         nOutputTable = (<a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>)(((<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a>)lpHostClut)-&gt;outputEnt);
01224         Tag = (((<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a>)lpHostClut)-&gt;lutBits == 8)? 
01225               <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a91">icSigLut8Type</a> : <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a90">icSigLut16Type</a>;
01226     }
01227 
01228     <span class="keywordflow">for</span> (i = 0; i &lt; nOutputCh; i++)
01229     {
01230         lpLineStart = lpMem;
01231         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a56">NewLine</a>);
01232         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a57">Slash</a>);
01233         <span class="keywordflow">if</span> (lpHostClut)
01234             lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a80">PreViewOutArray</a>);
01235         <span class="keywordflow">else</span>
01236             lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a78">OutputArray</a>);
01237         lpMem += <a class="code" href="../../d8/d9/jul98_2test_2csprof_8h.html#a44">WriteObjectN</a> (lpMem, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a28">Intent</a>, lstrlen (<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a28">Intent</a>));
01238         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a44">WriteInt</a> (lpMem, i);
01239         
01240         <span class="keywordflow">if</span> (lpHostClut)
01241             lpTable = ((<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a>)lpHostClut)-&gt;outputArray[i];
01242         <span class="keywordflow">else</span>
01243         {
01244             <span class="keywordflow">if</span> (Tag == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a91">icSigLut8Type</a>)
01245                 lpTable = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>) (((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a37">lpcpLut8Type</a>) Buff)-&gt;lut.data) +
01246                     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> +
01247                     nOutputTable * i;
01248             <span class="keywordflow">else</span>
01249                 lpTable = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>) (((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a36">lpcpLut16Type</a>) Buff)-&gt;lut.data) +
01250                     2 * <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> +
01251                     2 * nOutputTable * i;
01252         }
01253 
01254         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a27">AllowBinary</a>)               <span class="comment">// Output ASCII CRD</span>
01255         {
01256             <span class="keywordflow">if</span> (Tag == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a91">icSigLut8Type</a>)
01257             {
01258                 lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a2">BeginString</a>);
01259                 lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a227">WriteHexBuffer</a> (lpMem, lpTable, lpLineStart, nOutputTable);
01260                 lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a3">EndString</a>);
01261             } <span class="keywordflow">else</span>
01262             {
01263                 lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a4">BeginArray</a>);
01264                 <span class="keywordflow">for</span> (j = 0; j &lt; nOutputTable; j++)
01265                 {
01266                     <span class="keywordflow">if</span> (lpHostClut)
01267                         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a44">WriteInt</a> (lpMem, *((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)lpTable));
01268                     <span class="keywordflow">else</span>
01269                         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a44">WriteInt</a> (lpMem, <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a2">ui16toSINT</a> (lpTable));
01270                     lpTable += <span class="keyword">sizeof</span> (<a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a185">icUInt16Number</a>);
01271                     <span class="keywordflow">if</span> (((<a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>) (lpMem - lpLineStart)) &gt; <a class="code" href="../../d2/d9/aug98_2dll32_2csprof_8h.html#a4">MAX_LINELENG</a>)
01272                     {
01273                         lpLineStart = lpMem;
01274                         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a56">NewLine</a>);
01275                     }
01276                 }
01277                 lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a5">EndArray</a>);
01278             }
01279         } <span class="keywordflow">else</span>
01280         {                               <span class="comment">// Output BINARY CRD</span>
01281             <span class="keywordflow">if</span> (Tag == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a91">icSigLut8Type</a>)
01282             {
01283                 lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a228">WriteStringToken</a> (lpMem, 143, 256);
01284                 lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a229">WriteByteString</a> (lpMem, lpTable, 256<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01285             } <span class="keywordflow">else</span>
01286             {
01287                 lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a224">WriteHNAToken</a> (lpMem, 149, nOutputTable);
01288                 <span class="keywordflow">if</span> (lpHostClut)
01289                     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a226">WriteIntStringU2S_L</a> (lpMem, lpTable, nOutputTable);
01290                 <span class="keywordflow">else</span>
01291                     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a225">WriteIntStringU2S</a> (lpMem, lpTable, nOutputTable);
01292             }
01293         }
01294         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a49">DefOp</a>);
01295     }
01296 
01297     <span class="keywordflow">return</span> ((<a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>) (lpMem - lpOldMem));
01298 }
01299 
01300 <span class="comment">/***************************************************************************</span>
01301 <span class="comment">*                         CreateInputArray</span>
01302 <span class="comment">*  function:</span>
01303 <span class="comment">*       Create CSA/CRD Input arrays from the data supplied in icc profile's</span>
01304 <span class="comment">*       LUT8 or LUT16 tags.</span>
01305 <span class="comment">*  parameters:</span>
01306 <span class="comment">*       MEMPTR  lpMem        -- a pointer to the buffer which will contain the arrays.</span>
01307 <span class="comment">*       SINT    nInputCh     -- Number of input channel. if lpHostClut, no meaning.</span>
01308 <span class="comment">*       SINT    nInputTable  -- saze of each array.  if lpHostClut, no meaning.</span>
01309 <span class="comment">*       SINT    Offset       -- offset of Buff, point to the 1st byte of output array in CLUT.</span>
01310 <span class="comment">*                               if lpHostClut, no meaning.</span>
01311 <span class="comment">*       MEMPTR  Intent       -- </span>
01312 <span class="comment">*       CSIG    Tag          -- LUT8 or LUT16</span>
01313 <span class="comment">*       MEMPTR  Buff         -- point to a buffer which contains LUT8 or LUT16.</span>
01314 <span class="comment">*                               if NULL, use lpHostClut.</span>
01315 <span class="comment">*       BOOL    AllowBinary  --</span>
01316 <span class="comment">*       MEMPTR  lpHostClut   -- point to host CSA/CRD. if NULL, use Buff.</span>
01317 <span class="comment">*  returns:</span>
01318 <span class="comment">*       SINT                 -- The size of inpput array created.</span>
01319 <span class="comment">***************************************************************************/</span>
01320 
01321 <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>
<a name="l01322"></a><a class="code" href="../../d9/d5/dec97_2dll32_2profcrd_8c.html#a21">01322</a> <a class="code" href="../../d2/d9/ps2_8c.html#a215">CreateInputArray</a> (MEMPTR lpMem, SINT nInputCh, 
01323     SINT nInputTable, MEMPTR Intent, CSIG Tag, 
01324     MEMPTR Buff, BOOL bAllowBinary, MEMPTR lpHostClut)
01325 {
01326     <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a> i, j;
01327     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a> lpOldMem;
01328     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a> lpTable;
01329     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a> lpLineStart;
01330     lpOldMem = lpMem;
01331 
01332     <span class="keywordflow">if</span> (lpHostClut)
01333     {
01334         nInputCh = (<a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>)(((<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a>)lpHostClut)-&gt;inputChan);
01335         nInputTable = (<a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>)(((<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a>)lpHostClut)-&gt;inputEnt);
01336         Tag = (((<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a>)lpHostClut)-&gt;lutBits == 8)? 
01337                <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a91">icSigLut8Type</a> : <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a90">icSigLut16Type</a>;
01338     }
01339 
01340     <span class="keywordflow">for</span> (i = 0; i &lt; nInputCh; i++)
01341     {
01342         lpLineStart = lpMem;
01343         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a56">NewLine</a>);
01344         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a57">Slash</a>);
01345         <span class="keywordflow">if</span> (lpHostClut)
01346             lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a79">PreViewInArray</a>);
01347         <span class="keywordflow">else</span>
01348             lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a77">InputArray</a>);
01349         lpMem += <a class="code" href="../../d8/d9/jul98_2test_2csprof_8h.html#a44">WriteObjectN</a> (lpMem, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a28">Intent</a>, lstrlen (<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a28">Intent</a>));
01350         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a44">WriteInt</a> (lpMem, i);
01351 
01352         <span class="keywordflow">if</span> (lpHostClut)
01353         {
01354             lpTable = ((<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a>)lpHostClut)-&gt;inputArray[i];
01355         }
01356         <span class="keywordflow">else</span>
01357         {
01358             <span class="keywordflow">if</span> (Tag == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a91">icSigLut8Type</a>)
01359                 lpTable = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>) (((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a37">lpcpLut8Type</a>) Buff)-&gt;lut.data) + nInputTable * i;
01360             <span class="keywordflow">else</span>
01361                 lpTable = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>) (((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a36">lpcpLut16Type</a>) Buff)-&gt;lut.data) + 2 * nInputTable * i;
01362         }
01363         <span class="keywordflow">if</span> (!bAllowBinary)               <span class="comment">// Output ASCII CRD</span>
01364         {
01365             <span class="keywordflow">if</span> (Tag == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a91">icSigLut8Type</a>)
01366             {
01367                 lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a2">BeginString</a>);
01368                 lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a227">WriteHexBuffer</a> (lpMem, lpTable,lpLineStart, nInputTable);
01369                 lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a3">EndString</a>);
01370             } <span class="keywordflow">else</span>
01371             {
01372                 lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a4">BeginArray</a>);
01373                 <span class="keywordflow">for</span> (j = 0; j &lt; nInputTable; j++)
01374                 {
01375                     <span class="keywordflow">if</span>(lpHostClut)
01376                         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a44">WriteInt</a> (lpMem, *((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)lpTable));
01377                     <span class="keywordflow">else</span>
01378                         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a44">WriteInt</a> (lpMem, <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a2">ui16toSINT</a> (lpTable));
01379                     lpTable += <span class="keyword">sizeof</span> (<a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a185">icUInt16Number</a>);
01380                     <span class="keywordflow">if</span> (((<a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>) (lpMem - lpLineStart)) &gt; <a class="code" href="../../d2/d9/aug98_2dll32_2csprof_8h.html#a4">MAX_LINELENG</a>)
01381                     {
01382                         lpLineStart = lpMem;
01383                         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a56">NewLine</a>);
01384                     }
01385                 }
01386                 lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a5">EndArray</a>);
01387             }
01388         } <span class="keywordflow">else</span>
01389         {                               <span class="comment">// Output BINARY CRD</span>
01390             <span class="keywordflow">if</span> (Tag == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a91">icSigLut8Type</a>)
01391             {
01392                 lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a228">WriteStringToken</a> (lpMem, 143, 256);
01393                 lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a229">WriteByteString</a> (lpMem, lpTable, 256<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01394             } <span class="keywordflow">else</span>
01395             {
01396                 lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a224">WriteHNAToken</a> (lpMem, 149, nInputTable);
01397                 <span class="keywordflow">if</span> (lpHostClut)
01398                     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a226">WriteIntStringU2S_L</a> (lpMem, lpTable, nInputTable);
01399                 <span class="keywordflow">else</span>
01400                     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a225">WriteIntStringU2S</a> (lpMem, lpTable, nInputTable);
01401             }
01402         }
01403         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a49">DefOp</a>);
01404     }
01405 
01406     <span class="keywordflow">return</span> ((<a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>) (lpMem - lpOldMem));
01407 }
01408 
01409 <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>
<a name="l01410"></a><a class="code" href="../../d9/d5/dec97_2dll32_2profcrd_8c.html#a22">01410</a> <a class="code" href="../../d2/d9/ps2_8c.html#a205">SendCRDLMN</a>(MEMPTR lpMem, CSIG Intent, LPSFLOAT whitePoint, LPSFLOAT mediaWP, CSIG pcs)
01411 {
01412     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>  lpOldMem;
01413     <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>    i, j;
01414 
01415     lpOldMem = lpMem;
01416 
01417 <span class="comment">//********** /MatrixLMN</span>
01418     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a145">icAbsoluteColorimetric</a> == <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a28">Intent</a>)
01419     {
01420         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a56">NewLine</a>);
01421         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a27">MatrixLMNTag</a>);
01422 
01423         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a4">BeginArray</a>);
01424         <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++)
01425         {
01426             <span class="keywordflow">for</span> (j = 0; j &lt; 3; j++)
01427                 lpMem += <a class="code" href="../../d8/d9/jul98_2test_2csprof_8h.html#a46">WriteFloat</a> (lpMem,
01428                     (<span class="keywordtype">double</span>) (i == j) ? whitePoint[i] / mediaWP[i] : 0.0);
01429         }
01430         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a5">EndArray</a>);
01431     }
01432  <span class="comment">//********** /RangeLMN</span>
01433     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a56">NewLine</a>);
01434     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a26">RangeLMNTag</a>);
01435     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/monitor_8c.html#a2">pcs</a> == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a109">icSigXYZData</a>)
01436     {
01437         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a4">BeginArray</a>);
01438         <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++)
01439         {
01440             lpMem += <a class="code" href="../../d8/d9/jul98_2test_2csprof_8h.html#a46">WriteFloat</a> (lpMem, (<span class="keywordtype">double</span>) 0);
01441             lpMem += <a class="code" href="../../d8/d9/jul98_2test_2csprof_8h.html#a46">WriteFloat</a> (lpMem, (<span class="keywordtype">double</span>) whitePoint[i]);
01442         }
01443         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a5">EndArray</a>);
01444     } <span class="keywordflow">else</span>
01445     {
01446         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a100">RangeLMNLab</a>);
01447     }
01448 
01449  <span class="comment">//********** /EncodeLMN</span>
01450     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a56">NewLine</a>);
01451     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a28">EncodeLMNTag</a>);
01452     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a4">BeginArray</a>);
01453     <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++)
01454     {
01455         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a6">BeginFunction</a>);
01456         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/monitor_8c.html#a2">pcs</a> != <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a109">icSigXYZData</a>)
01457         {
01458             lpMem += <a class="code" href="../../d8/d9/jul98_2test_2csprof_8h.html#a46">WriteFloat</a> (lpMem, (<span class="keywordtype">double</span>)whitePoint[i]);
01459             lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a55">DivOp</a>);
01460             lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a101">EncodeLMNLab</a>);
01461         }
01462         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a7">EndFunction</a>);
01463     }
01464     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a5">EndArray</a>);
01465 
01466     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>)(lpMem - lpOldMem);
01467 }
01468 
01469 
01470 <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>
<a name="l01471"></a><a class="code" href="../../d9/d5/dec97_2dll32_2profcrd_8c.html#a23">01471</a> <a class="code" href="../../d2/d9/ps2_8c.html#a204">SendCRDPQR</a>(MEMPTR lpMem, CSIG Intent, LPSFLOAT whitePoint)
01472 {
01473     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>  lpOldMem;
01474     <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>    i;
01475 
01476     lpOldMem = lpMem;
01477 
01478 <span class="comment">//********** /RangePQR</span>
01479     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a56">NewLine</a>);
01480     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a19">RangePQRTag</a>);
01481     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a4">BeginArray</a>);
01482     <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++)
01483     {
01484         lpMem += <a class="code" href="../../d8/d9/jul98_2test_2csprof_8h.html#a46">WriteFloat</a> (lpMem, (<span class="keywordtype">double</span>) 0);
01485         lpMem += <a class="code" href="../../d8/d9/jul98_2test_2csprof_8h.html#a46">WriteFloat</a> (lpMem, (<span class="keywordtype">double</span>)(whitePoint[i]));
01486     }
01487     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a5">EndArray</a>);
01488 
01489 <span class="comment">//********** /MatrixPQR</span>
01490     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a56">NewLine</a>);
01491     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a21">MatrixPQRTag</a>);
01492     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a71">Identity</a>);
01493 
01494 <span class="comment">//********** /TransformPQR</span>
01495     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a56">NewLine</a>);
01496     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a20">TransformPQRTag</a>);
01497     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a4">BeginArray</a>);
01498     <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++)
01499     {
01500         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a6">BeginFunction</a>);
01501         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem,
01502             (<a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a145">icAbsoluteColorimetric</a> != <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a28">Intent</a>) ? <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a108">TransformPQR</a>[i] : <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a43">NullOp</a>);
01503         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a7">EndFunction</a>);
01504     }
01505     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a5">EndArray</a>);
01506    
01507     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>)(lpMem - lpOldMem);
01508 } 
01509 
01510 <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>
<a name="l01511"></a><a class="code" href="../../d9/d5/dec97_2dll32_2profcrd_8c.html#a24">01511</a> <a class="code" href="../../d2/d9/ps2_8c.html#a206">SendCRDABC</a>(MEMPTR lpMem, MEMPTR PublicArrayName, CSIG pcs, SINT nInputCh,
01512            MEMPTR Buff, LPSFLOAT e, CSIG LutTag, BOOL bAllowBinary)
01513 {
01514     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>  lpOldMem;
01515     <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>    i, j;
01516     <span class="keywordtype">double</span> TempMatrixABC[9];
01517     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a> lpTable;
01518     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a> lpLineStart;
01519     lpOldMem = lpMem;
01520 
01521  <span class="comment">//********** /RangeABC</span>
01522     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a56">NewLine</a>);
01523     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a22">RangeABCTag</a>);
01524     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a69">RangeABC</a>);
01525  <span class="comment">//********** /MatrixABC</span>
01526     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a56">NewLine</a>);
01527     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a24">MatrixABCTag</a>);
01528     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/monitor_8c.html#a2">pcs</a> == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a109">icSigXYZData</a>)
01529     {
01530         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a4">BeginArray</a>);
01531         <span class="keywordflow">if</span> (e)
01532         {
01533             <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++)
01534             {
01535                 <span class="keywordflow">for</span> (j = 0; j &lt; 3; j++)
01536                 {
01537                     lpMem += <a class="code" href="../../d8/d9/jul98_2test_2csprof_8h.html#a46">WriteFloat</a> (lpMem, e[i + j * 3]);
01538                 }
01539             }
01540         }
01541         <span class="keywordflow">else</span>
01542         {
01543             <span class="keywordflow">if</span> (LutTag == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a91">icSigLut8Type</a>)
01544             {
01545                 lpTable = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>) &amp; ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a37">lpcpLut8Type</a>) Buff)-&gt;lut.e00;
01546             } <span class="keywordflow">else</span>
01547             {
01548                 lpTable = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>) &amp; ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a36">lpcpLut16Type</a>) Buff)-&gt;lut.e00;
01549             }
01550             <span class="keywordflow">for</span> (i = 0; i &lt; 9; i++)
01551             {
01552                 TempMatrixABC[i] = ((<span class="keywordtype">double</span>) <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a9">si16f16toSFLOAT</a> (lpTable)) / <a class="code" href="../../d2/d9/aug98_2dll32_2csprof_8h.html#a3">CIEXYZRange</a>;
01553                 lpTable += <span class="keyword">sizeof</span> (<a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a192">icS15Fixed16Number</a>);
01554             }
01555             <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++)
01556             {
01557                 <span class="keywordflow">for</span> (j = 0; j &lt; 3; j++)
01558                 {
01559                     lpMem += <a class="code" href="../../d8/d9/jul98_2test_2csprof_8h.html#a46">WriteFloat</a> (lpMem, TempMatrixABC[i + j * 3]);
01560                 }
01561             }
01562         }
01563         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a5">EndArray</a>);
01564     } <span class="keywordflow">else</span>
01565     {
01566         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a102">MatrixABCLabCRD</a>);
01567     }
01568  <span class="comment">//********** /EncodeABC</span>
01569     lpLineStart = lpMem;
01570     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a56">NewLine</a>);
01571     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a25">EncodeABCTag</a>);
01572     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a4">BeginArray</a>);
01573     <span class="keywordflow">for</span> (i = 0; i &lt; nInputCh; i++)
01574     {
01575         lpLineStart = lpMem;
01576         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a56">NewLine</a>);
01577 
01578         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a6">BeginFunction</a>);
01579         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/monitor_8c.html#a2">pcs</a> == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a110">icSigLabData</a>)
01580         {
01581             lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem,
01582                                   (0 == i) ? <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a104">EncodeABCLab1</a> : <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a105">EncodeABCLab2</a>);
01583         }
01584         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a89">StartClip</a>);
01585         <span class="keywordflow">if</span> (e)
01586             lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a79">PreViewInArray</a>);
01587         <span class="keywordflow">else</span>
01588             lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a77">InputArray</a>);
01589         lpMem += <a class="code" href="../../d8/d9/jul98_2test_2csprof_8h.html#a44">WriteObjectN</a> (lpMem, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>) PublicArrayName, lstrlen (PublicArrayName));
01590         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a44">WriteInt</a> (lpMem, i);
01591 
01592         <span class="keywordflow">if</span> (!bAllowBinary)              <span class="comment">// Output ASCII CRD</span>
01593         {
01594             lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a56">NewLine</a>);
01595             lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a84">IndexArray</a>);
01596         } <span class="keywordflow">else</span>
01597         {                               <span class="comment">// Output BINARY CRD</span>
01598             <span class="keywordflow">if</span> (LutTag == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a91">icSigLut8Type</a>)
01599             {
01600                 lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a84">IndexArray</a>);
01601             } <span class="keywordflow">else</span>
01602             {
01603                 lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a83">IndexArray16b</a>);
01604             }
01605         }
01606         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, (LutTag == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a91">icSigLut8Type</a>) ? 
01607                               <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a91">Scale8</a> : <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a92">Scale16</a>);
01608         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a90">EndClip</a>);
01609         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a7">EndFunction</a>);
01610     }
01611     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a5">EndArray</a>);
01612     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>)(lpMem - lpOldMem);
01613 }
01614 
01615 <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>
<a name="l01616"></a><a class="code" href="../../d9/d5/dec97_2dll32_2profcrd_8c.html#a25">01616</a> <a class="code" href="../../d2/d9/ps2_8c.html#a203">SendCRDBWPoint</a>(MEMPTR lpMem, LPSFLOAT whitePoint)
01617 {
01618     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>  lpOldMem;
01619     <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>    i;
01620 
01621     lpOldMem = lpMem;
01622 
01623 <span class="comment">//********** /BlackPoint</span>
01624     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a56">NewLine</a>);
01625     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a18">BlackPointTag</a>);
01626     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a10">BlackPoint</a>);
01627 
01628 <span class="comment">//********** /WhitePoint</span>
01629     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a56">NewLine</a>);
01630     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a17">WhitePointTag</a>);
01631     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a4">BeginArray</a>);
01632     <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++)
01633     {
01634         lpMem += <a class="code" href="../../d8/d9/jul98_2test_2csprof_8h.html#a46">WriteFloat</a> (lpMem, (<span class="keywordtype">double</span>)(whitePoint[i]));
01635     }
01636     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a5">EndArray</a>);
01637     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>)(lpMem - lpOldMem);
01638 }
01639 
<a name="l01640"></a><a class="code" href="../../d9/d5/dec97_2dll32_2profcrd_8c.html#a26">01640</a> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a> <a class="code" href="../../d2/d9/ps2_8c.html#a207">SendCRDOutputTable</a>(MEMPTR lpMem, MEMPTR PublicArrayName, 
01641         SINT nOutputCh, CSIG LutTag, BOOL bHost, BOOL bAllowBinary)
01642 {
01643     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>  lpOldMem;
01644     <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>    i;
01645 
01646     lpOldMem = lpMem;
01647 
01648     <span class="keywordflow">for</span> (i = 0; i &lt; nOutputCh; i++)
01649     {
01650         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a56">NewLine</a>);
01651         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a6">BeginFunction</a>);
01652         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a73">Clip01</a>);
01653         <span class="keywordflow">if</span> (bHost)
01654             lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a80">PreViewOutArray</a>);
01655         <span class="keywordflow">else</span>
01656             lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a78">OutputArray</a>);
01657         lpMem += <a class="code" href="../../d8/d9/jul98_2test_2csprof_8h.html#a44">WriteObjectN</a> (lpMem, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>) PublicArrayName, lstrlen (PublicArrayName));
01658         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a44">WriteInt</a> (lpMem, i);
01659 
01660         <span class="keywordflow">if</span> (!bAllowBinary)               <span class="comment">// Output ASCII CRD</span>
01661         {
01662             lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a56">NewLine</a>);
01663             <span class="keywordflow">if</span> (LutTag == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a91">icSigLut8Type</a>)
01664             {
01665                 lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a94">TFunction8</a>);
01666             } <span class="keywordflow">else</span>
01667             {
01668                 lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a84">IndexArray</a>);
01669                 lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a92">Scale16</a>);
01670             }
01671         } <span class="keywordflow">else</span>
01672         {                               <span class="comment">// Output BINARY CRD</span>
01673             <span class="keywordflow">if</span> (LutTag == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a91">icSigLut8Type</a>)
01674             {
01675                 lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a94">TFunction8</a>);
01676             } <span class="keywordflow">else</span>
01677             {
01678                 lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a83">IndexArray16b</a>);
01679                 lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a92">Scale16</a>);
01680             }
01681         }
01682 
01683         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a7">EndFunction</a>);
01684     }
01685     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>)(lpMem - lpOldMem);
01686 }
01687 
01688 <span class="comment">//========================================================================</span>
01689 <span class="comment">/***************************************************************************</span>
01690 <span class="comment">*                  GetPS2PreviewColorRenderingDictionary</span>
01691 <span class="comment">*  function:</span>
01692 <span class="comment">*    This is the main function that creates proofing CRD.</span>
01693 <span class="comment">*    It does the following:</span>
01694 <span class="comment">*       1) Creates host TargetCRD, TargetCSA and DevCRD.</span>
01695 <span class="comment">*       2) Create proofing CRD by sampling TargetCRD TargetCSA and DevCRD.</span>
01696 <span class="comment">*       3) Uses TargetCRD's input table as proofingCRD's input table.</span>
01697 <span class="comment">*       4) Uses DevCRD's output table as proofingCRD's output table.</span>
01698 <span class="comment">*       5) Sample data is XYZ or Lab, depends on PCS of TargetCRD.</span>
01699 <span class="comment">*</span>
01700 <span class="comment">*  parameters:</span>
01701 <span class="comment">*       CHANDLE  cpDev        -- handle to Target icc profile.</span>
01702 <span class="comment">*       CHANDLE  cpTarget     -- handle to Dev icc profile.</span>
01703 <span class="comment">*       DWORD    Intent       -- intent </span>
01704 <span class="comment">*       MEMPTR   lpMem        -- pointer to buffer for proofCRD,</span>
01705 <span class="comment">*                                NULL means query buffer size.</span>
01706 <span class="comment">*       LPDWORD  lpcbSize     -- as input: current buffer size</span>
01707 <span class="comment">*                             -- as output: real proofCRD size.</span>
01708 <span class="comment">*       BOOL     bAllowBinary -- create a ascii or binary proofCRD.</span>
01709 <span class="comment">*</span>
01710 <span class="comment">*  returns:</span>
01711 <span class="comment">*       BOOL                  -- TRUE/FALSE</span>
01712 <span class="comment">***************************************************************************/</span>
01713 
01714 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a0">EXTERN</a>
<a name="l01715"></a><a class="code" href="../../d9/d5/dec97_2dll32_2profcrd_8c.html#a27">01715</a> <a class="code" href="../../d8/d6/jul98_2test_2profcrd_8h.html#a4">GetPS2PreviewColorRenderingDictionary</a> (CHANDLE cpDev,
01716                                 CHANDLE cpTarget,
01717                                 DWORD Intent,
01718                                 MEMPTR lpMem,
01719                                 LPDWORD lpcbSize,
01720                                 BOOL bAllowBinary)
01721 {
01722     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>    lpTargetCRD, lpTargetCSA, lpDevCRD;
01723     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>     cbTargetCRD, cbTargetCSA, cbDevCRD;
01724     HGLOBAL   hTargetCRD, hTargetCSA, hDevCRD;
01725     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>      Success = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01726     <span class="keywordtype">float</span>     Input[<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a0">MAXCHANNELS</a>];
01727     <span class="keywordtype">float</span>     Output[<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a0">MAXCHANNELS</a>];
01728     <span class="keywordtype">float</span>     Temp[<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a0">MAXCHANNELS</a>];
01729     <span class="keywordtype">int</span>       i, j, k, l;
01730     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>    lpLineStart;
01731     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>    lpOldMem;
01732     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a17">CSIG</a>      ColorSpace;
01733     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a17">CSIG</a>      DevColorSpace;
01734     <span class="keyword">static</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a17">CSIG</a>      IntentTag;
01735     <span class="keyword">static</span> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>      PreviewCRDGrid;
01736     <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>      OutArraySize, InArraySize;
01737     <span class="keywordtype">char</span>      PublicArrayName[<a class="code" href="../../d8/d8/aug98_2dll32_2csprof_8c.html#a1">TempBfSize</a>];
01738     <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>      TargetGrids, DevGrids;
01739 
01740     <span class="comment">// First pass, return the size of Previewind CRD.</span>
01741     <span class="keywordflow">if</span> (lpMem == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01742     {
01743         <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>   dwOutArraySizr = 0;
01744 
01745         i = 3;      <span class="comment">// Default output channal;</span>
01746         <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d9/ps2_8c.html#a41">GetCPDevSpace</a> (cpDev, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a27">LPCSIG</a>) &amp; DevColorSpace)) &amp;&amp;
01747                           (DevColorSpace == <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a118">icSigCmykData</a>))
01748         {
01749             i = 4;
01750         }
01751 
01752         <span class="comment">// Get the input array size IntentTag and Grid of the Target icc profile.</span>
01753         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9/ps2_8c.html#a199">GetCRDInputOutputArraySize</a>(cpTarget, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a28">Intent</a>,
01754             &amp;InArraySize, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;IntentTag, &amp;TargetGrids ))
01755             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01756 
01757         <span class="comment">// Get the output array size IntentTag and Grid of the Dev icc profile.</span>
01758         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9/ps2_8c.html#a199">GetCRDInputOutputArraySize</a>(cpDev, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a28">Intent</a>,
01759             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;OutArraySize, &amp;IntentTag, &amp;DevGrids ))
01760             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01761 
01762         PreviewCRDGrid = (TargetGrids &gt; DevGrids)? TargetGrids: DevGrids;
01763 
01764         <span class="comment">// Min proofing CRD grid will be PREVIEWCRDGRID</span>
01765         <span class="keywordflow">if</span> (PreviewCRDGrid &lt; <a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a1">PREVIEWCRDGRID</a>)
01766             PreviewCRDGrid = <a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a1">PREVIEWCRDGRID</a>;
01767         *lpcbSize = PreviewCRDGrid * PreviewCRDGrid * PreviewCRDGrid * 
01768                     i * 2 +           <span class="comment">// CLUT size (Hex output)</span>
01769                     OutArraySize +    <span class="comment">// Output Array size</span>
01770                     InArraySize  +    <span class="comment">// Input Array size</span>
01771                     4096;             <span class="comment">// Extra PostScript staff.</span>
01772          <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01773     }
01774 
01775     <span class="comment">// Second pass, return the Previewind CRD.</span>
01776     lpOldMem = lpMem;
01777 
01778     <span class="comment">//Query the sizes of Host TargetCRD, TargetCSA and DevCRD.</span>
01779     <span class="keywordflow">if</span> (!(<a class="code" href="../../d2/d9/ps2_8c.html#a201">GetHostColorRenderingDictionary</a> (cpTarget, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a28">Intent</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;cbTargetCRD)) ||
01780         !(<a class="code" href="../../d2/d9/ps2_8c.html#a202">GetHostColorSpaceArray</a> (cpTarget, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a28">Intent</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;cbTargetCSA)) ||
01781         !(<a class="code" href="../../d2/d9/ps2_8c.html#a201">GetHostColorRenderingDictionary</a> (cpDev, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a28">Intent</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;cbDevCRD)))
01782     {
01783         <span class="keywordflow">return</span> (Success);
01784     }
01785 
01786     <span class="comment">//Alloc the buffers for Host TargetCRD, TargetCSA and DevCRD.</span>
01787     hTargetCRD = hTargetCSA = hDevCRD = 0;
01788     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a7">MemAlloc</a> (cbTargetCRD, (HGLOBAL <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *)&amp;hTargetCRD, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a29">LPMEMPTR</a>)&amp;lpTargetCRD) ||
01789         !<a class="code" href="../../d2/d1/object_8c.html#a7">MemAlloc</a> (cbTargetCSA, (HGLOBAL <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *)&amp;hTargetCSA, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a29">LPMEMPTR</a>)&amp;lpTargetCSA) ||
01790         !<a class="code" href="../../d2/d1/object_8c.html#a7">MemAlloc</a> (cbDevCRD, (HGLOBAL <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *)&amp;hDevCRD, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a29">LPMEMPTR</a>)&amp;lpDevCRD))
01791     {
01792         <span class="keywordflow">goto</span> Done;
01793     }
01794 
01795     <span class="comment">//Build Host TargetCRD, TargetCSA and DevCRD.</span>
01796     <span class="keywordflow">if</span> (!(<a class="code" href="../../d2/d9/ps2_8c.html#a201">GetHostColorRenderingDictionary</a> (cpTarget, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a28">Intent</a>, lpTargetCRD, &amp;cbTargetCRD)) ||
01797         !(<a class="code" href="../../d2/d9/ps2_8c.html#a202">GetHostColorSpaceArray</a> (cpTarget, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a28">Intent</a>, lpTargetCSA, &amp;cbTargetCSA)) ||
01798         !(<a class="code" href="../../d2/d9/ps2_8c.html#a201">GetHostColorRenderingDictionary</a> (cpDev, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a28">Intent</a>, lpDevCRD, &amp;cbDevCRD)))
01799     {
01800         <span class="keywordflow">goto</span> Done;
01801     }
01802 
01803 <span class="comment">//  Build Proofing CRD based on Host TargetCRD TargetCSA and DevCRD.</span>
01804 <span class="comment">//  We use TargetCRD input tables and matrix as the</span>
01805 <span class="comment">//  input tables and matrix of the ProofCRD.</span>
01806 <span class="comment">//  We use DevCRD output tables as the output tables of the ProofCRD.</span>
01807 
01808 <span class="comment">//******** Define golbal array used in EncodeABC and RenderTaber</span>
01809     <a class="code" href="../../d2/d9/ps2_8c.html#a217">GetPublicArrayName</a> (cpDev, IntentTag, PublicArrayName);
01810     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a56">NewLine</a>);
01811     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a59">CRDBegin</a>);
01812 
01813     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a220">EnableGlobalDict</a>(lpMem);
01814 
01815     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a215">CreateInputArray</a> (lpMem, (<a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>)0, (<a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>)0, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>)PublicArrayName, 
01816              (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a17">CSIG</a>)0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, bAllowBinary, lpTargetCRD);
01817 
01818     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a216">CreateOutputArray</a> (lpMem, (<a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>)0, (<a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>)0, (<a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>)0, 
01819              (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a19">MEMPTR</a>)PublicArrayName, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a17">CSIG</a>)0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, bAllowBinary, lpDevCRD);
01820 
01821     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a56">NewLine</a>);
01822     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a48">SetGlobalOp</a>);
01823     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a51">EndOp</a>);
01824 
01825 <span class="comment">//************* Start writing  CRD  ****************************</span>
01826     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a56">NewLine</a>);
01827     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a8">BeginDict</a>);    <span class="comment">// Begin dictionary</span>
01828     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a11">DictType</a>); <span class="comment">// Dictionary type</span>
01829 
01830 <span class="comment">//********** Send Black/White Point.</span>
01831     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a203">SendCRDBWPoint</a>(lpMem, 
01832         ((<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a>)lpTargetCRD)-&gt;whitePoint);
01833 
01834 <span class="comment">//********** Send PQR - For White Point correction</span>
01835     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a204">SendCRDPQR</a>(lpMem, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a28">Intent</a>, 
01836         ((<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a>)lpTargetCRD)-&gt;whitePoint);
01837 
01838 <span class="comment">//********** Send LMN - For Absolute Colorimetric use WhitePoint's XYZs</span>
01839     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a205">SendCRDLMN</a>(lpMem, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a28">Intent</a>, 
01840         ((<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a>)lpTargetCRD)-&gt;whitePoint,
01841         ((<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a>)lpTargetCRD)-&gt;mediaWP,
01842         ((<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a>)lpTargetCRD)-&gt;<a class="code" href="../../d7/d3/monitor_8c.html#a2">pcs</a>);
01843 
01844 <span class="comment">//********** Create MatrixABC and  EncodeABC  stuff</span>
01845     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a206">SendCRDABC</a>(lpMem, PublicArrayName, 
01846         ((<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a>)lpTargetCRD)-&gt;<a class="code" href="../../d7/d3/monitor_8c.html#a2">pcs</a>,
01847         ((<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a>)lpTargetCRD)-&gt;inputChan,
01848         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01849         ((<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a>)lpTargetCRD)-&gt;e,
01850         (((<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a>)lpTargetCRD)-&gt;lutBits == 8)? icSigLut8Type:icSigLut16Type,
01851         bAllowBinary);
01852 
01853 <span class="comment">//********** /RenderTable</span>
01854     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a56">NewLine</a>);
01855     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a29">RenderTableTag</a>);
01856     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a4">BeginArray</a>);
01857 
01858     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a44">WriteInt</a> (lpMem, PreviewCRDGrid);  <span class="comment">// Send down Na</span>
01859     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a44">WriteInt</a> (lpMem, PreviewCRDGrid);  <span class="comment">// Send down Nb</span>
01860     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a44">WriteInt</a> (lpMem, PreviewCRDGrid);  <span class="comment">// Send down Nc</span>
01861 
01862     lpLineStart = lpMem;
01863     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a56">NewLine</a>);
01864     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a4">BeginArray</a>);
01865     ColorSpace = ((<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a>)lpDevCRD)-&gt;pcs;
01866     <span class="keywordflow">for</span> (i = 0; i &lt; PreviewCRDGrid; i++)        <span class="comment">// Na strings should be sent</span>
01867     {
01868         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a56">NewLine</a>);
01869         lpLineStart = lpMem;
01870         <span class="keywordflow">if</span> (bAllowBinary)
01871         {
01872             lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a228">WriteStringToken</a> (lpMem, 143, 
01873                 PreviewCRDGrid * PreviewCRDGrid * ((<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a>)lpDevCRD)-&gt;outputChan);
01874         }
01875         <span class="keywordflow">else</span>
01876         {
01877             lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a2">BeginString</a>);
01878         }
01879         Input[0] = ((<span class="keywordtype">float</span>)i) / (PreviewCRDGrid - 1);
01880         <span class="keywordflow">for</span> (j = 0; j &lt; PreviewCRDGrid; j++)
01881         {
01882             Input[1] = ((<span class="keywordtype">float</span>)j) / (PreviewCRDGrid - 1);
01883             <span class="keywordflow">for</span> (k = 0; k &lt; PreviewCRDGrid; k++)
01884             {
01885                 Input[2] = ((<span class="keywordtype">float</span>)k) / (PreviewCRDGrid - 1);
01886 
01887                 <a class="code" href="../../d2/d9/ps2_8c.html#a243">DoHostConversionCRD</a> ((<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a>)lpTargetCRD, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, Input, Output, ColorSpace, 1);
01888                 <a class="code" href="../../d2/d9/ps2_8c.html#a242">DoHostConversionCSA</a> ((<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a>)lpTargetCSA, Output, Temp);
01889                 <a class="code" href="../../d2/d9/ps2_8c.html#a243">DoHostConversionCRD</a> ((<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a>)lpDevCRD, (<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a>)lpTargetCSA, 
01890                                      Temp, Output, 0, 0);
01891                 <span class="keywordflow">for</span> (l = 0; l &lt; ((<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a>)lpDevCRD)-&gt;outputChan; l++)
01892                 {
01893                     <span class="keywordflow">if</span> (bAllowBinary)
01894                     {
01895                         *lpMem++ = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a12">BYTES</a>)(Output[l]*255);
01896                     }
01897                     <span class="keywordflow">else</span>
01898                     {
01899                         lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a45">WriteHex</a> (lpMem, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(Output[l]*255));
01900                         <span class="keywordflow">if</span> (((<a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a6">SINT</a>) (lpMem - lpLineStart)) &gt; <a class="code" href="../../d2/d9/aug98_2dll32_2csprof_8h.html#a4">MAX_LINELENG</a>)
01901                         {
01902                             lpLineStart = lpMem;
01903                             lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a56">NewLine</a>);
01904                         }
01905                     }
01906                 }
01907             }
01908         }
01909         <span class="keywordflow">if</span> (!bAllowBinary)
01910             lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a3">EndString</a>);
01911     }
01912     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a56">NewLine</a>);
01913     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a5">EndArray</a>);
01914     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a44">WriteInt</a> (lpMem, ((<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a>)lpDevCRD)-&gt;outputChan);
01915 
01916 <span class="comment">//********** Send Output Table.</span>
01917     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a207">SendCRDOutputTable</a>(lpMem, PublicArrayName, 
01918         ((<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a>)lpDevCRD)-&gt;outputChan,
01919         (((<a class="code" href="../../d2/d6/aug98_2dll32_2profcrd_8h.html#a3">LPHOSTCLUT</a>)lpDevCRD)-&gt;lutBits == 8)? icSigLut8Type:icSigLut16Type,
01920         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01921         bAllowBinary);
01922 
01923 
01924     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a56">NewLine</a>);
01925     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a5">EndArray</a>);
01926     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a9">EndDict</a>); <span class="comment">// End dictionary definition</span>
01927     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a56">NewLine</a>);
01928     lpMem += <a class="code" href="../../d2/d9/ps2_8c.html#a43">WriteObject</a> (lpMem, <a class="code" href="../../d6/d2/aug98_2dll32_2getcrd_8c.html#a60">CRDEnd</a>);
01929     Success = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01930 
01931 Done:
01932     *lpcbSize = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(lpMem - lpOldMem);
01933 
01934     <span class="keywordflow">if</span> (hTargetCRD)
01935          <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(hTargetCRD);
01936     <span class="keywordflow">if</span> (hTargetCSA)
01937          <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(hTargetCSA);
01938     <span class="keywordflow">if</span> (hDevCRD)
01939          <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(hDevCRD);
01940     <span class="keywordflow">return</span> (Success);
01941 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:27 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
