<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: verifier.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>verifier.c</h1><a href="../../d9/d5/verifier_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">   verifier.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the routines to verify system drivers.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Landy Wang (landyw) 3-Sep-1998</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00021 
<a name="l00022"></a><a class="code" href="../../d9/d5/verifier_8c.html#a0">00022</a> <span class="preprocessor">#define THUNKED_API</span>
00023 <span class="preprocessor"></span>
00024 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00025 PVOID
00026 <a class="code" href="../../d9/d5/verifier_8c.html#a54">VerifierAllocatePool</a>(
00027     IN POOL_TYPE PoolType,
00028     IN SIZE_T NumberOfBytes
00029     );
00030 
00031 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00032 PVOID
00033 <a class="code" href="../../d9/d5/verifier_8c.html#a55">VerifierAllocatePoolWithTag</a>(
00034     IN POOL_TYPE PoolType,
00035     IN SIZE_T NumberOfBytes,
00036     IN ULONG Tag
00037     );
00038 
00039 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00040 PVOID
00041 <a class="code" href="../../d9/d5/verifier_8c.html#a56">VerifierAllocatePoolWithQuotaTag</a>(
00042     IN POOL_TYPE PoolType,
00043     IN SIZE_T NumberOfBytes,
00044     IN ULONG Tag
00045     );
00046 
00047 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00048 PVOID
00049 <a class="code" href="../../d9/d5/verifier_8c.html#a57">VerifierAllocatePoolWithTagPriority</a>(
00050     IN POOL_TYPE PoolType,
00051     IN SIZE_T NumberOfBytes,
00052     IN ULONG Tag,
00053     IN EX_POOL_PRIORITY Priority
00054     );
00055 
00056 PVOID
00057 <a class="code" href="../../d9/d5/verifier_8c.html#a58">VeAllocatePoolWithTagPriority</a>(
00058     IN POOL_TYPE PoolType,
00059     IN SIZE_T NumberOfBytes,
00060     IN ULONG Tag,
00061     IN EX_POOL_PRIORITY Priority,
00062     IN PVOID CallingAddress
00063     );
00064 
00065 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00066 <a class="code" href="../../d9/d5/verifier_8c.html#a59">VerifierFreePool</a>(
00067     IN PVOID P
00068     );
00069 
00070 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00071 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00072 <a class="code" href="../../d9/d5/verifier_8c.html#a60">VerifierFreePoolWithTag</a>(
00073     IN PVOID P,
00074     IN ULONG TagToFree
00075     );
00076 
00077 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00078 LONG
00079 <a class="code" href="../../d9/d5/verifier_8c.html#a61">VerifierSetEvent</a>(
00080     IN <a class="code" href="../../d2/d6/struct__KEVENT.html">PRKEVENT</a> Event,
00081     IN KPRIORITY Increment,
00082     IN BOOLEAN Wait
00083     );
00084 
00085 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00086 KIRQL
00087 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
00088 <a class="code" href="../../d9/d5/verifier_8c.html#a62">VerifierKfRaiseIrql</a> (
00089     IN KIRQL NewIrql
00090     );
00091 
00092 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00093 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00094 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
00095 <a class="code" href="../../d9/d5/verifier_8c.html#a63">VerifierKfLowerIrql</a> (
00096     IN KIRQL NewIrql
00097     );
00098 
00099 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00100 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00101 <a class="code" href="../../d9/d5/verifier_8c.html#a64">VerifierKeRaiseIrql</a> (
00102     IN KIRQL NewIrql,
00103     OUT PKIRQL OldIrql
00104     );
00105 
00106 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00107 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00108 <a class="code" href="../../d9/d5/verifier_8c.html#a65">VerifierKeLowerIrql</a> (
00109     IN KIRQL NewIrql
00110     );
00111 
00112 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00113 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00114 <a class="code" href="../../d9/d5/verifier_8c.html#a66">VerifierKeAcquireSpinLock</a> (
00115     IN PKSPIN_LOCK SpinLock,
00116     OUT PKIRQL OldIrql
00117     );
00118 
00119 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00120 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00121 <a class="code" href="../../d9/d5/verifier_8c.html#a67">VerifierKeReleaseSpinLock</a> (
00122     IN PKSPIN_LOCK SpinLock,
00123     IN KIRQL NewIrql
00124     );
00125 
00126 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00127 KIRQL
00128 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
00129 <a class="code" href="../../d9/d5/verifier_8c.html#a68">VerifierKfAcquireSpinLock</a> (
00130     IN PKSPIN_LOCK SpinLock
00131     );
00132 
00133 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00134 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00135 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
00136 <a class="code" href="../../d9/d5/verifier_8c.html#a69">VerifierKfReleaseSpinLock</a> (
00137     IN PKSPIN_LOCK SpinLock,
00138     IN KIRQL NewIrql
00139     );
00140 
00141 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00142 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00143 <a class="code" href="../../d9/d5/verifier_8c.html#a70">VerifierKeInitializeTimerEx</a>(
00144     IN <a class="code" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer,
00145     IN TIMER_TYPE Type
00146     );
00147 
00148 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00149 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00150 <a class="code" href="../../d9/d5/verifier_8c.html#a71">VerifierKeInitializeTimer</a>(
00151     IN <a class="code" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer
00152     );
00153 
00154 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00155 BOOLEAN
00156 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
00157 <a class="code" href="../../d9/d5/verifier_8c.html#a72">VerifierExTryToAcquireFastMutex</a> (
00158     IN <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a> FastMutex
00159     );
00160 
00161 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00162 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00163 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
00164 <a class="code" href="../../d9/d5/verifier_8c.html#a73">VerifierExAcquireFastMutex</a> (
00165     IN <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a> FastMutex
00166     );
00167 
00168 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00169 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00170 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
00171 <a class="code" href="../../d9/d5/verifier_8c.html#a74">VerifierExReleaseFastMutex</a> (
00172     IN <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a> FastMutex
00173     );
00174 
00175 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00176 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00177 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
00178 <a class="code" href="../../d9/d5/verifier_8c.html#a75">VerifierExAcquireFastMutexUnsafe</a> (
00179     IN <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a> FastMutex
00180     );
00181 
00182 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00183 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00184 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
00185 <a class="code" href="../../d9/d5/verifier_8c.html#a76">VerifierExReleaseFastMutexUnsafe</a> (
00186     IN <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a> FastMutex
00187     );
00188 
00189 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00190 BOOLEAN
00191 <a class="code" href="../../d9/d5/verifier_8c.html#a77">VerifierExAcquireResourceExclusive</a>(
00192     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource,
00193     IN BOOLEAN Wait
00194     );
00195 
00196 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00197 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00198 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
00199 <a class="code" href="../../d9/d5/verifier_8c.html#a78">VerifierExReleaseResource</a>(
00200     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource
00201     );
00202 
00203 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00204 KIRQL
00205 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
00206 <a class="code" href="../../d9/d5/verifier_8c.html#a79">VerifierKeAcquireQueuedSpinLock</a> (
00207     IN KSPIN_LOCK_QUEUE_NUMBER Number
00208     );
00209 
00210 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00211 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00212 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
00213 <a class="code" href="../../d9/d5/verifier_8c.html#a80">VerifierKeReleaseQueuedSpinLock</a> (
00214     IN KSPIN_LOCK_QUEUE_NUMBER Number,
00215     IN KIRQL OldIrql
00216     );
00217 
00218 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00219 BOOLEAN
00220 <a class="code" href="../../d9/d5/verifier_8c.html#a81">VerifierSynchronizeExecution</a> (
00221     IN <a class="code" href="../../d0/d7/struct__KINTERRUPT.html">PKINTERRUPT</a> Interrupt,
00222     IN <a class="code" href="../../d0/d9/ntosdef_8h.html#a44">PKSYNCHRONIZE_ROUTINE</a> SynchronizeRoutine,
00223     IN PVOID SynchronizeContext
00224     );
00225 
00226 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00227 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00228 <a class="code" href="../../d9/d5/verifier_8c.html#a82">VerifierProbeAndLockPages</a> (
00229     IN OUT <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList,
00230     IN KPROCESSOR_MODE AccessMode,
00231     IN <a class="code" href="../../d2/d1/mm_8h.html#a141">LOCK_OPERATION</a> Operation
00232     );
00233 
00234 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00235 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00236 <a class="code" href="../../d9/d5/verifier_8c.html#a83">VerifierProbeAndLockProcessPages</a> (
00237     IN OUT <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList,
00238     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00239     IN KPROCESSOR_MODE AccessMode,
00240     IN LOCK_OPERATION Operation
00241     );
00242 
00243 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00244 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00245 <a class="code" href="../../d9/d5/verifier_8c.html#a84">VerifierProbeAndLockSelectedPages</a> (
00246     IN OUT <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList,
00247     IN PFILE_SEGMENT_ELEMENT SegmentArray,
00248     IN KPROCESSOR_MODE AccessMode,
00249     IN LOCK_OPERATION Operation
00250     );
00251 
00252 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00253 <a class="code" href="../../d9/d5/verifier_8c.html#a85">VerifierUnlockPages</a> (
00254      IN OUT <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList
00255      );
00256 
00257 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00258 <a class="code" href="../../d9/d5/verifier_8c.html#a86">VerifierUnmapLockedPages</a> (
00259      IN PVOID BaseAddress,
00260      IN <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList
00261      );
00262 
00263 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00264 <a class="code" href="../../d9/d5/verifier_8c.html#a87">VerifierUnmapIoSpace</a> (
00265      IN PVOID BaseAddress,
00266      IN SIZE_T NumberOfBytes
00267      );
00268 
00269 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00270 PVOID
00271 <a class="code" href="../../d9/d5/verifier_8c.html#a88">VerifierMapIoSpace</a> (
00272     IN PHYSICAL_ADDRESS PhysicalAddress,
00273     IN SIZE_T NumberOfBytes,
00274     IN <a class="code" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a> CacheType
00275     );
00276 
00277 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00278 PVOID
00279 <a class="code" href="../../d9/d5/verifier_8c.html#a89">VerifierMapLockedPages</a> (
00280     IN <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList,
00281     IN KPROCESSOR_MODE AccessMode
00282     );
00283 
00284 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00285 PVOID
00286 <a class="code" href="../../d9/d5/verifier_8c.html#a90">VerifierMapLockedPagesSpecifyCache</a> (
00287     IN <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList,
00288     IN KPROCESSOR_MODE AccessMode,
00289     IN MEMORY_CACHING_TYPE CacheType,
00290     IN PVOID RequestedAddress,
00291     IN ULONG BugCheckOnFailure,
00292     IN MM_PAGE_PRIORITY Priority
00293     );
00294 
00295 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00296 <a class="code" href="../../d9/d5/verifier_8c.html#a91">VerifierFreeTrackedPool</a>(
00297     IN PVOID VirtualAddress,
00298     IN SIZE_T ChargedBytes,
00299     IN LOGICAL CheckType,
00300     IN LOGICAL SpecialPool
00301     );
00302 
00303 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00304 <a class="code" href="../../d9/d5/verifier_8c.html#a92">ViPrintString</a> (
00305     IN PUNICODE_STRING DriverName
00306     );
00307 
00308 LOGICAL
00309 <a class="code" href="../../d9/d5/verifier_8c.html#a93">ViInjectResourceFailure</a> (
00310     VOID
00311     );
00312 
00313 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00314 <a class="code" href="../../d9/d5/verifier_8c.html#a94">ViTrimAllSystemPagableMemory</a> (
00315     VOID
00316     );
00317 
00318 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00319 <a class="code" href="../../d9/d5/verifier_8c.html#a95">ViInitializeEntry</a> (
00320     IN <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> Verifier,
00321     IN LOGICAL FirstLoad
00322     );
00323 
00324 LOGICAL
00325 <a class="code" href="../../d9/d5/verifier_8c.html#a96">ViReservePoolAllocation</a> (
00326     IN <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> Verifier
00327     );
00328 
00329 ULONG_PTR
00330 <a class="code" href="../../d9/d5/verifier_8c.html#a97">ViInsertPoolAllocation</a> (
00331     IN <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> Verifier,
00332     IN PVOID VirtualAddress,
00333     IN PVOID CallingAddress,
00334     IN SIZE_T NumberOfBytes,
00335     IN ULONG Tag
00336     );
00337 
00338 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00339 <a class="code" href="../../d9/d5/verifier_8c.html#a98">ViCancelPoolAllocation</a> (
00340     IN <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> Verifier
00341     );
00342 
00343 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00344 <a class="code" href="../../d9/d5/verifier_8c.html#a99">ViReleasePoolAllocation</a> (
00345     IN <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> Verifier,
00346     IN PVOID VirtualAddress,
00347     IN ULONG_PTR ListIndex,
00348     IN SIZE_T ChargedBytes
00349     );
00350 
00351 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00352 <a class="code" href="../../d9/d5/verifier_8c.html#a100">KfSanityCheckRaiseIrql</a> (
00353     IN KIRQL NewIrql
00354     );
00355 
00356 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00357 <a class="code" href="../../d9/d5/verifier_8c.html#a101">KfSanityCheckLowerIrql</a> (
00358     IN KIRQL NewIrql
00359     );
00360 
<a name="l00361"></a><a class="code" href="../../d9/d5/verifier_8c.html#a15">00361</a> <a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html">MM_DRIVER_VERIFIER_DATA</a> <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>;
00362 
00363 <span class="comment">//</span>
00364 <span class="comment">// Any flags which can be modified on the fly without rebooting are set here.</span>
00365 <span class="comment">//</span>
00366 
<a name="l00367"></a><a class="code" href="../../d9/d5/verifier_8c.html#a16">00367</a> ULONG <a class="code" href="../../d9/d5/verifier_8c.html#a16">VerifierModifyableOptions</a>;
<a name="l00368"></a><a class="code" href="../../d9/d5/verifier_8c.html#a17">00368</a> ULONG <a class="code" href="../../d9/d5/verifier_8c.html#a17">VerifierOptionChanges</a>;
00369 
<a name="l00370"></a><a class="code" href="../../d9/d5/verifier_8c.html#a18">00370</a> LIST_ENTRY <a class="code" href="../../d4/d8/mi_8h.html#a555">MiSuspectDriverList</a>;
00371 
<a name="l00372"></a><a class="code" href="../../d9/d5/verifier_8c.html#a19">00372</a> LOGICAL <a class="code" href="../../d9/d5/verifier_8c.html#a19">MiVerifyAllDrivers</a>;
00373 
<a name="l00374"></a><a class="code" href="../../d9/d5/verifier_8c.html#a20">00374</a> WCHAR <a class="code" href="../../d9/d5/verifier_8c.html#a20">MiVerifyRandomDrivers</a>;
00375 
<a name="l00376"></a><a class="code" href="../../d9/d5/verifier_8c.html#a21">00376</a> ULONG <a class="code" href="../../d9/d5/verifier_8c.html#a21">MiActiveVerifies</a>;
00377 
<a name="l00378"></a><a class="code" href="../../d9/d5/verifier_8c.html#a22">00378</a> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a554">MiActiveVerifierThunks</a>;
00379 
<a name="l00380"></a><a class="code" href="../../d9/d5/verifier_8c.html#a23">00380</a> ULONG <a class="code" href="../../d9/d5/verifier_8c.html#a23">MiNoPageOnRaiseIrql</a>;
00381 
<a name="l00382"></a><a class="code" href="../../d9/d5/verifier_8c.html#a24">00382</a> ULONG <a class="code" href="../../d9/d5/verifier_8c.html#a24">MiVerifierStackProtectTime</a>;
00383 
<a name="l00384"></a><a class="code" href="../../d9/d5/verifier_8c.html#a25">00384</a> LOGICAL <a class="code" href="../../d8/d0/cmdat3_8c.html#a13">MmDontVerifyRandomDrivers</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00385 
<a name="l00386"></a><a class="code" href="../../d9/d5/verifier_8c.html#a26">00386</a> LOGICAL <a class="code" href="../../d9/d5/verifier_8c.html#a26">VerifierSystemSufficientlyBooted</a>;
00387 
<a name="l00388"></a><a class="code" href="../../d9/d5/verifier_8c.html#a27">00388</a> LARGE_INTEGER <a class="code" href="../../d9/d5/verifier_8c.html#a27">VerifierRequiredTimeSinceBoot</a> = {(ULONG)(40 * 1000 * 1000 * 10), 1};
00389 
<a name="l00390"></a><a class="code" href="../../d9/d5/verifier_8c.html#a28">00390</a> LOGICAL <a class="code" href="../../d9/d5/verifier_8c.html#a28">VerifierIsTrackingPool</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00391 
<a name="l00392"></a><a class="code" href="../../d9/d5/verifier_8c.html#a29">00392</a> KSPIN_LOCK <a class="code" href="../../d9/d5/verifier_8c.html#a29">VerifierListLock</a>;
00393 
<a name="l00394"></a><a class="code" href="../../d9/d5/verifier_8c.html#a30">00394</a> KSPIN_LOCK <a class="code" href="../../d9/d5/verifier_8c.html#a30">VerifierPoolLock</a>;
00395 
<a name="l00396"></a><a class="code" href="../../d9/d5/verifier_8c.html#a31">00396</a> <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="code" href="../../d9/d5/verifier_8c.html#a31">VerifierPoolMutex</a>;
00397 
<a name="l00398"></a><a class="code" href="../../d9/d5/verifier_8c.html#a32">00398</a> PRTL_BITMAP <a class="code" href="../../d4/d8/mi_8h.html#a654">VerifierLargePagedPoolMap</a>;
00399 
<a name="l00400"></a><a class="code" href="../../d9/d5/verifier_8c.html#a33">00400</a> LIST_ENTRY <a class="code" href="../../d9/d5/verifier_8c.html#a33">MiVerifierDriverAddedThunkListHead</a>;
00401 
<a name="l00402"></a><a class="code" href="../../d9/d5/verifier_8c.html#a34">00402</a> <span class="keyword">extern</span> LOGICAL <a class="code" href="../../d8/d0/cmdat3_8c.html#a28">MmSpecialPoolCatchOverruns</a>;
00403 
<a name="l00404"></a><a class="code" href="../../d9/d5/verifier_8c.html#a35">00404</a> LOGICAL <a class="code" href="../../d2/d2/ex_2pool_8c.html#a61">KernelVerifier</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00405 
<a name="l00406"></a><a class="code" href="../../d9/d5/verifier_8c.html#a36">00406</a> ULONG <a class="code" href="../../d9/d5/verifier_8c.html#a36">KernelVerifierTickPage</a> = 0x7;
00407 
00408 LOGICAL
00409 <a class="code" href="../../d9/d5/verifier_8c.html#a102">MiEnableVerifier</a> (
00410     IN PLDR_DATA_TABLE_ENTRY DataTableEntry
00411     );
00412 
00413 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00414 <a class="code" href="../../d9/d5/verifier_8c.html#a103">ViInsertVerifierEntry</a> (
00415     IN <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> Verifier
00416     );
00417 
00418 PVOID
00419 <a class="code" href="../../d9/d5/verifier_8c.html#a104">ViPostPoolAllocation</a> (
00420     IN PVOID VirtualAddress,
00421     IN SIZE_T NumberOfBytes,
00422     IN POOL_TYPE PoolType,
00423     IN ULONG Tag,
00424     IN PVOID CallingAddress
00425     );
00426 
00427 <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a>
00428 <a class="code" href="../../d9/d5/verifier_8c.html#a105">ViLocateVerifierEntry</a> (
00429     IN PVOID SystemAddress
00430     );
00431 
00432 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00433 <a class="code" href="../../d9/d5/verifier_8c.html#a106">MiVerifierCheckThunks</a> (
00434     IN PLDR_DATA_TABLE_ENTRY DataTableEntry
00435     );
00436 
00437 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00438 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,MiInitializeDriverVerifierList)</span>
00439 <span class="preprocessor"></span><span class="preprocessor">#if defined(_X86_)</span>
00440 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,MiEnableKernelVerifier)</span>
00441 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00442 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiApplyDriverVerifier)</span>
00443 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiEnableVerifier)</span>
00444 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ViPrintString)</span>
00445 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MmGetVerifierInformation)</span>
00446 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MmSetVerifierInformation)</span>
00447 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MmAddVerifierThunks)</span>
00448 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,MiVerifierCheckThunks)</span>
00449 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,MiVerifyingDriverUnloading)</span>
00450 <span class="preprocessor"></span>
00451 <span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierProbeAndLockPages)</span>
00452 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierProbeAndLockProcessPages)</span>
00453 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierProbeAndLockSelectedPages)</span>
00454 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierUnlockPages)</span>
00455 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierMapIoSpace)</span>
00456 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierMapLockedPages)</span>
00457 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierMapLockedPagesSpecifyCache)</span>
00458 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierUnmapLockedPages)</span>
00459 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierUnmapIoSpace)</span>
00460 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierAllocatePool)</span>
00461 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierAllocatePoolWithTag)</span>
00462 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierAllocatePoolWithTagPriority)</span>
00463 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierAllocatePoolWithQuotaTag)</span>
00464 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierFreePool)</span>
00465 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierFreePoolWithTag)</span>
00466 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierKfRaiseIrql)</span>
00467 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierKfLowerIrql)</span>
00468 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierKeRaiseIrql)</span>
00469 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierKeLowerIrql)</span>
00470 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierKeAcquireSpinLock)</span>
00471 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierKeReleaseSpinLock)</span>
00472 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierKfAcquireSpinLock)</span>
00473 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierKfReleaseSpinLock)</span>
00474 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierKeInitializeTimer)</span>
00475 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierKeInitializeTimerEx)</span>
00476 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierExTryToAcquireFastMutex)</span>
00477 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierExAcquireFastMutex)</span>
00478 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierExReleaseFastMutex)</span>
00479 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierExAcquireFastMutexUnsafe)</span>
00480 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierExReleaseFastMutexUnsafe)</span>
00481 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierExAcquireResourceExclusive)</span>
00482 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierExReleaseResource)</span>
00483 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierKeAcquireQueuedSpinLock)</span>
00484 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierKeReleaseQueuedSpinLock)</span>
00485 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierSynchronizeExecution)</span>
00486 <span class="preprocessor"></span>
00487 <span class="preprocessor">#pragma alloc_text(PAGEVRFY,VerifierFreeTrackedPool)</span>
00488 <span class="preprocessor"></span>
00489 <span class="preprocessor">#pragma alloc_text(PAGEVRFY,VeAllocatePoolWithTagPriority)</span>
00490 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,ViInsertVerifierEntry)</span>
00491 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,ViLocateVerifierEntry)</span>
00492 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,ViPostPoolAllocation)</span>
00493 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,ViInjectResourceFailure)</span>
00494 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,ViTrimAllSystemPagableMemory)</span>
00495 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,ViInitializeEntry)</span>
00496 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,ViReservePoolAllocation)</span>
00497 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,ViInsertPoolAllocation)</span>
00498 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,ViCancelPoolAllocation)</span>
00499 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,ViReleasePoolAllocation)</span>
00500 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,KfSanityCheckRaiseIrql)</span>
00501 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY,KfSanityCheckLowerIrql)</span>
00502 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00503 <span class="preprocessor"></span>
<a name="l00504"></a><a class="code" href="../../d6/d6/struct__VERIFIER__THUNKS.html">00504</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d6/d6/struct__VERIFIER__THUNKS.html">_VERIFIER_THUNKS</a> {
<a name="l00505"></a><a class="code" href="../../d6/d6/struct__VERIFIER__THUNKS.html#o0">00505</a>     PDRIVER_VERIFIER_THUNK_ROUTINE  <a class="code" href="../../d6/d6/struct__VERIFIER__THUNKS.html#o0">PristineRoutine</a>;
<a name="l00506"></a><a class="code" href="../../d6/d6/struct__VERIFIER__THUNKS.html#o1">00506</a>     PDRIVER_VERIFIER_THUNK_ROUTINE  <a class="code" href="../../d6/d6/struct__VERIFIER__THUNKS.html#o1">NewRoutine</a>;
<a name="l00507"></a><a class="code" href="../../d6/d6/struct__VERIFIER__THUNKS.html#o2">00507</a>     ULONG           <a class="code" href="../../d6/d6/struct__VERIFIER__THUNKS.html#o2">Flag</a>;
00508 } <a class="code" href="../../d6/d6/struct__VERIFIER__THUNKS.html">VERIFIER_THUNKS</a>, *<a class="code" href="../../d6/d6/struct__VERIFIER__THUNKS.html">PVERIFIER_THUNKS</a>;
00509 
<a name="l00510"></a><a class="code" href="../../d5/d9/struct__DRIVER__SPECIFIED__VERIFIER__THUNKS.html">00510</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d5/d9/struct__DRIVER__SPECIFIED__VERIFIER__THUNKS.html">_DRIVER_SPECIFIED_VERIFIER_THUNKS</a> {
<a name="l00511"></a><a class="code" href="../../d5/d9/struct__DRIVER__SPECIFIED__VERIFIER__THUNKS.html#o0">00511</a>     LIST_ENTRY <a class="code" href="../../d5/d9/struct__DRIVER__SPECIFIED__VERIFIER__THUNKS.html#o0">ListEntry</a>;
<a name="l00512"></a><a class="code" href="../../d5/d9/struct__DRIVER__SPECIFIED__VERIFIER__THUNKS.html#o1">00512</a>     PLDR_DATA_TABLE_ENTRY <a class="code" href="../../d5/d9/struct__DRIVER__SPECIFIED__VERIFIER__THUNKS.html#o1">DataTableEntry</a>;
<a name="l00513"></a><a class="code" href="../../d5/d9/struct__DRIVER__SPECIFIED__VERIFIER__THUNKS.html#o2">00513</a>     ULONG <a class="code" href="../../d5/d9/struct__DRIVER__SPECIFIED__VERIFIER__THUNKS.html#o2">NumberOfThunks</a>;
00514 } <a class="code" href="../../d5/d9/struct__DRIVER__SPECIFIED__VERIFIER__THUNKS.html">DRIVER_SPECIFIED_VERIFIER_THUNKS</a>, *<a class="code" href="../../d5/d9/struct__DRIVER__SPECIFIED__VERIFIER__THUNKS.html">PDRIVER_SPECIFIED_VERIFIER_THUNKS</a>;
00515 
00516 <span class="preprocessor">#if defined (_X86_)</span>
00517 <span class="preprocessor"></span>
00518 <span class="preprocessor">#define VI_KE_RAISE_IRQL            0</span>
00519 <span class="preprocessor"></span><span class="preprocessor">#define VI_KE_LOWER_IRQL            1</span>
00520 <span class="preprocessor"></span><span class="preprocessor">#define VI_KE_ACQUIRE_SPINLOCK      2</span>
00521 <span class="preprocessor"></span><span class="preprocessor">#define VI_KE_RELEASE_SPINLOCK      3</span>
00522 <span class="preprocessor"></span><span class="preprocessor">#define VI_KF_RAISE_IRQL            4</span>
00523 <span class="preprocessor"></span><span class="preprocessor">#define VI_KF_LOWER_IRQL            5</span>
00524 <span class="preprocessor"></span><span class="preprocessor">#define VI_KF_ACQUIRE_SPINLOCK      6</span>
00525 <span class="preprocessor"></span><span class="preprocessor">#define VI_KF_RELEASE_SPINLOCK      7</span>
00526 <span class="preprocessor"></span><span class="preprocessor">#define VI_KE_ACQUIRE_QUEUED_SPINLOCK      8</span>
00527 <span class="preprocessor"></span><span class="preprocessor">#define VI_KE_RELEASE_QUEUED_SPINLOCK      9</span>
00528 <span class="preprocessor"></span>
00529 <span class="preprocessor">#define VI_HALMAX                   10</span>
00530 <span class="preprocessor"></span>
00531 PVOID MiKernelVerifierOriginalCalls[VI_HALMAX];
00532 
00533 <span class="preprocessor">#endif</span>
00534 <span class="preprocessor"></span>
00535 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00536 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00537"></a><a class="code" href="../../d9/d5/verifier_8c.html#a82">00537</a> <a class="code" href="../../d9/d5/verifier_8c.html#a82">VerifierProbeAndLockPages</a> (
00538      IN OUT <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList,
00539      IN KPROCESSOR_MODE AccessMode,
00540      IN LOCK_OPERATION Operation
00541      )
00542 {
00543     KIRQL CurrentIrql;
00544 
00545     CurrentIrql = KeGetCurrentIrql();
00546     <span class="keywordflow">if</span> (CurrentIrql &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
00547         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
00548                       0x70,
00549                       CurrentIrql,
00550                       (ULONG_PTR)MemoryDescriptorList,
00551                       (ULONG_PTR)AccessMode);
00552     }
00553 
00554     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a93">ViInjectResourceFailure</a> () == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00555         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_WORKING_SET_QUOTA);
00556     }
00557 
00558     <a class="code" href="../../d5/d6/iosup_8c.html#a41">MmProbeAndLockPages</a> (MemoryDescriptorList, AccessMode, Operation);
00559 }
00560 
00561 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00562 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00563"></a><a class="code" href="../../d9/d5/verifier_8c.html#a83">00563</a> <a class="code" href="../../d9/d5/verifier_8c.html#a83">VerifierProbeAndLockProcessPages</a> (
00564     IN OUT <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList,
00565     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00566     IN KPROCESSOR_MODE AccessMode,
00567     IN LOCK_OPERATION Operation
00568     )
00569 {
00570     KIRQL CurrentIrql;
00571 
00572     CurrentIrql = KeGetCurrentIrql();
00573     <span class="keywordflow">if</span> (CurrentIrql &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
00574         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
00575                       0x71,
00576                       CurrentIrql,
00577                       (ULONG_PTR)MemoryDescriptorList,
00578                       (ULONG_PTR)Process);
00579     }
00580 
00581     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a93">ViInjectResourceFailure</a> () == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00582         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_WORKING_SET_QUOTA);
00583     }
00584 
00585     <a class="code" href="../../d5/d6/iosup_8c.html#a42">MmProbeAndLockProcessPages</a> (MemoryDescriptorList,
00586                                 Process,
00587                                 AccessMode,
00588                                 Operation);
00589 }
00590 
00591 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00592 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00593"></a><a class="code" href="../../d9/d5/verifier_8c.html#a84">00593</a> <a class="code" href="../../d9/d5/verifier_8c.html#a84">VerifierProbeAndLockSelectedPages</a> (
00594     IN OUT <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList,
00595     IN PFILE_SEGMENT_ELEMENT SegmentArray,
00596     IN KPROCESSOR_MODE AccessMode,
00597     IN LOCK_OPERATION Operation
00598     )
00599 {
00600     KIRQL CurrentIrql;
00601 
00602     CurrentIrql = KeGetCurrentIrql();
00603     <span class="keywordflow">if</span> (CurrentIrql &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {
00604         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
00605                       0x72,
00606                       CurrentIrql,
00607                       (ULONG_PTR)MemoryDescriptorList,
00608                       (ULONG_PTR)AccessMode);
00609     }
00610 
00611     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a93">ViInjectResourceFailure</a> () == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00612         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_WORKING_SET_QUOTA);
00613     }
00614 
00615     <a class="code" href="../../d5/d6/iosup_8c.html#a44">MmProbeAndLockSelectedPages</a> (MemoryDescriptorList,
00616                                  SegmentArray,
00617                                  AccessMode,
00618                                  Operation);
00619 }
00620 
00621 <span class="comment">//</span>
00622 <span class="comment">// It would be great to rip out the ViBadMapper code but some drivers will</span>
00623 <span class="comment">// never get fixed if this is done.</span>
00624 <span class="comment">//</span>
00625 
<a name="l00626"></a><a class="code" href="../../d9/d5/verifier_8c.html#a1">00626</a> <span class="preprocessor">#define VI_BAD_MAPPERS_MAX  100</span>
00627 <span class="preprocessor"></span>
<a name="l00628"></a><a class="code" href="../../d9/d5/verifier_8c.html#a41">00628</a> KSPIN_LOCK <a class="code" href="../../d9/d5/verifier_8c.html#a41">ViBadMapperLock</a>;
<a name="l00629"></a><a class="code" href="../../d9/d5/verifier_8c.html#a42">00629</a> PVOID <a class="code" href="../../d9/d5/verifier_8c.html#a42">ViBadMappers</a>[<a class="code" href="../../d9/d5/verifier_8c.html#a1">VI_BAD_MAPPERS_MAX</a>];
00630 
00631 LOGICAL
<a name="l00632"></a><a class="code" href="../../d9/d5/verifier_8c.html#a107">00632</a> <a class="code" href="../../d9/d5/verifier_8c.html#a107">ViAddBadMapper</a> (
00633     IN PVOID BadMapper
00634     )
00635 {
00636     ULONG i;
00637     KIRQL OldIrql;
00638     LOGICAL Added;
00639 
00640     Added = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00641     ExAcquireSpinLock (&amp;<a class="code" href="../../d9/d5/verifier_8c.html#a41">ViBadMapperLock</a>, &amp;OldIrql);
00642 
00643     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d9/d5/verifier_8c.html#a1">VI_BAD_MAPPERS_MAX</a>; i += 1) {
00644         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a42">ViBadMappers</a>[i] == BadMapper) {
00645             <span class="keywordflow">break</span>;
00646         }
00647 
00648         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a42">ViBadMappers</a>[i] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00649             <a class="code" href="../../d9/d5/verifier_8c.html#a42">ViBadMappers</a>[i] = BadMapper;
00650             Added = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00651             <span class="keywordflow">break</span>;
00652         }
00653     }
00654 
00655     ExReleaseSpinLock (&amp;<a class="code" href="../../d9/d5/verifier_8c.html#a41">ViBadMapperLock</a>, OldIrql);
00656 
00657     <span class="keywordflow">return</span> Added;
00658 }
00659 
00660 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00661 PVOID
<a name="l00662"></a><a class="code" href="../../d9/d5/verifier_8c.html#a88">00662</a> <a class="code" href="../../d9/d5/verifier_8c.html#a88">VerifierMapIoSpace</a> (
00663      IN PHYSICAL_ADDRESS PhysicalAddress,
00664      IN SIZE_T NumberOfBytes,
00665      IN MEMORY_CACHING_TYPE CacheType
00666      )
00667 {
00668     KIRQL CurrentIrql;
00669 
00670     CurrentIrql = KeGetCurrentIrql();
00671     <span class="keywordflow">if</span> (CurrentIrql &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
00672         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
00673                       0x73,
00674                       CurrentIrql,
00675                       (ULONG_PTR)PhysicalAddress.LowPart,
00676                       NumberOfBytes);
00677     }
00678 
00679     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a93">ViInjectResourceFailure</a> () == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00680         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00681     }
00682 
00683     <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/iosup_8c.html#a57">MmMapIoSpace</a> (PhysicalAddress, NumberOfBytes, CacheType);
00684 }
00685 
00686 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00687 PVOID
<a name="l00688"></a><a class="code" href="../../d9/d5/verifier_8c.html#a89">00688</a> <a class="code" href="../../d9/d5/verifier_8c.html#a89">VerifierMapLockedPages</a> (
00689      IN <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList,
00690      IN KPROCESSOR_MODE AccessMode
00691      )
00692 {
00693     PVOID CallingAddress;
00694     PVOID CallersCaller;
00695     KIRQL CurrentIrql;
00696 
00697 <span class="preprocessor">#if defined (_X86_)</span>
00698 <span class="preprocessor"></span>    <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;CallingAddress, &amp;CallersCaller);
00699 <span class="preprocessor">#else</span>
00700 <span class="preprocessor"></span>    CallingAddress = (PVOID)_ReturnAddress();
00701 <span class="preprocessor">#endif</span>
00702 <span class="preprocessor"></span>
00703     CurrentIrql = KeGetCurrentIrql();
00704 
00705     <span class="keywordflow">if</span> (AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00706         <span class="keywordflow">if</span> (CurrentIrql &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
00707             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
00708                           0x74,
00709                           CurrentIrql,
00710                           (ULONG_PTR)MemoryDescriptorList,
00711                           (ULONG_PTR)AccessMode);
00712         }
00713     }
00714     <span class="keywordflow">else</span> {
00715         <span class="keywordflow">if</span> (CurrentIrql &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {
00716             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
00717                           0x75,
00718                           CurrentIrql,
00719                           (ULONG_PTR)MemoryDescriptorList,
00720                           (ULONG_PTR)AccessMode);
00721         }
00722     }
00723 
00724     <span class="keywordflow">if</span> ((MemoryDescriptorList-&gt;MdlFlags &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a25">MDL_MAPPING_CAN_FAIL</a>) == 0) {
00725 
00726         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a107">ViAddBadMapper</a> (CallingAddress) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00727 
00728             <span class="comment">//</span>
00729             <span class="comment">// All drivers must specify can fail.  We'd really like to bugcheck</span>
00730             <span class="comment">// here to get drivers to convert but cut them some slack for now.</span>
00731             <span class="comment">//</span>
00732 
00733             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"*******************************************************************************\n"</span>);
00734             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"*                                                                             *\n"</span>);
00735 
00736             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"* The Driver Verifier has detected the driver at address %p\n"</span>, CallingAddress);
00737             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"* is calling MmMapLockedPages instead of MmMapLockedPagesSpecifyCache.\n"</span>);
00738             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"* This can cause the system to needlessly bugcheck whenever system\n"</span>);
00739             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"* resources are low.  This driver needs to be fixed.\n"</span>);
00740 
00741             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"*                                                                             *\n"</span>);
00742             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"*******************************************************************************\n"</span>);
00743         }
00744     }
00745 
00746     <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/iosup_8c.html#a49">MmMapLockedPages</a> (MemoryDescriptorList, AccessMode);
00747 }
00748 
00749 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00750 PVOID
<a name="l00751"></a><a class="code" href="../../d9/d5/verifier_8c.html#a90">00751</a> <a class="code" href="../../d9/d5/verifier_8c.html#a90">VerifierMapLockedPagesSpecifyCache</a> (
00752      IN <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList,
00753      IN KPROCESSOR_MODE AccessMode,
00754      IN MEMORY_CACHING_TYPE CacheType,
00755      IN PVOID RequestedAddress,
00756      IN ULONG BugCheckOnFailure,
00757      IN MM_PAGE_PRIORITY Priority
00758      )
00759 {
00760     PVOID CallingAddress;
00761     PVOID CallersCaller;
00762     KIRQL CurrentIrql;
00763 
00764 <span class="preprocessor">#if defined (_X86_)</span>
00765 <span class="preprocessor"></span>    <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;CallingAddress, &amp;CallersCaller);
00766 <span class="preprocessor">#else</span>
00767 <span class="preprocessor"></span>    CallingAddress = (PVOID)_ReturnAddress();
00768 <span class="preprocessor">#endif</span>
00769 <span class="preprocessor"></span>
00770     CurrentIrql = KeGetCurrentIrql();
00771     <span class="keywordflow">if</span> (AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00772         <span class="keywordflow">if</span> (CurrentIrql &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
00773             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
00774                           0x76,
00775                           CurrentIrql,
00776                           (ULONG_PTR)MemoryDescriptorList,
00777                           (ULONG_PTR)AccessMode);
00778         }
00779     }
00780     <span class="keywordflow">else</span> {
00781         <span class="keywordflow">if</span> (CurrentIrql &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {
00782             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
00783                           0x77,
00784                           CurrentIrql,
00785                           (ULONG_PTR)MemoryDescriptorList,
00786                           (ULONG_PTR)AccessMode);
00787         }
00788     }
00789 
00790     <span class="keywordflow">if</span> ((MemoryDescriptorList-&gt;MdlFlags &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a25">MDL_MAPPING_CAN_FAIL</a>) ||
00791         (BugCheckOnFailure == 0)) {
00792 
00793         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a93">ViInjectResourceFailure</a> () == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00794             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00795         }
00796     }
00797     <span class="keywordflow">else</span> {
00798 
00799         <span class="comment">//</span>
00800         <span class="comment">// All drivers must specify can fail or don't bugcheck.  We'd</span>
00801         <span class="comment">// really like to bugcheck here to get drivers to convert but</span>
00802         <span class="comment">// cut them some slack for now.</span>
00803         <span class="comment">//</span>
00804 
00805         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a107">ViAddBadMapper</a> (CallingAddress) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00806 
00807             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"*******************************************************************************\n"</span>);
00808             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"*                                                                             *\n"</span>);
00809 
00810             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"* The Driver Verifier has detected the driver at address %p\n"</span>, CallingAddress);
00811             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"* is not calling the safe version of MmMapLockedPagesSpecifyCache.\n"</span>);
00812             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"* This can cause the system to needlessly bugcheck whenever system\n"</span>);
00813             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"* resources are low.  This driver needs to be fixed.\n"</span>);
00814 
00815             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"*                                                                             *\n"</span>);
00816             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"*******************************************************************************\n"</span>);
00817         }
00818     }
00819 
00820     <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/iosup_8c.html#a50">MmMapLockedPagesSpecifyCache</a> (MemoryDescriptorList,
00821                                          AccessMode,
00822                                          CacheType,
00823                                          RequestedAddress,
00824                                          BugCheckOnFailure,
00825                                          Priority);
00826 }
00827 
00828 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00829"></a><a class="code" href="../../d9/d5/verifier_8c.html#a85">00829</a> <a class="code" href="../../d9/d5/verifier_8c.html#a85">VerifierUnlockPages</a> (
00830      IN OUT <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList
00831      )
00832 {
00833     KIRQL CurrentIrql;
00834 
00835     CurrentIrql = KeGetCurrentIrql();
00836     <span class="keywordflow">if</span> (CurrentIrql &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
00837         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
00838                       0x78,
00839                       CurrentIrql,
00840                       (ULONG_PTR)MemoryDescriptorList,
00841                       0);
00842     }
00843 
00844     <span class="keywordflow">if</span> ((MemoryDescriptorList-&gt;MdlFlags &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a13">MDL_PAGES_LOCKED</a>) == 0) {
00845 
00846         <span class="comment">//</span>
00847         <span class="comment">// The caller is trying to unlock an MDL that was never locked down.</span>
00848         <span class="comment">//</span>
00849 
00850         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
00851                       0x7C,
00852                       (ULONG_PTR)MemoryDescriptorList,
00853                       (ULONG_PTR)MemoryDescriptorList-&gt;MdlFlags,
00854                       0);
00855     }
00856 
00857     <span class="keywordflow">if</span> (MemoryDescriptorList-&gt;MdlFlags &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a14">MDL_SOURCE_IS_NONPAGED_POOL</a>) {
00858 
00859         <span class="comment">//</span>
00860         <span class="comment">// Nonpaged pool should never be locked down.</span>
00861         <span class="comment">//</span>
00862 
00863         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
00864                       0x7D,
00865                       (ULONG_PTR)MemoryDescriptorList,
00866                       (ULONG_PTR)MemoryDescriptorList-&gt;MdlFlags,
00867                       0);
00868     }
00869 
00870     <a class="code" href="../../d5/d6/iosup_8c.html#a45">MmUnlockPages</a> (MemoryDescriptorList);
00871 }
00872 
00873 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00874"></a><a class="code" href="../../d9/d5/verifier_8c.html#a86">00874</a> <a class="code" href="../../d9/d5/verifier_8c.html#a86">VerifierUnmapLockedPages</a> (
00875      IN PVOID BaseAddress,
00876      IN <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList
00877      )
00878 {
00879     KIRQL CurrentIrql;
00880 
00881     CurrentIrql = KeGetCurrentIrql();
00882 
00883     <span class="keywordflow">if</span> (BaseAddress &gt; MM_HIGHEST_USER_ADDRESS) {
00884         <span class="keywordflow">if</span> (CurrentIrql &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
00885             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
00886                           0x79,
00887                           CurrentIrql,
00888                           (ULONG_PTR)BaseAddress,
00889                           (ULONG_PTR)MemoryDescriptorList);
00890         }
00891     }
00892     <span class="keywordflow">else</span> {
00893         <span class="keywordflow">if</span> (CurrentIrql &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {
00894             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
00895                           0x7A,
00896                           CurrentIrql,
00897                           (ULONG_PTR)BaseAddress,
00898                           (ULONG_PTR)MemoryDescriptorList);
00899         }
00900     }
00901 
00902     <a class="code" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (BaseAddress, MemoryDescriptorList);
00903 }
00904 
00905 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00906"></a><a class="code" href="../../d9/d5/verifier_8c.html#a87">00906</a> <a class="code" href="../../d9/d5/verifier_8c.html#a87">VerifierUnmapIoSpace</a> (
00907      IN PVOID BaseAddress,
00908      IN SIZE_T NumberOfBytes
00909      )
00910 {
00911     KIRQL CurrentIrql;
00912 
00913     CurrentIrql = KeGetCurrentIrql();
00914     <span class="keywordflow">if</span> (CurrentIrql &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
00915         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
00916                       0x7B,
00917                       CurrentIrql,
00918                       (ULONG_PTR)BaseAddress,
00919                       (ULONG_PTR)NumberOfBytes);
00920     }
00921 
00922     <a class="code" href="../../d5/d6/iosup_8c.html#a58">MmUnmapIoSpace</a> (BaseAddress, NumberOfBytes);
00923 }
00924 
00925 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00926 PVOID
<a name="l00927"></a><a class="code" href="../../d9/d5/verifier_8c.html#a54">00927</a> <a class="code" href="../../d9/d5/verifier_8c.html#a54">VerifierAllocatePool</a>(
00928     IN POOL_TYPE PoolType,
00929     IN SIZE_T NumberOfBytes
00930     )
00931 {
00932     PVOID CallingAddress;
00933     PVOID CallersCaller;
00934     <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> Verifier;
00935 
00936 <span class="preprocessor">#if defined (_X86_)</span>
00937 <span class="preprocessor"></span>    <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;CallingAddress, &amp;CallersCaller);
00938 <span class="preprocessor">#else</span>
00939 <span class="preprocessor"></span>    CallingAddress = (PVOID)_ReturnAddress();
00940 <span class="preprocessor">#endif</span>
00941 <span class="preprocessor"></span>
00942     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a61">KernelVerifier</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00943 
00944         Verifier = <a class="code" href="../../d9/d5/verifier_8c.html#a105">ViLocateVerifierEntry</a> (CallingAddress);
00945 
00946         <span class="keywordflow">if</span> ((Verifier == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00947             ((Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o6">Flags</a> &amp; <a class="code" href="../../d4/d8/mi_8h.html#a252">VI_VERIFYING_DIRECTLY</a>) == 0)) {
00948 
00949             <span class="keywordflow">return</span> <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (PoolType | <a class="code" href="../../d4/d2/pool_8h.html#a10">POOL_DRIVER_MASK</a>, NumberOfBytes);
00950         }
00951         PoolType |= <a class="code" href="../../d4/d2/pool_8h.html#a10">POOL_DRIVER_MASK</a>;
00952     }
00953 
00954     <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.AllocationsWithNoTag += 1;
00955 
00956     <span class="keywordflow">return</span> <a class="code" href="../../d9/d5/verifier_8c.html#a58">VeAllocatePoolWithTagPriority</a> (PoolType,
00957                                           NumberOfBytes,
00958                                           'parW',
00959                                           <a class="code" href="../../d5/d8/ex_8h.html#a330a194">HighPoolPriority</a>,
00960                                           CallingAddress);
00961 }
00962 
00963 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
00964 PVOID
<a name="l00965"></a><a class="code" href="../../d9/d5/verifier_8c.html#a55">00965</a> <a class="code" href="../../d9/d5/verifier_8c.html#a55">VerifierAllocatePoolWithTag</a>(
00966     IN POOL_TYPE PoolType,
00967     IN SIZE_T NumberOfBytes,
00968     IN ULONG Tag
00969     )
00970 {
00971     PVOID CallingAddress;
00972     PVOID CallersCaller;
00973     <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> Verifier;
00974 
00975 <span class="preprocessor">#if defined (_X86_)</span>
00976 <span class="preprocessor"></span>    <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;CallingAddress, &amp;CallersCaller);
00977 <span class="preprocessor">#else</span>
00978 <span class="preprocessor"></span>    CallingAddress = (PVOID)_ReturnAddress();
00979 <span class="preprocessor">#endif</span>
00980 <span class="preprocessor"></span>
00981     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a61">KernelVerifier</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00982         Verifier = <a class="code" href="../../d9/d5/verifier_8c.html#a105">ViLocateVerifierEntry</a> (CallingAddress);
00983 
00984         <span class="keywordflow">if</span> ((Verifier == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00985             ((Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o6">Flags</a> &amp; <a class="code" href="../../d4/d8/mi_8h.html#a252">VI_VERIFYING_DIRECTLY</a>) == 0)) {
00986 
00987             <span class="keywordflow">return</span> <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (PoolType | <a class="code" href="../../d4/d2/pool_8h.html#a10">POOL_DRIVER_MASK</a>,
00988                                           NumberOfBytes,
00989                                           Tag);
00990         }
00991         PoolType |= <a class="code" href="../../d4/d2/pool_8h.html#a10">POOL_DRIVER_MASK</a>;
00992     }
00993 
00994     <span class="keywordflow">return</span> <a class="code" href="../../d9/d5/verifier_8c.html#a58">VeAllocatePoolWithTagPriority</a> (PoolType,
00995                                           NumberOfBytes,
00996                                           Tag,
00997                                           <a class="code" href="../../d5/d8/ex_8h.html#a330a194">HighPoolPriority</a>,
00998                                           CallingAddress);
00999 }
01000 
01001 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
01002 PVOID
<a name="l01003"></a><a class="code" href="../../d9/d5/verifier_8c.html#a108">01003</a> <a class="code" href="../../d9/d5/verifier_8c.html#a108">VerifierAllocatePoolWithQuota</a>(
01004     IN POOL_TYPE PoolType,
01005     IN SIZE_T NumberOfBytes
01006     )
01007 {
01008     PVOID Va;
01009     LOGICAL RaiseOnQuotaFailure;
01010     PVOID CallingAddress;
01011     PVOID CallersCaller;
01012     <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> Verifier;
01013 
01014 <span class="preprocessor">#if defined (_X86_)</span>
01015 <span class="preprocessor"></span>    <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;CallingAddress, &amp;CallersCaller);
01016 <span class="preprocessor">#else</span>
01017 <span class="preprocessor"></span>    CallingAddress = (PVOID)_ReturnAddress();
01018 <span class="preprocessor">#endif</span>
01019 <span class="preprocessor"></span>
01020     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a61">KernelVerifier</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01021         Verifier = <a class="code" href="../../d9/d5/verifier_8c.html#a105">ViLocateVerifierEntry</a> (CallingAddress);
01022 
01023         <span class="keywordflow">if</span> ((Verifier == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01024             ((Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o6">Flags</a> &amp; <a class="code" href="../../d4/d8/mi_8h.html#a252">VI_VERIFYING_DIRECTLY</a>) == 0)) {
01025 
01026             <span class="keywordflow">return</span> <a class="code" href="../../d5/d5/cc_8h.html#a11">ExAllocatePoolWithQuota</a> (PoolType | <a class="code" href="../../d4/d2/pool_8h.html#a10">POOL_DRIVER_MASK</a>,
01027                                             NumberOfBytes);
01028         }
01029         PoolType |= <a class="code" href="../../d4/d2/pool_8h.html#a10">POOL_DRIVER_MASK</a>;
01030     }
01031 
01032     <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.AllocationsWithNoTag += 1;
01033 
01034     <span class="keywordflow">if</span> (PoolType &amp; <a class="code" href="../../d5/d8/ex_8h.html#a2">POOL_QUOTA_FAIL_INSTEAD_OF_RAISE</a>) {
01035         RaiseOnQuotaFailure = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01036         PoolType &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a2">POOL_QUOTA_FAIL_INSTEAD_OF_RAISE</a>;
01037     }
01038     <span class="keywordflow">else</span> {
01039         RaiseOnQuotaFailure = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01040     }
01041 
01042     Va = <a class="code" href="../../d9/d5/verifier_8c.html#a58">VeAllocatePoolWithTagPriority</a> (PoolType,
01043                                         NumberOfBytes,
01044                                         'parW',
01045                                         <a class="code" href="../../d5/d8/ex_8h.html#a330a194">HighPoolPriority</a>,
01046                                         CallingAddress);
01047 
01048     <span class="keywordflow">if</span> (Va == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01049         <span class="keywordflow">if</span> (RaiseOnQuotaFailure == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01050             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INSUFFICIENT_RESOURCES);
01051         }
01052     }
01053 
01054     <span class="keywordflow">return</span> Va;
01055 }
01056 
01057 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
01058 PVOID
<a name="l01059"></a><a class="code" href="../../d6/d6/ioverifier_8c.html#a23">01059</a> <a class="code" href="../../d9/d5/verifier_8c.html#a56">VerifierAllocatePoolWithQuotaTag</a>(
01060     IN POOL_TYPE PoolType,
01061     IN SIZE_T NumberOfBytes,
01062     IN ULONG Tag
01063     )
01064 {
01065     PVOID Va;
01066     LOGICAL RaiseOnQuotaFailure;
01067     PVOID CallingAddress;
01068     PVOID CallersCaller;
01069     <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> Verifier;
01070 
01071 <span class="preprocessor">#if defined (_X86_)</span>
01072 <span class="preprocessor"></span>    <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;CallingAddress, &amp;CallersCaller);
01073 <span class="preprocessor">#else</span>
01074 <span class="preprocessor"></span>    CallingAddress = (PVOID)_ReturnAddress();
01075 <span class="preprocessor">#endif</span>
01076 <span class="preprocessor"></span>
01077     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a61">KernelVerifier</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01078         Verifier = <a class="code" href="../../d9/d5/verifier_8c.html#a105">ViLocateVerifierEntry</a> (CallingAddress);
01079 
01080         <span class="keywordflow">if</span> ((Verifier == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01081             ((Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o6">Flags</a> &amp; <a class="code" href="../../d4/d8/mi_8h.html#a252">VI_VERIFYING_DIRECTLY</a>) == 0)) {
01082 
01083             <span class="keywordflow">return</span> <a class="code" href="../../d5/d8/ex_8h.html#a5">ExAllocatePoolWithQuotaTag</a> (PoolType | <a class="code" href="../../d4/d2/pool_8h.html#a10">POOL_DRIVER_MASK</a>,
01084                                                NumberOfBytes,
01085                                                Tag);
01086         }
01087         PoolType |= <a class="code" href="../../d4/d2/pool_8h.html#a10">POOL_DRIVER_MASK</a>;
01088     }
01089 
01090     <span class="keywordflow">if</span> (PoolType &amp; <a class="code" href="../../d5/d8/ex_8h.html#a2">POOL_QUOTA_FAIL_INSTEAD_OF_RAISE</a>) {
01091         RaiseOnQuotaFailure = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01092         PoolType &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a2">POOL_QUOTA_FAIL_INSTEAD_OF_RAISE</a>;
01093     }
01094     <span class="keywordflow">else</span> {
01095         RaiseOnQuotaFailure = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01096     }
01097 
01098     Va = <a class="code" href="../../d9/d5/verifier_8c.html#a58">VeAllocatePoolWithTagPriority</a> (PoolType,
01099                                         NumberOfBytes,
01100                                         Tag,
01101                                         <a class="code" href="../../d5/d8/ex_8h.html#a330a194">HighPoolPriority</a>,
01102                                         CallingAddress);
01103 
01104     <span class="keywordflow">if</span> (Va == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01105         <span class="keywordflow">if</span> (RaiseOnQuotaFailure == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01106             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INSUFFICIENT_RESOURCES);
01107         }
01108     }
01109 
01110     <span class="keywordflow">return</span> Va;
01111 }
01112 
01113 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
01114 PVOID
<a name="l01115"></a><a class="code" href="../../d9/d5/verifier_8c.html#a57">01115</a> <a class="code" href="../../d9/d5/verifier_8c.html#a57">VerifierAllocatePoolWithTagPriority</a>(
01116     IN POOL_TYPE PoolType,
01117     IN SIZE_T NumberOfBytes,
01118     IN ULONG Tag,
01119     IN EX_POOL_PRIORITY Priority
01120     )
01121 
01122 <span class="comment">/*++</span>
01123 <span class="comment"></span>
01124 <span class="comment">Routine Description:</span>
01125 <span class="comment"></span>
01126 <span class="comment">    This thunked-in function:</span>
01127 <span class="comment"></span>
01128 <span class="comment">        - Performs sanity checks on the caller.</span>
01129 <span class="comment">        - Can optionally provide allocation failures to the caller.</span>
01130 <span class="comment">        - Attempts to provide the allocation from special pool.</span>
01131 <span class="comment">        - Tracks pool to ensure callers free everything they allocate.</span>
01132 <span class="comment"></span>
01133 <span class="comment">--*/</span>
01134 
01135 {
01136     PVOID CallingAddress;
01137     PVOID CallersCaller;
01138     <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> Verifier;
01139 
01140 <span class="preprocessor">#if defined (_X86_)</span>
01141 <span class="preprocessor"></span>    <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;CallingAddress, &amp;CallersCaller);
01142 <span class="preprocessor">#else</span>
01143 <span class="preprocessor"></span>    CallingAddress = (PVOID)_ReturnAddress();
01144 <span class="preprocessor">#endif</span>
01145 <span class="preprocessor"></span>
01146     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a61">KernelVerifier</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01147         Verifier = <a class="code" href="../../d9/d5/verifier_8c.html#a105">ViLocateVerifierEntry</a> (CallingAddress);
01148 
01149         <span class="keywordflow">if</span> ((Verifier == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01150             ((Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o6">Flags</a> &amp; <a class="code" href="../../d4/d8/mi_8h.html#a252">VI_VERIFYING_DIRECTLY</a>) == 0)) {
01151 
01152             <span class="keywordflow">return</span> <a class="code" href="../../d5/d8/ex_8h.html#a222">ExAllocatePoolWithTagPriority</a> (PoolType | <a class="code" href="../../d4/d2/pool_8h.html#a10">POOL_DRIVER_MASK</a>,
01153                                                   NumberOfBytes,
01154                                                   Tag,
01155                                                   Priority);
01156         }
01157         PoolType |= <a class="code" href="../../d4/d2/pool_8h.html#a10">POOL_DRIVER_MASK</a>;
01158     }
01159 
01160     <span class="keywordflow">return</span> <a class="code" href="../../d9/d5/verifier_8c.html#a58">VeAllocatePoolWithTagPriority</a> (PoolType,
01161                                           NumberOfBytes,
01162                                           Tag,
01163                                           Priority,
01164                                           CallingAddress);
01165 }
01166 
01167 LOGICAL
<a name="l01168"></a><a class="code" href="../../d9/d5/verifier_8c.html#a93">01168</a> <a class="code" href="../../d9/d5/verifier_8c.html#a93">ViInjectResourceFailure</a> (
01169     VOID
01170     )
01171 
01172 <span class="comment">/*++</span>
01173 <span class="comment"></span>
01174 <span class="comment">Routine Description:</span>
01175 <span class="comment"></span>
01176 <span class="comment">    This function determines whether a resource allocation should be</span>
01177 <span class="comment">    deliberately failed.  This may be a pool allocation, MDL creation,</span>
01178 <span class="comment">    system PTE allocation, etc.</span>
01179 <span class="comment"></span>
01180 <span class="comment">Arguments:</span>
01181 <span class="comment"></span>
01182 <span class="comment">    None.</span>
01183 <span class="comment"></span>
01184 <span class="comment">Return Value:</span>
01185 <span class="comment"></span>
01186 <span class="comment">    TRUE if the allocation should be failed.  FALSE otherwise.</span>
01187 <span class="comment"></span>
01188 <span class="comment">Environment:</span>
01189 <span class="comment"></span>
01190 <span class="comment">    Kernel mode.  DISPATCH_LEVEL or below.</span>
01191 <span class="comment"></span>
01192 <span class="comment">--*/</span>
01193 
01194 {
01195     LARGE_INTEGER CurrentTime;
01196 
01197     <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Level &amp; DRIVER_VERIFIER_INJECT_ALLOCATION_FAILURES) == 0) {
01198         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01199     }
01200 
01201     <span class="comment">//</span>
01202     <span class="comment">// Don't fail any requests in the first 7 or 8 minutes as we want to</span>
01203     <span class="comment">// give the system enough time to boot.</span>
01204     <span class="comment">//</span>
01205 
01206     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a26">VerifierSystemSufficientlyBooted</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01207         <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a> (&amp;CurrentTime);
01208         <span class="keywordflow">if</span> (CurrentTime.QuadPart &gt; <a class="code" href="../../d4/d9/ke_8h.html#a124">KeBootTime</a>.QuadPart + <a class="code" href="../../d9/d5/verifier_8c.html#a27">VerifierRequiredTimeSinceBoot</a>.QuadPart) {
01209             <a class="code" href="../../d9/d5/verifier_8c.html#a26">VerifierSystemSufficientlyBooted</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01210         }
01211     }
01212 
01213     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a26">VerifierSystemSufficientlyBooted</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01214 
01215         <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a4">KeQueryTickCount</a>(&amp;CurrentTime);
01216 
01217         <span class="keywordflow">if</span> ((CurrentTime.LowPart &amp; 0xF) == 0) {
01218 
01219             <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.AllocationsFailedDeliberately += 1;
01220 
01221             <span class="comment">//</span>
01222             <span class="comment">// Deliberately fail this request.</span>
01223             <span class="comment">//</span>
01224 
01225             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01226         }
01227     }
01228 
01229     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01230 }
01231 
01232 LOGICAL
<a name="l01233"></a><a class="code" href="../../d9/d5/verifier_8c.html#a96">01233</a> <a class="code" href="../../d9/d5/verifier_8c.html#a96">ViReservePoolAllocation</a> (
01234     IN <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> Verifier
01235     )
01236 {
01237     ULONG_PTR OldSize;
01238     ULONG_PTR NewSize;
01239     ULONG_PTR NewHashOffset;
01240     ULONG_PTR <a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a>;
01241     ULONG_PTR Entries;
01242     ULONG_PTR i;
01243     KIRQL OldIrql;
01244     PVOID NewHashTable;
01245     <a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html">PVI_POOL_ENTRY</a> HashEntry;
01246     <a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html">PVI_POOL_ENTRY</a> OldHashTable;
01247 
01248     ExAcquireSpinLock (&amp;Verifier-&gt;VerifierPoolLock, &amp;OldIrql);
01249 
01250     <span class="keywordflow">while</span> (Verifier-&gt;PoolHashSize &lt;= Verifier-&gt;CurrentPagedPoolAllocations + Verifier-&gt;CurrentNonPagedPoolAllocations + Verifier-&gt;PoolHashReserved) {
01251 
01252         <span class="comment">//</span>
01253         <span class="comment">// More space is needed.  Try for it now.</span>
01254         <span class="comment">//</span>
01255 
01256 <span class="preprocessor">#define VI_POOL_ENTRIES_PER_PAGE (PAGE_SIZE / sizeof(VI_POOL_ENTRY))</span>
01257 <span class="preprocessor"></span>
01258         OldSize = Verifier-&gt;PoolHashSize * <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html">VI_POOL_ENTRY</a>);
01259 
01260         <span class="keywordflow">if</span> (Verifier-&gt;PoolHashSize &gt;= <a class="code" href="../../d9/d5/verifier_8c.html#a2">VI_POOL_ENTRIES_PER_PAGE</a>) {
01261             <a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01262         }
01263         <span class="keywordflow">else</span> {
01264             <a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a> = 16 * <span class="keyword">sizeof</span> (<a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html">VI_POOL_ENTRY</a>);
01265         }
01266 
01267         ExReleaseSpinLock (&amp;Verifier-&gt;VerifierPoolLock, OldIrql);
01268 
01269         NewSize = OldSize + <a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a>;
01270 
01271         <span class="keywordflow">if</span> (NewSize &lt; OldSize) {
01272             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01273         }
01274 
01275         <span class="comment">//</span>
01276         <span class="comment">// Note POOL_DRIVER_MASK must be set to stop the recursion loop</span>
01277         <span class="comment">// when using the kernel verifier.</span>
01278         <span class="comment">//</span>
01279 
01280         NewHashTable = <a class="code" href="../../d5/d8/ex_8h.html#a222">ExAllocatePoolWithTagPriority</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a> | <a class="code" href="../../d4/d2/pool_8h.html#a10">POOL_DRIVER_MASK</a>,
01281                                                       NewSize,
01282                                                       'ppeV',
01283                                                       <a class="code" href="../../d5/d8/ex_8h.html#a330a194">HighPoolPriority</a>);
01284 
01285         ExAcquireSpinLock (&amp;Verifier-&gt;VerifierPoolLock, &amp;OldIrql);
01286 
01287         OldSize = Verifier-&gt;PoolHashSize * <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html">VI_POOL_ENTRY</a>);
01288 
01289         <span class="keywordflow">if</span> (NewHashTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01290             <span class="keywordflow">if</span> (Verifier-&gt;PoolHashSize &lt;= Verifier-&gt;CurrentPagedPoolAllocations + Verifier-&gt;CurrentNonPagedPoolAllocations + Verifier-&gt;PoolHashReserved) {
01291                 ExReleaseSpinLock (&amp;Verifier-&gt;VerifierPoolLock, OldIrql);
01292                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01293             }
01294 
01295             <span class="comment">//</span>
01296             <span class="comment">// Another thread got here before us and space is available.</span>
01297             <span class="comment">//</span>
01298 
01299             <span class="keywordflow">break</span>;
01300         }
01301 
01302         <span class="keywordflow">if</span> (NewSize != OldSize + <a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a>) {
01303 
01304             <span class="comment">//</span>
01305             <span class="comment">// Another thread got here before us.</span>
01306             <span class="comment">//</span>
01307 
01308             ExReleaseSpinLock (&amp;Verifier-&gt;VerifierPoolLock, OldIrql);
01309             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (NewHashTable);
01310             ExAcquireSpinLock (&amp;Verifier-&gt;VerifierPoolLock, &amp;OldIrql);
01311         }
01312         <span class="keywordflow">else</span> {
01313 
01314             <span class="comment">//</span>
01315             <span class="comment">// Rebuild the list into the new table.</span>
01316             <span class="comment">//</span>
01317 
01318             OldHashTable = Verifier-&gt;PoolHash;
01319             <span class="keywordflow">if</span> (OldHashTable != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01320                 RtlCopyMemory (NewHashTable, OldHashTable, OldSize);
01321             }
01322 
01323             <span class="comment">//</span>
01324             <span class="comment">// Construct the freelist chaining it through any existing</span>
01325             <span class="comment">// list (any free entries must be already reserved).</span>
01326             <span class="comment">//</span>
01327 
01328             HashEntry = (<a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html">PVI_POOL_ENTRY</a>) ((PCHAR)NewHashTable + OldSize);
01329             Entries = <a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a> / <span class="keyword">sizeof</span> (<a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html">VI_POOL_ENTRY</a>);
01330             NewHashOffset = HashEntry - (<a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html">PVI_POOL_ENTRY</a>)NewHashTable;
01331 
01332             <span class="comment">//</span>
01333             <span class="comment">// If list compaction becomes important then chaining it on the</span>
01334             <span class="comment">// end here will need to be revisited.</span>
01335             <span class="comment">//</span>
01336 
01337             <span class="keywordflow">for</span> (i = 0; i &lt; Entries; i += 1) {
01338                 HashEntry-&gt;<a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html#o1">FreeListNext</a> = NewHashOffset + i + 1;
01339                 HashEntry += 1;
01340             }
01341             HashEntry -= 1;
01342             HashEntry-&gt;<a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html#o1">FreeListNext</a> = Verifier-&gt;PoolHashFree;
01343             Verifier-&gt;PoolHashFree = NewHashOffset;
01344             Verifier-&gt;PoolHash = NewHashTable;
01345             Verifier-&gt;PoolHashSize += Entries;
01346 
01347             <span class="comment">//</span>
01348             <span class="comment">// Free the old table.</span>
01349             <span class="comment">//</span>
01350 
01351             <span class="keywordflow">if</span> (OldHashTable != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01352                 ExReleaseSpinLock (&amp;Verifier-&gt;VerifierPoolLock, OldIrql);
01353                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (OldHashTable);
01354                 ExAcquireSpinLock (&amp;Verifier-&gt;VerifierPoolLock, &amp;OldIrql);
01355             }
01356         }
01357     }
01358 
01359     Verifier-&gt;PoolHashReserved += 1;
01360 
01361     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Verifier-&gt;PoolHashSize &gt;= Verifier-&gt;CurrentPagedPoolAllocations + Verifier-&gt;CurrentNonPagedPoolAllocations + Verifier-&gt;PoolHashReserved);
01362 
01363     ExReleaseSpinLock (&amp;Verifier-&gt;VerifierPoolLock, OldIrql);
01364 
01365     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01366 }
01367 
01368 ULONG_PTR
<a name="l01369"></a><a class="code" href="../../d9/d5/verifier_8c.html#a97">01369</a> <a class="code" href="../../d9/d5/verifier_8c.html#a97">ViInsertPoolAllocation</a> (
01370     IN <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> Verifier,
01371     IN PVOID VirtualAddress,
01372     IN PVOID CallingAddress,
01373     IN SIZE_T NumberOfBytes,
01374     IN ULONG Tag
01375     )
01376 
01377 <span class="comment">/*++</span>
01378 <span class="comment"></span>
01379 <span class="comment">Routine Description:</span>
01380 <span class="comment"></span>
01381 <span class="comment">    This function inserts the specified virtual address into the verifier</span>
01382 <span class="comment">    list for this driver.</span>
01383 <span class="comment"></span>
01384 <span class="comment">Arguments:</span>
01385 <span class="comment"></span>
01386 <span class="comment">    Verifier - Supplies the verifier entry to update.</span>
01387 <span class="comment"></span>
01388 <span class="comment">    VirtualAddress - Supplies the virtual address to insert.</span>
01389 <span class="comment"></span>
01390 <span class="comment">    CallingAddress - Supplies the caller's address.</span>
01391 <span class="comment"></span>
01392 <span class="comment">    NumberOfBytes - Supplies the number of bytes to allocate.</span>
01393 <span class="comment"></span>
01394 <span class="comment">    Tag - Supplies the tag for the pool being allocated.</span>
01395 <span class="comment"></span>
01396 <span class="comment">Return Value:</span>
01397 <span class="comment"></span>
01398 <span class="comment">    The list index this virtual address was inserted at.</span>
01399 <span class="comment"></span>
01400 <span class="comment">Environment:</span>
01401 <span class="comment"></span>
01402 <span class="comment">    Kernel mode, DISPATCH_LEVEL.  The Verifier-&gt;VerifierPoolLock must be held.</span>
01403 <span class="comment"></span>
01404 <span class="comment">--*/</span>
01405 
01406 {
01407     ULONG_PTR <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01408     <a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html">PVI_POOL_ENTRY</a> HashEntry;
01409 
01410     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
01411 
01412     <span class="comment">//</span>
01413     <span class="comment">// The list entry must be reserved in advance.</span>
01414     <span class="comment">//</span>
01415 
01416     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Verifier-&gt;PoolHashReserved != 0);
01417 
01418     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Verifier-&gt;PoolHashSize &gt;= Verifier-&gt;CurrentPagedPoolAllocations + Verifier-&gt;CurrentNonPagedPoolAllocations + Verifier-&gt;PoolHashReserved);
01419 
01420     <span class="comment">//</span>
01421     <span class="comment">// Use the next free list entry.</span>
01422     <span class="comment">//</span>
01423 
01424     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = Verifier-&gt;PoolHashFree;
01425     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> != <a class="code" href="../../d4/d8/mi_8h.html#a250">VI_POOL_FREELIST_END</a>);
01426 
01427     HashEntry = Verifier-&gt;PoolHash + <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01428 
01429     Verifier-&gt;PoolHashFree = HashEntry-&gt;<a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html#o1">FreeListNext</a>;
01430 
01431     Verifier-&gt;PoolHashReserved -= 1;
01432 
01433     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((HashEntry-&gt;<a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html#o1">FreeListNext</a> &amp; MINLONG_PTR) == 0) ||
01434             (HashEntry-&gt;<a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html#o1">FreeListNext</a> == <a class="code" href="../../d4/d8/mi_8h.html#a250">VI_POOL_FREELIST_END</a>));
01435 
01436     HashEntry-&gt;<a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html#o0">InUse</a>.<a class="code" href="../../d9/d6/struct__VI__POOL__ENTRY__INUSE.html#o0">VirtualAddress</a> = VirtualAddress;
01437     HashEntry-&gt;<a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html#o0">InUse</a>.<a class="code" href="../../d9/d6/struct__VI__POOL__ENTRY__INUSE.html#o1">CallingAddress</a> = CallingAddress;
01438     HashEntry-&gt;<a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html#o0">InUse</a>.<a class="code" href="../../d9/d6/struct__VI__POOL__ENTRY__INUSE.html#o2">NumberOfBytes</a> = NumberOfBytes;
01439     HashEntry-&gt;<a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html#o0">InUse</a>.<a class="code" href="../../d9/d6/struct__VI__POOL__ENTRY__INUSE.html#o3">Tag</a> = Tag;
01440 
01441     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((HashEntry-&gt;<a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html#o1">FreeListNext</a> &amp; MINLONG_PTR) != 0);
01442 
01443     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01444 }
01445 
01446 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01447"></a><a class="code" href="../../d9/d5/verifier_8c.html#a99">01447</a> <a class="code" href="../../d9/d5/verifier_8c.html#a99">ViReleasePoolAllocation</a> (
01448     IN <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> Verifier,
01449     IN PVOID VirtualAddress,
01450     IN ULONG_PTR ListIndex,
01451     IN SIZE_T ChargedBytes
01452     )
01453 
01454 <span class="comment">/*++</span>
01455 <span class="comment"></span>
01456 <span class="comment">Routine Description:</span>
01457 <span class="comment"></span>
01458 <span class="comment">    This function removes the specified virtual address from the verifier</span>
01459 <span class="comment">    list for this driver.</span>
01460 <span class="comment"></span>
01461 <span class="comment">Arguments:</span>
01462 <span class="comment"></span>
01463 <span class="comment">    Verifier - Supplies the verifier entry to update.</span>
01464 <span class="comment"></span>
01465 <span class="comment">    VirtualAddress - Supplies the virtual address to release.</span>
01466 <span class="comment"></span>
01467 <span class="comment">    ListIndex - Supplies the verifier pool hash index for the address being</span>
01468 <span class="comment">                released.</span>
01469 <span class="comment"></span>
01470 <span class="comment">    ChargedBytes - Supplies the bytes charged for this allocation.</span>
01471 <span class="comment"></span>
01472 <span class="comment">Return Value:</span>
01473 <span class="comment"></span>
01474 <span class="comment">    None.</span>
01475 <span class="comment"></span>
01476 <span class="comment">Environment:</span>
01477 <span class="comment"></span>
01478 <span class="comment">    Kernel mode, DISPATCH_LEVEL.  The Verifier-&gt;VerifierPoolLock must be held.</span>
01479 <span class="comment"></span>
01480 <span class="comment">--*/</span>
01481 
01482 {
01483     PFN_NUMBER PageFrameIndex;
01484     PFN_NUMBER PageFrameIndex2;
01485     <a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html">PVI_POOL_ENTRY</a> HashEntry;
01486     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01487 
01488     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
01489 
01490     <span class="keywordflow">if</span> (Verifier-&gt;PoolHash == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01491         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
01492                       0x59,
01493                       (ULONG_PTR)VirtualAddress,
01494                       ListIndex,
01495                       (ULONG_PTR)Verifier);
01496     }
01497 
01498     <span class="comment">//</span>
01499     <span class="comment">// Ensure that the list pointer has not been overrun and still</span>
01500     <span class="comment">// points at something decent.</span>
01501     <span class="comment">//</span>
01502 
01503     HashEntry = Verifier-&gt;PoolHash + ListIndex;
01504 
01505     <span class="keywordflow">if</span> (ListIndex &gt;= Verifier-&gt;PoolHashSize) {
01506         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
01507                       0x54,
01508                       (ULONG_PTR)VirtualAddress,
01509                       Verifier-&gt;PoolHashSize,
01510                       ListIndex);
01511     }
01512 
01513     <span class="keywordflow">if</span> (HashEntry-&gt;<a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html#o0">InUse</a>.<a class="code" href="../../d9/d6/struct__VI__POOL__ENTRY__INUSE.html#o0">VirtualAddress</a> != VirtualAddress) {
01514 
01515         PageFrameIndex = 0;
01516         PageFrameIndex2 = 1;
01517 
01518         <span class="keywordflow">if</span> ((!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(VirtualAddress)) &amp;&amp;
01519             (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(HashEntry-&gt;<a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html#o0">InUse</a>.<a class="code" href="../../d9/d6/struct__VI__POOL__ENTRY__INUSE.html#o0">VirtualAddress</a>))) {
01520 
01521             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(VirtualAddress);
01522             <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
01523                 PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
01524 
01525                 PageFrameIndex2 = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a> (HashEntry-&gt;<a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html#o0">InUse</a>.<a class="code" href="../../d9/d6/struct__VI__POOL__ENTRY__INUSE.html#o0">VirtualAddress</a>);
01526             }
01527         }
01528 
01529         <span class="comment">//</span>
01530         <span class="comment">// Caller overran and corrupted the virtual address - the linked</span>
01531         <span class="comment">// list cannot be counted on either.</span>
01532         <span class="comment">//</span>
01533 
01534         <span class="keywordflow">if</span> (PageFrameIndex != PageFrameIndex2) {
01535             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
01536                           0x52,
01537                           (ULONG_PTR)VirtualAddress,
01538                           (ULONG_PTR)HashEntry-&gt;<a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html#o0">InUse</a>.<a class="code" href="../../d9/d6/struct__VI__POOL__ENTRY__INUSE.html#o0">VirtualAddress</a>,
01539                           ChargedBytes);
01540         }
01541     }
01542 
01543     <span class="keywordflow">if</span> (HashEntry-&gt;<a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html#o0">InUse</a>.<a class="code" href="../../d9/d6/struct__VI__POOL__ENTRY__INUSE.html#o2">NumberOfBytes</a> != ChargedBytes) {
01544 
01545         <span class="comment">//</span>
01546         <span class="comment">// Caller overran and corrupted the byte count - the linked</span>
01547         <span class="comment">// list cannot be counted on either.</span>
01548         <span class="comment">//</span>
01549 
01550         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
01551                       0x51,
01552                       (ULONG_PTR)VirtualAddress,
01553                       (ULONG_PTR)HashEntry,
01554                       ChargedBytes);
01555     }
01556 
01557     <span class="comment">//</span>
01558     <span class="comment">// Put this list entry into the freelist.</span>
01559     <span class="comment">//</span>
01560 
01561     HashEntry-&gt;<a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html#o1">FreeListNext</a> = Verifier-&gt;PoolHashFree;
01562     Verifier-&gt;PoolHashFree = HashEntry - Verifier-&gt;PoolHash;
01563 }
01564 
01565 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01566"></a><a class="code" href="../../d9/d5/verifier_8c.html#a98">01566</a> <a class="code" href="../../d9/d5/verifier_8c.html#a98">ViCancelPoolAllocation</a> (
01567     IN <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> Verifier
01568     )
01569 
01570 <span class="comment">/*++</span>
01571 <span class="comment"></span>
01572 <span class="comment">Routine Description:</span>
01573 <span class="comment"></span>
01574 <span class="comment">    This function removes a reservation from the verifier list for this driver.</span>
01575 <span class="comment">    All reservations must be made in advance.  This routine is used when an</span>
01576 <span class="comment">    earlier reservation is not going to be used (ie: the actual pool</span>
01577 <span class="comment">    allocation failed so no reservation will be needed after all).</span>
01578 <span class="comment"></span>
01579 <span class="comment">Arguments:</span>
01580 <span class="comment"></span>
01581 <span class="comment">    Verifier - Supplies the verifier entry to update.</span>
01582 <span class="comment"></span>
01583 <span class="comment">Return Value:</span>
01584 <span class="comment"></span>
01585 <span class="comment">    None.</span>
01586 <span class="comment"></span>
01587 <span class="comment">Environment:</span>
01588 <span class="comment"></span>
01589 <span class="comment">    Kernel mode, DISPATCH_LEVEL or below, no verifier mutexes held.</span>
01590 <span class="comment"></span>
01591 <span class="comment">--*/</span>
01592 
01593 {
01594     KIRQL OldIrql;
01595 
01596     ExAcquireSpinLock (&amp;Verifier-&gt;VerifierPoolLock, &amp;OldIrql);
01597 
01598     <span class="comment">//</span>
01599     <span class="comment">// The hash entry reserved earlier is not going to be used after all.</span>
01600     <span class="comment">//</span>
01601 
01602     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Verifier-&gt;PoolHashReserved != 0);
01603 
01604     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Verifier-&gt;PoolHashSize &gt;= Verifier-&gt;CurrentPagedPoolAllocations + Verifier-&gt;CurrentNonPagedPoolAllocations + Verifier-&gt;PoolHashReserved);
01605 
01606     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Verifier-&gt;PoolHashFree != <a class="code" href="../../d4/d8/mi_8h.html#a250">VI_POOL_FREELIST_END</a>);
01607 
01608     Verifier-&gt;PoolHashReserved -= 1;
01609 
01610     ExReleaseSpinLock (&amp;Verifier-&gt;VerifierPoolLock, OldIrql);
01611 }
01612 
01613 PVOID
<a name="l01614"></a><a class="code" href="../../d9/d5/verifier_8c.html#a104">01614</a> <a class="code" href="../../d9/d5/verifier_8c.html#a104">ViPostPoolAllocation</a> (
01615     IN PVOID VirtualAddress,
01616     IN SIZE_T NumberOfBytes,
01617     IN POOL_TYPE PoolType,
01618     IN ULONG Tag,
01619     IN PVOID CallingAddress
01620     )
01621 
01622 <span class="comment">/*++</span>
01623 <span class="comment"></span>
01624 <span class="comment">Routine Description:</span>
01625 <span class="comment"></span>
01626 <span class="comment">    This function performs verifier book-keeping on the allocation attempt.</span>
01627 <span class="comment"></span>
01628 <span class="comment">Arguments:</span>
01629 <span class="comment"></span>
01630 <span class="comment">    VirtualAddress - Supplies the virtual address that should be allocated.</span>
01631 <span class="comment"></span>
01632 <span class="comment">    NumberOfBytes - Supplies the number of bytes to allocate.</span>
01633 <span class="comment"></span>
01634 <span class="comment">    PoolType - Supplies the type of pool being allocated.</span>
01635 <span class="comment"></span>
01636 <span class="comment">    Tag - Supplies the tag for the pool being allocated.</span>
01637 <span class="comment"></span>
01638 <span class="comment">    CallingAddress - Supplies the caller's address.</span>
01639 <span class="comment"></span>
01640 <span class="comment">Return Value:</span>
01641 <span class="comment"></span>
01642 <span class="comment">    The virtual address the caller should use.</span>
01643 <span class="comment"></span>
01644 <span class="comment">Environment:</span>
01645 <span class="comment"></span>
01646 <span class="comment">    Kernel mode.  DISPATCH_LEVEL or below.</span>
01647 <span class="comment"></span>
01648 <span class="comment">--*/</span>
01649 
01650 {
01651     KIRQL OldIrql;
01652     <a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">PMI_VERIFIER_POOL_HEADER</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
01653     SIZE_T ChargedBytes;
01654     <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> Verifier;
01655     ULONG_PTR InsertedIndex;
01656     LOGICAL SpecialPoolAllocation;
01657     <a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a> PoolHeader;
01658 
01659     InterlockedIncrement ((PLONG)&amp;<a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.AllocationsSucceeded);
01660     ChargedBytes = <a class="code" href="../../d4/d2/pool_8h.html#a23">EX_REAL_POOL_USAGE</a>(NumberOfBytes);
01661     SpecialPoolAllocation = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01662 
01663     <span class="keywordflow">if</span> (VirtualAddress &gt;= <a class="code" href="../../d2/d1/mm_8h.html#a160">MmSpecialPoolStart</a> &amp;&amp; VirtualAddress &lt; <a class="code" href="../../d2/d1/mm_8h.html#a161">MmSpecialPoolEnd</a>) {
01664         ChargedBytes = NumberOfBytes;
01665         InterlockedIncrement ((PLONG)&amp;<a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.AllocationsSucceededSpecialPool);
01666         SpecialPoolAllocation = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01667     }
01668     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NumberOfBytes &lt;= <a class="code" href="../../d5/d2/poolhack_8c.html#a7">POOL_BUDDY_MAX</a>) {
01669         ChargedBytes -= <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>;
01670     }
01671     <span class="keywordflow">else</span> {
01672 
01673         <span class="comment">//</span>
01674         <span class="comment">// This isn't exactly true but it does give the user a way to see</span>
01675         <span class="comment">// if this machine is large enough to support special pool 100%.</span>
01676         <span class="comment">//</span>
01677 
01678         InterlockedIncrement ((PLONG)&amp;<a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.AllocationsSucceededSpecialPool);
01679     }
01680 
01681     <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a9">POOL_VERIFIER_MASK</a>) == 0) {
01682         <span class="keywordflow">return</span> VirtualAddress;
01683     }
01684 
01685     <span class="keywordflow">if</span> (NumberOfBytes &gt; <a class="code" href="../../d5/d2/poolhack_8c.html#a7">POOL_BUDDY_MAX</a>) {
01686         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(VirtualAddress) == 0);
01687     }
01688 
01689     Verifier = <a class="code" href="../../d9/d5/verifier_8c.html#a105">ViLocateVerifierEntry</a> (CallingAddress);
01690     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Verifier != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01691     <a class="code" href="../../d9/d5/verifier_8c.html#a28">VerifierIsTrackingPool</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01692 
01693     <span class="keywordflow">if</span> (SpecialPoolAllocation == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01694 
01695         <span class="comment">//</span>
01696         <span class="comment">// Carefully adjust the special pool page to move the verifier tracking</span>
01697         <span class="comment">// header to the front.  This allows the allocation to remain butted</span>
01698         <span class="comment">// against the end of the page so overruns can be detected immediately.</span>
01699         <span class="comment">//</span>
01700 
01701         <span class="keywordflow">if</span> (((ULONG_PTR)VirtualAddress &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1))) {
01702             PoolHeader = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)(<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (VirtualAddress));
01703             <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = (<a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">PMI_VERIFIER_POOL_HEADER</a>) (PoolHeader + 1);
01704             VirtualAddress = (PVOID) ((PCHAR)VirtualAddress + <span class="keyword">sizeof</span> (<a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">MI_VERIFIER_POOL_HEADER</a>));
01705         }
01706         <span class="keywordflow">else</span> {
01707             PoolHeader = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((PCHAR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (VirtualAddress) + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>);
01708             <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = (<a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">PMI_VERIFIER_POOL_HEADER</a>) (PoolHeader - 1);
01709         }
01710         <span class="comment">// ASSERT (PoolHeader-&gt;Ulong1 &amp; MI_SPECIAL_POOL_VERIFIER);</span>
01711         PoolHeader-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o7">Ulong1</a> -= <span class="keyword">sizeof</span> (<a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">MI_VERIFIER_POOL_HEADER</a>);
01712         ChargedBytes -= <span class="keyword">sizeof</span> (<a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">MI_VERIFIER_POOL_HEADER</a>);
01713         PoolHeader-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o7">Ulong1</a> |= <a class="code" href="../../d4/d8/mi_8h.html#a3">MI_SPECIAL_POOL_VERIFIER</a>;
01714     }
01715     <span class="keywordflow">else</span> {
01716         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = (<a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">PMI_VERIFIER_POOL_HEADER</a>)((PCHAR)VirtualAddress +
01717                          ChargedBytes -
01718                          <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">MI_VERIFIER_POOL_HEADER</a>));
01719     }
01720 
01721     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((ULONG_PTR)<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> &amp; (<span class="keyword">sizeof</span>(ULONG) - 1)) == 0);
01722 
01723 
01724     <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Verifier = Verifier;
01725 
01726     <span class="comment">//</span>
01727     <span class="comment">// Enqueue the entry and update per-driver counters.</span>
01728     <span class="comment">// Note that paged pool allocations must be chained using nonpaged</span>
01729     <span class="comment">// pool to prevent deadlocks.</span>
01730     <span class="comment">//</span>
01731 
01732     ExAcquireSpinLock (&amp;Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o9">VerifierPoolLock</a>, &amp;OldIrql);
01733 
01734     InsertedIndex = <a class="code" href="../../d9/d5/verifier_8c.html#a97">ViInsertPoolAllocation</a> (Verifier,
01735                                             VirtualAddress,
01736                                             CallingAddress,
01737                                             ChargedBytes,
01738                                             Tag);
01739 
01740     <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>) == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
01741 
01742         Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o18">PagedBytes</a> += ChargedBytes;
01743         <span class="keywordflow">if</span> (Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o18">PagedBytes</a> &gt; Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o20">PeakPagedBytes</a>) {
01744             Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o20">PeakPagedBytes</a> = Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o18">PagedBytes</a>;
01745         }
01746 
01747         Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o14">CurrentPagedPoolAllocations</a> += 1;
01748         <span class="keywordflow">if</span> (Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o14">CurrentPagedPoolAllocations</a> &gt; Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o16">PeakPagedPoolAllocations</a>) {
01749             Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o16">PeakPagedPoolAllocations</a> = Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o14">CurrentPagedPoolAllocations</a>;
01750         }
01751     }
01752     <span class="keywordflow">else</span> {
01753         Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o19">NonPagedBytes</a> += ChargedBytes;
01754         <span class="keywordflow">if</span> (Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o19">NonPagedBytes</a> &gt; Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o21">PeakNonPagedBytes</a>) {
01755             Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o21">PeakNonPagedBytes</a> = Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o19">NonPagedBytes</a>;
01756         }
01757 
01758         Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o15">CurrentNonPagedPoolAllocations</a> += 1;
01759         <span class="keywordflow">if</span> (Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o15">CurrentNonPagedPoolAllocations</a> &gt; Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o17">PeakNonPagedPoolAllocations</a>) {
01760             Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o17">PeakNonPagedPoolAllocations</a> = Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o15">CurrentNonPagedPoolAllocations</a>;
01761         }
01762     }
01763 
01764     ExReleaseSpinLock (&amp;Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o9">VerifierPoolLock</a>, OldIrql);
01765 
01766     <span class="comment">//</span>
01767     <span class="comment">// Since the header for paged pool is paged, don't initialize it until the</span>
01768     <span class="comment">// spinlock above is released.</span>
01769     <span class="comment">//</span>
01770 
01771     <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ListIndex = InsertedIndex;
01772 
01773     <span class="comment">//</span>
01774     <span class="comment">// Update systemwide counters.</span>
01775     <span class="comment">//</span>
01776 
01777     <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>) == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
01778         ExAcquireFastMutex (&amp;<a class="code" href="../../d9/d5/verifier_8c.html#a31">VerifierPoolMutex</a>);
01779 
01780         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.PagedBytes += ChargedBytes;
01781         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.PagedBytes &gt; <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.PeakPagedBytes) {
01782             <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.PeakPagedBytes = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.PagedBytes;
01783         }
01784 
01785         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.CurrentPagedPoolAllocations += 1;
01786         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.CurrentPagedPoolAllocations &gt; <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.PeakPagedPoolAllocations) {
01787             <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.PeakPagedPoolAllocations = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.CurrentPagedPoolAllocations;
01788         }
01789 
01790         ExReleaseFastMutex (&amp;<a class="code" href="../../d9/d5/verifier_8c.html#a31">VerifierPoolMutex</a>);
01791     }
01792     <span class="keywordflow">else</span> {
01793         ExAcquireSpinLock (&amp;<a class="code" href="../../d9/d5/verifier_8c.html#a30">VerifierPoolLock</a>, &amp;OldIrql);
01794 
01795         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.NonPagedBytes += ChargedBytes;
01796         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.NonPagedBytes &gt; <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.PeakNonPagedBytes) {
01797             <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.PeakNonPagedBytes = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.NonPagedBytes;
01798         }
01799 
01800         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.CurrentNonPagedPoolAllocations += 1;
01801         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.CurrentNonPagedPoolAllocations &gt; <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.PeakNonPagedPoolAllocations) {
01802             <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.PeakNonPagedPoolAllocations = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.CurrentNonPagedPoolAllocations;
01803         }
01804 
01805         ExReleaseSpinLock (&amp;<a class="code" href="../../d9/d5/verifier_8c.html#a30">VerifierPoolLock</a>, OldIrql);
01806     }
01807 
01808     <span class="keywordflow">return</span> VirtualAddress;
01809 }
01810 
01811 PVOID
<a name="l01812"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a76">01812</a> <a class="code" href="../../d9/d5/verifier_8c.html#a58">VeAllocatePoolWithTagPriority</a>(
01813     IN POOL_TYPE PoolType,
01814     IN SIZE_T NumberOfBytes,
01815     IN ULONG Tag,
01816     IN EX_POOL_PRIORITY Priority,
01817     IN PVOID CallingAddress
01818     )
01819 
01820 <span class="comment">/*++</span>
01821 <span class="comment"></span>
01822 <span class="comment">Routine Description:</span>
01823 <span class="comment"></span>
01824 <span class="comment">    This routine is called both from ex\pool.c and directly within this module.</span>
01825 <span class="comment"></span>
01826 <span class="comment">        - Performs sanity checks on the caller.</span>
01827 <span class="comment">        - Can optionally provide allocation failures to the caller.</span>
01828 <span class="comment">        - Attempts to provide the allocation from special pool.</span>
01829 <span class="comment">        - Tracks pool to ensure callers free everything they allocate.</span>
01830 <span class="comment"></span>
01831 <span class="comment">--*/</span>
01832 
01833 {
01834     PVOID VirtualAddress;
01835     <a class="code" href="../../d5/d8/ex_8h.html#a97">EX_POOL_PRIORITY</a> AllocationPriority;
01836     SIZE_T ChargedBytes;
01837     <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> Verifier;
01838     LOGICAL ReservedHash;
01839     ULONG HeaderSize;
01840 
01841     <a class="code" href="../../d5/d8/ex_8h.html#a217">ExAllocatePoolSanityChecks</a> (PoolType, NumberOfBytes);
01842 
01843     InterlockedIncrement ((PLONG)&amp;<a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.AllocationsAttempted);
01844 
01845     <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a6">MUST_SUCCEED_POOL_TYPE_MASK</a>) == 0) {
01846 
01847         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a93">ViInjectResourceFailure</a> () == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01848 
01849             <span class="comment">//</span>
01850             <span class="comment">// Caller requested an exception - throw it here.</span>
01851             <span class="comment">//</span>
01852 
01853             <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d5/d8/ex_8h.html#a3">POOL_RAISE_IF_ALLOCATION_FAILURE</a>) != 0) {
01854                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INSUFFICIENT_RESOURCES);
01855             }
01856 
01857             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01858         }
01859     }
01860 
01861     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a9">POOL_VERIFIER_MASK</a>) == 0);
01862 
01863     AllocationPriority = Priority;
01864 
01865     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Level &amp; DRIVER_VERIFIER_SPECIAL_POOLING) {
01866 
01867         <span class="comment">//</span>
01868         <span class="comment">// Try for a special pool overrun allocation unless the caller has</span>
01869         <span class="comment">// explicitly specified otherwise.</span>
01870         <span class="comment">//</span>
01871 
01872         <span class="keywordflow">if</span> ((AllocationPriority &amp; (<a class="code" href="../../d5/d8/ex_8h.html#a330a189">LowPoolPrioritySpecialPoolOverrun</a> | <a class="code" href="../../d5/d8/ex_8h.html#a330a190">LowPoolPrioritySpecialPoolUnderrun</a>)) == 0) {
01873             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a28">MmSpecialPoolCatchOverruns</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01874                 AllocationPriority |= <a class="code" href="../../d5/d8/ex_8h.html#a330a189">LowPoolPrioritySpecialPoolOverrun</a>;
01875             }
01876             <span class="keywordflow">else</span> {
01877                 AllocationPriority |= <a class="code" href="../../d5/d8/ex_8h.html#a330a190">LowPoolPrioritySpecialPoolUnderrun</a>;
01878             }
01879         }
01880     }
01881 
01882     ReservedHash = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01883     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Level &amp; DRIVER_VERIFIER_TRACK_POOL_ALLOCATIONS) {
01884 
01885         <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a>) &amp;&amp; (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
01886 
01887             <span class="comment">//</span>
01888             <span class="comment">// Session pool is directly tracked by default already.</span>
01889             <span class="comment">//</span>
01890 
01891             NOTHING;
01892         }
01893         <span class="keywordflow">else</span> {
01894             HeaderSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">MI_VERIFIER_POOL_HEADER</a>);
01895 
01896             ChargedBytes = <a class="code" href="../../d4/d8/mi_8h.html#a90">MI_ROUND_TO_SIZE</a> (NumberOfBytes, <span class="keyword">sizeof</span>(ULONG)) + HeaderSize;
01897             Verifier = <a class="code" href="../../d9/d5/verifier_8c.html#a105">ViLocateVerifierEntry</a> (CallingAddress);
01898 
01899             <span class="keywordflow">if</span> ((Verifier == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01900                 ((Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o6">Flags</a> &amp; <a class="code" href="../../d4/d8/mi_8h.html#a252">VI_VERIFYING_DIRECTLY</a>) == 0)) {
01901 
01902                 <span class="comment">//</span>
01903                 <span class="comment">// This can happen for many reasons including no framing (which</span>
01904                 <span class="comment">// can cause RtlGetCallersAddress to return the wrong address),</span>
01905                 <span class="comment">// etc.</span>
01906                 <span class="comment">//</span>
01907 
01908                 <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.UnTrackedPool += 1;
01909             }
01910             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ChargedBytes &lt;= NumberOfBytes) {
01911 
01912                 <span class="comment">//</span>
01913                 <span class="comment">// Don't let the verifier header transform a bad caller into a</span>
01914                 <span class="comment">// good caller.  Fail via the fall through so an exception</span>
01915                 <span class="comment">// can be thrown if asked for, etc.</span>
01916                 <span class="comment">//</span>
01917 
01918                 <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.UnTrackedPool += 1;
01919             }
01920             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a6">MUST_SUCCEED_POOL_TYPE_MASK</a>) == 0) ||
01921                      (ChargedBytes &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) {
01922 
01923                 <span class="comment">//</span>
01924                 <span class="comment">// Any pool allocation that is allowed to fail or where the</span>
01925                 <span class="comment">// total number of charged bytes fits in a page (nonpaged-</span>
01926                 <span class="comment">// must-succeed requires this) is suitable for tracking.</span>
01927                 <span class="comment">// Just ensure that the hash list has space for it.</span>
01928                 <span class="comment">//</span>
01929 
01930                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a96">ViReservePoolAllocation</a> (Verifier) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01931                     ReservedHash = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01932                     NumberOfBytes = ChargedBytes;
01933                     PoolType |= <a class="code" href="../../d4/d2/pool_8h.html#a9">POOL_VERIFIER_MASK</a>;
01934                 }
01935             }
01936             <span class="keywordflow">else</span> {
01937                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>) == <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>);
01938                 <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.UnTrackedPool += 1;
01939             }
01940         }
01941     }
01942 
01943     VirtualAddress = <a class="code" href="../../d5/d8/ex_8h.html#a222">ExAllocatePoolWithTagPriority</a> (PoolType,
01944                                                     NumberOfBytes,
01945                                                     Tag,
01946                                                     AllocationPriority);
01947 
01948     <span class="keywordflow">if</span> (VirtualAddress == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01949         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.AllocationsFailed += 1;
01950 
01951         <span class="keywordflow">if</span> (ReservedHash == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01952 
01953             <span class="comment">//</span>
01954             <span class="comment">// Release the hash table entry now as it's not needed.</span>
01955             <span class="comment">//</span>
01956 
01957             <a class="code" href="../../d9/d5/verifier_8c.html#a98">ViCancelPoolAllocation</a> (Verifier);
01958         }
01959 
01960         <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d5/d8/ex_8h.html#a3">POOL_RAISE_IF_ALLOCATION_FAILURE</a>) != 0) {
01961             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INSUFFICIENT_RESOURCES);
01962         }
01963         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01964     }
01965 
01966     VirtualAddress = <a class="code" href="../../d9/d5/verifier_8c.html#a104">ViPostPoolAllocation</a> (VirtualAddress,
01967                                            NumberOfBytes,
01968                                            PoolType,
01969                                            Tag,
01970                                            CallingAddress);
01971 
01972     <span class="keywordflow">return</span> VirtualAddress;
01973 }
01974 
01975 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01976"></a><a class="code" href="../../d2/d1/mm_8h.html#a235">01976</a> <a class="code" href="../../d9/d5/verifier_8c.html#a91">VerifierFreeTrackedPool</a>(
01977     IN PVOID VirtualAddress,
01978     IN SIZE_T ChargedBytes,
01979     IN LOGICAL CheckType,
01980     IN LOGICAL SpecialPool
01981     )
01982 
01983 <span class="comment">/*++</span>
01984 <span class="comment"></span>
01985 <span class="comment">Routine Description:</span>
01986 <span class="comment"></span>
01987 <span class="comment">    Called directly from the pool manager or the memory manager for verifier-</span>
01988 <span class="comment">    tracked allocations.  The call to ExFreePool is already in progress.</span>
01989 <span class="comment"></span>
01990 <span class="comment">Arguments:</span>
01991 <span class="comment"></span>
01992 <span class="comment">    VirtualAddress - Supplies the virtual address being freed.</span>
01993 <span class="comment"></span>
01994 <span class="comment">    ChargedBytes - Supplies the number of bytes charged to this allocation.</span>
01995 <span class="comment"></span>
01996 <span class="comment">    CheckType - Supplies PagedPool or NonPagedPool.</span>
01997 <span class="comment"></span>
01998 <span class="comment">    SpecialPool - Supplies TRUE if the allocation is from special pool.</span>
01999 <span class="comment"></span>
02000 <span class="comment">Return Value:</span>
02001 <span class="comment"></span>
02002 <span class="comment">    None.</span>
02003 <span class="comment"></span>
02004 <span class="comment">Environment:</span>
02005 <span class="comment"></span>
02006 <span class="comment">    Kernel mode.</span>
02007 <span class="comment"></span>
02008 <span class="comment">    N.B.</span>
02009 <span class="comment"></span>
02010 <span class="comment">    Callers freeing small pool allocations hold no locks or mutexes on entry.</span>
02011 <span class="comment"></span>
02012 <span class="comment">    Callers freeing special pool hold no locks or mutexes on entry.</span>
02013 <span class="comment"></span>
02014 <span class="comment">    Callers freeing pool of PAGE_SIZE or larger hold the PFN lock (for nonpaged</span>
02015 <span class="comment">    allocations) or the PagedPool mutex (for paged allocations) on entry.</span>
02016 <span class="comment"></span>
02017 <span class="comment">--*/</span>
02018 
02019 {
02020     KIRQL OldIrql;
02021     ULONG_PTR <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02022     <a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a> PoolHeader;
02023     <a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">PMI_VERIFIER_POOL_HEADER</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
02024     <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> Verifier;
02025 
02026     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a28">VerifierIsTrackingPool</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02027 
02028         <span class="comment">//</span>
02029         <span class="comment">// The verifier is not enabled so the only way this routine is being</span>
02030         <span class="comment">// called is because the pool header is mangled or the caller specified</span>
02031         <span class="comment">// a bad address.  Either way it's a bugcheck.</span>
02032         <span class="comment">//</span>
02033 
02034         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (BAD_POOL_CALLER,
02035                       0x99,
02036                       (ULONG_PTR)VirtualAddress,
02037                       0,
02038                       0);
02039     }
02040 
02041     <span class="keywordflow">if</span> (SpecialPool == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02042 
02043         <span class="comment">//</span>
02044         <span class="comment">// Special pool allocation.</span>
02045         <span class="comment">//</span>
02046 
02047         <span class="keywordflow">if</span> (((ULONG_PTR)VirtualAddress &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1))) {
02048             PoolHeader = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (VirtualAddress);
02049             <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = (<a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">PMI_VERIFIER_POOL_HEADER</a>)(PoolHeader + 1);
02050         }
02051         <span class="keywordflow">else</span> {
02052             PoolHeader = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((PCHAR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (VirtualAddress) + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>);
02053             <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = (<a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">PMI_VERIFIER_POOL_HEADER</a>)(PoolHeader - 1);
02054         }
02055     }
02056     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/poolhack_8c.html#a5">PAGE_ALIGNED</a>(VirtualAddress)) {
02057 
02058         <span class="comment">//</span>
02059         <span class="comment">// Large page allocation.</span>
02060         <span class="comment">//</span>
02061 
02062         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = (<a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">PMI_VERIFIER_POOL_HEADER</a>) ((PCHAR)VirtualAddress +
02063                      ChargedBytes -
02064                      <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">MI_VERIFIER_POOL_HEADER</a>));
02065     }
02066     <span class="keywordflow">else</span> {
02067         ChargedBytes -= <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>;
02068         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = (<a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">PMI_VERIFIER_POOL_HEADER</a>) ((PCHAR)VirtualAddress +
02069                      ChargedBytes -
02070                      <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">MI_VERIFIER_POOL_HEADER</a>));
02071     }
02072 
02073     Verifier = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Verifier;
02074 
02075     <span class="comment">//</span>
02076     <span class="comment">// Check the pointer now so we can give a more friendly bugcheck</span>
02077     <span class="comment">// rather than crashing below on a bad reference.</span>
02078     <span class="comment">//</span>
02079 
02080     <span class="keywordflow">if</span> ((((ULONG_PTR)Verifier &amp; (<span class="keyword">sizeof</span>(ULONG) - 1)) != 0) ||
02081         (!<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(&amp;Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o7">Signature</a>)) ||
02082         (Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o7">Signature</a> != <a class="code" href="../../d4/d8/mi_8h.html#a251">MI_VERIFIER_ENTRY_SIGNATURE</a>)) {
02083 
02084         <span class="comment">//</span>
02085         <span class="comment">// The caller corrupted the saved verifier field.</span>
02086         <span class="comment">//</span>
02087 
02088         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
02089                       0x53,
02090                       (ULONG_PTR)VirtualAddress,
02091                       (ULONG_PTR)<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>,
02092                       (ULONG_PTR)Verifier);
02093     }
02094 
02095     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ListIndex;
02096 
02097     ExAcquireSpinLock (&amp;Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o9">VerifierPoolLock</a>, &amp;OldIrql);
02098 
02099     <a class="code" href="../../d9/d5/verifier_8c.html#a99">ViReleasePoolAllocation</a> (Verifier,
02100                              VirtualAddress,
02101                              <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>,
02102                              ChargedBytes);
02103 
02104     <span class="keywordflow">if</span> (CheckType == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
02105         Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o18">PagedBytes</a> -= ChargedBytes;
02106         Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o14">CurrentPagedPoolAllocations</a> -= 1;
02107 
02108         ExReleaseSpinLock (&amp;Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o9">VerifierPoolLock</a>, OldIrql);
02109 
02110         ExAcquireFastMutex (&amp;<a class="code" href="../../d9/d5/verifier_8c.html#a31">VerifierPoolMutex</a>);
02111         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.PagedBytes -= ChargedBytes;
02112         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.CurrentPagedPoolAllocations -= 1;
02113         ExReleaseFastMutex (&amp;<a class="code" href="../../d9/d5/verifier_8c.html#a31">VerifierPoolMutex</a>);
02114     }
02115     <span class="keywordflow">else</span> {
02116         Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o19">NonPagedBytes</a> -= ChargedBytes;
02117         Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o15">CurrentNonPagedPoolAllocations</a> -= 1;
02118         ExReleaseSpinLock (&amp;Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o9">VerifierPoolLock</a>, OldIrql);
02119 
02120         ExAcquireSpinLock (&amp;<a class="code" href="../../d9/d5/verifier_8c.html#a30">VerifierPoolLock</a>, &amp;OldIrql);
02121         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.NonPagedBytes -= ChargedBytes;
02122         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.CurrentNonPagedPoolAllocations -= 1;
02123         ExReleaseSpinLock (&amp;<a class="code" href="../../d9/d5/verifier_8c.html#a30">VerifierPoolLock</a>, OldIrql);
02124     }
02125 }
02126 
02127 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
02128 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02129"></a><a class="code" href="../../d9/d5/verifier_8c.html#a59">02129</a> <a class="code" href="../../d9/d5/verifier_8c.html#a59">VerifierFreePool</a>(
02130     IN PVOID P
02131     )
02132 {
02133     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a61">KernelVerifier</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02134         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (P);
02135         <span class="keywordflow">return</span>;
02136     }
02137 
02138     <a class="code" href="../../d9/d5/verifier_8c.html#a60">VerifierFreePoolWithTag</a> (P, 0);
02139 }
02140 
02141 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
02142 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02143"></a><a class="code" href="../../d9/d5/verifier_8c.html#a60">02143</a> <a class="code" href="../../d9/d5/verifier_8c.html#a60">VerifierFreePoolWithTag</a>(
02144     IN PVOID P,
02145     IN ULONG TagToFree
02146     )
02147 {
02148     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a61">KernelVerifier</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02149         <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a> (P, TagToFree);
02150         <span class="keywordflow">return</span>;
02151     }
02152 
02153     <a class="code" href="../../d5/d8/ex_8h.html#a218">ExFreePoolSanityChecks</a> (P);
02154 
02155     <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a> (P, TagToFree);
02156 }
02157 
02158 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
02159 LONG
<a name="l02160"></a><a class="code" href="../../d9/d5/verifier_8c.html#a61">02160</a> <a class="code" href="../../d9/d5/verifier_8c.html#a61">VerifierSetEvent</a> (
02161     IN <a class="code" href="../../d2/d6/struct__KEVENT.html">PRKEVENT</a> Event,
02162     IN KPRIORITY Increment,
02163     IN BOOLEAN Wait
02164     )
02165 {
02166     KIRQL CurrentIrql;
02167 
02168     CurrentIrql = KeGetCurrentIrql();
02169     <span class="keywordflow">if</span> (CurrentIrql &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
02170         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
02171                       0x80,
02172                       CurrentIrql,
02173                       (ULONG_PTR)<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>,
02174                       (ULONG_PTR)0);
02175     }
02176 
02177     <span class="keywordflow">return</span> <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>, <a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a>, Wait);
02178 }
02179 
02180 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
02181 BOOLEAN
<a name="l02182"></a><a class="code" href="../../d9/d5/verifier_8c.html#a77">02182</a> <a class="code" href="../../d9/d5/verifier_8c.html#a77">VerifierExAcquireResourceExclusive</a>(
02183     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource,
02184     IN BOOLEAN Wait
02185     )
02186 {
02187     KIRQL CurrentIrql;
02188 
02189     CurrentIrql = KeGetCurrentIrql ();
02190 
02191     <span class="keywordflow">if</span> ((CurrentIrql != <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) &amp;&amp;
02192         (!<a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>())) &amp;&amp;
02193         (<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable == 0)) {
02194 
02195             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
02196                           0x37,
02197                           CurrentIrql,
02198                           (ULONG_PTR)(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable),
02199                           (ULONG_PTR)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>);
02200     }
02201 
02202     <span class="keywordflow">return</span> <a class="code" href="../../d5/d8/ex_8h.html#a269">ExAcquireResourceExclusiveLite</a> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, Wait);
02203 }
02204 
02205 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
02206 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02207 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l02208"></a><a class="code" href="../../d9/d5/verifier_8c.html#a78">02208</a> <a class="code" href="../../d9/d5/verifier_8c.html#a78">VerifierExReleaseResource</a>(
02209     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource
02210     )
02211 {
02212     KIRQL CurrentIrql;
02213 
02214     CurrentIrql = KeGetCurrentIrql ();
02215 
02216     <span class="keywordflow">if</span> ((CurrentIrql != <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) &amp;&amp;
02217         (!<a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>())) &amp;&amp;
02218         (<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable == 0)) {
02219 
02220             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
02221                           0x38,
02222                           CurrentIrql,
02223                           (ULONG_PTR)(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable),
02224                           (ULONG_PTR)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>);
02225     }
02226 
02227     <a class="code" href="../../d5/d8/ex_8h.html#a273">ExReleaseResourceLite</a> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>);
02228 }
02229 
<a name="l02230"></a><a class="code" href="../../d9/d5/verifier_8c.html#a43">02230</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/d5/verifier_8c.html#a43">VerifierIrqlData</a>[0x10];
02231 
02232 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02233"></a><a class="code" href="../../d9/d5/verifier_8c.html#a100">02233</a> <a class="code" href="../../d9/d5/verifier_8c.html#a100">KfSanityCheckRaiseIrql</a> (
02234     IN KIRQL NewIrql
02235     )
02236 {
02237     KIRQL CurrentIrql;
02238 
02239     <span class="comment">//</span>
02240     <span class="comment">// Check for the caller inadvertently lowering.</span>
02241     <span class="comment">//</span>
02242 
02243     CurrentIrql = KeGetCurrentIrql ();
02244 
02245     <span class="keywordflow">if</span> (CurrentIrql == NewIrql) {
02246         <a class="code" href="../../d9/d5/verifier_8c.html#a43">VerifierIrqlData</a>[0] += 1;
02247         <span class="keywordflow">if</span> (CurrentIrql == <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {
02248             <a class="code" href="../../d9/d5/verifier_8c.html#a43">VerifierIrqlData</a>[1] += 1;
02249         }
02250         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CurrentIrql == <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
02251             <a class="code" href="../../d9/d5/verifier_8c.html#a43">VerifierIrqlData</a>[2] += 1;
02252         }
02253         <span class="keywordflow">else</span> {
02254             <a class="code" href="../../d9/d5/verifier_8c.html#a43">VerifierIrqlData</a>[3] += 1;
02255         }
02256     }
02257     <span class="keywordflow">else</span> {
02258         <a class="code" href="../../d9/d5/verifier_8c.html#a43">VerifierIrqlData</a>[4] += 1;
02259     }
02260 
02261     <span class="keywordflow">if</span> (CurrentIrql &gt; NewIrql) {
02262         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
02263                       0x30,
02264                       CurrentIrql,
02265                       NewIrql,
02266                       0);
02267     }
02268 
02269     <span class="comment">//</span>
02270     <span class="comment">// Check for the caller using an uninitialized variable.</span>
02271     <span class="comment">//</span>
02272 
02273     <span class="keywordflow">if</span> (NewIrql &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a57">HIGH_LEVEL</a>) {
02274         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
02275                       0x30,
02276                       CurrentIrql,
02277                       NewIrql,
02278                       0);
02279     }
02280 }
02281 
02282 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02283"></a><a class="code" href="../../d9/d5/verifier_8c.html#a101">02283</a> <a class="code" href="../../d9/d5/verifier_8c.html#a101">KfSanityCheckLowerIrql</a> (
02284     IN KIRQL NewIrql
02285     )
02286 {
02287     KIRQL CurrentIrql;
02288 
02289     <span class="comment">//</span>
02290     <span class="comment">// Check for the caller inadvertently lowering.</span>
02291     <span class="comment">//</span>
02292 
02293     CurrentIrql = KeGetCurrentIrql ();
02294 
02295     <span class="keywordflow">if</span> (CurrentIrql == NewIrql) {
02296         <a class="code" href="../../d9/d5/verifier_8c.html#a43">VerifierIrqlData</a>[8] += 1;
02297         <span class="keywordflow">if</span> (CurrentIrql == <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {
02298             <a class="code" href="../../d9/d5/verifier_8c.html#a43">VerifierIrqlData</a>[9] += 1;
02299         }
02300         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CurrentIrql == <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
02301             <a class="code" href="../../d9/d5/verifier_8c.html#a43">VerifierIrqlData</a>[10] += 1;
02302         }
02303         <span class="keywordflow">else</span> {
02304             <a class="code" href="../../d9/d5/verifier_8c.html#a43">VerifierIrqlData</a>[11] += 1;
02305         }
02306     }
02307     <span class="keywordflow">else</span> {
02308         <a class="code" href="../../d9/d5/verifier_8c.html#a43">VerifierIrqlData</a>[12] += 1;
02309     }
02310 
02311     <span class="keywordflow">if</span> (CurrentIrql &lt; NewIrql) {
02312         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
02313                       0x31,
02314                       CurrentIrql,
02315                       NewIrql,
02316                       0);
02317     }
02318 
02319     <span class="comment">//</span>
02320     <span class="comment">// Check for the caller using an uninitialized variable.</span>
02321     <span class="comment">//</span>
02322 
02323     <span class="keywordflow">if</span> (NewIrql &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a57">HIGH_LEVEL</a>) {
02324         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
02325                       0x31,
02326                       CurrentIrql,
02327                       NewIrql,
02328                       0);
02329     }
02330 }
02331 
02332 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02333"></a><a class="code" href="../../d9/d5/verifier_8c.html#a94">02333</a> <a class="code" href="../../d9/d5/verifier_8c.html#a94">ViTrimAllSystemPagableMemory</a> (
02334     VOID
02335     )
02336 {
02337     LARGE_INTEGER CurrentTime;
02338     LOGICAL PageOut;
02339 
02340     PageOut = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02341     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a61">KernelVerifier</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02342         <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a4">KeQueryTickCount</a>(&amp;CurrentTime);
02343         <span class="keywordflow">if</span> ((CurrentTime.LowPart &amp; <a class="code" href="../../d9/d5/verifier_8c.html#a36">KernelVerifierTickPage</a>) != 0) {
02344             PageOut = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02345         }
02346     }
02347 
02348     <span class="keywordflow">if</span> ((PageOut == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp; (<a class="code" href="../../d9/d5/verifier_8c.html#a23">MiNoPageOnRaiseIrql</a> == 0)) {
02349         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.TrimRequests += 1;
02350         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/wsmanage_8c.html#a48">MmTrimAllSystemPagableMemory</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02351             <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Trims += 1;
02352         }
02353     }
02354 }
02355 
02356 <span class="keyword">typedef</span>
02357 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02358"></a><a class="code" href="../../d9/d5/verifier_8c.html#a44">02358</a> (*PKE_ACQUIRE_SPINLOCK) (
02359     IN PKSPIN_LOCK SpinLock,
02360     OUT PKIRQL OldIrql
02361     );
02362 
02363 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
02364 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02365"></a><a class="code" href="../../d9/d5/verifier_8c.html#a66">02365</a> <a class="code" href="../../d9/d5/verifier_8c.html#a66">VerifierKeAcquireSpinLock</a> (
02366     IN PKSPIN_LOCK SpinLock,
02367     OUT PKIRQL OldIrql
02368     )
02369 {
02370     KIRQL CurrentIrql;
02371     <a class="code" href="../../d9/d5/verifier_8c.html#a44">PKE_ACQUIRE_SPINLOCK</a> HalRoutine;
02372 
02373     CurrentIrql = KeGetCurrentIrql ();
02374 
02375     <a class="code" href="../../d9/d5/verifier_8c.html#a100">KfSanityCheckRaiseIrql</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
02376 
02377     <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.AcquireSpinLocks += 1;
02378 
02379     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Level &amp; DRIVER_VERIFIER_FORCE_IRQL_CHECKING) {
02380         <span class="keywordflow">if</span> (CurrentIrql &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
02381             <a class="code" href="../../d9/d5/verifier_8c.html#a94">ViTrimAllSystemPagableMemory</a> ();
02382         }
02383     }
02384 
02385 <span class="preprocessor">#if defined (_X86_)</span>
02386 <span class="preprocessor"></span>    HalRoutine = (<a class="code" href="../../d9/d5/verifier_8c.html#a44">PKE_ACQUIRE_SPINLOCK</a>) (ULONG_PTR) MiKernelVerifierOriginalCalls[VI_KE_ACQUIRE_SPINLOCK];
02387 
02388     <span class="keywordflow">if</span> (HalRoutine) {
02389         (*HalRoutine)(SpinLock, OldIrql);
02390         <span class="keywordflow">return</span>;
02391     }
02392 <span class="preprocessor">#endif</span>
02393 <span class="preprocessor"></span>
02394     <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a> (SpinLock, OldIrql);
02395 }
02396 
02397 <span class="keyword">typedef</span>
02398 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02399"></a><a class="code" href="../../d9/d5/verifier_8c.html#a45">02399</a> (*PKE_RELEASE_SPINLOCK) (
02400     IN PKSPIN_LOCK SpinLock,
02401     IN KIRQL NewIrql
02402     );
02403 
02404 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
02405 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02406"></a><a class="code" href="../../d9/d5/verifier_8c.html#a67">02406</a> <a class="code" href="../../d9/d5/verifier_8c.html#a67">VerifierKeReleaseSpinLock</a> (
02407     IN PKSPIN_LOCK SpinLock,
02408     IN KIRQL NewIrql
02409     )
02410 {
02411     KIRQL CurrentIrql;
02412     <a class="code" href="../../d9/d5/verifier_8c.html#a45">PKE_RELEASE_SPINLOCK</a> HalRoutine;
02413 
02414     CurrentIrql = KeGetCurrentIrql ();
02415 
02416     <span class="comment">//</span>
02417     <span class="comment">// Caller better still be at DISPATCH_LEVEL when releasing the spinlock</span>
02418     <span class="comment">//</span>
02419 
02420     <span class="keywordflow">if</span> (CurrentIrql != <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
02421         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
02422                       0x32,
02423                       CurrentIrql,
02424                       (ULONG_PTR)SpinLock,
02425                       0);
02426     }
02427 
02428     <a class="code" href="../../d9/d5/verifier_8c.html#a101">KfSanityCheckLowerIrql</a> (NewIrql);
02429 
02430 <span class="preprocessor">#if defined (_X86_)</span>
02431 <span class="preprocessor"></span>    HalRoutine = (<a class="code" href="../../d9/d5/verifier_8c.html#a45">PKE_RELEASE_SPINLOCK</a>) (ULONG_PTR) MiKernelVerifierOriginalCalls[VI_KE_RELEASE_SPINLOCK];
02432 
02433     <span class="keywordflow">if</span> (HalRoutine) {
02434         (*HalRoutine)(SpinLock, NewIrql);
02435         <span class="keywordflow">return</span>;
02436     }
02437 <span class="preprocessor">#endif</span>
02438 <span class="preprocessor"></span>
02439     <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a> (SpinLock, NewIrql);
02440 }
02441 
02442 <span class="preprocessor">#if defined (_X86_)</span>
02443 <span class="preprocessor"></span>
02444 <span class="keyword">typedef</span>
02445 KIRQL
02446 (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a> *PKF_ACQUIRE_SPINLOCK) (
02447     IN PKSPIN_LOCK SpinLock
02448     );
02449 
02450 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
02451 KIRQL
02452 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
02453 <a class="code" href="../../d9/d5/verifier_8c.html#a68">VerifierKfAcquireSpinLock</a> (
02454     IN PKSPIN_LOCK SpinLock
02455     )
02456 {
02457     KIRQL CurrentIrql;
02458     PKF_ACQUIRE_SPINLOCK HalRoutine;
02459 
02460     CurrentIrql = KeGetCurrentIrql ();
02461 
02462     <a class="code" href="../../d9/d5/verifier_8c.html#a100">KfSanityCheckRaiseIrql</a> (DISPATCH_LEVEL);
02463 
02464     <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.AcquireSpinLocks += 1;
02465 
02466     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Level &amp; DRIVER_VERIFIER_FORCE_IRQL_CHECKING) {
02467         <span class="keywordflow">if</span> (CurrentIrql &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
02468             <a class="code" href="../../d9/d5/verifier_8c.html#a94">ViTrimAllSystemPagableMemory</a> ();
02469         }
02470     }
02471 
02472 <span class="preprocessor">#if defined (_X86_)</span>
02473 <span class="preprocessor"></span>    HalRoutine = (PKF_ACQUIRE_SPINLOCK) (ULONG_PTR) MiKernelVerifierOriginalCalls[VI_KF_ACQUIRE_SPINLOCK];
02474 
02475     <span class="keywordflow">if</span> (HalRoutine) {
02476         <span class="keywordflow">return</span> (*HalRoutine)(SpinLock);
02477     }
02478 <span class="preprocessor">#endif</span>
02479 <span class="preprocessor"></span>
02480     CurrentIrql = KfAcquireSpinLock (SpinLock);
02481 
02482     <span class="keywordflow">return</span> CurrentIrql;
02483 }
02484 
02485 <span class="keyword">typedef</span>
02486 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02487 (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a> *PKF_RELEASE_SPINLOCK) (
02488     IN PKSPIN_LOCK SpinLock,
02489     IN KIRQL NewIrql
02490     );
02491 
02492 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
02493 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02494 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
02495 <a class="code" href="../../d9/d5/verifier_8c.html#a69">VerifierKfReleaseSpinLock</a> (
02496     IN PKSPIN_LOCK SpinLock,
02497     IN KIRQL NewIrql
02498     )
02499 {
02500     KIRQL CurrentIrql;
02501     PKF_RELEASE_SPINLOCK HalRoutine;
02502 
02503     CurrentIrql = KeGetCurrentIrql ();
02504 
02505     <span class="comment">//</span>
02506     <span class="comment">// Caller better still be at DISPATCH_LEVEL when releasing the spinlock.</span>
02507     <span class="comment">//</span>
02508 
02509     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a61">KernelVerifier</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02510         <span class="keywordflow">if</span> (CurrentIrql &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
02511             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
02512                           0x35,
02513                           CurrentIrql,
02514                           (ULONG_PTR)SpinLock,
02515                           NewIrql);
02516         }
02517     }
02518     <span class="keywordflow">else</span> {
02519         <span class="keywordflow">if</span> (CurrentIrql != <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
02520             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
02521                           0x32,
02522                           CurrentIrql,
02523                           (ULONG_PTR)SpinLock,
02524                           NewIrql);
02525         }
02526     }
02527 
02528     <a class="code" href="../../d9/d5/verifier_8c.html#a101">KfSanityCheckLowerIrql</a> (NewIrql);
02529 
02530 <span class="preprocessor">#if defined (_X86_)</span>
02531 <span class="preprocessor"></span>    HalRoutine = (PKF_RELEASE_SPINLOCK) (ULONG_PTR) MiKernelVerifierOriginalCalls[VI_KF_RELEASE_SPINLOCK];
02532 
02533     <span class="keywordflow">if</span> (HalRoutine) {
02534         (*HalRoutine)(SpinLock, NewIrql);
02535         <span class="keywordflow">return</span>;
02536     }
02537 <span class="preprocessor">#endif</span>
02538 <span class="preprocessor"></span>
02539     KfReleaseSpinLock (SpinLock, NewIrql);
02540 }
02541 
02542 
02543 <span class="preprocessor">#if !defined(NT_UP)</span>
02544 <span class="preprocessor"></span>
02545 <span class="keyword">typedef</span>
02546 KIRQL
02547 (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a> *PKE_ACQUIRE_QUEUED_SPINLOCK) (
02548     IN <a class="code" href="../../d0/d9/ntosdef_8h.html#a35">KSPIN_LOCK_QUEUE_NUMBER</a> Number
02549     );
02550 
02551 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
02552 KIRQL
02553 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
02554 <a class="code" href="../../d9/d5/verifier_8c.html#a79">VerifierKeAcquireQueuedSpinLock</a> (
02555     IN KSPIN_LOCK_QUEUE_NUMBER Number
02556     )
02557 {
02558     KIRQL CurrentIrql;
02559     PKE_ACQUIRE_QUEUED_SPINLOCK HalRoutine;
02560 
02561     CurrentIrql = KeGetCurrentIrql ();
02562 
02563     <a class="code" href="../../d9/d5/verifier_8c.html#a100">KfSanityCheckRaiseIrql</a> (DISPATCH_LEVEL);
02564 
02565     <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.AcquireSpinLocks += 1;
02566 
02567     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Level &amp; DRIVER_VERIFIER_FORCE_IRQL_CHECKING) {
02568         <span class="keywordflow">if</span> (CurrentIrql &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
02569             <a class="code" href="../../d9/d5/verifier_8c.html#a94">ViTrimAllSystemPagableMemory</a> ();
02570         }
02571     }
02572 
02573 <span class="preprocessor">#if defined (_X86_)</span>
02574 <span class="preprocessor"></span>    HalRoutine = (PKE_ACQUIRE_QUEUED_SPINLOCK) MiKernelVerifierOriginalCalls[VI_KE_ACQUIRE_QUEUED_SPINLOCK];
02575 
02576     <span class="keywordflow">if</span> (HalRoutine) {
02577         <span class="keywordflow">return</span> (*HalRoutine)(Number);
02578     }
02579 <span class="preprocessor">#endif</span>
02580 <span class="preprocessor"></span>
02581     CurrentIrql = KeAcquireQueuedSpinLock (Number);
02582 
02583     <span class="keywordflow">return</span> CurrentIrql;
02584 }
02585 
02586 <span class="keyword">typedef</span>
02587 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02588 (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a> *PKE_RELEASE_QUEUED_SPINLOCK) (
02589     IN <a class="code" href="../../d0/d9/ntosdef_8h.html#a35">KSPIN_LOCK_QUEUE_NUMBER</a> Number,
02590     IN KIRQL OldIrql
02591     );
02592 
02593 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
02594 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02595 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
02596 <a class="code" href="../../d9/d5/verifier_8c.html#a80">VerifierKeReleaseQueuedSpinLock</a> (
02597     IN KSPIN_LOCK_QUEUE_NUMBER Number,
02598     IN KIRQL OldIrql
02599     )
02600 {
02601     KIRQL CurrentIrql;
02602     PKE_RELEASE_QUEUED_SPINLOCK HalRoutine;
02603 
02604     CurrentIrql = KeGetCurrentIrql ();
02605 
02606     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a61">KernelVerifier</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02607         <span class="keywordflow">if</span> (CurrentIrql &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
02608             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
02609                           0x36,
02610                           CurrentIrql,
02611                           (ULONG_PTR)Number,
02612                           (ULONG_PTR)OldIrql);
02613         }
02614     }
02615 
02616     <a class="code" href="../../d9/d5/verifier_8c.html#a101">KfSanityCheckLowerIrql</a> (OldIrql);
02617 
02618 <span class="preprocessor">#if defined (_X86_)</span>
02619 <span class="preprocessor"></span>    HalRoutine = (PKE_RELEASE_QUEUED_SPINLOCK) MiKernelVerifierOriginalCalls[VI_KE_RELEASE_QUEUED_SPINLOCK];
02620 
02621     <span class="keywordflow">if</span> (HalRoutine) {
02622         (*HalRoutine)(Number, OldIrql);
02623         <span class="keywordflow">return</span>;
02624     }
02625 <span class="preprocessor">#endif</span>
02626 <span class="preprocessor"></span>
02627     KeReleaseQueuedSpinLock (Number, OldIrql);
02628 }
02629 <span class="preprocessor">#endif</span>
02630 <span class="preprocessor"></span>
02631 <span class="keyword">typedef</span>
02632 KIRQL
02633 (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a> *PKF_RAISE_IRQL) (
02634     IN KIRQL NewIrql
02635     );
02636 
02637 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
02638 KIRQL
02639 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
02640 <a class="code" href="../../d9/d5/verifier_8c.html#a62">VerifierKfRaiseIrql</a> (
02641     IN KIRQL NewIrql
02642     )
02643 {
02644     PKF_RAISE_IRQL HalRoutine;
02645     KIRQL CurrentIrql;
02646 
02647     CurrentIrql = KeGetCurrentIrql ();
02648 
02649     <a class="code" href="../../d9/d5/verifier_8c.html#a100">KfSanityCheckRaiseIrql</a> (NewIrql);
02650 
02651     <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.RaiseIrqls += 1;
02652 
02653     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Level &amp; DRIVER_VERIFIER_FORCE_IRQL_CHECKING) {
02654         <span class="keywordflow">if</span> ((CurrentIrql &lt; DISPATCH_LEVEL) &amp;&amp; (NewIrql &gt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>)) {
02655             <a class="code" href="../../d9/d5/verifier_8c.html#a94">ViTrimAllSystemPagableMemory</a> ();
02656         }
02657     }
02658 
02659 <span class="preprocessor">#if defined (_X86_)</span>
02660 <span class="preprocessor"></span>    HalRoutine = (PKF_RAISE_IRQL) (ULONG_PTR) MiKernelVerifierOriginalCalls[VI_KF_RAISE_IRQL];
02661     <span class="keywordflow">if</span> (HalRoutine) {
02662         <span class="keywordflow">return</span> (*HalRoutine)(NewIrql);
02663     }
02664 <span class="preprocessor">#endif</span>
02665 <span class="preprocessor"></span>
02666     <span class="keywordflow">return</span> KfRaiseIrql (NewIrql);
02667 }
02668 
02669 <span class="keyword">typedef</span>
02670 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02671 (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a> *PKF_LOWER_IRQL) (
02672     IN KIRQL NewIrql
02673     );
02674 
02675 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
02676 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02677 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
02678 <a class="code" href="../../d9/d5/verifier_8c.html#a63">VerifierKfLowerIrql</a> (
02679     IN KIRQL NewIrql
02680     )
02681 {
02682     PKF_LOWER_IRQL HalRoutine;
02683 
02684     <a class="code" href="../../d9/d5/verifier_8c.html#a101">KfSanityCheckLowerIrql</a> (NewIrql);
02685 
02686 <span class="preprocessor">#if defined (_X86_)</span>
02687 <span class="preprocessor"></span>    HalRoutine = (PKF_LOWER_IRQL) (ULONG_PTR) MiKernelVerifierOriginalCalls[VI_KF_LOWER_IRQL];
02688     <span class="keywordflow">if</span> (HalRoutine) {
02689         (*HalRoutine)(NewIrql);
02690         <span class="keywordflow">return</span>;
02691     }
02692 <span class="preprocessor">#endif</span>
02693 <span class="preprocessor"></span>
02694     KfLowerIrql (NewIrql);
02695 }
02696 
02697 <span class="preprocessor">#endif</span>
02698 <span class="preprocessor"></span>
02699 <span class="preprocessor">#if defined(_ALPHA_)</span>
02700 <span class="preprocessor"></span><a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
02701 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02702 VerifierKeAcquireSpinLockAtDpcLevel (
02703     IN PKSPIN_LOCK SpinLock
02704     )
02705 {
02706     KIRQL CurrentIrql;
02707 
02708     CurrentIrql = KeGetCurrentIrql ();
02709 
02710     <span class="comment">//</span>
02711     <span class="comment">// Caller better be at DISPATCH_LEVEL.</span>
02712     <span class="comment">//</span>
02713 
02714     <span class="keywordflow">if</span> (CurrentIrql != <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
02715         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
02716                       0x40,
02717                       CurrentIrql,
02718                       (ULONG_PTR)SpinLock,
02719                       0);
02720     }
02721 
02722     <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.AcquireSpinLocks += 1;
02723 
02724     <a class="code" href="../../d4/d9/ke_8h.html#a356">KeAcquireSpinLockAtDpcLevel</a> (SpinLock);
02725 }
02726 
02727 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
02728 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02729 VerifierKeReleaseSpinLockFromDpcLevel (
02730     IN PKSPIN_LOCK SpinLock
02731     )
02732 {
02733     KIRQL CurrentIrql;
02734 
02735     CurrentIrql = KeGetCurrentIrql ();
02736 
02737     <span class="comment">//</span>
02738     <span class="comment">// Caller better be at DISPATCH_LEVEL.</span>
02739     <span class="comment">//</span>
02740 
02741     <span class="keywordflow">if</span> (CurrentIrql != <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
02742         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
02743                       0x41,
02744                       CurrentIrql,
02745                       (ULONG_PTR)SpinLock,
02746                       0);
02747     }
02748 
02749     <a class="code" href="../../d4/d9/ke_8h.html#a357">KeReleaseSpinLockFromDpcLevel</a> (SpinLock);
02750 }
02751 
02752 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
02753 KIRQL
02754 VerifierKeAcquireSpinLockRaiseToDpc (
02755     IN PKSPIN_LOCK SpinLock
02756     )
02757 {
02758     KIRQL CurrentIrql;
02759 
02760     CurrentIrql = KeGetCurrentIrql ();
02761 
02762     <span class="comment">//</span>
02763     <span class="comment">// Caller better be at or below DISPATCH_LEVEL.</span>
02764     <span class="comment">//</span>
02765 
02766     <span class="keywordflow">if</span> (CurrentIrql &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
02767         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
02768                       0x42,
02769                       CurrentIrql,
02770                       (ULONG_PTR)SpinLock,
02771                       0);
02772     }
02773 
02774     <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.AcquireSpinLocks += 1;
02775 
02776     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Level &amp; DRIVER_VERIFIER_FORCE_IRQL_CHECKING) {
02777         <span class="keywordflow">if</span> (CurrentIrql &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
02778             <a class="code" href="../../d9/d5/verifier_8c.html#a94">ViTrimAllSystemPagableMemory</a> ();
02779         }
02780     }
02781 
02782     <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/ke_8h.html#a358">KeAcquireSpinLockRaiseToDpc</a> (SpinLock);
02783 }
02784 <span class="preprocessor">#endif</span>
02785 <span class="preprocessor"></span>
02786 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
02787 BOOLEAN
02788 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l02789"></a><a class="code" href="../../d9/d5/verifier_8c.html#a72">02789</a> <a class="code" href="../../d9/d5/verifier_8c.html#a72">VerifierExTryToAcquireFastMutex</a> (
02790     IN <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a> FastMutex
02791     )
02792 {
02793     KIRQL CurrentIrql;
02794 
02795     CurrentIrql = KeGetCurrentIrql ();
02796 
02797     <span class="comment">//</span>
02798     <span class="comment">// Caller better be at or below APC_LEVEL or have APCs blocked.</span>
02799     <span class="comment">//</span>
02800 
02801     <span class="keywordflow">if</span> (CurrentIrql &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {
02802         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
02803                       0x33,
02804                       CurrentIrql,
02805                       (ULONG_PTR)FastMutex,
02806                       0);
02807     }
02808 
02809     <span class="keywordflow">return</span> ExTryToAcquireFastMutex (FastMutex);
02810 }
02811 
02812 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
02813 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02814 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l02815"></a><a class="code" href="../../d9/d5/verifier_8c.html#a73">02815</a> <a class="code" href="../../d9/d5/verifier_8c.html#a73">VerifierExAcquireFastMutex</a> (
02816     IN <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a> FastMutex
02817     )
02818 {
02819     KIRQL CurrentIrql;
02820 
02821     CurrentIrql = KeGetCurrentIrql ();
02822 
02823     <span class="comment">//</span>
02824     <span class="comment">// Caller better be at or below APC_LEVEL or have APCs blocked.</span>
02825     <span class="comment">//</span>
02826 
02827     <span class="keywordflow">if</span> (CurrentIrql &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {
02828         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
02829                       0x33,
02830                       CurrentIrql,
02831                       (ULONG_PTR)FastMutex,
02832                       0);
02833     }
02834 
02835     ExAcquireFastMutex (FastMutex);
02836 }
02837 
02838 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
02839 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02840 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l02841"></a><a class="code" href="../../d9/d5/verifier_8c.html#a75">02841</a> <a class="code" href="../../d9/d5/verifier_8c.html#a75">VerifierExAcquireFastMutexUnsafe</a> (
02842     IN <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a> FastMutex
02843     )
02844 {
02845     KIRQL CurrentIrql;
02846 
02847     CurrentIrql = KeGetCurrentIrql ();
02848 
02849     <span class="comment">//</span>
02850     <span class="comment">// Caller better be at APC_LEVEL or have APCs blocked.</span>
02851     <span class="comment">//</span>
02852 
02853     <span class="keywordflow">if</span> ((CurrentIrql != <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) &amp;&amp;
02854         (!<a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>())) &amp;&amp;
02855         (<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable == 0)) {
02856 
02857         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
02858                       0x39,
02859                       CurrentIrql,
02860                       (ULONG_PTR)(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable),
02861                       (ULONG_PTR)FastMutex);
02862     }
02863 
02864     <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a> (FastMutex);
02865 }
02866 
02867 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
02868 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02869 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l02870"></a><a class="code" href="../../d9/d5/verifier_8c.html#a74">02870</a> <a class="code" href="../../d9/d5/verifier_8c.html#a74">VerifierExReleaseFastMutex</a> (
02871     IN <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a> FastMutex
02872     )
02873 {
02874     KIRQL CurrentIrql;
02875 
02876     CurrentIrql = KeGetCurrentIrql ();
02877 
02878     <span class="comment">//</span>
02879     <span class="comment">// Caller better be at APC_LEVEL or have APCs blocked.</span>
02880     <span class="comment">//</span>
02881 
02882     <span class="keywordflow">if</span> ((CurrentIrql != <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) &amp;&amp;
02883         (!<a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>())) &amp;&amp;
02884         (<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable == 0)) {
02885 
02886         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
02887                       0x34,
02888                       CurrentIrql,
02889                       (ULONG_PTR)(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable),
02890                       (ULONG_PTR)FastMutex);
02891     }
02892 
02893     ExReleaseFastMutex (FastMutex);
02894 }
02895 
02896 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
02897 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02898 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l02899"></a><a class="code" href="../../d9/d5/verifier_8c.html#a76">02899</a> <a class="code" href="../../d9/d5/verifier_8c.html#a76">VerifierExReleaseFastMutexUnsafe</a> (
02900     IN <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a> FastMutex
02901     )
02902 {
02903     KIRQL CurrentIrql;
02904 
02905     CurrentIrql = KeGetCurrentIrql ();
02906 
02907     <span class="comment">//</span>
02908     <span class="comment">// Caller better be at APC_LEVEL or have APCs blocked.</span>
02909     <span class="comment">//</span>
02910 
02911     <span class="keywordflow">if</span> ((CurrentIrql != <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) &amp;&amp;
02912         (!<a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>())) &amp;&amp;
02913         (<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable == 0)) {
02914 
02915         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
02916                       0x3A,
02917                       CurrentIrql,
02918                       (ULONG_PTR)(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable),
02919                       (ULONG_PTR)FastMutex);
02920     }
02921 
02922     <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a> (FastMutex);
02923 }
02924 
02925 <span class="keyword">typedef</span>
02926 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02927"></a><a class="code" href="../../d9/d5/verifier_8c.html#a46">02927</a> (*PKE_RAISE_IRQL) (
02928     IN KIRQL NewIrql,
02929     OUT PKIRQL OldIrql
02930     );
02931 
02932 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
02933 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02934"></a><a class="code" href="../../d9/d5/verifier_8c.html#a64">02934</a> <a class="code" href="../../d9/d5/verifier_8c.html#a64">VerifierKeRaiseIrql</a> (
02935     IN KIRQL NewIrql,
02936     OUT PKIRQL OldIrql
02937     )
02938 {
02939     <a class="code" href="../../d9/d5/verifier_8c.html#a46">PKE_RAISE_IRQL</a> HalRoutine;
02940 
02941     *OldIrql = KeGetCurrentIrql ();
02942 
02943     <a class="code" href="../../d9/d5/verifier_8c.html#a100">KfSanityCheckRaiseIrql</a> (NewIrql);
02944 
02945     <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.RaiseIrqls += 1;
02946 
02947     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Level &amp; DRIVER_VERIFIER_FORCE_IRQL_CHECKING) {
02948         <span class="keywordflow">if</span> ((*OldIrql &lt; DISPATCH_LEVEL) &amp;&amp; (NewIrql &gt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>)) {
02949             <a class="code" href="../../d9/d5/verifier_8c.html#a94">ViTrimAllSystemPagableMemory</a> ();
02950         }
02951     }
02952 
02953 <span class="preprocessor">#if defined (_X86_)</span>
02954 <span class="preprocessor"></span>    HalRoutine = (<a class="code" href="../../d9/d5/verifier_8c.html#a46">PKE_RAISE_IRQL</a>) (ULONG_PTR) MiKernelVerifierOriginalCalls[VI_KE_RAISE_IRQL];
02955     <span class="keywordflow">if</span> (HalRoutine) {
02956         (*HalRoutine)(NewIrql, OldIrql);
02957         <span class="keywordflow">return</span>;
02958     }
02959 <span class="preprocessor">#endif</span>
02960 <span class="preprocessor"></span>
02961     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (NewIrql, OldIrql);
02962 }
02963 
02964 <span class="keyword">typedef</span>
02965 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02966"></a><a class="code" href="../../d9/d5/verifier_8c.html#a47">02966</a> (*PKE_LOWER_IRQL) (
02967     IN KIRQL NewIrql
02968     );
02969 
02970 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
02971 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02972"></a><a class="code" href="../../d9/d5/verifier_8c.html#a65">02972</a> <a class="code" href="../../d9/d5/verifier_8c.html#a65">VerifierKeLowerIrql</a> (
02973     IN KIRQL NewIrql
02974     )
02975 {
02976     <a class="code" href="../../d9/d5/verifier_8c.html#a47">PKE_LOWER_IRQL</a> HalRoutine;
02977 
02978     <a class="code" href="../../d9/d5/verifier_8c.html#a101">KfSanityCheckLowerIrql</a> (NewIrql);
02979 
02980 <span class="preprocessor">#if defined (_X86_)</span>
02981 <span class="preprocessor"></span>    HalRoutine = (<a class="code" href="../../d9/d5/verifier_8c.html#a47">PKE_LOWER_IRQL</a>) (ULONG_PTR) MiKernelVerifierOriginalCalls[VI_KE_LOWER_IRQL];
02982     <span class="keywordflow">if</span> (HalRoutine) {
02983         (*HalRoutine)(NewIrql);
02984         <span class="keywordflow">return</span>;
02985     }
02986 <span class="preprocessor">#endif</span>
02987 <span class="preprocessor"></span>
02988     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (NewIrql);
02989 }
02990 
02991 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
02992 BOOLEAN
<a name="l02993"></a><a class="code" href="../../d9/d5/verifier_8c.html#a81">02993</a> <a class="code" href="../../d9/d5/verifier_8c.html#a81">VerifierSynchronizeExecution</a> (
02994     IN <a class="code" href="../../d0/d7/struct__KINTERRUPT.html">PKINTERRUPT</a> Interrupt,
02995     IN PKSYNCHRONIZE_ROUTINE SynchronizeRoutine,
02996     IN PVOID SynchronizeContext
02997     )
02998 {
02999     KIRQL OldIrql;
03000 
03001     OldIrql = KeGetCurrentIrql ();
03002 
03003     <a class="code" href="../../d9/d5/verifier_8c.html#a100">KfSanityCheckRaiseIrql</a> (Interrupt-&gt;SynchronizeIrql);
03004 
03005     <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.SynchronizeExecutions += 1;
03006 
03007     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Level &amp; DRIVER_VERIFIER_FORCE_IRQL_CHECKING) {
03008         <span class="keywordflow">if</span> ((OldIrql &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) &amp;&amp; (Interrupt-&gt;SynchronizeIrql &gt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>)) {
03009             <a class="code" href="../../d9/d5/verifier_8c.html#a94">ViTrimAllSystemPagableMemory</a> ();
03010         }
03011     }
03012 
03013     <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/ke_8h.html#a273">KeSynchronizeExecution</a> (Interrupt,
03014                                    SynchronizeRoutine,
03015                                    SynchronizeContext);
03016 }
03017 
03018 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
03019 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03020"></a><a class="code" href="../../d9/d5/verifier_8c.html#a70">03020</a> <a class="code" href="../../d9/d5/verifier_8c.html#a70">VerifierKeInitializeTimerEx</a>(
03021     IN <a class="code" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer,
03022     IN TIMER_TYPE Type
03023     )
03024 {
03025     <span class="comment">//</span>
03026     <span class="comment">// Check the object being initialized isn't already an</span>
03027     <span class="comment">// active timer.  Make sure the timer table list is initialized.</span>
03028     <span class="comment">//</span>
03029 
03030     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9/kernldat_8c.html#a3">KiTimerTableListHead</a>[0].Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03031         <a class="code" href="../../d3/d2/timerobj_8c.html#a9">KeCheckForTimer</a>(Timer, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__KTIMER.html">KTIMER</a>));
03032     }
03033 
03034     <a class="code" href="../../d3/d2/timerobj_8c.html#a2">KeInitializeTimerEx</a>(Timer, Type);
03035 }
03036 
03037 <a class="code" href="../../d9/d5/verifier_8c.html#a0">THUNKED_API</a>
03038 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03039"></a><a class="code" href="../../d9/d5/verifier_8c.html#a71">03039</a> <a class="code" href="../../d9/d5/verifier_8c.html#a71">VerifierKeInitializeTimer</a>(
03040     IN <a class="code" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer
03041     )
03042 {
03043     <a class="code" href="../../d9/d5/verifier_8c.html#a70">VerifierKeInitializeTimerEx</a>(Timer, NotificationTimer);
03044 }
03045 
03046 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03047"></a><a class="code" href="../../d9/d5/verifier_8c.html#a95">03047</a> <a class="code" href="../../d9/d5/verifier_8c.html#a95">ViInitializeEntry</a> (
03048     IN <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> Verifier,
03049     IN LOGICAL FirstLoad
03050     )
03051 
03052 <span class="comment">/*++</span>
03053 <span class="comment"></span>
03054 <span class="comment">Routine Description:</span>
03055 <span class="comment"></span>
03056 <span class="comment">    Initialize various verifier fields as the driver is being (re)loaded now.</span>
03057 <span class="comment"></span>
03058 <span class="comment">Arguments:</span>
03059 <span class="comment"></span>
03060 <span class="comment">    Verifier - Supplies the verifier entry to be initialized.</span>
03061 <span class="comment"></span>
03062 <span class="comment">    FirstLoad - Supplies TRUE if this is the first load of this driver.</span>
03063 <span class="comment"></span>
03064 <span class="comment">Return Value:</span>
03065 <span class="comment"></span>
03066 <span class="comment">    None.</span>
03067 <span class="comment"></span>
03068 <span class="comment">--*/</span>
03069 
03070 {
03071     KIRQL OldIrql;
03072 
03073     <span class="comment">//</span>
03074     <span class="comment">// Only the BaseName field is initialized on entry.</span>
03075     <span class="comment">//</span>
03076 
03077     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;Verifier-&gt;VerifierPoolLock);
03078 
03079     Verifier-&gt;CurrentPagedPoolAllocations = 0;
03080     Verifier-&gt;CurrentNonPagedPoolAllocations = 0;
03081     Verifier-&gt;PeakPagedPoolAllocations = 0;
03082     Verifier-&gt;PeakNonPagedPoolAllocations = 0;
03083 
03084     Verifier-&gt;PagedBytes = 0;
03085     Verifier-&gt;NonPagedBytes = 0;
03086     Verifier-&gt;PeakPagedBytes = 0;
03087     Verifier-&gt;PeakNonPagedBytes = 0;
03088 
03089     Verifier-&gt;PoolHash = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03090     Verifier-&gt;PoolHashSize = 0;
03091     Verifier-&gt;PoolHashFree = <a class="code" href="../../d4/d8/mi_8h.html#a250">VI_POOL_FREELIST_END</a>;
03092     Verifier-&gt;PoolHashReserved = 0;
03093 
03094     Verifier-&gt;Signature = <a class="code" href="../../d4/d8/mi_8h.html#a251">MI_VERIFIER_ENTRY_SIGNATURE</a>;
03095 
03096     <span class="keywordflow">if</span> (FirstLoad == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03097         Verifier-&gt;Flags = 0;
03098         Verifier-&gt;Loads = 0;
03099         Verifier-&gt;Unloads = 0;
03100     }
03101 
03102     ExAcquireSpinLock (&amp;<a class="code" href="../../d9/d5/verifier_8c.html#a29">VerifierListLock</a>, &amp;OldIrql);
03103     Verifier-&gt;StartAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03104     Verifier-&gt;EndAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03105     ExReleaseSpinLock (&amp;<a class="code" href="../../d9/d5/verifier_8c.html#a29">VerifierListLock</a>, OldIrql);
03106 }
03107 
<a name="l03108"></a><a class="code" href="../../d9/d5/verifier_8c.html#a3">03108</a> <span class="preprocessor">#define UNICODE_TAB               0x0009</span>
<a name="l03109"></a><a class="code" href="../../d9/d5/verifier_8c.html#a4">03109</a> <span class="preprocessor"></span><span class="preprocessor">#define UNICODE_LF                0x000A</span>
<a name="l03110"></a><a class="code" href="../../d9/d5/verifier_8c.html#a5">03110</a> <span class="preprocessor"></span><span class="preprocessor">#define UNICODE_CR                0x000D</span>
<a name="l03111"></a><a class="code" href="../../d9/d5/verifier_8c.html#a6">03111</a> <span class="preprocessor"></span><span class="preprocessor">#define UNICODE_SPACE             0x0020</span>
<a name="l03112"></a><a class="code" href="../../d9/d5/verifier_8c.html#a7">03112</a> <span class="preprocessor"></span><span class="preprocessor">#define UNICODE_CJK_SPACE         0x3000</span>
03113 <span class="preprocessor"></span>
<a name="l03114"></a><a class="code" href="../../d9/d5/verifier_8c.html#a8">03114</a> <span class="preprocessor">#define UNICODE_WHITESPACE(_ch)     (((_ch) == UNICODE_TAB) || \</span>
03115 <span class="preprocessor">                                     ((_ch) == UNICODE_LF) || \</span>
03116 <span class="preprocessor">                                     ((_ch) == UNICODE_CR) || \</span>
03117 <span class="preprocessor">                                     ((_ch) == UNICODE_SPACE) || \</span>
03118 <span class="preprocessor">                                     ((_ch) == UNICODE_CJK_SPACE))</span>
03119 <span class="preprocessor"></span>
03120 LOGICAL
<a name="l03121"></a><a class="code" href="../../d9/d5/verifier_8c.html#a109">03121</a> <a class="code" href="../../d9/d5/verifier_8c.html#a109">MiInitializeDriverVerifierList</a> (
03122     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
03123     )
03124 
03125 <span class="comment">/*++</span>
03126 <span class="comment"></span>
03127 <span class="comment">Routine Description:</span>
03128 <span class="comment"></span>
03129 <span class="comment">    Parse the registry setting and set up the list of driver names that will</span>
03130 <span class="comment">    be put through the validation process.</span>
03131 <span class="comment"></span>
03132 <span class="comment">    Walk the loaded module list and thunk any drivers that need/deserve it.</span>
03133 <span class="comment"></span>
03134 <span class="comment">Arguments:</span>
03135 <span class="comment"></span>
03136 <span class="comment">    None.</span>
03137 <span class="comment"></span>
03138 <span class="comment">Return Value:</span>
03139 <span class="comment"></span>
03140 <span class="comment">    TRUE if successful, FALSE if not.</span>
03141 <span class="comment"></span>
03142 <span class="comment">Environment:</span>
03143 <span class="comment"></span>
03144 <span class="comment">    Kernel mode, Phase 0 Initialization.</span>
03145 <span class="comment"></span>
03146 <span class="comment">    Nonpaged (but not paged) pool exists.</span>
03147 <span class="comment"></span>
03148 <span class="comment">    The PsLoadedModuleList has not been set up yet although the boot drivers</span>
03149 <span class="comment">    have been relocated to their final resting places.</span>
03150 <span class="comment"></span>
03151 <span class="comment">--*/</span>
03152 
03153 {
03154     ULONG i;
03155     PLIST_ENTRY NextEntry;
03156     PLDR_DATA_TABLE_ENTRY DataTableEntry;
03157     PWCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
03158     PWCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
03159     PWCHAR Walk;
03160     ULONG NameLength;
03161     <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> Verifier;
03162     LARGE_INTEGER CurrentTime;
03163     UNICODE_STRING KernelString;
03164     UNICODE_STRING HalString;
03165     <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> KernelEntry;
03166     <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> HalEntry;
03167 
03168     InitializeListHead (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a555">MiSuspectDriverList</a>);
03169 
03170     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a12">MmVerifyDriverLevel</a> != (ULONG)-1) {
03171         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a12">MmVerifyDriverLevel</a> &amp; DRIVER_VERIFIER_IO_CHECKING) {
03172             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a10">MmVerifyDriverBufferLength</a> == (ULONG)-1) {
03173                 <a class="code" href="../../d8/d0/cmdat3_8c.html#a10">MmVerifyDriverBufferLength</a> = 0;     <span class="comment">// Mm will not page out verifier pages.</span>
03174             }
03175         }
03176     }
03177 
03178     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a10">MmVerifyDriverBufferLength</a> == (ULONG)-1) {
03179 
03180         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a13">MmDontVerifyRandomDrivers</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03181             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03182         }
03183 
03184         <a class="code" href="../../d8/d0/cmdat3_8c.html#a10">MmVerifyDriverBufferLength</a> = 0;
03185 
03186         CurrentTime = <a class="code" href="../../d2/d7/hal_8h.html#a205">KeQueryPerformanceCounter</a> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03187         CurrentTime.LowPart = (CurrentTime.LowPart % 26);
03188 
03189         <a class="code" href="../../d9/d5/verifier_8c.html#a20">MiVerifyRandomDrivers</a> = (WCHAR)<span class="charliteral">'A'</span> + (WCHAR)CurrentTime.LowPart;
03190 
03191         <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d5/verifier_8c.html#a20">MiVerifyRandomDrivers</a> == (WCHAR)<span class="charliteral">'H'</span>) ||
03192             (<a class="code" href="../../d9/d5/verifier_8c.html#a20">MiVerifyRandomDrivers</a> == (WCHAR)<span class="charliteral">'J'</span>) ||
03193             (<a class="code" href="../../d9/d5/verifier_8c.html#a20">MiVerifyRandomDrivers</a> == (WCHAR)<span class="charliteral">'X'</span>) ||
03194             (<a class="code" href="../../d9/d5/verifier_8c.html#a20">MiVerifyRandomDrivers</a> == (WCHAR)<span class="charliteral">'Y'</span>) ||
03195             (<a class="code" href="../../d9/d5/verifier_8c.html#a20">MiVerifyRandomDrivers</a> == (WCHAR)<span class="charliteral">'Z'</span>)) {
03196                 <a class="code" href="../../d9/d5/verifier_8c.html#a20">MiVerifyRandomDrivers</a> = (WCHAR)<span class="charliteral">'X'</span>;
03197         }
03198     }
03199 
03200     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;<a class="code" href="../../d9/d5/verifier_8c.html#a41">ViBadMapperLock</a>);
03201     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;<a class="code" href="../../d9/d5/verifier_8c.html#a29">VerifierListLock</a>);
03202 
03203     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;<a class="code" href="../../d9/d5/verifier_8c.html#a30">VerifierPoolLock</a>);
03204     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a> (&amp;<a class="code" href="../../d9/d5/verifier_8c.html#a31">VerifierPoolMutex</a>);
03205 
03206     InitializeListHead (&amp;<a class="code" href="../../d9/d5/verifier_8c.html#a33">MiVerifierDriverAddedThunkListHead</a>);
03207 
03208     <span class="comment">//</span>
03209     <span class="comment">// If no default is specified, then special pool, pagable code/data</span>
03210     <span class="comment">// flushing and pool leak detection are enabled.</span>
03211     <span class="comment">//</span>
03212 
03213     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a12">MmVerifyDriverLevel</a> == (ULONG)-1) {
03214         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Level = DRIVER_VERIFIER_SPECIAL_POOLING |
03215                                DRIVER_VERIFIER_FORCE_IRQL_CHECKING |
03216                                DRIVER_VERIFIER_TRACK_POOL_ALLOCATIONS;
03217     }
03218     <span class="keywordflow">else</span> {
03219         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Level = <a class="code" href="../../d8/d0/cmdat3_8c.html#a12">MmVerifyDriverLevel</a>;
03220     }
03221 
03222     <a class="code" href="../../d9/d5/verifier_8c.html#a16">VerifierModifyableOptions</a> = (DRIVER_VERIFIER_SPECIAL_POOLING |
03223                                  DRIVER_VERIFIER_FORCE_IRQL_CHECKING |
03224                                  DRIVER_VERIFIER_INJECT_ALLOCATION_FAILURES);
03225 
03226     <a class="code" href="../../d6/d6/ioverifier_8c.html#a26">IoVerifierInit</a> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Level, <a class="code" href="../../d0/d5/io_8h.html#a260">IOVERIFIERINIT_PHASE0</a> |
03227                                           <a class="code" href="../../d0/d5/io_8h.html#a261">IOVERIFIERINIT_EVERYTHING_TRACKED</a> |
03228                                           <a class="code" href="../../d0/d5/io_8h.html#a264">IOVERIFIERINIT_VERIFIER_DRIVER_LIST</a>);
03229 
03230     KernelEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03231     HalEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03232 
03233     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a20">MiVerifyRandomDrivers</a> == (WCHAR)0) {
03234 
03235         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;KernelString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ntoskrnl.exe"</span>);
03236         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;HalString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"hal.dll"</span>);
03237 
03238         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> = <a class="code" href="../../d8/d0/cmdat3_8c.html#a9">MmVerifyDriverBuffer</a>;
03239         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = <a class="code" href="../../d8/d0/cmdat3_8c.html#a9">MmVerifyDriverBuffer</a> + (<a class="code" href="../../d8/d0/cmdat3_8c.html#a10">MmVerifyDriverBufferLength</a> - <span class="keyword">sizeof</span>(WCHAR)) / <span class="keyword">sizeof</span>(WCHAR);
03240 
03241         <span class="keywordflow">while</span> (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> &lt; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>) {
03242             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a8">UNICODE_WHITESPACE</a>(*<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>)) {
03243                 <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> += 1;
03244                 <span class="keywordflow">continue</span>;
03245             }
03246 
03247             <span class="keywordflow">if</span> (*<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> == (WCHAR)<span class="charliteral">'*'</span>) {
03248                 <a class="code" href="../../d9/d5/verifier_8c.html#a19">MiVerifyAllDrivers</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03249                 <span class="keywordflow">break</span>;
03250             }
03251 
03252             <span class="keywordflow">for</span> (Walk = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>; Walk &lt; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>; Walk += 1) {
03253                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a8">UNICODE_WHITESPACE</a>(*Walk)) {
03254                     <span class="keywordflow">break</span>;
03255                 }
03256             }
03257 
03258             <span class="comment">//</span>
03259             <span class="comment">// Got a string.  Save it.</span>
03260             <span class="comment">//</span>
03261 
03262             NameLength = (ULONG)(Walk - <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> + 1) * <span class="keyword">sizeof</span> (WCHAR);
03263 
03264             Verifier = (<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
03265                                         <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
03266                                         <span class="keyword">sizeof</span> (<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">MI_VERIFIER_DRIVER_ENTRY</a>) +
03267                                                             NameLength,
03268                                         'dLmM');
03269 
03270             <span class="keywordflow">if</span> (Verifier == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03271                 <span class="keywordflow">break</span>;
03272             }
03273 
03274             Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o3">BaseName</a>.Buffer = (PWSTR)((PCHAR)Verifier +
03275                                                 <span class="keyword">sizeof</span> (<a class="code" href="../../d4/d8/mi_8h.html#a548">MI_VERIFIER_DRIVER_ENTRY</a>));
03276             Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o3">BaseName</a>.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)NameLength - <span class="keyword">sizeof</span> (UNICODE_NULL);
03277             Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o3">BaseName</a>.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)NameLength;
03278 
03279             RtlMoveMemory (Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o3">BaseName</a>.Buffer,
03280                            <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>,
03281                            NameLength - sizeof (UNICODE_NULL));
03282 
03283             <a class="code" href="../../d9/d5/verifier_8c.html#a95">ViInitializeEntry</a> (Verifier, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03284 
03285             Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o6">Flags</a> |= <a class="code" href="../../d4/d8/mi_8h.html#a252">VI_VERIFYING_DIRECTLY</a>;
03286 
03287             <a class="code" href="../../d9/d5/verifier_8c.html#a103">ViInsertVerifierEntry</a> (Verifier);
03288 
03289             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a> (&amp;KernelString,
03290                                        &amp;Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o3">BaseName</a>,
03291                                        <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03292 
03293                 <span class="comment">//</span>
03294                 <span class="comment">// All driver pool allocation calls must be intercepted so</span>
03295                 <span class="comment">// they are not mistaken for kernel pool allocations.</span>
03296                 <span class="comment">//</span>
03297 
03298                 <a class="code" href="../../d9/d5/verifier_8c.html#a19">MiVerifyAllDrivers</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03299 
03300                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a61">KernelVerifier</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03301                 KernelEntry = Verifier;
03302 
03303             }
03304             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a> (&amp;HalString,
03305                                             &amp;Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o3">BaseName</a>,
03306                                             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03307                 HalEntry = Verifier;
03308             }
03309 
03310             <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> = Walk + 1;
03311         }
03312     }
03313 
03314     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a958">MiTriageAddDrivers</a> (LoaderBlock) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03315 
03316         <span class="comment">//</span>
03317         <span class="comment">// Disable random driver verification if triage has picked driver(s).</span>
03318         <span class="comment">//</span>
03319 
03320         <a class="code" href="../../d9/d5/verifier_8c.html#a20">MiVerifyRandomDrivers</a> = (WCHAR)0;
03321     }
03322 
03323     <span class="comment">//</span>
03324     <span class="comment">// Process the boot-loaded drivers now.</span>
03325     <span class="comment">//</span>
03326 
03327     i = 0;
03328     NextEntry = LoaderBlock-&gt;LoadOrderListHead.Flink;
03329 
03330     <span class="keywordflow">for</span> ( ; NextEntry != &amp;LoaderBlock-&gt;LoadOrderListHead; NextEntry = NextEntry-&gt;Flink) {
03331 
03332         DataTableEntry = CONTAINING_RECORD(NextEntry,
03333                                            LDR_DATA_TABLE_ENTRY,
03334                                            InLoadOrderLinks);
03335 
03336         <span class="comment">//</span>
03337         <span class="comment">// Process the kernel and HAL specially.</span>
03338         <span class="comment">//</span>
03339 
03340         <span class="keywordflow">if</span> (i == 0) {
03341             <span class="keywordflow">if</span> (KernelEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03342                 <a class="code" href="../../d9/d5/verifier_8c.html#a110">MiApplyDriverVerifier</a> (DataTableEntry, KernelEntry);
03343             }
03344         }
03345         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i == 1) {
03346             <span class="keywordflow">if</span> (HalEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03347                 <a class="code" href="../../d9/d5/verifier_8c.html#a110">MiApplyDriverVerifier</a> (DataTableEntry, HalEntry);
03348             }
03349         }
03350         <span class="keywordflow">else</span> {
03351             <a class="code" href="../../d9/d5/verifier_8c.html#a110">MiApplyDriverVerifier</a> (DataTableEntry, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03352         }
03353         i += 1;
03354     }
03355 
03356     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03357 }
03358 
03359 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03360"></a><a class="code" href="../../d9/d5/verifier_8c.html#a103">03360</a> <a class="code" href="../../d9/d5/verifier_8c.html#a103">ViInsertVerifierEntry</a> (
03361     IN <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> Verifier
03362     )
03363 
03364 <span class="comment">/*++</span>
03365 <span class="comment"></span>
03366 <span class="comment">Routine Description:</span>
03367 <span class="comment"></span>
03368 <span class="comment">    Nonpagable wrapper to insert a new verifier entry.</span>
03369 <span class="comment"></span>
03370 <span class="comment">    Note that the system load mutant or the verifier load spinlock is sufficient</span>
03371 <span class="comment">    for readers to access the list.  This is because the insertion path</span>
03372 <span class="comment">    acquires both.</span>
03373 <span class="comment"></span>
03374 <span class="comment">    Lock synchronization is needed because pool allocators walk the</span>
03375 <span class="comment">    verifier list at DISPATCH_LEVEL.</span>
03376 <span class="comment"></span>
03377 <span class="comment">Arguments:</span>
03378 <span class="comment"></span>
03379 <span class="comment">    Verifier - Supplies a caller-initialized entry for the driver.</span>
03380 <span class="comment"></span>
03381 <span class="comment">Return Value:</span>
03382 <span class="comment"></span>
03383 <span class="comment">    None.</span>
03384 <span class="comment"></span>
03385 <span class="comment">--*/</span>
03386 
03387 {
03388     KIRQL OldIrql;
03389 
03390     ExAcquireSpinLock (&amp;<a class="code" href="../../d9/d5/verifier_8c.html#a29">VerifierListLock</a>, &amp;OldIrql);
03391     InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a555">MiSuspectDriverList</a>, &amp;Verifier-&gt;Links);
03392     ExReleaseSpinLock (&amp;<a class="code" href="../../d9/d5/verifier_8c.html#a29">VerifierListLock</a>, OldIrql);
03393 }
03394 
03395 <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a>
<a name="l03396"></a><a class="code" href="../../d9/d5/verifier_8c.html#a105">03396</a> <a class="code" href="../../d9/d5/verifier_8c.html#a105">ViLocateVerifierEntry</a> (
03397     IN PVOID SystemAddress
03398     )
03399 
03400 <span class="comment">/*++</span>
03401 <span class="comment"></span>
03402 <span class="comment">Routine Description:</span>
03403 <span class="comment"></span>
03404 <span class="comment">    Locate the Driver Verifier entry for the specified system address.</span>
03405 <span class="comment"></span>
03406 <span class="comment">Arguments:</span>
03407 <span class="comment"></span>
03408 <span class="comment">    SystemAddress - Supplies a code or data address within a driver.</span>
03409 <span class="comment"></span>
03410 <span class="comment">Return Value:</span>
03411 <span class="comment"></span>
03412 <span class="comment">    The Verifier entry corresponding to the driver or NULL.</span>
03413 <span class="comment"></span>
03414 <span class="comment">Environment:</span>
03415 <span class="comment"></span>
03416 <span class="comment">    The caller may be at DISPATCH_LEVEL and does not hold the MmSystemLoadLock.</span>
03417 <span class="comment"></span>
03418 <span class="comment">--*/</span>
03419 
03420 {
03421     KIRQL OldIrql;
03422     PLIST_ENTRY NextEntry;
03423     <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> Verifier;
03424 
03425     ExAcquireSpinLock (&amp;<a class="code" href="../../d9/d5/verifier_8c.html#a29">VerifierListLock</a>, &amp;OldIrql);
03426 
03427     NextEntry = <a class="code" href="../../d4/d8/mi_8h.html#a555">MiSuspectDriverList</a>.Flink;
03428     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d4/d8/mi_8h.html#a555">MiSuspectDriverList</a>) {
03429 
03430         Verifier = CONTAINING_RECORD(NextEntry,
03431                                      <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">MI_VERIFIER_DRIVER_ENTRY</a>,
03432                                      Links);
03433 
03434         <span class="keywordflow">if</span> ((SystemAddress &gt;= Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o4">StartAddress</a>) &amp;&amp;
03435             (SystemAddress &lt; Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o5">EndAddress</a>)) {
03436 
03437             ExReleaseSpinLock (&amp;<a class="code" href="../../d9/d5/verifier_8c.html#a29">VerifierListLock</a>, OldIrql);
03438             <span class="keywordflow">return</span> Verifier;
03439         }
03440         NextEntry = NextEntry-&gt;Flink;
03441     }
03442 
03443     ExReleaseSpinLock (&amp;<a class="code" href="../../d9/d5/verifier_8c.html#a29">VerifierListLock</a>, OldIrql);
03444     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03445 }
03446 
03447 LOGICAL
<a name="l03448"></a><a class="code" href="../../d9/d5/verifier_8c.html#a110">03448</a> <a class="code" href="../../d9/d5/verifier_8c.html#a110">MiApplyDriverVerifier</a> (
03449     IN PLDR_DATA_TABLE_ENTRY DataTableEntry,
03450     IN <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> Verifier
03451     )
03452 
03453 <span class="comment">/*++</span>
03454 <span class="comment"></span>
03455 <span class="comment">Routine Description:</span>
03456 <span class="comment"></span>
03457 <span class="comment">    This function is called as each module is loaded.  If the module being</span>
03458 <span class="comment">    loaded is in the suspect list, thunk it here.</span>
03459 <span class="comment"></span>
03460 <span class="comment">Arguments:</span>
03461 <span class="comment"></span>
03462 <span class="comment">    DataTableEntry - Supplies the data table entry for the module.</span>
03463 <span class="comment"></span>
03464 <span class="comment">    Verifier - Non-NULL if verification must be applied.  FALSE indicates</span>
03465 <span class="comment">                      that the driver name must match for verification to be</span>
03466 <span class="comment">                      applied.</span>
03467 <span class="comment"></span>
03468 <span class="comment">Return Value:</span>
03469 <span class="comment"></span>
03470 <span class="comment">    TRUE if thunking was applied, FALSE if not.</span>
03471 <span class="comment"></span>
03472 <span class="comment">Environment:</span>
03473 <span class="comment"></span>
03474 <span class="comment">    Kernel mode, Phase 0 Initialization and normal runtime.</span>
03475 <span class="comment">    Non paged pool exists in Phase0, but paged pool does not.</span>
03476 <span class="comment">    Post-Phase0 serialization is provided by the MmSystemLoadLock.</span>
03477 <span class="comment"></span>
03478 <span class="comment">--*/</span>
03479 
03480 {
03481     WCHAR FirstChar;
03482     LOGICAL Found;
03483     PLIST_ENTRY NextEntry;
03484     ULONG VerifierFlags;
03485 
03486     <span class="keywordflow">if</span> (Verifier != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03487         Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03488     }
03489     <span class="keywordflow">else</span> {
03490         Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03491         NextEntry = <a class="code" href="../../d4/d8/mi_8h.html#a555">MiSuspectDriverList</a>.Flink;
03492         <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d4/d8/mi_8h.html#a555">MiSuspectDriverList</a>) {
03493 
03494             Verifier = CONTAINING_RECORD(NextEntry,
03495                                          <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">MI_VERIFIER_DRIVER_ENTRY</a>,
03496                                          Links);
03497 
03498             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a> (&amp;Verifier-&gt;BaseName,
03499                                        &amp;DataTableEntry-&gt;BaseDllName,
03500                                        <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03501 
03502                 Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03503                 <a class="code" href="../../d9/d5/verifier_8c.html#a95">ViInitializeEntry</a> (Verifier, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03504                 <span class="keywordflow">break</span>;
03505             }
03506             NextEntry = NextEntry-&gt;Flink;
03507         }
03508     }
03509 
03510     <span class="keywordflow">if</span> (Found == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03511         VerifierFlags = <a class="code" href="../../d4/d8/mi_8h.html#a252">VI_VERIFYING_DIRECTLY</a>;
03512         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a19">MiVerifyAllDrivers</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03513             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a61">KernelVerifier</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03514                 VerifierFlags = <a class="code" href="../../d4/d8/mi_8h.html#a253">VI_VERIFYING_INVERSELY</a>;
03515             }
03516             Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03517         }
03518         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a20">MiVerifyRandomDrivers</a> != (WCHAR)0) {
03519 
03520             <span class="comment">//</span>
03521             <span class="comment">// Wildcard match drivers randomly.</span>
03522             <span class="comment">//</span>
03523 
03524             FirstChar = <a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(DataTableEntry-&gt;BaseDllName.Buffer[0]);
03525 
03526             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a20">MiVerifyRandomDrivers</a> == FirstChar) {
03527                 Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03528             }
03529             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a20">MiVerifyRandomDrivers</a> == (WCHAR)<span class="charliteral">'X'</span>) {
03530                 <span class="keywordflow">if</span> ((FirstChar &gt;= (WCHAR)<span class="charliteral">'0'</span>) &amp;&amp; (FirstChar &lt;= (WCHAR)<span class="charliteral">'9'</span>)) {
03531                     Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03532                 }
03533             }
03534         }
03535 
03536         <span class="keywordflow">if</span> (Found == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03537             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03538         }
03539 
03540         Verifier = (<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
03541                                     <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
03542                                     <span class="keyword">sizeof</span> (<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">MI_VERIFIER_DRIVER_ENTRY</a>) +
03543                                         DataTableEntry-&gt;BaseDllName.MaximumLength,
03544                                     'dLmM');
03545 
03546         <span class="keywordflow">if</span> (Verifier == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03547             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03548         }
03549 
03550         Verifier-&gt;BaseName.Buffer = (PWSTR)((PCHAR)Verifier +
03551                                         <span class="keyword">sizeof</span> (<a class="code" href="../../d4/d8/mi_8h.html#a548">MI_VERIFIER_DRIVER_ENTRY</a>));
03552         Verifier-&gt;BaseName.Length = DataTableEntry-&gt;BaseDllName.Length;
03553         Verifier-&gt;BaseName.MaximumLength = DataTableEntry-&gt;BaseDllName.MaximumLength;
03554 
03555         RtlMoveMemory (Verifier-&gt;BaseName.Buffer,
03556                        DataTableEntry-&gt;BaseDllName.Buffer,
03557                        DataTableEntry-&gt;BaseDllName.Length);
03558 
03559         <a class="code" href="../../d9/d5/verifier_8c.html#a95">ViInitializeEntry</a> (Verifier, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03560 
03561         Verifier-&gt;Flags = VerifierFlags;
03562 
03563         <a class="code" href="../../d9/d5/verifier_8c.html#a103">ViInsertVerifierEntry</a> (Verifier);
03564     }
03565 
03566     Verifier-&gt;StartAddress = DataTableEntry-&gt;DllBase;
03567     Verifier-&gt;EndAddress = (PVOID)((ULONG_PTR)DataTableEntry-&gt;DllBase + DataTableEntry-&gt;SizeOfImage);
03568 
03569     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a102">MiEnableVerifier</a> (DataTableEntry) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03570 
03571         <span class="keywordflow">if</span> (Verifier-&gt;Flags &amp; <a class="code" href="../../d4/d8/mi_8h.html#a252">VI_VERIFYING_DIRECTLY</a>) {
03572             <a class="code" href="../../d9/d5/verifier_8c.html#a92">ViPrintString</a> (&amp;DataTableEntry-&gt;BaseDllName);
03573         }
03574 
03575         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Loads += 1;
03576 
03577         Verifier-&gt;Loads += 1;
03578 
03579         DataTableEntry-&gt;Flags |= LDRP_IMAGE_VERIFYING;
03580         <a class="code" href="../../d9/d5/verifier_8c.html#a21">MiActiveVerifies</a> += 1;
03581 
03582         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a21">MiActiveVerifies</a> == 1) {
03583 
03584             <span class="comment">//</span>
03585             <span class="comment">// Up the retry mechanism for potential injection failures.</span>
03586             <span class="comment">//</span>
03587 
03588             <a class="code" href="../../d4/d8/mi_8h.html#a428">MiIoRetryLevel</a> = (ULONG)-1;
03589             <a class="code" href="../../d4/d8/mi_8h.html#a429">MiFaultRetries</a> = <a class="code" href="../../d4/d8/mi_8h.html#a428">MiIoRetryLevel</a>;
03590             <a class="code" href="../../d4/d8/mi_8h.html#a430">MiUserIoRetryLevel</a> = (ULONG)-1;
03591             <a class="code" href="../../d4/d8/mi_8h.html#a431">MiUserFaultRetries</a> = <a class="code" href="../../d4/d8/mi_8h.html#a430">MiUserIoRetryLevel</a>;
03592 
03593 <span class="preprocessor">#ifndef NO_POOL_CHECKS</span>
03594 <span class="preprocessor"></span>
03595             <span class="comment">//</span>
03596             <span class="comment">// If a loaded driver(s) is undergoing validation, the default</span>
03597             <span class="comment">// special pool randomizer is disabled as the precious virtual</span>
03598             <span class="comment">// address space and physical memory is being put to specific</span>
03599             <span class="comment">// use.</span>
03600             <span class="comment">//</span>
03601 
03602             <a class="code" href="../../d4/d8/mi_8h.html#a956">MiEnableRandomSpecialPool</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03603 <span class="preprocessor">#endif</span>
03604 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Level &amp; DRIVER_VERIFIER_FORCE_IRQL_CHECKING) {
03605 
03606                 <span class="comment">//</span>
03607                 <span class="comment">// Page out all thread stacks as soon as possible to</span>
03608                 <span class="comment">// catch drivers using local events that do usermode waits.</span>
03609                 <span class="comment">//</span>
03610 
03611                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a61">KernelVerifier</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03612                     <a class="code" href="../../d9/d5/verifier_8c.html#a24">MiVerifierStackProtectTime</a> = <a class="code" href="../../d4/d9/ke_8h.html#a140">KiStackProtectTime</a>;
03613                     <a class="code" href="../../d4/d9/ke_8h.html#a140">KiStackProtectTime</a> = 0;
03614                 }
03615             }
03616         }
03617     }
03618 
03619     <span class="keywordflow">return</span> Found;
03620 }
03621 
<a name="l03622"></a><a class="code" href="../../d9/d5/verifier_8c.html#a48">03622</a> PUNICODE_STRING <a class="code" href="../../d9/d5/verifier_8c.html#a48">ViBadDriver</a>;
03623 
03624 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03625"></a><a class="code" href="../../d9/d5/verifier_8c.html#a111">03625</a> <a class="code" href="../../d9/d5/verifier_8c.html#a111">MiVerifyingDriverUnloading</a> (
03626     IN PLDR_DATA_TABLE_ENTRY DataTableEntry
03627     )
03628 
03629 <span class="comment">/*++</span>
03630 <span class="comment"></span>
03631 <span class="comment">Routine Description:</span>
03632 <span class="comment"></span>
03633 <span class="comment">    This function is called as a driver that was being verified is now being</span>
03634 <span class="comment">    unloaded.</span>
03635 <span class="comment"></span>
03636 <span class="comment">Arguments:</span>
03637 <span class="comment"></span>
03638 <span class="comment">    DataTableEntry - Supplies the data table entry for the driver.</span>
03639 <span class="comment"></span>
03640 <span class="comment">Return Value:</span>
03641 <span class="comment"></span>
03642 <span class="comment">    TRUE if thunking was applied, FALSE if not.</span>
03643 <span class="comment"></span>
03644 <span class="comment">Environment:</span>
03645 <span class="comment"></span>
03646 <span class="comment">    Kernel mode, Phase 0 Initialization and normal runtime.</span>
03647 <span class="comment">    Non paged pool exists in Phase0, but paged pool does not.</span>
03648 <span class="comment">    Post-Phase0 serialization is provided by the MmSystemLoadLock.</span>
03649 <span class="comment"></span>
03650 <span class="comment">--*/</span>
03651 
03652 {
03653     KIRQL OldIrql;
03654     LOGICAL Found;
03655     PLIST_ENTRY NextEntry;
03656     <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> Verifier;
03657     <a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html">PVI_POOL_ENTRY</a> OldHashTable;
03658 
03659     Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03660     NextEntry = <a class="code" href="../../d4/d8/mi_8h.html#a555">MiSuspectDriverList</a>.Flink;
03661     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d4/d8/mi_8h.html#a555">MiSuspectDriverList</a>) {
03662 
03663         Verifier = CONTAINING_RECORD(NextEntry,
03664                                           <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">MI_VERIFIER_DRIVER_ENTRY</a>,
03665                                           Links);
03666 
03667         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a> (&amp;Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o3">BaseName</a>,
03668                                    &amp;DataTableEntry-&gt;BaseDllName,
03669                                    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03670 
03671             Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03672             <span class="keywordflow">break</span>;
03673         }
03674         NextEntry = NextEntry-&gt;Flink;
03675     }
03676 
03677     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Found == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03678 
03679     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Level &amp; DRIVER_VERIFIER_TRACK_POOL_ALLOCATIONS) {
03680 
03681         <span class="comment">//</span>
03682         <span class="comment">// Better not be any pool left that wasn't freed.  Walk the pagable</span>
03683         <span class="comment">// allocations in an attempt to make them all resident for a</span>
03684         <span class="comment">// kernel debugger session.</span>
03685         <span class="comment">//</span>
03686 
03687         <span class="keywordflow">if</span> (Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o18">PagedBytes</a>) {
03688 
03689 <span class="preprocessor">#if DBG</span>
03690 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Driver %wZ leaked %d paged pool allocations (0x%x bytes)\n"</span>,
03691                 &amp;DataTableEntry-&gt;FullDllName,
03692                 Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o14">CurrentPagedPoolAllocations</a>,
03693                 Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o18">PagedBytes</a>);
03694 <span class="preprocessor">#endif</span>
03695 <span class="preprocessor"></span>
03696             <span class="comment">//</span>
03697             <span class="comment">// It would be nice to fault in the driver's paged pool allocations</span>
03698             <span class="comment">// now to make debugging easier, but this cannot be easily done</span>
03699             <span class="comment">// in a deadlock free manner.</span>
03700             <span class="comment">//</span>
03701             <span class="comment">// At least disable the paging of pool on IRQL raising in attempt</span>
03702             <span class="comment">// to keep some of these allocations resident for debugging.</span>
03703             <span class="comment">// No need to undo the increment as we're about to bugcheck anyway.</span>
03704             <span class="comment">//</span>
03705 
03706             InterlockedIncrement ((PLONG)&amp;<a class="code" href="../../d9/d5/verifier_8c.html#a23">MiNoPageOnRaiseIrql</a>);
03707         }
03708 
03709 <span class="preprocessor">#if DBG</span>
03710 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o19">NonPagedBytes</a>) {
03711             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Driver %wZ leaked %d nonpaged pool allocations (0x%x bytes)\n"</span>,
03712                 &amp;DataTableEntry-&gt;FullDllName,
03713                 Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o15">CurrentNonPagedPoolAllocations</a>,
03714                 Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o19">NonPagedBytes</a>);
03715         }
03716 <span class="preprocessor">#endif</span>
03717 <span class="preprocessor"></span>
03718         <span class="keywordflow">if</span> (Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o18">PagedBytes</a> || Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o19">NonPagedBytes</a>) {
03719 <span class="preprocessor">#if 0</span>
03720 <span class="preprocessor"></span>            DbgBreakPoint ();
03721             InterlockedDecrement (&amp;<a class="code" href="../../d9/d5/verifier_8c.html#a23">MiNoPageOnRaiseIrql</a>);
03722 <span class="preprocessor">#else</span>
03723 <span class="preprocessor"></span>            <span class="comment">//</span>
03724             <span class="comment">// Snap this so the build/BVT lab can easily triage the culprit.</span>
03725             <span class="comment">//</span>
03726 
03727             <a class="code" href="../../d9/d5/verifier_8c.html#a48">ViBadDriver</a> = &amp;Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o3">BaseName</a>;
03728 
03729             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
03730                           0x60,
03731                           Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o18">PagedBytes</a>,
03732                           Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o19">NonPagedBytes</a>,
03733                           Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o14">CurrentPagedPoolAllocations</a> +
03734                             Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o15">CurrentNonPagedPoolAllocations</a>);
03735 <span class="preprocessor">#endif</span>
03736 <span class="preprocessor"></span>        }
03737 
03738         ExAcquireSpinLock (&amp;Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o9">VerifierPoolLock</a>, &amp;OldIrql);
03739 
03740         <span class="keywordflow">if</span> (Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o13">PoolHashReserved</a> != 0) {
03741             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
03742                           0x61,
03743                           Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o18">PagedBytes</a>,
03744                           Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o19">NonPagedBytes</a>,
03745                           Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o14">CurrentPagedPoolAllocations</a> +
03746                             Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o15">CurrentNonPagedPoolAllocations</a>);
03747         }
03748 
03749         OldHashTable = Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o10">PoolHash</a>;
03750         <span class="keywordflow">if</span> (OldHashTable != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03751             Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o11">PoolHashSize</a> = 0;
03752             Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o12">PoolHashFree</a> = <a class="code" href="../../d4/d8/mi_8h.html#a250">VI_POOL_FREELIST_END</a>;
03753             Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o10">PoolHash</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03754         }
03755         <span class="keywordflow">else</span> {
03756             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o11">PoolHashSize</a> == 0);
03757             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o12">PoolHashFree</a> == <a class="code" href="../../d4/d8/mi_8h.html#a250">VI_POOL_FREELIST_END</a>);
03758         }
03759 
03760         ExReleaseSpinLock (&amp;Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o9">VerifierPoolLock</a>, OldIrql);
03761 
03762         <span class="keywordflow">if</span> (OldHashTable != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03763             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (OldHashTable);
03764         }
03765 
03766         <span class="comment">//</span>
03767         <span class="comment">// Clear these fields so reuse of stale addresses don't trigger</span>
03768         <span class="comment">// erroneous bucket fills.</span>
03769         <span class="comment">//</span>
03770 
03771         ExAcquireSpinLock (&amp;<a class="code" href="../../d9/d5/verifier_8c.html#a29">VerifierListLock</a>, &amp;OldIrql);
03772         Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o4">StartAddress</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03773         Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o5">EndAddress</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03774         ExReleaseSpinLock (&amp;<a class="code" href="../../d9/d5/verifier_8c.html#a29">VerifierListLock</a>, OldIrql);
03775     }
03776 
03777     Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o2">Unloads</a> += 1;
03778     <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Unloads += 1;
03779     <a class="code" href="../../d9/d5/verifier_8c.html#a21">MiActiveVerifies</a> -= 1;
03780 
03781     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a21">MiActiveVerifies</a> == 0) {
03782 
03783         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Level &amp; DRIVER_VERIFIER_FORCE_IRQL_CHECKING) {
03784 
03785             <span class="comment">//</span>
03786             <span class="comment">// Return to normal thread stack protection.</span>
03787             <span class="comment">//</span>
03788 
03789             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a61">KernelVerifier</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03790                 <a class="code" href="../../d4/d9/ke_8h.html#a140">KiStackProtectTime</a> = <a class="code" href="../../d9/d5/verifier_8c.html#a24">MiVerifierStackProtectTime</a>;
03791             }
03792         }
03793 
03794 <span class="preprocessor">#ifndef NO_POOL_CHECKS</span>
03795 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a956">MiEnableRandomSpecialPool</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03796 <span class="preprocessor">#endif</span>
03797 <span class="preprocessor"></span>    }
03798 }
03799 
03800 <a class="code" href="../../d0/d9/ntosdef_8h.html#a29">NTKERNELAPI</a>
03801 LOGICAL
<a name="l03802"></a><a class="code" href="../../d9/d5/verifier_8c.html#a112">03802</a> <a class="code" href="../../d9/d5/verifier_8c.html#a112">MmIsDriverVerifying</a> (
03803     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject
03804     )
03805 
03806 <span class="comment">/*++</span>
03807 <span class="comment"></span>
03808 <span class="comment">Routine Description:</span>
03809 <span class="comment"></span>
03810 <span class="comment">    This function informs the caller if the argument driver is being verified.</span>
03811 <span class="comment"></span>
03812 <span class="comment">Arguments:</span>
03813 <span class="comment"></span>
03814 <span class="comment">    DriverObject - Supplies the driver object.</span>
03815 <span class="comment"></span>
03816 <span class="comment">Return Value:</span>
03817 <span class="comment"></span>
03818 <span class="comment">    TRUE if this driver is being verified, FALSE if not.</span>
03819 <span class="comment"></span>
03820 <span class="comment">Environment:</span>
03821 <span class="comment"></span>
03822 <span class="comment">    Kernel mode, any IRQL, any needed synchronization must be provided by the</span>
03823 <span class="comment">    caller.</span>
03824 <span class="comment"></span>
03825 <span class="comment">--*/</span>
03826 
03827 {
03828     PLDR_DATA_TABLE_ENTRY DataTableEntry;
03829 
03830     DataTableEntry = (PLDR_DATA_TABLE_ENTRY)DriverObject-&gt;DriverSection;
03831 
03832     <span class="keywordflow">if</span> (DataTableEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03833         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03834     }
03835 
03836     <span class="keywordflow">if</span> ((DataTableEntry-&gt;Flags &amp; LDRP_IMAGE_VERIFYING) == 0) {
03837         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03838     }
03839 
03840     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03841 }
03842 
<a name="l03843"></a><a class="code" href="../../d9/d5/verifier_8c.html#a9">03843</a> <span class="preprocessor">#define MM_BOOT_IMAGE_SIZE (16 * 1024 * 1024)</span>
03844 <span class="preprocessor"></span>
03845 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03846"></a><a class="code" href="../../d9/d5/verifier_8c.html#a113">03846</a> <a class="code" href="../../d9/d5/verifier_8c.html#a113">MmAddVerifierThunks</a> (
03847     IN PVOID ThunkBuffer,
03848     IN ULONG ThunkBufferSize
03849     )
03850 
03851 <span class="comment">/*++</span>
03852 <span class="comment"></span>
03853 <span class="comment">Routine Description:</span>
03854 <span class="comment"></span>
03855 <span class="comment">    This routine adds another set of thunks to the verifier list.</span>
03856 <span class="comment"></span>
03857 <span class="comment">Arguments:</span>
03858 <span class="comment"></span>
03859 <span class="comment">    ThunkBuffer - Supplies the buffer containing the thunk pairs.</span>
03860 <span class="comment"></span>
03861 <span class="comment">    ThunkBufferSize - Supplies the number of bytes in the thunk buffer.</span>
03862 <span class="comment"></span>
03863 <span class="comment">Return Value:</span>
03864 <span class="comment"></span>
03865 <span class="comment">    Returns the status of the operation.</span>
03866 <span class="comment"></span>
03867 <span class="comment">Environment:</span>
03868 <span class="comment"></span>
03869 <span class="comment">    Kernel mode.  APC_LEVEL and below.</span>
03870 <span class="comment"></span>
03871 <span class="comment">--*/</span>
03872 
03873 {
03874     ULONG i;
03875     ULONG NumberOfThunkPairs;
03876     PDRIVER_VERIFIER_THUNK_PAIRS ThunkPairs;
03877     PDRIVER_VERIFIER_THUNK_PAIRS ThunkTable;
03878     <a class="code" href="../../d9/d5/verifier_8c.html#a40">PDRIVER_SPECIFIED_VERIFIER_THUNKS</a> ThunkTableBase;
03879     PLDR_DATA_TABLE_ENTRY DataTableEntry;
03880     PVOID DriverStartAddress;
03881     PVOID DriverEndAddress;
03882 
03883     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03884 
03885     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a33">MiVerifierDriverAddedThunkListHead</a>.Flink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03886         <span class="keywordflow">return</span> STATUS_NOT_SUPPORTED;
03887     }
03888 
03889     ThunkPairs = (PDRIVER_VERIFIER_THUNK_PAIRS)ThunkBuffer;
03890     NumberOfThunkPairs = ThunkBufferSize / <span class="keyword">sizeof</span>(DRIVER_VERIFIER_THUNK_PAIRS);
03891 
03892     <span class="keywordflow">if</span> (NumberOfThunkPairs == 0) {
03893         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_1;
03894     }
03895 
03896     ThunkTableBase = (<a class="code" href="../../d9/d5/verifier_8c.html#a40">PDRIVER_SPECIFIED_VERIFIER_THUNKS</a>) <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
03897                             <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
03898                             <span class="keyword">sizeof</span> (<a class="code" href="../../d5/d9/struct__DRIVER__SPECIFIED__VERIFIER__THUNKS.html">DRIVER_SPECIFIED_VERIFIER_THUNKS</a>) + NumberOfThunkPairs * <span class="keyword">sizeof</span> (DRIVER_VERIFIER_THUNK_PAIRS),
03899                             'tVmM');
03900 
03901     <span class="keywordflow">if</span> (ThunkTableBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03902         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
03903     }
03904 
03905     ThunkTable = (PDRIVER_VERIFIER_THUNK_PAIRS)(ThunkTableBase + 1);
03906 
03907     RtlCopyMemory (ThunkTable,
03908                    ThunkPairs,
03909                    NumberOfThunkPairs * <span class="keyword">sizeof</span>(DRIVER_VERIFIER_THUNK_PAIRS));
03910 
03911     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
03912 
03913     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a432">MmSystemLoadLock</a>,
03914                            <a class="code" href="../../d4/d9/ke_8h.html#a407a216">WrVirtualMemory</a>,
03915                            <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
03916                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
03917                            (PLARGE_INTEGER)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03918 
03919     <span class="comment">//</span>
03920     <span class="comment">// Find and validate the image that contains the routines to be thunked.</span>
03921     <span class="comment">//</span>
03922 
03923     DataTableEntry = <a class="code" href="../../d4/d8/mi_8h.html#a874">MiLookupDataTableEntry</a> (ThunkTable-&gt;PristineRoutine,
03924                                              <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03925 
03926     <span class="keywordflow">if</span> (DataTableEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03927         <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a432">MmSystemLoadLock</a>, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03928         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03929         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ThunkTableBase);
03930         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
03931     }
03932 
03933     DriverStartAddress = (PVOID)(DataTableEntry-&gt;DllBase);
03934     DriverEndAddress = (PVOID)((PCHAR)DataTableEntry-&gt;DllBase + DataTableEntry-&gt;SizeOfImage);
03935 
03936     <span class="comment">//</span>
03937     <span class="comment">// Don't let drivers hook calls to kernel or HAL routines.</span>
03938     <span class="comment">//</span>
03939 
03940     <span class="keywordflow">if</span> (DriverStartAddress &lt; (PVOID)(<a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a> + <a class="code" href="../../d6/d8/mi386_8h.html#a4">MM_BOOT_IMAGE_SIZE</a>)) {
03941         <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a432">MmSystemLoadLock</a>, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03942         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03943         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ThunkTableBase);
03944         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
03945     }
03946 
03947     <span class="keywordflow">for</span> (i = 0; i &lt; NumberOfThunkPairs; i += 1) {
03948 
03949         <span class="comment">//</span>
03950         <span class="comment">// Ensure all the routines being thunked are in the same driver.</span>
03951         <span class="comment">//</span>
03952 
03953         <span class="keywordflow">if</span> (((ULONG_PTR)ThunkTable-&gt;PristineRoutine &lt; (ULONG_PTR)DriverStartAddress) ||
03954             ((ULONG_PTR)ThunkTable-&gt;PristineRoutine &gt;= (ULONG_PTR)DriverEndAddress)) {
03955 
03956             <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a432">MmSystemLoadLock</a>, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03957             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03958             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ThunkTableBase);
03959             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
03960         }
03961         ThunkTable += 1;
03962     }
03963 
03964     <span class="comment">//</span>
03965     <span class="comment">// Add the validated thunk table to the verifier's global list.</span>
03966     <span class="comment">//</span>
03967 
03968     ThunkTableBase-&gt;<a class="code" href="../../d5/d9/struct__DRIVER__SPECIFIED__VERIFIER__THUNKS.html#o1">DataTableEntry</a> = DataTableEntry;
03969     ThunkTableBase-&gt;<a class="code" href="../../d5/d9/struct__DRIVER__SPECIFIED__VERIFIER__THUNKS.html#o2">NumberOfThunks</a> = NumberOfThunkPairs;
03970     <a class="code" href="../../d4/d8/mi_8h.html#a554">MiActiveVerifierThunks</a> += 1;
03971 
03972     InsertTailList (&amp;<a class="code" href="../../d9/d5/verifier_8c.html#a33">MiVerifierDriverAddedThunkListHead</a>,
03973                     &amp;ThunkTableBase-&gt;<a class="code" href="../../d5/d9/struct__DRIVER__SPECIFIED__VERIFIER__THUNKS.html#o0">ListEntry</a>);
03974 
03975     <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a432">MmSystemLoadLock</a>, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03976     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03977 
03978     <span class="keywordflow">return</span> STATUS_SUCCESS;
03979 }
03980 
03981 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03982"></a><a class="code" href="../../d4/d8/mi_8h.html#a963">03982</a> <a class="code" href="../../d9/d5/verifier_8c.html#a106">MiVerifierCheckThunks</a> (
03983     IN PLDR_DATA_TABLE_ENTRY DataTableEntry
03984     )
03985 
03986 <span class="comment">/*++</span>
03987 <span class="comment"></span>
03988 <span class="comment">Routine Description:</span>
03989 <span class="comment"></span>
03990 <span class="comment">    This routine adds another set of thunks to the verifier list.</span>
03991 <span class="comment"></span>
03992 <span class="comment">Arguments:</span>
03993 <span class="comment"></span>
03994 <span class="comment">    DataTableEntry - Supplies the data table entry for the driver.</span>
03995 <span class="comment"></span>
03996 <span class="comment">Return Value:</span>
03997 <span class="comment"></span>
03998 <span class="comment">    None.</span>
03999 <span class="comment"></span>
04000 <span class="comment">Environment:</span>
04001 <span class="comment"></span>
04002 <span class="comment">    Kernel mode.  APC_LEVEL and below.</span>
04003 <span class="comment">    The system load lock must be held by the caller.</span>
04004 <span class="comment"></span>
04005 <span class="comment">--*/</span>
04006 
04007 {
04008     PLIST_ENTRY NextEntry;
04009     <a class="code" href="../../d9/d5/verifier_8c.html#a40">PDRIVER_SPECIFIED_VERIFIER_THUNKS</a> ThunkTableBase;
04010 
04011     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
04012 
04013     <span class="comment">//</span>
04014     <span class="comment">// N.B.  The DataTableEntry can move (see MiInitializeLoadedModuleList),</span>
04015     <span class="comment">//       but this only happens long before IoInitialize so this is safe.</span>
04016     <span class="comment">//</span>
04017 
04018     NextEntry = <a class="code" href="../../d9/d5/verifier_8c.html#a33">MiVerifierDriverAddedThunkListHead</a>.Flink;
04019     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d9/d5/verifier_8c.html#a33">MiVerifierDriverAddedThunkListHead</a>) {
04020 
04021         ThunkTableBase = CONTAINING_RECORD(NextEntry,
04022                                            <a class="code" href="../../d5/d9/struct__DRIVER__SPECIFIED__VERIFIER__THUNKS.html">DRIVER_SPECIFIED_VERIFIER_THUNKS</a>,
04023                                            ListEntry);
04024 
04025         <span class="keywordflow">if</span> (ThunkTableBase-&gt;<a class="code" href="../../d5/d9/struct__DRIVER__SPECIFIED__VERIFIER__THUNKS.html#o1">DataTableEntry</a> == DataTableEntry) {
04026             RemoveEntryList (NextEntry);
04027             NextEntry = NextEntry-&gt;Flink;
04028             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ThunkTableBase);
04029             <a class="code" href="../../d4/d8/mi_8h.html#a554">MiActiveVerifierThunks</a> -= 1;
04030 
04031             <span class="comment">//</span>
04032             <span class="comment">// Keep looking as the driver may have made multiple calls.</span>
04033             <span class="comment">//</span>
04034 
04035             <span class="keywordflow">continue</span>;
04036         }
04037 
04038         NextEntry = NextEntry-&gt;Flink;
04039     }
04040 }
04041 
<a name="l04042"></a><a class="code" href="../../d9/d5/verifier_8c.html#a10">04042</a> <span class="preprocessor">#define ROUND_UP(VALUE,ROUND) ((ULONG)(((ULONG)VALUE + \</span>
04043 <span class="preprocessor">                               ((ULONG)ROUND - 1L)) &amp; (~((ULONG)ROUND - 1L))))</span>
04044 <span class="preprocessor"></span>
04045 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04046"></a><a class="code" href="../../d9/d5/verifier_8c.html#a114">04046</a> <a class="code" href="../../d9/d5/verifier_8c.html#a114">MmGetVerifierInformation</a> (
04047     OUT PVOID SystemInformation,
04048     IN ULONG SystemInformationLength,
04049     OUT PULONG Length
04050     )
04051 
04052 <span class="comment">/*++</span>
04053 <span class="comment"></span>
04054 <span class="comment">Routine Description:</span>
04055 <span class="comment"></span>
04056 <span class="comment">    This routine returns information about drivers undergoing verification.</span>
04057 <span class="comment"></span>
04058 <span class="comment">Arguments:</span>
04059 <span class="comment"></span>
04060 <span class="comment">    SystemInformation - Returns the driver verification information.</span>
04061 <span class="comment"></span>
04062 <span class="comment">    SystemInformationLength - Supplies the length of the SystemInformation</span>
04063 <span class="comment">                              buffer.</span>
04064 <span class="comment"></span>
04065 <span class="comment">    Length - Returns the length of the driver verification file information</span>
04066 <span class="comment">             placed in the buffer.</span>
04067 <span class="comment"></span>
04068 <span class="comment">Return Value:</span>
04069 <span class="comment"></span>
04070 <span class="comment">    Returns the status of the operation.</span>
04071 <span class="comment"></span>
04072 <span class="comment">Environment:</span>
04073 <span class="comment"></span>
04074 <span class="comment">    The SystemInformation buffer is in user space and our caller has wrapped</span>
04075 <span class="comment">    a try-except around this entire routine.  Capture any exceptions here and</span>
04076 <span class="comment">    release resources accordingly.</span>
04077 <span class="comment"></span>
04078 <span class="comment">--*/</span>
04079 
04080 {
04081     PSYSTEM_VERIFIER_INFORMATION UserVerifyBuffer;
04082     ULONG NextEntryOffset;
04083     ULONG TotalSize;
04084     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04085     PLIST_ENTRY NextEntry;
04086     <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> Verifier;
04087     UNICODE_STRING UserBufferDriverName;
04088 
04089     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04090 
04091     NextEntryOffset = 0;
04092     TotalSize = 0;
04093 
04094     *Length = 0;
04095     UserVerifyBuffer = (PSYSTEM_VERIFIER_INFORMATION)SystemInformation;
04096 
04097     <span class="comment">//</span>
04098     <span class="comment">// Capture the number of verifying drivers and the relevant data while</span>
04099     <span class="comment">// synchronized.  Then return it to our caller.</span>
04100     <span class="comment">//</span>
04101 
04102     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
04103 
04104     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
04105 
04106     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a432">MmSystemLoadLock</a>,
04107                            <a class="code" href="../../d4/d9/ke_8h.html#a407a216">WrVirtualMemory</a>,
04108                            <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
04109                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
04110                            (PLARGE_INTEGER)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04111 
04112     <span class="keywordflow">try</span> {
04113 
04114         NextEntry = <a class="code" href="../../d4/d8/mi_8h.html#a555">MiSuspectDriverList</a>.Flink;
04115         <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d4/d8/mi_8h.html#a555">MiSuspectDriverList</a>) {
04116 
04117             Verifier = CONTAINING_RECORD(NextEntry,
04118                                               <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">MI_VERIFIER_DRIVER_ENTRY</a>,
04119                                               Links);
04120 
04121             <span class="keywordflow">if</span> ((Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o6">Flags</a> &amp; <a class="code" href="../../d4/d8/mi_8h.html#a252">VI_VERIFYING_DIRECTLY</a>) == 0) {
04122                 NextEntry = NextEntry-&gt;Flink;
04123                 <span class="keywordflow">continue</span>;
04124             }
04125 
04126             UserVerifyBuffer = (PSYSTEM_VERIFIER_INFORMATION)(
04127                                     (PUCHAR)UserVerifyBuffer + NextEntryOffset);
04128             NextEntryOffset = <span class="keyword">sizeof</span>(SYSTEM_VERIFIER_INFORMATION);
04129             TotalSize += <span class="keyword">sizeof</span>(SYSTEM_VERIFIER_INFORMATION);
04130 
04131             <span class="keywordflow">if</span> (TotalSize &gt; SystemInformationLength) {
04132                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INFO_LENGTH_MISMATCH);
04133             }
04134 
04135             <span class="comment">//</span>
04136             <span class="comment">// This data is cumulative for all drivers.</span>
04137             <span class="comment">//</span>
04138 
04139             UserVerifyBuffer-&gt;Level = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Level;
04140             UserVerifyBuffer-&gt;RaiseIrqls = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.RaiseIrqls;
04141             UserVerifyBuffer-&gt;AcquireSpinLocks = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.AcquireSpinLocks;
04142 
04143             UserVerifyBuffer-&gt;UnTrackedPool = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.UnTrackedPool;
04144             UserVerifyBuffer-&gt;SynchronizeExecutions = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.SynchronizeExecutions;
04145 
04146             UserVerifyBuffer-&gt;AllocationsAttempted = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.AllocationsAttempted;
04147             UserVerifyBuffer-&gt;AllocationsSucceeded = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.AllocationsSucceeded;
04148             UserVerifyBuffer-&gt;AllocationsSucceededSpecialPool = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.AllocationsSucceededSpecialPool;
04149             UserVerifyBuffer-&gt;AllocationsWithNoTag = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.AllocationsWithNoTag;
04150 
04151             UserVerifyBuffer-&gt;TrimRequests = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.TrimRequests;
04152             UserVerifyBuffer-&gt;Trims = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Trims;
04153             UserVerifyBuffer-&gt;AllocationsFailed = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.AllocationsFailed;
04154             UserVerifyBuffer-&gt;AllocationsFailedDeliberately = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.AllocationsFailedDeliberately;
04155 
04156             <span class="comment">//</span>
04157             <span class="comment">// This data is kept on a per-driver basis.</span>
04158             <span class="comment">//</span>
04159 
04160             UserVerifyBuffer-&gt;CurrentPagedPoolAllocations = Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o14">CurrentPagedPoolAllocations</a>;
04161             UserVerifyBuffer-&gt;CurrentNonPagedPoolAllocations = Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o15">CurrentNonPagedPoolAllocations</a>;
04162             UserVerifyBuffer-&gt;PeakPagedPoolAllocations = Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o16">PeakPagedPoolAllocations</a>;
04163             UserVerifyBuffer-&gt;PeakNonPagedPoolAllocations = Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o17">PeakNonPagedPoolAllocations</a>;
04164 
04165             UserVerifyBuffer-&gt;PagedPoolUsageInBytes = Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o18">PagedBytes</a>;
04166             UserVerifyBuffer-&gt;NonPagedPoolUsageInBytes = Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o19">NonPagedBytes</a>;
04167             UserVerifyBuffer-&gt;PeakPagedPoolUsageInBytes = Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o20">PeakPagedBytes</a>;
04168             UserVerifyBuffer-&gt;PeakNonPagedPoolUsageInBytes = Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o21">PeakNonPagedBytes</a>;
04169 
04170             UserVerifyBuffer-&gt;Loads = Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o1">Loads</a>;
04171             UserVerifyBuffer-&gt;Unloads = Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o2">Unloads</a>;
04172 
04173             <span class="comment">//</span>
04174             <span class="comment">// The DriverName portion of the UserVerifyBuffer must be saved</span>
04175             <span class="comment">// locally to protect against a malicious thread changing the</span>
04176             <span class="comment">// contents.  This is because we will reference the contents</span>
04177             <span class="comment">// ourselves when the actual string is copied out carefully below.</span>
04178             <span class="comment">//</span>
04179 
04180             UserBufferDriverName.Length = Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o3">BaseName</a>.Length;
04181             UserBufferDriverName.MaximumLength = Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o3">BaseName</a>.Length + <span class="keyword">sizeof</span> (WCHAR);
04182             UserBufferDriverName.Buffer = (PWCHAR)(UserVerifyBuffer + 1);
04183 
04184             UserVerifyBuffer-&gt;DriverName = UserBufferDriverName;
04185 
04186             TotalSize += <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a> (UserBufferDriverName.MaximumLength,
04187                                    <span class="keyword">sizeof</span>(ULONG));
04188             NextEntryOffset += <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a> (UserBufferDriverName.MaximumLength,
04189                                          <span class="keyword">sizeof</span>(ULONG));
04190 
04191             <span class="keywordflow">if</span> (TotalSize &gt; SystemInformationLength) {
04192                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INFO_LENGTH_MISMATCH);
04193             }
04194 
04195             <span class="comment">//</span>
04196             <span class="comment">// Carefully reference the UserVerifyBuffer here.</span>
04197             <span class="comment">//</span>
04198 
04199             RtlMoveMemory(UserBufferDriverName.Buffer,
04200                           Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o3">BaseName</a>.Buffer,
04201                           Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o3">BaseName</a>.Length);
04202 
04203             UserBufferDriverName.Buffer[
04204                         Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o3">BaseName</a>.Length/<span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
04205             UserVerifyBuffer-&gt;NextEntryOffset = NextEntryOffset;
04206 
04207             NextEntry = NextEntry-&gt;Flink;
04208         }
04209     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
04210         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
04211     }
04212 
04213     <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a432">MmSystemLoadLock</a>, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04214 
04215     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
04216 
04217     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_INFO_LENGTH_MISMATCH) {
04218         UserVerifyBuffer-&gt;NextEntryOffset = 0;
04219         *Length = TotalSize;
04220     }
04221 
04222     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04223 }
04224 
04225 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04226"></a><a class="code" href="../../d9/d5/verifier_8c.html#a115">04226</a> <a class="code" href="../../d9/d5/verifier_8c.html#a115">MmSetVerifierInformation</a> (
04227     IN OUT PVOID SystemInformation,
04228     IN ULONG SystemInformationLength
04229     )
04230 
04231 <span class="comment">/*++</span>
04232 <span class="comment"></span>
04233 <span class="comment">Routine Description:</span>
04234 <span class="comment"></span>
04235 <span class="comment">    This routine sets any driver verifier flags that can be done without</span>
04236 <span class="comment">    rebooting.</span>
04237 <span class="comment"></span>
04238 <span class="comment">Arguments:</span>
04239 <span class="comment"></span>
04240 <span class="comment">    SystemInformation - Gets and returns the driver verification flags.</span>
04241 <span class="comment"></span>
04242 <span class="comment">    SystemInformationLength - Supplies the length of the SystemInformation</span>
04243 <span class="comment">                              buffer.</span>
04244 <span class="comment"></span>
04245 <span class="comment">Return Value:</span>
04246 <span class="comment"></span>
04247 <span class="comment">    Returns the status of the operation.</span>
04248 <span class="comment"></span>
04249 <span class="comment">Environment:</span>
04250 <span class="comment"></span>
04251 <span class="comment">    The SystemInformation buffer is in user space and our caller has wrapped</span>
04252 <span class="comment">    a try-except around this entire routine.  Capture any exceptions here and</span>
04253 <span class="comment">    release resources accordingly.</span>
04254 <span class="comment"></span>
04255 <span class="comment">--*/</span>
04256 
04257 {
04258     ULONG UserFlags;
04259     ULONG NewFlags;
04260     ULONG NewFlagsOn;
04261     ULONG NewFlagsOff;
04262     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04263     PULONG UserVerifyBuffer;
04264 
04265     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04266 
04267     <span class="keywordflow">if</span> (SystemInformationLength &lt; <span class="keyword">sizeof</span> (ULONG)) {
04268         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INFO_LENGTH_MISMATCH);
04269     }
04270 
04271     UserVerifyBuffer = (PULONG)SystemInformation;
04272 
04273     <span class="comment">//</span>
04274     <span class="comment">// Synchronize all changes to the flags here.</span>
04275     <span class="comment">//</span>
04276 
04277     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
04278 
04279     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
04280 
04281     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a432">MmSystemLoadLock</a>,
04282                            <a class="code" href="../../d4/d9/ke_8h.html#a407a216">WrVirtualMemory</a>,
04283                            <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
04284                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
04285                            (PLARGE_INTEGER)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04286 
04287     <span class="keywordflow">try</span> {
04288 
04289         UserFlags = *UserVerifyBuffer;
04290 
04291         <span class="comment">//</span>
04292         <span class="comment">// Ensure nothing is being set or cleared that isn't supported.</span>
04293         <span class="comment">//</span>
04294         <span class="comment">//</span>
04295 
04296         NewFlagsOn = UserFlags &amp; <a class="code" href="../../d9/d5/verifier_8c.html#a16">VerifierModifyableOptions</a>;
04297 
04298         NewFlags = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Level | NewFlagsOn;
04299 
04300         <span class="comment">//</span>
04301         <span class="comment">// Any bits set in NewFlagsOff must be zeroed in the NewFlags.</span>
04302         <span class="comment">//</span>
04303 
04304         NewFlagsOff = ((~UserFlags) &amp; <a class="code" href="../../d9/d5/verifier_8c.html#a16">VerifierModifyableOptions</a>);
04305 
04306         NewFlags &amp;= ~NewFlagsOff;
04307 
04308         <span class="keywordflow">if</span> (NewFlags != <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Level) {
04309             <a class="code" href="../../d9/d5/verifier_8c.html#a17">VerifierOptionChanges</a> += 1;
04310             <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Level = NewFlags;
04311             *UserVerifyBuffer = NewFlags;
04312         }
04313 
04314     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
04315         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
04316     }
04317 
04318     <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a432">MmSystemLoadLock</a>, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04319 
04320     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
04321 
04322     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04323 }
04324 
<a name="l04325"></a><a class="code" href="../../d5/d6/struct__VERIFIER__STRING__INFO.html">04325</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d5/d6/struct__VERIFIER__STRING__INFO.html">_VERIFIER_STRING_INFO</a> {
<a name="l04326"></a><a class="code" href="../../d5/d6/struct__VERIFIER__STRING__INFO.html#o0">04326</a>    ULONG <a class="code" href="../../d5/d6/struct__VERIFIER__STRING__INFO.html#o0">BuildNumber</a>;
<a name="l04327"></a><a class="code" href="../../d5/d6/struct__VERIFIER__STRING__INFO.html#o1">04327</a>    ULONG <a class="code" href="../../d5/d6/struct__VERIFIER__STRING__INFO.html#o1">DriverVerifierLevel</a>;
<a name="l04328"></a><a class="code" href="../../d5/d6/struct__VERIFIER__STRING__INFO.html#o2">04328</a>    ULONG <a class="code" href="../../d5/d6/struct__VERIFIER__STRING__INFO.html#o2">Flags</a>;
<a name="l04329"></a><a class="code" href="../../d5/d6/struct__VERIFIER__STRING__INFO.html#o3">04329</a>    ULONG <a class="code" href="../../d5/d6/struct__VERIFIER__STRING__INFO.html#o3">Check</a>;
04330 } <a class="code" href="../../d5/d6/struct__VERIFIER__STRING__INFO.html">VERIFIER_STRING_INFO</a>, *<a class="code" href="../../d5/d6/struct__VERIFIER__STRING__INFO.html">PVERIFIER_STRING_INFO</a>;
04331 
<a name="l04332"></a><a class="code" href="../../d9/d5/verifier_8c.html#a51">04332</a> <span class="keyword">static</span> WCHAR <a class="code" href="../../d9/d5/verifier_8c.html#a51">Printable</a>[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"</span>;
<a name="l04333"></a><a class="code" href="../../d9/d5/verifier_8c.html#a52">04333</a> <span class="keyword">static</span> ULONG <a class="code" href="../../d9/d5/verifier_8c.html#a52">PrintableChars</a> = <span class="keyword">sizeof</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a51">Printable</a>) / <span class="keyword">sizeof</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a51">Printable</a>[0]) - 1;
04334 
04335 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04336"></a><a class="code" href="../../d9/d5/verifier_8c.html#a92">04336</a> <a class="code" href="../../d9/d5/verifier_8c.html#a92">ViPrintString</a> (
04337     IN PUNICODE_STRING DriverName
04338     )
04339 
04340 <span class="comment">/*++</span>
04341 <span class="comment"></span>
04342 <span class="comment">Routine Description:</span>
04343 <span class="comment"></span>
04344 <span class="comment">    This routine does a really bad hash of build number, verifier level and</span>
04345 <span class="comment">    flags by using the driver name as a stream of bytes to XOR into the flags,</span>
04346 <span class="comment">    etc.</span>
04347 <span class="comment"></span>
04348 <span class="comment">    This is a Neill Clift special.</span>
04349 <span class="comment"></span>
04350 <span class="comment">Arguments:</span>
04351 <span class="comment"></span>
04352 <span class="comment">    DriverName - Supplies the name of the driver.</span>
04353 <span class="comment"></span>
04354 <span class="comment">Return Value:</span>
04355 <span class="comment"></span>
04356 <span class="comment">    None.</span>
04357 <span class="comment"></span>
04358 <span class="comment">--*/</span>
04359 
04360 {
04361     <a class="code" href="../../d5/d6/struct__VERIFIER__STRING__INFO.html">VERIFIER_STRING_INFO</a> Bld;
04362     PUCHAR BufPtr;
04363     PWCHAR DriverPtr;
04364     ULONG BufLen;
04365     ULONG i;
04366     ULONG j;
04367     ULONG DriverChars;
04368     ULONG MaxChars;
04369     WCHAR OutBuf[<span class="keyword">sizeof</span> (<a class="code" href="../../d5/d6/struct__VERIFIER__STRING__INFO.html">VERIFIER_STRING_INFO</a>) * 2 + 1];
04370     UNICODE_STRING OutBufU;
04371     ULONG Rem;
04372     ULONG LastRem;
04373     LOGICAL Done;
04374 
04375     Bld.<a class="code" href="../../d5/d6/struct__VERIFIER__STRING__INFO.html#o0">BuildNumber</a> = <a class="code" href="../../d5/d5/triage_8c.html#a0">NtBuildNumber</a>;
04376     Bld.<a class="code" href="../../d5/d6/struct__VERIFIER__STRING__INFO.html#o1">DriverVerifierLevel</a> = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Level;
04377 
04378     <span class="comment">//</span>
04379     <span class="comment">// Unloads and other actions could be encoded in the Flags field here.</span>
04380     <span class="comment">//</span>
04381 
04382     Bld.<a class="code" href="../../d5/d6/struct__VERIFIER__STRING__INFO.html#o2">Flags</a> = 0;
04383 
04384     <span class="comment">//</span>
04385     <span class="comment">// Make the last ULONG a weird function of the others.</span>
04386     <span class="comment">//</span>
04387 
04388     Bld.<a class="code" href="../../d5/d6/struct__VERIFIER__STRING__INFO.html#o3">Check</a> = ((Bld.<a class="code" href="../../d5/d6/struct__VERIFIER__STRING__INFO.html#o2">Flags</a> + 1) * Bld.<a class="code" href="../../d5/d6/struct__VERIFIER__STRING__INFO.html#o0">BuildNumber</a> * (Bld.<a class="code" href="../../d5/d6/struct__VERIFIER__STRING__INFO.html#o1">DriverVerifierLevel</a> + 1)) * 123456789;
04389 
04390     BufPtr = (PUCHAR) &amp;Bld;
04391     BufLen = <span class="keyword">sizeof</span> (Bld);
04392 
04393     DriverChars = DriverName-&gt;Length / <span class="keyword">sizeof</span> (DriverName-&gt;Buffer[0]);
04394     DriverPtr = DriverName-&gt;Buffer;
04395     MaxChars = DriverChars;
04396 
04397     <span class="keywordflow">if</span> (DriverChars &lt; <span class="keyword">sizeof</span> (<a class="code" href="../../d5/d6/struct__VERIFIER__STRING__INFO.html">VERIFIER_STRING_INFO</a>)) {
04398         MaxChars = <span class="keyword">sizeof</span> (<a class="code" href="../../d5/d6/struct__VERIFIER__STRING__INFO.html">VERIFIER_STRING_INFO</a>);
04399     }
04400 
04401     <span class="comment">//</span>
04402     <span class="comment">// Xor each character in the driver name into the buffer.</span>
04403     <span class="comment">//</span>
04404 
04405     <span class="keywordflow">for</span> (i = 0; i &lt; MaxChars; i += 1) {
04406         BufPtr[i % BufLen] ^= (UCHAR) <a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(DriverPtr[i % DriverChars]);
04407     }
04408 
04409     <span class="comment">//</span>
04410     <span class="comment">// Produce a base N decoding of the binary buffer using the printable</span>
04411     <span class="comment">// characters defines. Treat the binary as a byte array and do the</span>
04412     <span class="comment">// division for each, tracking the carry.</span>
04413     <span class="comment">//</span>
04414 
04415     j = 0;
04416     <span class="keywordflow">do</span> {
04417         Done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04418 
04419         <span class="keywordflow">for</span> (i = 0, LastRem = 0; i &lt; <span class="keyword">sizeof</span> (<a class="code" href="../../d5/d6/struct__VERIFIER__STRING__INFO.html">VERIFIER_STRING_INFO</a>); i += 1) {
04420             Rem = BufPtr[i] + 256 * LastRem;
04421             BufPtr[i] = (UCHAR) (Rem / <a class="code" href="../../d9/d5/verifier_8c.html#a52">PrintableChars</a>);
04422             LastRem = Rem % <a class="code" href="../../d9/d5/verifier_8c.html#a52">PrintableChars</a>;
04423             <span class="keywordflow">if</span> (BufPtr[i]) {
04424                 Done = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04425             }
04426         }
04427         OutBuf[j++] = <a class="code" href="../../d9/d5/verifier_8c.html#a51">Printable</a>[LastRem];
04428 
04429         <span class="keywordflow">if</span> (j &gt;= <span class="keyword">sizeof</span> (OutBuf) / <span class="keyword">sizeof</span> (OutBuf[0])) {
04430 
04431             <span class="comment">//</span>
04432             <span class="comment">// The stack buffer isn't big enough.</span>
04433             <span class="comment">//</span>
04434 
04435             <span class="keywordflow">return</span>;
04436         }
04437 
04438     } <span class="keywordflow">while</span> (Done == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04439 
04440     OutBuf[j] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
04441 
04442     OutBufU.Length = OutBufU.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) j * <span class="keyword">sizeof</span> (WCHAR);
04443     OutBufU.Buffer = OutBuf;
04444 
04445     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"*******************************************************************************\n"</span>);
04446     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"*                                                                             *\n"</span>);
04447 
04448     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"* This is the string to paste into your build mail\n"</span>);
04449 
04450     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"* Driver Verifier: Enabled for %Z on Build %ld %wZ\n"</span>,
04451               DriverName, <a class="code" href="../../d5/d5/triage_8c.html#a0">NtBuildNumber</a> &amp; 0xFFFFFFF, &amp;OutBufU);
04452 
04453     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"*                                                                             *\n"</span>);
04454     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"*******************************************************************************\n"</span>);
04455 
04456     <span class="keywordflow">return</span>;
04457 }
04458 
04459 <span class="comment">//</span>
04460 <span class="comment">// BEWARE: Various kernel macros are undefined here so we can pull in the</span>
04461 <span class="comment">// real routines.  This is needed because the real routines are exported for</span>
04462 <span class="comment">// driver compatibility.  This module has been carefully laid out so these</span>
04463 <span class="comment">// macros are not referenced from this point down and references go to the</span>
04464 <span class="comment">// real routines.</span>
04465 <span class="comment">//</span>
04466 
04467 
04468 
04469 
04470 <span class="preprocessor">#undef KeRaiseIrql</span>
04471 <span class="preprocessor"></span><span class="preprocessor">#undef KeLowerIrql</span>
04472 <span class="preprocessor"></span><span class="preprocessor">#undef KeAcquireSpinLock</span>
04473 <span class="preprocessor"></span><span class="preprocessor">#undef KeReleaseSpinLock</span>
04474 <span class="preprocessor"></span><span class="preprocessor">#undef ExAcquireResourceExclusive</span>
04475 <span class="preprocessor"></span>
04476 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
04477 <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (
04478     IN KIRQL NewIrql,
04479     OUT PKIRQL OldIrql
04480     );
04481 
04482 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
04483 <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (
04484     IN KIRQL NewIrql
04485     );
04486 
04487 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
04488 <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a> (
04489     IN PKSPIN_LOCK SpinLock,
04490     OUT PKIRQL OldIrql
04491     );
04492 
04493 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
04494 <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a> (
04495     IN PKSPIN_LOCK SpinLock,
04496     IN KIRQL NewIrql
04497     );
04498 
04499 BOOLEAN
04500 <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a> (
04501     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource,
04502     IN BOOLEAN Wait
04503     );
04504 
04505 <span class="preprocessor">#if defined(_X86_)</span>
04506 <span class="preprocessor"></span><span class="preprocessor">#define X86_HAL_ROUTINE     1</span>
04507 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l04508"></a><a class="code" href="../../d9/d5/verifier_8c.html#a11">04508</a> <span class="preprocessor"></span><span class="preprocessor">#define X86_HAL_ROUTINE     0</span>
04509 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
04510 <span class="preprocessor"></span>
<a name="l04511"></a><a class="code" href="../../d9/d5/verifier_8c.html#a12">04511</a> <span class="preprocessor">#define POOL_ROUTINE        2</span>
04512 <span class="preprocessor"></span>
<a name="l04513"></a><a class="code" href="../../d9/d5/verifier_8c.html#a13">04513</a> <span class="preprocessor">#define VERIFIER_THUNK_IN_HAL(Flag) (Flag &amp; X86_HAL_ROUTINE)</span>
<a name="l04514"></a><a class="code" href="../../d9/d5/verifier_8c.html#a14">04514</a> <span class="preprocessor"></span><span class="preprocessor">#define VERIFIER_POOL_ROUTINE(Flag) (Flag &amp; POOL_ROUTINE)</span>
04515 <span class="preprocessor"></span>
<a name="l04516"></a><a class="code" href="../../d9/d5/verifier_8c.html#a53">04516</a> <a class="code" href="../../d6/d6/struct__VERIFIER__THUNKS.html">VERIFIER_THUNKS</a> <a class="code" href="../../d9/d5/verifier_8c.html#a53">MiVerifierThunks</a>[] = {
04517 
04518     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>,
04519     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a54">VerifierAllocatePool</a>,
04520     <a class="code" href="../../d9/d5/verifier_8c.html#a12">POOL_ROUTINE</a>,
04521 
04522     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d5/d5/cc_8h.html#a11">ExAllocatePoolWithQuota</a>,
04523     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a108">VerifierAllocatePoolWithQuota</a>,
04524     <a class="code" href="../../d9/d5/verifier_8c.html#a12">POOL_ROUTINE</a>,
04525 
04526     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d5/d8/ex_8h.html#a5">ExAllocatePoolWithQuotaTag</a>,
04527     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d6/d6/ioverifier_8c.html#a23">VerifierAllocatePoolWithQuotaTag</a>,
04528     <a class="code" href="../../d9/d5/verifier_8c.html#a12">POOL_ROUTINE</a>,
04529 
04530     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>,
04531     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a55">VerifierAllocatePoolWithTag</a>,
04532     <a class="code" href="../../d9/d5/verifier_8c.html#a12">POOL_ROUTINE</a>,
04533 
04534     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d2/d2/ex_2pool_8c.html#a77">ExAllocatePoolWithTagPriority</a>,
04535     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a57">VerifierAllocatePoolWithTagPriority</a>,
04536     <a class="code" href="../../d9/d5/verifier_8c.html#a12">POOL_ROUTINE</a>,
04537 
04538     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d6/d3/cmwraper_8c.html#a26">ExFreePool</a>,
04539     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a59">VerifierFreePool</a>,
04540     <a class="code" href="../../d9/d5/verifier_8c.html#a12">POOL_ROUTINE</a>,
04541 
04542     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>,
04543     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a60">VerifierFreePoolWithTag</a>,
04544     <a class="code" href="../../d9/d5/verifier_8c.html#a12">POOL_ROUTINE</a>,
04545 
04546     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d4/d9/ke_8h.html#a282">KeSetEvent</a>,
04547     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a61">VerifierSetEvent</a>,
04548     0,
04549 
04550     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>,
04551     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a75">VerifierExAcquireFastMutexUnsafe</a>,
04552     0,
04553 
04554     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>,
04555     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a76">VerifierExReleaseFastMutexUnsafe</a>,
04556     0,
04557 
04558 <span class="preprocessor">#if 0</span>
04559 <span class="preprocessor"></span>    <span class="comment">//</span>
04560     <span class="comment">// This API is re-routed through the stale ddkresrc.c.</span>
04561     <span class="comment">//</span>
04562     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>,
04563     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a77">VerifierExAcquireResourceExclusive</a>,
04564     0,
04565 <span class="preprocessor">#endif</span>
04566 <span class="preprocessor"></span>
04567     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d8/d8/ex_2resource_8c.html#a18">ExAcquireResourceExclusiveLite</a>,
04568     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a77">VerifierExAcquireResourceExclusive</a>,
04569     0,
04570 
04571     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d8/d8/ex_2resource_8c.html#a23">ExReleaseResourceLite</a>,
04572     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a78">VerifierExReleaseResource</a>,
04573     0,
04574 
04575     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d2/d1/mm_8h.html#a273">MmProbeAndLockPages</a>,
04576     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a82">VerifierProbeAndLockPages</a>,
04577     0,
04578 
04579     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d2/d1/mm_8h.html#a272">MmProbeAndLockProcessPages</a>,
04580     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a83">VerifierProbeAndLockProcessPages</a>,
04581     0,
04582 
04583     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d2/d1/mm_8h.html#a286">MmMapIoSpace</a>,
04584     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a88">VerifierMapIoSpace</a>,
04585     0,
04586 
04587     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d2/d1/mm_8h.html#a276">MmMapLockedPages</a>,
04588     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a89">VerifierMapLockedPages</a>,
04589     0,
04590 
04591     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d2/d1/mm_8h.html#a279">MmMapLockedPagesSpecifyCache</a>,
04592     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a90">VerifierMapLockedPagesSpecifyCache</a>,
04593     0,
04594 
04595     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d2/d1/mm_8h.html#a274">MmUnlockPages</a>,
04596     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a85">VerifierUnlockPages</a>,
04597     0,
04598 
04599     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d2/d1/mm_8h.html#a280">MmUnmapLockedPages</a>,
04600     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a86">VerifierUnmapLockedPages</a>,
04601     0,
04602 
04603     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d2/d1/mm_8h.html#a287">MmUnmapIoSpace</a>,
04604     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a87">VerifierUnmapIoSpace</a>,
04605     0,
04606 
04607     <span class="comment">//</span>
04608     <span class="comment">// These routines cannot be referenced as data on x86 because they</span>
04609     <span class="comment">// reside in the HAL.  So their addresses must be checked as a pointer.</span>
04610     <span class="comment">//</span>
04611 
04612     (PDRIVER_VERIFIER_THUNK_ROUTINE)ExAcquireFastMutex,
04613     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a73">VerifierExAcquireFastMutex</a>,
04614     <a class="code" href="../../d9/d5/verifier_8c.html#a11">X86_HAL_ROUTINE</a>,
04615 
04616     (PDRIVER_VERIFIER_THUNK_ROUTINE)ExTryToAcquireFastMutex,
04617     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a72">VerifierExTryToAcquireFastMutex</a>,
04618     <a class="code" href="../../d9/d5/verifier_8c.html#a11">X86_HAL_ROUTINE</a>,
04619 
04620     (PDRIVER_VERIFIER_THUNK_ROUTINE)ExReleaseFastMutex,
04621     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a74">VerifierExReleaseFastMutex</a>,
04622     <a class="code" href="../../d9/d5/verifier_8c.html#a11">X86_HAL_ROUTINE</a>,
04623 
04624     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>,
04625     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a64">VerifierKeRaiseIrql</a>,
04626     <a class="code" href="../../d9/d5/verifier_8c.html#a11">X86_HAL_ROUTINE</a>,
04627 
04628     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>,
04629     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a65">VerifierKeLowerIrql</a>,
04630     <a class="code" href="../../d9/d5/verifier_8c.html#a11">X86_HAL_ROUTINE</a>,
04631 
04632     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a>,
04633     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a66">VerifierKeAcquireSpinLock</a>,
04634     <a class="code" href="../../d9/d5/verifier_8c.html#a11">X86_HAL_ROUTINE</a>,
04635 
04636     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d4/d9/ke_8h.html#a359">KeReleaseSpinLock</a>,
04637     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a67">VerifierKeReleaseSpinLock</a>,
04638     <a class="code" href="../../d9/d5/verifier_8c.html#a11">X86_HAL_ROUTINE</a>,
04639 
04640     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d4/d9/ke_8h.html#a273">KeSynchronizeExecution</a>,
04641     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a81">VerifierSynchronizeExecution</a>,
04642     0,
04643 
04644     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d4/d9/ke_8h.html#a342">KeInitializeTimerEx</a>,
04645     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a70">VerifierKeInitializeTimerEx</a>,
04646     0,
04647 
04648     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d4/d9/ke_8h.html#a341">KeInitializeTimer</a>,
04649     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a71">VerifierKeInitializeTimer</a>,
04650     0,
04651 
04652 <span class="preprocessor">#if defined(_X86_)</span>
04653 <span class="preprocessor"></span>
04654     (PDRIVER_VERIFIER_THUNK_ROUTINE)KfRaiseIrql,
04655     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a62">VerifierKfRaiseIrql</a>,
04656     <a class="code" href="../../d9/d5/verifier_8c.html#a11">X86_HAL_ROUTINE</a>,
04657 
04658     (PDRIVER_VERIFIER_THUNK_ROUTINE)KfLowerIrql,
04659     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a63">VerifierKfLowerIrql</a>,
04660     <a class="code" href="../../d9/d5/verifier_8c.html#a11">X86_HAL_ROUTINE</a>,
04661 
04662     (PDRIVER_VERIFIER_THUNK_ROUTINE)KfAcquireSpinLock,
04663     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a68">VerifierKfAcquireSpinLock</a>,
04664     <a class="code" href="../../d9/d5/verifier_8c.html#a11">X86_HAL_ROUTINE</a>,
04665 
04666     (PDRIVER_VERIFIER_THUNK_ROUTINE)KfReleaseSpinLock,
04667     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a69">VerifierKfReleaseSpinLock</a>,
04668     <a class="code" href="../../d9/d5/verifier_8c.html#a11">X86_HAL_ROUTINE</a>,
04669 
04670 <span class="preprocessor">#endif</span>
04671 <span class="preprocessor"></span>
04672 <span class="preprocessor">#if defined(_ALPHA_)</span>
04673 <span class="preprocessor"></span>
04674     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d4/d9/ke_8h.html#a356">KeAcquireSpinLockAtDpcLevel</a>,
04675     (PDRIVER_VERIFIER_THUNK_ROUTINE)VerifierKeAcquireSpinLockAtDpcLevel,
04676     0,
04677 
04678     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d4/d9/ke_8h.html#a357">KeReleaseSpinLockFromDpcLevel</a>,
04679     (PDRIVER_VERIFIER_THUNK_ROUTINE)VerifierKeReleaseSpinLockFromDpcLevel,
04680     0,
04681 
04682     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d4/d9/ke_8h.html#a358">KeAcquireSpinLockRaiseToDpc</a>,
04683     (PDRIVER_VERIFIER_THUNK_ROUTINE)VerifierKeAcquireSpinLockRaiseToDpc,
04684     0,
04685 
04686 <span class="preprocessor">#endif</span>
04687 <span class="preprocessor"></span>
04688     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d0/d5/io_8h.html#a493">IoFreeIrp</a>,
04689     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d0/d5/io_8h.html#a589">IovFreeIrp</a>,
04690     0,
04691 
04692     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d0/d5/io_8h.html#a463">IofCallDriver</a>,
04693     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d0/d5/io_8h.html#a592">IovCallDriver</a>,
04694     0,
04695     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d0/d5/io_8h.html#a473">IofCompleteRequest</a>,
04696     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d0/d5/io_8h.html#a593">IovCompleteRequest</a>,
04697     0,
04698     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d0/d5/io_8h.html#a457">IoBuildDeviceIoControlRequest</a>,
04699     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d0/d5/io_8h.html#a595">IovBuildDeviceIoControlRequest</a>,
04700     0,
04701 
04702     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d0/d5/io_8h.html#a456">IoBuildAsynchronousFsdRequest</a>,
04703     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d0/d5/io_8h.html#a594">IovBuildAsynchronousFsdRequest</a>,
04704     0,
04705 
04706     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d0/d5/io_8h.html#a515">IoInitializeTimer</a>,
04707     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d0/d5/io_8h.html#a596">IovInitializeTimer</a>,
04708     0
04709 };
04710 
04711 LOGICAL
<a name="l04712"></a><a class="code" href="../../d9/d5/verifier_8c.html#a102">04712</a> <a class="code" href="../../d9/d5/verifier_8c.html#a102">MiEnableVerifier</a> (
04713     IN PLDR_DATA_TABLE_ENTRY DataTableEntry
04714     )
04715 
04716 <span class="comment">/*++</span>
04717 <span class="comment"></span>
04718 <span class="comment">Routine Description:</span>
04719 <span class="comment"></span>
04720 <span class="comment">    This function enables the verifier for the argument driver by thunking</span>
04721 <span class="comment">    relevant system APIs in the argument driver import table.</span>
04722 <span class="comment"></span>
04723 <span class="comment">Arguments:</span>
04724 <span class="comment"></span>
04725 <span class="comment">    DataTableEntry - Supplies the data table entry for the driver.</span>
04726 <span class="comment"></span>
04727 <span class="comment">Return Value:</span>
04728 <span class="comment"></span>
04729 <span class="comment">    TRUE if thunking was applied, FALSE if not.</span>
04730 <span class="comment"></span>
04731 <span class="comment">Environment:</span>
04732 <span class="comment"></span>
04733 <span class="comment">    Kernel mode, Phase 0 Initialization and normal runtime.</span>
04734 <span class="comment">    Non paged pool exists in Phase0, but paged pool does not.</span>
04735 <span class="comment"></span>
04736 <span class="comment">--*/</span>
04737 
04738 {
04739     ULONG i;
04740     ULONG j;
04741     PULONG_PTR ImportThunk;
04742     ULONG ImportSize;
04743     <a class="code" href="../../d9/d5/verifier_8c.html#a38">PVERIFIER_THUNKS</a> VerifierThunk;
04744     ULONG ThunkCount;
04745     LOGICAL Found;
04746     ULONG_PTR RealRoutine;
04747     PULONG_PTR PointerRealRoutine;
04748     PLIST_ENTRY NextEntry;
04749     PDRIVER_VERIFIER_THUNK_PAIRS ThunkTable;
04750     <a class="code" href="../../d9/d5/verifier_8c.html#a40">PDRIVER_SPECIFIED_VERIFIER_THUNKS</a> ThunkTableBase;
04751 
04752     ImportThunk = (PULONG_PTR)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
04753                                                DataTableEntry-&gt;DllBase,
04754                                                <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
04755                                                IMAGE_DIRECTORY_ENTRY_IAT,
04756                                                &amp;ImportSize);
04757 
04758     <span class="keywordflow">if</span> (ImportThunk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04759         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04760     }
04761 
04762     ImportSize /= <span class="keyword">sizeof</span>(PULONG_PTR);
04763 
04764     <span class="keywordflow">for</span> (i = 0; i &lt; ImportSize; i += 1, ImportThunk += 1) {
04765 
04766         Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04767 
04768         VerifierThunk = <a class="code" href="../../d9/d5/verifier_8c.html#a53">MiVerifierThunks</a>;
04769 
04770         <span class="keywordflow">for</span> (ThunkCount = 0; ThunkCount &lt; <span class="keyword">sizeof</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a53">MiVerifierThunks</a>) / <span class="keyword">sizeof</span> (<a class="code" href="../../d6/d6/struct__VERIFIER__THUNKS.html">VERIFIER_THUNKS</a>); ThunkCount += 1) {
04771 
04772             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a61">KernelVerifier</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
04773                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a14">VERIFIER_POOL_ROUTINE</a> (VerifierThunk-&gt;<a class="code" href="../../d6/d6/struct__VERIFIER__THUNKS.html#o2">Flag</a>) == 0) {
04774                     VerifierThunk += 1;
04775                     <span class="keywordflow">continue</span>;
04776                 }
04777             }
04778 
04779             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a13">VERIFIER_THUNK_IN_HAL</a> (VerifierThunk-&gt;<a class="code" href="../../d6/d6/struct__VERIFIER__THUNKS.html#o2">Flag</a>) == 0) {
04780                 RealRoutine = (ULONG_PTR)VerifierThunk-&gt;<a class="code" href="../../d6/d6/struct__VERIFIER__THUNKS.html#o0">PristineRoutine</a>;
04781             }
04782             <span class="keywordflow">else</span> {
04783 
04784                 <span class="comment">//</span>
04785                 <span class="comment">// Only the x86 has/needs this oddity - take the kernel address,</span>
04786                 <span class="comment">// knowing that it points at a 2 byte jmp opcode followed by</span>
04787                 <span class="comment">// a 4-byte indirect pointer to a destination address.</span>
04788                 <span class="comment">//</span>
04789 
04790                 PointerRealRoutine = (PULONG_PTR)*((PULONG_PTR)((PCHAR)VerifierThunk-&gt;<a class="code" href="../../d6/d6/struct__VERIFIER__THUNKS.html#o0">PristineRoutine</a> + 2));
04791                 RealRoutine = *PointerRealRoutine;
04792             }
04793 
04794             <span class="keywordflow">if</span> (*ImportThunk == RealRoutine) {
04795                 *ImportThunk = (ULONG_PTR)(VerifierThunk-&gt;<a class="code" href="../../d6/d6/struct__VERIFIER__THUNKS.html#o1">NewRoutine</a>);
04796                 Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04797                 <span class="keywordflow">break</span>;
04798             }
04799             VerifierThunk += 1;
04800         }
04801 
04802         <span class="keywordflow">if</span> (Found == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04803 
04804             NextEntry = <a class="code" href="../../d9/d5/verifier_8c.html#a33">MiVerifierDriverAddedThunkListHead</a>.Flink;
04805             <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d9/d5/verifier_8c.html#a33">MiVerifierDriverAddedThunkListHead</a>) {
04806 
04807                 ThunkTableBase = CONTAINING_RECORD(NextEntry,
04808                                                    <a class="code" href="../../d5/d9/struct__DRIVER__SPECIFIED__VERIFIER__THUNKS.html">DRIVER_SPECIFIED_VERIFIER_THUNKS</a>,
04809                                                    ListEntry);
04810 
04811                 ThunkTable = (PDRIVER_VERIFIER_THUNK_PAIRS)(ThunkTableBase + 1);
04812 
04813                 <span class="keywordflow">for</span> (j = 0; j &lt; ThunkTableBase-&gt;<a class="code" href="../../d5/d9/struct__DRIVER__SPECIFIED__VERIFIER__THUNKS.html#o2">NumberOfThunks</a>; j += 1) {
04814 
04815                     <span class="keywordflow">if</span> (*ImportThunk == (ULONG_PTR)ThunkTable-&gt;PristineRoutine) {
04816                         *ImportThunk = (ULONG_PTR)(ThunkTable-&gt;NewRoutine);
04817                         Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04818                         <span class="keywordflow">break</span>;
04819                     }
04820                     ThunkTable += 1;
04821                 }
04822 
04823                 <span class="keywordflow">if</span> (Found == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
04824                     <span class="keywordflow">break</span>;
04825                 }
04826 
04827                 NextEntry = NextEntry-&gt;Flink;
04828             }
04829         }
04830     }
04831     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04832 }
04833 
04834 <span class="preprocessor">#if defined(_X86_)</span>
04835 <span class="preprocessor"></span>
04836 DRIVER_VERIFIER_THUNK_PAIRS MiKernelVerifierThunks[] = {
04837 
04838     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>,
04839     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a64">VerifierKeRaiseIrql</a>,
04840 
04841     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>,
04842     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a65">VerifierKeLowerIrql</a>,
04843 
04844     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a>,
04845     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a66">VerifierKeAcquireSpinLock</a>,
04846 
04847     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d4/d9/ke_8h.html#a359">KeReleaseSpinLock</a>,
04848     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a67">VerifierKeReleaseSpinLock</a>,
04849 
04850     (PDRIVER_VERIFIER_THUNK_ROUTINE)KfRaiseIrql,
04851     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a62">VerifierKfRaiseIrql</a>,
04852 
04853     (PDRIVER_VERIFIER_THUNK_ROUTINE)KfLowerIrql,
04854     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a63">VerifierKfLowerIrql</a>,
04855 
04856     (PDRIVER_VERIFIER_THUNK_ROUTINE)KfAcquireSpinLock,
04857     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a68">VerifierKfAcquireSpinLock</a>,
04858 
04859     (PDRIVER_VERIFIER_THUNK_ROUTINE)KfReleaseSpinLock,
04860     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a69">VerifierKfReleaseSpinLock</a>,
04861 
04862 <span class="preprocessor">#if !defined(NT_UP)</span>
04863 <span class="preprocessor"></span>    (PDRIVER_VERIFIER_THUNK_ROUTINE)KeAcquireQueuedSpinLock,
04864     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a79">VerifierKeAcquireQueuedSpinLock</a>,
04865 
04866     (PDRIVER_VERIFIER_THUNK_ROUTINE)KeReleaseQueuedSpinLock,
04867     (PDRIVER_VERIFIER_THUNK_ROUTINE)<a class="code" href="../../d9/d5/verifier_8c.html#a80">VerifierKeReleaseQueuedSpinLock</a>,
04868 <span class="preprocessor">#endif</span>
04869 <span class="preprocessor"></span>};
04870 
04871 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
04872 <a class="code" href="../../d4/d8/mi_8h.html#a964">MiEnableKernelVerifier</a> (
04873     VOID
04874     )
04875 
04876 <span class="comment">/*++</span>
04877 <span class="comment"></span>
04878 <span class="comment">Routine Description:</span>
04879 <span class="comment"></span>
04880 <span class="comment">    This function enables the verifier for the kernel by thunking</span>
04881 <span class="comment">    relevant HAL APIs in the kernel's import table.</span>
04882 <span class="comment"></span>
04883 <span class="comment">Arguments:</span>
04884 <span class="comment"></span>
04885 <span class="comment">    None.</span>
04886 <span class="comment"></span>
04887 <span class="comment">Return Value:</span>
04888 <span class="comment"></span>
04889 <span class="comment">    None.</span>
04890 <span class="comment"></span>
04891 <span class="comment">Environment:</span>
04892 <span class="comment"></span>
04893 <span class="comment">    Kernel mode, Phase 1 Initialization.</span>
04894 <span class="comment"></span>
04895 <span class="comment">--*/</span>
04896 
04897 {
04898     ULONG i;
04899     PULONG_PTR ImportThunk;
04900     ULONG ImportSize;
04901     PDRIVER_VERIFIER_THUNK_PAIRS VerifierThunk;
04902     ULONG ThunkCount;
04903     ULONG_PTR RealRoutine;
04904     PULONG_PTR PointerRealRoutine;
04905 
04906     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a61">KernelVerifier</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04907         <span class="keywordflow">return</span>;
04908     }
04909 
04910     ImportThunk = (PULONG_PTR)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
04911                                                PsNtosImageBase,
04912                                                TRUE,
04913                                                IMAGE_DIRECTORY_ENTRY_IAT,
04914                                                &amp;ImportSize);
04915 
04916     <span class="keywordflow">if</span> (ImportThunk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04917         <span class="keywordflow">return</span>;
04918     }
04919 
04920     ImportSize /= <span class="keyword">sizeof</span>(PULONG_PTR);
04921 
04922     <span class="keywordflow">for</span> (i = 0; i &lt; ImportSize; i += 1, ImportThunk += 1) {
04923 
04924         VerifierThunk = MiKernelVerifierThunks;
04925 
04926         <span class="keywordflow">for</span> (ThunkCount = 0; ThunkCount &lt; <span class="keyword">sizeof</span> (MiKernelVerifierThunks) / <span class="keyword">sizeof</span> (DRIVER_VERIFIER_THUNK_PAIRS); ThunkCount += 1) {
04927 
04928             <span class="comment">//</span>
04929             <span class="comment">// Only the x86 has/needs this oddity - take the kernel address,</span>
04930             <span class="comment">// knowing that it points at a 2 byte jmp opcode followed by</span>
04931             <span class="comment">// a 4-byte indirect pointer to a destination address.</span>
04932             <span class="comment">//</span>
04933 
04934             PointerRealRoutine = (PULONG_PTR)*((PULONG_PTR)((PCHAR)VerifierThunk-&gt;PristineRoutine + 2));
04935             RealRoutine = *PointerRealRoutine;
04936 
04937             <span class="keywordflow">if</span> (*ImportThunk == RealRoutine) {
04938 
04939                 <span class="comment">//</span>
04940                 <span class="comment">// Order is important here.</span>
04941                 <span class="comment">//</span>
04942 
04943                 <span class="keywordflow">if</span> (MiKernelVerifierOriginalCalls[ThunkCount] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04944                     MiKernelVerifierOriginalCalls[ThunkCount] = (PVOID)RealRoutine;
04945                 }
04946 
04947                 *ImportThunk = (ULONG_PTR)(VerifierThunk-&gt;NewRoutine);
04948 
04949                 <span class="keywordflow">break</span>;
04950             }
04951             VerifierThunk += 1;
04952         }
04953     }
04954     <span class="keywordflow">return</span>;
04955 }
04956 <span class="preprocessor">#endif</span>
04957 <span class="preprocessor"></span>
04958 <span class="comment">//</span>
04959 <span class="comment">// BEWARE: Various kernel macros were undefined above so we can pull in the</span>
04960 <span class="comment">// real routines.  This is needed because the real routines are exported for</span>
04961 <span class="comment">// driver compatibility.  This module has been carefully laid out so these</span>
04962 <span class="comment">// macros are not referenced from that point to here and references go to the</span>
04963 <span class="comment">// real routines.</span>
04964 <span class="comment">//</span>
04965 <span class="comment">// BE EXTREMELY CAREFUL IF YOU DECIDE TO ADD ROUTINES BELOW THIS POINT !</span>
04966 <span class="comment">//</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:23 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
