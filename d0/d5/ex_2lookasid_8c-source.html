<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: lookasid.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>lookasid.c</h1><a href="../../d9/d5/ex_2lookasid_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1995  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    lookasid.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements lookaside list function.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    David N. Cutler (davec) 19-Feb-1995</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d4/d0/exp_8h.html">exp.h</a>"</span>
00022 
00023 <span class="comment">//</span>
00024 <span class="comment">// Define maximum dynamic adjustment scan periods.</span>
00025 <span class="comment">//</span>
00026 
<a name="l00027"></a><a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a0">00027</a> <span class="preprocessor">#define MAXIMUM_SCAN_PERIOD 4</span>
00028 <span class="preprocessor"></span>
00029 <span class="comment">//</span>
00030 <span class="comment">// Define Minimum lookaside list depth.</span>
00031 <span class="comment">//</span>
00032 
<a name="l00033"></a><a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a1">00033</a> <span class="preprocessor">#define MINIMUM_LOOKASIDE_DEPTH 4</span>
00034 <span class="preprocessor"></span>
00035 <span class="comment">//</span>
00036 <span class="comment">// Define minimum allocation threshold.</span>
00037 <span class="comment">//</span>
00038 
<a name="l00039"></a><a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a2">00039</a> <span class="preprocessor">#define MINIMUM_ALLOCATION_THRESHOLD 25</span>
00040 <span class="preprocessor"></span>
00041 <span class="comment">//</span>
00042 <span class="comment">// Define forward referenced function prototypes.</span>
00043 <span class="comment">//</span>
00044 
00045 LOGICAL
00046 <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a10">ExpComputeLookasideDepth</a> (
00047     IN ULONG Allocates,
00048     IN ULONG Misses,
00049     IN USHORT MaximumDepth,
00050     IN OUT PUSHORT Depth
00051     );
00052 
00053 PVOID
00054 <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a11">ExpDummyAllocate</a> (
00055     IN POOL_TYPE PoolType,
00056     IN SIZE_T NumberOfBytes,
00057     IN ULONG Tag
00058     );
00059 
00060 LOGICAL
00061 <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a12">ExpScanGeneralLookasideList</a> (
00062     IN PLIST_ENTRY ListHead,
00063     IN PKSPIN_LOCK SpinLock
00064     );
00065 
00066 LOGICAL
00067 <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a13">ExpScanPoolLookasideList</a> (
00068     IN PLIST_ENTRY ListHead
00069     );
00070 
00071 <span class="comment">//</span>
00072 <span class="comment">// Define the global nonpaged and paged lookaside list data.</span>
00073 <span class="comment">//</span>
00074 
<a name="l00075"></a><a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a3">00075</a> LIST_ENTRY <a class="code" href="../../d4/d0/exp_8h.html#a13">ExNPagedLookasideListHead</a>;
<a name="l00076"></a><a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a4">00076</a> KSPIN_LOCK <a class="code" href="../../d4/d0/exp_8h.html#a14">ExNPagedLookasideLock</a>;
<a name="l00077"></a><a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a5">00077</a> LIST_ENTRY <a class="code" href="../../d4/d0/exp_8h.html#a15">ExPagedLookasideListHead</a>;
<a name="l00078"></a><a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a6">00078</a> KSPIN_LOCK <a class="code" href="../../d4/d0/exp_8h.html#a16">ExPagedLookasideLock</a>;
<a name="l00079"></a><a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a7">00079</a> LIST_ENTRY <a class="code" href="../../d4/d0/exp_8h.html#a17">ExPoolLookasideListHead</a>;
00080 
00081 <span class="comment">//</span>
00082 <span class="comment">// Define lookaside list dynamic adjustment data.</span>
00083 <span class="comment">//</span>
00084 
<a name="l00085"></a><a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a8">00085</a> ULONG <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a8">ExpAdjustScanPeriod</a> = 1;
<a name="l00086"></a><a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a9">00086</a> ULONG <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a9">ExpCurrentScanPeriod</a> = 1;
00087 
00088 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00089"></a><a class="code" href="../../d5/d8/ex_8h.html#a245">00089</a> <a class="code" href="../../d5/d8/ex_8h.html#a245">ExAdjustLookasideDepth</a> (
00090     VOID
00091     )
00092 
00093 <span class="comment">/*++</span>
00094 <span class="comment"></span>
00095 <span class="comment">Routine Description:</span>
00096 <span class="comment"></span>
00097 <span class="comment">    This function is called periodically to adjust the maximum depth of</span>
00098 <span class="comment">    all lookaside lists.</span>
00099 <span class="comment"></span>
00100 <span class="comment">Arguments:</span>
00101 <span class="comment"></span>
00102 <span class="comment">    None.</span>
00103 <span class="comment"></span>
00104 <span class="comment">Return Value:</span>
00105 <span class="comment"></span>
00106 <span class="comment">    None.</span>
00107 <span class="comment"></span>
00108 <span class="comment">--*/</span>
00109 
00110 {
00111 
00112     LOGICAL Changes;
00113 
00114     <span class="comment">//</span>
00115     <span class="comment">// Decrement the scan period and check if it is time to dynamically</span>
00116     <span class="comment">// adjust the maximum depth of lookaside lists.</span>
00117     <span class="comment">//</span>
00118 
00119     <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a9">ExpCurrentScanPeriod</a> -= 1;
00120     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a9">ExpCurrentScanPeriod</a> == 0) {
00121         Changes = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00122 
00123         <span class="comment">//</span>
00124         <span class="comment">// Scan the general paged and nonpaged lookaside lists.</span>
00125         <span class="comment">//</span>
00126 
00127         Changes |= <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a12">ExpScanGeneralLookasideList</a>(&amp;<a class="code" href="../../d4/d0/exp_8h.html#a13">ExNPagedLookasideListHead</a>,
00128                                                &amp;<a class="code" href="../../d4/d0/exp_8h.html#a14">ExNPagedLookasideLock</a>);
00129 
00130         Changes |= <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a12">ExpScanGeneralLookasideList</a>(&amp;<a class="code" href="../../d4/d0/exp_8h.html#a15">ExPagedLookasideListHead</a>,
00131                                                &amp;<a class="code" href="../../d4/d0/exp_8h.html#a16">ExPagedLookasideLock</a>);
00132 
00133         <span class="comment">//</span>
00134         <span class="comment">// Scan the pool paged and nonpaged lookaside lists;</span>
00135         <span class="comment">//</span>
00136 
00137         Changes |= <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a13">ExpScanPoolLookasideList</a>(&amp;<a class="code" href="../../d4/d0/exp_8h.html#a17">ExPoolLookasideListHead</a>);
00138 
00139         <span class="comment">//</span>
00140         <span class="comment">// If any changes were made to the depth of any lookaside list during</span>
00141         <span class="comment">// this scan period, then lower the scan period to the minimum value.</span>
00142         <span class="comment">// Otherwise, attempt to raise the scan period.</span>
00143         <span class="comment">//</span>
00144 
00145         <span class="keywordflow">if</span> (Changes != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00146             <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a8">ExpAdjustScanPeriod</a> = 1;
00147 
00148         } <span class="keywordflow">else</span> {
00149             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a8">ExpAdjustScanPeriod</a> != <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a0">MAXIMUM_SCAN_PERIOD</a>) {
00150                 <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a8">ExpAdjustScanPeriod</a> += 1;
00151             }
00152         }
00153 
00154         <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a9">ExpCurrentScanPeriod</a> = <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a8">ExpAdjustScanPeriod</a>;
00155     }
00156 
00157     <span class="keywordflow">return</span>;
00158 }
00159 
00160 LOGICAL
<a name="l00161"></a><a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a10">00161</a> <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a10">ExpComputeLookasideDepth</a> (
00162     IN ULONG Allocates,
00163     IN ULONG Misses,
00164     IN USHORT MaximumDepth,
00165     IN OUT PUSHORT Depth
00166     )
00167 
00168 <span class="comment">/*++</span>
00169 <span class="comment"></span>
00170 <span class="comment">Routine Description:</span>
00171 <span class="comment"></span>
00172 <span class="comment">    This function computes the target depth of a lookaside list given the</span>
00173 <span class="comment">    total allocations and misses during the last scan period and the current</span>
00174 <span class="comment">    depth.</span>
00175 <span class="comment"></span>
00176 <span class="comment">Arguments:</span>
00177 <span class="comment"></span>
00178 <span class="comment">    Allocates - Supplies the total number of allocations during the last</span>
00179 <span class="comment">        scan period.</span>
00180 <span class="comment"></span>
00181 <span class="comment">    Misses - Supplies the total number of allocate misses during the last</span>
00182 <span class="comment">        scan period.</span>
00183 <span class="comment"></span>
00184 <span class="comment">    MaximumDepth - Supplies the maximum depth the lookaside list is allowed</span>
00185 <span class="comment">        to reach.</span>
00186 <span class="comment"></span>
00187 <span class="comment">    Depth - Supplies a pointer to the current lookaside list depth which</span>
00188 <span class="comment">        receives the target depth.</span>
00189 <span class="comment"></span>
00190 <span class="comment">Return Value:</span>
00191 <span class="comment"></span>
00192 <span class="comment">    If the target depth is greater than the current depth, then a value of</span>
00193 <span class="comment">    TRUE is returned as the function value. Otherwise, a value of FALSE is</span>
00194 <span class="comment">    returned.</span>
00195 <span class="comment"></span>
00196 <span class="comment">--*/</span>
00197 
00198 {
00199 
00200     LOGICAL Changes;
00201     ULONG Ratio;
00202     ULONG Target;
00203 
00204     <span class="comment">//</span>
00205     <span class="comment">// If the allocate rate is less than the mimimum threshold, then lower</span>
00206     <span class="comment">// the maximum depth of the lookaside list. Otherwise, if the miss rate</span>
00207     <span class="comment">// is less than .5%, then lower the maximum depth. Otherwise, raise the</span>
00208     <span class="comment">// maximum depth based on the miss rate.</span>
00209     <span class="comment">//</span>
00210 
00211     Changes = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00212     <span class="keywordflow">if</span> (Misses &gt;= Allocates) {
00213         Misses = Allocates;
00214     }
00215 
00216     <span class="keywordflow">if</span> (Allocates == 0) {
00217         Allocates = 1;
00218     }
00219 
00220     Ratio = (Misses * 1000) / Allocates;
00221     Target = *Depth;
00222     <span class="keywordflow">if</span> ((Allocates / <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a8">ExpAdjustScanPeriod</a>) &lt; <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a2">MINIMUM_ALLOCATION_THRESHOLD</a>) {
00223         <span class="keywordflow">if</span> (Target &gt; (<a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a1">MINIMUM_LOOKASIDE_DEPTH</a> + 10)) {
00224             Target -= 10;
00225 
00226         } <span class="keywordflow">else</span> {
00227             Target = <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a1">MINIMUM_LOOKASIDE_DEPTH</a>;
00228         }
00229 
00230     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Ratio &lt; 5) {
00231         <span class="keywordflow">if</span> (Target &gt; (<a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a1">MINIMUM_LOOKASIDE_DEPTH</a> + 1)) {
00232             Target -= 1;
00233 
00234         } <span class="keywordflow">else</span> {
00235             Target = <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a1">MINIMUM_LOOKASIDE_DEPTH</a>;
00236         }
00237 
00238     } <span class="keywordflow">else</span> {
00239         Changes = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00240         Target += ((Ratio * MaximumDepth) / (1000 * 2)) + 5;
00241         <span class="keywordflow">if</span> (Target &gt; MaximumDepth) {
00242             Target = MaximumDepth;
00243         }
00244     }
00245 
00246     *Depth = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Target;
00247     <span class="keywordflow">return</span> Changes;
00248 }
00249 
00250 LOGICAL
<a name="l00251"></a><a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a12">00251</a> <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a12">ExpScanGeneralLookasideList</a> (
00252     IN PLIST_ENTRY ListHead,
00253     IN PKSPIN_LOCK SpinLock
00254     )
00255 
00256 <span class="comment">/*++</span>
00257 <span class="comment"></span>
00258 <span class="comment">Routine Description:</span>
00259 <span class="comment"></span>
00260 <span class="comment">    This function scans the specified list of general lookaside descriptors</span>
00261 <span class="comment">    and adjusts the maximum depth as necessary.</span>
00262 <span class="comment"></span>
00263 <span class="comment">Arguments:</span>
00264 <span class="comment"></span>
00265 <span class="comment">    ListHead - Supplies the address of the listhead for a list of lookaside</span>
00266 <span class="comment">        descriptors.</span>
00267 <span class="comment"></span>
00268 <span class="comment">    SpinLock - Supplies the address of the spinlock to be used to synchronize</span>
00269 <span class="comment">        access to the list of lookaside descriptors.</span>
00270 <span class="comment"></span>
00271 <span class="comment">Return Value:</span>
00272 <span class="comment"></span>
00273 <span class="comment">    A value of TRUE is returned if the maximum depth of any lookaside list</span>
00274 <span class="comment">    is changed. Otherwise, a value of FALSE is returned.</span>
00275 <span class="comment"></span>
00276 <span class="comment">--*/</span>
00277 
00278 {
00279 
00280     ULONG Allocates;
00281     LOGICAL Changes;
00282     PLIST_ENTRY Entry;
00283     <a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html">PPAGED_LOOKASIDE_LIST</a> Lookaside;
00284     ULONG Misses;
00285     KIRQL OldIrql;
00286 
00287     <span class="comment">//</span>
00288     <span class="comment">// Raise IRQL and acquire the specified spinlock.</span>
00289     <span class="comment">//</span>
00290 
00291     Changes = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00292     ExAcquireSpinLock(SpinLock, &amp;OldIrql);
00293 
00294     <span class="comment">//</span>
00295     <span class="comment">// Scan the specified list of lookaside descriptors and adjust the</span>
00296     <span class="comment">// maximum depth as necessary.</span>
00297     <span class="comment">//</span>
00298     <span class="comment">// N.B. All lookaside list descriptor are treated as if they were</span>
00299     <span class="comment">//      paged descriptor even though they may be nonpaged descriptors.</span>
00300     <span class="comment">//      This is possible since both structures are identical except</span>
00301     <span class="comment">//      for the locking fields which are the last structure fields.</span>
00302 
00303     Entry = ListHead-&gt;Flink;
00304     <span class="keywordflow">while</span> (Entry != ListHead) {
00305         Lookaside = CONTAINING_RECORD(Entry,
00306                                       <a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html">PAGED_LOOKASIDE_LIST</a>,
00307                                       <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>.ListEntry);
00308 
00309         <span class="comment">//</span>
00310         <span class="comment">// Compute the total number of allocations and misses per second for</span>
00311         <span class="comment">// this scan period.</span>
00312         <span class="comment">//</span>
00313 
00314         Allocates = Lookaside-&gt;<a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o3">TotalAllocates</a> - Lookaside-&gt;<a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o15">LastTotalAllocates</a>;
00315         Lookaside-&gt;<a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o15">LastTotalAllocates</a> = Lookaside-&gt;<a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o3">TotalAllocates</a>;
00316         Misses = Lookaside-&gt;<a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o4">AllocateMisses</a> - Lookaside-&gt;<a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o16">LastAllocateMisses</a>;
00317         Lookaside-&gt;<a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o16">LastAllocateMisses</a> = Lookaside-&gt;<a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o4">AllocateMisses</a>;
00318 
00319         <span class="comment">//</span>
00320         <span class="comment">// Compute target depth of lookaside list.</span>
00321         <span class="comment">//</span>
00322 
00323         Changes |= <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a10">ExpComputeLookasideDepth</a>(Allocates,
00324                                             Misses,
00325                                             Lookaside-&gt;<a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o2">MaximumDepth</a>,
00326                                             &amp;Lookaside-&gt;<a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o1">Depth</a>);
00327 
00328         Entry = Entry-&gt;Flink;
00329     }
00330 
00331     <span class="comment">//</span>
00332     <span class="comment">// Release spinlock, lower IRQL, and return function value.</span>
00333     <span class="comment">//</span>
00334 
00335     ExReleaseSpinLock(SpinLock, OldIrql);
00336     <span class="keywordflow">return</span> Changes;
00337 }
00338 
00339 LOGICAL
<a name="l00340"></a><a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a13">00340</a> <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a13">ExpScanPoolLookasideList</a> (
00341     IN PLIST_ENTRY ListHead
00342     )
00343 
00344 <span class="comment">/*++</span>
00345 <span class="comment"></span>
00346 <span class="comment">Routine Description:</span>
00347 <span class="comment"></span>
00348 <span class="comment">    This function scans the specified pool lookaside descriptors and adjusts</span>
00349 <span class="comment">    the maximum depth as necessary.</span>
00350 <span class="comment"></span>
00351 <span class="comment">Arguments:</span>
00352 <span class="comment"></span>
00353 <span class="comment">    ListHead - Supplies a pointer to the list of pool lookaside structures.</span>
00354 <span class="comment"></span>
00355 <span class="comment">Return Value:</span>
00356 <span class="comment"></span>
00357 <span class="comment">    A value of TRUE is returned if the maximum depth of any lookaside list</span>
00358 <span class="comment">    is changed. Otherwise, a value of FALSE is returned.</span>
00359 <span class="comment"></span>
00360 <span class="comment">--*/</span>
00361 
00362 {
00363 
00364     ULONG Allocates;
00365     LOGICAL Changes;
00366     <a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">PNPAGED_LOOKASIDE_LIST</a> Lookaside;
00367     PLIST_ENTRY NextEntry;
00368     ULONG Misses;
00369 
00370     <span class="comment">//</span>
00371     <span class="comment">// Scan the specified list of lookaside descriptors and adjust the</span>
00372     <span class="comment">// maximum depth as necessary.</span>
00373     <span class="comment">//</span>
00374 
00375     Changes = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00376     NextEntry = ListHead-&gt;Flink;
00377     <span class="keywordflow">while</span> (NextEntry != ListHead) {
00378         Lookaside = CONTAINING_RECORD(NextEntry,
00379                                       <a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a>,
00380                                       <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>.ListEntry);
00381 
00382         <span class="comment">//</span>
00383         <span class="comment">// Compute the total number of allocations and misses per second for</span>
00384         <span class="comment">// this scan period.</span>
00385         <span class="comment">//</span>
00386 
00387         Allocates = Lookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o3">TotalAllocates</a> - Lookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o15">LastTotalAllocates</a>;
00388         Lookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o15">LastTotalAllocates</a> = Lookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o3">TotalAllocates</a>;
00389         Misses = Allocates - (Lookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o5">AllocateHits</a> - Lookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o17">LastAllocateHits</a>);
00390         Lookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o17">LastAllocateHits</a> = Lookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o5">AllocateHits</a>;
00391 
00392         <span class="comment">//</span>
00393         <span class="comment">// Compute target depth of lookaside list.</span>
00394         <span class="comment">//</span>
00395 
00396         Changes |= <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a10">ExpComputeLookasideDepth</a>(Allocates,
00397                                             Misses,
00398                                             Lookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o2">MaximumDepth</a>,
00399                                             &amp;Lookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o1">Depth</a>);
00400 
00401         NextEntry = NextEntry-&gt;Flink;
00402     }
00403 
00404     <span class="keywordflow">return</span> Changes;
00405 }
00406 
00407 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00408"></a><a class="code" href="../../d5/d8/ex_8h.html#a246">00408</a> <a class="code" href="../../d5/d8/ex_8h.html#a246">ExInitializeNPagedLookasideList</a> (
00409     IN <a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">PNPAGED_LOOKASIDE_LIST</a> Lookaside,
00410     IN PALLOCATE_FUNCTION Allocate,
00411     IN PFREE_FUNCTION Free,
00412     IN ULONG Flags,
00413     IN SIZE_T Size,
00414     IN ULONG Tag,
00415     IN USHORT Depth
00416     )
00417 
00418 <span class="comment">/*++</span>
00419 <span class="comment"></span>
00420 <span class="comment">Routine Description:</span>
00421 <span class="comment"></span>
00422 <span class="comment">    This function initializes a nonpaged lookaside list structure and inserts</span>
00423 <span class="comment">    the structure in the system nonpaged lookaside list.</span>
00424 <span class="comment"></span>
00425 <span class="comment">Arguments:</span>
00426 <span class="comment"></span>
00427 <span class="comment">    Lookaside - Supplies a pointer to a nonpaged lookaside list structure.</span>
00428 <span class="comment"></span>
00429 <span class="comment">    Allocate - Supplies an optional pointer to an allocate function.</span>
00430 <span class="comment"></span>
00431 <span class="comment">    Free - Supplies an optional pointer to a free function.</span>
00432 <span class="comment"></span>
00433 <span class="comment">    Flags - Supplies the pool allocation flags which are merged with the</span>
00434 <span class="comment">        pool allocation type (NonPagedPool) to control pool allocation.</span>
00435 <span class="comment"></span>
00436 <span class="comment">    Size - Supplies the size for the lookaside list entries.</span>
00437 <span class="comment"></span>
00438 <span class="comment">    Tag - Supplies the pool tag for the lookaside list entries.</span>
00439 <span class="comment"></span>
00440 <span class="comment">    Depth - Supplies the maximum depth of the lookaside list.</span>
00441 <span class="comment"></span>
00442 <span class="comment">Return Value:</span>
00443 <span class="comment"></span>
00444 <span class="comment">    None.</span>
00445 <span class="comment"></span>
00446 <span class="comment">--*/</span>
00447 
00448 {
00449 
00450     <span class="comment">//</span>
00451     <span class="comment">// Initialize the lookaside list structure.</span>
00452     <span class="comment">//</span>
00453 
00454     <a class="code" href="../../d5/d8/ex_8h.html#a9">ExInitializeSListHead</a>(&amp;Lookaside-&gt;L.ListHead);
00455     Lookaside-&gt;L.Depth = <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a1">MINIMUM_LOOKASIDE_DEPTH</a>;
00456     Lookaside-&gt;L.MaximumDepth = 256; <span class="comment">//Depth;</span>
00457     Lookaside-&gt;L.TotalAllocates = 0;
00458     Lookaside-&gt;L.AllocateMisses = 0;
00459     Lookaside-&gt;L.TotalFrees = 0;
00460     Lookaside-&gt;L.FreeMisses = 0;
00461     Lookaside-&gt;L.Type = <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a> | Flags;
00462     Lookaside-&gt;L.Tag = Tag;
00463     Lookaside-&gt;L.Size = (ULONG)<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00464     <span class="keywordflow">if</span> (Allocate == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00465         Lookaside-&gt;L.Allocate = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>;
00466 
00467     } <span class="keywordflow">else</span> {
00468         Lookaside-&gt;L.Allocate = Allocate;
00469     }
00470 
00471     <span class="keywordflow">if</span> (Free == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00472         Lookaside-&gt;L.Free = <a class="code" href="../../d6/d3/cmwraper_8c.html#a26">ExFreePool</a>;
00473 
00474     } <span class="keywordflow">else</span> {
00475         Lookaside-&gt;L.Free = Free;
00476     }
00477 
00478     Lookaside-&gt;L.LastTotalAllocates = 0;
00479     Lookaside-&gt;L.LastAllocateMisses = 0;
00480     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;Lookaside-&gt;Lock);
00481 
00482     <span class="comment">//</span>
00483     <span class="comment">// Insert the lookaside list structure is the system nonpaged lookaside</span>
00484     <span class="comment">// list.</span>
00485     <span class="comment">//</span>
00486 
00487     <a class="code" href="../../d5/d8/ex_8h.html#a238">ExInterlockedInsertTailList</a>(&amp;<a class="code" href="../../d4/d0/exp_8h.html#a13">ExNPagedLookasideListHead</a>,
00488                                 &amp;Lookaside-&gt;L.ListEntry,
00489                                 &amp;<a class="code" href="../../d4/d0/exp_8h.html#a14">ExNPagedLookasideLock</a>);
00490     <span class="keywordflow">return</span>;
00491 }
00492 
00493 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00494"></a><a class="code" href="../../d5/d8/ex_8h.html#a247">00494</a> <a class="code" href="../../d5/d8/ex_8h.html#a247">ExDeleteNPagedLookasideList</a> (
00495     IN <a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">PNPAGED_LOOKASIDE_LIST</a> Lookaside
00496     )
00497 
00498 <span class="comment">/*++</span>
00499 <span class="comment"></span>
00500 <span class="comment">Routine Description:</span>
00501 <span class="comment"></span>
00502 <span class="comment">    This function removes a paged lookaside structure from the system paged</span>
00503 <span class="comment">    lookaside list and frees any entries specified by the lookaside structure.</span>
00504 <span class="comment"></span>
00505 <span class="comment">Arguments:</span>
00506 <span class="comment"></span>
00507 <span class="comment">    Lookaside - Supplies a pointer to a nonpaged lookaside list structure.</span>
00508 <span class="comment"></span>
00509 <span class="comment">Return Value:</span>
00510 <span class="comment"></span>
00511 <span class="comment">    None.</span>
00512 <span class="comment"></span>
00513 <span class="comment">--*/</span>
00514 
00515 {
00516 
00517     PVOID Entry;
00518     KIRQL OldIrql;
00519 
00520     <span class="comment">//</span>
00521     <span class="comment">// Acquire the nonpaged system lookaside list lock and remove the</span>
00522     <span class="comment">// specified lookaside list structure from the list.</span>
00523     <span class="comment">//</span>
00524 
00525     ExAcquireSpinLock(&amp;<a class="code" href="../../d4/d0/exp_8h.html#a14">ExNPagedLookasideLock</a>, &amp;OldIrql);
00526     RemoveEntryList(&amp;Lookaside-&gt;L.ListEntry);
00527     ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/exp_8h.html#a14">ExNPagedLookasideLock</a>, OldIrql);
00528 
00529     <span class="comment">//</span>
00530     <span class="comment">// Remove all pool entries from the specified lookaside structure</span>
00531     <span class="comment">// and free them.</span>
00532     <span class="comment">//</span>
00533 
00534     Lookaside-&gt;L.Allocate = <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a11">ExpDummyAllocate</a>;
00535     <span class="keywordflow">while</span> ((Entry = <a class="code" href="../../d5/d8/ex_8h.html#a248">ExAllocateFromNPagedLookasideList</a>(Lookaside)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00536         (Lookaside-&gt;L.Free)(Entry);
00537     }
00538 
00539     <span class="keywordflow">return</span>;
00540 }
00541 
00542 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00543"></a><a class="code" href="../../d5/d8/ex_8h.html#a250">00543</a> <a class="code" href="../../d5/d8/ex_8h.html#a250">ExInitializePagedLookasideList</a> (
00544     IN <a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html">PPAGED_LOOKASIDE_LIST</a> Lookaside,
00545     IN PALLOCATE_FUNCTION Allocate,
00546     IN PFREE_FUNCTION Free,
00547     IN ULONG Flags,
00548     IN SIZE_T Size,
00549     IN ULONG Tag,
00550     IN USHORT Depth
00551     )
00552 
00553 <span class="comment">/*++</span>
00554 <span class="comment"></span>
00555 <span class="comment">Routine Description:</span>
00556 <span class="comment"></span>
00557 <span class="comment">    This function initializes a paged lookaside list structure and inserts</span>
00558 <span class="comment">    the structure in the system paged lookaside list.</span>
00559 <span class="comment"></span>
00560 <span class="comment">Arguments:</span>
00561 <span class="comment"></span>
00562 <span class="comment">    Lookaside - Supplies a pointer to a paged lookaside list structure.</span>
00563 <span class="comment"></span>
00564 <span class="comment">    Allocate - Supplies an optional pointer to an allocate function.</span>
00565 <span class="comment"></span>
00566 <span class="comment">    Free - Supplies an optional pointer to a free function.</span>
00567 <span class="comment"></span>
00568 <span class="comment">    Flags - Supplies the pool allocation flags which are merged with the</span>
00569 <span class="comment">        pool allocation type (NonPagedPool) to control pool allocation.</span>
00570 <span class="comment"></span>
00571 <span class="comment">    Size - Supplies the size for the lookaside list entries.</span>
00572 <span class="comment"></span>
00573 <span class="comment">    Tag - Supplies the pool tag for the lookaside list entries.</span>
00574 <span class="comment"></span>
00575 <span class="comment">    Depth - Supplies the maximum depth of the lookaside list.</span>
00576 <span class="comment"></span>
00577 <span class="comment">Return Value:</span>
00578 <span class="comment"></span>
00579 <span class="comment">    None.</span>
00580 <span class="comment"></span>
00581 <span class="comment">--*/</span>
00582 
00583 {
00584 
00585     <span class="comment">//</span>
00586     <span class="comment">// Initialize the lookaside list structure.</span>
00587     <span class="comment">//</span>
00588 
00589     <a class="code" href="../../d5/d8/ex_8h.html#a9">ExInitializeSListHead</a>(&amp;Lookaside-&gt;L.ListHead);
00590     Lookaside-&gt;L.Depth = <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a1">MINIMUM_LOOKASIDE_DEPTH</a>;
00591     Lookaside-&gt;L.MaximumDepth = 256; <span class="comment">//Depth;</span>
00592     Lookaside-&gt;L.TotalAllocates = 0;
00593     Lookaside-&gt;L.AllocateMisses = 0;
00594     Lookaside-&gt;L.TotalFrees = 0;
00595     Lookaside-&gt;L.FreeMisses = 0;
00596     Lookaside-&gt;L.Type = <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a> | Flags;
00597     Lookaside-&gt;L.Tag = Tag;
00598     Lookaside-&gt;L.Size = (ULONG)<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00599     <span class="keywordflow">if</span> (Allocate == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00600         Lookaside-&gt;L.Allocate = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>;
00601 
00602     } <span class="keywordflow">else</span> {
00603         Lookaside-&gt;L.Allocate = Allocate;
00604     }
00605 
00606     <span class="keywordflow">if</span> (Free == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00607         Lookaside-&gt;L.Free = <a class="code" href="../../d6/d3/cmwraper_8c.html#a26">ExFreePool</a>;
00608 
00609     } <span class="keywordflow">else</span> {
00610         Lookaside-&gt;L.Free = Free;
00611     }
00612 
00613     Lookaside-&gt;L.LastTotalAllocates = 0;
00614     Lookaside-&gt;L.LastAllocateMisses = 0;
00615     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;Lookaside-&gt;Lock);
00616 
00617     <span class="comment">//</span>
00618     <span class="comment">// Insert the lookaside list structure in the system paged lookaside</span>
00619     <span class="comment">// list.</span>
00620     <span class="comment">//</span>
00621 
00622     <a class="code" href="../../d5/d8/ex_8h.html#a238">ExInterlockedInsertTailList</a>(&amp;<a class="code" href="../../d4/d0/exp_8h.html#a15">ExPagedLookasideListHead</a>,
00623                                 &amp;Lookaside-&gt;L.ListEntry,
00624                                 &amp;<a class="code" href="../../d4/d0/exp_8h.html#a16">ExPagedLookasideLock</a>);
00625     <span class="keywordflow">return</span>;
00626 }
00627 
00628 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00629"></a><a class="code" href="../../d5/d8/ex_8h.html#a251">00629</a> <a class="code" href="../../d5/d8/ex_8h.html#a251">ExDeletePagedLookasideList</a> (
00630     IN <a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html">PPAGED_LOOKASIDE_LIST</a> Lookaside
00631     )
00632 
00633 <span class="comment">/*++</span>
00634 <span class="comment"></span>
00635 <span class="comment">Routine Description:</span>
00636 <span class="comment"></span>
00637 <span class="comment">    This function removes a paged lookaside structure from the system paged</span>
00638 <span class="comment">    lookaside list and frees any entries specified by the lookaside structure.</span>
00639 <span class="comment"></span>
00640 <span class="comment">Arguments:</span>
00641 <span class="comment"></span>
00642 <span class="comment">    Lookaside - Supplies a pointer to a paged lookaside list structure.</span>
00643 <span class="comment"></span>
00644 <span class="comment">Return Value:</span>
00645 <span class="comment"></span>
00646 <span class="comment">    None.</span>
00647 <span class="comment"></span>
00648 <span class="comment">--*/</span>
00649 
00650 {
00651 
00652     PVOID Entry;
00653     KIRQL OldIrql;
00654 
00655     <span class="comment">//</span>
00656     <span class="comment">// Acquire the paged system lookaside list lock and remove the</span>
00657     <span class="comment">// specified lookaside list structure from the list.</span>
00658     <span class="comment">//</span>
00659 
00660     ExAcquireSpinLock(&amp;<a class="code" href="../../d4/d0/exp_8h.html#a16">ExPagedLookasideLock</a>, &amp;OldIrql);
00661     RemoveEntryList(&amp;Lookaside-&gt;L.ListEntry);
00662     ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/exp_8h.html#a16">ExPagedLookasideLock</a>, OldIrql);
00663 
00664     <span class="comment">//</span>
00665     <span class="comment">// Remove all pool entries from the specified lookaside structure</span>
00666     <span class="comment">// and free them.</span>
00667     <span class="comment">//</span>
00668 
00669     Lookaside-&gt;L.Allocate = <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a11">ExpDummyAllocate</a>;
00670     <span class="keywordflow">while</span> ((Entry = <a class="code" href="../../d5/d8/ex_8h.html#a252">ExAllocateFromPagedLookasideList</a>(Lookaside)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00671         (Lookaside-&gt;L.Free)(Entry);
00672     }
00673 
00674     <span class="keywordflow">return</span>;
00675 }
00676 
00677 <span class="preprocessor">#if !defined(_MIPS_) &amp;&amp; !defined(_ALPHA_) &amp;&amp; !defined(_IA64_)</span>
00678 <span class="preprocessor"></span>
00679 
00680 PVOID
<a name="l00681"></a><a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a19">00681</a> <a class="code" href="../../d5/d8/ex_8h.html#a252">ExAllocateFromPagedLookasideList</a>(
00682     IN <a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html">PPAGED_LOOKASIDE_LIST</a> Lookaside
00683     )
00684 
00685 <span class="comment">/*++</span>
00686 <span class="comment"></span>
00687 <span class="comment">Routine Description:</span>
00688 <span class="comment"></span>
00689 <span class="comment">    This function removes (pops) the first entry from the specified</span>
00690 <span class="comment">    paged lookaside list.</span>
00691 <span class="comment"></span>
00692 <span class="comment">Arguments:</span>
00693 <span class="comment"></span>
00694 <span class="comment">    Lookaside - Supplies a pointer to a paged lookaside list structure.</span>
00695 <span class="comment"></span>
00696 <span class="comment">Return Value:</span>
00697 <span class="comment"></span>
00698 <span class="comment">    If an entry is removed from the specified lookaside list, then the</span>
00699 <span class="comment">    address of the entry is returned as the function value. Otherwise,</span>
00700 <span class="comment">    NULL is returned.</span>
00701 <span class="comment"></span>
00702 <span class="comment">--*/</span>
00703 
00704 {
00705 
00706     PVOID Entry;
00707 
00708     Lookaside-&gt;L.TotalAllocates += 1;
00709 
00710     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/i386_8h.html#a16">Isx86FeaturePresent</a>(<a class="code" href="../../d5/d3/i386_8h.html#a7">KF_CMPXCHG8B</a>)) {
00711         <span class="keywordflow">if</span> ((Entry = <a class="code" href="../../d5/d8/ex_8h.html#a242">ExInterlockedPopEntrySList</a>(&amp;Lookaside-&gt;L.ListHead,
00712                                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00713 
00714             Lookaside-&gt;L.AllocateMisses += 1;
00715             Entry = (Lookaside-&gt;L.Allocate)(Lookaside-&gt;L.Type,
00716                                             Lookaside-&gt;L.Size,
00717                                             Lookaside-&gt;L.Tag);
00718         }
00719 
00720         <span class="keywordflow">return</span> Entry;
00721     }
00722 
00723     ExAcquireFastMutex(&amp;Lookaside-&gt;Lock);
00724     Entry = PopEntryList(&amp;Lookaside-&gt;L.ListHead.Next);
00725     <span class="keywordflow">if</span> (Entry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00726         ExReleaseFastMutex(&amp;Lookaside-&gt;Lock);
00727         Lookaside-&gt;L.AllocateMisses += 1;
00728         Entry = (Lookaside-&gt;L.Allocate)(Lookaside-&gt;L.Type,
00729                                         Lookaside-&gt;L.Size,
00730                                         Lookaside-&gt;L.Tag);
00731 
00732     } <span class="keywordflow">else</span> {
00733         Lookaside-&gt;L.ListHead.Depth -= 1;
00734         ExReleaseFastMutex(&amp;Lookaside-&gt;Lock);
00735     }
00736 
00737     <span class="keywordflow">return</span> Entry;
00738 }
00739 
00740 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00741"></a><a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a20">00741</a> <a class="code" href="../../d5/d8/ex_8h.html#a253">ExFreeToPagedLookasideList</a>(
00742     IN <a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html">PPAGED_LOOKASIDE_LIST</a> Lookaside,
00743     IN PVOID Entry
00744     )
00745 
00746 <span class="comment">/*++</span>
00747 <span class="comment"></span>
00748 <span class="comment">Routine Description:</span>
00749 <span class="comment"></span>
00750 <span class="comment">    This function inserts (pushes) the specified entry into the specified</span>
00751 <span class="comment">    paged lookaside list.</span>
00752 <span class="comment"></span>
00753 <span class="comment">Arguments:</span>
00754 <span class="comment"></span>
00755 <span class="comment">    Lookaside - Supplies a pointer to a paged lookaside list structure.</span>
00756 <span class="comment"></span>
00757 <span class="comment">    Entry - Supples a pointer to the entry that is inserted in the</span>
00758 <span class="comment">        lookaside list.</span>
00759 <span class="comment"></span>
00760 <span class="comment">Return Value:</span>
00761 <span class="comment"></span>
00762 <span class="comment">    None.</span>
00763 <span class="comment"></span>
00764 <span class="comment">--*/</span>
00765 
00766 {
00767 
00768     Lookaside-&gt;L.TotalFrees += 1;
00769 
00770     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/i386_8h.html#a16">Isx86FeaturePresent</a>(<a class="code" href="../../d5/d3/i386_8h.html#a7">KF_CMPXCHG8B</a>)) {
00771         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/ex_8h.html#a10">ExQueryDepthSList</a>(&amp;Lookaside-&gt;L.ListHead) &gt;= Lookaside-&gt;L.Depth) {
00772             Lookaside-&gt;L.FreeMisses += 1;
00773             (Lookaside-&gt;L.Free)(Entry);
00774 
00775         } <span class="keywordflow">else</span> {
00776             <a class="code" href="../../d5/d8/ex_8h.html#a243">ExInterlockedPushEntrySList</a>(&amp;Lookaside-&gt;L.ListHead,
00777                                         (PSINGLE_LIST_ENTRY)Entry,
00778                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00779         }
00780 
00781         <span class="keywordflow">return</span>;
00782     }
00783 
00784     ExAcquireFastMutex(&amp;Lookaside-&gt;Lock);
00785     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/ex_8h.html#a10">ExQueryDepthSList</a>(&amp;Lookaside-&gt;L.ListHead) &gt;= Lookaside-&gt;L.Depth) {
00786         ExReleaseFastMutex(&amp;Lookaside-&gt;Lock);
00787         Lookaside-&gt;L.FreeMisses += 1;
00788         (Lookaside-&gt;L.Free)(Entry);
00789 
00790     } <span class="keywordflow">else</span> {
00791         PushEntryList(&amp;Lookaside-&gt;L.ListHead.Next, (PSINGLE_LIST_ENTRY)Entry);
00792         Lookaside-&gt;L.ListHead.Depth += 1;
00793         ExReleaseFastMutex(&amp;Lookaside-&gt;Lock);
00794     }
00795 
00796     <span class="keywordflow">return</span>;
00797 }
00798 
00799 <span class="preprocessor">#endif</span>
00800 <span class="preprocessor"></span>
00801 PVOID
<a name="l00802"></a><a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a11">00802</a> <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a11">ExpDummyAllocate</a> (
00803     IN POOL_TYPE PoolType,
00804     IN SIZE_T NumberOfBytes,
00805     IN ULONG Tag
00806     )
00807 
00808 <span class="comment">/*++</span>
00809 <span class="comment"></span>
00810 <span class="comment">Routine Description:</span>
00811 <span class="comment"></span>
00812 <span class="comment">    This function is a dummy allocation routine which is used to empty</span>
00813 <span class="comment">    a lookaside list.</span>
00814 <span class="comment"></span>
00815 <span class="comment">Arguments:</span>
00816 <span class="comment"></span>
00817 <span class="comment">    PoolType - Supplies the type of pool to allocate.</span>
00818 <span class="comment"></span>
00819 <span class="comment">    NumberOfBytes - supplies the number of bytes to allocate.</span>
00820 <span class="comment"></span>
00821 <span class="comment">    Tag - supplies the pool tag.</span>
00822 <span class="comment"></span>
00823 <span class="comment">Return Value:</span>
00824 <span class="comment"></span>
00825 <span class="comment">    NULL is returned as the function value.</span>
00826 <span class="comment"></span>
00827 <span class="comment">--*/</span>
00828 
00829 {
00830 
00831     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00832 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:39 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
