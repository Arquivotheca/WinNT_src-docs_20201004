<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: flushtb.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>flushtb.c</h1><a href="../../d9/d5/ia64_2flushtb_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Module Name:</span>
00004 <span class="comment"></span>
00005 <span class="comment">    flushtb.c</span>
00006 <span class="comment"></span>
00007 <span class="comment">Abstract:</span>
00008 <span class="comment"></span>
00009 <span class="comment">    This module implement machine dependent functions to flush the</span>
00010 <span class="comment">    translation buffer and synchronize PIDs in an MP system.</span>
00011 <span class="comment"></span>
00012 <span class="comment">Author:</span>
00013 <span class="comment"></span>
00014 <span class="comment">    Koichi Yamada 2-Jan-95</span>
00015 <span class="comment"></span>
00016 <span class="comment">Environment:</span>
00017 <span class="comment"></span>
00018 <span class="comment">    Kernel mode only.</span>
00019 <span class="comment"></span>
00020 <span class="comment">Revision History:</span>
00021 <span class="comment"></span>
00022 <span class="comment">--*/</span>
00023 
00024 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00025 <span class="preprocessor">#include "<a class="code" href="../../d2/d1/mm_8h.html">mm.h</a>"</span>
00026 <span class="preprocessor">#include "..\..\mm\mi.h"</span>
00027 
<a name="l00028"></a><a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a7">00028</a> <span class="keyword">extern</span> KSPIN_LOCK <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a7">KiTbBroadcastLock</a>;
<a name="l00029"></a><a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a8">00029</a> <span class="keyword">extern</span> KSPIN_LOCK <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a8">KiMasterRidLock</a>;
00030 
<a name="l00031"></a><a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a0">00031</a> <span class="preprocessor">#define _x256mb (1024*1024*256)</span>
00032 <span class="preprocessor"></span>
00033 <span class="comment">//extern VOID MiCheckPointBreak(VOID);</span>
00034 
<a name="l00035"></a><a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a1">00035</a> <span class="preprocessor">#define KiFlushSingleTbGlobal(Invalid, Va) __ptcga((__int64)Va, PAGE_SHIFT &lt;&lt; 2)</span>
00036 <span class="preprocessor"></span>
<a name="l00037"></a><a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a2">00037</a> <span class="preprocessor">#define KiFlushSingleTbLocal(Invalid, va) __ptcl((__int64)va, PAGE_SHIFT &lt;&lt; 2)</span>
00038 <span class="preprocessor"></span>
<a name="l00039"></a><a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a3">00039</a> <span class="preprocessor">#define KiTbSynchronizeGlobal() { __mf(); __isrlz(); }</span>
00040 <span class="preprocessor"></span>
<a name="l00041"></a><a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a4">00041</a> <span class="preprocessor">#define KiTbSynchronizeLocal() {  __isrlz(); }</span>
00042 <span class="preprocessor"></span>
<a name="l00043"></a><a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a5">00043</a> <span class="preprocessor">#define KiFlush2gbTbGlobal(Invalid) \</span>
00044 <span class="preprocessor">  { \</span>
00045 <span class="preprocessor">    __ptcga((__int64)0, 28 &lt;&lt; 2); \</span>
00046 <span class="preprocessor">    __ptcg((__int64)_x256mb, 28 &lt;&lt; 2); \</span>
00047 <span class="preprocessor">    __ptcg((__int64)_x256mb*2,28 &lt;&lt; 2); \</span>
00048 <span class="preprocessor">    __ptcg((__int64)_x256mb*3, 28 &lt;&lt; 2); \</span>
00049 <span class="preprocessor">    __ptcg((__int64)_x256mb*4, 28 &lt;&lt; 2); \</span>
00050 <span class="preprocessor">    __ptcg((__int64)_x256mb*5, 28 &lt;&lt; 2); \</span>
00051 <span class="preprocessor">    __ptcg((__int64)_x256mb*6, 28 &lt;&lt; 2); \</span>
00052 <span class="preprocessor">    __ptcg((__int64)_x256mb*7, 28 &lt;&lt; 2); \</span>
00053 <span class="preprocessor">  } </span>
00054 <span class="preprocessor"></span>
<a name="l00055"></a><a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a6">00055</a> <span class="preprocessor">#define KiFlush2gbTbLocal(Invalid) \</span>
00056 <span class="preprocessor">  { \</span>
00057 <span class="preprocessor">    __ptcl((__int64)0, 28 &lt;&lt; 2); \</span>
00058 <span class="preprocessor">    __ptcl((__int64)_x256mb, 28 &lt;&lt; 2); \</span>
00059 <span class="preprocessor">    __ptcl((__int64)_x256mb*2,28 &lt;&lt; 2); \</span>
00060 <span class="preprocessor">    __ptcl((__int64)_x256mb*3, 28 &lt;&lt; 2); \</span>
00061 <span class="preprocessor">    __ptcl((__int64)_x256mb*4, 28 &lt;&lt; 2); \</span>
00062 <span class="preprocessor">    __ptcl((__int64)_x256mb*5, 28 &lt;&lt; 2); \</span>
00063 <span class="preprocessor">    __ptcl((__int64)_x256mb*6, 28 &lt;&lt; 2); \</span>
00064 <span class="preprocessor">    __ptcl((__int64)_x256mb*7, 28 &lt;&lt; 2); \</span>
00065 <span class="preprocessor">  } </span>
00066 <span class="preprocessor"></span>
00067 
00068 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00069 <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a9">KiSetProcessRid</a> (
00070     ULONG NewProcessRid
00071 );
00072 
00073 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00074 <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a2">KiSetRegionRegister</a> (
00075     PVOID VirtualAddress,
00076     ULONGLONG Contents
00077     );
00078 
00079 
00080 <span class="comment">//</span>
00081 <span class="comment">// Define forward referenced prototypes.</span>
00082 <span class="comment">//</span>
00083 
00084 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00085 <a class="code" href="../../d4/d1/xxflshtb_8c.html#a0">KiFlushEntireTbTarget</a> (
00086     IN PULONG SignalDone,
00087     IN PVOID Parameter1,
00088     IN PVOID Parameter2,
00089     IN PVOID Parameter3
00090     );
00091 
00092 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00093 <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a12">KiInvalidateForwardProgressTbBuffer</a>(
00094     KAFFINITY TargetProcessors
00095     );
00096 
00097 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00098 <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a13">KiFlushForwardProgressTbBuffer</a>(
00099     KAFFINITY TargetProcessors
00100     );
00101 
00102 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00103 <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a14">KiFlushForwardProgressTbBufferLocal</a>(
00104     VOID
00105     );
00106 
00107 
00108 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00109"></a><a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a15">00109</a> <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (
00110     IN BOOLEAN Invalid,
00111     IN BOOLEAN AllProcessors
00112     )
00113 
00114 <span class="comment">/*++</span>
00115 <span class="comment"></span>
00116 <span class="comment">Routine Description:</span>
00117 <span class="comment"></span>
00118 <span class="comment">    This function flushes the entire translation buffer (TB) on all</span>
00119 <span class="comment">    processors that are currently running threads which are children</span>
00120 <span class="comment">    of the current process or flushes the entire translation buffer</span>
00121 <span class="comment">    on all processors in the host configuration.</span>
00122 <span class="comment"></span>
00123 <span class="comment">Arguments:</span>
00124 <span class="comment"></span>
00125 <span class="comment">    Invalid - Supplies a boolean value that specifies the reason for</span>
00126 <span class="comment">        flushing the translation buffer.</span>
00127 <span class="comment"></span>
00128 <span class="comment">    AllProcessors - Supplies a boolean value that determines which</span>
00129 <span class="comment">        translation buffers are to be flushed.</span>
00130 <span class="comment"></span>
00131 <span class="comment">Return Value:</span>
00132 <span class="comment"></span>
00133 <span class="comment">    None.</span>
00134 <span class="comment"></span>
00135 <span class="comment"></span>
00136 <span class="comment">--*/</span>
00137 
00138 {
00139 
00140     KIRQL OldIrql;
00141     KAFFINITY TargetProcessors;
00142     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00143     BOOLEAN NeedTbFlush = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00144 
00145     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00146 
00147     OldIrql = KeRaiseIrqlToSynchLevel();
00148 
00149 <span class="preprocessor">#if !defined(NT_UP)</span>
00150 <span class="preprocessor"></span>    TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>;
00151     TargetProcessors &amp;= PCR-&gt;NotMember;
00152     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00153         <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00154                         <a class="code" href="../../d7/d5/alpha_2flushtb_8c.html#a0">KiFlushEntireTbTarget</a>,
00155                         (PVOID)NeedTbFlush,
00156                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00157                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00158     }
00159 
00160     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Wow64Process != 0) {
00161         <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a12">KiInvalidateForwardProgressTbBuffer</a>(TargetProcessors);
00162     }
00163 <span class="preprocessor">#endif</span>
00164 <span class="preprocessor"></span>
00165     <a class="code" href="../../d4/d9/ke_8h.html#a374">KeFlushCurrentTb</a>();
00166 
00167     <span class="comment">//</span>
00168     <span class="comment">// Wait until all target processors have finished.</span>
00169     <span class="comment">//</span>
00170 
00171 <span class="preprocessor">#if !defined(NT_UP)</span>
00172 <span class="preprocessor"></span>
00173     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00174         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>(TargetProcessors);
00175     }
00176 
00177 <span class="preprocessor">#endif</span>
00178 <span class="preprocessor"></span>
00179     <span class="comment">//</span>
00180     <span class="comment">// Wait until all target processors have finished.</span>
00181     <span class="comment">//</span>
00182 
00183 <span class="preprocessor">#if defined(NT_UP)</span>
00184 <span class="preprocessor"></span>
00185     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00186 
00187 <span class="preprocessor">#else</span>
00188 <span class="preprocessor"></span>
00189     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00190         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>(TargetProcessors);
00191     }
00192 
00193     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00194 
00195 <span class="preprocessor">#endif</span>
00196 <span class="preprocessor"></span>
00197     <span class="keywordflow">return</span>;
00198 }
00199 
00200 
00201 
00202 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00203"></a><a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a11">00203</a> <a class="code" href="../../d4/d1/xxflshtb_8c.html#a0">KiFlushEntireTbTarget</a> (
00204     IN PULONG SignalDone,
00205     IN PVOID Parameter1,
00206     IN PVOID Parameter2,
00207     IN PVOID Parameter3
00208     )
00209 
00210 <span class="comment">/*++</span>
00211 <span class="comment"></span>
00212 <span class="comment">Routine Description:</span>
00213 <span class="comment"></span>
00214 <span class="comment">    This is the target function for flushing the entire TB.</span>
00215 <span class="comment"></span>
00216 <span class="comment">Arguments:</span>
00217 <span class="comment"></span>
00218 <span class="comment">    SignalDone Supplies a pointer to a variable that is cleared when the</span>
00219 <span class="comment">        requested operation has been performed.</span>
00220 <span class="comment"></span>
00221 <span class="comment">    Parameter1 - Parameter3 - Not used.</span>
00222 <span class="comment"></span>
00223 <span class="comment">Return Value:</span>
00224 <span class="comment"></span>
00225 <span class="comment">    None.</span>
00226 <span class="comment"></span>
00227 <span class="comment">--*/</span>
00228 
00229 {
00230 
00231 <span class="preprocessor">#if !defined(NT_UP)</span>
00232 <span class="preprocessor"></span>
00233     <span class="comment">//</span>
00234     <span class="comment">// Flush the entire TB on the current processor.</span>
00235     <span class="comment">//</span>
00236 
00237     <a class="code" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone</a>(SignalDone);
00238 
00239     <a class="code" href="../../d4/d9/ke_8h.html#a374">KeFlushCurrentTb</a>();
00240 
00241 <span class="preprocessor">#endif</span>
00242 <span class="preprocessor"></span>
00243     <span class="keywordflow">return</span>;
00244 }
00245 
00246 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00247"></a><a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a16">00247</a> <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a1">KeFlushMultipleTb</a> (
00248     IN ULONG Number,
00249     IN PVOID *Virtual,
00250     IN BOOLEAN Invalid,
00251     IN BOOLEAN AllProcessors,
00252     IN PHARDWARE_PTE *PtePointer OPTIONAL,
00253     IN HARDWARE_PTE PteValue
00254     )
00255 
00256 <span class="comment">/*++</span>
00257 <span class="comment"></span>
00258 <span class="comment">Routine Description:</span>
00259 <span class="comment"></span>
00260 <span class="comment">    This function flushes multiple entries from the translation buffer</span>
00261 <span class="comment">    on all processors that are currently running threads which are</span>
00262 <span class="comment">    children of the current process or flushes multiple entries from</span>
00263 <span class="comment">    the translation buffer on all processors in the host configuration.</span>
00264 <span class="comment"></span>
00265 <span class="comment">    N.B. The specified translation entries on all processors in the host</span>
00266 <span class="comment">         configuration are always flushed since PowerPC TB is tagged by</span>
00267 <span class="comment">         VSID and translations are held across context switch boundaries.</span>
00268 <span class="comment"></span>
00269 <span class="comment">Arguments:</span>
00270 <span class="comment"></span>
00271 <span class="comment">    Number - Supplies the number of TB entries to flush.</span>
00272 <span class="comment"></span>
00273 <span class="comment">    Virtual - Supplies a pointer to an array of virtual addresses that</span>
00274 <span class="comment">        are within the pages whose translation buffer entries are to be</span>
00275 <span class="comment">        flushed.</span>
00276 <span class="comment"></span>
00277 <span class="comment">    Invalid - Supplies a boolean value that specifies the reason for</span>
00278 <span class="comment">        flushing the translation buffer.</span>
00279 <span class="comment"></span>
00280 <span class="comment">    AllProcessors - Supplies a boolean value that determines which</span>
00281 <span class="comment">        translation buffers are to be flushed.</span>
00282 <span class="comment"></span>
00283 <span class="comment">    PtePointer - Supplies an optional pointer to an array of pointers to</span>
00284 <span class="comment">       page table entries that receive the specified page table entry</span>
00285 <span class="comment">       value.</span>
00286 <span class="comment"></span>
00287 <span class="comment">    PteValue - Supplies the the new page table entry value.</span>
00288 <span class="comment"></span>
00289 <span class="comment">Return Value:</span>
00290 <span class="comment"></span>
00291 <span class="comment">    None.</span>
00292 <span class="comment"></span>
00293 <span class="comment">--*/</span>
00294 
00295 {
00296 
00297     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00298     PKPRCB Prcb;
00299     KAFFINITY TargetProcessors;
00300     <a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">PWOW64_PROCESS</a> Wow64Process;
00301     KIRQL OldIrql;
00302     BOOLEAN Flush2gb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00303 
00304 <span class="preprocessor">#if 0</span>
00305 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() == <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00306 <span class="preprocessor">#endif</span>
00307 <span class="preprocessor"></span>
00308     OldIrql = KeRaiseIrqlToSynchLevel();
00309 
00310     Wow64Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Wow64Process;
00311 
00312 <span class="preprocessor">#ifdef MI_ALTFLG_FLUSH2G</span>
00313 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((Wow64Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; 
00314         ((Wow64Process-&gt;AltFlags &amp; <a class="code" href="../../d2/d9/miia64_8h.html#a239">MI_ALTFLG_FLUSH2G</a>) != 0)) { 
00315         Flush2gb = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00316     }
00317 <span class="preprocessor">#endif</span>
00318 <span class="preprocessor"></span>
00319     <span class="comment">//</span>
00320     <span class="comment">// If a page table entry address array is specified, then set the</span>
00321     <span class="comment">// specified page table entries to the specific value.</span>
00322     <span class="comment">//</span>
00323 
00324 <span class="preprocessor">#if !defined(NT_UP)</span>
00325 <span class="preprocessor"></span>
00326     TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>;
00327     TargetProcessors &amp;= PCR-&gt;NotMember;
00328 
00329     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00330 
00331         <span class="comment">//</span>
00332         <span class="comment">// Acquire a global lock. Only one processor at a time can issue</span>
00333         <span class="comment">// a PTC.G operation.</span>
00334         <span class="comment">//</span>
00335 
00336         KiAcquireSpinLock(&amp;<a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a7">KiTbBroadcastLock</a>);
00337 
00338         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; Number; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00339             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PtePointer)) {
00340                 *PtePointer[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = PteValue;
00341             }
00342 
00343             <span class="comment">//</span>
00344             <span class="comment">// Flush the specified TB on each processor. Hardware automatically</span>
00345             <span class="comment">// perform broadcasts if MP.</span>
00346             <span class="comment">//</span>
00347 
00348             <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a1">KiFlushSingleTbGlobal</a>(Invalid, <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]);
00349         }
00350 
00351         <span class="keywordflow">if</span> (Wow64Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00352             <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a13">KiFlushForwardProgressTbBuffer</a>(TargetProcessors);
00353         }
00354 
00355         <span class="keywordflow">if</span> (Flush2gb == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00356             <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a5">KiFlush2gbTbGlobal</a>(Invalid);
00357         }
00358 
00359         <span class="comment">//</span>
00360         <span class="comment">// Wait for the broadcast to be complete.</span>
00361         <span class="comment">//</span>
00362 
00363         <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a3">KiTbSynchronizeGlobal</a>();
00364 
00365         KiReleaseSpinLock(&amp;<a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a7">KiTbBroadcastLock</a>);
00366 
00367     }
00368     <span class="keywordflow">else</span> {
00369 
00370         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; Number; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00371             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PtePointer)) {
00372                 *PtePointer[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = PteValue;
00373             }
00374 
00375             <span class="comment">//</span>
00376             <span class="comment">// Flush the specified TB on the local processor.  No broadcast is</span>
00377             <span class="comment">// performed.</span>
00378             <span class="comment">//</span>
00379 
00380             <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a2">KiFlushSingleTbLocal</a>(Invalid, <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]);
00381         }
00382 
00383         <span class="keywordflow">if</span> (Wow64Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00384             <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a14">KiFlushForwardProgressTbBufferLocal</a>();
00385         }
00386 
00387         <span class="keywordflow">if</span> (Flush2gb == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00388             <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a6">KiFlush2gbTbLocal</a>(Invalid);
00389         }
00390 
00391         <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a4">KiTbSynchronizeLocal</a>();
00392     }
00393 
00394 <span class="preprocessor">#else</span>
00395 <span class="preprocessor"></span>    <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; Number; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00396         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PtePointer)) {
00397            *PtePointer[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = PteValue;
00398         }
00399 
00400         <span class="comment">//</span>
00401         <span class="comment">// Flush the specified TB on the local processor.  No broadcast is</span>
00402         <span class="comment">// performed.</span>
00403         <span class="comment">//</span>
00404 
00405         <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a2">KiFlushSingleTbLocal</a>(Invalid, <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]);
00406     }
00407 
00408     <span class="keywordflow">if</span> (Wow64Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00409         <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a14">KiFlushForwardProgressTbBufferLocal</a>();
00410     }
00411 
00412     <span class="keywordflow">if</span> (Flush2gb == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00413         <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a6">KiFlush2gbTbLocal</a>(Invalid);
00414     }
00415 
00416     <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a4">KiTbSynchronizeLocal</a>();
00417 
00418 <span class="preprocessor">#endif</span>
00419 <span class="preprocessor"></span>
00420     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00421 
00422     <span class="keywordflow">return</span>;
00423 }
00424 
00425 
00426 HARDWARE_PTE
<a name="l00427"></a><a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a17">00427</a> <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (
00428     IN PVOID Virtual,
00429     IN BOOLEAN Invalid,
00430     IN BOOLEAN AllProcessors,
00431     IN PHARDWARE_PTE PtePointer,
00432     IN HARDWARE_PTE PteValue
00433     )
00434 
00435 <span class="comment">/*++</span>
00436 <span class="comment"></span>
00437 <span class="comment">Routine Description:</span>
00438 <span class="comment"></span>
00439 <span class="comment">    This function flushes a single entry from the translation buffer</span>
00440 <span class="comment">    on all processors that are currently running threads which are</span>
00441 <span class="comment">    children of the current process or flushes a single entry from</span>
00442 <span class="comment">    the translation buffer on all processors in the host configuration.</span>
00443 <span class="comment"></span>
00444 <span class="comment">    N.B. The specified translation entry on all processors in the host</span>
00445 <span class="comment">         configuration is always flushed since PowerPC TB is tagged by</span>
00446 <span class="comment">         VSID and translations are held across context switch boundaries.</span>
00447 <span class="comment"></span>
00448 <span class="comment">Arguments:</span>
00449 <span class="comment"></span>
00450 <span class="comment">    Virtual - Supplies a virtual address that is within the page whose</span>
00451 <span class="comment">        translation buffer entry is to be flushed.</span>
00452 <span class="comment"></span>
00453 <span class="comment">    Invalid - Supplies a boolean value that specifies the reason for</span>
00454 <span class="comment">        flushing the translation buffer.</span>
00455 <span class="comment"></span>
00456 <span class="comment">    AllProcessors - Supplies a boolean value that determines which</span>
00457 <span class="comment">        translation buffers are to be flushed.</span>
00458 <span class="comment"></span>
00459 <span class="comment">    PtePointer - Supplies a pointer to the page table entry which</span>
00460 <span class="comment">        receives the specified value.</span>
00461 <span class="comment"></span>
00462 <span class="comment">    PteValue - Supplies the the new page table entry value.</span>
00463 <span class="comment"></span>
00464 <span class="comment">Return Value:</span>
00465 <span class="comment"></span>
00466 <span class="comment">    The previous contents of the specified page table entry is returned</span>
00467 <span class="comment">    as the function value.</span>
00468 <span class="comment"></span>
00469 <span class="comment">--*/</span>
00470 
00471 {
00472 
00473     HARDWARE_PTE OldPte;
00474     PKPRCB Prcb;
00475     KAFFINITY TargetProcessors;
00476     <a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">PWOW64_PROCESS</a> Wow64Process;
00477     KIRQL OldIrql;
00478     BOOLEAN Flush2gb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00479 
00480 <span class="preprocessor">#if 0</span>
00481 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() == <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00482 <span class="preprocessor">#endif</span>
00483 <span class="preprocessor"></span>
00484     <span class="comment">//</span>
00485     <span class="comment">// Compute the target set of processors.</span>
00486     <span class="comment">//</span>
00487 
00488     OldIrql = KeRaiseIrqlToSynchLevel();
00489 
00490     <span class="comment">//</span>
00491     <span class="comment">// Check to see if it is the Wow64 process</span>
00492     <span class="comment">//</span>
00493 
00494     Wow64Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Wow64Process;
00495 
00496 <span class="preprocessor">#ifdef MI_ALTFLG_FLUSH2G</span>
00497 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((Wow64Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; 
00498         ((Wow64Process-&gt;AltFlags &amp; <a class="code" href="../../d2/d9/miia64_8h.html#a239">MI_ALTFLG_FLUSH2G</a>) != 0)) { 
00499         Flush2gb = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00500     }
00501 <span class="preprocessor">#endif</span>
00502 <span class="preprocessor"></span>
00503     <span class="comment">//</span>
00504     <span class="comment">// Capture the previous contents of the page table entry and set the</span>
00505     <span class="comment">// page table entry to the new value.</span>
00506     <span class="comment">//</span>
00507 
00508     OldPte = *PtePointer;
00509     *PtePointer = PteValue;
00510 
00511 <span class="preprocessor">#if !defined(NT_UP)</span>
00512 <span class="preprocessor"></span>
00513     TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>;
00514     TargetProcessors &amp;= PCR-&gt;NotMember;
00515 
00516     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00517 
00518         <span class="comment">//</span>
00519         <span class="comment">// Flush the specified TB on each processor. Hardware automatically</span>
00520         <span class="comment">// perform broadcasts if MP.</span>
00521         <span class="comment">//</span>
00522 
00523         KiAcquireSpinLock(&amp;<a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a7">KiTbBroadcastLock</a>);
00524 
00525         <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a1">KiFlushSingleTbGlobal</a>(Invalid, <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>);
00526 
00527         <span class="keywordflow">if</span> (Wow64Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00528             <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a13">KiFlushForwardProgressTbBuffer</a>(TargetProcessors);
00529         }
00530 
00531         <span class="keywordflow">if</span> (Flush2gb) {
00532             <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a5">KiFlush2gbTbGlobal</a>(Invalid);
00533         }
00534 
00535         <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a3">KiTbSynchronizeGlobal</a>();
00536 
00537         KiReleaseSpinLock(&amp;<a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a7">KiTbBroadcastLock</a>);
00538 
00539     }
00540     <span class="keywordflow">else</span> {
00541 
00542         <span class="comment">//</span>
00543         <span class="comment">// Flush the specified TB on the local processor.  No broadcast is</span>
00544         <span class="comment">// performed.</span>
00545         <span class="comment">//</span>
00546         
00547         <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a2">KiFlushSingleTbLocal</a>(Invalid, <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>);
00548 
00549         <span class="keywordflow">if</span> (Wow64Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00550             <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a14">KiFlushForwardProgressTbBufferLocal</a>();
00551         }
00552 
00553         <span class="keywordflow">if</span> (Flush2gb == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) { 
00554             <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a6">KiFlush2gbTbLocal</a>(Invalid);
00555         } 
00556 
00557         <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a4">KiTbSynchronizeLocal</a>();
00558 
00559     }
00560 
00561 <span class="preprocessor">#else</span>
00562 <span class="preprocessor"></span>
00563     <span class="comment">//</span>
00564     <span class="comment">// Flush the specified entry from the TB on the local processor.</span>
00565     <span class="comment">//</span>
00566 
00567     <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a2">KiFlushSingleTbLocal</a>(Invalid, <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>);
00568 
00569     <span class="keywordflow">if</span> (Wow64Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00570         <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a14">KiFlushForwardProgressTbBufferLocal</a>();
00571     }
00572 
00573     <span class="keywordflow">if</span> (Flush2gb == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) { 
00574         <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a6">KiFlush2gbTbLocal</a>(Invalid);
00575     }
00576 
00577     <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a4">KiTbSynchronizeLocal</a>();
00578 
00579 <span class="preprocessor">#endif</span>
00580 <span class="preprocessor"></span>
00581     <span class="comment">//</span>
00582     <span class="comment">// Wait until all target processors have finished.</span>
00583     <span class="comment">//</span>
00584 
00585     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00586 
00587     <span class="comment">//</span>
00588     <span class="comment">// Return the previous page table entry value.</span>
00589     <span class="comment">//</span>
00590 
00591     <span class="keywordflow">return</span> OldPte;
00592 }
00593 
00594 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00595"></a><a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a12">00595</a> <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a12">KiInvalidateForwardProgressTbBuffer</a>(
00596     KAFFINITY TargetProcessors
00597     )
00598 {
00599     PKPRCB Prcb;
00600     ULONG BitNumber;
00601     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> CurrentProcess;
00602     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> TargetProcess;
00603     PKPCR Pcr;
00604     ULONG i;
00605 
00606     CurrentProcess = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ApcState.Process;
00607 
00608     <span class="comment">//</span>
00609     <span class="comment">// Invalidate the ForwardProgressTb buffer on the current processor</span>
00610     <span class="comment">//</span>
00611 
00612     <span class="keywordflow">for</span> (i = 0; i &lt; MAXIMUM_FWP_BUFFER_ENTRY; i += 1) {
00613         
00614         PCR-&gt;ForwardProgressBuffer[(i*2)+1] = 0;
00615 
00616     }
00617 
00618     <span class="comment">//</span>
00619     <span class="comment">// Invalidate the ForwardProgressTb buffer on all the other processors</span>
00620     <span class="comment">//</span>
00621 
00622     <span class="keywordflow">while</span> (TargetProcessors != 0) {
00623 
00624         BitNumber = <a class="code" href="../../d4/d9/ke_8h.html#a39">KeFindFirstSetRightMember</a>(TargetProcessors);
00625         <a class="code" href="../../d0/d0/ki_8h.html#a6">ClearMember</a>(BitNumber, TargetProcessors);
00626         Prcb = <a class="code" href="../../d4/d9/ke_8h.html#a139">KiProcessorBlock</a>[BitNumber];
00627 
00628         Pcr = KSEG_ADDRESS(Prcb-&gt;PcrPage);
00629         
00630         TargetProcess = Pcr-&gt;CurrentThread-&gt;ApcState.Process;
00631 
00632         <span class="keywordflow">if</span> (TargetProcess == CurrentProcess) {
00633 
00634             <span class="keywordflow">for</span> (i = 0; i &lt; MAXIMUM_FWP_BUFFER_ENTRY; i += 1) {
00635                 
00636                 Pcr-&gt;ForwardProgressBuffer[(i*2)+1] = 0;
00637 
00638             }
00639         }
00640     }
00641 }
00642 
00643 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00644"></a><a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a13">00644</a> <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a13">KiFlushForwardProgressTbBuffer</a>(
00645     KAFFINITY TargetProcessors
00646     )
00647 {
00648     PKPRCB Prcb;
00649     ULONG BitNumber;
00650     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> CurrentProcess;
00651     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> TargetProcess;
00652     PKPCR Pcr;
00653     ULONG i;
00654     PVOID Va;
00655     <span class="keyword">volatile</span> ULONGLONG *PointerPte;
00656 
00657     CurrentProcess = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ApcState.Process;
00658 
00659     <span class="comment">//</span>
00660     <span class="comment">// Flush the ForwardProgressTb buffer on the current processor</span>
00661     <span class="comment">//</span>
00662 
00663     <span class="keywordflow">for</span> (i = 0; i &lt; MAXIMUM_FWP_BUFFER_ENTRY; i += 1) {
00664         
00665         Va = (PVOID)PCR-&gt;ForwardProgressBuffer[i*2]; 
00666         PointerPte = &amp;PCR-&gt;ForwardProgressBuffer[(i*2)+1];
00667 
00668         <span class="keywordflow">if</span> (*PointerPte != 0) {
00669             *PointerPte = 0;
00670             <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a1">KiFlushSingleTbGlobal</a>(Invalid, Va);
00671         }
00672 
00673     }
00674 
00675     <span class="comment">//</span>
00676     <span class="comment">// Flush the ForwardProgressTb buffer on all the processors</span>
00677     <span class="comment">//</span>
00678         
00679     <span class="keywordflow">while</span> (TargetProcessors != 0) {
00680 
00681         BitNumber = <a class="code" href="../../d4/d9/ke_8h.html#a39">KeFindFirstSetRightMember</a>(TargetProcessors);
00682         <a class="code" href="../../d0/d0/ki_8h.html#a6">ClearMember</a>(BitNumber, TargetProcessors);
00683         Prcb = <a class="code" href="../../d4/d9/ke_8h.html#a139">KiProcessorBlock</a>[BitNumber];
00684 
00685         Pcr = KSEG_ADDRESS(Prcb-&gt;PcrPage);
00686         
00687         TargetProcess = Pcr-&gt;CurrentThread-&gt;ApcState.Process;
00688 
00689         <span class="keywordflow">if</span> (TargetProcess == CurrentProcess) {
00690 
00691             <span class="keywordflow">for</span> (i = 0; i &lt; MAXIMUM_FWP_BUFFER_ENTRY; i += 1) {
00692                 
00693                 Va = (PVOID)Pcr-&gt;ForwardProgressBuffer[i*2]; 
00694                 PointerPte = &amp;Pcr-&gt;ForwardProgressBuffer[(i*2)+1];
00695 
00696                 <span class="keywordflow">if</span> (*PointerPte != 0) {
00697                     *PointerPte = 0;
00698                     <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a1">KiFlushSingleTbGlobal</a>(Invalid, Va);
00699                 }
00700             }
00701         }
00702     }
00703 }
00704 
00705 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00706"></a><a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a14">00706</a> <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a14">KiFlushForwardProgressTbBufferLocal</a>(
00707     VOID
00708     )
00709 {
00710     ULONG i;
00711     PVOID Va;
00712     <span class="keyword">volatile</span> ULONGLONG *PointerPte;
00713 
00714     <span class="comment">//</span>
00715     <span class="comment">// Flush the ForwardProgressTb buffer on the current processor</span>
00716     <span class="comment">//</span>
00717 
00718     <span class="keywordflow">for</span> (i = 0; i &lt; MAXIMUM_FWP_BUFFER_ENTRY; i += 1) {
00719         
00720         Va = (PVOID)PCR-&gt;ForwardProgressBuffer[i*2]; 
00721         PointerPte = &amp;PCR-&gt;ForwardProgressBuffer[(i*2)+1];
00722 
00723         <span class="keywordflow">if</span> (*PointerPte != 0) {
00724             *PointerPte = 0;
00725             <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a2">KiFlushSingleTbLocal</a>(Invalid, Va);
00726         }
00727 
00728     }
00729 }
00730 
00731 
00732 ULONG
<a name="l00733"></a><a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a18">00733</a> <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a18">KiGetNewRid</a> (
00734     IN PULONG ProcessNewRid,
00735     IN PULONGLONG ProcessNewSequence
00736     )
00737 
00738 <span class="comment">/*++</span>
00739 <span class="comment"></span>
00740 <span class="comment"> Routine Description:</span>
00741 <span class="comment"></span>
00742 <span class="comment">    Generate a new region id. If the region id wraps then the TBs of</span>
00743 <span class="comment">    all the processors need to be flushed.</span>
00744 <span class="comment"></span>
00745 <span class="comment"> Arguments:</span>
00746 <span class="comment"></span>
00747 <span class="comment">    ProcessNewRid (a0) - Supplies a pointer to rid of new process (64-bit).</span>
00748 <span class="comment"></span>
00749 <span class="comment">    ProcessNewSeqNum (a1) - Pointer to new process sequence number (64-bit).</span>
00750 <span class="comment"></span>
00751 <span class="comment"> Return Value:</span>
00752 <span class="comment"></span>
00753 <span class="comment">    New rid value</span>
00754 <span class="comment"></span>
00755 <span class="comment"> Notes:</span>
00756 <span class="comment"></span>
00757 <span class="comment">    This routine called by KiSwapProcess only.</span>
00758 <span class="comment"></span>
00759 <span class="comment"> Environment:</span>
00760 <span class="comment"></span>
00761 <span class="comment">    Kernel mode.</span>
00762 <span class="comment">    KiLockDispaterLock or LockQueuedDispatcherLock is held</span>
00763 <span class="comment"></span>
00764 <span class="comment">--*/</span>
00765 
00766 {
00767 
00768     ULONG NewRid;
00769     KAFFINITY TargetProcessors;
00770 
00771     KiMasterRid += 1;
00772 
00773     <span class="keywordflow">if</span> (KiMasterRid &lt;= MAXIMUM_RID) {
00774 
00775         <span class="comment">//</span>
00776         <span class="comment">// Update Process-&gt;ProcessRid and Process-&gt;ProcessSequence.</span>
00777         <span class="comment">//</span>
00778 
00779         *ProcessNewRid = KiMasterRid;
00780         *ProcessNewSequence = KiMasterSequence;
00781 
00782         <span class="keywordflow">return</span> (*ProcessNewRid);
00783     }
00784 
00785     <span class="comment">//</span>
00786     <span class="comment">// Region ID must be recycled.</span>
00787     <span class="comment">//</span>
00788 
00789 
00790     KiMasterRid = START_PROCESS_RID;
00791 
00792     KiMasterSequence += 1;
00793 
00794     <span class="keywordflow">if</span> (KiMasterSequence &gt; MAXIMUM_SEQUENCE) {
00795 
00796         KiMasterSequence = START_SEQUENCE;
00797 
00798     }
00799 
00800     <span class="comment">//</span>
00801     <span class="comment">// Update new process's ProcessRid and ProcessSequence.</span>
00802     <span class="comment">//</span>
00803 
00804     *ProcessNewRid = KiMasterRid;
00805     *ProcessNewSequence = KiMasterSequence;
00806 
00807 <span class="preprocessor">#if !defined(NT_UP)</span>
00808 <span class="preprocessor"></span>
00809     <span class="comment">//</span>
00810     <span class="comment">// Broadcast TB flush.</span>
00811     <span class="comment">//</span>
00812 
00813     TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>;
00814     TargetProcessors &amp;= PCR-&gt;NotMember;
00815     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00816         <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00817                         <a class="code" href="../../d7/d5/alpha_2flushtb_8c.html#a0">KiFlushEntireTbTarget</a>,
00818                         (PVOID)<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00819                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00820                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00821     }
00822 
00823 <span class="preprocessor">#endif</span>
00824 <span class="preprocessor"></span>
00825     <a class="code" href="../../d4/d9/ke_8h.html#a374">KeFlushCurrentTb</a>();
00826 
00827 
00828 <span class="preprocessor">#if !defined(NT_UP)</span>
00829 <span class="preprocessor"></span>
00830     <span class="comment">//</span>
00831     <span class="comment">// Wait until all target processors have finished.</span>
00832     <span class="comment">//</span>
00833 
00834     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00835         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>(TargetProcessors);
00836     }
00837 
00838 <span class="preprocessor">#endif</span>
00839 <span class="preprocessor"></span>
00840     <span class="keywordflow">return</span> *ProcessNewRid;
00841 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:02 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
