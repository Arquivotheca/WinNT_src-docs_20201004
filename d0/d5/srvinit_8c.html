<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: srvinit.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>srvinit.c File Reference</h1><code>#include "<a class="el" href="../../d7/d2/w32_2ntcon_2server_2precomp_8h-source.html">precomp.h</a>"</code><br>

<p>
<a href="../../d1/d4/srvinit_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a0">SYSTEM_ROOT</a>&nbsp;&nbsp;&nbsp;(L"%SystemRoot%")</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a1">SYSTEM_ROOT_LENGTH</a>&nbsp;&nbsp;&nbsp;(sizeof(SYSTEM_ROOT) - sizeof(WCHAR))</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a22">UnregisterVDM</a> (IN <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a23">NonConsoleProcessShutdown</a> (PCSR_PROCESS Process, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="el" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a24">ConsoleClientShutdown</a> (PCSR_PROCESS Process, ULONG Flags, BOOLEAN fFirstPass)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a25">ConsoleClientConnectRoutine</a> (IN PCSR_PROCESS Process, IN OUT PVOID ConnectionInfo, IN OUT PULONG ConnectionInfoLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a26">ConsoleClientDisconnectRoutine</a> (IN PCSR_PROCESS Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a27">ConsolePlaySound</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a28">LoadLinkInfo</a> (<a class="el" href="../../d0/d3/struct__CONSOLE__INFO.html">PCONSOLE_INFO</a> ConsoleInfo, LPWSTR Title, LPDWORD TitleLength, LPWSTR CurDir, LPWSTR AppName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a29">InitWindowClass</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a30">InitWindowsStuff</a> (HDESK hdesk, LPDWORD lpdwThreadId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS APIPRIVATE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a31">ConServerDllInitialization</a> (PCSR_SERVER_DLL LoadedServerDll)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a32">MapHandle</a> (IN HANDLE ClientProcessHandle, IN HANDLE ServerHandle, OUT PHANDLE ClientHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a33">AddProcessToList</a> (IN OUT <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console, IN OUT <a class="el" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">PCONSOLE_PROCESS_HANDLE</a> ProcessHandleRecord, IN HANDLE ProcessHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">PCONSOLE_PROCESS_HANDLE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a34">FindProcessInList</a> (IN <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console, IN HANDLE ProcessHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a35">RemoveProcessFromList</a> (IN OUT <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console, IN HANDLE ProcessHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a36">SetUpConsole</a> (IN OUT <a class="el" href="../../d0/d3/struct__CONSOLE__INFO.html">PCONSOLE_INFO</a> ConsoleInfo, IN <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> TitleLength, IN LPWSTR Title, IN LPWSTR CurDir, IN LPWSTR AppName, IN <a class="el" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData, IN BOOLEAN WindowVisible, IN PUNICODE_STRING pstrDesktopName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a37">RemoveConsole</a> (IN <a class="el" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData, IN HANDLE ProcessHandle, IN HANDLE ProcessId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a38">SrvAllocConsole</a> (IN OUT PCSR_API_MSG m, IN OUT PCSR_REPLY_STATUS ReplyStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a39">SrvFreeConsole</a> (IN OUT PCSR_API_MSG m, IN OUT PCSR_REPLY_STATUS ReplyStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a40">MyRegOpenKey</a> (IN HANDLE hKey, IN LPWSTR lpSubKey, OUT PHANDLE phResult)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a> (IN HANDLE hKey, IN LPWSTR lpValueName, IN <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwValueLength, OUT LPBYTE lpData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LPWSTR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a42">TranslateConsoleTitle</a> (LPWSTR ConsoleTitle, <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a22">PUSHORT</a> pcbTranslatedTitle, BOOL Unexpand, BOOL Substitute)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a43">InitializeConsoleAttributes</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a44">GetRegistryValues</a> (IN LPWSTR ConsoleTitle, OUT <a class="el" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html">PCONSOLE_REGISTRY_INFO</a> RegInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a45">GetConsoleLangId</a> (IN UINT OutputCP, OUT LANGID *pLangId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a46">SrvGetConsoleLangId</a> (IN OUT PCSR_API_MSG m, IN OUT PCSR_REPLY_STATUS ReplyStatus)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>CONST PCSR_API_ROUTINE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a2">ConsoleServerApiDispatchTable</a> [ConsolepMaxApiNumber-ConsolepOpenConsole]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>CONST BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a3">ConsoleServerApiServerValidTable</a> [ConsolepMaxApiNumber-ConsolepOpenConsole]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a4">FullScreenInitialized</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>CRITICAL_SECTION&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a5">ConsoleVDMCriticalSection</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a6">ConsoleVDMOnSwitching</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>CRITICAL_SECTION&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a7">ConsoleInitWindowsLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a8">fOneTimeInitialized</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UINT&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a9">OEMCP</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UINT&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a10">WINDOWSCP</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UINT&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a11">ConsoleOutputCP</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html">CONSOLE_REGISTRY_INFO</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a12">DefaultRegInfo</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HANDLE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a13">ghInstance</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HICON&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a14">ghDefaultIcon</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HICON&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a15">ghDefaultSmIcon</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HCURSOR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a16">ghNormalCursor</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PWIN32HEAP&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a17">pConHeap</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a18">dwConBaseTag</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a19">gExtendedEditKey</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a20">gfTrimLeadingZeros</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/srvinit_8c.html#a21">gfLoadConIme</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="srvinit.c::SYSTEM_ROOT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SYSTEM_ROOT&nbsp;&nbsp;&nbsp;(L"%SystemRoot%")          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01827">1827</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01831">TranslateConsoleTitle()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="srvinit.c::SYSTEM_ROOT_LENGTH" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SYSTEM_ROOT_LENGTH&nbsp;&nbsp;&nbsp;(sizeof(SYSTEM_ROOT) - sizeof(WCHAR))          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01828">1828</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01831">TranslateConsoleTitle()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a33" doxytag="srvinit.c::AddProcessToList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID AddProcessToList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Console</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">PCONSOLE_PROCESS_HANDLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandleRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00895">895</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00087">CONSOLE_HAS_FOCUS</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00100">CONSOLE_SHUTTING_DOWN</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00097">CONSOLE_TERMINATING</a>, and <a class="el" href="../../d7/d1/output_8c-source.html#l04200">SetProcessFocus()</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00705">ConsoleAddProcessRoutine()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01091">ConsoleClientConnectRoutine()</a>, and <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01537">SrvAllocConsole()</a>.
<p>
<pre class="fragment"><div>00900 {
00901     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(Console-&gt;Flags &amp; (CONSOLE_TERMINATING | CONSOLE_SHUTTING_DOWN)));
00902 
00903     ProcessHandleRecord-&gt;ProcessHandle = ProcessHandle;
00904     ProcessHandleRecord-&gt;TerminateCount = 0;
00905     InsertHeadList(&amp;Console-&gt;ProcessHandleList,&amp;ProcessHandleRecord-&gt;ListLink);
00906 
00907     <a class="code" href="../../d6/d2/output_8c.html#a72">SetProcessFocus</a>(ProcessHandleRecord-&gt;Process, Console-&gt;Flags &amp; CONSOLE_HAS_FOCUS);
00908 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="srvinit.c::ConServerDllInitialization" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS APIPRIVATE ConServerDllInitialization           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PCSR_SERVER_DLL&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LoadedServerDll</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00737">737</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
References <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00705">ConsoleAddProcessRoutine()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01091">ConsoleClientConnectRoutine()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01482">ConsoleClientDisconnectRoutine()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01912">ConsoleClientShutdown()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00300">ConsoleInitWindowsLock</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00051">ConsoleOutputCP</a>, <a class="el" href="../../d5/d5/conmsg_8h.html#a236a235">ConsolepMaxApiNumber</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00026">ConsoleServerApiDispatchTable</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00115">ConsoleServerApiServerValidTable</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00040">ConsoleVDMCriticalSection</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00041">ConsoleVDMOnSwitching</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00138">DBG</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00165">dwConBaseTag</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00027">ghInstance</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00062">gInputThreadMsgLock</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00057">InitializeConsoleHandleTable()</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l00109">InitializeFonts()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l01829">InitializeThreadMessages()</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00043">InputThreadTlsIndex</a>, <a class="el" href="../../d0/d3/dbcs_8h.html#a46">IsAvailableFarEastCodePage()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00025">OEMCP</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00164">pConHeap</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01266">RtlInitializeCriticalSectionAndSpinCount()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00026">WINDOWSCP</a>.
<p>
<pre class="fragment"><div>00743                    :
00744 
00745     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server dll.  It initializes
00746     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> console handle table.
00747 
00748 Arguments:
00749 
00750     LoadedServerDll - Pointer to console server dll data
00751 
00752 Return Value:
00753 
00754 --*/
00755 
00756 {
00757     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00758 
00759     LoadedServerDll-&gt;ApiNumberBase = CONSRV_FIRST_API_NUMBER;
00760     LoadedServerDll-&gt;MaxApiNumber = <a class="code" href="../../d5/d5/conmsg_8h.html#a236a235">ConsolepMaxApiNumber</a>;
00761     LoadedServerDll-&gt;ApiDispatchTable = (PCSR_API_ROUTINE *)<a class="code" href="../../d0/d5/srvinit_8c.html#a2">ConsoleServerApiDispatchTable</a>;
00762     LoadedServerDll-&gt;ApiServerValidTable = (PBOOLEAN)<a class="code" href="../../d0/d5/srvinit_8c.html#a3">ConsoleServerApiServerValidTable</a>;
00763 <span class="preprocessor">#if DBG</span>
00764 <span class="preprocessor"></span>    LoadedServerDll-&gt;ApiNameTable = ConsoleServerApiNameTable;
00765 <span class="preprocessor">#else</span>
00766 <span class="preprocessor"></span>    LoadedServerDll-&gt;ApiNameTable = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00767 <span class="preprocessor">#endif</span>
00768 <span class="preprocessor"></span>    LoadedServerDll-&gt;PerProcessDataLength = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">CONSOLE_PER_PROCESS_DATA</a>);
00769     LoadedServerDll-&gt;ConnectRoutine = <a class="code" href="../../d0/d5/srvinit_8c.html#a25">ConsoleClientConnectRoutine</a>;
00770     LoadedServerDll-&gt;DisconnectRoutine = <a class="code" href="../../d0/d5/srvinit_8c.html#a26">ConsoleClientDisconnectRoutine</a>;
00771     LoadedServerDll-&gt;AddProcessRoutine = <a class="code" href="../../d8/d5/consrv_8h.html#a69">ConsoleAddProcessRoutine</a>;
00772     LoadedServerDll-&gt;ShutdownProcessRoutine = <a class="code" href="../../d0/d5/srvinit_8c.html#a24">ConsoleClientShutdown</a>;
00773 
00774     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a4">ghInstance</a> = LoadedServerDll-&gt;ModuleHandle;
00775 
00776     <span class="comment">// initialize data structures</span>
00777 
00778     InitWin32HeapStubs();
00779 
00780     <a class="code" href="../../d8/d5/consrv_8h.html#a59">pConHeap</a> = Win32HeapCreate(
00781                               <span class="stringliteral">"CH_Head"</span>,
00782                               <span class="stringliteral">"CH_Tail"</span>,
00783                               HEAP_GROWABLE | HEAP_CLASS_5 |
00784 #<span class="keywordflow">if</span> DBG
00785                               HEAP_TAIL_CHECKING_ENABLED,
00786 #<span class="keywordflow">else</span>
00787                               0,
00788 #endif
00789                               NULL,             <span class="comment">// HeapBase</span>
00790                               64 * 1024,        <span class="comment">// ReserveSize</span>
00791                               4096,             <span class="comment">// CommitSize</span>
00792                               NULL,             <span class="comment">// Lock to use for serialization</span>
00793                               NULL);            <span class="comment">// GrowthThreshold</span>
00794 
00795     <span class="comment">// pConHeap = RtlProcessHeap();</span>
00796 
00797     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a59">pConHeap</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00798         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00799     }
00800 
00801     <a class="code" href="../../d8/d5/consrv_8h.html#a60">dwConBaseTag</a> = Win32HeapCreateTag( pConHeap,
00802                                      0,
00803                                      L<span class="stringliteral">"CON!"</span>,
00804                                      L<span class="stringliteral">"TMP\0"</span>
00805                                      L<span class="stringliteral">"BMP\0"</span>
00806                                      L<span class="stringliteral">"ALIAS\0"</span>
00807                                      L<span class="stringliteral">"HISTORY\0"</span>
00808                                      L<span class="stringliteral">"TITLE\0"</span>
00809                                      L<span class="stringliteral">"HANDLE\0"</span>
00810                                      L<span class="stringliteral">"CONSOLE\0"</span>
00811                                      L<span class="stringliteral">"ICON\0"</span>
00812                                      L<span class="stringliteral">"BUFFER\0"</span>
00813                                      L<span class="stringliteral">"WAIT\0"</span>
00814                                      L<span class="stringliteral">"FONT\0"</span>
00815                                      L<span class="stringliteral">"SCREEN\0"</span>
00816 #<span class="keywordflow">if</span> defined(FE_SB)
00817                                      L<span class="stringliteral">"TMP DBCS\0"</span>
00818                                      L<span class="stringliteral">"SCREEN DBCS\0"</span>
00819                                      L<span class="stringliteral">"EUDC\0"</span>
00820                                      L<span class="stringliteral">"CONVAREA\0"</span>
00821                                      L<span class="stringliteral">"IME\0"</span>
00822 #endif
00823                                    );
00824     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a10">InitializeConsoleHandleTable</a>();
00825     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00826         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00827     }
00828 
00829     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a26">RtlInitializeCriticalSectionAndSpinCount</a>(&amp;ConsoleInitWindowsLock,
00830                                                       0x80000000);
00831     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00832         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00833     }
00834 
00835     <span class="comment">//</span>
00836     <span class="comment">// Initialize Input thread local message queue</span>
00837     <span class="comment">//</span>
00838     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a26">RtlInitializeCriticalSectionAndSpinCount</a>(&amp;gInputThreadMsgLock,
00839                                                       0x80000000);
00840     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00841         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00842     }
00843 
00844     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a37">InitializeThreadMessages</a>();
00845 
00846 <span class="preprocessor">#ifdef i386</span>
00847 <span class="preprocessor"></span>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a26">RtlInitializeCriticalSectionAndSpinCount</a>(&amp;ConsoleVDMCriticalSection,
00848                                                       0x80000000);
00849     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00850         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00851     }
00852     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a14">ConsoleVDMOnSwitching</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00853 <span class="preprocessor">#endif</span>
00854 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a> = GetOEMCP();
00855     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a3">WINDOWSCP</a> = GetACP();
00856 <span class="preprocessor">#if !defined(FE_SB)</span>
00857 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a22">ConsoleOutputCP</a> = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>;
00858 <span class="preprocessor">#endif</span>
00859 <span class="preprocessor"></span>
00860     <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a21">InitializeFonts</a>();
00861 
00862     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a15">InputThreadTlsIndex</a> = TlsAlloc();
00863     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a15">InputThreadTlsIndex</a> == 0xFFFFFFFF)
00864         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00865 
00866 <span class="preprocessor">#if defined(FE_SB)</span>
00867 <span class="preprocessor"></span>    gfIsDBCSACP = !!<a class="code" href="../../d0/d3/dbcs_8h.html#a46">IsAvailableFarEastCodePage</a>(WINDOWSCP);
00868 <span class="preprocessor">#endif</span>
00869 <span class="preprocessor"></span>
00870     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00871 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="srvinit.c::ConsoleClientConnectRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ConsoleClientConnectRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCSR_PROCESS&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ConnectionInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ConnectionInfoLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01091">1091</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
References <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00895">AddProcessToList()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l01683">AllocateCommandHistory()</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00103">_CONSOLE_API_CONNECTINFO::AppName</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00102">_CONSOLE_API_CONNECTINFO::AppNameLength</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00380">CONSOLE_CLIENTPROCESSHANDLE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00383">CONSOLE_CLIENTPROCESSID</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00389">CONSOLE_FROMPROCESSPERPROCESSDATA</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00399">CONSOLE_GETCONSOLEAPPFROMPROCESSDATA</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00087">CONSOLE_HAS_FOCUS</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00401">CONSOLE_SETCONSOLEAPPFROMPROCESSDATA</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00100">CONSOLE_SHUTTING_DOWN</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00089">_CONSOLE_API_CONNECTINFO::ConsoleApp</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00322">_CONSOLE_PER_PROCESS_DATA::ConsoleHandle</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00042">_CONSOLE_INFO::ConsoleHandle</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00180">ConsoleHeapAlloc</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00193">ConsoleHeapFree</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00036">ConsoleIMERoutine</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00088">_CONSOLE_API_CONNECTINFO::ConsoleInfo</a>, <a class="el" href="../../d6/d3/server_2msgbeep_8c-source.html#l00025">ConsolePlaySound()</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00050">_CONSOLE_PROCESS_HANDLE::CtrlRoutine</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00091">_CONSOLE_API_CONNECTINFO::CtrlRoutine</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00033">CtrlRoutine</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00105">_CONSOLE_API_CONNECTINFO::CurDir</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00104">_CONSOLE_API_CONNECTINFO::CurDirLength</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00101">_CONSOLE_API_CONNECTINFO::Desktop</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00100">_CONSOLE_API_CONNECTINFO::DesktopLength</a>, <a class="el" href="../../d2/d9/tdisp_8c-source.html#l00009">ErrorExit()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00911">FindProcessInList()</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00164">_CONSOLE_INFORMATION::Flags</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00067">HANDLE_TAG</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00135">_CONSOLE_INFORMATION::hWinSta</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00047">_CONSOLE_INFO::InitEvents</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00146">_CONSOLE_INFORMATION::InitEvents</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00034">INITIALIZATION_FAILED</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00033">INITIALIZATION_SUCCEEDED</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00132">_CONSOLE_INFORMATION::InputBuffer</a>, <a class="el" href="../../d0/d3/input_8h-source.html#l00037">_INPUT_INFORMATION::InputWaitEvent</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00043">_CONSOLE_INFO::InputWaitHandle</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00874">MapHandle()</a>, <a class="el" href="../../d3/d2/tnlsxlat_8c-source.html#l00026">NELEM</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00102">NtReadVirtualMemory()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l00870">NtUserConsoleControl()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d5/conmsg_8h.html#a16">PCONSOLE_API_CONNECTINFO</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00048">_CONSOLE_PROCESS_HANDLE::Process</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00092">_CONSOLE_API_CONNECTINFO::PropRoutine</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00051">_CONSOLE_PROCESS_HANDLE::PropRoutine</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01355">RemoveConsole()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01686">RevalidateConsole()</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00328">_CONSOLE_PER_PROCESS_DATA::RootProcess</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l04213">SetProcessForegroundRights()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00955">SetUpConsole()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00099">_CONSOLE_API_CONNECTINFO::Title</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00098">_CONSOLE_API_CONNECTINFO::TitleLength</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00062">TMP_TAG</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00090">_CONSOLE_API_CONNECTINFO::WindowVisible</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00737">ConServerDllInitialization()</a>.
<p>
<pre class="fragment"><div>01099                    :
01100 
01101     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when a <span class="keyword">new</span> process <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created.  For processes
01102     without parents, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> creates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> console.  For processes with
01103     parents, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> duplicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle table.
01104 
01105 Arguments:
01106 
01107     Process - Pointer to process structure.
01108 
01109     ConnectionInfo - Pointer to connection info.
01110 
01111     ConnectionInfoLength - Connection info length.
01112 
01113 Return Value:
01114 
01115 --*/
01116 
01117 {
01118     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01119     <a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html">PCONSOLE_API_CONNECTINFO</a> p = (<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html">PCONSOLE_API_CONNECTINFO</a>)ConnectionInfo;
01120     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
01121     <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData;
01122     <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">PCONSOLE_PROCESS_HANDLE</a> ProcessHandleRecord;
01123     CONSOLEWINDOWSTATIONPROCESS ConsoleWindowStationInfo;
01124     UNICODE_STRING strDesktopName;
01125     CONSOLE_PROCESS_INFO cpi;
01126 
01127     <span class="keywordflow">if</span> (p == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
01128         *ConnectionInfoLength != <span class="keyword">sizeof</span>( *p ) ||
01129         p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o9">AppNameLength</a> &gt; <span class="keyword">sizeof</span>(p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o10">AppName</a>) ||
01130         p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o11">CurDirLength</a> &gt; <span class="keyword">sizeof</span>(p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o12">CurDir</a>) ||
01131         p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o5">TitleLength</a> &gt; <span class="keyword">sizeof</span>(p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o6">Title</a>)) {
01132 
01133         KdPrint((<span class="stringliteral">"CONSRV: bad connection info\n"</span>));
01134         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
01135         <span class="keywordflow">return</span>( STATUS_UNSUCCESSFUL );
01136     }
01137 
01138     <span class="comment">//</span>
01139     <span class="comment">// Make sure the strings are NULL terminated.</span>
01140     <span class="comment">//</span>
01141 
01142     p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o10">AppName</a>[<a class="code" href="../../d2/d3/tnlsxlat_8c.html#a0">NELEM</a>(p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o10">AppName</a>) - 1] = 0;
01143     p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o12">CurDir</a>[<a class="code" href="../../d2/d3/tnlsxlat_8c.html#a0">NELEM</a>(p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o12">CurDir</a>) - 1] = 0;
01144     p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o6">Title</a>[<a class="code" href="../../d2/d3/tnlsxlat_8c.html#a0">NELEM</a>(p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o6">Title</a>) - 1] = 0;
01145 
01146     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a10">CtrlRoutine</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01147         <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a10">CtrlRoutine</a> = p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o3">CtrlRoutine</a>;
01148     }
01149 <span class="preprocessor">#if defined(FE_IME)</span>
01150 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a11">ConsoleIMERoutine</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01151         <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a11">ConsoleIMERoutine</a> = p-&gt;ConsoleIMERoutine;
01152     }
01153 <span class="preprocessor">#endif</span>
01154 <span class="preprocessor"></span>    ProcessData = <a class="code" href="../../d1/d7/server_8h.html#a82">CONSOLE_FROMPROCESSPERPROCESSDATA</a>(Process);
01155     Console = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01156 
01157     <span class="comment">//</span>
01158     <span class="comment">// If this process is not a console app, stop right here - no</span>
01159     <span class="comment">// initialization is needed. Just need to remember that this</span>
01160     <span class="comment">// is not a console app so that we do no work during</span>
01161     <span class="comment">// ClientDisconnectRoutine().</span>
01162     <span class="comment">//</span>
01163 
01164     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01165     <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d7/server_8h.html#a86">CONSOLE_GETCONSOLEAPPFROMPROCESSDATA</a>(ProcessData) = p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o1">ConsoleApp</a>)) {
01166 
01167         <span class="comment">//</span>
01168         <span class="comment">// First call off to USER so it unblocks any app waiting on a call</span>
01169         <span class="comment">// to WaitForInputIdle. This way apps calling WinExec() to exec console</span>
01170         <span class="comment">// apps will return right away.</span>
01171         <span class="comment">//</span>
01172 
01173 
01174         <span class="comment">/*</span>
01175 <span class="comment">         * Bug 273518 - joejo</span>
01176 <span class="comment">         *</span>
01177 <span class="comment">         * Adding optimization to bug fix</span>
01178 <span class="comment">         */</span>
01179         cpi.dwProcessID = HandleToUlong(<a class="code" href="../../d1/d7/server_8h.html#a80">CONSOLE_CLIENTPROCESSID</a>());
01180         cpi.dwFlags = (p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o0">ConsoleInfo</a>.<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o0">ConsoleHandle</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ? 0 : CPI_NEWPROCESSWINDOW;
01181 
01182         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">NtUserConsoleControl</a>(ConsoleNotifyConsoleApplication,
01183                 &amp;cpi, <span class="keyword">sizeof</span>(CONSOLE_PROCESS_INFO));
01184 
01185         <span class="comment">//</span>
01186         <span class="comment">// create console</span>
01187         <span class="comment">//</span>
01188 
01189         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o0">ConsoleInfo</a>.<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o0">ConsoleHandle</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01190             ProcessHandleRecord = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( HANDLE_TAG ),<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">CONSOLE_PROCESS_HANDLE</a>));
01191             <span class="keywordflow">if</span> (ProcessHandleRecord == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01192                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
01193                 <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01194             }
01195 
01196             <span class="comment">//</span>
01197             <span class="comment">// We are creating a new console, so derereference</span>
01198             <span class="comment">// the parent's console, if any.</span>
01199             <span class="comment">//</span>
01200 
01201             <span class="keywordflow">if</span> (ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o0">ConsoleHandle</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01202                 <a class="code" href="../../d0/d5/srvinit_8c.html#a37">RemoveConsole</a>(ProcessData, Process-&gt;ProcessHandle, 0);
01203             }
01204 
01205             <span class="comment">//</span>
01206             <span class="comment">// Get the desktop name.</span>
01207             <span class="comment">//</span>
01208 
01209             <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o7">DesktopLength</a>) {
01210                 strDesktopName.Buffer = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(
01211                                                   <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TMP_TAG ),
01212                                                   p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o7">DesktopLength</a>);
01213                 <span class="keywordflow">if</span> (strDesktopName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01214                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
01215                     <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01216                 }
01217                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a9">NtReadVirtualMemory</a>(Process-&gt;ProcessHandle,
01218                                     (PVOID)p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o8">Desktop</a>,
01219                                     strDesktopName.Buffer,
01220                                     p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o7">DesktopLength</a>,
01221                                     NULL
01222                                    );
01223                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01224                     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(strDesktopName.Buffer);
01225                     <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01226                 }
01227                 strDesktopName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o7">DesktopLength</a>;
01228                 strDesktopName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o7">DesktopLength</a> - <span class="keyword">sizeof</span>(WCHAR));
01229             } <span class="keywordflow">else</span> {
01230                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strDesktopName, L<span class="stringliteral">"Default"</span>);
01231             }
01232 
01233             ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o6">RootProcess</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01234             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/srvinit_8c.html#a36">SetUpConsole</a>(&amp;p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o0">ConsoleInfo</a>,
01235                                     p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o5">TitleLength</a>,
01236                                     p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o6">Title</a>,
01237                                     p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o12">CurDir</a>,
01238                                     p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o10">AppName</a>,
01239                                     ProcessData,
01240                                     p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o2">WindowVisible</a>,
01241                                     &amp;strDesktopName);
01242             <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o7">DesktopLength</a>)
01243                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(strDesktopName.Buffer);
01244             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01245                 <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01246             }
01247 
01248             <span class="comment">// Play the Open sound for console apps</span>
01249 
01250             <a class="code" href="../../d5/d4/server_2msgbeep_8c.html#a0">ConsolePlaySound</a>();
01251 
01252             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a34">RevalidateConsole</a>(p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o0">ConsoleInfo</a>.<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o0">ConsoleHandle</a>,&amp;Console);
01253             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
01254         }
01255         <span class="keywordflow">else</span> {
01256             ProcessHandleRecord = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01257             ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o6">RootProcess</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01258 
01259             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01260             <span class="keywordflow">if</span> (!(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a34">RevalidateConsole</a>(p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o0">ConsoleInfo</a>.<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o0">ConsoleHandle</a>,&amp;Console))) ) {
01261                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PROCESS_IS_TERMINATING;
01262                 <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01263             }
01264 
01265             <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a15">CONSOLE_SHUTTING_DOWN</a>) {
01266                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PROCESS_IS_TERMINATING;
01267                 <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01268             }
01269 
01270             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d5/srvinit_8c.html#a32">MapHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>(),
01271                             Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o17">InitEvents</a>[INITIALIZATION_SUCCEEDED],
01272                             &amp;p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o0">ConsoleInfo</a>.<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o5">InitEvents</a>[INITIALIZATION_SUCCEEDED]
01273                             ) ||
01274                 !<a class="code" href="../../d0/d5/srvinit_8c.html#a32">MapHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>(),
01275                             Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o17">InitEvents</a>[INITIALIZATION_FAILED],
01276                             &amp;p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o0">ConsoleInfo</a>.<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o5">InitEvents</a>[INITIALIZATION_FAILED]
01277                             ) ||
01278                 !<a class="code" href="../../d0/d5/srvinit_8c.html#a32">MapHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>(),
01279                             Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o3">InputBuffer</a>.<a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html#o11">InputWaitEvent</a>,
01280                             &amp;p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o0">ConsoleInfo</a>.<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o1">InputWaitHandle</a>
01281                             )) {
01282                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
01283                 <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01284             }
01285 
01286             ProcessHandleRecord = <a class="code" href="../../d0/d5/srvinit_8c.html#a34">FindProcessInList</a>(Console,<a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>());
01287             <span class="keywordflow">if</span> (ProcessHandleRecord) {
01288                 ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o4">CtrlRoutine</a> = p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o3">CtrlRoutine</a>;
01289                 ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o5">PropRoutine</a> = p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o4">PropRoutine</a>;
01290                 ProcessHandleRecord = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01291             }
01292         }
01293         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01294 
01295             <span class="comment">//</span>
01296             <span class="comment">// Associate the correct window station with client process</span>
01297             <span class="comment">// so they can do Global atom calls.</span>
01298             <span class="comment">//</span>
01299             <span class="keywordflow">if</span> (DuplicateHandle( NtCurrentProcess(),
01300                                  Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o6">hWinSta</a>,
01301                                  Process-&gt;ProcessHandle,
01302                                  &amp;ConsoleWindowStationInfo.hwinsta,
01303                                  0,
01304                                  FALSE,
01305                                  DUPLICATE_SAME_ACCESS
01306                                )
01307                ) {
01308                 ConsoleWindowStationInfo.dwProcessId = HandleToUlong(<a class="code" href="../../d1/d7/server_8h.html#a80">CONSOLE_CLIENTPROCESSID</a>());
01309                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">NtUserConsoleControl</a>(ConsoleWindowStationProcess,
01310                         &amp;ConsoleWindowStationInfo, <span class="keyword">sizeof</span>(ConsoleWindowStationInfo));
01311 
01312                 }
01313 
01314             <span class="keywordflow">if</span> (ProcessHandleRecord) {
01315                 ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o2">Process</a> = Process;
01316                 ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o4">CtrlRoutine</a> = p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o3">CtrlRoutine</a>;
01317                 ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o5">PropRoutine</a> = p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o4">PropRoutine</a>;
01318                 <a class="code" href="../../d0/d5/srvinit_8c.html#a33">AddProcessToList</a>(Console,ProcessHandleRecord,<a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>());
01319             }
01320             <a class="code" href="../../d6/d2/output_8c.html#a73">SetProcessForegroundRights</a>(Process,
01321                                        Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; CONSOLE_HAS_FOCUS);
01322             <a class="code" href="../../d8/d5/consrv_8h.html#a254">AllocateCommandHistory</a>(Console,
01323                             p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o9">AppNameLength</a>,
01324                             p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o10">AppName</a>,
01325                             <a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>());
01326             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01327 
01328         } <span class="keywordflow">else</span> {
01329 <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>:
01330             <a class="code" href="../../d1/d7/server_8h.html#a88">CONSOLE_SETCONSOLEAPPFROMPROCESSDATA</a>(ProcessData,FALSE);
01331             <span class="keywordflow">if</span> (ProcessHandleRecord)
01332                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ProcessHandleRecord);
01333             <span class="keywordflow">if</span> (Console) {
01334                 <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01335             }
01336             <span class="keywordflow">if</span> (ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o0">ConsoleHandle</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01337                 <a class="code" href="../../d0/d5/srvinit_8c.html#a37">RemoveConsole</a>(ProcessData, Process-&gt;ProcessHandle, 0);
01338             }
01339         }
01340     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o0">ConsoleHandle</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01341 
01342         <span class="comment">//</span>
01343         <span class="comment">// This is a non-console app with a reference to a</span>
01344         <span class="comment">// reference to a parent console.  Dereference the</span>
01345         <span class="comment">// console.</span>
01346         <span class="comment">//</span>
01347 
01348         <a class="code" href="../../d0/d5/srvinit_8c.html#a37">RemoveConsole</a>(ProcessData, Process-&gt;ProcessHandle, 0);
01349     }
01350 
01351     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01352 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="srvinit.c::ConsoleClientDisconnectRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ConsoleClientDisconnectRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCSR_PROCESS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Process</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01482">1482</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
References <a class="el" href="../../d2/d6/server_8h-source.html#l00389">CONSOLE_FROMPROCESSPERPROCESSDATA</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00386">CONSOLE_FROMPROCESSPROCESSHANDLE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00401">CONSOLE_SETCONSOLEAPPFROMPROCESSDATA</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00322">_CONSOLE_PER_PROCESS_DATA::ConsoleHandle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01355">RemoveConsole()</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00737">ConServerDllInitialization()</a>.
<p>
<pre class="fragment"><div>01488                    :
01489 
01490     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when a process <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> destroyed.  It closes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01491     process's handles and frees <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> console <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>'s <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last reference.
01492 
01493 Arguments:
01494 
01495     Process - Pointer to process structure.
01496 
01497 Return Value:
01498 
01499 --*/
01500 
01501 {
01502     <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData;
01503 
01504 <span class="preprocessor">#if 0</span>
01505 <span class="preprocessor"></span>    OutputDebugString(<span class="stringliteral">"entering ConsoleClientDisconnectRoutine\n"</span>);
01506 <span class="preprocessor">#endif</span>
01507 <span class="preprocessor"></span>    ProcessData = <a class="code" href="../../d1/d7/server_8h.html#a82">CONSOLE_FROMPROCESSPERPROCESSDATA</a>(Process);
01508 
01509     <span class="comment">//</span>
01510     <span class="comment">// If this process is not a console app, stop right here - no</span>
01511     <span class="comment">// disconnect processing is needed, because this app didn't create</span>
01512     <span class="comment">// or connect to an existing console.</span>
01513     <span class="comment">//</span>
01514 
01515     <span class="keywordflow">if</span> ( ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o0">ConsoleHandle</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01516 <span class="preprocessor">#if defined(FE_IME)</span>
01517 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (ProcessData-&gt;hDesk )
01518         {
01519             <span class="comment">//</span>
01520             <span class="comment">// If this process is a Console IME,</span>
01521             <span class="comment">// should unregister console IME on this desktop.</span>
01522             <span class="comment">//</span>
01523             RemoveConsoleIME(Process, HandleToUlong(Process-&gt;ClientId.UniqueThread));
01524         }
01525 <span class="preprocessor">#endif</span>
01526 <span class="preprocessor"></span>        <span class="keywordflow">return</span>;
01527     }
01528 
01529     <a class="code" href="../../d0/d5/srvinit_8c.html#a37">RemoveConsole</a>(ProcessData,
01530             <a class="code" href="../../d1/d7/server_8h.html#a81">CONSOLE_FROMPROCESSPROCESSHANDLE</a>(Process),
01531             Process-&gt;ClientId.UniqueProcess);
01532     <a class="code" href="../../d1/d7/server_8h.html#a88">CONSOLE_SETCONSOLEAPPFROMPROCESSDATA</a>(ProcessData,FALSE);
01533     <span class="keywordflow">return</span>;
01534 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="srvinit.c::ConsoleClientShutdown" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG ConsoleClientShutdown           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PCSR_PROCESS&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>fFirstPass</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01912">1912</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
References <a class="el" href="../../d2/d6/server_8h-source.html#l00389">CONSOLE_FROMPROCESSPERPROCESSDATA</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00399">CONSOLE_GETCONSOLEAPPFROMPROCESSDATA</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00405">CONSOLE_GETCONSOLEHANDLEFROMPROCESSDATA</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00093">CONSOLE_NO_WINDOW</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00103">CONSOLE_WOW_REGISTERED</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00322">_CONSOLE_PER_PROCESS_DATA::ConsoleHandle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00164">_CONSOLE_INFORMATION::Flags</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00137">_CONSOLE_INFORMATION::hWnd</a>, <a class="el" href="../../d4/d7/aug98_2test_2main_8c-source.html#l00110">hWnd</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00235">_CONSOLE_INFORMATION::InputThreadInfo</a>, <a class="el" href="../../d3/d9/server_2exitwin_8c-source.html#l01842">InternalWaitCancel()</a>, <a class="el" href="../../d4/d8/client_2wow_8c-source.html#l00277">IsWindow()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l02088">NonConsoleProcessShutdown()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l07575">NtUserSetInformationThread()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00048">_CONSOLE_PROCESS_HANDLE::Process</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00148">_CONSOLE_INFORMATION::ProcessHandleList</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00130">_CONSOLE_INFORMATION::RefCount</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01686">RevalidateConsole()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00078">SHUTDOWN_CANCEL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00076">SHUTDOWN_KNOWN_PROCESS</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00077">SHUTDOWN_UNKNOWN_PROCESS</a>, <a class="el" href="../../d8/d5/consrv_8h.html#a154">ShutdownConsole()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00225">_CONSOLE_INFORMATION::TerminationEvent</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00055">_INPUT_THREAD_INFO::ThreadHandle</a>, and <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00737">ConServerDllInitialization()</a>.
<p>
<pre class="fragment"><div>01917 {
01918     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
01919     <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData;
01920     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01921     HWND <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>;
01922     HANDLE TerminationEvent;
01923     HANDLE ConsoleHandle;
01924     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> WaitStatus;
01925     USERTHREAD_USEDESKTOPINFO utudi;
01926 
01927     <span class="comment">//</span>
01928     <span class="comment">// Find the console associated with this process</span>
01929     <span class="comment">//</span>
01930 
01931     ProcessData = <a class="code" href="../../d1/d7/server_8h.html#a82">CONSOLE_FROMPROCESSPERPROCESSDATA</a>(Process);
01932 
01933     <span class="comment">//</span>
01934     <span class="comment">// If this process is not a console app, stop right here unless</span>
01935     <span class="comment">// this is the second pass of shutdown, in which case we'll take</span>
01936     <span class="comment">// it.</span>
01937     <span class="comment">//</span>
01938 
01939     <span class="keywordflow">if</span> (!ProcessData || !<a class="code" href="../../d1/d7/server_8h.html#a86">CONSOLE_GETCONSOLEAPPFROMPROCESSDATA</a>(ProcessData)) {
01940 <span class="preprocessor">#if defined(FE_IME)</span>
01941 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (fFirstPass &amp;&amp;
01942             (ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o0">ConsoleHandle</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01943             (ProcessData-&gt;hDesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))
01944         {
01945             <span class="comment">//</span>
01946             <span class="comment">// If this process is a Console IME,</span>
01947             <span class="comment">// should unregister console IME on this desktop.</span>
01948             <span class="comment">//</span>
01949             RemoveConsoleIME(Process, HandleToUlong(Process-&gt;ClientId.UniqueThread));
01950         }
01951 <span class="preprocessor">#endif</span>
01952 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (fFirstPass) {
01953             <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a14">SHUTDOWN_UNKNOWN_PROCESS</a>;
01954         }
01955         <span class="keywordflow">return</span> <a class="code" href="../../d0/d5/srvinit_8c.html#a23">NonConsoleProcessShutdown</a>(Process, Flags);
01956     }
01957 
01958     <span class="comment">//</span>
01959     <span class="comment">// Find the console structure pointer.</span>
01960     <span class="comment">//</span>
01961 
01962     ConsoleHandle = <a class="code" href="../../d1/d7/server_8h.html#a91">CONSOLE_GETCONSOLEHANDLEFROMPROCESSDATA</a>(ProcessData);
01963     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a34">RevalidateConsole</a>(
01964             ConsoleHandle,
01965             &amp;Console);
01966 
01967     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01968         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a14">SHUTDOWN_UNKNOWN_PROCESS</a>;
01969         }
01970 
01971     <span class="comment">//</span>
01972     <span class="comment">// If this is the invisible WOW console, return UNKNOWN so USER</span>
01973     <span class="comment">// enumerates 16-bit gui apps.</span>
01974     <span class="comment">//</span>
01975 
01976     <span class="keywordflow">if</span> ((Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a8">CONSOLE_NO_WINDOW</a>) &amp;&amp;
01977         (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a18">CONSOLE_WOW_REGISTERED</a>)) {
01978         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01979         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a14">SHUTDOWN_UNKNOWN_PROCESS</a>;
01980         }
01981 
01982     <span class="comment">//</span>
01983     <span class="comment">// Sometimes the console structure is around even though the</span>
01984     <span class="comment">// hWnd has been NULLed out. In this case, go to non-console</span>
01985     <span class="comment">// process shutdown.</span>
01986     <span class="comment">//</span>
01987 
01988     <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o8">hWnd</a>;
01989     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || !<a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(hWnd)) {
01990         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01991         <span class="keywordflow">return</span> <a class="code" href="../../d0/d5/srvinit_8c.html#a23">NonConsoleProcessShutdown</a>(Process, Flags);
01992         }
01993 
01994     <span class="comment">//</span>
01995     <span class="comment">// Make a copy of the console termination event</span>
01996     <span class="comment">//</span>
01997 
01998     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(NtCurrentProcess(),
01999                                Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o68">TerminationEvent</a>,
02000                                NtCurrentProcess(),
02001                                &amp;TerminationEvent,
02002                                0,
02003                                FALSE,
02004                                DUPLICATE_SAME_ACCESS
02005                                );
02006     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02007         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02008         <span class="keywordflow">return</span> <a class="code" href="../../d0/d5/srvinit_8c.html#a23">NonConsoleProcessShutdown</a>(Process, Flags);
02009     }
02010 
02011     <span class="comment">//</span>
02012     <span class="comment">// Attach to the desktop.</span>
02013     <span class="comment">//</span>
02014 
02015     utudi.hThread = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o75">InputThreadInfo</a>-&gt;<a class="code" href="../../d9/d2/struct__INPUT__THREAD__INFO.html#o0">ThreadHandle</a>;
02016     utudi.drdRestore.pdeskRestore = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02017     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(NtCurrentThread(),
02018                                         UserThreadUseDesktop,
02019                                         &amp;utudi,
02020                                         <span class="keyword">sizeof</span>(utudi));
02021 
02022     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02023     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02024         <span class="keywordflow">return</span> <a class="code" href="../../d0/d5/srvinit_8c.html#a23">NonConsoleProcessShutdown</a>(Process, Flags);
02025     }
02026 
02027     <span class="comment">//</span>
02028     <span class="comment">// We're done looking at this process structure, so dereference it.</span>
02029     <span class="comment">//</span>
02030     CsrDereferenceProcess(Process);
02031 
02032     <span class="comment">//</span>
02033     <span class="comment">// Synchronously talk to this console.</span>
02034     <span class="comment">//</span>
02035 
02036     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d5/consrv_8h.html#a154">ShutdownConsole</a>(ConsoleHandle, Flags);
02037 
02038     <span class="comment">//</span>
02039     <span class="comment">// Detach from the desktop.</span>
02040     <span class="comment">//</span>
02041 
02042     utudi.hThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02043     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(NtCurrentThread(),
02044                                UserThreadUseDesktop,
02045                                &amp;utudi,
02046                                <span class="keyword">sizeof</span>(utudi));
02047 
02048     <span class="comment">//</span>
02049     <span class="comment">// If Status == STATUS_PROCESS_IS_TERMINATING, then we should wait</span>
02050     <span class="comment">// for the console to exit.</span>
02051     <span class="comment">//</span>
02052 
02053     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PROCESS_IS_TERMINATING) {
02054         WaitStatus = <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a18">InternalWaitCancel</a>(TerminationEvent, 500000);
02055         <span class="keywordflow">if</span> (WaitStatus == STATUS_WAIT_1) {
02056             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a15">SHUTDOWN_CANCEL</a>;
02057         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (WaitStatus != STATUS_TIMEOUT) {
02058             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a13">SHUTDOWN_KNOWN_PROCESS</a>;
02059         } <span class="keywordflow">else</span> {
02060 <span class="preprocessor">#if DBG</span>
02061 <span class="preprocessor"></span>            PLIST_ENTRY ListHead, ListNext;
02062             <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">PCONSOLE_PROCESS_HANDLE</a> ProcessHandleRecord;
02063             PCSR_PROCESS Process;
02064 
02065             RIPMSG0(RIP_ERROR | RIP_THERESMORE, <span class="stringliteral">"********************************************"</span>);
02066             RIPMSG1(RIP_ERROR | RIP_THERESMORE, <span class="stringliteral">"Shutdown wait timed out on console %p"</span>, Console);
02067             RIPMSG1(RIP_ERROR | RIP_THERESMORE, <span class="stringliteral">"Reference count is %d"</span>, Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o1">RefCount</a>);
02068             RIPMSG0(RIP_ERROR | RIP_THERESMORE, <span class="stringliteral">"Dump these processes and see if they're hung"</span>);
02069             ListHead = &amp;Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o19">ProcessHandleList</a>;
02070             ListNext = ListHead-&gt;Flink;
02071             <span class="keywordflow">while</span> (ListNext != ListHead) {
02072                 ProcessHandleRecord = CONTAINING_RECORD(ListNext, <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">CONSOLE_PROCESS_HANDLE</a>, ListLink);
02073                 Process = ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o2">Process</a>;
02074                 RIPMSG2(RIP_ERROR | RIP_THERESMORE, <span class="stringliteral">"CsrProcess = %p ProcessId = %x"</span>, Process, Process-&gt;ClientId.UniqueProcess);
02075                 ListNext = ListNext-&gt;Flink;
02076             }
02077             RIPMSG0(RIP_ERROR, <span class="stringliteral">"********************************************"</span>);
02078 <span class="preprocessor">#endif</span>
02079 <span class="preprocessor"></span>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a15">SHUTDOWN_CANCEL</a>;
02080         }
02081     }
02082     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(TerminationEvent);
02083 
02084     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02085 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="srvinit.c::ConsolePlaySound" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ConsolePlaySound           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d3/server_2msgbeep_8c-source.html#l00025">25</a> of file <a class="el" href="../../d6/d3/server_2msgbeep_8c-source.html">server/msgbeep.c</a>.
<p>
References <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l04526">NtUserCallOneParam()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03564">USER_SOUND_OPEN</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01091">ConsoleClientConnectRoutine()</a>.
<p>
<pre class="fragment"><div>00027 {
00028     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(USER_SOUND_OPEN, SFI_PLAYEVENTSOUND);
00029 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="srvinit.c::FindProcessInList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">PCONSOLE_PROCESS_HANDLE</a> FindProcessInList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Console</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00911">911</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d2/d6/server_8h-source.html#l00047">_CONSOLE_PROCESS_HANDLE::ProcessHandle</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01091">ConsoleClientConnectRoutine()</a>.
<p>
<pre class="fragment"><div>00915 {
00916     <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">PCONSOLE_PROCESS_HANDLE</a> ProcessHandleRecord;
00917     PLIST_ENTRY ListHead, ListNext;
00918 
00919     ListHead = &amp;Console-&gt;ProcessHandleList;
00920     ListNext = ListHead-&gt;Flink;
00921     <span class="keywordflow">while</span> (ListNext != ListHead) {
00922         ProcessHandleRecord = CONTAINING_RECORD( ListNext, <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">CONSOLE_PROCESS_HANDLE</a>, ListLink );
00923         <span class="keywordflow">if</span> (ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o1">ProcessHandle</a> == ProcessHandle) {
00924             <span class="keywordflow">return</span> ProcessHandleRecord;
00925         }
00926         ListNext = ListNext-&gt;Flink;
00927     }
00928     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00929 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="srvinit.c::GetConsoleLangId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS GetConsoleLangId           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>OutputCP</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT LANGID *&nbsp;</td>
          <td class="mdname" nowrap> <em>pLangId</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l02643">2643</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
References <a class="el" href="../../d9/d4/consrv_8h-source.html#l00149">CONSOLE_IS_DBCS_ENABLED</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l03150">CommandNumberPopup()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l03040">CopyFromCharPopup()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l03096">CopyToCharPopup()</a>, <a class="el" href="../../d9/d8/dllinit_8c-source.html#l00346">SetTEBLangID()</a>, and <a class="el" href="../../d1/d4/srvinit_8c-source.html#l02680">SrvGetConsoleLangId()</a>.
<p>
<pre class="fragment"><div>02647 {
02648     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02649 
02650     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a32">CONSOLE_IS_DBCS_ENABLED</a>()){
02651         <span class="keywordflow">if</span> (pLangId != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02652             <span class="keywordflow">switch</span> (OutputCP) {
02653                 <span class="keywordflow">case</span> 932:
02654                     *pLangId = MAKELANGID( LANG_JAPANESE, SUBLANG_DEFAULT );
02655                     <span class="keywordflow">break</span>;
02656                 <span class="keywordflow">case</span> 949:
02657                     *pLangId = MAKELANGID( LANG_KOREAN, SUBLANG_KOREAN );
02658                     <span class="keywordflow">break</span>;
02659                 <span class="keywordflow">case</span> 936:
02660                     *pLangId = MAKELANGID( LANG_CHINESE, SUBLANG_CHINESE_SIMPLIFIED );
02661                     <span class="keywordflow">break</span>;
02662                 <span class="keywordflow">case</span> 950:
02663                     *pLangId = MAKELANGID( LANG_CHINESE, SUBLANG_CHINESE_TRADITIONAL );
02664                     <span class="keywordflow">break</span>;
02665                 <span class="keywordflow">default</span>:
02666                     *pLangId = MAKELANGID( LANG_ENGLISH, SUBLANG_ENGLISH_US );
02667                     <span class="keywordflow">break</span>;
02668             }
02669         }
02670         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02671     }
02672     <span class="keywordflow">else</span> {
02673         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_SUPPORTED;
02674     }
02675 
02676     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02677 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="srvinit.c::GetRegistryValues" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID GetRegistryValues           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN LPWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>ConsoleTitle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html">PCONSOLE_REGISTRY_INFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RegInfo</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l02210">2210</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
References <a class="el" href="../../d9/d4/consrv_8h-source.html#l00193">ConsoleHeapFree</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00067">DBGPRINT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00022">DefaultRegInfo</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l00306">gaWordDelimChars</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l00307">gaWordDelimCharsDefault</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00054">gExtendedEditKey</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00057">gfLoadConIme</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00055">gfTrimLeadingZeros</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l00186">InitExtendedEditKeys()</a>, <a class="el" href="../../d0/d3/dbcs_8h.html#a46">IsAvailableFarEastCodePage()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00433">_CONSOLE_REGISTRY_INFO::LastWriteTime</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01635">MyRegOpenKey()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01670">MyRegQueryValue()</a>, <a class="el" href="../../d3/d2/tnlsxlat_8c-source.html#l00026">NELEM</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00048">NT_ERROR</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02018">NtQueryKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00025">OEMCP</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">PBYTE</a>, <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l01564">RtlOpenCurrentUser()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01831">TranslateConsoleTitle()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>, and <a class="el" href="../../d5/d0/cmdline_8h-source.html#l00405">WORD_DELIM_MAX</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00626">InitWindowsStuff()</a>, and <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00360">LoadLinkInfo()</a>.
<p>
<pre class="fragment"><div>02217                    :
02218 
02219     This routine reads in values from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry and places them
02220     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supplied structure.
02221 
02222 Arguments:
02223 
02224     ConsoleTitle - name of subkey to open
02225 
02226     RegInfo - pointer to structure to receive information
02227 
02228 Return Value:
02229 
02230     none
02231 
02232 --*/
02233 
02234 {
02235     HANDLE hCurrentUserKey;
02236     HANDLE hConsoleKey;
02237     HANDLE hTitleKey;
02238     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02239     LPWSTR TranslatedConsoleTitle;
02240     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwValue;
02241     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> i;
02242     WCHAR awchFaceName[LF_FACESIZE];
02243     WCHAR awchBuffer[64];
02244     KEY_BASIC_INFORMATION KeyInfo;
02245     ULONG ResultLength;
02246 
02247     <span class="comment">//</span>
02248     <span class="comment">// Impersonate the client process</span>
02249     <span class="comment">//</span>
02250 
02251     <span class="keywordflow">if</span> (!CsrImpersonateClient(NULL)) {
02252         KdPrint((<span class="stringliteral">"CONSRV: GetRegistryValues Impersonate failed\n"</span>));
02253         <span class="keywordflow">return</span>;
02254     }
02255 
02256     <span class="comment">//</span>
02257     <span class="comment">// Open the current user registry key</span>
02258     <span class="comment">//</span>
02259 
02260     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a27">RtlOpenCurrentUser</a>(MAXIMUM_ALLOWED, &amp;hCurrentUserKey);
02261     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02262         CsrRevertToSelf();
02263         <span class="keywordflow">return</span>;
02264     }
02265 
02266     <span class="comment">//</span>
02267     <span class="comment">// Open the console registry key</span>
02268     <span class="comment">//</span>
02269 
02270     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2server_8c.html#a44">MyRegOpenKey</a>(hCurrentUserKey,
02271                           CONSOLE_REGISTRY_STRING,
02272                           &amp;hConsoleKey);
02273     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02274         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hCurrentUserKey);
02275         CsrRevertToSelf();
02276         <span class="keywordflow">return</span>;
02277     }
02278 
02279     <span class="comment">//</span>
02280     <span class="comment">// If we're not reading the default key, check if the default values</span>
02281     <span class="comment">// need to be updated</span>
02282     <span class="comment">//</span>
02283 
02284     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a24">NtQueryKey</a>(hConsoleKey,
02285                         KeyBasicInformation,
02286                         &amp;KeyInfo,
02287                         <span class="keyword">sizeof</span>(KeyInfo),
02288                         &amp;ResultLength);
02289     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>(Status)) {
02290         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o18">LastWriteTime</a> != KeyInfo.LastWriteTime.QuadPart) {
02291             <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o18">LastWriteTime</a> = KeyInfo.LastWriteTime.QuadPart;
02292             <span class="keywordflow">if</span> (RegInfo != &amp;<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>) {
02293                 <a class="code" href="../../d0/d5/srvinit_8c.html#a44">GetRegistryValues</a>(L<span class="stringliteral">""</span>, &amp;DefaultRegInfo);
02294                 *RegInfo = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>;
02295             }
02296         }
02297     }
02298 
02299     <span class="comment">//</span>
02300     <span class="comment">// Open the console title subkey</span>
02301     <span class="comment">//</span>
02302 
02303     TranslatedConsoleTitle = <a class="code" href="../../d0/d5/srvinit_8c.html#a42">TranslateConsoleTitle</a>(ConsoleTitle, NULL, TRUE, TRUE);
02304     <span class="keywordflow">if</span> (TranslatedConsoleTitle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02305         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hConsoleKey);
02306         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hCurrentUserKey);
02307         CsrRevertToSelf();
02308         <span class="keywordflow">return</span>;
02309     }
02310     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2server_8c.html#a44">MyRegOpenKey</a>(hConsoleKey,
02311                          TranslatedConsoleTitle,
02312                          &amp;hTitleKey);
02313     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TranslatedConsoleTitle);
02314     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02315         TranslatedConsoleTitle = <a class="code" href="../../d0/d5/srvinit_8c.html#a42">TranslateConsoleTitle</a>(ConsoleTitle, NULL, FALSE, TRUE);
02316         <span class="keywordflow">if</span> (TranslatedConsoleTitle) {
02317             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2server_8c.html#a44">MyRegOpenKey</a>(hConsoleKey,
02318                                  TranslatedConsoleTitle,
02319                                  &amp;hTitleKey);
02320             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TranslatedConsoleTitle);
02321         }
02322     }
02323     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02324         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hConsoleKey);
02325         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hCurrentUserKey);
02326         CsrRevertToSelf();
02327         <span class="keywordflow">return</span>;
02328     }
02329 
02330     <span class="comment">//</span>
02331     <span class="comment">// Initial screen fill</span>
02332     <span class="comment">//</span>
02333 
02334     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02335                        CONSOLE_REGISTRY_FILLATTR,
02336                        <span class="keyword">sizeof</span>(dwValue), (PBYTE)&amp;dwValue))) {
02337         RegInfo-&gt;ScreenFill.Attributes = (WORD)dwValue;
02338     }
02339 
02340     <span class="comment">//</span>
02341     <span class="comment">// Initial popup fill</span>
02342     <span class="comment">//</span>
02343 
02344     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02345                        CONSOLE_REGISTRY_POPUPATTR,
02346                        <span class="keyword">sizeof</span>(dwValue), (PBYTE)&amp;dwValue))) {
02347         RegInfo-&gt;PopupFill.Attributes = (WORD)dwValue;
02348     }
02349 
02350     <span class="comment">//</span>
02351     <span class="comment">// Initial insert mode</span>
02352     <span class="comment">//</span>
02353 
02354     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02355                        CONSOLE_REGISTRY_INSERTMODE,
02356                        <span class="keyword">sizeof</span>(dwValue), (PBYTE)&amp;dwValue))) {
02357         RegInfo-&gt;InsertMode = !!dwValue;
02358     }
02359 
02360     <span class="comment">//</span>
02361     <span class="comment">// Initial quick edit mode</span>
02362     <span class="comment">//</span>
02363 
02364     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02365                        CONSOLE_REGISTRY_QUICKEDIT,
02366                        <span class="keyword">sizeof</span>(dwValue), (PBYTE)&amp;dwValue))) {
02367         RegInfo-&gt;QuickEdit = !!dwValue;
02368     }
02369 
02370 <span class="preprocessor">#ifdef i386</span>
02371 <span class="preprocessor"></span>    <span class="comment">//</span>
02372     <span class="comment">// Initial full screen mode</span>
02373     <span class="comment">//</span>
02374 
02375     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02376                        CONSOLE_REGISTRY_FULLSCR,
02377                        <span class="keyword">sizeof</span>(dwValue), (PBYTE)&amp;dwValue))) {
02378         RegInfo-&gt;FullScreen = !!dwValue;
02379     }
02380 <span class="preprocessor">#endif</span>
02381 <span class="preprocessor"></span>
02382 <span class="preprocessor">#if defined(FE_SB) // scotthsu</span>
02383 <span class="preprocessor"></span>    <span class="comment">//</span>
02384     <span class="comment">// Code Page</span>
02385     <span class="comment">//</span>
02386 
02387     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02388                        CONSOLE_REGISTRY_CODEPAGE,
02389                        <span class="keyword">sizeof</span>(dwValue), (PBYTE)&amp;dwValue))) {
02390         RegInfo-&gt;CodePage = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)dwValue;
02391 
02392         <span class="comment">// If this routine specified default settings for console property,</span>
02393         <span class="comment">// then make sure code page value when Fae East environment.</span>
02394         <span class="comment">// If code page value does not the same to OEMCP and any FE's code page then</span>
02395         <span class="comment">// we are override code page value to OEMCP on default console property.</span>
02396         <span class="comment">// Because, Far East environment has limitation that doesn not switch to</span>
02397         <span class="comment">// another FE's code page by the SetConsoleCP/SetConsoleOutputCP.</span>
02398         <span class="comment">//</span>
02399         <span class="comment">// Compare of ConsoleTitle and L"" has limit to default property of console.</span>
02400         <span class="comment">// It means, this code doesn't care user defined property.</span>
02401         <span class="comment">// Content of user defined property has responsibility to themselves.</span>
02402 
02403         <span class="keywordflow">if</span> ( wcscmp(ConsoleTitle,L<span class="stringliteral">""</span>) == 0 &amp;&amp;
02404              <a class="code" href="../../d0/d3/dbcs_8h.html#a46">IsAvailableFarEastCodePage</a>( RegInfo-&gt;CodePage ) &amp;&amp;
02405              <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a> != RegInfo-&gt;CodePage ) {
02406             RegInfo-&gt;CodePage = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>;
02407         }
02408     }
02409 <span class="preprocessor">#endif</span>
02410 <span class="preprocessor"></span>
02411     <span class="comment">//</span>
02412     <span class="comment">// Initial screen buffer size</span>
02413     <span class="comment">//</span>
02414 
02415     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02416                        CONSOLE_REGISTRY_BUFFERSIZE,
02417                        <span class="keyword">sizeof</span>(dwValue), (PBYTE)&amp;dwValue))) {
02418         RegInfo-&gt;ScreenBufferSize.X = LOWORD(dwValue);
02419         RegInfo-&gt;ScreenBufferSize.Y = HIWORD(dwValue);
02420         <span class="keywordflow">if</span> (RegInfo-&gt;ScreenBufferSize.X &lt;= 0)
02421             RegInfo-&gt;ScreenBufferSize.X = 1;
02422         <span class="keywordflow">if</span> (RegInfo-&gt;ScreenBufferSize.Y &lt;= 0)
02423             RegInfo-&gt;ScreenBufferSize.Y = 1;
02424     }
02425 
02426     <span class="comment">//</span>
02427     <span class="comment">// Initial window size</span>
02428     <span class="comment">//</span>
02429 
02430     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02431                        CONSOLE_REGISTRY_WINDOWSIZE,
02432                        <span class="keyword">sizeof</span>(dwValue), (PBYTE)&amp;dwValue))) {
02433         RegInfo-&gt;WindowSize.X = LOWORD(dwValue);
02434         RegInfo-&gt;WindowSize.Y = HIWORD(dwValue);
02435         <span class="keywordflow">if</span> (RegInfo-&gt;WindowSize.X &lt;= 0)
02436             RegInfo-&gt;WindowSize.X = 1;
02437         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (RegInfo-&gt;WindowSize.X &gt; RegInfo-&gt;ScreenBufferSize.X)
02438             RegInfo-&gt;WindowSize.X = RegInfo-&gt;ScreenBufferSize.X;
02439         <span class="keywordflow">if</span> (RegInfo-&gt;WindowSize.Y &lt;= 0)
02440             RegInfo-&gt;WindowSize.Y = 1;
02441         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (RegInfo-&gt;WindowSize.Y &gt; RegInfo-&gt;ScreenBufferSize.Y)
02442             RegInfo-&gt;WindowSize.Y = RegInfo-&gt;ScreenBufferSize.Y;
02443     }
02444 
02445     <span class="comment">//</span>
02446     <span class="comment">// Initial window position</span>
02447     <span class="comment">//</span>
02448 
02449     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02450                        CONSOLE_REGISTRY_WINDOWPOS,
02451                        <span class="keyword">sizeof</span>(dwValue), (PBYTE)&amp;dwValue))) {
02452         RegInfo-&gt;WindowOrigin.X = LOWORD(dwValue);
02453         RegInfo-&gt;WindowOrigin.Y = HIWORD(dwValue);
02454         RegInfo-&gt;AutoPosition = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02455     }
02456 
02457     <span class="comment">//</span>
02458     <span class="comment">// Initial font size</span>
02459     <span class="comment">//</span>
02460 
02461     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02462                        CONSOLE_REGISTRY_FONTSIZE,
02463                        <span class="keyword">sizeof</span>(dwValue), (PBYTE)&amp;dwValue))) {
02464         RegInfo-&gt;FontSize.X = LOWORD(dwValue);
02465         RegInfo-&gt;FontSize.Y = HIWORD(dwValue);
02466     }
02467 
02468     <span class="comment">//</span>
02469     <span class="comment">// Initial font family</span>
02470     <span class="comment">//</span>
02471 
02472     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02473                        CONSOLE_REGISTRY_FONTFAMILY,
02474                        <span class="keyword">sizeof</span>(dwValue), (PBYTE)&amp;dwValue))) {
02475         RegInfo-&gt;FontFamily = dwValue;
02476     }
02477 
02478     <span class="comment">//</span>
02479     <span class="comment">// Initial font weight</span>
02480     <span class="comment">//</span>
02481 
02482     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02483                        CONSOLE_REGISTRY_FONTWEIGHT,
02484                        <span class="keyword">sizeof</span>(dwValue), (PBYTE)&amp;dwValue))) {
02485         RegInfo-&gt;FontWeight = dwValue;
02486     }
02487 
02488     <span class="comment">//</span>
02489     <span class="comment">// Initial font face name</span>
02490     <span class="comment">//</span>
02491 
02492     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02493                        CONSOLE_REGISTRY_FACENAME,
02494                        <span class="keyword">sizeof</span>(awchFaceName), (PBYTE)awchFaceName))) {
02495         RtlCopyMemory(RegInfo-&gt;FaceName, awchFaceName, <span class="keyword">sizeof</span>(awchFaceName));
02496         RegInfo-&gt;FaceName[<a class="code" href="../../d2/d3/tnlsxlat_8c.html#a0">NELEM</a>(RegInfo-&gt;FaceName) - 1] = 0;
02497     }
02498 
02499     <span class="comment">//</span>
02500     <span class="comment">// Initial cursor size</span>
02501     <span class="comment">//</span>
02502 
02503     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02504                        CONSOLE_REGISTRY_CURSORSIZE,
02505                        <span class="keyword">sizeof</span>(dwValue), (PBYTE)&amp;dwValue))) {
02506         RegInfo-&gt;CursorSize = dwValue;
02507     }
02508 
02509     <span class="comment">//</span>
02510     <span class="comment">// Initial history buffer size</span>
02511     <span class="comment">//</span>
02512 
02513     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02514                        CONSOLE_REGISTRY_HISTORYSIZE,
02515                        <span class="keyword">sizeof</span>(dwValue), (PBYTE)&amp;dwValue))) {
02516         RegInfo-&gt;HistoryBufferSize = dwValue;
02517     }
02518 
02519     <span class="comment">//</span>
02520     <span class="comment">// Initial number of history buffers</span>
02521     <span class="comment">//</span>
02522 
02523     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02524                        CONSOLE_REGISTRY_HISTORYBUFS,
02525                        <span class="keyword">sizeof</span>(dwValue), (PBYTE)&amp;dwValue))) {
02526         RegInfo-&gt;NumberOfHistoryBuffers = dwValue;
02527     }
02528 
02529     <span class="comment">//</span>
02530     <span class="comment">// Initial history duplication mode</span>
02531     <span class="comment">//</span>
02532 
02533     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02534                        CONSOLE_REGISTRY_HISTORYNODUP,
02535                        <span class="keyword">sizeof</span>(dwValue), (PBYTE)&amp;dwValue))) {
02536         RegInfo-&gt;HistoryNoDup = dwValue;
02537     }
02538 
02539     <span class="keywordflow">for</span> (i=0; i&lt;16; i++) {
02540         wsprintf(awchBuffer, CONSOLE_REGISTRY_COLORTABLE, i);
02541         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey, awchBuffer,
02542                            <span class="keyword">sizeof</span>(dwValue), (PBYTE)&amp;dwValue))) {
02543             RegInfo-&gt;ColorTable[ i ] = dwValue;
02544         }
02545     }
02546 
02547     <span class="keywordflow">if</span> (RegInfo == &amp;<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>) {
02548         <span class="comment">//</span>
02549         <span class="comment">// If the common (default) setting has been changed,</span>
02550         <span class="comment">//</span>
02551 
02552         <span class="comment">//</span>
02553         <span class="comment">// Get registry for conime flag</span>
02554         <span class="comment">//</span>
02555         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hConsoleKey, CONSOLE_REGISTRY_LOAD_CONIME, <span class="keyword">sizeof</span> dwValue, (PBYTE)&amp;dwValue))) {
02556             <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a26">gfLoadConIme</a> = (dwValue != 0);
02557         } <span class="keywordflow">else</span> {
02558             <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a26">gfLoadConIme</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02559         }
02560 
02561         <span class="comment">//</span>
02562         <span class="comment">// get extended edit mode and keys from registry.</span>
02563         <span class="comment">//</span>
02564         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hConsoleKey,
02565                 CONSOLE_REGISTRY_EXTENDEDEDITKEY,
02566                 <span class="keyword">sizeof</span> dwValue,
02567                 (PBYTE)&amp;dwValue)) &amp;&amp;
02568                 dwValue &lt;= 1) {
02569 
02570             ExtKeyDefBuf buf;
02571 
02572             <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a24">gExtendedEditKey</a> = dwValue;
02573 
02574             <span class="comment">//</span>
02575             <span class="comment">// Initialize Extended Edit keys</span>
02576             <span class="comment">//</span>
02577             <a class="code" href="../../d4/d1/cmdline_8h.html#a63">InitExtendedEditKeys</a>(NULL);
02578 
02579             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hConsoleKey,
02580                         CONSOLE_REGISTRY_EXTENDEDEDITKEY_CUSTOM,
02581                         <span class="keyword">sizeof</span> buf,
02582                         (PBYTE)&amp;buf))) {
02583                 <a class="code" href="../../d4/d1/cmdline_8h.html#a63">InitExtendedEditKeys</a>(&amp;buf);
02584             }
02585 <span class="preprocessor">    #if DBG</span>
02586 <span class="preprocessor"></span>            <span class="keywordflow">else</span> {
02587                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Error reading ExtendedEditkeyCustom.\n"</span>);
02588             }
02589 <span class="preprocessor">    #endif</span>
02590 <span class="preprocessor"></span>        }
02591         <span class="keywordflow">else</span> {
02592             <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a24">gExtendedEditKey</a> = 0;
02593             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"Error reading ExtendedEditkey.\n"</span>));
02594         }
02595 
02596         <span class="comment">//</span>
02597         <span class="comment">// Word delimiters</span>
02598         <span class="comment">//</span>
02599         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a24">gExtendedEditKey</a>) {
02600             <span class="comment">// If extended edit key is given, provide extended word delimiters</span>
02601             <span class="comment">// by default.</span>
02602             memcpy((LPBYTE)gaWordDelimChars, (LPBYTE)gaWordDelimCharsDefault,
02603                     <span class="keyword">sizeof</span> gaWordDelimChars[0] * WORD_DELIM_MAX);
02604         } <span class="keywordflow">else</span> {
02605             <span class="comment">// Otherwise, stick to the original word delimiter.</span>
02606             <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a14">gaWordDelimChars</a>[0] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
02607         }
02608 
02609         <span class="comment">// Read word delimiters from registry</span>
02610         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hConsoleKey,
02611                     CONSOLE_REGISTRY_WORD_DELIM,
02612                     <span class="keyword">sizeof</span> awchBuffer,
02613                     (PBYTE)awchBuffer))) {
02614             <span class="comment">// OK, copy it to the word delimiter array.</span>
02615             wcsncpy(gaWordDelimChars, awchBuffer, WORD_DELIM_MAX);
02616             <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a14">gaWordDelimChars</a>[<a class="code" href="../../d4/d1/cmdline_8h.html#a24">WORD_DELIM_MAX</a> - 1] = 0;
02617         }
02618 
02619         <span class="comment">//</span>
02620         <span class="comment">// Read Trim Zero Heading flag</span>
02621         <span class="comment">//</span>
02622         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02623                            CONSOLE_REGISTRY_TRIMZEROHEADINGS,
02624                            <span class="keyword">sizeof</span>(dwValue), (PBYTE)&amp;dwValue))) {
02625             <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a25">gfTrimLeadingZeros</a> = dwValue;
02626         } <span class="keywordflow">else</span> {
02627             <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a25">gfTrimLeadingZeros</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02628         }
02629     }
02630 
02631 
02632     <span class="comment">//</span>
02633     <span class="comment">// Close the registry keys</span>
02634     <span class="comment">//</span>
02635 
02636     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hTitleKey);
02637     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hConsoleKey);
02638     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hCurrentUserKey);
02639     CsrRevertToSelf();
02640 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="srvinit.c::InitializeConsoleAttributes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID InitializeConsoleAttributes           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l02132">2132</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
References <a class="el" href="../../d2/d6/server_8h-source.html#l00426">_CONSOLE_REGISTRY_INFO::AutoPosition</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00432">_CONSOLE_REGISTRY_INFO::ColorTable</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00250">CURSOR_SMALL_SIZE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00422">_CONSOLE_REGISTRY_INFO::CursorSize</a>, <a class="el" href="../../d5/d0/cmdline_8h-source.html#l00083">DEFAULT_NUMBER_OF_BUFFERS</a>, <a class="el" href="../../d5/d0/cmdline_8h-source.html#l00082">DEFAULT_NUMBER_OF_COMMANDS</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00022">DefaultRegInfo</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00421">_CONSOLE_REGISTRY_INFO::FaceName</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00419">_CONSOLE_REGISTRY_INFO::FontFamily</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00418">_CONSOLE_REGISTRY_INFO::FontSize</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00420">_CONSOLE_REGISTRY_INFO::FontWeight</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00423">_CONSOLE_REGISTRY_INFO::FullScreen</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00429">_CONSOLE_REGISTRY_INFO::HistoryBufferSize</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00431">_CONSOLE_REGISTRY_INFO::HistoryNoDup</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l00177">InitializeSystemMetrics()</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00425">_CONSOLE_REGISTRY_INFO::InsertMode</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00433">_CONSOLE_REGISTRY_INFO::LastWriteTime</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00430">_CONSOLE_REGISTRY_INFO::NumberOfHistoryBuffers</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00025">OEMCP</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00428">_CONSOLE_REGISTRY_INFO::PopupFill</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00424">_CONSOLE_REGISTRY_INFO::QuickEdit</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00415">_CONSOLE_REGISTRY_INFO::ScreenBufferSize</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00427">_CONSOLE_REGISTRY_INFO::ScreenFill</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00417">_CONSOLE_REGISTRY_INFO::WindowOrigin</a>, and <a class="el" href="../../d2/d6/server_8h-source.html#l00416">_CONSOLE_REGISTRY_INFO::WindowSize</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/server_2server_8c-source.html#l01121">SrvLogon()</a>.
<p>
<pre class="fragment"><div>02136                    :
02137 
02138     This routine initializes <span class="keywordflow">default</span> attributes from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current
02139     user's registry values. It gets called during logon/logoff.
02140 
02141 Arguments:
02142 
02143     none
02144 
02145 Return Value:
02146 
02147     none
02148 
02149 --*/
02150 
02151 {
02152     <span class="comment">//</span>
02153     <span class="comment">// Store default values in structure and mark it</span>
02154     <span class="comment">// as invalid (by resetting LastWriteTime).</span>
02155     <span class="comment">//</span>
02156 
02157     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o12">ScreenFill</a>.Attributes = 0x07;            <span class="comment">// white on black</span>
02158     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o12">ScreenFill</a>.Char.UnicodeChar = (WCHAR)<span class="charliteral">' '</span>;
02159     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o13">PopupFill</a>.Attributes = 0xf5;             <span class="comment">// purple on white</span>
02160     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o13">PopupFill</a>.Char.UnicodeChar = (WCHAR)<span class="charliteral">' '</span>;
02161     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o10">InsertMode</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02162     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o9">QuickEdit</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02163     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o11">AutoPosition</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02164     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o8">FullScreen</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02165     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o0">ScreenBufferSize</a>.X = 80;
02166     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o0">ScreenBufferSize</a>.Y = 25;
02167     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o1">WindowSize</a>.X = 80;
02168     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o1">WindowSize</a>.Y = 25;
02169     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o2">WindowOrigin</a>.X = 0;
02170     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o2">WindowOrigin</a>.Y = 0;
02171     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o3">FontSize</a>.X = 0;
02172     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o3">FontSize</a>.Y = 0;
02173     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o4">FontFamily</a> = 0;
02174     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o5">FontWeight</a> = 0;
02175     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o6">FaceName</a>[0] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
02176     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o7">CursorSize</a> = <a class="code" href="../../d7/d2/output_8h.html#a10">CURSOR_SMALL_SIZE</a>;
02177     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o14">HistoryBufferSize</a> = <a class="code" href="../../d4/d1/cmdline_8h.html#a6">DEFAULT_NUMBER_OF_COMMANDS</a>;
02178     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o15">NumberOfHistoryBuffers</a> = <a class="code" href="../../d4/d1/cmdline_8h.html#a7">DEFAULT_NUMBER_OF_BUFFERS</a>;
02179     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o16">HistoryNoDup</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02180     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[ 0] = RGB(0,   0,   0   );
02181     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[ 1] = RGB(0,   0,   0x80);
02182     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[ 2] = RGB(0,   0x80,0   );
02183     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[ 3] = RGB(0,   0x80,0x80);
02184     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[ 4] = RGB(0x80,0,   0   );
02185     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[ 5] = RGB(0x80,0,   0x80);
02186     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[ 6] = RGB(0x80,0x80,0   );
02187     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[ 7] = RGB(0xC0,0xC0,0xC0);
02188     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[ 8] = RGB(0x80,0x80,0x80);
02189     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[ 9] = RGB(0,   0,   0xFF);
02190     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[10] = RGB(0,   0xFF,0   );
02191     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[11] = RGB(0,   0xFF,0xFF);
02192     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[12] = RGB(0xFF,0,   0   );
02193     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[13] = RGB(0xFF,0,   0xFF);
02194     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[14] = RGB(0xFF,0xFF,0   );
02195     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[15] = RGB(0xFF,0xFF,0xFF);
02196 <span class="preprocessor">#if defined(FE_SB) // scotthsu</span>
02197 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.CodePage = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>;
02198 <span class="preprocessor">#endif</span>
02199 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o18">LastWriteTime</a> = 0;
02200 
02201     <span class="comment">//</span>
02202     <span class="comment">// Get system metrics for this user</span>
02203     <span class="comment">//</span>
02204 
02205     <a class="code" href="../../d6/d2/output_8c.html#a38">InitializeSystemMetrics</a>();
02206 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="srvinit.c::InitWindowClass" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL InitWindowClass           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00590">590</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00432">_CONSOLE_REGISTRY_INFO::ColorTable</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00444">CONSOLE_WINDOW_CLASS</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l04700">ConsoleWindowProc()</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00022">DefaultRegInfo</a>, <a class="el" href="../../d4/d8/client_2wow_8c-source.html#l00401">GetSystemMetrics()</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00028">ghDefaultIcon</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00029">ghDefaultSmIcon</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00027">ghInstance</a>, <a class="el" href="../../d5/d5/ntuser_2server_2globals_8c-source.html#l00017">ghModuleWin</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00030">ghNormalCursor</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00076">IDI_CONSOLE</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00183">LOBYTE</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l00870">NtUserConsoleControl()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/cltxt_8h-source.html#l01441">RegisterClassEx</a>, and <a class="el" href="../../d2/d6/server_8h-source.html#l00427">_CONSOLE_REGISTRY_INFO::ScreenFill</a>.
<p>
Referenced by <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l01946">ConsoleInputThread()</a>.
<p>
<pre class="fragment"><div>00591 {
00592     WNDCLASSEX wc;
00593     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> retval;
00594     ATOM atomConsoleClass;
00595 
00596     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a7">ghNormalCursor</a> = LoadCursor(NULL, IDC_ARROW);
00597     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ghModuleWin != NULL);
00598     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a5">ghDefaultIcon</a>       = LoadIcon(ghModuleWin, MAKEINTRESOURCE(IDI_CONSOLE));
00599     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a6">ghDefaultSmIcon</a>     = LoadImage(ghModuleWin, MAKEINTRESOURCE(IDI_CONSOLE), IMAGE_ICON,
00600                                     <a class="code" href="../../d3/d9/client_2wow_8c.html#a16">GetSystemMetrics</a>(SM_CXSMICON), <a class="code" href="../../d3/d9/client_2wow_8c.html#a16">GetSystemMetrics</a>(SM_CYSMICON),
00601                                     LR_SHARED);
00602     wc.hIcon            = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a5">ghDefaultIcon</a>;
00603     wc.cbSize           = <span class="keyword">sizeof</span>(WNDCLASSEX);
00604     wc.style            = CS_HREDRAW | CS_VREDRAW | CS_OWNDC | CS_DBLCLKS;
00605     wc.lpfnWndProc      = <a class="code" href="../../d8/d5/consrv_8h.html#a121">ConsoleWindowProc</a>;
00606     wc.cbClsExtra       = 0;
00607     wc.cbWndExtra       = GWL_CONSOLE_WNDALLOC;
00608     wc.hInstance        = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a4">ghInstance</a>;
00609     wc.hCursor          = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a7">ghNormalCursor</a>;
00610     wc.hbrBackground    = CreateSolidBrush(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[<a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o12">ScreenFill</a>.Attributes &gt;&gt; 4) &amp; 0xF]);
00611     wc.lpszMenuName     = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00612     wc.lpszClassName    = <a class="code" href="../../d1/d7/server_8h.html#a93">CONSOLE_WINDOW_CLASS</a>;
00613     wc.hIconSm          = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a6">ghDefaultSmIcon</a>;
00614 
00615     atomConsoleClass = <a class="code" href="../../d5/d9/cltxt_8h.html#a8">RegisterClassEx</a>(&amp;wc);
00616     retval = (atomConsoleClass != 0);
00617 
00618     <span class="keywordflow">if</span> (retval)
00619         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">NtUserConsoleControl</a>(ConsoleClassAtom, &amp;atomConsoleClass, <span class="keyword">sizeof</span>(ATOM));
00620 
00621     <span class="keywordflow">return</span> retval;
00622 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="srvinit.c::InitWindowsStuff" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS InitWindowsStuff           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HDESK&nbsp;</td>
          <td class="mdname" nowrap> <em>hdesk</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPDWORD&nbsp;</td>
          <td class="mdname" nowrap> <em>lpdwThreadId</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00626">626</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00300">ConsoleInitWindowsLock</a>, <a class="el" href="../../d8/d5/consrv_8h.html#a132">ConsoleInputThread()</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00022">DefaultRegInfo</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00067">_INPUT_THREAD_INIT_INFO::DesktopHandle</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d2/d9/tdisp_8c-source.html#l00009">ErrorExit()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00050">fOneTimeInitialized</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00039">FullScreenInitialized</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l02210">GetRegistryValues()</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00066">_INPUT_THREAD_INIT_INFO::InitCompleteEventHandle</a>, <a class="el" href="../../d0/d3/dbcs_8h.html#a44">InitializeDbcsMisc()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l02089">InitializeFullScreen()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l02631">InitializeScrollBuffer()</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00068">_INPUT_THREAD_INIT_INFO::InitStatus</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00180">NtCreateEvent()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>, <a class="el" href="../../d2/d1/psspnd_8c-source.html#l00138">NtResumeThread()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l00870">NtUserConsoleControl()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00282">NtWaitForSingleObject()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l01241">RtlCreateUserThread()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00065">_INPUT_THREAD_INIT_INFO::ThreadHandle</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00955">SetUpConsole()</a>.
<p>
<pre class="fragment"><div>00629 {
00630     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00631     CLIENT_ID ClientId;
00632     CONSOLEDESKTOPCONSOLETHREAD ConsoleDesktopInfo;
00633     <a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html">INPUT_THREAD_INIT_INFO</a> InputThreadInitInfo;
00634 
00635     <span class="comment">//</span>
00636     <span class="comment">// This routine must be done within a critical section to ensure that</span>
00637     <span class="comment">// only one thread can initialize at a time. We need a special critical</span>
00638     <span class="comment">// section here because Csr calls into ConsoleAddProcessRoutine with</span>
00639     <span class="comment">// it's own critical section locked and then tries to grab the</span>
00640     <span class="comment">// ConsoleHandleTableLock. If we call CsrAddStaticServerThread here</span>
00641     <span class="comment">// with the ConsoleHandleTableLock locked we could get into a deadlock</span>
00642     <span class="comment">// situation. This critical section should not be used anywhere else.</span>
00643     <span class="comment">//</span>
00644 
00645     RtlEnterCriticalSection(&amp;ConsoleInitWindowsLock);
00646 
00647     ConsoleDesktopInfo.hdesk = hdesk;
00648     ConsoleDesktopInfo.dwThreadId = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1;
00649     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">NtUserConsoleControl</a>(ConsoleDesktopConsoleThread, &amp;ConsoleDesktopInfo,
00650             <span class="keyword">sizeof</span>(ConsoleDesktopInfo));
00651     <span class="keywordflow">if</span> (ConsoleDesktopInfo.dwThreadId == 0) {
00652 
00653         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a21">fOneTimeInitialized</a>) {
00654 
00655 <span class="preprocessor">#if defined(FE_SB)</span>
00656 <span class="preprocessor"></span>            <a class="code" href="../../d0/d3/dbcs_8h.html#a44">InitializeDbcsMisc</a>();
00657 <span class="preprocessor">#endif</span>
00658 <span class="preprocessor"></span>
00659             <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a12">FullScreenInitialized</a> = <a class="code" href="../../d7/d4/server_2private_8c.html#a55">InitializeFullScreen</a>();
00660 
00661             <span class="comment">//</span>
00662             <span class="comment">// read the registry values</span>
00663             <span class="comment">//</span>
00664 
00665             <a class="code" href="../../d0/d5/srvinit_8c.html#a44">GetRegistryValues</a>(L<span class="stringliteral">""</span>, &amp;DefaultRegInfo);
00666 
00667             <span class="comment">//</span>
00668             <span class="comment">// allocate buffer for scrolling</span>
00669             <span class="comment">//</span>
00670 
00671             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/output_8c.html#a59">InitializeScrollBuffer</a>();
00672             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00673             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00674                 <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00675         }
00676 
00677         <span class="comment">//</span>
00678         <span class="comment">// create GetMessage thread</span>
00679         <span class="comment">//</span>
00680 
00681         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/ex_2event_8c.html#a5">NtCreateEvent</a>(&amp;InputThreadInitInfo.<a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html#o1">InitCompleteEventHandle</a>, EVENT_ALL_ACCESS,
00682                                NULL, NotificationEvent, FALSE);
00683         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00684             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00685         }
00686 
00687         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(NtCurrentProcess(), hdesk,
00688                 NtCurrentProcess(), &amp;InputThreadInitInfo.<a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html#o2">DesktopHandle</a>, 0,
00689                 0, DUPLICATE_SAME_ACCESS);
00690         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00691             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(InputThreadInitInfo.<a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html#o1">InitCompleteEventHandle</a>);
00692             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00693         }
00694 
00695         <span class="comment">// can't call CreateThread from server</span>
00696         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/rtlexec_8c.html#a13">RtlCreateUserThread</a>(NtCurrentProcess(),
00697                                      (PSECURITY_DESCRIPTOR) NULL,
00698                                      TRUE,
00699                                      0,
00700                                      0,
00701                                      0,
00702                                      (PUSER_THREAD_START_ROUTINE)ConsoleInputThread,
00703                                      &amp;InputThreadInitInfo,
00704                                      &amp;InputThreadInitInfo.<a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html#o0">ThreadHandle</a>,
00705                                      &amp;ClientId
00706                                     );
00707         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00708             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(InputThreadInitInfo.<a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html#o1">InitCompleteEventHandle</a>);
00709             CloseDesktop(InputThreadInitInfo.<a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html#o2">DesktopHandle</a>);
00710             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00711         }
00712 
00713         CsrAddStaticServerThread(InputThreadInitInfo.<a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html#o0">ThreadHandle</a>,&amp;ClientId,0);
00714         <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(InputThreadInitInfo.<a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html#o0">ThreadHandle</a>, NULL);
00715         <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>(InputThreadInitInfo.<a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html#o1">InitCompleteEventHandle</a>, FALSE, NULL);
00716         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(InputThreadInitInfo.<a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html#o1">InitCompleteEventHandle</a>);
00717 
00718         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(InputThreadInitInfo.<a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html#o3">InitStatus</a>)) {
00719             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00720         }
00721 
00722         *lpdwThreadId = HandleToUlong(ClientId.UniqueThread);
00723 
00724         <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a21">fOneTimeInitialized</a>=<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00725     } <span class="keywordflow">else</span> {
00726         *lpdwThreadId = ConsoleDesktopInfo.dwThreadId;
00727     }
00728 
00729 <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>:
00730     RtlLeaveCriticalSection(&amp;ConsoleInitWindowsLock);
00731 
00732     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00733 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="srvinit.c::LoadLinkInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LoadLinkInfo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d3/struct__CONSOLE__INFO.html">PCONSOLE_INFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ConsoleInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>Title</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPDWORD&nbsp;</td>
          <td class="mdname" nowrap> <em>TitleLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>CurDir</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>AppName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00360">360</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
References <a class="el" href="../../d2/d6/server_8h-source.html#l00426">_CONSOLE_REGISTRY_INFO::AutoPosition</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00432">_CONSOLE_REGISTRY_INFO::ColorTable</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00422">_CONSOLE_REGISTRY_INFO::CursorSize</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00022">DefaultRegInfo</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00051">_CONSOLE_INFO::dwHotKey</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00052">_CONSOLE_INFO::dwStartupFlags</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00421">_CONSOLE_REGISTRY_INFO::FaceName</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00065">_CONSOLE_INFO::FaceName</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00419">_CONSOLE_REGISTRY_INFO::FontFamily</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00418">_CONSOLE_REGISTRY_INFO::FontSize</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00420">_CONSOLE_REGISTRY_INFO::FontWeight</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00423">_CONSOLE_REGISTRY_INFO::FullScreen</a>, <a class="el" href="../../d4/d3/link_8c-source.html#l00264">GetLinkProperties()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l02210">GetRegistryValues()</a>, <a class="el" href="../../d4/d3/link_8c-source.html#l00016">GetTitleFromLinkName()</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00028">ghDefaultIcon</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00029">ghDefaultSmIcon</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00049">_CONSOLE_INFO::hIcon</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00429">_CONSOLE_REGISTRY_INFO::HistoryBufferSize</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00431">_CONSOLE_REGISTRY_INFO::HistoryNoDup</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00050">_CONSOLE_INFO::hSmIcon</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00048">_CONSOLE_INFO::iIconId</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00425">_CONSOLE_REGISTRY_INFO::InsertMode</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00025">INT</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00898">LINK_NOINFO</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00899">LINK_SIMPLEINFO</a>, <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00065">MAX_PATH</a>, <a class="el" href="../../d6/d3/acpitabl_8h-source.html#l00366">min</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00430">_CONSOLE_REGISTRY_INFO::NumberOfHistoryBuffers</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00025">OEMCP</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00428">_CONSOLE_REGISTRY_INFO::PopupFill</a>, <a class="el" href="../../d7/d9/extract_8c-source.html#l01072">PrivateExtractIconExW()</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00424">_CONSOLE_REGISTRY_INFO::QuickEdit</a>, <a class="el" href="../../d6/d0/curdir_8c-source.html#l02156">RtlDosSearchPath_U()</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00415">_CONSOLE_REGISTRY_INFO::ScreenBufferSize</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00427">_CONSOLE_REGISTRY_INFO::ScreenFill</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00417">_CONSOLE_REGISTRY_INFO::WindowOrigin</a>, and <a class="el" href="../../d2/d6/server_8h-source.html#l00416">_CONSOLE_REGISTRY_INFO::WindowSize</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00955">SetUpConsole()</a>.
<p>
<pre class="fragment"><div>00367 {
00368     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwLinkLen;
00369     WCHAR LinkName[ <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>+1 ];
00370     <a class="code" href="../../d2/d9/structLNKPROPNTCONSOLE.html">LNKPROPNTCONSOLE</a> linkprops;
00371     LPWSTR pszIconLocation;
00372     <span class="keywordtype">int</span> nIconIndex;
00373 
00374     ConsoleInfo-&gt;uCodePage = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>;
00375 
00376     <span class="comment">// Do some initialization</span>
00377     ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o7">hIcon</a> = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a5">ghDefaultIcon</a>;
00378     ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o8">hSmIcon</a> = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a6">ghDefaultSmIcon</a>;
00379     pszIconLocation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00380     nIconIndex = 0;
00381 
00382     <span class="comment">// Try to impersonate the client-side thread</span>
00383     <span class="keywordflow">if</span> (!CsrImpersonateClient(NULL)) {
00384         ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o10">dwStartupFlags</a> &amp;= (~STARTF_TITLEISLINKNAME);
00385         <span class="keywordflow">goto</span> DefaultInit;
00386     }
00387 
00388     <span class="comment">// Did we get started from a link?</span>
00389     <span class="keywordflow">if</span> (ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o10">dwStartupFlags</a> &amp; STARTF_TITLEISLINKNAME) {
00390 
00391         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Success;
00392         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> oldLen;
00393 
00394         <span class="comment">// Get the filename of the link (TitleLength is BYTES, not CHARS)</span>
00395         dwLinkLen = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(<a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(*TitleLength,(MAX_PATH+1)*<span class="keyword">sizeof</span>(WCHAR)));
00396         RtlCopyMemory(LinkName,Title,dwLinkLen);
00397         LinkName[ <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a> ] = (WCHAR)0;
00398 
00399 
00400         <span class="comment">// Get the title for the window, which is effectively the link file name</span>
00401         oldLen = *TitleLength;
00402         *TitleLength = <a class="code" href="../../d3/d4/link_8c.html#a0">GetTitleFromLinkName</a>( LinkName, Title );
00403         <span class="keywordflow">if</span> (*TitleLength &lt; oldLen)
00404             Title[ *TitleLength / <span class="keyword">sizeof</span>(WCHAR) ] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00405 
00406         <span class="comment">// try to get console properties from the link</span>
00407         Success =  <a class="code" href="../../d3/d4/link_8c.html#a3">GetLinkProperties</a>( LinkName,
00408                                       &amp;linkprops,
00409                                       <span class="keyword">sizeof</span>(linkprops)
00410                                      );
00411 
00412         <span class="keywordflow">if</span> (Success == <a class="code" href="../../d8/d5/consrv_8h.html#a47">LINK_NOINFO</a>) {
00413             ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o10">dwStartupFlags</a> &amp;= (~STARTF_TITLEISLINKNAME);
00414             <span class="keywordflow">goto</span> NormalInit;
00415         }
00416 
00417         <span class="keywordflow">if</span> (linkprops.<a class="code" href="../../d2/d9/structLNKPROPNTCONSOLE.html#o1">pszIconLocation</a> &amp;&amp; *linkprops.<a class="code" href="../../d2/d9/structLNKPROPNTCONSOLE.html#o1">pszIconLocation</a>) {
00418             pszIconLocation = linkprops.<a class="code" href="../../d2/d9/structLNKPROPNTCONSOLE.html#o1">pszIconLocation</a>;
00419             nIconIndex = linkprops.<a class="code" href="../../d2/d9/structLNKPROPNTCONSOLE.html#o2">uIcon</a>;
00420             ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o6">iIconId</a> = 0;
00421         }
00422 
00423         <span class="comment">// Transfer link settings</span>
00424         ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o9">dwHotKey</a> = linkprops.<a class="code" href="../../d2/d9/structLNKPROPNTCONSOLE.html#o4">uHotKey</a>;
00425         ConsoleInfo-&gt;wShowWindow = (WORD)linkprops.<a class="code" href="../../d2/d9/structLNKPROPNTCONSOLE.html#o3">uShowCmd</a>;
00426 
00427         <span class="keywordflow">if</span> (Success == <a class="code" href="../../d8/d5/consrv_8h.html#a48">LINK_SIMPLEINFO</a>) {
00428             ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o10">dwStartupFlags</a> &amp;= (~STARTF_TITLEISLINKNAME);
00429             <span class="keywordflow">goto</span> NormalInit;
00430         }
00431 
00432         <span class="comment">// Transfer console link settings</span>
00433         ConsoleInfo-&gt;wFillAttribute = linkprops.<a class="code" href="../../d2/d9/structLNKPROPNTCONSOLE.html#o5">console_props</a>.wFillAttribute;
00434         ConsoleInfo-&gt;wPopupFillAttribute = linkprops.<a class="code" href="../../d2/d9/structLNKPROPNTCONSOLE.html#o5">console_props</a>.wPopupFillAttribute;
00435 
00436         RtlCopyMemory( &amp;ConsoleInfo-&gt;dwScreenBufferSize,
00437                        &amp;linkprops.<a class="code" href="../../d2/d9/structLNKPROPNTCONSOLE.html#o5">console_props</a>.dwScreenBufferSize,
00438                        <span class="keyword">sizeof</span>(NT_CONSOLE_PROPS) - FIELD_OFFSET(NT_CONSOLE_PROPS, dwScreenBufferSize)
00439                       );
00440 
00441         ConsoleInfo-&gt;uCodePage = linkprops.fe_console_props.uCodePage;
00442 
00443 <span class="preprocessor">#if 0</span>
00444 <span class="preprocessor"></span>        {
00445 
00446             <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> i;
00447 
00448             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"[LoadLinkInfo Properties for %ws]\n"</span>, Title );
00449             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    wFillAttribute      = 0x%04X\n"</span>, ConsoleInfo-&gt;wFillAttribute );
00450             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    wPopupFillAttribute = 0x%04X\n"</span>, ConsoleInfo-&gt;wPopupFillAttribute );
00451             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    dwScreenBufferSize  = (%d , %d)\n"</span>, ConsoleInfo-&gt;dwScreenBufferSize.X, ConsoleInfo-&gt;dwScreenBufferSize.Y );
00452             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    dwWindowSize        = (%d , %d)\n"</span>, ConsoleInfo-&gt;dwWindowSize.X, ConsoleInfo-&gt;dwWindowSize.Y );
00453             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    dwWindowOrigin      = (%d , %d)\n"</span>, ConsoleInfo-&gt;dwWindowOrigin.X, ConsoleInfo-&gt;dwWindowOrigin.Y );
00454             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    nFont               = 0x%X\n"</span>, ConsoleInfo-&gt;nFont );
00455             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    nInputBufferSize    = 0x%X\n"</span>, ConsoleInfo-&gt;nInputBufferSize );
00456             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    dwFontSize          = (%d , %d)\n"</span>, ConsoleInfo-&gt;dwFontSize.X, ConsoleInfo-&gt;dwFontSize.Y );
00457             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    uFontFamily         = 0x%08X\n"</span>, ConsoleInfo-&gt;uFontFamily );
00458             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    uFontWeight         = 0x%08X\n"</span>, ConsoleInfo-&gt;uFontWeight );
00459             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    FaceName            = %ws\n"</span>, ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o23">FaceName</a> );
00460             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    uCursorSize         = %d\n"</span>, ConsoleInfo-&gt;uCursorSize );
00461             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    bFullScreen         = %s\n"</span>, ConsoleInfo-&gt;bFullScreen ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span> );
00462             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    bQuickEdit          = %s\n"</span>, ConsoleInfo-&gt;bQuickEdit  ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span> );
00463             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    bInsertMode         = %s\n"</span>, ConsoleInfo-&gt;bInsertMode ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span> );
00464             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    bAutoPosition       = %s\n"</span>, ConsoleInfo-&gt;bAutoPosition ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span> );
00465             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    uHistoryBufferSize  = %d\n"</span>, ConsoleInfo-&gt;uHistoryBufferSize );
00466             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    uNumHistoryBuffers  = %d\n"</span>, ConsoleInfo-&gt;uNumberOfHistoryBuffers );
00467             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    bHistoryNoDup       = %s\n"</span>, ConsoleInfo-&gt;bHistoryNoDup ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span> );
00468             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    ColorTable = ["</span> );
00469             i=0;
00470             <span class="keywordflow">while</span>( i &lt; 16 )
00471             {
00472                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n         "</span>);
00473                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"0x%08X "</span>, ConsoleInfo-&gt;ColorTable[i++]);
00474                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"0x%08X "</span>, ConsoleInfo-&gt;ColorTable[i++]);
00475                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"0x%08X "</span>, ConsoleInfo-&gt;ColorTable[i++]);
00476                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"0x%08X "</span>, ConsoleInfo-&gt;ColorTable[i++]);
00477             }
00478             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"]\n\n"</span> );
00479         }
00480 <span class="preprocessor">#endif</span>
00481 <span class="preprocessor"></span>
00482         ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o10">dwStartupFlags</a> &amp;= ~(STARTF_USESIZE | STARTF_USECOUNTCHARS);
00483     }
00484 
00485 NormalInit:
00486 
00487     <span class="comment">//</span>
00488     <span class="comment">// Go get the icon</span>
00489     <span class="comment">//</span>
00490 
00491     <span class="keywordflow">if</span> (pszIconLocation == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00492         dwLinkLen = <a class="code" href="../../d5/d1/curdir_8c.html#a32">RtlDosSearchPath_U</a>(CurDir,
00493                                        AppName,
00494                                        NULL,
00495                                        <span class="keyword">sizeof</span>(LinkName),
00496                                        LinkName,
00497                                        NULL);
00498         <span class="keywordflow">if</span> (dwLinkLen &gt; 0 &amp;&amp; dwLinkLen &lt; <span class="keyword">sizeof</span>(LinkName)) {
00499             pszIconLocation = LinkName;
00500         } <span class="keywordflow">else</span> {
00501             pszIconLocation = AppName;
00502         }
00503     }
00504 
00505     <span class="keywordflow">if</span> (pszIconLocation != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00506         HICON hIcon, hSmIcon;
00507         hIcon = hSmIcon = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00508         <a class="code" href="../../d6/d0/extract_8c.html#a47">PrivateExtractIconExW</a>(pszIconLocation,
00509                               nIconIndex,
00510                               &amp;hIcon,
00511                               &amp;hSmIcon,
00512                               1);
00513         <span class="comment">/*</span>
00514 <span class="comment">         * If there is no large icon, use the default ones</span>
00515 <span class="comment">         * If there is only a large icon in the resource, do not use</span>
00516 <span class="comment">         * the default small one but let it be NULL so we'll stretch the large one</span>
00517 <span class="comment">         */</span>
00518         <span class="keywordflow">if</span> (hIcon != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00519             ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o7">hIcon</a> = hIcon;
00520             ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o8">hSmIcon</a> = hSmIcon;
00521         }
00522     }
00523 
00524     CsrRevertToSelf();
00525 
00526     <span class="keywordflow">if</span> (! IsValidCodePage(ConsoleInfo-&gt;uCodePage)) {    <span class="comment">// fail safe</span>
00527         ConsoleInfo-&gt;uCodePage = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>;
00528     }
00529 
00530     <span class="keywordflow">if</span> (!(ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o10">dwStartupFlags</a> &amp; STARTF_TITLEISLINKNAME)) {
00531         <a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html">CONSOLE_REGISTRY_INFO</a> RegInfo;
00532 
00533 DefaultInit:
00534         <span class="comment">//</span>
00535         <span class="comment">// read values from the registry</span>
00536         <span class="comment">//</span>
00537 
00538         RegInfo = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>;
00539         <a class="code" href="../../d0/d5/srvinit_8c.html#a44">GetRegistryValues</a>(Title, &amp;RegInfo);
00540 
00541         <span class="comment">//</span>
00542         <span class="comment">// if a value isn't specified in STARTUPINFO, then use the one</span>
00543         <span class="comment">// from the registry.</span>
00544         <span class="comment">//</span>
00545 
00546         <span class="keywordflow">if</span> (!(ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o10">dwStartupFlags</a> &amp; STARTF_USEFILLATTRIBUTE)) {
00547             ConsoleInfo-&gt;wFillAttribute = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o12">ScreenFill</a>.Attributes;
00548         }
00549         ConsoleInfo-&gt;wPopupFillAttribute = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o13">PopupFill</a>.Attributes;
00550 
00551         <span class="keywordflow">if</span> (!(ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o10">dwStartupFlags</a> &amp; STARTF_USECOUNTCHARS)) {
00552             ConsoleInfo-&gt;dwScreenBufferSize = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o0">ScreenBufferSize</a>;
00553         }
00554         <span class="keywordflow">if</span> (!(ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o10">dwStartupFlags</a> &amp; STARTF_USESIZE)) {
00555             ConsoleInfo-&gt;dwWindowSize = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o1">WindowSize</a>;
00556         }
00557         <span class="keywordflow">if</span> (!(ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o10">dwStartupFlags</a> &amp; STARTF_USEPOSITION)) {
00558             ConsoleInfo-&gt;dwWindowOrigin = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o2">WindowOrigin</a>;
00559             ConsoleInfo-&gt;bAutoPosition = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o11">AutoPosition</a>;
00560         } <span class="keywordflow">else</span> {
00561             ConsoleInfo-&gt;bAutoPosition = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00562         }
00563         <span class="keywordflow">if</span> (!(ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o10">dwStartupFlags</a> &amp; STARTF_RUNFULLSCREEN)) {
00564             ConsoleInfo-&gt;bFullScreen = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o8">FullScreen</a>;
00565         } <span class="keywordflow">else</span> {
00566             ConsoleInfo-&gt;bFullScreen = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00567         }
00568 
00569         ConsoleInfo-&gt;uFontFamily = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o4">FontFamily</a>;
00570         ConsoleInfo-&gt;uFontWeight = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o5">FontWeight</a>;
00571         ConsoleInfo-&gt;dwFontSize = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o3">FontSize</a>;
00572         RtlCopyMemory(ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o23">FaceName</a>, RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o6">FaceName</a>, <span class="keyword">sizeof</span>(RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o6">FaceName</a>));
00573 
00574         ConsoleInfo-&gt;bQuickEdit = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o9">QuickEdit</a>;
00575         ConsoleInfo-&gt;bInsertMode = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o10">InsertMode</a>;
00576 
00577         ConsoleInfo-&gt;uCursorSize = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o7">CursorSize</a>;
00578         ConsoleInfo-&gt;uHistoryBufferSize = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o14">HistoryBufferSize</a>;
00579         ConsoleInfo-&gt;uNumberOfHistoryBuffers = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o15">NumberOfHistoryBuffers</a>;
00580         ConsoleInfo-&gt;bHistoryNoDup = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o16">HistoryNoDup</a>;
00581         RtlCopyMemory(ConsoleInfo-&gt;ColorTable, RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>, <span class="keyword">sizeof</span>(RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>));
00582 <span class="preprocessor">#ifdef FE_SB</span>
00583 <span class="preprocessor"></span>        ConsoleInfo-&gt;uCodePage = RegInfo.CodePage;
00584 <span class="preprocessor">#endif</span>
00585 <span class="preprocessor"></span>    }
00586 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="srvinit.c::MapHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL MapHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientProcessHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ServerHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientHandle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00874">874</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00789">AllocateConsole()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01091">ConsoleClientConnectRoutine()</a>, and <a class="el" href="../../d6/d0/w32_2ntcon_2server_2bitmap_8c-source.html#l00027">CreateConsoleBitmap()</a>.
<p>
<pre class="fragment"><div>00879 {
00880     <span class="comment">//</span>
00881     <span class="comment">// map event handle into dll's handle space.</span>
00882     <span class="comment">//</span>
00883 
00884     <span class="keywordflow">return</span> DuplicateHandle(NtCurrentProcess(),
00885                            ServerHandle,
00886                            ClientProcessHandle,
00887                            ClientHandle,
00888                            0,
00889                            FALSE,
00890                            DUPLICATE_SAME_ACCESS
00891                           );
00892 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="srvinit.c::MyRegOpenKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MyRegOpenKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>hKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LPWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>lpSubKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>phResult</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01635">1635</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
References <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l02210">GetRegistryValues()</a>, and <a class="el" href="../../d1/d6/server_2server_8c-source.html#l01068">GetTimeouts()</a>.
<p>
<pre class="fragment"><div>01640 {
01641     OBJECT_ATTRIBUTES   Obja;
01642     UNICODE_STRING      SubKey;
01643 
01644     <span class="comment">//</span>
01645     <span class="comment">// Convert the subkey to a counted Unicode string.</span>
01646     <span class="comment">//</span>
01647 
01648     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;SubKey, lpSubKey );
01649 
01650     <span class="comment">//</span>
01651     <span class="comment">// Initialize the OBJECT_ATTRIBUTES structure and open the key.</span>
01652     <span class="comment">//</span>
01653 
01654     InitializeObjectAttributes(
01655         &amp;Obja,
01656         &amp;SubKey,
01657         OBJ_CASE_INSENSITIVE,
01658         hKey,
01659         NULL
01660         );
01661 
01662     <span class="keywordflow">return</span> <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(
01663               phResult,
01664               KEY_READ,
01665               &amp;Obja
01666               );
01667 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="srvinit.c::MyRegQueryValue" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MyRegQueryValue           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>hKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LPWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>lpValueName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>dwValueLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT LPBYTE&nbsp;</td>
          <td class="mdname" nowrap> <em>lpData</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01670">1670</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00180">ConsoleHeapAlloc</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00193">ConsoleHeapFree</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00062">TMP_TAG</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l02210">GetRegistryValues()</a>.
<p>
<pre class="fragment"><div>01676 {
01677     UNICODE_STRING <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
01678     ULONG BufferLength;
01679     ULONG ResultLength;
01680     PKEY_VALUE_PARTIAL_INFORMATION KeyValueInformation;
01681     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01682 
01683     <span class="comment">//</span>
01684     <span class="comment">// Convert the subkey to a counted Unicode string.</span>
01685     <span class="comment">//</span>
01686 
01687     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;ValueName, lpValueName );
01688 
01689     BufferLength = FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION, Data) + dwValueLength;
01690     KeyValueInformation = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TMP_TAG ),BufferLength);
01691     <span class="keywordflow">if</span> (KeyValueInformation == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01692         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01693 
01694     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
01695                 hKey,
01696                 &amp;ValueName,
01697                 KeyValuePartialInformation,
01698                 KeyValueInformation,
01699                 BufferLength,
01700                 &amp;ResultLength
01701                 );
01702     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01703         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeyValueInformation-&gt;DataLength &lt;= dwValueLength);
01704         RtlCopyMemory(lpData,
01705             KeyValueInformation-&gt;Data,
01706             KeyValueInformation-&gt;DataLength);
01707         <span class="keywordflow">if</span> (KeyValueInformation-&gt;Type == REG_SZ ||
01708             KeyValueInformation-&gt;Type == REG_MULTI_SZ
01709            ) {
01710             <span class="keywordflow">if</span> (KeyValueInformation-&gt;DataLength + <span class="keyword">sizeof</span>(WCHAR) &gt; dwValueLength) {
01711                 KeyValueInformation-&gt;DataLength -= <span class="keyword">sizeof</span>(WCHAR);
01712             }
01713             lpData[KeyValueInformation-&gt;DataLength++] = 0;
01714             lpData[KeyValueInformation-&gt;DataLength] = 0;
01715         }
01716     }
01717     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(KeyValueInformation);
01718     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01719 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="srvinit.c::NonConsoleProcessShutdown" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG NonConsoleProcessShutdown           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PCSR_PROCESS&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>dwFlags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l02088">2088</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l03502">CreateCtrlThread()</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00033">CtrlRoutine</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00458">_CONSOLE_PROCESS_TERMINATION_RECORD::CtrlRoutine</a>, <a class="el" href="../../d4/d7/propapi_8h-source.html#l00043">dwFlags</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00455">_CONSOLE_PROCESS_TERMINATION_RECORD::ProcessHandle</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00076">SHUTDOWN_KNOWN_PROCESS</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00456">_CONSOLE_PROCESS_TERMINATION_RECORD::TerminateCount</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01912">ConsoleClientShutdown()</a>.
<p>
<pre class="fragment"><div>02092 {
02093     <a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html">CONSOLE_PROCESS_TERMINATION_RECORD</a> TerminateRecord;
02094     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> EventType;
02095     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> Success;
02096     HANDLE ProcessHandle;
02097 
02098     Success = DuplicateHandle(NtCurrentProcess(),
02099             Process-&gt;ProcessHandle,
02100             NtCurrentProcess(),
02101             &amp;ProcessHandle,
02102             0,
02103             FALSE,
02104             DUPLICATE_SAME_ACCESS);
02105 
02106     <span class="keywordflow">if</span> (!Success)
02107         ProcessHandle = Process-&gt;ProcessHandle;
02108 
02109     TerminateRecord.<a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html#o0">ProcessHandle</a> = ProcessHandle;
02110     TerminateRecord.<a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html#o1">TerminateCount</a> = 0;
02111     TerminateRecord.<a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html#o3">CtrlRoutine</a> = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a10">CtrlRoutine</a>;
02112 
02113     CsrDereferenceProcess(Process);
02114 
02115     EventType = CTRL_LOGOFF_EVENT;
02116     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; EWX_SHUTDOWN)
02117         EventType = CTRL_SHUTDOWN_EVENT;
02118 
02119     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a52">CreateCtrlThread</a>(&amp;TerminateRecord,
02120             1,
02121             NULL,
02122             EventType,
02123             TRUE);
02124 
02125     <span class="keywordflow">if</span> (Success)
02126         CloseHandle(ProcessHandle);
02127 
02128     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a13">SHUTDOWN_KNOWN_PROCESS</a>;
02129 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="srvinit.c::RemoveConsole" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RemoveConsole           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessId</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01355">1355</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02844">CloseInputHandle()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02929">CloseOutputHandle()</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00295">CONSOLE_FREE_HANDLE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00099">CONSOLE_FULLSCREEN_NOPAINT</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00026">CONSOLE_INPUT_HANDLE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00092">CONSOLE_NOTIFY_LAST_CLOSE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00094">CONSOLE_VDM_REGISTERED</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00221">_CONSOLE_INFORMATION::ConsoleHandle</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00193">ConsoleHeapFree</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l03502">CreateCtrlThread()</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00033">CtrlRoutine</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00458">_CONSOLE_PROCESS_TERMINATION_RECORD::CtrlRoutine</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01501">DereferenceIoHandleNoCheck()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00164">_CONSOLE_INFORMATION::Flags</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l04605">FreeCommandHistory()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01110">FreeCon()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01280">FreeProcessData()</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00311">_HANDLE_DATA::HandleType</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00231">_CONSOLE_INFORMATION::hProcessLastNotifyClose</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00455">_CONSOLE_PROCESS_TERMINATION_RECORD::ProcessHandle</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00232">_CONSOLE_INFORMATION::ProcessIdLastNotifyClose</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00130">_CONSOLE_INFORMATION::RefCount</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00932">RemoveProcessFromList()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01686">RevalidateConsole()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00456">_CONSOLE_PROCESS_TERMINATION_RECORD::TerminateCount</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00980">UnregisterVDM()</a>, and <a class="el" href="../../d2/d6/server_8h-source.html#l00196">_CONSOLE_INFORMATION::VDMProcessId</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01091">ConsoleClientConnectRoutine()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01482">ConsoleClientDisconnectRoutine()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01608">SrvFreeConsole()</a>, and <a class="el" href="../../d1/d4/ntcon_2conime_2conime_8c-source.html#l00288">WndProc()</a>.
<p>
<pre class="fragment"><div>01360 {
01361     ULONG i;
01362     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
01363     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01364     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
01365 
01366     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a34">RevalidateConsole</a>(ProcessData-&gt;ConsoleHandle, &amp;Console);
01367 
01368     <span class="comment">//</span>
01369     <span class="comment">// If this process isn't using the console, error.</span>
01370     <span class="comment">//</span>
01371 
01372     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01373         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
01374         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01375     }
01376 
01377     <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a7">CONSOLE_NOTIFY_LAST_CLOSE</a>) {
01378         <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o73">ProcessIdLastNotifyClose</a> == ProcessId) {
01379             <span class="comment">// if this process is the one who wants last close notification,</span>
01380             <span class="comment">// remove it.</span>
01381             Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a7">CONSOLE_NOTIFY_LAST_CLOSE</a>;
01382             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o72">hProcessLastNotifyClose</a>);
01383         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ProcessData-&gt;RootProcess) {
01384             <span class="comment">// notify the ntvdm process to terminate if the console root</span>
01385             <span class="comment">// process is going away.</span>
01386             HANDLE ConsoleHandle;
01387             <a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html">CONSOLE_PROCESS_TERMINATION_RECORD</a> ProcessHandleList;
01388 
01389             Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a7">CONSOLE_NOTIFY_LAST_CLOSE</a>;
01390             ConsoleHandle = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o65">ConsoleHandle</a>;
01391             ProcessHandleList.<a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html#o0">ProcessHandle</a> = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o72">hProcessLastNotifyClose</a>;
01392             ProcessHandleList.<a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html#o1">TerminateCount</a> = 0;
01393             ProcessHandleList.<a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html#o3">CtrlRoutine</a> = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a10">CtrlRoutine</a>;
01394             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01395             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a52">CreateCtrlThread</a>(&amp;ProcessHandleList,
01396                             1,
01397                             NULL,
01398                             SYSTEM_ROOT_CONSOLE_EVENT,
01399                             TRUE);
01400             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(ProcessHandleList.<a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html#o0">ProcessHandle</a>);
01401             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a34">RevalidateConsole</a>(ConsoleHandle, &amp;Console);
01402             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
01403             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01404                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01405             }
01406         }
01407     }
01408 
01409     <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o52">VDMProcessId</a> == ProcessId &amp;&amp;
01410         (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>)) {
01411         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a14">CONSOLE_FULLSCREEN_NOPAINT</a>;
01412         <a class="code" href="../../d0/d5/srvinit_8c.html#a22">UnregisterVDM</a>(Console);
01413     }
01414 
01415     <span class="keywordflow">if</span> (ProcessHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01416         <a class="code" href="../../d0/d5/srvinit_8c.html#a35">RemoveProcessFromList</a>(Console,ProcessHandle);
01417         <a class="code" href="../../d8/d5/consrv_8h.html#a259">FreeCommandHistory</a>(Console,ProcessHandle);
01418     }
01419 
01420     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o1">RefCount</a>);
01421 
01422     <span class="comment">//</span>
01423     <span class="comment">// close the process's handles.</span>
01424     <span class="comment">//</span>
01425 
01426     <span class="keywordflow">for</span> (i=0;i&lt;ProcessData-&gt;HandleTableSize;i++) {
01427         <span class="keywordflow">if</span> (ProcessData-&gt;HandleTablePtr[i].HandleType != <a class="code" href="../../d1/d7/server_8h.html#a47">CONSOLE_FREE_HANDLE</a>) {
01428             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(ProcessData,
01429                                                 (HANDLE) i,
01430                                                 &amp;HandleData
01431                                                );
01432             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
01433             <span class="keywordflow">if</span> (HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> &amp; <a class="code" href="../../d5/d5/conmsg_8h.html#a0">CONSOLE_INPUT_HANDLE</a>) {
01434                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a35">CloseInputHandle</a>(ProcessData,Console,HandleData,(HANDLE) i);
01435             }
01436             <span class="keywordflow">else</span> {
01437                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a36">CloseOutputHandle</a>(ProcessData,Console,HandleData,(HANDLE) i,FALSE);
01438             }
01439         }
01440     }
01441     <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a25">FreeProcessData</a>(ProcessData);
01442     ProcessData-&gt;ConsoleHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01443 
01444     <span class="comment">//</span>
01445     <span class="comment">// decrement the console reference count.  free the console if it goes to</span>
01446     <span class="comment">// zero.</span>
01447     <span class="comment">//</span>
01448 
01449     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o1">RefCount</a>--;
01450     <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o1">RefCount</a> == 0) {
01451 
01452 <span class="preprocessor">#if defined(FE_IME)</span>
01453 <span class="preprocessor"></span>
01454         PCONVERSIONAREA_INFORMATION ConvAreaInfo;
01455         PCONVERSIONAREA_INFORMATION ConvAreaInfoNext;
01456 
01457         ConvAreaInfo = Console-&gt;ConsoleIme.ConvAreaRoot;
01458         <span class="keywordflow">while</span>(ConvAreaInfo) {
01459             ConvAreaInfoNext = ConvAreaInfo-&gt;ConvAreaNext;
01460             FreeConvAreaScreenBuffer(ConvAreaInfo-&gt;ScreenBuffer);
01461             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ConvAreaInfo);
01462             ConvAreaInfo = ConvAreaInfoNext;
01463         }
01464 
01465         <span class="keywordflow">if</span> (Console-&gt;ConsoleIme.NumberOfConvAreaCompStr) {
01466             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Console-&gt;ConsoleIme.ConvAreaCompStr);
01467         }
01468         <span class="keywordflow">if</span> (Console-&gt;ConsoleIme.CompStrData) {
01469             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Console-&gt;ConsoleIme.CompStrData);
01470         }
01471 <span class="preprocessor">#endif</span>
01472 <span class="preprocessor"></span>        <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a21">FreeCon</a>(Console);
01473     }
01474     <span class="keywordflow">else</span> {
01475         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01476     }
01477     <span class="keywordflow">return</span>( STATUS_SUCCESS );
01478 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="srvinit.c::RemoveProcessFromList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RemoveProcessFromList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Console</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00932">932</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00193">ConsoleHeapFree</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00046">_CONSOLE_PROCESS_HANDLE::ListLink</a>, and <a class="el" href="../../d2/d6/server_8h-source.html#l00047">_CONSOLE_PROCESS_HANDLE::ProcessHandle</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01355">RemoveConsole()</a>.
<p>
<pre class="fragment"><div>00936 {
00937     <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">PCONSOLE_PROCESS_HANDLE</a> ProcessHandleRecord;
00938     PLIST_ENTRY ListHead, ListNext;
00939 
00940     ListHead = &amp;Console-&gt;ProcessHandleList;
00941     ListNext = ListHead-&gt;Flink;
00942     <span class="keywordflow">while</span> (ListNext != ListHead) {
00943         ProcessHandleRecord = CONTAINING_RECORD( ListNext, <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">CONSOLE_PROCESS_HANDLE</a>, ListLink );
00944         ListNext = ListNext-&gt;Flink;
00945         <span class="keywordflow">if</span> (ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o1">ProcessHandle</a> == ProcessHandle) {
00946             RemoveEntryList(&amp;ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o0">ListLink</a>);
00947             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ProcessHandleRecord);
00948             <span class="keywordflow">return</span>;
00949         }
00950     }
00951     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FALSE);
00952 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="srvinit.c::SetUpConsole" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SetUpConsole           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d0/d3/struct__CONSOLE__INFO.html">PCONSOLE_INFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ConsoleInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TitleLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LPWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>Title</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LPWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>CurDir</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LPWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>AppName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>WindowVisible</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>pstrDesktopName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00955">955</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
References <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00789">AllocateConsole()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00269">AllocateConsoleHandle()</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d4/d9/user32_8def-source.html#l00631">CloseWindowStation</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00380">CONSOLE_CLIENTPROCESSHANDLE</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00150">CONSOLE_IS_IME_ENABLED</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00404">CONSOLE_SETCONSOLEHANDLE</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00175">DereferenceConsoleHandle()</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00331">FreeConsoleHandle()</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00136">_CONSOLE_INFORMATION::hDesk</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00135">_CONSOLE_INFORMATION::hWinSta</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00626">InitWindowsStuff()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00360">LoadLinkInfo()</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00258">LockConsoleHandleTable</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l01365">NtUserResolveDesktop()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00130">_CONSOLE_INFORMATION::RefCount</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00259">UnlockConsoleHandleTable</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01091">ConsoleClientConnectRoutine()</a>, and <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01537">SrvAllocConsole()</a>.
<p>
<pre class="fragment"><div>00965 {
00966     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00967     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
00968     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> ConsoleThreadId;
00969     HWINSTA hwinsta;
00970     HDESK hdesk;
00971     USEROBJECTFLAGS UserObjectFlags;
00972     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Length;
00973 
00974     <span class="comment">//</span>
00975     <span class="comment">// Connect to the windowstation and desktop.</span>
00976     <span class="comment">//</span>
00977 
00978     <span class="keywordflow">if</span> (!CsrImpersonateClient(NULL)) {
00979         <span class="keywordflow">return</span> STATUS_BAD_IMPERSONATION_LEVEL;
00980     }
00981 
00982     hdesk = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a97">NtUserResolveDesktop</a>(<a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>(),
00983             pstrDesktopName, FALSE, &amp;hwinsta);
00984 
00985     CsrRevertToSelf();
00986 
00987     <span class="keywordflow">if</span> (hdesk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00988         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00989     }
00990 
00991     <span class="comment">//</span>
00992     <span class="comment">// Need to initialize windows stuff once real console app starts.</span>
00993     <span class="comment">// This is because for the time being windows expects the first</span>
00994     <span class="comment">// app to be a windows app.</span>
00995     <span class="comment">//</span>
00996 
00997     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/srvinit_8c.html#a30">InitWindowsStuff</a>(hdesk, &amp;ConsoleThreadId);
00998     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00999         CloseDesktop(hdesk);
01000         <a class="code" href="../../d3/d0/user32_8def.html#a72">CloseWindowStation</a>(hwinsta);
01001         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01002     }
01003 
01004     <span class="comment">//</span>
01005     <span class="comment">// If the windowstation isn't visible, then neither is the window.</span>
01006     <span class="comment">//</span>
01007 
01008     <span class="keywordflow">if</span> (WindowVisible) {
01009         <span class="keywordflow">if</span> (GetUserObjectInformation(hwinsta,
01010                                      UOI_FLAGS,
01011                                      &amp;UserObjectFlags,
01012                                      <span class="keyword">sizeof</span>(UserObjectFlags),
01013                                      &amp;Length)) {
01014             <span class="keywordflow">if</span> (!(UserObjectFlags.dwFlags &amp; WSF_VISIBLE)) {
01015                 WindowVisible = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01016             }
01017         }
01018     }
01019 
01020     <span class="comment">//</span>
01021     <span class="comment">// We need to see if we were spawned from a link.  If we were, we</span>
01022     <span class="comment">// need to call back into the shell to try to get all the console</span>
01023     <span class="comment">// information from the link.</span>
01024     <span class="comment">//</span>
01025 
01026     <a class="code" href="../../d0/d5/srvinit_8c.html#a28">LoadLinkInfo</a>( ConsoleInfo, Title, &amp;TitleLength, CurDir, AppName );
01027 
01028     <a class="code" href="../../d8/d5/consrv_8h.html#a40">LockConsoleHandleTable</a>();
01029 
01030     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a13">AllocateConsoleHandle</a>(&amp;ConsoleInfo-&gt;ConsoleHandle);
01031     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01032         <a class="code" href="../../d8/d5/consrv_8h.html#a41">UnlockConsoleHandleTable</a>();
01033         CloseDesktop(hdesk);
01034         <a class="code" href="../../d3/d0/user32_8def.html#a72">CloseWindowStation</a>(hwinsta);
01035         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01036     }
01037 
01038     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a19">AllocateConsole</a>(ConsoleInfo-&gt;ConsoleHandle,
01039                              Title,
01040                              (USHORT)TitleLength,
01041                              <a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>(),
01042                              &amp;ConsoleInfo-&gt;StdIn,
01043                              &amp;ConsoleInfo-&gt;StdOut,
01044                              &amp;ConsoleInfo-&gt;StdErr,
01045                              ProcessData,
01046                              ConsoleInfo,
01047                              WindowVisible,
01048                              ConsoleThreadId
01049                              );
01050     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01051         <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a14">FreeConsoleHandle</a>(ConsoleInfo-&gt;ConsoleHandle);
01052         <a class="code" href="../../d8/d5/consrv_8h.html#a41">UnlockConsoleHandleTable</a>();
01053         CloseDesktop(hdesk);
01054         <a class="code" href="../../d3/d0/user32_8def.html#a72">CloseWindowStation</a>(hwinsta);
01055         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01056     }
01057     <a class="code" href="../../d1/d7/server_8h.html#a90">CONSOLE_SETCONSOLEHANDLE</a>(ConsoleInfo-&gt;ConsoleHandle);
01058     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a11">DereferenceConsoleHandle</a>(ConsoleInfo-&gt;ConsoleHandle,&amp;Console);
01059     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
01060 
01061     <span class="comment">//</span>
01062     <span class="comment">// increment console reference count</span>
01063     <span class="comment">//</span>
01064 
01065     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o1">RefCount</a>++;
01066 
01067     <span class="comment">//</span>
01068     <span class="comment">// Save the windowstation and desktop handles so they</span>
01069     <span class="comment">// can be used later</span>
01070     <span class="comment">//</span>
01071 
01072     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o6">hWinSta</a> = hwinsta;
01073     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o7">hDesk</a> = hdesk;
01074 
01075     <a class="code" href="../../d8/d5/consrv_8h.html#a41">UnlockConsoleHandleTable</a>();
01076 
01077 <span class="preprocessor">#if defined(FE_IME)</span>
01078 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a33">CONSOLE_IS_IME_ENABLED</a>())
01079     {
01080         <span class="keywordflow">if</span> (WindowVisible)
01081         {
01082             InitConsoleIMEStuff(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o7">hDesk</a>, ConsoleThreadId, Console);
01083         }
01084     }
01085 <span class="preprocessor">#endif</span>
01086 <span class="preprocessor"></span>
01087     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01088 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="srvinit.c::SrvAllocConsole" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG SrvAllocConsole           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PCSR_API_MSG&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCSR_REPLY_STATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>ReplyStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01537">1537</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
References <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00895">AddProcessToList()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l01683">AllocateCommandHistory()</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00600">_CONSOLE_ALLOC_MSG::AppName</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00599">_CONSOLE_ALLOC_MSG::AppNameLength</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">BYTE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00380">CONSOLE_CLIENTPROCESSHANDLE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00399">CONSOLE_GETCONSOLEAPPFROMPROCESSDATA</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00087">CONSOLE_HAS_FOCUS</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00395">CONSOLE_PERPROCESSDATA</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00400">CONSOLE_SETCONSOLEAPP</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00100">CONSOLE_SHUTTING_DOWN</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00042">_CONSOLE_INFO::ConsoleHandle</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00180">ConsoleHeapAlloc</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00193">ConsoleHeapFree</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00594">_CONSOLE_ALLOC_MSG::ConsoleInfo</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00603">_CONSOLE_ALLOC_MSG::CtrlRoutine</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00050">_CONSOLE_PROCESS_HANDLE::CtrlRoutine</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00602">_CONSOLE_ALLOC_MSG::CurDir</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00601">_CONSOLE_ALLOC_MSG::CurDirLength</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00598">_CONSOLE_ALLOC_MSG::Desktop</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00597">_CONSOLE_ALLOC_MSG::DesktopLength</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00164">_CONSOLE_INFORMATION::Flags</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00067">HANDLE_TAG</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d5/conmsg_8h.html#a114">PCONSOLE_ALLOC_MSG</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00048">_CONSOLE_PROCESS_HANDLE::Process</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00604">_CONSOLE_ALLOC_MSG::PropRoutine</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00051">_CONSOLE_PROCESS_HANDLE::PropRoutine</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01686">RevalidateConsole()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l04213">SetProcessForegroundRights()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00955">SetUpConsole()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00596">_CONSOLE_ALLOC_MSG::Title</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00595">_CONSOLE_ALLOC_MSG::TitleLength</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>.
<p>
<pre class="fragment"><div>01541 {
01542     <a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html">PCONSOLE_ALLOC_MSG</a> a = (<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html">PCONSOLE_ALLOC_MSG</a>)&amp;m-&gt;u.ApiMessageData;
01543     <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData;
01544     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01545     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
01546     <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">PCONSOLE_PROCESS_HANDLE</a> ProcessHandleRecord;
01547     PCSR_PROCESS Process;
01548     UNICODE_STRING strDesktopName;
01549 
01550     ProcessData = <a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>();
01551     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d1/d7/server_8h.html#a86">CONSOLE_GETCONSOLEAPPFROMPROCESSDATA</a>(ProcessData));
01552 
01553     <span class="keywordflow">if</span> (!CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o2">Title</a>, a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o1">TitleLength</a>, <span class="keyword">sizeof</span>(BYTE)) ||
01554         !CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o4">Desktop</a>, a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o3">DesktopLength</a>, <span class="keyword">sizeof</span>(BYTE)) ||
01555         !CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o8">CurDir</a>, a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o7">CurDirLength</a>, <span class="keyword">sizeof</span>(BYTE)) ||
01556         !CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o6">AppName</a>, a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o5">AppNameLength</a>, <span class="keyword">sizeof</span>(BYTE)) ||
01557         !CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o0">ConsoleInfo</a>, <span class="keyword">sizeof</span>(*a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o0">ConsoleInfo</a>), <span class="keyword">sizeof</span>(BYTE))) {
01558 
01559         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01560     }
01561 
01562     Process = (PCSR_PROCESS)(CSR_SERVER_QUERYCLIENTTHREAD()-&gt;Process);
01563     <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o3">DesktopLength</a>)
01564         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strDesktopName, a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o4">Desktop</a>);
01565     <span class="keywordflow">else</span>
01566         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strDesktopName, L<span class="stringliteral">"Default"</span>);
01567 
01568     ProcessHandleRecord = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( HANDLE_TAG ),<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">CONSOLE_PROCESS_HANDLE</a>));
01569     <span class="keywordflow">if</span> (ProcessHandleRecord == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01570         <span class="keywordflow">return</span> (ULONG)STATUS_NO_MEMORY;
01571     }
01572 
01573     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/srvinit_8c.html#a36">SetUpConsole</a>(a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o0">ConsoleInfo</a>,
01574                           a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o1">TitleLength</a>,
01575                           a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o2">Title</a>,
01576                           a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o8">CurDir</a>,
01577                           a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o6">AppName</a>,
01578                           ProcessData,
01579                           TRUE,
01580                           &amp;strDesktopName);
01581     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01582         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ProcessHandleRecord);
01583         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01584     }
01585     <a class="code" href="../../d1/d7/server_8h.html#a87">CONSOLE_SETCONSOLEAPP</a>(TRUE);
01586     Process-&gt;Flags |= CSR_PROCESS_CONSOLEAPP;
01587     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a34">RevalidateConsole</a>(a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o0">ConsoleInfo</a>-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o0">ConsoleHandle</a>,&amp;Console);
01588     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
01589     ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o2">Process</a> = CSR_SERVER_QUERYCLIENTTHREAD()-&gt;Process;
01590     ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o4">CtrlRoutine</a> = a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o9">CtrlRoutine</a>;
01591     ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o5">PropRoutine</a> = a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o10">PropRoutine</a>;
01592     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (!(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; CONSOLE_SHUTTING_DOWN));
01593     <a class="code" href="../../d0/d5/srvinit_8c.html#a33">AddProcessToList</a>(Console,ProcessHandleRecord,<a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>());
01594     <a class="code" href="../../d6/d2/output_8c.html#a73">SetProcessForegroundRights</a>(Process,
01595                                Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; CONSOLE_HAS_FOCUS);
01596     (HANDLE) <a class="code" href="../../d8/d5/consrv_8h.html#a254">AllocateCommandHistory</a>(Console,
01597                            a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o5">AppNameLength</a>,
01598                            a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o6">AppName</a>,
01599                            <a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>());
01600 
01601     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01602 
01603     <span class="keywordflow">return</span> STATUS_SUCCESS;
01604     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
01605 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="srvinit.c::SrvFreeConsole" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG SrvFreeConsole           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PCSR_API_MSG&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCSR_REPLY_STATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>ReplyStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01608">1608</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00380">CONSOLE_CLIENTPROCESSHANDLE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00383">CONSOLE_CLIENTPROCESSID</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00399">CONSOLE_GETCONSOLEAPPFROMPROCESSDATA</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00405">CONSOLE_GETCONSOLEHANDLEFROMPROCESSDATA</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00395">CONSOLE_PERPROCESSDATA</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00400">CONSOLE_SETCONSOLEAPP</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00608">_CONSOLE_FREE_MSG::ConsoleHandle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/conmsg_8h.html#a116">PCONSOLE_FREE_MSG</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01355">RemoveConsole()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>01612 {
01613     <a class="code" href="../../d4/d0/struct__CONSOLE__FREE__MSG.html">PCONSOLE_FREE_MSG</a> a = (<a class="code" href="../../d4/d0/struct__CONSOLE__FREE__MSG.html">PCONSOLE_FREE_MSG</a>)&amp;m-&gt;u.ApiMessageData;
01614     <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData;
01615     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01616 
01617     ProcessData = <a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>();
01618     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d7/server_8h.html#a86">CONSOLE_GETCONSOLEAPPFROMPROCESSDATA</a>(ProcessData));
01619 
01620     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d7/server_8h.html#a91">CONSOLE_GETCONSOLEHANDLEFROMPROCESSDATA</a>(ProcessData)==a-&gt;<a class="code" href="../../d4/d0/struct__CONSOLE__FREE__MSG.html#o0">ConsoleHandle</a>);
01621 
01622     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/srvinit_8c.html#a37">RemoveConsole</a>(ProcessData,
01623             <a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>(),
01624             <a class="code" href="../../d1/d7/server_8h.html#a80">CONSOLE_CLIENTPROCESSID</a>());
01625 
01626     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01627         <a class="code" href="../../d1/d7/server_8h.html#a87">CONSOLE_SETCONSOLEAPP</a>(FALSE);
01628     }
01629 
01630     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01631     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
01632 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a46" doxytag="srvinit.c::SrvGetConsoleLangId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG SrvGetConsoleLangId           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PCSR_API_MSG&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCSR_REPLY_STATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>ReplyStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l02680">2680</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
References <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01627">ApiPreamble()</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00824">_CONSOLE_LANGID_MSG::ConsoleHandle</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l02643">GetConsoleLangId()</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00825">_CONSOLE_LANGID_MSG::LangId</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00211">_CONSOLE_INFORMATION::OutputCP</a>, <a class="el" href="../../d5/d5/conmsg_8h.html#a160">PCONSOLE_LANGID_MSG</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>.
<p>
<pre class="fragment"><div>02684 {
02685     <a class="code" href="../../d4/d3/struct__CONSOLE__LANGID__MSG.html">PCONSOLE_LANGID_MSG</a> a = (<a class="code" href="../../d4/d3/struct__CONSOLE__LANGID__MSG.html">PCONSOLE_LANGID_MSG</a>)&amp;m-&gt;u.ApiMessageData;
02686     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02687     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
02688 
02689     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d4/d3/struct__CONSOLE__LANGID__MSG.html#o0">ConsoleHandle</a>,
02690                          &amp;Console
02691                         );
02692     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02693         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02694     }
02695     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/srvinit_8c.html#a45">GetConsoleLangId</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o62">OutputCP</a>, &amp;a-&gt;<a class="code" href="../../d4/d3/struct__CONSOLE__LANGID__MSG.html#o1">LangId</a>);
02696 
02697     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02698     <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02699     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
02700 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a42" doxytag="srvinit.c::TranslateConsoleTitle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LPWSTR TranslateConsoleTitle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">LPWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>ConsoleTitle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a22">PUSHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pcbTranslatedTitle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>Unexpand</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>Substitute</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01831">1831</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
References <a class="el" href="../../d9/d4/consrv_8h-source.html#l00180">ConsoleHeapAlloc</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l00369">MyStringCompareW()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">PBYTE</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01827">SYSTEM_ROOT</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01828">SYSTEM_ROOT_LENGTH</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00066">TITLE_TAG</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00789">AllocateConsole()</a>, and <a class="el" href="../../d1/d4/srvinit_8c-source.html#l02210">GetRegistryValues()</a>.
<p>
<pre class="fragment"><div>01839                    :
01840 
01841     This routine translates <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> characters into <span class="charliteral">'_'</span> characters because
01842     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NT registry apis <span class="keywordflow">do</span> not allow <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> creation of keys with
01843     names that contain <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> characters. It also converts absolute paths
01844     into %SystemRoot% relative ones. As an example, <span class="keywordflow">if</span> both behaviors were
01845     specified <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> would convert a title like C:\WINNT\System32\cmd.exe to
01846     %SystemRoot%_System32_cmd.exe.
01847 
01848 Arguments:
01849 
01850     ConsoleTitle - Pointer to string to translate.
01851 
01852     pcbTranslatedTitle - On <span class="keywordflow">return</span>, contains size of translated title.
01853 
01854     Unexpand - Convert absolute <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> to %SystemRoot% relative one.
01855 
01856     Substitute - Replace <span class="charliteral">'\'</span> with <span class="charliteral">'_'</span> in <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.
01857 
01858 Return Value:
01859 
01860     Pointer to translated title or <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
01861 
01862 Note:
01863 
01864     This routine allocates a buffer that must be freed.
01865 
01866 --*/
01867 {
01868     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> cbConsoleTitle,i;
01869     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> cbSystemRoot;
01870     LPWSTR TranslatedConsoleTitle,Tmp;
01871 
01872     cbConsoleTitle = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((lstrlenW(ConsoleTitle) + 1) * <span class="keyword">sizeof</span>(WCHAR));
01873     cbSystemRoot = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(lstrlenW(USER_SHARED_DATA-&gt;NtSystemRoot) * <span class="keyword">sizeof</span>(WCHAR));
01874 
01875     <span class="keywordflow">if</span> (Unexpand &amp;&amp; !<a class="code" href="../../d8/d5/consrv_8h.html#a262">MyStringCompareW</a>(ConsoleTitle,
01876                                       USER_SHARED_DATA-&gt;NtSystemRoot,
01877                                       cbSystemRoot,
01878                                       TRUE)) {
01879         cbConsoleTitle -= cbSystemRoot;
01880         (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ConsoleTitle += cbSystemRoot;
01881         cbSystemRoot = <a class="code" href="../../d0/d5/srvinit_8c.html#a1">SYSTEM_ROOT_LENGTH</a>;
01882     } <span class="keywordflow">else</span> {
01883         cbSystemRoot = 0;
01884     }
01885 
01886     Tmp = TranslatedConsoleTitle = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TITLE_TAG ),cbSystemRoot + cbConsoleTitle);
01887     <span class="keywordflow">if</span> (TranslatedConsoleTitle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01888         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01889     }
01890 
01891     RtlCopyMemory(TranslatedConsoleTitle, SYSTEM_ROOT, cbSystemRoot);
01892     (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)TranslatedConsoleTitle += cbSystemRoot;
01893 
01894     <span class="keywordflow">for</span> (i=0;i&lt;cbConsoleTitle;i+=<span class="keyword">sizeof</span>(WCHAR)) {
01895         <span class="keywordflow">if</span> (Substitute &amp;&amp; *ConsoleTitle == <span class="charliteral">'\\'</span>) {
01896             *TranslatedConsoleTitle++ = (WCHAR)<span class="charliteral">'_'</span>;
01897         } <span class="keywordflow">else</span> {
01898             *TranslatedConsoleTitle++ = *ConsoleTitle;
01899         }
01900         ConsoleTitle++;
01901     }
01902 
01903     <span class="keywordflow">if</span> (pcbTranslatedTitle) {
01904         *pcbTranslatedTitle = cbSystemRoot + cbConsoleTitle;
01905     }
01906 
01907     <span class="keywordflow">return</span> Tmp;
01908 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="srvinit.c::UnregisterVDM" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UnregisterVDM           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Console</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00980">980</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
References <a class="el" href="../../d7/d7/dispatch_8h-source.html#l00115">AdjustCursorPosition</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01519">ConnectToEmulator()</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00098">CONSOLE_CONNECTED_TO_EMULATOR</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00087">CONSOLE_HAS_FOCUS</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00148">CONSOLE_TEXTMODE_BUFFER</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00094">CONSOLE_VDM_REGISTERED</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00103">CONSOLE_WOW_REGISTERED</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d2/dbcs_8h-source.html#l00051">FS_MODE_GRAPHICS</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00039">FullScreenInitialized</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d0/d3/dbcs_8h.html#a51">IsAvailableFsCodePage()</a>, <a class="el" href="../../d1/d2/dbcs_8h-source.html#l00028">JAPAN_CP</a>, <a class="el" href="../../d1/d2/dbcs_8h-source.html#l00027">KOREAN_CP</a>, <a class="el" href="../../d1/d2/dbcs_8h-source.html#l00049">_MODE_FONT_PAIR::Mode</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00033">NtUnmapViewOfSection()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l00870">NtUserConsoleControl()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l07575">NtUserSetInformationThread()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d2/dbcs_8h-source.html#l00069">RegModeFontPairs</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00114">_MODE_FONT_PAIR::Resolution</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02843">TIF_DOSEMULATOR</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02842">TIF_VDMAPP</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01567">DisplayModeTransition()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01355">RemoveConsole()</a>, and <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01094">SrvRegisterConsoleVDM()</a>.
<p>
<pre class="fragment"><div>00983 {
00984 <span class="comment">// williamh, Feb 2 1994.</span>
00985 <span class="comment">// catch multiple calls to unregister vdm. Believe it or not, this could</span>
00986 <span class="comment">// happen</span>
00987     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Console-&gt;Flags &amp; CONSOLE_VDM_REGISTERED);
00988     <span class="keywordflow">if</span> (!(Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>))
00989         <span class="keywordflow">return</span>;
00990 
00991 <span class="preprocessor">#if defined(FE_SB) &amp;&amp; defined(i386)</span>
00992 <span class="preprocessor"></span><span class="comment">// When HDOS apps exit, console screen resolution is changed to 640*400. Because HBIOS set</span>
00993 <span class="comment">// Screen resolution to 640*400. So, we should replace current screen resoultion(640*480).</span>
00994 <span class="comment">// 09/11/96 bklee</span>
00995     {
00996 
00997     <span class="keywordflow">if</span> ((Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN_HARDWARE)  &amp;&amp;
00998         ( Console-&gt;OutputCP == <a class="code" href="../../d0/d3/dbcs_8h.html#a6">KOREAN_CP</a> ||
00999          (Console-&gt;OutputCP == <a class="code" href="../../d0/d3/dbcs_8h.html#a7">JAPAN_CP</a> &amp;&amp; ISNECPC98(gdwMachineId) ) )) {
01000 
01001          ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01002          DEVMODEW Devmode;
01003          <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fGraphics = fFullScreenGraphics ? <a class="code" href="../../d0/d3/dbcs_8h.html#a51">IsAvailableFsCodePage</a>(Console-&gt;OutputCP) : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01004 
01005          <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = Console-&gt;CurrentScreenBuffer-&gt;BufferInfo.TextInfo.ModeIndex;
01006 
01007          ZeroMemory(&amp;Devmode, <span class="keyword">sizeof</span>(Devmode));
01008 
01009          Devmode.dmSize = <span class="keyword">sizeof</span>(Devmode);
01010          Devmode.dmDriverExtra = 0;
01011          Devmode.dmFields = DM_BITSPERPEL   |
01012                             DM_PELSWIDTH    |
01013                             DM_PELSHEIGHT   |
01014                             DM_DISPLAYFLAGS;
01015 
01016          Devmode.dmBitsPerPel   = 4;
01017 
01018          Devmode.dmPelsWidth  = <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>.X;
01019          Devmode.dmPelsHeight = <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>.Y;
01020          Devmode.dmDisplayFlags = (fGraphics &amp;&amp; (<a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o0">Mode</a> &amp; <a class="code" href="../../d0/d3/dbcs_8h.html#a9">FS_MODE_GRAPHICS</a>)) ? 0 : DMDISPLAYFLAGS_TEXTMODE;
01021 
01022          GdiFullscreenControl(FullscreenControlSetMode,
01023                               &amp;Devmode,
01024                               <span class="keyword">sizeof</span>(Devmode),
01025                               NULL,
01026                               NULL);
01027     }
01028     }
01029 <span class="preprocessor">#endif</span>
01030 <span class="preprocessor"></span><span class="preprocessor">#ifdef i386</span>
01031 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN_HARDWARE &amp;&amp;
01032         Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a13">CONSOLE_CONNECTED_TO_EMULATOR</a>) {
01033     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">NtUserConsoleControl</a>(ConsoleSetVDMCursorBounds, NULL, 0);
01034         <span class="comment">// connect emulator</span>
01035         <a class="code" href="../../d7/d4/server_2private_8c.html#a41">ConnectToEmulator</a>(FALSE, Console);
01036     }
01037 
01038     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a12">FullScreenInitialized</a>) {
01039         CloseHandle(Console-&gt;VDMStartHardwareEvent);
01040         CloseHandle(Console-&gt;VDMEndHardwareEvent);
01041         <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),Console-&gt;StateBuffer);
01042         <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(Console-&gt;VDMProcessHandle,Console-&gt;StateBufferClient);
01043         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Console-&gt;StateSectionHandle);
01044         Console-&gt;StateLength = 0;
01045     }
01046 
01047 <span class="preprocessor">#endif</span>
01048 <span class="preprocessor"></span>
01049     Console-&gt;Flags &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>;
01050 
01051     <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a2">CONSOLE_HAS_FOCUS</a>) {
01052         USERTHREAD_FLAGS Flags;
01053 
01054         Flags.dwFlags = 0;
01055         Flags.dwMask = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a810">TIF_VDMAPP</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a811">TIF_DOSEMULATOR</a>);
01056         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(Console-&gt;InputThreadInfo-&gt;ThreadHandle,
01057                 UserThreadFlags, &amp;Flags, <span class="keyword">sizeof</span>(Flags));
01058     }
01059     Console-&gt;Flags &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a18">CONSOLE_WOW_REGISTERED</a>;
01060     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Console-&gt;VDMBuffer != NULL);
01061     <span class="keywordflow">if</span> (Console-&gt;VDMBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01062         <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(Console-&gt;VDMProcessHandle,Console-&gt;VDMBufferClient);
01063         <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),Console-&gt;VDMBuffer);
01064         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Console-&gt;VDMBufferSectionHandle);
01065         Console-&gt;VDMBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01066     }
01067 <span class="preprocessor">#ifdef i386</span>
01068 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Console-&gt;CurrentScreenBuffer &amp;&amp;
01069         Console-&gt;CurrentScreenBuffer-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
01070         Console-&gt;CurrentScreenBuffer-&gt;BufferInfo.TextInfo.MousePosition.X = 0;
01071         Console-&gt;CurrentScreenBuffer-&gt;BufferInfo.TextInfo.MousePosition.Y = 0;
01072     }
01073 <span class="preprocessor">#endif</span>
01074 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Console-&gt;VDMProcessHandle);
01075     CloseHandle(Console-&gt;VDMProcessHandle);
01076     Console-&gt;VDMProcessHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01077 
01078 <span class="preprocessor">#if defined(FE_SB) &amp;&amp; defined(FE_IME) &amp;&amp; defined(i386)</span>
01079 <span class="preprocessor"></span>    {
01080         <span class="keywordflow">if</span> (Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN) {
01081             Console-&gt;Flags |= CONSOLE_JUST_VDM_UNREGISTERED ;
01082         }
01083         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Console-&gt;CurrentScreenBuffer-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
01084             <a class="code" href="../../d6/d8/dispatch_8h.html#a10">AdjustCursorPosition</a>(Console-&gt;CurrentScreenBuffer,
01085                                  Console-&gt;CurrentScreenBuffer-&gt;BufferInfo.TextInfo.CursorPosition,
01086                                  TRUE,
01087                                  NULL);
01088         }
01089     }
01090 <span class="preprocessor">#endif</span>
01091 <span class="preprocessor"></span>}
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a7" doxytag="srvinit.c::ConsoleInitWindowsLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CRITICAL_SECTION <a class="el" href="../../d0/d5/srvinit_8c.html#a7">ConsoleInitWindowsLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00300">300</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00737">ConServerDllInitialization()</a>, and <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00626">InitWindowsStuff()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="srvinit.c::ConsoleOutputCP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UINT <a class="el" href="../../d0/d5/srvinit_8c.html#a11">ConsoleOutputCP</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00305">305</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00789">AllocateConsole()</a>, and <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00737">ConServerDllInitialization()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="srvinit.c::ConsoleServerApiDispatchTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CONST PCSR_API_ROUTINE <a class="el" href="../../d0/d5/srvinit_8c.html#a2">ConsoleServerApiDispatchTable</a>[ConsolepMaxApiNumber-ConsolepOpenConsole]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00026">26</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00737">ConServerDllInitialization()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="srvinit.c::ConsoleServerApiServerValidTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CONST BOOLEAN <a class="el" href="../../d0/d5/srvinit_8c.html#a3">ConsoleServerApiServerValidTable</a>[ConsolepMaxApiNumber-ConsolepOpenConsole]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00115">115</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00737">ConServerDllInitialization()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="srvinit.c::ConsoleVDMCriticalSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CRITICAL_SECTION <a class="el" href="../../d0/d5/srvinit_8c.html#a5">ConsoleVDMCriticalSection</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00296">296</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01627">ApiPreamble()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00737">ConServerDllInitialization()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01567">DisplayModeTransition()</a>, and <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="srvinit.c::ConsoleVDMOnSwitching" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> <a class="el" href="../../d0/d5/srvinit_8c.html#a6">ConsoleVDMOnSwitching</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00297">297</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01627">ApiPreamble()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00737">ConServerDllInitialization()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01567">DisplayModeTransition()</a>, and <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="srvinit.c::DefaultRegInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html">CONSOLE_REGISTRY_INFO</a> <a class="el" href="../../d0/d5/srvinit_8c.html#a12">DefaultRegInfo</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00306">306</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l02210">GetRegistryValues()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l02132">InitializeConsoleAttributes()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l02631">InitializeScrollBuffer()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00590">InitWindowClass()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00626">InitWindowsStuff()</a>, and <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00360">LoadLinkInfo()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="srvinit.c::dwConBaseTag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="el" href="../../d0/d5/srvinit_8c.html#a18">dwConBaseTag</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00353">353</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00737">ConServerDllInitialization()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="srvinit.c::fOneTimeInitialized" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL <a class="el" href="../../d0/d5/srvinit_8c.html#a8">fOneTimeInitialized</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00301">301</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l01946">ConsoleInputThread()</a>, and <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00626">InitWindowsStuff()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="srvinit.c::FullScreenInitialized" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL <a class="el" href="../../d0/d5/srvinit_8c.html#a4">FullScreenInitialized</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00295">295</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01567">DisplayModeTransition()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l00270">DoCreateScreenBuffer()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l02272">HandleSysKeyEvent()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00626">InitWindowsStuff()</a>, <a class="el" href="../../d2/d6/ntcon_2server_2menu_8c-source.html#l00459">PropertiesUpdate()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01094">SrvRegisterConsoleVDM()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00853">SrvSetConsoleDisplayMode()</a>, and <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00980">UnregisterVDM()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="srvinit.c::gExtendedEditKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="el" href="../../d0/d5/srvinit_8c.html#a19">gExtendedEditKey</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00355">355</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l02210">GetRegistryValues()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l02214">IsCommandLineEditingKey()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l02179">IsCommandLinePopupKey()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l00289">IsPauseKey()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l00229">ParseEditKeyInfo()</a>, and <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l00876">ProcessCookedReadInput()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="srvinit.c::gfLoadConIme" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL <a class="el" href="../../d0/d5/srvinit_8c.html#a21">gfLoadConIme</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00358">358</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l02210">GetRegistryValues()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="srvinit.c::gfTrimLeadingZeros" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL <a class="el" href="../../d0/d5/srvinit_8c.html#a20">gfTrimLeadingZeros</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00356">356</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l02210">GetRegistryValues()</a>, and <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l03080">HandleMouseEvent()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="srvinit.c::ghDefaultIcon" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HICON <a class="el" href="../../d0/d5/srvinit_8c.html#a14">ghDefaultIcon</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00348">348</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/output_8c-source.html#l04700">ConsoleWindowProc()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l00834">CreateWindowsWindow()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l04454">DestroyWindowsWindow()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00590">InitWindowClass()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00360">LoadLinkInfo()</a>, and <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l01164">SrvSetConsoleIcon()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="srvinit.c::ghDefaultSmIcon" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HICON <a class="el" href="../../d0/d5/srvinit_8c.html#a15">ghDefaultSmIcon</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00349">349</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/output_8c-source.html#l04700">ConsoleWindowProc()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l00834">CreateWindowsWindow()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l04454">DestroyWindowsWindow()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00590">InitWindowClass()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00360">LoadLinkInfo()</a>, and <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l01164">SrvSetConsoleIcon()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="srvinit.c::ghInstance" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HANDLE <a class="el" href="../../d0/d5/srvinit_8c.html#a13">ghInstance</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00347">347</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l03150">CommandNumberPopup()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00737">ConServerDllInitialization()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l03040">CopyFromCharPopup()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l03096">CopyToCharPopup()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l00834">CreateWindowsWindow()</a>, <a class="el" href="../../d1/d3/find_8c-source.html#l00268">DoFind()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l02272">HandleSysKeyEvent()</a>, <a class="el" href="../../d2/d6/ntcon_2server_2menu_8c-source.html#l00061">InitSystemMenu()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00590">InitWindowClass()</a>, <a class="el" href="../../d2/d6/ntcon_2server_2menu_8c-source.html#l00024">MyModifyMenuItem()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l01657">ProcessCreateConsoleWindow()</a>, <a class="el" href="../../d9/d8/dllinit_8c-source.html#l00141">SetUpConsoleInfo()</a>, and <a class="el" href="../../d2/d6/ntcon_2server_2menu_8c-source.html#l00236">SetWinText()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="srvinit.c::ghNormalCursor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HCURSOR <a class="el" href="../../d0/d5/srvinit_8c.html#a16">ghNormalCursor</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00350">350</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/output_8c-source.html#l00485">CreateScreenBuffer()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00590">InitWindowClass()</a>, and <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00213">SrvSetConsoleCursor()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="srvinit.c::OEMCP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UINT <a class="el" href="../../d0/d5/srvinit_8c.html#a9">OEMCP</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00303">303</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00789">AllocateConsole()</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l01469">CharToWchar()</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l01443">CharToWcharGlyph()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00737">ConServerDllInitialization()</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l01345">ConvertInputToUnicode()</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l01508">ConvertOutputToOem()</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l01384">ConvertOutputToUnicode()</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l01307">ConvertToOem()</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l01676">FalseUnicodeToRealUnicode()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l02210">GetRegistryValues()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l02132">InitializeConsoleAttributes()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00360">LoadLinkInfo()</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l01573">RealUnicodeToFalseUnicode()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l03175">SetRAMFontCodePage()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l04879">SrvGetConsoleTitle()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l01229">SrvSetConsoleCP()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l04929">SrvSetConsoleTitle()</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l01489">WcharToChar()</a>, and <a class="el" href="../../d1/d2/__stream_8h-source.html#l01020">WWSB_DoSrvWriteConsole()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="srvinit.c::pConHeap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PWIN32HEAP <a class="el" href="../../d0/d5/srvinit_8c.html#a17">pConHeap</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00352">352</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00737">ConServerDllInitialization()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="srvinit.c::WINDOWSCP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UINT <a class="el" href="../../d0/d5/srvinit_8c.html#a10">WINDOWSCP</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00304">304</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00737">ConServerDllInitialization()</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l01676">FalseUnicodeToRealUnicode()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l01795">ReadOutputString()</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l01573">RealUnicodeToFalseUnicode()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l00801">SB_TranslateOutputToOem()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l00976">SB_TranslateOutputToUnicode()</a>, <a class="el" href="../../d6/d0/w32_2ntcon_2server_2bitmap_8c-source.html#l00168">SrvInvalidateBitMapRect()</a>, <a class="el" href="../../d1/d2/__stream_8h-source.html#l01020">WWSB_DoSrvWriteConsole()</a>, <a class="el" href="../../d9/d1/__output_8h-source.html#l01530">WWSB_FillOutput()</a>, and <a class="el" href="../../d9/d1/__output_8h-source.html#l01002">WWSB_WriteOutputString()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:40 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
