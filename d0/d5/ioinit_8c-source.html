<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ioinit.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ioinit.c</h1><a href="../../d9/d5/ioinit_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989-1993  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    ioinit.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the code to initialize the I/O system.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Darryl E. Havens (darrylh) April 27, 1989</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Kernel mode, system initialization code</span>
00020 <span class="comment"></span>
00021 <span class="comment">Revision History:</span>
00022 <span class="comment"></span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d0/d6/iop_8h.html">iop.h</a>"</span>
00027 <span class="preprocessor">#include &lt;<a class="code" href="../../d3/d8/setupblk_8h.html">setupblk.h</a>&gt;</span>
00028 <span class="preprocessor">#include &lt;<a class="code" href="../../d0/d1/inbv_8h.html">inbv.h</a>&gt;</span>
00029 <span class="preprocessor">#include &lt;ntddstor.h&gt;</span>
00030 
00031 
00032 <span class="comment">//</span>
00033 <span class="comment">// Define the default number of I/O stack locations a large IRP should</span>
00034 <span class="comment">// have if not specified by the registry.</span>
00035 <span class="comment">//</span>
00036 
<a name="l00037"></a><a class="code" href="../../d9/d5/ioinit_8c.html#a0">00037</a> <span class="preprocessor">#define DEFAULT_LARGE_IRP_LOCATIONS 8</span>
00038 <span class="preprocessor"></span>
00039 <span class="comment">//</span>
00040 <span class="comment">// Define the default number of IRP that can be in progress and allocated</span>
00041 <span class="comment">// from a lookaside list.</span>
00042 <span class="comment">//</span>
00043 
<a name="l00044"></a><a class="code" href="../../d9/d5/ioinit_8c.html#a1">00044</a> <span class="preprocessor">#define DEFAULT_LOOKASIDE_IRP_LIMIT 512</span>
00045 <span class="preprocessor"></span>
00046 <span class="comment">//</span>
00047 <span class="comment">// Define the type for driver group name entries in the group list so that</span>
00048 <span class="comment">// load order dependencies can be tracked.</span>
00049 <span class="comment">//</span>
00050 
<a name="l00051"></a><a class="code" href="../../d4/d2/struct__TREE__ENTRY.html">00051</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d4/d2/struct__TREE__ENTRY.html">_TREE_ENTRY</a> {
<a name="l00052"></a><a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o0">00052</a>     <span class="keyword">struct </span><a class="code" href="../../d4/d2/struct__TREE__ENTRY.html">_TREE_ENTRY</a> *<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o0">Left</a>;
<a name="l00053"></a><a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o1">00053</a>     <span class="keyword">struct </span><a class="code" href="../../d4/d2/struct__TREE__ENTRY.html">_TREE_ENTRY</a> *<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o1">Right</a>;
<a name="l00054"></a><a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o2">00054</a>     <span class="keyword">struct </span><a class="code" href="../../d4/d2/struct__TREE__ENTRY.html">_TREE_ENTRY</a> *<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o2">Sibling</a>;
<a name="l00055"></a><a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o3">00055</a>     ULONG <a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o3">DriversThisType</a>;
<a name="l00056"></a><a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o4">00056</a>     ULONG <a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o4">DriversLoaded</a>;
<a name="l00057"></a><a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o5">00057</a>     UNICODE_STRING <a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o5">GroupName</a>;
00058 } <a class="code" href="../../d4/d2/struct__TREE__ENTRY.html">TREE_ENTRY</a>, *<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html">PTREE_ENTRY</a>;
00059 
<a name="l00060"></a><a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html">00060</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html">_DRIVER_INFORMATION</a> {
<a name="l00061"></a><a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o0">00061</a>     LIST_ENTRY <a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o0">Link</a>;
<a name="l00062"></a><a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o1">00062</a>     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> <a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o1">DriverObject</a>;
<a name="l00063"></a><a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o2">00063</a>     <a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html">PBOOT_DRIVER_LIST_ENTRY</a> <a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o2">DataTableEntry</a>;
<a name="l00064"></a><a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o3">00064</a>     HANDLE <a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o3">ServiceHandle</a>;
<a name="l00065"></a><a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o4">00065</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o4">TagPosition</a>;
<a name="l00066"></a><a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o5">00066</a>     BOOLEAN <a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o5">Failed</a>;
<a name="l00067"></a><a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o6">00067</a>     BOOLEAN <a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o6">Processed</a>;
00068 } <a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html">DRIVER_INFORMATION</a>, *<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html">PDRIVER_INFORMATION</a>;
00069 
<a name="l00070"></a><a class="code" href="../../d9/d5/ioinit_8c.html#a7">00070</a> <a class="code" href="../../d9/d5/ioinit_8c.html#a4">PTREE_ENTRY</a> <a class="code" href="../../d9/d5/ioinit_8c.html#a7">IopGroupListHead</a>;
00071 
00072 <span class="comment">//</span>
00073 <span class="comment">// I/O Error logging support</span>
00074 <span class="comment">//</span>
<a name="l00075"></a><a class="code" href="../../d9/d5/ioinit_8c.html#a8">00075</a> PVOID <a class="code" href="../../d9/d5/ioinit_8c.html#a8">IopErrorLogObject</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00076 
00077 <span class="comment">//</span>
00078 <span class="comment">// Group order table</span>
00079 <span class="comment">//</span>
00080 
<a name="l00081"></a><a class="code" href="../../d9/d5/ioinit_8c.html#a9">00081</a> ULONG <a class="code" href="../../d9/d5/ioinit_8c.html#a9">IopGroupIndex</a>;
<a name="l00082"></a><a class="code" href="../../d9/d5/ioinit_8c.html#a10">00082</a> PLIST_ENTRY <a class="code" href="../../d9/d5/ioinit_8c.html#a10">IopGroupTable</a>;
00083 
00084 <span class="comment">//</span>
00085 <span class="comment">// Define a macro for initializing drivers.</span>
00086 <span class="comment">//</span>
00087 
<a name="l00088"></a><a class="code" href="../../d9/d5/ioinit_8c.html#a2">00088</a> <span class="preprocessor">#define InitializeDriverObject( Object ) {                                 \</span>
00089 <span class="preprocessor">    ULONG i;                                                               \</span>
00090 <span class="preprocessor">    RtlZeroMemory( Object,                                                 \</span>
00091 <span class="preprocessor">                   sizeof( DRIVER_OBJECT ) + sizeof ( DRIVER_EXTENSION )); \</span>
00092 <span class="preprocessor">    Object-&gt;DriverExtension = (PDRIVER_EXTENSION) (Object + 1);            \</span>
00093 <span class="preprocessor">    Object-&gt;DriverExtension-&gt;DriverObject = Object;                        \</span>
00094 <span class="preprocessor">    for (i = 0; i &lt;= IRP_MJ_MAXIMUM_FUNCTION; i++)                         \</span>
00095 <span class="preprocessor">        Object-&gt;MajorFunction[i] = IopInvalidDeviceRequest;                \</span>
00096 <span class="preprocessor">    Object-&gt;Type = IO_TYPE_DRIVER;                                         \</span>
00097 <span class="preprocessor">    Object-&gt;Size = sizeof( DRIVER_OBJECT );                                \</span>
00098 <span class="preprocessor">    }</span>
00099 <span class="preprocessor"></span>
00100 <span class="comment">//</span>
00101 <span class="comment">// Define external procedures not in common header files</span>
00102 <span class="comment">//</span>
00103 
00104 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00105 <a class="code" href="../../d9/d5/ioinit_8c.html#a13">IopInitializeData</a>(
00106     VOID
00107     );
00108 
00109 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00110 <a class="code" href="../../d9/d5/ioinit_8c.html#a14">RawInitialize</a>(
00111     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
00112     IN PUNICODE_STRING RegistryPath
00113     );
00114 
00115 <span class="comment">//</span>
00116 <span class="comment">// Define the local procedures</span>
00117 <span class="comment">//</span>
00118 
00119 BOOLEAN
00120 <a class="code" href="../../d9/d5/ioinit_8c.html#a15">IopCheckDependencies</a>(
00121     IN HANDLE KeyHandle
00122     );
00123 
00124 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00125 <a class="code" href="../../d9/d5/ioinit_8c.html#a16">IopCreateArcNames</a>(
00126     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
00127     );
00128 
00129 BOOLEAN
00130 <a class="code" href="../../d9/d5/ioinit_8c.html#a17">IopCreateObjectTypes</a>(
00131     VOID
00132     );
00133 
00134 <a class="code" href="../../d9/d5/ioinit_8c.html#a4">PTREE_ENTRY</a>
00135 <a class="code" href="../../d9/d5/ioinit_8c.html#a18">IopCreateEntry</a>(
00136     IN PUNICODE_STRING GroupName
00137     );
00138 
00139 BOOLEAN
00140 <a class="code" href="../../d9/d5/ioinit_8c.html#a19">IopCreateRootDirectories</a>(
00141     VOID
00142     );
00143 
00144 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00145 <a class="code" href="../../d9/d5/ioinit_8c.html#a38">IopFreeGroupTree</a>(
00146     IN PTREE_ENTRY TreeEntry
00147     );
00148 
00149 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00150 <a class="code" href="../../d9/d5/ioinit_8c.html#a21">IopInitializeAttributesAndCreateObject</a>(
00151     IN PUNICODE_STRING ObjectName,
00152     IN OUT POBJECT_ATTRIBUTES ObjectAttributes,
00153     OUT <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> *DriverObject
00154     );
00155 
00156 BOOLEAN
00157 <a class="code" href="../../d9/d5/ioinit_8c.html#a22">IopInitializeBootDrivers</a>(
00158     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock,
00159     OUT <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> *PreviousDriver
00160     );
00161 
00162 <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>
00163 <a class="code" href="../../d9/d5/ioinit_8c.html#a23">IopInitializeBuiltinDriver</a>(
00164     IN PUNICODE_STRING DriverName,
00165     IN PUNICODE_STRING RegistryPath,
00166     IN PDRIVER_INITIALIZE DriverInitializeRoutine,
00167     IN PLDR_DATA_TABLE_ENTRY TableEntry,
00168     IN BOOLEAN TextModeSetup
00169     );
00170 
00171 
00172 BOOLEAN
00173 <a class="code" href="../../d9/d5/ioinit_8c.html#a24">IopInitializeSingleBootDriver</a>(
00174     IN  HANDLE KeyHandle,
00175     IN  <a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html">PBOOT_DRIVER_LIST_ENTRY</a> BootDriver,
00176     OUT PUNICODE_STRING DriverName           OPTIONAL
00177     );
00178 
00179 BOOLEAN
00180 <a class="code" href="../../d9/d5/ioinit_8c.html#a25">IopInitializeSystemDrivers</a>(
00181     VOID
00182     );
00183 
00184 <a class="code" href="../../d9/d5/ioinit_8c.html#a4">PTREE_ENTRY</a>
00185 <a class="code" href="../../d9/d5/ioinit_8c.html#a26">IopLookupGroupName</a>(
00186     IN PUNICODE_STRING GroupName,
00187     IN BOOLEAN Insert
00188     );
00189 
00190 BOOLEAN
00191 <a class="code" href="../../d9/d5/ioinit_8c.html#a27">IopMarkBootPartition</a>(
00192     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
00193     );
00194 
00195 BOOLEAN
00196 <a class="code" href="../../d9/d5/ioinit_8c.html#a28">IopReassignSystemRoot</a>(
00197     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock,
00198     OUT PSTRING NtDeviceName
00199     );
00200 
00201 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00202 <a class="code" href="../../d9/d5/ioinit_8c.html#a29">IopStoreSystemPartitionInformation</a>(
00203     IN     PUNICODE_STRING NtSystemPartitionDeviceName,
00204     IN OUT PUNICODE_STRING OsLoaderPathName
00205     );
00206 
00207 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>
00208 <a class="code" href="../../d9/d5/ioinit_8c.html#a30">IopGetDriverTagPriority</a> (
00209     IN HANDLE Servicehandle
00210     );
00211 
00212 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00213 <a class="code" href="../../d9/d5/ioinit_8c.html#a31">IopInsertDriverList</a> (
00214     IN PLIST_ENTRY ListHead,
00215     IN PDRIVER_INFORMATION DriverInfo
00216     );
00217 
00218 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00219 <a class="code" href="../../d9/d5/ioinit_8c.html#a32">IopNotifySetupDevices</a> (
00220     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode
00221     );
00222 
00223 BOOLEAN
00224 <a class="code" href="../../d9/d5/ioinit_8c.html#a33">IopWaitForBootDevicesStarted</a> (
00225     IN VOID
00226     );
00227 
00228 BOOLEAN
00229 <a class="code" href="../../d9/d5/ioinit_8c.html#a34">IopWaitForBootDevicesDeleted</a> (
00230     IN VOID
00231     );
00232 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00233 <a class="code" href="../../d9/d5/ioinit_8c.html#a37">IopSetIoRoutines</a>(
00234     IN VOID
00235     );
00236 
00237 <span class="comment">//</span>
00238 <span class="comment">// The following allows the I/O system's initialization routines to be</span>
00239 <span class="comment">// paged out of memory.</span>
00240 <span class="comment">//</span>
00241 
00242 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00243 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IoInitSystem)</span>
00244 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopCheckDependencies)</span>
00245 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopCreateArcNames)</span>
00246 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopCreateEntry)</span>
00247 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopCreateObjectTypes)</span>
00248 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopCreateRootDirectories)</span>
00249 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopFreeGroupTree)</span>
00250 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopInitializeAttributesAndCreateObject)</span>
00251 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopInitializeBootDrivers)</span>
00252 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopInitializeBuiltinDriver)</span>
00253 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopInitializeSingleBootDriver)</span>
00254 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopInitializeSystemDrivers)</span>
00255 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopLookupGroupName)</span>
00256 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopMarkBootPartition)</span>
00257 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopReassignSystemRoot)</span>
00258 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopStoreSystemPartitionInformation)</span>
00259 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopInsertDriverList)</span>
00260 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopGetDriverTagPriority)</span>
00261 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopNotifySetupDevices)</span>
00262 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopWaitForBootDevicesStarted)</span>
00263 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopWaitForBootDevicesDeleted)</span>
00264 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopLoadBootFilterDriver)</span>
00265 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopSetIoRoutines)</span>
00266 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00267 <span class="preprocessor"></span>
00268 
00269 BOOLEAN
<a name="l00270"></a><a class="code" href="../../d9/d5/ioinit_8c.html#a36">00270</a> <a class="code" href="../../d9/d5/ioinit_8c.html#a36">IoInitSystem</a>(
00271     <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
00272     )
00273 
00274 <span class="comment">/*++</span>
00275 <span class="comment"></span>
00276 <span class="comment">Routine Description:</span>
00277 <span class="comment"></span>
00278 <span class="comment">    This routine initializes the I/O system.</span>
00279 <span class="comment"></span>
00280 <span class="comment">Arguments:</span>
00281 <span class="comment"></span>
00282 <span class="comment">    LoaderBlock - Supplies a pointer to the loader parameter block that was</span>
00283 <span class="comment">        created by the OS Loader.</span>
00284 <span class="comment"></span>
00285 <span class="comment">Return Value:</span>
00286 <span class="comment"></span>
00287 <span class="comment">    The function value is a BOOLEAN indicating whether or not the I/O system</span>
00288 <span class="comment">    was successfully initialized.</span>
00289 <span class="comment"></span>
00290 <span class="comment">--*/</span>
00291 
00292 {
00293     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
00294     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> *nextDriverObject;
00295     STRING ntDeviceName;
00296     UCHAR deviceNameBuffer[256];
00297     ULONG largePacketSize;
00298     ULONG smallPacketSize;
00299     ULONG mdlPacketSize;
00300     ULONG numberOfPackets;
00301     ULONG poolSize;
00302     PLIST_ENTRY entry;
00303     <a class="code" href="../../d5/d3/struct__REINIT__PACKET.html">PREINIT_PACKET</a> reinitEntry;
00304     LARGE_INTEGER deltaTime;
00305     <a class="code" href="../../d2/d1/mm_8h.html#a140">MM_SYSTEMSIZE</a> systemSize;
00306     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> completionZoneSize;
00307     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> largeIrpZoneSize;
00308     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> smallIrpZoneSize;
00309     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> mdlZoneSize;
00310     ULONG oldNtGlobalFlag;
00311     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00312     ANSI_STRING ansiString;
00313     UNICODE_STRING eventName;
00314     UNICODE_STRING startTypeName;
00315     OBJECT_ATTRIBUTES objectAttributes;
00316     HANDLE handle;
00317     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
00318     <a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">PNPAGED_LOOKASIDE_LIST</a> lookaside;
00319     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00320     PKPRCB prcb;
00321     ULONG len;
00322     PKEY_VALUE_PARTIAL_INFORMATION value;
00323     UCHAR   valueBuffer[32];
00324 
00325     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d3/d5/iodata_8c.html#a63">IopQueryOperationLength</a>[FileMaximumInformation] == 0xff );
00326     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d3/d5/iodata_8c.html#a64">IopSetOperationLength</a>[FileMaximumInformation] == 0xff );
00327     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d3/d5/iodata_8c.html#a66">IopQueryOperationAccess</a>[FileMaximumInformation] == 0xffffffff );
00328     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d3/d5/iodata_8c.html#a67">IopSetOperationAccess</a>[FileMaximumInformation] == 0xffffffff );
00329 
00330     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d3/d5/iodata_8c.html#a68">IopQueryFsOperationLength</a>[FileFsMaximumInformation] == 0xff );
00331     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d3/d5/iodata_8c.html#a69">IopSetFsOperationLength</a>[FileFsMaximumInformation] == 0xff );
00332     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d3/d5/iodata_8c.html#a70">IopQueryFsOperationAccess</a>[FileFsMaximumInformation] == 0xffffffff );
00333     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d3/d5/iodata_8c.html#a71">IopSetFsOperationAccess</a>[FileFsMaximumInformation] == 0xffffffff );
00334 
00335     <span class="comment">//</span>
00336     <span class="comment">// Initialize the I/O database resource, lock, and the file system and</span>
00337     <span class="comment">// network file system queue headers.  Also allocate the cancel spin</span>
00338     <span class="comment">// lock.</span>
00339     <span class="comment">//</span>
00340 
00341     ntDeviceName.Buffer = deviceNameBuffer;
00342     ntDeviceName.MaximumLength = <span class="keyword">sizeof</span>(deviceNameBuffer);
00343     ntDeviceName.Length = 0;
00344 
00345     <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a4">IopDatabaseResource</a> );
00346     <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a5">IopSecurityResource</a> );
00347     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a3">IopDatabaseLock</a> );
00348     InitializeListHead( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a6">IopDiskFileSystemQueueHead</a> );
00349     InitializeListHead( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a7">IopCdRomFileSystemQueueHead</a> );
00350     InitializeListHead( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a9">IopTapeFileSystemQueueHead</a> );
00351     InitializeListHead( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a8">IopNetworkFileSystemQueueHead</a> );
00352     InitializeListHead( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a10">IopBootDriverReinitializeQueueHead</a> );
00353     InitializeListHead( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a11">IopDriverReinitializeQueueHead</a> );
00354     InitializeListHead( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a12">IopNotifyShutdownQueueHead</a> );
00355     InitializeListHead( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a13">IopNotifyLastChanceShutdownQueueHead</a> );
00356     InitializeListHead( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a14">IopFsNotifyChangeQueueHead</a> );
00357     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a1">IopCancelSpinLock</a> );
00358     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a2">IopVpbSpinLock</a> );
00359     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;<a class="code" href="../../d0/d5/io_8h.html#a379">IoStatisticsLock</a> );
00360 
00361     <a class="code" href="../../d9/d5/ioinit_8c.html#a37">IopSetIoRoutines</a>();
00362     <span class="comment">//</span>
00363     <span class="comment">// Initialize the unique device object number counter used by IoCreateDevice</span>
00364     <span class="comment">// when automatically generating a device object name.</span>
00365     <span class="comment">//</span>
00366     <a class="code" href="../../d3/d5/iodata_8c.html#a50">IopUniqueDeviceObjectNumber</a> = 0;
00367 
00368     <span class="comment">//</span>
00369     <span class="comment">// Initialize the large I/O Request Packet (IRP) lookaside list head and the</span>
00370     <span class="comment">// mutex which guards the list.</span>
00371     <span class="comment">//</span>
00372 
00373     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d0/cmdat3_8c.html#a56">IopLargeIrpStackLocations</a>) {
00374         <a class="code" href="../../d8/d0/cmdat3_8c.html#a56">IopLargeIrpStackLocations</a> = <a class="code" href="../../d9/d5/ioinit_8c.html#a0">DEFAULT_LARGE_IRP_LOCATIONS</a>;
00375     }
00376 
00377     systemSize = <a class="code" href="../../d5/d1/mminit_8c.html#a57">MmQuerySystemSize</a>();
00378 
00379     <span class="keywordflow">switch</span> ( systemSize ) {
00380 
00381     <span class="keywordflow">case</span> <a class="code" href="../../d2/d1/mm_8h.html#a343a165">MmSmallSystem</a> :
00382         completionZoneSize = 6;
00383         smallIrpZoneSize = 6;
00384         largeIrpZoneSize = 8;
00385         mdlZoneSize = 16;
00386         <a class="code" href="../../d0/d6/iop_8h.html#a131">IopLookasideIrpLimit</a> = <a class="code" href="../../d9/d5/ioinit_8c.html#a1">DEFAULT_LOOKASIDE_IRP_LIMIT</a>;
00387         <span class="keywordflow">break</span>;
00388 
00389     <span class="keywordflow">case</span> <a class="code" href="../../d2/d1/mm_8h.html#a343a166">MmMediumSystem</a> :
00390         completionZoneSize = 24;
00391         smallIrpZoneSize = 24;
00392         largeIrpZoneSize = 32;
00393         mdlZoneSize = 90;
00394         <a class="code" href="../../d0/d6/iop_8h.html#a131">IopLookasideIrpLimit</a> = <a class="code" href="../../d9/d5/ioinit_8c.html#a1">DEFAULT_LOOKASIDE_IRP_LIMIT</a> * 2;
00395         <span class="keywordflow">break</span>;
00396 
00397     <span class="keywordflow">case</span> <a class="code" href="../../d2/d1/mm_8h.html#a343a167">MmLargeSystem</a> :
00398         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/mminit_8c.html#a58">MmIsThisAnNtAsSystem</a>()) {
00399             completionZoneSize = 96;
00400             smallIrpZoneSize = 96;
00401             largeIrpZoneSize = 128;
00402             mdlZoneSize = 256;
00403             <a class="code" href="../../d0/d6/iop_8h.html#a131">IopLookasideIrpLimit</a> = <a class="code" href="../../d9/d5/ioinit_8c.html#a1">DEFAULT_LOOKASIDE_IRP_LIMIT</a> * 4;
00404 
00405         } <span class="keywordflow">else</span> {
00406             completionZoneSize = 32;
00407             smallIrpZoneSize = 32;
00408             largeIrpZoneSize = 64;
00409             mdlZoneSize = 128;
00410             <a class="code" href="../../d0/d6/iop_8h.html#a131">IopLookasideIrpLimit</a> = <a class="code" href="../../d9/d5/ioinit_8c.html#a1">DEFAULT_LOOKASIDE_IRP_LIMIT</a> * 3;
00411         }
00412 
00413         <span class="keywordflow">break</span>;
00414     }
00415 
00416     <span class="comment">//</span>
00417     <span class="comment">// Initialize the system I/O completion lookaside list.</span>
00418     <span class="comment">//</span>
00419 
00420     <a class="code" href="../../d5/d8/ex_8h.html#a246">ExInitializeNPagedLookasideList</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a15">IopCompletionLookasideList</a>,
00421                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00422                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00423                                      0,
00424                                      <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d0/struct__IOP__MINI__COMPLETION__PACKET.html">IOP_MINI_COMPLETION_PACKET</a>),
00425                                      ' pcI',
00426                                      completionZoneSize );
00427 
00428     <span class="comment">//</span>
00429     <span class="comment">// Initialize the system large IRP lookaside list.</span>
00430     <span class="comment">//</span>
00431 
00432     largePacketSize = (ULONG) (<span class="keyword">sizeof</span>( <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> ) + (<a class="code" href="../../d8/d0/cmdat3_8c.html#a56">IopLargeIrpStackLocations</a> * <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> )));
00433     <a class="code" href="../../d5/d8/ex_8h.html#a246">ExInitializeNPagedLookasideList</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a16">IopLargeIrpLookasideList</a>,
00434                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00435                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00436                                      0,
00437                                      largePacketSize,
00438                                      'lprI',
00439                                      largeIrpZoneSize );
00440 
00441     <span class="comment">//</span>
00442     <span class="comment">// Initialize the system small IRP lookaside list.</span>
00443     <span class="comment">//</span>
00444 
00445     smallPacketSize = (ULONG) (<span class="keyword">sizeof</span>( <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> ) + <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> ));
00446     <a class="code" href="../../d5/d8/ex_8h.html#a246">ExInitializeNPagedLookasideList</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a17">IopSmallIrpLookasideList</a>,
00447                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00448                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00449                                      0,
00450                                      smallPacketSize,
00451                                      'sprI',
00452                                      smallIrpZoneSize );
00453 
00454     <span class="comment">//</span>
00455     <span class="comment">// Initialize the system MDL lookaside list.</span>
00456     <span class="comment">//</span>
00457 
00458     mdlPacketSize = (ULONG) (<span class="keyword">sizeof</span>( <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> ) + (<a class="code" href="../../d0/d6/iop_8h.html#a12">IOP_FIXED_SIZE_MDL_PFNS</a> * <span class="keyword">sizeof</span>( PFN_NUMBER )));
00459     <a class="code" href="../../d5/d8/ex_8h.html#a246">ExInitializeNPagedLookasideList</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a18">IopMdlLookasideList</a>,
00460                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00461                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00462                                      0,
00463                                      mdlPacketSize,
00464                                      ' ldM',
00465                                      mdlZoneSize );
00466 
00467     <span class="comment">//</span>
00468     <span class="comment">// Initialize the per processor nonpaged lookaside lists and descriptors.</span>
00469     <span class="comment">//</span>
00470 
00471     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; (ULONG)<a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00472         prcb = <a class="code" href="../../d4/d9/ke_8h.html#a139">KiProcessorBlock</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00473 
00474         <span class="comment">//</span>
00475         <span class="comment">// Initialize the I/O completion per processor lookaside pointers</span>
00476         <span class="comment">//</span>
00477 
00478         prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a203">LookasideCompletionList</a>].L = &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a15">IopCompletionLookasideList</a>;
00479         lookaside = (<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">PNPAGED_LOOKASIDE_LIST</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00480                                                                    <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a>),
00481                                                                    'PpcI');
00482 
00483         <span class="keywordflow">if</span> (lookaside != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00484             <a class="code" href="../../d5/d8/ex_8h.html#a246">ExInitializeNPagedLookasideList</a>( lookaside,
00485                                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00486                                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00487                                              0,
00488                                              <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d6/iop_8h.html#a69">IOP_MINI_COMPLETION_PACKET</a>),
00489                                              'PpcI',
00490                                              completionZoneSize );
00491 
00492         } <span class="keywordflow">else</span> {
00493             lookaside = &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a15">IopCompletionLookasideList</a>;
00494         }
00495 
00496         prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a203">LookasideCompletionList</a>].P = lookaside;
00497 
00498         <span class="comment">//</span>
00499         <span class="comment">// Initialize the large IRP per processor lookaside pointers.</span>
00500         <span class="comment">//</span>
00501 
00502         prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a198">LookasideLargeIrpList</a>].<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a> = &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a16">IopLargeIrpLookasideList</a>;
00503         lookaside = (<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">PNPAGED_LOOKASIDE_LIST</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00504                                                                    <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d8/ex_8h.html#a104">NPAGED_LOOKASIDE_LIST</a>),
00505                                                                    'LprI');
00506 
00507         <span class="keywordflow">if</span> (lookaside != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00508             <a class="code" href="../../d5/d8/ex_8h.html#a246">ExInitializeNPagedLookasideList</a>( lookaside,
00509                                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00510                                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00511                                              0,
00512                                              largePacketSize,
00513                                              'LprI',
00514                                              largeIrpZoneSize );
00515 
00516         } <span class="keywordflow">else</span> {
00517             lookaside = &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a16">IopLargeIrpLookasideList</a>;
00518         }
00519 
00520         prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a198">LookasideLargeIrpList</a>].P = lookaside;
00521 
00522         <span class="comment">//</span>
00523         <span class="comment">// Initialize the small IRP per processor lookaside pointers.</span>
00524         <span class="comment">//</span>
00525 
00526         prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a197">LookasideSmallIrpList</a>].<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a> = &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a17">IopSmallIrpLookasideList</a>;
00527         lookaside = (<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">PNPAGED_LOOKASIDE_LIST</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00528                                                                    <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d8/ex_8h.html#a104">NPAGED_LOOKASIDE_LIST</a>),
00529                                                                    'SprI');
00530 
00531         <span class="keywordflow">if</span> (lookaside != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00532             <a class="code" href="../../d5/d8/ex_8h.html#a246">ExInitializeNPagedLookasideList</a>( lookaside,
00533                                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00534                                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00535                                              0,
00536                                              smallPacketSize,
00537                                              'SprI',
00538                                              smallIrpZoneSize);
00539 
00540         } <span class="keywordflow">else</span> {
00541             lookaside = &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a17">IopSmallIrpLookasideList</a>;
00542         }
00543 
00544         prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a197">LookasideSmallIrpList</a>].P = lookaside;
00545 
00546         <span class="comment">//</span>
00547         <span class="comment">// Initialize the MDL per processor lookaside list pointers.</span>
00548         <span class="comment">//</span>
00549 
00550         prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a199">LookasideMdlList</a>].<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a> = &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a18">IopMdlLookasideList</a>;
00551         lookaside = (<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">PNPAGED_LOOKASIDE_LIST</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00552                                                                    <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d8/ex_8h.html#a104">NPAGED_LOOKASIDE_LIST</a>),
00553                                                                    'PldM');
00554 
00555         <span class="keywordflow">if</span> (lookaside != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00556             <a class="code" href="../../d5/d8/ex_8h.html#a246">ExInitializeNPagedLookasideList</a>( lookaside,
00557                                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00558                                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00559                                              0,
00560                                              mdlPacketSize,
00561                                              'PldM',
00562                                              mdlZoneSize );
00563 
00564         } <span class="keywordflow">else</span> {
00565             lookaside = &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a18">IopMdlLookasideList</a>;
00566         }
00567 
00568         prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a199">LookasideMdlList</a>].P = lookaside;
00569     }
00570 
00571     <span class="comment">//</span>
00572     <span class="comment">// Initialize the I/O completion spin lock.</span>
00573     <span class="comment">//</span>
00574 
00575     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a24">IopCompletionLock</a> );
00576 
00577     <span class="comment">//</span>
00578     <span class="comment">// Initalize the error log spin locks and log list.</span>
00579     <span class="comment">//</span>
00580 
00581     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a6">IopErrorLogLock</a> );
00582     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a7">IopErrorLogAllocationLock</a> );
00583     InitializeListHead( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a21">IopErrorLogListHead</a> );
00584 
00585     <span class="comment">//</span>
00586     <span class="comment">// Determine if the Error Log service will ever run this boot.</span>
00587     <span class="comment">//</span>
00588     InitializeObjectAttributes (&amp;objectAttributes,
00589                                 &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a31">CmRegistryMachineSystemCurrentControlSetServicesEventLog</a>,
00590                                 OBJ_CASE_INSENSITIVE,
00591                                 (HANDLE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00592                                 (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00593 
00594     status = ZwOpenKey(&amp;handle,
00595                        KEY_READ,
00596                        &amp;objectAttributes
00597                        );
00598 
00599     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00600         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;startTypeName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Start"</span>);
00601         value = (PKEY_VALUE_PARTIAL_INFORMATION) valueBuffer;
00602         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a> (handle,
00603                                   &amp;startTypeName,
00604                                   KeyValuePartialInformation,
00605                                   valueBuffer,
00606                                   <span class="keyword">sizeof</span> (valueBuffer),
00607                                   &amp;len);
00608 
00609         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status) &amp;&amp; (value-&gt;Type == REG_DWORD)) {
00610             <span class="keywordflow">if</span> (SERVICE_DISABLED == (*(PULONG) (value-&gt;Data))) {
00611                 <span class="comment">//</span>
00612                 <span class="comment">// We are disabled for this boot.</span>
00613                 <span class="comment">//</span>
00614                 <a class="code" href="../../d7/d7/errorlog_8c.html#a7">IopErrorLogDisabledThisBoot</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00615             } <span class="keywordflow">else</span> {
00616                 <a class="code" href="../../d7/d7/errorlog_8c.html#a7">IopErrorLogDisabledThisBoot</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00617             }
00618         } <span class="keywordflow">else</span> {
00619             <span class="comment">//</span>
00620             <span class="comment">// Didn't find the value so we are not enabled.</span>
00621             <span class="comment">//</span>
00622             <a class="code" href="../../d7/d7/errorlog_8c.html#a7">IopErrorLogDisabledThisBoot</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00623         }
00624     } <span class="keywordflow">else</span> {
00625         <span class="comment">//</span>
00626         <span class="comment">// Didn't find the key so we are not enabled</span>
00627         <span class="comment">//</span>
00628         <a class="code" href="../../d7/d7/errorlog_8c.html#a7">IopErrorLogDisabledThisBoot</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00629     }
00630 
00631     <span class="comment">//</span>
00632     <span class="comment">// Initialize the registry access semaphore.</span>
00633     <span class="comment">//</span>
00634 
00635     <a class="code" href="../../d1/d6/semphobj_8c.html#a1">KeInitializeSemaphore</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a60">IopRegistrySemaphore</a>, 1, 1 );
00636 
00637     <span class="comment">//</span>
00638     <span class="comment">// Initialize the timer database and start the timer DPC routine firing</span>
00639     <span class="comment">// so that drivers can use it during initialization.</span>
00640     <span class="comment">//</span>
00641 
00642     deltaTime.QuadPart = - 10 * 1000 * 1000;
00643 
00644     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a8">IopTimerLock</a> );
00645     InitializeListHead( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a28">IopTimerQueueHead</a> );
00646     <a class="code" href="../../d4/d1/dpcobj_8c.html#a1">KeInitializeDpc</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a29">IopTimerDpc</a>, <a class="code" href="../../d2/d4/internal_8c.html#a68">IopTimerDispatch</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00647     <a class="code" href="../../d3/d2/timerobj_8c.html#a2">KeInitializeTimerEx</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a30">IopTimer</a>, SynchronizationTimer );
00648     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d3/d2/timerobj_8c.html#a7">KeSetTimerEx</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a30">IopTimer</a>, deltaTime, 1000, &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a29">IopTimerDpc</a> );
00649 
00650     <span class="comment">//</span>
00651     <span class="comment">// Initialize the IopHardError structure used for informational pop-ups.</span>
00652     <span class="comment">//</span>
00653 
00654     <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a25">IopHardError</a>.<a class="code" href="../../d8/d0/struct__IOP__HARD__ERROR__QUEUE.html#o0">ExWorkItem</a>,
00655                           <a class="code" href="../../d2/d4/internal_8c.html#a44">IopHardErrorThread</a>,
00656                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00657 
00658     InitializeListHead( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a25">IopHardError</a>.<a class="code" href="../../d8/d0/struct__IOP__HARD__ERROR__QUEUE.html#o1">WorkQueue</a> );
00659 
00660     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a25">IopHardError</a>.<a class="code" href="../../d8/d0/struct__IOP__HARD__ERROR__QUEUE.html#o2">WorkQueueSpinLock</a> );
00661 
00662     <a class="code" href="../../d1/d6/semphobj_8c.html#a1">KeInitializeSemaphore</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a25">IopHardError</a>.<a class="code" href="../../d8/d0/struct__IOP__HARD__ERROR__QUEUE.html#o3">WorkQueueSemaphore</a>,
00663                            0,
00664                            MAXLONG );
00665 
00666     <a class="code" href="../../d3/d5/iodata_8c.html#a25">IopHardError</a>.<a class="code" href="../../d8/d0/struct__IOP__HARD__ERROR__QUEUE.html#o4">ThreadStarted</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00667 
00668     <a class="code" href="../../d3/d5/iodata_8c.html#a26">IopCurrentHardError</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00669 
00670     <span class="comment">//</span>
00671     <span class="comment">// Create the link tracking named event.</span>
00672     <span class="comment">//</span>
00673 
00674     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;eventName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Security\\TRKWKS_EVENT"</span> );
00675     InitializeObjectAttributes( &amp;objectAttributes,
00676                                 &amp;eventName,
00677                                 OBJ_PERMANENT,
00678                                 (HANDLE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00679                                 (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00680     status = <a class="code" href="../../d0/d8/ex_2event_8c.html#a5">NtCreateEvent</a>( &amp;handle,
00681                             EVENT_ALL_ACCESS,
00682                             &amp;objectAttributes,
00683                             NotificationEvent,
00684                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00685     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00686 <span class="preprocessor">#if DBG</span>
00687 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IOINIT: NtCreateEvent failed\n"</span> );
00688 <span class="preprocessor">#endif</span>
00689 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00690     }
00691 
00692     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( handle,
00693                                       0,
00694                                       <a class="code" href="../../d7/d7/ntapi_8c.html#a3">ExEventObjectType</a>,
00695                                       <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00696                                       (PVOID *) &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a62">IopLinkTrackingServiceEvent</a>,
00697                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00698 
00699     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a53">IopLinkTrackingPacket</a>.<a class="code" href="../../d8/d1/struct__LINK__TRACKING__PACKET.html#o1">Event</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00700     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;<a class="code" href="../../d3/d5/iodata_8c.html#a52">IopLinkTrackingPortObject</a>, SynchronizationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00701 
00702     <a class="code" href="../../d1/d6/semphobj_8c.html#a1">KeInitializeSemaphore</a>(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a4">IopProfileChangeSemaphore</a>, 1, 1) ;
00703 
00704     <span class="comment">//</span>
00705     <span class="comment">// Create all of the objects for the I/O system.</span>
00706     <span class="comment">//</span>
00707 
00708     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d5/ioinit_8c.html#a17">IopCreateObjectTypes</a>()) {
00709 <span class="preprocessor">#if DBG</span>
00710 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IOINIT: IopCreateObjectTypes failed\n"</span> );
00711 <span class="preprocessor">#endif</span>
00712 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00713     }
00714 
00715     <span class="comment">//</span>
00716     <span class="comment">// Create the root directories for the I/O system.</span>
00717     <span class="comment">//</span>
00718 
00719     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d5/ioinit_8c.html#a19">IopCreateRootDirectories</a>()) {
00720 <span class="preprocessor">#if DBG</span>
00721 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IOINIT: IopCreateRootDirectories failed\n"</span> );
00722 <span class="preprocessor">#endif</span>
00723 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00724     }
00725 
00726     <span class="comment">//</span>
00727     <span class="comment">// Initialize the resource map</span>
00728     <span class="comment">//</span>
00729 
00730     <a class="code" href="../../d1/d8/report_8c.html#a10">IopInitializeResourceMap</a> (LoaderBlock);
00731 
00732     <span class="comment">//</span>
00733     <span class="comment">// Initialize PlugPlay services phase 0</span>
00734     <span class="comment">//</span>
00735 
00736     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a237">IopInitializePlugPlayServices</a>(LoaderBlock, 0);
00737     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00738         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00739     }
00740 
00741     <span class="comment">//</span>
00742     <span class="comment">// Call Power manager to initialize for drivers</span>
00743     <span class="comment">//</span>
00744 
00745     <a class="code" href="../../d1/d2/po_8h.html#a59">PoInitDriverServices</a>(0);
00746 
00747     <span class="comment">//</span>
00748     <span class="comment">// Call HAL to initialize PnP bus driver</span>
00749     <span class="comment">//</span>
00750 
00751     <a class="code" href="../../d2/d7/hal_8h.html#a31">HalInitPnpDriver</a>();
00752     deviceNode = <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>;
00753     <span class="keywordflow">while</span> (deviceNode) {
00754         <span class="keywordflow">if</span> ((deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>) &amp;&amp;
00755             !(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a24">DNF_LEGACY_DRIVER</a>)) {
00756             <a class="code" href="../../d1/d0/pnpdata_8c.html#a3">IopInitHalDeviceNode</a> = deviceNode;
00757             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a7">DNF_HAL_NODE</a>;
00758             <span class="keywordflow">break</span>;
00759         }
00760         deviceNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
00761     }
00762 
00763     <span class="comment">//</span>
00764     <span class="comment">// Call WMI to initialize it and allow it to create its driver object</span>
00765     <span class="comment">// Note that no calls to WMI can occur until it is initialized here.</span>
00766     <span class="comment">//</span>
00767 
00768     <a class="code" href="../../d0/d5/io_8h.html#a576">WMIInitialize</a>();
00769 
00770     <span class="comment">//</span>
00771     <span class="comment">// Save this for use during PnP enumeration -- we NULL it out later</span>
00772     <span class="comment">// before LoaderBlock is reused.</span>
00773     <span class="comment">//</span>
00774 
00775     <a class="code" href="../../d3/d5/iodata_8c.html#a73">IopLoaderBlock</a> = (PVOID)LoaderBlock;
00776 
00777     <span class="comment">//</span>
00778     <span class="comment">// If this is a remote boot, we need to add a few values to the registry.</span>
00779     <span class="comment">//</span>
00780 
00781     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/io_8h.html#a399">IoRemoteBootClient</a>) {
00782         status = <a class="code" href="../../d4/d6/netboot_8c.html#a10">IopAddRemoteBootValuesToRegistry</a>(LoaderBlock);
00783         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00784             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( NETWORK_BOOT_INITIALIZATION_FAILED,
00785                           1,
00786                           status,
00787                           0,
00788                           0 );
00789         }
00790     }
00791 
00792     <span class="comment">//</span>
00793     <span class="comment">// Initialize PlugPlay services phase 1 to execute firmware mapper</span>
00794     <span class="comment">//</span>
00795 
00796     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a237">IopInitializePlugPlayServices</a>(LoaderBlock, 1);
00797     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00798         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00799     }
00800 
00801     <span class="comment">//</span>
00802     <span class="comment">// Initialize the drivers loaded by the boot loader (OSLOADER)</span>
00803     <span class="comment">//</span>
00804 
00805     nextDriverObject = &amp;driverObject;
00806     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d5/ioinit_8c.html#a22">IopInitializeBootDrivers</a>( LoaderBlock,
00807                                    nextDriverObject )) {
00808 <span class="preprocessor">#if DBG</span>
00809 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IOINIT: Initializing boot drivers failed\n"</span> );
00810 <span class="preprocessor">#endif // DBG</span>
00811 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00812     }
00813 
00814     <span class="comment">//</span>
00815     <span class="comment">// Once we have initialized the boot drivers, we don't need the</span>
00816     <span class="comment">// copy of the pointer to the loader block any more.</span>
00817     <span class="comment">//</span>
00818 
00819     <a class="code" href="../../d3/d5/iodata_8c.html#a73">IopLoaderBlock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00820 
00821     <span class="comment">//</span>
00822     <span class="comment">// If this is a remote boot, start the network and assign</span>
00823     <span class="comment">// C: to \Device\LanmanRedirector.</span>
00824     <span class="comment">//</span>
00825 
00826     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/io_8h.html#a399">IoRemoteBootClient</a>) {
00827         status = <a class="code" href="../../d4/d6/netboot_8c.html#a11">IopStartNetworkForRemoteBoot</a>(LoaderBlock);
00828         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00829             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( NETWORK_BOOT_INITIALIZATION_FAILED,
00830                           2,
00831                           status,
00832                           0,
00833                           0 );
00834         }
00835     }
00836 
00837     <span class="comment">//</span>
00838     <span class="comment">// Save the current value of the NT Global Flags and enable kernel debugger</span>
00839     <span class="comment">// symbol loading while drivers are being loaded so that systems can be</span>
00840     <span class="comment">// debugged regardless of whether they are free or checked builds.</span>
00841     <span class="comment">//</span>
00842 
00843     oldNtGlobalFlag = <a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a>;
00844 
00845     <span class="keywordflow">if</span> (!(<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_ENABLE_KDEBUG_SYMBOL_LOAD)) {
00846         <a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> |= FLG_ENABLE_KDEBUG_SYMBOL_LOAD;
00847     }
00848 
00849     status = <a class="code" href="../../d0/d1/psinit_8c.html#a44">PsLocateSystemDll</a>();
00850     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00851         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00852     }
00853 
00854     <span class="comment">//</span>
00855     <span class="comment">// Initialize the device drivers for the system.</span>
00856     <span class="comment">//</span>
00857 
00858     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d5/ioinit_8c.html#a25">IopInitializeSystemDrivers</a>()) {
00859 <span class="preprocessor">#if DBG</span>
00860 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IOINIT: Initializing system drivers failed\n"</span> );
00861 <span class="preprocessor">#endif // DBG</span>
00862 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00863     }
00864 
00865     <span class="comment">//</span>
00866     <span class="comment">// Free the memory allocated to contain the group dependency list.</span>
00867     <span class="comment">//</span>
00868 
00869     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/ioinit_8c.html#a7">IopGroupListHead</a>) {
00870         <a class="code" href="../../d9/d5/ioinit_8c.html#a38">IopFreeGroupTree</a>( <a class="code" href="../../d9/d5/ioinit_8c.html#a7">IopGroupListHead</a> );
00871     }
00872 
00873     <span class="comment">//</span>
00874     <span class="comment">// Walk the list of drivers that have requested that they be called again</span>
00875     <span class="comment">// for reinitialization purposes.</span>
00876     <span class="comment">//</span>
00877 
00878     <span class="keywordflow">while</span> (entry = <a class="code" href="../../d5/d8/ex_8h.html#a239">ExInterlockedRemoveHeadList</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a11">IopDriverReinitializeQueueHead</a>, &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a3">IopDatabaseLock</a> )) {
00879         reinitEntry = CONTAINING_RECORD( entry, <a class="code" href="../../d5/d3/struct__REINIT__PACKET.html">REINIT_PACKET</a>, ListEntry );
00880         reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o2">Count</a>++;
00881         reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> &amp;= ~<a class="code" href="../../d0/d5/io_8h.html#a146">DRVO_REINIT_REGISTERED</a>;
00882         reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o2">DriverReinitializationRoutine</a>( reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>,
00883                                                     reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o3">Context</a>,
00884                                                     reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o2">Count</a> );
00885         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( reinitEntry );
00886     }
00887 
00888     <span class="comment">//</span>
00889     <span class="comment">// Reassign \SystemRoot to NT device name path.</span>
00890     <span class="comment">//</span>
00891 
00892     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d5/ioinit_8c.html#a28">IopReassignSystemRoot</a>( LoaderBlock, &amp;ntDeviceName )) {
00893         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00894     }
00895 
00896     <span class="comment">//</span>
00897     <span class="comment">// Protect the system partition of an ARC system if necessary</span>
00898     <span class="comment">//</span>
00899 
00900     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a201">IopProtectSystemPartition</a>( LoaderBlock )) {
00901         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00902     }
00903 
00904     <span class="comment">//</span>
00905     <span class="comment">// Assign DOS drive letters to disks and cdroms and define \SystemRoot.</span>
00906     <span class="comment">//</span>
00907 
00908     ansiString.MaximumLength = <a class="code" href="../../d8/d1/init_8h.html#a3">NtSystemRoot</a>.MaximumLength / <span class="keyword">sizeof</span>( WCHAR );
00909     ansiString.Length = 0;
00910     ansiString.Buffer = (<a class="code" href="../../d8/d2/ldrinit_8c.html#a7">RtlAllocateStringRoutine</a>)( ansiString.MaximumLength );
00911     status = <a class="code" href="../../d6/d6/nls_8c.html#a23">RtlUnicodeStringToAnsiString</a>( &amp;ansiString,
00912                                            &amp;<a class="code" href="../../d8/d1/init_8h.html#a3">NtSystemRoot</a>,
00913                                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00914                                          );
00915     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00916         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IOINIT: UnicodeToAnsi( %wZ ) failed - %x\n"</span>, &amp;<a class="code" href="../../d8/d1/init_8h.html#a3">NtSystemRoot</a>, status );
00917         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00918     }
00919 
00920     <a class="code" href="../../d2/d7/hal_8h.html#a191">IoAssignDriveLetters</a>( LoaderBlock,
00921                           &amp;ntDeviceName,
00922                           ansiString.Buffer,
00923                           &amp;ansiString );
00924 
00925     status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;<a class="code" href="../../d8/d1/init_8h.html#a3">NtSystemRoot</a>,
00926                                            &amp;ansiString,
00927                                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00928                                          );
00929     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00930         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IOINIT: AnsiToUnicode( %Z ) failed - %x\n"</span>, &amp;ansiString, status );
00931         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00932     }
00933 
00934     <span class="comment">//</span>
00935     <span class="comment">// Also restore the NT Global Flags to their original state.</span>
00936     <span class="comment">//</span>
00937 
00938     <a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> = oldNtGlobalFlag;
00939 
00940     <span class="comment">//</span>
00941     <span class="comment">// Call Power manager to initialize for post-boot drivers</span>
00942     <span class="comment">//</span>
00943     <a class="code" href="../../d1/d2/po_8h.html#a59">PoInitDriverServices</a>(1);
00944 
00945     <span class="comment">//</span>
00946     <span class="comment">// Indicate that the I/O system successfully initialized itself.</span>
00947     <span class="comment">//</span>
00948 
00949     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00950 }
00951 
00952 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00953"></a><a class="code" href="../../d9/d5/ioinit_8c.html#a37">00953</a> <a class="code" href="../../d9/d5/ioinit_8c.html#a37">IopSetIoRoutines</a>()
00954 {
00955     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/iodata_8c.html#a55">pIofCallDriver</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00956 
00957         <a class="code" href="../../d3/d5/iodata_8c.html#a55">pIofCallDriver</a> = <a class="code" href="../../d0/d6/iop_8h.html#a235">IopfCallDriver</a>;
00958     }
00959 
00960     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/iodata_8c.html#a56">pIofCompleteRequest</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00961 
00962         <a class="code" href="../../d3/d5/iodata_8c.html#a56">pIofCompleteRequest</a> = <a class="code" href="../../d0/d6/iop_8h.html#a236">IopfCompleteRequest</a>;
00963     }
00964 
00965     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/iodata_8c.html#a57">pIoAllocateIrp</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00966 
00967         <a class="code" href="../../d3/d5/iodata_8c.html#a57">pIoAllocateIrp</a> = <a class="code" href="../../d0/d6/iop_8h.html#a237">IopAllocateIrpPrivate</a>;
00968     }
00969 
00970     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/iodata_8c.html#a58">pIoFreeIrp</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00971 
00972         <a class="code" href="../../d3/d5/iodata_8c.html#a58">pIoFreeIrp</a> = <a class="code" href="../../d0/d6/iop_8h.html#a238">IopFreeIrp</a>;
00973     }
00974 }
00975 
00976 
00977 BOOLEAN
<a name="l00978"></a><a class="code" href="../../d9/d5/ioinit_8c.html#a15">00978</a> <a class="code" href="../../d9/d5/ioinit_8c.html#a15">IopCheckDependencies</a>(
00979     IN HANDLE KeyHandle
00980     )
00981 
00982 <span class="comment">/*++</span>
00983 <span class="comment"></span>
00984 <span class="comment">Routine Description:</span>
00985 <span class="comment"></span>
00986 <span class="comment">    This routine gets the "DependOnGroup" field for the specified key node</span>
00987 <span class="comment">    and determines whether any driver in the group(s) that this entry is</span>
00988 <span class="comment">    dependent on has successfully loaded.</span>
00989 <span class="comment"></span>
00990 <span class="comment">Arguments:</span>
00991 <span class="comment"></span>
00992 <span class="comment">    KeyHandle - Supplies a handle to the key representing the driver in</span>
00993 <span class="comment">        question.</span>
00994 <span class="comment"></span>
00995 <span class="comment">Return Value:</span>
00996 <span class="comment"></span>
00997 <span class="comment">    The function value is TRUE if the driver should be loaded, otherwise</span>
00998 <span class="comment">    FALSE</span>
00999 <span class="comment"></span>
01000 <span class="comment">--*/</span>
01001 
01002 {
01003     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
01004     UNICODE_STRING groupName;
01005     BOOLEAN load;
01006     ULONG length;
01007     PWSTR source;
01008     <a class="code" href="../../d9/d5/ioinit_8c.html#a4">PTREE_ENTRY</a> treeEntry;
01009 
01010     <span class="comment">//</span>
01011     <span class="comment">// Attempt to obtain the "DependOnGroup" key for the specified driver</span>
01012     <span class="comment">// entry.  If one does not exist, then simply mark this driver as being</span>
01013     <span class="comment">// one to attempt to load.  If it does exist, then check to see whether</span>
01014     <span class="comment">// or not any driver in the groups that it is dependent on has loaded</span>
01015     <span class="comment">// and allow it to load.</span>
01016     <span class="comment">//</span>
01017 
01018     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( KeyHandle, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DependOnGroup"</span>, &amp;keyValueInformation ))) {
01019         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01020     }
01021 
01022     length = keyValueInformation-&gt;DataLength;
01023 
01024     source = (PWSTR) ((PUCHAR) keyValueInformation + keyValueInformation-&gt;DataOffset);
01025     load = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01026 
01027     <span class="keywordflow">while</span> (length) {
01028         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;groupName, source );
01029         groupName.Length = groupName.MaximumLength;
01030         treeEntry = <a class="code" href="../../d9/d5/ioinit_8c.html#a26">IopLookupGroupName</a>( &amp;groupName, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01031         <span class="keywordflow">if</span> (treeEntry) {
01032             <span class="keywordflow">if</span> (!treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o4">DriversLoaded</a>) {
01033                 load = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01034                 <span class="keywordflow">break</span>;
01035             }
01036         }
01037         length -= groupName.MaximumLength;
01038         source = (PWSTR) ((PUCHAR) source + groupName.MaximumLength);
01039     }
01040 
01041     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
01042     <span class="keywordflow">return</span> load;
01043 }
01044 
01045 
01046 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01047"></a><a class="code" href="../../d9/d5/ioinit_8c.html#a16">01047</a> <a class="code" href="../../d9/d5/ioinit_8c.html#a16">IopCreateArcNames</a>(
01048     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
01049     )
01050 
01051 <span class="comment">/*++</span>
01052 <span class="comment"></span>
01053 <span class="comment">Routine Description:</span>
01054 <span class="comment"></span>
01055 <span class="comment">    The loader block contains a table of disk signatures and corresponding</span>
01056 <span class="comment">    ARC names. Each device that the loader can access will appear in the</span>
01057 <span class="comment">    table. This routine opens each disk device in the system, reads the</span>
01058 <span class="comment">    signature and compares it to the table. For each match, it creates a</span>
01059 <span class="comment">    symbolic link between the nt device name and the ARC name.</span>
01060 <span class="comment"></span>
01061 <span class="comment">    The checksum value provided by the loader is the ULONG sum of all</span>
01062 <span class="comment">    elements in the checksum, inverted, plus 1:</span>
01063 <span class="comment">    checksum = ~sum + 1;</span>
01064 <span class="comment">    This way the sum of all of the elements can be calculated here and</span>
01065 <span class="comment">    added to the checksum in the loader block.  If the result is zero, then</span>
01066 <span class="comment">    there is a match.</span>
01067 <span class="comment"></span>
01068 <span class="comment">Arguments:</span>
01069 <span class="comment"></span>
01070 <span class="comment">    LoaderBlock - Supplies a pointer to the loader parameter block that was</span>
01071 <span class="comment">        created by the OS Loader.</span>
01072 <span class="comment"></span>
01073 <span class="comment">Return Value:</span>
01074 <span class="comment"></span>
01075 <span class="comment">    None.</span>
01076 <span class="comment"></span>
01077 <span class="comment">--*/</span>
01078 
01079 {
01080     STRING arcBootDeviceString;
01081     UCHAR deviceNameBuffer[128];
01082     STRING deviceNameString;
01083     UNICODE_STRING deviceNameUnicodeString;
01084     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
01085     UCHAR arcNameBuffer[128];
01086     STRING arcNameString;
01087     UNICODE_STRING arcNameUnicodeString;
01088     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
01089     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01090     IO_STATUS_BLOCK ioStatusBlock;
01091     DISK_GEOMETRY diskGeometry;
01092     PDRIVE_LAYOUT_INFORMATION driveLayout;
01093     PLIST_ENTRY listEntry;
01094     <a class="code" href="../../d3/d9/struct__ARC__DISK__SIGNATURE.html">PARC_DISK_SIGNATURE</a> diskBlock;
01095     ULONG diskNumber;
01096     ULONG partitionNumber;
01097     PCHAR arcName;
01098     PULONG buffer;
01099     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
01100     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
01101     LARGE_INTEGER offset;
01102     ULONG checkSum;
01103     ULONG i;
01104     PVOID tmpPtr;
01105     BOOLEAN useLegacyEnumeration = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01106     BOOLEAN singleBiosDiskFound;
01107     BOOLEAN bootDiskFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01108     <a class="code" href="../../d2/d9/struct__ARC__DISK__INFORMATION.html">PARC_DISK_INFORMATION</a> arcInformation = LoaderBlock-&gt;ArcDiskInformation;
01109     ULONG totalDriverDisksFound = <a class="code" href="../../d4/d6/iosubs_8c.html#a69">IoGetConfigurationInformation</a>()-&gt;<a class="code" href="../../d6/d8/struct__CONFIGURATION__INFORMATION.html#o0">DiskCount</a>;
01110     ULONG totalPnpDisksFound = 0;
01111     STRING arcSystemDeviceString;
01112     STRING osLoaderPathString;
01113     UNICODE_STRING osLoaderPathUnicodeString;
01114     PWSTR diskList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01115     <span class="keywordtype">wchar_t</span> *pDiskNameList;
01116     STORAGE_DEVICE_NUMBER   pnpDiskDeviceNumber;
01117 
01118 
01119     <span class="comment">//</span>
01120     <span class="comment">// ask PNP to give us a list with all the currently active disks</span>
01121     <span class="comment">//</span>
01122 
01123     pDiskNameList = diskList;
01124     pnpDiskDeviceNumber.DeviceNumber = 0xFFFFFFFF;
01125     status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a86">IoGetDeviceInterfaces</a>(&amp;DiskClassGuid, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, &amp;diskList);
01126 
01127     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01128 
01129         useLegacyEnumeration = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01130         <span class="keywordflow">if</span> (pDiskNameList) {
01131             *pDiskNameList = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
01132         }
01133 
01134     } <span class="keywordflow">else</span> {
01135 
01136         <span class="comment">//</span>
01137         <span class="comment">// count the number of disks returned</span>
01138         <span class="comment">//</span>
01139 
01140         pDiskNameList = diskList;
01141         <span class="keywordflow">while</span> (*pDiskNameList != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>) {
01142 
01143             totalPnpDisksFound++;
01144             pDiskNameList = pDiskNameList + (wcslen(pDiskNameList) + 1);
01145 
01146         }
01147 
01148         pDiskNameList = diskList;
01149 
01150         <span class="comment">//</span>
01151         <span class="comment">// if the disk returned by PNP are not all the disks in the system</span>
01152         <span class="comment">// it means that some legacy driver has generated a disk device object/link.</span>
01153         <span class="comment">// In that case we need to enumerate all pnp disks and then using the legacy</span>
01154         <span class="comment">// for-loop also enumerate the non-pnp disks</span>
01155         <span class="comment">//</span>
01156 
01157         <span class="keywordflow">if</span> (totalPnpDisksFound &lt; totalDriverDisksFound) {
01158             useLegacyEnumeration = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01159         }
01160 
01161     }
01162 
01163     <span class="comment">//</span>
01164     <span class="comment">// If a single bios disk was found if there is only a</span>
01165     <span class="comment">// single entry on the disk signature list.</span>
01166     <span class="comment">//</span>
01167 
01168     singleBiosDiskFound = (arcInformation-&gt;<a class="code" href="../../d2/d9/struct__ARC__DISK__INFORMATION.html#o0">DiskSignatures</a>.Flink-&gt;Flink ==
01169                            &amp;arcInformation-&gt;<a class="code" href="../../d2/d9/struct__ARC__DISK__INFORMATION.html#o0">DiskSignatures</a>) ? (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) : (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01170 
01171 
01172     <span class="comment">//</span>
01173     <span class="comment">// Create hal/loader partition name</span>
01174     <span class="comment">//</span>
01175 
01176     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( arcNameBuffer, <span class="stringliteral">"\\ArcName\\%s"</span>, LoaderBlock-&gt;ArcHalDeviceName );
01177     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;arcNameString, arcNameBuffer );
01178     <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a> (&amp;<a class="code" href="../../d3/d5/iodata_8c.html#a87">IoArcHalDeviceName</a>, &amp;arcNameString, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01179 
01180     <span class="comment">//</span>
01181     <span class="comment">// Create boot partition name</span>
01182     <span class="comment">//</span>
01183 
01184     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( arcNameBuffer, <span class="stringliteral">"\\ArcName\\%s"</span>, LoaderBlock-&gt;ArcBootDeviceName );
01185     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;arcNameString, arcNameBuffer );
01186     <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a> (&amp;<a class="code" href="../../d3/d5/iodata_8c.html#a86">IoArcBootDeviceName</a>, &amp;arcNameString, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01187     i = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a> (LoaderBlock-&gt;ArcBootDeviceName) + 1;
01188     <a class="code" href="../../d3/d5/iodata_8c.html#a88">IoLoaderArcBootDeviceName</a> = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, i);
01189     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/iodata_8c.html#a88">IoLoaderArcBootDeviceName</a>) {
01190         memcpy (<a class="code" href="../../d3/d5/iodata_8c.html#a88">IoLoaderArcBootDeviceName</a>, LoaderBlock-&gt;ArcBootDeviceName, i);
01191     }
01192 
01193     <span class="keywordflow">if</span> (singleBiosDiskFound &amp;&amp; strstr(LoaderBlock-&gt;ArcBootDeviceName, <span class="stringliteral">"cdrom"</span>)) {
01194         singleBiosDiskFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01195     }
01196 
01197     <span class="comment">//</span>
01198     <span class="comment">// Get ARC boot device name from loader block.</span>
01199     <span class="comment">//</span>
01200 
01201     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;arcBootDeviceString,
01202                        LoaderBlock-&gt;ArcBootDeviceName );
01203 
01204     <span class="comment">//</span>
01205     <span class="comment">// Get ARC system device name from loader block.</span>
01206     <span class="comment">//</span>
01207 
01208     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;arcSystemDeviceString,
01209                        LoaderBlock-&gt;ArcHalDeviceName );
01210 
01211     <span class="comment">//</span>
01212     <span class="comment">// If this is a remote boot, create an ArcName for the redirector path.</span>
01213     <span class="comment">//</span>
01214 
01215     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/io_8h.html#a399">IoRemoteBootClient</a>) {
01216 
01217         bootDiskFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01218 
01219         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;deviceNameString, <span class="stringliteral">"\\Device\\LanmanRedirector"</span> );
01220         status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;deviceNameUnicodeString,
01221                                                &amp;deviceNameString,
01222                                                <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01223 
01224         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01225 
01226             <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( arcNameBuffer,
01227                      <span class="stringliteral">"\\ArcName\\%s"</span>,
01228                      LoaderBlock-&gt;ArcBootDeviceName );
01229             <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;arcNameString, arcNameBuffer );
01230             status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;arcNameUnicodeString,
01231                                                    &amp;arcNameString,
01232                                                    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01233             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01234 
01235                 <span class="comment">//</span>
01236                 <span class="comment">// Create symbolic link between NT device name and ARC name.</span>
01237                 <span class="comment">//</span>
01238 
01239                 <a class="code" href="../../d4/d6/iosubs_8c.html#a50">IoCreateSymbolicLink</a>( &amp;arcNameUnicodeString,
01240                                       &amp;deviceNameUnicodeString );
01241                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;arcNameUnicodeString );
01242 
01243                 <span class="comment">//</span>
01244                 <span class="comment">// We've found the system partition--store it away in the registry</span>
01245                 <span class="comment">// to later be transferred to a application-friendly location.</span>
01246                 <span class="comment">//</span>
01247                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;osLoaderPathString, LoaderBlock-&gt;NtHalPathName );
01248                 status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;osLoaderPathUnicodeString,
01249                                                        &amp;osLoaderPathString,
01250                                                        <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01251 
01252 <span class="preprocessor">#if DBG</span>
01253 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01254                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopCreateArcNames: couldn't allocate unicode string for OsLoader path - %x\n"</span>, status);
01255                 }
01256 <span class="preprocessor">#endif // DBG</span>
01257 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01258 
01259                     <a class="code" href="../../d9/d5/ioinit_8c.html#a29">IopStoreSystemPartitionInformation</a>( &amp;deviceNameUnicodeString,
01260                                                         &amp;osLoaderPathUnicodeString );
01261 
01262                     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;osLoaderPathUnicodeString );
01263                 }
01264             }
01265 
01266             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;deviceNameUnicodeString );
01267         }
01268     }
01269 
01270     <span class="comment">//</span>
01271     <span class="comment">// For each disk in the system do the following:</span>
01272     <span class="comment">// 1. open the device</span>
01273     <span class="comment">// 2. get its geometry</span>
01274     <span class="comment">// 3. read the MBR</span>
01275     <span class="comment">// 4. determine ARC name via disk signature and checksum</span>
01276     <span class="comment">// 5. construct ARC name.</span>
01277     <span class="comment">// In order to deal with the case of disk dissappearing before we get to this point</span>
01278     <span class="comment">// (due to a failed start on one of many disks present in the system) we ask PNP for a list</span>
01279     <span class="comment">// of all the currenttly active disks in the system. If the number of disks returned is</span>
01280     <span class="comment">// less than the IoGetConfigurationInformation()-&gt;DiskCount, then we have legacy disks</span>
01281     <span class="comment">// that we need to enumerate in the for loop.</span>
01282     <span class="comment">// In the legacy case, the ending condition for the loop is NOT the total disk on the</span>
01283     <span class="comment">// system but an arbitrary number of the max total legacy disks expected in the system..</span>
01284     <span class="comment">// Additional note: Legacy disks get assigned symbolic links AFTER all pnp enumeration is complete</span>
01285     <span class="comment">//</span>
01286 
01287     totalDriverDisksFound = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(totalPnpDisksFound,totalDriverDisksFound);
01288 
01289     <span class="keywordflow">if</span> (useLegacyEnumeration &amp;&amp; (totalPnpDisksFound == 0)) {
01290 
01291         <span class="comment">//</span>
01292         <span class="comment">// search up to a maximum arbitrary number of legacy disks</span>
01293         <span class="comment">//</span>
01294 
01295         totalDriverDisksFound +=20;
01296     }
01297 
01298     <span class="keywordflow">for</span> (diskNumber = 0;
01299          diskNumber &lt; totalDriverDisksFound;
01300          diskNumber++) {
01301 
01302         <span class="comment">//</span>
01303         <span class="comment">// Construct the NT name for a disk and obtain a reference.</span>
01304         <span class="comment">//</span>
01305 
01306         <span class="keywordflow">if</span> (pDiskNameList &amp;&amp; (*pDiskNameList != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>)) {
01307 
01308             <span class="comment">//</span>
01309             <span class="comment">// retrieve the first symbolic linkname from the PNP disk list</span>
01310             <span class="comment">//</span>
01311 
01312             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;deviceNameUnicodeString, pDiskNameList);
01313             pDiskNameList = pDiskNameList + (wcslen(pDiskNameList) + 1);
01314 
01315             status = <a class="code" href="../../d4/d6/iosubs_8c.html#a71">IoGetDeviceObjectPointer</a>( &amp;deviceNameUnicodeString,
01316                                                FILE_READ_ATTRIBUTES,
01317                                                &amp;fileObject,
01318                                                &amp;deviceObject );
01319 
01320             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01321 
01322                 <span class="comment">//</span>
01323                 <span class="comment">// since PNP gave s just asym link we have to retrieve the actual</span>
01324                 <span class="comment">// disk number through an IOCTL call to the disk stack.</span>
01325                 <span class="comment">// Create IRP for get device number device control.</span>
01326                 <span class="comment">//</span>
01327 
01328                 irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a25">IoBuildDeviceIoControlRequest</a>( IOCTL_STORAGE_GET_DEVICE_NUMBER,
01329                                                      deviceObject,
01330                                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01331                                                      0,
01332                                                      &amp;pnpDiskDeviceNumber,
01333                                                      <span class="keyword">sizeof</span>(STORAGE_DEVICE_NUMBER),
01334                                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01335                                                      &amp;event,
01336                                                      &amp;ioStatusBlock );
01337                 <span class="keywordflow">if</span> (!irp) {
01338                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
01339                     <span class="keywordflow">continue</span>;
01340                 }
01341 
01342                 <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event,
01343                                    NotificationEvent,
01344                                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01345                 status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject,
01346                                        irp );
01347 
01348                 <span class="keywordflow">if</span> (status == STATUS_PENDING) {
01349                     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
01350                                            <a class="code" href="../../d4/d9/ke_8h.html#a407a203">Suspended</a>,
01351                                            <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01352                                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01353                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01354                     status = ioStatusBlock.Status;
01355                 }
01356 
01357                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01358                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
01359                     <span class="keywordflow">continue</span>;
01360                 }
01361 
01362             }
01363 
01364             <span class="keywordflow">if</span> (useLegacyEnumeration &amp;&amp; (*pDiskNameList == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>) ) {
01365 
01366                 <span class="comment">//</span>
01367                 <span class="comment">// end of pnp disks</span>
01368                 <span class="comment">// if there are any legacy disks following we need to update</span>
01369                 <span class="comment">// the total disk found number to cover the maximum disk number</span>
01370                 <span class="comment">// a legacy disk could be at. (in a sparse name space)</span>
01371                 <span class="comment">//</span>
01372 
01373                 <span class="keywordflow">if</span> (pnpDiskDeviceNumber.DeviceNumber == 0xFFFFFFFF) {
01374                     pnpDiskDeviceNumber.DeviceNumber = 0;
01375                 }
01376 
01377                 diskNumber = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(diskNumber,pnpDiskDeviceNumber.DeviceNumber);
01378                 totalDriverDisksFound = diskNumber + 20;
01379 
01380             }
01381 
01382         } <span class="keywordflow">else</span> {
01383 
01384             <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( deviceNameBuffer,
01385                      <span class="stringliteral">"\\Device\\Harddisk%d\\Partition0"</span>,
01386                      diskNumber );
01387             <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;deviceNameString, deviceNameBuffer );
01388             status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;deviceNameUnicodeString,
01389                                                    &amp;deviceNameString,
01390                                                    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01391             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01392                 <span class="keywordflow">continue</span>;
01393             }
01394 
01395             status = <a class="code" href="../../d4/d6/iosubs_8c.html#a71">IoGetDeviceObjectPointer</a>( &amp;deviceNameUnicodeString,
01396                                                FILE_READ_ATTRIBUTES,
01397                                                &amp;fileObject,
01398                                                &amp;deviceObject );
01399 
01400             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;deviceNameUnicodeString );
01401 
01402             <span class="comment">//</span>
01403             <span class="comment">// set the pnpDiskNumber value so its not used.</span>
01404             <span class="comment">//</span>
01405 
01406             pnpDiskDeviceNumber.DeviceNumber = 0xFFFFFFFF;
01407 
01408         }
01409 
01410 
01411         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01412 
01413             <span class="keywordflow">continue</span>;
01414         }
01415 
01416         <span class="comment">//</span>
01417         <span class="comment">// Create IRP for get drive geometry device control.</span>
01418         <span class="comment">//</span>
01419 
01420         irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a25">IoBuildDeviceIoControlRequest</a>( IOCTL_DISK_GET_DRIVE_GEOMETRY,
01421                                              deviceObject,
01422                                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01423                                              0,
01424                                              &amp;diskGeometry,
01425                                              <span class="keyword">sizeof</span>(DISK_GEOMETRY),
01426                                              <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01427                                              &amp;event,
01428                                              &amp;ioStatusBlock );
01429         <span class="keywordflow">if</span> (!irp) {
01430             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
01431             <span class="keywordflow">continue</span>;
01432         }
01433 
01434         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event,
01435                            NotificationEvent,
01436                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01437         status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject,
01438                                irp );
01439 
01440         <span class="keywordflow">if</span> (status == STATUS_PENDING) {
01441             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
01442                                    <a class="code" href="../../d4/d9/ke_8h.html#a407a203">Suspended</a>,
01443                                    <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01444                                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01445                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01446             status = ioStatusBlock.Status;
01447         }
01448 
01449         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01450             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
01451             <span class="keywordflow">continue</span>;
01452         }
01453 
01454         <span class="comment">//</span>
01455         <span class="comment">// Get partition information for this disk.</span>
01456         <span class="comment">//</span>
01457 
01458         status = <a class="code" href="../../d2/d7/hal_8h.html#a192">IoReadPartitionTable</a>( deviceObject,
01459                                        diskGeometry.BytesPerSector,
01460                                        <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01461                                        &amp;driveLayout );
01462 
01463         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
01464 
01465         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01466             <span class="keywordflow">continue</span>;
01467         }
01468 
01469         <span class="comment">//</span>
01470         <span class="comment">// Make sure sector size is at least 512 bytes.</span>
01471         <span class="comment">//</span>
01472 
01473         <span class="keywordflow">if</span> (diskGeometry.BytesPerSector &lt; 512) {
01474             diskGeometry.BytesPerSector = 512;
01475         }
01476 
01477         <span class="comment">//</span>
01478         <span class="comment">// Check to see if EZ Drive is out there on this disk.  If</span>
01479         <span class="comment">// it is then zero out the signature in the drive layout since</span>
01480         <span class="comment">// this will never be written by anyone AND change to offset to</span>
01481         <span class="comment">// actually read sector 1 rather than 0 cause that's what the</span>
01482         <span class="comment">// loader actually did.</span>
01483         <span class="comment">//</span>
01484 
01485         offset.QuadPart = 0;
01486         <a class="code" href="../../d2/d7/hal_8h.html#a23">HalExamineMBR</a>( deviceObject,
01487                        diskGeometry.BytesPerSector,
01488                        (ULONG)0x55,
01489                        &amp;tmpPtr );
01490 
01491         <span class="keywordflow">if</span> (tmpPtr) {
01492 
01493             offset.QuadPart = diskGeometry.BytesPerSector;
01494             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(tmpPtr);
01495 <span class="preprocessor">#ifdef _X86_</span>
01496 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/i386init_8c.html#a1">KeI386MachineType</a> &amp; MACHINE_TYPE_PC_9800_COMPATIBLE) {
01497 
01498             <span class="comment">//</span>
01499             <span class="comment">//  PC 9800 compatible machines do not have a standard</span>
01500             <span class="comment">//  MBR format and use a different sector for checksuming.</span>
01501             <span class="comment">//</span>
01502 
01503             offset.QuadPart = 512;
01504 <span class="preprocessor">#endif //_X86_</span>
01505 <span class="preprocessor"></span>        }
01506 
01507         <span class="comment">//</span>
01508         <span class="comment">// Allocate buffer for sector read and construct the read request.</span>
01509         <span class="comment">//</span>
01510 
01511         buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a179">NonPagedPoolCacheAlignedMustS</a>,
01512                                  diskGeometry.BytesPerSector );
01513 
01514         <span class="keywordflow">if</span> (buffer) {
01515             irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a27">IoBuildSynchronousFsdRequest</a>( <a class="code" href="../../d0/d5/io_8h.html#a16">IRP_MJ_READ</a>,
01516                                                 deviceObject,
01517                                                 buffer,
01518                                                 diskGeometry.BytesPerSector,
01519                                                 &amp;offset,
01520                                                 &amp;event,
01521                                                 &amp;ioStatusBlock );
01522 
01523             <span class="keywordflow">if</span> (!irp) {
01524                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(driveLayout);
01525                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(buffer);
01526                 <span class="keywordflow">continue</span>;
01527             }
01528         } <span class="keywordflow">else</span> {
01529             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(driveLayout);
01530             <span class="keywordflow">continue</span>;
01531         }
01532         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event,
01533                            NotificationEvent,
01534                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01535         status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject,
01536                                irp );
01537         <span class="keywordflow">if</span> (status == STATUS_PENDING) {
01538             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
01539                                    <a class="code" href="../../d4/d9/ke_8h.html#a407a203">Suspended</a>,
01540                                    <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01541                                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01542                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01543             status = ioStatusBlock.Status;
01544         }
01545 
01546         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01547             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(driveLayout);
01548             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(buffer);
01549             <span class="keywordflow">continue</span>;
01550         }
01551 
01552         <span class="comment">//</span>
01553         <span class="comment">// Calculate MBR sector checksum.  Only 512 bytes are used.</span>
01554         <span class="comment">//</span>
01555 
01556         checkSum = 0;
01557         <span class="keywordflow">for</span> (i = 0; i &lt; 128; i++) {
01558             checkSum += buffer[i];
01559         }
01560 
01561         <span class="comment">//</span>
01562         <span class="comment">// For each ARC disk information record in the loader block</span>
01563         <span class="comment">// match the disk signature and checksum to determine its ARC</span>
01564         <span class="comment">// name and construct the NT ARC names symbolic links.</span>
01565         <span class="comment">//</span>
01566 
01567         <span class="keywordflow">for</span> (listEntry = arcInformation-&gt;<a class="code" href="../../d2/d9/struct__ARC__DISK__INFORMATION.html#o0">DiskSignatures</a>.Flink;
01568              listEntry != &amp;arcInformation-&gt;<a class="code" href="../../d2/d9/struct__ARC__DISK__INFORMATION.html#o0">DiskSignatures</a>;
01569              listEntry = listEntry-&gt;Flink) {
01570 
01571             <span class="comment">//</span>
01572             <span class="comment">// Get next record and compare disk signatures.</span>
01573             <span class="comment">//</span>
01574 
01575             diskBlock = CONTAINING_RECORD( listEntry,
01576                                            <a class="code" href="../../d3/d9/struct__ARC__DISK__SIGNATURE.html">ARC_DISK_SIGNATURE</a>,
01577                                            ListEntry );
01578 
01579             <span class="comment">//</span>
01580             <span class="comment">// Compare disk signatures.</span>
01581             <span class="comment">//</span>
01582             <span class="comment">// Or if there is only a single disk drive from</span>
01583             <span class="comment">// both the bios and driver viewpoints then</span>
01584             <span class="comment">// assign an arc name to that drive.</span>
01585             <span class="comment">//</span>
01586 
01587             <span class="keywordflow">if</span> ((singleBiosDiskFound &amp;&amp; (totalDriverDisksFound == 1)) ||
01588                 (diskBlock-&gt;<a class="code" href="../../d3/d9/struct__ARC__DISK__SIGNATURE.html#o1">Signature</a> == driveLayout-&gt;Signature &amp;&amp;
01589                  !(diskBlock-&gt;<a class="code" href="../../d3/d9/struct__ARC__DISK__SIGNATURE.html#o3">CheckSum</a> + checkSum) &amp;&amp;
01590                  diskBlock-&gt;<a class="code" href="../../d3/d9/struct__ARC__DISK__SIGNATURE.html#o4">ValidPartitionTable</a>)) {
01591 
01592                 <span class="comment">//</span>
01593                 <span class="comment">// Create unicode device name for physical disk.</span>
01594                 <span class="comment">//</span>
01595 
01596                 <span class="keywordflow">if</span> (pnpDiskDeviceNumber.DeviceNumber == 0xFFFFFFFF) {
01597 
01598                     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( deviceNameBuffer,
01599                              <span class="stringliteral">"\\Device\\Harddisk%d\\Partition0"</span>,
01600                              diskNumber );
01601 
01602                 } <span class="keywordflow">else</span> {
01603 
01604                     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( deviceNameBuffer,
01605                              <span class="stringliteral">"\\Device\\Harddisk%d\\Partition0"</span>,
01606                              pnpDiskDeviceNumber.DeviceNumber );
01607 
01608                 }
01609 
01610                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;deviceNameString, deviceNameBuffer );
01611                 status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;deviceNameUnicodeString,
01612                                                        &amp;deviceNameString,
01613                                                        <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01614                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01615                     <span class="keywordflow">continue</span>;
01616                 }
01617 
01618                 <span class="comment">//</span>
01619                 <span class="comment">// Create unicode ARC name for this partition.</span>
01620                 <span class="comment">//</span>
01621 
01622                 arcName = diskBlock-&gt;<a class="code" href="../../d3/d9/struct__ARC__DISK__SIGNATURE.html#o2">ArcName</a>;
01623                 <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( arcNameBuffer,
01624                          <span class="stringliteral">"\\ArcName\\%s"</span>,
01625                          arcName );
01626                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;arcNameString, arcNameBuffer );
01627                 status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;arcNameUnicodeString,
01628                                                        &amp;arcNameString,
01629                                                        <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01630                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01631                     <span class="keywordflow">continue</span>;
01632                 }
01633 
01634                 <span class="comment">//</span>
01635                 <span class="comment">// Create symbolic link between NT device name and ARC name.</span>
01636                 <span class="comment">//</span>
01637 
01638                 <a class="code" href="../../d4/d6/iosubs_8c.html#a50">IoCreateSymbolicLink</a>( &amp;arcNameUnicodeString,
01639                                       &amp;deviceNameUnicodeString );
01640                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;arcNameUnicodeString );
01641                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;deviceNameUnicodeString );
01642 
01643                 <span class="comment">//</span>
01644                 <span class="comment">// Create an ARC name for every partition on this disk.</span>
01645                 <span class="comment">//</span>
01646 
01647                 <span class="keywordflow">for</span> (partitionNumber = 0;
01648                      partitionNumber &lt; driveLayout-&gt;PartitionCount;
01649                      partitionNumber++) {
01650 
01651                     <span class="comment">//</span>
01652                     <span class="comment">// Create unicode NT device name.</span>
01653                     <span class="comment">//</span>
01654 
01655                     <span class="keywordflow">if</span> (pnpDiskDeviceNumber.DeviceNumber == 0xFFFFFFFF) {
01656 
01657                         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( deviceNameBuffer,
01658                                  <span class="stringliteral">"\\Device\\Harddisk%d\\Partition%d"</span>,
01659                                  diskNumber,
01660                                  partitionNumber+1 );
01661 
01662 
01663                     } <span class="keywordflow">else</span> {
01664 
01665                         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( deviceNameBuffer,
01666                                  <span class="stringliteral">"\\Device\\Harddisk%d\\Partition%d"</span>,
01667                                  pnpDiskDeviceNumber.DeviceNumber,
01668                                  partitionNumber+1 );
01669 
01670                     }
01671 
01672                     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;deviceNameString, deviceNameBuffer );
01673                     status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;deviceNameUnicodeString,
01674                                                            &amp;deviceNameString,
01675                                                            <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01676                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01677                         <span class="keywordflow">continue</span>;
01678                     }
01679 
01680                     <span class="comment">//</span>
01681                     <span class="comment">// Create unicode ARC name for this partition and</span>
01682                     <span class="comment">// check to see if this is the boot disk.</span>
01683                     <span class="comment">//</span>
01684 
01685                     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( arcNameBuffer,
01686                              <span class="stringliteral">"%spartition(%d)"</span>,
01687                              arcName,
01688                              partitionNumber+1 );
01689                     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;arcNameString, arcNameBuffer );
01690                     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/string_8c.html#a11">RtlEqualString</a>( &amp;arcNameString,
01691                                         &amp;arcBootDeviceString,
01692                                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> )) {
01693                         bootDiskFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01694                     }
01695 
01696                     <span class="comment">//</span>
01697                     <span class="comment">// See if this is the system partition.</span>
01698                     <span class="comment">//</span>
01699                     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/string_8c.html#a11">RtlEqualString</a>( &amp;arcNameString,
01700                                         &amp;arcSystemDeviceString,
01701                                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> )) {
01702                         <span class="comment">//</span>
01703                         <span class="comment">// We've found the system partition--store it away in the registry</span>
01704                         <span class="comment">// to later be transferred to a application-friendly location.</span>
01705                         <span class="comment">//</span>
01706                         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;osLoaderPathString, LoaderBlock-&gt;NtHalPathName );
01707                         status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;osLoaderPathUnicodeString,
01708                                                                &amp;osLoaderPathString,
01709                                                                <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01710 
01711 <span class="preprocessor">#if DBG</span>
01712 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01713                             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopCreateArcNames: couldn't allocate unicode string for OsLoader path - %x\n"</span>, status);
01714                         }
01715 <span class="preprocessor">#endif // DBG</span>
01716 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01717 
01718                             <a class="code" href="../../d9/d5/ioinit_8c.html#a29">IopStoreSystemPartitionInformation</a>( &amp;deviceNameUnicodeString,
01719                                                                 &amp;osLoaderPathUnicodeString );
01720 
01721                             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;osLoaderPathUnicodeString );
01722                         }
01723                     }
01724 
01725                     <span class="comment">//</span>
01726                     <span class="comment">// Add the NT ARC namespace prefix to the ARC name constructed.</span>
01727                     <span class="comment">//</span>
01728 
01729                     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( arcNameBuffer,
01730                              <span class="stringliteral">"\\ArcName\\%spartition(%d)"</span>,
01731                              arcName,
01732                              partitionNumber+1 );
01733                     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;arcNameString, arcNameBuffer );
01734                     status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;arcNameUnicodeString,
01735                                                            &amp;arcNameString,
01736                                                            <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01737                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01738                         <span class="keywordflow">continue</span>;
01739                     }
01740 
01741                     <span class="comment">//</span>
01742                     <span class="comment">// Create symbolic link between NT device name and ARC name.</span>
01743                     <span class="comment">//</span>
01744 
01745                     <a class="code" href="../../d4/d6/iosubs_8c.html#a50">IoCreateSymbolicLink</a>( &amp;arcNameUnicodeString,
01746                                           &amp;deviceNameUnicodeString );
01747                     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;arcNameUnicodeString );
01748                     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;deviceNameUnicodeString );
01749                 }
01750 
01751             } <span class="keywordflow">else</span> {
01752 
01753 <span class="preprocessor">#if DBG</span>
01754 <span class="preprocessor"></span>                <span class="comment">//</span>
01755                 <span class="comment">// Check key indicators to see if this condition may be</span>
01756                 <span class="comment">// caused by a viral infection.</span>
01757                 <span class="comment">//</span>
01758 
01759                 <span class="keywordflow">if</span> (diskBlock-&gt;<a class="code" href="../../d3/d9/struct__ARC__DISK__SIGNATURE.html#o1">Signature</a> == driveLayout-&gt;Signature &amp;&amp;
01760                     (diskBlock-&gt;<a class="code" href="../../d3/d9/struct__ARC__DISK__SIGNATURE.html#o3">CheckSum</a> + checkSum) != 0 &amp;&amp;
01761                     diskBlock-&gt;<a class="code" href="../../d3/d9/struct__ARC__DISK__SIGNATURE.html#o4">ValidPartitionTable</a>) {
01762                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopCreateArcNames: Virus or duplicate disk signatures\n"</span>);
01763                 }
01764 <span class="preprocessor">#endif</span>
01765 <span class="preprocessor"></span>            }
01766         }
01767 
01768         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( driveLayout );
01769         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( buffer );
01770     }
01771 
01772     <span class="keywordflow">if</span> (!bootDiskFound) {
01773 
01774         <span class="comment">//</span>
01775         <span class="comment">// Locate the disk block that represents the boot device.</span>
01776         <span class="comment">//</span>
01777 
01778         diskBlock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01779         <span class="keywordflow">for</span> (listEntry = arcInformation-&gt;<a class="code" href="../../d2/d9/struct__ARC__DISK__INFORMATION.html#o0">DiskSignatures</a>.Flink;
01780              listEntry != &amp;arcInformation-&gt;<a class="code" href="../../d2/d9/struct__ARC__DISK__INFORMATION.html#o0">DiskSignatures</a>;
01781              listEntry = listEntry-&gt;Flink) {
01782 
01783             diskBlock = CONTAINING_RECORD( listEntry,
01784                                            <a class="code" href="../../d3/d9/struct__ARC__DISK__SIGNATURE.html">ARC_DISK_SIGNATURE</a>,
01785                                            ListEntry );
01786             <span class="keywordflow">if</span> (strcmp( diskBlock-&gt;<a class="code" href="../../d3/d9/struct__ARC__DISK__SIGNATURE.html#o2">ArcName</a>, LoaderBlock-&gt;ArcBootDeviceName ) == 0) {
01787                 <span class="keywordflow">break</span>;
01788             }
01789             diskBlock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01790         }
01791 
01792         <span class="keywordflow">if</span> (diskBlock) {
01793 
01794             <span class="comment">//</span>
01795             <span class="comment">// This could be a CdRom boot.  Search all of the NT CdRoms</span>
01796             <span class="comment">// to locate a checksum match on the diskBlock found.  If</span>
01797             <span class="comment">// there is a match, assign the ARC name to the CdRom.</span>
01798             <span class="comment">//</span>
01799 
01800             irp = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01801             buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a179">NonPagedPoolCacheAlignedMustS</a>,
01802                                      2048 );
01803             <span class="keywordflow">if</span> (buffer) {
01804 
01805                 <span class="comment">//</span>
01806                 <span class="comment">// Construct the NT names for CdRoms and search each one</span>
01807                 <span class="comment">// for a checksum match.  If found, create the ARC Name</span>
01808                 <span class="comment">// symbolic link.</span>
01809                 <span class="comment">//</span>
01810 
01811                 <span class="keywordflow">for</span> (diskNumber = 0; <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>; diskNumber++) {
01812 
01813                     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( deviceNameBuffer,
01814                              <span class="stringliteral">"\\Device\\CdRom%d"</span>,
01815                              diskNumber );
01816 
01817                     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;deviceNameString, deviceNameBuffer );
01818                     status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;deviceNameUnicodeString,
01819                                                            &amp;deviceNameString,
01820                                                            <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01821                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01822 
01823                         status = <a class="code" href="../../d4/d6/iosubs_8c.html#a71">IoGetDeviceObjectPointer</a>( &amp;deviceNameUnicodeString,
01824                                                            FILE_READ_ATTRIBUTES,
01825                                                            &amp;fileObject,
01826                                                            &amp;deviceObject );
01827                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01828 
01829                             <span class="comment">//</span>
01830                             <span class="comment">// All CdRoms have been processed.</span>
01831                             <span class="comment">//</span>
01832 
01833                             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;deviceNameUnicodeString );
01834                             <span class="keywordflow">break</span>;
01835                         }
01836 
01837                         <span class="comment">//</span>
01838                         <span class="comment">// Read the block for the checksum calculation.</span>
01839                         <span class="comment">//</span>
01840 
01841                         offset.QuadPart = 0x8000;
01842                         irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a27">IoBuildSynchronousFsdRequest</a>( <a class="code" href="../../d0/d5/io_8h.html#a16">IRP_MJ_READ</a>,
01843                                                             deviceObject,
01844                                                             buffer,
01845                                                             2048,
01846                                                             &amp;offset,
01847                                                             &amp;event,
01848                                                             &amp;ioStatusBlock );
01849                         checkSum = 0;
01850                         <span class="keywordflow">if</span> (irp) {
01851                             <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event,
01852                                                NotificationEvent,
01853                                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01854                             status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject,
01855                                                    irp );
01856                             <span class="keywordflow">if</span> (status == STATUS_PENDING) {
01857                                 <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
01858                                                        <a class="code" href="../../d4/d9/ke_8h.html#a407a203">Suspended</a>,
01859                                                        <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01860                                                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01861                                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01862                                 status = ioStatusBlock.Status;
01863                             }
01864 
01865                             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01866 
01867                                 <span class="comment">//</span>
01868                                 <span class="comment">// Calculate MBR sector checksum.</span>
01869                                 <span class="comment">// 2048 bytes are used.</span>
01870                                 <span class="comment">//</span>
01871 
01872                                 <span class="keywordflow">for</span> (i = 0; i &lt; 2048 / <span class="keyword">sizeof</span>(ULONG) ; i++) {
01873                                     checkSum += buffer[i];
01874                                 }
01875                             }
01876                         }
01877                         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
01878 
01879                         <span class="keywordflow">if</span> (!(diskBlock-&gt;<a class="code" href="../../d3/d9/struct__ARC__DISK__SIGNATURE.html#o3">CheckSum</a> + checkSum)) {
01880 
01881                             <span class="comment">//</span>
01882                             <span class="comment">// This is the boot CdRom.  Create the symlink for</span>
01883                             <span class="comment">// the ARC name from the loader block.</span>
01884                             <span class="comment">//</span>
01885 
01886                             <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( arcNameBuffer,
01887                                      <span class="stringliteral">"\\ArcName\\%s"</span>,
01888                                      LoaderBlock-&gt;ArcBootDeviceName );
01889                             <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;arcNameString, arcNameBuffer );
01890                             status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;arcNameUnicodeString,
01891                                                                    &amp;arcNameString,
01892                                                                    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01893                             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01894 
01895                                 <a class="code" href="../../d4/d6/iosubs_8c.html#a50">IoCreateSymbolicLink</a>( &amp;arcNameUnicodeString,
01896                                                       &amp;deviceNameUnicodeString );
01897                                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;arcNameUnicodeString );
01898                             }
01899                             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;deviceNameUnicodeString );
01900                             <span class="keywordflow">break</span>;
01901                         }
01902                         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;deviceNameUnicodeString );
01903                     }
01904                 }
01905                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(buffer);
01906             }
01907         }
01908     }
01909 
01910     <span class="keywordflow">if</span> (diskList) {
01911         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(diskList);
01912     }
01913 }
01914 
<a name="l01915"></a><a class="code" href="../../d9/d5/ioinit_8c.html#a11">01915</a> GENERIC_MAPPING <a class="code" href="../../d9/d5/ioinit_8c.html#a11">IopFileMapping</a> = {
01916     STANDARD_RIGHTS_READ |
01917         FILE_READ_DATA | FILE_READ_ATTRIBUTES | FILE_READ_EA | SYNCHRONIZE,
01918     STANDARD_RIGHTS_WRITE |
01919         FILE_WRITE_DATA | FILE_WRITE_ATTRIBUTES | FILE_WRITE_EA | FILE_APPEND_DATA | SYNCHRONIZE,
01920     STANDARD_RIGHTS_EXECUTE |
01921         SYNCHRONIZE | FILE_READ_ATTRIBUTES | FILE_EXECUTE,
01922     FILE_ALL_ACCESS
01923 };
01924 
<a name="l01925"></a><a class="code" href="../../d9/d5/ioinit_8c.html#a12">01925</a> GENERIC_MAPPING <a class="code" href="../../d9/d5/ioinit_8c.html#a12">IopCompletionMapping</a> = {
01926     STANDARD_RIGHTS_READ |
01927         IO_COMPLETION_QUERY_STATE,
01928     STANDARD_RIGHTS_WRITE |
01929         IO_COMPLETION_MODIFY_STATE,
01930     STANDARD_RIGHTS_EXECUTE |
01931         SYNCHRONIZE,
01932     IO_COMPLETION_ALL_ACCESS
01933 };
01934 
01935 BOOLEAN
<a name="l01936"></a><a class="code" href="../../d9/d5/ioinit_8c.html#a17">01936</a> <a class="code" href="../../d9/d5/ioinit_8c.html#a17">IopCreateObjectTypes</a>(
01937     VOID
01938     )
01939 
01940 <span class="comment">/*++</span>
01941 <span class="comment"></span>
01942 <span class="comment">Routine Description:</span>
01943 <span class="comment"></span>
01944 <span class="comment">    This routine creates the object types used by the I/O system and its</span>
01945 <span class="comment">    components.  The object types created are:</span>
01946 <span class="comment"></span>
01947 <span class="comment">        Adapter</span>
01948 <span class="comment">        Controller</span>
01949 <span class="comment">        Device</span>
01950 <span class="comment">        Driver</span>
01951 <span class="comment">        File</span>
01952 <span class="comment">        I/O Completion</span>
01953 <span class="comment"></span>
01954 <span class="comment">Arguments:</span>
01955 <span class="comment"></span>
01956 <span class="comment">    None.</span>
01957 <span class="comment"></span>
01958 <span class="comment">Return Value:</span>
01959 <span class="comment"></span>
01960 <span class="comment">    The function value is a BOOLEAN indicating whether or not the object</span>
01961 <span class="comment">    types were successfully created.</span>
01962 <span class="comment"></span>
01963 <span class="comment"></span>
01964 <span class="comment">--*/</span>
01965 
01966 {
01967     <a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html">OBJECT_TYPE_INITIALIZER</a> objectTypeInitializer;
01968     UNICODE_STRING nameString;
01969 
01970     <span class="comment">//</span>
01971     <span class="comment">// Initialize the common fields of the Object Type Initializer record</span>
01972     <span class="comment">//</span>
01973 
01974     RtlZeroMemory( &amp;objectTypeInitializer, <span class="keyword">sizeof</span>( objectTypeInitializer ) );
01975     objectTypeInitializer.Length = <span class="keyword">sizeof</span>( objectTypeInitializer );
01976     objectTypeInitializer.InvalidAttributes = OBJ_OPENLINK;
01977     objectTypeInitializer.GenericMapping = <a class="code" href="../../d9/d5/ioinit_8c.html#a11">IopFileMapping</a>;
01978     objectTypeInitializer.PoolType = <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>;
01979     objectTypeInitializer.ValidAccessMask = FILE_ALL_ACCESS;
01980     objectTypeInitializer.UseDefaultObject = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01981 
01982 
01983     <span class="comment">//</span>
01984     <span class="comment">// Create the object type for adapter objects.</span>
01985     <span class="comment">//</span>
01986 
01987     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;nameString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Adapter"</span> );
01988     <span class="comment">// objectTypeInitializer.DefaultNonPagedPoolCharge = sizeof( struct _ADAPTER_OBJECT );</span>
01989     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>( &amp;nameString,
01990                                       &amp;objectTypeInitializer,
01991                                       (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01992                                       &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a32">IoAdapterObjectType</a> ))) {
01993         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01994     }
01995 
01996 <span class="preprocessor">#ifdef _PNP_POWER_</span>
01997 <span class="preprocessor"></span>
01998     <span class="comment">//</span>
01999     <span class="comment">// Create the object type for device helper objects.</span>
02000     <span class="comment">//</span>
02001 
02002     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;nameString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DeviceHandler"</span> );
02003     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>( &amp;nameString,
02004                                       &amp;objectTypeInitializer,
02005                                       (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02006                                       &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a37">IoDeviceHandlerObjectType</a> ))) {
02007         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02008     }
02009     <a class="code" href="../../d3/d5/iodata_8c.html#a39">IoDeviceHandlerObjectSize</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d3/struct__DEVICE__HANDLER__OBJECT.html">DEVICE_HANDLER_OBJECT</a>);
02010 
02011 <span class="preprocessor">#endif</span>
02012 <span class="preprocessor"></span>
02013     <span class="comment">//</span>
02014     <span class="comment">// Create the object type for controller objects.</span>
02015     <span class="comment">//</span>
02016 
02017     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;nameString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Controller"</span> );
02018     objectTypeInitializer.DefaultNonPagedPoolCharge = <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d8/struct__CONTROLLER__OBJECT.html">CONTROLLER_OBJECT</a> );
02019     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>( &amp;nameString,
02020                                       &amp;objectTypeInitializer,
02021                                       (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02022                                       &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a33">IoControllerObjectType</a> ))) {
02023         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02024     }
02025 
02026     <span class="comment">//</span>
02027     <span class="comment">// Create the object type for device objects.</span>
02028     <span class="comment">//</span>
02029 
02030     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;nameString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Device"</span> );
02031     objectTypeInitializer.DefaultNonPagedPoolCharge = <span class="keyword">sizeof</span>( <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">DEVICE_OBJECT</a> );
02032     objectTypeInitializer.ParseProcedure = <a class="code" href="../../d0/d6/iop_8h.html#a199">IopParseDevice</a>;
02033     objectTypeInitializer.DeleteProcedure = <a class="code" href="../../d0/d6/iop_8h.html#a163">IopDeleteDevice</a>;
02034     objectTypeInitializer.SecurityProcedure = <a class="code" href="../../d0/d6/iop_8h.html#a183">IopGetSetSecurityObject</a>;
02035     objectTypeInitializer.QueryNameProcedure = (<a class="code" href="../../d4/d0/ob_8h.html#a28">OB_QUERYNAME_METHOD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02036     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>( &amp;nameString,
02037                                       &amp;objectTypeInitializer,
02038                                       (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02039                                       &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a35">IoDeviceObjectType</a> ))) {
02040         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02041     }
02042 
02043     <span class="comment">//</span>
02044     <span class="comment">// Create the object type for driver objects.</span>
02045     <span class="comment">//</span>
02046 
02047     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;nameString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Driver"</span> );
02048     objectTypeInitializer.DefaultNonPagedPoolCharge = <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">DRIVER_OBJECT</a> );
02049     objectTypeInitializer.ParseProcedure = (<a class="code" href="../../d4/d0/ob_8h.html#a26">OB_PARSE_METHOD</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02050     objectTypeInitializer.DeleteProcedure = <a class="code" href="../../d0/d6/iop_8h.html#a162">IopDeleteDriver</a>;
02051     objectTypeInitializer.SecurityProcedure = (<a class="code" href="../../d4/d0/ob_8h.html#a27">OB_SECURITY_METHOD</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02052     objectTypeInitializer.QueryNameProcedure = (<a class="code" href="../../d4/d0/ob_8h.html#a28">OB_QUERYNAME_METHOD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02053     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>( &amp;nameString,
02054                                       &amp;objectTypeInitializer,
02055                                       (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02056                                       &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a36">IoDriverObjectType</a> ))) {
02057         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02058     }
02059 
02060     <span class="comment">//</span>
02061     <span class="comment">// Create the object type for I/O completion objects.</span>
02062     <span class="comment">//</span>
02063 
02064     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;nameString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"IoCompletion"</span> );
02065     objectTypeInitializer.DefaultNonPagedPoolCharge = <span class="keyword">sizeof</span>( <a class="code" href="../../d7/d7/struct__KQUEUE.html">KQUEUE</a> );
02066     objectTypeInitializer.InvalidAttributes = OBJ_PERMANENT | OBJ_OPENLINK;
02067     objectTypeInitializer.GenericMapping = <a class="code" href="../../d9/d5/ioinit_8c.html#a12">IopCompletionMapping</a>;
02068     objectTypeInitializer.ValidAccessMask = IO_COMPLETION_ALL_ACCESS;
02069     objectTypeInitializer.DeleteProcedure = <a class="code" href="../../d5/d4/complete_8c.html#a7">IopDeleteIoCompletion</a>;
02070     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>( &amp;nameString,
02071                                       &amp;objectTypeInitializer,
02072                                       (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02073                                       &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a34">IoCompletionObjectType</a> ))) {
02074         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02075     }
02076 
02077     <span class="comment">//</span>
02078     <span class="comment">// Create the object type for file objects.</span>
02079     <span class="comment">//</span>
02080 
02081     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;nameString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"File"</span> );
02082     objectTypeInitializer.DefaultPagedPoolCharge = <a class="code" href="../../d0/d5/io_8h.html#a221">IO_FILE_OBJECT_PAGED_POOL_CHARGE</a>;
02083     objectTypeInitializer.DefaultNonPagedPoolCharge = <a class="code" href="../../d0/d5/io_8h.html#a220">IO_FILE_OBJECT_NON_PAGED_POOL_CHARGE</a> +
02084                                                       <span class="keyword">sizeof</span>( <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">FILE_OBJECT</a> );
02085     objectTypeInitializer.InvalidAttributes = OBJ_PERMANENT | OBJ_EXCLUSIVE | OBJ_OPENLINK;
02086     objectTypeInitializer.GenericMapping = <a class="code" href="../../d9/d5/ioinit_8c.html#a11">IopFileMapping</a>;
02087     objectTypeInitializer.ValidAccessMask = FILE_ALL_ACCESS;
02088     objectTypeInitializer.MaintainHandleCount = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02089     objectTypeInitializer.CloseProcedure = <a class="code" href="../../d0/d6/iop_8h.html#a154">IopCloseFile</a>;
02090     objectTypeInitializer.DeleteProcedure = <a class="code" href="../../d0/d6/iop_8h.html#a164">IopDeleteFile</a>;
02091     objectTypeInitializer.ParseProcedure = <a class="code" href="../../d0/d6/iop_8h.html#a200">IopParseFile</a>;
02092     objectTypeInitializer.SecurityProcedure = <a class="code" href="../../d0/d6/iop_8h.html#a183">IopGetSetSecurityObject</a>;
02093     objectTypeInitializer.QueryNameProcedure = <a class="code" href="../../d0/d6/iop_8h.html#a202">IopQueryName</a>;
02094     objectTypeInitializer.UseDefaultObject = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02095 
02096     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>( &amp;nameString,
02097                                       &amp;objectTypeInitializer,
02098                                       (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02099                                       &amp;<a class="code" href="../../d5/d8/fssup_8c.html#a3">IoFileObjectType</a> ))) {
02100         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02101     }
02102 
02103     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02104 }
02105 
02106 <a class="code" href="../../d9/d5/ioinit_8c.html#a4">PTREE_ENTRY</a>
<a name="l02107"></a><a class="code" href="../../d9/d5/ioinit_8c.html#a18">02107</a> <a class="code" href="../../d9/d5/ioinit_8c.html#a18">IopCreateEntry</a>(
02108     IN PUNICODE_STRING GroupName
02109     )
02110 
02111 <span class="comment">/*++</span>
02112 <span class="comment"></span>
02113 <span class="comment">Routine Description:</span>
02114 <span class="comment"></span>
02115 <span class="comment">    This routine creates an entry for the specified group name suitable for</span>
02116 <span class="comment">    being inserted into the group name tree.</span>
02117 <span class="comment"></span>
02118 <span class="comment">Arguments:</span>
02119 <span class="comment"></span>
02120 <span class="comment">    GroupName - Specifies the name of the group for the entry.</span>
02121 <span class="comment"></span>
02122 <span class="comment">Return Value:</span>
02123 <span class="comment"></span>
02124 <span class="comment">    The function value is a pointer to the created entry.</span>
02125 <span class="comment"></span>
02126 <span class="comment"></span>
02127 <span class="comment">--*/</span>
02128 
02129 {
02130     <a class="code" href="../../d9/d5/ioinit_8c.html#a4">PTREE_ENTRY</a> treeEntry;
02131 
02132     <span class="comment">//</span>
02133     <span class="comment">// Allocate and initialize an entry suitable for placing into the group</span>
02134     <span class="comment">// name tree.</span>
02135     <span class="comment">//</span>
02136 
02137     treeEntry = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
02138                                 <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d2/struct__TREE__ENTRY.html">TREE_ENTRY</a> ) + GroupName-&gt;Length );
02139     <span class="keywordflow">if</span> (!treeEntry) {
02140         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
02141     }
02142 
02143     RtlZeroMemory( treeEntry, <span class="keyword">sizeof</span>( <a class="code" href="../../d9/d5/ioinit_8c.html#a3">TREE_ENTRY</a> ) );
02144     treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o5">GroupName</a>.Length = GroupName-&gt;Length;
02145     treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o5">GroupName</a>.MaximumLength = GroupName-&gt;Length;
02146     treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o5">GroupName</a>.Buffer = (PWCHAR) (treeEntry + 1);
02147     RtlCopyMemory( treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o5">GroupName</a>.Buffer,
02148                    GroupName-&gt;Buffer,
02149                    GroupName-&gt;Length );
02150 
02151     <span class="keywordflow">return</span> treeEntry;
02152 }
02153 
02154 BOOLEAN
<a name="l02155"></a><a class="code" href="../../d9/d5/ioinit_8c.html#a19">02155</a> <a class="code" href="../../d9/d5/ioinit_8c.html#a19">IopCreateRootDirectories</a>(
02156     VOID
02157     )
02158 
02159 <span class="comment">/*++</span>
02160 <span class="comment"></span>
02161 <span class="comment">Routine Description:</span>
02162 <span class="comment"></span>
02163 <span class="comment">    This routine is invoked to create the object manager directory objects</span>
02164 <span class="comment">    to contain the various device and file system driver objects.</span>
02165 <span class="comment"></span>
02166 <span class="comment">Arguments:</span>
02167 <span class="comment"></span>
02168 <span class="comment">    None.</span>
02169 <span class="comment"></span>
02170 <span class="comment">Return Value:</span>
02171 <span class="comment"></span>
02172 <span class="comment">    The function value is a BOOLEAN indicating whether or not the directory</span>
02173 <span class="comment">    objects were successfully created.</span>
02174 <span class="comment"></span>
02175 <span class="comment"></span>
02176 <span class="comment">--*/</span>
02177 
02178 {
02179     HANDLE handle;
02180     OBJECT_ATTRIBUTES objectAttributes;
02181     UNICODE_STRING nameString;
02182     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02183 
02184     <span class="comment">//</span>
02185     <span class="comment">// Create the root directory object for the \Driver directory.</span>
02186     <span class="comment">//</span>
02187 
02188     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;nameString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Driver"</span> );
02189     InitializeObjectAttributes( &amp;objectAttributes,
02190                                 &amp;nameString,
02191                                 OBJ_PERMANENT,
02192                                 (HANDLE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02193                                 (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
02194 
02195     status = <a class="code" href="../../d8/d0/obdir_8c.html#a0">NtCreateDirectoryObject</a>( &amp;handle,
02196                                       DIRECTORY_ALL_ACCESS,
02197                                       &amp;objectAttributes );
02198     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02199         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02200     } <span class="keywordflow">else</span> {
02201         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
02202     }
02203 
02204     <span class="comment">//</span>
02205     <span class="comment">// Create the root directory object for the \FileSystem directory.</span>
02206     <span class="comment">//</span>
02207 
02208     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;nameString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\FileSystem"</span> );
02209 
02210     status = <a class="code" href="../../d8/d0/obdir_8c.html#a0">NtCreateDirectoryObject</a>( &amp;handle,
02211                                       DIRECTORY_ALL_ACCESS,
02212                                       &amp;objectAttributes );
02213     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02214         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02215     } <span class="keywordflow">else</span> {
02216         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
02217     }
02218 
02219     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02220 }
02221 
02222 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02223"></a><a class="code" href="../../d9/d5/ioinit_8c.html#a38">02223</a> <a class="code" href="../../d9/d5/ioinit_8c.html#a38">IopFreeGroupTree</a>(
02224     PTREE_ENTRY TreeEntry
02225     )
02226 
02227 <span class="comment">/*++</span>
02228 <span class="comment"></span>
02229 <span class="comment">Routine Description:</span>
02230 <span class="comment"></span>
02231 <span class="comment">    This routine is invoked to free a node from the group dependency tree.</span>
02232 <span class="comment">    It is invoked the first time with the root of the tree, and thereafter</span>
02233 <span class="comment">    recursively to walk the tree and remove the nodes.</span>
02234 <span class="comment"></span>
02235 <span class="comment">Arguments:</span>
02236 <span class="comment"></span>
02237 <span class="comment">    TreeEntry - Supplies a pointer to the node to be freed.</span>
02238 <span class="comment"></span>
02239 <span class="comment">Return Value:</span>
02240 <span class="comment"></span>
02241 <span class="comment">    None.</span>
02242 <span class="comment"></span>
02243 <span class="comment">--*/</span>
02244 
02245 {
02246     <span class="comment">//</span>
02247     <span class="comment">// Simply walk the tree in ascending order from the bottom up and free</span>
02248     <span class="comment">// each node along the way.</span>
02249     <span class="comment">//</span>
02250 
02251     <span class="keywordflow">if</span> (TreeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o0">Left</a>) {
02252         <a class="code" href="../../d9/d5/ioinit_8c.html#a38">IopFreeGroupTree</a>( TreeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o0">Left</a> );
02253     }
02254 
02255     <span class="keywordflow">if</span> (TreeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o2">Sibling</a>) {
02256         <a class="code" href="../../d9/d5/ioinit_8c.html#a38">IopFreeGroupTree</a>( TreeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o2">Sibling</a> );
02257     }
02258 
02259     <span class="keywordflow">if</span> (TreeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o1">Right</a>) {
02260         <a class="code" href="../../d9/d5/ioinit_8c.html#a38">IopFreeGroupTree</a>( TreeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o1">Right</a> );
02261     }
02262 
02263     <span class="comment">//</span>
02264     <span class="comment">// All of the children and siblings for this node have been freed, so</span>
02265     <span class="comment">// now free this node as well.</span>
02266     <span class="comment">//</span>
02267 
02268     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( TreeEntry );
02269 }
02270 
02271 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02272"></a><a class="code" href="../../d9/d5/ioinit_8c.html#a21">02272</a> <a class="code" href="../../d9/d5/ioinit_8c.html#a21">IopInitializeAttributesAndCreateObject</a>(
02273     IN PUNICODE_STRING ObjectName,
02274     IN OUT POBJECT_ATTRIBUTES ObjectAttributes,
02275     OUT <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> *DriverObject
02276     )
02277 
02278 <span class="comment">/*++</span>
02279 <span class="comment"></span>
02280 <span class="comment">Routine Description:</span>
02281 <span class="comment"></span>
02282 <span class="comment">    This routine is invoked to initialize a set of object attributes and</span>
02283 <span class="comment">    to create a driver object.</span>
02284 <span class="comment"></span>
02285 <span class="comment">Arguments:</span>
02286 <span class="comment"></span>
02287 <span class="comment">    ObjectName - Supplies the name of the driver object.</span>
02288 <span class="comment"></span>
02289 <span class="comment">    ObjectAttributes - Supplies a pointer to the object attributes structure</span>
02290 <span class="comment">        to be initialized.</span>
02291 <span class="comment"></span>
02292 <span class="comment">    DriverObject - Supplies a variable to receive a pointer to the resultant</span>
02293 <span class="comment">        created driver object.</span>
02294 <span class="comment"></span>
02295 <span class="comment">Return Value:</span>
02296 <span class="comment"></span>
02297 <span class="comment">    The function value is the final status of the operation.</span>
02298 <span class="comment"></span>
02299 <span class="comment">--*/</span>
02300 
02301 {
02302     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02303 
02304     <span class="comment">//</span>
02305     <span class="comment">// Simply initialize the object attributes and create the driver object.</span>
02306     <span class="comment">//</span>
02307 
02308     InitializeObjectAttributes( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
02309                                 ObjectName,
02310                                 OBJ_PERMANENT | OBJ_CASE_INSENSITIVE,
02311                                 (HANDLE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02312                                 (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
02313 
02314     status = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>( KeGetPreviousMode(),
02315                              <a class="code" href="../../d3/d5/iodata_8c.html#a36">IoDriverObjectType</a>,
02316                              <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
02317                              <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
02318                              (PVOID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02319                              (ULONG) (<span class="keyword">sizeof</span>( <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">DRIVER_OBJECT</a> ) + <span class="keyword">sizeof</span> ( <a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html">DRIVER_EXTENSION</a> )),
02320                              0,
02321                              0,
02322                              (PVOID *)DriverObject );
02323     <span class="keywordflow">return</span> status;
02324 }
02325 
02326 BOOLEAN
<a name="l02327"></a><a class="code" href="../../d9/d5/ioinit_8c.html#a22">02327</a> <a class="code" href="../../d9/d5/ioinit_8c.html#a22">IopInitializeBootDrivers</a>(
02328     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock,
02329     OUT <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> *PreviousDriver
02330     )
02331 
02332 <span class="comment">/*++</span>
02333 <span class="comment"></span>
02334 <span class="comment">Routine Description:</span>
02335 <span class="comment"></span>
02336 <span class="comment">    This routine is invoked to initialize the boot drivers that were loaded</span>
02337 <span class="comment">    by the OS Loader.  The list of drivers is provided as part of the loader</span>
02338 <span class="comment">    parameter block.</span>
02339 <span class="comment"></span>
02340 <span class="comment">Arguments:</span>
02341 <span class="comment"></span>
02342 <span class="comment">    LoaderBlock - Supplies a pointer to the loader parameter block, created</span>
02343 <span class="comment">        by the OS Loader.</span>
02344 <span class="comment"></span>
02345 <span class="comment">    Previous Driver - Supplies a variable to receive the address of the</span>
02346 <span class="comment">        driver object chain created by initializing the drivers.</span>
02347 <span class="comment"></span>
02348 <span class="comment">Return Value:</span>
02349 <span class="comment"></span>
02350 <span class="comment">    The function value is a BOOLEAN indicating whether or not the boot</span>
02351 <span class="comment">    drivers were successfully initialized.</span>
02352 <span class="comment"></span>
02353 <span class="comment">--*/</span>
02354 
02355 {
02356     UNICODE_STRING completeName;
02357     UNICODE_STRING rawFsName;
02358     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02359     PLIST_ENTRY nextEntry;
02360     PLIST_ENTRY entry;
02361     <a class="code" href="../../d5/d3/struct__REINIT__PACKET.html">PREINIT_PACKET</a> reinitEntry;
02362     <a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html">PBOOT_DRIVER_LIST_ENTRY</a> bootDriver;
02363     HANDLE keyHandle;
02364     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
02365     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
02366     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> i, j;
02367     PLDR_DATA_TABLE_ENTRY driverEntry;
02368     PLDR_DATA_TABLE_ENTRY dllEntry;
02369     UNICODE_STRING groupName;
02370     <a class="code" href="../../d9/d5/ioinit_8c.html#a4">PTREE_ENTRY</a> treeEntry;
02371     <a class="code" href="../../d9/d5/ioinit_8c.html#a6">PDRIVER_INFORMATION</a> driverInfo;
02372     <a class="code" href="../../d0/d6/struct__START__CONTEXT.html">START_CONTEXT</a> startContext;
02373     BOOLEAN moreProcessing;
02374     BOOLEAN newDevice;
02375     BOOLEAN textModeSetup = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02376     BOOLEAN bootReinitDriversFound;
02377     BOOLEAN bootConfigsOK;
02378 
02379     UNREFERENCED_PARAMETER( PreviousDriver );
02380 
02381     <span class="comment">//</span>
02382     <span class="comment">// Initialize the built-in RAW file system driver.</span>
02383     <span class="comment">//</span>
02384 
02385     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;rawFsName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\FileSystem\\RAW"</span> );
02386     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;completeName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span> );
02387     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d5/ioinit_8c.html#a23">IopInitializeBuiltinDriver</a>( &amp;rawFsName,
02388                                      &amp;completeName,
02389                                      <a class="code" href="../../d9/d5/ioinit_8c.html#a14">RawInitialize</a>,
02390                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02391                                      textModeSetup )) {
02392 <span class="preprocessor">#if DBG</span>
02393 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IOINIT: Failed to initialize RAW filsystem \n"</span> );
02394 
02395 <span class="preprocessor">#endif</span>
02396 <span class="preprocessor"></span>
02397         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02398     }
02399 
02400     <span class="comment">//</span>
02401     <span class="comment">// Determine number of group orders and build a list_entry array to link all the drivers</span>
02402     <span class="comment">// together based on their groups.</span>
02403     <span class="comment">//</span>
02404 
02405     <a class="code" href="../../d9/d5/ioinit_8c.html#a9">IopGroupIndex</a> = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a33">IopGetGroupOrderIndex</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02406     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/ioinit_8c.html#a9">IopGroupIndex</a> == <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>) {
02407         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02408     }
02409 
02410     <a class="code" href="../../d9/d5/ioinit_8c.html#a10">IopGroupTable</a> = (PLIST_ENTRY) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="code" href="../../d9/d5/ioinit_8c.html#a9">IopGroupIndex</a> * <span class="keyword">sizeof</span> (LIST_ENTRY));
02411     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/ioinit_8c.html#a10">IopGroupTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02412         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02413     }
02414     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d9/d5/ioinit_8c.html#a9">IopGroupIndex</a>; i++) {
02415         InitializeListHead(&amp;<a class="code" href="../../d9/d5/ioinit_8c.html#a10">IopGroupTable</a>[i]);
02416     }
02417 
02418     <a class="code" href="../../d1/d0/pnpdata_8c.html#a24">PnpAsyncOk</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02419 
02420     <span class="comment">//</span>
02421     <span class="comment">// Call DllInitialize for driver dependent DLLs.</span>
02422     <span class="comment">//</span>
02423 
02424     nextEntry = LoaderBlock-&gt;LoadOrderListHead.Flink;
02425     <span class="keywordflow">while</span> (nextEntry != &amp;LoaderBlock-&gt;LoadOrderListHead) {
02426         dllEntry = CONTAINING_RECORD(nextEntry, LDR_DATA_TABLE_ENTRY, InLoadOrderLinks);
02427         <span class="keywordflow">if</span> (dllEntry-&gt;Flags &amp; LDRP_DRIVER_DEPENDENT_DLL) {
02428             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d8/d8/sysload_8c.html#a67">MmCallDllInitialize</a>(dllEntry);
02429         }
02430         nextEntry = nextEntry-&gt;Flink;
02431     }
02432     <span class="comment">//</span>
02433     <span class="comment">// Allocate pool to store driver's start information.</span>
02434     <span class="comment">// All the driver info records with the same group value will be linked into a list.</span>
02435     <span class="comment">//</span>
02436 
02437     nextEntry = LoaderBlock-&gt;BootDriverListHead.Flink;
02438     <span class="keywordflow">while</span> (nextEntry != &amp;LoaderBlock-&gt;BootDriverListHead) {
02439         bootDriver = CONTAINING_RECORD( nextEntry,
02440                                         <a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html">BOOT_DRIVER_LIST_ENTRY</a>,
02441                                         Link );
02442         driverEntry = bootDriver-&gt;<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o3">LdrEntry</a>;
02443         driverInfo = (<a class="code" href="../../d9/d5/ioinit_8c.html#a6">PDRIVER_INFORMATION</a>) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
02444                         <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html">DRIVER_INFORMATION</a>));
02445         <span class="keywordflow">if</span> (driverInfo) {
02446             RtlZeroMemory(driverInfo, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d5/ioinit_8c.html#a5">DRIVER_INFORMATION</a>));
02447             InitializeListHead(&amp;driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o0">Link</a>);
02448             driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o2">DataTableEntry</a> = bootDriver;
02449 
02450             <span class="comment">//</span>
02451             <span class="comment">// Open the driver's registry key to find out if this is a</span>
02452             <span class="comment">// filesystem or a driver.</span>
02453             <span class="comment">//</span>
02454 
02455             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;keyHandle,
02456                                            (HANDLE)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02457                                            &amp;bootDriver-&gt;<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o2">RegistryPath</a>,
02458                                            KEY_READ
02459                                            );
02460             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02461                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(driverInfo);
02462             } <span class="keywordflow">else</span> {
02463                 driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o3">ServiceHandle</a> = keyHandle;
02464                 j = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a33">IopGetGroupOrderIndex</a>(keyHandle);
02465                 <span class="keywordflow">if</span> (j == <a class="code" href="../../d9/d0/pnpiop_8h.html#a55">SETUP_RESERVED_GROUP</a>) {
02466 
02467                     textModeSetup = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02468 
02469                     <span class="comment">//</span>
02470                     <span class="comment">// Special handling for setupdd.sys</span>
02471                     <span class="comment">//</span>
02472 
02473                     status = <a class="code" href="../../d0/d6/iop_8h.html#a175">IopGetDriverNameFromKeyNode</a>( keyHandle,
02474                                                           &amp;completeName );
02475                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02476                         driverObject = <a class="code" href="../../d9/d5/ioinit_8c.html#a23">IopInitializeBuiltinDriver</a>(
02477                                            &amp;completeName,
02478                                            &amp;bootDriver-&gt;<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o2">RegistryPath</a>,
02479                                            (<a class="code" href="../../d0/d5/io_8h.html#a284">PDRIVER_INITIALIZE</a>) driverEntry-&gt;EntryPoint,
02480                                            driverEntry,
02481                                            textModeSetup );
02482                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( completeName.Buffer );
02483                         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(keyHandle);
02484                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(driverInfo);
02485                         <span class="keywordflow">if</span> (driverObject) {
02486 
02487                             <span class="comment">//</span>
02488                             <span class="comment">// Once we successfully initialized the setupdd.sys, we are ready</span>
02489                             <span class="comment">// to notify it all the root enumerated devices.</span>
02490                             <span class="comment">//</span>
02491 
02492                             <a class="code" href="../../d9/d5/ioinit_8c.html#a32">IopNotifySetupDevices</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>);
02493                         } <span class="keywordflow">else</span> {
02494                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d9/d5/ioinit_8c.html#a10">IopGroupTable</a>);
02495                             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02496                         }
02497                     }
02498 
02499                 } <span class="keywordflow">else</span> {
02500                     driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o4">TagPosition</a> = <a class="code" href="../../d9/d5/ioinit_8c.html#a30">IopGetDriverTagPriority</a>(keyHandle);
02501                     <a class="code" href="../../d9/d5/ioinit_8c.html#a31">IopInsertDriverList</a>(&amp;<a class="code" href="../../d9/d5/ioinit_8c.html#a10">IopGroupTable</a>[j], driverInfo);
02502                 }
02503             }
02504         }
02505         nextEntry = nextEntry-&gt;Flink;
02506     }
02507 
02508     <span class="comment">//</span>
02509     <span class="comment">// Process each driver base on its group.  The group with lower index number (higher</span>
02510     <span class="comment">// priority) is processed first.</span>
02511     <span class="comment">//</span>
02512 
02513     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d9/d5/ioinit_8c.html#a9">IopGroupIndex</a>; i++) {
02514         nextEntry = <a class="code" href="../../d9/d5/ioinit_8c.html#a10">IopGroupTable</a>[i].Flink;
02515         <span class="keywordflow">while</span> (nextEntry != &amp;<a class="code" href="../../d9/d5/ioinit_8c.html#a10">IopGroupTable</a>[i]) {
02516 
02517             driverInfo = CONTAINING_RECORD(nextEntry, <a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html">DRIVER_INFORMATION</a>, Link);
02518             keyHandle = driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o3">ServiceHandle</a>;
02519             bootDriver = driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o2">DataTableEntry</a>;
02520             driverEntry = bootDriver-&gt;<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o3">LdrEntry</a>;
02521             driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o6">Processed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02522 
02523             <span class="comment">//</span>
02524             <span class="comment">// call the driver's driver entry</span>
02525             <span class="comment">//</span>
02526             <span class="comment">// See if this driver has an ObjectName value.  If so, this value</span>
02527             <span class="comment">// overrides the default ("\Driver" or "\FileSystem").</span>
02528             <span class="comment">//</span>
02529 
02530             status = <a class="code" href="../../d0/d6/iop_8h.html#a175">IopGetDriverNameFromKeyNode</a>( keyHandle,
02531                                                   &amp;completeName );
02532             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02533 
02534 <span class="preprocessor">#if DBG</span>
02535 <span class="preprocessor"></span>                <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IOINIT: Could not get driver name for %wZ\n"</span>,
02536                           &amp;bootDriver-&gt;<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o2">RegistryPath</a> );
02537 <span class="preprocessor">#endif // DBG</span>
02538 <span class="preprocessor"></span>
02539                 driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o5">Failed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02540             } <span class="keywordflow">else</span> {
02541 
02542                 status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( keyHandle,
02543                                               <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Group"</span>,
02544                                               &amp;keyValueInformation );
02545                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02546 
02547                     <span class="keywordflow">if</span> (keyValueInformation-&gt;DataLength) {
02548                         groupName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) keyValueInformation-&gt;DataLength;
02549                         groupName.MaximumLength = groupName.Length;
02550                         groupName.Buffer = (PWSTR) ((PUCHAR) keyValueInformation + keyValueInformation-&gt;DataOffset);
02551                         treeEntry = <a class="code" href="../../d9/d5/ioinit_8c.html#a26">IopLookupGroupName</a>( &amp;groupName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
02552                     } <span class="keywordflow">else</span> {
02553                         treeEntry = (<a class="code" href="../../d9/d5/ioinit_8c.html#a4">PTREE_ENTRY</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02554                     }
02555                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
02556                 } <span class="keywordflow">else</span> {
02557                     treeEntry = (<a class="code" href="../../d9/d5/ioinit_8c.html#a4">PTREE_ENTRY</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02558                 }
02559 
02560                 <span class="comment">//</span>
02561                 <span class="comment">// Check if this bus has a BOOT config.</span>
02562                 <span class="comment">// Buses with BOOT configs allow assignment of BOOT configs on their level.</span>
02563                 <span class="comment">//</span>
02564 
02565                 bootConfigsOK = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02566                 status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( keyHandle,
02567                                               <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"HasBootConfig"</span>,
02568                                               &amp;keyValueInformation );
02569                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02570                     <span class="keywordflow">if</span> (*(PULONG)((PUCHAR)keyValueInformation + keyValueInformation-&gt;DataOffset) == 0) {
02571                         bootConfigsOK = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02572                     }
02573                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
02574                 }
02575 
02576                 driverObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02577                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/ioinit_8c.html#a15">IopCheckDependencies</a>( keyHandle )) {
02578                     <span class="comment">//</span>
02579                     <span class="comment">// The driver may already be initialized by IopInitializeBootFilterDriver</span>
02580                     <span class="comment">// if it is boot filter driver.</span>
02581                     <span class="comment">// If not, initialize it.</span>
02582                     <span class="comment">//</span>
02583 
02584                     driverObject = driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o1">DriverObject</a>;
02585                     <span class="keywordflow">if</span> (driverObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02586                         driverObject = <a class="code" href="../../d9/d5/ioinit_8c.html#a23">IopInitializeBuiltinDriver</a>(
02587                                            &amp;completeName,
02588                                            &amp;bootDriver-&gt;<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o2">RegistryPath</a>,
02589                                            (<a class="code" href="../../d0/d5/io_8h.html#a284">PDRIVER_INITIALIZE</a>) driverEntry-&gt;EntryPoint,
02590                                            driverEntry,
02591                                            textModeSetup);
02592                         <span class="comment">//</span>
02593                         <span class="comment">// Pnp might unload the driver before we get a chance to look at this. So take an extra</span>
02594                         <span class="comment">// reference.</span>
02595                         <span class="comment">//</span>
02596                         <span class="keywordflow">if</span> (driverObject) {
02597                             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(driverObject);
02598                         }
02599                     }
02600                 }
02601                 <span class="keywordflow">if</span> (driverObject) {
02602                     <span class="keywordflow">if</span> (treeEntry) {
02603                         treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o4">DriversLoaded</a>++;
02604                     }
02605                     driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o1">DriverObject</a> = driverObject;
02606 
02607                 } <span class="keywordflow">else</span> {
02608                     driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o5">Failed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02609                 }
02610                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( completeName.Buffer );
02611             }
02612             <span class="keywordflow">if</span> (!driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o5">Failed</a>) {
02613 
02614                 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> group;
02615 
02616                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a260">IopAddDevicesToBootDriver</a>(driverObject);
02617 
02618                 <span class="comment">//</span>
02619                 <span class="comment">// Scan the hardware tree looking for devices which need</span>
02620                 <span class="comment">// resources or starting.</span>
02621                 <span class="comment">//</span>
02622 
02623                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a305">IopRequestDeviceAction</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a220">ReenumerateBootDevices</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, (PNTSTATUS)&amp;bootConfigsOK);
02624 
02625             }
02626 
02627             <span class="comment">//</span>
02628             <span class="comment">// Before processing next boot driver, wait for IoRequestDeviceRemoval complete.</span>
02629             <span class="comment">// The driver to be processed may need the resources being released by</span>
02630             <span class="comment">// IoRequestDeviceRemoval.  (For drivers report detected BOOT device if they fail to</span>
02631             <span class="comment">// get the resources in their DriverEntry.  They will fail and we will bugcheck with</span>
02632             <span class="comment">// inaccessible boot device.)</span>
02633             <span class="comment">//</span>
02634 
02635             <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d5/ioinit_8c.html#a34">IopWaitForBootDevicesDeleted</a>()) {
02636                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02637             }
02638 
02639             nextEntry = nextEntry-&gt;Flink;
02640         }
02641 
02642         <span class="comment">//</span>
02643         <span class="comment">// If we are done with Bus driver group, then it's time to reserved the Hal resources</span>
02644         <span class="comment">// and reserve boot resources</span>
02645         <span class="comment">//</span>
02646 
02647         <span class="keywordflow">if</span> (i == <a class="code" href="../../d9/d0/pnpiop_8h.html#a56">BUS_DRIVER_GROUP</a>) {
02648             <span class="keywordflow">if</span> (textModeSetup == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02649                 <span class="comment">//</span>
02650                 <span class="comment">// BUGBUG - There problems with Async ops, disable for now.</span>
02651                 <span class="comment">//</span>
02652                 <span class="comment">// PnpAsyncOk = TRUE;</span>
02653             }
02654 
02655             <span class="comment">//</span>
02656             <span class="comment">// Reserve BOOT configs on Internal bus 0.</span>
02657             <span class="comment">//</span>
02658 
02659             <a class="code" href="../../d5/d1/pnpres_8c.html#a110">IopReserveLegacyBootResources</a>(Internal, 0);
02660             <a class="code" href="../../d1/d0/pnpdata_8c.html#a20">IopReserveResourcesRoutine</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a335">IopAllocateBootResources</a>;
02661             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a2">IopInitHalResources</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02662             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a4">IopInitReservedResourceList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02663             <a class="code" href="../../d1/d0/pnpdata_8c.html#a18">IopBootConfigsReserved</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02664 
02665         }
02666     }
02667 
02668     <span class="comment">//</span>
02669     <span class="comment">// If we started a network boot driver, then imitate what DHCP does</span>
02670     <span class="comment">// in sending IOCTLs.</span>
02671     <span class="comment">//</span>
02672 
02673     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/io_8h.html#a399">IoRemoteBootClient</a>) {
02674         status = <a class="code" href="../../d4/d6/netboot_8c.html#a13">IopStartTcpIpForRemoteBoot</a>(LoaderBlock);
02675         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02676             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( NETWORK_BOOT_INITIALIZATION_FAILED,
02677                           3,
02678                           status,
02679                           0,
02680                           0 );
02681         }
02682     }
02683 
02684     <span class="comment">//</span>
02685     <span class="comment">// Scan the hardware tree looking for devices which need</span>
02686     <span class="comment">// resources or starting.</span>
02687     <span class="comment">//</span>
02688     <a class="code" href="../../d1/d0/pnpdata_8c.html#a17">PnPBootDriversLoaded</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02689     <a class="code" href="../../d1/d0/pnpdata_8c.html#a19">IopResourcesReleased</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02690 
02691     <a class="code" href="../../d9/d0/pnpiop_8h.html#a305">IopRequestDeviceAction</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a221">RestartEnumeration</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02692 
02693     <span class="comment">//</span>
02694     <span class="comment">// If start irps are handled asynchronously, we need to make sure all the boot devices</span>
02695     <span class="comment">// started before continue.</span>
02696     <span class="comment">//</span>
02697 
02698     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d5/ioinit_8c.html#a33">IopWaitForBootDevicesStarted</a>()) {
02699         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02700     }
02701 
02702     bootReinitDriversFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02703 
02704     <span class="keywordflow">while</span> (entry = <a class="code" href="../../d5/d8/ex_8h.html#a239">ExInterlockedRemoveHeadList</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a10">IopBootDriverReinitializeQueueHead</a>, &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a3">IopDatabaseLock</a> )) {
02705         bootReinitDriversFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02706         reinitEntry = CONTAINING_RECORD( entry, <a class="code" href="../../d5/d3/struct__REINIT__PACKET.html">REINIT_PACKET</a>, ListEntry );
02707         reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o2">Count</a>++;
02708         reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> &amp;= ~<a class="code" href="../../d0/d5/io_8h.html#a148">DRVO_BOOTREINIT_REGISTERED</a>;
02709         reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o2">DriverReinitializationRoutine</a>( reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>,
02710                                                     reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o3">Context</a>,
02711                                                     reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o2">Count</a> );
02712         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( reinitEntry );
02713     }
02714 
02715     <span class="comment">//</span>
02716     <span class="comment">// If there were any drivers that registered for boot reinitialization, then</span>
02717     <span class="comment">// we need to wait one more time to make sure we catch any additional</span>
02718     <span class="comment">// devices that were created in response to the reinitialization callback.</span>
02719     <span class="comment">//</span>
02720 
02721     <span class="keywordflow">if</span> (bootReinitDriversFound &amp;&amp; !<a class="code" href="../../d9/d5/ioinit_8c.html#a33">IopWaitForBootDevicesStarted</a>()) {
02722         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02723     }
02724 
02725     <span class="comment">//</span>
02726     <span class="comment">// Link NT device names to ARC names now that all of the boot drivers</span>
02727     <span class="comment">// have intialized.</span>
02728     <span class="comment">//</span>
02729 
02730     <a class="code" href="../../d9/d5/ioinit_8c.html#a16">IopCreateArcNames</a>( LoaderBlock );
02731 
02732     <span class="comment">//</span>
02733     <span class="comment">// Find and mark the boot partition device object so that if a subsequent</span>
02734     <span class="comment">// access or mount of the device during initialization occurs, an more</span>
02735     <span class="comment">// bugcheck can be produced that helps the user understand why the system</span>
02736     <span class="comment">// is failing to boot and run properly.  This occurs when either one of the</span>
02737     <span class="comment">// device drivers or the file system fails to load, or when the file system</span>
02738     <span class="comment">// cannot mount the device for some other reason.</span>
02739     <span class="comment">//</span>
02740 
02741     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d5/ioinit_8c.html#a27">IopMarkBootPartition</a>( LoaderBlock )) {
02742         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02743     }
02744 
02745     <span class="comment">//</span>
02746     <span class="comment">// BUGBUG - There problems with Async ops, disable for now.</span>
02747     <span class="comment">//</span>
02748     <span class="comment">// PnpAsyncOk = TRUE;</span>
02749     <a class="code" href="../../d1/d0/pnpdata_8c.html#a16">PnPBootDriversInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02750 
02751     <span class="comment">//</span>
02752     <span class="comment">// Go thru every driver that we initialized.  If it supports AddDevice entry and</span>
02753     <span class="comment">// did not create any device object after we start it.  We mark it as failure so</span>
02754     <span class="comment">// text mode setup knows this driver is not needed.</span>
02755     <span class="comment">//</span>
02756 
02757     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d9/d5/ioinit_8c.html#a9">IopGroupIndex</a>; i++) {
02758         <span class="keywordflow">while</span> (IsListEmpty(&amp;<a class="code" href="../../d9/d5/ioinit_8c.html#a10">IopGroupTable</a>[i]) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02759 
02760             BOOLEAN failed;
02761 
02762             nextEntry = RemoveHeadList(&amp;<a class="code" href="../../d9/d5/ioinit_8c.html#a10">IopGroupTable</a>[i]);
02763             driverInfo = CONTAINING_RECORD(nextEntry, <a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html">DRIVER_INFORMATION</a>, Link);
02764             driverObject = driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o1">DriverObject</a>;
02765 
02766             <span class="keywordflow">if</span> (textModeSetup                    &amp;&amp;
02767                 (driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o5">Failed</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)    &amp;&amp;
02768                 !<a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a32">IopIsLegacyDriver</a>(driverObject) &amp;&amp;
02769                 (driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o2">DeviceObject</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
02770                 !(driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a146">DRVO_REINIT_REGISTERED</a>)) {
02771 
02772                 <span class="comment">//</span>
02773                 <span class="comment">// If failed is not set and it's not a legacy driver and it has no device object</span>
02774                 <span class="comment">// tread it as failure case.</span>
02775                 <span class="comment">//</span>
02776 
02777                 driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o5">Failed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02778 
02779                 <span class="keywordflow">if</span> (!(driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a143">DRVO_UNLOAD_INVOKED</a>)) {
02780                     driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a143">DRVO_UNLOAD_INVOKED</a>;
02781                     <span class="keywordflow">if</span> (driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o13">DriverUnload</a>) {
02782                         driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o13">DriverUnload</a>(driverObject);
02783                     }
02784                     <a class="code" href="../../d5/d0/obclose_8c.html#a3">ObMakeTemporaryObject</a>( driverObject );  <span class="comment">// Reference taken while inserting into the object table.</span>
02785                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(driverObject);      <span class="comment">// Reference taken when getting driver object pointer.</span>
02786                 }
02787             }
02788             <span class="keywordflow">if</span> (driverObject) {
02789                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(driverObject);          <span class="comment">// Reference taken specifically for text mode setup.</span>
02790             }
02791 
02792             <span class="keywordflow">if</span> (driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o5">Failed</a>) {
02793                 driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o2">DataTableEntry</a>-&gt;<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o3">LdrEntry</a>-&gt;Flags |= LDRP_FAILED_BUILTIN_LOAD;
02794             }
02795             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o3">ServiceHandle</a>);
02796             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(driverInfo);
02797         }
02798     }
02799 
02800     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d9/d5/ioinit_8c.html#a10">IopGroupTable</a>);
02801 
02802     <span class="comment">//</span>
02803     <span class="comment">// Initialize the drivers necessary to dump all of physical memory to the</span>
02804     <span class="comment">// disk if the system is configured to do so.</span>
02805     <span class="comment">//</span>
02806 
02807 
02808     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02809 }
02810 
02811 <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>
<a name="l02812"></a><a class="code" href="../../d9/d5/ioinit_8c.html#a23">02812</a> <a class="code" href="../../d9/d5/ioinit_8c.html#a23">IopInitializeBuiltinDriver</a>(
02813     IN PUNICODE_STRING DriverName,
02814     IN PUNICODE_STRING RegistryPath,
02815     IN PDRIVER_INITIALIZE DriverInitializeRoutine,
02816     IN PLDR_DATA_TABLE_ENTRY DriverEntry,
02817     IN BOOLEAN TextModeSetup
02818     )
02819 
02820 <span class="comment">/*++</span>
02821 <span class="comment"></span>
02822 <span class="comment">Routine Description:</span>
02823 <span class="comment"></span>
02824 <span class="comment">    This routine is invoked to initialize a built-in driver.</span>
02825 <span class="comment"></span>
02826 <span class="comment">Arguments:</span>
02827 <span class="comment"></span>
02828 <span class="comment">    DriverName - Specifies the name to be used in creating the driver object.</span>
02829 <span class="comment"></span>
02830 <span class="comment">    RegistryPath - Specifies the path to be used by the driver to get to</span>
02831 <span class="comment">        the registry.</span>
02832 <span class="comment"></span>
02833 <span class="comment">    DriverInitializeRoutine - Specifies the initialization entry point of</span>
02834 <span class="comment">        the built-in driver.</span>
02835 <span class="comment"></span>
02836 <span class="comment">    DriverEntry - Specifies the driver data table entry to determine if the</span>
02837 <span class="comment">        driver is a wdm driver.</span>
02838 <span class="comment"></span>
02839 <span class="comment">    TextModeSetup - Specifies if this is TextMode setup boot.</span>
02840 <span class="comment"></span>
02841 <span class="comment">Return Value:</span>
02842 <span class="comment"></span>
02843 <span class="comment">    The function returns a pointer to a DRIVER_OBJECT if the built-in</span>
02844 <span class="comment">    driver successfully initialized.  Otherwise, a value of NULL is returned.</span>
02845 <span class="comment"></span>
02846 <span class="comment">--*/</span>
02847 
02848 {
02849     HANDLE handle;
02850     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
02851     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> tmpDriverObject;
02852     OBJECT_ATTRIBUTES objectAttributes;
02853     PWSTR buffer;
02854     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02855     HANDLE serviceHandle;
02856     PWSTR pserviceName;
02857     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> serviceNameLength;
02858     <a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html">PDRIVER_EXTENSION</a> driverExtension;
02859     PIMAGE_NT_HEADERS ntHeaders;
02860     PVOID imageBase;
02861 <span class="preprocessor">#if DBG</span>
02862 <span class="preprocessor"></span>    LARGE_INTEGER stime, etime;
02863     ULONG dtime;
02864 <span class="preprocessor">#endif</span>
02865 <span class="preprocessor"></span>    PLIST_ENTRY entry;
02866     PLDR_DATA_TABLE_ENTRY DataTableEntry;
02867 
02868     <span class="comment">//</span>
02869     <span class="comment">// Begin by creating the driver object.</span>
02870     <span class="comment">//</span>
02871 
02872     status = <a class="code" href="../../d9/d5/ioinit_8c.html#a21">IopInitializeAttributesAndCreateObject</a>( DriverName,
02873                                                      &amp;objectAttributes,
02874                                                      &amp;driverObject );
02875     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02876         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02877     }
02878 
02879     <span class="comment">//</span>
02880     <span class="comment">// Initialize the driver object.</span>
02881     <span class="comment">//</span>
02882 
02883     <a class="code" href="../../d9/d5/ioinit_8c.html#a2">InitializeDriverObject</a>( driverObject );
02884     driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o11">DriverInit</a> = DriverInitializeRoutine;
02885 
02886     <span class="comment">//</span>
02887     <span class="comment">// Insert the driver object into the object table.</span>
02888     <span class="comment">//</span>
02889 
02890     status = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>( driverObject,
02891                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02892                              FILE_READ_DATA,
02893                              0,
02894                              (PVOID *) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02895                              &amp;handle );
02896 
02897     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02898         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02899     }
02900 
02901     <span class="comment">//</span>
02902     <span class="comment">// Reference the handle and obtain a pointer to the driver object so that</span>
02903     <span class="comment">// the handle can be deleted without the object going away.</span>
02904     <span class="comment">//</span>
02905 
02906     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( handle,
02907                                         0,
02908                                         <a class="code" href="../../d3/d5/iodata_8c.html#a36">IoDriverObjectType</a>,
02909                                         <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
02910                                         (PVOID *) &amp;tmpDriverObject,
02911                                         (<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">POBJECT_HANDLE_INFORMATION</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
02912     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_SUCCESS);
02913     <span class="comment">//</span>
02914     <span class="comment">// Fill in the DriverSection so the image will be automatically unloaded on</span>
02915     <span class="comment">// failures. We should use the entry from the PsModuleList.</span>
02916     <span class="comment">//</span>
02917 
02918     entry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
02919     <span class="keywordflow">while</span> (entry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a> &amp;&amp; <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>) {
02920         DataTableEntry = CONTAINING_RECORD(entry,
02921                                            LDR_DATA_TABLE_ENTRY,
02922                                            InLoadOrderLinks);
02923         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/string_8c.html#a11">RtlEqualString</a>((PSTRING)&amp;<a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;BaseDllName,
02924                     (PSTRING)&amp;DataTableEntry-&gt;BaseDllName,
02925                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
02926                     )) {
02927             driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o6">DriverSection</a> = DataTableEntry;
02928             <span class="keywordflow">break</span>;
02929         }
02930         entry = entry-&gt;Flink;
02931     }
02932 
02933     <span class="comment">//</span>
02934     <span class="comment">// The boot process takes a while loading drivers.   Indicate that</span>
02935     <span class="comment">// progress is being made.</span>
02936     <span class="comment">//</span>
02937 
02938     <a class="code" href="../../d0/d1/inbv_8h.html#a13">InbvIndicateProgress</a>();
02939 
02940     <span class="comment">//</span>
02941     <span class="comment">// Get start and sice for the DriverObject.</span>
02942     <span class="comment">//</span>
02943 
02944     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>) {
02945         imageBase = <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;DllBase;
02946         ntHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(imageBase);
02947         driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o4">DriverStart</a> = imageBase;
02948         driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o5">DriverSize</a> = ntHeaders-&gt;OptionalHeader.SizeOfImage;
02949         <span class="keywordflow">if</span> (!(ntHeaders-&gt;OptionalHeader.DllCharacteristics &amp; IMAGE_DLLCHARACTERISTICS_WDM_DRIVER)) {
02950             driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a144">DRVO_LEGACY_DRIVER</a>;
02951         }
02952     } <span class="keywordflow">else</span> {
02953         ntHeaders = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02954         driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a144">DRVO_LEGACY_DRIVER</a>;
02955     }
02956 
02957     <span class="comment">//</span>
02958     <span class="comment">// Save the name of the driver so that it can be easily located by functions</span>
02959     <span class="comment">// such as error logging.</span>
02960     <span class="comment">//</span>
02961 
02962     buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, DriverName-&gt;MaximumLength + 2 );
02963 
02964     <span class="keywordflow">if</span> (buffer) {
02965         driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>.Buffer = buffer;
02966         driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>.MaximumLength = DriverName-&gt;MaximumLength;
02967         driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>.Length = DriverName-&gt;Length;
02968 
02969         RtlCopyMemory( driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>.Buffer,
02970                        DriverName-&gt;Buffer,
02971                        DriverName-&gt;MaximumLength );
02972         buffer[DriverName-&gt;Length &gt;&gt; 1] = (WCHAR) <span class="charliteral">'\0'</span>;
02973     }
02974 
02975     <span class="comment">//</span>
02976     <span class="comment">// Save the name of the service key so that it can be easily located by PnP</span>
02977     <span class="comment">// mamager.</span>
02978     <span class="comment">//</span>
02979 
02980     driverExtension = driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>;
02981     <span class="keywordflow">if</span> (RegistryPath &amp;&amp; RegistryPath-&gt;Length != 0) {
02982         pserviceName = RegistryPath-&gt;Buffer + RegistryPath-&gt;Length / <span class="keyword">sizeof</span> (WCHAR) - 1;
02983         <span class="keywordflow">if</span> (*pserviceName == OBJ_NAME_PATH_SEPARATOR) {
02984             pserviceName--;
02985         }
02986         serviceNameLength = 0;
02987         <span class="keywordflow">while</span> (pserviceName != RegistryPath-&gt;Buffer) {
02988             <span class="keywordflow">if</span> (*pserviceName == OBJ_NAME_PATH_SEPARATOR) {
02989                 pserviceName++;
02990                 <span class="keywordflow">break</span>;
02991             } <span class="keywordflow">else</span> {
02992                 serviceNameLength += <span class="keyword">sizeof</span>(WCHAR);
02993                 pserviceName--;
02994             }
02995         }
02996         <span class="keywordflow">if</span> (pserviceName == RegistryPath-&gt;Buffer) {
02997             serviceNameLength += <span class="keyword">sizeof</span>(WCHAR);
02998         }
02999         buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, serviceNameLength + <span class="keyword">sizeof</span>(UNICODE_NULL) );
03000 
03001         <span class="keywordflow">if</span> (buffer) {
03002             driverExtension-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>.Buffer = buffer;
03003             driverExtension-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>.MaximumLength = serviceNameLength + <span class="keyword">sizeof</span>(UNICODE_NULL);
03004             driverExtension-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>.Length = serviceNameLength;
03005 
03006             RtlCopyMemory( driverExtension-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>.Buffer,
03007                            pserviceName,
03008                            serviceNameLength );
03009             buffer[driverExtension-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>.Length &gt;&gt; 1] = UNICODE_NULL;
03010         } <span class="keywordflow">else</span> {
03011             status = STATUS_INSUFFICIENT_RESOURCES;
03012             driverExtension-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03013             driverExtension-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>.Length = 0;
03014             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
03015         }
03016 
03017         <span class="comment">//</span>
03018         <span class="comment">// Prepare driver initialization</span>
03019         <span class="comment">//</span>
03020 
03021         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;serviceHandle,
03022                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03023                                        RegistryPath,
03024                                        KEY_ALL_ACCESS
03025                                        );
03026         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03027             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a5">IopPrepareDriverLoading</a>(&amp;driverExtension-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>,
03028                                              serviceHandle,
03029                                              ntHeaders);
03030             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(serviceHandle);
03031             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03032                 <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
03033             }
03034         } <span class="keywordflow">else</span> {
03035             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
03036         }
03037     } <span class="keywordflow">else</span> {
03038         driverExtension-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03039         driverExtension-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>.MaximumLength = 0;
03040         driverExtension-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>.Length = 0;
03041     }
03042 
03043     <span class="comment">//</span>
03044     <span class="comment">// Load the Registry information in the appropriate fields of the device</span>
03045     <span class="comment">// object.</span>
03046     <span class="comment">//</span>
03047 
03048     driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o9">HardwareDatabase</a> = &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a17">CmRegistryMachineHardwareDescriptionSystemName</a>;
03049 
03050 <span class="preprocessor">#if DBG</span>
03051 <span class="preprocessor"></span>    <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a> (&amp;stime);
03052 <span class="preprocessor">#endif</span>
03053 <span class="preprocessor"></span>
03054     <span class="comment">//</span>
03055     <span class="comment">// Now invoke the driver's initialization routine to initialize itself.</span>
03056     <span class="comment">//</span>
03057 
03058     <a class="code" href="../../d2/d1/mm_8h.html#a45">PERFINFO_DRIVER_INIT</a>( driverObject);
03059 
03060     status = driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o11">DriverInit</a>( driverObject, RegistryPath );
03061 
03062     <a class="code" href="../../d2/d1/mm_8h.html#a46">PERFINFO_DRIVER_INIT_COMPLETE</a>( driverObject);
03063 
03064 <span class="preprocessor">#if DBG</span>
03065 <span class="preprocessor"></span>
03066     <span class="comment">//</span>
03067     <span class="comment">// If DriverInit took longer than 5 seconds or the driver did not load,</span>
03068     <span class="comment">// print a message.</span>
03069     <span class="comment">//</span>
03070 
03071     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a> (&amp;etime);
03072     dtime  = (ULONG) ((etime.QuadPart - stime.QuadPart) / 1000000);
03073 
03074     <span class="keywordflow">if</span> (dtime &gt; 50  ||  !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03075         <span class="keywordflow">if</span> (dtime &lt; 10) {
03076             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IOINIT: Built-in driver %wZ failed to initialize - %lX\n"</span>,
03077                 DriverName, status );
03078 
03079         } <span class="keywordflow">else</span> {
03080             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IOINIT: Built-in driver %wZ took %d.%ds to "</span>,
03081                 DriverName, dtime/10, dtime%10 );
03082 
03083             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03084                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"initialize\n"</span>);
03085             } <span class="keywordflow">else</span> {
03086                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"fail initialization - %lX\n"</span>, status);
03087             }
03088         }
03089     }
03090 <span class="preprocessor">#endif</span>
03091 <span class="preprocessor"></span><a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
03092     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
03093 
03094     <span class="comment">//</span>
03095     <span class="comment">// If we load the driver because we think it is a legacy driver and</span>
03096     <span class="comment">// it does not create any device object in its DriverEntry.  We will</span>
03097     <span class="comment">// unload this driver.</span>
03098     <span class="comment">//</span>
03099 
03100     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; !<a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a32">IopIsLegacyDriver</a>(driverObject)) {
03101         <span class="keywordflow">if</span> (driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o2">DeviceObject</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>     &amp;&amp;
03102             driverExtension-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>.Buffer &amp;&amp;
03103             !<a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a19">IopIsAnyDeviceInstanceEnabled</a>(&amp;driverExtension-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
03104             <span class="keywordflow">if</span> (TextModeSetup &amp;&amp; !(driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a146">DRVO_REINIT_REGISTERED</a>)) {
03105 
03106                 <span class="comment">//</span>
03107                 <span class="comment">// Clean up but leave driver object.  Because it may be needed later.</span>
03108                 <span class="comment">// After boot driver phase completes, we will process all the driver objects</span>
03109                 <span class="comment">// which still have no device to control.</span>
03110                 <span class="comment">//</span>
03111 
03112                 <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a18">IopDriverLoadingFailed</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>);
03113             }
03114         } <span class="keywordflow">else</span> {
03115 
03116             <span class="comment">//</span>
03117             <span class="comment">// Start the devices controlled by the driver and enumerate them</span>
03118             <span class="comment">// At this point, we know there is at least one device controlled by the driver.</span>
03119             <span class="comment">//</span>
03120 
03121             <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a34">IopDeleteLegacyKey</a>(driverObject);
03122         }
03123     }
03124 
03125     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03126         <a class="code" href="../../d0/d6/iop_8h.html#a207">IopReadyDeviceObjects</a>( driverObject );
03127         <span class="keywordflow">return</span> driverObject;
03128     } <span class="keywordflow">else</span> {
03129         <span class="keywordflow">if</span> (status != STATUS_PLUGPLAY_NO_DEVICE) {
03130 
03131             <span class="comment">//</span>
03132             <span class="comment">// if STATUS_PLUGPLAY_NO_DEVICE, the driver was disable by hardware profile.</span>
03133             <span class="comment">//</span>
03134 
03135             <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a18">IopDriverLoadingFailed</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>);
03136             <a class="code" href="../../d5/d0/obclose_8c.html#a3">ObMakeTemporaryObject</a>( driverObject );
03137             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> ( driverObject );
03138         }
03139         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03140     }
03141 }
03142 
03143 
03144 
03145 BOOLEAN
<a name="l03146"></a><a class="code" href="../../d9/d5/ioinit_8c.html#a25">03146</a> <a class="code" href="../../d9/d5/ioinit_8c.html#a25">IopInitializeSystemDrivers</a>(
03147     VOID
03148     )
03149 
03150 <span class="comment">/*++</span>
03151 <span class="comment"></span>
03152 <span class="comment">Routine Description:</span>
03153 <span class="comment"></span>
03154 <span class="comment">    This routine is invoked to load and initialize all of the drivers that</span>
03155 <span class="comment">    are supposed to be loaded during Phase 1 initialization of the I/O</span>
03156 <span class="comment">    system.  This is accomplished by calling the Configuration Manager to</span>
03157 <span class="comment">    get a NULL-terminated array of handles to the open keys for each driver</span>
03158 <span class="comment">    that is to be loaded, and then loading and initializing the driver.</span>
03159 <span class="comment"></span>
03160 <span class="comment">Arguments:</span>
03161 <span class="comment"></span>
03162 <span class="comment">    None.</span>
03163 <span class="comment"></span>
03164 <span class="comment">Return Value:</span>
03165 <span class="comment"></span>
03166 <span class="comment">    The function value is a BOOLEAN indicating whether or not the drivers</span>
03167 <span class="comment">    were successfully loaded and initialized.</span>
03168 <span class="comment"></span>
03169 <span class="comment">--*/</span>
03170 
03171 {
03172     BOOLEAN  newDevice, moreProcessing;
03173     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03174     PHANDLE driverList;
03175     PHANDLE savedList;
03176     HANDLE enumHandle;
03177     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
03178     UNICODE_STRING groupName, enumName;
03179     <a class="code" href="../../d9/d5/ioinit_8c.html#a4">PTREE_ENTRY</a> treeEntry;
03180     UNICODE_STRING driverName;
03181     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
03182     <a class="code" href="../../d0/d6/struct__START__CONTEXT.html">START_CONTEXT</a> startContext;
03183 
03184     <span class="comment">//</span>
03185     <span class="comment">// Scan the device node tree to process any device which have been enumerated</span>
03186     <span class="comment">// but not been added/started.</span>
03187     <span class="comment">//</span>
03188 
03189     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o0">LoadDriver</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03190     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o2">AddContext</a>.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o2">DriverStartType</a> = SERVICE_DEMAND_START;
03191 
03192     <a class="code" href="../../d9/d0/pnpiop_8h.html#a261">IopProcessAddDevices</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>, <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>, SERVICE_DEMAND_START);
03193 
03194     <span class="comment">//</span>
03195     <span class="comment">// Process the whole device tree to assign resources to those devices who</span>
03196     <span class="comment">// have been successfully added to their drivers.</span>
03197     <span class="comment">//</span>
03198 
03199     newDevice = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03200     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o2">AddContext</a>.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o0">GroupsToStart</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>;
03201     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o2">AddContext</a>.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o1">GroupToStartNext</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>;
03202     <span class="keywordflow">while</span> (newDevice || moreProcessing) {
03203         startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o1">NewDevice</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03204         moreProcessing = <a class="code" href="../../d9/d0/pnpiop_8h.html#a262">IopProcessAssignResources</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03205 
03206         <span class="comment">//</span>
03207         <span class="comment">// Process the whole device tree to start those devices who have been allocated</span>
03208         <span class="comment">// resources and waiting to be started.</span>
03209         <span class="comment">// Note, the IopProcessStartDevices routine may enumerate new devices.</span>
03210         <span class="comment">//</span>
03211 
03212         <a class="code" href="../../d9/d0/pnpiop_8h.html#a263">IopProcessStartDevices</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>, &amp;startContext);
03213         newDevice = startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o1">NewDevice</a>;
03214     }
03215 
03216     <span class="comment">//</span>
03217     <span class="comment">// Walk thru the service list to load the remaining system start drivers.</span>
03218     <span class="comment">// (Most likely these drivers are software drivers.)</span>
03219     <span class="comment">//</span>
03220 
03221     <span class="comment">//</span>
03222     <span class="comment">// Get the list of drivers that are to be loaded during this phase of</span>
03223     <span class="comment">// system initialization, and invoke each driver in turn.  Ensure that</span>
03224     <span class="comment">// the list really exists, otherwise get out now.</span>
03225     <span class="comment">//</span>
03226 
03227     <span class="keywordflow">if</span> (!(driverList = <a class="code" href="../../d7/d9/cm_8h.html#a29">CmGetSystemDriverList</a>())) {
03228         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03229     }
03230 
03231     <span class="comment">//</span>
03232     <span class="comment">// Walk the entire list, loading each of the drivers if not already loaded,</span>
03233     <span class="comment">// until there are no more drivers in the list.</span>
03234     <span class="comment">//</span>
03235 
03236     <span class="keywordflow">for</span> (savedList = driverList; *driverList; driverList++) {
03237 
03238         <span class="comment">//</span>
03239         <span class="comment">// Now check if the driver has been loaded already.</span>
03240         <span class="comment">// get the name of the driver object first ...</span>
03241         <span class="comment">//</span>
03242 
03243         status = <a class="code" href="../../d0/d6/iop_8h.html#a175">IopGetDriverNameFromKeyNode</a>( *driverList,
03244                                               &amp;driverName );
03245         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03246 
03247             driverObject = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a22">IopReferenceDriverObjectByName</a>(&amp;driverName);
03248             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;driverName);
03249             <span class="keywordflow">if</span> (driverObject) {
03250 
03251                 <span class="comment">//</span>
03252                 <span class="comment">// Driver was loaded already.  Dereference the driver object</span>
03253                 <span class="comment">// and skip it.</span>
03254                 <span class="comment">//</span>
03255 
03256                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(driverObject);
03257                 <span class="keywordflow">continue</span>;
03258             }
03259         }
03260 
03261         <span class="comment">//</span>
03262         <span class="comment">// Open registry ServiceKeyName\Enum branch to check if the driver was</span>
03263         <span class="comment">// loaded before but failed.</span>
03264         <span class="comment">//</span>
03265 
03266         PiWstrToUnicodeString(&amp;enumName, REGSTR_KEY_ENUM);
03267         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;enumHandle,
03268                                        *driverList,
03269                                        &amp;enumName,
03270                                        KEY_READ
03271                                        );
03272 
03273         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03274 
03275             ULONG startFailed = 0;
03276 
03277             status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(enumHandle, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"INITSTARTFAILED"</span>, &amp;keyValueInformation);
03278 
03279             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03280                 <span class="keywordflow">if</span> (keyValueInformation-&gt;DataLength) {
03281                     startFailed = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03282                 }
03283                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
03284             }
03285             ZwClose(enumHandle);
03286             <span class="keywordflow">if</span> (startFailed != 0) {
03287                 <span class="keywordflow">continue</span>;
03288             }
03289         }
03290 
03291         <span class="comment">//</span>
03292         <span class="comment">// The driver is not loaded yet.  Load it ...</span>
03293         <span class="comment">//</span>
03294 
03295         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( *driverList,
03296                                       <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Group"</span>,
03297                                       &amp;keyValueInformation );
03298         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03299             <span class="keywordflow">if</span> (keyValueInformation-&gt;DataLength) {
03300                 groupName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) keyValueInformation-&gt;DataLength;
03301                 groupName.MaximumLength = groupName.Length;
03302                 groupName.Buffer = (PWSTR) ((PUCHAR) keyValueInformation + keyValueInformation-&gt;DataOffset);
03303                 treeEntry = <a class="code" href="../../d9/d5/ioinit_8c.html#a26">IopLookupGroupName</a>( &amp;groupName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
03304             } <span class="keywordflow">else</span> {
03305                 treeEntry = (<a class="code" href="../../d9/d5/ioinit_8c.html#a4">PTREE_ENTRY</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03306             }
03307             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
03308         } <span class="keywordflow">else</span> {
03309             treeEntry = (<a class="code" href="../../d9/d5/ioinit_8c.html#a4">PTREE_ENTRY</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03310         }
03311 
03312         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/ioinit_8c.html#a15">IopCheckDependencies</a>( *driverList )) {
03313             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d6/iop_8h.html#a191">IopLoadDriver</a>( *driverList, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ) )) {
03314                 <span class="keywordflow">if</span> (treeEntry) {
03315                     treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o4">DriversLoaded</a>++;
03316                 }
03317             }
03318         }
03319 
03320         <span class="comment">//</span>
03321         <span class="comment">// The boot process takes a while loading drivers.   Indicate that</span>
03322         <span class="comment">// progress is being made.</span>
03323         <span class="comment">//</span>
03324 
03325         <a class="code" href="../../d0/d1/inbv_8h.html#a13">InbvIndicateProgress</a>();
03326 
03327     }
03328 
03329     <span class="comment">//</span>
03330     <span class="comment">// Finally, free the pool that was allocated for the list and return</span>
03331     <span class="comment">// an indicator the load operation worked.</span>
03332     <span class="comment">//</span>
03333 
03334     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( (PVOID) savedList );
03335 
03336     <span class="comment">//</span>
03337     <span class="comment">// Walk the device tree again to enumerate any devices reported after the system drivers</span>
03338     <span class="comment">// started.</span>
03339     <span class="comment">//</span>
03340 
03341     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o0">LoadDriver</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03342     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o2">AddContext</a>.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o2">DriverStartType</a> = SERVICE_DEMAND_START;
03343 
03344     <a class="code" href="../../d9/d0/pnpiop_8h.html#a261">IopProcessAddDevices</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>, <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>, SERVICE_DEMAND_START);
03345 
03346     <span class="comment">//</span>
03347     <span class="comment">// Process the whole device tree to assign resources to those devices who</span>
03348     <span class="comment">// have been successfully added to their drivers.</span>
03349     <span class="comment">//</span>
03350 
03351     newDevice = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03352     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o2">AddContext</a>.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o0">GroupsToStart</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>;
03353     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o2">AddContext</a>.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o1">GroupToStartNext</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>;
03354     <span class="keywordflow">do</span> {
03355         startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o1">NewDevice</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03356         moreProcessing = <a class="code" href="../../d9/d0/pnpiop_8h.html#a262">IopProcessAssignResources</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>, newDevice, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03357 
03358         <span class="comment">//</span>
03359         <span class="comment">// Process the whole device tree to start those devices who have been allocated</span>
03360         <span class="comment">// resources and waiting to be started.</span>
03361         <span class="comment">// Note, the IopProcessStartDevices routine may enumerate new devices.</span>
03362         <span class="comment">//</span>
03363 
03364         <a class="code" href="../../d9/d0/pnpiop_8h.html#a263">IopProcessStartDevices</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>, &amp;startContext);
03365         newDevice = startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o1">NewDevice</a>;
03366     } <span class="keywordflow">while</span> (newDevice || moreProcessing) ;
03367 
03368     <span class="comment">//</span>
03369     <span class="comment">// Mark pnp has completed the driver loading for both system and</span>
03370     <span class="comment">// autoload drivers.</span>
03371     <span class="comment">//</span>
03372 
03373     <a class="code" href="../../d1/d0/pnpdata_8c.html#a14">PnPInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03374 
03375     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03376 }
03377 
03378 <a class="code" href="../../d9/d5/ioinit_8c.html#a4">PTREE_ENTRY</a>
<a name="l03379"></a><a class="code" href="../../d9/d5/ioinit_8c.html#a26">03379</a> <a class="code" href="../../d9/d5/ioinit_8c.html#a26">IopLookupGroupName</a>(
03380     IN PUNICODE_STRING GroupName,
03381     IN BOOLEAN Insert
03382     )
03383 
03384 <span class="comment">/*++</span>
03385 <span class="comment"></span>
03386 <span class="comment">Routine Description:</span>
03387 <span class="comment"></span>
03388 <span class="comment">    This routine looks up a group entry in the group load tree and either</span>
03389 <span class="comment">    returns a pointer to it, or optionally creates the entry and inserts</span>
03390 <span class="comment">    it into the tree.</span>
03391 <span class="comment"></span>
03392 <span class="comment">Arguments:</span>
03393 <span class="comment"></span>
03394 <span class="comment">    GroupName - The name of the group to look up, or insert.</span>
03395 <span class="comment"></span>
03396 <span class="comment">    Insert - Indicates whether or not an entry is to be created and inserted</span>
03397 <span class="comment">        into the tree if the name does not already exist.</span>
03398 <span class="comment"></span>
03399 <span class="comment">Return Value:</span>
03400 <span class="comment"></span>
03401 <span class="comment">    The function value is a pointer to the entry for the specified group</span>
03402 <span class="comment">    name, or NULL.</span>
03403 <span class="comment"></span>
03404 <span class="comment">--*/</span>
03405 
03406 {
03407     <a class="code" href="../../d9/d5/ioinit_8c.html#a4">PTREE_ENTRY</a> treeEntry;
03408     <a class="code" href="../../d9/d5/ioinit_8c.html#a4">PTREE_ENTRY</a> previousEntry;
03409 
03410     <span class="comment">//</span>
03411     <span class="comment">// Begin by determining whether or not there are any entries in the tree</span>
03412     <span class="comment">// whatsoever.  If not, and it is OK to insert, then insert this entry</span>
03413     <span class="comment">// into the tree.</span>
03414     <span class="comment">//</span>
03415 
03416     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d5/ioinit_8c.html#a7">IopGroupListHead</a>) {
03417         <span class="keywordflow">if</span> (!Insert) {
03418             <span class="keywordflow">return</span> (<a class="code" href="../../d9/d5/ioinit_8c.html#a4">PTREE_ENTRY</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03419         } <span class="keywordflow">else</span> {
03420             <a class="code" href="../../d9/d5/ioinit_8c.html#a7">IopGroupListHead</a> = <a class="code" href="../../d9/d5/ioinit_8c.html#a18">IopCreateEntry</a>( GroupName );
03421             <span class="keywordflow">return</span> <a class="code" href="../../d9/d5/ioinit_8c.html#a7">IopGroupListHead</a>;
03422         }
03423     }
03424 
03425     <span class="comment">//</span>
03426     <span class="comment">// The tree is not empty, so actually attempt to do a lookup.</span>
03427     <span class="comment">//</span>
03428 
03429     treeEntry = <a class="code" href="../../d9/d5/ioinit_8c.html#a7">IopGroupListHead</a>;
03430 
03431     <span class="keywordflow">for</span> (;;) {
03432         <span class="keywordflow">if</span> (GroupName-&gt;Length &lt; treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o5">GroupName</a>.Length) {
03433             <span class="keywordflow">if</span> (treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o0">Left</a>) {
03434                 treeEntry = treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o0">Left</a>;
03435             } <span class="keywordflow">else</span> {
03436                 <span class="keywordflow">if</span> (!Insert) {
03437                     <span class="keywordflow">return</span> (<a class="code" href="../../d9/d5/ioinit_8c.html#a4">PTREE_ENTRY</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03438                 } <span class="keywordflow">else</span> {
03439                     treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o0">Left</a> = <a class="code" href="../../d9/d5/ioinit_8c.html#a18">IopCreateEntry</a>( GroupName );
03440                     <span class="keywordflow">return</span> treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o0">Left</a>;
03441                 }
03442 
03443             }
03444         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (GroupName-&gt;Length &gt; treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o5">GroupName</a>.Length) {
03445             <span class="keywordflow">if</span> (treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o1">Right</a>) {
03446                 treeEntry = treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o1">Right</a>;
03447             } <span class="keywordflow">else</span> {
03448                 <span class="keywordflow">if</span> (!Insert) {
03449                     <span class="keywordflow">return</span> (<a class="code" href="../../d9/d5/ioinit_8c.html#a4">PTREE_ENTRY</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03450                 } <span class="keywordflow">else</span> {
03451                     treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o1">Right</a> = <a class="code" href="../../d9/d5/ioinit_8c.html#a18">IopCreateEntry</a>( GroupName );
03452                     <span class="keywordflow">return</span> treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o1">Right</a>;
03453                 }
03454             }
03455         } <span class="keywordflow">else</span> {
03456             <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>( GroupName, &amp;treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o5">GroupName</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> )) {
03457                 previousEntry = treeEntry;
03458                 <span class="keywordflow">while</span> (treeEntry-&gt;Sibling) {
03459                     treeEntry = treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o2">Sibling</a>;
03460                     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>( GroupName, &amp;treeEntry-&gt;GroupName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> )) {
03461                         <span class="keywordflow">return</span> treeEntry;
03462                     }
03463                     previousEntry = previousEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o2">Sibling</a>;
03464                 }
03465                 <span class="keywordflow">if</span> (!Insert) {
03466                     <span class="keywordflow">return</span> (<a class="code" href="../../d9/d5/ioinit_8c.html#a4">PTREE_ENTRY</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03467                 } <span class="keywordflow">else</span> {
03468                     previousEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o2">Sibling</a> = <a class="code" href="../../d9/d5/ioinit_8c.html#a18">IopCreateEntry</a>( GroupName );
03469                     <span class="keywordflow">return</span> previousEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o2">Sibling</a>;
03470                 }
03471             } <span class="keywordflow">else</span> {
03472                 <span class="keywordflow">return</span> treeEntry;
03473             }
03474         }
03475     }
03476 }
03477 
03478 BOOLEAN
<a name="l03479"></a><a class="code" href="../../d9/d5/ioinit_8c.html#a27">03479</a> <a class="code" href="../../d9/d5/ioinit_8c.html#a27">IopMarkBootPartition</a>(
03480     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
03481     )
03482 
03483 <span class="comment">/*++</span>
03484 <span class="comment"></span>
03485 <span class="comment">Routine Description:</span>
03486 <span class="comment"></span>
03487 <span class="comment">    This routine is invoked to locate and mark the boot partition device object</span>
03488 <span class="comment">    as a boot device so that subsequent operations can fail more cleanly and</span>
03489 <span class="comment">    with a better explanation of why the system failed to boot and run properly.</span>
03490 <span class="comment"></span>
03491 <span class="comment">Arguments:</span>
03492 <span class="comment"></span>
03493 <span class="comment">    LoaderBlock - Supplies a pointer to the loader parameter block created</span>
03494 <span class="comment">        by the OS Loader during the boot process.  This structure contains</span>
03495 <span class="comment">        the various system partition and boot device names and paths.</span>
03496 <span class="comment"></span>
03497 <span class="comment">Return Value:</span>
03498 <span class="comment"></span>
03499 <span class="comment">    The function value is TRUE if everything worked, otherwise FALSE.</span>
03500 <span class="comment"></span>
03501 <span class="comment">Notes:</span>
03502 <span class="comment"></span>
03503 <span class="comment">    If the boot partition device object cannot be found, then the system will</span>
03504 <span class="comment">    bugcheck.</span>
03505 <span class="comment"></span>
03506 <span class="comment">--*/</span>
03507 
03508 {
03509     OBJECT_ATTRIBUTES objectAttributes;
03510     STRING deviceNameString;
03511     UCHAR deviceNameBuffer[256];
03512     UNICODE_STRING deviceNameUnicodeString;
03513     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03514     HANDLE fileHandle;
03515     IO_STATUS_BLOCK ioStatus;
03516     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
03517     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> ArcNameFmt[12];
03518 
03519     ArcNameFmt[0] = <span class="charliteral">'\\'</span>;
03520     ArcNameFmt[1] = <span class="charliteral">'A'</span>;
03521     ArcNameFmt[2] = <span class="charliteral">'r'</span>;
03522     ArcNameFmt[3] = <span class="charliteral">'c'</span>;
03523     ArcNameFmt[4] = <span class="charliteral">'N'</span>;
03524     ArcNameFmt[5] = <span class="charliteral">'a'</span>;
03525     ArcNameFmt[6] = <span class="charliteral">'m'</span>;
03526     ArcNameFmt[7] = <span class="charliteral">'e'</span>;
03527     ArcNameFmt[8] = <span class="charliteral">'\\'</span>;
03528     ArcNameFmt[9] = <span class="charliteral">'%'</span>;
03529     ArcNameFmt[10] = <span class="charliteral">'s'</span>;
03530     ArcNameFmt[11] = <span class="charliteral">'\0'</span>;
03531     <span class="comment">//</span>
03532     <span class="comment">// Open the ARC boot device object. The boot device driver should have</span>
03533     <span class="comment">// created the object.</span>
03534     <span class="comment">//</span>
03535 
03536     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( deviceNameBuffer,
03537              ArcNameFmt,
03538              LoaderBlock-&gt;ArcBootDeviceName );
03539 
03540     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;deviceNameString, deviceNameBuffer );
03541 
03542     status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;deviceNameUnicodeString,
03543                                            &amp;deviceNameString,
03544                                            <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
03545 
03546     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03547         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03548     }
03549 
03550     InitializeObjectAttributes( &amp;objectAttributes,
03551                                 &amp;deviceNameUnicodeString,
03552                                 OBJ_CASE_INSENSITIVE,
03553                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03554                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
03555 
03556     status = <a class="code" href="../../d6/d9/restrfil_8c.html#a33">ZwOpenFile</a>( &amp;fileHandle,
03557                          FILE_READ_ATTRIBUTES,
03558                          &amp;objectAttributes,
03559                          &amp;ioStatus,
03560                          0,
03561                          FILE_NON_DIRECTORY_FILE );
03562     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03563         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( INACCESSIBLE_BOOT_DEVICE,
03564                       (ULONG_PTR) &amp;deviceNameUnicodeString,
03565                       status,
03566                       0,
03567                       0 );
03568     }
03569 
03570     <span class="comment">//</span>
03571     <span class="comment">// Convert the file handle into a pointer to the device object itself.</span>
03572     <span class="comment">//</span>
03573 
03574     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( fileHandle,
03575                                         0,
03576                                         <a class="code" href="../../d5/d8/fssup_8c.html#a3">IoFileObjectType</a>,
03577                                         <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
03578                                         (PVOID *) &amp;fileObject,
03579                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
03580     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03581         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;deviceNameUnicodeString );
03582         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03583     }
03584 
03585     <span class="comment">//</span>
03586     <span class="comment">// Mark the device object represented by the file object.</span>
03587     <span class="comment">//</span>
03588 
03589     fileObject-&gt;DeviceObject-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a129">DO_SYSTEM_BOOT_PARTITION</a>;
03590 
03591 
03592     <span class="comment">//</span>
03593     <span class="comment">// Reference the device object and store the reference.</span>
03594     <span class="comment">//</span>
03595     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(fileObject-&gt;DeviceObject);
03596 
03597     <a class="code" href="../../d9/d5/ioinit_8c.html#a8">IopErrorLogObject</a> =  fileObject-&gt;DeviceObject;
03598 
03599     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;deviceNameUnicodeString );
03600 
03601     <span class="comment">//</span>
03602     <span class="comment">// Finally, close the handle and dereference the file object.</span>
03603     <span class="comment">//</span>
03604 
03605     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( fileHandle );
03606     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
03607 
03608     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03609 }
03610 
03611 BOOLEAN
<a name="l03612"></a><a class="code" href="../../d9/d5/ioinit_8c.html#a28">03612</a> <a class="code" href="../../d9/d5/ioinit_8c.html#a28">IopReassignSystemRoot</a>(
03613     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock,
03614     OUT PSTRING NtDeviceName
03615     )
03616 
03617 <span class="comment">/*++</span>
03618 <span class="comment"></span>
03619 <span class="comment">Routine Description:</span>
03620 <span class="comment"></span>
03621 <span class="comment">    This routine is invoked to reassign \SystemRoot from being an ARC path</span>
03622 <span class="comment">    name to its NT path name equivalent.  This is done by looking up the</span>
03623 <span class="comment">    ARC device name as a symbolic link and determining which NT device object</span>
03624 <span class="comment">    is referred to by it.  The link is then replaced with the new name.</span>
03625 <span class="comment"></span>
03626 <span class="comment">Arguments:</span>
03627 <span class="comment"></span>
03628 <span class="comment">    LoaderBlock - Supplies a pointer to the loader parameter block created</span>
03629 <span class="comment">        by the OS Loader during the boot process.  This structure contains</span>
03630 <span class="comment">        the various system partition and boot device names and paths.</span>
03631 <span class="comment"></span>
03632 <span class="comment">    NtDeviceName - Specifies a pointer to a STRING to receive the NT name of</span>
03633 <span class="comment">        the device from which the system was booted.</span>
03634 <span class="comment"></span>
03635 <span class="comment">Return Value:</span>
03636 <span class="comment"></span>
03637 <span class="comment">    The function value is a BOOLEAN indicating whether or not the ARC name</span>
03638 <span class="comment">    was resolved to an NT name.</span>
03639 <span class="comment"></span>
03640 <span class="comment">--*/</span>
03641 
03642 {
03643     OBJECT_ATTRIBUTES objectAttributes;
03644     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03645     UCHAR deviceNameBuffer[256];
03646     WCHAR arcNameUnicodeBuffer[64];
03647     UCHAR arcNameStringBuffer[256];
03648     STRING deviceNameString;
03649     STRING arcNameString;
03650     STRING linkString;
03651     UNICODE_STRING linkUnicodeString;
03652     UNICODE_STRING deviceNameUnicodeString;
03653     UNICODE_STRING arcNameUnicodeString;
03654     HANDLE linkHandle;
03655 
03656 <span class="preprocessor">#if DBG</span>
03657 <span class="preprocessor"></span>
03658     UCHAR debugBuffer[256];
03659     STRING debugString;
03660     UNICODE_STRING debugUnicodeString;
03661 
03662 <span class="preprocessor">#endif</span>
03663 <span class="preprocessor"></span>    <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> ArcNameFmt[12];
03664 
03665     ArcNameFmt[0] = <span class="charliteral">'\\'</span>;
03666     ArcNameFmt[1] = <span class="charliteral">'A'</span>;
03667     ArcNameFmt[2] = <span class="charliteral">'r'</span>;
03668     ArcNameFmt[3] = <span class="charliteral">'c'</span>;
03669     ArcNameFmt[4] = <span class="charliteral">'N'</span>;
03670     ArcNameFmt[5] = <span class="charliteral">'a'</span>;
03671     ArcNameFmt[6] = <span class="charliteral">'m'</span>;
03672     ArcNameFmt[7] = <span class="charliteral">'e'</span>;
03673     ArcNameFmt[8] = <span class="charliteral">'\\'</span>;
03674     ArcNameFmt[9] = <span class="charliteral">'%'</span>;
03675     ArcNameFmt[10] = <span class="charliteral">'s'</span>;
03676     ArcNameFmt[11] = <span class="charliteral">'\0'</span>;
03677 
03678     <span class="comment">//</span>
03679     <span class="comment">// Open the ARC boot device symbolic link object. The boot device</span>
03680     <span class="comment">// driver should have created the object.</span>
03681     <span class="comment">//</span>
03682 
03683     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( deviceNameBuffer,
03684              ArcNameFmt,
03685              LoaderBlock-&gt;ArcBootDeviceName );
03686 
03687     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;deviceNameString, deviceNameBuffer );
03688 
03689     status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;deviceNameUnicodeString,
03690                                            &amp;deviceNameString,
03691                                            <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
03692 
03693     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03694         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03695     }
03696 
03697     InitializeObjectAttributes( &amp;objectAttributes,
03698                                 &amp;deviceNameUnicodeString,
03699                                 OBJ_CASE_INSENSITIVE,
03700                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03701                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
03702 
03703     status = <a class="code" href="../../d4/d1/oblink_8c.html#a6">NtOpenSymbolicLinkObject</a>( &amp;linkHandle,
03704                                        SYMBOLIC_LINK_ALL_ACCESS,
03705                                        &amp;objectAttributes );
03706 
03707     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03708 
03709 <span class="preprocessor">#if DBG</span>
03710 <span class="preprocessor"></span>
03711         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( debugBuffer, <span class="stringliteral">"IOINIT: unable to resolve %s, Status == %X\n"</span>,
03712                  deviceNameBuffer,
03713                  status );
03714 
03715         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;debugString, debugBuffer );
03716 
03717         status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;debugUnicodeString,
03718                                                &amp;debugString,
03719                                                <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
03720 
03721         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03722             ZwDisplayString( &amp;debugUnicodeString );
03723             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;debugUnicodeString );
03724         }
03725 
03726 <span class="preprocessor">#endif // DBG</span>
03727 <span class="preprocessor"></span>
03728         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;deviceNameUnicodeString );
03729         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03730     }
03731 
03732     <span class="comment">//</span>
03733     <span class="comment">// Get handle to \SystemRoot symbolic link.</span>
03734     <span class="comment">//</span>
03735 
03736     arcNameUnicodeString.Buffer = arcNameUnicodeBuffer;
03737     arcNameUnicodeString.Length = 0;
03738     arcNameUnicodeString.MaximumLength = <span class="keyword">sizeof</span>( arcNameUnicodeBuffer );
03739 
03740     status = <a class="code" href="../../d4/d1/oblink_8c.html#a7">NtQuerySymbolicLinkObject</a>( linkHandle,
03741                                         &amp;arcNameUnicodeString,
03742                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
03743 
03744     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03745         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03746     }
03747 
03748     arcNameString.Buffer = arcNameStringBuffer;
03749     arcNameString.Length = 0;
03750     arcNameString.MaximumLength = <span class="keyword">sizeof</span>( arcNameStringBuffer );
03751 
03752     status = <a class="code" href="../../d6/d6/nls_8c.html#a23">RtlUnicodeStringToAnsiString</a>( &amp;arcNameString,
03753                                            &amp;arcNameUnicodeString,
03754                                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
03755 
03756     arcNameStringBuffer[arcNameString.Length] = <span class="charliteral">'\0'</span>;
03757 
03758     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( linkHandle );
03759     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;deviceNameUnicodeString );
03760 
03761     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;linkString, <a class="code" href="../../d8/d1/init_8h.html#a0">INIT_SYSTEMROOT_LINKNAME</a> );
03762 
03763     status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;linkUnicodeString,
03764                                            &amp;linkString,
03765                                            <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03766 
03767     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03768         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03769     }
03770 
03771     InitializeObjectAttributes( &amp;objectAttributes,
03772                                 &amp;linkUnicodeString,
03773                                 OBJ_CASE_INSENSITIVE,
03774                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03775                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
03776 
03777     status = <a class="code" href="../../d4/d1/oblink_8c.html#a6">NtOpenSymbolicLinkObject</a>( &amp;linkHandle,
03778                                        SYMBOLIC_LINK_ALL_ACCESS,
03779                                        &amp;objectAttributes );
03780 
03781     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03782         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03783     }
03784 
03785     <a class="code" href="../../d5/d0/obclose_8c.html#a2">NtMakeTemporaryObject</a>( linkHandle );
03786     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( linkHandle );
03787 
03788     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( deviceNameBuffer,
03789              <span class="stringliteral">"%Z%s"</span>,
03790              &amp;arcNameString,
03791              LoaderBlock-&gt;NtBootPathName );
03792 
03793     <span class="comment">//</span>
03794     <span class="comment">// Get NT device name for \SystemRoot assignment.</span>
03795     <span class="comment">//</span>
03796 
03797     <a class="code" href="../../d2/d7/string_8c.html#a8">RtlCopyString</a>( NtDeviceName, &amp;arcNameString );
03798 
03799     deviceNameBuffer[<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(deviceNameBuffer)-1] = <span class="charliteral">'\0'</span>;
03800 
03801     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;deviceNameString, deviceNameBuffer);
03802 
03803     InitializeObjectAttributes( &amp;objectAttributes,
03804                                 &amp;linkUnicodeString,
03805                                 OBJ_CASE_INSENSITIVE | OBJ_PERMANENT,
03806                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03807                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
03808 
03809     status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;arcNameUnicodeString,
03810                                            &amp;deviceNameString,
03811                                            <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03812 
03813     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03814         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03815     }
03816 
03817     status = <a class="code" href="../../d4/d1/oblink_8c.html#a5">NtCreateSymbolicLinkObject</a>( &amp;linkHandle,
03818                                          SYMBOLIC_LINK_ALL_ACCESS,
03819                                          &amp;objectAttributes,
03820                                          &amp;arcNameUnicodeString );
03821 
03822     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;arcNameUnicodeString );
03823     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;linkUnicodeString );
03824     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( linkHandle );
03825 
03826 <span class="preprocessor">#if DBG</span>
03827 <span class="preprocessor"></span>
03828     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03829 
03830         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( debugBuffer,
03831                  <span class="stringliteral">"INIT: Reassigned %s =&gt; %s\n"</span>,
03832                  <a class="code" href="../../d8/d1/init_8h.html#a0">INIT_SYSTEMROOT_LINKNAME</a>,
03833                  deviceNameBuffer );
03834 
03835     } <span class="keywordflow">else</span> {
03836 
03837         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( debugBuffer,
03838                  <span class="stringliteral">"INIT: unable to create %s =&gt; %s, Status == %X\n"</span>,
03839                  <a class="code" href="../../d8/d1/init_8h.html#a0">INIT_SYSTEMROOT_LINKNAME</a>,
03840                  deviceNameBuffer,
03841                  status );
03842     }
03843 
03844     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;debugString, debugBuffer );
03845 
03846     status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;debugUnicodeString,
03847                                            &amp;debugString,
03848                                            <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
03849 
03850     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03851 
03852         ZwDisplayString( &amp;debugUnicodeString );
03853         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;debugUnicodeString );
03854     }
03855 
03856 <span class="preprocessor">#endif // DBG</span>
03857 <span class="preprocessor"></span>
03858     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03859 }
03860 
03861 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03862"></a><a class="code" href="../../d9/d5/ioinit_8c.html#a29">03862</a> <a class="code" href="../../d9/d5/ioinit_8c.html#a29">IopStoreSystemPartitionInformation</a>(
03863     IN     PUNICODE_STRING NtSystemPartitionDeviceName,
03864     IN OUT PUNICODE_STRING OsLoaderPathName
03865     )
03866 
03867 <span class="comment">/*++</span>
03868 <span class="comment"></span>
03869 <span class="comment">Routine Description:</span>
03870 <span class="comment"></span>
03871 <span class="comment">    This routine writes two values to the registry (under HKLM\SYSTEM\Setup)--one</span>
03872 <span class="comment">    containing the NT device name of the system partition and the other containing</span>
03873 <span class="comment">    the path to the OS loader.  These values will later be migrated into a</span>
03874 <span class="comment">    Win95-compatible registry location (NT path converted to DOS path), so that</span>
03875 <span class="comment">    installation programs (including our own setup) have a rock-solid way of knowing</span>
03876 <span class="comment">    what the system partition is, on both ARC and x86.</span>
03877 <span class="comment"></span>
03878 <span class="comment">    ERRORS ENCOUNTERED IN THIS ROUTINE ARE NOT CONSIDERED FATAL.</span>
03879 <span class="comment"></span>
03880 <span class="comment">Arguments:</span>
03881 <span class="comment"></span>
03882 <span class="comment">    NtSystemPartitionDeviceName - supplies the NT device name of the system partition.</span>
03883 <span class="comment">        This is the \Device\Harddisk&lt;n&gt;\Partition&lt;m&gt; name, which used to be the actual</span>
03884 <span class="comment">        device name, but now is a symbolic link to a name of the form \Device\Volume&lt;x&gt;.</span>
03885 <span class="comment">        We open up this symbolic link, and retrieve the name that it points to.  The</span>
03886 <span class="comment">        target name is the one we store away in the registry.</span>
03887 <span class="comment"></span>
03888 <span class="comment">    OsLoaderPathName - supplies the path (on the partition specified in the 1st parameter)</span>
03889 <span class="comment">        where the OS loader is located.  Upon return, this path will have had its trailing</span>
03890 <span class="comment">        backslash removed (if present, and path isn't root).</span>
03891 <span class="comment"></span>
03892 <span class="comment">Return Value:</span>
03893 <span class="comment"></span>
03894 <span class="comment">    None.</span>
03895 <span class="comment"></span>
03896 <span class="comment">--*/</span>
03897 
03898 {
03899     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03900     HANDLE linkHandle;
03901     OBJECT_ATTRIBUTES objectAttributes;
03902     HANDLE systemHandle, setupHandle;
03903     UNICODE_STRING nameString, volumeNameString;
03904     WCHAR voumeNameStringBuffer[256];
03905     <span class="comment">//</span>
03906     <span class="comment">// Declare a unicode buffer big enough to contain the longest string we'll be using.</span>
03907     <span class="comment">// (ANSI string in 'sizeof()' below on purpose--we want the number of chars here.)</span>
03908     <span class="comment">//</span>
03909     WCHAR nameBuffer[<span class="keyword">sizeof</span>(<span class="stringliteral">"SystemPartition"</span>)];
03910 
03911     <span class="comment">//</span>
03912     <span class="comment">// Both UNICODE_STRING buffers should be NULL-terminated.</span>
03913     <span class="comment">//</span>
03914 
03915     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( NtSystemPartitionDeviceName-&gt;MaximumLength &gt;= NtSystemPartitionDeviceName-&gt;Length + <span class="keyword">sizeof</span>(WCHAR) );
03916     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( NtSystemPartitionDeviceName-&gt;Buffer[NtSystemPartitionDeviceName-&gt;Length / <span class="keyword">sizeof</span>(WCHAR)] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span> );
03917 
03918     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( OsLoaderPathName-&gt;MaximumLength &gt;= OsLoaderPathName-&gt;Length + <span class="keyword">sizeof</span>(WCHAR) );
03919     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( OsLoaderPathName-&gt;Buffer[OsLoaderPathName-&gt;Length / <span class="keyword">sizeof</span>(WCHAR)] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span> );
03920 
03921     <span class="comment">//</span>
03922     <span class="comment">// Open the NtSystemPartitionDeviceName symbolic link, and find out the volume device</span>
03923     <span class="comment">// it points to.</span>
03924     <span class="comment">//</span>
03925 
03926     InitializeObjectAttributes(&amp;objectAttributes,
03927                                NtSystemPartitionDeviceName,
03928                                OBJ_CASE_INSENSITIVE,
03929                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03930                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
03931                               );
03932 
03933     status = <a class="code" href="../../d4/d1/oblink_8c.html#a6">NtOpenSymbolicLinkObject</a>(&amp;linkHandle,
03934                                       SYMBOLIC_LINK_QUERY,
03935                                       &amp;objectAttributes
03936                                      );
03937 
03938     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03939 <span class="preprocessor">#if DBG</span>
03940 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopStoreSystemPartitionInformation: couldn't open symbolic link %wZ - %x\n"</span>,
03941                  NtSystemPartitionDeviceName,
03942                  status
03943                 );
03944 <span class="preprocessor">#endif // DBG</span>
03945 <span class="preprocessor"></span>        <span class="keywordflow">return</span>;
03946     }
03947 
03948     volumeNameString.Buffer = voumeNameStringBuffer;
03949     volumeNameString.Length = 0;
03950     <span class="comment">//</span>
03951     <span class="comment">// Leave room at the end of the buffer for a terminating null, in case we need to add one.</span>
03952     <span class="comment">//</span>
03953     volumeNameString.MaximumLength = <span class="keyword">sizeof</span>(voumeNameStringBuffer) - <span class="keyword">sizeof</span>(WCHAR);
03954 
03955     status = <a class="code" href="../../d4/d1/oblink_8c.html#a7">NtQuerySymbolicLinkObject</a>(linkHandle,
03956                                        &amp;volumeNameString,
03957                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
03958                                       );
03959 
03960     <span class="comment">//</span>
03961     <span class="comment">// We don't need the handle to the symbolic link any longer.</span>
03962     <span class="comment">//</span>
03963 
03964     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(linkHandle);
03965 
03966     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03967 <span class="preprocessor">#if DBG</span>
03968 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopStoreSystemPartitionInformation: couldn't query symbolic link %wZ - %x\n"</span>,
03969                  NtSystemPartitionDeviceName,
03970                  status
03971                 );
03972 <span class="preprocessor">#endif // DBG</span>
03973 <span class="preprocessor"></span>        <span class="keywordflow">return</span>;
03974     }
03975 
03976     <span class="comment">//</span>
03977     <span class="comment">// Make sure the volume name string is null-terminated.</span>
03978     <span class="comment">//</span>
03979 
03980     volumeNameString.Buffer[volumeNameString.Length / <span class="keyword">sizeof</span>(WCHAR)] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
03981 
03982     <span class="comment">//</span>
03983     <span class="comment">// Open HKLM\SYSTEM key.</span>
03984     <span class="comment">//</span>
03985 
03986     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;systemHandle,
03987                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03988                                    &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a21">CmRegistryMachineSystemName</a>,
03989                                    KEY_ALL_ACCESS
03990                                    );
03991 
03992     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03993 <span class="preprocessor">#if DBG</span>
03994 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopStoreSystemPartitionInformation: couldn't open \\REGISTRY\\MACHINE\\SYSTEM - %x\n"</span>, status);
03995 <span class="preprocessor">#endif // DBG</span>
03996 <span class="preprocessor"></span>        <span class="keywordflow">return</span>;
03997     }
03998 
03999     <span class="comment">//</span>
04000     <span class="comment">// Now open/create the setup subkey.</span>
04001     <span class="comment">//</span>
04002 
04003     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Setup"</span>) &lt;= <span class="keyword">sizeof</span>(nameBuffer) );
04004 
04005     nameBuffer[0] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'S'</span>;
04006     nameBuffer[1] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'e'</span>;
04007     nameBuffer[2] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'t'</span>;
04008     nameBuffer[3] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'u'</span>;
04009     nameBuffer[4] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'p'</span>;
04010     nameBuffer[5] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
04011 
04012     nameString.MaximumLength = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Setup"</span>);
04013     nameString.Length        = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Setup"</span>) - <span class="keyword">sizeof</span>(WCHAR);
04014     nameString.Buffer        = nameBuffer;
04015 
04016     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;setupHandle,
04017                                      systemHandle,
04018                                      &amp;nameString,
04019                                      KEY_ALL_ACCESS,
04020                                      REG_OPTION_NON_VOLATILE,
04021                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
04022                                      );
04023 
04024     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(systemHandle);  <span class="comment">// Don't need the handle to the HKLM\System key anymore.</span>
04025 
04026     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04027 <span class="preprocessor">#if DBG</span>
04028 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopStoreSystemPartitionInformation: couldn't open Setup subkey - %x\n"</span>, status);
04029 <span class="preprocessor">#endif // DBG</span>
04030 <span class="preprocessor"></span>        <span class="keywordflow">return</span>;
04031     }
04032 
04033     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SystemPartition"</span>) &lt;= <span class="keyword">sizeof</span>(nameBuffer) );
04034 
04035     nameBuffer[0]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'S'</span>;
04036     nameBuffer[1]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'y'</span>;
04037     nameBuffer[2]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'s'</span>;
04038     nameBuffer[3]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'t'</span>;
04039     nameBuffer[4]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'e'</span>;
04040     nameBuffer[5]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'m'</span>;
04041     nameBuffer[6]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'P'</span>;
04042     nameBuffer[7]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'a'</span>;
04043     nameBuffer[8]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'r'</span>;
04044     nameBuffer[9]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'t'</span>;
04045     nameBuffer[10] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'i'</span>;
04046     nameBuffer[11] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'t'</span>;
04047     nameBuffer[12] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'i'</span>;
04048     nameBuffer[13] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'o'</span>;
04049     nameBuffer[14] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'n'</span>;
04050     nameBuffer[15] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
04051 
04052     nameString.MaximumLength = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SystemPartition"</span>);
04053     nameString.Length        = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SystemPartition"</span>) - <span class="keyword">sizeof</span>(WCHAR);
04054 
04055     
04056   
04057     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(setupHandle,
04058                             &amp;nameString,
04059                             <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
04060                             REG_SZ,
04061                             volumeNameString.Buffer,
04062                             volumeNameString.Length + <span class="keyword">sizeof</span>(WCHAR)
04063                            );
04064     
04065 
04066 <span class="preprocessor">#if DBG</span>
04067 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04068         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopStoreSystemPartitionInformation: couldn't write SystemPartition value - %x\n"</span>, status);
04069     }
04070 <span class="preprocessor">#endif // DBG</span>
04071 <span class="preprocessor"></span>
04072     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"OsLoaderPath"</span>) &lt;= <span class="keyword">sizeof</span>(nameBuffer) );
04073 
04074     nameBuffer[0]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'O'</span>;
04075     nameBuffer[1]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'s'</span>;
04076     nameBuffer[2]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'L'</span>;
04077     nameBuffer[3]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'o'</span>;
04078     nameBuffer[4]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'a'</span>;
04079     nameBuffer[5]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'d'</span>;
04080     nameBuffer[6]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'e'</span>;
04081     nameBuffer[7]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'r'</span>;
04082     nameBuffer[8]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'P'</span>;
04083     nameBuffer[9]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'a'</span>;
04084     nameBuffer[10] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'t'</span>;
04085     nameBuffer[11] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'h'</span>;
04086     nameBuffer[12] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
04087 
04088     nameString.MaximumLength = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"OsLoaderPath"</span>);
04089     nameString.Length        = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"OsLoaderPath"</span>) - <span class="keyword">sizeof</span>(WCHAR);
04090 
04091     <span class="comment">//</span>
04092     <span class="comment">// Strip off the trailing backslash from the path (unless, of course, the path is a</span>
04093     <span class="comment">// single backslash).</span>
04094     <span class="comment">//</span>
04095 
04096     <span class="keywordflow">if</span> ((OsLoaderPathName-&gt;Length &gt; <span class="keyword">sizeof</span>(WCHAR)) &amp;&amp;
04097         (*(PWCHAR)((PCHAR)OsLoaderPathName-&gt;Buffer + OsLoaderPathName-&gt;Length - <span class="keyword">sizeof</span>(WCHAR)) == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>)) {
04098 
04099         OsLoaderPathName-&gt;Length -= <span class="keyword">sizeof</span>(WCHAR);
04100         *(PWCHAR)((PCHAR)OsLoaderPathName-&gt;Buffer + OsLoaderPathName-&gt;Length) = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
04101     }
04102 
04103     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(setupHandle,
04104                            &amp;nameString,
04105                            <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
04106                            REG_SZ,
04107                            OsLoaderPathName-&gt;Buffer,
04108                            OsLoaderPathName-&gt;Length + <span class="keyword">sizeof</span>(WCHAR)
04109                            );
04110 <span class="preprocessor">#if DBG</span>
04111 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04112         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopStoreSystemPartitionInformation: couldn't write OsLoaderPath value - %x\n"</span>, status);
04113     }
04114 <span class="preprocessor">#endif // DBG</span>
04115 <span class="preprocessor"></span>
04116     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(setupHandle);
04117 }
04118 
04119 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>
<a name="l04120"></a><a class="code" href="../../d9/d5/ioinit_8c.html#a30">04120</a> <a class="code" href="../../d9/d5/ioinit_8c.html#a30">IopGetDriverTagPriority</a> (
04121     IN HANDLE ServiceHandle
04122     )
04123 
04124 <span class="comment">/*++</span>
04125 <span class="comment"></span>
04126 <span class="comment">Routine Description:</span>
04127 <span class="comment"></span>
04128 <span class="comment">    This routine reads the Tag value of a driver and determine the tag's priority</span>
04129 <span class="comment">    among its driver group.</span>
04130 <span class="comment"></span>
04131 <span class="comment">Arguments:</span>
04132 <span class="comment"></span>
04133 <span class="comment">    ServiceHandle - specifies the handle of the driver's service key.</span>
04134 <span class="comment"></span>
04135 <span class="comment">Return Value:</span>
04136 <span class="comment"></span>
04137 <span class="comment">    USHORT for priority.</span>
04138 <span class="comment"></span>
04139 <span class="comment">--*/</span>
04140 
04141 {
04142     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04143     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
04144     PKEY_VALUE_FULL_INFORMATION keyValueInformation1;
04145     UNICODE_STRING groupName;
04146     HANDLE handle;
04147     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> index = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) -1;
04148     PULONG groupOrder;
04149     ULONG count, tag;
04150 
04151     <span class="comment">//</span>
04152     <span class="comment">// Open System\CurrentControlSet\Control\GroupOrderList</span>
04153     <span class="comment">//</span>
04154 
04155     PiWstrToUnicodeString(&amp;groupName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\GroupOrderList"</span>);
04156     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
04157                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04158                                    &amp;groupName,
04159                                    KEY_READ
04160                                    );
04161 
04162     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04163         <span class="keywordflow">return</span> index;
04164     }
04165 
04166     <span class="comment">//</span>
04167     <span class="comment">// Read service key's Group value</span>
04168     <span class="comment">//</span>
04169 
04170     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (ServiceHandle,
04171                                   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Group"</span>,
04172                                   &amp;keyValueInformation);
04173     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04174 
04175         <span class="comment">//</span>
04176         <span class="comment">// Try to read what caller wants.</span>
04177         <span class="comment">//</span>
04178 
04179         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_SZ) &amp;&amp;
04180             (keyValueInformation-&gt;DataLength != 0)) {
04181             <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(&amp;groupName,
04182                                            (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
04183                                            keyValueInformation-&gt;DataLength
04184                                            );
04185         }
04186     } <span class="keywordflow">else</span> {
04187 
04188         <span class="comment">//</span>
04189         <span class="comment">// If we failed to read the Group value, or no Group value...</span>
04190         <span class="comment">//</span>
04191 
04192         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(handle);
04193         <span class="keywordflow">return</span> index;
04194     }
04195 
04196     <span class="comment">//</span>
04197     <span class="comment">// Read service key's Tag value</span>
04198     <span class="comment">//</span>
04199 
04200     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (ServiceHandle,
04201                                   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Tag"</span>,
04202                                   &amp;keyValueInformation1);
04203     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04204 
04205         <span class="comment">//</span>
04206         <span class="comment">// Try to read what caller wants.</span>
04207         <span class="comment">//</span>
04208 
04209         <span class="keywordflow">if</span> ((keyValueInformation1-&gt;Type == REG_DWORD) &amp;&amp;
04210             (keyValueInformation1-&gt;DataLength != 0)) {
04211             tag = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation1);
04212         }
04213         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation1);
04214     } <span class="keywordflow">else</span> {
04215 
04216         <span class="comment">//</span>
04217         <span class="comment">// If we failed to read the Group value, or no Group value...</span>
04218         <span class="comment">//</span>
04219 
04220         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
04221         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(handle);
04222         <span class="keywordflow">return</span> index;
04223     }
04224 
04225     <span class="comment">//</span>
04226     <span class="comment">// Read group order list value for the driver's Group</span>
04227     <span class="comment">//</span>
04228 
04229     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (handle,
04230                                   groupName.Buffer,
04231                                   &amp;keyValueInformation1);
04232     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
04233     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(handle);
04234     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04235 
04236         <span class="comment">//</span>
04237         <span class="comment">// Try to read what caller wants.</span>
04238         <span class="comment">//</span>
04239 
04240         <span class="keywordflow">if</span> ((keyValueInformation1-&gt;Type == REG_BINARY) &amp;&amp;
04241             (keyValueInformation1-&gt;DataLength != 0)) {
04242             groupOrder = (PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation1);
04243             count = *groupOrder;
04244             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((count + 1) * <span class="keyword">sizeof</span>(ULONG) &lt;= keyValueInformation1-&gt;DataLength);
04245             groupOrder++;
04246             <span class="keywordflow">for</span> (index = 1; index &lt;= count; index++) {
04247                 <span class="keywordflow">if</span> (tag == *groupOrder) {
04248                     <span class="keywordflow">break</span>;
04249                 } <span class="keywordflow">else</span> {
04250                     groupOrder++;
04251                 }
04252             }
04253         }
04254         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation1);
04255     } <span class="keywordflow">else</span> {
04256 
04257         <span class="comment">//</span>
04258         <span class="comment">// If we failed to read the Group value, or no Group value...</span>
04259         <span class="comment">//</span>
04260 
04261         <span class="keywordflow">return</span> index;
04262     }
04263     <span class="keywordflow">return</span> index;
04264 }
04265 
04266 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04267"></a><a class="code" href="../../d9/d5/ioinit_8c.html#a31">04267</a> <a class="code" href="../../d9/d5/ioinit_8c.html#a31">IopInsertDriverList</a> (
04268     IN PLIST_ENTRY ListHead,
04269     IN PDRIVER_INFORMATION DriverInfo
04270     )
04271 
04272 <span class="comment">/*++</span>
04273 <span class="comment"></span>
04274 <span class="comment">Routine Description:</span>
04275 <span class="comment"></span>
04276 <span class="comment">    This routine reads the Tag value of a driver and determine the tag's priority</span>
04277 <span class="comment">    among its driver group.</span>
04278 <span class="comment"></span>
04279 <span class="comment">Arguments:</span>
04280 <span class="comment"></span>
04281 <span class="comment">    ServiceHandle - specifies the handle of the driver's service key.</span>
04282 <span class="comment"></span>
04283 <span class="comment">Return Value:</span>
04284 <span class="comment"></span>
04285 <span class="comment">    USHORT for priority.</span>
04286 <span class="comment"></span>
04287 <span class="comment">--*/</span>
04288 
04289 {
04290     PLIST_ENTRY nextEntry;
04291     <a class="code" href="../../d9/d5/ioinit_8c.html#a6">PDRIVER_INFORMATION</a> info;
04292 
04293     nextEntry = ListHead-&gt;Flink;
04294     <span class="keywordflow">while</span> (nextEntry != ListHead) {
04295         info = CONTAINING_RECORD(nextEntry, <a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html">DRIVER_INFORMATION</a>, Link);
04296 
04297         <span class="comment">//</span>
04298         <span class="comment">// Scan the driver info list to find the driver whose priority is</span>
04299         <span class="comment">// lower than current driver's.</span>
04300         <span class="comment">// (Lower TagPosition value means higher Priority)</span>
04301         <span class="comment">//</span>
04302 
04303         <span class="keywordflow">if</span> (info-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o4">TagPosition</a> &gt; DriverInfo-&gt;TagPosition) {
04304             <span class="keywordflow">break</span>;
04305         }
04306         nextEntry = nextEntry-&gt;Flink;
04307     }
04308 
04309     <span class="comment">//</span>
04310     <span class="comment">// Insert the Driver info to the front of the nextEntry</span>
04311     <span class="comment">//</span>
04312 
04313     nextEntry = nextEntry-&gt;Blink;
04314     InsertHeadList(nextEntry, &amp;DriverInfo-&gt;Link);
04315 }
04316 
04317 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04318"></a><a class="code" href="../../d9/d5/ioinit_8c.html#a32">04318</a> <a class="code" href="../../d9/d5/ioinit_8c.html#a32">IopNotifySetupDevices</a> (
04319     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode
04320     )
04321 
04322 <span class="comment">/*++</span>
04323 <span class="comment"></span>
04324 <span class="comment">Routine Description:</span>
04325 <span class="comment"></span>
04326 <span class="comment">    This routine notifies setupdd.sys for all the enumerated devices whose</span>
04327 <span class="comment">    service have not been setup.</span>
04328 <span class="comment"></span>
04329 <span class="comment">    This routine only gets executed on textmode setup phase.</span>
04330 <span class="comment"></span>
04331 <span class="comment">Parameters:</span>
04332 <span class="comment"></span>
04333 <span class="comment">    DeviceNode - specifies the root of the subtree to be processed.</span>
04334 <span class="comment"></span>
04335 <span class="comment">Return Value:</span>
04336 <span class="comment"></span>
04337 <span class="comment">    None.</span>
04338 <span class="comment"></span>
04339 <span class="comment">--*/</span>
04340 
04341 {
04342     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>;
04343     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
04344     HANDLE handle;
04345     UNICODE_STRING unicodeString;
04346     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04347     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
04348 
04349     <span class="keywordflow">while</span> (deviceNode) {
04350         <a class="code" href="../../d9/d5/ioinit_8c.html#a32">IopNotifySetupDevices</a>(deviceNode);
04351         <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o14">ServiceName</a>.Length == 0) {
04352 
04353             <span class="comment">//</span>
04354             <span class="comment">// We only notify setupdd the device nodes which do not have service setup yet.</span>
04355             <span class="comment">// It is impossible that at this point, a device has a service setup and</span>
04356             <span class="comment">// setupdd has to change it.</span>
04357             <span class="comment">//</span>
04358 
04359             deviceObject = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>;
04360             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">IopDeviceObjectToDeviceInstance</a>(deviceObject, &amp;handle, KEY_ALL_ACCESS);
04361             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04362 
04363                 <span class="comment">//</span>
04364                 <span class="comment">// Notify setup about the device.</span>
04365                 <span class="comment">//</span>
04366 
04367                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a347">IopNotifySetupDeviceArrival</a>(deviceObject, handle, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04368 
04369                 <span class="comment">//</span>
04370                 <span class="comment">// Finally register the device</span>
04371                 <span class="comment">//</span>
04372 
04373                 status = <a class="code" href="../../d6/d9/pnp_8h.html#a138">PpDeviceRegistration</a>(
04374                              &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>,
04375                              <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
04376                              &amp;unicodeString       <span class="comment">// registered ServiceName</span>
04377                              );
04378 
04379                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04380                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o14">ServiceName</a> = unicodeString;
04381                     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(deviceNode, CM_PROB_NOT_CONFIGURED)) {
04382                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a79">IopClearDevNodeProblem</a>(deviceNode);
04383                     }
04384                 }
04385                 ZwClose(handle);
04386             }
04387         }
04388         deviceNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
04389     }
04390 }
04391 
04392 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04393"></a><a class="code" href="../../d0/d6/iop_8h.html#a227">04393</a> <a class="code" href="../../d0/d6/iop_8h.html#a227">IopLogErrorEvent</a>(
04394     IN ULONG            SequenceNumber,
04395     IN ULONG            UniqueErrorValue,
04396     IN NTSTATUS         FinalStatus,
04397     IN NTSTATUS         SpecificIOStatus,
04398     IN ULONG            LengthOfInsert1,
04399     IN PWCHAR           Insert1,
04400     IN ULONG            LengthOfInsert2,
04401     IN PWCHAR           Insert2
04402     )
04403 
04404 <span class="comment">/*++</span>
04405 <span class="comment"></span>
04406 <span class="comment">Routine Description:</span>
04407 <span class="comment"></span>
04408 <span class="comment">    This routine allocates an error log entry, copies the supplied data</span>
04409 <span class="comment">    to it, and requests that it be written to the error log file.</span>
04410 <span class="comment"></span>
04411 <span class="comment">Arguments:</span>
04412 <span class="comment">    SequenceNumber - A value that is unique to an IRP over the life of the irp in</span>
04413 <span class="comment">    this driver. - 0 generally means an error not associated with an IRP</span>
04414 <span class="comment"></span>
04415 <span class="comment">    UniqueErrorValue - A unique long word that identifies the particular</span>
04416 <span class="comment">    call to this function.</span>
04417 <span class="comment"></span>
04418 <span class="comment">    FinalStatus - The final status given to the irp that was associated</span>
04419 <span class="comment">    with this error.  If this log entry is being made during one of</span>
04420 <span class="comment">    the retries this value will be STATUS_SUCCESS.</span>
04421 <span class="comment"></span>
04422 <span class="comment">    SpecificIOStatus - The IO status for a particular error.</span>
04423 <span class="comment"></span>
04424 <span class="comment">    LengthOfInsert1 - The length in bytes (including the terminating NULL)</span>
04425 <span class="comment">                      of the first insertion string.</span>
04426 <span class="comment"></span>
04427 <span class="comment">    Insert1 - The first insertion string.</span>
04428 <span class="comment"></span>
04429 <span class="comment">    LengthOfInsert2 - The length in bytes (including the terminating NULL)</span>
04430 <span class="comment">                      of the second insertion string.  NOTE, there must</span>
04431 <span class="comment">                      be a first insertion string for their to be</span>
04432 <span class="comment">                      a second insertion string.</span>
04433 <span class="comment"></span>
04434 <span class="comment">    Insert2 - The second insertion string.</span>
04435 <span class="comment"></span>
04436 <span class="comment">Return Value:</span>
04437 <span class="comment"></span>
04438 <span class="comment">    STATUS_SUCCESS - Success</span>
04439 <span class="comment">    STATUS_INVALID_HANDLE - Uninitialized error log device object</span>
04440 <span class="comment">    STATUS_NO_DATA_DETECTED - NULL Error log entry</span>
04441 <span class="comment"></span>
04442 <span class="comment">--*/</span>
04443 
04444 {
04445     PIO_ERROR_LOG_PACKET errorLogEntry;
04446     PUCHAR ptrToFirstInsert;
04447     PUCHAR ptrToSecondInsert;
04448 
04449     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d5/ioinit_8c.html#a8">IopErrorLogObject</a>) {
04450         <span class="keywordflow">return</span>(STATUS_INVALID_HANDLE);
04451     }
04452 
04453 
04454     errorLogEntry = <a class="code" href="../../d4/d6/iosubs_8c.html#a14">IoAllocateErrorLogEntry</a>(
04455                         <a class="code" href="../../d9/d5/ioinit_8c.html#a8">IopErrorLogObject</a>,
04456                         (UCHAR)( <span class="keyword">sizeof</span>(IO_ERROR_LOG_PACKET) +
04457                                 LengthOfInsert1 +
04458                                 LengthOfInsert2) );
04459 
04460    <span class="keywordflow">if</span> ( errorLogEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
04461 
04462       errorLogEntry-&gt;ErrorCode = SpecificIOStatus;
04463       errorLogEntry-&gt;SequenceNumber = SequenceNumber;
04464       errorLogEntry-&gt;MajorFunctionCode = 0;
04465       errorLogEntry-&gt;RetryCount = 0;
04466       errorLogEntry-&gt;UniqueErrorValue = UniqueErrorValue;
04467       errorLogEntry-&gt;FinalStatus = FinalStatus;
04468       errorLogEntry-&gt;DumpDataSize = 0;
04469 
04470       ptrToFirstInsert = (PUCHAR)&amp;errorLogEntry-&gt;DumpData[0];
04471 
04472       ptrToSecondInsert = ptrToFirstInsert + LengthOfInsert1;
04473 
04474       <span class="keywordflow">if</span> (LengthOfInsert1) {
04475 
04476          errorLogEntry-&gt;NumberOfStrings = 1;
04477          errorLogEntry-&gt;StringOffset = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(ptrToFirstInsert -
04478                                                 (PUCHAR)errorLogEntry);
04479          RtlCopyMemory(
04480                       ptrToFirstInsert,
04481                       Insert1,
04482                       LengthOfInsert1
04483                       );
04484 
04485          <span class="keywordflow">if</span> (LengthOfInsert2) {
04486 
04487             errorLogEntry-&gt;NumberOfStrings = 2;
04488             RtlCopyMemory(
04489                          ptrToSecondInsert,
04490                          Insert2,
04491                          LengthOfInsert2
04492                          );
04493 
04494          } <span class="comment">//LenghtOfInsert2</span>
04495 
04496       } <span class="comment">// LenghtOfInsert1</span>
04497 
04498       <a class="code" href="../../d4/d6/iosubs_8c.html#a123">IoWriteErrorLogEntry</a>(errorLogEntry);
04499       <span class="keywordflow">return</span>(STATUS_SUCCESS);
04500 
04501    }  <span class="comment">// errorLogEntry != NULL</span>
04502 
04503     <span class="keywordflow">return</span>(STATUS_NO_DATA_DETECTED);
04504 
04505 } <span class="comment">//IopLogErrorEvent</span>
04506 
04507 BOOLEAN
<a name="l04508"></a><a class="code" href="../../d9/d5/ioinit_8c.html#a33">04508</a> <a class="code" href="../../d9/d5/ioinit_8c.html#a33">IopWaitForBootDevicesStarted</a> (
04509     IN VOID
04510     )
04511 
04512 <span class="comment">/*++</span>
04513 <span class="comment"></span>
04514 <span class="comment">Routine Description:</span>
04515 <span class="comment"></span>
04516 <span class="comment">    This routine waits for enumeration lock to be released for ALL devices.</span>
04517 <span class="comment"></span>
04518 <span class="comment">Arguments:</span>
04519 <span class="comment"></span>
04520 <span class="comment">    None.</span>
04521 <span class="comment"></span>
04522 <span class="comment">Return Value:</span>
04523 <span class="comment"></span>
04524 <span class="comment">    BOOLEAN.</span>
04525 <span class="comment"></span>
04526 <span class="comment">--*/</span>
04527 
04528 {
04529     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
04530     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04531     KIRQL oldIrql;
04532 
04533     <span class="comment">//</span>
04534     <span class="comment">// Wait on IoInvalidateDeviceRelations event to make sure all the devcies are enumerated</span>
04535     <span class="comment">// before progressing to mark boot partitions.</span>
04536     <span class="comment">//</span>
04537 
04538     status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a10">PiEnumerationLock</a>,
04539                                     <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
04540                                     <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
04541                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
04542                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
04543     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04544         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04545     }
04546 
04547     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a24">PnpAsyncOk</a>) {
04548 
04549         <span class="comment">//</span>
04550         <span class="comment">// Perform top-down check to make sure all the devices with Async start and Async Query</span>
04551         <span class="comment">// Device Relations are done.</span>
04552         <span class="comment">//</span>
04553 
04554         deviceNode = <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>;
04555         <span class="keywordflow">for</span> (; ;) {
04556 
04557             ExAcquireSpinLock(&amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a7">IopPnPSpinLock</a>, &amp;oldIrql);
04558 
04559             <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a44">DNF_ASYNC_REQUEST_PENDING</a>) {
04560 
04561                 <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>(&amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a10">PiEnumerationLock</a>);
04562                 ExReleaseSpinLock(&amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a7">IopPnPSpinLock</a>, oldIrql);
04563 
04564                 <span class="comment">//</span>
04565                 <span class="comment">// Wait on PiEnumerationLock to be signaled before proceeding.</span>
04566                 <span class="comment">// At this point if a device node is marked ASYNC request pending,  this</span>
04567                 <span class="comment">// must be an ASYNC start or enumeration which will queue an enumeration</span>
04568                 <span class="comment">// request and once the enumeration completes, the PiEnumerationLock</span>
04569                 <span class="comment">// will be signaled.</span>
04570                 <span class="comment">//</span>
04571 
04572                 status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a10">PiEnumerationLock</a>,
04573                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
04574                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
04575                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
04576                                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
04577                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04578                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04579                 }
04580                 <span class="keywordflow">continue</span>;   <span class="comment">// Make sure this device is done.</span>
04581             } <span class="keywordflow">else</span> {
04582                 ExReleaseSpinLock(&amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a7">IopPnPSpinLock</a>, oldIrql);
04583             }
04584 
04585             <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>) {
04586                 deviceNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>;
04587                 <span class="keywordflow">continue</span>;
04588             }
04589             <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>) {
04590                 deviceNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
04591                 <span class="keywordflow">continue</span>;
04592             }
04593 
04594             <span class="keywordflow">for</span> (; ;) {
04595                 deviceNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>;
04596 
04597                 <span class="comment">//</span>
04598                 <span class="comment">// If that was the last node to check, then exit loop</span>
04599                 <span class="comment">//</span>
04600 
04601                 <span class="keywordflow">if</span> (deviceNode == <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) {
04602                     <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
04603                 }
04604                 <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>) {
04605                     deviceNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
04606                     <span class="keywordflow">break</span>;
04607                 }
04608             }
04609         }
04610     <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
04611         ;
04612     }
04613     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04614 }
04615 
04616 BOOLEAN
<a name="l04617"></a><a class="code" href="../../d9/d5/ioinit_8c.html#a34">04617</a> <a class="code" href="../../d9/d5/ioinit_8c.html#a34">IopWaitForBootDevicesDeleted</a> (
04618     IN VOID
04619     )
04620 
04621 <span class="comment">/*++</span>
04622 <span class="comment"></span>
04623 <span class="comment">Routine Description:</span>
04624 <span class="comment"></span>
04625 <span class="comment">    This routine waits for IoRequestDeviceRemoval to be completed.</span>
04626 <span class="comment"></span>
04627 <span class="comment">Arguments:</span>
04628 <span class="comment"></span>
04629 <span class="comment">    None.</span>
04630 <span class="comment"></span>
04631 <span class="comment">Return Value:</span>
04632 <span class="comment"></span>
04633 <span class="comment">    BOOLEAN.</span>
04634 <span class="comment"></span>
04635 <span class="comment">--*/</span>
04636 
04637 {
04638     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04639 
04640     <span class="comment">//</span>
04641     <span class="comment">// Wait on device removal event to make sure all the deleted devcies are processed</span>
04642     <span class="comment">// before moving on to process next boot driver.</span>
04643     <span class="comment">//</span>
04644 
04645     status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a9">PiEventQueueEmpty</a>,
04646                                     <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
04647                                     <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
04648                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
04649                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
04650     <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status);
04651 }
04652 
04653 <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>
<a name="l04654"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a327">04654</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a327">IopLoadBootFilterDriver</a> (
04655     IN PUNICODE_STRING DriverName,
04656     IN ULONG GroupIndex
04657     )
04658 
04659 <span class="comment">/*++</span>
04660 <span class="comment"></span>
04661 <span class="comment">Routine Description:</span>
04662 <span class="comment"></span>
04663 <span class="comment">    This initializes boot filter drivers.</span>
04664 <span class="comment"></span>
04665 <span class="comment">Arguments:</span>
04666 <span class="comment"></span>
04667 <span class="comment">    DriverName - specifies the name of the driver to be initialized.</span>
04668 <span class="comment"></span>
04669 <span class="comment">    GroupIndex - specifies the Driver's group index (could be anything)</span>
04670 <span class="comment"></span>
04671 <span class="comment">Return Value:</span>
04672 <span class="comment"></span>
04673 <span class="comment">    PDRIVER_OBJECT</span>
04674 <span class="comment"></span>
04675 <span class="comment">--*/</span>
04676 
04677 {
04678     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04679     PLIST_ENTRY nextEntry;
04680     <a class="code" href="../../d9/d5/ioinit_8c.html#a6">PDRIVER_INFORMATION</a> driverInfo;
04681     UNICODE_STRING completeName;
04682     <a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html">PBOOT_DRIVER_LIST_ENTRY</a> bootDriver;
04683     PLDR_DATA_TABLE_ENTRY driverEntry;
04684     HANDLE keyHandle;
04685     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04686 
04687     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/ioinit_8c.html#a10">IopGroupTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || GroupIndex &gt;= <a class="code" href="../../d9/d5/ioinit_8c.html#a9">IopGroupIndex</a>) {
04688 
04689         <span class="comment">//</span>
04690         <span class="comment">// If we have not reached the boot driver initialization phase or</span>
04691         <span class="comment">// the filter driver is not a boot driver.</span>
04692         <span class="comment">//</span>
04693 
04694         <span class="keywordflow">return</span> driverObject;
04695     }
04696 
04697     <span class="comment">//</span>
04698     <span class="comment">// Go thru every driver that we initialized.  If it supports AddDevice entry and</span>
04699     <span class="comment">// did not create any device object after we start it.  We mark it as failure so</span>
04700     <span class="comment">// text mode setup knows this driver is not needed.</span>
04701     <span class="comment">//</span>
04702 
04703     nextEntry = <a class="code" href="../../d9/d5/ioinit_8c.html#a10">IopGroupTable</a>[GroupIndex].Flink;
04704     <span class="keywordflow">while</span> (nextEntry != &amp;<a class="code" href="../../d9/d5/ioinit_8c.html#a10">IopGroupTable</a>[GroupIndex]) {
04705 
04706         driverInfo = CONTAINING_RECORD(nextEntry, <a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html">DRIVER_INFORMATION</a>, Link);
04707         <span class="keywordflow">if</span> (driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o6">Processed</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04708 
04709             keyHandle = driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o3">ServiceHandle</a>;
04710 
04711             status = <a class="code" href="../../d0/d6/iop_8h.html#a175">IopGetDriverNameFromKeyNode</a>( keyHandle,
04712                                                   &amp;completeName );
04713             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04714                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(DriverName,
04715                                           &amp;completeName,
04716                                           <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {    <span class="comment">// case-insensitive</span>
04717 
04718                     bootDriver = driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o2">DataTableEntry</a>;
04719                     driverEntry = bootDriver-&gt;<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o3">LdrEntry</a>;
04720 
04721                     driverObject = <a class="code" href="../../d9/d5/ioinit_8c.html#a23">IopInitializeBuiltinDriver</a>(
04722                                        &amp;completeName,
04723                                        &amp;bootDriver-&gt;<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o2">RegistryPath</a>,
04724                                        (<a class="code" href="../../d0/d5/io_8h.html#a284">PDRIVER_INITIALIZE</a>) driverEntry-&gt;EntryPoint,
04725                                        driverEntry,
04726                                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04727                     driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o1">DriverObject</a> = driverObject;
04728                     driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o6">Processed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04729                     <span class="comment">//</span>
04730                     <span class="comment">// Pnp might unload the driver before we get a chance to look at this. So take an extra</span>
04731                     <span class="comment">// reference.</span>
04732                     <span class="comment">//</span>
04733                     <span class="keywordflow">if</span> (driverObject) {
04734                         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(driverObject);
04735                     }
04736                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(completeName.Buffer);
04737                     <span class="keywordflow">break</span>;
04738                 }
04739                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(completeName.Buffer);
04740             }
04741         }
04742 
04743         nextEntry = nextEntry-&gt;Flink;
04744     }
04745     <span class="keywordflow">return</span> driverObject;
04746 }
04747 <span class="preprocessor">#if 0</span>
04748 <span class="preprocessor"></span>
04749 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
04750 IopCheckClassFiltersForBootDevice (
04751     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode
04752     )
04753 
04754 <span class="comment">/*++</span>
04755 <span class="comment"></span>
04756 <span class="comment">Routine Description:</span>
04757 <span class="comment"></span>
04758 <span class="comment">    This routine notifies setupdd.sys for all the enumerated devices whose</span>
04759 <span class="comment">    service have not been setup.</span>
04760 <span class="comment"></span>
04761 <span class="comment">    This routine only gets executed on textmode setup phase.</span>
04762 <span class="comment"></span>
04763 <span class="comment">Parameters:</span>
04764 <span class="comment"></span>
04765 <span class="comment">    DeviceNode - specifies the root of the subtree to be processed.</span>
04766 <span class="comment"></span>
04767 <span class="comment">Return Value:</span>
04768 <span class="comment"></span>
04769 <span class="comment">    None.</span>
04770 <span class="comment"></span>
04771 <span class="comment">--*/</span>
04772 
04773 {
04774     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
04775     HANDLE handle;
04776     UNICODE_STRING unicodeString, unicodeName;
04777     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04778     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
04779 
04780     <span class="keywordflow">if</span> (DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o14">ServiceName</a>.Length != 0) {
04781 
04782         deviceObject = DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>;
04783         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">IopDeviceObjectToDeviceInstance</a>(deviceObject, &amp;handle, KEY_ALL_ACCESS);
04784         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04785 
04786             <span class="comment">//</span>
04787             <span class="comment">// Check if Class GUID is present.  If yes, add the device</span>
04788             <span class="comment">// instance to its Class Filters' service keys such that the class filter</span>
04789             <span class="comment">// drivers can stay around.</span>
04790             <span class="comment">//</span>
04791 
04792             <span class="comment">//</span>
04793             <span class="comment">// Get the class value to locate the class key for this devnode</span>
04794             <span class="comment">//</span>
04795 
04796             status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(handle,
04797                                          REGSTR_VALUE_CLASSGUID,
04798                                          &amp;keyValueInformation);
04799 
04800             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp;
04801                 ((keyValueInformation-&gt;Type == REG_SZ) &amp;&amp; (keyValueInformation-&gt;DataLength != 0))) {
04802 
04803                 HANDLE controlKey, classKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04804                 UNICODE_STRING unicodeClassGuid;
04805                 RTL_QUERY_REGISTRY_TABLE queryTable[2];
04806 
04807                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(
04808                     &amp;unicodeClassGuid,
04809                     (PWSTR) <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
04810                     keyValueInformation-&gt;DataLength);
04811 
04812                 <span class="comment">//</span>
04813                 <span class="comment">// Open the class key</span>
04814                 <span class="comment">//</span>
04815 
04816                 status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;controlKey,
04817                                                NULL,
04818                                                &amp;CmRegistryMachineSystemCurrentControlSetControlClass,
04819                                                KEY_READ
04820                                                );
04821 
04822                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04823                     classKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04824                 } <span class="keywordflow">else</span> {
04825                     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;classKey,
04826                                                    controlKey,
04827                                                    &amp;unicodeClassGuid,
04828                                                    KEY_READ
04829                                                    );
04830 
04831                     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(controlKey);
04832                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04833                         classKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04834                     }
04835                 }
04836                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
04837 
04838                 <span class="keywordflow">if</span> (classKey) {
04839 
04840                     RTL_QUERY_REGISTRY_TABLE queryTable;
04841 
04842                     RtlZeroMemory(&amp;queryTable, <span class="keyword">sizeof</span>(queryTable));
04843 
04844                     queryTable.QueryRoutine =
04845                         (PRTL_QUERY_REGISTRY_ROUTINE) IopAddDeviceInstanceForClassFilters;
04846                     queryTable.Name = REGSTR_VAL_LOWERFILTERS;
04847                     <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a19">RtlQueryRegistryValues</a>(RTL_REGISTRY_HANDLE,
04848                                            (PWSTR) classKey,
04849                                            &amp;queryTable,
04850                                            &amp;deviceNode-&gt;InstancePath,
04851                                            NULL);
04852 
04853                     queryTable.QueryRoutine =
04854                         (PRTL_QUERY_REGISTRY_ROUTINE) IopAddDeviceInstanceForClassFilters;
04855                     queryTable.Name = REGSTR_VAL_UPPERFILTERS;
04856                     <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a19">RtlQueryRegistryValues</a>(RTL_REGISTRY_HANDLE,
04857                                            (PWSTR) classKey,
04858                                            &amp;queryTable,
04859                                            &amp;deviceNode-&gt;InstancePath,
04860                                            NULL);
04861                     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(classKey);
04862                 }
04863             }
04864 
04865             ZwClose(handle);
04866         }
04867     }
04868 }
04869 
04870 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
04871 IopAddDeviceInstanceForClassFilters(
04872     IN PWSTR ValueName,
04873     IN ULONG ValueType,
04874     IN PWCHAR ValueData,
04875     IN ULONG ValueLength,
04876     IN PUNICODE_STRING DeviceInstancePath,
04877     IN ULONG notUse
04878     )
04879 
04880 <span class="comment">/*++</span>
04881 <span class="comment"></span>
04882 <span class="comment">Routine Description:</span>
04883 <span class="comment"></span>
04884 <span class="comment">    This routine add a device instance path to the service's enum subkey.</span>
04885 <span class="comment"></span>
04886 <span class="comment">Arguments:</span>
04887 <span class="comment"></span>
04888 <span class="comment">    ValueName - the name of the value</span>
04889 <span class="comment"></span>
04890 <span class="comment">    ValueType - the type of the value</span>
04891 <span class="comment"></span>
04892 <span class="comment">    ValueData - the data in the value (unicode string data)</span>
04893 <span class="comment"></span>
04894 <span class="comment">    ValueLength - the number of bytes in the value data</span>
04895 <span class="comment"></span>
04896 <span class="comment">    Context - a structure which contains the device node, the context passed</span>
04897 <span class="comment">              to IopCallDriverAddDevice and the driver lists for the device</span>
04898 <span class="comment">              node.</span>
04899 <span class="comment"></span>
04900 <span class="comment">    EntryContext - the index of the driver list the routine should append</span>
04901 <span class="comment">                   nodes to.</span>
04902 <span class="comment"></span>
04903 <span class="comment">Return Value:</span>
04904 <span class="comment"></span>
04905 <span class="comment">    STATUS_SUCCESS if the driver was located and added to the list</span>
04906 <span class="comment">    successfully or if there was a non-fatal error while handling the</span>
04907 <span class="comment">    driver.</span>
04908 <span class="comment"></span>
04909 <span class="comment">    an error value indicating why the driver could not be added to the list.</span>
04910 <span class="comment"></span>
04911 <span class="comment">--*/</span>
04912 
04913 {
04914     UNICODE_STRING serviceName;
04915     UNICODE_STRING matchingDeviceInstance;
04916     UNICODE_STRING unicodeString;
04917     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> unicodeBuffer[20];
04918     HANDLE serviceEnumHandle;
04919     ULONG count;
04920     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04921 
04922     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;serviceName, ValueData);
04923     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a>(&amp;serviceName,
04924                                     KEY_ALL_ACCESS,
04925                                     NULL,
04926                                     &amp;serviceEnumHandle,
04927                                     TRUE
04928                                    );
04929     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04930         <span class="keywordflow">return</span> STATUS_SUCCESS;
04931     }
04932 
04933     <span class="comment">//</span>
04934     <span class="comment">// Now, search through the service's existing list of device instances, to see</span>
04935     <span class="comment">// if this instance has previously been registered.</span>
04936     <span class="comment">//</span>
04937 
04938     status = PiFindDevInstMatch(serviceEnumHandle,
04939                                 DeviceInstancePath,
04940                                 &amp;count,
04941                                 &amp;matchingDeviceInstance);
04942 
04943     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04944         <span class="keywordflow">return</span> STATUS_SUCCESS;
04945     }
04946 
04947     <span class="keywordflow">if</span> (!matchingDeviceInstance.Buffer) {
04948 
04949         <span class="comment">//</span>
04950         <span class="comment">// Create the value entry and update NextInstance= for the madeup key</span>
04951         <span class="comment">//</span>
04952 
04953         PiUlongToUnicodeString(&amp;unicodeString, unicodeBuffer, 20, count);
04954         status = ZwSetValueKey(
04955                     serviceEnumHandle,
04956                     &amp;unicodeString,
04957                     TITLE_INDEX_VALUE,
04958                     REG_SZ,
04959                     DeviceInstancePath-&gt;Buffer,
04960                     DeviceInstancePath-&gt;Length
04961                     );
04962         count++;
04963         PiWstrToUnicodeString(&amp;unicodeString, REGSTR_VALUE_COUNT);
04964         ZwSetValueKey(
04965                 serviceEnumHandle,
04966                 &amp;unicodeString,
04967                 TITLE_INDEX_VALUE,
04968                 REG_DWORD,
04969                 &amp;count,
04970                 <span class="keyword">sizeof</span>(count)
04971                 );
04972         PiWstrToUnicodeString(&amp;unicodeString, REGSTR_VALUE_NEXT_INSTANCE);
04973         ZwSetValueKey(
04974                 serviceEnumHandle,
04975                 &amp;unicodeString,
04976                 TITLE_INDEX_VALUE,
04977                 REG_DWORD,
04978                 &amp;count,
04979                 <span class="keyword">sizeof</span>(count)
04980                 );
04981     } <span class="keywordflow">else</span> {
04982         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;matchingDeviceInstance);
04983     }
04984     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(serviceEnumHandle);
04985     <span class="keywordflow">return</span> STATUS_SUCCESS;
04986 }
04987 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:29 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
