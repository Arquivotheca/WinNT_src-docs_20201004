<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: adtlog.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>adtlog.c File Reference</h1><code>#include &lt;nt.h&gt;</code><br>
<code>#include &lt;<a class="el" href="../../d0/d8/ntos_8h-source.html">ntos.h</a>&gt;</code><br>
<code>#include &lt;zwapi.h&gt;</code><br>
<code>#include "<a class="el" href="../../d7/d5/sep_8h-source.html">sep.h</a>"</code><br>
<code>#include "sertlp.h"</code><br>
<code>#include "<a class="el" href="../../d8/d3/adt_8h-source.html">adt.h</a>"</code><br>
<code>#include "<a class="el" href="../../d2/d4/adtp_8h-source.html">adtp.h</a>"</code><br>
<code>#include "<a class="el" href="../../d2/d9/rmp_8h-source.html">rmp.h</a>"</code><br>

<p>
<a href="../../d1/d4/adtlog_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/adtlog_8c.html#a0">SepAdtLogAuditRecord</a> (IN PSE_ADT_PARAMETER_ARRAY AuditParameters)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/adtlog_8c.html#a1">SepAuditFailed</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/adtlog_8c.html#a2">SepAdtMarshallAuditRecord</a> (IN PSE_ADT_PARAMETER_ARRAY AuditParameters, OUT PSE_ADT_PARAMETER_ARRAY *MarshalledAuditParameters, OUT PSEP_RM_LSA_MEMORY_TYPE RecordMemoryType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/adtlog_8c.html#a3">SepAdtSetAuditLogInformation</a> (IN PPOLICY_AUDIT_LOG_INFO AuditLogInformation)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/adtlog_8c.html#a4">SepAdtCopyToLsaSharedMemory</a> (IN HANDLE LsaProcessHandle, IN PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN ULONG BufferLength, OUT PVOID *LsaBufferAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/adtlog_8c.html#a5">SepQueueWorkItem</a> (IN <a class="el" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html">PSEP_LSA_WORK_ITEM</a> LsaWorkItem, IN BOOLEAN ForceQueue)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html">PSEP_LSA_WORK_ITEM</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/adtlog_8c.html#a6">SepDequeueWorkItem</a> (VOID)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a4" doxytag="adtlog.c::SepAdtCopyToLsaSharedMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SepAdtCopyToLsaSharedMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>LsaProcessHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>LsaBufferAddress</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/adtlog_8c-source.html#l00504">504</a> of file <a class="el" href="../../d1/d4/adtlog_8c-source.html">adtlog.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d1/d9/rmmain_8c-source.html#l00907">SepRmCallLsa()</a>.
<p>
<pre class="fragment"><div>00513                    :
00514 
00515     This function allocates memory shared with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LSA and optionally copies
00516     a given buffer to <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
00517 
00518 Arguments:
00519 
00520     LsaProcessHandle - Specifies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lsa Process.
00521 
00522     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer to be copied.
00523 
00524     BufferLength - Length of buffer.
00525 
00526     LsaBufferAddress - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer valid in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00527         Lsa process context.
00528 
00529 Return Value:
00530 
00531     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Standard Nt Result Code
00532 
00533         Result codes returned by called <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a>.
00534 --*/
00535 
00536 {
00537     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, SecondaryStatus;
00538     PVOID OutputLsaBufferAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00539     SIZE_T RegionSize = BufferLength;
00540 
00541     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00542 
00543     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory(
00544                  LsaProcessHandle,
00545                  &amp;OutputLsaBufferAddress,
00546                  0,
00547                  &amp;RegionSize,
00548                  MEM_COMMIT,
00549                  PAGE_READWRITE
00550                  );
00551 
00552     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00553 
00554         <span class="keywordflow">goto</span> CopyToLsaSharedMemoryError;
00555     }
00556 
00557     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwWriteVirtualMemory(
00558                  LsaProcessHandle,
00559                  OutputLsaBufferAddress,
00560                  Buffer,
00561                  BufferLength,
00562                  NULL
00563                  );
00564 
00565     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00566 
00567         <span class="keywordflow">goto</span> CopyToLsaSharedMemoryError;
00568     }
00569 
00570     *LsaBufferAddress = OutputLsaBufferAddress;
00571     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00572 
00573 CopyToLsaSharedMemoryError:
00574 
00575     <span class="comment">//</span>
00576     <span class="comment">// If we allocated memory, free it.</span>
00577     <span class="comment">//</span>
00578 
00579     <span class="keywordflow">if</span> (OutputLsaBufferAddress != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00580 
00581         RegionSize = 0;
00582 
00583         SecondaryStatus = ZwFreeVirtualMemory(
00584                               LsaProcessHandle,
00585                               &amp;OutputLsaBufferAddress,
00586                               &amp;RegionSize,
00587                               MEM_RELEASE
00588                               );
00589 
00590         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(SecondaryStatus));
00591 
00592         OutputLsaBufferAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00593     }
00594 
00595     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00596 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="adtlog.c::SepAdtLogAuditRecord" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepAdtLogAuditRecord           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSE_ADT_PARAMETER_ARRAY&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>AuditParameters</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/adtlog_8c-source.html#l00052">52</a> of file <a class="el" href="../../d1/d4/adtlog_8c-source.html">adtlog.c</a>.
<p>
References <a class="el" href="../../d7/d5/sep_8h-source.html#l00364">_SEP_LSA_WORK_ITEM::CleanupFunction</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00354">_SEP_LSA_WORK_ITEM::CommandNumber</a>, <a class="el" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o5">_SEP_LSA_WORK_ITEM::CommandParams</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00355">_SEP_LSA_WORK_ITEM::CommandParamsLength</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00330">_SEP_LSA_WORK_ITEM::CommandParamsMemoryType</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00356">_SEP_LSA_WORK_ITEM::ReplyBuffer</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00357">_SEP_LSA_WORK_ITEM::ReplyBufferLength</a>, <a class="el" href="../../d6/d6/sep_8h.html#a27">SEP_LSA_WORK_ITEM</a>, <a class="el" href="../../d1/d4/adtlog_8c-source.html#l00264">SepAdtMarshallAuditRecord()</a>, <a class="el" href="../../d1/d4/adtlog_8c-source.html#l00153">SepAuditFailed()</a>, <a class="el" href="../../d6/d6/sep_8h.html#a77a34">SepAuditRecord</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00077">SepCrashOnAuditFail</a>, <a class="el" href="../../d1/d4/adtlog_8c-source.html#l00600">SepQueueWorkItem()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00336">_SEP_LSA_WORK_ITEM::Tag</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02573">SeAuditHandleDuplication()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02466">SeAuditProcessCreation()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02653">SeAuditProcessExit()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01312">SepAdtCloseObjectAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01465">SepAdtDeleteObjectAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02717">SepAdtGenerateDiscardAudit()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01794">SepAdtHandleAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01907">SepAdtObjectReferenceAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00571">SepAdtOpenObjectAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01003">SepAdtOpenObjectForDeleteAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00346">SepAdtPrivilegedServiceAuditAlarm()</a>, and <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00125">SepAdtPrivilegeObjectAuditAlarm()</a>.
<p>
<pre class="fragment"><div>00058                    :
00059 
00060     This function manages <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> logging of Audit Records.  It provides <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00061     single interface to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Audit Logging component from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Audit/Alarm
00062     generation <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a>.  The function constructs an Audit Record in
00063     <span class="keyword">self</span>-relative <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information provided and appends <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> to
00064     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Audit Record Queue, a doubly-linked list of Audit Records awaiting
00065     output to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Audit Log.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> dedicated thread reads <span class="keyword">this</span> queue, writing
00066     Audit Records to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Audit Log and removing them from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Audit Queue.
00067 
00068 Arguments:
00069 
00070     AuditEventType - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Audit <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> described by
00071         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> audit information provided.
00072 
00073     AuditInformation - Pointer to buffer containing captured auditing
00074         information related to an Audit <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> AuditEventType.
00075 
00076 Return Value:
00077 
00078     STATUS_SUCCESS
00079     STATUS_UNSUCCESSFUL - Audit record was not queued
00080     STATUS_INSUFFICIENT_RESOURCES - unable to allocate heap
00081 
00082 --*/
00083 
00084 {
00085     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00086     <a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html">PSEP_LSA_WORK_ITEM</a> AuditWorkItem;
00087 
00088     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00089 
00090     AuditWorkItem = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, <span class="keyword">sizeof</span>( <a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html">SEP_LSA_WORK_ITEM</a> ), 'iAeS' );
00091 
00092     <span class="keywordflow">if</span> ( AuditWorkItem == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00093 
00094         <a class="code" href="../../d1/d5/adtp_8h.html#a31">SepAuditFailed</a>();
00095         <span class="keywordflow">return</span>;
00096     }
00097 
00098     AuditWorkItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o2">Tag</a> = <a class="code" href="../../d6/d6/sep_8h.html#a77a34">SepAuditRecord</a>;
00099     AuditWorkItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o6">CommandNumber</a> = LsapWriteAuditMessageCommand;
00100     AuditWorkItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o8">ReplyBuffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00101     AuditWorkItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o9">ReplyBufferLength</a> = 0;
00102     AuditWorkItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o10">CleanupFunction</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00103 
00104     <span class="comment">//</span>
00105     <span class="comment">// Build an Audit record in self-relative format from the supplied</span>
00106     <span class="comment">// Audit Information.</span>
00107     <span class="comment">//</span>
00108 
00109     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d5/adtp_8h.html#a18">SepAdtMarshallAuditRecord</a>(
00110                  AuditParameters,
00111                  (PSE_ADT_PARAMETER_ARRAY *) &amp;AuditWorkItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o5">CommandParams</a>.BaseAddress,
00112                  &amp;AuditWorkItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o1">CommandParamsMemoryType</a>
00113                  );
00114 
00115     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00116 
00117         <span class="comment">//</span>
00118         <span class="comment">// Extract the length of the Audit Record.  Store it as the length</span>
00119         <span class="comment">// of the Command Parameters buffer.</span>
00120         <span class="comment">//</span>
00121 
00122         AuditWorkItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o7">CommandParamsLength</a> =
00123             ((PSE_ADT_PARAMETER_ARRAY) AuditWorkItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o5">CommandParams</a>.BaseAddress)-&gt;Length;
00124 
00125         <span class="comment">//</span>
00126         <span class="comment">// If we're going to crash on a discarded audit, ignore the queue bounds</span>
00127         <span class="comment">// check and force the item onto the queue.</span>
00128         <span class="comment">//</span>
00129 
00130         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/sep_8h.html#a68">SepQueueWorkItem</a>( AuditWorkItem, (BOOLEAN)(SepCrashOnAuditFail ? TRUE : FALSE) )) {
00131 
00132             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( AuditWorkItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o5">CommandParams</a>.BaseAddress );
00133             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( AuditWorkItem );
00134 
00135             <span class="comment">//</span>
00136             <span class="comment">// We failed to put the record on the queue.  Take whatever action is</span>
00137             <span class="comment">// appropriate.</span>
00138             <span class="comment">//</span>
00139 
00140             <a class="code" href="../../d1/d5/adtp_8h.html#a31">SepAuditFailed</a>();
00141         }
00142 
00143     } <span class="keywordflow">else</span> {
00144 
00145         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( AuditWorkItem );
00146         <a class="code" href="../../d1/d5/adtp_8h.html#a31">SepAuditFailed</a>();
00147     }
00148 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="adtlog.c::SepAdtMarshallAuditRecord" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SepAdtMarshallAuditRecord           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSE_ADT_PARAMETER_ARRAY&nbsp;</td>
          <td class="mdname" nowrap> <em>AuditParameters</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSE_ADT_PARAMETER_ARRAY *&nbsp;</td>
          <td class="mdname" nowrap> <em>MarshalledAuditParameters</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSEP_RM_LSA_MEMORY_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>RecordMemoryType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/adtlog_8c-source.html#l00264">264</a> of file <a class="el" href="../../d1/d4/adtlog_8c-source.html">adtlog.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, and <a class="el" href="../../d1/d1/usrbench_8h-source.html#l00230">SourceString</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/adtlog_8c-source.html#l00052">SepAdtLogAuditRecord()</a>.
<p>
<pre class="fragment"><div>00272                    :
00273 
00274     This routine will take an AuditParamters structure and create
00275     a <span class="keyword">new</span> AuditParameters structure that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> suitable <span class="keywordflow">for</span> sending
00276     to LSA.  It will be in <span class="keyword">self</span>-relative form and allocated as
00277     a single chunk of memory.
00278 
00279 Arguments:
00280 
00281 
00282     AuditParameters - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> filled in set of AuditParameters to be marshalled.
00283 
00284     MarshalledAuditParameters - Returns a pointer to a block of heap memory
00285         containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed AuditParameters in <span class="keyword">self</span>-relative form suitable
00286         <span class="keywordflow">for</span> passing to LSA.
00287 
00288 
00289 Return Value:
00290 
00291     None.
00292 
00293 --*/
00294 
00295 {
00296     ULONG i;
00297     ULONG TotalSize = <span class="keyword">sizeof</span>( SE_ADT_PARAMETER_ARRAY );
00298     PUNICODE_STRING TargetString;
00299     PCHAR Base;
00300     ULONG BaseIncr;
00301 
00302     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00303 
00304     <span class="comment">//</span>
00305     <span class="comment">// Calculate the total size required for the passed AuditParameters</span>
00306     <span class="comment">// block.  This calculation will probably be an overestimate of the</span>
00307     <span class="comment">// amount of space needed, because data smaller that 2 dwords will</span>
00308     <span class="comment">// be stored directly in the parameters structure, but their length</span>
00309     <span class="comment">// will be counted here anyway.  The overestimate can't be more than</span>
00310     <span class="comment">// 24 dwords, and will never even approach that amount, so it isn't</span>
00311     <span class="comment">// worth the time it would take to avoid it.</span>
00312     <span class="comment">//</span>
00313 
00314     <span class="keywordflow">for</span> (i=0; i&lt;AuditParameters-&gt;ParameterCount; i++) {
00315         TotalSize += (ULONG)LongAlignSize(AuditParameters-&gt;Parameters[i].Length);
00316     }
00317 
00318     <span class="comment">//</span>
00319     <span class="comment">// Allocate a big enough block of memory to hold everything.</span>
00320     <span class="comment">// If it fails, quietly abort, since there isn't much else we</span>
00321     <span class="comment">// can do.</span>
00322     <span class="comment">//</span>
00323 
00324     *MarshalledAuditParameters = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, TotalSize, 'pAeS' );
00325 
00326     <span class="keywordflow">if</span> (*MarshalledAuditParameters == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00327 
00328         *RecordMemoryType = SepRmNoMemory;
00329         <span class="keywordflow">return</span>(STATUS_INSUFFICIENT_RESOURCES);
00330     }
00331 
00332     *RecordMemoryType = SepRmPagedPoolMemory;
00333 
00334     RtlCopyMemory (
00335        *MarshalledAuditParameters,
00336        AuditParameters,
00337        <span class="keyword">sizeof</span>( SE_ADT_PARAMETER_ARRAY )
00338        );
00339 
00340    (*MarshalledAuditParameters)-&gt;Length = TotalSize;
00341    (*MarshalledAuditParameters)-&gt;Flags  = SE_ADT_PARAMETERS_SELF_RELATIVE;
00342 
00343     <span class="comment">//</span>
00344     <span class="comment">// Start walking down the list of parameters and marshall them</span>
00345     <span class="comment">// into the target buffer.</span>
00346     <span class="comment">//</span>
00347 
00348     Base = (PCHAR) ((PCHAR)(*MarshalledAuditParameters) + <span class="keyword">sizeof</span>( SE_ADT_PARAMETER_ARRAY ));
00349 
00350     <span class="keywordflow">for</span> (i=0; i&lt;AuditParameters-&gt;ParameterCount; i++) {
00351 
00352 
00353         <span class="keywordflow">switch</span> (AuditParameters-&gt;Parameters[i].Type) {
00354             <span class="keywordflow">case</span> SeAdtParmTypeNone:
00355             <span class="keywordflow">case</span> SeAdtParmTypeUlong:
00356             <span class="keywordflow">case</span> SeAdtParmTypeLogonId:
00357             <span class="keywordflow">case</span> SeAdtParmTypeNoLogonId:
00358             <span class="keywordflow">case</span> SeAdtParmTypeAccessMask:
00359                 {
00360                     <span class="comment">//</span>
00361                     <span class="comment">// Nothing to do for this</span>
00362                     <span class="comment">//</span>
00363 
00364                     <span class="keywordflow">break</span>;
00365 
00366                 }
00367             <span class="keywordflow">case</span> SeAdtParmTypeString:
00368             <span class="keywordflow">case</span> SeAdtParmTypeFileSpec:
00369                 {
00370                     PUNICODE_STRING <a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>;
00371                     <span class="comment">//</span>
00372                     <span class="comment">// We must copy the body of the unicode string</span>
00373                     <span class="comment">// and then copy the body of the string.  Pointers</span>
00374                     <span class="comment">// must be turned into offsets.</span>
00375 
00376                     TargetString = (PUNICODE_STRING)Base;
00377 
00378                     <a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a> = AuditParameters-&gt;Parameters[i].Address;
00379 
00380                     *TargetString = *<a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>;
00381 
00382                     <span class="comment">//</span>
00383                     <span class="comment">// Reset the data pointer in the output parameters to</span>
00384                     <span class="comment">// 'point' to the new string structure.</span>
00385                     <span class="comment">//</span>
00386 
00387                     (*MarshalledAuditParameters)-&gt;Parameters[i].Address = Base - (ULONG_PTR)(*MarshalledAuditParameters);
00388 
00389                     Base += <span class="keyword">sizeof</span>( UNICODE_STRING );
00390 
00391                     RtlCopyMemory( Base, <a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>-&gt;Buffer, <a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>-&gt;Length );
00392 
00393                     <span class="comment">//</span>
00394                     <span class="comment">// Make the string buffer in the target string point to where we</span>
00395                     <span class="comment">// just copied the data.</span>
00396                     <span class="comment">//</span>
00397 
00398                     TargetString-&gt;Buffer = (PWSTR)(Base - (ULONG_PTR)(*MarshalledAuditParameters));
00399 
00400                     BaseIncr = (ULONG)LongAlignSize(<a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>-&gt;Length);
00401 
00402                     Base += BaseIncr;
00403 
00404                     <span class="keywordflow">break</span>;
00405                 }
00406 
00407             <span class="comment">//</span>
00408             <span class="comment">// Handle types where we simply copy the buffer.</span>
00409             <span class="comment">//</span>
00410             <span class="keywordflow">case</span> SeAdtParmTypeSid:
00411             <span class="keywordflow">case</span> SeAdtParmTypePrivs:
00412             <span class="keywordflow">case</span> SeAdtParmTypeObjectTypes:
00413                 {
00414                     <span class="comment">//</span>
00415                     <span class="comment">// Copy the data into the output buffer</span>
00416                     <span class="comment">//</span>
00417 
00418                     RtlCopyMemory( Base,
00419                                    AuditParameters-&gt;Parameters[i].Address,
00420                                    AuditParameters-&gt;Parameters[i].Length );
00421 
00422                     <span class="comment">//</span>
00423                     <span class="comment">// Reset the 'address' of the data to be its offset in the</span>
00424                     <span class="comment">// buffer.</span>
00425                     <span class="comment">//</span>
00426 
00427                     (*MarshalledAuditParameters)-&gt;Parameters[i].Address = Base - (ULONG_PTR)(*MarshalledAuditParameters);
00428 
00429                     Base +=  (ULONG)LongAlignSize( AuditParameters-&gt;Parameters[i].Length );
00430 
00431 
00432                     <span class="keywordflow">break</span>;
00433                 }
00434             <span class="keywordflow">default</span>:
00435                 {
00436                     <span class="comment">//</span>
00437                     <span class="comment">// We got passed junk, complain.</span>
00438                     <span class="comment">//</span>
00439 
00440                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FALSE );
00441                     <span class="keywordflow">break</span>;
00442                 }
00443         }
00444     }
00445 
00446     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00447 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="adtlog.c::SepAdtSetAuditLogInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepAdtSetAuditLogInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PPOLICY_AUDIT_LOG_INFO&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>AuditLogInformation</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/adtlog_8c-source.html#l00451">451</a> of file <a class="el" href="../../d1/d4/adtlog_8c-source.html">adtlog.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00029">SepAdtLogInformation</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00060">SepRmAcquireDbWriteLock</a>, and <a class="el" href="../../d2/d9/rmp_8h-source.html#l00066">SepRmReleaseDbWriteLock</a>.
<p>
Referenced by <a class="el" href="../../d8/d8/rmaudit_8c-source.html#l00164">SepRmSetAuditLogWrkr()</a>.
<p>
<pre class="fragment"><div>00457                    :
00458 
00459     This function stores Audit Log Information in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Reference Monitor's
00460     in-memory database.  This information contains parameters such as Audit
00461     Log size etc.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's responsibility to ensure that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00462     supplied information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid.
00463 
00464     NOTE:  After initialization, <span class="keyword">this</span> function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LSA
00465     via a Reference Monitor command.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a necessary restriction
00466     because <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Audit Log Information stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LSA Database must
00467     remain in sync
00468 
00469 Arguments:
00470 
00471     AuditLogInformation - Pointer to Audit Log Information structure.
00472 
00473 Return Value:
00474 
00475     None.
00476 
00477 --*/
00478 
00479 {
00480     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00481 
00482     <span class="comment">//</span>
00483     <span class="comment">// Acquire Reference Monitor Database write lock.</span>
00484     <span class="comment">//</span>
00485 
00486     <a class="code" href="../../d1/d0/rmp_8h.html#a3">SepRmAcquireDbWriteLock</a>();
00487 
00488     <span class="comment">//</span>
00489     <span class="comment">// Write the information</span>
00490     <span class="comment">//</span>
00491 
00492     <a class="code" href="../../d1/d5/adtp_8h.html#a3">SepAdtLogInformation</a> = *AuditLogInformation;
00493 
00494     <span class="comment">//</span>
00495     <span class="comment">// Release Reference Monitor Database write lock</span>
00496     <span class="comment">//</span>
00497 
00498     <a class="code" href="../../d1/d0/rmp_8h.html#a5">SepRmReleaseDbWriteLock</a>();
00499 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="adtlog.c::SepAuditFailed" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepAuditFailed           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/adtlog_8c-source.html#l00153">153</a> of file <a class="el" href="../../d1/d4/adtlog_8c-source.html">adtlog.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00070">KeBugCheck()</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00077">SepCrashOnAuditFail</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/adtlog_8c-source.html#l00052">SepAdtLogAuditRecord()</a>.
<p>
<pre class="fragment"><div>00159                    :
00160 
00161     Bugchecks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system due to a missed audit (optional requirement
00162     <span class="keywordflow">for</span> C2 compliance).
00163 
00164 Arguments:
00165 
00166     None.
00167 
00168 Return Value:
00169 
00170     None.
00171 
00172 --*/
00173 
00174 {
00175     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00176     OBJECT_ATTRIBUTES Obja;
00177     HANDLE KeyHandle;
00178     UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
00179     UNICODE_STRING <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
00180     UCHAR NewValue;
00181 
00182     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<span class="keyword">sizeof</span>(UCHAR) == <span class="keyword">sizeof</span>(BOOLEAN));
00183 
00184     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d5/adtp_8h.html#a12">SepCrashOnAuditFail</a>) {
00185         <span class="keywordflow">return</span>;
00186     }
00187 
00188     <span class="comment">//</span>
00189     <span class="comment">// Turn off flag in the registry that controls crashing on audit failure</span>
00190     <span class="comment">//</span>
00191 
00192     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;KeyName, L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\Lsa"</span>);
00193 
00194     InitializeObjectAttributes( &amp;Obja,
00195                                 &amp;KeyName,
00196                                 OBJ_CASE_INSENSITIVE | 
00197                                     OBJ_KERNEL_HANDLE,
00198                                 NULL,
00199                                 NULL
00200                                 );
00201     <span class="keywordflow">do</span> {
00202 
00203         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenKey(
00204                      &amp;KeyHandle,
00205                      KEY_SET_VALUE,
00206                      &amp;Obja
00207                      );
00208 
00209     } <span class="keywordflow">while</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INSUFFICIENT_RESOURCES) || (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NO_MEMORY));
00210 
00211     <span class="comment">//</span>
00212     <span class="comment">// If the LSA key isn't there, he's got big problems.  But don't crash.</span>
00213     <span class="comment">//</span>
00214 
00215     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_OBJECT_NAME_NOT_FOUND) {
00216         <a class="code" href="../../d1/d5/adtp_8h.html#a12">SepCrashOnAuditFail</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00217         <span class="keywordflow">return</span>;
00218     }
00219 
00220     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00221         <span class="keywordflow">goto</span> bugcheck;
00222     }
00223 
00224     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;ValueName, CRASH_ON_AUDIT_FAIL_VALUE );
00225 
00226     NewValue = LSAP_ALLOW_ADIMIN_LOGONS_ONLY;
00227 
00228     <span class="keywordflow">do</span> {
00229 
00230         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwSetValueKey( KeyHandle,
00231                                 &amp;ValueName,
00232                                 0,
00233                                 REG_NONE,
00234                                 &amp;NewValue,
00235                                 <span class="keyword">sizeof</span>(UCHAR)
00236                                 );
00237 
00238     } <span class="keywordflow">while</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INSUFFICIENT_RESOURCES) || (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NO_MEMORY));
00239     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00240 
00241     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00242         <span class="keywordflow">goto</span> bugcheck;
00243     }
00244 
00245     <span class="keywordflow">do</span> {
00246 
00247         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwFlushKey( KeyHandle );
00248 
00249     } <span class="keywordflow">while</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INSUFFICIENT_RESOURCES) || (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NO_MEMORY));
00250     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00251 
00252     <span class="comment">//</span>
00253     <span class="comment">// go boom.</span>
00254     <span class="comment">//</span>
00255 
00256 bugcheck:
00257 
00258     <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(AUDIT_FAILURE);
00259 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="adtlog.c::SepDequeueWorkItem" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html">PSEP_LSA_WORK_ITEM</a> SepDequeueWorkItem           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/adtlog_8c-source.html#l00738">738</a> of file <a class="el" href="../../d1/d4/adtlog_8c-source.html">adtlog.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00324">_SEP_LSA_WORK_ITEM::List</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00063">SepAdtCurrentListLength</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00287">SepLockLsaQueue</a>, <a class="el" href="../../d9/d4/seglobal_8c-source.html#l00288">SepLsaQueue</a>, and <a class="el" href="../../d7/d5/sep_8h-source.html#l00290">SepUnlockLsaQueue</a>.
<p>
Referenced by <a class="el" href="../../d1/d9/rmmain_8c-source.html#l00907">SepRmCallLsa()</a>.
<p>
<pre class="fragment"><div>00744                    :
00745 
00746     Removes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> top element of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d8/d5/seglobal_8c.html#a95">SepLsaQueue</a> and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00747     next element <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> one, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> otherwise.
00748 
00749 Arguments:
00750 
00751     None.
00752 
00753 Return Value:
00754 
00755     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next <a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html">SEP_LSA_WORK_ITEM</a>, or <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
00756 
00757 --*/
00758 
00759 {
00760     <a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html">PSEP_LSA_WORK_ITEM</a> OldWorkQueueItem;
00761 
00762     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00763 
00764     <a class="code" href="../../d6/d6/sep_8h.html#a14">SepLockLsaQueue</a>();
00765 
00766     OldWorkQueueItem = (<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html">PSEP_LSA_WORK_ITEM</a>)RemoveHeadList(&amp;SepLsaQueue);
00767     OldWorkQueueItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o0">List</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00768     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( OldWorkQueueItem );
00769 
00770     <a class="code" href="../../d1/d5/adtp_8h.html#a10">SepAdtCurrentListLength</a>--;
00771 
00772 <span class="preprocessor">#if 0</span>
00773 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Removing item\n"</span>);
00774 <span class="preprocessor">#endif</span>
00775 <span class="preprocessor"></span>
00776     <span class="keywordflow">if</span> (IsListEmpty( &amp;SepLsaQueue )) {
00777 
00778         <a class="code" href="../../d6/d6/sep_8h.html#a15">SepUnlockLsaQueue</a>();
00779         <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00780     }
00781 
00782     <span class="comment">//</span>
00783     <span class="comment">// We know there's something on the queue now, so we</span>
00784     <span class="comment">// can unlock it.</span>
00785     <span class="comment">//</span>
00786 
00787     <a class="code" href="../../d6/d6/sep_8h.html#a15">SepUnlockLsaQueue</a>();
00788     <span class="keywordflow">return</span>((<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html">PSEP_LSA_WORK_ITEM</a>)(&amp;<a class="code" href="../../d8/d5/seglobal_8c.html#a95">SepLsaQueue</a>)-&gt;Flink);
00789 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="adtlog.c::SepQueueWorkItem" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN SepQueueWorkItem           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html">PSEP_LSA_WORK_ITEM</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LsaWorkItem</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ForceQueue</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/adtlog_8c-source.html#l00600">600</a> of file <a class="el" href="../../d1/d4/adtlog_8c-source.html">adtlog.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d5/d8/ex_8h.html#a332a206">DelayedWorkQueue</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01961">ExInitializeWorkItem</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00375">ExQueueWorkItem()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01950">PWORKER_THREAD_ROUTINE</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00056">SepAdtCountEventsDiscarded</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00063">SepAdtCurrentListLength</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00070">SepAdtDiscardingAudits</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02717">SepAdtGenerateDiscardAudit()</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00037">SepAdtMaxListLength</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00038">SepAdtMinListLength</a>, <a class="el" href="../../d9/d4/seglobal_8c-source.html#l00296">SepExWorkItem</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00287">SepLockLsaQueue</a>, <a class="el" href="../../d9/d4/seglobal_8c-source.html#l00288">SepLsaQueue</a>, <a class="el" href="../../d1/d9/rmmain_8c-source.html#l00907">SepRmCallLsa()</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00290">SepUnlockLsaQueue</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d7/d5/sep_8h-source.html#l00372">_SEP_WORK_ITEM::WorkItem</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/adtlog_8c-source.html#l00052">SepAdtLogAuditRecord()</a>, and <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00777">SepInformLsaOfDeletedLogon()</a>.
<p>
<pre class="fragment"><div>00607                    :
00608 
00609     Puts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed work item on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> queue to be passed to LSA,
00610     and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> queue upon arrival.
00611 
00612 Arguments:
00613 
00614     LsaWorkItem - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> work item to be queued.
00615 
00616     ForceQueue - Indicate that <span class="keyword">this</span> item <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not to be discarded
00617         due because of a full queue.
00618 
00619 Return Value:
00620 
00621     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - The item was successfully queued.
00622 
00623     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - The item was not queued and must be discarded.
00624 
00625 --*/
00626 
00627 {
00628     BOOLEAN rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00629     BOOLEAN StartExThread = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
00630 
00631     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00632 
00633 <span class="preprocessor">#if 0</span>
00634 <span class="preprocessor"></span>
00635   <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Queueing an audit\n"</span>);
00636 
00637 <span class="preprocessor">#endif</span>
00638 <span class="preprocessor"></span>
00639     <a class="code" href="../../d6/d6/sep_8h.html#a14">SepLockLsaQueue</a>();
00640 
00641     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d5/adtp_8h.html#a11">SepAdtDiscardingAudits</a> &amp;&amp; !ForceQueue) {
00642 
00643         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d5/adtp_8h.html#a10">SepAdtCurrentListLength</a> &lt; <a class="code" href="../../d1/d5/adtp_8h.html#a6">SepAdtMinListLength</a>) {
00644 
00645             <span class="comment">//</span>
00646             <span class="comment">// We need to generate an audit saying how many audits we've</span>
00647             <span class="comment">// discarded.</span>
00648             <span class="comment">//</span>
00649             <span class="comment">// Since we have the mutex protecting the Audit queue, we don't</span>
00650             <span class="comment">// have to worry about anyone coming along and logging an</span>
00651             <span class="comment">// audit.  But *we* can, since a mutex may be acquired recursively.</span>
00652             <span class="comment">//</span>
00653             <span class="comment">// Since we are so protected, turn off the SepAdtDiscardingAudits</span>
00654             <span class="comment">// flag here so that we don't come through this path again.</span>
00655             <span class="comment">//</span>
00656 
00657             <a class="code" href="../../d1/d5/adtp_8h.html#a11">SepAdtDiscardingAudits</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00658 
00659             <a class="code" href="../../d7/d6/sepaudit_8c.html#a22">SepAdtGenerateDiscardAudit</a>();
00660 <span class="preprocessor">#if 0</span>
00661 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Auditing resumed\n"</span>);
00662 <span class="preprocessor">#endif</span>
00663 <span class="preprocessor"></span>
00664             <span class="comment">//</span>
00665             <span class="comment">// We must assume that that worked, so clear the discard count.</span>
00666             <span class="comment">//</span>
00667 
00668             <a class="code" href="../../d1/d5/adtp_8h.html#a9">SepAdtCountEventsDiscarded</a> = 0;
00669 
00670             <span class="comment">//</span>
00671             <span class="comment">// Our 'audits discarded' audit is now on the queue,</span>
00672             <span class="comment">// continue logging the one we started with.</span>
00673             <span class="comment">//</span>
00674 
00675         } <span class="keywordflow">else</span> {
00676 
00677             <span class="comment">//</span>
00678             <span class="comment">// We are not yet below our low water mark.  Toss</span>
00679             <span class="comment">// this audit and increment the discard count.</span>
00680             <span class="comment">//</span>
00681 
00682             <a class="code" href="../../d1/d5/adtp_8h.html#a9">SepAdtCountEventsDiscarded</a>++;
00683             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00684             <span class="keywordflow">goto</span> Exit;
00685         }
00686     }
00687 
00688     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d5/adtp_8h.html#a10">SepAdtCurrentListLength</a> &lt; <a class="code" href="../../d1/d5/adtp_8h.html#a5">SepAdtMaxListLength</a> || ForceQueue) {
00689 
00690         InsertTailList(&amp;SepLsaQueue, &amp;LsaWorkItem-&gt;List);
00691 
00692         <span class="keywordflow">if</span> (++<a class="code" href="../../d1/d5/adtp_8h.html#a10">SepAdtCurrentListLength</a> == 1) {
00693 
00694 <span class="preprocessor">#if 0</span>
00695 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Queueing a work item\n"</span>);
00696 <span class="preprocessor">#endif</span>
00697 <span class="preprocessor"></span>
00698             StartExThread = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
00699         }
00700 
00701     } <span class="keywordflow">else</span> {
00702 
00703         <span class="comment">//</span>
00704         <span class="comment">// There is no room for this audit on the queue,</span>
00705         <span class="comment">// so change our state to 'discarding' and tell</span>
00706         <span class="comment">// the caller to toss this audit.</span>
00707         <span class="comment">//</span>
00708 
00709         <a class="code" href="../../d1/d5/adtp_8h.html#a11">SepAdtDiscardingAudits</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00710 
00711 <span class="preprocessor">#if 0</span>
00712 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Starting to discard audits\n"</span>);
00713 <span class="preprocessor">#endif</span>
00714 <span class="preprocessor"></span>
00715         rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00716     }
00717 
00718 Exit:
00719 
00720     <a class="code" href="../../d6/d6/sep_8h.html#a15">SepUnlockLsaQueue</a>();
00721 
00722     <span class="keywordflow">if</span> ( StartExThread )
00723     {
00724         <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>( &amp;<a class="code" href="../../d8/d5/seglobal_8c.html#a97">SepExWorkItem</a>.<a class="code" href="../../d2/d2/struct__SEP__WORK__ITEM.html#o0">WorkItem</a>,
00725                               (PWORKER_THREAD_ROUTINE) SepRmCallLsa,
00726                               &amp;SepExWorkItem
00727                               );
00728 
00729         <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>( &amp;<a class="code" href="../../d8/d5/seglobal_8c.html#a97">SepExWorkItem</a>.<a class="code" href="../../d2/d2/struct__SEP__WORK__ITEM.html#o0">WorkItem</a>, DelayedWorkQueue );
00730     }
00731 
00732     <span class="keywordflow">return</span>( rc );
00733 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:50 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
