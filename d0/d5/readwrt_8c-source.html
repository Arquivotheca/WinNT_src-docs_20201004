<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: readwrt.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>readwrt.c</h1><a href="../../d9/d5/readwrt_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">   readwrt.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the routines which implement the capability</span>
00012 <span class="comment">    to read and write the virtual memory of a target process.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Lou Perazzoli (loup) 22-May-1989</span>
00017 <span class="comment">    Landy Wang (landyw) 02-June-1997</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00024 
00025 <span class="comment">//</span>
00026 <span class="comment">// The maximum amount to try to Probe and Lock is 14 pages, this</span>
00027 <span class="comment">// way it always fits in a 16 page allocation.</span>
00028 <span class="comment">//</span>
00029 
<a name="l00030"></a><a class="code" href="../../d9/d5/readwrt_8c.html#a0">00030</a> <span class="preprocessor">#define MAX_LOCK_SIZE ((ULONG)(14 * PAGE_SIZE))</span>
00031 <span class="preprocessor"></span>
00032 <span class="comment">//</span>
00033 <span class="comment">// The maximum to move in a single block is 64k bytes.</span>
00034 <span class="comment">//</span>
00035 
<a name="l00036"></a><a class="code" href="../../d9/d5/readwrt_8c.html#a1">00036</a> <span class="preprocessor">#define MAX_MOVE_SIZE (LONG)0x10000</span>
00037 <span class="preprocessor"></span>
00038 <span class="comment">//</span>
00039 <span class="comment">// The minimum to move is a single block is 128 bytes.</span>
00040 <span class="comment">//</span>
00041 
<a name="l00042"></a><a class="code" href="../../d9/d5/readwrt_8c.html#a2">00042</a> <span class="preprocessor">#define MINIMUM_ALLOCATION (LONG)128</span>
00043 <span class="preprocessor"></span>
00044 <span class="comment">//</span>
00045 <span class="comment">// Define the pool move threshold value.</span>
00046 <span class="comment">//</span>
00047 
<a name="l00048"></a><a class="code" href="../../d9/d5/readwrt_8c.html#a3">00048</a> <span class="preprocessor">#define POOL_MOVE_THRESHOLD 511</span>
00049 <span class="preprocessor"></span>
00050 <span class="comment">//</span>
00051 <span class="comment">// Define forward referenced procedure prototypes.</span>
00052 <span class="comment">//</span>
00053 
00054 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00055 <a class="code" href="../../d9/d5/readwrt_8c.html#a5">MiValidateUserTransfer</a>(
00056      IN PVOID BaseAddress,
00057      IN PVOID Buffer,
00058      IN ULONG BufferSize
00059      );
00060 
00061 ULONG
00062 <a class="code" href="../../d9/d5/readwrt_8c.html#a6">MiGetExceptionInfo</a> (
00063     IN PEXCEPTION_POINTERS ExceptionPointers,
00064     IN PULONG_PTR BadVa1,
00065     IN PULONG_PTR BadVa2
00066     );
00067 
00068 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00069 <a class="code" href="../../d9/d5/readwrt_8c.html#a7">MiDoMappedCopy</a> (
00070      IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> FromProcess,
00071      IN PVOID FromAddress,
00072      IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ToProcess,
00073      OUT PVOID ToAddress,
00074      IN ULONG BufferSize,
00075      IN KPROCESSOR_MODE PreviousMode,
00076      OUT PULONG NumberOfBytesRead
00077      );
00078 
00079 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00080 <a class="code" href="../../d9/d5/readwrt_8c.html#a8">MiDoPoolCopy</a> (
00081      IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> FromProcess,
00082      IN PVOID FromAddress,
00083      IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ToProcess,
00084      OUT PVOID ToAddress,
00085      IN ULONG BufferSize,
00086      IN KPROCESSOR_MODE PreviousMode,
00087      OUT PULONG NumberOfBytesRead
00088      );
00089 
00090 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00091 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiGetExceptionInfo)</span>
00092 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtReadVirtualMemory)</span>
00093 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtWriteVirtualMemory)</span>
00094 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiDoMappedCopy)</span>
00095 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiDoPoolCopy)</span>
00096 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiValidateUserTransfer)</span>
00097 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00098 <span class="preprocessor"></span>
<a name="l00099"></a><a class="code" href="../../d9/d5/readwrt_8c.html#a4">00099</a> <span class="preprocessor">#define COPY_STACK_SIZE 64</span>
00100 <span class="preprocessor"></span>
00101 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00102"></a><a class="code" href="../../d9/d5/readwrt_8c.html#a9">00102</a> <a class="code" href="../../d9/d5/readwrt_8c.html#a9">NtReadVirtualMemory</a> (
00103      IN HANDLE ProcessHandle,
00104      IN PVOID BaseAddress,
00105      OUT PVOID Buffer,
00106      IN ULONG BufferSize,
00107      OUT PULONG NumberOfBytesRead OPTIONAL
00108      )
00109 
00110 <span class="comment">/*++</span>
00111 <span class="comment"></span>
00112 <span class="comment">Routine Description:</span>
00113 <span class="comment"></span>
00114 <span class="comment">    This function copies the specified address range from the specified</span>
00115 <span class="comment">    process into the specified address range of the current process.</span>
00116 <span class="comment"></span>
00117 <span class="comment">Arguments:</span>
00118 <span class="comment"></span>
00119 <span class="comment">     ProcessHandle - Supplies an open handle to a process object.</span>
00120 <span class="comment"></span>
00121 <span class="comment">     BaseAddress - Supplies the base address in the specified process</span>
00122 <span class="comment">          to be read.</span>
00123 <span class="comment"></span>
00124 <span class="comment">     Buffer - Supplies the address of a buffer which receives the</span>
00125 <span class="comment">          contents from the specified process address space.</span>
00126 <span class="comment"></span>
00127 <span class="comment">     BufferSize - Supplies the requested number of bytes to read from</span>
00128 <span class="comment">          the specified process.</span>
00129 <span class="comment"></span>
00130 <span class="comment">     NumberOfBytesRead - Receives the actual number of bytes</span>
00131 <span class="comment">          transferred into the specified buffer.</span>
00132 <span class="comment"></span>
00133 <span class="comment">Return Value:</span>
00134 <span class="comment"></span>
00135 <span class="comment">    TBS</span>
00136 <span class="comment"></span>
00137 <span class="comment">--*/</span>
00138 
00139 {
00140 
00141     ULONG BytesCopied;
00142     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00143     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00144     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00145 
00146     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00147 
00148     <span class="comment">//</span>
00149     <span class="comment">// Get the previous mode and probe output argument if necessary.</span>
00150     <span class="comment">//</span>
00151 
00152     PreviousMode = KeGetPreviousMode();
00153     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00154 
00155         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a5">MiValidateUserTransfer</a>(BaseAddress, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>);
00156         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00157             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00158         }
00159 
00160         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(NumberOfBytesRead)) {
00161             <span class="keywordflow">try</span> {
00162                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(NumberOfBytesRead);
00163 
00164             } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00165                 <span class="keywordflow">return</span> GetExceptionCode();
00166             }
00167         }
00168     }
00169 
00170     <span class="comment">//</span>
00171     <span class="comment">// If the buffer size is not zero, then attempt to read data from the</span>
00172     <span class="comment">// specified process address space into the current process address</span>
00173     <span class="comment">// space.</span>
00174     <span class="comment">//</span>
00175 
00176     BytesCopied = 0;
00177     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00178     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> != 0) {
00179 
00180         <span class="comment">//</span>
00181         <span class="comment">// Reference the target process.</span>
00182         <span class="comment">//</span>
00183 
00184         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(ProcessHandle,
00185                                            PROCESS_VM_READ,
00186                                            <a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>,
00187                                            PreviousMode,
00188                                            (PVOID *)&amp;Process,
00189                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00190 
00191         <span class="comment">//</span>
00192         <span class="comment">// If the process was successfully referenced, then attempt to</span>
00193         <span class="comment">// read the specified memory either by direct mapping or copying</span>
00194         <span class="comment">// through nonpaged pool.</span>
00195         <span class="comment">//</span>
00196 
00197         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
00198 
00199             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a11">MmCopyVirtualMemory</a> (Process,
00200                                           BaseAddress,
00201                                           <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(),
00202                                           <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00203                                           <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>,
00204                                           PreviousMode,
00205                                           &amp;BytesCopied);
00206 
00207             <span class="comment">//</span>
00208             <span class="comment">// Dereference the target process.</span>
00209             <span class="comment">//</span>
00210 
00211             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00212         }
00213     }
00214 
00215     <span class="comment">//</span>
00216     <span class="comment">// If requested, return the number of bytes read.</span>
00217     <span class="comment">//</span>
00218 
00219     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(NumberOfBytesRead)) {
00220         <span class="keywordflow">try</span> {
00221             *NumberOfBytesRead = BytesCopied;
00222 
00223         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00224             NOTHING;
00225         }
00226     }
00227 
00228     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00229 }
00230 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00231"></a><a class="code" href="../../d9/d5/readwrt_8c.html#a10">00231</a> <a class="code" href="../../d9/d5/readwrt_8c.html#a10">NtWriteVirtualMemory</a>(
00232      IN HANDLE ProcessHandle,
00233      OUT PVOID BaseAddress,
00234      IN PVOID Buffer,
00235      IN ULONG BufferSize,
00236      OUT PULONG NumberOfBytesWritten OPTIONAL
00237      )
00238 
00239 <span class="comment">/*++</span>
00240 <span class="comment"></span>
00241 <span class="comment">Routine Description:</span>
00242 <span class="comment"></span>
00243 <span class="comment">    This function copies the specified address range from the current</span>
00244 <span class="comment">    process into the specified address range of the specified process.</span>
00245 <span class="comment"></span>
00246 <span class="comment">Arguments:</span>
00247 <span class="comment"></span>
00248 <span class="comment">     ProcessHandle - Supplies an open handle to a process object.</span>
00249 <span class="comment"></span>
00250 <span class="comment">     BaseAddress - Supplies the base address to be written to in the</span>
00251 <span class="comment">          specified process.</span>
00252 <span class="comment"></span>
00253 <span class="comment">     Buffer - Supplies the address of a buffer which contains the</span>
00254 <span class="comment">          contents to be written into the specified process</span>
00255 <span class="comment">          address space.</span>
00256 <span class="comment"></span>
00257 <span class="comment">     BufferSize - Supplies the requested number of bytes to write</span>
00258 <span class="comment">          into the specified process.</span>
00259 <span class="comment"></span>
00260 <span class="comment">     NumberOfBytesWritten - Receives the actual number of</span>
00261 <span class="comment">          bytes transferred into the specified address</span>
00262 <span class="comment">          space.</span>
00263 <span class="comment"></span>
00264 <span class="comment">Return Value:</span>
00265 <span class="comment"></span>
00266 <span class="comment">    TBS</span>
00267 <span class="comment"></span>
00268 <span class="comment">--*/</span>
00269 
00270 {
00271     ULONG BytesCopied;
00272     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00273     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00274     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00275 
00276     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00277 
00278     <span class="comment">//</span>
00279     <span class="comment">// Get the previous mode and probe output argument if necessary.</span>
00280     <span class="comment">//</span>
00281 
00282     PreviousMode = KeGetPreviousMode();
00283     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00284 
00285         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a5">MiValidateUserTransfer</a>(BaseAddress, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>);
00286         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00287             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00288         }
00289 
00290         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(NumberOfBytesWritten)) {
00291             <span class="keywordflow">try</span> {
00292                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(NumberOfBytesWritten);
00293 
00294             } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00295                 <span class="keywordflow">return</span> GetExceptionCode();
00296             }
00297         }
00298     }
00299 
00300     <span class="comment">//</span>
00301     <span class="comment">// If the buffer size is not zero, then attempt to write data from the</span>
00302     <span class="comment">// current process address space into the target process address space.</span>
00303     <span class="comment">//</span>
00304 
00305     BytesCopied = 0;
00306     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00307     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> != 0) {
00308 
00309         <span class="comment">//</span>
00310         <span class="comment">// Reference the target process.</span>
00311         <span class="comment">//</span>
00312 
00313         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(ProcessHandle,
00314                                            PROCESS_VM_WRITE,
00315                                            <a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>,
00316                                            PreviousMode,
00317                                            (PVOID *)&amp;Process,
00318                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00319 
00320         <span class="comment">//</span>
00321         <span class="comment">// If the process was successfully referenced, then attempt to</span>
00322         <span class="comment">// write the specified memory either by direct mapping or copying</span>
00323         <span class="comment">// through nonpaged pool.</span>
00324         <span class="comment">//</span>
00325 
00326         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
00327 
00328             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a11">MmCopyVirtualMemory</a> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(),
00329                                           <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00330                                           Process,
00331                                           BaseAddress,
00332                                           <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>,
00333                                           PreviousMode,
00334                                           &amp;BytesCopied);
00335 
00336             <span class="comment">//</span>
00337             <span class="comment">// Dereference the target process.</span>
00338             <span class="comment">//</span>
00339 
00340             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00341         }
00342     }
00343 
00344     <span class="comment">//</span>
00345     <span class="comment">// If requested, return the number of bytes read.</span>
00346     <span class="comment">//</span>
00347 
00348     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(NumberOfBytesWritten)) {
00349         <span class="keywordflow">try</span> {
00350             *NumberOfBytesWritten = BytesCopied;
00351 
00352         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00353             NOTHING;
00354         }
00355     }
00356 
00357     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00358 }
00359 
00360 
00361 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00362"></a><a class="code" href="../../d9/d5/readwrt_8c.html#a11">00362</a> <a class="code" href="../../d9/d5/readwrt_8c.html#a11">MmCopyVirtualMemory</a>(
00363     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> FromProcess,
00364     IN PVOID FromAddress,
00365     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ToProcess,
00366     OUT PVOID ToAddress,
00367     IN ULONG BufferSize,
00368     IN KPROCESSOR_MODE PreviousMode,
00369     OUT PULONG NumberOfBytesCopied
00370     )
00371 {
00372     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00373     KIRQL OldIrql;
00374     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessToLock;
00375 
00376     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> == 0) {
00377         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);         <span class="comment">// No one should call with a zero size.</span>
00378         <span class="keywordflow">return</span> STATUS_SUCCESS;
00379     }
00380 
00381     ProcessToLock = FromProcess;
00382     <span class="keywordflow">if</span> (FromProcess == <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()) {
00383         ProcessToLock = ToProcess;
00384     }
00385 
00386     <span class="comment">//</span>
00387     <span class="comment">// Make sure the process still has an address space.</span>
00388     <span class="comment">//</span>
00389 
00390     <a class="code" href="../../d4/d8/mi_8h.html#a117">MiLockSystemSpace</a>(OldIrql);
00391     <span class="keywordflow">if</span> (ProcessToLock-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o27">AddressSpaceDeleted</a> != 0) {
00392         <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
00393         <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
00394     }
00395     ProcessToLock-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o31">VmOperation</a> += 1;
00396     <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
00397 
00398 
00399     <span class="comment">//</span>
00400     <span class="comment">// If the buffer size is greater than the pool move threshold,</span>
00401     <span class="comment">// then attempt to write the memory via direct mapping.</span>
00402     <span class="comment">//</span>
00403 
00404     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> &gt; <a class="code" href="../../d9/d5/readwrt_8c.html#a3">POOL_MOVE_THRESHOLD</a>) {
00405         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a7">MiDoMappedCopy</a>(FromProcess,
00406                                 FromAddress,
00407                                 ToProcess,
00408                                 ToAddress,
00409                                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>,
00410                                 PreviousMode,
00411                                 NumberOfBytesCopied);
00412 
00413         <span class="comment">//</span>
00414         <span class="comment">// If the completion status is not a working quota problem,</span>
00415         <span class="comment">// then finish the service. Otherwise, attempt to write the</span>
00416         <span class="comment">// memory through nonpaged pool.</span>
00417         <span class="comment">//</span>
00418 
00419         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_WORKING_SET_QUOTA) {
00420             <span class="keywordflow">goto</span> CompleteService;
00421         }
00422 
00423         *NumberOfBytesCopied = 0;
00424     }
00425 
00426     <span class="comment">//</span>
00427     <span class="comment">// There was not enough working set quota to write the memory via</span>
00428     <span class="comment">// direct mapping or the size of the write was below the pool move</span>
00429     <span class="comment">// threshold. Attempt to write the specified memory through nonpaged</span>
00430     <span class="comment">// pool.</span>
00431     <span class="comment">//</span>
00432 
00433     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a8">MiDoPoolCopy</a>(FromProcess,
00434                           FromAddress,
00435                           ToProcess,
00436                           ToAddress,
00437                           <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>,
00438                           PreviousMode,
00439                           NumberOfBytesCopied);
00440 
00441     <span class="comment">//</span>
00442     <span class="comment">// Dereference the target process.</span>
00443     <span class="comment">//</span>
00444 
00445 CompleteService:
00446 
00447     <span class="comment">//</span>
00448     <span class="comment">// Indicate that the vm operation is complete.</span>
00449     <span class="comment">//</span>
00450 
00451     <a class="code" href="../../d4/d8/mi_8h.html#a117">MiLockSystemSpace</a>(OldIrql);
00452     ProcessToLock-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o31">VmOperation</a> -= 1;
00453     <span class="keywordflow">if</span> ((ProcessToLock-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o31">VmOperation</a> == 0) &amp;&amp;
00454         (ProcessToLock-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o34">VmOperationEvent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00455        <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (ProcessToLock-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o34">VmOperationEvent</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00456     }
00457     <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
00458 
00459     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00460 }
00461 
00462 
00463 ULONG
<a name="l00464"></a><a class="code" href="../../d9/d5/readwrt_8c.html#a6">00464</a> <a class="code" href="../../d9/d5/readwrt_8c.html#a6">MiGetExceptionInfo</a> (
00465     IN PEXCEPTION_POINTERS ExceptionPointers,
00466     IN PULONG_PTR BadVa1,
00467     IN PULONG_PTR BadVa2
00468     )
00469 
00470 <span class="comment">/*++</span>
00471 <span class="comment"></span>
00472 <span class="comment">Routine Description:</span>
00473 <span class="comment"></span>
00474 <span class="comment">    This routine examines a exception record and extracts the virtual</span>
00475 <span class="comment">    address of an access violation, guard page violation, or in-page error.</span>
00476 <span class="comment"></span>
00477 <span class="comment">Arguments:</span>
00478 <span class="comment"></span>
00479 <span class="comment">    ExceptionPointers - Supplies a pointer to the exception record.</span>
00480 <span class="comment"></span>
00481 <span class="comment">    BadVa - Receives the virtual address which caused the access violation.</span>
00482 <span class="comment"></span>
00483 <span class="comment">Return Value:</span>
00484 <span class="comment"></span>
00485 <span class="comment">    EXECUTE_EXCEPTION_HANDLER</span>
00486 <span class="comment"></span>
00487 <span class="comment">--*/</span>
00488 
00489 {
00490     PEXCEPTION_RECORD ExceptionRecord;
00491 
00492     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00493 
00494     <span class="comment">//</span>
00495     <span class="comment">// If the exception code is an access violation, guard page violation,</span>
00496     <span class="comment">// or an in-page read error, then return the faulting address. Otherwise.</span>
00497     <span class="comment">// return a special address value.</span>
00498     <span class="comment">//</span>
00499 
00500     *BadVa2 = 0;
00501     ExceptionRecord = ExceptionPointers-&gt;ExceptionRecord;
00502     <span class="keywordflow">if</span> ((ExceptionRecord-&gt;ExceptionCode == STATUS_ACCESS_VIOLATION) ||
00503         (ExceptionRecord-&gt;ExceptionCode == STATUS_GUARD_PAGE_VIOLATION) ||
00504         (ExceptionRecord-&gt;ExceptionCode == STATUS_IN_PAGE_ERROR)) {
00505 
00506         <span class="comment">//</span>
00507         <span class="comment">// The virtual address which caused the exception is the 2nd</span>
00508         <span class="comment">// parameter in the exception information array.</span>
00509         <span class="comment">//</span>
00510 
00511         *BadVa1 = ExceptionRecord-&gt;ExceptionInformation[1];
00512         <span class="keywordflow">if</span> (ExceptionRecord-&gt;NumberParameters == 3) {
00513             *BadVa2 = ExceptionRecord-&gt;ExceptionInformation[2];
00514         }
00515 
00516     } <span class="keywordflow">else</span> {
00517 
00518         <span class="comment">//</span>
00519         <span class="comment">// Unexpected exception - set the number of bytes copied to zero.</span>
00520         <span class="comment">//</span>
00521 
00522         *BadVa2 = 0xFFFFFFFF;
00523     }
00524 
00525     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>;
00526 }
00527 
00528 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00529"></a><a class="code" href="../../d9/d5/readwrt_8c.html#a7">00529</a> <a class="code" href="../../d9/d5/readwrt_8c.html#a7">MiDoMappedCopy</a> (
00530     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> FromProcess,
00531     IN PVOID FromAddress,
00532     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ToProcess,
00533     OUT PVOID ToAddress,
00534     IN ULONG BufferSize,
00535     IN KPROCESSOR_MODE PreviousMode,
00536     OUT PULONG NumberOfBytesRead
00537     )
00538 
00539 <span class="comment">/*++</span>
00540 <span class="comment"></span>
00541 <span class="comment">Routine Description:</span>
00542 <span class="comment"></span>
00543 <span class="comment">    This function copies the specified address range from the specified</span>
00544 <span class="comment">    process into the specified address range of the current process.</span>
00545 <span class="comment"></span>
00546 <span class="comment">Arguments:</span>
00547 <span class="comment"></span>
00548 <span class="comment">     FromProcess - Supplies an open handle to a process object.</span>
00549 <span class="comment"></span>
00550 <span class="comment">     FromAddress - Supplies the base address in the specified process</span>
00551 <span class="comment">                   to be read.</span>
00552 <span class="comment"></span>
00553 <span class="comment">     ToProcess - Supplies an open handle to a process object.</span>
00554 <span class="comment"></span>
00555 <span class="comment">     ToAddress - Supplies the address of a buffer which receives the</span>
00556 <span class="comment">                 contents from the specified process address space.</span>
00557 <span class="comment"></span>
00558 <span class="comment">     BufferSize - Supplies the requested number of bytes to read from</span>
00559 <span class="comment">                  the specified process.</span>
00560 <span class="comment"></span>
00561 <span class="comment">     PreviousMode - Supplies the previous processor mode.</span>
00562 <span class="comment"></span>
00563 <span class="comment">     NumberOfBytesRead - Receives the actual number of bytes</span>
00564 <span class="comment">                         transferred into the specified buffer.</span>
00565 <span class="comment"></span>
00566 <span class="comment">Return Value:</span>
00567 <span class="comment"></span>
00568 <span class="comment">    TBS</span>
00569 <span class="comment"></span>
00570 <span class="comment">--*/</span>
00571 
00572 {
00573 
00574     ULONG AmountToMove;
00575     ULONG_PTR BadVa1;
00576     ULONG_PTR BadVa2;
00577     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00578     LOGICAL Moving;
00579     LOGICAL Probing;
00580     BOOLEAN LockedMdlPages;
00581     PVOID InVa;
00582     ULONG LeftToMove;
00583     PULONG MappedAddress;
00584     ULONG MaximumMoved;
00585     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl;
00586     PFN_NUMBER MdlHack[(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>)/<span class="keyword">sizeof</span>(PFN_NUMBER)) + (<a class="code" href="../../d9/d5/readwrt_8c.html#a0">MAX_LOCK_SIZE</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) + 1];
00587     PVOID OutVa;
00588     LOGICAL MappingFailed;
00589 
00590     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00591 
00592     MappingFailed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00593 
00594     <span class="comment">//</span>
00595     <span class="comment">// Get the address of the current process object and initialize copy</span>
00596     <span class="comment">// parameters.</span>
00597     <span class="comment">//</span>
00598 
00599     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00600 
00601     InVa = FromAddress;
00602     OutVa = ToAddress;
00603 
00604     MaximumMoved = <a class="code" href="../../d9/d5/readwrt_8c.html#a0">MAX_LOCK_SIZE</a>;
00605     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> &lt;= <a class="code" href="../../d9/d5/readwrt_8c.html#a0">MAX_LOCK_SIZE</a>) {
00606         MaximumMoved = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
00607     }
00608 
00609     Mdl = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)&amp;MdlHack[0];
00610 
00611     <span class="comment">//</span>
00612     <span class="comment">// Map the data into the system part of the address space, then copy it.</span>
00613     <span class="comment">//</span>
00614 
00615     LeftToMove = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
00616     AmountToMove = MaximumMoved;
00617     <span class="keywordflow">while</span> (LeftToMove &gt; 0) {
00618 
00619         <span class="keywordflow">if</span> (LeftToMove &lt; AmountToMove) {
00620 
00621             <span class="comment">//</span>
00622             <span class="comment">// Set to move the remaining bytes.</span>
00623             <span class="comment">//</span>
00624 
00625             AmountToMove = LeftToMove;
00626         }
00627 
00628         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00629         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;FromProcess-&gt;Pcb);
00630 
00631         <span class="comment">//</span>
00632         <span class="comment">// We may be touching a user's memory which could be invalid,</span>
00633         <span class="comment">// declare an exception handler.</span>
00634         <span class="comment">//</span>
00635 
00636         <span class="keywordflow">try</span> {
00637 
00638             <span class="comment">//</span>
00639             <span class="comment">// Probe to make sure that the specified buffer is accessible in</span>
00640             <span class="comment">// the target process.</span>
00641             <span class="comment">//</span>
00642 
00643             MappedAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00644             LockedMdlPages = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00645 
00646             <span class="keywordflow">if</span> ((InVa == FromAddress) &amp;&amp; (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>)){
00647                 Probing = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00648                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a> (FromAddress, <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
00649             }
00650             Probing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00651 
00652             <span class="comment">//</span>
00653             <span class="comment">// Initialize MDL for request.</span>
00654             <span class="comment">//</span>
00655 
00656             <a class="code" href="../../d2/d1/mm_8h.html#a24">MmInitializeMdl</a> (Mdl, (PVOID)InVa, AmountToMove);
00657 
00658             Moving = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00659             <a class="code" href="../../d5/d6/iosup_8c.html#a41">MmProbeAndLockPages</a> (Mdl, PreviousMode, <a class="code" href="../../d2/d1/mm_8h.html#a344a168">IoReadAccess</a>);
00660             Moving = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00661 
00662             LockedMdlPages = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00663 
00664             MappedAddress = <a class="code" href="../../d5/d6/iosup_8c.html#a50">MmMapLockedPagesSpecifyCache</a> (Mdl,
00665                                                           <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00666                                                           <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>,
00667                                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00668                                                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00669                                                           <a class="code" href="../../d2/d1/mm_8h.html#a347a183">HighPagePriority</a>);
00670 
00671             <span class="keywordflow">if</span> (MappedAddress == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00672                 MappingFailed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00673                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_INSUFFICIENT_RESOURCES);
00674             }
00675 
00676             <span class="comment">//</span>
00677             <span class="comment">// Deattach from the FromProcess and attach to the ToProcess.</span>
00678             <span class="comment">//</span>
00679 
00680             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00681             <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;ToProcess-&gt;Pcb);
00682 
00683             <span class="comment">//</span>
00684             <span class="comment">// Now operating in the context of the ToProcess.</span>
00685             <span class="comment">//</span>
00686             <span class="keywordflow">if</span> ((InVa == FromAddress) &amp;&amp; (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>)){
00687                 Probing = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00688                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a> (ToAddress, <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
00689             }
00690             Probing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00691 
00692             RtlCopyMemory (OutVa, MappedAddress, AmountToMove);
00693 
00694         } except (<a class="code" href="../../d9/d5/readwrt_8c.html#a6">MiGetExceptionInfo</a> (GetExceptionInformation(),
00695                                       &amp;BadVa1,
00696                                       &amp;BadVa2)) {
00697 
00698 
00699             <span class="comment">//</span>
00700             <span class="comment">// If an exception occurs during the move operation or probe,</span>
00701             <span class="comment">// return the exception code as the status value.</span>
00702             <span class="comment">//</span>
00703 
00704             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00705             <span class="keywordflow">if</span> (MappedAddress != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00706                 <a class="code" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (MappedAddress, Mdl);
00707             }
00708             <span class="keywordflow">if</span> (LockedMdlPages == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00709                 <a class="code" href="../../d5/d6/iosup_8c.html#a45">MmUnlockPages</a> (Mdl);
00710             }
00711 
00712             <span class="keywordflow">if</span> (GetExceptionCode() == STATUS_WORKING_SET_QUOTA) {
00713                 <span class="keywordflow">return</span> STATUS_WORKING_SET_QUOTA;
00714             }
00715 
00716             <span class="keywordflow">if</span> ((Probing == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) || (MappingFailed == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00717                 <span class="keywordflow">return</span> GetExceptionCode();
00718 
00719             } <span class="keywordflow">else</span> {
00720 
00721                 <span class="comment">//</span>
00722                 <span class="comment">// The failure occurred during the move operation, determine</span>
00723                 <span class="comment">// which move failed, and calculate the number of bytes</span>
00724                 <span class="comment">// actually moved.</span>
00725                 <span class="comment">//</span>
00726 
00727                 <span class="keywordflow">if</span> (Moving == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00728                     <span class="keywordflow">if</span> (BadVa1 != 0xFFFFFFFF) {
00729                         *NumberOfBytesRead = (ULONG)((ULONG_PTR)BadVa2 - (ULONG_PTR)FromAddress);
00730                     }
00731 
00732                 } <span class="keywordflow">else</span> {
00733                     *NumberOfBytesRead = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> - LeftToMove;
00734                 }
00735             }
00736 
00737             <span class="keywordflow">return</span> STATUS_PARTIAL_COPY;
00738         }
00739         <a class="code" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (MappedAddress, Mdl);
00740         <a class="code" href="../../d5/d6/iosup_8c.html#a45">MmUnlockPages</a> (Mdl);
00741 
00742         LeftToMove -= AmountToMove;
00743         InVa = (PVOID)((ULONG_PTR)InVa + AmountToMove);
00744         OutVa = (PVOID)((ULONG_PTR)OutVa + AmountToMove);
00745     }
00746 
00747     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00748 
00749     <span class="comment">//</span>
00750     <span class="comment">// Set number of bytes moved.</span>
00751     <span class="comment">//</span>
00752 
00753     *NumberOfBytesRead = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
00754     <span class="keywordflow">return</span> STATUS_SUCCESS;
00755 }
00756 
00757 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00758"></a><a class="code" href="../../d9/d5/readwrt_8c.html#a8">00758</a> <a class="code" href="../../d9/d5/readwrt_8c.html#a8">MiDoPoolCopy</a> (
00759      IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> FromProcess,
00760      IN PVOID FromAddress,
00761      IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ToProcess,
00762      OUT PVOID ToAddress,
00763      IN ULONG BufferSize,
00764      IN KPROCESSOR_MODE PreviousMode,
00765      OUT PULONG NumberOfBytesRead
00766      )
00767 
00768 <span class="comment">/*++</span>
00769 <span class="comment"></span>
00770 <span class="comment">Routine Description:</span>
00771 <span class="comment"></span>
00772 <span class="comment">    This function copies the specified address range from the specified</span>
00773 <span class="comment">    process into the specified address range of the current process.</span>
00774 <span class="comment"></span>
00775 <span class="comment">Arguments:</span>
00776 <span class="comment"></span>
00777 <span class="comment">     ProcessHandle - Supplies an open handle to a process object.</span>
00778 <span class="comment"></span>
00779 <span class="comment">     BaseAddress - Supplies the base address in the specified process</span>
00780 <span class="comment">                   to be read.</span>
00781 <span class="comment"></span>
00782 <span class="comment">     Buffer - Supplies the address of a buffer which receives the</span>
00783 <span class="comment">              contents from the specified process address space.</span>
00784 <span class="comment"></span>
00785 <span class="comment">     BufferSize - Supplies the requested number of bytes to read from</span>
00786 <span class="comment">                  the specified process.</span>
00787 <span class="comment"></span>
00788 <span class="comment">     PreviousMode - Supplies the previous processor mode.</span>
00789 <span class="comment"></span>
00790 <span class="comment">     NumberOfBytesRead - Receives the actual number of bytes</span>
00791 <span class="comment">                         transferred into the specified buffer.</span>
00792 <span class="comment"></span>
00793 <span class="comment">Return Value:</span>
00794 <span class="comment"></span>
00795 <span class="comment">    TBS</span>
00796 <span class="comment"></span>
00797 <span class="comment">--*/</span>
00798 
00799 {
00800 
00801     ULONG AmountToMove;
00802     ULONG_PTR BadVa1;
00803     ULONG_PTR BadVa2;
00804     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00805     LOGICAL Moving;
00806     LOGICAL Probing;
00807     PVOID InVa;
00808     ULONG LeftToMove;
00809     ULONG MaximumMoved;
00810     PVOID OutVa;
00811     PVOID PoolArea;
00812     LONGLONG StackArray[<a class="code" href="../../d8/d5/physical_8c.html#a0">COPY_STACK_SIZE</a>];
00813     ULONG FreePool;
00814 
00815     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00816 
00817     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> != 0);
00818 
00819     <span class="comment">//</span>
00820     <span class="comment">// Get the address of the current process object and initialize copy</span>
00821     <span class="comment">// parameters.</span>
00822     <span class="comment">//</span>
00823 
00824     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00825 
00826     InVa = FromAddress;
00827     OutVa = ToAddress;
00828 
00829     <span class="comment">//</span>
00830     <span class="comment">// Allocate non-paged memory to copy in and out of.</span>
00831     <span class="comment">//</span>
00832 
00833     MaximumMoved = <a class="code" href="../../d9/d5/readwrt_8c.html#a1">MAX_MOVE_SIZE</a>;
00834     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> &lt;= <a class="code" href="../../d9/d5/readwrt_8c.html#a1">MAX_MOVE_SIZE</a>) {
00835         MaximumMoved = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
00836     }
00837 
00838     FreePool = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00839     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> &lt;= <span class="keyword">sizeof</span>(StackArray)) {
00840         PoolArea = (PULONG)&amp;StackArray[0];
00841     } <span class="keywordflow">else</span> {
00842         <span class="keywordflow">do</span> {
00843             PoolArea = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, MaximumMoved, 'wRmM');
00844             <span class="keywordflow">if</span> (PoolArea != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00845                 FreePool = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00846                 <span class="keywordflow">break</span>;
00847             }
00848 
00849             MaximumMoved = MaximumMoved &gt;&gt; 1;
00850             <span class="keywordflow">if</span> (MaximumMoved &lt;= <span class="keyword">sizeof</span>(StackArray)) {
00851                 PoolArea = (PULONG)&amp;StackArray[0];
00852                 <span class="keywordflow">break</span>;
00853             }
00854         } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00855     }
00856 
00857     <span class="comment">//</span>
00858     <span class="comment">// Copy the data into pool, then copy back into the ToProcess.</span>
00859     <span class="comment">//</span>
00860 
00861     LeftToMove = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
00862     AmountToMove = MaximumMoved;
00863     <span class="keywordflow">while</span> (LeftToMove &gt; 0) {
00864 
00865         <span class="keywordflow">if</span> (LeftToMove &lt; AmountToMove) {
00866 
00867             <span class="comment">//</span>
00868             <span class="comment">// Set to move the remaining bytes.</span>
00869             <span class="comment">//</span>
00870 
00871             AmountToMove = LeftToMove;
00872         }
00873 
00874         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00875         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;FromProcess-&gt;Pcb);
00876 
00877         <span class="comment">//</span>
00878         <span class="comment">// We may be touching a user's memory which could be invalid,</span>
00879         <span class="comment">// declare an exception handler.</span>
00880         <span class="comment">//</span>
00881 
00882         <span class="keywordflow">try</span> {
00883 
00884             <span class="comment">//</span>
00885             <span class="comment">// Probe to make sure that the specified buffer is accessible in</span>
00886             <span class="comment">// the target process.</span>
00887             <span class="comment">//</span>
00888 
00889             <span class="keywordflow">if</span> ((InVa == FromAddress) &amp;&amp; (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>)){
00890                 Probing = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00891                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a> (FromAddress, <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
00892             }
00893 
00894             Probing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00895 
00896             Moving = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00897 
00898             RtlCopyMemory (PoolArea, InVa, AmountToMove);
00899 
00900             Moving = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00901 
00902             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00903             <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;ToProcess-&gt;Pcb);
00904 
00905             <span class="comment">//</span>
00906             <span class="comment">// Now operating in the context of the ToProcess.</span>
00907             <span class="comment">//</span>
00908 
00909             <span class="keywordflow">if</span> ((InVa == FromAddress) &amp;&amp; (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>)){
00910                 Probing = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00911                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a> (ToAddress, <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
00912             }
00913             Probing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00914 
00915             RtlCopyMemory (OutVa, PoolArea, AmountToMove);
00916 
00917         } except (<a class="code" href="../../d9/d5/readwrt_8c.html#a6">MiGetExceptionInfo</a> (GetExceptionInformation(),
00918                                       &amp;BadVa1,
00919                                       &amp;BadVa2)) {
00920 
00921             <span class="comment">//</span>
00922             <span class="comment">// If an exception occurs during the move operation or probe,</span>
00923             <span class="comment">// return the exception code as the status value.</span>
00924             <span class="comment">//</span>
00925 
00926             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00927 
00928             <span class="keywordflow">if</span> (FreePool) {
00929                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (PoolArea);
00930             }
00931             <span class="keywordflow">if</span> (Probing == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00932                 <span class="keywordflow">return</span> GetExceptionCode();
00933 
00934             } <span class="keywordflow">else</span> {
00935 
00936                 <span class="comment">//</span>
00937                 <span class="comment">// The failure occurred during the move operation, determine</span>
00938                 <span class="comment">// which move failed, and calculate the number of bytes</span>
00939                 <span class="comment">// actually moved.</span>
00940                 <span class="comment">//</span>
00941 
00942                 <span class="keywordflow">if</span> (Moving == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00943 
00944                     <span class="comment">//</span>
00945                     <span class="comment">// The failure occurred getting the data.</span>
00946                     <span class="comment">//</span>
00947 
00948                     <span class="keywordflow">if</span> (BadVa1 != 0xFFFFFFFF) {
00949                         *NumberOfBytesRead = (ULONG)((ULONG_PTR)(BadVa2 - (ULONG_PTR)FromAddress));
00950                     }
00951 
00952                 } <span class="keywordflow">else</span> {
00953 
00954                     <span class="comment">//</span>
00955                     <span class="comment">// The failure occurred writing the data.</span>
00956                     <span class="comment">//</span>
00957 
00958                     *NumberOfBytesRead = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> - LeftToMove;
00959                 }
00960             }
00961 
00962             <span class="keywordflow">return</span> STATUS_PARTIAL_COPY;
00963         }
00964 
00965         LeftToMove -= AmountToMove;
00966         InVa = (PVOID)((ULONG_PTR)InVa + AmountToMove);
00967         OutVa = (PVOID)((ULONG_PTR)OutVa + AmountToMove);
00968     }
00969 
00970     <span class="keywordflow">if</span> (FreePool) {
00971         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (PoolArea);
00972     }
00973     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00974 
00975     <span class="comment">//</span>
00976     <span class="comment">// Set number of bytes moved.</span>
00977     <span class="comment">//</span>
00978 
00979     *NumberOfBytesRead = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
00980     <span class="keywordflow">return</span> STATUS_SUCCESS;
00981 }
00982 
00983 
00984 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00985"></a><a class="code" href="../../d9/d5/readwrt_8c.html#a5">00985</a> <a class="code" href="../../d9/d5/readwrt_8c.html#a5">MiValidateUserTransfer</a>(
00986      IN PVOID BaseAddressPointer,
00987      IN PVOID BufferPointer,
00988      IN ULONG BufferSize
00989      )
00990 
00991 <span class="comment">/*++</span>
00992 <span class="comment"></span>
00993 <span class="comment">Routine Description:</span>
00994 <span class="comment"></span>
00995 <span class="comment">    This function checks whether the parameter source and destination address</span>
00996 <span class="comment">    ranges lie within the user virtual address space.  This function does NOT</span>
00997 <span class="comment">    guarantee that the addresses are in fact mapped or that faults will not</span>
00998 <span class="comment">    occur - it just validates the address range.</span>
00999 <span class="comment"></span>
01000 <span class="comment">Arguments:</span>
01001 <span class="comment"></span>
01002 <span class="comment">     BaseAddress - Supplies the base address within a process to be read.</span>
01003 <span class="comment"></span>
01004 <span class="comment">     Buffer - Supplies the address of a buffer which sends or receives the</span>
01005 <span class="comment">              contents from the specified process address space.</span>
01006 <span class="comment"></span>
01007 <span class="comment">     BufferSize - Supplies the requested number of bytes to read or write from</span>
01008 <span class="comment">                  the specified process.</span>
01009 <span class="comment"></span>
01010 <span class="comment">Return Value:</span>
01011 <span class="comment"></span>
01012 <span class="comment">    STATUS_SUCCESS if valid user ranges, error otherwise.</span>
01013 <span class="comment"></span>
01014 <span class="comment">Environment:</span>
01015 <span class="comment"></span>
01016 <span class="comment">    None.</span>
01017 <span class="comment"></span>
01018 <span class="comment">--*/</span>
01019 
01020 {
01021     ULONG_PTR   BaseAddress;
01022     ULONG_PTR   <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
01023 
01024     BaseAddress = (ULONG_PTR)BaseAddressPointer;
01025     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = (ULONG_PTR)BufferPointer;
01026 
01027     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01028 
01029     <span class="comment">//</span>
01030     <span class="comment">// check that both the base address and the target buffer qualify</span>
01031     <span class="comment">// as valid user address ranges.  Wrapping is not allowed.</span>
01032     <span class="comment">//</span>
01033     <span class="keywordflow">if</span> (BaseAddress + <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> &lt; BaseAddress) {
01034         <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
01035     }
01036 
01037     <span class="keywordflow">if</span> (((PVOID)BaseAddress &gt; MM_HIGHEST_USER_ADDRESS) ||
01038         ((PVOID)(BaseAddress + <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) &gt; MM_HIGHEST_USER_ADDRESS)) {
01039 
01040             <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
01041     }
01042 
01043     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) {
01044         <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
01045     }
01046 
01047     <span class="keywordflow">if</span> (((PVOID)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> &gt; MM_HIGHEST_USER_ADDRESS) ||
01048         ((PVOID)(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) &gt; MM_HIGHEST_USER_ADDRESS)) {
01049 
01050             <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
01051     }
01052 
01053     <span class="keywordflow">return</span> STATUS_SUCCESS;
01054 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:37 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
