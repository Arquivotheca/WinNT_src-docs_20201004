<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: hivechek.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>hivechek.c</h1><a href="../../d9/d0/hivechek_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    hivechek.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements consistency checking for hives.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Bryan M. Willman (bryanwi) 09-Dec-91</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment"></span>
00020 <span class="comment">Revision History:</span>
00021 <span class="comment"></span>
00022 <span class="comment">--*/</span>
00023 
00024 <span class="preprocessor">#include    "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00025 
00026 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvCheckHive)</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvCheckBin)</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00030 <span class="preprocessor"></span>
00031 <span class="comment">//</span>
00032 <span class="comment">// debug structures</span>
00033 <span class="comment">//</span>
00034 <span class="keyword">extern</span> <span class="keyword">struct </span>{
<a name="l00035"></a><a class="code" href="../../d9/d0/hivechek_8c.html#a0">00035</a>     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>      <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00036     ULONG       <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
<a name="l00037"></a><a class="code" href="../../d9/d0/hivechek_8c.html#a2">00037</a>     ULONG       <a class="code" href="../../d7/d0/cmdat2_8c.html#a32">Space</a>;
<a name="l00038"></a><a class="code" href="../../d9/d0/hivechek_8c.html#a3">00038</a>     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d7/d0/cmdat2_8c.html#a33">MapPoint</a>;
<a name="l00039"></a><a class="code" href="../../d9/d0/hivechek_8c.html#a4">00039</a>     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>       <a class="code" href="../../d7/d0/cmdat2_8c.html#a34">BinPoint</a>;
00040 } <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>;
00041 
00042 <span class="keyword">extern</span> <span class="keyword">struct </span>{
<a name="l00043"></a><a class="code" href="../../d9/d0/hivechek_8c.html#a6">00043</a>     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>       <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
<a name="l00044"></a><a class="code" href="../../d9/d0/hivechek_8c.html#a1">00044</a>     ULONG       <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
<a name="l00045"></a><a class="code" href="../../d9/d0/hivechek_8c.html#a7">00045</a>     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>      <a class="code" href="../../d1/d0/cmchek_8c.html#a8">CellPoint</a>;
00046 } <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>;
00047 
00048 
00049 <span class="preprocessor">#if DBG</span>
00050 <span class="preprocessor"></span>ULONG HvHiveChecking=0;
00051 <span class="preprocessor">#endif</span>
00052 <span class="preprocessor"></span>
00053 ULONG
<a name="l00054"></a><a class="code" href="../../d9/d0/hivechek_8c.html#a9">00054</a> <a class="code" href="../../d9/d0/hivechek_8c.html#a9">HvCheckHive</a>(
00055     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>  Hive,
00056     PULONG  Storage OPTIONAL
00057     )
00058 <span class="comment">/*++</span>
00059 <span class="comment"></span>
00060 <span class="comment">Routine Description:</span>
00061 <span class="comment"></span>
00062 <span class="comment">    Check the consistency of a hive.  Apply CheckBin to bins, make sure</span>
00063 <span class="comment">    all pointers in the cell map point to correct places.</span>
00064 <span class="comment"></span>
00065 <span class="comment">Arguments:</span>
00066 <span class="comment"></span>
00067 <span class="comment">    Hive - supplies a pointer to the hive control structure for the</span>
00068 <span class="comment">            hive of interest.</span>
00069 <span class="comment"></span>
00070 <span class="comment">    Storage - supplies adddress of ULONG to receive size of allocated user data</span>
00071 <span class="comment"></span>
00072 <span class="comment">Return Value:</span>
00073 <span class="comment"></span>
00074 <span class="comment">    0 if Hive is OK.  Error return indicator if not.  Error value</span>
00075 <span class="comment">    comes from one of the check procedures.</span>
00076 <span class="comment"></span>
00077 <span class="comment">    RANGE:  2000 - 2999</span>
00078 <span class="comment"></span>
00079 <span class="comment">--*/</span>
00080 {
00081     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> p;
00082     ULONG       Length;
00083     ULONG       localstorage = 0;
00084     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>;
00085     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>       <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00086     ULONG   i;
00087     ULONG   rc;
00088     <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>  FreeBin;
00089 
00090     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Hive = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00091     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Status = 0;
00092     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Space = (ULONG)-1;
00093     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.MapPoint = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00094     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.BinPoint = 0;
00095 
00096     p = 0;
00097 
00098 
00099     <span class="comment">//</span>
00100     <span class="comment">// one pass for Stable space, one pass for Volatile</span>
00101     <span class="comment">//</span>
00102     <span class="keywordflow">for</span> (i = 0; i &lt;= <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>; i++) {
00103         Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[i].Length;
00104 
00105         <span class="comment">//</span>
00106         <span class="comment">// for each bin in the space</span>
00107         <span class="comment">//</span>
00108         <span class="keywordflow">while</span> (p &lt; Length) {
00109             <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, p);
00110             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00111                 KdPrint((<span class="stringliteral">"HvCheckHive:"</span>));
00112                 KdPrint((<span class="stringliteral">"\tBin@:%08lx invalid\n"</span>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>));
00113                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Status = 2005;
00114                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Space = i;
00115                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.MapPoint = p;
00116                 <span class="keywordflow">return</span> 2005;
00117             }
00118 
00119 
00120             <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BinAddress &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a36">HMAP_DISCARDABLE</a>) == 0) {
00121 
00122                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)((<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BinAddress) &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
00123 
00124                 <span class="comment">//</span>
00125                 <span class="comment">// bin header valid?</span>
00126                 <span class="comment">//</span>
00127                 <span class="keywordflow">if</span> ( (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> &gt; Length)                           ||
00128                      (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o0">Signature</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a24">HBIN_SIGNATURE</a>)             ||
00129                      (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> != p)
00130                    )
00131                 {
00132                     KdPrint((<span class="stringliteral">"HvCheckHive:"</span>));
00133                     KdPrint((<span class="stringliteral">"\tBin@:%08lx invalid\n"</span>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>));
00134                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Status = 2010;
00135                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Space = i;
00136                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.MapPoint = p;
00137                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.BinPoint = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00138                     <span class="keywordflow">return</span> 2010;
00139                 }
00140 
00141                 <span class="comment">//</span>
00142                 <span class="comment">// structure inside the bin valid?</span>
00143                 <span class="comment">//</span>
00144                 rc = <a class="code" href="../../d9/d0/hivechek_8c.html#a10">HvCheckBin</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>, &amp;localstorage);
00145                 <span class="keywordflow">if</span> (rc != 0) {
00146                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Status = rc;
00147                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Space = i;
00148                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.MapPoint = p;
00149                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.BinPoint = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00150                     <span class="keywordflow">return</span> rc;
00151                 }
00152 
00153                 p = (ULONG)p + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
00154 
00155             } <span class="keywordflow">else</span> {
00156                 <span class="comment">//</span>
00157                 <span class="comment">// Bin is not present, skip it and advance to the next one.</span>
00158                 <span class="comment">//</span>
00159                 FreeBin = (<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>)<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BlockAddress;
00160                 p+=FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>;
00161             }
00162         }
00163 
00164         p = 0x80000000;     <span class="comment">// Beginning of Volatile space</span>
00165     }
00166 
00167     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Storage)) {
00168         *Storage = localstorage;
00169     }
00170     <span class="keywordflow">return</span> 0;
00171 }
00172 
00173 
00174 ULONG
<a name="l00175"></a><a class="code" href="../../d9/d0/hivechek_8c.html#a10">00175</a> <a class="code" href="../../d9/d0/hivechek_8c.html#a10">HvCheckBin</a>(
00176     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>  Hive,
00177     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>   Bin,
00178     PULONG  Storage
00179     )
00180 <span class="comment">/*++</span>
00181 <span class="comment"></span>
00182 <span class="comment">Routine Description:</span>
00183 <span class="comment"></span>
00184 <span class="comment">    Step through all of the cells in the bin.  Make sure that</span>
00185 <span class="comment">    they are consistent with each other, and with the bin header.</span>
00186 <span class="comment"></span>
00187 <span class="comment">Arguments:</span>
00188 <span class="comment"></span>
00189 <span class="comment">    Hive - pointer to the hive control structure</span>
00190 <span class="comment"></span>
00191 <span class="comment">    Bin - pointer to bin to check</span>
00192 <span class="comment"></span>
00193 <span class="comment">    Storage - pointer to a ulong to get allocated user data size</span>
00194 <span class="comment"></span>
00195 <span class="comment">Return Value:</span>
00196 <span class="comment"></span>
00197 <span class="comment">    0 if Bin is OK.  Number of test in procedure that failed if not.</span>
00198 <span class="comment"></span>
00199 <span class="comment">    RANGE:  1 - 1999</span>
00200 <span class="comment"></span>
00201 <span class="comment">--*/</span>
00202 {
00203     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>  p;
00204     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>  np;
00205     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>  lp;
00206     ULONG   freespace = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00207     ULONG   allocated = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00208     ULONG   userallocated = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00209 
00210     <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.Bin = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00211     <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.Status = 0;
00212     <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.CellPoint = 0;
00213 
00214     <span class="comment">//</span>
00215     <span class="comment">// Scan all the cells in the bin, total free and allocated, check</span>
00216     <span class="comment">// for impossible pointers.</span>
00217     <span class="comment">//</span>
00218     p = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>));
00219     lp = p;
00220 
00221     <span class="comment">// DRAGOS:</span>
00222     <span class="comment">// The way allocated and freespace are computed implies the following invariants:</span>
00223     <span class="comment">// 1. allocated + freespace = p + p-&gt;Size - (Bin + sizeof(HBIN)). This is because p-&gt;Size is added either to allocated or to freespace.</span>
00224     <span class="comment">//    So, assuming that allocated &gt; Bin-&gt;Size , then</span>
00225     <span class="comment">//              ==&gt; p + p-&gt;Size - (Bin + sizeof(HBIN)) &gt; Bin-&gt;Size.</span>
00226     <span class="comment">//              ==&gt; p + p-&gt;Size &gt; Bin + Bin-&gt;Size + sizeof(HBIN)</span>
00227     <span class="comment">//              ==&gt; p + p-&gt;Size &gt; Bin + Bin-&gt;Size</span>
00228     <span class="comment">//      This proves that the test "NeverFail 1" (see bellow) will never fail, because when something is wrong, the test above it (namely "Fail 1") will fail </span>
00229     <span class="comment">//      and the function will exit.</span>
00230     <span class="comment">//</span>
00231     <span class="comment">//    The same logic applies to the test "NeverFail 2", so it can be removed also.</span>
00232     <span class="comment">//</span>
00233     <span class="comment">// 2. The new value of p is always calculated as p = p + p-&gt;Size. By the time this is done, the new value of p (ie. p + p-&gt;Size) is already checked against </span>
00234     <span class="comment">//      Bin + Bin-&gt;Size (see tests "Fail 1" and "Fail 2"). So, if p &gt; Bin + Bin-&gt;Size, either "Fail 1" or "Fail 2" will fail before asigning the new bogus value </span>
00235     <span class="comment">//      to p. Therefore, the only possible path to exit the while loop (except a return 20 or return 40), is when p == Bin + Bin-&gt;Size.</span>
00236     <span class="comment">//      ==&gt; test "NeverFail 3" can be removed as it will never fail !</span>
00237     <span class="comment">//</span>
00238     <span class="comment">// 3. Considering 1 (where p + p-&gt;Size became p) </span>
00239     <span class="comment">//              ==&gt; allocated + freespace =  p - (Bin + sizeof(HBIN))</span>
00240     <span class="comment">//    But, Considering 2 (above), when the while loop exits, p = Bin + Bin-&gt;Size</span>
00241     <span class="comment">//              ==&gt; allocated + freespace = Bin + Bin-&gt;Size - (Bin + sizeof(HBIN))</span>
00242     <span class="comment">//              ==&gt; allocated + freespace + sizeof(HBIN) = Bin-&gt;Size</span>
00243     <span class="comment">//       This proves that test "NeverFail 4" (see bellow) will never fail as the expresion tested is always true (if the flow of execution reaches the test point).</span>
00244     <span class="comment">//</span>
00245 
00246     <span class="keywordflow">while</span> (p &lt; (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>)) {
00247 
00248         <span class="comment">//</span>
00249         <span class="comment">// Check last pointer</span>
00250         <span class="comment">//</span>
00251         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>)) {
00252             <span class="keywordflow">if</span> (lp == p) {
00253                 <span class="keywordflow">if</span> (p-&gt;u.OldCell.Last != <a class="code" href="../../d0/d1/hivedata_8h.html#a25">HBIN_NIL</a>) {
00254                     KdPrint((<span class="stringliteral">"HvCheckBin 20: First cell has wrong last pointer\n"</span>));
00255                     KdPrint((<span class="stringliteral">"Bin = %08lx\n"</span>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>));
00256                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.Status = 20;
00257                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.CellPoint = p;
00258                     <span class="keywordflow">return</span> 20;
00259                 }
00260             } <span class="keywordflow">else</span> {
00261                 <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)(p-&gt;u.OldCell.Last + (PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>) != lp) {
00262                     KdPrint((<span class="stringliteral">"HvCheckBin 30: incorrect last pointer\n"</span>));
00263                     KdPrint((<span class="stringliteral">"Bin = %08lx\n"</span>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>));
00264                     KdPrint((<span class="stringliteral">"p = %08lx\n"</span>, (ULONG_PTR)p));
00265                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.Status = 30;
00266                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.CellPoint = p;
00267                     <span class="keywordflow">return</span> 30;
00268                 }
00269             }
00270         }
00271 
00272         
00273         <span class="comment">//</span>
00274         <span class="comment">// Check size</span>
00275         <span class="comment">//</span>
00276         <span class="keywordflow">if</span> (p-&gt;Size &lt; 0) {
00277 
00278             <span class="comment">//</span>
00279             <span class="comment">// allocated cell</span>
00280             <span class="comment">//</span>
00281 
00282             <span class="comment">// DRAGOS:    Fail 1</span>
00283             <span class="comment">// This test will alway fail prior to the failure of the bellow test</span>
00284             <span class="comment">//</span>
00285             <span class="keywordflow">if</span> ( ((ULONG)(p-&gt;Size * -1) &gt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>)        ||
00286                  ( (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((p-&gt;Size * -1) + (PUCHAR)p) &gt;
00287                    (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) )
00288                )
00289             {
00290                 KdPrint((<span class="stringliteral">"HvCheckBin 40: impossible allocation\n"</span>));
00291                 KdPrint((<span class="stringliteral">"Bin = %08lx\n"</span>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>));
00292                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.Status = 40;
00293                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.CellPoint = p;
00294                 <span class="keywordflow">return</span> 40;
00295             }
00296 
00297             allocated += (p-&gt;Size * -1);
00298             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>)) {
00299                 userallocated += (p-&gt;Size * -1) - FIELD_OFFSET(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>, u.OldCell.u.UserData);
00300             } <span class="keywordflow">else</span> {
00301                 userallocated += (p-&gt;Size * -1) - FIELD_OFFSET(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>, u.NewCell.u.UserData);
00302             }
00303 
00304             <span class="comment">//</span>
00305             <span class="comment">// DRAGOS:   NeverFail 1</span>
00306             <span class="comment">// This test will never fail. If a size is wrong the above test (Fail 1)will fail. We can remove this test (it's useless).</span>
00307             <span class="comment">//</span>
00308             <span class="keywordflow">if</span> (allocated &gt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) {
00309                 KdPrint((<span class="stringliteral">"HvCheckBin 50: allocated exceeds available\n"</span>));
00310                 KdPrint((<span class="stringliteral">"Bin = %08lx\n"</span>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>));
00311                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.Status = 50;
00312                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.CellPoint = p;
00313                 <span class="keywordflow">return</span> 50;
00314             }
00315 
00316             np = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)p + (p-&gt;Size * -1));
00317 
00318 
00319 
00320         } <span class="keywordflow">else</span> {
00321 
00322             <span class="comment">//</span>
00323             <span class="comment">// free cell</span>
00324             <span class="comment">//</span>
00325 
00326             <span class="comment">// DRAGOS:    Fail 2</span>
00327             <span class="comment">// This test will alway fail prior to the failure of the bellow test</span>
00328             <span class="comment">//</span>
00329             <span class="keywordflow">if</span> ( ((ULONG)p-&gt;Size &gt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>)               ||
00330                  ( (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)(p-&gt;Size + (PUCHAR)p) &gt;
00331                    (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) ) ||
00332                  (p-&gt;Size == 0) )
00333             {
00334                 KdPrint((<span class="stringliteral">"HvCheckBin 60: impossible free block\n"</span>));
00335                 KdPrint((<span class="stringliteral">"Bin = %08lx\n"</span>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>));
00336                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.Status = 60;
00337                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.CellPoint = p;
00338                 <span class="keywordflow">return</span> 60;
00339             }
00340 
00341             freespace = freespace + p-&gt;Size;
00342 
00343             <span class="comment">//</span>
00344             <span class="comment">// DRAGOS:   NeverFail 2</span>
00345             <span class="comment">// This test will never fail. If a size is wrong the above test (Fail 2) will fail. We can remove this test (it's useless).</span>
00346             <span class="comment">//</span>
00347             <span class="keywordflow">if</span> (freespace &gt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) {
00348                 KdPrint((<span class="stringliteral">"HvCheckBin 70: free exceeds available\n"</span>));
00349                 KdPrint((<span class="stringliteral">"Bin = %08lx\n"</span>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>));
00350                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.Status = 70;
00351                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.CellPoint = p;
00352                 <span class="keywordflow">return</span> 70;
00353             }
00354 
00355             np = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)p + p-&gt;Size);
00356 
00357         }
00358 
00359         lp = p;
00360         p = np;
00361     }
00362 
00363     <span class="comment">// DRAGOS:  NeverFail 4</span>
00364     <span class="comment">// This test never fails. If the while loop exits, the condition tested here is always true!!!</span>
00365     <span class="comment">// We can remove this test (it's useless)</span>
00366     <span class="comment">//</span>
00367     <span class="keywordflow">if</span> ((freespace + allocated + <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>)) != <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) {
00368         KdPrint((<span class="stringliteral">"HvCheckBin 995: sizes do not add up\n"</span>));
00369         KdPrint((<span class="stringliteral">"Bin = %08lx\n"</span>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>));
00370         KdPrint((<span class="stringliteral">"freespace = %08lx  "</span>, freespace));
00371         KdPrint((<span class="stringliteral">"allocated = %08lx  "</span>, allocated));
00372         KdPrint((<span class="stringliteral">"size = %08lx\n"</span>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>));
00373         <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.Status = 995;
00374         <span class="keywordflow">return</span> 995;
00375     }
00376 
00377     <span class="comment">// DRAGOS:  NeverFail 3</span>
00378     <span class="comment">// This test never fails. The only way out of the while loop is when p == Bin + Bin-&gt;Size !!!!!!!</span>
00379     <span class="comment">// We can remove this test (it's useless)</span>
00380     <span class="comment">//</span>
00381     <span class="keywordflow">if</span> (p != (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>)) {
00382         KdPrint((<span class="stringliteral">"HvCheckBin 1000: last cell points off the end\n"</span>));
00383         KdPrint((<span class="stringliteral">"Bin = %08lx\n"</span>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>));
00384         <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.Status = 1000;
00385         <span class="keywordflow">return</span> 1000;
00386     }
00387 
00388     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Storage)) {
00389         *Storage += userallocated;
00390     }
00391     <span class="keywordflow">return</span> 0;
00392 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:17 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
