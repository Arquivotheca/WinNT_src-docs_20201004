<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: dockhwp.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>dockhwp.c</h1><a href="../../d9/d0/dockhwp_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1998  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    dock.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment"></span>
00012 <span class="comment">Author:</span>
00013 <span class="comment"></span>
00014 <span class="comment">    Kenneth D. Ray (kenray) Feb 1998</span>
00015 <span class="comment"></span>
00016 <span class="comment">Revision History:</span>
00017 <span class="comment"></span>
00018 <span class="comment">--*/</span>
00019 
00020 <span class="preprocessor">#include "<a class="code" href="../../d0/d6/iop_8h.html">iop.h</a>"</span>
00021 <span class="preprocessor">#undef ExAllocatePool</span>
00022 <span class="preprocessor"></span><span class="preprocessor">#undef ExAllocatePoolWithQuota</span>
00023 <span class="preprocessor"></span><span class="preprocessor">#include "..\config\cmp.h"</span>
00024 <span class="preprocessor">#include &lt;string.h&gt;</span>
00025 <span class="preprocessor">#include &lt;<a class="code" href="../../d6/d7/profiles_8h.html">profiles.h</a>&gt;</span>
00026 <span class="preprocessor">#include &lt;wdmguid.h&gt;</span>
00027 
00028 <span class="preprocessor">#if DBG</span>
00029 <span class="preprocessor"></span>
00030 <span class="preprocessor">#define ASSERT_SEMA_NOT_SIGNALLED(SemaphoreObject) \</span>
00031 <span class="preprocessor">    ASSERT(KeReadStateSemaphore(SemaphoreObject) == 0) ;</span>
00032 <span class="preprocessor"></span>
00033 <span class="preprocessor">#else // DBG</span>
00034 <span class="preprocessor"></span>
<a name="l00035"></a><a class="code" href="../../d9/d0/dockhwp_8c.html#a0">00035</a> <span class="preprocessor">#define ASSERT_SEMA_NOT_SIGNALLED(SemaphoreObject)</span>
00036 <span class="preprocessor"></span>
00037 <span class="preprocessor">#endif // DBG</span>
00038 <span class="preprocessor"></span>
00039 <span class="comment">//</span>
00040 <span class="comment">// Internal functions to dockhwp.c</span>
00041 <span class="comment">//</span>
00042 
00043 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00044 <a class="code" href="../../d9/d0/dockhwp_8c.html#a8">IopExecuteHardwareProfileChange</a>(
00045     IN  <a class="code" href="../../d9/d0/pnpiop_8h.html#a194">HARDWARE_PROFILE_BUS_TYPE</a>   Bus,
00046     IN  PWCHAR                    * ProfileSerialNumbers,
00047     IN  ULONG                       SerialNumbersCount,
00048     OUT PHANDLE                     NewProfile,
00049     OUT PBOOLEAN                    ProfileChanged
00050     );
00051 
00052 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00053 <a class="code" href="../../d9/d0/dockhwp_8c.html#a9">IopUpdateHardwareProfile</a> (
00054     OUT PBOOLEAN   ProfileChanged
00055     );
00056 
00057 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00058 <a class="code" href="../../d9/d0/dockhwp_8c.html#a10">IopHardwareProfileSendCommit</a>(
00059     VOID
00060     );
00061 
00062 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00063 <a class="code" href="../../d9/d0/dockhwp_8c.html#a11">IopHardwareProfileSendCancel</a>(
00064     VOID
00065     );
00066 
00067 <span class="comment">//</span>
00068 <span class="comment">// List of current dock devices, and the number of dockdevices.</span>
00069 <span class="comment">// Must hold IopDockDeviceListLock to change these values.</span>
00070 <span class="comment">//</span>
<a name="l00071"></a><a class="code" href="../../d9/d0/dockhwp_8c.html#a1">00071</a> LIST_ENTRY  <a class="code" href="../../d9/d0/dockhwp_8c.html#a1">IopDockDeviceListHead</a>;
<a name="l00072"></a><a class="code" href="../../d9/d0/dockhwp_8c.html#a2">00072</a> ULONG       <a class="code" href="../../d9/d0/dockhwp_8c.html#a2">IopDockDeviceCount</a>;
<a name="l00073"></a><a class="code" href="../../d9/d0/dockhwp_8c.html#a3">00073</a> <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>  <a class="code" href="../../d9/d0/dockhwp_8c.html#a3">IopDockDeviceListLock</a>;
<a name="l00074"></a><a class="code" href="../../d9/d0/dockhwp_8c.html#a4">00074</a> <a class="code" href="../../d8/d7/struct__KSEMAPHORE.html">KSEMAPHORE</a>  <a class="code" href="../../d9/d0/dockhwp_8c.html#a4">IopProfileChangeSemaphore</a>;
<a name="l00075"></a><a class="code" href="../../d9/d0/dockhwp_8c.html#a5">00075</a> BOOLEAN     <a class="code" href="../../d9/d0/dockhwp_8c.html#a5">IopProfileChangeCancelRequired</a>;
<a name="l00076"></a><a class="code" href="../../d9/d0/dockhwp_8c.html#a6">00076</a> LONG        <a class="code" href="../../d9/d0/dockhwp_8c.html#a6">IopDocksInTransition</a>;
00077 
<a name="l00078"></a><a class="code" href="../../d2/d6/structPROFILE__WORK__ITEM.html">00078</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
00079 
<a name="l00080"></a><a class="code" href="../../d2/d6/structPROFILE__WORK__ITEM.html#o0">00080</a>     <a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">WORK_QUEUE_ITEM</a> WorkItem;
<a name="l00081"></a><a class="code" href="../../d2/d6/structPROFILE__WORK__ITEM.html#o1">00081</a>     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>          NotificationCompleted ;
<a name="l00082"></a><a class="code" href="../../d2/d6/structPROFILE__WORK__ITEM.html#o2">00082</a>     LPGUID          NotificationGuid ;
<a name="l00083"></a><a class="code" href="../../d2/d6/structPROFILE__WORK__ITEM.html#o3">00083</a>     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        FinalStatus ;
<a name="l00084"></a><a class="code" href="../../d2/d6/structPROFILE__WORK__ITEM.html#o4">00084</a>     PPNP_VETO_TYPE  VetoType ;
<a name="l00085"></a><a class="code" href="../../d2/d6/structPROFILE__WORK__ITEM.html#o5">00085</a>     PUNICODE_STRING VetoName ;
00086 
00087 } <a class="code" href="../../d2/d6/structPROFILE__WORK__ITEM.html">PROFILE_WORK_ITEM</a>, *<a class="code" href="../../d9/d0/dockhwp_8c.html#a7">PPROFILE_WORK_ITEM</a> ;
00088 
00089 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00090 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopHardwareProfileBeginTransition)</span>
00091 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopHardwareProfileMarkDock)</span>
00092 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopHardwareProfileQueryChange)</span>
00093 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopHardwareProfileCommitStartedDock)</span>
00094 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopHardwareProfileCommitRemovedDock)</span>
00095 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopHardwareProfileCancelRemovedDock)</span>
00096 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopHardwareProfileCancelTransition)</span>
00097 <span class="preprocessor"></span><span class="preprocessor">#define alloc_text(PAGE, IopHardwareProfileSendCommit)</span>
00098 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopHardwareProfileSendCancel)</span>
00099 <span class="preprocessor"></span><span class="preprocessor">#endif // ALLOC_PRAGMA</span>
00100 <span class="preprocessor"></span>
00101 
00102 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00103"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a377">00103</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a377">IopHardwareProfileBeginTransition</a>(
00104     IN BOOLEAN SubsumeExistingDeparture
00105     )
00106 <span class="comment">/*++</span>
00107 <span class="comment"></span>
00108 <span class="comment">Routine Description:</span>
00109 <span class="comment"></span>
00110 <span class="comment">    This routine must be called before any dock devnodes can be marked for</span>
00111 <span class="comment">    transition (ie arriving or departing). After calling this function,</span>
00112 <span class="comment">    IopHardwareProfileMarkDock should be called for each dock that is appearing</span>
00113 <span class="comment">    or disappearing.</span>
00114 <span class="comment"></span>
00115 <span class="comment">    Functionally, this code acquires the profile change semaphore. Future</span>
00116 <span class="comment">    changes in the life of the added dock devnodes cause it to be released.</span>
00117 <span class="comment"></span>
00118 <span class="comment">Arguments:</span>
00119 <span class="comment"></span>
00120 <span class="comment">    SubsumeExistingDeparture - Set if we are ejecting the parent of a</span>
00121 <span class="comment">                               device that is still in the process of</span>
00122 <span class="comment">                               ejecting...</span>
00123 <span class="comment"></span>
00124 <span class="comment">Return Value:</span>
00125 <span class="comment"></span>
00126 <span class="comment">    None.</span>
00127 <span class="comment"></span>
00128 <span class="comment">--*/</span>
00129 {
00130     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status ;
00131 
00132     <span class="keywordflow">if</span> (SubsumeExistingDeparture) {
00133 
00134         <span class="comment">//</span>
00135         <span class="comment">// We will already have queried in this case. Also, enumeration is</span>
00136         <span class="comment">// locked right now, so the appropriate devices found cannot disappear.</span>
00137         <span class="comment">// Assert everything is consistant.</span>
00138         <span class="comment">//</span>
00139         <a class="code" href="../../d9/d0/dockhwp_8c.html#a0">ASSERT_SEMA_NOT_SIGNALLED</a>(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a4">IopProfileChangeSemaphore</a>) ;
00140         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d9/d0/dockhwp_8c.html#a6">IopDocksInTransition</a> != 0) ;
00141         <span class="keywordflow">return</span> ;
00142     }
00143 
00144     <span class="comment">//</span>
00145     <span class="comment">// Take the profile change semaphore. We do this whenever a dock is</span>
00146     <span class="comment">// in our list, even if no query is going to occur.</span>
00147     <span class="comment">//</span>
00148     status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(
00149         &amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a4">IopProfileChangeSemaphore</a>,
00150         <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
00151         <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00152         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00153         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00154         );
00155 
00156     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_SUCCESS) ;
00157 }
00158 
00159 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00160"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a378">00160</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a378">IopHardwareProfileMarkDock</a>(
00161     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>    DeviceNode,
00162     PROFILE_STATUS  ChangeInPresence
00163     )
00164 <span class="comment">/*++</span>
00165 <span class="comment"></span>
00166 <span class="comment">Routine Description:</span>
00167 <span class="comment"></span>
00168 <span class="comment">    This routine is called to mark a dock as "in transition", ie it is either</span>
00169 <span class="comment">    disappearing or appearing, the results of which determine our final</span>
00170 <span class="comment">    hardware profile state. After all the docks that are transitioning have</span>
00171 <span class="comment">    been passed into this function, IopHardwareProfileQueryChange is called.</span>
00172 <span class="comment"></span>
00173 <span class="comment">Arguments:</span>
00174 <span class="comment"></span>
00175 <span class="comment">    DeviceNode          - The dock devnode that is appearing or disappearing</span>
00176 <span class="comment">    ChangeInPresence    - Either DOCK_DEPARTING or DOCK_ARRIVING</span>
00177 <span class="comment"></span>
00178 <span class="comment">Return Value:</span>
00179 <span class="comment"></span>
00180 <span class="comment">    Nope.</span>
00181 <span class="comment"></span>
00182 <span class="comment">--*/</span>
00183 {
00184     PWCHAR          deviceSerialNumber;
00185     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>  deviceObject;
00186     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        status;
00187 
00188     <span class="comment">//</span>
00189     <span class="comment">// Verify we are under semaphore, we aren't marking the dock twice, and</span>
00190     <span class="comment">// our parameters are sensable.</span>
00191     <span class="comment">//</span>
00192     <a class="code" href="../../d9/d0/dockhwp_8c.html#a0">ASSERT_SEMA_NOT_SIGNALLED</a>(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a4">IopProfileChangeSemaphore</a>) ;
00193     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus == <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a204">DOCK_QUIESCENT</a>) ;
00194     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((ChangeInPresence == <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a206">DOCK_DEPARTING</a>)||
00195            (ChangeInPresence == <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a205">DOCK_ARRIVING</a>)) ;
00196 
00197     <span class="keywordflow">if</span> (ChangeInPresence == <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a205">DOCK_ARRIVING</a>) {
00198 
00199         <span class="comment">//</span>
00200         <span class="comment">// First, ensure this dock is a member of the dock list.</span>
00201         <span class="comment">// ADRIAO BUGBUG 11/12/98 -</span>
00202         <span class="comment">//     We should move this into IopProcessNewDeviceNode.</span>
00203         <span class="comment">//</span>
00204         <span class="keywordflow">if</span> (IsListEmpty(&amp;DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.ListEntry)) {
00205 
00206             <span class="comment">//</span>
00207             <span class="comment">// Acquire the lock on the list of dock devices</span>
00208             <span class="comment">//</span>
00209             ExAcquireFastMutex(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a3">IopDockDeviceListLock</a>);
00210 
00211             <span class="comment">//</span>
00212             <span class="comment">// Add this element to the head of the list</span>
00213             <span class="comment">//</span>
00214             InsertHeadList(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a1">IopDockDeviceListHead</a>,
00215                            &amp;DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.ListEntry);
00216             <a class="code" href="../../d9/d0/dockhwp_8c.html#a2">IopDockDeviceCount</a>++;
00217 
00218             <span class="comment">//</span>
00219             <span class="comment">// Release the lock on the list of dock devices</span>
00220             <span class="comment">//</span>
00221             ExReleaseFastMutex(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a3">IopDockDeviceListLock</a>);
00222         }
00223 
00224         <span class="comment">//</span>
00225         <span class="comment">// Retrieve the Serial Number from this dock device. We do this just</span>
00226         <span class="comment">// to test the BIOS today. Later we will be acquiring the information</span>
00227         <span class="comment">// to determine the profile we are *about* to enter.</span>
00228         <span class="comment">//</span>
00229         deviceObject = DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>;
00230         status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a35">IopQueryDeviceSerialNumber</a>(deviceObject,
00231                                             &amp;deviceSerialNumber);
00232 
00233         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; (deviceSerialNumber != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00234 
00235             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceSerialNumber) ;
00236         }
00237 
00238     } <span class="keywordflow">else</span> {
00239 
00240         <span class="comment">//</span>
00241         <span class="comment">// DOCK_DEPARTING case, we must be a member of the dock list...</span>
00242         <span class="comment">//</span>
00243         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!IsListEmpty(&amp;DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.ListEntry)) ;
00244     }
00245 
00246     InterlockedIncrement(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a6">IopDocksInTransition</a>) ;
00247     DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus = ChangeInPresence ;
00248 }
00249 
00250 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00251"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a379">00251</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a379">IopHardwareProfileQueryChange</a>(
00252     IN  BOOLEAN                     SubsumingExistingDeparture,
00253     IN  PROFILE_NOTIFICATION_TIME   InPnpEvent,
00254     OUT PPNP_VETO_TYPE              VetoType,
00255     OUT PUNICODE_STRING             VetoName OPTIONAL
00256     )
00257 <span class="comment">/*++</span>
00258 <span class="comment"></span>
00259 <span class="comment">Routine Description:</span>
00260 <span class="comment"></span>
00261 <span class="comment">    This function queries drivers to see if it is OK to exit the current</span>
00262 <span class="comment">    hardware profile and enter next one (as determined by which docks have</span>
00263 <span class="comment">    been marked). One of three functions should be used subsequently to this</span>
00264 <span class="comment">    call:</span>
00265 <span class="comment">        IopHardwareProfileCommitStartedDock (call when a dock has successfully</span>
00266 <span class="comment">                                             started)</span>
00267 <span class="comment">        IopHardwareProfileCommitRemovedDock (call when a dock is no longer</span>
00268 <span class="comment">                                             present in the system)</span>
00269 <span class="comment">        IopHardwareProfileCancelTransition  (call to abort a transition, say</span>
00270 <span class="comment">                                             if a dock failed to start or a</span>
00271 <span class="comment">                                             query returned failure for eject)</span>
00272 <span class="comment"></span>
00273 <span class="comment">Arguments:</span>
00274 <span class="comment"></span>
00275 <span class="comment">    InPnpEvent  - This argument indicates whether an operation is being done</span>
00276 <span class="comment">                  within the context of another PnpEvent or not. If not, we</span>
00277 <span class="comment">                  will queue such an event and block on it. If so, we cannot</span>
00278 <span class="comment">                  queue&amp;block (we'd deadlock), so we do the query manually.</span>
00279 <span class="comment">    VetoType    - If this function returns false, this parameter will describe</span>
00280 <span class="comment">                  who failed the query profile change. The below optional</span>
00281 <span class="comment">                  parameter will contain the name of said vetoer.</span>
00282 <span class="comment">    VetoName    - This optional parameter will get the name of the vetoer (ie</span>
00283 <span class="comment">                  devinst, service name, application name, etc). If VetoName</span>
00284 <span class="comment">                  is supplied, the caller must free the buffer returned.</span>
00285 <span class="comment"></span>
00286 <span class="comment">Return Value:</span>
00287 <span class="comment"></span>
00288 <span class="comment">    NTSTATUS.</span>
00289 <span class="comment"></span>
00290 <span class="comment">--*/</span>
00291 {
00292     <a class="code" href="../../d2/d6/structPROFILE__WORK__ITEM.html">PROFILE_WORK_ITEM</a> profileWorkItem;
00293     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00294     BOOLEAN arrivingDockFound;
00295     PLIST_ENTRY listEntry ;
00296     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> devNode ;
00297 
00298     <a class="code" href="../../d9/d0/dockhwp_8c.html#a0">ASSERT_SEMA_NOT_SIGNALLED</a>(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a4">IopProfileChangeSemaphore</a>) ;
00299 
00300     <span class="comment">//</span>
00301     <span class="comment">// Acquire the lock on the list of dock devices and determine whether any</span>
00302     <span class="comment">// dock devnodes are arriving.</span>
00303     <span class="comment">//</span>
00304     ExAcquireFastMutex(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a3">IopDockDeviceListLock</a>);
00305 
00306     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d9/d0/dockhwp_8c.html#a6">IopDocksInTransition</a>) ;
00307 
00308     arrivingDockFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
00309     <span class="keywordflow">for</span> (listEntry  = <a class="code" href="../../d9/d0/dockhwp_8c.html#a1">IopDockDeviceListHead</a>.Flink;
00310         listEntry != &amp;(<a class="code" href="../../d9/d0/dockhwp_8c.html#a1">IopDockDeviceListHead</a>);
00311         listEntry  = listEntry-&gt;Flink ) {
00312 
00313         devNode = CONTAINING_RECORD(listEntry,
00314                                     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">DEVICE_NODE</a>,
00315                                     DockInfo.ListEntry);
00316 
00317         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus != <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a203">DOCK_NOTDOCKDEVICE</a>)&amp;&amp;
00318                (devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus != <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a207">DOCK_EJECTIRP_COMPLETED</a>)) ;
00319 
00320         <span class="keywordflow">if</span> (devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus == <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a205">DOCK_ARRIVING</a>) {
00321 
00322             arrivingDockFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
00323         }
00324     }
00325 
00326     <span class="comment">//</span>
00327     <span class="comment">// Release the lock on the list of dock devices</span>
00328     <span class="comment">//</span>
00329     ExReleaseFastMutex(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a3">IopDockDeviceListLock</a>);
00330 
00331     <span class="keywordflow">if</span> (SubsumingExistingDeparture) {
00332 
00333         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d9/d0/dockhwp_8c.html#a5">IopProfileChangeCancelRequired</a>) ;
00334         <span class="comment">//</span>
00335         <span class="comment">// We're nesting. Work off the last query, and don't requery.</span>
00336         <span class="comment">//</span>
00337         <span class="keywordflow">return</span> STATUS_SUCCESS ;
00338     }
00339 
00340     <span class="keywordflow">if</span> (arrivingDockFound) {
00341 
00342         <span class="comment">//</span>
00343         <span class="comment">// We currently don't actually query for hardware profile change on a</span>
00344         <span class="comment">// dock event as the user may have the lid closed. If we ever find a</span>
00345         <span class="comment">// piece of hardware that needs to be updated *prior* to actually</span>
00346         <span class="comment">// switching over, we will have to remove this bit of code.</span>
00347         <span class="comment">//</span>
00348         <a class="code" href="../../d9/d0/dockhwp_8c.html#a5">IopProfileChangeCancelRequired</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
00349         <span class="keywordflow">return</span> STATUS_SUCCESS ;
00350     }
00351 
00352     PIDBGMSG(PIDBG_HWPROFILE, (<span class="stringliteral">"NTOSKRNL: Sending HW profile change [query]\n"</span>)) ;
00353 
00354     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a348">IopRequestHwProfileChangeNotification</a>(
00355         (LPGUID) &amp;GUID_HWPROFILE_QUERY_CHANGE,
00356         InPnpEvent,
00357         VetoType,
00358         VetoName
00359         );
00360 
00361     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00362         <a class="code" href="../../d9/d0/dockhwp_8c.html#a5">IopProfileChangeCancelRequired</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
00363     } <span class="keywordflow">else</span> {
00364         <a class="code" href="../../d9/d0/dockhwp_8c.html#a5">IopProfileChangeCancelRequired</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
00365     }
00366     <span class="keywordflow">return</span> status ;
00367 }
00368 
00369 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00370"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a380">00370</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a380">IopHardwareProfileCommitStartedDock</a>(
00371     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode
00372     )
00373 <span class="comment">/*++</span>
00374 <span class="comment"></span>
00375 <span class="comment">Routine Description:</span>
00376 <span class="comment"></span>
00377 <span class="comment">    This routine adds the specified device from the list of current dock</span>
00378 <span class="comment">    devices and requests a Hardware Profile change.</span>
00379 <span class="comment"></span>
00380 <span class="comment">Arguments:</span>
00381 <span class="comment"></span>
00382 <span class="comment">    DeviceNode  - Supplies a pointer to a device node which will be started and</span>
00383 <span class="comment">                  enumerated.</span>
00384 <span class="comment"></span>
00385 <span class="comment">Return Value:</span>
00386 <span class="comment"></span>
00387 <span class="comment">    None.</span>
00388 <span class="comment"></span>
00389 <span class="comment">--*/</span>
00390 {
00391     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00392     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00393     PWCHAR  deviceSerialNumber;
00394     BOOLEAN profileChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
00395 
00396     <a class="code" href="../../d9/d0/dockhwp_8c.html#a0">ASSERT_SEMA_NOT_SIGNALLED</a>(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a4">IopProfileChangeSemaphore</a>) ;
00397     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode-&gt;DockInfo.DockStatus == <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a205">DOCK_ARRIVING</a>) ;
00398     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!IsListEmpty(&amp;DeviceNode-&gt;DockInfo.ListEntry)) ;
00399 
00400     DeviceNode-&gt;DockInfo.DockStatus = <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a204">DOCK_QUIESCENT</a> ;
00401     InterlockedDecrement(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a6">IopDocksInTransition</a>) ;
00402 
00403     <span class="comment">//</span>
00404     <span class="comment">// We only add one dock at a time. So this should have been the last!</span>
00405     <span class="comment">//</span>
00406     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d9/d0/dockhwp_8c.html#a6">IopDocksInTransition</a>) ;
00407 
00408     <span class="comment">//</span>
00409     <span class="comment">// Retrieve the Serial Number from this dock device</span>
00410     <span class="comment">//</span>
00411     <span class="keywordflow">if</span> (DeviceNode-&gt;DockInfo.SerialNumber == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00412 
00413         deviceObject = DeviceNode-&gt;PhysicalDeviceObject;
00414 
00415         status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a35">IopQueryDeviceSerialNumber</a>(deviceObject,
00416                                             &amp;deviceSerialNumber);
00417 
00418         DeviceNode-&gt;DockInfo.SerialNumber = deviceSerialNumber;
00419 
00420         <span class="comment">//</span>
00421         <span class="comment">// Update the current Hardware Profile after successfully starting this</span>
00422         <span class="comment">// device. This routine does two things for us:</span>
00423         <span class="comment">// 1) It determines whether the profile actually changed and updates</span>
00424         <span class="comment">//    the global flag IopProfileChangeOccured appropriately.</span>
00425         <span class="comment">// 2) If the profile changed, this routine updates the registry, but</span>
00426         <span class="comment">//    does *not* broadcast the profile change around.</span>
00427         <span class="comment">//</span>
00428         status = <a class="code" href="../../d9/d0/dockhwp_8c.html#a9">IopUpdateHardwareProfile</a>(&amp;profileChanged);
00429         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00430 
00431             PIDBGMSG(
00432                 PIDBG_HWPROFILE,
00433                 (<span class="stringliteral">"IopUpdateHardwareProfile failed with status == %lx\n"</span>, status)
00434                 ) ;
00435         }
00436 
00437     } <span class="keywordflow">else</span> {
00438         <span class="comment">//</span>
00439         <span class="comment">// Couldn't get Serial Number for this dock device, or serial number was NULL</span>
00440         <span class="comment">//</span>
00441         status = STATUS_UNSUCCESSFUL;
00442     }
00443 
00444     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; profileChanged) {
00445 
00446         <a class="code" href="../../d9/d0/dockhwp_8c.html#a10">IopHardwareProfileSendCommit</a>() ;
00447         <a class="code" href="../../d9/d0/pnpiop_8h.html#a361">IopProcessNewProfile</a>();
00448 
00449     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/dockhwp_8c.html#a5">IopProfileChangeCancelRequired</a>) {
00450 
00451         <a class="code" href="../../d9/d0/dockhwp_8c.html#a11">IopHardwareProfileSendCancel</a>() ;
00452     }
00453 
00454     <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(
00455         &amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a4">IopProfileChangeSemaphore</a>,
00456         <a class="code" href="../../d7/d8/exboosts_8h.html#a3">IO_NO_INCREMENT</a>,
00457         1,
00458         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00459         );
00460 
00461     <span class="keywordflow">return</span> ;
00462 }
00463 
00464 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00465"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a381">00465</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a381">IopHardwareProfileCommitRemovedDock</a>(
00466     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode
00467     )
00468 <span class="comment">/*++</span>
00469 <span class="comment"></span>
00470 <span class="comment">Routine Description:</span>
00471 <span class="comment"></span>
00472 <span class="comment">    This routine removes the specified device from the list of current dock</span>
00473 <span class="comment">    devices and requests a Hardware Profile change.</span>
00474 <span class="comment"></span>
00475 <span class="comment">Arguments:</span>
00476 <span class="comment"></span>
00477 <span class="comment">    DeviceNode - Supplies a pointer to a device node which has been listed as</span>
00478 <span class="comment">                 missing in a previous enumeration, has had the final remove IRP</span>
00479 <span class="comment">                 sent to it, and is about to be deleted.</span>
00480 <span class="comment"></span>
00481 <span class="comment">Return Value:</span>
00482 <span class="comment"></span>
00483 <span class="comment">    None.</span>
00484 <span class="comment"></span>
00485 <span class="comment">--*/</span>
00486 {
00487     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00488     BOOLEAN  profileChanged ;
00489     LONG     remainingDockCount ;
00490 
00491     <span class="comment">//</span>
00492     <span class="comment">// Acquire the lock on the list of dock devices</span>
00493     <span class="comment">//</span>
00494     ExAcquireFastMutex(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a3">IopDockDeviceListLock</a>);
00495 
00496     <span class="comment">//</span>
00497     <span class="comment">// Since we are about to remove this dock device from the list of</span>
00498     <span class="comment">// all dock devices present, the list should not be empty.</span>
00499     <span class="comment">//</span>
00500     <a class="code" href="../../d9/d0/dockhwp_8c.html#a0">ASSERT_SEMA_NOT_SIGNALLED</a>(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a4">IopProfileChangeSemaphore</a>) ;
00501     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((DeviceNode-&gt;DockInfo.DockStatus == <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a206">DOCK_DEPARTING</a>)||
00502            (DeviceNode-&gt;DockInfo.DockStatus == <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a207">DOCK_EJECTIRP_COMPLETED</a>)) ;
00503     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!IsListEmpty(&amp;DeviceNode-&gt;DockInfo.ListEntry)) ;
00504 
00505     <span class="comment">//</span>
00506     <span class="comment">// Remove the current devnode from the list of docks</span>
00507     <span class="comment">//</span>
00508     RemoveEntryList(&amp;DeviceNode-&gt;DockInfo.ListEntry);
00509     InitializeListHead(&amp;DeviceNode-&gt;DockInfo.ListEntry);
00510     <span class="keywordflow">if</span> (DeviceNode-&gt;DockInfo.SerialNumber) {
00511 
00512         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;DockInfo.SerialNumber);
00513         DeviceNode-&gt;DockInfo.SerialNumber = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00514     }
00515     <a class="code" href="../../d9/d0/dockhwp_8c.html#a2">IopDockDeviceCount</a>--;
00516 
00517     DeviceNode-&gt;DockInfo.DockStatus = <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a204">DOCK_QUIESCENT</a> ;
00518     remainingDockCount = InterlockedDecrement(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a6">IopDocksInTransition</a>) ;
00519     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(remainingDockCount &gt;= 0) ;
00520 
00521     <span class="comment">//</span>
00522     <span class="comment">// Release the lock on the list of dock devices</span>
00523     <span class="comment">//</span>
00524     ExReleaseFastMutex(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a3">IopDockDeviceListLock</a>);
00525 
00526     <span class="keywordflow">if</span> (remainingDockCount) {
00527 
00528         <span class="keywordflow">return</span> ;
00529     }
00530 
00531     <span class="comment">//</span>
00532     <span class="comment">// Update the current Hardware Profile after removing this device.</span>
00533     <span class="comment">//</span>
00534     status = <a class="code" href="../../d9/d0/dockhwp_8c.html#a9">IopUpdateHardwareProfile</a>(&amp;profileChanged);
00535 
00536     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00537 
00538         <span class="comment">//</span>
00539         <span class="comment">// So we're there physically, but not mentally? Too bad, where broadcasting</span>
00540         <span class="comment">// change either way.</span>
00541         <span class="comment">//</span>
00542         PIDBGMSG(
00543             PIDBG_HWPROFILE,
00544             (<span class="stringliteral">"IopUpdateHardwareProfile failed with status == %lx\n"</span>, status)
00545             ) ;
00546 
00547         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) ;
00548     }
00549 
00550     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; profileChanged) {
00551 
00552         <a class="code" href="../../d9/d0/dockhwp_8c.html#a10">IopHardwareProfileSendCommit</a>() ;
00553         <a class="code" href="../../d9/d0/pnpiop_8h.html#a361">IopProcessNewProfile</a>();
00554 
00555     } <span class="keywordflow">else</span> {
00556 
00557         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d9/d0/dockhwp_8c.html#a5">IopProfileChangeCancelRequired</a>) ;
00558         <a class="code" href="../../d9/d0/dockhwp_8c.html#a11">IopHardwareProfileSendCancel</a>() ;
00559     }
00560 
00561     <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(
00562         &amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a4">IopProfileChangeSemaphore</a>,
00563         <a class="code" href="../../d7/d8/exboosts_8h.html#a3">IO_NO_INCREMENT</a>,
00564         1,
00565         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00566         );
00567 
00568     <span class="keywordflow">return</span> ;
00569 }
00570 
00571 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00572"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a382">00572</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a382">IopHardwareProfileCancelRemovedDock</a>(
00573     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode
00574     )
00575 <span class="comment">/*++</span>
00576 <span class="comment"></span>
00577 <span class="comment">Routine Description:</span>
00578 <span class="comment"></span>
00579 <span class="comment">    This routine is called when a dock that was marked to disappear didn't (ie,</span>
00580 <span class="comment">    after the eject, the dock device still enumerated). We remove it from the</span>
00581 <span class="comment">    transition list and complete/cancel the HW profile change as appropriate.</span>
00582 <span class="comment">    See IopHardwareProfileSetMarkedDocksEjected.</span>
00583 <span class="comment"></span>
00584 <span class="comment">Arguments:</span>
00585 <span class="comment"></span>
00586 <span class="comment">    DeviceNode - Supplies a pointer to a device node which will be started and</span>
00587 <span class="comment">                 enumerated.</span>
00588 <span class="comment"></span>
00589 <span class="comment">Return Value:</span>
00590 <span class="comment"></span>
00591 <span class="comment">    None.</span>
00592 <span class="comment"></span>
00593 <span class="comment">--*/</span>
00594 {
00595     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00596     BOOLEAN  profileChanged ;
00597     LONG     remainingDockCount ;
00598 
00599     <span class="comment">//</span>
00600     <span class="comment">// Acquire the lock on the list of dock devices</span>
00601     <span class="comment">//</span>
00602     ExAcquireFastMutex(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a3">IopDockDeviceListLock</a>);
00603 
00604     <span class="comment">//</span>
00605     <span class="comment">// Since we are about to remove this dock device from the list of</span>
00606     <span class="comment">// all dock devices present, the list should not be empty.</span>
00607     <span class="comment">//</span>
00608     <a class="code" href="../../d9/d0/dockhwp_8c.html#a0">ASSERT_SEMA_NOT_SIGNALLED</a>(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a4">IopProfileChangeSemaphore</a>) ;
00609     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode-&gt;DockInfo.DockStatus == <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a207">DOCK_EJECTIRP_COMPLETED</a>) ;
00610     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!IsListEmpty(&amp;DeviceNode-&gt;DockInfo.ListEntry)) ;
00611 
00612     DeviceNode-&gt;DockInfo.DockStatus = <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a204">DOCK_QUIESCENT</a> ;
00613     remainingDockCount = InterlockedDecrement(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a6">IopDocksInTransition</a>) ;
00614     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(remainingDockCount &gt;= 0) ;
00615 
00616     <span class="comment">//</span>
00617     <span class="comment">// Release the lock on the list of dock devices</span>
00618     <span class="comment">//</span>
00619     ExReleaseFastMutex(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a3">IopDockDeviceListLock</a>);
00620 
00621     <span class="keywordflow">if</span> (remainingDockCount) {
00622 
00623         <span class="keywordflow">return</span> ;
00624     }
00625 
00626     <span class="comment">//</span>
00627     <span class="comment">// Update the current Hardware Profile after removing this device.</span>
00628     <span class="comment">//</span>
00629     status = <a class="code" href="../../d9/d0/dockhwp_8c.html#a9">IopUpdateHardwareProfile</a>(&amp;profileChanged);
00630 
00631     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00632 
00633         <span class="comment">//</span>
00634         <span class="comment">// So we're there physically, but not mentally? Too bad, where broadcasting</span>
00635         <span class="comment">// change either way.</span>
00636         <span class="comment">//</span>
00637         PIDBGMSG(
00638             PIDBG_HWPROFILE,
00639             (<span class="stringliteral">"IopUpdateHardwareProfile failed with status == %lx\n"</span>, status)
00640             ) ;
00641         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) ;
00642     }
00643 
00644     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; profileChanged) {
00645 
00646         <a class="code" href="../../d9/d0/dockhwp_8c.html#a10">IopHardwareProfileSendCommit</a>() ;
00647         <a class="code" href="../../d9/d0/pnpiop_8h.html#a361">IopProcessNewProfile</a>();
00648 
00649     } <span class="keywordflow">else</span> {
00650 
00651         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d9/d0/dockhwp_8c.html#a5">IopProfileChangeCancelRequired</a>) ;
00652         <a class="code" href="../../d9/d0/dockhwp_8c.html#a11">IopHardwareProfileSendCancel</a>() ;
00653     }
00654 
00655     <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(
00656         &amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a4">IopProfileChangeSemaphore</a>,
00657         <a class="code" href="../../d7/d8/exboosts_8h.html#a3">IO_NO_INCREMENT</a>,
00658         1,
00659         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00660         );
00661 
00662     <span class="keywordflow">return</span> ;
00663 }
00664 
00665 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00666"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a383">00666</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a383">IopHardwareProfileCancelTransition</a>(
00667     VOID
00668     )
00669 <span class="comment">/*++</span>
00670 <span class="comment"></span>
00671 <span class="comment">Routine Description:</span>
00672 <span class="comment"></span>
00673 <span class="comment">    This routine unmarks any marked devnodes (ie, sets them to no change,</span>
00674 <span class="comment">    appearing or disappearing), and sends the CancelQueryProfileChange as</span>
00675 <span class="comment">    appropriate. Once called, other profile changes can occur.</span>
00676 <span class="comment"></span>
00677 <span class="comment">Arguments:</span>
00678 <span class="comment"></span>
00679 <span class="comment">    None.</span>
00680 <span class="comment"></span>
00681 <span class="comment">Return Value:</span>
00682 <span class="comment"></span>
00683 <span class="comment">    Nodda.</span>
00684 <span class="comment"></span>
00685 <span class="comment">--*/</span>
00686 {
00687     PLIST_ENTRY  listEntry;
00688     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> devNode;
00689 
00690     <a class="code" href="../../d9/d0/dockhwp_8c.html#a0">ASSERT_SEMA_NOT_SIGNALLED</a>(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a4">IopProfileChangeSemaphore</a>) ;
00691 
00692     <span class="comment">//</span>
00693     <span class="comment">// Acquire the lock on the list of dock devices</span>
00694     <span class="comment">//</span>
00695     ExAcquireFastMutex(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a3">IopDockDeviceListLock</a>);
00696 
00697     <span class="keywordflow">for</span> (listEntry  = <a class="code" href="../../d9/d0/dockhwp_8c.html#a1">IopDockDeviceListHead</a>.Flink;
00698         listEntry != &amp;(<a class="code" href="../../d9/d0/dockhwp_8c.html#a1">IopDockDeviceListHead</a>);
00699         listEntry  = listEntry-&gt;Flink ) {
00700 
00701         devNode = CONTAINING_RECORD(listEntry,
00702                                     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">DEVICE_NODE</a>,
00703                                     DockInfo.ListEntry);
00704 
00705         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus != <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a203">DOCK_NOTDOCKDEVICE</a>)&amp;&amp;
00706                (devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus != <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a207">DOCK_EJECTIRP_COMPLETED</a>)) ;
00707         <span class="keywordflow">if</span> (devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus != <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a204">DOCK_QUIESCENT</a>) {
00708 
00709             InterlockedDecrement(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a6">IopDocksInTransition</a>) ;
00710             devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus = <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a204">DOCK_QUIESCENT</a> ;
00711         }
00712     }
00713 
00714     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d9/d0/dockhwp_8c.html#a6">IopDocksInTransition</a>) ;
00715 
00716     <span class="comment">//</span>
00717     <span class="comment">// Release the lock on the list of dock devices</span>
00718     <span class="comment">//</span>
00719     ExReleaseFastMutex(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a3">IopDockDeviceListLock</a>);
00720 
00721     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/dockhwp_8c.html#a5">IopProfileChangeCancelRequired</a>) {
00722 
00723         <a class="code" href="../../d9/d0/dockhwp_8c.html#a11">IopHardwareProfileSendCancel</a>() ;
00724     }
00725 
00726     <span class="comment">//</span>
00727     <span class="comment">// No need to broadcast the cancels here, as IopQueryHardwareProfileChange</span>
00728     <span class="comment">// will have taken care of the cancels for us.</span>
00729     <span class="comment">//</span>
00730     <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(
00731         &amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a4">IopProfileChangeSemaphore</a>,
00732         <a class="code" href="../../d7/d8/exboosts_8h.html#a3">IO_NO_INCREMENT</a>,
00733         1,
00734         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00735         );
00736 }
00737 
00738 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00739"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a384">00739</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a384">IopHardwareProfileSetMarkedDocksEjected</a>(
00740     VOID
00741     )
00742 <span class="comment">/*++</span>
00743 <span class="comment"></span>
00744 <span class="comment">Routine Description:</span>
00745 <span class="comment"></span>
00746 <span class="comment">    This routine moves any departing devnodes to the ejected state. If any</span>
00747 <span class="comment">    subsequent enumeration lists the device as present, we know the eject</span>
00748 <span class="comment">    failed and we appropriately cancel that piece of the profile change.</span>
00749 <span class="comment">    IopHardwareProfileCancelRemovedDock can only be called after this function</span>
00750 <span class="comment">    is called.</span>
00751 <span class="comment"></span>
00752 <span class="comment">Arguments:</span>
00753 <span class="comment"></span>
00754 <span class="comment">    None.</span>
00755 <span class="comment"></span>
00756 <span class="comment">Return Value:</span>
00757 <span class="comment"></span>
00758 <span class="comment">    Nodda.</span>
00759 <span class="comment"></span>
00760 <span class="comment">--*/</span>
00761 {
00762     PLIST_ENTRY  listEntry;
00763     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> devNode;
00764 
00765     <a class="code" href="../../d9/d0/dockhwp_8c.html#a0">ASSERT_SEMA_NOT_SIGNALLED</a>(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a4">IopProfileChangeSemaphore</a>) ;
00766 
00767     <span class="comment">//</span>
00768     <span class="comment">// Acquire the lock on the list of dock devices</span>
00769     <span class="comment">//</span>
00770     ExAcquireFastMutex(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a3">IopDockDeviceListLock</a>);
00771 
00772     <span class="keywordflow">for</span> (listEntry  = <a class="code" href="../../d9/d0/dockhwp_8c.html#a1">IopDockDeviceListHead</a>.Flink;
00773         listEntry != &amp;(<a class="code" href="../../d9/d0/dockhwp_8c.html#a1">IopDockDeviceListHead</a>);
00774         listEntry  = listEntry-&gt;Flink ) {
00775 
00776         devNode = CONTAINING_RECORD(listEntry,
00777                                     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">DEVICE_NODE</a>,
00778                                     DockInfo.ListEntry);
00779 
00780         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus == <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a204">DOCK_QUIESCENT</a>)||
00781                (devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus == <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a206">DOCK_DEPARTING</a>)) ;
00782         <span class="keywordflow">if</span> (devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus != <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a204">DOCK_QUIESCENT</a>) {
00783 
00784             devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus = <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a207">DOCK_EJECTIRP_COMPLETED</a> ;
00785         }
00786     }
00787 
00788     <span class="comment">//</span>
00789     <span class="comment">// Release the lock on the list of dock devices</span>
00790     <span class="comment">//</span>
00791     ExReleaseFastMutex(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a3">IopDockDeviceListLock</a>);
00792 }
00793 
00794 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00795"></a><a class="code" href="../../d9/d0/dockhwp_8c.html#a10">00795</a> <a class="code" href="../../d9/d0/dockhwp_8c.html#a10">IopHardwareProfileSendCommit</a>(
00796     VOID
00797     )
00798 <span class="comment">/*++</span>
00799 <span class="comment"></span>
00800 <span class="comment">Routine Description:</span>
00801 <span class="comment"></span>
00802 <span class="comment">    This routine (internal to dockhwp.c) simply sends the change complete message.</span>
00803 <span class="comment">    We do not wait for this, as it is asynchronous...</span>
00804 <span class="comment"></span>
00805 <span class="comment">Arguments:</span>
00806 <span class="comment"></span>
00807 <span class="comment">    None.</span>
00808 <span class="comment"></span>
00809 <span class="comment">Return Value:</span>
00810 <span class="comment"></span>
00811 <span class="comment">    Nodda.</span>
00812 <span class="comment"></span>
00813 <span class="comment">--*/</span>
00814 {
00815     <a class="code" href="../../d9/d0/dockhwp_8c.html#a0">ASSERT_SEMA_NOT_SIGNALLED</a>(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a4">IopProfileChangeSemaphore</a>) ;
00816     PIDBGMSG(PIDBG_HWPROFILE, (<span class="stringliteral">"NTOSKRNL: Sending HW profile change [commit]\n"</span>)) ;
00817 
00818     <a class="code" href="../../d9/d0/pnpiop_8h.html#a348">IopRequestHwProfileChangeNotification</a>(
00819         (LPGUID) &amp;GUID_HWPROFILE_CHANGE_COMPLETE,
00820         <a class="code" href="../../d9/d0/pnpiop_8h.html#a388a210">PROFILE_PERHAPS_IN_PNPEVENT</a>,
00821         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00822         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00823         );
00824 }
00825 
00826 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00827"></a><a class="code" href="../../d9/d0/dockhwp_8c.html#a11">00827</a> <a class="code" href="../../d9/d0/dockhwp_8c.html#a11">IopHardwareProfileSendCancel</a>(
00828     VOID
00829     )
00830 <span class="comment">/*++</span>
00831 <span class="comment"></span>
00832 <span class="comment">Routine Description:</span>
00833 <span class="comment"></span>
00834 <span class="comment">    This routine (internal to dockhwp.c) simply sends the cancel.</span>
00835 <span class="comment"></span>
00836 <span class="comment">Arguments:</span>
00837 <span class="comment"></span>
00838 <span class="comment">    None.</span>
00839 <span class="comment"></span>
00840 <span class="comment">Return Value:</span>
00841 <span class="comment"></span>
00842 <span class="comment">    Nodda.</span>
00843 <span class="comment"></span>
00844 <span class="comment">--*/</span>
00845 {
00846     <a class="code" href="../../d2/d6/structPROFILE__WORK__ITEM.html">PROFILE_WORK_ITEM</a>   profileWorkItem;
00847     PNP_VETO_TYPE       vetoType;
00848     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            status;
00849 
00850     <a class="code" href="../../d9/d0/dockhwp_8c.html#a0">ASSERT_SEMA_NOT_SIGNALLED</a>(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a4">IopProfileChangeSemaphore</a>) ;
00851     PIDBGMSG(PIDBG_HWPROFILE, (<span class="stringliteral">"NTOSKRNL: Sending HW profile change [cancel]\n"</span>)) ;
00852 
00853     <a class="code" href="../../d9/d0/pnpiop_8h.html#a348">IopRequestHwProfileChangeNotification</a>(
00854         (LPGUID) &amp;GUID_HWPROFILE_CHANGE_CANCELLED,
00855         <a class="code" href="../../d9/d0/pnpiop_8h.html#a388a210">PROFILE_PERHAPS_IN_PNPEVENT</a>,
00856         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00857         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00858         ) ;
00859 }
00860 
00861 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00862"></a><a class="code" href="../../d9/d0/dockhwp_8c.html#a9">00862</a> <a class="code" href="../../d9/d0/dockhwp_8c.html#a9">IopUpdateHardwareProfile</a> (
00863     OUT PBOOLEAN   ProfileChanged
00864     )
00865 <span class="comment">/*++</span>
00866 <span class="comment">Routine Description:</span>
00867 <span class="comment"></span>
00868 <span class="comment">    This routine scans the list of current dock devices, builds a list of serial</span>
00869 <span class="comment">    numbers from those devices, and calls for the Hardware Profile to be</span>
00870 <span class="comment">    changed, based on that list.</span>
00871 <span class="comment"></span>
00872 <span class="comment">Arguments:</span>
00873 <span class="comment"></span>
00874 <span class="comment">    ProfileChanged - Supplies a variable to receive TRUE if the current hardware</span>
00875 <span class="comment">                     profile changes as a result of calling this routine.</span>
00876 <span class="comment"></span>
00877 <span class="comment">Return Value:</span>
00878 <span class="comment"></span>
00879 <span class="comment">    NTSTATUS code.</span>
00880 <span class="comment"></span>
00881 <span class="comment">--*/</span>
00882 {
00883     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
00884     PLIST_ENTRY  listEntry;
00885     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> devNode;
00886     PWCHAR  *profileSerialNumbers, *p;
00887     HANDLE  hProfileKey=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00888     ULONG   len, numProfiles;
00889     HANDLE  hCurrent, hIDConfigDB;
00890     UNICODE_STRING unicodeName;
00891 
00892     <span class="comment">//</span>
00893     <span class="comment">// Acquire the lock on the list of dock devices</span>
00894     <span class="comment">//</span>
00895     ExAcquireFastMutex(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a3">IopDockDeviceListLock</a>);
00896 
00897     <span class="comment">//</span>
00898     <span class="comment">// Update the flag for Ejectable Docks</span>
00899     <span class="comment">//</span>
00900     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, <a class="code" href="../../d1/d2/cmp_8h.html#a125">CM_HARDWARE_PROFILE_STR_DATABASE</a>);
00901     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;hIDConfigDB,
00902                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00903                                      &amp;unicodeName,
00904                                      KEY_READ,
00905                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) )) {
00906 
00907         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, <a class="code" href="../../d1/d2/cmp_8h.html#a142">CM_HARDWARE_PROFILE_STR_CURRENT_DOCK_INFO</a>);
00908         <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;hCurrent,
00909                                          hIDConfigDB,
00910                                          &amp;unicodeName,
00911                                          KEY_READ | KEY_WRITE,
00912                                          <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) )) {
00913 
00914             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, REGSTR_VAL_EJECTABLE_DOCKS);
00915             ZwSetValueKey(hCurrent,
00916                           &amp;unicodeName,
00917                           0,
00918                           REG_DWORD,
00919                           &amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a2">IopDockDeviceCount</a>,
00920                           <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d0/dockhwp_8c.html#a2">IopDockDeviceCount</a>));
00921             ZwClose(hCurrent);
00922         }
00923         ZwClose(hIDConfigDB);
00924     }
00925 
00926     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/dockhwp_8c.html#a2">IopDockDeviceCount</a> == 0) {
00927         <span class="comment">//</span>
00928         <span class="comment">// if there are no dock devices, the list should</span>
00929         <span class="comment">// contain a single null entry, in addition to the null</span>
00930         <span class="comment">// termination.</span>
00931         <span class="comment">//</span>
00932         numProfiles = 1;
00933         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsListEmpty(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a1">IopDockDeviceListHead</a>));
00934     } <span class="keywordflow">else</span> {
00935         numProfiles = <a class="code" href="../../d9/d0/dockhwp_8c.html#a2">IopDockDeviceCount</a>;
00936         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!IsListEmpty(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a1">IopDockDeviceListHead</a>));
00937     }
00938 
00939     <span class="comment">//</span>
00940     <span class="comment">// Allocate space for a null-terminated list of SerialNumber lists.</span>
00941     <span class="comment">//</span>
00942     len = (numProfiles+1)*<span class="keyword">sizeof</span>(PWCHAR);
00943     profileSerialNumbers = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, len);
00944 
00945     <span class="keywordflow">if</span> (profileSerialNumbers) {
00946 
00947         p = profileSerialNumbers;
00948 
00949         <span class="comment">//</span>
00950         <span class="comment">// Create the list of Serial Numbers</span>
00951         <span class="comment">//</span>
00952         <span class="keywordflow">for</span> (listEntry  = <a class="code" href="../../d9/d0/dockhwp_8c.html#a1">IopDockDeviceListHead</a>.Flink;
00953              listEntry != &amp;(<a class="code" href="../../d9/d0/dockhwp_8c.html#a1">IopDockDeviceListHead</a>);
00954              listEntry  = listEntry-&gt;Flink ) {
00955 
00956             devNode = CONTAINING_RECORD(listEntry,
00957                                         <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">DEVICE_NODE</a>,
00958                                         DockInfo.ListEntry);
00959 
00960             <span class="comment">//</span>
00961             <span class="comment">// ADRIAO BUGBUG 11/11/98 -</span>
00962             <span class="comment">//     Is everything in the quiescent state here?</span>
00963             <span class="comment">//</span>
00964             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus != <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a203">DOCK_NOTDOCKDEVICE</a>) ;
00965             <span class="keywordflow">if</span> (devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.SerialNumber) {
00966                 *p = devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.SerialNumber;
00967                 p++;
00968             }
00969         }
00970 
00971         ExReleaseFastMutex(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a3">IopDockDeviceListLock</a>);
00972 
00973         <span class="keywordflow">if</span> (p == profileSerialNumbers) {
00974             <span class="comment">//</span>
00975             <span class="comment">// Set a single list entry to NULL if we look to be in an "undocked"</span>
00976             <span class="comment">// profile</span>
00977             <span class="comment">//</span>
00978             *p = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00979             p++;
00980         }
00981 
00982         <span class="comment">//</span>
00983         <span class="comment">// Null-terminate the list</span>
00984         <span class="comment">//</span>
00985         *p = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00986 
00987         numProfiles = (ULONG)(p - profileSerialNumbers);
00988 
00989         <span class="comment">//</span>
00990         <span class="comment">// Change the current Hardware Profile based on the new Dock State</span>
00991         <span class="comment">// and perform notification that the Hardware Profile has changed</span>
00992         <span class="comment">//</span>
00993         status = <a class="code" href="../../d9/d0/dockhwp_8c.html#a8">IopExecuteHardwareProfileChange</a>(<a class="code" href="../../d9/d0/pnpiop_8h.html#a392a226">HardwareProfileBusTypeACPI</a>,
00994                                                  profileSerialNumbers,
00995                                                  numProfiles,
00996                                                  &amp;hProfileKey,
00997                                                  ProfileChanged);
00998         <span class="keywordflow">if</span> (hProfileKey) {
00999             ZwClose(hProfileKey);
01000         }
01001         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (profileSerialNumbers);
01002 
01003     } <span class="keywordflow">else</span> {
01004 
01005         ExReleaseFastMutex(&amp;<a class="code" href="../../d9/d0/dockhwp_8c.html#a3">IopDockDeviceListLock</a>);
01006 
01007         status = STATUS_INSUFFICIENT_RESOURCES;
01008     }
01009 
01010     <span class="keywordflow">return</span> status;
01011 }
01012 
01013 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01014"></a><a class="code" href="../../d9/d0/dockhwp_8c.html#a20">01014</a> <a class="code" href="../../d9/d0/dockhwp_8c.html#a20">IopExecuteHwpDefaultSelect</a> (
01015     IN  <a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">PCM_HARDWARE_PROFILE_LIST</a> ProfileList,
01016     OUT PULONG ProfileIndexToUse,
01017     IN  PVOID Context
01018     )
01019 {
01020     UNREFERENCED_PARAMETER (Context);
01021 
01022     * ProfileIndexToUse = 0;
01023 
01024     <span class="keywordflow">return</span> STATUS_SUCCESS;
01025 }
01026 
01027 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01028"></a><a class="code" href="../../d9/d0/dockhwp_8c.html#a8">01028</a> <a class="code" href="../../d9/d0/dockhwp_8c.html#a8">IopExecuteHardwareProfileChange</a>(
01029     IN  HARDWARE_PROFILE_BUS_TYPE   Bus,
01030     IN  PWCHAR                    * ProfileSerialNumbers,
01031     IN  ULONG                       SerialNumbersCount,
01032     OUT PHANDLE                     NewProfile,
01033     OUT PBOOLEAN                    ProfileChanged
01034     )
01035 
01036 
01037 <span class="comment">/*++</span>
01038 <span class="comment">Routine Description:</span>
01039 <span class="comment">    A docking event has occured and now, given a list of Profile Serial Numbers</span>
01040 <span class="comment">    that describe the new docking state:</span>
01041 <span class="comment">    Transition to the given docking state.</span>
01042 <span class="comment">    Set the Current Hardware Profile to based on the new state.</span>
01043 <span class="comment">    (Possibly Prompt the user if there is ambiguity)</span>
01044 <span class="comment">    Send Removes to those devices that are turned off in this profile,</span>
01045 <span class="comment"></span>
01046 <span class="comment">Arguments:</span>
01047 <span class="comment">    Bus - This is the bus that is supplying the hardware profile change</span>
01048 <span class="comment">    (currently only HardwareProfileBusTypeAcpi is supported).</span>
01049 <span class="comment"></span>
01050 <span class="comment">    ProfileSerialNumbers - A list of serial numbers (a list of null terminated</span>
01051 <span class="comment">    UCHAR lists) representing this new docking state.  These can be listed in</span>
01052 <span class="comment">    any order, and form a complete representation of the new docking state</span>
01053 <span class="comment">    caused by a docking even on the given bus.  A Serial Number string of "\0"</span>
01054 <span class="comment">    represents an "undocked state" and should not be listed with any other</span>
01055 <span class="comment">    strings.  This list need not be sorted.</span>
01056 <span class="comment"></span>
01057 <span class="comment">    SerialNumbersCount - The number of serial numbers listed.</span>
01058 <span class="comment"></span>
01059 <span class="comment">    NewProfile - a handle to the registry key representing the new hardware</span>
01060 <span class="comment">    profile (IE \CCS\HardwareProfiles\Current".)</span>
01061 <span class="comment"></span>
01062 <span class="comment">    ProfileChanged - set to TRUE if new current profile (as a result of this</span>
01063 <span class="comment">    docking event, is different that then old current profile.</span>
01064 <span class="comment"></span>
01065 <span class="comment">--*/</span>
01066 {
01067     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        status = STATUS_SUCCESS;
01068     ULONG           len;
01069     ULONG           tmplen;
01070     ULONG           i, j;
01071     PWCHAR          tmpStr;
01072     UNICODE_STRING  tmpUStr;
01073     PUNICODE_STRING sortedSerials = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01074 
01075     <a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html">PPROFILE_ACPI_DOCKING_STATE</a> dockState = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01076 
01077     PIDBGMSG(
01078         PIDBG_HWPROFILE,
01079         (<span class="stringliteral">"Execute Profile (BusType %x), (SerialNumCount %x)\n"</span>, Bus, SerialNumbersCount)
01080         ) ;
01081 
01082     <span class="comment">//</span>
01083     <span class="comment">// Sort the list of serial numbers</span>
01084     <span class="comment">//</span>
01085     len = <span class="keyword">sizeof</span> (UNICODE_STRING) * SerialNumbersCount;
01086     sortedSerials = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, len);
01087     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == sortedSerials) {
01088         status = STATUS_INSUFFICIENT_RESOURCES;
01089         <span class="keywordflow">goto</span> Clean;
01090     }
01091     <span class="keywordflow">for</span> (i = 0; i &lt; SerialNumbersCount; i++) {
01092         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;sortedSerials[i], ProfileSerialNumbers[i]);
01093     }
01094     <span class="comment">//</span>
01095     <span class="comment">// I do not anticipate getting more than a few serial numbers, and I am</span>
01096     <span class="comment">// just lasy enough to write this comment and use a buble sort.</span>
01097     <span class="comment">//</span>
01098     <span class="keywordflow">for</span> (i = 0; i &lt; SerialNumbersCount; i++) {
01099         <span class="keywordflow">for</span> (j = 0; j &lt; SerialNumbersCount - 1; j++) {
01100             <span class="keywordflow">if</span> (0 &lt; <a class="code" href="../../d6/d6/nls_8c.html#a41">RtlCompareUnicodeString</a> (&amp;sortedSerials[j],
01101                                              &amp;sortedSerials[j+1],
01102                                              <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
01103                 tmpUStr = sortedSerials[j];
01104                 sortedSerials[j] = sortedSerials[j+1];
01105                 sortedSerials[j+1] = tmpUStr;
01106             }
01107         }
01108     }
01109 
01110     <span class="comment">//</span>
01111     <span class="comment">// Construct the DockState ID</span>
01112     <span class="comment">//</span>
01113     len = 0;
01114     <span class="keywordflow">for</span> (i = 0; i &lt; SerialNumbersCount; i++) {
01115         len += sortedSerials[i].Length;
01116     }
01117     len += <span class="keyword">sizeof</span> (WCHAR); <span class="comment">// NULL termination;</span>
01118 
01119     dockState = (<a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html">PPROFILE_ACPI_DOCKING_STATE</a>)
01120                 <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
01121                                 len + <span class="keyword">sizeof</span> (<a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html">PROFILE_ACPI_DOCKING_STATE</a>));
01122     <span class="comment">// BUGBUG wasted WCHAR here.  Oh well.</span>
01123 
01124     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == dockState) {
01125         status = STATUS_INSUFFICIENT_RESOURCES;
01126         <span class="keywordflow">goto</span> Clean;
01127     }
01128     <span class="keywordflow">for</span> (i = 0, tmpStr = dockState-&gt;<a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html#o2">SerialNumber</a>, tmplen = 0;
01129          i &lt; SerialNumbersCount;
01130          i++) {
01131 
01132         tmplen = sortedSerials[i].Length;
01133         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (tmplen &lt;= len - ((PCHAR)tmpStr - (PCHAR)dockState-&gt;SerialNumber));
01134 
01135         RtlCopyMemory (tmpStr, sortedSerials[i].<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, tmplen);
01136         (PCHAR) tmpStr += tmplen;
01137     }
01138 
01139     *(tmpStr++) = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
01140 
01141     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (len == (ULONG) ((PCHAR) tmpStr - (PCHAR) dockState-&gt;<a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html#o2">SerialNumber</a>));
01142     dockState-&gt;<a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html#o1">SerialLength</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) len;
01143 
01144     <span class="keywordflow">if</span> ((SerialNumbersCount &gt; 1) || (<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span> !=  dockState-&gt;<a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html#o2">SerialNumber</a>[0])) {
01145         dockState-&gt;<a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html#o0">DockingState</a> = <a class="code" href="../../d6/d7/profiles_8h.html#a7">HW_PROFILE_DOCKSTATE_DOCKED</a>;
01146     } <span class="keywordflow">else</span> {
01147         dockState-&gt;<a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html#o0">DockingState</a> = <a class="code" href="../../d6/d7/profiles_8h.html#a6">HW_PROFILE_DOCKSTATE_UNDOCKED</a>;
01148     }
01149 
01150 
01151     <span class="comment">//</span>
01152     <span class="comment">// Set the new Profile</span>
01153     <span class="comment">//</span>
01154     <span class="keywordflow">switch</span> (Bus) {
01155     <span class="keywordflow">case</span> <a class="code" href="../../d9/d0/pnpiop_8h.html#a392a226">HardwareProfileBusTypeACPI</a>:
01156 
01157         status = <a class="code" href="../../d6/d2/hwprofil_8c.html#a6">CmSetAcpiHwProfile</a> (dockState,
01158                                      <a class="code" href="../../d9/d0/dockhwp_8c.html#a20">IopExecuteHwpDefaultSelect</a>,
01159                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01160                                      NewProfile,
01161                                      ProfileChanged);
01162 
01163         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) || (!(*ProfileChanged))) ;
01164         <span class="keywordflow">break</span>;
01165 
01166     <span class="keywordflow">default</span>:
01167         *ProfileChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
01168         status = STATUS_NOT_SUPPORTED;
01169         <span class="keywordflow">goto</span> Clean;
01170     }
01171 
01172 Clean:
01173     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != sortedSerials) {
01174         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (sortedSerials);
01175     }
01176     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != dockState) {
01177         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (dockState);
01178     }
01179 
01180     <span class="keywordflow">return</span> status;
01181 }
01182 
01183 
01184 
01185 <span class="comment">//</span>
01186 <span class="comment">// Beyond here lie commented out code. This code is a sketch of what we will</span>
01187 <span class="comment">// use when we do two-step profile changes (ie, using the serial numbers figure</span>
01188 <span class="comment">// out what profile we are *about* to enter, and return a set of all existing</span>
01189 <span class="comment">// profiles that we might transition into. Today this code is not used as not</span>
01190 <span class="comment">// all BIOS's can tell us what profile we are entering prior to being there.</span>
01191 <span class="comment">//</span>
01192 
01193 <span class="preprocessor">#if 0</span>
01194 <span class="preprocessor"></span>
01195 <span class="keyword">struct </span>_IOP_NEW_ACPI_STATE {
01196     ULONG Blah;
01197     <a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">PCM_HARDWARE_PROFILE_LIST</a>    ProfileList;
01198 
01199 } IOP_NEW_ACPI_STATE, *PIOP_NEW_ACPI_STATE;
01200 
01201 
01202 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01203 IopProfileAcquisition (
01204     IN  <a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">PCM_HARDWARE_PROFILE_LIST</a>   ProfileList,
01205     OUT PULONG                      ProfileIndexToUse,
01206     IN  PIOP_PROFILE_LIST           NewAcpiState
01207     )
01208 <span class="comment">/*++</span>
01209 <span class="comment">Routine Description</span>
01210 <span class="comment"></span>
01211 <span class="comment">--*/</span>
01212 {
01213     <a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">PCM_HARDWARE_PROFILE_LIST</a> tmpList;
01214     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
01215     ULONG i;
01216     ULONG k;
01217     ULONG oldSize;
01218     ULONG newSize;
01219     BOOLEAN found;
01220 
01221     <span class="comment">//</span>
01222     <span class="comment">// We need to add the entries from ProfileList to our new acpi state</span>
01223     <span class="comment">//</span>
01224     <span class="comment">// Use the most inefficient manner possible to see if we already have</span>
01225     <span class="comment">// this profile.  Hopefully there will not be that many profiles around.</span>
01226     <span class="comment">//</span>
01227     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ProfileList-&gt;CurrentProfileCount &lt;= ProfileList-&gt;MaxProfileCount);
01228     <span class="keywordflow">for</span> (i = 0; i &lt; ProfileList-&gt;CurrentProfileCount; i++) {
01229         found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01230 
01231         <span class="keywordflow">for</span> (k = 0; k &lt; NewAcpiState-&gt;ProfileList-&gt;CurrentProfileCount; k++) {
01232             <span class="keywordflow">if</span> (ProfileList-&gt;Profile[i].Id ==
01233                 NewAcpiState-&gt;ProfileList-&gt;Profile[k]) {
01234                 found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01235                 <span class="keywordflow">break</span>;
01236             }
01237         }
01238 
01239         <span class="keywordflow">if</span> (!found) {
01240             <span class="comment">//</span>
01241             <span class="comment">// Add it</span>
01242             <span class="comment">//</span>
01243             <span class="keywordflow">if</span> (NewAcpiState-&gt;MaxProfileCount &lt;= NewAcpiState-&gt;CurrentProfileCount) {
01244                 tmpList = NewAcpiState-&gt;ProfileList;
01245 
01246                 oldSize = <span class="keyword">sizeof</span> (<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">CM_HARDWARE_PROFILE_LIST</a>)
01247                         + (<span class="keyword">sizeof</span> (<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html">CM_HARDWARE_PROFILE</a>) *
01248                            (tmpList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o0">MaxProfileCount</a> - 1));
01249 
01250                 newSize = tmpList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o0">MaxProfileCount</a> * 2;
01251                 newSize = <span class="keyword">sizeof</span> (<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">CM_HARDWARE_PROFILE_LIST</a>)
01252                         + (<span class="keyword">sizeof</span> (CM_HAREWARE_PROFILE) * (newSize - 1));
01253 
01254                 tmpList = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (PagedPool, newSize);
01255                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == tmpList) {
01256                     <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01257                 }
01258                 RtlCopyMemory (tmpList, NewAcpiState-&gt;ProfileList, oldSize);
01259                 <span class="comment">// NB current count and Max count copied over as well</span>
01260                 tmpList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o0">MaxProfileCount</a> *= 2;
01261 
01262                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (NewAcpiState-&gt;ProfileList);
01263                 NewAcpiState-&gt;ProfileList = tmpList;
01264             }
01265 
01266             k = NewAcpiState-&gt;ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o1">CurrentProfileCount</a>++;
01267             NewAcpiState-&gt;ProfileList-&gt;Profile[k] = ProfileList-&gt;Profile[i].
01268         }
01269 
01270     }
01271 
01272 
01273 
01274     *ProfileIndexToUse = -1; <span class="comment">// Don't select anything yet.</span>
01275     <span class="keywordflow">return</span> status;
01276 }
01277 
01278 
01279 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01280 IopFindPossibleProfiles (
01281     IN <a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html">PPROFILE_ACPI_DOCKING_STATE</a> * AcpiProfiles,
01282     IN ULONG PossibleDockingStates,
01283     OUT <a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">PCM_HARDWARE_PROFILE_LIST</a> * ProfileList
01284     )
01285 <span class="comment">/*++</span>
01286 <span class="comment">Routine Description:</span>
01287 <span class="comment">    Based on the cononical list of possible acpi docking states, determine the</span>
01288 <span class="comment">    cononical list of Hardware profiles that might result.</span>
01289 <span class="comment"></span>
01290 <span class="comment">Arguments:</span>
01291 <span class="comment">    AcpiProfiles - A list of pointers to AcpiProfiles that could be achieved</span>
01292 <span class="comment">    in the next docking state.</span>
01293 <span class="comment"></span>
01294 <span class="comment">    PossibleDockingStates - The total number of AcpiProfiles.</span>
01295 <span class="comment"></span>
01296 <span class="comment">    ProfileList - the cononical list of hardware profiles that could result from</span>
01297 <span class="comment">    the given list of acpi docking profiles.</span>
01298 <span class="comment"></span>
01299 <span class="comment">--*/</span>
01300 {
01301     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status = STATUS_SUCCESS;
01302     ULONG       i;
01303     IOP_PROFILE_CONTEXT         context;
01304     <a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html">PROFILE_ACPI_DOCKING_STATE</a>  acpiDockState;
01305 
01306     context-&gt;ProfileList = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (NonPagedPool,
01307                                            <span class="keyword">sizeof</span> (<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">PCM_HARDWARE_PROFILE_LIST</a>));
01308     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == context-&gt;ProfileList) {
01309         status = STATUS_INSUFICIENT_RESOURCES;
01310         <span class="keywordflow">goto</span> Clean;
01311     }
01312     context-&gt;ProfileList-&gt;MaxProfileCount = 1;
01313     context-&gt;ProfileList-&gt;CurrentProfileCount = 0;
01314 
01315     <span class="keywordflow">for</span> (i = 0; i &lt; PossibleDockingStates; i++) {
01316 
01317         status = <a class="code" href="../../d6/d2/hwprofil_8c.html#a6">CmSetAcpiHwProfile</a> (AcpiProfiles[i],
01318                                      IopProfileAcquisition,
01319                                      &amp;context);
01320 
01321         <span class="keywordflow">if</span> (STATUS_MORE_PROCESSING_REQUIRED == status) {
01322             status = STATUS_SUCCESS;
01323         }
01324         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01325             <span class="keywordflow">goto</span> Clean;
01326         }
01327     }
01328     status = STATUS_SUCCESS
01329 
01330     *ProfileList = context-&gt;ProfileList;
01331 
01332 Clean:
01333 
01334     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != context-&gt;ProfileList) {
01335         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (context-&gt;ProfileList);
01336     }
01337 
01338     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01339         <span class="keywordflow">if</span> (possibleProfileList) {
01340             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (possibleProfileList);
01341         }
01342     }
01343 
01344     <span class="keywordflow">return</span> status;
01345 }
01346 
01347 <span class="keyword">typedef</span> <span class="keyword">struct </span>_IOP_ACPI_DOCKING_PROFILE_INFO {
01348     ULONG Blah;
01349 } IOP_ACPI_DOCKING_PROFILE_INFO, * PIOP_ACPI_DOCKING_PROFILE_INFO;
01350 
01351 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01352 IopAcpiQueryDockingProfileEvent (
01353     IN  PUCHAR    * AcpiDockSerialNumbers,
01354     IN  ULONG       PossibleSerialNumbers,
01355     IN  PFOOBAR     DockRelations,
01356     OUT PIOP_ACPI_DOCKING_PROFILE_INFO * AcpiDockInfo,
01357     )
01358 <span class="comment">/*++</span>
01359 <span class="comment">Routine Description:</span>
01360 <span class="comment">    Given a list of ACPI serial numbers that might appear once an ACPI docking</span>
01361 <span class="comment">    event has completed, determine the cononical list of hardware profiles that</span>
01362 <span class="comment">    could result from the docking serial numbers provided.  Query remove all</span>
01363 <span class="comment">    devices listed as disabled across all of these profiles.  If all queries</span>
01364 <span class="comment">    succeed, then remove all devices.  If not cancel the queries.</span>
01365 <span class="comment"></span>
01366 <span class="comment">    Return success iff all query removes completed successfully.  Otherwise</span>
01367 <span class="comment">    fail.</span>
01368 <span class="comment"></span>
01369 <span class="comment">    Do not actually cause the remove of these devices.</span>
01370 <span class="comment"></span>
01371 <span class="comment"></span>
01372 <span class="comment">Arguments</span>
01373 <span class="comment">    AcpiDockSerialNumbers - a list of serial numbers for the possible docks</span>
01374 <span class="comment">    that may be attached for this acpi docking event.</span>
01375 <span class="comment"></span>
01376 <span class="comment">    PossibleSerialNumbers - number of elements in that list.</span>
01377 <span class="comment"></span>
01378 <span class="comment">    BUGBUG</span>
01379 <span class="comment">    DockRelations - the list of (help me out here I don't really know) which</span>
01380 <span class="comment">                    may be removed when this docking state is executed.</span>
01381 <span class="comment">    BUGBUG</span>
01382 <span class="comment"></span>
01383 <span class="comment"></span>
01384 <span class="comment">    AcpiDockInfo - a context parameter that needs to be passed to</span>
01385 <span class="comment">    IopAcpiExecuteDockingProfile.</span>
01386 <span class="comment"></span>
01387 <span class="comment">--*/</span>
01388 {
01389     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status = STATUS_SUCCESS;
01390 
01391     <span class="keywordflow">return</span> status;
01392 }
01393 
01394 <span class="preprocessor">#endif</span>
01395 <span class="preprocessor"></span>
01396 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:46 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
