<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: balmgr.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>balmgr.c</h1><a href="../../d9/d0/balmgr_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991-1994  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    balmgr.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the NT balance set manager. Normally the kernel</span>
00012 <span class="comment">    does not contain "policy" code. However, the balance set manager needs</span>
00013 <span class="comment">    to be able to traverse the kernel data structures and, therefore, the</span>
00014 <span class="comment">    code has been located as logically part of the kernel.</span>
00015 <span class="comment"></span>
00016 <span class="comment">    The balance set manager performs the following operations:</span>
00017 <span class="comment"></span>
00018 <span class="comment">        1. Makes the kernel stack of threads that have been waiting for a</span>
00019 <span class="comment">           certain amount of time, nonresident.</span>
00020 <span class="comment"></span>
00021 <span class="comment">        2. Removes processes from the balance set when memory gets tight</span>
00022 <span class="comment">           and brings processes back into the balance set when there is</span>
00023 <span class="comment">           more memory available.</span>
00024 <span class="comment"></span>
00025 <span class="comment">        3. Makes the kernel stack resident for threads whose wait has been</span>
00026 <span class="comment">           completed, but whose stack is nonresident.</span>
00027 <span class="comment"></span>
00028 <span class="comment">        4. Arbitrarily boosts the priority of a selected set of threads</span>
00029 <span class="comment">           to prevent priority inversion in variable priority levels.</span>
00030 <span class="comment"></span>
00031 <span class="comment">    In general, the balance set manager only is active during periods when</span>
00032 <span class="comment">    memory is tight.</span>
00033 <span class="comment"></span>
00034 <span class="comment">Author:</span>
00035 <span class="comment"></span>
00036 <span class="comment">    David N. Cutler (davec) 13-Jul-1991</span>
00037 <span class="comment"></span>
00038 <span class="comment">Environment:</span>
00039 <span class="comment"></span>
00040 <span class="comment">    Kernel mode only.</span>
00041 <span class="comment"></span>
00042 <span class="comment">Revision History:</span>
00043 <span class="comment"></span>
00044 <span class="comment">--*/</span>
00045 
00046 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00047 
00048 <span class="comment">//</span>
00049 <span class="comment">// Define balance set wait object types.</span>
00050 <span class="comment">//</span>
00051 
<a name="l00052"></a><a class="code" href="../../d9/d0/balmgr_8c.html#a26">00052</a> <span class="keyword">typedef</span> <span class="keyword">enum</span> <a class="code" href="../../d1/d9/worker_8c.html#a31">_BALANCE_OBJECT</a> {
00053     <a class="code" href="../../d1/d9/worker_8c.html#a31a18">TimerExpiration</a>,
00054     <a class="code" href="../../d9/d0/balmgr_8c.html#a26a17">WorkingSetManagerEvent</a>,
00055     <a class="code" href="../../d9/d0/balmgr_8c.html#a26a18">MaximumObject</a>
00056     } <a class="code" href="../../d1/d9/worker_8c.html#a11">BALANCE_OBJECT</a>;
00057 
00058 <span class="comment">//</span>
00059 <span class="comment">// Define maximum number of thread stacks that can be out swapped in</span>
00060 <span class="comment">// a single time period.</span>
00061 <span class="comment">//</span>
00062 
<a name="l00063"></a><a class="code" href="../../d9/d0/balmgr_8c.html#a0">00063</a> <span class="preprocessor">#define MAXIMUM_THREAD_STACKS 20</span>
00064 <span class="preprocessor"></span>
00065 <span class="comment">//</span>
00066 <span class="comment">// Define periodic wait interval value.</span>
00067 <span class="comment">//</span>
00068 
<a name="l00069"></a><a class="code" href="../../d9/d0/balmgr_8c.html#a1">00069</a> <span class="preprocessor">#define PERIODIC_INTERVAL (1 * 1000 * 1000 * 10)</span>
00070 <span class="preprocessor"></span>
00071 <span class="comment">//</span>
00072 <span class="comment">// Define amount of time a thread can be in the ready state without having</span>
00073 <span class="comment">// is priority boosted (approximately 4 seconds).</span>
00074 <span class="comment">//</span>
00075 
<a name="l00076"></a><a class="code" href="../../d9/d0/balmgr_8c.html#a2">00076</a> <span class="preprocessor">#define READY_WITHOUT_RUNNING  (4 * 75)</span>
00077 <span class="preprocessor"></span>
00078 <span class="comment">//</span>
00079 <span class="comment">// Define kernel stack protect time. For small systems the protect time</span>
00080 <span class="comment">// is 3 seconds. For all other systems, the protect time is 7 seconds.</span>
00081 <span class="comment">//</span>
00082 
<a name="l00083"></a><a class="code" href="../../d9/d0/balmgr_8c.html#a3">00083</a> <span class="preprocessor">#define SMALL_SYSTEM_STACK_PROTECT_TIME (3 * 75)</span>
<a name="l00084"></a><a class="code" href="../../d9/d0/balmgr_8c.html#a4">00084</a> <span class="preprocessor"></span><span class="preprocessor">#define STACK_PROTECT_TIME              (7 * 75)</span>
<a name="l00085"></a><a class="code" href="../../d9/d0/balmgr_8c.html#a5">00085</a> <span class="preprocessor"></span><span class="preprocessor">#define STACK_SCAN_PERIOD 4</span>
<a name="l00086"></a><a class="code" href="../../d9/d0/balmgr_8c.html#a13">00086</a> <span class="preprocessor"></span>ULONG <a class="code" href="../../d4/d9/ke_8h.html#a140">KiStackProtectTime</a>;
00087 
00088 <span class="comment">//</span>
00089 <span class="comment">// Define number of threads to scan each period and the priority boost bias.</span>
00090 <span class="comment">//</span>
00091 
<a name="l00092"></a><a class="code" href="../../d9/d0/balmgr_8c.html#a6">00092</a> <span class="preprocessor">#define THREAD_BOOST_BIAS 1</span>
<a name="l00093"></a><a class="code" href="../../d9/d0/balmgr_8c.html#a7">00093</a> <span class="preprocessor"></span><span class="preprocessor">#define THREAD_BOOST_PRIORITY (LOW_REALTIME_PRIORITY - THREAD_BOOST_BIAS)</span>
<a name="l00094"></a><a class="code" href="../../d9/d0/balmgr_8c.html#a8">00094</a> <span class="preprocessor"></span><span class="preprocessor">#define THREAD_SCAN_PRIORITY (THREAD_BOOST_PRIORITY - 1)</span>
<a name="l00095"></a><a class="code" href="../../d9/d0/balmgr_8c.html#a9">00095</a> <span class="preprocessor"></span><span class="preprocessor">#define THREAD_READY_COUNT 10</span>
<a name="l00096"></a><a class="code" href="../../d9/d0/balmgr_8c.html#a10">00096</a> <span class="preprocessor"></span><span class="preprocessor">#define THREAD_SCAN_COUNT 16</span>
00097 <span class="preprocessor"></span>
<a name="l00098"></a><a class="code" href="../../d9/d0/balmgr_8c.html#a11">00098</a> <span class="preprocessor">#define EXECUTION_TIME_LIMITS_PERIOD 7</span>
00099 <span class="preprocessor"></span>
00100 <span class="comment">//</span>
00101 <span class="comment">// Define local procedure prototypes.</span>
00102 <span class="comment">//</span>
00103 
00104 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00105 <a class="code" href="../../d9/d0/balmgr_8c.html#a19">KiInSwapKernelStacks</a> (
00106     IN KIRQL PreviousIrql
00107     );
00108 
00109 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00110 <a class="code" href="../../d9/d0/balmgr_8c.html#a20">KiInSwapProcesses</a> (
00111     IN KIRQL PreviousIrql
00112     );
00113 
00114 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00115 <a class="code" href="../../d9/d0/balmgr_8c.html#a21">KiOutSwapKernelStacks</a> (
00116     IN KIRQL PreviousIrql
00117     );
00118 
00119 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00120 <a class="code" href="../../d9/d0/balmgr_8c.html#a22">KiOutSwapProcesses</a> (
00121     IN KIRQL PreviousIrql
00122     );
00123 
00124 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00125 <a class="code" href="../../d9/d0/balmgr_8c.html#a23">KiScanReadyQueues</a> (
00126     VOID
00127     );
00128 
00129 <span class="comment">//</span>
00130 <span class="comment">// Define thread table index static data.</span>
00131 <span class="comment">//</span>
00132 
<a name="l00133"></a><a class="code" href="../../d9/d0/balmgr_8c.html#a14">00133</a> ULONG <a class="code" href="../../d9/d0/balmgr_8c.html#a14">KiReadyQueueIndex</a> = 1;
00134 
00135 <span class="comment">//</span>
00136 <span class="comment">// Define swap request flag.</span>
00137 <span class="comment">//</span>
00138 
<a name="l00139"></a><a class="code" href="../../d9/d0/balmgr_8c.html#a15">00139</a> BOOLEAN <a class="code" href="../../d9/d0/balmgr_8c.html#a15">KiStackOutSwapRequest</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00140 
00141 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00142"></a><a class="code" href="../../d9/d0/balmgr_8c.html#a24">00142</a> <a class="code" href="../../d9/d0/balmgr_8c.html#a24">KeBalanceSetManager</a> (
00143     IN PVOID Context
00144     )
00145 
00146 <span class="comment">/*++</span>
00147 <span class="comment"></span>
00148 <span class="comment">Routine Description:</span>
00149 <span class="comment"></span>
00150 <span class="comment">    This function is the startup code for the balance set manager. The</span>
00151 <span class="comment">    balance set manager thread is created during system initialization</span>
00152 <span class="comment">    and begins execution in this function.</span>
00153 <span class="comment"></span>
00154 <span class="comment">Arguments:</span>
00155 <span class="comment"></span>
00156 <span class="comment">    Context - Supplies a pointer to an arbitrary data structure (NULL).</span>
00157 <span class="comment"></span>
00158 <span class="comment">Return Value:</span>
00159 <span class="comment"></span>
00160 <span class="comment">    None.</span>
00161 <span class="comment"></span>
00162 <span class="comment">--*/</span>
00163 
00164 {
00165 
00166     LARGE_INTEGER DueTime;
00167     <a class="code" href="../../d3/d8/struct__KTIMER.html">KTIMER</a> PeriodTimer;
00168     KIRQL OldIrql;
00169     ULONG StackScanPeriod;
00170     ULONG ExecutionTimeLimitPeriod;
00171     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00172     <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">KWAIT_BLOCK</a> WaitBlockArray[<a class="code" href="../../d9/d0/balmgr_8c.html#a26a18">MaximumObject</a>];
00173     PVOID WaitObjects[<a class="code" href="../../d9/d0/balmgr_8c.html#a26a18">MaximumObject</a>];
00174 
00175     <span class="comment">//</span>
00176     <span class="comment">// Raise the thread priority to the lowest realtime level.</span>
00177     <span class="comment">//</span>
00178 
00179     <a class="code" href="../../d9/d1/thredobj_8c.html#a24">KeSetPriorityThread</a>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>(), LOW_REALTIME_PRIORITY);
00180 
00181     <span class="comment">//</span>
00182     <span class="comment">// Initialize the periodic timer, set it to expire one period from</span>
00183     <span class="comment">// now, and set the stack scan period.</span>
00184     <span class="comment">//</span>
00185 
00186     <a class="code" href="../../d3/d2/timerobj_8c.html#a1">KeInitializeTimer</a>(&amp;PeriodTimer);
00187     DueTime.QuadPart = - <a class="code" href="../../d9/d0/balmgr_8c.html#a1">PERIODIC_INTERVAL</a>;
00188     <a class="code" href="../../d3/d2/timerobj_8c.html#a6">KeSetTimer</a>(&amp;PeriodTimer, DueTime, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00189     StackScanPeriod = <a class="code" href="../../d9/d0/balmgr_8c.html#a5">STACK_SCAN_PERIOD</a>;
00190     ExecutionTimeLimitPeriod = <a class="code" href="../../d9/d0/balmgr_8c.html#a11">EXECUTION_TIME_LIMITS_PERIOD</a>;
00191     <span class="comment">//</span>
00192     <span class="comment">// Compute the stack protect time based on the system size.</span>
00193     <span class="comment">//</span>
00194 
00195     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/mminit_8c.html#a57">MmQuerySystemSize</a>() == <a class="code" href="../../d2/d1/mm_8h.html#a343a165">MmSmallSystem</a>) {
00196         <a class="code" href="../../d4/d9/ke_8h.html#a140">KiStackProtectTime</a> = <a class="code" href="../../d9/d0/balmgr_8c.html#a3">SMALL_SYSTEM_STACK_PROTECT_TIME</a>;
00197 
00198     } <span class="keywordflow">else</span> {
00199         <a class="code" href="../../d4/d9/ke_8h.html#a140">KiStackProtectTime</a> = <a class="code" href="../../d9/d0/balmgr_8c.html#a4">STACK_PROTECT_TIME</a>;
00200     }
00201 
00202     <span class="comment">//</span>
00203     <span class="comment">// Initialize the wait objects array.</span>
00204     <span class="comment">//</span>
00205 
00206     WaitObjects[<a class="code" href="../../d1/d9/worker_8c.html#a31a18">TimerExpiration</a>] = (PVOID)&amp;PeriodTimer;
00207     WaitObjects[<a class="code" href="../../d9/d0/balmgr_8c.html#a26a17">WorkingSetManagerEvent</a>] = (PVOID)&amp;<a class="code" href="../../d2/d1/mm_8h.html#a139">MmWorkingSetManagerEvent</a>;
00208 
00209     <span class="comment">//</span>
00210     <span class="comment">// Loop forever processing balance set manager events.</span>
00211     <span class="comment">//</span>
00212 
00213     <span class="keywordflow">do</span> {
00214 
00215         <span class="comment">//</span>
00216         <span class="comment">// Wait for a memory management memory low event, a swap event,</span>
00217         <span class="comment">// or the expiration of the period timout rate that the balance</span>
00218         <span class="comment">// set manager runs at.</span>
00219         <span class="comment">//</span>
00220 
00221         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a3">KeWaitForMultipleObjects</a>(<a class="code" href="../../d9/d0/balmgr_8c.html#a26a18">MaximumObject</a>,
00222                                           &amp;WaitObjects[0],
00223                                           WaitAny,
00224                                           <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
00225                                           <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00226                                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00227                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00228                                           &amp;WaitBlockArray[0]);
00229 
00230         <span class="comment">//</span>
00231         <span class="comment">// Switch on the wait status.</span>
00232         <span class="comment">//</span>
00233 
00234         <span class="keywordflow">switch</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
00235 
00236             <span class="comment">//</span>
00237             <span class="comment">// Periodic timer expiration.</span>
00238             <span class="comment">//</span>
00239 
00240         <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/worker_8c.html#a31a18">TimerExpiration</a>:
00241 
00242             <span class="comment">//</span>
00243             <span class="comment">// Attempt to initiate outswaping of kernel stacks.</span>
00244             <span class="comment">//</span>
00245 
00246             StackScanPeriod -= 1;
00247             <span class="keywordflow">if</span> (StackScanPeriod == 0) {
00248                 StackScanPeriod = <a class="code" href="../../d9/d0/balmgr_8c.html#a5">STACK_SCAN_PERIOD</a>;
00249                 <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00250                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/balmgr_8c.html#a15">KiStackOutSwapRequest</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00251                     <a class="code" href="../../d9/d0/balmgr_8c.html#a15">KiStackOutSwapRequest</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00252                     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00253                     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a47">KiSwapEvent</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00254 
00255                 } <span class="keywordflow">else</span> {
00256                     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00257                 }
00258             }
00259 
00260             <span class="comment">//</span>
00261             <span class="comment">// Adjust the depth of lookaside lists.</span>
00262             <span class="comment">//</span>
00263 
00264             <a class="code" href="../../d5/d8/ex_8h.html#a245">ExAdjustLookasideDepth</a>();
00265 
00266             <span class="comment">//</span>
00267             <span class="comment">// Scan ready queues and boost thread priorities as appropriate.</span>
00268             <span class="comment">//</span>
00269 
00270             <a class="code" href="../../d9/d0/balmgr_8c.html#a23">KiScanReadyQueues</a>();
00271 
00272             <span class="comment">//</span>
00273             <span class="comment">// Execute the virtual memory working set manager.</span>
00274             <span class="comment">//</span>
00275 
00276             <a class="code" href="../../d5/d0/wsmanage_8c.html#a41">MmWorkingSetManager</a>();
00277 
00278             <span class="comment">//</span>
00279             <span class="comment">// Enforce execution time limits</span>
00280             <span class="comment">//</span>
00281 
00282             ExecutionTimeLimitPeriod -= 1;
00283             <span class="keywordflow">if</span> (ExecutionTimeLimitPeriod == 0) {
00284                 ExecutionTimeLimitPeriod = <a class="code" href="../../d9/d0/balmgr_8c.html#a11">EXECUTION_TIME_LIMITS_PERIOD</a>;
00285                 <a class="code" href="../../d1/d1/psjob_8c.html#a16">PsEnforceExecutionTimeLimits</a>();
00286                 }
00287 
00288             <span class="comment">//</span>
00289             <span class="comment">// Set the timer to expire at the next periodic interval.</span>
00290             <span class="comment">//</span>
00291 
00292             <a class="code" href="../../d3/d2/timerobj_8c.html#a6">KeSetTimer</a>(&amp;PeriodTimer, DueTime, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00293             <span class="keywordflow">break</span>;
00294 
00295             <span class="comment">//</span>
00296             <span class="comment">// Working set manager event.</span>
00297             <span class="comment">//</span>
00298 
00299         <span class="keywordflow">case</span> <a class="code" href="../../d9/d0/balmgr_8c.html#a26a17">WorkingSetManagerEvent</a>:
00300 
00301             <span class="comment">//</span>
00302             <span class="comment">// Call the working set manager to trim working sets.</span>
00303             <span class="comment">//</span>
00304 
00305             <a class="code" href="../../d5/d0/wsmanage_8c.html#a41">MmWorkingSetManager</a>();
00306             <span class="keywordflow">break</span>;
00307 
00308             <span class="comment">//</span>
00309             <span class="comment">// Illegal return status.</span>
00310             <span class="comment">//</span>
00311 
00312         <span class="keywordflow">default</span>:
00313             KdPrint((<span class="stringliteral">"BALMGR: Illegal wait status, %lx =\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00314             <span class="keywordflow">break</span>;
00315         }
00316 
00317     } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00318     <span class="keywordflow">return</span>;
00319 }
00320 
00321 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00322"></a><a class="code" href="../../d9/d0/balmgr_8c.html#a25">00322</a> <a class="code" href="../../d9/d0/balmgr_8c.html#a25">KeSwapProcessOrStack</a> (
00323     IN PVOID Context
00324     )
00325 
00326 <span class="comment">/*++</span>
00327 <span class="comment"></span>
00328 <span class="comment">Routine Description:</span>
00329 <span class="comment"></span>
00330 <span class="comment">    This thread controls the swapping of processes and kernel stacks. The</span>
00331 <span class="comment">    order of evaluation is:</span>
00332 <span class="comment"></span>
00333 <span class="comment">        Outswap kernel stacks</span>
00334 <span class="comment">        Outswap processes</span>
00335 <span class="comment">        Inswap processes</span>
00336 <span class="comment">        Inswap kernel stacks</span>
00337 <span class="comment"></span>
00338 <span class="comment">Arguments:</span>
00339 <span class="comment"></span>
00340 <span class="comment">    Context - Supplies a pointer to the routine context - not used.</span>
00341 <span class="comment"></span>
00342 <span class="comment">Return Value:</span>
00343 <span class="comment"></span>
00344 <span class="comment">    None.</span>
00345 <span class="comment"></span>
00346 <span class="comment">--*/</span>
00347 
00348 {
00349 
00350     KIRQL OldIrql;
00351     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00352 
00353     <span class="comment">//</span>
00354     <span class="comment">// Raise the thread priority to the lowest realtime level + 7 (i.e.,</span>
00355     <span class="comment">// priority 23).</span>
00356     <span class="comment">//</span>
00357 
00358     <a class="code" href="../../d9/d1/thredobj_8c.html#a24">KeSetPriorityThread</a>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>(), LOW_REALTIME_PRIORITY + 7);
00359 
00360     <span class="comment">//</span>
00361     <span class="comment">// Loop for ever processing swap events.</span>
00362     <span class="comment">//</span>
00363 
00364     <span class="keywordflow">do</span> {
00365 
00366         <span class="comment">//</span>
00367         <span class="comment">// Wait for a swap event to occur.</span>
00368         <span class="comment">//</span>
00369 
00370         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a47">KiSwapEvent</a>,
00371                                        <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
00372                                        <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00373                                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00374                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00375 
00376         <span class="comment">//</span>
00377         <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00378         <span class="comment">//</span>
00379 
00380         <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00381 
00382         <span class="comment">//</span>
00383         <span class="comment">// Loop until all of the four possible actions cannot be initiated.</span>
00384         <span class="comment">//</span>
00385 
00386         <span class="keywordflow">do</span> {
00387 
00388             <span class="comment">//</span>
00389             <span class="comment">// If a request has been made to out swap kernel stacks, then</span>
00390             <span class="comment">// attempt to outswap kernel stacks. Otherwise, if the process</span>
00391             <span class="comment">// out swap list is not empty, then initiate process outswapping.</span>
00392             <span class="comment">// Otherwise, if the process inswap list is not empty, then start</span>
00393             <span class="comment">// process inswapping. Otherwise, if the kernal stack inswap list</span>
00394             <span class="comment">// is not active, then initiate kernel stack inswapping. Otherwise,</span>
00395             <span class="comment">// no work is available.</span>
00396             <span class="comment">//</span>
00397 
00398             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/balmgr_8c.html#a15">KiStackOutSwapRequest</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00399                 <a class="code" href="../../d9/d0/balmgr_8c.html#a15">KiStackOutSwapRequest</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00400                 <a class="code" href="../../d9/d0/balmgr_8c.html#a21">KiOutSwapKernelStacks</a>(OldIrql);
00401                 <span class="keywordflow">continue</span>;
00402 
00403             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsListEmpty(&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a49">KiProcessOutSwapListHead</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00404                 <a class="code" href="../../d9/d0/balmgr_8c.html#a22">KiOutSwapProcesses</a>(OldIrql);
00405                 <span class="keywordflow">continue</span>;
00406 
00407             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsListEmpty(&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a48">KiProcessInSwapListHead</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00408                 <a class="code" href="../../d9/d0/balmgr_8c.html#a20">KiInSwapProcesses</a>(OldIrql);
00409                 <span class="keywordflow">continue</span>;
00410 
00411             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsListEmpty(&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a50">KiStackInSwapListHead</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00412                 <a class="code" href="../../d9/d0/balmgr_8c.html#a19">KiInSwapKernelStacks</a>(OldIrql);
00413                 <span class="keywordflow">continue</span>;
00414 
00415             } <span class="keywordflow">else</span> {
00416                 <span class="keywordflow">break</span>;
00417             }
00418         } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00419 
00420         <span class="comment">//</span>
00421         <span class="comment">// Unlock the dispatcher database and lower IRQL to its previous</span>
00422         <span class="comment">// value.</span>
00423         <span class="comment">//</span>
00424 
00425         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00426     } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00427     <span class="keywordflow">return</span>;
00428 }
00429 
00430 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00431"></a><a class="code" href="../../d9/d0/balmgr_8c.html#a19">00431</a> <a class="code" href="../../d9/d0/balmgr_8c.html#a19">KiInSwapKernelStacks</a> (
00432     IN KIRQL PreviousIrql
00433     )
00434 
00435 <span class="comment">/*++</span>
00436 <span class="comment"></span>
00437 <span class="comment">Routine Description:</span>
00438 <span class="comment"></span>
00439 <span class="comment">    This function in swaps the kernel stack for threads whose wait has been</span>
00440 <span class="comment">    completed and whose kernel stack is nonresident.</span>
00441 <span class="comment"></span>
00442 <span class="comment">    N.B. The dispatcher data lock is held on entry to this routine and must</span>
00443 <span class="comment">         be help on exit to this routine.</span>
00444 <span class="comment"></span>
00445 <span class="comment">Arguments:</span>
00446 <span class="comment"></span>
00447 <span class="comment">    PreviousIrql - Supplies the previous IRQL.</span>
00448 <span class="comment"></span>
00449 <span class="comment">Return Value:</span>
00450 <span class="comment"></span>
00451 <span class="comment">    None.</span>
00452 <span class="comment"></span>
00453 <span class="comment">--*/</span>
00454 
00455 {
00456 
00457     PLIST_ENTRY NextEntry;
00458     KIRQL OldIrql;
00459     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00460 
00461     <span class="comment">//</span>
00462     <span class="comment">// Process the stack in swap list and for each thread removed from the</span>
00463     <span class="comment">// list, make its kernel stack resident, and ready it for execution.</span>
00464     <span class="comment">//</span>
00465 
00466     OldIrql = PreviousIrql;
00467     NextEntry = <a class="code" href="../../d5/d9/kernldat_8c.html#a50">KiStackInSwapListHead</a>.Flink;
00468     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a50">KiStackInSwapListHead</a>) {
00469         Thread = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d8/struct__KTHREAD.html">KTHREAD</a>, WaitListEntry);
00470         RemoveEntryList(NextEntry);
00471         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00472         <a class="code" href="../../d4/d5/procsup_8c.html#a37">MmInPageKernelStack</a>(Thread);
00473         <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00474         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o44">KernelStackResident</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00475         <a class="code" href="../../d0/d2/thredsup_8c.html#a3">KiReadyThread</a>(Thread);
00476         NextEntry = <a class="code" href="../../d5/d9/kernldat_8c.html#a50">KiStackInSwapListHead</a>.Flink;
00477     }
00478 
00479     <span class="keywordflow">return</span>;
00480 }
00481 
00482 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00483"></a><a class="code" href="../../d9/d0/balmgr_8c.html#a20">00483</a> <a class="code" href="../../d9/d0/balmgr_8c.html#a20">KiInSwapProcesses</a> (
00484     IN KIRQL PreviousIrql
00485     )
00486 
00487 <span class="comment">/*++</span>
00488 <span class="comment"></span>
00489 <span class="comment">Routine Description:</span>
00490 <span class="comment"></span>
00491 <span class="comment">    This function in swaps processes.</span>
00492 <span class="comment"></span>
00493 <span class="comment">    N.B. The dispatcher data lock is held on entry to this routine and must</span>
00494 <span class="comment">         be help on exit to this routine.</span>
00495 <span class="comment"></span>
00496 <span class="comment">Arguments:</span>
00497 <span class="comment"></span>
00498 <span class="comment">    PreviousIrql - Supplies the previous IRQL.</span>
00499 <span class="comment"></span>
00500 <span class="comment">Return Value:</span>
00501 <span class="comment"></span>
00502 <span class="comment">    None.</span>
00503 <span class="comment"></span>
00504 <span class="comment">--*/</span>
00505 
00506 {
00507 
00508     PLIST_ENTRY NextEntry;
00509     KIRQL OldIrql;
00510     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00511     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00512 
00513     <span class="comment">//</span>
00514     <span class="comment">// Process the process in swap list and for each process removed from</span>
00515     <span class="comment">// the list, make the process resident, and process its ready list.</span>
00516     <span class="comment">//</span>
00517 
00518     OldIrql = PreviousIrql;
00519     NextEntry = <a class="code" href="../../d5/d9/kernldat_8c.html#a48">KiProcessInSwapListHead</a>.Flink;
00520     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a48">KiProcessInSwapListHead</a>) {
00521         Process = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d5/d7/struct__KPROCESS.html">KPROCESS</a>, SwapListEntry);
00522         RemoveEntryList(NextEntry);
00523         Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o15">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a405a189">ProcessInSwap</a>;
00524         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00525         <a class="code" href="../../d4/d5/procsup_8c.html#a39">MmInSwapProcess</a>(Process);
00526         <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00527         Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o15">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a405a186">ProcessInMemory</a>;
00528         NextEntry = Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o6">ReadyListHead</a>.Flink;
00529         <span class="keywordflow">while</span> (NextEntry != &amp;Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o6">ReadyListHead</a>) {
00530             Thread = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d8/struct__KTHREAD.html">KTHREAD</a>, WaitListEntry);
00531             RemoveEntryList(NextEntry);
00532             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o43">ProcessReadyQueue</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00533             <a class="code" href="../../d0/d2/thredsup_8c.html#a3">KiReadyThread</a>(Thread);
00534             NextEntry = Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o6">ReadyListHead</a>.Flink;
00535         }
00536 
00537         NextEntry = <a class="code" href="../../d5/d9/kernldat_8c.html#a48">KiProcessInSwapListHead</a>.Flink;
00538     }
00539 
00540     <span class="keywordflow">return</span>;
00541 }
00542 
00543 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00544"></a><a class="code" href="../../d9/d0/balmgr_8c.html#a21">00544</a> <a class="code" href="../../d9/d0/balmgr_8c.html#a21">KiOutSwapKernelStacks</a> (
00545     IN KIRQL PreviousIrql
00546     )
00547 
00548 <span class="comment">/*++</span>
00549 <span class="comment"></span>
00550 <span class="comment">Routine Description:</span>
00551 <span class="comment"></span>
00552 <span class="comment">    This function attempts to out swap the kernel stack for threads whose</span>
00553 <span class="comment">    wait mode is user and which have been waiting longer than the stack</span>
00554 <span class="comment">    protect time.</span>
00555 <span class="comment"></span>
00556 <span class="comment">    N.B. The dispatcher data lock is held on entry to this routine and must</span>
00557 <span class="comment">         be help on exit to this routine.</span>
00558 <span class="comment"></span>
00559 <span class="comment">Arguments:</span>
00560 <span class="comment"></span>
00561 <span class="comment">    PreviousIrql - Supplies the previous IRQL.</span>
00562 <span class="comment"></span>
00563 <span class="comment">Return Value:</span>
00564 <span class="comment"></span>
00565 <span class="comment">    None.</span>
00566 <span class="comment"></span>
00567 <span class="comment">--*/</span>
00568 
00569 {
00570 
00571     ULONG CurrentTick;
00572     PLIST_ENTRY NextEntry;
00573     ULONG NumberOfThreads;
00574     KIRQL OldIrql;
00575     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00576     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00577     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> ThreadObjects[<a class="code" href="../../d9/d0/balmgr_8c.html#a0">MAXIMUM_THREAD_STACKS</a>];
00578     ULONG WaitTime;
00579 
00580     <span class="comment">//</span>
00581     <span class="comment">// Scan the waiting in list and check if the wait time exceeds the</span>
00582     <span class="comment">// stack protect time. If the protect time is exceeded, then make</span>
00583     <span class="comment">// the kernel stack of the waiting thread nonresident. If the count</span>
00584     <span class="comment">// of the number of stacks that are resident for the process reaches</span>
00585     <span class="comment">// zero, then insert the process in the outswap list and set its state</span>
00586     <span class="comment">// to transition.</span>
00587     <span class="comment">//</span>
00588 
00589     CurrentTick = KiQueryLowTickCount();
00590     OldIrql = PreviousIrql;
00591     NextEntry = <a class="code" href="../../d5/d9/kernldat_8c.html#a61">KiWaitInListHead</a>.Flink;
00592     NumberOfThreads = 0;
00593     <span class="keywordflow">while</span> ((NextEntry != &amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a61">KiWaitInListHead</a>) &amp;&amp;
00594            (NumberOfThreads &lt; <a class="code" href="../../d9/d0/balmgr_8c.html#a0">MAXIMUM_THREAD_STACKS</a>)) {
00595         Thread = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d8/struct__KTHREAD.html">KTHREAD</a>, WaitListEntry);
00596 
00597         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o18">WaitMode</a> == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00598 
00599         NextEntry = NextEntry-&gt;Flink;
00600         WaitTime = CurrentTick - Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o23">WaitTime</a>;
00601         <span class="keywordflow">if</span> ((WaitTime &gt;= <a class="code" href="../../d4/d9/ke_8h.html#a140">KiStackProtectTime</a>) &amp;&amp;
00602              <a class="code" href="../../d9/d9/mips_8h.html#a1">KiIsThreadNumericStateSaved</a>(Thread)) {
00603             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o44">KernelStackResident</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00604             ThreadObjects[NumberOfThreads] = Thread;
00605             NumberOfThreads += 1;
00606             RemoveEntryList(&amp;Thread-&gt;WaitListEntry);
00607             InsertTailList(&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a62">KiWaitOutListHead</a>, &amp;Thread-&gt;WaitListEntry);
00608             Process = Thread-&gt;ApcState.Process;
00609             Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o11">StackCount</a> -= 1;
00610             <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o11">StackCount</a> == 0) {
00611                 Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o15">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a405a188">ProcessInTransition</a>;
00612                 InsertTailList(&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a49">KiProcessOutSwapListHead</a>,
00613                                &amp;Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o7">SwapListEntry</a>);
00614             }
00615         }
00616     }
00617 
00618     <span class="comment">//</span>
00619     <span class="comment">// Unlock the dispatcher database and lower IRQL to its previous</span>
00620     <span class="comment">// value.</span>
00621     <span class="comment">//</span>
00622 
00623     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00624 
00625     <span class="comment">//</span>
00626     <span class="comment">// Out swap the kernels stack for the selected set of threads.</span>
00627     <span class="comment">//</span>
00628 
00629     <span class="keywordflow">while</span> (NumberOfThreads &gt; 0) {
00630         NumberOfThreads -= 1;
00631         Thread = ThreadObjects[NumberOfThreads];
00632         <a class="code" href="../../d4/d5/procsup_8c.html#a36">MmOutPageKernelStack</a>(Thread);
00633     }
00634 
00635     <span class="comment">//</span>
00636     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00637     <span class="comment">//</span>
00638 
00639     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00640     <span class="keywordflow">return</span>;
00641 }
00642 
00643 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00644"></a><a class="code" href="../../d9/d0/balmgr_8c.html#a22">00644</a> <a class="code" href="../../d9/d0/balmgr_8c.html#a22">KiOutSwapProcesses</a> (
00645     IN KIRQL PreviousIrql
00646     )
00647 
00648 <span class="comment">/*++</span>
00649 <span class="comment"></span>
00650 <span class="comment">Routine Description:</span>
00651 <span class="comment"></span>
00652 <span class="comment">    This function out swaps processes.</span>
00653 <span class="comment"></span>
00654 <span class="comment">    N.B. The dispatcher data lock is held on entry to this routine and must</span>
00655 <span class="comment">         be help on exit to this routine.</span>
00656 <span class="comment"></span>
00657 <span class="comment">Arguments:</span>
00658 <span class="comment"></span>
00659 <span class="comment">    PreviousIrql - Supplies the previous IRQL.</span>
00660 <span class="comment"></span>
00661 <span class="comment">Return Value:</span>
00662 <span class="comment"></span>
00663 <span class="comment">    None.</span>
00664 <span class="comment"></span>
00665 <span class="comment">--*/</span>
00666 
00667 {
00668 
00669     PLIST_ENTRY NextEntry;
00670     KIRQL OldIrql;
00671     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00672     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00673 
00674     <span class="comment">//</span>
00675     <span class="comment">// Process the process out swap list and for each process removed from</span>
00676     <span class="comment">// the list, make the process nonresident, and process its ready list.</span>
00677     <span class="comment">//</span>
00678 
00679     OldIrql = PreviousIrql;
00680     NextEntry = <a class="code" href="../../d5/d9/kernldat_8c.html#a49">KiProcessOutSwapListHead</a>.Flink;
00681     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a49">KiProcessOutSwapListHead</a>) {
00682         Process = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d5/d7/struct__KPROCESS.html">KPROCESS</a>, SwapListEntry);
00683         RemoveEntryList(NextEntry);
00684 
00685         <span class="comment">//</span>
00686         <span class="comment">// If there are any threads in the process ready list, then don't</span>
00687         <span class="comment">// out swap the process and ready all threads in the process ready</span>
00688         <span class="comment">// list. Otherwsie, out swap the process.</span>
00689         <span class="comment">//</span>
00690 
00691         NextEntry = Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o6">ReadyListHead</a>.Flink;
00692         <span class="keywordflow">if</span> (NextEntry != &amp;Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o6">ReadyListHead</a>) {
00693             Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o15">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a405a186">ProcessInMemory</a>;
00694             <span class="keywordflow">while</span> (NextEntry != &amp;Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o6">ReadyListHead</a>) {
00695                 Thread = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d8/struct__KTHREAD.html">KTHREAD</a>, WaitListEntry);
00696                 RemoveEntryList(NextEntry);
00697                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o43">ProcessReadyQueue</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00698                 <a class="code" href="../../d0/d2/thredsup_8c.html#a3">KiReadyThread</a>(Thread);
00699                 NextEntry = Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o6">ReadyListHead</a>.Flink;
00700             }
00701 
00702         } <span class="keywordflow">else</span> {
00703             Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o15">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a405a190">ProcessOutSwap</a>;
00704             <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00705             <a class="code" href="../../d4/d5/procsup_8c.html#a38">MmOutSwapProcess</a>(Process);
00706             <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00707 
00708             <span class="comment">//</span>
00709             <span class="comment">// While the process was being outswapped there may have been one</span>
00710             <span class="comment">// or more threads that attached to the process. If the process</span>
00711             <span class="comment">// ready list is not empty, then in swap the process. Otherwise,</span>
00712             <span class="comment">// mark the process as out of memory.</span>
00713             <span class="comment">//</span>
00714 
00715             NextEntry = Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o6">ReadyListHead</a>.Flink;
00716             <span class="keywordflow">if</span> (NextEntry != &amp;Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o6">ReadyListHead</a>) {
00717                 Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o15">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a405a188">ProcessInTransition</a>;
00718                 InsertTailList(&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a48">KiProcessInSwapListHead</a>, &amp;Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o7">SwapListEntry</a>);
00719 
00720             } <span class="keywordflow">else</span> {
00721                 Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o15">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a405a187">ProcessOutOfMemory</a>;
00722             }
00723         }
00724 
00725         NextEntry = <a class="code" href="../../d5/d9/kernldat_8c.html#a49">KiProcessOutSwapListHead</a>.Flink;
00726     }
00727 
00728     <span class="keywordflow">return</span>;
00729 }
00730 
00731 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00732"></a><a class="code" href="../../d9/d0/balmgr_8c.html#a23">00732</a> <a class="code" href="../../d9/d0/balmgr_8c.html#a23">KiScanReadyQueues</a> (
00733     VOID
00734     )
00735 
00736 <span class="comment">/*++</span>
00737 <span class="comment"></span>
00738 <span class="comment">Routine Description:</span>
00739 <span class="comment"></span>
00740 <span class="comment">    This function scans a section of the ready queues and attempts to</span>
00741 <span class="comment">    boost the priority of threads that run at variable priority levels.</span>
00742 <span class="comment"></span>
00743 <span class="comment">Arguments:</span>
00744 <span class="comment"></span>
00745 <span class="comment">    None.</span>
00746 <span class="comment"></span>
00747 <span class="comment">Return Value:</span>
00748 <span class="comment"></span>
00749 <span class="comment">    None.</span>
00750 <span class="comment"></span>
00751 <span class="comment">--*/</span>
00752 
00753 {
00754 
00755     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
00756     ULONG CurrentTick;
00757     PLIST_ENTRY Entry;
00758     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00759     PLIST_ENTRY ListHead;
00760     ULONG Number = 0;
00761     KIRQL OldIrql;
00762     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00763     ULONG Summary;
00764     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00765     ULONG WaitTime;
00766 
00767     <span class="comment">//</span>
00768     <span class="comment">// Lock the dispatcher database and check if there are any ready threads</span>
00769     <span class="comment">// queued at the scannable priority levels.</span>
00770     <span class="comment">//</span>
00771 
00772     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00773     Summary = <a class="code" href="../../d5/d9/kernldat_8c.html#a2">KiReadySummary</a> &amp; ((1 &lt;&lt; <a class="code" href="../../d9/d0/balmgr_8c.html#a7">THREAD_BOOST_PRIORITY</a>) - 2);
00774     <span class="keywordflow">if</span> (Summary != 0) {
00775         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = <a class="code" href="../../d9/d0/balmgr_8c.html#a9">THREAD_READY_COUNT</a>;
00776         CurrentTick = KiQueryLowTickCount();
00777         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d9/d0/balmgr_8c.html#a14">KiReadyQueueIndex</a>;
00778         Number = <a class="code" href="../../d9/d0/balmgr_8c.html#a10">THREAD_SCAN_COUNT</a>;
00779         <span class="keywordflow">do</span> {
00780 
00781             <span class="comment">//</span>
00782             <span class="comment">// If the current ready queue index is beyond the end of the range</span>
00783             <span class="comment">// of priorities that are scanned, then wrap back to the beginning</span>
00784             <span class="comment">// priority.</span>
00785             <span class="comment">//</span>
00786 
00787             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt; <a class="code" href="../../d9/d0/balmgr_8c.html#a8">THREAD_SCAN_PRIORITY</a>) {
00788                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 1;
00789             }
00790 
00791             <span class="comment">//</span>
00792             <span class="comment">// If there are any ready threads queued at the current priority</span>
00793             <span class="comment">// level, then attempt to boost the thread priority.</span>
00794             <span class="comment">//</span>
00795 
00796             <span class="keywordflow">if</span> (((Summary &gt;&gt; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>) &amp; 1) != 0) {
00797                 Summary ^= (1 &lt;&lt; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>);
00798                 ListHead = &amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a0">KiDispatcherReadyListHead</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00799                 Entry = ListHead-&gt;Flink;
00800 
00801                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Entry != ListHead);
00802 
00803                 <span class="keywordflow">do</span> {
00804                     Thread = CONTAINING_RECORD(Entry, <a class="code" href="../../d1/d8/struct__KTHREAD.html">KTHREAD</a>, WaitListEntry);
00805 
00806                     <span class="comment">//</span>
00807                     <span class="comment">// If the thread has been waiting for an extended period,</span>
00808                     <span class="comment">// then boost the priority of the selected.</span>
00809                     <span class="comment">//</span>
00810 
00811                     WaitTime = CurrentTick - Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o23">WaitTime</a>;
00812                     <span class="keywordflow">if</span> (WaitTime &gt;= <a class="code" href="../../d9/d0/balmgr_8c.html#a2">READY_WITHOUT_RUNNING</a>) {
00813 
00814                         <span class="comment">//</span>
00815                         <span class="comment">// Remove the thread from the respective ready queue.</span>
00816                         <span class="comment">//</span>
00817 
00818                         Entry = Entry-&gt;Blink;
00819                         RemoveEntryList(Entry-&gt;Flink);
00820                         <span class="keywordflow">if</span> (IsListEmpty(ListHead) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00821                             <a class="code" href="../../d0/d0/ki_8h.html#a6">ClearMember</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, <a class="code" href="../../d5/d9/kernldat_8c.html#a2">KiReadySummary</a>);
00822                         }
00823 
00824                         <span class="comment">//</span>
00825                         <span class="comment">// Compute the priority decrement value, set the new</span>
00826                         <span class="comment">// thread priority, set the decrement count, set the</span>
00827                         <span class="comment">// thread quantum, and ready the thread for execution.</span>
00828                         <span class="comment">//</span>
00829 
00830                         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o26">PriorityDecrement</a> +=
00831                                         <a class="code" href="../../d9/d0/balmgr_8c.html#a7">THREAD_BOOST_PRIORITY</a> - Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o13">Priority</a>;
00832 
00833                         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o25">DecrementCount</a> = <a class="code" href="../../d4/d9/ke_8h.html#a4">ROUND_TRIP_DECREMENT_COUNT</a>;
00834                         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o13">Priority</a> = <a class="code" href="../../d9/d0/balmgr_8c.html#a7">THREAD_BOOST_PRIORITY</a>;
00835                         Process = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>;
00836                         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o27">Quantum</a> = Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o13">ThreadQuantum</a> * 2;
00837                         <a class="code" href="../../d0/d2/thredsup_8c.html#a3">KiReadyThread</a>(Thread);
00838                         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> -= 1;
00839                     }
00840 
00841                     Entry = Entry-&gt;Flink;
00842                     Number -= 1;
00843                 } <span class="keywordflow">while</span> ((Entry != ListHead) &amp; (Number != 0) &amp; (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> != 0));
00844             }
00845 
00846             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
00847         } <span class="keywordflow">while</span> ((Summary != 0) &amp; (Number != 0) &amp; (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> != 0));
00848     }
00849 
00850     <span class="comment">//</span>
00851     <span class="comment">// Unlock the dispatcher database and save the last read queue index</span>
00852     <span class="comment">// for the next scan.</span>
00853     <span class="comment">//</span>
00854 
00855     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00856     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> != 0) &amp;&amp; (Number != 0)) {
00857         <a class="code" href="../../d9/d0/balmgr_8c.html#a14">KiReadyQueueIndex</a> = 1;
00858 
00859     } <span class="keywordflow">else</span> {
00860         <a class="code" href="../../d9/d0/balmgr_8c.html#a14">KiReadyQueueIndex</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00861     }
00862 
00863     <span class="keywordflow">return</span>;
00864 }
00865 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:18 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
