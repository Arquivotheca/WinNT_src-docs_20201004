<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: obhandle.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>obhandle.c</h1><a href="../../d9/d0/obhandle_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    obhandle.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Object handle routines</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Steve Wood (stevewo) 31-Mar-1989</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d5/d1/obp_8h.html">obp.h</a>"</span>
00022 
00023 <span class="comment">//</span>
00024 <span class="comment">//  Define logical sum of all generic accesses.</span>
00025 <span class="comment">//</span>
00026 
<a name="l00027"></a><a class="code" href="../../d9/d0/obhandle_8c.html#a0">00027</a> <span class="preprocessor">#define GENERIC_ACCESS (GENERIC_READ | GENERIC_WRITE | GENERIC_EXECUTE | GENERIC_ALL)</span>
00028 <span class="preprocessor"></span>
00029 <span class="comment">//</span>
00030 <span class="comment">//  The following variable is declared in obinit.c and is used to protect the</span>
00031 <span class="comment">//  process object table</span>
00032 <span class="comment">//</span>
00033 
<a name="l00034"></a><a class="code" href="../../d9/d0/obhandle_8c.html#a1">00034</a> <span class="keyword">extern</span> <a class="code" href="../../d3/d7/struct__KMUTANT.html">KMUTANT</a> <a class="code" href="../../d9/d0/obhandle_8c.html#a1">ObpInitKillMutant</a>;
00035 
00036 <span class="comment">//</span>
00037 <span class="comment">// Define local prototypes</span>
00038 <span class="comment">//</span>
00039 
00040 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00041 <a class="code" href="../../d9/d0/obhandle_8c.html#a2">ObpIncrementHandleDataBase</a> (
00042     IN <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader,
00043     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00044     OUT PULONG NewProcessHandleCount
00045     );
00046 
00047 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00048 <a class="code" href="../../d9/d0/obhandle_8c.html#a6">ObpCaptureHandleInformation</a> (
00049     IN OUT PSYSTEM_HANDLE_TABLE_ENTRY_INFO *HandleEntryInfo,
00050     IN HANDLE UniqueProcessId,
00051     IN PVOID HandleTableEntry,
00052     IN HANDLE HandleIndex,
00053     IN ULONG Length,
00054     IN OUT PULONG RequiredLength
00055     );
00056 
00057 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00058 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtDuplicateObject)</span>
00059 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObGetHandleInformation)</span>
00060 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObpInsertHandleCount)</span>
00061 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObpIncrementHandleCount)</span>
00062 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObpIncrementUnnamedHandleCount)</span>
00063 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObpDecrementHandleCount)</span>
00064 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObpCreateHandle)</span>
00065 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObpCreateUnnamedHandle)</span>
00066 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObpIncrementHandleDataBase)</span>
00067 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00068 <span class="preprocessor"></span>
00069 
00070 <span class="comment">//</span>
00071 <span class="comment">//  Define routines for incrementing and decrementing the object header</span>
00072 <span class="comment">//  counters.  These routines are only used if MPSAFE handle count check</span>
00073 <span class="comment">//  is defined</span>
00074 <span class="comment">//</span>
00075 
00076 <span class="preprocessor">#ifdef MPSAFE_HANDLE_COUNT_CHECK</span>
00077 <span class="preprocessor"></span>
00078 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00079 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
00080 <a class="code" href="../../d5/d1/obp_8h.html#a3">ObpIncrPointerCount</a> (
00081     IN <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader
00082     )
00083 {
00084     KIRQL OldIrql;
00085 
00086     ExAcquireFastLock( &amp;ObpLock, &amp;OldIrql );
00087     ObjectHeader-&gt;PointerCount += 1;
00088     ExReleaseFastLock( &amp;ObpLock, OldIrql );
00089 }
00090 
00091 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00092 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
00093 <a class="code" href="../../d5/d1/obp_8h.html#a4">ObpDecrPointerCount</a> (
00094     IN <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader
00095     )
00096 {
00097     KIRQL OldIrql;
00098 
00099     ExAcquireFastLock( &amp;ObpLock, &amp;OldIrql );
00100     ObjectHeader-&gt;PointerCount -= 1;
00101     ExReleaseFastLock( &amp;ObpLock, OldIrql );
00102 }
00103 
00104 BOOLEAN
00105 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
00106 <a class="code" href="../../d5/d1/obp_8h.html#a5">ObpDecrPointerCountWithResult</a> (
00107     IN <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader
00108     )
00109 {
00110     KIRQL OldIrql;
00111     LONG Result;
00112 
00113     ExAcquireFastLock( &amp;ObpLock, &amp;OldIrql );
00114 
00115     <span class="keywordflow">if</span> (ObjectHeader-&gt;PointerCount &lt;= ObjectHeader-&gt;HandleCount) {
00116 
00117         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"OB: About to over-dereference object %x (ObjectHeader at %x)\n"</span>,
00118                   ObjectHeader-&gt;Object, ObjectHeader );
00119 
00120         DbgBreakPoint();
00121     }
00122 
00123     ObjectHeader-&gt;PointerCount -= 1;
00124     Result = ObjectHeader-&gt;PointerCount;
00125     ExReleaseFastLock( &amp;ObpLock, OldIrql );
00126     <span class="keywordflow">return</span> Result == 0;
00127 }
00128 
00129 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00130 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
00131 <a class="code" href="../../d5/d1/obp_8h.html#a6">ObpIncrHandleCount</a> (
00132     IN <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader
00133     )
00134 {
00135     KIRQL OldIrql;
00136 
00137     ExAcquireFastLock( &amp;ObpLock, &amp;OldIrql );
00138     ObjectHeader-&gt;HandleCount += 1;
00139     ExReleaseFastLock( &amp;ObpLock, OldIrql );
00140     }
00141 
00142 BOOLEAN
00143 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
00144 <a class="code" href="../../d5/d1/obp_8h.html#a7">ObpDecrHandleCount</a> (
00145     IN <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader
00146     )
00147 {
00148     KIRQL OldIrql;
00149     LONG Old;
00150 
00151     ExAcquireFastLock( &amp;ObpLock, &amp;OldIrql );
00152     Old = ObjectHeader-&gt;HandleCount;
00153     ObjectHeader-&gt;HandleCount -= 1;
00154     ExReleaseFastLock( &amp;ObpLock, OldIrql );
00155 
00156     <span class="keywordflow">return</span> Old == 1;
00157 }
00158 
00159 <span class="preprocessor">#endif // MPSAFE_HANDLE_COUNT_CHECK</span>
00160 <span class="preprocessor"></span>
00161 
00162 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00163"></a><a class="code" href="../../d9/d0/obhandle_8c.html#a4">00163</a> <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a> (
00164     IN HANDLE SourceProcessHandle,
00165     IN HANDLE SourceHandle,
00166     IN HANDLE TargetProcessHandle OPTIONAL,
00167     OUT PHANDLE TargetHandle OPTIONAL,
00168     IN ACCESS_MASK DesiredAccess,
00169     IN ULONG HandleAttributes,
00170     IN ULONG Options
00171     )
00172 
00173 <span class="comment">/*++</span>
00174 <span class="comment"></span>
00175 <span class="comment">Routine Description:</span>
00176 <span class="comment"></span>
00177 <span class="comment">    This function creates a handle that is a duplicate of the specified</span>
00178 <span class="comment">    source handle.  The source handle is evaluated in the context of the</span>
00179 <span class="comment">    specified source process.  The calling process must have</span>
00180 <span class="comment">    PROCESS_DUP_HANDLE access to the source process.  The duplicate</span>
00181 <span class="comment">    handle is created with the specified attributes and desired access.</span>
00182 <span class="comment">    The duplicate handle is created in the handle table of the specified</span>
00183 <span class="comment">    target process.  The calling process must have PROCESS_DUP_HANDLE</span>
00184 <span class="comment">    access to the target process.</span>
00185 <span class="comment"></span>
00186 <span class="comment">Arguments:</span>
00187 <span class="comment"></span>
00188 <span class="comment">    SourceProcessHandle - Supplies a handle to the source process for the</span>
00189 <span class="comment">        handle being duplicated</span>
00190 <span class="comment"></span>
00191 <span class="comment">    SourceHandle - Supplies the handle being duplicated</span>
00192 <span class="comment"></span>
00193 <span class="comment">    TargetProcessHandle - Optionally supplies a handle to the target process</span>
00194 <span class="comment">        that is to receive the new handle</span>
00195 <span class="comment"></span>
00196 <span class="comment">    TargetHandle - Optionally returns a the new duplicated handle</span>
00197 <span class="comment"></span>
00198 <span class="comment">    DesiredAccess - Desired access for the new handle</span>
00199 <span class="comment"></span>
00200 <span class="comment">    HandleAttributes - Desired attributes for the new handle</span>
00201 <span class="comment"></span>
00202 <span class="comment">    Options - Duplication options that control things like close source,</span>
00203 <span class="comment">        same access, and same attributes.</span>
00204 <span class="comment"></span>
00205 <span class="comment">Return Value:</span>
00206 <span class="comment"></span>
00207 <span class="comment">    TBS</span>
00208 <span class="comment"></span>
00209 <span class="comment">--*/</span>
00210 
00211 {
00212     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00213     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00214     PVOID SourceObject;
00215     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00216     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
00217     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> SourceProcess;
00218     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess;
00219     BOOLEAN Attached;
00220     PVOID ObjectTable;
00221     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">HANDLE_TABLE_ENTRY</a> ObjectTableEntry;
00222     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a> HandleInformation;
00223     HANDLE NewHandle;
00224     <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">ACCESS_STATE</a> AccessState;
00225     <a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">AUX_ACCESS_DATA</a> AuxData;
00226     ACCESS_MASK SourceAccess;
00227     ACCESS_MASK TargetAccess;
00228     <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> PassedAccessState = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00229 
00230     <span class="comment">//</span>
00231     <span class="comment">//  Get previous processor mode and probe output arguments if necessary.</span>
00232     <span class="comment">//</span>
00233 
00234     PreviousMode = KeGetPreviousMode();
00235 
00236     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( TargetHandle ) &amp;&amp; (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>)) {
00237 
00238         <span class="keywordflow">try</span> {
00239 
00240             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>( TargetHandle );
00241 
00242         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00243 
00244             <span class="keywordflow">return</span>( GetExceptionCode() );
00245         }
00246     }
00247 
00248     <span class="comment">//</span>
00249     <span class="comment">//  If the caller is not asking for the same access then</span>
00250     <span class="comment">//  validate the access they are requesting doesn't contain</span>
00251     <span class="comment">//  any bad bits</span>
00252     <span class="comment">//</span>
00253 
00254     <span class="keywordflow">if</span> (!(Options &amp; DUPLICATE_SAME_ACCESS)) {
00255 
00256         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a83">ObpValidateDesiredAccess</a>( DesiredAccess );
00257 
00258         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00259 
00260             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00261         }
00262     }
00263 
00264     <span class="comment">//</span>
00265     <span class="comment">//  The Attached variable indicates if we needed to</span>
00266     <span class="comment">//  attach to the source process because it was not the</span>
00267     <span class="comment">//  current process.</span>
00268     <span class="comment">//</span>
00269 
00270     Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00271 
00272     <span class="comment">//</span>
00273     <span class="comment">//  Given the input source process handle get a pointer</span>
00274     <span class="comment">//  to the source process object</span>
00275     <span class="comment">//</span>
00276 
00277     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( SourceProcessHandle,
00278                                         PROCESS_DUP_HANDLE,
00279                                         <a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>,
00280                                         PreviousMode,
00281                                         (PVOID *)&amp;SourceProcess,
00282                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00283 
00284     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00285 
00286         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00287     }
00288 
00289     <span class="comment">//</span>
00290     <span class="comment">//  Lock down access to the process object tables</span>
00291     <span class="comment">//</span>
00292 
00293     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00294 
00295     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;<a class="code" href="../../d9/d0/obhandle_8c.html#a1">ObpInitKillMutant</a>,
00296                            <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
00297                            <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00298                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00299                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00300 
00301     <span class="comment">//</span>
00302     <span class="comment">//  Make sure the source process has an object table still</span>
00303     <span class="comment">//</span>
00304 
00305     <span class="keywordflow">if</span> ( SourceProcess-&gt;ObjectTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00306 
00307         <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a>( &amp;<a class="code" href="../../d9/d0/obhandle_8c.html#a1">ObpInitKillMutant</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00308 
00309         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00310 
00311         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SourceProcess );
00312 
00313         <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
00314     }
00315 
00316     <span class="comment">//</span>
00317     <span class="comment">//  If the specified source process is not the current process, attach</span>
00318     <span class="comment">//  to the specified source process.  Then after we reference the object</span>
00319     <span class="comment">//  we can detach from the process.</span>
00320     <span class="comment">//</span>
00321 
00322     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != SourceProcess) {
00323 
00324         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>( &amp;SourceProcess-&gt;Pcb );
00325 
00326         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00327     }
00328 
00329     <span class="comment">//</span>
00330     <span class="comment">//  The the input source handle get a pointer to the</span>
00331     <span class="comment">//  source object itself, then detach from the process</span>
00332     <span class="comment">//  if necessary and check if we were given a good</span>
00333     <span class="comment">//  source handle.</span>
00334     <span class="comment">//</span>
00335 
00336     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( SourceHandle,
00337                                         0,
00338                                         (<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00339                                         PreviousMode,
00340                                         &amp;SourceObject,
00341                                         &amp;HandleInformation );
00342 
00343     <span class="keywordflow">if</span> (Attached) {
00344 
00345         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00346 
00347         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00348     }
00349 
00350     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00351 
00352         <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a>( &amp;<a class="code" href="../../d9/d0/obhandle_8c.html#a1">ObpInitKillMutant</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00353 
00354         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00355 
00356         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SourceProcess );
00357 
00358         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00359     }
00360 
00361     <span class="comment">//</span>
00362     <span class="comment">//  We are all done if no target process handle was specified.</span>
00363     <span class="comment">//  This is practially a noop because the only really end result</span>
00364     <span class="comment">//  could be that we've closed the source handle.</span>
00365     <span class="comment">//</span>
00366 
00367     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( TargetProcessHandle )) {
00368 
00369         <span class="comment">//</span>
00370         <span class="comment">//  If no TargetProcessHandle, then only possible option is to close</span>
00371         <span class="comment">//  the source handle in the context of the source process.</span>
00372         <span class="comment">//</span>
00373 
00374         <span class="keywordflow">if</span> (!(Options &amp; DUPLICATE_CLOSE_SOURCE)) {
00375 
00376             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00377         }
00378 
00379         <span class="keywordflow">if</span> (Options &amp; DUPLICATE_CLOSE_SOURCE) {
00380 
00381             <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>( &amp;SourceProcess-&gt;Pcb );
00382 
00383             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( SourceHandle );
00384 
00385             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00386         }
00387 
00388         <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a>( &amp;<a class="code" href="../../d9/d0/obhandle_8c.html#a1">ObpInitKillMutant</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00389 
00390         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00391 
00392         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SourceObject );
00393         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SourceProcess );
00394 
00395         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00396     }
00397 
00398     SourceAccess = HandleInformation.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o1">GrantedAccess</a>;
00399 
00400     <span class="comment">//</span>
00401     <span class="comment">//  At this point the caller did specify for a target process</span>
00402     <span class="comment">//  So from the target process handle get a pointer to the</span>
00403     <span class="comment">//  target process object.</span>
00404     <span class="comment">//</span>
00405 
00406     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( TargetProcessHandle,
00407                                         PROCESS_DUP_HANDLE,
00408                                         <a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>,
00409                                         PreviousMode,
00410                                         (PVOID *)&amp;TargetProcess,
00411                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00412 
00413     <span class="comment">//</span>
00414     <span class="comment">//  If we cannot get the traget process object then close the</span>
00415     <span class="comment">//  source down if requsted, cleanup and return to our caller</span>
00416     <span class="comment">//</span>
00417 
00418     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00419 
00420         <span class="keywordflow">if</span> (Options &amp; DUPLICATE_CLOSE_SOURCE) {
00421 
00422             <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>( &amp;SourceProcess-&gt;Pcb );
00423 
00424             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( SourceHandle );
00425 
00426             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00427         }
00428 
00429         <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a>( &amp;<a class="code" href="../../d9/d0/obhandle_8c.html#a1">ObpInitKillMutant</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00430 
00431         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00432 
00433         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SourceObject );
00434         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SourceProcess );
00435 
00436         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00437     }
00438 
00439     <span class="comment">//</span>
00440     <span class="comment">//  Make sure the target process has not exited</span>
00441     <span class="comment">//</span>
00442 
00443     <span class="keywordflow">if</span> ( TargetProcess-&gt;ObjectTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00444 
00445         <span class="keywordflow">if</span> (Options &amp; DUPLICATE_CLOSE_SOURCE) {
00446 
00447             <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>( &amp;SourceProcess-&gt;Pcb );
00448 
00449             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( SourceHandle );
00450 
00451             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00452         }
00453 
00454         <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a>( &amp;<a class="code" href="../../d9/d0/obhandle_8c.html#a1">ObpInitKillMutant</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00455 
00456         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00457 
00458         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SourceObject );
00459         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SourceProcess );
00460         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( TargetProcess );
00461 
00462         <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
00463     }
00464 
00465     <span class="comment">//</span>
00466     <span class="comment">//  If the specified target process is not the current process, attach</span>
00467     <span class="comment">//  to the specified target process.</span>
00468     <span class="comment">//</span>
00469 
00470     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != TargetProcess) {
00471 
00472         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>( &amp;TargetProcess-&gt;Pcb );
00473 
00474         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00475     }
00476 
00477     <span class="comment">//</span>
00478     <span class="comment">//  Construct the proper desired access and attributes for the new handle</span>
00479     <span class="comment">//</span>
00480 
00481     <span class="keywordflow">if</span> (Options &amp; DUPLICATE_SAME_ACCESS) {
00482 
00483         DesiredAccess = SourceAccess;
00484     }
00485 
00486     <span class="keywordflow">if</span> (Options &amp; DUPLICATE_SAME_ATTRIBUTES) {
00487 
00488         HandleAttributes = HandleInformation.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o0">HandleAttributes</a>;
00489 
00490     } <span class="keywordflow">else</span> {
00491 
00492         <span class="comment">//</span>
00493         <span class="comment">//  Always propogate auditing information.</span>
00494         <span class="comment">//</span>
00495 
00496         HandleAttributes |= HandleInformation.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o0">HandleAttributes</a> &amp; <a class="code" href="../../d7/d7/ntapi_8c.html#a2">OBJ_AUDIT_OBJECT_CLOSE</a>;
00497     }
00498 
00499     <span class="comment">//</span>
00500     <span class="comment">//  Get the object header for the source object</span>
00501     <span class="comment">//</span>
00502 
00503     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( SourceObject );
00504     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
00505 
00506     ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a> = ObjectHeader;
00507     ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o1">ObAttributes</a> |= (HandleAttributes &amp; <a class="code" href="../../d5/d1/obp_8h.html#a17">OBJ_HANDLE_ATTRIBUTES</a>);
00508 
00509     <span class="comment">//</span>
00510     <span class="comment">//  If any of the generic access bits are specified then map those to more</span>
00511     <span class="comment">//  specific access bits</span>
00512     <span class="comment">//</span>
00513 
00514     <span class="keywordflow">if</span> ((DesiredAccess &amp; <a class="code" href="../../d9/d0/obhandle_8c.html#a0">GENERIC_ACCESS</a>) != 0) {
00515 
00516         <a class="code" href="../../d8/d6/sertl_8c.html#a70">RtlMapGenericMask</a>( &amp;DesiredAccess,
00517                            &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> );
00518     }
00519 
00520     <span class="comment">//</span>
00521     <span class="comment">//  Make sure to preserve ACCESS_SYSTEM_SECURITY, which most likely is not</span>
00522     <span class="comment">//  found in the ValidAccessMask</span>
00523     <span class="comment">//</span>
00524 
00525     TargetAccess = DesiredAccess &amp;
00526                    (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o5">ValidAccessMask</a> | ACCESS_SYSTEM_SECURITY);
00527 
00528     <span class="comment">//</span>
00529     <span class="comment">//  If the access requested for the target is a superset of the</span>
00530     <span class="comment">//  access allowed in the source, perform full AVR.  If it is a</span>
00531     <span class="comment">//  subset or equal, do not perform any access validation.</span>
00532     <span class="comment">//</span>
00533     <span class="comment">//  Do not allow superset access if object type has a private security</span>
00534     <span class="comment">//  method, as there is no means to call them in this case to do the</span>
00535     <span class="comment">//  access check.</span>
00536     <span class="comment">//</span>
00537     <span class="comment">//  If the AccessState is not passed to ObpIncrementHandleCount</span>
00538     <span class="comment">//  there will be no AVR.</span>
00539     <span class="comment">//</span>
00540 
00541     <span class="keywordflow">if</span> (TargetAccess &amp; ~SourceAccess) {
00542 
00543         <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o17">SecurityProcedure</a> == <a class="code" href="../../d0/d5/se_8h.html#a115">SeDefaultObjectMethod</a>) {
00544 
00545             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/seastate_8c.html#a2">SeCreateAccessState</a>( &amp;AccessState,
00546                                           &amp;AuxData,
00547                                           TargetAccess,       <span class="comment">// DesiredAccess</span>
00548                                           &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> );
00549 
00550             PassedAccessState = &amp;AccessState;
00551 
00552         } <span class="keywordflow">else</span> {
00553 
00554             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
00555         }
00556 
00557     } <span class="keywordflow">else</span> {
00558 
00559         <span class="comment">//</span>
00560         <span class="comment">//  Do not perform AVR</span>
00561         <span class="comment">//</span>
00562 
00563         PassedAccessState = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00564 
00565         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00566     }
00567 
00568     <span class="comment">//</span>
00569     <span class="comment">//  Increment the new handle count and get a pointer to</span>
00570     <span class="comment">//  the target processes object table</span>
00571     <span class="comment">//</span>
00572 
00573     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00574 
00575         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a77">ObpIncrementHandleCount</a>( <a class="code" href="../../d4/d0/ob_8h.html#a100a60">ObDuplicateHandle</a>,
00576                                           <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(), <span class="comment">// this is already the target process</span>
00577                                           SourceObject,
00578                                           ObjectType,
00579                                           PassedAccessState,
00580                                           PreviousMode,
00581                                           HandleAttributes );
00582 
00583         ObjectTable = <a class="code" href="../../d5/d1/obp_8h.html#a12">ObpGetObjectTable</a>();
00584 
00585         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ObjectTable);
00586     }
00587 
00588     <span class="keywordflow">if</span> (Attached) {
00589 
00590         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00591 
00592         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00593     }
00594 
00595     <span class="keywordflow">if</span> (Options &amp; DUPLICATE_CLOSE_SOURCE) {
00596 
00597         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>( &amp;SourceProcess-&gt;Pcb );
00598 
00599         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( SourceHandle );
00600 
00601         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00602     }
00603 
00604     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00605 
00606         <span class="keywordflow">if</span> (PassedAccessState != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00607 
00608             <a class="code" href="../../d2/d5/seastate_8c.html#a3">SeDeleteAccessState</a>( PassedAccessState );
00609         }
00610 
00611         <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a>( &amp;<a class="code" href="../../d9/d0/obhandle_8c.html#a1">ObpInitKillMutant</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00612 
00613         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00614 
00615         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SourceObject );
00616         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SourceProcess );
00617         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( TargetProcess );
00618 
00619         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00620     }
00621 
00622     <span class="keywordflow">if</span> ((PassedAccessState != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (PassedAccessState-&gt;<a class="code" href="../../d2/d5/struct__ACCESS__STATE.html#o3">GenerateOnClose</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00623 
00624         <span class="comment">//</span>
00625         <span class="comment">//  If we performed AVR opening the handle, then mark the handle as needing</span>
00626         <span class="comment">//  auditing when it's closed.</span>
00627         <span class="comment">//</span>
00628 
00629         ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o1">ObAttributes</a> |= <a class="code" href="../../d7/d7/ntapi_8c.html#a2">OBJ_AUDIT_OBJECT_CLOSE</a>;
00630     }
00631 
00632 <span class="preprocessor">#if i386 &amp;&amp; !FPO</span>
00633 <span class="preprocessor"></span>
00634     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_KERNEL_STACK_TRACE_DB) {
00635 
00636         ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o3">GrantedAccessIndex</a> = ObpComputeGrantedAccessIndex( TargetAccess );
00637         ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o4">CreatorBackTraceIndex</a> = RtlLogStackBackTrace();
00638 
00639     } <span class="keywordflow">else</span> {
00640 
00641         ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a> = TargetAccess;
00642     }
00643 
00644 <span class="preprocessor">#else</span>
00645 <span class="preprocessor"></span>
00646     ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a> = TargetAccess;
00647 
00648 <span class="preprocessor">#endif // i386 &amp;&amp; !FPO</span>
00649 <span class="preprocessor"></span>
00650     <span class="comment">//</span>
00651     <span class="comment">//  Now that we've constructed a new object table entry for the duplicated handle</span>
00652     <span class="comment">//  we need to add it to the object table of the target process</span>
00653 
00654 
00655     NewHandle = <a class="code" href="../../d5/d8/ex_8h.html#a296">ExCreateHandle</a>( ObjectTable, &amp;ObjectTableEntry );
00656 
00657     <span class="keywordflow">if</span> (NewHandle) {
00658 
00659         <span class="comment">//</span>
00660         <span class="comment">//  We have a new handle to audit the creation of the new handle if</span>
00661         <span class="comment">//  AVR was done.  And set the optional output handle variable.  Note</span>
00662         <span class="comment">//  that if we reach here the status variable is already a success</span>
00663         <span class="comment">//</span>
00664 
00665         <span class="keywordflow">if</span> (PassedAccessState != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00666 
00667             <a class="code" href="../../d3/d5/seaudit_8c.html#a28">SeAuditHandleCreation</a>( PassedAccessState, NewHandle );
00668         }
00669 
00670         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/se_8h.html#a106">SeDetailedAuditing</a> &amp;&amp; (ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o1">ObAttributes</a> &amp; <a class="code" href="../../d7/d7/ntapi_8c.html#a2">OBJ_AUDIT_OBJECT_CLOSE</a>)) {
00671 
00672             <a class="code" href="../../d7/d6/sepaudit_8c.html#a20">SeAuditHandleDuplication</a>( SourceHandle,
00673                                       NewHandle,
00674                                       SourceProcess,
00675                                       TargetProcess );
00676         }
00677 
00678         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( TargetHandle )) {
00679 
00680             <span class="keywordflow">try</span> {
00681 
00682                 *TargetHandle = NewHandle;
00683 
00684             } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00685 
00686                 <span class="comment">//</span>
00687                 <span class="comment">//  Fall through, since we cannot undo what we have done.</span>
00688                 <span class="comment">//</span>
00689             }
00690         }
00691 
00692     } <span class="keywordflow">else</span> {
00693 
00694         <span class="comment">//</span>
00695         <span class="comment">//  We didn't get a new handle to decrement the handle count dereference</span>
00696         <span class="comment">//  the necessary objects, set the optional output variable and indicate</span>
00697         <span class="comment">//  why we're failing</span>
00698         <span class="comment">//</span>
00699 
00700         <a class="code" href="../../d5/d1/obp_8h.html#a78">ObpDecrementHandleCount</a>( TargetProcess,
00701                                  ObjectHeader,
00702                                  ObjectType,
00703                                  TargetAccess );
00704 
00705         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SourceObject );
00706 
00707         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( TargetHandle )) {
00708 
00709             <span class="keywordflow">try</span> {
00710 
00711                 *TargetHandle = (HANDLE)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00712 
00713             } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00714 
00715                 <span class="comment">//</span>
00716                 <span class="comment">//  Fall through so we can return the correct status.</span>
00717                 <span class="comment">//</span>
00718             }
00719         }
00720 
00721         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00722     }
00723 
00724     <span class="comment">//</span>
00725     <span class="comment">//  Cleanup from our selfs and then return to our caller</span>
00726     <span class="comment">//</span>
00727 
00728     <span class="keywordflow">if</span> (PassedAccessState != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00729 
00730         <a class="code" href="../../d2/d5/seastate_8c.html#a3">SeDeleteAccessState</a>( PassedAccessState );
00731     }
00732 
00733     <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a>( &amp;<a class="code" href="../../d9/d0/obhandle_8c.html#a1">ObpInitKillMutant</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00734 
00735     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00736 
00737     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SourceProcess );
00738     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( TargetProcess );
00739 
00740     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00741 }
00742 
00743 
00744 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00745"></a><a class="code" href="../../d9/d0/obhandle_8c.html#a5">00745</a> <a class="code" href="../../d9/d0/obhandle_8c.html#a5">ObGetHandleInformation</a> (
00746     OUT PSYSTEM_HANDLE_INFORMATION HandleInformation,
00747     IN ULONG Length,
00748     OUT PULONG ReturnLength OPTIONAL
00749     )
00750 
00751 <span class="comment">/*++</span>
00752 <span class="comment"></span>
00753 <span class="comment">Routine Description:</span>
00754 <span class="comment"></span>
00755 <span class="comment">    This routine returns information about the specified handle.</span>
00756 <span class="comment"></span>
00757 <span class="comment">Arguments:</span>
00758 <span class="comment"></span>
00759 <span class="comment">    HandleInformation - Supplies an array of handle information</span>
00760 <span class="comment">        structures to fill in</span>
00761 <span class="comment"></span>
00762 <span class="comment">    Length - Supplies the length the handle information array in bytes</span>
00763 <span class="comment"></span>
00764 <span class="comment">    ReturnLength - Receives the number of bytes used by this call</span>
00765 <span class="comment"></span>
00766 <span class="comment">Return Value:</span>
00767 <span class="comment"></span>
00768 <span class="comment">    An appropriate status value</span>
00769 <span class="comment"></span>
00770 <span class="comment">--*/</span>
00771 
00772 {
00773     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00774     ULONG RequiredLength;
00775 
00776     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00777 
00778     RequiredLength = FIELD_OFFSET( SYSTEM_HANDLE_INFORMATION, Handles );
00779 
00780     <span class="keywordflow">if</span> (Length &lt; RequiredLength) {
00781 
00782         <span class="keywordflow">return</span>( STATUS_INFO_LENGTH_MISMATCH );
00783     }
00784 
00785     HandleInformation-&gt;NumberOfHandles = 0;
00786 
00787     <span class="comment">//</span>
00788     <span class="comment">//  For every handle in every handle table we'll be calling</span>
00789     <span class="comment">//  our callback routine</span>
00790     <span class="comment">//</span>
00791 
00792     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d8/ex_8h.html#a295">ExSnapShotHandleTables</a>( <a class="code" href="../../d9/d0/obhandle_8c.html#a3">ObpCaptureHandleInformation</a>,
00793                                      HandleInformation,
00794                                      Length,
00795                                      &amp;RequiredLength );
00796 
00797     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
00798 
00799         *ReturnLength = RequiredLength;
00800     }
00801 
00802     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00803 }
00804 
00805 
00806 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00807"></a><a class="code" href="../../d9/d0/obhandle_8c.html#a6">00807</a> <a class="code" href="../../d9/d0/obhandle_8c.html#a6">ObpCaptureHandleInformation</a> (
00808     IN OUT PSYSTEM_HANDLE_TABLE_ENTRY_INFO *HandleEntryInfo,
00809     IN HANDLE UniqueProcessId,
00810     IN <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> ObjectTableEntry,
00811     IN HANDLE HandleIndex,
00812     IN ULONG Length,
00813     IN OUT PULONG RequiredLength
00814     )
00815 
00816 <span class="comment">/*++</span>
00817 <span class="comment"></span>
00818 <span class="comment">Routine Description:</span>
00819 <span class="comment"></span>
00820 <span class="comment">    This is the callback routine of ObGetHandleInformation</span>
00821 <span class="comment"></span>
00822 <span class="comment">Arguments:</span>
00823 <span class="comment"></span>
00824 <span class="comment">    HandleEntryInfo - Supplies a pointer to the output buffer to receive</span>
00825 <span class="comment">        the handle information</span>
00826 <span class="comment"></span>
00827 <span class="comment">    UniqueProcessId - Supplies the process id of the caller</span>
00828 <span class="comment"></span>
00829 <span class="comment">    ObjectTableEntry - Supplies the handle table entry that is being</span>
00830 <span class="comment">        captured</span>
00831 <span class="comment"></span>
00832 <span class="comment">    HandleIndex - Supplies the index for the preceding handle table entry</span>
00833 <span class="comment"></span>
00834 <span class="comment">    Length - Specifies the length, in bytes, of the original user buffer</span>
00835 <span class="comment"></span>
00836 <span class="comment">    RequiredLength - Specifies the length, in bytes, that has already been</span>
00837 <span class="comment">        used in the buffer to store information.  On return this receives</span>
00838 <span class="comment">        the updated number of bytes being used.</span>
00839 <span class="comment"></span>
00840 <span class="comment">        Note that the HandleEntryInfo does not necessarily point to the</span>
00841 <span class="comment">        start of the original user buffer.  It will have been offset by</span>
00842 <span class="comment">        the feed-in RequiredLength value.</span>
00843 <span class="comment"></span>
00844 <span class="comment">Return Value:</span>
00845 <span class="comment"></span>
00846 <span class="comment">    An appropriate status value</span>
00847 <span class="comment"></span>
00848 <span class="comment">--*/</span>
00849 
00850 {
00851     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00852     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00853 
00854     <span class="comment">//</span>
00855     <span class="comment">//  Figure out who much size we really need to contain this extra record</span>
00856     <span class="comment">//  and then check that it fits.</span>
00857     <span class="comment">//</span>
00858 
00859     *RequiredLength += <span class="keyword">sizeof</span>( SYSTEM_HANDLE_TABLE_ENTRY_INFO );
00860 
00861     <span class="keywordflow">if</span> (Length &lt; *RequiredLength) {
00862 
00863         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INFO_LENGTH_MISMATCH;
00864 
00865     } <span class="keywordflow">else</span> {
00866 
00867         <span class="comment">//</span>
00868         <span class="comment">//  Get the object header from the table entry and then copy over the information</span>
00869         <span class="comment">//</span>
00870 
00871         ObjectHeader = (<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>)(((ULONG_PTR)(ObjectTableEntry-&gt;Object)) &amp; ~<a class="code" href="../../d5/d1/obp_8h.html#a17">OBJ_HANDLE_ATTRIBUTES</a>);
00872 
00873         (*HandleEntryInfo)-&gt;UniqueProcessId       = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((ULONG_PTR)UniqueProcessId);
00874         (*HandleEntryInfo)-&gt;HandleAttributes      = (UCHAR)(ObjectTableEntry-&gt;ObAttributes &amp; <a class="code" href="../../d5/d1/obp_8h.html#a17">OBJ_HANDLE_ATTRIBUTES</a>);
00875         (*HandleEntryInfo)-&gt;ObjectTypeIndex       = (UCHAR)(ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o4">Index</a>);
00876         (*HandleEntryInfo)-&gt;HandleValue           = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((ULONG_PTR)(HandleIndex));
00877         (*HandleEntryInfo)-&gt;Object                = &amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o11">Body</a>;
00878         (*HandleEntryInfo)-&gt;CreatorBackTraceIndex = 0;
00879 
00880 <span class="preprocessor">#if i386 &amp;&amp; !FPO</span>
00881 <span class="preprocessor"></span>
00882         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_KERNEL_STACK_TRACE_DB) {
00883 
00884             (*HandleEntryInfo)-&gt;CreatorBackTraceIndex = ObjectTableEntry-&gt;CreatorBackTraceIndex;
00885             (*HandleEntryInfo)-&gt;GrantedAccess = ObpTranslateGrantedAccessIndex( ObjectTableEntry-&gt;GrantedAccessIndex );
00886 
00887         } <span class="keywordflow">else</span> {
00888 
00889             (*HandleEntryInfo)-&gt;GrantedAccess = ObjectTableEntry-&gt;GrantedAccess;
00890         }
00891 
00892 <span class="preprocessor">#else</span>
00893 <span class="preprocessor"></span>
00894         (*HandleEntryInfo)-&gt;GrantedAccess = ObjectTableEntry-&gt;GrantedAccess;
00895 
00896 <span class="preprocessor">#endif // i386 &amp;&amp; !FPO</span>
00897 <span class="preprocessor"></span>
00898         (*HandleEntryInfo)++;
00899 
00900         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00901     }
00902 
00903     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00904 }
00905 
00906 
00907 <a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html">POBJECT_HANDLE_COUNT_ENTRY</a>
<a name="l00908"></a><a class="code" href="../../d5/d1/obp_8h.html#a76">00908</a> <a class="code" href="../../d5/d1/obp_8h.html#a76">ObpInsertHandleCount</a> (
00909     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader
00910     )
00911 
00912 <span class="comment">/*++</span>
00913 <span class="comment"></span>
00914 <span class="comment">Routine Description:</span>
00915 <span class="comment"></span>
00916 <span class="comment">    This function will increase the size of the handle database</span>
00917 <span class="comment">    stored in the handle information of an object header.  If</span>
00918 <span class="comment">    necessary it will allocate new and free old handle databases.</span>
00919 <span class="comment"></span>
00920 <span class="comment">    This routine should not be called if there is already free</span>
00921 <span class="comment">    space in the handle table.</span>
00922 <span class="comment"></span>
00923 <span class="comment">Arguments:</span>
00924 <span class="comment"></span>
00925 <span class="comment">    ObjectHeader - The object whose handle count is being incremented</span>
00926 <span class="comment"></span>
00927 <span class="comment">Return Value:</span>
00928 <span class="comment"></span>
00929 <span class="comment">    The pointer to the next free handle count entry within the</span>
00930 <span class="comment">    handle database.</span>
00931 <span class="comment"></span>
00932 <span class="comment">--*/</span>
00933 
00934 {
00935     <a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html">POBJECT_HEADER_HANDLE_INFO</a> HandleInfo;
00936     <a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html">POBJECT_HANDLE_COUNT_DATABASE</a> OldHandleCountDataBase;
00937     <a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html">POBJECT_HANDLE_COUNT_DATABASE</a> NewHandleCountDataBase;
00938     <a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html">POBJECT_HANDLE_COUNT_ENTRY</a> FreeHandleCountEntry;
00939     ULONG CountEntries;
00940     ULONG OldSize;
00941     ULONG NewSize;
00942     <a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html">OBJECT_HANDLE_COUNT_DATABASE</a> SingleEntryDataBase;
00943 
00944     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00945 
00946     <span class="comment">//</span>
00947     <span class="comment">//  Check if the object has any handle information</span>
00948     <span class="comment">//</span>
00949 
00950     HandleInfo = <a class="code" href="../../d4/d0/ob_8h.html#a11">OBJECT_HEADER_TO_HANDLE_INFO</a>(ObjectHeader);
00951 
00952     <span class="keywordflow">if</span> (HandleInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00953 
00954         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00955     }
00956 
00957     <span class="comment">//</span>
00958     <span class="comment">//  The object does have some handle information.  If it has</span>
00959     <span class="comment">//  a single handle entry then we'll construct a local dummy</span>
00960     <span class="comment">//  handle count database and come up with a new data base for</span>
00961     <span class="comment">//  storing two entries.</span>
00962     <span class="comment">//</span>
00963 
00964     <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a7">OB_FLAG_SINGLE_HANDLE_ENTRY</a>) {
00965 
00966         SingleEntryDataBase.<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html#o0">CountEntries</a> = 1;
00967         SingleEntryDataBase.<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html#o1">HandleCountEntries</a>[0] = HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o1">SingleEntry</a>;
00968 
00969         OldHandleCountDataBase = &amp;SingleEntryDataBase;
00970 
00971         OldSize = <span class="keyword">sizeof</span>( SingleEntryDataBase );
00972 
00973         CountEntries = 2;
00974 
00975         NewSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html">OBJECT_HANDLE_COUNT_DATABASE</a>) +
00976                ((CountEntries - 1) * <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html">OBJECT_HANDLE_COUNT_ENTRY</a> ));
00977 
00978     } <span class="keywordflow">else</span> {
00979 
00980         <span class="comment">//</span>
00981         <span class="comment">//  The object already has multiple handles so we reference the</span>
00982         <span class="comment">//  current handle database, and compute a new size bumped by four</span>
00983         <span class="comment">//</span>
00984 
00985         OldHandleCountDataBase = HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o0">HandleCountDataBase</a>;
00986 
00987         CountEntries = OldHandleCountDataBase-&gt;<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html#o0">CountEntries</a>;
00988 
00989         OldSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html">OBJECT_HANDLE_COUNT_DATABASE</a>) +
00990                ((CountEntries - 1) * <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html">OBJECT_HANDLE_COUNT_ENTRY</a>));
00991 
00992         CountEntries += 4;
00993 
00994         NewSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html">OBJECT_HANDLE_COUNT_DATABASE</a>) +
00995                ((CountEntries - 1) * <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html">OBJECT_HANDLE_COUNT_ENTRY</a>));
00996     }
00997 
00998     <span class="comment">//</span>
00999     <span class="comment">//  Now allocate pool for the new handle database.</span>
01000     <span class="comment">//</span>
01001 
01002     NewHandleCountDataBase = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, NewSize,'dHbO');
01003 
01004     <span class="keywordflow">if</span> (NewHandleCountDataBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01005 
01006         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01007     }
01008 
01009     <span class="comment">//</span>
01010     <span class="comment">//  Copy over the old database.  Note that this might just copy our</span>
01011     <span class="comment">//  local dummy entry for the single entry case</span>
01012     <span class="comment">//</span>
01013 
01014     RtlMoveMemory(NewHandleCountDataBase, OldHandleCountDataBase, OldSize);
01015 
01016     <span class="comment">//</span>
01017     <span class="comment">//  If the previous mode was a single entry then remove that</span>
01018     <span class="comment">//  indication otherwise free up with previous handle database</span>
01019     <span class="comment">//</span>
01020 
01021     <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a7">OB_FLAG_SINGLE_HANDLE_ENTRY</a>) {
01022 
01023         ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp;= ~<a class="code" href="../../d4/d0/ob_8h.html#a7">OB_FLAG_SINGLE_HANDLE_ENTRY</a>;
01024 
01025     } <span class="keywordflow">else</span> {
01026 
01027         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( OldHandleCountDataBase );
01028     }
01029 
01030     <span class="comment">//</span>
01031     <span class="comment">//  Find the end of the new database that is used and zero out</span>
01032     <span class="comment">//  the memory</span>
01033     <span class="comment">//</span>
01034 
01035     FreeHandleCountEntry =
01036         (<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html">POBJECT_HANDLE_COUNT_ENTRY</a>)((PCHAR)NewHandleCountDataBase + OldSize);
01037 
01038     RtlZeroMemory(FreeHandleCountEntry, NewSize - OldSize);
01039 
01040     <span class="comment">//</span>
01041     <span class="comment">//  Set the new database to the proper entry count and put it</span>
01042     <span class="comment">//  all in the object</span>
01043     <span class="comment">//</span>
01044 
01045     NewHandleCountDataBase-&gt;<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html#o0">CountEntries</a> = CountEntries;
01046 
01047     HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o0">HandleCountDataBase</a> = NewHandleCountDataBase;
01048 
01049     <span class="comment">//</span>
01050     <span class="comment">//  And return to our caller</span>
01051     <span class="comment">//</span>
01052 
01053     <span class="keywordflow">return</span> FreeHandleCountEntry;
01054 }
01055 
01056 
01057 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01058"></a><a class="code" href="../../d9/d0/obhandle_8c.html#a2">01058</a> <a class="code" href="../../d9/d0/obhandle_8c.html#a2">ObpIncrementHandleDataBase</a> (
01059     IN <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader,
01060     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
01061     OUT PULONG NewProcessHandleCount
01062     )
01063 
01064 <span class="comment">/*++</span>
01065 <span class="comment"></span>
01066 <span class="comment">Routine Description:</span>
01067 <span class="comment"></span>
01068 <span class="comment">    This function increments the handle count database associated with the</span>
01069 <span class="comment">    specified object for a specified process.</span>
01070 <span class="comment"></span>
01071 <span class="comment">Arguments:</span>
01072 <span class="comment"></span>
01073 <span class="comment">    ObjectHeader - Supplies a pointer to the object.</span>
01074 <span class="comment"></span>
01075 <span class="comment">    Process - Supplies a pointer to the process whose handle count is to be</span>
01076 <span class="comment">        updated.</span>
01077 <span class="comment"></span>
01078 <span class="comment">    NewProcessHandleCount - Supplies a pointer to a variable that receives</span>
01079 <span class="comment">        the new handle count for the process.</span>
01080 <span class="comment"></span>
01081 <span class="comment">Return Value:</span>
01082 <span class="comment"></span>
01083 <span class="comment">    An appropriate status value</span>
01084 <span class="comment"></span>
01085 <span class="comment">--*/</span>
01086 
01087 {
01088     <a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html">POBJECT_HEADER_HANDLE_INFO</a> HandleInfo;
01089     <a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html">POBJECT_HANDLE_COUNT_DATABASE</a> HandleCountDataBase;
01090     <a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html">POBJECT_HANDLE_COUNT_ENTRY</a> HandleCountEntry;
01091     <a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html">POBJECT_HANDLE_COUNT_ENTRY</a> FreeHandleCountEntry;
01092     ULONG CountEntries;
01093     ULONG ProcessHandleCount;
01094 
01095     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01096 
01097     <span class="comment">//</span>
01098     <span class="comment">//  Translate the object header to the handle information.</span>
01099     <span class="comment">//</span>
01100 
01101     HandleInfo = <a class="code" href="../../d4/d0/ob_8h.html#a11">OBJECT_HEADER_TO_HANDLE_INFO</a>(ObjectHeader);
01102 
01103     <span class="comment">//</span>
01104     <span class="comment">//  Check if the object has space for only a single handle</span>
01105     <span class="comment">//</span>
01106 
01107     <span class="keywordflow">if</span> (ObjectHeader-&gt;Flags &amp; <a class="code" href="../../d4/d0/ob_8h.html#a7">OB_FLAG_SINGLE_HANDLE_ENTRY</a>) {
01108 
01109         <span class="comment">//</span>
01110         <span class="comment">//  If the single handle isn't in use then set the entry</span>
01111         <span class="comment">//  and tell the caller there is only one handle</span>
01112         <span class="comment">//</span>
01113 
01114         <span class="keywordflow">if</span> (HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o1">SingleEntry</a>.<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a> == 0) {
01115 
01116             *NewProcessHandleCount = 1;
01117             HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o1">SingleEntry</a>.<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a> = 1;
01118             HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o1">SingleEntry</a>.<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o0">Process</a> = Process;
01119 
01120             <span class="keywordflow">return</span> STATUS_SUCCESS;
01121 
01122         <span class="comment">//</span>
01123         <span class="comment">//  If the single entry is for the same process as specified</span>
01124         <span class="comment">//  then increment the count and we're done</span>
01125         <span class="comment">//</span>
01126 
01127         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o1">SingleEntry</a>.<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o0">Process</a> == Process) {
01128 
01129             *NewProcessHandleCount = ++HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o1">SingleEntry</a>.<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a>;
01130 
01131             <span class="keywordflow">return</span> STATUS_SUCCESS;
01132 
01133         <span class="comment">//</span>
01134         <span class="comment">//  Finally we have a object with a single handle entry already</span>
01135         <span class="comment">//  in use, so we need to grow the handle database before</span>
01136         <span class="comment">//  we can set this new value</span>
01137         <span class="comment">//</span>
01138 
01139         } <span class="keywordflow">else</span> {
01140 
01141             FreeHandleCountEntry = <a class="code" href="../../d5/d1/obp_8h.html#a76">ObpInsertHandleCount</a>( ObjectHeader );
01142 
01143             <span class="keywordflow">if</span> (FreeHandleCountEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01144 
01145                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01146             }
01147 
01148             FreeHandleCountEntry-&gt;<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o0">Process</a> = Process;
01149             FreeHandleCountEntry-&gt;<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a> = 1;
01150             *NewProcessHandleCount = 1;
01151 
01152             <span class="keywordflow">return</span> STATUS_SUCCESS;
01153         }
01154     }
01155 
01156     <span class="comment">//</span>
01157     <span class="comment">//  The object does not contain a single entry, therefore we're</span>
01158     <span class="comment">//  assuming it already has a handle count database</span>
01159     <span class="comment">//</span>
01160 
01161     <span class="comment">//</span>
01162     <span class="comment">//  **** HandleInfo should first be checked for null</span>
01163     <span class="comment">//</span>
01164 
01165     HandleCountDataBase = HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o0">HandleCountDataBase</a>;
01166 
01167     FreeHandleCountEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01168 
01169     <span class="comment">//</span>
01170     <span class="comment">//  **** can we with success if the database is null</span>
01171     <span class="comment">//</span>
01172 
01173     <span class="keywordflow">if</span> (HandleCountDataBase != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01174 
01175         <span class="comment">//</span>
01176         <span class="comment">//  Get the number of entries and a pointer to the first one</span>
01177         <span class="comment">//  in the handle database</span>
01178         <span class="comment">//</span>
01179 
01180         CountEntries = HandleCountDataBase-&gt;<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html#o0">CountEntries</a>;
01181         HandleCountEntry = &amp;HandleCountDataBase-&gt;<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html#o1">HandleCountEntries</a>[ 0 ];
01182 
01183         <span class="comment">//</span>
01184         <span class="comment">//  For each entry in the handle database check for a process</span>
01185         <span class="comment">//  match and if so then increment the handle count and return</span>
01186         <span class="comment">//  to our caller.  Otherwise if the entry is free then remember</span>
01187         <span class="comment">//  it so we can store to it later</span>
01188         <span class="comment">//</span>
01189 
01190         <span class="keywordflow">while</span> (CountEntries) {
01191 
01192             <span class="keywordflow">if</span> (HandleCountEntry-&gt;<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o0">Process</a> == Process) {
01193 
01194                 *NewProcessHandleCount = ++HandleCountEntry-&gt;<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a>;
01195 
01196                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01197 
01198             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (HandleCountEntry-&gt;<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a> == 0) {
01199 
01200                 FreeHandleCountEntry = HandleCountEntry;
01201             }
01202 
01203             ++HandleCountEntry;
01204             --CountEntries;
01205         }
01206 
01207         <span class="comment">//</span>
01208         <span class="comment">//  If we did not find a free handle entry then we have to grow the</span>
01209         <span class="comment">//  handle database before we can set this new value</span>
01210         <span class="comment">//</span>
01211 
01212         <span class="keywordflow">if</span> (FreeHandleCountEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01213 
01214             FreeHandleCountEntry = <a class="code" href="../../d5/d1/obp_8h.html#a76">ObpInsertHandleCount</a>( ObjectHeader );
01215 
01216             <span class="keywordflow">if</span> (FreeHandleCountEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01217 
01218                 <span class="keywordflow">return</span>(STATUS_INSUFFICIENT_RESOURCES);
01219             }
01220         }
01221 
01222         FreeHandleCountEntry-&gt;<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o0">Process</a> = Process;
01223         FreeHandleCountEntry-&gt;<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a> = 1;
01224         *NewProcessHandleCount = 1;
01225     }
01226 
01227     <span class="keywordflow">return</span> STATUS_SUCCESS;
01228 }
01229 
01230 
01231 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01232"></a><a class="code" href="../../d5/d1/obp_8h.html#a77">01232</a> <a class="code" href="../../d5/d1/obp_8h.html#a77">ObpIncrementHandleCount</a> (
01233     OB_OPEN_REASON OpenReason,
01234     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
01235     PVOID Object,
01236     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType,
01237     <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState OPTIONAL,
01238     KPROCESSOR_MODE AccessMode,
01239     ULONG Attributes
01240     )
01241 
01242 <span class="comment">/*++</span>
01243 <span class="comment"></span>
01244 <span class="comment">Routine Description:</span>
01245 <span class="comment"></span>
01246 <span class="comment">    Increments the count of number of handles to the given object.</span>
01247 <span class="comment"></span>
01248 <span class="comment">    If the object is being opened or created, access validation and</span>
01249 <span class="comment">    auditing will be performed as appropriate.</span>
01250 <span class="comment"></span>
01251 <span class="comment">Arguments:</span>
01252 <span class="comment"></span>
01253 <span class="comment">    OpenReason - Supplies the reason the handle count is being incremented.</span>
01254 <span class="comment"></span>
01255 <span class="comment">    Process - Pointer to the process in which the new handle will reside.</span>
01256 <span class="comment"></span>
01257 <span class="comment">    Object - Supplies a pointer to the body of the object.</span>
01258 <span class="comment"></span>
01259 <span class="comment">    ObjectType - Supplies the type of the object.</span>
01260 <span class="comment"></span>
01261 <span class="comment">    AccessState - Optional parameter supplying the current accumulated</span>
01262 <span class="comment">        security information describing the attempt to access the object.</span>
01263 <span class="comment"></span>
01264 <span class="comment">    AccessMode - Supplies the mode of the requestor.</span>
01265 <span class="comment"></span>
01266 <span class="comment">    Attributes - Desired attributes for the handle</span>
01267 <span class="comment"></span>
01268 <span class="comment">Return Value:</span>
01269 <span class="comment"></span>
01270 <span class="comment">    An appropriate status value</span>
01271 <span class="comment"></span>
01272 <span class="comment">--*/</span>
01273 
01274 {
01275     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01276     ULONG ProcessHandleCount;
01277     BOOLEAN ExclusiveHandle;
01278     <a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html">POBJECT_HEADER_CREATOR_INFO</a> CreatorInfo;
01279     <a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html">POBJECT_HEADER_QUOTA_INFO</a> QuotaInfo;
01280     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01281     BOOLEAN HasPrivilege = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01282     PRIVILEGE_SET Privileges;
01283     BOOLEAN NewObject;
01284     BOOLEAN HoldObjectTypeMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01285 
01286     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01287 
01288     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>( <span class="stringliteral">"ObpIncrementHandleCount"</span> );
01289 
01290     <span class="comment">//</span>
01291     <span class="comment">//  Get a pointer to the object header</span>
01292     <span class="comment">//</span>
01293 
01294     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
01295 
01296     <span class="comment">//</span>
01297     <span class="comment">//  Charge the user quota for the object</span>
01298     <span class="comment">//</span>
01299 
01300     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a82">ObpChargeQuotaForObject</a>( ObjectHeader, ObjectType, &amp;NewObject );
01301 
01302     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01303 
01304         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01305     }
01306 
01307     <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
01308     HoldObjectTypeMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01309 
01310     <span class="keywordflow">try</span> {
01311 
01312         ExclusiveHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01313 
01314         <span class="comment">//</span>
01315         <span class="comment">//  Check if the caller wants exlusive access and if so then</span>
01316         <span class="comment">//  make sure the attributes and header flags match up correctly</span>
01317         <span class="comment">//</span>
01318 
01319         <span class="keywordflow">if</span> (Attributes &amp; OBJ_EXCLUSIVE) {
01320 
01321             <span class="keywordflow">if</span> ((Attributes &amp; OBJ_INHERIT) ||
01322                 ((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a4">OB_FLAG_EXCLUSIVE_OBJECT</a>) == 0)) {
01323 
01324                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
01325                 leave;
01326             }
01327 
01328             <span class="keywordflow">if</span> (((<a class="code" href="../../d4/d0/ob_8h.html#a9">OBJECT_HEADER_TO_EXCLUSIVE_PROCESS</a>(ObjectHeader) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01329                  (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o1">HandleCount</a> != 0))
01330 
01331                     ||
01332 
01333                 ((<a class="code" href="../../d4/d0/ob_8h.html#a9">OBJECT_HEADER_TO_EXCLUSIVE_PROCESS</a>(ObjectHeader) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01334                  (<a class="code" href="../../d4/d0/ob_8h.html#a9">OBJECT_HEADER_TO_EXCLUSIVE_PROCESS</a>(ObjectHeader) != <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()))) {
01335 
01336                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
01337                 leave;
01338             }
01339 
01340             ExclusiveHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01341 
01342         <span class="comment">//</span>
01343         <span class="comment">//  The user doesn't want exclusive access so now check to make sure</span>
01344         <span class="comment">//  the attriutes and header flags match up correctly</span>
01345         <span class="comment">//</span>
01346 
01347         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a4">OB_FLAG_EXCLUSIVE_OBJECT</a>) &amp;&amp;
01348                    (<a class="code" href="../../d4/d0/ob_8h.html#a9">OBJECT_HEADER_TO_EXCLUSIVE_PROCESS</a>(ObjectHeader) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01349 
01350             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
01351             leave;
01352         }
01353 
01354         <span class="comment">//</span>
01355         <span class="comment">//  If handle count going from zero to one for an existing object that</span>
01356         <span class="comment">//  maintains a handle count database, but does not have an open procedure</span>
01357         <span class="comment">//  just a close procedure, then fail the call as they are trying to</span>
01358         <span class="comment">//  reopen an object by pointer and the close procedure will not know</span>
01359         <span class="comment">//  that the object has been 'recreated'</span>
01360         <span class="comment">//</span>
01361 
01362         <span class="keywordflow">if</span> ((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o1">HandleCount</a> == 0) &amp;&amp;
01363             (!NewObject) &amp;&amp;
01364             (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o7">MaintainHandleCount</a>) &amp;&amp;
01365             (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o13">OpenProcedure</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01366             (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o14">CloseProcedure</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01367 
01368             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
01369             leave;
01370         }
01371 
01372         <span class="keywordflow">if</span> ((OpenReason == <a class="code" href="../../d4/d0/ob_8h.html#a100a59">ObOpenHandle</a>) ||
01373             ((OpenReason == <a class="code" href="../../d4/d0/ob_8h.html#a100a60">ObDuplicateHandle</a>) &amp;&amp; ARGUMENT_PRESENT(AccessState))) {
01374 
01375             <span class="comment">//</span>
01376             <span class="comment">//  Perform Access Validation to see if we can open this</span>
01377             <span class="comment">//  (already existing) object.</span>
01378             <span class="comment">//</span>
01379             
01380             <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d1/obse_8c.html#a3">ObCheckObjectAccess</a>( Object,
01381                                       AccessState,
01382                                       <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01383                                       AccessMode,
01384                                       &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01385 
01386                 leave;
01387             }
01388             
01389         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((OpenReason == <a class="code" href="../../d4/d0/ob_8h.html#a100a58">ObCreateHandle</a>)) {
01390 
01391             <span class="comment">//</span>
01392             <span class="comment">//  We are creating a new instance of this object type.</span>
01393             <span class="comment">//  A total of three audit messages may be generated:</span>
01394             <span class="comment">//</span>
01395             <span class="comment">//  1 - Audit the attempt to create an instance of this</span>
01396             <span class="comment">//      object type.</span>
01397             <span class="comment">//</span>
01398             <span class="comment">//  2 - Audit the successful creation.</span>
01399             <span class="comment">//</span>
01400             <span class="comment">//  3 - Audit the allocation of the handle.</span>
01401             <span class="comment">//</span>
01402 
01403             <span class="comment">//</span>
01404             <span class="comment">//  At this point, the RemainingDesiredAccess field in</span>
01405             <span class="comment">//  the AccessState may still contain either Generic access</span>
01406             <span class="comment">//  types, or MAXIMUM_ALLOWED.  We will map the generics</span>
01407             <span class="comment">//  and substitute GenericAll for MAXIMUM_ALLOWED.</span>
01408             <span class="comment">//</span>
01409 
01410             <span class="keywordflow">if</span> ( AccessState-&gt;RemainingDesiredAccess &amp; MAXIMUM_ALLOWED ) {
01411 
01412                 AccessState-&gt;RemainingDesiredAccess &amp;= ~MAXIMUM_ALLOWED;
01413                 AccessState-&gt;RemainingDesiredAccess |= GENERIC_ALL;
01414             }
01415 
01416             <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d0/obhandle_8c.html#a0">GENERIC_ACCESS</a> &amp; AccessState-&gt;RemainingDesiredAccess) != 0) {
01417 
01418                 <a class="code" href="../../d8/d6/sertl_8c.html#a70">RtlMapGenericMask</a>( &amp;AccessState-&gt;RemainingDesiredAccess,
01419                                    &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> );
01420             }
01421 
01422             <span class="comment">//</span>
01423             <span class="comment">//  Since we are creating the object, we can give any access the caller</span>
01424             <span class="comment">//  wants.  The only exception is ACCESS_SYSTEM_SECURITY, which requires</span>
01425             <span class="comment">//  a privilege.</span>
01426             <span class="comment">//</span>
01427 
01428             <span class="keywordflow">if</span> ( AccessState-&gt;RemainingDesiredAccess &amp; ACCESS_SYSTEM_SECURITY ) {
01429 
01430                 <span class="comment">//</span>
01431                 <span class="comment">//  We could use SeSinglePrivilegeCheck here, but it</span>
01432                 <span class="comment">//  captures the subject context again, and we don't</span>
01433                 <span class="comment">//  want to do that in this path for performance reasons.</span>
01434                 <span class="comment">//</span>
01435 
01436                 Privileges.PrivilegeCount = 1;
01437                 Privileges.Control = PRIVILEGE_SET_ALL_NECESSARY;
01438                 Privileges.Privilege[0].Luid = <a class="code" href="../../d0/d5/se_8h.html#a85">SeSecurityPrivilege</a>;
01439                 Privileges.Privilege[0].Attributes = 0;
01440 
01441                 HasPrivilege = <a class="code" href="../../d8/d4/privileg_8c.html#a1">SePrivilegeCheck</a>( &amp;Privileges,
01442                                                  &amp;AccessState-&gt;SubjectSecurityContext,
01443                                                  KeGetPreviousMode() );
01444 
01445                 <span class="keywordflow">if</span> (!HasPrivilege) {
01446 
01447                     <a class="code" href="../../d3/d5/seaudit_8c.html#a15">SePrivilegedServiceAuditAlarm</a> ( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01448                                                     &amp;AccessState-&gt;SubjectSecurityContext,
01449                                                     &amp;Privileges,
01450                                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01451 
01452                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PRIVILEGE_NOT_HELD;
01453                     leave;
01454                 }
01455 
01456                 AccessState-&gt;RemainingDesiredAccess &amp;= ~ACCESS_SYSTEM_SECURITY;
01457                 AccessState-&gt;PreviouslyGrantedAccess |= ACCESS_SYSTEM_SECURITY;
01458 
01459                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d2/d5/seastate_8c.html#a5">SeAppendPrivileges</a>( AccessState,
01460                                            &amp;Privileges );
01461             }
01462 
01463             <span class="comment">//</span>
01464             <span class="comment">//  Get the objects creator info block and insert it on the</span>
01465             <span class="comment">//  global list of objects for that type</span>
01466             <span class="comment">//</span>
01467 
01468             CreatorInfo = <a class="code" href="../../d4/d0/ob_8h.html#a13">OBJECT_HEADER_TO_CREATOR_INFO</a>( ObjectHeader );
01469 
01470             <span class="keywordflow">if</span> (CreatorInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01471 
01472                 InsertTailList( &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o1">TypeList</a>, &amp;CreatorInfo-&gt;<a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html#o0">TypeList</a> );
01473             }
01474         }
01475 
01476         <span class="keywordflow">if</span> (ExclusiveHandle) {
01477 
01478             <a class="code" href="../../d4/d0/ob_8h.html#a10">OBJECT_HEADER_TO_QUOTA_INFO</a>(ObjectHeader)-&gt;ExclusiveProcess = Process;
01479         }
01480 
01481         <a class="code" href="../../d5/d1/obp_8h.html#a6">ObpIncrHandleCount</a>( ObjectHeader );
01482         ProcessHandleCount = 0;
01483 
01484         <span class="comment">//</span>
01485         <span class="comment">//  If the object type wants us to keep try of the handle counts</span>
01486         <span class="comment">//  then call our routine to do the work</span>
01487         <span class="comment">//</span>
01488 
01489         <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o7">MaintainHandleCount</a>) {
01490 
01491             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a2">ObpIncrementHandleDataBase</a>( ObjectHeader,
01492                                                  Process,
01493                                                  &amp;ProcessHandleCount );
01494 
01495             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01496                 <span class="comment">// BUG BUG, We probably need more backout than this, NeillC</span>
01497                 <a class="code" href="../../d5/d1/obp_8h.html#a7">ObpDecrHandleCount</a>( ObjectHeader );
01498 
01499                 leave;
01500             }
01501         }
01502 
01503         <span class="comment">//</span>
01504         <span class="comment">//  Set our preliminary status now to success because</span>
01505         <span class="comment">//  the call to the open procedure might change this</span>
01506         <span class="comment">//</span>
01507 
01508         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01509 
01510         <span class="comment">//</span>
01511         <span class="comment">//  If the object type has an open procedure</span>
01512         <span class="comment">//  then invoke that procedure</span>
01513         <span class="comment">//</span>
01514 
01515         <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o13">OpenProcedure</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01516 
01517             KIRQL SaveIrql;
01518 
01519             <span class="comment">//</span>
01520             <span class="comment">//  Leave the object type mutex when call the OpenProcedure. If an exception</span>
01521             <span class="comment">//  while OpenProcedure the HoldObjectTypeMutex disable leaving the mutex</span>
01522             <span class="comment">//  on finally block</span>
01523             <span class="comment">//</span>
01524 
01525             <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
01526             HoldObjectTypeMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01527 
01528             <a class="code" href="../../d5/d1/obp_8h.html#a0">ObpBeginTypeSpecificCallOut</a>( SaveIrql );
01529 
01530             <span class="keywordflow">try</span> {
01531 
01532                 (*ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o13">OpenProcedure</a>)( OpenReason,
01533                                                        Process,
01534                                                        Object,
01535                                                        AccessState ?
01536                                                            AccessState-&gt;PreviouslyGrantedAccess :
01537                                                            0,
01538                                                        ProcessHandleCount );
01539 
01540             } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
01541 
01542                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01543             }
01544 
01545             <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"Open"</span>, ObjectType, Object );
01546 
01547             <span class="comment">//</span>
01548             <span class="comment">//  Hold back the object type mutex and set the HoldObjectTypeMutex variable</span>
01549             <span class="comment">//  to allow releasing the mutex while leaving this procedure</span>
01550             <span class="comment">//</span>
01551 
01552             <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
01553             HoldObjectTypeMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01554 
01555             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01556 
01557                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d1/obp_8h.html#a7">ObpDecrHandleCount</a>( ObjectHeader );
01558                 leave;
01559             }
01560         }
01561 
01562         <span class="comment">//</span>
01563         <span class="comment">//  Do some simple bookkeeping for the handle counts</span>
01564         <span class="comment">//  and then return to our caller</span>
01565         <span class="comment">//</span>
01566 
01567         ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o6">TotalNumberOfHandles</a> += 1;
01568 
01569         <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o6">TotalNumberOfHandles</a> &gt; ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o8">HighWaterNumberOfHandles</a>) {
01570 
01571             ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o8">HighWaterNumberOfHandles</a> = ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o6">TotalNumberOfHandles</a>;
01572         }
01573 
01574     } finally {
01575 
01576         <span class="keywordflow">if</span> ( HoldObjectTypeMutex ) {
01577 
01578             <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
01579         }
01580     }
01581 
01582     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01583 }
01584 
01585 
01586 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01587"></a><a class="code" href="../../d5/d1/obp_8h.html#a80">01587</a> <a class="code" href="../../d5/d1/obp_8h.html#a80">ObpIncrementUnnamedHandleCount</a> (
01588     PACCESS_MASK DesiredAccess,
01589     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
01590     PVOID Object,
01591     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType,
01592     KPROCESSOR_MODE AccessMode,
01593     ULONG Attributes
01594     )
01595 
01596 <span class="comment">/*++</span>
01597 <span class="comment"></span>
01598 <span class="comment">Routine Description:</span>
01599 <span class="comment"></span>
01600 <span class="comment">    Increments the count of number of handles to the given object.</span>
01601 <span class="comment"></span>
01602 <span class="comment">Arguments:</span>
01603 <span class="comment"></span>
01604 <span class="comment">    Desired Access - Supplies the desired access to the object and receives</span>
01605 <span class="comment">        the assign access mask</span>
01606 <span class="comment"></span>
01607 <span class="comment">    Process - Pointer to the process in which the new handle will reside.</span>
01608 <span class="comment"></span>
01609 <span class="comment">    Object - Supplies a pointer to the body of the object.</span>
01610 <span class="comment"></span>
01611 <span class="comment">    ObjectType - Supplies the type of the object.</span>
01612 <span class="comment"></span>
01613 <span class="comment">    AccessMode - Supplies the mode of the requestor.</span>
01614 <span class="comment"></span>
01615 <span class="comment">    Attributes - Desired attributes for the handle</span>
01616 <span class="comment"></span>
01617 <span class="comment">Return Value:</span>
01618 <span class="comment"></span>
01619 <span class="comment">    An appropriate status value</span>
01620 <span class="comment"></span>
01621 <span class="comment">--*/</span>
01622 
01623 {
01624     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01625     BOOLEAN ExclusiveHandle;
01626     <a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html">POBJECT_HEADER_CREATOR_INFO</a> CreatorInfo;
01627     <a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html">POBJECT_HEADER_QUOTA_INFO</a> QuotaInfo;
01628     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01629     BOOLEAN NewObject;
01630     ULONG ProcessHandleCount;
01631     BOOLEAN HoldObjectTypeMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01632 
01633     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01634 
01635     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>( <span class="stringliteral">"ObpIncrementUnnamedHandleCount"</span> );
01636 
01637     <span class="comment">//</span>
01638     <span class="comment">//  Get a pointer to the object header</span>
01639     <span class="comment">//</span>
01640 
01641     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
01642 
01643     <span class="comment">//</span>
01644     <span class="comment">//  Charge the user quota for the object</span>
01645     <span class="comment">//</span>
01646 
01647     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a82">ObpChargeQuotaForObject</a>( ObjectHeader, ObjectType, &amp;NewObject );
01648 
01649     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01650 
01651         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01652     }
01653 
01654     <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
01655     HoldObjectTypeMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01656 
01657     <span class="keywordflow">try</span> {
01658 
01659         ExclusiveHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01660 
01661         <span class="comment">//</span>
01662         <span class="comment">//  Check if the caller wants exlusive access and if so then</span>
01663         <span class="comment">//  make sure the attributes and header flags match up correctly</span>
01664         <span class="comment">//</span>
01665 
01666         <span class="keywordflow">if</span> (Attributes &amp; OBJ_EXCLUSIVE) {
01667 
01668             <span class="keywordflow">if</span> ((Attributes &amp; OBJ_INHERIT) ||
01669                 ((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a4">OB_FLAG_EXCLUSIVE_OBJECT</a>) == 0)) {
01670 
01671                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
01672                 leave;
01673             }
01674 
01675             <span class="keywordflow">if</span> (((<a class="code" href="../../d4/d0/ob_8h.html#a9">OBJECT_HEADER_TO_EXCLUSIVE_PROCESS</a>(ObjectHeader) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01676                  (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o1">HandleCount</a> != 0))
01677 
01678                         ||
01679 
01680                 ((<a class="code" href="../../d4/d0/ob_8h.html#a9">OBJECT_HEADER_TO_EXCLUSIVE_PROCESS</a>(ObjectHeader) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01681                  (<a class="code" href="../../d4/d0/ob_8h.html#a9">OBJECT_HEADER_TO_EXCLUSIVE_PROCESS</a>(ObjectHeader) != <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()))) {
01682 
01683                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
01684                 leave;
01685             }
01686 
01687             ExclusiveHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01688 
01689         <span class="comment">//</span>
01690         <span class="comment">//  The user doesn't want exclusive access so now check to make sure</span>
01691         <span class="comment">//  the attriutes and header flags match up correctly</span>
01692         <span class="comment">//</span>
01693 
01694         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a4">OB_FLAG_EXCLUSIVE_OBJECT</a>) &amp;&amp;
01695                    (<a class="code" href="../../d4/d0/ob_8h.html#a9">OBJECT_HEADER_TO_EXCLUSIVE_PROCESS</a>(ObjectHeader) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01696 
01697             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
01698             leave;
01699         }
01700 
01701         <span class="comment">//</span>
01702         <span class="comment">//  If handle count going from zero to one for an existing object that</span>
01703         <span class="comment">//  maintains a handle count database, but does not have an open procedure</span>
01704         <span class="comment">//  just a close procedure, then fail the call as they are trying to</span>
01705         <span class="comment">//  reopen an object by pointer and the close procedure will not know</span>
01706         <span class="comment">//  that the object has been 'recreated'</span>
01707         <span class="comment">//</span>
01708 
01709         <span class="keywordflow">if</span> ((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o1">HandleCount</a> == 0) &amp;&amp;
01710             (!NewObject) &amp;&amp;
01711             (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o7">MaintainHandleCount</a>) &amp;&amp;
01712             (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o13">OpenProcedure</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01713             (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o14">CloseProcedure</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01714 
01715             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
01716 
01717             leave;
01718         }
01719 
01720         <span class="comment">//</span>
01721         <span class="comment">//  If the user asked for the maximum allowed then remove the bit and</span>
01722         <span class="comment">//  or in generic all access</span>
01723         <span class="comment">//</span>
01724 
01725         <span class="keywordflow">if</span> ( *DesiredAccess &amp; MAXIMUM_ALLOWED ) {
01726 
01727             *DesiredAccess &amp;= ~MAXIMUM_ALLOWED;
01728             *DesiredAccess |= GENERIC_ALL;
01729         }
01730 
01731         <span class="comment">//  If the user asked for any generic bit then translate it to</span>
01732         <span class="comment">//  someone more appropriate for the object type</span>
01733         <span class="comment">//</span>
01734 
01735         <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d0/obhandle_8c.html#a0">GENERIC_ACCESS</a> &amp; *DesiredAccess) != 0) {
01736 
01737             <a class="code" href="../../d8/d6/sertl_8c.html#a70">RtlMapGenericMask</a>( DesiredAccess,
01738                                &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> );
01739         }
01740 
01741         <span class="comment">//</span>
01742         <span class="comment">//  Get a pointer to the creator info block for the object and insert</span>
01743         <span class="comment">//  it on the global list of object for that type</span>
01744         <span class="comment">//</span>
01745 
01746         CreatorInfo = <a class="code" href="../../d4/d0/ob_8h.html#a13">OBJECT_HEADER_TO_CREATOR_INFO</a>( ObjectHeader );
01747 
01748         <span class="keywordflow">if</span> (CreatorInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01749 
01750             InsertTailList( &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o1">TypeList</a>, &amp;CreatorInfo-&gt;<a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html#o0">TypeList</a> );
01751         }
01752 
01753         <span class="keywordflow">if</span> (ExclusiveHandle) {
01754 
01755             <a class="code" href="../../d4/d0/ob_8h.html#a10">OBJECT_HEADER_TO_QUOTA_INFO</a>(ObjectHeader)-&gt;ExclusiveProcess = Process;
01756         }
01757 
01758         <a class="code" href="../../d5/d1/obp_8h.html#a6">ObpIncrHandleCount</a>( ObjectHeader );
01759         ProcessHandleCount = 0;
01760 
01761         <span class="comment">//</span>
01762         <span class="comment">//  If the object type wants us to keep try of the handle counts</span>
01763         <span class="comment">//  then call our routine to do the work</span>
01764         <span class="comment">//</span>
01765 
01766         <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o7">MaintainHandleCount</a>) {
01767 
01768             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a2">ObpIncrementHandleDataBase</a>( ObjectHeader,
01769                                                  Process,
01770                                                  &amp;ProcessHandleCount );
01771 
01772             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01773                 <span class="comment">// BUG BUG, We probably need more backout than this, NeillC</span>
01774                 <a class="code" href="../../d5/d1/obp_8h.html#a7">ObpDecrHandleCount</a>( ObjectHeader );
01775                 leave;
01776             }
01777         }
01778 
01779         <span class="comment">//</span>
01780         <span class="comment">//  Set our preliminary status now to success because</span>
01781         <span class="comment">//  the call to the open procedure might change this</span>
01782         <span class="comment">//</span>
01783 
01784         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01785 
01786         <span class="comment">//</span>
01787         <span class="comment">//  If the object type has an open procedure</span>
01788         <span class="comment">//  then invoke that procedure</span>
01789         <span class="comment">//</span>
01790 
01791         <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o13">OpenProcedure</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01792 
01793             KIRQL SaveIrql;
01794 
01795             <span class="comment">//</span>
01796             <span class="comment">//  Leave the object type mutex when call the OpenProcedure. If an exception</span>
01797             <span class="comment">//  while OpenProcedure the HoldObjectTypeMutex disable leaving the mutex</span>
01798             <span class="comment">//  on finally block</span>
01799             <span class="comment">//</span>
01800 
01801             <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
01802             HoldObjectTypeMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01803 
01804             <a class="code" href="../../d5/d1/obp_8h.html#a0">ObpBeginTypeSpecificCallOut</a>( SaveIrql );
01805 
01806             <span class="keywordflow">try</span> {
01807 
01808                 (*ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o13">OpenProcedure</a>)( <a class="code" href="../../d4/d0/ob_8h.html#a100a58">ObCreateHandle</a>,
01809                                                        Process,
01810                                                        Object,
01811                                                        *DesiredAccess,
01812                                                        ProcessHandleCount );
01813 
01814             } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
01815 
01816                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01817             }
01818 
01819             <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"Open"</span>, ObjectType, Object );
01820 
01821             <span class="comment">//</span>
01822             <span class="comment">//  Hold back the object type mutex and set the HoldObjectTypeMutex variable</span>
01823             <span class="comment">//  to allow releasing the mutex while leaving this procedure</span>
01824             <span class="comment">//</span>
01825 
01826             <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
01827             HoldObjectTypeMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01828 
01829             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01830 
01831                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d1/obp_8h.html#a7">ObpDecrHandleCount</a>( ObjectHeader );
01832                 leave;
01833             }
01834         }
01835 
01836         <span class="comment">//</span>
01837         <span class="comment">//  Do some simple bookkeeping for the handle counts</span>
01838         <span class="comment">//  and then return to our caller</span>
01839         <span class="comment">//</span>
01840 
01841         ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o6">TotalNumberOfHandles</a> += 1;
01842 
01843         <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o6">TotalNumberOfHandles</a> &gt; ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o8">HighWaterNumberOfHandles</a>) {
01844 
01845             ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o8">HighWaterNumberOfHandles</a> = ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o6">TotalNumberOfHandles</a>;
01846         }
01847 
01848     } finally {
01849 
01850         <span class="keywordflow">if</span> ( HoldObjectTypeMutex ) {
01851 
01852             <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
01853         }
01854     }
01855 
01856     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01857 }
01858 
01859 
01860 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01861"></a><a class="code" href="../../d5/d1/obp_8h.html#a82">01861</a> <a class="code" href="../../d5/d1/obp_8h.html#a82">ObpChargeQuotaForObject</a> (
01862     IN <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader,
01863     IN <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType,
01864     OUT PBOOLEAN NewObject
01865     )
01866 
01867 <span class="comment">/*++</span>
01868 <span class="comment"></span>
01869 <span class="comment">Routine Description:</span>
01870 <span class="comment"></span>
01871 <span class="comment">    This routine charges quota against the current process for the new</span>
01872 <span class="comment">    object</span>
01873 <span class="comment"></span>
01874 <span class="comment">Arguments:</span>
01875 <span class="comment"></span>
01876 <span class="comment">    ObjectHeader - Supplies a pointer to the new object being charged for</span>
01877 <span class="comment"></span>
01878 <span class="comment">    ObjectType - Supplies the type of the new object</span>
01879 <span class="comment"></span>
01880 <span class="comment">    NewObject - Returns true if the object is really new and false otherwise</span>
01881 <span class="comment"></span>
01882 <span class="comment">Return Value:</span>
01883 <span class="comment"></span>
01884 <span class="comment">    An appropriate status value</span>
01885 <span class="comment"></span>
01886 <span class="comment">--*/</span>
01887 
01888 {
01889     <a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html">POBJECT_HEADER_QUOTA_INFO</a> QuotaInfo;
01890     ULONG NonPagedPoolCharge;
01891     ULONG PagedPoolCharge;
01892 
01893     <span class="comment">//</span>
01894     <span class="comment">//  Get a pointer to the quota block for this object</span>
01895     <span class="comment">//</span>
01896 
01897     QuotaInfo = <a class="code" href="../../d4/d0/ob_8h.html#a10">OBJECT_HEADER_TO_QUOTA_INFO</a>( ObjectHeader );
01898 
01899     *NewObject = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01900 
01901     <span class="comment">//</span>
01902     <span class="comment">//  If the object is new then we have work to do otherwise</span>
01903     <span class="comment">//  we'll return with NewObject set to false</span>
01904     <span class="comment">//</span>
01905 
01906     <span class="keywordflow">if</span> (ObjectHeader-&gt;Flags &amp; <a class="code" href="../../d4/d0/ob_8h.html#a1">OB_FLAG_NEW_OBJECT</a>) {
01907 
01908         <span class="comment">//</span>
01909         <span class="comment">//  Say the object now isn't new</span>
01910         <span class="comment">//</span>
01911 
01912         ObjectHeader-&gt;Flags &amp;= ~<a class="code" href="../../d4/d0/ob_8h.html#a1">OB_FLAG_NEW_OBJECT</a>;
01913 
01914         <span class="comment">//</span>
01915         <span class="comment">//  If there does exist a quota info structure for this</span>
01916         <span class="comment">//  object then calculate what our charge should be from</span>
01917         <span class="comment">//  the information stored in that structure</span>
01918         <span class="comment">//</span>
01919 
01920         <span class="keywordflow">if</span> (QuotaInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01921 
01922             PagedPoolCharge = QuotaInfo-&gt;<a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html#o0">PagedPoolCharge</a> +
01923                               QuotaInfo-&gt;<a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html#o2">SecurityDescriptorCharge</a>;
01924             NonPagedPoolCharge = QuotaInfo-&gt;<a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html#o1">NonPagedPoolCharge</a>;
01925 
01926         } <span class="keywordflow">else</span> {
01927 
01928             <span class="comment">//</span>
01929             <span class="comment">//  There isn't any quota information so we're on our own</span>
01930             <span class="comment">//  Paged pool charge is the default for the object plus</span>
01931             <span class="comment">//  the security descriptor if present.  Nonpaged pool charge</span>
01932             <span class="comment">//  is the default for the object.</span>
01933             <span class="comment">//</span>
01934 
01935             PagedPoolCharge = ObjectType-&gt;TypeInfo.DefaultPagedPoolCharge;
01936 
01937             <span class="keywordflow">if</span> (ObjectHeader-&gt;SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01938 
01939                 ObjectHeader-&gt;Flags |= <a class="code" href="../../d4/d0/ob_8h.html#a6">OB_FLAG_DEFAULT_SECURITY_QUOTA</a>;
01940                 PagedPoolCharge += <a class="code" href="../../d0/d5/se_8h.html#a0">SE_DEFAULT_SECURITY_QUOTA</a>;
01941             }
01942 
01943             NonPagedPoolCharge = ObjectType-&gt;TypeInfo.DefaultNonPagedPoolCharge;
01944         }
01945 
01946         <span class="comment">//</span>
01947         <span class="comment">//  Now charge for the quota and make sure it succeeds</span>
01948         <span class="comment">//</span>
01949 
01950         ObjectHeader-&gt;QuotaBlockCharged = (PVOID)<a class="code" href="../../d0/d2/psquota_8c.html#a0">PsChargeSharedPoolQuota</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(),
01951                                                                           PagedPoolCharge,
01952                                                                           NonPagedPoolCharge );
01953 
01954         <span class="keywordflow">if</span> (ObjectHeader-&gt;QuotaBlockCharged == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01955 
01956             <span class="keywordflow">return</span> STATUS_QUOTA_EXCEEDED;
01957         }
01958 
01959         *NewObject = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01960     }
01961 
01962     <span class="keywordflow">return</span> STATUS_SUCCESS;
01963 }
01964 
01965 
01966 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01967"></a><a class="code" href="../../d5/d1/obp_8h.html#a78">01967</a> <a class="code" href="../../d5/d1/obp_8h.html#a78">ObpDecrementHandleCount</a> (
01968     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
01969     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader,
01970     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType,
01971     ACCESS_MASK GrantedAccess
01972     )
01973 
01974 <span class="comment">/*++</span>
01975 <span class="comment"></span>
01976 <span class="comment">Routine Description:</span>
01977 <span class="comment"></span>
01978 <span class="comment">    This procedure decrements the handle count for the specified object</span>
01979 <span class="comment"></span>
01980 <span class="comment">Arguments:</span>
01981 <span class="comment"></span>
01982 <span class="comment">    Process - Supplies the process where the handle existed</span>
01983 <span class="comment"></span>
01984 <span class="comment">    ObjectHeader - Supplies a pointer to the object header for the object</span>
01985 <span class="comment"></span>
01986 <span class="comment">    ObjectType - Supplies a type of the object</span>
01987 <span class="comment"></span>
01988 <span class="comment">    GrantedAccess - Supplies the current access mask to the object</span>
01989 <span class="comment"></span>
01990 <span class="comment">Return Value:</span>
01991 <span class="comment"></span>
01992 <span class="comment">    None.</span>
01993 <span class="comment"></span>
01994 <span class="comment">--*/</span>
01995 
01996 {
01997     <a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html">POBJECT_HEADER_HANDLE_INFO</a> HandleInfo;
01998     <a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html">POBJECT_HANDLE_COUNT_DATABASE</a> HandleCountDataBase;
01999     <a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html">POBJECT_HANDLE_COUNT_ENTRY</a> HandleCountEntry;
02000     <a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html">POBJECT_HEADER_CREATOR_INFO</a> CreatorInfo;
02001     PVOID Object;
02002     ULONG CountEntries;
02003     ULONG ProcessHandleCount;
02004     ULONG SystemHandleCount;
02005     BOOLEAN HandleCountIsZero;
02006 
02007     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02008 
02009     <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
02010 
02011     Object = (PVOID)&amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o11">Body</a>;
02012 
02013     SystemHandleCount = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o1">HandleCount</a>;
02014     ProcessHandleCount = 0;
02015 
02016     <span class="comment">//</span>
02017     <span class="comment">//  Decrement the handle count and it was one and it</span>
02018     <span class="comment">//  was an exclusive object then zero out the exclusive</span>
02019     <span class="comment">//  process</span>
02020     <span class="comment">//</span>
02021 
02022     HandleCountIsZero = <a class="code" href="../../d5/d1/obp_8h.html#a7">ObpDecrHandleCount</a>( ObjectHeader );
02023             
02024     <span class="keywordflow">if</span> ( HandleCountIsZero &amp;&amp;
02025         (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a4">OB_FLAG_EXCLUSIVE_OBJECT</a>)) {
02026 
02027         <a class="code" href="../../d4/d0/ob_8h.html#a10">OBJECT_HEADER_TO_QUOTA_INFO</a>( ObjectHeader )-&gt;ExclusiveProcess = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02028     }
02029     
02030     <span class="keywordflow">if</span> ( HandleCountIsZero ) {
02031     
02032         CreatorInfo = <a class="code" href="../../d4/d0/ob_8h.html#a13">OBJECT_HEADER_TO_CREATOR_INFO</a>( ObjectHeader );
02033     
02034         <span class="comment">//</span>
02035         <span class="comment">//  If there is a creator info record and we are on the list</span>
02036         <span class="comment">//  for the object type then remove this object from the list</span>
02037         <span class="comment">//</span>
02038 
02039         <span class="keywordflow">if</span> (CreatorInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; !IsListEmpty( &amp;CreatorInfo-&gt;<a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html#o0">TypeList</a> )) {
02040                         
02041             RemoveEntryList( &amp;CreatorInfo-&gt;<a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html#o0">TypeList</a> );
02042             
02043             InitializeListHead( &amp;CreatorInfo-&gt;<a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html#o0">TypeList</a> );
02044         }
02045     }
02046 
02047     <span class="comment">//</span>
02048     <span class="comment">//  If the object maintains a handle count database then</span>
02049     <span class="comment">//  search through the handle database and decrement</span>
02050     <span class="comment">//  the necessary information</span>
02051     <span class="comment">//</span>
02052 
02053     <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o7">MaintainHandleCount</a>) {
02054 
02055         HandleInfo = <a class="code" href="../../d4/d0/ob_8h.html#a11">OBJECT_HEADER_TO_HANDLE_INFO</a>( ObjectHeader );
02056 
02057         <span class="comment">//</span>
02058         <span class="comment">//  Check if there is a single handle entry, then it better</span>
02059         <span class="comment">//  be ours</span>
02060         <span class="comment">//</span>
02061 
02062         <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a7">OB_FLAG_SINGLE_HANDLE_ENTRY</a>) {
02063 
02064             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o1">SingleEntry</a>.<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o0">Process</a> == Process);
02065             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o1">SingleEntry</a>.<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a> &gt; 0);
02066 
02067             ProcessHandleCount = HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o1">SingleEntry</a>.<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a>--;
02068             HandleCountEntry = &amp;HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o1">SingleEntry</a>;
02069 
02070         } <span class="keywordflow">else</span> {
02071 
02072             <span class="comment">//</span>
02073             <span class="comment">//  Otherwise search the database for a process match</span>
02074             <span class="comment">//</span>
02075 
02076             HandleCountDataBase = HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o0">HandleCountDataBase</a>;
02077 
02078             <span class="keywordflow">if</span> (HandleCountDataBase != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02079 
02080                 CountEntries = HandleCountDataBase-&gt;<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html#o0">CountEntries</a>;
02081                 HandleCountEntry = &amp;HandleCountDataBase-&gt;<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html#o1">HandleCountEntries</a>[ 0 ];
02082 
02083                 <span class="keywordflow">while</span> (CountEntries) {
02084 
02085                     <span class="keywordflow">if</span> ((HandleCountEntry-&gt;<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a> != 0) &amp;&amp;
02086                         (HandleCountEntry-&gt;<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o0">Process</a> == Process)) {
02087 
02088                         ProcessHandleCount = HandleCountEntry-&gt;<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a>--;
02089 
02090                         <span class="keywordflow">break</span>;
02091                     }
02092 
02093                     HandleCountEntry++;
02094                     CountEntries--;
02095                 }
02096             }
02097         }
02098 
02099         <span class="comment">//</span>
02100         <span class="comment">//  Now if the process is giving up all handles to the object</span>
02101         <span class="comment">//  then zero out the handle count entry.  For a single handle</span>
02102         <span class="comment">//  entry this is just the single entry in the header handle info</span>
02103         <span class="comment">//  structure</span>
02104         <span class="comment">//</span>
02105 
02106         <span class="keywordflow">if</span> (ProcessHandleCount == 1) {
02107 
02108             HandleCountEntry-&gt;<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o0">Process</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02109             HandleCountEntry-&gt;<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a> = 0;
02110         }
02111     }
02112 
02113     <span class="comment">//</span>
02114     <span class="comment">//  If the Object Type has a Close Procedure, then release the type</span>
02115     <span class="comment">//  mutex before calling it, and then call ObpDeleteNameCheck without</span>
02116     <span class="comment">//  the mutex held.</span>
02117     <span class="comment">//</span>
02118 
02119     <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o14">CloseProcedure</a>) {
02120 
02121         KIRQL SaveIrql;
02122 
02123         <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
02124 
02125         <a class="code" href="../../d5/d1/obp_8h.html#a0">ObpBeginTypeSpecificCallOut</a>( SaveIrql );
02126 
02127         (*ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o14">CloseProcedure</a>)( Process,
02128                                                 Object,
02129                                                 GrantedAccess,
02130                                                 ProcessHandleCount,
02131                                                 SystemHandleCount );
02132 
02133         <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"Close"</span>, ObjectType, Object );
02134 
02135         <a class="code" href="../../d7/d1/obref_8c.html#a11">ObpDeleteNameCheck</a>( Object, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
02136 
02137     } <span class="keywordflow">else</span> {
02138 
02139         <span class="comment">//</span>
02140         <span class="comment">//  If there is no Close Procedure, then just call ObpDeleteNameCheck</span>
02141         <span class="comment">//  with the mutex held.</span>
02142         <span class="comment">//</span>
02143         <span class="comment">//  The following call will release the type mutex</span>
02144         <span class="comment">//</span>
02145 
02146         <a class="code" href="../../d7/d1/obref_8c.html#a11">ObpDeleteNameCheck</a>( Object, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
02147     }
02148 
02149     <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
02150     
02151     ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o6">TotalNumberOfHandles</a> -= 1;
02152         
02153     <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
02154 
02155     <span class="keywordflow">return</span>;
02156 }
02157 
02158 
02159 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02160"></a><a class="code" href="../../d5/d1/obp_8h.html#a79">02160</a> <a class="code" href="../../d5/d1/obp_8h.html#a79">ObpCreateHandle</a> (
02161     IN OB_OPEN_REASON OpenReason,
02162     IN PVOID Object,
02163     IN <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ExpectedObjectType OPTIONAL,
02164     IN <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState,
02165     IN ULONG ObjectPointerBias OPTIONAL,
02166     IN ULONG Attributes,
02167     IN BOOLEAN DirectoryLocked,
02168     IN KPROCESSOR_MODE AccessMode,
02169     OUT PVOID *ReferencedNewObject OPTIONAL,
02170     OUT PHANDLE Handle
02171     )
02172 
02173 <span class="comment">/*++</span>
02174 <span class="comment"></span>
02175 <span class="comment">Routine Description:</span>
02176 <span class="comment"></span>
02177 <span class="comment">    This function creates a new handle to an existing object</span>
02178 <span class="comment"></span>
02179 <span class="comment">Arguments:</span>
02180 <span class="comment"></span>
02181 <span class="comment">    OpenReason - The reason why we are doing this work</span>
02182 <span class="comment"></span>
02183 <span class="comment">    Object - A pointer to the body of the new object</span>
02184 <span class="comment"></span>
02185 <span class="comment">    ExpectedObjectType - Optionally Supplies the object type that</span>
02186 <span class="comment">        the caller is expecting</span>
02187 <span class="comment"></span>
02188 <span class="comment">    AccessState - Supplies the access state for the handle requested</span>
02189 <span class="comment">        by the caller</span>
02190 <span class="comment"></span>
02191 <span class="comment">    ObjectPointerBias - Optionally supplies a count of addition</span>
02192 <span class="comment">        increments we do to the pointer count for the object</span>
02193 <span class="comment"></span>
02194 <span class="comment">    Attributes -  Desired attributes for the handle</span>
02195 <span class="comment"></span>
02196 <span class="comment">    DirectoryLocked - Indicates if the root directory mutex is already held</span>
02197 <span class="comment"></span>
02198 <span class="comment">    AccessMode - Supplies the mode of the requestor.</span>
02199 <span class="comment"></span>
02200 <span class="comment">    ReferencedNewObject - Optionally receives a pointer to the body</span>
02201 <span class="comment">        of the new object</span>
02202 <span class="comment"></span>
02203 <span class="comment">    Handle - Receives the new handle value</span>
02204 <span class="comment"></span>
02205 <span class="comment">Return Value:</span>
02206 <span class="comment"></span>
02207 <span class="comment">    An appropriate status value</span>
02208 <span class="comment"></span>
02209 <span class="comment">--*/</span>
02210 
02211 {
02212     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02213     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
02214     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
02215     PVOID ObjectTable;
02216     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">HANDLE_TABLE_ENTRY</a> ObjectTableEntry;
02217     HANDLE NewHandle;
02218     ACCESS_MASK DesiredAccess;
02219     ACCESS_MASK GrantedAccess;
02220     ULONG BiasCount;
02221     BOOLEAN AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02222     BOOLEAN KernelHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02223     <a class="code" href="../../d3/d5/struct__KAPC__STATE.html">KAPC_STATE</a> ApcState;
02224 
02225     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02226 
02227     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>( <span class="stringliteral">"ObpCreateHandle"</span> );
02228 
02229     <span class="comment">//</span>
02230     <span class="comment">//  Merge both the remaining desired access and the currently</span>
02231     <span class="comment">//  granted access states into one mask</span>
02232     <span class="comment">//</span>
02233     <span class="comment">//  **** why is this being done here and then later in the this</span>
02234     <span class="comment">//  same routine.</span>
02235     <span class="comment">//</span>
02236 
02237     DesiredAccess = AccessState-&gt;RemainingDesiredAccess |
02238                     AccessState-&gt;PreviouslyGrantedAccess;
02239 
02240     <span class="comment">//</span>
02241     <span class="comment">//  Get a pointer to the object header and object type</span>
02242     <span class="comment">//</span>
02243 
02244     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
02245     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
02246 
02247     <span class="comment">//</span>
02248     <span class="comment">//  If the object type isn't what was expected then</span>
02249     <span class="comment">//  return an error to our caller, but first see if</span>
02250     <span class="comment">//  we should release the directory mutex</span>
02251     <span class="comment">//</span>
02252 
02253     <span class="keywordflow">if</span> ((ARGUMENT_PRESENT( ExpectedObjectType )) &amp;&amp;
02254         (ObjectType != ExpectedObjectType )) {
02255 
02256         <span class="keywordflow">if</span> (DirectoryLocked) {
02257 
02258             <a class="code" href="../../d5/d1/obp_8h.html#a11">ObpLeaveRootDirectoryMutex</a>();
02259         }
02260 
02261         <span class="keywordflow">return</span>( STATUS_OBJECT_TYPE_MISMATCH );
02262     }
02263 
02264     <span class="comment">//</span>
02265     <span class="comment">//  Set the first ulong of the object table entry to point</span>
02266     <span class="comment">//  back to the object header</span>
02267     <span class="comment">//</span>
02268 
02269     ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a> = ObjectHeader;
02270 
02271     <span class="comment">//</span>
02272     <span class="comment">//  Now get a pointer to the object table for either the current process</span>
02273     <span class="comment">//  of the kernel handle table</span>
02274     <span class="comment">//</span>
02275 
02276     <span class="keywordflow">if</span> ((Attributes &amp; OBJ_KERNEL_HANDLE) &amp;&amp; (AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>)) {
02277 
02278         ObjectTable = <a class="code" href="../../d5/d1/obp_8h.html#a54">ObpKernelHandleTable</a>;
02279         KernelHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02280 
02281         <span class="comment">//</span>
02282         <span class="comment">//  Go to the system process if we have to</span>
02283         <span class="comment">//</span>
02284 
02285         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != <a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>) {
02286             <a class="code" href="../../d3/d5/procobj_8c.html#a6">KeStackAttachProcess</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>, &amp;ApcState);
02287             AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02288         }
02289 
02290 
02291     } <span class="keywordflow">else</span> {
02292 
02293         ObjectTable = <a class="code" href="../../d5/d1/obp_8h.html#a12">ObpGetObjectTable</a>();
02294     }
02295 
02296     <span class="comment">//</span>
02297     <span class="comment">//  ObpIncrementHandleCount will perform access checking on the</span>
02298     <span class="comment">//  object being opened as appropriate.</span>
02299     <span class="comment">//</span>
02300 
02301     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a77">ObpIncrementHandleCount</a>( OpenReason,
02302                                       <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(),
02303                                       Object,
02304                                       ObjectType,
02305                                       AccessState,
02306                                       AccessMode,
02307                                       Attributes );
02308 
02309     <span class="keywordflow">if</span> (AccessState-&gt;GenerateOnClose) {
02310 
02311         Attributes |= <a class="code" href="../../d7/d7/ntapi_8c.html#a2">OBJ_AUDIT_OBJECT_CLOSE</a>;
02312     }
02313 
02314     <span class="comment">//</span>
02315     <span class="comment">//  Or in some low order bits into the first ulong of the object</span>
02316     <span class="comment">//  table entry</span>
02317     <span class="comment">//</span>
02318 
02319     ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o1">ObAttributes</a> |= (Attributes &amp; <a class="code" href="../../d5/d1/obp_8h.html#a17">OBJ_HANDLE_ATTRIBUTES</a>);
02320 
02321     <span class="comment">//</span>
02322     <span class="comment">//  Merge both the remaining desired access and the currently</span>
02323     <span class="comment">//  granted access states into one mask and then compute</span>
02324     <span class="comment">//  the granted access</span>
02325     <span class="comment">//</span>
02326 
02327     DesiredAccess = AccessState-&gt;RemainingDesiredAccess |
02328                     AccessState-&gt;PreviouslyGrantedAccess;
02329 
02330     GrantedAccess = DesiredAccess &amp;
02331                     (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o5">ValidAccessMask</a> | ACCESS_SYSTEM_SECURITY );
02332 
02333     <span class="comment">//</span>
02334     <span class="comment">//  Unlock the directory if it is locked and make sure</span>
02335     <span class="comment">//  we've been successful so far</span>
02336     <span class="comment">//</span>
02337 
02338     <span class="keywordflow">if</span> (DirectoryLocked) {
02339 
02340         <a class="code" href="../../d5/d1/obp_8h.html#a11">ObpLeaveRootDirectoryMutex</a>();
02341     }
02342 
02343     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
02344 
02345         <span class="comment">//</span>
02346         <span class="comment">//  If we are attached to the system process then return</span>
02347         <span class="comment">//  back to our caller</span>
02348         <span class="comment">//</span>
02349 
02350         <span class="keywordflow">if</span> (AttachedToProcess) {
02351             <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
02352             AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02353         }
02354 
02355         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
02356     }
02357 
02358     <span class="comment">//</span>
02359     <span class="comment">//  Bias the pointer count if that is what the caller wanted</span>
02360     <span class="comment">//</span>
02361 
02362     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( (PVOID)(ULONG_PTR)ObjectPointerBias )) {
02363 
02364         BiasCount = ObjectPointerBias;
02365 
02366         <span class="keywordflow">while</span> (BiasCount--) {
02367 
02368             <a class="code" href="../../d5/d1/obp_8h.html#a3">ObpIncrPointerCount</a>( ObjectHeader );
02369         }
02370     }
02371 
02372     <span class="comment">//</span>
02373     <span class="comment">//  Set the granted access mask in the object table entry (second ulong)</span>
02374     <span class="comment">//</span>
02375 
02376 <span class="preprocessor">#if i386 &amp;&amp; !FPO</span>
02377 <span class="preprocessor"></span>
02378     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_KERNEL_STACK_TRACE_DB) {
02379 
02380         ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o3">GrantedAccessIndex</a> = ObpComputeGrantedAccessIndex( GrantedAccess );
02381         ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o4">CreatorBackTraceIndex</a> = RtlLogStackBackTrace();
02382 
02383     } <span class="keywordflow">else</span> {
02384 
02385         ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a> = GrantedAccess;
02386     }
02387 
02388 <span class="preprocessor">#else</span>
02389 <span class="preprocessor"></span>
02390     ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a> = GrantedAccess;
02391 
02392 <span class="preprocessor">#endif // i386 &amp;&amp; !FPO</span>
02393 <span class="preprocessor"></span>
02394     <span class="comment">//</span>
02395     <span class="comment">//  Add this new object table entry to the object table for the process</span>
02396     <span class="comment">//</span>
02397 
02398     NewHandle = <a class="code" href="../../d5/d8/ex_8h.html#a296">ExCreateHandle</a>( ObjectTable, &amp;ObjectTableEntry );
02399 
02400     <span class="comment">//</span>
02401     <span class="comment">//  If we didn't get a handle then cleanup after ourselves and return</span>
02402     <span class="comment">//  the error to our caller</span>
02403     <span class="comment">//</span>
02404 
02405     <span class="keywordflow">if</span> (NewHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02406 
02407         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( (PVOID)(ULONG_PTR)ObjectPointerBias )) {
02408 
02409             BiasCount = ObjectPointerBias;
02410 
02411             <span class="keywordflow">while</span> (BiasCount--) {
02412 
02413                 <a class="code" href="../../d5/d1/obp_8h.html#a4">ObpDecrPointerCount</a>( ObjectHeader );
02414             }
02415         }
02416 
02417         <a class="code" href="../../d5/d1/obp_8h.html#a78">ObpDecrementHandleCount</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(),
02418                                  ObjectHeader,
02419                                  ObjectType,
02420                                  GrantedAccess );
02421 
02422         <span class="comment">//</span>
02423         <span class="comment">//  If we are attached to the system process then return</span>
02424         <span class="comment">//  back to our caller</span>
02425         <span class="comment">//</span>
02426 
02427         <span class="keywordflow">if</span> (AttachedToProcess) {
02428             <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
02429             AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02430         }
02431 
02432         <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
02433     }
02434 
02435     <span class="comment">//</span>
02436     <span class="comment">//  We have a new Ex style handle now make it an ob style handle and also</span>
02437     <span class="comment">//  adjust for the kernel handle by setting the sign bit in the handle</span>
02438     <span class="comment">//  value</span>
02439     <span class="comment">//</span>
02440 
02441     <span class="keywordflow">if</span> (KernelHandle) {
02442 
02443         NewHandle = <a class="code" href="../../d5/d1/obp_8h.html#a26">EncodeKernelHandle</a>( NewHandle );
02444     }
02445 
02446     *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = NewHandle;
02447 
02448     <span class="comment">//</span>
02449     <span class="comment">//  If requested, generate audit messages to indicate that a new handle</span>
02450     <span class="comment">//  has been allocated.</span>
02451     <span class="comment">//</span>
02452     <span class="comment">//  This is the final security operation in the creation/opening of the</span>
02453     <span class="comment">//  object.</span>
02454     <span class="comment">//</span>
02455 
02456     <span class="keywordflow">if</span> ( AccessState-&gt;GenerateAudit ) {
02457 
02458         <a class="code" href="../../d3/d5/seaudit_8c.html#a28">SeAuditHandleCreation</a>( AccessState,
02459                                *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> );
02460     }
02461 
02462     <span class="keywordflow">if</span> (OpenReason == <a class="code" href="../../d4/d0/ob_8h.html#a100a58">ObCreateHandle</a>) {
02463 
02464         <a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">PAUX_ACCESS_DATA</a> AuxData = AccessState-&gt;AuxData;
02465 
02466         <span class="keywordflow">if</span> ( ( AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a>-&gt;PrivilegeCount &gt; 0) ) {
02467 
02468             <a class="code" href="../../d3/d5/seaudit_8c.html#a13">SePrivilegeObjectAuditAlarm</a>( *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
02469                                          &amp;AccessState-&gt;SubjectSecurityContext,
02470                                          GrantedAccess,
02471                                          AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a>,
02472                                          <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02473                                          KeGetPreviousMode() );
02474         }
02475     }
02476 
02477     <span class="comment">//</span>
02478     <span class="comment">//  If the caller had a pointer bias and wanted the new reference object</span>
02479     <span class="comment">//  then return that value</span>
02480     <span class="comment">//</span>
02481 
02482     <span class="keywordflow">if</span> ((ARGUMENT_PRESENT( (PVOID)(ULONG_PTR)ObjectPointerBias )) &amp;&amp;
02483         (ARGUMENT_PRESENT( ReferencedNewObject ))) {
02484 
02485         *ReferencedNewObject = Object;
02486     }
02487 
02488     <span class="comment">//</span>
02489     <span class="comment">//  If we are attached to the system process then return</span>
02490     <span class="comment">//  back to our caller</span>
02491     <span class="comment">//</span>
02492 
02493     <span class="keywordflow">if</span> (AttachedToProcess) {
02494         <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
02495         AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02496     }
02497 
02498     <span class="comment">//</span>
02499     <span class="comment">//  And return to our caller</span>
02500     <span class="comment">//</span>
02501 
02502     <span class="keywordflow">return</span>( STATUS_SUCCESS );
02503 }
02504 
02505 
02506 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02507"></a><a class="code" href="../../d5/d1/obp_8h.html#a81">02507</a> <a class="code" href="../../d5/d1/obp_8h.html#a81">ObpCreateUnnamedHandle</a> (
02508     IN PVOID Object,
02509     IN ACCESS_MASK DesiredAccess,
02510     IN ULONG ObjectPointerBias OPTIONAL,
02511     IN ULONG Attributes,
02512     IN KPROCESSOR_MODE AccessMode,
02513     OUT PVOID *ReferencedNewObject OPTIONAL,
02514     OUT PHANDLE Handle
02515     )
02516 
02517 <span class="comment">/*++</span>
02518 <span class="comment"></span>
02519 <span class="comment">Routine Description:</span>
02520 <span class="comment"></span>
02521 <span class="comment">    This function creates a new unnamed handle for an existing object</span>
02522 <span class="comment"></span>
02523 <span class="comment">Arguments:</span>
02524 <span class="comment"></span>
02525 <span class="comment">    Object - A pointer to the body of the new object</span>
02526 <span class="comment"></span>
02527 <span class="comment">    DesiredAccess - Supplies the access mask being requsted</span>
02528 <span class="comment"></span>
02529 <span class="comment">    ObjectPointerBias - Optionally supplies a count of addition</span>
02530 <span class="comment">        increments we do to the pointer count for the object</span>
02531 <span class="comment"></span>
02532 <span class="comment">    Attributes -  Desired attributes for the handle</span>
02533 <span class="comment"></span>
02534 <span class="comment">    AccessMode - Supplies the mode of the requestor.</span>
02535 <span class="comment"></span>
02536 <span class="comment">    ReferencedNewObject - Optionally receives a pointer to the body</span>
02537 <span class="comment">        of the new object</span>
02538 <span class="comment"></span>
02539 <span class="comment">    Handle - Receives the new handle value</span>
02540 <span class="comment"></span>
02541 <span class="comment">Return Value:</span>
02542 <span class="comment"></span>
02543 <span class="comment">    An appropriate status value</span>
02544 <span class="comment"></span>
02545 <span class="comment">--*/</span>
02546 
02547 {
02548     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02549     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
02550     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
02551     PVOID ObjectTable;
02552     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">HANDLE_TABLE_ENTRY</a> ObjectTableEntry;
02553     HANDLE NewHandle;
02554     ULONG BiasCount;
02555     ACCESS_MASK GrantedAccess;
02556     BOOLEAN AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02557     BOOLEAN KernelHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02558     <a class="code" href="../../d3/d5/struct__KAPC__STATE.html">KAPC_STATE</a> ApcState;
02559 
02560     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02561 
02562     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>( <span class="stringliteral">"ObpCreateUnnamedHandle"</span> );
02563 
02564     <span class="comment">//</span>
02565     <span class="comment">//  Get the object header and type for the new object</span>
02566     <span class="comment">//</span>
02567 
02568     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
02569     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
02570 
02571     <span class="comment">//</span>
02572     <span class="comment">//  Set the first ulong of the object table entry to point</span>
02573     <span class="comment">//  to the object header and then or in the low order attribute</span>
02574     <span class="comment">//  bits</span>
02575     <span class="comment">//</span>
02576 
02577     ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a> = ObjectHeader;
02578 
02579     ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o1">ObAttributes</a> |= (Attributes &amp; <a class="code" href="../../d5/d1/obp_8h.html#a17">OBJ_HANDLE_ATTRIBUTES</a>);
02580 
02581     <span class="comment">//</span>
02582     <span class="comment">//  Now get a pointer to the object table for either the current process</span>
02583     <span class="comment">//  of the kernel handle table</span>
02584     <span class="comment">//</span>
02585 
02586     <span class="keywordflow">if</span> ((Attributes &amp; OBJ_KERNEL_HANDLE) &amp;&amp; (AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>)) {
02587 
02588         ObjectTable = <a class="code" href="../../d5/d1/obp_8h.html#a54">ObpKernelHandleTable</a>;
02589         KernelHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02590 
02591         <span class="comment">//</span>
02592         <span class="comment">//  Go to the system process if we have to</span>
02593         <span class="comment">//</span>
02594 
02595         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != <a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>) {
02596             <a class="code" href="../../d3/d5/procobj_8c.html#a6">KeStackAttachProcess</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>, &amp;ApcState);
02597             AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02598         }
02599 
02600     } <span class="keywordflow">else</span> {
02601 
02602         ObjectTable = <a class="code" href="../../d5/d1/obp_8h.html#a12">ObpGetObjectTable</a>();
02603     }
02604 
02605     <span class="comment">//</span>
02606     <span class="comment">//  Increment the handle count, this routine also does the access</span>
02607     <span class="comment">//  check if necessary</span>
02608     <span class="comment">//</span>
02609 
02610     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a80">ObpIncrementUnnamedHandleCount</a>( &amp;DesiredAccess,
02611                                              <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(),
02612                                              Object,
02613                                              ObjectType,
02614                                              AccessMode,
02615                                              Attributes );
02616 
02617 
02618     GrantedAccess = DesiredAccess &amp;
02619                     (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o5">ValidAccessMask</a> | ACCESS_SYSTEM_SECURITY );
02620 
02621     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
02622 
02623         <span class="comment">//</span>
02624         <span class="comment">//  If we are attached to the system process then return</span>
02625         <span class="comment">//  back to our caller</span>
02626         <span class="comment">//</span>
02627 
02628         <span class="keywordflow">if</span> (AttachedToProcess) {
02629             <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
02630             AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02631         }
02632 
02633         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
02634     }
02635 
02636     <span class="comment">//</span>
02637     <span class="comment">//  Bias the pointer count if that is what the caller wanted</span>
02638     <span class="comment">//</span>
02639 
02640     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( (PVOID)(ULONG_PTR)ObjectPointerBias )) {
02641 
02642         BiasCount = ObjectPointerBias;
02643 
02644         <span class="keywordflow">while</span> (BiasCount--) {
02645 
02646             <a class="code" href="../../d5/d1/obp_8h.html#a3">ObpIncrPointerCount</a>( ObjectHeader );
02647         }
02648     }
02649 
02650     <span class="comment">//</span>
02651     <span class="comment">//  Set the granted access mask in the object table entry (second ulong)</span>
02652     <span class="comment">//</span>
02653 
02654 <span class="preprocessor">#if i386 &amp;&amp; !FPO</span>
02655 <span class="preprocessor"></span>
02656     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_KERNEL_STACK_TRACE_DB) {
02657 
02658         ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o3">GrantedAccessIndex</a> = ObpComputeGrantedAccessIndex( GrantedAccess );
02659         ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o4">CreatorBackTraceIndex</a> = RtlLogStackBackTrace();
02660 
02661     } <span class="keywordflow">else</span> {
02662 
02663         ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a> = GrantedAccess;
02664     }
02665 
02666 <span class="preprocessor">#else</span>
02667 <span class="preprocessor"></span>
02668     ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a> = GrantedAccess;
02669 
02670 <span class="preprocessor">#endif // i386 &amp;&amp; !FPO</span>
02671 <span class="preprocessor"></span>
02672     <span class="comment">//</span>
02673     <span class="comment">//  Add this new object table entry to the object table for the process</span>
02674     <span class="comment">//</span>
02675 
02676     NewHandle = <a class="code" href="../../d5/d8/ex_8h.html#a296">ExCreateHandle</a>( ObjectTable, &amp;ObjectTableEntry );
02677 
02678     <span class="comment">//</span>
02679     <span class="comment">//  If we didn't get a handle then cleanup after ourselves and return</span>
02680     <span class="comment">//  the error to our caller</span>
02681     <span class="comment">//</span>
02682 
02683     <span class="keywordflow">if</span> (NewHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02684 
02685         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( (PVOID)(ULONG_PTR)ObjectPointerBias )) {
02686 
02687             BiasCount = ObjectPointerBias;
02688 
02689             <span class="keywordflow">while</span> (BiasCount--) {
02690 
02691                 <a class="code" href="../../d5/d1/obp_8h.html#a4">ObpDecrPointerCount</a>( ObjectHeader );
02692             }
02693         }
02694 
02695         <a class="code" href="../../d5/d1/obp_8h.html#a78">ObpDecrementHandleCount</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(),
02696                                  ObjectHeader,
02697                                  ObjectType,
02698                                  GrantedAccess );
02699 
02700         <span class="comment">//</span>
02701         <span class="comment">//  If we are attached to the system process then return</span>
02702         <span class="comment">//  back to our caller</span>
02703         <span class="comment">//</span>
02704 
02705         <span class="keywordflow">if</span> (AttachedToProcess) {
02706             <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
02707             AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02708         }
02709 
02710         <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
02711     }
02712 
02713     <span class="comment">//</span>
02714     <span class="comment">//  We have a new Ex style handle now make it an ob style handle and also</span>
02715     <span class="comment">//  adjust for the kernel handle by setting the sign bit in the handle</span>
02716     <span class="comment">//  value</span>
02717     <span class="comment">//</span>
02718 
02719     <span class="keywordflow">if</span> (KernelHandle) {
02720 
02721         NewHandle = <a class="code" href="../../d5/d1/obp_8h.html#a26">EncodeKernelHandle</a>( NewHandle );
02722     }
02723 
02724     *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = NewHandle;
02725 
02726     <span class="comment">//</span>
02727     <span class="comment">//  If the caller had a pointer bias and wanted the new reference object</span>
02728     <span class="comment">//  then return that value</span>
02729     <span class="comment">//</span>
02730 
02731     <span class="keywordflow">if</span> ((ARGUMENT_PRESENT( (PVOID)(ULONG_PTR)ObjectPointerBias )) &amp;&amp;
02732         (ARGUMENT_PRESENT( ReferencedNewObject ))) {
02733 
02734         *ReferencedNewObject = Object;
02735     }
02736 
02737     <span class="comment">//</span>
02738     <span class="comment">//  If we are attached to the system process then return</span>
02739     <span class="comment">//  back to our caller</span>
02740     <span class="comment">//</span>
02741 
02742     <span class="keywordflow">if</span> (AttachedToProcess) {
02743         <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
02744         AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02745     }
02746 
02747     <span class="keywordflow">return</span>( STATUS_SUCCESS );
02748 }
02749 
02750 
02751 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02752"></a><a class="code" href="../../d5/d1/obp_8h.html#a83">02752</a> <a class="code" href="../../d5/d1/obp_8h.html#a83">ObpValidateDesiredAccess</a> (
02753     IN ACCESS_MASK DesiredAccess
02754     )
02755 
02756 <span class="comment">/*++</span>
02757 <span class="comment"></span>
02758 <span class="comment">Routine Description:</span>
02759 <span class="comment"></span>
02760 <span class="comment">    This routine checks the input desired access mask to see that</span>
02761 <span class="comment">    some invalid bits are not set.  The invalid bits are the top</span>
02762 <span class="comment">    two reserved bits and the top three standard rights bits.</span>
02763 <span class="comment">    See \nt\public\sdk\inc\ntseapi.h for more details.</span>
02764 <span class="comment"></span>
02765 <span class="comment">Arguments:</span>
02766 <span class="comment"></span>
02767 <span class="comment">    DesiredAccess - Supplies the mask being checked</span>
02768 <span class="comment"></span>
02769 <span class="comment">Return Value:</span>
02770 <span class="comment"></span>
02771 <span class="comment">    STATUS_ACCESS_DENIED if one or more of the wrongs bits are set and</span>
02772 <span class="comment">    STATUS_SUCCESS otherwise</span>
02773 <span class="comment"></span>
02774 <span class="comment">--*/</span>
02775 
02776 {
02777     <span class="keywordflow">if</span> (DesiredAccess &amp; 0x0CE00000) {
02778 
02779         <span class="keywordflow">return</span>( STATUS_ACCESS_DENIED );
02780 
02781     } <span class="keywordflow">else</span> {
02782 
02783         <span class="keywordflow">return</span>( STATUS_SUCCESS );
02784     }
02785 }
02786 
02787 
02788 <span class="preprocessor">#if i386 &amp;&amp; !FPO</span>
02789 <span class="preprocessor"></span>
02790 <span class="comment">//</span>
02791 <span class="comment">//  The following three variables are just performance counters</span>
02792 <span class="comment">//  for the following two routines</span>
02793 <span class="comment">//</span>
02794 
02795 ULONG ObpXXX1;
02796 ULONG ObpXXX2;
02797 ULONG ObpXXX3;
02798 
02799 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>
02800 ObpComputeGrantedAccessIndex (
02801     ACCESS_MASK GrantedAccess
02802     )
02803 
02804 <span class="comment">/*++</span>
02805 <span class="comment"></span>
02806 <span class="comment">Routine Description:</span>
02807 <span class="comment"></span>
02808 <span class="comment">    This routine takes a granted access and returns and index</span>
02809 <span class="comment">    back to our cache of granted access masks.</span>
02810 <span class="comment"></span>
02811 <span class="comment">Arguments:</span>
02812 <span class="comment"></span>
02813 <span class="comment">    GrantedAccess - Supplies the access mask being added to the cache</span>
02814 <span class="comment"></span>
02815 <span class="comment">Return Value:</span>
02816 <span class="comment"></span>
02817 <span class="comment">    USHORT - returns an index in the cache for the input granted access</span>
02818 <span class="comment"></span>
02819 <span class="comment">--*/</span>
02820 
02821 {
02822     KIRQL OldIrql;
02823     ULONG GrantedAccessIndex, <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
02824     PACCESS_MASK p;
02825 
02826     ObpXXX1 += 1;
02827 
02828     <span class="comment">//</span>
02829     <span class="comment">//  Lock the global data structure</span>
02830     <span class="comment">//</span>
02831 
02832     ExAcquireFastLock( &amp;ObpLock, &amp;OldIrql );
02833 
02834     <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = ObpCurCachedGrantedAccessIndex;
02835     p = ObpCachedGrantedAccesses;
02836 
02837     <span class="comment">//</span>
02838     <span class="comment">//  For each index in our cache look for a match and if found</span>
02839     <span class="comment">//  then unlock the data structure and return that index</span>
02840     <span class="comment">//</span>
02841 
02842     <span class="keywordflow">for</span> (GrantedAccessIndex = 0; GrantedAccessIndex &lt; <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>; GrantedAccessIndex++, p++ ) {
02843 
02844         ObpXXX2 += 1;
02845 
02846         <span class="keywordflow">if</span> (*p == GrantedAccess) {
02847 
02848             ExReleaseFastLock( &amp;ObpLock, OldIrql );
02849             <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)GrantedAccessIndex;
02850         }
02851     }
02852 
02853     <span class="comment">//</span>
02854     <span class="comment">//  We didn't find a match now see if we've maxed out the cache</span>
02855     <span class="comment">//</span>
02856 
02857     <span class="keywordflow">if</span> (ObpCurCachedGrantedAccessIndex == ObpMaxCachedGrantedAccessIndex) {
02858 
02859         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"OB: GrantedAccess cache limit hit.\n"</span> );
02860         DbgBreakPoint();
02861     }
02862 
02863     <span class="comment">//</span>
02864     <span class="comment">//  Set the granted access to the next free slot and increment the</span>
02865     <span class="comment">//  number used in the cache, release the lock, and return the</span>
02866     <span class="comment">//  new index to our caller</span>
02867     <span class="comment">//</span>
02868 
02869     *p = GrantedAccess;
02870     ObpCurCachedGrantedAccessIndex += 1;
02871 
02872     ExReleaseFastLock( &amp;ObpLock, OldIrql );
02873 
02874     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)GrantedAccessIndex;
02875 }
02876 
02877 ACCESS_MASK
02878 ObpTranslateGrantedAccessIndex (
02879     USHORT GrantedAccessIndex
02880     )
02881 
02882 <span class="comment">/*++</span>
02883 <span class="comment"></span>
02884 <span class="comment">Routine Description:</span>
02885 <span class="comment"></span>
02886 <span class="comment">    This routine takes as input a cache index and returns</span>
02887 <span class="comment">    the corresponding granted access mask</span>
02888 <span class="comment"></span>
02889 <span class="comment">Arguments:</span>
02890 <span class="comment"></span>
02891 <span class="comment">    GrantedAccessIndex - Supplies the cache index to look up</span>
02892 <span class="comment"></span>
02893 <span class="comment">Return Value:</span>
02894 <span class="comment"></span>
02895 <span class="comment">    ACCESS_MASK - Returns the corresponding desired access mask</span>
02896 <span class="comment"></span>
02897 <span class="comment">--*/</span>
02898 
02899 {
02900     KIRQL OldIrql;
02901     ACCESS_MASK GrantedAccess = (ACCESS_MASK)0;
02902 
02903     ObpXXX3 += 1;
02904 
02905     <span class="comment">//</span>
02906     <span class="comment">//  Lock the global data structure</span>
02907     <span class="comment">//</span>
02908 
02909     ExAcquireFastLock( &amp;ObpLock, &amp;OldIrql );
02910 
02911     <span class="comment">//</span>
02912     <span class="comment">//  If the input index is within bounds then get the granted</span>
02913     <span class="comment">//  access</span>
02914     <span class="comment">//</span>
02915 
02916     <span class="keywordflow">if</span> (GrantedAccessIndex &lt; ObpCurCachedGrantedAccessIndex) {
02917 
02918         GrantedAccess = ObpCachedGrantedAccesses[ GrantedAccessIndex ];
02919     }
02920 
02921     <span class="comment">//</span>
02922     <span class="comment">//  Release the lock and return the granted access to our caller</span>
02923     <span class="comment">//</span>
02924 
02925     ExReleaseFastLock( &amp;ObpLock, OldIrql );
02926 
02927     <span class="keywordflow">return</span> GrantedAccess;
02928 }
02929 
02930 <span class="preprocessor">#endif // i386 &amp;&amp; !FPO</span>
02931 <span class="preprocessor"></span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:05 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
