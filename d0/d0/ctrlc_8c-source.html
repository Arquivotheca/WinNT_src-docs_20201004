<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ctrlc.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ctrlc.c</h1><a href="../../d9/d0/ctrlc_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    ctrlc.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements ctrl-c handling</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Therese Stowell (thereses) 1-Mar-1991</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:   </span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d4/d3/w32_2ntcon_2client_2precomp_8h.html">precomp.h</a>"</span>
00022 <span class="preprocessor">#pragma hdrstop</span>
00023 <span class="preprocessor"></span>
00024 <span class="preprocessor">#if !defined(BUILD_WOW64)</span>
00025 <span class="preprocessor"></span>
<a name="l00026"></a><a class="code" href="../../d9/d0/ctrlc_8c.html#a0">00026</a> <span class="preprocessor">#define LIST_INCREMENT 2    // amount to grow handler list</span>
<a name="l00027"></a><a class="code" href="../../d9/d0/ctrlc_8c.html#a1">00027</a> <span class="preprocessor"></span><span class="preprocessor">#define INITIAL_LIST_SIZE 1 // initial length of handler list</span>
00028 <span class="preprocessor"></span>
<a name="l00029"></a><a class="code" href="../../d9/d0/ctrlc_8c.html#a5">00029</a> PHANDLER_ROUTINE <a class="code" href="../../d9/d0/ctrlc_8c.html#a5">SingleHandler</a>[<a class="code" href="../../d9/d0/ctrlc_8c.html#a1">INITIAL_LIST_SIZE</a>]; <span class="comment">// initial handler list</span>
<a name="l00030"></a><a class="code" href="../../d9/d0/ctrlc_8c.html#a6">00030</a> ULONG <a class="code" href="../../d9/d0/ctrlc_8c.html#a6">HandlerListLength</a>;            <span class="comment">// used length of handler list</span>
<a name="l00031"></a><a class="code" href="../../d9/d0/ctrlc_8c.html#a7">00031</a> ULONG <a class="code" href="../../d9/d0/ctrlc_8c.html#a7">AllocatedHandlerListLength</a>;   <span class="comment">// allocated length of handler list</span>
<a name="l00032"></a><a class="code" href="../../d9/d0/ctrlc_8c.html#a8">00032</a> PHANDLER_ROUTINE *<a class="code" href="../../d9/d0/ctrlc_8c.html#a8">HandlerList</a>;      <span class="comment">// pointer to handler list</span>
00033 
<a name="l00034"></a><a class="code" href="../../d9/d0/ctrlc_8c.html#a2">00034</a> <span class="preprocessor">#define NUMBER_OF_CTRL_EVENTS 7     // number of ctrl events</span>
<a name="l00035"></a><a class="code" href="../../d9/d0/ctrlc_8c.html#a3">00035</a> <span class="preprocessor"></span><span class="preprocessor">#define SYSTEM_CLOSE_EVENT 4</span>
00036 <span class="preprocessor"></span>
<a name="l00037"></a><a class="code" href="../../d9/d0/ctrlc_8c.html#a4">00037</a> <span class="preprocessor">#define IGNORE_CTRL_C   0x01</span>
00038 <span class="preprocessor"></span>
<a name="l00039"></a><a class="code" href="../../d9/d0/ctrlc_8c.html#a9">00039</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d0/ctrlc_8c.html#a9">LastConsoleEventActive</a>;
00040 
00041 
00042 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00043"></a><a class="code" href="../../d9/d0/ctrlc_8c.html#a10">00043</a> <a class="code" href="../../d9/d0/ctrlc_8c.html#a10">DefaultHandler</a>(
00044     IN ULONG CtrlType
00045     )
00046 
00047 <span class="comment">/*++</span>
00048 <span class="comment"></span>
00049 <span class="comment">    This is the default ctrl handler.</span>
00050 <span class="comment"></span>
00051 <span class="comment">Parameters:</span>
00052 <span class="comment"></span>
00053 <span class="comment">    CtrlType - type of ctrl event (ctrl-c, ctrl-break).</span>
00054 <span class="comment"></span>
00055 <span class="comment">Return Value:</span>
00056 <span class="comment"></span>
00057 <span class="comment">    none.</span>
00058 <span class="comment"></span>
00059 <span class="comment">--*/</span>
00060 
00061 {
00062     ExitProcess((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)CONTROL_C_EXIT);
00063     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00064     UNREFERENCED_PARAMETER(CtrlType);
00065 }
00066 
00067 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00068"></a><a class="code" href="../../d9/d0/ctrlc_8c.html#a11">00068</a> <a class="code" href="../../d9/d0/ctrlc_8c.html#a11">InitializeCtrlHandling</a>( VOID )
00069 
00070 <span class="comment">/*++</span>
00071 <span class="comment"></span>
00072 <span class="comment">    This routine initializes ctrl handling.  It is called by AllocConsole</span>
00073 <span class="comment">    and the dll initialization code.</span>
00074 <span class="comment"></span>
00075 <span class="comment">Parameters:</span>
00076 <span class="comment"></span>
00077 <span class="comment">    none.</span>
00078 <span class="comment"></span>
00079 <span class="comment">Return Value:</span>
00080 <span class="comment"></span>
00081 <span class="comment">    none.</span>
00082 <span class="comment"></span>
00083 <span class="comment">--*/</span>
00084 
00085 {
00086     <a class="code" href="../../d9/d0/ctrlc_8c.html#a7">AllocatedHandlerListLength</a> = <a class="code" href="../../d9/d0/ctrlc_8c.html#a6">HandlerListLength</a> = <a class="code" href="../../d9/d0/ctrlc_8c.html#a1">INITIAL_LIST_SIZE</a>;
00087     <a class="code" href="../../d9/d0/ctrlc_8c.html#a8">HandlerList</a> = <a class="code" href="../../d9/d0/ctrlc_8c.html#a5">SingleHandler</a>;
00088     <a class="code" href="../../d9/d0/ctrlc_8c.html#a5">SingleHandler</a>[0] = <a class="code" href="../../d9/d0/ctrlc_8c.html#a10">DefaultHandler</a>;
00089     <span class="keywordflow">return</span> STATUS_SUCCESS;
00090 }
00091 
00092 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
<a name="l00093"></a><a class="code" href="../../d8/d9/dllinit_8c.html#a8">00093</a> <a class="code" href="../../d8/d9/dllinit_8c.html#a8">CtrlRoutine</a>(
00094     IN LPVOID lpThreadParameter
00095     )
00096 
00097 <span class="comment">/*++</span>
00098 <span class="comment"></span>
00099 <span class="comment">Routine Description:</span>
00100 <span class="comment"></span>
00101 <span class="comment">    This thread is created when ctrl-c or ctrl-break is entered,</span>
00102 <span class="comment">    or when close is selected.  it calls the appropriate handlers.</span>
00103 <span class="comment"></span>
00104 <span class="comment">Arguments:</span>
00105 <span class="comment"></span>
00106 <span class="comment">    lpThreadParameter - what type of event happened.</span>
00107 <span class="comment"></span>
00108 <span class="comment">Return Value:</span>
00109 <span class="comment"></span>
00110 <span class="comment">    STATUS_SUCCESS</span>
00111 <span class="comment"></span>
00112 <span class="comment">--*/</span>
00113 
00114 {
00115     ULONG i;
00116     ULONG EventNumber,OriginalEventNumber;
00117     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> fNoExit;
00118     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwExitCode;
00119     EXCEPTION_RECORD ExceptionRecord;
00120 
00121     SetThreadPriority(NtCurrentThread(), THREAD_PRIORITY_HIGHEST);
00122     OriginalEventNumber = EventNumber = PtrToUlong(lpThreadParameter);
00123 
00124     <span class="comment">//</span>
00125     <span class="comment">// If this bit is set, it means we don't want to cause this process</span>
00126     <span class="comment">// to exit itself if it is a logoff or shutdown event.</span>
00127     <span class="comment">//</span>
00128     fNoExit = 0x80000000 &amp; EventNumber;
00129     EventNumber &amp;= ~0x80000000;
00130 
00131     <span class="comment">//</span>
00132     <span class="comment">// the ctrl_close event is set when the user selects the window</span>
00133     <span class="comment">// close option from the system menu, or EndTask, or Settings-Terminate.</span>
00134     <span class="comment">// the system close event is used when another ctrl-thread times out.</span>
00135     <span class="comment">//</span>
00136 
00137     <span class="keywordflow">switch</span> (EventNumber) {
00138     <span class="keywordflow">default</span>:
00139         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (EventNumber &lt; <a class="code" href="../../d9/d0/ctrlc_8c.html#a2">NUMBER_OF_CTRL_EVENTS</a>);
00140         <span class="keywordflow">if</span> (EventNumber &gt;= <a class="code" href="../../d9/d0/ctrlc_8c.html#a2">NUMBER_OF_CTRL_EVENTS</a>)
00141             <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)STATUS_UNSUCCESSFUL;
00142         <span class="keywordflow">break</span>;
00143 
00144     <span class="keywordflow">case</span> CTRL_C_EVENT:
00145     <span class="keywordflow">case</span> CTRL_BREAK_EVENT:
00146         <span class="comment">//</span>
00147         <span class="comment">// If the process is being debugged, give the debugger</span>
00148         <span class="comment">// a shot. If the debugger handles the exception, then</span>
00149         <span class="comment">// go back and wait.</span>
00150         <span class="comment">//</span>
00151 
00152         <span class="keywordflow">if</span> (!IsDebuggerPresent())
00153             <span class="keywordflow">break</span>;
00154 
00155         <span class="keywordflow">if</span> ( EventNumber == CTRL_C_EVENT ) {
00156             ExceptionRecord.ExceptionCode = DBG_CONTROL_C;
00157             }
00158         <span class="keywordflow">else</span> {
00159             ExceptionRecord.ExceptionCode = DBG_CONTROL_BREAK;
00160             }
00161         ExceptionRecord.ExceptionFlags = 0;
00162         ExceptionRecord.ExceptionRecord = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00163         ExceptionRecord.ExceptionAddress = (PVOID)<a class="code" href="../../d9/d0/ctrlc_8c.html#a10">DefaultHandler</a>;
00164         ExceptionRecord.NumberParameters = 0;
00165 
00166         <span class="keywordflow">try</span> {
00167             <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a9">RtlRaiseException</a>(&amp;ExceptionRecord);
00168         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00169             <a class="code" href="../../d6/d4/condll_8h.html#a9">LockDll</a>();
00170             <span class="keywordflow">try</span> {
00171                 <span class="keywordflow">if</span> (EventNumber != CTRL_C_EVENT ||
00172                         NtCurrentPeb()-&gt;ProcessParameters-&gt;ConsoleFlags != <a class="code" href="../../d9/d0/ctrlc_8c.html#a4">IGNORE_CTRL_C</a>) {
00173                     <span class="keywordflow">for</span> (i=<a class="code" href="../../d9/d0/ctrlc_8c.html#a6">HandlerListLength</a>;i&gt;0;i--) {
00174                         <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d0/ctrlc_8c.html#a8">HandlerList</a>[i-1])(EventNumber)) {
00175                             <span class="keywordflow">break</span>;
00176                         }
00177                     }
00178                 }
00179             } finally {
00180                 <a class="code" href="../../d6/d4/condll_8h.html#a10">UnlockDll</a>();
00181             }
00182         }
00183         ExitThread(0);
00184         <span class="keywordflow">break</span>;
00185 
00186     <span class="keywordflow">case</span> <a class="code" href="../../d9/d0/ctrlc_8c.html#a3">SYSTEM_CLOSE_EVENT</a>:
00187         ExitProcess((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)CONTROL_C_EXIT);
00188         <span class="keywordflow">break</span>;
00189 
00190     <span class="keywordflow">case</span> SYSTEM_ROOT_CONSOLE_EVENT:
00191         <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/ctrlc_8c.html#a9">LastConsoleEventActive</a>)
00192             ExitThread(0);
00193         <span class="keywordflow">break</span>;
00194 
00195     <span class="keywordflow">case</span> CTRL_CLOSE_EVENT:
00196     <span class="keywordflow">case</span> CTRL_LOGOFF_EVENT:
00197     <span class="keywordflow">case</span> CTRL_SHUTDOWN_EVENT:
00198         <span class="comment">//if (LastConsoleEventActive)</span>
00199             <span class="comment">//EventNumber = SYSTEM_ROOT_CONSOLE_EVENT;</span>
00200         <span class="keywordflow">break</span>;
00201     }
00202 
00203     <a class="code" href="../../d6/d4/condll_8h.html#a9">LockDll</a>();
00204     dwExitCode = 0;
00205     <span class="keywordflow">try</span> {
00206         <span class="keywordflow">if</span> (EventNumber != CTRL_C_EVENT ||
00207                 NtCurrentPeb()-&gt;ProcessParameters-&gt;ConsoleFlags != <a class="code" href="../../d9/d0/ctrlc_8c.html#a4">IGNORE_CTRL_C</a>) {
00208             <span class="keywordflow">for</span> (i=<a class="code" href="../../d9/d0/ctrlc_8c.html#a6">HandlerListLength</a>;i&gt;0;i--) {
00209 
00210                 <span class="comment">//</span>
00211                 <span class="comment">// Don't call the last handler (the default one which calls</span>
00212                 <span class="comment">// ExitProcess() if this process isn't supposed to exit (system</span>
00213                 <span class="comment">// process are not supposed to exit because of shutdown or</span>
00214                 <span class="comment">// logoff event notification).</span>
00215                 <span class="comment">//</span>
00216 
00217                 <span class="keywordflow">if</span> ((i-1) == 0 &amp;&amp; fNoExit) {
00218                     <span class="keywordflow">if</span> (EventNumber == CTRL_LOGOFF_EVENT ||
00219                         EventNumber == CTRL_SHUTDOWN_EVENT) {
00220                         <span class="keywordflow">break</span>;
00221                     }
00222                 }
00223 
00224                 <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d0/ctrlc_8c.html#a8">HandlerList</a>[i-1])(EventNumber)) {
00225                     <span class="keywordflow">switch</span> (EventNumber) {
00226                     <span class="keywordflow">case</span> CTRL_CLOSE_EVENT:
00227                     <span class="keywordflow">case</span> CTRL_LOGOFF_EVENT:
00228                     <span class="keywordflow">case</span> CTRL_SHUTDOWN_EVENT:
00229                     <span class="keywordflow">case</span> SYSTEM_ROOT_CONSOLE_EVENT:
00230                         dwExitCode = OriginalEventNumber;
00231                         <span class="keywordflow">break</span>;
00232                     }
00233                     <span class="keywordflow">break</span>;
00234                 }
00235             }
00236         }
00237     } finally {
00238         <a class="code" href="../../d6/d4/condll_8h.html#a10">UnlockDll</a>();
00239     }
00240     ExitThread(dwExitCode);
00241     <span class="keywordflow">return</span> STATUS_SUCCESS;
00242 }
00243 
00244 <span class="preprocessor">#endif </span>
00245 <span class="preprocessor"></span>
00246 <span class="preprocessor"></span><span class="preprocessor">#if !defined(BUILD_WOW6432)</span>
00247 <span class="preprocessor"></span>
00248 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00249 <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a>
<a name="l00250"></a><a class="code" href="../../d9/d0/ctrlc_8c.html#a13">00250</a> <a class="code" href="../../d9/d0/ctrlc_8c.html#a13">SetLastConsoleEventActiveInternal</a>( VOID )
00251 
00252 <span class="comment">/*++</span>
00253 <span class="comment"></span>
00254 <span class="comment">Routine Description:</span>
00255 <span class="comment"></span>
00256 <span class="comment">    Sends a ConsolepNotifyLastClose command to the server.</span>
00257 <span class="comment"></span>
00258 <span class="comment">Arguments:</span>
00259 <span class="comment"></span>
00260 <span class="comment">    none.</span>
00261 <span class="comment"></span>
00262 <span class="comment">Return Value:</span>
00263 <span class="comment"></span>
00264 <span class="comment">    None.</span>
00265 <span class="comment"></span>
00266 <span class="comment">--*/</span>
00267 
00268 {
00269     <a class="code" href="../../d5/d9/struct__CONSOLE__API__MSG.html">CONSOLE_API_MSG</a> m;
00270     <a class="code" href="../../d8/d3/struct__CONSOLE__NOTIFYLASTCLOSE__MSG.html">PCONSOLE_NOTIFYLASTCLOSE_MSG</a> a = &amp;m.<a class="code" href="../../d5/d9/struct__CONSOLE__API__MSG.html#o77">u</a>.SetLastConsoleEventActive;
00271 
00272     a-&gt;<a class="code" href="../../d8/d3/struct__CONSOLE__NOTIFYLASTCLOSE__MSG.html#o0">ConsoleHandle</a> = <a class="code" href="../../d6/d4/condll_8h.html#a1">GET_CONSOLE_HANDLE</a>;
00273     <a class="code" href="../../d8/d9/wow64csr_8c.html#a4">CsrClientCallServer</a>( (PCSR_API_MSG)&amp;m,
00274                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00275                          CSR_MAKE_API_NUMBER( CONSRV_SERVERDLL_INDEX,
00276                                               <a class="code" href="../../d5/d5/conmsg_8h.html#a236a230">ConsolepNotifyLastClose</a>
00277                                             ),
00278                          <span class="keyword">sizeof</span>( *a )
00279                        );
00280 }
00281 
00282 <span class="preprocessor">#endif </span>
00283 <span class="preprocessor"></span>
00284 <span class="preprocessor"></span><span class="preprocessor">#if !defined(BUILD_WOW64)</span>
00285 <span class="preprocessor"></span>
00286 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00287 <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a>
<a name="l00288"></a><a class="code" href="../../d9/d0/ctrlc_8c.html#a14">00288</a> <a class="code" href="../../d9/d0/ctrlc_8c.html#a14">SetLastConsoleEventActive</a>( VOID )
00289 <span class="comment">// private api</span>
00290 {
00291 
00292     <a class="code" href="../../d9/d0/ctrlc_8c.html#a9">LastConsoleEventActive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00293     <a class="code" href="../../d9/d0/ctrlc_8c.html#a13">SetLastConsoleEventActiveInternal</a>();
00294 }
00295 
00296 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00297"></a><a class="code" href="../../d9/d0/ctrlc_8c.html#a15">00297</a> <a class="code" href="../../d9/d0/ctrlc_8c.html#a15">SetCtrlHandler</a>(
00298     IN PHANDLER_ROUTINE HandlerRoutine
00299     )
00300 
00301 <span class="comment">/*++</span>
00302 <span class="comment"></span>
00303 <span class="comment">Routine Description:</span>
00304 <span class="comment"></span>
00305 <span class="comment">    This routine adds a ctrl handler to the process's list.</span>
00306 <span class="comment"></span>
00307 <span class="comment">Arguments:</span>
00308 <span class="comment"></span>
00309 <span class="comment">    HandlerRoutine - pointer to ctrl handler.</span>
00310 <span class="comment"></span>
00311 <span class="comment">Return Value:</span>
00312 <span class="comment"></span>
00313 <span class="comment">    TRUE - success.</span>
00314 <span class="comment"></span>
00315 <span class="comment">--*/</span>
00316 
00317 {
00318     PHANDLER_ROUTINE *NewHandlerList;
00319 
00320     <span class="comment">//</span>
00321     <span class="comment">// NULL handler routine is not stored in table. It is</span>
00322     <span class="comment">// used to temporarily inhibit ^C event handling</span>
00323     <span class="comment">//</span>
00324 
00325     <span class="keywordflow">if</span> ( !HandlerRoutine ) {
00326         NtCurrentPeb()-&gt;ProcessParameters-&gt;ConsoleFlags = <a class="code" href="../../d9/d0/ctrlc_8c.html#a4">IGNORE_CTRL_C</a>;
00327         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00328         }
00329 
00330     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/ctrlc_8c.html#a6">HandlerListLength</a> == <a class="code" href="../../d9/d0/ctrlc_8c.html#a7">AllocatedHandlerListLength</a>) {
00331 
00332         <span class="comment">//</span>
00333         <span class="comment">// grow list</span>
00334         <span class="comment">//</span>
00335 
00336         NewHandlerList = (PHANDLER_ROUTINE *) <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( RtlProcessHeap(), 0,
00337                                                  <span class="keyword">sizeof</span>(PHANDLER_ROUTINE) * (<a class="code" href="../../d9/d0/ctrlc_8c.html#a6">HandlerListLength</a> + <a class="code" href="../../d9/d0/ctrlc_8c.html#a0">LIST_INCREMENT</a>));
00338         <span class="keywordflow">if</span> (!NewHandlerList) {
00339             <a class="code" href="../../d6/d4/condll_8h.html#a2">SET_LAST_ERROR</a>(ERROR_NOT_ENOUGH_MEMORY);
00340             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00341         }
00342 
00343         <span class="comment">//</span>
00344         <span class="comment">// copy list</span>
00345         <span class="comment">//</span>
00346 
00347         RtlCopyMemory(NewHandlerList,<a class="code" href="../../d9/d0/ctrlc_8c.html#a8">HandlerList</a>,<span class="keyword">sizeof</span>(PHANDLER_ROUTINE) * <a class="code" href="../../d9/d0/ctrlc_8c.html#a6">HandlerListLength</a>);
00348 
00349         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/ctrlc_8c.html#a8">HandlerList</a> != <a class="code" href="../../d9/d0/ctrlc_8c.html#a5">SingleHandler</a>) {
00350 
00351             <span class="comment">//</span>
00352             <span class="comment">// free old list</span>
00353             <span class="comment">//</span>
00354 
00355             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, <a class="code" href="../../d9/d0/ctrlc_8c.html#a8">HandlerList</a>);
00356         }
00357         <a class="code" href="../../d9/d0/ctrlc_8c.html#a8">HandlerList</a> = NewHandlerList;
00358         <a class="code" href="../../d9/d0/ctrlc_8c.html#a7">AllocatedHandlerListLength</a> += <a class="code" href="../../d9/d0/ctrlc_8c.html#a0">LIST_INCREMENT</a>;
00359     }
00360     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d9/d0/ctrlc_8c.html#a6">HandlerListLength</a> &lt; <a class="code" href="../../d9/d0/ctrlc_8c.html#a7">AllocatedHandlerListLength</a>);
00361 
00362     <a class="code" href="../../d9/d0/ctrlc_8c.html#a8">HandlerList</a>[<a class="code" href="../../d9/d0/ctrlc_8c.html#a6">HandlerListLength</a>] = HandlerRoutine;
00363     <a class="code" href="../../d9/d0/ctrlc_8c.html#a6">HandlerListLength</a>++;
00364     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00365 }
00366 
00367 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00368"></a><a class="code" href="../../d9/d0/ctrlc_8c.html#a16">00368</a> <a class="code" href="../../d9/d0/ctrlc_8c.html#a16">RemoveCtrlHandler</a>(
00369     IN PHANDLER_ROUTINE HandlerRoutine
00370     )
00371 
00372 <span class="comment">/*++</span>
00373 <span class="comment"></span>
00374 <span class="comment">Routine Description:</span>
00375 <span class="comment"></span>
00376 <span class="comment">    This routine removes a ctrl handler from the process's list.</span>
00377 <span class="comment"></span>
00378 <span class="comment">Arguments:</span>
00379 <span class="comment"></span>
00380 <span class="comment">    HandlerRoutine - pointer to ctrl handler.</span>
00381 <span class="comment"></span>
00382 <span class="comment">Return Value:</span>
00383 <span class="comment"></span>
00384 <span class="comment">    TRUE - success.</span>
00385 <span class="comment"></span>
00386 <span class="comment">--*/</span>
00387 
00388 {
00389     ULONG i;
00390 
00391     <span class="comment">//</span>
00392     <span class="comment">// NULL handler routine is not stored in table. It is</span>
00393     <span class="comment">// used to temporarily inhibit ^C event handling. Removing</span>
00394     <span class="comment">// this handler allows normal processing to occur</span>
00395     <span class="comment">//</span>
00396 
00397     <span class="keywordflow">if</span> ( !HandlerRoutine ) {
00398         NtCurrentPeb()-&gt;ProcessParameters-&gt;ConsoleFlags = 0;
00399         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00400         }
00401 
00402     <span class="keywordflow">for</span> (i=0;i&lt;<a class="code" href="../../d9/d0/ctrlc_8c.html#a6">HandlerListLength</a>;i++) {
00403         <span class="keywordflow">if</span> (*(<a class="code" href="../../d9/d0/ctrlc_8c.html#a8">HandlerList</a>+i) == HandlerRoutine) {
00404             <span class="keywordflow">if</span> (i &lt; (<a class="code" href="../../d9/d0/ctrlc_8c.html#a6">HandlerListLength</a>-1)) {
00405                 memmove(&amp;<a class="code" href="../../d9/d0/ctrlc_8c.html#a8">HandlerList</a>[i],&amp;<a class="code" href="../../d9/d0/ctrlc_8c.html#a8">HandlerList</a>[i+1],<span class="keyword">sizeof</span>(PHANDLER_ROUTINE) * (<a class="code" href="../../d9/d0/ctrlc_8c.html#a6">HandlerListLength</a> - i - 1));
00406             }
00407             <a class="code" href="../../d9/d0/ctrlc_8c.html#a6">HandlerListLength</a> -= 1;
00408             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00409         }
00410     }
00411     <a class="code" href="../../d6/d4/condll_8h.html#a2">SET_LAST_ERROR</a>(ERROR_INVALID_PARAMETER);
00412     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00413 }
00414 
00415 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00416 <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a>
<a name="l00417"></a><a class="code" href="../../d9/d0/ctrlc_8c.html#a17">00417</a> <a class="code" href="../../d9/d0/ctrlc_8c.html#a17">SetConsoleCtrlHandler</a>(
00418     IN PHANDLER_ROUTINE HandlerRoutine,
00419     IN BOOL Add       <span class="comment">// add or delete</span>
00420     )
00421 
00422 <span class="comment">/*++</span>
00423 <span class="comment"></span>
00424 <span class="comment">Routine Description:</span>
00425 <span class="comment"></span>
00426 <span class="comment">    This routine adds or removes a ctrl handler from the process's list.</span>
00427 <span class="comment"></span>
00428 <span class="comment">Arguments:</span>
00429 <span class="comment"></span>
00430 <span class="comment">    HandlerRoutine - pointer to ctrl handler.</span>
00431 <span class="comment"></span>
00432 <span class="comment">    Add - if TRUE, add handler.  else remove.</span>
00433 <span class="comment"></span>
00434 <span class="comment">Return Value:</span>
00435 <span class="comment"></span>
00436 <span class="comment">    TRUE - success.</span>
00437 <span class="comment"></span>
00438 <span class="comment">--*/</span>
00439 
00440 {
00441     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> Success;
00442 
00443     <a class="code" href="../../d6/d4/condll_8h.html#a9">LockDll</a>();
00444     <span class="keywordflow">if</span> (Add) {
00445         Success = <a class="code" href="../../d9/d0/ctrlc_8c.html#a15">SetCtrlHandler</a>(HandlerRoutine);
00446     }
00447     <span class="keywordflow">else</span> {
00448         Success = <a class="code" href="../../d9/d0/ctrlc_8c.html#a16">RemoveCtrlHandler</a>(HandlerRoutine);
00449     }
00450     <a class="code" href="../../d6/d4/condll_8h.html#a10">UnlockDll</a>();
00451     <span class="keywordflow">return</span> Success;
00452 }
00453 
00454 <span class="preprocessor">#endif </span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:37 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
