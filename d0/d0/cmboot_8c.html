<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmboot.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmboot.c File Reference</h1><code>#include "<a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>"</code><br>
<code>#include &lt;<a class="el" href="../../d7/d6/profiles_8h-source.html">profiles.h</a>&gt;</code><br>

<p>
<a href="../../d1/d9/cmboot_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d0/cmboot_8c.html#a0">LOAD_LAST</a>&nbsp;&nbsp;&nbsp;0xffffffff</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d0/cmboot_8c.html#a1">LOAD_NEXT_TO_LAST</a>&nbsp;&nbsp;&nbsp;(LOAD_LAST-1)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(<a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, Value, realsize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d0/cmboot_8c.html#a3">TempAlias</a>&nbsp;&nbsp;&nbsp;AliasList-&gt;Alias[i]</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d0/cmboot_8c.html#a4">CmpAddDriverToList</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> DriverCell, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> GroupOrderCell, IN PUNICODE_STRING RegistryPath, IN PLIST_ENTRY BootDriverListHead)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d0/cmboot_8c.html#a5">CmpDoSort</a> (IN PLIST_ENTRY DriverListHead, IN PUNICODE_STRING OrderList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d0/cmboot_8c.html#a6">CmpFindTagIndex</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> TagCell, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> GroupOrderCell, IN PUNICODE_STRING GroupName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d0/cmboot_8c.html#a7">CmpIsLoadType</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, IN SERVICE_LOAD_TYPE LoadType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d0/cmboot_8c.html#a8">CmpOrderGroup</a> (IN <a class="el" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">PBOOT_DRIVER_NODE</a> GroupStart, IN <a class="el" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">PBOOT_DRIVER_NODE</a> GroupEnd)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d0/cmboot_8c.html#a9">BlPrint</a> (PCHAR cp,...)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d0/cmboot_8c.html#a10">CmpFindNLSData</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ControlSet, OUT PUNICODE_STRING AnsiFilename, OUT PUNICODE_STRING OemFilename, OUT PUNICODE_STRING CaseTableFilename, OUT PUNICODE_STRING OemHalFont)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d0/cmboot_8c.html#a11">CmpFindDrivers</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ControlSet, IN SERVICE_LOAD_TYPE LoadType, IN PWSTR BootFileSystem OPTIONAL, IN PLIST_ENTRY DriverListHead)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d0/cmboot_8c.html#a12">CmpSortDriverList</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ControlSet, IN PLIST_ENTRY DriverListHead)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d0/cmboot_8c.html#a13">CmpResolveDriverDependencies</a> (IN PLIST_ENTRY DriverListHead)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d0/cmboot_8c.html#a14">CmpFindControlSet</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> SystemHive, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> RootCell, IN PUNICODE_STRING SelectName, OUT PBOOLEAN AutoSelect)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d0/cmboot_8c.html#a15">CmpSetCurrentProfile</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ControlSet, IN <a class="el" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html">PCM_HARDWARE_PROFILE</a> Profile)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d0/cmboot_8c.html#a16">CmpFindProfileOption</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> SystemHive, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ControlSet, OUT OPTIONAL <a class="el" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">PCM_HARDWARE_PROFILE_LIST</a> *ReturnedProfileList, OUT OPTIONAL <a class="el" href="../../d9/d3/struct__CM__HARDWARE__PROFILE__ALIAS__LIST.html">PCM_HARDWARE_PROFILE_ALIAS_LIST</a> *ReturnedAliasList, OUT OPTIONAL PULONG ProfileTimeout)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a2" doxytag="cmboot.c::CmpValueToData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpValueToData          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Value,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>realsize&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(<a class="code" href="../../d9/d0/cmdata_8h.html#a38">CmpIsHKeyValueSmall</a>(realsize,Value-&gt;DataLength) ?          \
     ((<span class="keyword">struct </span><a class="code" href="../../d4/d9/struct__CELL__DATA.html">_CELL_DATA</a> *)(&amp;Value-&gt;Data)) : <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,Value-&gt;Data))
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00078">78</a> of file <a class="el" href="../../d1/d9/cmboot_8c-source.html">cmboot.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00538">CmpAddDriverToList()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01082">CmpFindControlSet()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00108">CmpFindNLSData()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01284">CmpFindProfileOption()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01693">CmpFindTagIndex()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00473">CmpIsLoadType()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01221">CmpSetCurrentProfile()</a>, and <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00744">CmpSortDriverList()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="cmboot.c::LOAD_LAST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LOAD_LAST&nbsp;&nbsp;&nbsp;0xffffffff          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00036">36</a> of file <a class="el" href="../../d1/d9/cmboot_8c-source.html">cmboot.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00538">CmpAddDriverToList()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="cmboot.c::LOAD_NEXT_TO_LAST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LOAD_NEXT_TO_LAST&nbsp;&nbsp;&nbsp;(LOAD_LAST-1)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00037">37</a> of file <a class="el" href="../../d1/d9/cmboot_8c-source.html">cmboot.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01693">CmpFindTagIndex()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="cmboot.c::TempAlias" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define TempAlias&nbsp;&nbsp;&nbsp;AliasList-&gt;Alias[i]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01284">CmpFindProfileOption()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a9" doxytag="cmboot.c::BlPrint" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID BlPrint           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>cp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>&nbsp;</td>
          <td class="mdname" nowrap> <em>...</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="cmboot.c::CmpAddDriverToList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpAddDriverToList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>GroupOrderCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>RegistryPath</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>BootDriverListHead</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00538">538</a> of file <a class="el" href="../../d1/d9/cmboot_8c-source.html">cmboot.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00597">_HHIVE::Allocate</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00121">CmpCompressedNameSize()</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00151">CmpCopyCompressedName()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01693">CmpFindTagIndex()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01243">CmpFindValueByName</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00078">CmpValueToData</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00067">DriverEntry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00456">_BOOT_DRIVER_NODE::ErrorControl</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00453">_BOOT_DRIVER_NODE::Group</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00440">KEY_COMP_NAME</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00452">_BOOT_DRIVER_NODE::ListEntry</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00036">LOAD_LAST</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00477">_CM_KEY_NODE::Name</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00454">_BOOT_DRIVER_NODE::Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00475">_CM_KEY_NODE::NameLength</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00107">PHCELL_INDEX</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01883">RtlAppendUnicodeStringToString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01821">RtlAppendUnicodeToString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00455">_BOOT_DRIVER_NODE::Tag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00333">CmpFindDrivers()</a>.
<p>
<pre class="fragment"><div>00548                    :
00549 
00550     This routine allocates a list entry node <span class="keywordflow">for</span> a particular driver.
00551     It initializes <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>, filename, group name, and
00552     dependency list.  Finally, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> inserts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> node into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> boot
00553     driver list.
00554 
00555     Note that <span class="keyword">this</span> routine allocates memory by calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>'s
00556     memory allocation <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a>.
00557 
00558 Arguments:
00559 
00560     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure
00561 
00562     DriverCell - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver's node in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive.
00563 
00564     GroupOrderCell - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> GroupOrderList key.
00565         ( \Registry\Machine\System\CurrentControlSet\Control\GroupOrderList )
00566 
00567     RegistryPath - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SERVICES node
00568             of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> set.
00569 
00570     BootDriverListHead - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> head of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> boot driver list
00571 
00572 Return Value:
00573 
00574     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - Driver successfully added to boot driver list.
00575 
00576     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - Could not add driver to boot driver list.
00577 
00578 --*/
00579 
00580 {
00581     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Driver;
00582     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> DriverNameLength;
00583     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> Value;
00584     <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">PBOOT_DRIVER_NODE</a> DriverNode;
00585     <a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html">PBOOT_DRIVER_LIST_ENTRY</a> <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>;
00586     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ValueCell;
00587     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Tag;
00588     UNICODE_STRING UnicodeString;
00589     PUNICODE_STRING <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>;
00590     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00591     ULONG Length;
00592     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00593     ULONG   realsize;
00594 
00595     Driver = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, DriverCell);
00596     DriverNode = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">BOOT_DRIVER_NODE</a>),<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00597     <span class="keywordflow">if</span> (DriverNode == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00598         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00599     }
00600     <span class="keywordflow">if</span> (Driver-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>) {
00601         DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o2">Name</a>.Length = <a class="code" href="../../d1/d2/cmp_8h.html#a320">CmpCompressedNameSize</a>(Driver-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,Driver-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
00602         DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o2">Name</a>.Buffer = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o2">Name</a>.Length, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00603         <span class="keywordflow">if</span> (DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o2">Name</a>.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00604             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00605         }
00606         <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o2">Name</a>.Buffer,
00607                               DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o2">Name</a>.Length,
00608                               Driver-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
00609                               Driver-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
00610 
00611     } <span class="keywordflow">else</span> {
00612         DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o2">Name</a>.Length = Driver-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
00613         DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o2">Name</a>.Buffer = Driver-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>;
00614     }
00615     DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o2">Name</a>.MaximumLength = DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o2">Name</a>.Length;
00616     DriverNameLength = DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o2">Name</a>.Length;
00617 
00618     <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a> = &amp;DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o0">ListEntry</a>;
00619 
00620     <span class="comment">//</span>
00621     <span class="comment">// Check for ImagePath value, which will override the default name</span>
00622     <span class="comment">// if it is present.</span>
00623     <span class="comment">//</span>
00624     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, L<span class="stringliteral">"ImagePath"</span>);
00625     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(Hive,
00626                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,DriverCell),
00627                                    &amp;UnicodeString);
00628     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00629 
00630         <span class="comment">//</span>
00631         <span class="comment">// No ImagePath, so generate default filename.</span>
00632         <span class="comment">// Build up Unicode filename  ("system32\drivers&lt;nodename&gt;.sys");</span>
00633         <span class="comment">//</span>
00634 
00635         Length = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"System32\\Drivers\\"</span>) +
00636                  DriverNameLength  +
00637                  <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">".sys"</span>);
00638 
00639         <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> = &amp;<a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;FilePath;
00640         <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length = 0;
00641         <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Length;
00642         <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer = (PWSTR)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(Length, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00643         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00644             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00645         }
00646         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(FileName, L<span class="stringliteral">"System32\\"</span>))) {
00647             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00648         }
00649         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(FileName, L<span class="stringliteral">"Drivers\\"</span>))) {
00650             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00651         }
00652         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(
00653                 <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(FileName,
00654                                                &amp;DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o2">Name</a>))) {
00655             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00656         }
00657         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(FileName, L<span class="stringliteral">".sys"</span>))) {
00658             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00659         }
00660 
00661     } <span class="keywordflow">else</span> {
00662         Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,ValueCell);
00663         <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> = &amp;<a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;FilePath;
00664         <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(Hive,Value,realsize);
00665         <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;MaximumLength = <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize;
00666     }
00667 
00668     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> = &amp;<a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;RegistryPath;
00669     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length = 0;
00670     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;MaximumLength = RegistryPath-&gt;Length + DriverNameLength;
00671     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;MaximumLength,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00672     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00673         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00674     }
00675     <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(FileName, RegistryPath);
00676     <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(FileName, &amp;DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o2">Name</a>);
00677 
00678     InsertHeadList(BootDriverListHead, &amp;<a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;Link);
00679 
00680     <span class="comment">//</span>
00681     <span class="comment">// Find "ErrorControl" value</span>
00682     <span class="comment">//</span>
00683 
00684     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, L<span class="stringliteral">"ErrorControl"</span>);
00685     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(Hive,
00686                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,DriverCell),
00687                                    &amp;UnicodeString);
00688     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00689         DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o4">ErrorControl</a> = NormalError;
00690     } <span class="keywordflow">else</span> {
00691         Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ValueCell);
00692         DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o4">ErrorControl</a> = *(PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(Hive,Value,realsize);
00693     }
00694 
00695     <span class="comment">//</span>
00696     <span class="comment">// Find "Group" value</span>
00697     <span class="comment">//</span>
00698     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, L<span class="stringliteral">"group"</span>);
00699     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(Hive,
00700                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,DriverCell),
00701                                    &amp;UnicodeString);
00702     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00703         DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o1">Group</a>.Length = 0;
00704         DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o1">Group</a>.MaximumLength = 0;
00705         DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o1">Group</a>.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00706     } <span class="keywordflow">else</span> {
00707         Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ValueCell);
00708         DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o1">Group</a>.Buffer = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(Hive,Value,realsize);
00709         DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o1">Group</a>.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize - <span class="keyword">sizeof</span>(WCHAR);
00710         DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o1">Group</a>.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o1">Group</a>.Length;
00711     }
00712 
00713     <span class="comment">//</span>
00714     <span class="comment">// Calculate the tag value for the driver.  If the driver has no tag,</span>
00715     <span class="comment">// this defaults to 0xffffffff, so the driver is loaded last in the</span>
00716     <span class="comment">// group.</span>
00717     <span class="comment">//</span>
00718     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, L<span class="stringliteral">"Tag"</span>);
00719     Tag = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(Hive,
00720                              (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,DriverCell),
00721                              &amp;UnicodeString);
00722     <span class="keywordflow">if</span> (Tag == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00723         DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o3">Tag</a> = <a class="code" href="../../d0/d0/cmboot_8c.html#a0">LOAD_LAST</a>;
00724     } <span class="keywordflow">else</span> {
00725         <span class="comment">//</span>
00726         <span class="comment">// Now we have to find this tag in the tag list for the group.</span>
00727         <span class="comment">// If the tag is not in the tag list, then it defaults to 0xfffffffe,</span>
00728         <span class="comment">// so it is loaded after all the drivers in the tag list, but before</span>
00729         <span class="comment">// all the drivers without tags at all.</span>
00730         <span class="comment">//</span>
00731 
00732         DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o3">Tag</a> = <a class="code" href="../../d0/d0/cmboot_8c.html#a6">CmpFindTagIndex</a>(Hive,
00733                                           Tag,
00734                                           GroupOrderCell,
00735                                           &amp;DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o1">Group</a>);
00736     }
00737 
00738     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00739 
00740 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="cmboot.c::CmpDoSort" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpDoSort           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverListHead</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>OrderList</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00837">837</a> of file <a class="el" href="../../d1/d9/cmboot_8c-source.html">cmboot.c</a>.
<p>
References <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00050">End</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00453">_BOOT_DRIVER_NODE::Group</a>, <a class="el" href="../../d8/d8/cm_8h-source.html#l00100">_BOOT_DRIVER_LIST_ENTRY::Link</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00452">_BOOT_DRIVER_NODE::ListEntry</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00744">CmpSortDriverList()</a>.
<p>
<pre class="fragment"><div>00844                    :
00845 
00846     Sorts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> boot driver list based on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> order list
00847 
00848     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last entry in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group order list and work towards
00849     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> beginning.  For each group entry, <a class="code" href="../../d7/d4/conexts_8c.html#a1">move</a> all driver entries that
00850     are members of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> front of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list.  Driver entries
00851     with no groups, or with a group that does not match any in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00852     group list will be shoved to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list.
00853 
00854 Arguments:
00855 
00856     DriverListHead - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> head of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of
00857             boot drivers to be sorted.
00858 
00859     OrderList - Supplies pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> order list
00860 
00861 Return Value:
00862 
00863     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> successfully ordered
00864 
00865     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> inconsistent and could not be ordered.
00866 
00867 --*/
00868 
00869 {
00870     PWSTR Current;
00871     PWSTR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
00872     PLIST_ENTRY Next;
00873     <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">PBOOT_DRIVER_NODE</a> CurrentNode;
00874     UNICODE_STRING CurrentGroup;
00875 
00876 
00877     Current = (PWSTR) ((PUCHAR)(OrderList-&gt;Buffer)+OrderList-&gt;Length);
00878 
00879     <span class="keywordflow">while</span> (Current &gt; OrderList-&gt;Buffer) {
00880         <span class="keywordflow">do</span> {
00881             <span class="keywordflow">if</span> (*(Current) == UNICODE_NULL) {
00882                 <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = Current;
00883             }
00884             --Current;
00885         } <span class="keywordflow">while</span> ((*(Current-1) != UNICODE_NULL) &amp;&amp;
00886                  ( Current != OrderList-&gt;Buffer));
00887 
00888         <span class="comment">//</span>
00889         <span class="comment">// Current now points to the beginning of the NULL-terminated</span>
00890         <span class="comment">// Unicode string.</span>
00891         <span class="comment">// End now points to the end of the string</span>
00892         <span class="comment">//</span>
00893         CurrentGroup.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) ((PCHAR)<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> - (PCHAR)Current);
00894         CurrentGroup.MaximumLength = CurrentGroup.Length;
00895         CurrentGroup.Buffer = Current;
00896         Next = DriverListHead-&gt;Flink;
00897         <span class="keywordflow">while</span> (Next != DriverListHead) {
00898             CurrentNode = CONTAINING_RECORD(Next,
00899                                             <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">BOOT_DRIVER_NODE</a>,
00900                                             ListEntry.Link);
00901             Next = CurrentNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o0">ListEntry</a>.<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o0">Link</a>.Flink;
00902             <span class="keywordflow">if</span> (CurrentNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o1">Group</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00903                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;CurrentGroup, &amp;CurrentNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o1">Group</a>,TRUE)) {
00904                     RemoveEntryList(&amp;CurrentNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o0">ListEntry</a>.<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o0">Link</a>);
00905                     InsertHeadList(DriverListHead,
00906                                    &amp;CurrentNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o0">ListEntry</a>.<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o0">Link</a>);
00907                 }
00908             }
00909         }
00910         --Current;
00911 
00912     }
00913 
00914     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00915 
00916 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="cmboot.c::CmpFindControlSet" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CmpFindControlSet           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RootCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SelectName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AutoSelect</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01082">1082</a> of file <a class="el" href="../../d1/d9/cmboot_8c-source.html">cmboot.c</a>.
<p>
References <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00186">CmpFindSubKeyByName()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01243">CmpFindValueByName</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00078">CmpValueToData</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00107">PHCELL_INDEX</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d6/d9/heappage_8c.html#a68">sprintf()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d7/regtest_8c.html#a2">strlen()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00499">_CM_KEY_VALUE::Type</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/cmcontrl_8c-source.html#l00050">CmGetSystemControlValues()</a>, and <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02169">CmGetSystemDriverList()</a>.
<p>
<pre class="fragment"><div>01091                    :
01092 
01093     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> parses <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SYSTEM hive and <span class="stringliteral">"Select"</span> node
01094     to locate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> set to be used <span class="keywordflow">for</span> booting.
01095 
01096     Note that <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> also updates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of Current to reflect
01097     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> set that was just found.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> what we want to <span class="keywordflow">do</span>
01098     when <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called during boot.  During I/O initialization, <span class="keyword">this</span>
01099     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> irrelevant, since we're just changing <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> to what <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> already <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>.
01100 
01101 Arguments:
01102 
01103     SystemHive - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SYSTEM hive.
01104 
01105     RootCell - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root cell of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive.
01106 
01107     SelectName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Select value to be used in
01108             determining <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> set.  This should be one of <span class="stringliteral">"Current"</span>
01109             <span class="stringliteral">"Default"</span> or <span class="stringliteral">"LastKnownGood"</span>
01110 
01111     AutoSelect - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AutoSelect value under
01112             <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Select node.
01113 
01114 Return Value:
01115 
01116     != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> set to be used <span class="keywordflow">for</span> booting.
01117     == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a> - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> corrupt or inconsistent
01118 
01119 --*/
01120 
01121 {
01122     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Select;
01123     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ValueCell;
01124     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ControlSet;
01125     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> AutoSelectCell;
01126     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01127     UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
01128     ANSI_STRING AnsiString;
01129     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01130     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> Value;
01131     PULONG ControlSetIndex;
01132     PULONG CurrentControl;
01133     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> AsciiBuffer[128];
01134     WCHAR UnicodeBuffer[128];
01135     ULONG realsize;
01136 
01137     <span class="comment">//</span>
01138     <span class="comment">// Find \SYSTEM\SELECT node.</span>
01139     <span class="comment">//</span>
01140     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"select"</span>);
01141     Select = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(SystemHive,
01142                                 (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive,RootCell),
01143                                 &amp;Name);
01144     <span class="keywordflow">if</span> (Select == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01145         <span class="keywordflow">return</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>);
01146     }
01147 
01148     <span class="comment">//</span>
01149     <span class="comment">// Find AutoSelect value</span>
01150     <span class="comment">//</span>
01151     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"AutoSelect"</span>);
01152     AutoSelectCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(SystemHive,
01153                                         (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive,Select),
01154                                         &amp;Name);
01155     <span class="keywordflow">if</span> (AutoSelectCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01156         <span class="comment">//</span>
01157         <span class="comment">// It's not there, we don't care.  Set autoselect to TRUE</span>
01158         <span class="comment">//</span>
01159         *AutoSelect = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01160     } <span class="keywordflow">else</span> {
01161         Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, AutoSelectCell);
01162         *AutoSelect = *(PBOOLEAN)(<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(SystemHive,Value,realsize));
01163     }
01164 
01165     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(SystemHive,
01166                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive,Select),
01167                                    SelectName);
01168     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01169         <span class="keywordflow">return</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>);
01170     }
01171     Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, ValueCell);
01172     <span class="keywordflow">if</span> (Value-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a> != REG_DWORD) {
01173         <span class="keywordflow">return</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>);
01174     }
01175 
01176     ControlSetIndex = (PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(SystemHive, Value,realsize);
01177 
01178     <span class="comment">//</span>
01179     <span class="comment">// Find appropriate control set</span>
01180     <span class="comment">//</span>
01181 
01182     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(AsciiBuffer, <span class="stringliteral">"ControlSet%03d"</span>, *ControlSetIndex);
01183     AnsiString.Length = AnsiString.MaximumLength = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(&amp;(AsciiBuffer[0]));
01184     AnsiString.Buffer = AsciiBuffer;
01185     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.MaximumLength = 128*<span class="keyword">sizeof</span>(WCHAR);
01186     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Buffer = UnicodeBuffer;
01187     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;Name,
01188                                           &amp;AnsiString,
01189                                           FALSE);
01190     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01191         <span class="keywordflow">return</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>);
01192     }
01193     ControlSet = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(SystemHive,
01194                                      (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive,RootCell),
01195                                      &amp;Name);
01196     <span class="keywordflow">if</span> (ControlSet == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01197         <span class="keywordflow">return</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>);
01198     }
01199 
01200     <span class="comment">//</span>
01201     <span class="comment">// Control set was successfully found, so update the value in "Current"</span>
01202     <span class="comment">// to reflect the control set we are going to use.</span>
01203     <span class="comment">//</span>
01204     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"Current"</span>);
01205     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(SystemHive,
01206                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive,Select),
01207                                    &amp;Name);
01208     <span class="keywordflow">if</span> (ValueCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01209         Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, ValueCell);
01210         <span class="keywordflow">if</span> (Value-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a> == REG_DWORD) {
01211             CurrentControl = (PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(SystemHive, Value,realsize);
01212             *CurrentControl = *ControlSetIndex;
01213         }
01214     }
01215     <span class="keywordflow">return</span>(ControlSet);
01216 
01217 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="cmboot.c::CmpFindDrivers" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpFindDrivers           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ControlSet</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SERVICE_LOAD_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>LoadType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWSTR BootFileSystem&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverListHead</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00333">333</a> of file <a class="el" href="../../d1/d9/cmboot_8c-source.html">cmboot.c</a>.
<p>
References <a class="el" href="../../d1/d2/cmp_8h.html#a157">BOOT_DRIVER_NODE</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00538">CmpAddDriverToList()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00186">CmpFindSubKeyByName()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00771">CmpFindSubKeyByNumber()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00473">CmpIsLoadType()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00456">_BOOT_DRIVER_NODE::ErrorControl</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00107">PHCELL_INDEX</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01821">RtlAppendUnicodeToString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02169">CmGetSystemDriverList()</a>.
<p>
<pre class="fragment"><div>00343                    :
00344 
00345     Traverses a particular <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> set and creates a list of boot drivers
00346     to be loaded.  This list <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> unordered, but complete.
00347 
00348 Arguments:
00349 
00350     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SYSTEM hive.
00351 
00352     ControlSet - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> set.
00353 
00354     LoadType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of drivers to be loaded (BootLoad,
00355             SystemLoad, AutoLoad, etc)
00356 
00357     BootFileSystem - If present, supplies the base name of the boot
00358         filesystem, which is explicitly added to the driver list.
00359 
00360     DriverListHead - Supplies a pointer to the head of the (empty) list
00361             of boot drivers to load.
00362 
00363 Return Value:
00364 
00365     TRUE - List successfully created.
00366 
00367     FALSE - Hive is corrupt.
00368 
00369 --*/
00370 
00371 {
00372     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Services;
00373     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Control;
00374     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> GroupOrder;
00375     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> DriverCell;
00376     UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00377     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00378     <span class="keywordtype">int</span> i;
00379     UNICODE_STRING UnicodeString;
00380     UNICODE_STRING BasePath;
00381     WCHAR BaseBuffer[128];
00382     <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">PBOOT_DRIVER_NODE</a> BootFileSystemNode;
00383     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> ControlNode;
00384     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> ServicesNode;
00385 
00386     <span class="comment">//</span>
00387     <span class="comment">// Find SERVICES node.</span>
00388     <span class="comment">//</span>
00389     ControlNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,ControlSet);
00390     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"Services"</span>);
00391     Services = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(Hive,
00392                                    ControlNode,
00393                                    &amp;Name);
00394     <span class="keywordflow">if</span> (Services == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00395         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00396     }
00397     ServicesNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,Services);
00398 
00399     <span class="comment">//</span>
00400     <span class="comment">// Find CONTROL node.</span>
00401     <span class="comment">//</span>
00402     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"Control"</span>);
00403     Control = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(Hive,
00404                                   ControlNode,
00405                                   &amp;Name);
00406     <span class="keywordflow">if</span> (Control == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00407         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00408     }
00409 
00410     <span class="comment">//</span>
00411     <span class="comment">// Find GroupOrderList node.</span>
00412     <span class="comment">//</span>
00413     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"GroupOrderList"</span>);
00414     GroupOrder = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(Hive,
00415                                      (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,Control),
00416                                      &amp;Name);
00417     <span class="keywordflow">if</span> (GroupOrder == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00418         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00419     }
00420 
00421     BasePath.Length = 0;
00422     BasePath.MaximumLength = <span class="keyword">sizeof</span>(BaseBuffer);
00423     BasePath.Buffer = BaseBuffer;
00424     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;BasePath, L<span class="stringliteral">"\\Registry\\Machine\\System\\"</span>);
00425     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;BasePath, L<span class="stringliteral">"CurrentControlSet\\Services\\"</span>);
00426 
00427     i=0;
00428     <span class="keywordflow">do</span> {
00429         DriverCell = <a class="code" href="../../d1/d2/cmp_8h.html#a304">CmpFindSubKeyByNumber</a>(Hive,ServicesNode,i++);
00430         <span class="keywordflow">if</span> (DriverCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00431             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/cmboot_8c.html#a7">CmpIsLoadType</a>(Hive, DriverCell, LoadType)) {
00432                 <a class="code" href="../../d0/d0/cmboot_8c.html#a4">CmpAddDriverToList</a>(Hive,
00433                                    DriverCell,
00434                                    GroupOrder,
00435                                    &amp;BasePath,
00436                                    DriverListHead);
00437 
00438             }
00439         }
00440     } <span class="keywordflow">while</span> ( DriverCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a> );
00441 
00442     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(BootFileSystem)) {
00443         <span class="comment">//</span>
00444         <span class="comment">// Add boot filesystem to boot driver list</span>
00445         <span class="comment">//</span>
00446 
00447         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, BootFileSystem);
00448         DriverCell = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(Hive,
00449                                          ServicesNode,
00450                                          &amp;UnicodeString);
00451         <span class="keywordflow">if</span> (DriverCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00452             <a class="code" href="../../d0/d0/cmboot_8c.html#a4">CmpAddDriverToList</a>(Hive,
00453                                DriverCell,
00454                                GroupOrder,
00455                                &amp;BasePath,
00456                                DriverListHead);
00457 
00458             <span class="comment">//</span>
00459             <span class="comment">// mark the Boot Filesystem critical</span>
00460             <span class="comment">//</span>
00461             BootFileSystemNode = CONTAINING_RECORD(DriverListHead-&gt;Flink,
00462                                                    <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">BOOT_DRIVER_NODE</a>,
00463                                                    ListEntry.Link);
00464             BootFileSystemNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o4">ErrorControl</a> = SERVICE_ERROR_CRITICAL;
00465         }
00466     }
00467     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00468 
00469 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="cmboot.c::CmpFindNLSData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpFindNLSData           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ControlSet</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>AnsiFilename</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>OemFilename</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>CaseTableFilename</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>OemHalFont</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00108">108</a> of file <a class="el" href="../../d1/d9/cmboot_8c-source.html">cmboot.c</a>.
<p>
References <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00186">CmpFindSubKeyByName()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01243">CmpFindValueByName</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00078">CmpValueToData</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00107">PHCELL_INDEX</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>00119                    :
00120 
00121     Traverses a particular <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> set and determines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filenames <span class="keywordflow">for</span>
00122     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NLS data files that need to be loaded.
00123 
00124 Arguments:
00125 
00126     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SYSTEM hive.
00127 
00128     ControlSet - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> set.
00129 
00130     AnsiFileName - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Ansi codepage <a class="code" href="../../d7/d1/genuedef_8c.html#a9">file</a> (c_1252.nls)
00131 
00132     OemFileName -  Returns the name of the OEM codepage file  (c_437.nls)
00133 
00134     CaseTableFileName - Returns the name of the Unicode upper/lowercase
00135             table for the language (l_intl.nls)
00136 
00137     OemHalfont - Returns the name of the font file to be used by the HAL.
00138 
00139 Return Value:
00140 
00141     TRUE - filenames successfully determined
00142 
00143     FALSE - hive is corrupt
00144 
00145 --*/
00146 
00147 {
00148     UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00149     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Control;
00150     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Nls;
00151     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CodePage;
00152     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Language;
00153     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ValueCell;
00154     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00155     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> Value;
00156     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00157     ULONG realsize;
00158 
00159     <span class="comment">//</span>
00160     <span class="comment">// Find CONTROL node</span>
00161     <span class="comment">//</span>
00162     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"Control"</span>);
00163     Control = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(Hive,
00164                                  (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,ControlSet),
00165                                  &amp;Name);
00166     <span class="keywordflow">if</span> (Control == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00167         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00168     }
00169 
00170     <span class="comment">//</span>
00171     <span class="comment">// Find NLS node</span>
00172     <span class="comment">//</span>
00173     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"NLS"</span>);
00174     Nls = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(Hive,
00175                              (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,Control),
00176                              &amp;Name);
00177     <span class="keywordflow">if</span> (Nls == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00178         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00179     }
00180 
00181     <span class="comment">//</span>
00182     <span class="comment">// Find CodePage node</span>
00183     <span class="comment">//</span>
00184     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"CodePage"</span>);
00185     CodePage = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(Hive,
00186                                   (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,Nls),
00187                                   &amp;Name);
00188     <span class="keywordflow">if</span> (CodePage == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00189         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00190     }
00191 
00192     <span class="comment">//</span>
00193     <span class="comment">// Find ACP value</span>
00194     <span class="comment">//</span>
00195     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"ACP"</span>);
00196     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(Hive,
00197                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,CodePage),
00198                                    &amp;Name);
00199     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00200         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00201     }
00202 
00203     Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ValueCell);
00204     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Buffer = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(Hive,Value,realsize);
00205     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.MaximumLength=(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize;
00206     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length = 0;
00207     <span class="keywordflow">while</span> ((<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length&lt;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.MaximumLength) &amp;&amp;
00208            (<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Buffer[<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length/<span class="keyword">sizeof</span>(WCHAR)] != UNICODE_NULL)) {
00209         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length += <span class="keyword">sizeof</span>(WCHAR);
00210     }
00211 
00212     <span class="comment">//</span>
00213     <span class="comment">// Find ACP filename</span>
00214     <span class="comment">//</span>
00215     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(Hive,
00216                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,CodePage),
00217                                    &amp;Name);
00218     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00219         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00220     }
00221 
00222     Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ValueCell);
00223     AnsiFilename-&gt;Buffer = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(Hive,Value,realsize);
00224     AnsiFilename-&gt;Length = AnsiFilename-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize;
00225 
00226     <span class="comment">//</span>
00227     <span class="comment">// Find OEMCP node</span>
00228     <span class="comment">//</span>
00229     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"OEMCP"</span>);
00230     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(Hive,
00231                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,CodePage),
00232                                    &amp;Name);
00233     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00234         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00235     }
00236 
00237     Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ValueCell);
00238     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Buffer = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(Hive,Value,realsize);
00239     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize;
00240     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length = 0;
00241     <span class="keywordflow">while</span> ((<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length&lt;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.MaximumLength) &amp;&amp;
00242            (<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Buffer[<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length/<span class="keyword">sizeof</span>(WCHAR)] != UNICODE_NULL)) {
00243         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length += <span class="keyword">sizeof</span>(WCHAR);
00244     }
00245 
00246     <span class="comment">//</span>
00247     <span class="comment">// Find OEMCP filename</span>
00248     <span class="comment">//</span>
00249     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(Hive,
00250                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,CodePage),
00251                                    &amp;Name);
00252     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00253         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00254     }
00255 
00256     Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ValueCell);
00257     OemFilename-&gt;Buffer = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(Hive, Value,realsize);
00258     OemFilename-&gt;Length = OemFilename-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize;
00259 
00260     <span class="comment">//</span>
00261     <span class="comment">// Find Language node</span>
00262     <span class="comment">//</span>
00263     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"Language"</span>);
00264     Language = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(Hive,
00265                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,Nls),
00266                                    &amp;Name);
00267     <span class="keywordflow">if</span> (Language == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00268         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00269     }
00270 
00271     <span class="comment">//</span>
00272     <span class="comment">// Find Default value</span>
00273     <span class="comment">//</span>
00274     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"Default"</span>);
00275     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(Hive,
00276                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,Language),
00277                                    &amp;Name);
00278     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00279             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00280     }
00281 
00282     Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ValueCell);
00283     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Buffer = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(Hive, Value,realsize);
00284     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize;
00285     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length = 0;
00286 
00287     <span class="keywordflow">while</span> ((<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length&lt;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.MaximumLength) &amp;&amp;
00288            (<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Buffer[<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length/<span class="keyword">sizeof</span>(WCHAR)] != UNICODE_NULL)) {
00289         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length+=<span class="keyword">sizeof</span>(WCHAR);
00290     }
00291 
00292     <span class="comment">//</span>
00293     <span class="comment">// Find default filename</span>
00294     <span class="comment">//</span>
00295     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(Hive,
00296                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,Language),
00297                                    &amp;Name);
00298     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00299         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00300     }
00301 
00302     Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ValueCell);
00303     CaseTableFilename-&gt;Buffer = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(Hive, Value,realsize);
00304     CaseTableFilename-&gt;Length = CaseTableFilename-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize;
00305 
00306     <span class="comment">//</span>
00307     <span class="comment">// Find OEMHAL filename</span>
00308     <span class="comment">//</span>
00309     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"OEMHAL"</span>);
00310     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(Hive,
00311                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,CodePage),
00312                                    &amp;Name);
00313     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00314 <span class="preprocessor">#ifdef i386</span>
00315 <span class="preprocessor"></span>        OemHalFont-&gt;Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00316         OemHalFont-&gt;Length = 0;
00317         OemHalFont-&gt;MaximumLength = 0;
00318         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00319 <span class="preprocessor">#endif</span>
00320 <span class="preprocessor"></span>        <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00321     }
00322 
00323     Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ValueCell);
00324     OemHalFont-&gt;Buffer = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(Hive,Value,realsize);
00325     OemHalFont-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize;
00326     OemHalFont-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize;
00327 
00328     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00329 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="cmboot.c::CmpFindProfileOption" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CmpFindProfileOption           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ControlSet</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT OPTIONAL <a class="el" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">PCM_HARDWARE_PROFILE_LIST</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnedProfileList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT OPTIONAL <a class="el" href="../../d9/d3/struct__CM__HARDWARE__PROFILE__ALIAS__LIST.html">PCM_HARDWARE_PROFILE_ALIAS_LIST</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnedAliasList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT OPTIONAL PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ProfileTimeout</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01284">1284</a> of file <a class="el" href="../../d1/d9/cmboot_8c-source.html">cmboot.c</a>.
<p>
References <a class="el" href="../../d1/d2/cmp_8h.html#a189">CM_HARDWARE_PROFILE</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a191">CM_HARDWARE_PROFILE_LIST</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01585">CM_HARDWARE_PROFILE_STR_ALIASABLE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01592">CM_HARDWARE_PROFILE_STR_FRIENDLY_NAME</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01591">CM_HARDWARE_PROFILE_STR_PREFERENCE_ORDER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01590">CM_HARDWARE_PROFILE_STR_PRISTINE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01625">CM_HP_FLAGS_ALIASABLE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01627">CM_HP_FLAGS_PRISTINE</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00121">CmpCompressedNameSize()</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00151">CmpCopyCompressedName()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00186">CmpFindSubKeyByName()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00771">CmpFindSubKeyByNumber()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01243">CmpFindValueByName</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00078">CmpValueToData</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01645">_CM_HARDWARE_PROFILE_ALIAS_LIST::CurrentAliasCount</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01632">_CM_HARDWARE_PROFILE_LIST::CurrentProfileCount</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01622">_CM_HARDWARE_PROFILE::Flags</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01619">_CM_HARDWARE_PROFILE::FriendlyName</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01621">_CM_HARDWARE_PROFILE::Id</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00440">KEY_COMP_NAME</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01644">_CM_HARDWARE_PROFILE_ALIAS_LIST::MaxAliasCount</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01631">_CM_HARDWARE_PROFILE_LIST::MaxProfileCount</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00477">_CM_KEY_NODE::Name</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01618">_CM_HARDWARE_PROFILE::NameLength</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00475">_CM_KEY_NODE::NameLength</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a196">PCM_HARDWARE_PROFILE_ALIAS_LIST</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a192">PCM_HARDWARE_PROFILE_LIST</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01620">_CM_HARDWARE_PROFILE::PreferenceOrder</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01633">_CM_HARDWARE_PROFILE_LIST::Profile</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d0/d3/cnvint_8c-source.html#l00225">RtlUnicodeStringToInteger()</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00454">_CM_KEY_NODE::SubKeyCounts</a>, <a class="el" href="../../d0/d0/cmboot_8c.html#a3">TempAlias</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00499">_CM_KEY_VALUE::Type</a>.
<p>
<pre class="fragment"><div>01294                    :
01295 
01296     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> parses <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SYSTEM hive and locates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01297     <span class="stringliteral">"CurrentControlSet\Control\IDConfigDB"</span> node to determine <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01298     hardware profile configuration settings.
01299 
01300 Arguments:
01301 
01302     SystemHive - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SYSTEM hive.
01303 
01304     ControlSet - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root cell of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive.
01305 
01306     ProfileList - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of available hardware profiles sorted
01307                   by preference. Will be allocated by <span class="keyword">this</span> routine <span class="keywordflow">if</span>
01308                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> passed in, or a pointer to a <a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">CM_HARDWARE_PROFILE_LIST</a>
01309                   structure that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> too small <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> passed in.
01310 
01311     ProfileTimeout - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timeout value <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> config menu.
01312 
01313 Return Value:
01314 
01315     != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IDConfigDB node.
01316     == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a> - Indicates IDConfigDB does not exist
01317 
01318 --*/
01319 {
01320     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ControlCell;
01321     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> IDConfigDB;
01322     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> DefaultCell;
01323     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> TimeoutCell;
01324     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ProfileCell;
01325     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> AliasCell;
01326     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> HWCell;
01327     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> HWNode;
01328     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> ProfileNode;
01329     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> AliasNode;
01330     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> ConfigDBNode;
01331     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Control;
01332     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> TimeoutValue;
01333     UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
01334     ULONG realsize;
01335     <a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">PCM_HARDWARE_PROFILE_LIST</a> ProfileList;
01336     <a class="code" href="../../d9/d3/struct__CM__HARDWARE__PROFILE__ALIAS__LIST.html">PCM_HARDWARE_PROFILE_ALIAS_LIST</a> AliasList;
01337     ULONG ProfileCount;
01338     ULONG AliasCount;
01339     ULONG i,j;
01340     WCHAR NameBuf[20];
01341 
01342     <span class="comment">//</span>
01343     <span class="comment">// Find Control node</span>
01344     <span class="comment">//</span>
01345     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"Control"</span>);
01346     ControlCell = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(SystemHive,
01347                                       (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive,ControlSet),
01348                                       &amp;Name);
01349     <span class="keywordflow">if</span> (ControlCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01350         <span class="keywordflow">return</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>);
01351     }
01352     Control = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, ControlCell);
01353 
01354     <span class="comment">//</span>
01355     <span class="comment">// Find IDConfigDB node</span>
01356     <span class="comment">//</span>
01357     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"IDConfigDB"</span>);
01358     IDConfigDB = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(SystemHive,
01359                                      Control,
01360                                      &amp;Name);
01361     <span class="keywordflow">if</span> (IDConfigDB == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01362         <span class="keywordflow">return</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>);
01363     }
01364     ConfigDBNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, IDConfigDB);
01365 
01366     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ProfileTimeout)) {
01367         <span class="comment">//</span>
01368         <span class="comment">// Find UserWaitInterval value. This is the timeout</span>
01369         <span class="comment">//</span>
01370         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"UserWaitInterval"</span>);
01371         TimeoutCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(SystemHive,
01372                                          ConfigDBNode,
01373                                          &amp;Name);
01374         <span class="keywordflow">if</span> (TimeoutCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01375             *ProfileTimeout = 0;
01376         } <span class="keywordflow">else</span> {
01377             TimeoutValue = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, TimeoutCell);
01378             <span class="keywordflow">if</span> (TimeoutValue-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a> != REG_DWORD) {
01379                 *ProfileTimeout = 0;
01380             } <span class="keywordflow">else</span> {
01381                 *ProfileTimeout = *(PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(SystemHive, TimeoutValue, realsize);
01382             }
01383         }
01384     }
01385 
01386     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnedProfileList)) {
01387         ProfileList = *ReturnedProfileList;
01388         <span class="comment">//</span>
01389         <span class="comment">// Enumerate the keys under IDConfigDB\Hardware Profiles</span>
01390         <span class="comment">// and build the list of available hardware profiles.  The list</span>
01391         <span class="comment">// is built sorted by PreferenceOrder.  Therefore, when the</span>
01392         <span class="comment">// list is complete, the default hardware profile is at the</span>
01393         <span class="comment">// head of the list.</span>
01394         <span class="comment">//</span>
01395         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"Hardware Profiles"</span>);
01396         ProfileCell = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(SystemHive,
01397                                           ConfigDBNode,
01398                                           &amp;Name);
01399         <span class="keywordflow">if</span> (ProfileCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01400             ProfileCount = 0;
01401             <span class="keywordflow">if</span> (ProfileList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01402                 ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o1">CurrentProfileCount</a> = 0;
01403             }
01404         } <span class="keywordflow">else</span> {
01405             ProfileNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, ProfileCell);
01406             ProfileCount = ProfileNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>];
01407             <span class="keywordflow">if</span> ((ProfileList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o0">MaxProfileCount</a> &lt; ProfileCount)) {
01408                 <span class="comment">//</span>
01409                 <span class="comment">// Allocate a larger ProfileList</span>
01410                 <span class="comment">//</span>
01411                 ProfileList = (SystemHive-&gt;Allocate)(<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">CM_HARDWARE_PROFILE_LIST</a>)
01412                                                      + (ProfileCount-1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html">CM_HARDWARE_PROFILE</a>),
01413                                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01414                 <span class="keywordflow">if</span> (ProfileList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01415                     <span class="keywordflow">return</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>);
01416                 }
01417                 ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o0">MaxProfileCount</a> = ProfileCount;
01418             }
01419             ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o1">CurrentProfileCount</a> = 0;
01420 
01421             <span class="comment">//</span>
01422             <span class="comment">// Enumerate the keys and fill in the profile list.</span>
01423             <span class="comment">//</span>
01424             <span class="keywordflow">for</span> (i=0; i&lt;ProfileCount; i++) {
01425                 <a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html">CM_HARDWARE_PROFILE</a> TempProfile;
01426                 <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ValueCell;
01427                 <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> ValueNode;
01428                 UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
01429                 ULONG realsize;
01430 
01431                 HWCell = <a class="code" href="../../d1/d2/cmp_8h.html#a304">CmpFindSubKeyByNumber</a>(SystemHive, ProfileNode, i);
01432                 <span class="keywordflow">if</span> (HWCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01433                     <span class="comment">//</span>
01434                     <span class="comment">// This should never happen.</span>
01435                     <span class="comment">//</span>
01436                     ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o1">CurrentProfileCount</a> = i;
01437                     <span class="keywordflow">break</span>;
01438                 }
01439                 HWNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, HWCell);
01440                 <span class="keywordflow">if</span> (HWNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>) {
01441                     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length = <a class="code" href="../../d1/d2/cmp_8h.html#a320">CmpCompressedNameSize</a>(HWNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
01442                                                            HWNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
01443                     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.MaximumLength = <span class="keyword">sizeof</span>(NameBuf);
01444                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.MaximumLength &lt; <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length) {
01445                         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.MaximumLength;
01446                     }
01447                     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer = NameBuf;
01448                     <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer,
01449                                           <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length,
01450                                           HWNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
01451                                           HWNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
01452                 } <span class="keywordflow">else</span> {
01453                     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.MaximumLength = HWNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
01454                     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer = HWNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>;
01455                 }
01456 
01457                 <span class="comment">//</span>
01458                 <span class="comment">// Fill in the temporary profile structure with this</span>
01459                 <span class="comment">// profile's data.</span>
01460                 <span class="comment">//</span>
01461                 <a class="code" href="../../d9/d3/cnvint_8c.html#a4">RtlUnicodeStringToInteger</a>(&amp;KeyName, 0, &amp;TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o3">Id</a>);
01462                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, CM_HARDWARE_PROFILE_STR_PREFERENCE_ORDER);
01463                 ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(SystemHive,
01464                                                HWNode,
01465                                                &amp;Name);
01466                 <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01467                     TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o2">PreferenceOrder</a> = (ULONG)-1;
01468                 } <span class="keywordflow">else</span> {
01469                     ValueNode = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, ValueCell);
01470                     TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o2">PreferenceOrder</a> = *(PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(SystemHive,
01471                                                                           ValueNode,
01472                                                                           realsize);
01473                 }
01474                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, CM_HARDWARE_PROFILE_STR_FRIENDLY_NAME);
01475                 ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(SystemHive,
01476                                                HWNode,
01477                                                &amp;Name);
01478                 <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01479                     TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o1">FriendlyName</a> = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"-------"</span>;
01480                     TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o0">NameLength</a> = wcslen(TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o1">FriendlyName</a>) * <span class="keyword">sizeof</span>(WCHAR);
01481                 } <span class="keywordflow">else</span> {
01482                     ValueNode = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, ValueCell);
01483                     TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o1">FriendlyName</a> = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(SystemHive,
01484                                                                      ValueNode,
01485                                                                      realsize);
01486                     TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o0">NameLength</a> = realsize - <span class="keyword">sizeof</span>(WCHAR);
01487                 }
01488 
01489                 TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o4">Flags</a> = 0;
01490 
01491                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, CM_HARDWARE_PROFILE_STR_ALIASABLE);
01492                 ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(SystemHive,
01493                                                HWNode,
01494                                                &amp;Name);
01495                 <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01496                     TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o4">Flags</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a147">CM_HP_FLAGS_ALIASABLE</a>;
01497                 } <span class="keywordflow">else</span> {
01498                     ValueNode = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, ValueCell);
01499 
01500                     <span class="keywordflow">if</span> (*(PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a> (SystemHive,
01501                                                  ValueNode,
01502                                                  realsize)) {
01503                         TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o4">Flags</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a147">CM_HP_FLAGS_ALIASABLE</a>;
01504                         <span class="comment">// NO other flags set.</span>
01505                     }
01506                 }
01507 
01508                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, CM_HARDWARE_PROFILE_STR_PRISTINE);
01509                 ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(SystemHive,
01510                                                HWNode,
01511                                                &amp;Name);
01512                 <span class="keywordflow">if</span> (ValueCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01513 
01514                     ValueNode = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, ValueCell);
01515 
01516                     <span class="keywordflow">if</span> (*(PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a> (SystemHive,
01517                                                  ValueNode,
01518                                                  realsize)) {
01519                         TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o4">Flags</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a149">CM_HP_FLAGS_PRISTINE</a>;
01520                         <span class="comment">// NO other flags set.</span>
01521                     }
01522                 }
01523 
01524                 <span class="comment">//</span>
01525                 <span class="comment">// If we see a profile with the ID of zero (AKA an illegal)</span>
01526                 <span class="comment">// ID for a hardware profile to possess, then we know that this</span>
01527                 <span class="comment">// must be a pristine profile.</span>
01528                 <span class="comment">//</span>
01529                 <span class="keywordflow">if</span> (0 == TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o3">Id</a>) {
01530                     TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o4">Flags</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a149">CM_HP_FLAGS_PRISTINE</a>;
01531                     <span class="comment">// NO other flags set.</span>
01532 
01533                     TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o2">PreferenceOrder</a> = -1; <span class="comment">// move to the end of the list.</span>
01534                 }
01535 
01536 
01537                 <span class="comment">//</span>
01538                 <span class="comment">// Insert this new profile into the appropriate spot in the</span>
01539                 <span class="comment">// profile array. Entries are sorted by preference order.</span>
01540                 <span class="comment">//</span>
01541                 <span class="keywordflow">for</span> (j=0; j&lt;ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o1">CurrentProfileCount</a>; j++) {
01542                     <span class="keywordflow">if</span> (ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o2">Profile</a>[j].<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o2">PreferenceOrder</a> &gt;= TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o2">PreferenceOrder</a>) {
01543                         <span class="comment">//</span>
01544                         <span class="comment">// Insert at position j.</span>
01545                         <span class="comment">//</span>
01546                         RtlMoveMemory(&amp;ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o2">Profile</a>[j+1],
01547                                       &amp;ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o2">Profile</a>[j],
01548                                       <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html">CM_HARDWARE_PROFILE</a>)*(ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o0">MaxProfileCount</a>-j-1));
01549                         <span class="keywordflow">break</span>;
01550                     }
01551                 }
01552                 ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o2">Profile</a>[j] = TempProfile;
01553                 ++ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o1">CurrentProfileCount</a>;
01554             }
01555         }
01556         *ReturnedProfileList = ProfileList;
01557     }
01558 
01559     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnedAliasList)) {
01560         AliasList = *ReturnedAliasList;
01561         <span class="comment">//</span>
01562         <span class="comment">// Enumerate the keys under IDConfigDB\Alias</span>
01563         <span class="comment">// and build the list of available hardware profiles aliases.</span>
01564         <span class="comment">// So that if we know our docking state we can find it in the alias</span>
01565         <span class="comment">// table.</span>
01566         <span class="comment">//</span>
01567         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"Alias"</span>);
01568         AliasCell = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(SystemHive,
01569                                         ConfigDBNode,
01570                                         &amp;Name);
01571         <span class="keywordflow">if</span> (AliasCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01572             AliasCount = 0;
01573             <span class="keywordflow">if</span> (AliasList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01574                 AliasList-&gt;<a class="code" href="../../d9/d3/struct__CM__HARDWARE__PROFILE__ALIAS__LIST.html#o1">CurrentAliasCount</a> = 0;
01575             }
01576         } <span class="keywordflow">else</span> {
01577             AliasNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, AliasCell);
01578             AliasCount = AliasNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>];
01579             <span class="keywordflow">if</span> ((AliasList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (AliasList-&gt;<a class="code" href="../../d9/d3/struct__CM__HARDWARE__PROFILE__ALIAS__LIST.html#o0">MaxAliasCount</a> &lt; AliasCount)) {
01580                 <span class="comment">//</span>
01581                 <span class="comment">// Allocate a larger AliasList</span>
01582                 <span class="comment">//</span>
01583                 AliasList = (SystemHive-&gt;Allocate)(<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">CM_HARDWARE_PROFILE_LIST</a>)
01584                                                    + (AliasCount-1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html">CM_HARDWARE_PROFILE</a>),
01585                                                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01586                 <span class="keywordflow">if</span> (AliasList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01587                     <span class="keywordflow">return</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>);
01588                 }
01589                 AliasList-&gt;<a class="code" href="../../d9/d3/struct__CM__HARDWARE__PROFILE__ALIAS__LIST.html#o0">MaxAliasCount</a> = AliasCount;
01590             }
01591             AliasList-&gt;<a class="code" href="../../d9/d3/struct__CM__HARDWARE__PROFILE__ALIAS__LIST.html#o1">CurrentAliasCount</a> = 0;
01592 
01593             <span class="comment">//</span>
01594             <span class="comment">// Enumerate the keys and fill in the profile list.</span>
01595             <span class="comment">//</span>
01596             <span class="keywordflow">for</span> (i=0; i&lt;AliasCount; i++) {
01597 <span class="preprocessor">#define TempAlias AliasList-&gt;Alias[i]</span>
01598 <span class="preprocessor"></span>                <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ValueCell;
01599                 <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> ValueNode;
01600                 UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
01601                 ULONG realsize;
01602 
01603                 HWCell = <a class="code" href="../../d1/d2/cmp_8h.html#a304">CmpFindSubKeyByNumber</a>(SystemHive, AliasNode, i);
01604                 <span class="keywordflow">if</span> (HWCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01605                     <span class="comment">//</span>
01606                     <span class="comment">// This should never happen.</span>
01607                     <span class="comment">//</span>
01608                     AliasList-&gt;<a class="code" href="../../d9/d3/struct__CM__HARDWARE__PROFILE__ALIAS__LIST.html#o1">CurrentAliasCount</a> = i;
01609                     <span class="keywordflow">break</span>;
01610                 }
01611                 HWNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, HWCell);
01612                 <span class="keywordflow">if</span> (HWNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>) {
01613                     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length = <a class="code" href="../../d1/d2/cmp_8h.html#a320">CmpCompressedNameSize</a>(HWNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
01614                                                            HWNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
01615                     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.MaximumLength = <span class="keyword">sizeof</span>(NameBuf);
01616                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.MaximumLength &lt; <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length) {
01617                         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.MaximumLength;
01618                     }
01619                     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer = NameBuf;
01620                     <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer,
01621                                           <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length,
01622                                           HWNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
01623                                           HWNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
01624                 } <span class="keywordflow">else</span> {
01625                     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.MaximumLength = HWNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
01626                     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer = HWNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>;
01627                 }
01628 
01629                 <span class="comment">//</span>
01630                 <span class="comment">// Fill in the temporary profile structure with this</span>
01631                 <span class="comment">// profile's data.</span>
01632                 <span class="comment">//</span>
01633                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"ProfileNumber"</span>);
01634                 ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(SystemHive,
01635                                                HWNode,
01636                                                &amp;Name);
01637                 <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01638                     <a class="code" href="../../d0/d0/cmboot_8c.html#a3">TempAlias</a>.ProfileNumber = 0;
01639                 } <span class="keywordflow">else</span> {
01640                     ValueNode = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, ValueCell);
01641                     <a class="code" href="../../d0/d0/cmboot_8c.html#a3">TempAlias</a>.ProfileNumber = *(PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(SystemHive,
01642                                                                       ValueNode,
01643                                                                       realsize);
01644                 }
01645                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"DockState"</span>);
01646                 ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(SystemHive,
01647                                                HWNode,
01648                                                &amp;Name);
01649                 <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01650                     <a class="code" href="../../d0/d0/cmboot_8c.html#a3">TempAlias</a>.DockState = 0;
01651                 } <span class="keywordflow">else</span> {
01652                     ValueNode = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, ValueCell);
01653                     <a class="code" href="../../d0/d0/cmboot_8c.html#a3">TempAlias</a>.DockState = *(PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(SystemHive,
01654                                                                   ValueNode,
01655                                                                   realsize);
01656                 }
01657                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"DockID"</span>);
01658                 ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(SystemHive,
01659                                                HWNode,
01660                                                &amp;Name);
01661                 <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01662                     <a class="code" href="../../d0/d0/cmboot_8c.html#a3">TempAlias</a>.DockID = 0;
01663                 } <span class="keywordflow">else</span> {
01664                     ValueNode = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, ValueCell);
01665                     <a class="code" href="../../d0/d0/cmboot_8c.html#a3">TempAlias</a>.DockID = *(PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(SystemHive,
01666                                                                ValueNode,
01667                                                                realsize);
01668                 }
01669                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"SerialNumber"</span>);
01670                 ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(SystemHive,
01671                                                HWNode,
01672                                                &amp;Name);
01673                 <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01674                     <a class="code" href="../../d0/d0/cmboot_8c.html#a3">TempAlias</a>.SerialNumber = 0;
01675                 } <span class="keywordflow">else</span> {
01676                     ValueNode = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, ValueCell);
01677                     <a class="code" href="../../d0/d0/cmboot_8c.html#a3">TempAlias</a>.SerialNumber = *(PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(SystemHive,
01678                                                                      ValueNode,
01679                                                                      realsize);
01680                 }
01681 
01682                 ++AliasList-&gt;<a class="code" href="../../d9/d3/struct__CM__HARDWARE__PROFILE__ALIAS__LIST.html#o1">CurrentAliasCount</a>;
01683             }
01684         }
01685         *ReturnedAliasList = AliasList;
01686     }
01687 
01688     <span class="keywordflow">return</span>(IDConfigDB);
01689 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="cmboot.c::CmpFindTagIndex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG CmpFindTagIndex           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TagCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>GroupOrderCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>GroupName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01693">1693</a> of file <a class="el" href="../../d1/d9/cmboot_8c-source.html">cmboot.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l01243">CmpFindValueByName</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00078">CmpValueToData</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00037">LOAD_NEXT_TO_LAST</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00538">CmpAddDriverToList()</a>.
<p>
<pre class="fragment"><div>01702                    :
01703 
01704     Calculates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tag index <span class="keywordflow">for</span> a driver based on its tag value and
01705     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> GroupOrderList entry <span class="keywordflow">for</span> its group.
01706 
01707 Arguments:
01708 
01709     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver.
01710 
01711     TagCell - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cell index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver's tag value cell.
01712 
01713     GroupOrderCell - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cell index <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> set's
01714             GroupOrderList:
01715 
01716             \Registry\Machine\System\CurrentControlSet\Control\GroupOrderList
01717 
01718     GroupName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver belongs to.
01719             Note that <span class="keywordflow">if</span> a driver's group does not have an entry under
01720             GroupOrderList, its tags will be ignored.  Also note that <span class="keywordflow">if</span>
01721             a driver belongs to no group (GroupName is NULL) its tags will
01722             be ignored.
01723 
01724 Return Value:
01725 
01726     The index that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver should be sorted by.
01727 
01728 --*/
01729 
01730 {
01731     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> TagValue;
01732     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> DriverTagValue;
01733     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> OrderCell;
01734     PULONG OrderVector;
01735     PULONG DriverTag;
01736     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01737     ULONG CurrentTag;
01738     ULONG realsize;
01739 
01740 
01741     DriverTagValue = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, TagCell);
01742     DriverTag = (PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(Hive, DriverTagValue, realsize);
01743 
01744     OrderCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(Hive,
01745                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,GroupOrderCell),
01746                                    GroupName);
01747     <span class="keywordflow">if</span> (OrderCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01748         <span class="keywordflow">return</span>(<a class="code" href="../../d0/d0/cmboot_8c.html#a1">LOAD_NEXT_TO_LAST</a>);
01749     }
01750 
01751     TagValue = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, OrderCell);
01752     OrderVector = (PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(Hive, TagValue,realsize);
01753 
01754     <span class="keywordflow">for</span> (CurrentTag=1; CurrentTag &lt;= OrderVector[0]; CurrentTag++) {
01755         <span class="keywordflow">if</span> (OrderVector[CurrentTag] == *DriverTag) {
01756             <span class="comment">//</span>
01757             <span class="comment">// We have found a matching tag in the OrderVector, so return</span>
01758             <span class="comment">// its index.</span>
01759             <span class="comment">//</span>
01760             <span class="keywordflow">return</span>(CurrentTag);
01761         }
01762     }
01763 
01764     <span class="comment">//</span>
01765     <span class="comment">// There was no matching tag in the OrderVector.</span>
01766     <span class="comment">//</span>
01767     <span class="keywordflow">return</span>(<a class="code" href="../../d0/d0/cmboot_8c.html#a1">LOAD_NEXT_TO_LAST</a>);
01768 
01769 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="cmboot.c::CmpIsLoadType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpIsLoadType           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SERVICE_LOAD_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>LoadType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00473">473</a> of file <a class="el" href="../../d1/d9/cmboot_8c-source.html">cmboot.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01243">CmpFindValueByName</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00078">CmpValueToData</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00107">PHCELL_INDEX</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00333">CmpFindDrivers()</a>.
<p>
<pre class="fragment"><div>00481                    :
00482 
00483     Determines <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> of a specified LoadType, based on its
00484     node values.
00485 
00486 Arguments:
00487 
00488     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system
00489            hive.
00490 
00491     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cell index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver's node in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system hive.
00492 
00493     LoadType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of drivers to be loaded (BootLoad,
00494             SystemLoad, AutoLoad, etc)
00495 
00496 Return Value:
00497 
00498     TRUE - Driver is the correct type and should be loaded.
00499 
00500     FALSE - Driver is not the correct type and should not be loaded.
00501 
00502 --*/
00503 
00504 {
00505     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ValueCell;
00506     PLONG Data;
00507     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00508     UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00509     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> Value;
00510     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00511     ULONG realsize;
00512 
00513     <span class="comment">//</span>
00514     <span class="comment">// Must have a Start=BootLoad value in order to be a boot driver, so</span>
00515     <span class="comment">// look for that first.</span>
00516     <span class="comment">//</span>
00517     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"Start"</span>);
00518     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(Hive,
00519                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,Cell),
00520                                    &amp;Name);
00521     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00522         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00523     }
00524 
00525     Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ValueCell);
00526 
00527     Data = (PLONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(Hive,Value,realsize);
00528 
00529     <span class="keywordflow">if</span> (*Data != LoadType) {
00530         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00531     }
00532 
00533     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00534 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="cmboot.c::CmpOrderGroup" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpOrderGroup           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">PBOOT_DRIVER_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>GroupStart</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">PBOOT_DRIVER_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>GroupEnd</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00997">997</a> of file <a class="el" href="../../d1/d9/cmboot_8c-source.html">cmboot.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d8/cm_8h-source.html#l00100">_BOOT_DRIVER_LIST_ENTRY::Link</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00452">_BOOT_DRIVER_NODE::ListEntry</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00455">_BOOT_DRIVER_NODE::Tag</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00920">CmpResolveDriverDependencies()</a>.
<p>
<pre class="fragment"><div>01004                    :
01005 
01006     Reorders <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> nodes in a driver group based on their tag values.
01007 
01008 Arguments:
01009 
01010     GroupStart - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first node in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group.
01011 
01012     GroupEnd - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last node in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group.
01013 
01014 Return Value:
01015 
01016     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a> successfully reordered
01017 
01018     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - Circular dependencies detected.
01019 
01020 --*/
01021 
01022 {
01023     <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">PBOOT_DRIVER_NODE</a> Current;
01024     <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">PBOOT_DRIVER_NODE</a> Previous;
01025     PLIST_ENTRY ListEntry;
01026     BOOLEAN StartOver=<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01027 
01028     <span class="keywordflow">if</span> (GroupStart == GroupEnd) {
01029         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01030     }
01031 
01032     Current = GroupStart;
01033 
01034     <span class="keywordflow">do</span> {
01035         <span class="comment">//</span>
01036         <span class="comment">// If the driver before the current one has a lower tag, then</span>
01037         <span class="comment">// we do not need to move it.  If not, then remove the driver</span>
01038         <span class="comment">// from the list and scan backwards until we find a driver with</span>
01039         <span class="comment">// a tag that is &lt;= the current tag, or we reach the beginning</span>
01040         <span class="comment">// of the list.</span>
01041         <span class="comment">//</span>
01042         Previous = Current;
01043         ListEntry = Current-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o0">ListEntry</a>.<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o0">Link</a>.Flink;
01044         Current = CONTAINING_RECORD(ListEntry,
01045                                     <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">BOOT_DRIVER_NODE</a>,
01046                                     ListEntry.Link);
01047 
01048         <span class="keywordflow">if</span> (Previous-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o3">Tag</a> &gt; Current-&gt;Tag) {
01049             <span class="comment">//</span>
01050             <span class="comment">// Remove the Current driver from the list, and search</span>
01051             <span class="comment">// backwards until we find a tag that is &lt;= the current</span>
01052             <span class="comment">// driver's tag.  Reinsert the current driver there.</span>
01053             <span class="comment">//</span>
01054             <span class="keywordflow">if</span> (Current == GroupEnd) {
01055                 ListEntry = Current-&gt;ListEntry.Link.Blink;
01056                 GroupEnd = CONTAINING_RECORD(ListEntry,
01057                                              <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">BOOT_DRIVER_NODE</a>,
01058                                              ListEntry.Link);
01059             }
01060             RemoveEntryList(&amp;Current-&gt;ListEntry.Link);
01061             <span class="keywordflow">while</span> ( (Previous-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o3">Tag</a> &gt; Current-&gt;Tag) &amp;&amp;
01062                     (Previous != GroupStart) ) {
01063                 ListEntry = Previous-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o0">ListEntry</a>.<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o0">Link</a>.Blink;
01064                 Previous = CONTAINING_RECORD(ListEntry,
01065                                              <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">BOOT_DRIVER_NODE</a>,
01066                                              ListEntry.Link);
01067             }
01068             InsertTailList(&amp;Previous-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o0">ListEntry</a>.<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o0">Link</a>,
01069                            &amp;Current-&gt;ListEntry.Link);
01070             <span class="keywordflow">if</span> (Previous == GroupStart) {
01071                 GroupStart = Current;
01072             }
01073         }
01074 
01075     } <span class="keywordflow">while</span> ( Current != GroupEnd );
01076 
01077     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01078 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="cmboot.c::CmpResolveDriverDependencies" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpResolveDriverDependencies           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLIST_ENTRY&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DriverListHead</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00920">920</a> of file <a class="el" href="../../d1/d9/cmboot_8c-source.html">cmboot.c</a>.
<p>
References <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00997">CmpOrderGroup()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00453">_BOOT_DRIVER_NODE::Group</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02169">CmGetSystemDriverList()</a>.
<p>
<pre class="fragment"><div>00926                    :
00927 
00928     This routine orders driver nodes in a group based on their dependencies
00929     on one another.  It removes any drivers that have circular dependencies
00930     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list.
00931 
00932 Arguments:
00933 
00934     DriverListHead - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> head of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of
00935             boot drivers to be sorted.
00936 
00937 Return Value:
00938 
00939     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - Dependencies successfully resolved
00940 
00941     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - Corrupt hive.
00942 
00943 --*/
00944 
00945 {
00946     PLIST_ENTRY CurrentEntry;
00947     <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">PBOOT_DRIVER_NODE</a> GroupStart;
00948     <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">PBOOT_DRIVER_NODE</a> GroupEnd;
00949     <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">PBOOT_DRIVER_NODE</a> CurrentNode;
00950 
00951     CurrentEntry = DriverListHead-&gt;Flink;
00952 
00953     <span class="keywordflow">while</span> (CurrentEntry != DriverListHead) {
00954         <span class="comment">//</span>
00955         <span class="comment">// The list is already ordered by groups.  Find the first and</span>
00956         <span class="comment">// last entry in each group, and order each of these sub-lists</span>
00957         <span class="comment">// based on their dependencies.</span>
00958         <span class="comment">//</span>
00959 
00960         GroupStart = CONTAINING_RECORD(CurrentEntry,
00961                                        <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">BOOT_DRIVER_NODE</a>,
00962                                        ListEntry.Link);
00963         <span class="keywordflow">do</span> {
00964             GroupEnd = CONTAINING_RECORD(CurrentEntry,
00965                                          <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">BOOT_DRIVER_NODE</a>,
00966                                          ListEntry.Link);
00967 
00968             CurrentEntry = CurrentEntry-&gt;Flink;
00969             CurrentNode = CONTAINING_RECORD(CurrentEntry,
00970                                             <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">BOOT_DRIVER_NODE</a>,
00971                                             ListEntry.Link);
00972 
00973             <span class="keywordflow">if</span> (CurrentEntry == DriverListHead) {
00974                 <span class="keywordflow">break</span>;
00975             }
00976 
00977             <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;GroupStart-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o1">Group</a>,
00978                                        &amp;CurrentNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o1">Group</a>,
00979                                        TRUE)) {
00980                 <span class="keywordflow">break</span>;
00981             }
00982 
00983         } <span class="keywordflow">while</span> ( CurrentEntry != DriverListHead );
00984 
00985         <span class="comment">//</span>
00986         <span class="comment">// GroupStart now points to the first driver node in the group,</span>
00987         <span class="comment">// and GroupEnd points to the last driver node in the group.</span>
00988         <span class="comment">//</span>
00989         <a class="code" href="../../d0/d0/cmboot_8c.html#a8">CmpOrderGroup</a>(GroupStart, GroupEnd);
00990 
00991     }
00992     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00993 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="cmboot.c::CmpSetCurrentProfile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpSetCurrentProfile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ControlSet</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html">PCM_HARDWARE_PROFILE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Profile</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01221">1221</a> of file <a class="el" href="../../d1/d9/cmboot_8c-source.html">cmboot.c</a>.
<p>
References <a class="el" href="../../d1/d2/cmp_8h.html#a299">CmpFindProfileOption()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01243">CmpFindValueByName</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00078">CmpValueToData</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a190">PCM_HARDWARE_PROFILE</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00499">_CM_KEY_VALUE::Type</a>.
<p>
<pre class="fragment"><div>01229                    :
01230 
01231     Edits <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> in-memory copy of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry to reflect <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hardware
01232     profile that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> booting from.
01233 
01234 Arguments:
01235 
01236     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure
01237 
01238     ControlSet - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> set.
01239 
01240     Profile - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> selected hardware profile
01241 
01242 Return Value:
01243 
01244     None.
01245 
01246 --*/
01247 
01248 {
01249     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> IDConfigDB;
01250     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> IDConfigNode;
01251     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CurrentConfigCell;
01252     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> CurrentConfigValue;
01253     UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
01254     PULONG CurrentConfig;
01255     ULONG realsize;
01256 
01257     IDConfigDB = <a class="code" href="../../d1/d2/cmp_8h.html#a299">CmpFindProfileOption</a>(Hive,
01258                                       ControlSet,
01259                                       NULL,
01260                                       NULL,
01261                                       NULL);
01262     <span class="keywordflow">if</span> (IDConfigDB != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01263         IDConfigNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, IDConfigDB);
01264         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"CurrentConfig"</span>);
01265         CurrentConfigCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(Hive,
01266                                                IDConfigNode,
01267                                                &amp;Name);
01268         <span class="keywordflow">if</span> (CurrentConfigCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01269             CurrentConfigValue = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, CurrentConfigCell);
01270             <span class="keywordflow">if</span> (CurrentConfigValue-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a> == REG_DWORD) {
01271                 CurrentConfig = (PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(Hive,
01272                                                        CurrentConfigValue,
01273                                                        realsize);
01274                 *CurrentConfig = Profile-&gt;Id;
01275             }
01276         }
01277     }
01278 
01279 
01280 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="cmboot.c::CmpSortDriverList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpSortDriverList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ControlSet</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverListHead</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00744">744</a> of file <a class="el" href="../../d1/d9/cmboot_8c-source.html">cmboot.c</a>.
<p>
References <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00837">CmpDoSort()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00186">CmpFindSubKeyByName()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01243">CmpFindValueByName</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00078">CmpValueToData</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00107">PHCELL_INDEX</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00499">_CM_KEY_VALUE::Type</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02169">CmGetSystemDriverList()</a>.
<p>
<pre class="fragment"><div>00752                    :
00753 
00754     Sorts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of boot drivers by their groups based on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group
00755     ordering in &lt;control_set&gt;\CONTROL\SERVICE_GROUP_ORDER:list
00756 
00757     Does NOT <span class="keywordflow">do</span> dependency ordering.
00758 
00759 Arguments:
00760 
00761     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SYSTEM hive.
00762 
00763     ControlSet - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> set.
00764 
00765     DriverListHead - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> head of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of
00766             boot drivers to be sorted.
00767 
00768 Return Value:
00769 
00770     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> successfully sorted
00771 
00772     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> inconsistent and could not be sorted.
00773 
00774 --*/
00775 
00776 {
00777     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Controls;
00778     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> GroupOrder;
00779     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ListCell;
00780     UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00781     UNICODE_STRING DependList;
00782     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00783     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00784     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> ListNode;
00785     ULONG realsize;
00786 
00787     <span class="comment">//</span>
00788     <span class="comment">// Find "CONTROL" node.</span>
00789     <span class="comment">//</span>
00790     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"Control"</span>);
00791     Controls = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(Hive,
00792                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,ControlSet),
00793                                    &amp;Name);
00794     <span class="keywordflow">if</span> (Controls == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00795         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00796     }
00797 
00798     <span class="comment">//</span>
00799     <span class="comment">// Find "SERVICE_GROUP_ORDER" subkey</span>
00800     <span class="comment">//</span>
00801     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"ServiceGroupOrder"</span>);
00802     GroupOrder = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(Hive,
00803                                      (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,Controls),
00804                                      &amp;Name);
00805     <span class="keywordflow">if</span> (GroupOrder == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00806         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00807     }
00808 
00809     <span class="comment">//</span>
00810     <span class="comment">// Find "list" value</span>
00811     <span class="comment">//</span>
00812     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"list"</span>);
00813     ListCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(Hive,
00814                                   (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,GroupOrder),
00815                                   &amp;Name);
00816     <span class="keywordflow">if</span> (ListCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00817         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00818     }
00819     ListNode = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ListCell);
00820     <span class="keywordflow">if</span> (ListNode-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a> != REG_MULTI_SZ) {
00821         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00822     }
00823 
00824     DependList.Buffer = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(Hive,ListNode,realsize);
00825     DependList.Length = DependList.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize - <span class="keyword">sizeof</span>(WCHAR);
00826 
00827     <span class="comment">//</span>
00828     <span class="comment">// Dependency list is now pointed to by DependList-&gt;Buffer.  We need</span>
00829     <span class="comment">// to sort the driver entry list.</span>
00830     <span class="comment">//</span>
00831 
00832     <span class="keywordflow">return</span> (<a class="code" href="../../d0/d0/cmboot_8c.html#a5">CmpDoSort</a>(DriverListHead, &amp;DependList));
00833 
00834 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:06 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
