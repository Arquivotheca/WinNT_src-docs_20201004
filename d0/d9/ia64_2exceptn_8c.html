<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ia64/exceptn.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>exceptn.c File Reference</h1><code>#include "<a class="el" href="../../d1/d9/ki_8h-source.html">ki.h</a>"</code><br>
<code>#include "<a class="el" href="../../d2/d7/ntfpia64_8h-source.html">ntfpia64.h</a>"</code><br>

<p>
<a href="../../d1/d8/ia64_2exceptn_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/ia64_2exceptn_8c.html#a0">DEFAULT_NO_ALIGNMENT_FIXUPS</a>&nbsp;&nbsp;&nbsp;FALSE</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/ia64_2exceptn_8c.html#a2">KiRestoreHigherFPVolatile</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/ia64_2exceptn_8c.html#a3">fp_emulate</a> (ULONG trap_type, PVOID pbundle, ULONGLONG *pipsr, ULONGLONG *pfpsr, ULONGLONG *pisr, ULONGLONG *ppreds, ULONGLONG *pifs, PVOID fp_state)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/ia64_2exceptn_8c.html#a4">KiEmulateFloat</a> (PEXCEPTION_RECORD ExceptionRecord, PKEXCEPTION_FRAME ExceptionFrame, PKTRAP_FRAME TrapFrame)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/ia64_2exceptn_8c.html#a5">KiDispatchException</a> (IN PEXCEPTION_RECORD ExceptionRecord, IN PKEXCEPTION_FRAME ExceptionFrame, IN PKTRAP_FRAME TrapFrame, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode, IN BOOLEAN FirstChance)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/ia64_2exceptn_8c.html#a6">KiCopyInformation</a> (IN OUT PEXCEPTION_RECORD ExceptionRecord1, IN PEXCEPTION_RECORD ExceptionRecord2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/ia64_2exceptn_8c.html#a7">KeRaiseUserException</a> (IN NTSTATUS ExceptionCode)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/ia64_2exceptn_8c.html#a1">KiEnableAlignmentFaultExceptions</a> = DEFAULT_NO_ALIGNMENT_FIXUPS ? 1 : 2</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="ia64/exceptn.c::DEFAULT_NO_ALIGNMENT_FIXUPS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DEFAULT_NO_ALIGNMENT_FIXUPS&nbsp;&nbsp;&nbsp;FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/ia64_2exceptn_8c-source.html#l00052">52</a> of file <a class="el" href="../../d1/d8/ia64_2exceptn_8c-source.html">ia64/exceptn.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="ia64/exceptn.c::fp_emulate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG fp_emulate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>trap_type</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>pbundle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONGLONG *&nbsp;</td>
          <td class="mdname" nowrap> <em>pipsr</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONGLONG *&nbsp;</td>
          <td class="mdname" nowrap> <em>pfpsr</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONGLONG *&nbsp;</td>
          <td class="mdname" nowrap> <em>pisr</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONGLONG *&nbsp;</td>
          <td class="mdname" nowrap> <em>ppreds</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONGLONG *&nbsp;</td>
          <td class="mdname" nowrap> <em>pifs</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>fp_state</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="ia64/exceptn.c::KeRaiseUserException" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS KeRaiseUserException           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN NTSTATUS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ExceptionCode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/ia64_2exceptn_8c-source.html#l00760">760</a> of file <a class="el" href="../../d1/d8/ia64_2exceptn_8c-source.html">ia64/exceptn.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02811">KeRaiseUserExceptionDispatcher</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
<pre class="fragment"><div>00766                    :
00767 
00768     This function causes an exception to be raised in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling thread's user-mode
00769     context. It does <span class="keyword">this</span> by editing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap frame <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel was entered with to
00770     point to trampoline code that raises <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested exception.
00771 
00772 Arguments:
00773 
00774     ExceptionCode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status value to be used as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception
00775         code <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be raised.
00776 
00777 Return Value:
00778 
00779     The status value that should be returned by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
00780 
00781 --*/
00782 
00783 {
00784     PKTRAP_FRAME TrapFrame;
00785 
00786     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetPreviousMode() == UserMode);
00787 
00788     TrapFrame = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;TrapFrame;
00789 
00790     <span class="keywordflow">try</span> {
00791         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a> ((PVOID)TrapFrame-&gt;IntSp, 16, <span class="keyword">sizeof</span>(QUAD));
00792         *(PULONGLONG)TrapFrame-&gt;IntSp = TrapFrame-&gt;BrRp;
00793         *(PULONGLONG)(TrapFrame-&gt;IntSp + 8) = TrapFrame-&gt;RsPFS;
00794     } except (EXCEPTION_EXECUTE_HANDLER) {
00795         <span class="keywordflow">return</span> (ExceptionCode);
00796     }
00797 
00798     TrapFrame-&gt;StIIP = ((PPLABEL_DESCRIPTOR)<a class="code" href="../../d4/d9/ke_8h.html#a151">KeRaiseUserExceptionDispatcher</a>)-&gt;EntryPoint;
00799     TrapFrame-&gt;StIFS &amp;= (0x3i64 &lt;&lt; 62);
00800     <span class="keywordflow">return</span>(ExceptionCode);
00801 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="ia64/exceptn.c::KiCopyInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG KiCopyInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PEXCEPTION_RECORD&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionRecord1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PEXCEPTION_RECORD&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionRecord2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/ia64_2exceptn_8c-source.html#l00722">722</a> of file <a class="el" href="../../d1/d8/ia64_2exceptn_8c-source.html">ia64/exceptn.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>.
<p>
<pre class="fragment"><div>00729                    :
00730 
00731     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called from an exception filter to copy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception
00732     information from one exception record to another when an exception occurs.
00733 
00734 Arguments:
00735 
00736     ExceptionRecord1 - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> destination exception record.
00737 
00738     ExceptionRecord2 - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source exception record.
00739 
00740 Return Value:
00741 
00742     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function value.
00743 
00744 --*/
00745 
00746 {
00747     <span class="comment">//</span>
00748     <span class="comment">// Copy one exception record to another and return value that causes</span>
00749     <span class="comment">// an exception handler to be executed.</span>
00750     <span class="comment">//</span>
00751 
00752     RtlMoveMemory((PVOID)ExceptionRecord1,
00753                   (PVOID)ExceptionRecord2,
00754                   <span class="keyword">sizeof</span>(EXCEPTION_RECORD));
00755 
00756     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>;
00757 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="ia64/exceptn.c::KiDispatchException" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiDispatchException           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PEXCEPTION_RECORD&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKEXCEPTION_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>FirstChance</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/ia64_2exceptn_8c-source.html#l00230">230</a> of file <a class="el" href="../../d1/d8/ia64_2exceptn_8c-source.html">ia64/exceptn.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00239">CONTEXT_FULL</a>, <a class="el" href="../../d7/d2/dbgkport_8c-source.html#l00099">DbgkForwardException()</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d8/4_2ia64_2kdtrap_8c-source.html#l00329">KdIsThisAKdTrap()</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d3/d8/ppc_2exceptn_8c-source.html#l00081">KeContextFromKframes()</a>, <a class="el" href="../../d3/d8/ppc_2exceptn_8c-source.html#l00230">KeContextToKframes()</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02810">KeUserExceptionDispatcher</a>, <a class="el" href="../../d3/d8/ppc_2exceptn_8c-source.html#l00886">KiCopyInformation()</a>, <a class="el" href="../../d1/d6/kdp_8h-source.html#l00437">KiDebugRoutine</a>, <a class="el" href="../../d1/d8/ia64_2exceptn_8c-source.html#l00098">KiEmulateFloat()</a>, <a class="el" href="../../d8/d4/ppc_2alignem_8c-source.html#l00255">KiEmulateReference()</a>, <a class="el" href="../../d9/d7/alpha_2exceptn_8c-source.html#l00077">KiEnableAlignmentFaultExceptions</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00025">KMODE_EXCEPTION_NOT_HANDLED</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00098">RtlDispatchException()</a>, <a class="el" href="../../d9/d9/rtl_2ia64_2miscc_8c-source.html#l00037">RtlpCaptureRnats()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
<pre class="fragment"><div>00240                    :
00241 
00242     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to dispatch an exception to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> proper mode and
00243     to cause <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception dispatcher to be called.
00244 
00245     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a data misalignment, <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first chance <span class="keywordflow">for</span>
00246     handling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread has enabled automatic
00247     alignment fixup, then an attempt <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to emulate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unaligned
00248     reference.
00249 
00250     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a floating exception (N.B. the pseudo status
00251     STATUS_FLOAT_STACK_CHECK is used to signify <span class="keyword">this</span> and is converted to the
00252     proper code by examiningg the main status field of the floating point 
00253     status <span class="keyword">register</span>).
00254 
00255     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> neither a data misalignment nor a floating point
00256     exception and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous mode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> kernel, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception
00257     dispatcher <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called directly to process <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception. Otherwise <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00258     exception record, exception frame, and trap frame contents are copied
00259     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user mode stack. The contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception frame and trap
00260     are then modified such that when <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned, execution will
00261     commense in user mode in a routine which will call <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception
00262     dispatcher.
00263 
00264 Arguments:
00265 
00266     ExceptionRecord - Supplies a pointer to an exception record.
00267 
00268     ExceptionFrame - Supplies a pointer to an exception frame.
00269 
00270     TrapFrame - Supplies a pointer to a trap frame.
00271 
00272     PreviousMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous processor mode.
00273 
00274     FirstChance - Supplies a <span class="keywordtype">boolean</span> variable that specifies whether <span class="keyword">this</span>
00275         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first (TRUE) or second (FALSE) time that this exception has
00276         been processed.
00277 
00278 Return Value:
00279 
00280     None.
00281 
00282 --*/
00283 
00284 {
00285 
00286     CONTEXT ContextFrame;
00287     EXCEPTION_RECORD ExceptionRecord1;
00288     PPLABEL_DESCRIPTOR Plabel;
00289     BOOLEAN UserApcPending;
00290 
00291     <span class="comment">//</span>
00292     <span class="comment">// If the exception is a data misalignment, the previous mode was user,</span>
00293     <span class="comment">// this is the first chance for handling the exception, and the current</span>
00294     <span class="comment">// thread has enabled automatic alignment fixup, then attempt to emulate</span>
00295     <span class="comment">// the unaligned reference.</span>
00296     <span class="comment">//</span>
00297 
00298 <span class="preprocessor">#if DBG</span>
00299 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (KiBreakOnAlignmentFault != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00300 
00301         <span class="keywordflow">if</span> (ExceptionRecord-&gt;ExceptionCode == STATUS_DATATYPE_MISALIGNMENT) {
00302 
00303             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KI: Alignment fault exr = %p Pc = %p Address = %p\n"</span>,
00304                      ExceptionRecord,
00305                      ExceptionRecord-&gt;ExceptionAddress,
00306                      ExceptionRecord-&gt;ExceptionInformation[2]);
00307 
00308             DbgBreakPoint();
00309         }
00310     }
00311 <span class="preprocessor">#endif</span>
00312 <span class="preprocessor"></span>
00313     <span class="keywordflow">if</span> ((ExceptionRecord-&gt;ExceptionCode == STATUS_DATATYPE_MISALIGNMENT) &amp;&amp;
00314         (FirstChance != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00315 
00316 <span class="preprocessor">#if DBG</span>
00317 <span class="preprocessor"></span>
00318         <span class="comment">//</span>
00319         <span class="comment">// Count alignment faults by mode and display them at intervals.</span>
00320         <span class="comment">//</span>
00321 
00322         <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00323             KiKernelFixupCount += 1;
00324             <span class="keywordflow">if</span> ((KiKernelFixupCount &amp; KiKernelFixupMask) == 0) {
00325                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KI: Kernel Fixup: Pid=0x%.3lx, Pc=%.16p, Address=%.16p ... Total=%ld\n"</span>,
00326                          <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;UniqueProcessId,
00327                          ExceptionRecord-&gt;ExceptionAddress,
00328                          ExceptionRecord-&gt;ExceptionInformation[1],
00329                          KiKernelFixupCount);
00330             }
00331 
00332         } <span class="keywordflow">else</span> {
00333             KiUserFixupCount += 1;
00334             <span class="keywordflow">if</span> ((KiUserFixupCount &amp; KiUserFixupMask) == 0) {
00335                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KI: User  Fixup: Pid=0x%.3lx, Pc=%.16p, Address=%.16p ... Total=%ld\n"</span>,
00336                          <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;UniqueProcessId,
00337                          ExceptionRecord-&gt;ExceptionAddress,
00338                          ExceptionRecord-&gt;ExceptionInformation[1],
00339                          KiUserFixupCount);
00340             }
00341         }
00342 
00343 <span class="preprocessor">#endif</span>
00344 <span class="preprocessor"></span>
00345         <span class="comment">//</span>
00346         <span class="comment">// If alignment fault exceptions are not enabled, then no exception</span>
00347         <span class="comment">// should be raised and the data reference should be emulated.</span>
00348         <span class="comment">//</span>
00349         <span class="comment">// We will emulate the reference if</span>
00350         <span class="comment">//      KiEnableAlignmentFaultExceptions == 0 (always fix up all faults, the default)</span>
00351         <span class="comment">// OR   The thread has explicitly enabled alignment fixups</span>
00352         <span class="comment">// OR   KiEnableAlignmentFaultExceptions == 2 and the process is not being debugged</span>
00353         <span class="comment">//</span>
00354 
00355         <span class="keywordflow">if</span> ( (<a class="code" href="../../d8/d8/alpha_2exceptn_8c.html#a1">KiEnableAlignmentFaultExceptions</a> == 0) ||
00356 
00357              ((<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;AutoAlignment != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ||
00358               (<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ApcState.Process-&gt;AutoAlignment != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) ||
00359 
00360              (((<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;DebugPort == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>)) &amp;&amp;
00361               (<a class="code" href="../../d8/d8/alpha_2exceptn_8c.html#a1">KiEnableAlignmentFaultExceptions</a> == 2)) ) {
00362 
00363             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a18">KiEmulateReference</a>(ExceptionRecord,
00364                                    ExceptionFrame,
00365                                    TrapFrame) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) 
00366             {
00367                 <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;KeAlignmentFixupCount += 1;
00368                 <span class="keywordflow">goto</span> Handled2;
00369             }
00370         }
00371     }
00372 
00373     <span class="comment">//</span>
00374     <span class="comment">// N.B. BREAKIN_BREAKPOINT check is in KdpTrap()</span>
00375     <span class="comment">//</span>
00376 
00377     <span class="comment">//</span>
00378     <span class="comment">// If the exception is a floating point exception, then the</span>
00379     <span class="comment">// ExceptionCode was set to STATUS_FLOAT_MULTIPLE_TRAPS or </span>
00380     <span class="comment">// STATUS_FLOAT_MULTIPLE_FAULTS.</span>
00381     <span class="comment">//</span>
00382 
00383     <span class="keywordflow">if</span> ((ExceptionRecord-&gt;ExceptionCode == STATUS_FLOAT_MULTIPLE_FAULTS) ||
00384         (ExceptionRecord-&gt;ExceptionCode == STATUS_FLOAT_MULTIPLE_TRAPS)) {
00385 
00386         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d9/ia64_2exceptn_8c.html#a4">KiEmulateFloat</a>(ExceptionRecord, ExceptionFrame, TrapFrame)) {
00387 
00388             <span class="comment">//</span>
00389             <span class="comment">// Emulation is successful; continue execution</span>
00390             <span class="comment">//</span>
00391 
00392             <span class="keywordflow">return</span>;
00393         }
00394     }
00395 
00396     <span class="comment">//</span>
00397     <span class="comment">// Move machine state from trap and exception frames to a context frame,</span>
00398     <span class="comment">// and increment the number of exceptions dispatched.</span>
00399     <span class="comment">//</span>
00400 
00401     ContextFrame.ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a152">CONTEXT_FULL</a>;
00402     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a9">KeContextFromKframes</a>(TrapFrame, ExceptionFrame, &amp;ContextFrame);
00403     <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;KeExceptionDispatchCount += 1;
00404 
00405     <span class="comment">//</span>
00406     <span class="comment">// Select the method of handling the exception based on the previous mode.</span>
00407     <span class="comment">//</span>
00408 
00409     <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00410 
00411         <span class="comment">//</span>
00412         <span class="comment">// Previous mode was kernel.</span>
00413         <span class="comment">//</span>
00414         <span class="comment">// If this is the first chance, the kernel debugger is active, and</span>
00415         <span class="comment">// the exception is a kernel breakpoint, then give the kernel debugger</span>
00416         <span class="comment">// a chance to handle the exception.</span>
00417         <span class="comment">//</span>
00418         <span class="comment">// If this is the first chance and the kernel debugger is not active</span>
00419         <span class="comment">// or does not handle the exception, then attempt to find a frame</span>
00420         <span class="comment">// handler to handle the exception.</span>
00421         <span class="comment">//</span>
00422         <span class="comment">// If this is the second chance or the exception is not handled, then</span>
00423         <span class="comment">// if the kernel debugger is active, then give the kernel debugger a</span>
00424         <span class="comment">// second chance to handle the exception. If the kernel debugger does</span>
00425         <span class="comment">// not handle the exception, then bug check.</span>
00426         <span class="comment">//</span>
00427 
00428         <span class="keywordflow">if</span> (FirstChance != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00429 
00430             <span class="comment">//</span>
00431             <span class="comment">// This is the first chance to handle the exception.</span>
00432             <span class="comment">//</span>
00433             <span class="comment">// Note: RtlpCaptureRnats() flushes the RSE and captures the</span>
00434             <span class="comment">//       Nat bits of stacked registers in the RSE frame at</span>
00435             <span class="comment">//       which exception happens.</span>
00436             <span class="comment">//</span>
00437 
00438             <a class="code" href="../../d8/d0/rtl_2ia64_2miscc_8c.html#a1">RtlpCaptureRnats</a>(&amp;ContextFrame);
00439             TrapFrame-&gt;RsRNAT = ContextFrame.RsRNAT;
00440 
00441             <span class="comment">//</span>
00442             <span class="comment">// If the kernel debugger is active, the exception is a breakpoint,</span>
00443             <span class="comment">// and the breakpoint is handled by the kernel debugger, then give</span>
00444             <span class="comment">// the kernel debugger a chance to handle the exception.</span>
00445             <span class="comment">//</span>
00446 
00447             <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00448                (ExceptionRecord-&gt;ExceptionCode == STATUS_BREAKPOINT) &amp;&amp;
00449                (<a class="code" href="../../d3/d9/4_2ia64_2kdtrap_8c.html#a1">KdIsThisAKdTrap</a>(ExceptionRecord,
00450                                 &amp;ContextFrame,
00451                                 KernelMode) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00452 
00453                 <span class="keywordflow">if</span> (((<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a>) (TrapFrame,
00454                                        ExceptionFrame,
00455                                        ExceptionRecord,
00456                                        &amp;ContextFrame,
00457                                        <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00458                                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00459 
00460                     <span class="keywordflow">goto</span> Handled1;
00461                 }
00462             }
00463 
00464             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a7">RtlDispatchException</a>(ExceptionRecord, &amp;ContextFrame) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00465                 <span class="keywordflow">goto</span> Handled1;
00466             }
00467         }
00468 
00469         <span class="comment">//</span>
00470         <span class="comment">// This is the second chance to handle the exception.</span>
00471         <span class="comment">//</span>
00472 
00473         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00474             <span class="keywordflow">if</span> (((<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a>) (TrapFrame,
00475                                    ExceptionFrame,
00476                                    ExceptionRecord,
00477                                    &amp;ContextFrame,
00478                                    PreviousMode,
00479                                    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00480                 <span class="keywordflow">goto</span> Handled1;
00481             }
00482         }
00483 
00484         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(KMODE_EXCEPTION_NOT_HANDLED,
00485                      ExceptionRecord-&gt;ExceptionCode,
00486                      (ULONG_PTR)ExceptionRecord-&gt;ExceptionAddress,
00487                      ExceptionRecord-&gt;ExceptionInformation[0],
00488                      ExceptionRecord-&gt;ExceptionInformation[1]);
00489 
00490     } <span class="keywordflow">else</span> {
00491 
00492         <span class="comment">//</span>
00493         <span class="comment">// Previous mode was user.</span>
00494         <span class="comment">//</span>
00495         <span class="comment">// If this is the first chance, the kernel debugger is active, the</span>
00496         <span class="comment">// exception is a kernel breakpoint, and the current process is not</span>
00497         <span class="comment">// being debugged, or the current process is being debugged, but the</span>
00498         <span class="comment">// the breakpoint is not a kernel breakpoint instruction, then give</span>
00499         <span class="comment">// the kernel debugger a chance to handle the exception.</span>
00500         <span class="comment">//</span>
00501         <span class="comment">// If this is the first chance and the current process has a debugger</span>
00502         <span class="comment">// port, then send a message to the debugger port and wait for a reply.</span>
00503         <span class="comment">// If the debugger handles the exception, then continue execution. Else</span>
00504         <span class="comment">// transfer the exception information to the user stack, transition to</span>
00505         <span class="comment">// user mode, and attempt to dispatch the exception to a frame based</span>
00506         <span class="comment">// handler. If a frame based handler handles the exception, then continue</span>
00507         <span class="comment">// execution. Otherwise, execute the raise exception system service</span>
00508         <span class="comment">// which will call this routine a second time to process the exception.</span>
00509         <span class="comment">//</span>
00510         <span class="comment">// If this is the second chance and the current process has a debugger</span>
00511         <span class="comment">// port, then send a message to the debugger port and wait for a reply.</span>
00512         <span class="comment">// If the debugger handles the exception, then continue execution. Else</span>
00513         <span class="comment">// if the current process has a subsystem port, then send a message to</span>
00514         <span class="comment">// the subsystem port and wait for a reply. If the subsystem handles the</span>
00515         <span class="comment">// exception, then continue execution. Else terminate the thread.</span>
00516         <span class="comment">//</span>
00517 
00518         <span class="keywordflow">if</span> (FirstChance != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00519 
00520             <span class="comment">//</span>
00521             <span class="comment">// If the kernel debugger is active, the exception is a kernel</span>
00522             <span class="comment">// breakpoint, and the current process is not being debugged,</span>
00523             <span class="comment">// or the current process is being debugged, but the breakpoint</span>
00524             <span class="comment">// is not a kernel breakpoint instruction, then give the kernel</span>
00525             <span class="comment">// debugger a chance to handle the exception.</span>
00526             <span class="comment">//</span>
00527 
00528             <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00529                 (ExceptionRecord-&gt;ExceptionCode == STATUS_BREAKPOINT) &amp;&amp;
00530                 (<a class="code" href="../../d3/d9/4_2ia64_2kdtrap_8c.html#a1">KdIsThisAKdTrap</a>(ExceptionRecord,
00531                                  &amp;ContextFrame,
00532                                  UserMode) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
00533                 ((<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;DebugPort == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00534                 ((<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;DebugPort != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00535                 (ExceptionRecord-&gt;ExceptionInformation[0] !=
00536                                             DEBUG_STOP_BREAKPOINT)))) {
00537 
00538                 <span class="keywordflow">if</span> (((<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a>) (TrapFrame,
00539                                        ExceptionFrame,
00540                                        ExceptionRecord,
00541                                        &amp;ContextFrame,
00542                                        <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
00543                                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00544 
00545                     <span class="keywordflow">goto</span> Handled1;
00546                 }
00547             }
00548 
00549             <span class="comment">//</span>
00550             <span class="comment">// This is the first chance to handle the exception.</span>
00551             <span class="comment">//</span>
00552 
00553             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/dbgk_8h.html#a5">DbgkForwardException</a>(ExceptionRecord, TRUE, FALSE)) {
00554                 TrapFrame-&gt;StFPSR = SANITIZE_FSR(TrapFrame-&gt;StFPSR, UserMode);
00555                 <span class="keywordflow">goto</span> Handled2;
00556             }
00557 
00558             <span class="comment">//</span>
00559             <span class="comment">// Transfer exception information to the user stack, transition</span>
00560             <span class="comment">// to user mode, and attempt to dispatch the exception to a frame</span>
00561             <span class="comment">// based handler.</span>
00562             <span class="comment">//</span>
00563             <span class="comment">//</span>
00564             <span class="comment">// We are running on the kernel stack now.  On the user stack, we</span>
00565             <span class="comment">// build a stack frame containing the following:</span>
00566             <span class="comment">//</span>
00567             <span class="comment">//               |                                   |</span>
00568             <span class="comment">//               |-----------------------------------|</span>
00569             <span class="comment">//               |                                   |</span>
00570             <span class="comment">//               |   User's stack frame              |</span>
00571             <span class="comment">//               |                                   |</span>
00572             <span class="comment">//               |-----------------------------------|</span>
00573             <span class="comment">//               |                                   |</span>
00574             <span class="comment">//               |   Context record                  |</span>
00575             <span class="comment">//               |                                   |</span>
00576             <span class="comment">//               |                                   |</span>
00577             <span class="comment">//               |- - - - - - - - - - - - - - - - - -|</span>
00578             <span class="comment">//               |                                   |</span>
00579             <span class="comment">//               |   Exception record                |</span>
00580             <span class="comment">//               |                                   |</span>
00581             <span class="comment">//               |- - - - - - - - - - - - - - - - - -|</span>
00582             <span class="comment">//               |   Stack Scratch Area              |</span>
00583             <span class="comment">//               |-----------------------------------|</span>
00584             <span class="comment">//               |                                   |</span>
00585             <span class="comment">//</span>
00586             <span class="comment">// This stack frame is for KiUserExceptionDispatcher, the assembly</span>
00587             <span class="comment">// langauge routine that effects transfer in user mode to</span>
00588             <span class="comment">// RtlDispatchException.  KiUserExceptionDispatcher is passed</span>
00589             <span class="comment">// pointers to the Exception Record and Context Record as</span>
00590             <span class="comment">// parameters.</span>
00591             <span class="comment">//</span>
00592 
00593         repeat:
00594             <span class="keywordflow">try</span> {
00595 
00596                 <span class="comment">//</span>
00597                 <span class="comment">// Compute length of exception record and new aligned stack</span>
00598                 <span class="comment">// address.</span>
00599                 <span class="comment">//</span>
00600 
00601                 ULONG Length = (STACK_SCRATCH_AREA + 15 +
00602                                 <span class="keyword">sizeof</span>(EXCEPTION_REGISTRATION_RECORD) +
00603                                 <span class="keyword">sizeof</span>(EXCEPTION_RECORD) + <span class="keyword">sizeof</span>(CONTEXT)) &amp; ~(15);
00604                 ULONGLONG UserStack = (ContextFrame.IntSp &amp; (~15)) - Length;
00605                 ULONGLONG ContextSlot = UserStack + STACK_SCRATCH_AREA;
00606                 ULONGLONG ExceptSlot = ContextSlot + <span class="keyword">sizeof</span>(CONTEXT);
00607                 PULONGLONG PUserStack = (PULONGLONG) UserStack;
00608                 
00609                 <span class="comment">//</span>
00610                 <span class="comment">// Probe user stack area for writeability and then transfer the</span>
00611                 <span class="comment">// exception record and conext record to the user stack area.</span>
00612                 <span class="comment">//</span>
00613 
00614                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>((PCHAR)UserStack, Length, <span class="keyword">sizeof</span>(QUAD));
00615                 RtlMoveMemory((PVOID)ContextSlot, &amp;ContextFrame, 
00616                               <span class="keyword">sizeof</span>(CONTEXT));
00617                 RtlMoveMemory((PVOID)ExceptSlot, ExceptionRecord, 
00618                               <span class="keyword">sizeof</span>(EXCEPTION_RECORD));
00619 
00620                 <span class="comment">//</span>
00621                 <span class="comment">// Set address of exception record and context record in</span>
00622                 <span class="comment">// the exception frame and the new stack pointer in the </span>
00623                 <span class="comment">// current trap frame.  Also set the initial frame size</span>
00624                 <span class="comment">// to be zero.</span>
00625                 <span class="comment">//</span>
00626                 <span class="comment">// N.B. User exception dispatcher flushes the RSE</span>
00627                 <span class="comment">//      and updates the BSPStore field upon entry.</span>
00628                 <span class="comment">//</span>
00629 
00630                 TrapFrame-&gt;RsPFS = TrapFrame-&gt;StIFS;
00631                 TrapFrame-&gt;StIFS &amp;= 0xffffffc000000000;
00632                 TrapFrame-&gt;StIPSR &amp;= ~((0x3i64 &lt;&lt; PSR_RI) | (0x1i64 &lt;&lt; PSR_IS));
00633                 TrapFrame-&gt;IntSp = UserStack;
00634                 TrapFrame-&gt;IntNats = 0;
00635 
00636                 ExceptionFrame-&gt;IntS0 = ExceptSlot;
00637                 ExceptionFrame-&gt;IntS1 = ContextSlot;
00638                 ExceptionFrame-&gt;IntNats = 0;
00639 
00640                 <span class="comment">//</span>
00641                 <span class="comment">// Set the address and the gp of the exception routine that </span>
00642                 <span class="comment">// will call the exception dispatcher and then return to the </span>
00643                 <span class="comment">// trap handler.  The trap handler will restore the exception </span>
00644                 <span class="comment">// and trap frame context and continue execution in the routine</span>
00645                 <span class="comment">// that will call the exception dispatcher.</span>
00646                 <span class="comment">//</span>
00647 
00648                 Plabel = (PPLABEL_DESCRIPTOR)<a class="code" href="../../d4/d9/ke_8h.html#a150">KeUserExceptionDispatcher</a>;
00649                 TrapFrame-&gt;StIIP = Plabel-&gt;EntryPoint;
00650                 TrapFrame-&gt;IntGp = Plabel-&gt;GlobalPointer;
00651 
00652                 <span class="keywordflow">return</span>;
00653 
00654             <span class="comment">//</span>
00655             <span class="comment">// If an exception occurs, then copy the new exception information</span>
00656             <span class="comment">// to an exception record and handle the exception.</span>
00657             <span class="comment">//</span>
00658 
00659             } except (<a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a12">KiCopyInformation</a>(&amp;ExceptionRecord1,
00660                                (GetExceptionInformation())-&gt;ExceptionRecord)) {
00661 
00662                 <span class="comment">//</span>
00663                 <span class="comment">// If the exception is a stack overflow, then attempt</span>
00664                 <span class="comment">// to raise the stack overflow exception. Otherwise,</span>
00665                 <span class="comment">// the user's stack is not accessible, or is misaligned,</span>
00666                 <span class="comment">// and second chance processing is performed.</span>
00667                 <span class="comment">//</span>
00668 
00669                 <span class="keywordflow">if</span> (ExceptionRecord1.ExceptionCode == STATUS_STACK_OVERFLOW) {
00670                     ExceptionRecord1.ExceptionAddress = ExceptionRecord-&gt;ExceptionAddress;
00671                     RtlMoveMemory((PVOID)ExceptionRecord,
00672                                   &amp;ExceptionRecord1, <span class="keyword">sizeof</span>(EXCEPTION_RECORD));
00673                     <span class="keywordflow">goto</span> repeat;
00674                 }
00675             }
00676         }
00677 
00678         <span class="comment">//</span>
00679         <span class="comment">// This is the second chance to handle the exception.</span>
00680         <span class="comment">//</span>
00681 
00682         UserApcPending = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ApcState.UserApcPending;
00683         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/dbgk_8h.html#a5">DbgkForwardException</a>(ExceptionRecord, TRUE, TRUE)) {
00684             TrapFrame-&gt;StFPSR = SANITIZE_FSR(TrapFrame-&gt;StFPSR, UserMode);
00685             <span class="keywordflow">goto</span> Handled2;
00686 
00687         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/dbgk_8h.html#a5">DbgkForwardException</a>(ExceptionRecord, FALSE, TRUE)) {
00688             TrapFrame-&gt;StFPSR = SANITIZE_FSR(TrapFrame-&gt;StFPSR, UserMode);
00689             <span class="keywordflow">goto</span> Handled2;
00690 
00691         } <span class="keywordflow">else</span> {
00692             ZwTerminateProcess(NtCurrentProcess(), ExceptionRecord-&gt;ExceptionCode);
00693             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(KMODE_EXCEPTION_NOT_HANDLED,
00694                          ExceptionRecord-&gt;ExceptionCode,
00695                          (ULONG_PTR)ExceptionRecord-&gt;ExceptionAddress,
00696                          ExceptionRecord-&gt;ExceptionInformation[0],
00697                          ExceptionRecord-&gt;ExceptionInformation[1]);
00698         }
00699     }
00700 
00701     <span class="comment">//</span>
00702     <span class="comment">// Move machine state from context frame to trap and exception frames and</span>
00703     <span class="comment">// then return to continue execution with the restored state.</span>
00704     <span class="comment">//</span>
00705 
00706 Handled1:
00707     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a10">KeContextToKframes</a>(TrapFrame, ExceptionFrame, &amp;ContextFrame,
00708                        ContextFrame.ContextFlags, PreviousMode);
00709 
00710     <span class="comment">//</span>
00711     <span class="comment">// Exception was handled by the debugger or the associated subsystem</span>
00712     <span class="comment">// and state was modified, if necessary, using the get state and set</span>
00713     <span class="comment">// state capabilities. Therefore the context frame does not need to</span>
00714     <span class="comment">// be transfered to the trap and exception frames.</span>
00715     <span class="comment">//</span>
00716 
00717 Handled2:
00718     <span class="keywordflow">return</span>;
00719 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="ia64/exceptn.c::KiEmulateFloat" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KiEmulateFloat           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PEXCEPTION_RECORD&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PKEXCEPTION_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/ia64_2exceptn_8c-source.html#l00098">98</a> of file <a class="el" href="../../d1/d8/ia64_2exceptn_8c-source.html">ia64/exceptn.c</a>.
<p>
References <a class="el" href="../../d2/d7/ntfpia64_8h-source.html#l00008">_FLOATING_POINT_STATE::ExceptionFrame</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d8/ntfpia64_8h.html#a0">FLOATING_POINT_STATE</a>, <a class="el" href="../../d3/d3/ia64_2floatem_8c-source.html#l00238">fp_emulate()</a>, <a class="el" href="../../d9/d2/ia32def_8h-source.html#l00222">ISRCode</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html#l01130">KiAdvanceInstPointer()</a>, <a class="el" href="../../d0/d9/ia64_2exceptn_8c.html#a2">KiRestoreHigherFPVolatile()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d7/ntfpia64_8h-source.html#l00007">_FLOATING_POINT_STATE::TrapFrame</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d1/d8/ia64_2exceptn_8c-source.html#l00230">KiDispatchException()</a>.
<p>
<pre class="fragment"><div>00103 {
00104 
00105     <a class="code" href="../../d8/d2/struct__FLOATING__POINT__STATE.html">FLOATING_POINT_STATE</a> FpState;
00106     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a>;
00107     ULONG TrapType;
00108     PVOID ExceptionAddress;
00109     LONG <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = -1;
00110 
00111     FpState.<a class="code" href="../../d8/d2/struct__FLOATING__POINT__STATE.html#o1">ExceptionFrame</a> = (PVOID)ExceptionFrame;
00112     FpState.<a class="code" href="../../d8/d2/struct__FLOATING__POINT__STATE.html#o0">TrapFrame</a> = (PVOID)TrapFrame;
00113 
00114     <span class="keywordflow">if</span> (ExceptionRecord-&gt;ExceptionCode == STATUS_FLOAT_MULTIPLE_FAULTS) {
00115         TrapType = 1;
00116         ExceptionAddress = (PVOID)TrapFrame-&gt;StIIP;
00117     } <span class="keywordflow">else</span> {
00118         TrapType = 0;
00119         ExceptionAddress = (PVOID)TrapFrame-&gt;StIIPA;
00120     }
00121 
00122     <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a91">fp_emulate</a>(TrapType, ExceptionAddress,
00123                       &amp;TrapFrame-&gt;StIPSR, &amp;TrapFrame-&gt;StFPSR, &amp;TrapFrame-&gt;StISR,
00124                       &amp;TrapFrame-&gt;Preds, &amp;TrapFrame-&gt;StIFS, (PVOID)&amp;FpState)) == 0) {
00125 
00126        <span class="comment">//</span>
00127        <span class="comment">// Exception was handled and state modified.</span>
00128        <span class="comment">// Therefore the context frame does not need to</span>
00129        <span class="comment">// be transfered to the trap and exception frames.</span>
00130        <span class="comment">//</span>
00131        <span class="comment">// Since it was fault, PC should be advanced</span>
00132        <span class="comment">//</span>
00133 
00134        <span class="keywordflow">if</span> (TrapType == 1) {
00135            <a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a13">KiAdvanceInstPointer</a>(TrapFrame);
00136        }
00137 
00138        <span class="keywordflow">if</span> (TrapFrame-&gt;StIPSR &amp; (1 &lt;&lt; PSR_MFH)) {
00139 
00140            <span class="comment">//</span>
00141            <span class="comment">// high fp set is modified, reload high fp register set</span>
00142            <span class="comment">// must prevent interrupt during restore</span>
00143            <span class="comment">//</span>
00144 
00145            __rsm ((1 &lt;&lt; PSR_DFH) | (1 &lt;&lt; PSR_I));
00146            <a class="code" href="../../d0/d9/ia64_2exceptn_8c.html#a2">KiRestoreHigherFPVolatile</a>();
00147            __ssm ((1 &lt;&lt; PSR_DFH) | (1 &lt;&lt; PSR_I));
00148            __dsrlz();
00149        }
00150 
00151        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00152     }
00153 
00154     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == -1) {
00155         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(FP_EMULATION_ERROR, 
00156                      (ULONG_PTR)TrapFrame, 
00157                      (ULONG_PTR)ExceptionFrame, 0, 0);
00158     } 
00159 
00160     <a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)TrapFrame-&gt;StISR;
00161 
00162     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> &amp; 0x1) {
00163 
00164         ExceptionRecord-&gt;ExceptionInformation[4] = TrapFrame-&gt;StISR;
00165 
00166         <span class="keywordflow">if</span> (!(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> &amp; 0x4)) {
00167             <span class="keywordflow">if</span> (TrapType == 1) {
00168 
00169                 <span class="comment">//</span>
00170                 <span class="comment">// FP Fault</span>
00171                 <span class="comment">//</span>
00172 
00173                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a> &amp; 0x11) {
00174                     ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_INVALID_OPERATION;
00175                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a> &amp; 0x22) {
00176                     ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_DENORMAL_OPERAND;
00177                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a> &amp; 0x44) {
00178                     ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_DIVIDE_BY_ZERO;
00179                 }
00180 
00181             } <span class="keywordflow">else</span> {
00182 
00183                 <span class="comment">//</span>
00184                 <span class="comment">// FP Trap</span>
00185                 <span class="comment">//</span>
00186 
00187                 <a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a> = <a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a> &gt;&gt; 7;
00188                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a> &amp; 0x11) {
00189                     ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_OVERFLOW;
00190                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a> &amp; 0x22) {
00191                     ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_UNDERFLOW;
00192                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a> &amp; 0x44) {
00193                     ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_INEXACT_RESULT;
00194                 }
00195 
00196             }
00197         }
00198 
00199         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> &amp; 0x2) {
00200 
00201             <span class="comment">//</span>
00202             <span class="comment">// FP Fault To Trap</span>
00203             <span class="comment">//</span>
00204 
00205             <a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a13">KiAdvanceInstPointer</a>(TrapFrame);
00206             ExceptionRecord-&gt;ExceptionAddress =
00207                 (PVOID) RtlIa64InsertIPSlotNumber
00208                             (TrapFrame-&gt;StIIP,
00209                              ((TrapFrame-&gt;StISR &amp; ISR_EI_MASK) &gt;&gt; ISR_EI)
00210                             );
00211             <span class="keywordflow">if</span> (!(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> &amp; 0x4)) {
00212                 <a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a> = <a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a> &gt;&gt; 7;
00213                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a> &amp; 0x11) {
00214                     ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_OVERFLOW;
00215                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a> &amp; 0x22) {
00216                     ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_UNDERFLOW;
00217                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a> &amp; 0x44) {
00218                     ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_INEXACT_RESULT;
00219                 }
00220             } <span class="keywordflow">else</span> {
00221                 ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_MULTIPLE_TRAPS;
00222             }
00223         }
00224     }
00225 
00226     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00227 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="ia64/exceptn.c::KiRestoreHigherFPVolatile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiRestoreHigherFPVolatile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d1/d8/ia64_2exceptn_8c-source.html#l00098">KiEmulateFloat()</a>.    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a1" doxytag="ia64/exceptn.c::KiEnableAlignmentFaultExceptions" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d2/d9/ppc_2exceptn_8c.html#a6">KiEnableAlignmentFaultExceptions</a> = DEFAULT_NO_ALIGNMENT_FIXUPS ? 1 : 2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/ia64_2exceptn_8c-source.html#l00054">54</a> of file <a class="el" href="../../d1/d8/ia64_2exceptn_8c-source.html">ia64/exceptn.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:34 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
