<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: protect.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>protect.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d1/d8/protect_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>HARDWARE_PTE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/protect_8c.html#a1">MiFlushTbAndCapture</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PtePointer, IN HARDWARE_PTE TempPte, IN <a class="el" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/protect_8c.html#a2">MiSetProtectionOnTransitionPte</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte, IN ULONG ProtectionMask)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/protect_8c.html#a3">MiCaptureSystemPte</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerProtoPte, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/protect_8c.html#a4">NtProtectVirtualMemory</a> (IN HANDLE ProcessHandle, IN OUT PVOID *BaseAddress, IN OUT PSIZE_T RegionSize, IN ULONG NewProtect, OUT PULONG OldProtect)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/protect_8c.html#a5">MiProtectVirtualMemory</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN PVOID *BaseAddress, IN PSIZE_T RegionSize, IN ULONG NewProtect, IN PULONG LastProtect)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/protect_8c.html#a6">MiSetProtectionOnSection</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> FoundVad, IN PVOID StartingAddress, IN PVOID EndingAddress, IN ULONG NewProtect, OUT PULONG CapturedOldProtect, IN ULONG DontCharge)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/protect_8c.html#a7">MiGetPageProtection</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/protect_8c.html#a8">MiChangeNoAccessForkPte</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte, IN ULONG ProtectionMask)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/protect_8c.html#a9">MiCheckSecuredVad</a> (IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad, IN PVOID Base, IN SIZE_T <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>, IN ULONG ProtectionMask)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>CCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/protect_8c.html#a0">MmReadWrite</a> [32]</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="protect.c::MiCaptureSystemPte" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> MiCaptureSystemPte           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PointerProtoPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/protect_8c-source.html#l02204">2204</a> of file <a class="el" href="../../d1/d8/protect_8c-source.html">protect.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00837">MiMakeSystemAddressValidPfnWs()</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
<pre class="fragment"><div>02211                    :
02212 
02213     Nonpagable helper routine to capture <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contents of a pagable PTE.
02214 
02215 Arguments:
02216 
02217     PointerProtoPte - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> prototype PTE.
02218 
02219     Process - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relevant process.
02220 
02221 Return Value:
02222 
02223     PTE contents.
02224 
02225 Environment:
02226 
02227     Kernel mode.  Caller holds address space and working set mutexes <span class="keywordflow">if</span>
02228     Process <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set.  Working set mutex was acquired unsafe.
02229 
02230 --*/
02231 
02232 {
02233     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
02234     KIRQL OldIrql;
02235 
02236     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02237     <a class="code" href="../../d0/d2/mmsup_8c.html#a9">MiMakeSystemAddressValidPfnWs</a> (PointerProtoPte, Process);
02238     TempPte = *PointerProtoPte;
02239     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02240     <span class="keywordflow">return</span> TempPte;
02241 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="protect.c::MiChangeNoAccessForkPte" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG MiChangeNoAccessForkPte           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PointerPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ProtectionMask</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/protect_8c-source.html#l02032">2032</a> of file <a class="el" href="../../d1/d8/protect_8c-source.html">protect.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00145">MM_NOACCESS</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d8/protect_8c-source.html#l00344">MiProtectVirtualMemory()</a>, and <a class="el" href="../../d1/d8/protect_8c-source.html#l01110">MiSetProtectionOnSection()</a>.
<p>
<pre class="fragment"><div>02039                    :
02040 
02041 
02042 Arguments:
02043 
02044     PointerPte - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current PTE.
02045 
02046     ProtectionMask - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection mask to set.
02047 
02048 Return Value:
02049 
02050     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loop should be repeated <span class="keywordflow">for</span> <span class="keyword">this</span> PTE, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
02051     <span class="keywordflow">if</span> protection has been set.
02052 
02053 
02054 Environment:
02055 
02056     Kernel mode, address creation mutex held, APCs disabled.
02057 
02058 --*/
02059 
02060 {
02061     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02062 
02063     <span class="keywordflow">if</span> (ProtectionMask == <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>) {
02064 
02065         <span class="comment">//</span>
02066         <span class="comment">// No need to change the page protection.</span>
02067         <span class="comment">//</span>
02068 
02069         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02070     }
02071 
02072     PointerPte-&gt;u.Proto.ReadOnly = 1;
02073 
02074     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02075 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="protect.c::MiCheckSecuredVad" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiCheckSecuredVad           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vad</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Base</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ProtectionMask</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/protect_8c-source.html#l02244">2244</a> of file <a class="el" href="../../d1/d8/protect_8c-source.html">protect.c</a>.
<p>
References <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00050">End</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02379">_MMSECURE_ENTRY::EndVpn</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02380">_MMSECURE_ENTRY::List</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00143">MM_GUARD_PAGE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00158">MM_SECURE_DELETE_CHECK</a>, <a class="el" href="../../d6/d2/acceschk_8c-source.html#l00035">MmReadWrite</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02378">_MMSECURE_ENTRY::StartVpn</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o2">_MMSECURE_ENTRY::u2</a>.
<p>
Referenced by <a class="el" href="../../d1/d8/protect_8c-source.html#l00344">MiProtectVirtualMemory()</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00090">MmUnmapViewOfSection()</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>, and <a class="el" href="../../d4/d6/freevm_8c-source.html#l00066">NtFreeVirtualMemory()</a>.
<p>
<pre class="fragment"><div>02253                    :
02254 
02255     This routine checks to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified VAD <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> secured in such
02256     a way as to conflict with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address range and protection mask
02257     specified.
02258 
02259 Arguments:
02260 
02261     Vad - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> VAD containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address range.
02262 
02263     Base - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection starts at.
02264 
02265     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range.
02266 
02267     ProtectionMask - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection mask being set.
02268 
02269 Return Value:
02270 
02271     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> value.
02272 
02273 Environment:
02274 
02275     Kernel mode.
02276 
02277 --*/
02278 
02279 {
02280     PVOID <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
02281     PLIST_ENTRY Next;
02282     <a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">PMMSECURE_ENTRY</a> Entry;
02283     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02284 
02285     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = (PVOID)((PCHAR)Base + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
02286 
02287     <span class="keywordflow">if</span> (ProtectionMask &lt; <a class="code" href="../../d4/d8/mi_8h.html#a55">MM_SECURE_DELETE_CHECK</a>) {
02288         <span class="keywordflow">if</span> ((Vad-&gt;u.VadFlags.NoChange == 1) &amp;&amp;
02289             (Vad-&gt;u2.VadFlags2.SecNoChange == 1) &amp;&amp;
02290             (Vad-&gt;u.VadFlags.Protection != ProtectionMask)) {
02291 
02292             <span class="comment">//</span>
02293             <span class="comment">// An attempt is made at changing the protection</span>
02294             <span class="comment">// of a SEC_NO_CHANGE section - return an error.</span>
02295             <span class="comment">//</span>
02296 
02297             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PAGE_PROTECTION;
02298             <span class="keywordflow">goto</span> done;
02299         }
02300     } <span class="keywordflow">else</span> {
02301 
02302         <span class="comment">//</span>
02303         <span class="comment">// Deletion - set to no-access for check.  SEC_NOCHANGE allows</span>
02304         <span class="comment">// deletion, but does not allow page protection changes.</span>
02305         <span class="comment">//</span>
02306 
02307         ProtectionMask = 0;
02308     }
02309 
02310     <span class="keywordflow">if</span> (Vad-&gt;u2.VadFlags2.OneSecured) {
02311 
02312         <span class="keywordflow">if</span> (((ULONG_PTR)Base &lt;= Vad-&gt;u3.Secured.EndVpn) &amp;&amp;
02313              ((ULONG_PTR)<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> &gt;= Vad-&gt;u3.Secured.StartVpn)) {
02314 
02315             <span class="comment">//</span>
02316             <span class="comment">// This region conflicts, check the protections.</span>
02317             <span class="comment">//</span>
02318 
02319             <span class="keywordflow">if</span> (ProtectionMask &amp; <a class="code" href="../../d4/d8/mi_8h.html#a44">MM_GUARD_PAGE</a>) {
02320                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PAGE_PROTECTION;
02321                 <span class="keywordflow">goto</span> done;
02322             }
02323 
02324             <span class="keywordflow">if</span> (Vad-&gt;u2.VadFlags2.ReadOnly) {
02325                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/acceschk_8c.html#a0">MmReadWrite</a>[ProtectionMask] &lt; 10) {
02326                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PAGE_PROTECTION;
02327                     <span class="keywordflow">goto</span> done;
02328                 }
02329             } <span class="keywordflow">else</span> {
02330                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/acceschk_8c.html#a0">MmReadWrite</a>[ProtectionMask] &lt; 11) {
02331                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PAGE_PROTECTION;
02332                     <span class="keywordflow">goto</span> done;
02333                 }
02334             }
02335         }
02336 
02337     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Vad-&gt;u2.VadFlags2.MultipleSecured) {
02338 
02339         Next = Vad-&gt;u3.List.Flink;
02340         <span class="keywordflow">do</span> {
02341             Entry = CONTAINING_RECORD( Next,
02342                                        <a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">MMSECURE_ENTRY</a>,
02343                                        List);
02344 
02345             <span class="keywordflow">if</span> (((ULONG_PTR)Base &lt;= Entry-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o4">EndVpn</a>) &amp;&amp;
02346                 ((ULONG_PTR)<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> &gt;= Entry-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o3">StartVpn</a>)) {
02347 
02348                 <span class="comment">//</span>
02349                 <span class="comment">// This region conflicts, check the protections.</span>
02350                 <span class="comment">//</span>
02351 
02352                 <span class="keywordflow">if</span> (ProtectionMask &amp; <a class="code" href="../../d4/d8/mi_8h.html#a44">MM_GUARD_PAGE</a>) {
02353                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PAGE_PROTECTION;
02354                     <span class="keywordflow">goto</span> done;
02355                 }
02356     
02357                 <span class="keywordflow">if</span> (Entry-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o2">u2</a>.VadFlags2.ReadOnly) {
02358                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/acceschk_8c.html#a0">MmReadWrite</a>[ProtectionMask] &lt; 10) {
02359                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PAGE_PROTECTION;
02360                         <span class="keywordflow">goto</span> done;
02361                     }
02362                 } <span class="keywordflow">else</span> {
02363                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/acceschk_8c.html#a0">MmReadWrite</a>[ProtectionMask] &lt; 11) {
02364                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PAGE_PROTECTION;
02365                         <span class="keywordflow">goto</span> done;
02366                     }
02367                 }
02368             }
02369             Next = Entry-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o5">List</a>.Flink;
02370         } <span class="keywordflow">while</span> (Entry-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o5">List</a>.Flink != &amp;Vad-&gt;u3.List);
02371     }
02372 
02373 done:
02374     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02375 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="protect.c::MiFlushTbAndCapture" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HARDWARE_PTE MiFlushTbAndCapture           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PtePointer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HARDWARE_PTE&nbsp;</td>
          <td class="mdname" nowrap> <em>TempPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Pfn1</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/protect_8c-source.html#l02079">2079</a> of file <a class="el" href="../../d1/d8/protect_8c-source.html">protect.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00188">KeFlushSingleTb()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02228">MI_CAPTURE_DIRTY_BIT_TO_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00757">MI_IS_PTE_DIRTY</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02440">MiActiveWriteWatch</a>, <a class="el" href="../../d4/d8/mi_8h.html#a772">MiCaptureWriteWatchDirtyBit()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html#o15">_MMSUPPORT::u</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00196">_EPROCESS::Vm</a>.
<p>
Referenced by <a class="el" href="../../d1/d8/protect_8c-source.html#l00344">MiProtectVirtualMemory()</a>, and <a class="el" href="../../d1/d8/protect_8c-source.html#l01110">MiSetProtectionOnSection()</a>.
<p>
<pre class="fragment"><div>02087 {
02088     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PreviousPte;
02089     KIRQL OldIrql;
02090     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
02091     PVOID VirtualAddress;
02092 
02093     <span class="comment">//</span>
02094     <span class="comment">// Flush the TB as we have changed the protection</span>
02095     <span class="comment">// of a valid PTE.</span>
02096     <span class="comment">//</span>
02097 
02098     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02099 
02100     PreviousPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush = <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (
02101                             MiGetVirtualAddressMappedByPte (PointerPte),
02102                             FALSE,
02103                             FALSE,
02104                             (PHARDWARE_PTE)PointerPte,
02105                             TempPte);
02106 
02107     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PreviousPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
02108 
02109     <span class="comment">//</span>
02110     <span class="comment">// A page protection is being changed, on certain</span>
02111     <span class="comment">// hardware the dirty bit should be ORed into the</span>
02112     <span class="comment">// modify bit in the PFN element.</span>
02113     <span class="comment">//</span>
02114 
02115     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a177">MI_CAPTURE_DIRTY_BIT_TO_PFN</a> (&amp;PreviousPte, Pfn1);
02116 
02117     <span class="comment">//</span>
02118     <span class="comment">// If the PTE indicates the page has been modified (this is different</span>
02119     <span class="comment">// from the PFN indicating this), then ripple it back to the write watch</span>
02120     <span class="comment">// bitmap now since we are still in the correct process context.</span>
02121     <span class="comment">//</span>
02122 
02123     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a495">MiActiveWriteWatch</a> != 0) {
02124         <span class="keywordflow">if</span> ((Pfn1-&gt;u3.e1.PrototypePte == 0) &amp;&amp;
02125             (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a114">MI_IS_PTE_DIRTY</a>(PreviousPte))) {
02126 
02127             Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
02128 
02129             <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.WriteWatch == 1) {
02130 
02131                 <span class="comment">//</span>
02132                 <span class="comment">// This process has (or had) write watch VADs.  Search now</span>
02133                 <span class="comment">// for a write watch region encapsulating the PTE being</span>
02134                 <span class="comment">// invalidated.</span>
02135                 <span class="comment">//</span>
02136 
02137                 VirtualAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
02138                 <a class="code" href="../../d4/d8/mi_8h.html#a772">MiCaptureWriteWatchDirtyBit</a> (Process, VirtualAddress);
02139             }
02140         }
02141     }
02142 <span class="preprocessor">#if DBG</span>
02143 <span class="preprocessor"></span>    <span class="keywordflow">else</span> {
02144         Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
02145         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.WriteWatch == 0);
02146     }
02147 <span class="preprocessor">#endif</span>
02148 <span class="preprocessor"></span>
02149     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02150     <span class="keywordflow">return</span> PreviousPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush;
02151 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="protect.c::MiGetPageProtection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG MiGetPageProtection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PointerPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/protect_8c-source.html#l01874">1874</a> of file <a class="el" href="../../d1/d8/protect_8c-source.html">protect.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d7/d7/mi386_8h-source.html#l00170">KSTACK_POOL_START</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00274">MI_CONVERT_FROM_PTE_PROTECTION</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02693">MI_IS_PTE_PROTOTYPE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02336">MI_PTE_LOOKUP_NEEDED</a>, <a class="el" href="../../d5/d3/queryvm_8c.html#a2">MiCaptureSystemPte()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00248">MiLocateWsle()</a>, <a class="el" href="../../d3/d1/data386_8c-source.html#l00171">MiNumberOfExtraSystemPdes</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01466">MiPteToProto</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00278">MM_VA_MAPPED_BY_PDE</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00442">MmWorkingSetList</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00444">MmWsle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, and <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>.
<p>
Referenced by <a class="el" href="../../d1/d8/protect_8c-source.html#l00344">MiProtectVirtualMemory()</a>, <a class="el" href="../../d6/d2/queryvm_8c-source.html#l00673">MiQueryAddressState()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l01110">MiSetProtectionOnSection()</a>, and <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>.
<p>
<pre class="fragment"><div>01881                    :
01882 
01883     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page protection of a non-zero PTE.
01884     It may release and reacquire <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set mutex.
01885 
01886 Arguments:
01887 
01888     PointerPte - Supplies a pointer to a non-zero PTE.
01889 
01890 Return Value:
01891 
01892     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection code.
01893 
01894 Environment:
01895 
01896     Kernel mode, working set and address creation mutex held.
01897     Note, that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address creation mutex does not need to be held
01898     <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set mutex does not need to be released in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01899     <span class="keywordflow">case</span> of a prototype PTE.
01900 
01901 --*/
01902 
01903 {
01904 
01905     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
01906     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> ProtoPteContents;
01907     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01908     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ProtoPteAddress;
01909     PVOID Va;
01910     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01911 
01912     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01913 
01914     PteContents = *PointerPte;
01915 
01916     <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Valid == 0) &amp;&amp; (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1)) {
01917 
01918         <span class="comment">//</span>
01919         <span class="comment">// This pte is in prototype format, the protection is</span>
01920         <span class="comment">// stored in the prototype PTE.</span>
01921         <span class="comment">//</span>
01922 
01923         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a195">MI_IS_PTE_PROTOTYPE</a>(PointerPte) ||
01924 <span class="preprocessor">#ifdef _X86_</span>
01925 <span class="preprocessor"></span>            (<a class="code" href="../../d2/d2/data386_8c.html#a27">MiNumberOfExtraSystemPdes</a> &amp;&amp; (PointerPte &gt;= (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d6/d8/mi386_8h.html#a5">KSTACK_POOL_START</a> &amp;&amp; PointerPte &lt; (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(<a class="code" href="../../d6/d8/mi386_8h.html#a5">KSTACK_POOL_START</a> + <a class="code" href="../../d2/d2/data386_8c.html#a27">MiNumberOfExtraSystemPdes</a> * <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a50">MM_VA_MAPPED_BY_PDE</a>))) ||
01926 <span class="preprocessor">#endif</span>
01927 <span class="preprocessor"></span>            (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a181">MI_PTE_LOOKUP_NEEDED</a>)) {
01928 
01929             <span class="comment">//</span>
01930             <span class="comment">// The protection is within this PTE.</span>
01931             <span class="comment">//</span>
01932 
01933             <span class="keywordflow">return</span> <a class="code" href="../../d4/d8/mi_8h.html#a86">MI_CONVERT_FROM_PTE_PROTECTION</a> (
01934                                             PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection);
01935         }
01936 
01937         ProtoPteAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a144">MiPteToProto</a> (PointerPte);
01938 
01939         <span class="comment">//</span>
01940         <span class="comment">// Capture protopte PTE contents.</span>
01941         <span class="comment">//</span>
01942 
01943         ProtoPteContents = <a class="code" href="../../d5/d3/queryvm_8c.html#a2">MiCaptureSystemPte</a> (ProtoPteAddress, Process);
01944 
01945         <span class="comment">//</span>
01946         <span class="comment">// The working set mutex may have been released and the</span>
01947         <span class="comment">// page may no longer be in prototype format, get the</span>
01948         <span class="comment">// new contents of the PTE and obtain the protection mask.</span>
01949         <span class="comment">//</span>
01950 
01951         PteContents = <a class="code" href="../../d5/d3/queryvm_8c.html#a2">MiCaptureSystemPte</a> (PointerPte, Process);
01952     }
01953 
01954     <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Valid == 0) &amp;&amp; (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1)) {
01955 
01956         <span class="comment">//</span>
01957         <span class="comment">// Pte is still prototype, return the protection captured</span>
01958         <span class="comment">// from the prototype PTE.</span>
01959         <span class="comment">//</span>
01960 
01961         <span class="keywordflow">if</span> (ProtoPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
01962 
01963             <span class="comment">//</span>
01964             <span class="comment">// The prototype PTE is valid, get the protection from</span>
01965             <span class="comment">// the PFN database.</span>
01966             <span class="comment">//</span>
01967 
01968             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (ProtoPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01969             <span class="keywordflow">return</span> <a class="code" href="../../d4/d8/mi_8h.html#a86">MI_CONVERT_FROM_PTE_PROTECTION</a>(
01970                                       Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection);
01971 
01972         } <span class="keywordflow">else</span> {
01973 
01974             <span class="comment">//</span>
01975             <span class="comment">// The prototype PTE is not valid, return the protection from the</span>
01976             <span class="comment">// PTE.</span>
01977             <span class="comment">//</span>
01978 
01979             <span class="keywordflow">return</span> <a class="code" href="../../d4/d8/mi_8h.html#a86">MI_CONVERT_FROM_PTE_PROTECTION</a> (
01980                                      ProtoPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection);
01981         }
01982     }
01983 
01984     <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
01985 
01986         <span class="comment">//</span>
01987         <span class="comment">// The page is valid, the protection field is either in the</span>
01988         <span class="comment">// PFN database original PTE element or the WSLE.  If</span>
01989         <span class="comment">// the page is private, get it from the PFN original PTE</span>
01990         <span class="comment">// element, else use the WSLE.</span>
01991         <span class="comment">//</span>
01992 
01993         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01994 
01995         <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte == 0) ||
01996 <span class="preprocessor">#ifdef _X86_</span>
01997 <span class="preprocessor"></span>            (<a class="code" href="../../d2/d2/data386_8c.html#a27">MiNumberOfExtraSystemPdes</a> &amp;&amp; (PointerPte &gt;= (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d6/d8/mi386_8h.html#a5">KSTACK_POOL_START</a> &amp;&amp; PointerPte &lt; (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(<a class="code" href="../../d6/d8/mi386_8h.html#a5">KSTACK_POOL_START</a> + <a class="code" href="../../d2/d2/data386_8c.html#a27">MiNumberOfExtraSystemPdes</a> * <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a50">MM_VA_MAPPED_BY_PDE</a>))) ||
01998 <span class="preprocessor">#endif</span>
01999 <span class="preprocessor"></span>            (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a195">MI_IS_PTE_PROTOTYPE</a>(PointerPte))) {
02000 
02001             <span class="comment">//</span>
02002             <span class="comment">// This is a private PTE or the PTE address is that of a</span>
02003             <span class="comment">// prototype PTE, hence the protection is in</span>
02004             <span class="comment">// the original PTE.</span>
02005             <span class="comment">//</span>
02006 
02007             <span class="keywordflow">return</span> <a class="code" href="../../d4/d8/mi_8h.html#a86">MI_CONVERT_FROM_PTE_PROTECTION</a>(
02008                                       Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection);
02009         }
02010 
02011         <span class="comment">//</span>
02012         <span class="comment">// The PTE was a hardware PTE, get the protection</span>
02013         <span class="comment">// from the WSLE.</span>
02014 
02015         Va = (PULONG)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
02016         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d7/d0/wstree_8c.html#a7">MiLocateWsle</a> ((PVOID)Va, MmWorkingSetList,
02017                                             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex);
02018 
02019         <span class="keywordflow">return</span> <a class="code" href="../../d4/d8/mi_8h.html#a86">MI_CONVERT_FROM_PTE_PROTECTION</a> (MmWsle[Index].u1.e1.Protection);
02020     }
02021 
02022     <span class="comment">//</span>
02023     <span class="comment">// PTE is either demand zero or transition, in either</span>
02024     <span class="comment">// case protection is in PTE.</span>
02025     <span class="comment">//</span>
02026 
02027     <span class="keywordflow">return</span> <a class="code" href="../../d4/d8/mi_8h.html#a86">MI_CONVERT_FROM_PTE_PROTECTION</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection);
02028 
02029 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="protect.c::MiProtectVirtualMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiProtectVirtualMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>RegionSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NewProtect</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LastProtect</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/protect_8c-source.html#l00344">344</a> of file <a class="el" href="../../d1/d8/protect_8c-source.html">protect.c</a>.
<p>
References <a class="el" href="../../d3/d8/miia64_8h-source.html#l03246">ALT_CHANGE</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02393">_MMVAD::ControlArea</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02385">_MMVAD::EndingVpn</a>, <a class="el" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01093">LOCK_WS_AND_ADDRESS_SPACE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01044">LOCK_WS_UNSAFE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00274">MI_CONVERT_FROM_PTE_PROTECTION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01355">MI_GET_USED_PTES_HANDLE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00665">MI_GET_WORKING_SET_FROM_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01359">MI_INCREMENT_USED_PTES_BY_HANDLE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00494">MI_MAKE_VALID_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00641">MI_SET_PTE_IN_WORKING_SET</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00761">MI_VA_TO_VPN</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l02032">MiChangeNoAccessForkPte()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00556">MiCheckForConflictingVad</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l02244">MiCheckSecuredVad()</a>, <a class="el" href="../../d4/d9/wrtfault_8c-source.html#l00025">MiCopyOnWrite()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00437">MiDoesPdeExistAndMakeValid()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01980">MiDoesPpeExistAndMakeValid</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l02079">MiFlushTbAndCapture()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l01874">MiGetPageProtection()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l03696">MiGetProtoPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d4/d6/freevm_8c-source.html#l00937">MiIsEntireRangeCommitted()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01945">MiIsPteOnPdeBoundary</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00624">MiMakePdeExistAndMakeValid()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l03591">MiMakePpeExistAndMakeValid</a>, <a class="el" href="../../d2/d9/miia64_8h.html#a317">MiMakeProtectForNativePage()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00243">MiMakeProtectionMask()</a>, <a class="el" href="../../d2/d9/miia64_8h.html#a303">MiProtectFor4kPage()</a>, <a class="el" href="../../d2/d9/miia64_8h.html#a310">MiQueryProtectionFor4kPage()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l00899">MiRemovePageFromWorkingSet()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l01110">MiSetProtectionOnSection()</a>, <a class="el" href="../../d8/d8/sysload_8c.html#a41">MiSetProtectionOnTransitionPte()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00154">MM_PROTECTION_COPY_MASK</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04827">MmSectionCommitMutex</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d3/d8/miia64_8h-source.html#l03208">PAGE_4K</a>, <a class="el" href="../../d3/d8/miia64_8h-source.html#l03211">PAGE_4K_ALIGN</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02384">_MMVAD::StartingVpn</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html#o10">_CONTROL_AREA::u</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o7">_MMVAD::u</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o13">_MMVAD::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01101">UNLOCK_ADDRESS_SPACE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01097">UNLOCK_WS_AND_ADDRESS_SPACE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01085">UNLOCK_WS_UNSAFE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>, and <a class="el" href="../../d1/d8/protect_8c-source.html#l00069">NtProtectVirtualMemory()</a>.
<p>
<pre class="fragment"><div>00354                    :
00355 
00356     This routine changes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection on a region of committed pages
00357     within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address space of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject process.  Setting
00358     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection on a range of pages causes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> old protection to be
00359     replaced by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified protection value.
00360 
00361 Arguments:
00362 
00363     Process - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process.
00364 
00365     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting address to protect.
00366 
00367     RegionsSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> region to protect.
00368 
00369     NewProtect - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> protection to set.
00370 
00371     LastProtect - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a kernel owned pointer to
00372                 store (without probing) <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> old protection into.
00373 
00374 
00375 Return Value:
00376 
00377     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protect operation.
00378 
00379 Environment:
00380 
00381     Kernel mode
00382 
00383 --*/
00384 
00385 {
00386     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> FoundVad;
00387     PVOID StartingAddress;
00388     PVOID EndingAddress;
00389     PVOID CapturedBase;
00390     SIZE_T CapturedRegionSize;
00391     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00392     ULONG Attached;
00393     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00394     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00395     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00396     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00397     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerProtoPte;
00398     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastProtoPte;
00399     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00400     ULONG CapturedOldProtect;
00401     ULONG ProtectionMask;
00402     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00403     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
00404     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PreviousPte;
00405     ULONG Locked;
00406     PVOID Va;
00407     ULONG DoAgain;
00408     ULONG Waited;
00409     PVOID UsedPageTableHandle;
00410     PVOID UsedPageDirectoryHandle;
00411     ULONG WorkingSetIndex;
00412 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00413 <span class="preprocessor"></span>    PVOID OriginalBase;
00414     SIZE_T OriginalRegionSize;
00415     ULONG OriginalProtectionMask;
00416     PVOID StartingAddressFor4k;
00417     PVOID EndingAddressFor4k;
00418     SIZE_T CapturedRegionSizeFor4k;
00419     ULONG CapturedOldProtectFor4k;
00420     BOOLEAN EmulationFor4kPage = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>; 
00421 <span class="preprocessor">#endif</span>
00422 <span class="preprocessor"></span>
00423     Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00424     Locked = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00425 
00426     <span class="comment">//</span>
00427     <span class="comment">// Get the address creation mutex to block multiple threads from</span>
00428     <span class="comment">// creating or deleting address space at the same time.</span>
00429     <span class="comment">// Get the working set mutex so PTEs can be modified.</span>
00430     <span class="comment">// Block APCs so an APC which takes a page</span>
00431     <span class="comment">// fault does not corrupt various structures.</span>
00432     <span class="comment">//</span>
00433 
00434     CapturedBase = *BaseAddress;
00435     CapturedRegionSize = *RegionSize;
00436 
00437 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00438 <span class="preprocessor"></span>    OriginalBase = CapturedBase;
00439     OriginalRegionSize = CapturedRegionSize;
00440 
00441     <span class="keywordflow">if</span> (Process-&gt;Wow64Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00442 
00443         StartingAddressFor4k = (PVOID)<a class="code" href="../../d2/d9/miia64_8h.html#a230">PAGE_4K_ALIGN</a>(OriginalBase);
00444 
00445         EndingAddressFor4k = (PVOID)(((ULONG_PTR)OriginalBase +
00446                                       OriginalRegionSize - 1) | (<a class="code" href="../../d2/d9/miia64_8h.html#a227">PAGE_4K</a> - 1));
00447             
00448         CapturedRegionSizeFor4k = (ULONG_PTR)EndingAddressFor4k - 
00449             (ULONG_PTR)StartingAddressFor4k + 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00450 
00451         OriginalProtectionMask = <a class="code" href="../../d0/d2/mmsup_8c.html#a5">MiMakeProtectionMask</a>(NewProtect);
00452 
00453         EmulationFor4kPage = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00454 
00455     }
00456 <span class="preprocessor">#endif</span>
00457 <span class="preprocessor"></span>
00458     <span class="keywordflow">try</span> {
00459         ProtectionMask = <a class="code" href="../../d0/d2/mmsup_8c.html#a5">MiMakeProtectionMask</a> (NewProtect);
00460     } except (EXCEPTION_EXECUTE_HANDLER) {
00461         <span class="keywordflow">return</span> GetExceptionCode();
00462     }
00463 
00464     <a class="code" href="../../d4/d8/mi_8h.html#a161">LOCK_WS_AND_ADDRESS_SPACE</a> (Process);
00465 
00466     <span class="comment">//</span>
00467     <span class="comment">// Make sure the address space was not deleted, if so, return an error.</span>
00468     <span class="comment">//</span>
00469 
00470     <span class="keywordflow">if</span> (Process-&gt;AddressSpaceDeleted != 0) {
00471         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PROCESS_IS_TERMINATING;
00472         <span class="keywordflow">goto</span> ErrorFound;
00473     }
00474 
00475     EndingAddress = (PVOID)(((ULONG_PTR)CapturedBase +
00476                                 CapturedRegionSize - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
00477     StartingAddress = (PVOID)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(CapturedBase);
00478     FoundVad = <a class="code" href="../../d4/d8/mi_8h.html#a98">MiCheckForConflictingVad</a> (StartingAddress, EndingAddress);
00479 
00480     <span class="keywordflow">if</span> (FoundVad == (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00481 
00482         <span class="comment">//</span>
00483         <span class="comment">// No virtual address is reserved at the specified base address,</span>
00484         <span class="comment">// return an error.</span>
00485         <span class="comment">//</span>
00486 
00487         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_CONFLICTING_ADDRESSES;
00488         <span class="keywordflow">goto</span> ErrorFound;
00489     }
00490 
00491     <span class="comment">//</span>
00492     <span class="comment">// Ensure that the starting and ending addresses are all within</span>
00493     <span class="comment">// the same virtual address descriptor.</span>
00494     <span class="comment">//</span>
00495 
00496     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (StartingAddress) &lt; FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>) ||
00497         (<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndingAddress) &gt; FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>)) {
00498 
00499         <span class="comment">//</span>
00500         <span class="comment">// Not within the section virtual address descriptor,</span>
00501         <span class="comment">// return an error.</span>
00502         <span class="comment">//</span>
00503 
00504         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_CONFLICTING_ADDRESSES;
00505         <span class="keywordflow">goto</span> ErrorFound;
00506     }
00507 
00508     <span class="keywordflow">if</span> (FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.UserPhysicalPages == 1) {
00509 
00510         <span class="comment">//</span>
00511         <span class="comment">// These must always be readwrite.</span>
00512         <span class="comment">//</span>
00513 
00514         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_CONFLICTING_ADDRESSES;
00515         <span class="keywordflow">goto</span> ErrorFound;
00516     }
00517 
00518     <span class="keywordflow">if</span> (FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PhysicalMapping == 1) {
00519 
00520         <span class="comment">//</span>
00521         <span class="comment">// Setting the protection of a physically mapped section is</span>
00522         <span class="comment">// not allowed as there is no corresponding PFN database element.</span>
00523         <span class="comment">//</span>
00524 
00525         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_CONFLICTING_ADDRESSES;
00526         <span class="keywordflow">goto</span> ErrorFound;
00527     }
00528 
00529     <span class="keywordflow">if</span> (FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange == 1) {
00530 
00531         <span class="comment">//</span>
00532         <span class="comment">// An attempt is made at changing the protection</span>
00533         <span class="comment">// of a secured VAD, check to see if the address range</span>
00534         <span class="comment">// to change allows the change.</span>
00535         <span class="comment">//</span>
00536 
00537         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d9/protect_8c.html#a9">MiCheckSecuredVad</a> (FoundVad,
00538                                     CapturedBase,
00539                                     CapturedRegionSize,
00540                                     ProtectionMask);
00541 
00542         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (Status)) {
00543             <span class="keywordflow">goto</span> ErrorFound;
00544         }
00545     }
00546 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00547 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (EmulationFor4kPage == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00548         <span class="comment">//</span>
00549         <span class="comment">// if not secured, relax the protection</span>
00550         <span class="comment">//</span>
00551 
00552         NewProtect = <a class="code" href="../../d2/d9/miia64_8h.html#a317">MiMakeProtectForNativePage</a>(StartingAddressFor4k, 
00553                                                 NewProtect, 
00554                                                 Process);
00555 
00556         ProtectionMask = <a class="code" href="../../d0/d2/mmsup_8c.html#a5">MiMakeProtectionMask</a> (NewProtect);
00557     }
00558 <span class="preprocessor">#endif</span>
00559 <span class="preprocessor"></span>
00560     <span class="keywordflow">if</span> (FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory == 0) {
00561 
00562 
00563         <span class="comment">//</span>
00564         <span class="comment">// For mapped sections, the NO_CACHE attribute is not allowed.</span>
00565         <span class="comment">//</span>
00566 
00567         <span class="keywordflow">if</span> (NewProtect &amp; PAGE_NOCACHE) {
00568 
00569             <span class="comment">//</span>
00570             <span class="comment">// Not allowed.</span>
00571             <span class="comment">//</span>
00572 
00573             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_4;
00574             <span class="keywordflow">goto</span> ErrorFound;
00575         }
00576 
00577         <span class="comment">//</span>
00578         <span class="comment">// If this is a file mapping, then all pages must be</span>
00579         <span class="comment">// committed as there can be no sparse file maps. Images</span>
00580         <span class="comment">// can have non-committed pages if the alignment is greater</span>
00581         <span class="comment">// than the page size.</span>
00582         <span class="comment">//</span>
00583 
00584         <span class="keywordflow">if</span> ((FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.File == 0) ||
00585             (FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image == 1)) {
00586 
00587             PointerProtoPte = <a class="code" href="../../d4/d8/mi_8h.html#a246">MiGetProtoPteAddress</a> (FoundVad,
00588                                         MI_VA_TO_VPN (StartingAddress));
00589             LastProtoPte = <a class="code" href="../../d4/d8/mi_8h.html#a246">MiGetProtoPteAddress</a> (FoundVad,
00590                                         MI_VA_TO_VPN (EndingAddress));
00591 
00592             <span class="comment">//</span>
00593             <span class="comment">// Release the working set mutex and acquire the section</span>
00594             <span class="comment">// commit mutex.  Check all the prototype PTEs described by</span>
00595             <span class="comment">// the virtual address range to ensure they are committed.</span>
00596             <span class="comment">//</span>
00597 
00598             <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
00599             <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a> (&amp;MmSectionCommitMutex);
00600 
00601             <span class="keywordflow">while</span> (PointerProtoPte &lt;= LastProtoPte) {
00602 
00603                 <span class="comment">//</span>
00604                 <span class="comment">// Check to see if the prototype PTE is committed, if</span>
00605                 <span class="comment">// not return an error.</span>
00606                 <span class="comment">//</span>
00607 
00608                 <span class="keywordflow">if</span> (PointerProtoPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
00609 
00610                     <span class="comment">//</span>
00611                     <span class="comment">// Error, this prototype PTE is not committed.</span>
00612                     <span class="comment">//</span>
00613 
00614                     <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a> (&amp;MmSectionCommitMutex);
00615                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_COMMITTED;
00616                     <a class="code" href="../../d4/d8/mi_8h.html#a163">UNLOCK_ADDRESS_SPACE</a> (Process);
00617                     <span class="keywordflow">goto</span> ErrorFoundNoWs;
00618                 }
00619                 PointerProtoPte += 1;
00620             }
00621 
00622             <span class="comment">//</span>
00623             <span class="comment">// The range is committed, release the section commitment</span>
00624             <span class="comment">// mutex, acquire the working set mutex and update the local PTEs.</span>
00625             <span class="comment">//</span>
00626 
00627             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a> (&amp;MmSectionCommitMutex);
00628 
00629             <span class="comment">//</span>
00630             <span class="comment">// Set the protection on the section pages.  This could</span>
00631             <span class="comment">// get a quota exceeded exception.</span>
00632             <span class="comment">//</span>
00633 
00634             <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
00635         }
00636 
00637 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00638 <span class="preprocessor"></span>
00639         <span class="comment">//</span>
00640         <span class="comment">// We need to change the alternate table before PTEs are created for the protection </span>
00641         <span class="comment">// change.</span>
00642         <span class="comment">//</span>
00643 
00644         <span class="keywordflow">if</span> (EmulationFor4kPage == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00645 
00646             <span class="comment">//</span>
00647             <span class="comment">// Before accessing Alternate Table, unlock the working set mutex</span>
00648             <span class="comment">//</span>
00649 
00650             <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
00651 
00652             <span class="comment">//</span>
00653             <span class="comment">// Get the old protection</span>
00654             <span class="comment">//</span>
00655 
00656             CapturedOldProtectFor4k = 
00657                 <a class="code" href="../../d2/d9/miia64_8h.html#a310">MiQueryProtectionFor4kPage</a>(StartingAddressFor4k, Process);
00658             
00659             <span class="keywordflow">if</span> (CapturedOldProtectFor4k != 0) {
00660  
00661                 CapturedOldProtectFor4k = 
00662                     <a class="code" href="../../d4/d8/mi_8h.html#a86">MI_CONVERT_FROM_PTE_PROTECTION</a>(CapturedOldProtectFor4k);
00663 
00664             }
00665 
00666             <span class="comment">//</span>
00667             <span class="comment">// Set the alternate permission table</span>
00668             <span class="comment">//</span>
00669 
00670             <span class="keywordflow">if</span> ((FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.ImageMap == 1) ||
00671                 (FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.CopyOnWrite == 1)) {
00672 
00673                 OriginalProtectionMask |= <a class="code" href="../../d4/d8/mi_8h.html#a52">MM_PROTECTION_COPY_MASK</a>;
00674 
00675             }
00676 
00677             <a class="code" href="../../d2/d9/miia64_8h.html#a303">MiProtectFor4kPage</a> (StartingAddressFor4k, 
00678                                 CapturedRegionSizeFor4k, 
00679                                 OriginalProtectionMask, 
00680                                 ALT_CHANGE,
00681                                 Process);
00682 
00683             <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
00684         }
00685 <span class="preprocessor">#endif</span>
00686 <span class="preprocessor"></span>
00687         <span class="keywordflow">try</span> {
00688             Locked = <a class="code" href="../../d0/d9/protect_8c.html#a6">MiSetProtectionOnSection</a> ( Process,
00689                                                 FoundVad,
00690                                                 StartingAddress,
00691                                                 EndingAddress,
00692                                                 NewProtect,
00693                                                 &amp;CapturedOldProtect,
00694                                                 FALSE );
00695 
00696         } except (EXCEPTION_EXECUTE_HANDLER) {
00697 
00698             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00699             <span class="keywordflow">goto</span> ErrorFound;
00700         }
00701     } <span class="keywordflow">else</span> {
00702 
00703         <span class="comment">//</span>
00704         <span class="comment">// Not a section, private.</span>
00705         <span class="comment">// For private pages, the WRITECOPY attribute is not allowed.</span>
00706         <span class="comment">//</span>
00707 
00708         <span class="keywordflow">if</span> ((NewProtect &amp; PAGE_WRITECOPY) ||
00709             (NewProtect &amp; PAGE_EXECUTE_WRITECOPY)) {
00710 
00711             <span class="comment">//</span>
00712             <span class="comment">// Not allowed.</span>
00713             <span class="comment">//</span>
00714 
00715             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_4;
00716             <span class="keywordflow">goto</span> ErrorFound;
00717         }
00718 
00719         <span class="comment">//</span>
00720         <span class="comment">// Ensure all of the pages are already committed as described</span>
00721         <span class="comment">// in the virtual address descriptor.</span>
00722         <span class="comment">//</span>
00723 
00724         <span class="keywordflow">if</span> ( !<a class="code" href="../../d4/d8/mi_8h.html#a906">MiIsEntireRangeCommitted</a>(StartingAddress,
00725                                          EndingAddress,
00726                                          FoundVad,
00727                                          Process)) {
00728 
00729             <span class="comment">//</span>
00730             <span class="comment">// Previously reserved pages have been decommitted, or an error</span>
00731             <span class="comment">// occurred, release mutex and return status.</span>
00732             <span class="comment">//</span>
00733 
00734             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_COMMITTED;
00735             <span class="keywordflow">goto</span> ErrorFound;
00736         }
00737 
00738 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00739 <span class="preprocessor"></span>
00740         <span class="comment">//</span>
00741         <span class="comment">// We need to change the alternate table before PTEs are created for the protection </span>
00742         <span class="comment">// change.</span>
00743         <span class="comment">//</span>
00744 
00745         <span class="keywordflow">if</span> (EmulationFor4kPage == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00746 
00747             <span class="comment">//</span>
00748             <span class="comment">// Before accessing Alternate Table, unlock the working set mutex</span>
00749             <span class="comment">//</span>
00750 
00751             <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
00752 
00753             <span class="comment">//</span>
00754             <span class="comment">// Get the old protection</span>
00755             <span class="comment">//</span>
00756 
00757             CapturedOldProtectFor4k = 
00758                 <a class="code" href="../../d2/d9/miia64_8h.html#a310">MiQueryProtectionFor4kPage</a>(StartingAddressFor4k, Process);
00759             
00760             <span class="keywordflow">if</span> (CapturedOldProtectFor4k != 0) {
00761  
00762                 CapturedOldProtectFor4k = 
00763                     <a class="code" href="../../d4/d8/mi_8h.html#a86">MI_CONVERT_FROM_PTE_PROTECTION</a>(CapturedOldProtectFor4k);
00764 
00765             }
00766 
00767             <span class="comment">//</span>
00768             <span class="comment">// Set the alternate permission table</span>
00769             <span class="comment">//</span>
00770 
00771             <a class="code" href="../../d2/d9/miia64_8h.html#a303">MiProtectFor4kPage</a> (StartingAddressFor4k, 
00772                                 CapturedRegionSizeFor4k, 
00773                                 OriginalProtectionMask, 
00774                                 ALT_CHANGE,
00775                                 Process);
00776 
00777             <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
00778         }
00779 <span class="preprocessor">#endif</span>
00780 <span class="preprocessor"></span>
00781         <span class="comment">//</span>
00782         <span class="comment">// The address range is committed, change the protection.</span>
00783         <span class="comment">//</span>
00784 
00785         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (StartingAddress);
00786         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (StartingAddress);
00787         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (StartingAddress);
00788         LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EndingAddress);
00789 
00790 <span class="preprocessor">#if defined (_WIN64)</span>
00791 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (PointerPpe, Process, FALSE);
00792         <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
00793             UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
00794             <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
00795         }
00796 <span class="preprocessor">#endif</span>
00797 <span class="preprocessor"></span>
00798         <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a>(PointerPde, Process, FALSE);
00799 
00800         <span class="comment">//</span>
00801         <span class="comment">// Capture the protection for the first page.</span>
00802         <span class="comment">//</span>
00803 
00804         <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0) {
00805 
00806             CapturedOldProtect = <a class="code" href="../../d0/d9/protect_8c.html#a7">MiGetPageProtection</a> (PointerPte, Process);
00807 
00808             <span class="comment">//</span>
00809             <span class="comment">// Make sure the page directory &amp; table pages are still resident.</span>
00810             <span class="comment">//</span>
00811 
00812 <span class="preprocessor">#if defined (_WIN64)</span>
00813 <span class="preprocessor"></span>            <a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (PointerPpe, Process, FALSE);
00814             <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
00815                 UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
00816                 <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
00817             }
00818 <span class="preprocessor">#endif</span>
00819 <span class="preprocessor"></span>
00820             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a>(PointerPde, Process, FALSE);
00821 
00822         } <span class="keywordflow">else</span> {
00823 
00824             <span class="comment">//</span>
00825             <span class="comment">// Get the protection from the VAD.</span>
00826             <span class="comment">//</span>
00827 
00828             CapturedOldProtect =
00829                <a class="code" href="../../d4/d8/mi_8h.html#a86">MI_CONVERT_FROM_PTE_PROTECTION</a>(FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection);
00830         }
00831 
00832         <span class="comment">//</span>
00833         <span class="comment">// For all the PTEs in the specified address range, set the</span>
00834         <span class="comment">// protection depending on the state of the PTE.</span>
00835         <span class="comment">//</span>
00836 
00837         <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
00838 
00839             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPte)) {
00840 
00841                 PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
00842                 PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (PointerPte);
00843 
00844 <span class="preprocessor">#if defined (_WIN64)</span>
00845 <span class="preprocessor"></span>                <a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (PointerPpe, Process, FALSE);
00846                 <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
00847                     UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
00848                     <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
00849                 }
00850 <span class="preprocessor">#endif</span>
00851 <span class="preprocessor"></span>
00852                 <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a>(PointerPde, Process, FALSE);
00853             }
00854 
00855             PteContents = *PointerPte;
00856 
00857             <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
00858 
00859                 <span class="comment">//</span>
00860                 <span class="comment">// Increment the count of non-zero page table entries</span>
00861                 <span class="comment">// for this page table and the number of private pages</span>
00862                 <span class="comment">// for the process.  The protection will be set as</span>
00863                 <span class="comment">// if the PTE was demand zero.</span>
00864                 <span class="comment">//</span>
00865 
00866                 UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (MiGetVirtualAddressMappedByPte (PointerPte));
00867 
00868                 <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageTableHandle);
00869             }
00870 
00871             <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
00872 
00873                 <span class="comment">//</span>
00874                 <span class="comment">// Set the protection into both the PTE and the original PTE</span>
00875                 <span class="comment">// in the PFN database.</span>
00876                 <span class="comment">//</span>
00877 
00878                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
00879 
00880                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte == 1) {
00881 
00882                     <span class="comment">//</span>
00883                     <span class="comment">// This PTE refers to a fork prototype PTE, make it</span>
00884                     <span class="comment">// private.</span>
00885                     <span class="comment">//</span>
00886 
00887                     <a class="code" href="../../d3/d0/wrtfault_8c.html#a0">MiCopyOnWrite</a> (MiGetVirtualAddressMappedByPte (PointerPte),
00888                                     PointerPte);
00889 
00890                     <span class="comment">//</span>
00891                     <span class="comment">// This may have released the working set mutex and</span>
00892                     <span class="comment">// the page directory and table pages may no longer be</span>
00893                     <span class="comment">// in memory.</span>
00894                     <span class="comment">//</span>
00895 
00896                     <span class="keywordflow">do</span> {
00897 
00898                         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (MiGetPteAddress (PointerPde),
00899                                                           Process,
00900                                                           FALSE,
00901                                                           &amp;Waited);
00902 
00903                         Waited = 0;
00904 
00905                         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
00906                                                           Process,
00907                                                           FALSE,
00908                                                           &amp;Waited);
00909 
00910                     } <span class="keywordflow">while</span> (Waited != 0);
00911 
00912                     <span class="comment">//</span>
00913                     <span class="comment">// Do the loop again for the same PTE.</span>
00914                     <span class="comment">//</span>
00915 
00916                     <span class="keywordflow">continue</span>;
00917                 } <span class="keywordflow">else</span> {
00918 
00919                     <span class="comment">//</span>
00920                     <span class="comment">// The PTE is a private page which is valid, if the</span>
00921                     <span class="comment">// specified protection is no-access or guard page</span>
00922                     <span class="comment">// remove the PTE from the working set.</span>
00923                     <span class="comment">//</span>
00924 
00925                     <span class="keywordflow">if</span> ((NewProtect &amp; PAGE_NOACCESS) ||
00926                         (NewProtect &amp; PAGE_GUARD)) {
00927 
00928                         <span class="comment">//</span>
00929                         <span class="comment">// Remove the page from the working set.</span>
00930                         <span class="comment">//</span>
00931 
00932                         Locked = <a class="code" href="../../d4/d0/wslist_8c.html#a23">MiRemovePageFromWorkingSet</a> (PointerPte,
00933                                                              Pfn1,
00934                                                              &amp;Process-&gt;Vm);
00935 
00936 
00937                         <span class="keywordflow">continue</span>;
00938                     } <span class="keywordflow">else</span> {
00939 
00940 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00941 <span class="preprocessor"></span>                        MiSetOriginalPteProtection (Pfn1, ProtectionMask);
00942 <span class="preprocessor">#else</span>
00943 <span class="preprocessor"></span>                        Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = ProtectionMask;
00944 <span class="preprocessor">#endif</span>
00945 <span class="preprocessor"></span>                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
00946                                            PointerPte-&gt;u.Hard.PageFrameNumber,
00947                                            ProtectionMask,
00948                                            PointerPte);
00949 
00950                         WorkingSetIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a110">MI_GET_WORKING_SET_FROM_PTE</a> (&amp;PteContents);
00951                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a109">MI_SET_PTE_IN_WORKING_SET</a> (&amp;TempPte, WorkingSetIndex);
00952 
00953                         <span class="comment">//</span>
00954                         <span class="comment">// Flush the TB as we have changed the protection</span>
00955                         <span class="comment">// of a valid PTE.</span>
00956                         <span class="comment">//</span>
00957 
00958                         PreviousPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush = <a class="code" href="../../d0/d9/protect_8c.html#a1">MiFlushTbAndCapture</a> (PointerPte,
00959                                                                TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush,
00960                                                                Pfn1);
00961                     }
00962                 }
00963             } <span class="keywordflow">else</span> {
00964 
00965                 <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) {
00966 
00967                     <span class="comment">//</span>
00968                     <span class="comment">// This PTE refers to a fork prototype PTE, make the</span>
00969                     <span class="comment">// page private.  This is accomplished by releasing</span>
00970                     <span class="comment">// the working set mutex, reading the page thereby</span>
00971                     <span class="comment">// causing a fault, and re-executing the loop, hopefully,</span>
00972                     <span class="comment">// this time, we'll find the page present and will</span>
00973                     <span class="comment">// turn it into a private page.</span>
00974                     <span class="comment">//</span>
00975                     <span class="comment">// Note, that a TRY is used to catch guard</span>
00976                     <span class="comment">// page exceptions and no-access exceptions.</span>
00977                     <span class="comment">//</span>
00978 
00979                     Va = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
00980 
00981                     DoAgain = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00982 
00983                     <span class="keywordflow">while</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
00984 
00985                         <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
00986 
00987                         <span class="keywordflow">try</span> {
00988 
00989                             *(<span class="keyword">volatile</span> ULONG *)Va;
00990                         } except (EXCEPTION_EXECUTE_HANDLER) {
00991 
00992                             <span class="keywordflow">if</span> (GetExceptionCode() ==
00993                                                 STATUS_ACCESS_VIOLATION) {
00994 
00995                                 <span class="comment">//</span>
00996                                 <span class="comment">// The prototype PTE must be noaccess.</span>
00997                                 <span class="comment">//</span>
00998 
00999                                 DoAgain = <a class="code" href="../../d0/d9/protect_8c.html#a8">MiChangeNoAccessForkPte</a> (PointerPte,
01000                                                                 ProtectionMask);
01001                             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (GetExceptionCode() ==
01002                                                     STATUS_IN_PAGE_ERROR) {
01003                                 <span class="comment">//</span>
01004                                 <span class="comment">// Ignore this page and go onto the next one.</span>
01005                                 <span class="comment">//</span>
01006 
01007                                 PointerPte += 1;
01008                                 DoAgain = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01009 
01010                                 <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
01011                                     <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
01012                                     <span class="keywordflow">break</span>;
01013                                 }
01014                             }
01015                         }
01016 
01017                         <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
01018 
01019                         <span class="keywordflow">do</span> {
01020 
01021                             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (MiGetPteAddress (PointerPde),
01022                                                               Process,
01023                                                               FALSE,
01024                                                               &amp;Waited);
01025 
01026                             Waited = 0;
01027 
01028                             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
01029                                                               Process,
01030                                                               FALSE,
01031                                                               &amp;Waited);
01032 
01033                         } <span class="keywordflow">while</span> (Waited != 0);
01034 
01035                         PteContents = *(<span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> *)PointerPte;
01036                     }
01037 
01038                     <span class="keywordflow">if</span> (DoAgain) {
01039                         <span class="keywordflow">continue</span>;
01040                     }
01041 
01042                 } <span class="keywordflow">else</span> {
01043 
01044                     <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1) {
01045 
01046                         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/sysload_8c.html#a41">MiSetProtectionOnTransitionPte</a> (
01047                                                     PointerPte,
01048                                                     ProtectionMask)) {
01049                             <span class="keywordflow">continue</span>;
01050                         }
01051                     } <span class="keywordflow">else</span> {
01052 
01053                         <span class="comment">//</span>
01054                         <span class="comment">// Must be page file space or demand zero.</span>
01055                         <span class="comment">//</span>
01056 
01057                         PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = ProtectionMask;
01058                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Long != 0);
01059                     }
01060                 }
01061             }
01062             PointerPte += 1;
01063         } <span class="comment">//end while</span>
01064     }
01065 
01066     <span class="comment">//</span>
01067     <span class="comment">// Common completion code.</span>
01068     <span class="comment">//</span>
01069 
01070 <span class="preprocessor">#if defined(_MIALT4K_)</span>
01071 <span class="preprocessor"></span>
01072     <span class="keywordflow">if</span> (EmulationFor4kPage == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01073 
01074         StartingAddress = StartingAddressFor4k;
01075 
01076         EndingAddress = EndingAddressFor4k;
01077             
01078         <span class="keywordflow">if</span> (CapturedOldProtectFor4k != 0) {
01079 
01080             <span class="comment">//</span>
01081             <span class="comment">// change CapturedOldProtect when CapturedOldProtectFor4k</span>
01082             <span class="comment">// contains the true protection for the 4k page</span>
01083             <span class="comment">//</span>
01084 
01085             CapturedOldProtect = CapturedOldProtectFor4k;
01086 
01087         }
01088     }
01089 <span class="preprocessor">#endif</span>
01090 <span class="preprocessor"></span>
01091     *RegionSize = (PCHAR)EndingAddress - (PCHAR)StartingAddress + 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
01092     *BaseAddress = StartingAddress;
01093     *LastProtect = CapturedOldProtect;
01094 
01095     <span class="keywordflow">if</span> (Locked) {
01096         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_WAS_UNLOCKED;
01097     } <span class="keywordflow">else</span> {
01098         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01099     }
01100 
01101 ErrorFound:
01102     <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
01103 
01104 ErrorFoundNoWs:
01105     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01106 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="protect.c::MiSetProtectionOnSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG MiSetProtectionOnSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FoundVad</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>EndingAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NewProtect</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedOldProtect</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DontCharge</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/protect_8c-source.html#l01110">1110</a> of file <a class="el" href="../../d1/d8/protect_8c-source.html">protect.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01044">LOCK_WS_UNSAFE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00274">MI_CONVERT_FROM_PTE_PROTECTION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01355">MI_GET_USED_PTES_HANDLE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00665">MI_GET_WORKING_SET_FROM_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01359">MI_INCREMENT_USED_PTES_BY_HANDLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00280">MI_IS_PTE_PROTECTION_COPY_WRITE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00494">MI_MAKE_VALID_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02336">MI_PTE_LOOKUP_NEEDED</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00641">MI_SET_PTE_IN_WORKING_SET</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00761">MI_VA_TO_VPN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02486">MI_WRITE_INVALID_PTE</a>, <a class="el" href="../../d5/d3/queryvm_8c.html#a2">MiCaptureSystemPte()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l02032">MiChangeNoAccessForkPte()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00191">MiChargeCommitment()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00058">MiChargePageFileQuota()</a>, <a class="el" href="../../d4/d9/wrtfault_8c-source.html#l00025">MiCopyOnWrite()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00437">MiDoesPdeExistAndMakeValid()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01980">MiDoesPpeExistAndMakeValid</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l02079">MiFlushTbAndCapture()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l01874">MiGetPageProtection()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l03696">MiGetProtoPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01945">MiIsPteOnPdeBoundary</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00248">MiLocateWsle()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00624">MiMakePdeExistAndMakeValid()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l03591">MiMakePpeExistAndMakeValid</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00243">MiMakeProtectionMask()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01466">MiPteToProto</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l00899">MiRemovePageFromWorkingSet()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00133">MiReturnPageFileQuota()</a>, <a class="el" href="../../d8/d8/sysload_8c.html#a41">MiSetProtectionOnTransitionPte()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00198">MM_COPY_ON_WRITE_MASK</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04292">MM_DBG_COMMIT_RETURN_PROTECTION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04265">MM_DBG_COMMIT_SET_PROTECTION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00154">MM_PROTECTION_COPY_MASK</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00442">MmWorkingSetList</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00444">MmWsle</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00075">PrototypePte</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00318">PS_JOB_STATUS_REPORT_COMMIT_CHANGES</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l02823">PsChangeJobMemoryUsage()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l02901">PsReportProcessMemoryLimitViolation()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d1/d8/struct__MMWSLE.html#o3">_MMWSLE::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01085">UNLOCK_WS_UNSAFE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d1/d8/protect_8c-source.html#l00344">MiProtectVirtualMemory()</a>, and <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>.
<p>
<pre class="fragment"><div>01122                    :
01123 
01124     This routine changes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection on a region of committed pages
01125     within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address space of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject process.  Setting
01126     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection on a range of pages causes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> old protection to be
01127     replaced by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified protection value.
01128 
01129 Arguments:
01130 
01131     Process - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process.
01132 
01133     FoundVad - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> VAD containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range to protect.
01134 
01135     StartingAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting address to protect.
01136 
01137     EndingAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ending address to protect.
01138 
01139     NewProtect - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> protection to set.
01140 
01141     CapturedOldProtect - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a kernel owned pointer to
01142                 store (without probing) <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> old protection into.
01143 
01144     DontCharge - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> no quota or commitment should be charged.
01145 
01146 Return Value:
01147 
01148     Returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> a locked page was removed from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set (protection
01149     was guard page or no-access, FALSE otherwise.
01150 
01151 Exceptions raised <span class="keywordflow">for</span> page file quota or commitment violations.
01152 
01153 Environment:
01154 
01155     Kernel mode, working set mutex held, address creation mutex held
01156     APCs disabled.
01157 
01158 --*/
01159 
01160 {
01161     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01162     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
01163     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
01164     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
01165     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerProtoPte;
01166     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01167     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
01168     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PreviousPte;
01169     ULONG Locked;
01170     ULONG ProtectionMask;
01171     ULONG ProtectionMaskNotCopy;
01172     ULONG NewProtectionMask;
01173     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
01174     ULONG Index;
01175     PULONG Va;
01176     ULONG WriteCopy;
01177     ULONG DoAgain;
01178     ULONG Waited;
01179     SIZE_T QuotaCharge;
01180     PVOID UsedPageTableHandle;
01181     PVOID UsedPageDirectoryHandle;
01182     ULONG WorkingSetIndex;
01183 
01184     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01185 
01186     Locked = FALSE;
01187     WriteCopy = FALSE;
01188     QuotaCharge = 0;
01189 
01190     <span class="comment">//</span>
01191     <span class="comment">// Make the protection field.</span>
01192     <span class="comment">//</span>
01193 
01194     ASSERT (FoundVad-&gt;u.VadFlags.PrivateMemory == 0);
01195 
01196     if ((FoundVad-&gt;u.VadFlags.ImageMap == 1) ||
01197         (FoundVad-&gt;u2.VadFlags2.CopyOnWrite == 1)) {
01198 
01199         if (NewProtect &amp; PAGE_READWRITE) {
01200             NewProtect &amp;= ~PAGE_READWRITE;
01201             NewProtect |= PAGE_WRITECOPY;
01202         }
01203 
01204         <span class="keywordflow">if</span> (NewProtect &amp; PAGE_EXECUTE_READWRITE) {
01205             NewProtect &amp;= ~PAGE_EXECUTE_READWRITE;
01206             NewProtect |= PAGE_EXECUTE_WRITECOPY;
01207         }
01208     }
01209 
01210     ProtectionMask = MiMakeProtectionMask (NewProtect);
01211 
01212     <span class="comment">//</span>
01213     <span class="comment">// Determine if copy on write is being set.</span>
01214     <span class="comment">//</span>
01215 
01216     ProtectionMaskNotCopy = ProtectionMask;
01217     <span class="keywordflow">if</span> ((ProtectionMask &amp; MM_COPY_ON_WRITE_MASK) == MM_COPY_ON_WRITE_MASK) {
01218         WriteCopy = TRUE;
01219         ProtectionMaskNotCopy &amp;= ~MM_PROTECTION_COPY_MASK;
01220     }
01221 
01222 #<span class="keywordflow">if</span> defined(_MIALT4K_)
01223 
01224     <span class="keywordflow">if</span> ((Process-&gt;Wow64Process != NULL) &amp;&amp; 
01225         (FoundVad-&gt;u.VadFlags.ImageMap == 0) &amp;&amp;
01226         (FoundVad-&gt;u2.VadFlags2.CopyOnWrite == 0) &amp;&amp; 
01227         (WriteCopy)) {
01228         
01229         NTSTATUS status;
01230 
01231         status = MiSetCopyPagesFor4kPage(Process,
01232                                          &amp;FoundVad,
01233                                          &amp;StartingAddress,
01234                                          &amp;EndingAddress,
01235                                          ProtectionMask);
01236 
01237         <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
01238             ExRaiseStatus (status);
01239         }
01240 
01241     }
01242         
01243 #endif
01244 
01245     PointerPpe = MiGetPpeAddress (StartingAddress);
01246     PointerPde = MiGetPdeAddress (StartingAddress);
01247     PointerPte = MiGetPteAddress (StartingAddress);
01248     LastPte = MiGetPteAddress (EndingAddress);
01249 
01250 #<span class="keywordflow">if</span> defined (_WIN64)
01251     MiMakePpeExistAndMakeValid (PointerPpe, Process, FALSE);
01252     <span class="keywordflow">if</span> (PointerPde-&gt;u.Long == 0) {
01253         UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
01254         MI_INCREMENT_USED_PTES_BY_HANDLE (UsedPageDirectoryHandle);
01255     }
01256 #endif
01257 
01258     <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a>(PointerPde, Process, FALSE);
01259 
01260     <span class="comment">//</span>
01261     <span class="comment">// Capture the protection for the first page.</span>
01262     <span class="comment">//</span>
01263 
01264     <span class="keywordflow">if</span> (PointerPte-&gt;u.Long != 0) {
01265 
01266         *CapturedOldProtect = <a class="code" href="../../d4/d8/mi_8h.html#a937">MiGetPageProtection</a> (PointerPte, Process);
01267 
01268         <span class="comment">//</span>
01269         <span class="comment">// Make sure the Page table page is still resident.</span>
01270         <span class="comment">//</span>
01271 
01272         PointerPpe = MiGetPteAddress (PointerPde);
01273 
01274         <span class="keywordflow">do</span> {
01275 
01276             (VOID)MiDoesPpeExistAndMakeValid (PointerPpe, Process, FALSE, &amp;Waited);
01277             Waited = 0;
01278 
01279             (VOID)MiDoesPdeExistAndMakeValid (PointerPde, Process, FALSE, &amp;Waited);
01280         } <span class="keywordflow">while</span> (Waited != 0);
01281 
01282     } <span class="keywordflow">else</span> {
01283 
01284         <span class="comment">//</span>
01285         <span class="comment">// Get the protection from the VAD, unless image file.</span>
01286         <span class="comment">//</span>
01287 
01288         <span class="keywordflow">if</span> (FoundVad-&gt;u.VadFlags.ImageMap == 0) {
01289 
01290             <span class="comment">//</span>
01291             <span class="comment">// This is not an image file, the protection is in the VAD.</span>
01292             <span class="comment">//</span>
01293 
01294             *CapturedOldProtect =
01295                 <a class="code" href="../../d4/d8/mi_8h.html#a86">MI_CONVERT_FROM_PTE_PROTECTION</a>(FoundVad-&gt;u.VadFlags.Protection);
01296         } <span class="keywordflow">else</span> {
01297 
01298             <span class="comment">//</span>
01299             <span class="comment">// This is an image file, the protection is in the</span>
01300             <span class="comment">// prototype PTE.</span>
01301             <span class="comment">//</span>
01302 
01303             PointerProtoPte = <a class="code" href="../../d4/d8/mi_8h.html#a246">MiGetProtoPteAddress</a> (FoundVad,
01304                                     MI_VA_TO_VPN (
01305                                     MiGetVirtualAddressMappedByPte (PointerPte)));
01306 
01307             TempPte = <a class="code" href="../../d5/d3/queryvm_8c.html#a2">MiCaptureSystemPte</a> (PointerProtoPte, Process);
01308 
01309             *CapturedOldProtect = <a class="code" href="../../d0/d9/protect_8c.html#a7">MiGetPageProtection</a> (&amp;TempPte,
01310                                                        Process);
01311 
01312             <span class="comment">//</span>
01313             <span class="comment">// Make sure the Page directory and table pages are still resident.</span>
01314             <span class="comment">//</span>
01315 
01316             PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
01317 
01318             <span class="keywordflow">do</span> {
01319 
01320                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a>(PointerPpe, Process, FALSE, &amp;Waited);
01321                 Waited = 0;
01322 
01323                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a>(PointerPde, Process, FALSE, &amp;Waited);
01324             } <span class="keywordflow">while</span> (Waited != 0);
01325         }
01326     }
01327 
01328     <span class="comment">//</span>
01329     <span class="comment">// If the page protection is being change to be copy-on-write, the</span>
01330     <span class="comment">// commitment and page file quota for the potentially dirty private pages</span>
01331     <span class="comment">// must be calculated and charged.  This must be done before any</span>
01332     <span class="comment">// protections are changed as the changes cannot be undone.</span>
01333     <span class="comment">//</span>
01334 
01335     <span class="keywordflow">if</span> (WriteCopy) {
01336 
01337         <span class="comment">//</span>
01338         <span class="comment">// Calculate the charges.  If the page is shared and not write copy</span>
01339         <span class="comment">// it is counted as a charged page.</span>
01340         <span class="comment">//</span>
01341 
01342         <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
01343 
01344             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPte)) {
01345 
01346                 PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
01347                 PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
01348 
01349                 <span class="keywordflow">do</span> {
01350 
01351                     <span class="keywordflow">while</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a>(PointerPpe, Process, FALSE, &amp;Waited)) {
01352 
01353                         <span class="comment">//</span>
01354                         <span class="comment">// No PPE exists for this address.  Therefore</span>
01355                         <span class="comment">// all the PTEs are shared and not copy on write.</span>
01356                         <span class="comment">// go to the next PPE.</span>
01357                         <span class="comment">//</span>
01358 
01359                         PointerPpe += 1;
01360                         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPpe);
01361                         PointerProtoPte = PointerPte;
01362                         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
01363 
01364                         <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
01365                             QuotaCharge += 1 + LastPte - PointerProtoPte;
01366                             <span class="keywordflow">goto</span> Done;
01367                         }
01368                         QuotaCharge += PointerPte - PointerProtoPte;
01369                     }
01370 
01371                     Waited = 0;
01372 
01373                     <span class="keywordflow">while</span> (!<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a>(PointerPde, Process, FALSE, &amp;Waited)) {
01374 
01375                         <span class="comment">//</span>
01376                         <span class="comment">// No PDE exists for this address.  Therefore</span>
01377                         <span class="comment">// all the PTEs are shared and not copy on write.</span>
01378                         <span class="comment">// go to the next PDE.</span>
01379                         <span class="comment">//</span>
01380 
01381                         PointerPde += 1;
01382                         PointerProtoPte = PointerPte;
01383                         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
01384                         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
01385 
01386                         <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
01387                             QuotaCharge += 1 + LastPte - PointerProtoPte;
01388                             <span class="keywordflow">goto</span> Done;
01389                         }
01390                         QuotaCharge += PointerPte - PointerProtoPte;
01391 <span class="preprocessor">#if defined (_WIN64)</span>
01392 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPde)) {
01393                             Waited = 1;
01394                             <span class="keywordflow">break</span>;
01395                         }
01396 <span class="preprocessor">#endif</span>
01397 <span class="preprocessor"></span>                    }
01398                 } <span class="keywordflow">while</span> (Waited != 0);
01399             }
01400 
01401             PteContents = *PointerPte;
01402 
01403             <span class="keywordflow">if</span> (PteContents.u.Long == 0) {
01404 
01405                 <span class="comment">//</span>
01406                 <span class="comment">// The PTE has not been evaluated, assume copy on write.</span>
01407                 <span class="comment">//</span>
01408 
01409                 QuotaCharge += 1;
01410 
01411             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((PteContents.u.Hard.Valid == 1) &amp;&amp;
01412                 (PteContents.u.Hard.CopyOnWrite == 0)) {
01413 
01414                 <span class="comment">//</span>
01415                 <span class="comment">// See if this is a prototype PTE, if so charge it.</span>
01416                 <span class="comment">//</span>
01417 
01418                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.u.Hard.PageFrameNumber);
01419 
01420                 <span class="keywordflow">if</span> (Pfn1-&gt;u3.e1.PrototypePte == 1) {
01421                     QuotaCharge += 1;
01422                 }
01423             } <span class="keywordflow">else</span> {
01424 
01425                 <span class="keywordflow">if</span> (PteContents.u.Soft.Prototype == 1) {
01426 
01427                     <span class="comment">//</span>
01428                     <span class="comment">// This is a prototype PTE.  Charge if it is not</span>
01429                     <span class="comment">// in copy on write format.</span>
01430                     <span class="comment">//</span>
01431 
01432                     <span class="keywordflow">if</span> (PteContents.u.Soft.PageFileHigh == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a181">MI_PTE_LOOKUP_NEEDED</a>) {
01433 
01434                         <span class="comment">//</span>
01435                         <span class="comment">// Page protection is within the PTE.</span>
01436                         <span class="comment">//</span>
01437 
01438                         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d8/mi_8h.html#a88">MI_IS_PTE_PROTECTION_COPY_WRITE</a>(PteContents.u.Soft.Protection)) {
01439                             QuotaCharge += 1;
01440                         }
01441                     } <span class="keywordflow">else</span> {
01442 
01443                         <span class="comment">//</span>
01444                         <span class="comment">// The PTE references the prototype directly, therefore</span>
01445                         <span class="comment">// it can't be copy on write.  Charge.</span>
01446                         <span class="comment">//</span>
01447 
01448                         QuotaCharge += 1;
01449                     }
01450                 }
01451             }
01452             PointerPte += 1;
01453         }
01454 
01455 Done:
01456         NOTHING;
01457 
01458         <span class="comment">//</span>
01459         <span class="comment">// Charge for the quota.</span>
01460         <span class="comment">//</span>
01461 
01462         <span class="keywordflow">if</span> (!DontCharge) {
01463             <a class="code" href="../../d6/d1/mmquota_8c.html#a15">MiChargePageFileQuota</a> (QuotaCharge, Process);
01464 
01465             <span class="keywordflow">if</span> (Process-&gt;CommitChargeLimit) {
01466                 <span class="keywordflow">if</span> (Process-&gt;CommitCharge + QuotaCharge &gt; Process-&gt;CommitChargeLimit) {
01467                     <a class="code" href="../../d0/d2/psquota_8c.html#a5">MiReturnPageFileQuota</a> (QuotaCharge, Process);
01468                     <span class="keywordflow">if</span> (Process-&gt;Job) {
01469                         <a class="code" href="../../d1/d1/psjob_8c.html#a21">PsReportProcessMemoryLimitViolation</a> ();
01470                     }
01471                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_COMMITMENT_LIMIT);
01472                 }
01473             }
01474             <span class="keywordflow">if</span> (Process-&gt;JobStatus &amp; <a class="code" href="../../d1/d9/ps_8h.html#a13">PS_JOB_STATUS_REPORT_COMMIT_CHANGES</a>) {
01475                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/psjob_8c.html#a20">PsChangeJobMemoryUsage</a>(QuotaCharge) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01476                     <a class="code" href="../../d0/d2/psquota_8c.html#a5">MiReturnPageFileQuota</a> (QuotaCharge, Process);
01477                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_COMMITMENT_LIMIT);
01478                 }
01479             }
01480 
01481             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a17">MiChargeCommitment</a> (QuotaCharge, Process) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01482                 <span class="keywordflow">if</span> (Process-&gt;JobStatus &amp; <a class="code" href="../../d1/d9/ps_8h.html#a13">PS_JOB_STATUS_REPORT_COMMIT_CHANGES</a>) {
01483 
01484                     <span class="comment">//</span>
01485                     <span class="comment">// Temporarily up the process commit charge as the</span>
01486                     <span class="comment">// job code will be referencing it as though everything</span>
01487                     <span class="comment">// has succeeded.</span>
01488                     <span class="comment">//</span>
01489 
01490                     Process-&gt;CommitCharge += QuotaCharge;
01491                     <a class="code" href="../../d1/d1/psjob_8c.html#a20">PsChangeJobMemoryUsage</a>(-(SSIZE_T)QuotaCharge);
01492                     Process-&gt;CommitCharge -= QuotaCharge;
01493                 }
01494                 <a class="code" href="../../d0/d2/psquota_8c.html#a5">MiReturnPageFileQuota</a> (QuotaCharge, Process);
01495                 <a class="code" href="../../d0/d4/ex_2alpha_2raisests_8c.html#a3">ExRaiseStatus</a> STATUS_COMMITMENT_LIMIT;
01496             }
01497 
01498             <span class="comment">//</span>
01499             <span class="comment">// Add the quota into the charge to the VAD.</span>
01500             <span class="comment">//</span>
01501 
01502             <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_SET_PROTECTION, QuotaCharge);
01503             FoundVad-&gt;u.VadFlags.CommitCharge += QuotaCharge;
01504             Process-&gt;CommitCharge += QuotaCharge;
01505             <span class="keywordflow">if</span> (Process-&gt;CommitCharge &gt; Process-&gt;CommitChargePeak) {
01506                 Process-&gt;CommitChargePeak = Process-&gt;CommitCharge;
01507             }
01508         }
01509     }
01510 
01511     <span class="comment">//</span>
01512     <span class="comment">// For all the PTEs in the specified address range, set the</span>
01513     <span class="comment">// protection depending on the state of the PTE.</span>
01514     <span class="comment">//</span>
01515 
01516     <span class="comment">//</span>
01517     <span class="comment">// If the PTE was copy on write (but not written) and the</span>
01518     <span class="comment">// new protection is NOT copy-on-write, return page file quota</span>
01519     <span class="comment">// and commitment.</span>
01520     <span class="comment">//</span>
01521 
01522     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (StartingAddress);
01523     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (StartingAddress);
01524     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (StartingAddress);
01525 
01526     <span class="keywordflow">do</span> {
01527 
01528         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe, Process, FALSE, &amp;Waited);
01529 
01530         Waited = 0;
01531 
01532         <a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde, Process, FALSE, &amp;Waited);
01533 
01534     } <span class="keywordflow">while</span> (Waited != 0);
01535 
01536     QuotaCharge = 0;
01537 
01538     <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
01539 
01540         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPte)) {
01541             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
01542             PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (PointerPte);
01543 
01544 <span class="preprocessor">#if defined (_WIN64)</span>
01545 <span class="preprocessor"></span>            <a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (PointerPpe, Process, FALSE);
01546             <span class="keywordflow">if</span> (PointerPde-&gt;u.Long == 0) {
01547                 UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
01548                 <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
01549             }
01550 <span class="preprocessor">#endif</span>
01551 <span class="preprocessor"></span>
01552             <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a> (PointerPde, Process, FALSE);
01553         }
01554 
01555         PteContents = *PointerPte;
01556 
01557         <span class="keywordflow">if</span> (PteContents.u.Long == 0) {
01558 
01559             <span class="comment">//</span>
01560             <span class="comment">// The PTE is zero, set it into prototype PTE format</span>
01561             <span class="comment">// with the protection in the prototype PTE.</span>
01562             <span class="comment">//</span>
01563 
01564             TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a12">PrototypePte</a>;
01565             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = ProtectionMask;
01566             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, TempPte);
01567 
01568             <span class="comment">//</span>
01569             <span class="comment">// Increment the count of non-zero page table entries</span>
01570             <span class="comment">// for this page table and the number of private pages</span>
01571             <span class="comment">// for the process.</span>
01572             <span class="comment">//</span>
01573 
01574             UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (MiGetVirtualAddressMappedByPte (PointerPte));
01575 
01576             <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageTableHandle);
01577 
01578         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PteContents.u.Hard.Valid == 1) {
01579 
01580             <span class="comment">//</span>
01581             <span class="comment">// Set the protection into both the PTE and the original PTE</span>
01582             <span class="comment">// in the PFN database for private pages only.</span>
01583             <span class="comment">//</span>
01584 
01585             NewProtectionMask = ProtectionMask;
01586 
01587             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.u.Hard.PageFrameNumber);
01588 
01589             <span class="keywordflow">if</span> ((NewProtect &amp; PAGE_NOACCESS) ||
01590                 (NewProtect &amp; PAGE_GUARD)) {
01591 
01592                 Locked = <a class="code" href="../../d4/d0/wslist_8c.html#a23">MiRemovePageFromWorkingSet</a> (PointerPte,
01593                                                      Pfn1,
01594                                                      &amp;Process-&gt;Vm );
01595                 <span class="keywordflow">continue</span>;
01596 
01597             } <span class="keywordflow">else</span> {
01598 
01599                 <span class="keywordflow">if</span> (Pfn1-&gt;u3.e1.PrototypePte == 1) {
01600 
01601                     <span class="comment">//</span>
01602                     <span class="comment">// The true protection may be in the WSLE, locate</span>
01603                     <span class="comment">// the WSLE.</span>
01604                     <span class="comment">//</span>
01605 
01606                     Va = (PULONG)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
01607                     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d7/d0/wstree_8c.html#a7">MiLocateWsle</a> ((PVOID)Va, MmWorkingSetList,
01608                                             Pfn1-&gt;u1.WsIndex);
01609 
01610                     <span class="comment">//</span>
01611                     <span class="comment">// Check to see if this is a prototype PTE.  This</span>
01612                     <span class="comment">// is done by comparing the PTE address in the</span>
01613                     <span class="comment">// PFN database to the PTE address indicated by the</span>
01614                     <span class="comment">// VAD.  If they are not equal, this is a prototype</span>
01615                     <span class="comment">// PTE.</span>
01616                     <span class="comment">//</span>
01617 
01618                     <span class="keywordflow">if</span> (Pfn1-&gt;PteAddress !=
01619                                   <a class="code" href="../../d4/d8/mi_8h.html#a246">MiGetProtoPteAddress</a> (FoundVad,
01620                                               MI_VA_TO_VPN ((PVOID)Va))) {
01621 
01622                         <span class="comment">//</span>
01623                         <span class="comment">// This PTE refers to a fork prototype PTE, make it</span>
01624                         <span class="comment">// private.</span>
01625                         <span class="comment">//</span>
01626 
01627                         <a class="code" href="../../d3/d0/wrtfault_8c.html#a0">MiCopyOnWrite</a> ((PVOID)Va, PointerPte);
01628 
01629                         <span class="keywordflow">if</span> (WriteCopy) {
01630                             QuotaCharge += 1;
01631                         }
01632 
01633                         <span class="comment">//</span>
01634                         <span class="comment">// This may have released the working set mutex and</span>
01635                         <span class="comment">// the page table page may no longer be in memory.</span>
01636                         <span class="comment">//</span>
01637 
01638                         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
01639 
01640                         <span class="keywordflow">do</span> {
01641 
01642                             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
01643                                                               Process,
01644                                                               FALSE,
01645                                                               &amp;Waited);
01646 
01647                             Waited = 0;
01648 
01649                             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
01650                                                               Process,
01651                                                               FALSE,
01652                                                               &amp;Waited);
01653 
01654                         } <span class="keywordflow">while</span> (Waited != 0);
01655 
01656                         <span class="comment">//</span>
01657                         <span class="comment">// Do the loop again.</span>
01658                         <span class="comment">//</span>
01659 
01660                         <span class="keywordflow">continue</span>;
01661 
01662                     } <span class="keywordflow">else</span> {
01663 
01664                         <span class="comment">//</span>
01665                         <span class="comment">// Update the protection field in the WSLE and</span>
01666                         <span class="comment">// the PTE.</span>
01667                         <span class="comment">//</span>
01668                         <span class="comment">//</span>
01669                         <span class="comment">// If the PTE is copy on write uncharge the</span>
01670                         <span class="comment">// previously charged quota.</span>
01671                         <span class="comment">//</span>
01672 
01673                         <span class="keywordflow">if</span> ((!WriteCopy) &amp;&amp; (PteContents.u.Hard.CopyOnWrite == 1)) {
01674                             QuotaCharge += 1;
01675                         }
01676 
01677                         <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Protection = ProtectionMask;
01678                         <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.SameProtectAsProto = 0;
01679                     }
01680 
01681                 } <span class="keywordflow">else</span> {
01682 
01683                     <span class="comment">//</span>
01684                     <span class="comment">// Page is private (copy on written), protection mask</span>
01685                     <span class="comment">// is stored in the original pte field.</span>
01686                     <span class="comment">//</span>
01687 
01688 <span class="preprocessor">#if PFN_CONSISTENCY</span>
01689 <span class="preprocessor"></span>                    MiSetOriginalPteProtection (Pfn1, ProtectionMaskNotCopy);
01690 <span class="preprocessor">#else</span>
01691 <span class="preprocessor"></span>                    Pfn1-&gt;OriginalPte.u.Soft.Protection = ProtectionMaskNotCopy;
01692 <span class="preprocessor">#endif</span>
01693 <span class="preprocessor"></span>                    NewProtectionMask = ProtectionMaskNotCopy;
01694                 }
01695 
01696                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
01697                                    PteContents.u.Hard.PageFrameNumber,
01698                                    NewProtectionMask,
01699                                    PointerPte);
01700 
01701                 WorkingSetIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a110">MI_GET_WORKING_SET_FROM_PTE</a> (&amp;PteContents);
01702 
01703                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a109">MI_SET_PTE_IN_WORKING_SET</a> (&amp;TempPte, WorkingSetIndex);
01704             }
01705 
01706             <span class="comment">//</span>
01707             <span class="comment">// Flush the TB as we have changed the protection</span>
01708             <span class="comment">// of a valid PTE.</span>
01709             <span class="comment">//</span>
01710 
01711             PreviousPte.u.Flush = <a class="code" href="../../d0/d9/protect_8c.html#a1">MiFlushTbAndCapture</a> (PointerPte,
01712                                                        TempPte.u.Flush,
01713                                                        Pfn1);
01714         } <span class="keywordflow">else</span> {
01715 
01716             <span class="keywordflow">if</span> (PteContents.u.Soft.Prototype == 1) {
01717 
01718                 <span class="comment">//</span>
01719                 <span class="comment">// The PTE is in prototype PTE format.</span>
01720                 <span class="comment">//</span>
01721 
01722                 <span class="comment">//</span>
01723                 <span class="comment">// Is it a fork prototype PTE?</span>
01724                 <span class="comment">//</span>
01725 
01726                 Va = (PULONG)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
01727 
01728                 <span class="keywordflow">if</span> ((PteContents.u.Soft.PageFileHigh != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a181">MI_PTE_LOOKUP_NEEDED</a>) &amp;&amp;
01729                    (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a144">MiPteToProto</a> (PointerPte) !=
01730                                      <a class="code" href="../../d4/d8/mi_8h.html#a246">MiGetProtoPteAddress</a> (FoundVad,
01731                                          MI_VA_TO_VPN ((PVOID)Va)))) {
01732 
01733                     <span class="comment">//</span>
01734                     <span class="comment">// This PTE refers to a fork prototype PTE, make the</span>
01735                     <span class="comment">// page private.  This is accomplished by releasing</span>
01736                     <span class="comment">// the working set mutex, reading the page thereby</span>
01737                     <span class="comment">// causing a fault, and re-executing the loop, hopefully,</span>
01738                     <span class="comment">// this time, we'll find the page present and will</span>
01739                     <span class="comment">// turn it into a private page.</span>
01740                     <span class="comment">//</span>
01741                     <span class="comment">// Note, that page with prototype = 1 cannot be</span>
01742                     <span class="comment">// no-access.</span>
01743                     <span class="comment">//</span>
01744 
01745                     DoAgain = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01746 
01747                     <span class="keywordflow">while</span> (PteContents.u.Hard.Valid == 0) {
01748 
01749                         <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
01750 
01751                         <span class="keywordflow">try</span> {
01752 
01753                             *(<span class="keyword">volatile</span> ULONG *)Va;
01754                         } except (EXCEPTION_EXECUTE_HANDLER) {
01755 
01756                             <span class="keywordflow">if</span> (GetExceptionCode() !=
01757                                                 STATUS_GUARD_PAGE_VIOLATION) {
01758 
01759                                 <span class="comment">//</span>
01760                                 <span class="comment">// The prototype PTE must be noaccess.</span>
01761                                 <span class="comment">//</span>
01762 
01763                                 DoAgain = <a class="code" href="../../d0/d9/protect_8c.html#a8">MiChangeNoAccessForkPte</a> (PointerPte,
01764                                                                 ProtectionMask);
01765                             }
01766                         }
01767 
01768                         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
01769 
01770                         <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
01771 
01772                         <span class="keywordflow">do</span> {
01773 
01774                             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
01775                                                               Process,
01776                                                               FALSE,
01777                                                               &amp;Waited);
01778 
01779                             Waited = 0;
01780 
01781                             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
01782                                                               Process,
01783                                                               FALSE,
01784                                                               &amp;Waited);
01785 
01786                         } <span class="keywordflow">while</span> (Waited != 0);
01787 
01788                         PteContents = *(<span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> *)PointerPte;
01789                     }
01790 
01791                     <span class="keywordflow">if</span> (DoAgain) {
01792                         <span class="keywordflow">continue</span>;
01793                     }
01794 
01795                 } <span class="keywordflow">else</span> {
01796 
01797                     <span class="comment">//</span>
01798                     <span class="comment">// If the new protection is not write-copy, the PTE</span>
01799                     <span class="comment">// protection is not in the prototype PTE (can't be</span>
01800                     <span class="comment">// write copy for sections), and the protection in</span>
01801                     <span class="comment">// the PTE is write-copy, release the page file</span>
01802                     <span class="comment">// quota and commitment for this page.</span>
01803                     <span class="comment">//</span>
01804 
01805                     <span class="keywordflow">if</span> ((!WriteCopy) &amp;&amp;
01806                         (PteContents.u.Soft.PageFileHigh == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a181">MI_PTE_LOOKUP_NEEDED</a>)) {
01807                         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a88">MI_IS_PTE_PROTECTION_COPY_WRITE</a>(PteContents.u.Soft.Protection)) {
01808                             QuotaCharge += 1;
01809                         }
01810 
01811                     }
01812 
01813                     <span class="comment">//</span>
01814                     <span class="comment">// The PTE is a prototype PTE.  Make the high part</span>
01815                     <span class="comment">// of the PTE indicate that the protection field</span>
01816                     <span class="comment">// is in the PTE itself.</span>
01817                     <span class="comment">//</span>
01818 
01819                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, PrototypePte);
01820                     PointerPte-&gt;u.Soft.Protection = ProtectionMask;
01821                 }
01822 
01823             } <span class="keywordflow">else</span> {
01824 
01825                 <span class="keywordflow">if</span> (PteContents.u.Soft.Transition == 1) {
01826 
01827                     <span class="comment">//</span>
01828                     <span class="comment">// This is a transition PTE. (Page is private)</span>
01829                     <span class="comment">//</span>
01830 
01831                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/sysload_8c.html#a41">MiSetProtectionOnTransitionPte</a> (
01832                                                 PointerPte,
01833                                                 ProtectionMaskNotCopy)) {
01834                         <span class="keywordflow">continue</span>;
01835                     }
01836 
01837                 } <span class="keywordflow">else</span> {
01838 
01839                     <span class="comment">//</span>
01840                     <span class="comment">// Must be page file space or demand zero.</span>
01841                     <span class="comment">//</span>
01842 
01843                     PointerPte-&gt;u.Soft.Protection = ProtectionMaskNotCopy;
01844                 }
01845             }
01846         }
01847 
01848         PointerPte += 1;
01849     }
01850 
01851     <span class="comment">//</span>
01852     <span class="comment">// Return the quota charge and the commitment, if any.</span>
01853     <span class="comment">//</span>
01854 
01855     <span class="keywordflow">if</span> ((QuotaCharge &gt; 0) &amp;&amp; (!DontCharge)) {
01856 
01857         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (QuotaCharge);
01858         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_PROTECTION, QuotaCharge);
01859         <a class="code" href="../../d0/d2/psquota_8c.html#a5">MiReturnPageFileQuota</a> (QuotaCharge, Process);
01860 
01861         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (QuotaCharge &lt;= FoundVad-&gt;u.VadFlags.CommitCharge);
01862 
01863         FoundVad-&gt;u.VadFlags.CommitCharge -= QuotaCharge;
01864         <span class="keywordflow">if</span> (Process-&gt;JobStatus &amp; <a class="code" href="../../d1/d9/ps_8h.html#a13">PS_JOB_STATUS_REPORT_COMMIT_CHANGES</a>) {
01865             <a class="code" href="../../d1/d1/psjob_8c.html#a20">PsChangeJobMemoryUsage</a>(-(SSIZE_T)QuotaCharge);
01866         }
01867         Process-&gt;CommitCharge -= QuotaCharge;
01868     }
01869 
01870     <span class="keywordflow">return</span> Locked;
01871 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="protect.c::MiSetProtectionOnTransitionPte" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG MiSetProtectionOnTransitionPte           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PointerPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ProtectionMask</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/protect_8c-source.html#l02154">2154</a> of file <a class="el" href="../../d1/d8/protect_8c-source.html">protect.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
<pre class="fragment"><div>02161 {
02162     KIRQL OldIrql;
02163     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
02164     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
02165 
02166     <span class="comment">//</span>
02167     <span class="comment">// This is a transition PTE. (Page is private)</span>
02168     <span class="comment">//</span>
02169 
02170     <span class="comment">//</span>
02171     <span class="comment">// Need pfn mutex to ensure page doesn't become</span>
02172     <span class="comment">// non-transition.</span>
02173     <span class="comment">//</span>
02174 
02175     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02176 
02177     <span class="comment">//</span>
02178     <span class="comment">// Make sure the page is still a transition page.</span>
02179     <span class="comment">//</span>
02180 
02181     PteContents = *(<span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> *)PointerPte;
02182 
02183     <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
02184                      (PointerPte-&gt;u.Soft.Transition == 1)) {
02185 
02186         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (
02187                       PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Trans.PageFrameNumber);
02188 
02189         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = ProtectionMask;
02190         PointerPte-&gt;u.Soft.Protection = ProtectionMask;
02191         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02192         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02193     }
02194 
02195     <span class="comment">//</span>
02196     <span class="comment">// Do this loop again for the same PTE.</span>
02197     <span class="comment">//</span>
02198 
02199     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02200     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02201 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="protect.c::NtProtectVirtualMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtProtectVirtualMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>RegionSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NewProtect</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>OldProtect</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/protect_8c-source.html#l00069">69</a> of file <a class="el" href="../../d1/d8/protect_8c-source.html">protect.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00243">MiMakeProtectionMask()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l00344">MiProtectVirtualMemory()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00189">MM_DBG_SHOW_NT_CALLS</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01598">ProbeForWritePointer</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01649">ProbeForWriteUlong</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01666">ProbeForWriteUlong_ptr</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00088">PsProcessType</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03781">LdrpDphSnapImports()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03417">LdrpSetProtection()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02258">LdrpSnapIAT()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00214">LdrpWalkImportDescriptor()</a>, and <a class="el" href="../../d0/d2/utxcpt1_8c-source.html#l00005">main()</a>.
<p>
<pre class="fragment"><div>00079                    :
00080 
00081     This routine changes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection on a region of committed pages
00082     within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address space of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject process.  Setting
00083     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection on a range of pages causes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> old protection to be
00084     replaced by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified protection value.
00085 
00086 Arguments:
00087 
00088      ProcessHandle - An open handle to a process object.
00089 
00090      BaseAddress - The base address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> region of pages
00091           whose protection <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be changed. This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00092           rounded down to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next host page address
00093           boundary.
00094 
00095      RegionSize - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to a variable that will receive
00096           <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual size in bytes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">protected</span> region
00097           of pages. The initial value of <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00098           rounded up to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next host page size boundary.
00099 
00100      NewProtect - The <span class="keyword">new</span> protection desired <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00101           specified region of pages.
00102 
00103      Protect Values
00104 
00105           PAGE_NOACCESS - No access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified region
00106                of pages <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed. An attempt to read,
00107                write, or execute <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified region
00108                results in an access violation (i.e. a GP
00109                fault).
00110 
00111           PAGE_EXECUTE - Execute access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00112                region of pages <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed. An attempt to
00113                read or write <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified region results in
00114                an access violation.
00115 
00116           PAGE_READONLY - Read <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> and execute access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00117                specified region of pages <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed. An
00118                attempt to write <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified region results
00119                in an access violation.
00120 
00121           PAGE_READWRITE - Read, write, and execute access to
00122                <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified region of pages <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed. If
00123                write access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> underlying section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00124                allowed, then a single copy of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages are
00125                shared. Otherwise <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages are shared read
00126                <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>/copy on write.
00127 
00128           PAGE_GUARD - Read, write, and execute access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00129                specified region of pages <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed,
00130                however, access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> region causes a <span class="stringliteral">"guard</span>
00131 <span class="stringliteral">               region entered"</span> condition to be raised in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00132                subject process. If write access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00133                underlying section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed, then a single
00134                copy of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages are shared. Otherwise <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00135                pages are shared read <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>/copy on write.
00136 
00137           PAGE_NOCACHE - The page should be treated as uncached.
00138                This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> valid <span class="keywordflow">for</span> non-shared pages.
00139 
00140 
00141      OldProtect - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to a variable that will receive
00142           <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> old protection of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first page within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00143           specified region of pages.
00144 
00145 Return Value:
00146 
00147     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status
00148 
00149     TBS
00150 
00151 
00152 Environment:
00153 
00154     Kernel mode.
00155 
00156 --*/
00157 
00158 
00159 {
00160     <span class="comment">//</span>
00161     <span class="comment">// note - special treatment for the following cases...</span>
00162     <span class="comment">//</span>
00163     <span class="comment">// if a page is locked in the working set (memory?) and the</span>
00164     <span class="comment">// protection is changed to no access, the page should be</span>
00165     <span class="comment">// removed from the working set... valid pages can't be no access.</span>
00166     <span class="comment">//</span>
00167     <span class="comment">// if page is going to be read only or no access? and is demand</span>
00168     <span class="comment">// zero, make sure it is changed to a page of zeroes.</span>
00169     <span class="comment">//</span>
00170     <span class="comment">// update the vm spec to explain locked pages are unlocked when</span>
00171     <span class="comment">// freed or protection is changed to no-access (this may be a nasty</span>
00172     <span class="comment">// problem if we don't want to do this!!</span>
00173     <span class="comment">//</span>
00174 
00175     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00176     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00177     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00178     ULONG Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00179     PVOID CapturedBase;
00180     SIZE_T CapturedRegionSize;
00181     ULONG ProtectionMask;
00182 
00183     ULONG LastProtect;
00184 
00185     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00186 
00187     <span class="comment">//</span>
00188     <span class="comment">// Check the protection field.  This could raise an exception.</span>
00189     <span class="comment">//</span>
00190 
00191     <span class="keywordflow">try</span> {
00192         ProtectionMask = <a class="code" href="../../d0/d2/mmsup_8c.html#a5">MiMakeProtectionMask</a> (NewProtect);
00193     } except (EXCEPTION_EXECUTE_HANDLER) {
00194         <span class="keywordflow">return</span> GetExceptionCode();
00195     }
00196 
00197     PreviousMode = KeGetPreviousMode();
00198 
00199     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00200 
00201         <span class="comment">//</span>
00202         <span class="comment">// Capture the region size and base address under an exception handler.</span>
00203         <span class="comment">//</span>
00204 
00205         <span class="keywordflow">try</span> {
00206 
00207             <a class="code" href="../../d5/d8/ex_8h.html#a37">ProbeForWritePointer</a> (BaseAddress);
00208             <a class="code" href="../../d5/d8/ex_8h.html#a41">ProbeForWriteUlong_ptr</a> (RegionSize);
00209             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a> (OldProtect);
00210 
00211             <span class="comment">//</span>
00212             <span class="comment">// Capture the region size and base address.</span>
00213             <span class="comment">//</span>
00214 
00215             CapturedBase = *BaseAddress;
00216             CapturedRegionSize = *RegionSize;
00217 
00218         } except (EXCEPTION_EXECUTE_HANDLER) {
00219 
00220             <span class="comment">//</span>
00221             <span class="comment">// If an exception occurs during the probe or capture</span>
00222             <span class="comment">// of the initial values, then handle the exception and</span>
00223             <span class="comment">// return the exception code as the status value.</span>
00224             <span class="comment">//</span>
00225 
00226             <span class="keywordflow">return</span> GetExceptionCode();
00227         }
00228 
00229     } <span class="keywordflow">else</span> {
00230 
00231         <span class="comment">//</span>
00232         <span class="comment">// Capture the region size and base address.</span>
00233         <span class="comment">//</span>
00234 
00235         CapturedRegionSize = *RegionSize;
00236         CapturedBase = *BaseAddress;
00237     }
00238 
00239 <span class="preprocessor">#if DBG</span>
00240 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a81">MM_DBG_SHOW_NT_CALLS</a>) {
00241         <span class="keywordflow">if</span> ( !MmWatchProcess ) {
00242             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"protectvm process handle %lx base address %lx size %lx protect %lx\n"</span>,
00243                 ProcessHandle, CapturedBase, CapturedRegionSize, NewProtect);
00244         }
00245     }
00246 <span class="preprocessor">#endif</span>
00247 <span class="preprocessor"></span>
00248     <span class="comment">//</span>
00249     <span class="comment">// Make sure the specified starting and ending addresses are</span>
00250     <span class="comment">// within the user part of the virtual address space.</span>
00251     <span class="comment">//</span>
00252 
00253     <span class="keywordflow">if</span> (CapturedBase &gt; MM_HIGHEST_USER_ADDRESS) {
00254 
00255         <span class="comment">//</span>
00256         <span class="comment">// Invalid base address.</span>
00257         <span class="comment">//</span>
00258 
00259         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
00260     }
00261 
00262     <span class="keywordflow">if</span> ((ULONG_PTR)MM_HIGHEST_USER_ADDRESS - (ULONG_PTR)CapturedBase &lt;
00263                   CapturedRegionSize) {
00264 
00265         <span class="comment">//</span>
00266         <span class="comment">// Invalid region size;</span>
00267         <span class="comment">//</span>
00268 
00269         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_3;
00270     }
00271 
00272     <span class="keywordflow">if</span> (CapturedRegionSize == 0) {
00273         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_3;
00274     }
00275 
00276     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> ( ProcessHandle,
00277                                          PROCESS_VM_OPERATION,
00278                                          PsProcessType,
00279                                          PreviousMode,
00280                                          (PVOID *)&amp;Process,
00281                                          NULL );
00282 
00283     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00284         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00285     }
00286 
00287     <span class="comment">//</span>
00288     <span class="comment">// If the specified process is not the current process, attach</span>
00289     <span class="comment">// to the specified process.</span>
00290     <span class="comment">//</span>
00291 
00292     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != Process) {
00293         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>);
00294         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00295     }
00296 
00297     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d9/protect_8c.html#a5">MiProtectVirtualMemory</a> (Process,
00298                                      &amp;CapturedBase,
00299                                      &amp;CapturedRegionSize,
00300                                      NewProtect,
00301                                      &amp;LastProtect);
00302 
00303 
00304     <span class="keywordflow">if</span> (Attached) {
00305         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00306     }
00307 
00308     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (Process);
00309 
00310     <span class="comment">//</span>
00311     <span class="comment">// Establish an exception handler and write the size and base</span>
00312     <span class="comment">// address.</span>
00313     <span class="comment">//</span>
00314 
00315     <span class="keywordflow">try</span> {
00316 
00317         <span class="comment">//</span>
00318         <span class="comment">// Reprobe the addresses as certain architectures (intel 386 for one)</span>
00319         <span class="comment">// do not trap kernel writes.  This is the one service which allows</span>
00320         <span class="comment">// the protection of the page to change between the initial probe</span>
00321         <span class="comment">// and the final argument update.</span>
00322         <span class="comment">//</span>
00323 
00324         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00325 
00326             <a class="code" href="../../d5/d8/ex_8h.html#a37">ProbeForWritePointer</a> (BaseAddress);
00327             <a class="code" href="../../d5/d8/ex_8h.html#a41">ProbeForWriteUlong_ptr</a> (RegionSize);
00328             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a> (OldProtect);
00329         }
00330 
00331         *RegionSize = CapturedRegionSize;
00332         *BaseAddress = CapturedBase;
00333         *OldProtect = LastProtect;
00334 
00335     } except (EXCEPTION_EXECUTE_HANDLER) {
00336         NOTHING;
00337     }
00338 
00339     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00340 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a0" doxytag="protect.c::MmReadWrite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CCHAR <a class="el" href="../../d0/d9/protect_8c.html#a0">MmReadWrite</a>[32]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/protect_8c-source.html#l00057">57</a> of file <a class="el" href="../../d1/d8/protect_8c-source.html">protect.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/acceschk_8c-source.html#l00042">MiAccessCheck()</a>, and <a class="el" href="../../d1/d8/protect_8c-source.html#l02244">MiCheckSecuredVad()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:21 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
