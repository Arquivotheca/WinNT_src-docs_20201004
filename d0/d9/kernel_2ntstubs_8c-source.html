<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ntstubs.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ntstubs.c</h1><a href="../../d9/d9/kernel_2ntstubs_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: ntstubs.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Kernel-mode stubs</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 03-16-95 JimA             Created.</span>
00010 <span class="comment">* 08-12-96 jparsons         Added lparam validate for WM_NCCREATE [51986]</span>
00011 <span class="comment">\***************************************************************************/</span>
00012 
00013 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00014 <span class="preprocessor">#pragma hdrstop</span>
00015 <span class="preprocessor"></span>
00016 <span class="preprocessor">#include "cscall.h"</span>
00017 
00018 <span class="preprocessor">#include &lt;dbt.h&gt;</span>
<a name="l00019"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a0">00019</a> <span class="preprocessor">#define PROTOS_ONLY 1</span>
00020 <span class="preprocessor"></span><span class="preprocessor">#include "msgdef.h"</span>
00021 
00022 <span class="preprocessor">#if DBG</span>
00023 <span class="preprocessor"></span><span class="keywordtype">int</span> ThreadLockCount(<span class="keywordtype">void</span>)
00024 {
00025     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>();
00026     <a class="code" href="../../d5/d1/struct__TL.html">PTL</a> ptl = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o1">ptl</a>;
00027     <span class="keywordtype">int</span> nLocks = 0;
00028 
00029     <span class="keywordflow">while</span> (ptl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00030         nLocks++;
00031         ptl = ptl-&gt;next;
00032     }
00033     ptl = ptiCurrent-&gt;ptlW32;
00034     <span class="keywordflow">while</span> (ptl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00035         nLocks++;
00036         ptl = ptl-&gt;next;
00037     }
00038     <span class="keywordflow">return</span> nLocks;
00039 }
00040 <span class="keywordtype">void</span> ThreadLockCheck(<span class="keywordtype">int</span> nLocks)
00041 {
00042     <span class="keywordtype">int</span> nNewCount = ThreadLockCount();
00043     <span class="keywordflow">if</span> (nLocks != nNewCount) {
00044 
00045         <span class="keywordflow">if</span> (**((PBOOLEAN*)&amp;<a class="code" href="../../d7/d3/kd_8h.html#a13">KdDebuggerEnabled</a>)) {
00046 
00047             <span class="comment">/*</span>
00048 <span class="comment">             * The below is as is because it is intended to work on both</span>
00049 <span class="comment">             * free and checked builds when thread lock counting is on.</span>
00050 <span class="comment">             */</span>
00051 <span class="preprocessor">            #undef DbgPrint</span>
00052 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"ThreadLocks mismatch %d %d\n"</span>, nLocks, nNewCount);
00053             DbgBreakPoint();
00054         }
00055     }
00056 }
00057 <span class="comment">// The parameter is used ensure BEGINRECV* matches ENDRECV* in each stub</span>
00058 <span class="preprocessor">#define DBG_THREADLOCK_START(s)   { int nLocks ## s = ThreadLockCount();</span>
00059 <span class="preprocessor"></span><span class="preprocessor">#define DBG_THREADLOCK_END(s)     ThreadLockCheck(nLocks ## s); }</span>
00060 <span class="preprocessor"></span><span class="preprocessor">#else // DBG_THREADLOCK</span>
<a name="l00061"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a1">00061</a> <span class="preprocessor"></span><span class="preprocessor">#define DBG_THREADLOCK_START(s)</span>
<a name="l00062"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a2">00062</a> <span class="preprocessor"></span><span class="preprocessor">#define DBG_THREADLOCK_END(s)</span>
00063 <span class="preprocessor"></span><span class="preprocessor">#endif // DBG_THREADLOCK</span>
00064 <span class="preprocessor"></span>
00065 <span class="comment">/*</span>
00066 <span class="comment"> * Setup and control macros</span>
00067 <span class="comment"> */</span>
<a name="l00068"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a3">00068</a> <span class="preprocessor">#define BEGINRECV(type, err)    \</span>
00069 <span class="preprocessor">    type retval;                \</span>
00070 <span class="preprocessor">    type errret = err;          \</span>
00071 <span class="preprocessor">    EnterCrit();                \</span>
00072 <span class="preprocessor">    DBG_THREADLOCK_START(_)</span>
<a name="l00073"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a4">00073</a> <span class="preprocessor"></span><span class="preprocessor">#define ENDRECV() ENDRECV_(_)</span>
00074 <span class="preprocessor"></span>
<a name="l00075"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">00075</a> <span class="preprocessor">#define BEGINATOMICRECV(type, err)    \</span>
00076 <span class="preprocessor">    type retval;                \</span>
00077 <span class="preprocessor">    type errret = err;          \</span>
00078 <span class="preprocessor">    EnterCrit();                \</span>
00079 <span class="preprocessor">    DBG_THREADLOCK_START(_)     \</span>
00080 <span class="preprocessor">    BEGINATOMICCHECK()</span>
<a name="l00081"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">00081</a> <span class="preprocessor"></span><span class="preprocessor">#define ENDATOMICRECV() ENDATOMICRECV_(_)</span>
00082 <span class="preprocessor"></span>
<a name="l00083"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a7">00083</a> <span class="preprocessor">#define BEGINRECVCSRSS(type, err)      \</span>
00084 <span class="preprocessor">    type retval;                       \</span>
00085 <span class="preprocessor">    type errret = err;                 \</span>
00086 <span class="preprocessor">    EnterCrit();                       \</span>
00087 <span class="preprocessor">    DBG_THREADLOCK_START(CSRSS)          \</span>
00088 <span class="preprocessor">    if (!ISCSRSS()) {                  \</span>
00089 <span class="preprocessor">        retval = STATUS_ACCESS_DENIED; \</span>
00090 <span class="preprocessor">        goto errorexit;                \</span>
00091 <span class="preprocessor">    }</span>
<a name="l00092"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a8">00092</a> <span class="preprocessor"></span><span class="preprocessor">#define ENDRECVCSRSS() ENDRECV_(CSRSS)</span>
00093 <span class="preprocessor"></span>
<a name="l00094"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">00094</a> <span class="preprocessor">#define BEGINRECV_SHARED(type, err) \</span>
00095 <span class="preprocessor">    type retval;                    \</span>
00096 <span class="preprocessor">    type errret = err;              \</span>
00097 <span class="preprocessor">    EnterSharedCrit();              \</span>
00098 <span class="preprocessor">    DBG_THREADLOCK_START(SHARED)</span>
<a name="l00099"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">00099</a> <span class="preprocessor"></span><span class="preprocessor">#define ENDRECV_SHARED() ENDRECV_(SHARED)</span>
00100 <span class="preprocessor"></span>
<a name="l00101"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a11">00101</a> <span class="preprocessor">#define BEGINRECV_NOCRIT(type, err) \</span>
00102 <span class="preprocessor">    type retval;                    \</span>
00103 <span class="preprocessor">    type errret = err;</span>
00104 <span class="preprocessor"></span>
<a name="l00105"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a12">00105</a> <span class="preprocessor">#define BEGINRECV_VOID() \</span>
00106 <span class="preprocessor">    EnterCrit();         \</span>
00107 <span class="preprocessor">    DBG_THREADLOCK_START(_VOID)</span>
<a name="l00108"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a13">00108</a> <span class="preprocessor"></span><span class="preprocessor">#define ENDRECV_VOID() ENDRECV_VOID_(_VOID)</span>
00109 <span class="preprocessor"></span>
<a name="l00110"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a14">00110</a> <span class="preprocessor">#define BEGINRECV_HWND(type, err, hwnd)           \</span>
00111 <span class="preprocessor">    type retval;                                  \</span>
00112 <span class="preprocessor">    type errret = err;                            \</span>
00113 <span class="preprocessor">    PWND pwnd;                                    \</span>
00114 <span class="preprocessor">    EnterCrit();                                  \</span>
00115 <span class="preprocessor">    DBG_THREADLOCK_START(HWND)                    \</span>
00116 <span class="preprocessor">    if ((pwnd = ValidateHwnd((hwnd))) == NULL) {  \</span>
00117 <span class="preprocessor">        retval = errret;                          \</span>
00118 <span class="preprocessor">        goto errorexit;                           \</span>
00119 <span class="preprocessor">    }</span>
<a name="l00120"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a15">00120</a> <span class="preprocessor"></span><span class="preprocessor">#define ENDRECV_HWND() ENDRECV_HWND_(HWND)</span>
00121 <span class="preprocessor"></span>
<a name="l00122"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a16">00122</a> <span class="preprocessor">#define BEGINATOMICRECV_HWND(type, err, hwnd)     \</span>
00123 <span class="preprocessor">    type retval;                                  \</span>
00124 <span class="preprocessor">    type errret = err;                            \</span>
00125 <span class="preprocessor">    PWND pwnd;                                    \</span>
00126 <span class="preprocessor">    EnterCrit();                                  \</span>
00127 <span class="preprocessor">    DBG_THREADLOCK_START(HWND)                    \</span>
00128 <span class="preprocessor">    BEGINATOMICCHECK()                            \</span>
00129 <span class="preprocessor">    if ((pwnd = ValidateHwnd((hwnd))) == NULL) {  \</span>
00130 <span class="preprocessor">        retval = errret;                          \</span>
00131 <span class="preprocessor">        goto errorexit;                           \</span>
00132 <span class="preprocessor">    }</span>
<a name="l00133"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a17">00133</a> <span class="preprocessor"></span><span class="preprocessor">#define ENDATOMICRECV_HWND() ENDATOMICRECV_HWND_(HWND)</span>
00134 <span class="preprocessor"></span>
<a name="l00135"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a18">00135</a> <span class="preprocessor">#define BEGINRECV_HWND_VOID(hwnd)                 \</span>
00136 <span class="preprocessor">    PWND pwnd;                                    \</span>
00137 <span class="preprocessor">    EnterCrit();                                  \</span>
00138 <span class="preprocessor">    DBG_THREADLOCK_START(HWND_VOID)               \</span>
00139 <span class="preprocessor">    if ((pwnd = ValidateHwnd((hwnd))) == NULL) {  \</span>
00140 <span class="preprocessor">        goto errorexit;                           \</span>
00141 <span class="preprocessor">    }</span>
<a name="l00142"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a19">00142</a> <span class="preprocessor"></span><span class="preprocessor">#define ENDRECV_HWND_VOID() ENDRECV_VOID_(HWND_VOID)</span>
00143 <span class="preprocessor"></span>
<a name="l00144"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a20">00144</a> <span class="preprocessor">#define BEGINRECV_HWND_SHARED(type, err, hwnd)    \</span>
00145 <span class="preprocessor">    type retval;                                  \</span>
00146 <span class="preprocessor">    type errret = err;                            \</span>
00147 <span class="preprocessor">    PWND pwnd;                                    \</span>
00148 <span class="preprocessor">    EnterSharedCrit();                            \</span>
00149 <span class="preprocessor">    DBG_THREADLOCK_START(HWND_SHARED)             \</span>
00150 <span class="preprocessor">    if ((pwnd = ValidateHwnd((hwnd))) == NULL) {  \</span>
00151 <span class="preprocessor">        retval = errret;                          \</span>
00152 <span class="preprocessor">        goto errorexit;                           \</span>
00153 <span class="preprocessor">    }</span>
<a name="l00154"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a21">00154</a> <span class="preprocessor"></span><span class="preprocessor">#define ENDRECV_HWND_SHARED() ENDRECV_HWND_(HWND_SHARED)</span>
00155 <span class="preprocessor"></span>
<a name="l00156"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a22">00156</a> <span class="preprocessor">#define BEGINRECV_HWNDOPT_SHARED(type, err, hwnd)    \</span>
00157 <span class="preprocessor">    type retval;                                     \</span>
00158 <span class="preprocessor">    type errret = err;                               \</span>
00159 <span class="preprocessor">    PWND pwnd;                                       \</span>
00160 <span class="preprocessor">    EnterSharedCrit();                               \</span>
00161 <span class="preprocessor">    DBG_THREADLOCK_START(HWND_OPT_SHARED)              \</span>
00162 <span class="preprocessor">    if (hwnd) {                                      \</span>
00163 <span class="preprocessor">        if ((pwnd = ValidateHwnd((hwnd))) == NULL) { \</span>
00164 <span class="preprocessor">            retval = errret;                         \</span>
00165 <span class="preprocessor">            goto errorexit;                          \</span>
00166 <span class="preprocessor">        }                                            \</span>
00167 <span class="preprocessor">    } else {                                         \</span>
00168 <span class="preprocessor">        pwnd = NULL;                                 \</span>
00169 <span class="preprocessor">    }</span>
<a name="l00170"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a23">00170</a> <span class="preprocessor"></span><span class="preprocessor">#define ENDRECV_HWNDOPT_SHARED() ENDRECV_HWND_(HWND_OPT_SHARED)</span>
00171 <span class="preprocessor"></span>
<a name="l00172"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">00172</a> <span class="preprocessor">#define BEGINRECV_HWNDLOCK(type, err, hwnd)      \</span>
00173 <span class="preprocessor">    type retval;                                 \</span>
00174 <span class="preprocessor">    type errret = err;                           \</span>
00175 <span class="preprocessor">    PWND pwnd;                                   \</span>
00176 <span class="preprocessor">    TL tlpwnd;                                   \</span>
00177 <span class="preprocessor">    PTHREADINFO ptiCurrent;                      \</span>
00178 <span class="preprocessor">    EnterCrit();                                 \</span>
00179 <span class="preprocessor">    DBG_THREADLOCK_START(HWNDLOCK)                 \</span>
00180 <span class="preprocessor">    if ((pwnd = ValidateHwnd((hwnd))) == NULL) { \</span>
00181 <span class="preprocessor">        retval = errret;                         \</span>
00182 <span class="preprocessor">        goto errorexit2;                         \</span>
00183 <span class="preprocessor">    }                                            \</span>
00184 <span class="preprocessor">    ptiCurrent = PtiCurrent();                   \</span>
00185 <span class="preprocessor">    ThreadLockAlwaysWithPti(ptiCurrent, pwnd, &amp;tlpwnd);</span>
<a name="l00186"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">00186</a> <span class="preprocessor"></span><span class="preprocessor">#define ENDRECV_HWNDLOCK() ENDRECV_HWNDLOCK_(HWNDLOCK)</span>
00187 <span class="preprocessor"></span>
<a name="l00188"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a26">00188</a> <span class="preprocessor">#define BEGINRECV_HWNDLOCK_ND(type, err, hwnd)       \</span>
00189 <span class="preprocessor">    type retval;                                     \</span>
00190 <span class="preprocessor">    type errret = err;                               \</span>
00191 <span class="preprocessor">    PWND pwndND;                                     \</span>
00192 <span class="preprocessor">    TL tlpwnd;                                       \</span>
00193 <span class="preprocessor">    PTHREADINFO ptiCurrent;                          \</span>
00194 <span class="preprocessor">    EnterCrit();                                     \</span>
00195 <span class="preprocessor">    DBG_THREADLOCK_START(HWNDLOCK_ND)                \</span>
00196 <span class="preprocessor">    if (((pwndND = ValidateHwnd((hwnd))) == NULL) || \</span>
00197 <span class="preprocessor">            (pwndND == _GetDesktopWindow()) ||       \</span>
00198 <span class="preprocessor">            (pwndND == _GetMessageWindow())) {       \</span>
00199 <span class="preprocessor">        retval = errret;                             \</span>
00200 <span class="preprocessor">        goto errorexit2;                             \</span>
00201 <span class="preprocessor">    }                                                \</span>
00202 <span class="preprocessor">    ptiCurrent = PtiCurrent();                       \</span>
00203 <span class="preprocessor">    ThreadLockAlwaysWithPti(ptiCurrent, pwndND, &amp;tlpwnd);</span>
<a name="l00204"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a27">00204</a> <span class="preprocessor"></span><span class="preprocessor">#define ENDRECV_HWNDLOCK_ND() ENDRECV_HWNDLOCK_(HWNDLOCK_ND)</span>
00205 <span class="preprocessor"></span>
<a name="l00206"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a28">00206</a> <span class="preprocessor">#define BEGINRECV_HWNDLOCK_OPT(type, err, hwnd) \</span>
00207 <span class="preprocessor">    type retval;                                    \</span>
00208 <span class="preprocessor">    type errret = err;                              \</span>
00209 <span class="preprocessor">    PWND pwnd;                                      \</span>
00210 <span class="preprocessor">    TL tlpwnd;                                      \</span>
00211 <span class="preprocessor">    PTHREADINFO ptiCurrent;                         \</span>
00212 <span class="preprocessor">    EnterCrit();                                    \</span>
00213 <span class="preprocessor">    DBG_THREADLOCK_START(HWNDLOCK_OPT)                \</span>
00214 <span class="preprocessor">    if (hwnd) {                                     \</span>
00215 <span class="preprocessor">        if ((pwnd = ValidateHwnd(hwnd)) == NULL) {  \</span>
00216 <span class="preprocessor">            retval = errret;                        \</span>
00217 <span class="preprocessor">            goto errorexit2;                        \</span>
00218 <span class="preprocessor">        }                                           \</span>
00219 <span class="preprocessor">    } else {                                        \</span>
00220 <span class="preprocessor">        pwnd = NULL;                                \</span>
00221 <span class="preprocessor">    }                                               \</span>
00222 <span class="preprocessor">    ptiCurrent = PtiCurrent();                      \</span>
00223 <span class="preprocessor">    ThreadLockWithPti(ptiCurrent, pwnd, &amp;tlpwnd);</span>
<a name="l00224"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a29">00224</a> <span class="preprocessor"></span><span class="preprocessor">#define ENDRECV_HWNDLOCK_OPT() ENDRECV_HWNDLOCK_(HWNDLOCK_OPT)</span>
00225 <span class="preprocessor"></span>
<a name="l00226"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a30">00226</a> <span class="preprocessor">#define BEGINRECV_HWNDLOCK_VOID(hwnd) \</span>
00227 <span class="preprocessor">    PWND pwnd;                                          \</span>
00228 <span class="preprocessor">    TL tlpwnd;                                          \</span>
00229 <span class="preprocessor">    PTHREADINFO ptiCurrent;                             \</span>
00230 <span class="preprocessor">    EnterCrit();                                        \</span>
00231 <span class="preprocessor">    DBG_THREADLOCK_START(HWNDLOCK_VOID)                   \</span>
00232 <span class="preprocessor">    if ((pwnd = ValidateHwnd((hwnd))) == NULL) {        \</span>
00233 <span class="preprocessor">        goto errorexit2;                                \</span>
00234 <span class="preprocessor">    }                                                   \</span>
00235 <span class="preprocessor">    ptiCurrent = PtiCurrent();                          \</span>
00236 <span class="preprocessor">    ThreadLockAlwaysWithPti(ptiCurrent, pwnd, &amp;tlpwnd);</span>
00237 <span class="preprocessor"></span>
<a name="l00238"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a31">00238</a> <span class="preprocessor">#define ISXPFNPROCINRANGE(range)                        \</span>
00239 <span class="preprocessor">    ((xpfnProc &gt;= SFI_BEGINTRANSLATE ## range)          \</span>
00240 <span class="preprocessor">        &amp;&amp; (xpfnProc &lt; SFI_ENDTRANSLATE ## range))</span>
00241 <span class="preprocessor"></span>
<a name="l00242"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a32">00242</a> <span class="preprocessor">#define VALIDATEXPFNPROC(range)                                 \</span>
00243 <span class="preprocessor">    UserAssert(SFI_ENDTRANSLATETABLE == ulMaxSimpleCall);       \</span>
00244 <span class="preprocessor">    UserAssert(SFI_ENDTRANSLATE ## range &lt;= ulMaxSimpleCall);   \</span>
00245 <span class="preprocessor">    if (!ISXPFNPROCINRANGE(range)) {                            \</span>
00246 <span class="preprocessor">        MSGERROR(0);                                             \</span>
00247 <span class="preprocessor">    }</span>
00248 <span class="preprocessor"></span>
00249 
00250 
<a name="l00251"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a33">00251</a> <span class="preprocessor">#define CLEANUPRECV() \</span>
00252 <span class="preprocessor">cleanupexit:</span>
00253 <span class="preprocessor"></span>
<a name="l00254"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a34">00254</a> <span class="preprocessor">#define ENDRECV_(s)       \</span>
00255 <span class="preprocessor">    goto errorexit;       \</span>
00256 <span class="preprocessor">errorexit:                \</span>
00257 <span class="preprocessor">    DBG_THREADLOCK_END(s) \</span>
00258 <span class="preprocessor">    LeaveCrit();          \</span>
00259 <span class="preprocessor">    return retval;</span>
00260 <span class="preprocessor"></span>
<a name="l00261"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a35">00261</a> <span class="preprocessor">#define ENDATOMICRECV_(s) \</span>
00262 <span class="preprocessor">    goto errorexit;       \</span>
00263 <span class="preprocessor">errorexit:                \</span>
00264 <span class="preprocessor">    ENDATOMICCHECK()      \</span>
00265 <span class="preprocessor">    DBG_THREADLOCK_END(s) \</span>
00266 <span class="preprocessor">    LeaveCrit();          \</span>
00267 <span class="preprocessor">    return retval;</span>
00268 <span class="preprocessor"></span>
<a name="l00269"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a36">00269</a> <span class="preprocessor">#define ENDRECV_NOCRIT() \</span>
00270 <span class="preprocessor">    goto errorexit;      \</span>
00271 <span class="preprocessor">errorexit:               \</span>
00272 <span class="preprocessor">    return retval;</span>
00273 <span class="preprocessor"></span>
<a name="l00274"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a37">00274</a> <span class="preprocessor">#define ENDRECV_VOID_(s) \</span>
00275 <span class="preprocessor">    goto errorexit;      \</span>
00276 <span class="preprocessor">errorexit:               \</span>
00277 <span class="preprocessor">    DBG_THREADLOCK_END(s)  \</span>
00278 <span class="preprocessor">    LeaveCrit();         \</span>
00279 <span class="preprocessor">    return;</span>
00280 <span class="preprocessor"></span>
<a name="l00281"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a38">00281</a> <span class="preprocessor">#define ENDRECV_HWND_(s) \</span>
00282 <span class="preprocessor">    goto errorexit;         \</span>
00283 <span class="preprocessor">errorexit:                  \</span>
00284 <span class="preprocessor">    DBG_THREADLOCK_END(s)     \</span>
00285 <span class="preprocessor">    LeaveCrit();            \</span>
00286 <span class="preprocessor">    return retval;</span>
00287 <span class="preprocessor"></span>
<a name="l00288"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a39">00288</a> <span class="preprocessor">#define ENDATOMICRECV_HWND_(s) \</span>
00289 <span class="preprocessor">    goto errorexit;         \</span>
00290 <span class="preprocessor">errorexit:                  \</span>
00291 <span class="preprocessor">    ENDATOMICCHECK()        \</span>
00292 <span class="preprocessor">    DBG_THREADLOCK_END(s)   \</span>
00293 <span class="preprocessor">    LeaveCrit();            \</span>
00294 <span class="preprocessor">    return retval;</span>
00295 <span class="preprocessor"></span>
<a name="l00296"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a40">00296</a> <span class="preprocessor">#define ENDRECV_HWNDLOCK_(s) \</span>
00297 <span class="preprocessor">    goto errorexit;          \</span>
00298 <span class="preprocessor">errorexit:                   \</span>
00299 <span class="preprocessor">    ThreadUnlock(&amp;tlpwnd);   \</span>
00300 <span class="preprocessor">errorexit2:                  \</span>
00301 <span class="preprocessor">    DBG_THREADLOCK_END(s)      \</span>
00302 <span class="preprocessor">    LeaveCrit();             \</span>
00303 <span class="preprocessor">    return retval;</span>
00304 <span class="preprocessor"></span>
<a name="l00305"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a41">00305</a> <span class="preprocessor">#define ENDRECV_HWNDLOCK_VOID() \</span>
00306 <span class="preprocessor">    goto errorexit;                 \</span>
00307 <span class="preprocessor">errorexit:                          \</span>
00308 <span class="preprocessor">    ThreadUnlock(&amp;tlpwnd);          \</span>
00309 <span class="preprocessor">errorexit2:                         \</span>
00310 <span class="preprocessor">    DBG_THREADLOCK_END(HWNDLOCK_VOID) \</span>
00311 <span class="preprocessor">    LeaveCrit();                    \</span>
00312 <span class="preprocessor">    return;</span>
00313 <span class="preprocessor"></span>
00314 <span class="comment">/*</span>
00315 <span class="comment"> * MSGERROR - exit the stub with an error condition.</span>
00316 <span class="comment"> * Parameters:</span>
00317 <span class="comment"> * LastError (OPTIONAL):</span>
00318 <span class="comment"> * == 0 If LastError is 0, the compiler will optimize away the call to</span>
00319 <span class="comment"> *      UserSetLastError().  The last error will not be set to zero!</span>
00320 <span class="comment"> * != 0 If you want to SetLastError, provide a non-zero value.</span>
00321 <span class="comment"> */</span>
<a name="l00322"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a42">00322</a> <span class="preprocessor">#define MSGERROR(LastError) {        \</span>
00323 <span class="preprocessor">    retval = errret;                 \</span>
00324 <span class="preprocessor">    if (LastError) {                 \</span>
00325 <span class="preprocessor">        UserSetLastError(LastError); \</span>
00326 <span class="preprocessor">    }                                \</span>
00327 <span class="preprocessor">    goto errorexit; }</span>
00328 <span class="preprocessor"></span>
00329 
<a name="l00330"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a43">00330</a> <span class="preprocessor">#define MSGERROR_VOID() { \</span>
00331 <span class="preprocessor">    goto errorexit; }</span>
00332 <span class="preprocessor"></span>
00333 <span class="comment">/*</span>
00334 <span class="comment"> * Same as MSGERROR but jumps to cleanup code instead of straight to the return</span>
00335 <span class="comment"> */</span>
<a name="l00336"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">00336</a> <span class="preprocessor">#define MSGERRORCLEANUP(LastError) { \</span>
00337 <span class="preprocessor">    retval = errret;                 \</span>
00338 <span class="preprocessor">    if (LastError) {                 \</span>
00339 <span class="preprocessor">        UserSetLastError(LastError); \</span>
00340 <span class="preprocessor">    }                                \</span>
00341 <span class="preprocessor">    goto cleanupexit; }</span>
00342 <span class="preprocessor"></span>
<a name="l00343"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">00343</a> <span class="preprocessor">#define StubExceptionHandler(fSetLastError)  W32ExceptionHandler((fSetLastError), RIP_WARNING)</span>
00344 <span class="preprocessor"></span>
<a name="l00345"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a46">00345</a> <span class="preprocessor">#define TESTFLAGS(flags, mask) \</span>
00346 <span class="preprocessor">    if (((flags) &amp; ~(mask)) != 0) { \</span>
00347 <span class="preprocessor">        RIPERR2(ERROR_INVALID_FLAGS, RIP_WARNING, "Invalid flags, %x &amp; ~%x != 0 " #mask, \</span>
00348 <span class="preprocessor">            flags, mask); \</span>
00349 <span class="preprocessor">        MSGERROR(0);   \</span>
00350 <span class="preprocessor">    }</span>
00351 <span class="preprocessor"></span>
<a name="l00352"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a47">00352</a> <span class="preprocessor">#define LIMITVALUE(value, limit, szText) \</span>
00353 <span class="preprocessor">    if ((UINT)(value) &gt; (UINT)(limit)) {     \</span>
00354 <span class="preprocessor">        RIPERR3(ERROR_INVALID_PARAMETER, RIP_WARNING, "Invalid parameter, %d &gt; %d in %s", \</span>
00355 <span class="preprocessor">             value, limit, szText); \</span>
00356 <span class="preprocessor">        MSGERROR(0);     \</span>
00357 <span class="preprocessor">    }</span>
00358 <span class="preprocessor"></span>
<a name="l00359"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a48">00359</a> <span class="preprocessor">#define MESSAGECALL(api) \</span>
00360 <span class="preprocessor">LRESULT NtUserfn ## api( \</span>
00361 <span class="preprocessor">    PWND pwnd,           \</span>
00362 <span class="preprocessor">    UINT msg,            \</span>
00363 <span class="preprocessor">    WPARAM wParam,       \</span>
00364 <span class="preprocessor">    LPARAM lParam,       \</span>
00365 <span class="preprocessor">    ULONG_PTR xParam,     \</span>
00366 <span class="preprocessor">    DWORD xpfnProc,      \</span>
00367 <span class="preprocessor">    BOOL bAnsi)</span>
00368 <span class="preprocessor"></span>
<a name="l00369"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">00369</a> <span class="preprocessor">#define BEGINRECV_MESSAGECALL(err)      \</span>
00370 <span class="preprocessor">    LRESULT retval;                     \</span>
00371 <span class="preprocessor">    LRESULT errret = err;               \</span>
00372 <span class="preprocessor">    PTHREADINFO ptiCurrent = PtiCurrent(); \</span>
00373 <span class="preprocessor">    CheckCritIn();</span>
00374 <span class="preprocessor"></span>
<a name="l00375"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">00375</a> <span class="preprocessor">#define ENDRECV_MESSAGECALL()           \</span>
00376 <span class="preprocessor">    goto errorexit;                     \</span>
00377 <span class="preprocessor">errorexit:                              \</span>
00378 <span class="preprocessor">    return retval;</span>
00379 <span class="preprocessor"></span>
<a name="l00380"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a51">00380</a> <span class="preprocessor">#define BEGINRECV_HOOKCALL()            \</span>
00381 <span class="preprocessor">    LRESULT retval;                     \</span>
00382 <span class="preprocessor">    LRESULT errret = 0;                 \</span>
00383 <span class="preprocessor">    CheckCritIn();</span>
00384 <span class="preprocessor"></span>
<a name="l00385"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a52">00385</a> <span class="preprocessor">#define ENDRECV_HOOKCALL()              \</span>
00386 <span class="preprocessor">    goto errorexit;                     \</span>
00387 <span class="preprocessor">errorexit:                              \</span>
00388 <span class="preprocessor">    return retval;</span>
00389 <span class="preprocessor"></span>
<a name="l00390"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a53">00390</a> <span class="preprocessor">#define CALLPROC(p) FNID(p)</span>
00391 <span class="preprocessor"></span>
00392 <span class="comment">/*</span>
00393 <span class="comment"> * Validation macros</span>
00394 <span class="comment"> */</span>
<a name="l00395"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a54">00395</a> <span class="preprocessor">#define ValidateHWNDNoRIP(p,h)              \</span>
00396 <span class="preprocessor">    if ((p = ValidateHwnd(h)) == NULL)      \</span>
00397 <span class="preprocessor">        MSGERROR(0);</span>
00398 <span class="preprocessor"></span>
<a name="l00399"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a55">00399</a> <span class="preprocessor">#define ValidateHWND(p,h)                   \</span>
00400 <span class="preprocessor">    if ((p = ValidateHwnd(h)) == NULL)      \</span>
00401 <span class="preprocessor">        MSGERROR(0);</span>
00402 <span class="preprocessor"></span>
<a name="l00403"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a56">00403</a> <span class="preprocessor">#define ValidateHWNDND(p,h)                 \</span>
00404 <span class="preprocessor">    if ( ((p = ValidateHwnd(h)) == NULL) || \</span>
00405 <span class="preprocessor">         (p == _GetDesktopWindow()) ||      \</span>
00406 <span class="preprocessor">         (p == _GetMessageWindow())         \</span>
00407 <span class="preprocessor">        )       \</span>
00408 <span class="preprocessor">        MSGERROR(0);</span>
00409 <span class="preprocessor"></span>
<a name="l00410"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a57">00410</a> <span class="preprocessor">#define ValidateHWNDOPT(p,h) \</span>
00411 <span class="preprocessor">    if (h) {                                \</span>
00412 <span class="preprocessor">        if ((p = ValidateHwnd(h)) == NULL)  \</span>
00413 <span class="preprocessor">            MSGERROR(0);                     \</span>
00414 <span class="preprocessor">    } else {                                \</span>
00415 <span class="preprocessor">        p = NULL;                           \</span>
00416 <span class="preprocessor">    }</span>
00417 <span class="preprocessor"></span>
<a name="l00418"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a58">00418</a> <span class="preprocessor">#define ValidateHWNDIA(p,h)                      \</span>
00419 <span class="preprocessor">    if (h != HWND_TOP &amp;&amp;                         \</span>
00420 <span class="preprocessor">        h != HWND_BOTTOM &amp;&amp;                      \</span>
00421 <span class="preprocessor">        h != HWND_TOPMOST &amp;&amp;                     \</span>
00422 <span class="preprocessor">        h != HWND_NOTOPMOST) {                   \</span>
00423 <span class="preprocessor">        if ( ((p = ValidateHwnd(h)) == NULL) ||  \</span>
00424 <span class="preprocessor">             (p == _GetDesktopWindow()) ||       \</span>
00425 <span class="preprocessor">             (p == _GetMessageWindow())          \</span>
00426 <span class="preprocessor">            )        \</span>
00427 <span class="preprocessor">            MSGERROR(0);                          \</span>
00428 <span class="preprocessor">    } else {                                     \</span>
00429 <span class="preprocessor">        p = (PWND)h;                             \</span>
00430 <span class="preprocessor">    }</span>
00431 <span class="preprocessor"></span>
<a name="l00432"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a59">00432</a> <span class="preprocessor">#define ValidateHWNDFF(p,h) \</span>
00433 <span class="preprocessor">    if ((h != (HWND)-1) &amp;&amp; (h !=(HWND)0xffff)) { \</span>
00434 <span class="preprocessor">        if ((p = ValidateHwnd(h)) == NULL)       \</span>
00435 <span class="preprocessor">            MSGERROR(0);                          \</span>
00436 <span class="preprocessor">    } else {                                     \</span>
00437 <span class="preprocessor">        p = PWND_BROADCAST;                      \</span>
00438 <span class="preprocessor">    }</span>
00439 <span class="preprocessor"></span>
<a name="l00440"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a60">00440</a> <span class="preprocessor">#define ValidateHMENUOPT(p,h) \</span>
00441 <span class="preprocessor">    if (h) {                                \</span>
00442 <span class="preprocessor">        if ((p = ValidateHmenu(h)) == NULL) \</span>
00443 <span class="preprocessor">            MSGERROR(0);                     \</span>
00444 <span class="preprocessor">    } else {                                \</span>
00445 <span class="preprocessor">        p = NULL;                           \</span>
00446 <span class="preprocessor">    }</span>
00447 <span class="preprocessor"></span>
<a name="l00448"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a61">00448</a> <span class="preprocessor">#define ValidateHMENU(p,h) \</span>
00449 <span class="preprocessor">    if ((p = ValidateHmenu(h)) == NULL) \</span>
00450 <span class="preprocessor">        MSGERROR(0);</span>
00451 <span class="preprocessor"></span>
<a name="l00452"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a62">00452</a> <span class="preprocessor">#define ValidateHMENUMODIFY(p,h) \</span>
00453 <span class="preprocessor">    if ((p = ValidateHmenu(h)) == NULL)  {          \</span>
00454 <span class="preprocessor">        MSGERROR(0);                                 \</span>
00455 <span class="preprocessor">    } else if (TestMF(p, MFDESKTOP)) { \</span>
00456 <span class="preprocessor">        RIPMSG1(RIP_WARNING, "ValidateHMENUMODIFY: Attempt to modify desktop menu:%#p", p); \</span>
00457 <span class="preprocessor">        MSGERROR(0);                                 \</span>
00458 <span class="preprocessor">    }</span>
00459 <span class="preprocessor"></span>
<a name="l00460"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a63">00460</a> <span class="preprocessor">#define ValidateHACCEL(p,h) \</span>
00461 <span class="preprocessor">    if ((p = HMValidateHandle(h, TYPE_ACCELTABLE)) == NULL) \</span>
00462 <span class="preprocessor">        MSGERROR(0);</span>
00463 <span class="preprocessor"></span>
<a name="l00464"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a64">00464</a> <span class="preprocessor">#define ValidateHCURSOR(p,h) \</span>
00465 <span class="preprocessor">    if ((p = HMValidateHandle(h, TYPE_CURSOR)) == NULL) \</span>
00466 <span class="preprocessor">        MSGERROR(0);</span>
00467 <span class="preprocessor"></span>
<a name="l00468"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a65">00468</a> <span class="preprocessor">#define ValidateHCURSOROPT(p,h) \</span>
00469 <span class="preprocessor">    if (h) {                                 \</span>
00470 <span class="preprocessor">        if ((p = HMValidateHandle(h, TYPE_CURSOR)) == NULL) \</span>
00471 <span class="preprocessor">        MSGERROR(0);                          \</span>
00472 <span class="preprocessor">    } else {                                \</span>
00473 <span class="preprocessor">        p = NULL;                           \</span>
00474 <span class="preprocessor">    }</span>
00475 <span class="preprocessor"></span>
<a name="l00476"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a66">00476</a> <span class="preprocessor">#define ValidateHICON(p,h) \</span>
00477 <span class="preprocessor">    if ((p = HMValidateHandle(h, TYPE_CURSOR)) == NULL) \</span>
00478 <span class="preprocessor">        MSGERROR(0);</span>
00479 <span class="preprocessor"></span>
<a name="l00480"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a67">00480</a> <span class="preprocessor">#define ValidateHHOOK(p,h) \</span>
00481 <span class="preprocessor">    if ((p = HMValidateHandle(h, TYPE_HOOK)) == NULL) \</span>
00482 <span class="preprocessor">        MSGERROR(0);</span>
00483 <span class="preprocessor"></span>
<a name="l00484"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a68">00484</a> <span class="preprocessor">#define ValidateHWINEVENTHOOK(p,h) \</span>
00485 <span class="preprocessor">    if ((p = HMValidateHandle(h, TYPE_WINEVENTHOOK)) == NULL) \</span>
00486 <span class="preprocessor">        MSGERROR(0);</span>
00487 <span class="preprocessor"></span>
<a name="l00488"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a69">00488</a> <span class="preprocessor">#define ValidateHDWP(p,h) \</span>
00489 <span class="preprocessor">    if ((p = HMValidateHandle(h, TYPE_SETWINDOWPOS)) == NULL) \</span>
00490 <span class="preprocessor">        MSGERROR(0);</span>
00491 <span class="preprocessor"></span>
<a name="l00492"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a70">00492</a> <span class="preprocessor">#define ValidateHMONITOR(p,h) \</span>
00493 <span class="preprocessor">    if ((p = ValidateHmonitor(h)) == NULL) \</span>
00494 <span class="preprocessor">        MSGERROR(0);</span>
00495 <span class="preprocessor"></span>
<a name="l00496"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a71">00496</a> <span class="preprocessor">#define ValidateHIMC(p,h) \</span>
00497 <span class="preprocessor">    if ((p = HMValidateHandle((HANDLE)h, TYPE_INPUTCONTEXT)) == NULL) \</span>
00498 <span class="preprocessor">        MSGERROR(0);</span>
00499 <span class="preprocessor"></span>
<a name="l00500"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a72">00500</a> <span class="preprocessor">#define ValidateHIMCOPT(p,h) \</span>
00501 <span class="preprocessor">    if (h) {                                                              \</span>
00502 <span class="preprocessor">        if ((p = HMValidateHandle((HANDLE)h, TYPE_INPUTCONTEXT)) == NULL) \</span>
00503 <span class="preprocessor">            MSGERROR(0);                                                   \</span>
00504 <span class="preprocessor">    } else {                                                              \</span>
00505 <span class="preprocessor">        p = NULL;                                                         \</span>
00506 <span class="preprocessor">    }</span>
00507 <span class="preprocessor"></span>
<a name="l00508"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a73">00508</a> <span class="preprocessor">#define ValidateIMMEnabled()                                                                    \</span>
00509 <span class="preprocessor">    if (!IS_IME_ENABLED()) {                                                                    \</span>
00510 <span class="preprocessor">        RIPERR0(ERROR_CALL_NOT_IMPLEMENTED, RIP_VERBOSE, "IME is disabled in this system.");    \</span>
00511 <span class="preprocessor">        MSGERROR(0); \</span>
00512 <span class="preprocessor">    }</span>
00513 <span class="preprocessor"></span>
<a name="l00514"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a74">00514</a> <span class="preprocessor">#define ValidateIMMEnabledVOID()                                                                \</span>
00515 <span class="preprocessor">    if (!IS_IME_ENABLED()) {                                                                    \</span>
00516 <span class="preprocessor">        RIPERR0(ERROR_CALL_NOT_IMPLEMENTED, RIP_VERBOSE, "IME is disabled in this system.");    \</span>
00517 <span class="preprocessor">        MSGERROR_VOID();                                                                        \</span>
00518 <span class="preprocessor">    }</span>
00519 <span class="preprocessor"></span>
00520 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00521"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a77">00521</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a77">NtUserRemoteConnect</a>(
00522     IN <a class="code" href="../../d3/d8/struct__DOCONNECTDATA.html">PDOCONNECTDATA</a> pDoConnectData,
00523     IN ULONG DisplayDriverNameLength,
00524     IN PWCHAR DisplayDriverName )
00525 {
00526     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a7">BEGINRECVCSRSS</a>(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>, STATUS_UNSUCCESSFUL);
00527     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
00528         errret = STATUS_ACCESS_DENIED;
00529         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
00530     }
00531 
00532     <span class="comment">/*</span>
00533 <span class="comment">     * Probe all read arguments -- no try block.</span>
00534 <span class="comment">     */</span>
00535 <span class="preprocessor">#if DBG</span>
00536 <span class="preprocessor"></span>    <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(DisplayDriverName, DisplayDriverNameLength, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
00537     <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(pDoConnectData, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__DOCONNECTDATA.html">DOCONNECTDATA</a>), <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
00538 <span class="preprocessor">#endif</span>
00539 <span class="preprocessor"></span>
00540     retval = <a class="code" href="../../d4/d1/userk_8h.html#a2085">RemoteConnect</a>(
00541                  pDoConnectData,
00542                  DisplayDriverNameLength,
00543                  DisplayDriverName);
00544 
00545 
00546     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserRemoteConnect"</span>);
00547     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a8">ENDRECVCSRSS</a>();
00548 
00549 }
00550 
00551 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00552"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a78">00552</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a78">NtUserRemoteRedrawRectangle</a>(
00553     IN WORD Left,
00554     IN WORD Top,
00555     IN WORD Right,
00556     IN WORD Bottom )
00557 {
00558     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a7">BEGINRECVCSRSS</a>(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>, STATUS_UNSUCCESSFUL);
00559     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
00560         errret = STATUS_ACCESS_DENIED;
00561         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
00562     }
00563 
00564     retval = <a class="code" href="../../d4/d1/userk_8h.html#a2103">RemoteRedrawRectangle</a>(
00565                  Left,
00566                  Top,
00567                  Right,
00568                  Bottom);
00569 
00570     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserRemoteRedrawRectangle"</span>);
00571     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a8">ENDRECVCSRSS</a>();
00572 }
00573 
00574 
00575 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00576"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a79">00576</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a79">NtUserRemoteRedrawScreen</a>(
00577     VOID)
00578 {
00579     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a7">BEGINRECVCSRSS</a>(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>, STATUS_UNSUCCESSFUL);
00580     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
00581         errret = STATUS_ACCESS_DENIED;
00582         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
00583     }
00584 
00585     <span class="comment">/*</span>
00586 <span class="comment">     * If there are any shadow connections, or it's not disconnected</span>
00587 <span class="comment">     */</span>
00588     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a349">gnShadowers</a> &gt; 0 || <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a350">gbConnected</a>)
00589         retval = <a class="code" href="../../d4/d1/userk_8h.html#a2104">RemoteRedrawScreen</a>();
00590     <span class="keywordflow">else</span>
00591         retval = STATUS_UNSUCCESSFUL;
00592 
00593     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserRemoteRedrawScreen"</span>);
00594     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a8">ENDRECVCSRSS</a>();
00595 }
00596 
00597 
00598 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00599"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a80">00599</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a80">NtUserRemoteStopScreenUpdates</a>(
00600     VOID)
00601 {
00602     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a7">BEGINRECVCSRSS</a>(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>, STATUS_UNSUCCESSFUL);
00603     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
00604         errret = STATUS_ACCESS_DENIED;
00605         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
00606     }
00607 
00608     retval = <a class="code" href="../../d4/d1/userk_8h.html#a2090">xxxRemoteStopScreenUpdates</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00609 
00610     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserRemoteStopScreenUpdates"</span>);
00611     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a8">ENDRECVCSRSS</a>();
00612 }
00613 
00614 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00615"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a81">00615</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a81">NtUserCtxDisplayIOCtl</a>(
00616     IN ULONG  DisplayIOCtlFlags,
00617     IN PUCHAR pDisplayIOCtlData,
00618     IN ULONG  cbDisplayIOCtlData)
00619 {
00620     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a7">BEGINRECVCSRSS</a>(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>, STATUS_UNSUCCESSFUL);
00621     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
00622         errret = STATUS_ACCESS_DENIED;
00623         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
00624     }
00625 
00626     <span class="comment">/*</span>
00627 <span class="comment">     * Probe all read arguments</span>
00628 <span class="comment">     */</span>
00629 <span class="preprocessor">#if DBG</span>
00630 <span class="preprocessor"></span>    <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(pDisplayIOCtlData, cbDisplayIOCtlData, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
00631 <span class="preprocessor">#endif</span>
00632 <span class="preprocessor"></span>
00633     retval = <a class="code" href="../../d4/d1/userk_8h.html#a2100">CtxDisplayIOCtl</a>(
00634                  DisplayIOCtlFlags,
00635                  pDisplayIOCtlData,
00636                  cbDisplayIOCtlData);
00637 
00638     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserCtxDisplayIOCtl"</span>);
00639     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a8">ENDRECVCSRSS</a>();
00640 
00641 }
00642 
<a name="l00643"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a82">00643</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a82">NtUserHardErrorControl</a>(
00644     IN HARDERRORCONTROL dwCmd,
00645     IN HANDLE handle,
00646     OUT PDESKRESTOREDATA pdrdRestore OPTIONAL)
00647 {
00648     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a7">BEGINRECVCSRSS</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, HEC_ERROR);
00649 
00650 <span class="preprocessor">#if DBG</span>
00651 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ARGUMENT_PRESENT(pdrdRestore)) {
00652         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(pdrdRestore, <span class="keyword">sizeof</span>(DESKRESTOREDATA), <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
00653     }
00654 <span class="preprocessor">#endif</span>
00655 <span class="preprocessor"></span>
00656     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1175">xxxHardErrorControl</a>(dwCmd, handle, pdrdRestore);
00657 
00658     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserHardErrorControl"</span>);
00659     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a8">ENDRECVCSRSS</a>();
00660 }
00661 
<a name="l00662"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a83">00662</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a83">NtUserGetObjectInformation</a>(  <span class="comment">// API GetUserObjectInformationA/W</span>
00663     IN HANDLE hObject,
00664     IN <span class="keywordtype">int</span> nIndex,
00665     OUT PVOID pvInfo,
00666     IN DWORD nLength,
00667     OUT OPTIONAL LPDWORD pnLengthNeeded)
00668 {
00669     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwAlign;
00670     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwLocalLength;
00671     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00672 
00673     <span class="comment">/*</span>
00674 <span class="comment">     * Probe arguments</span>
00675 <span class="comment">     */</span>
00676     <span class="keywordflow">try</span> {
00677 <span class="preprocessor">#if defined(_X86_)</span>
00678 <span class="preprocessor"></span>        dwAlign = <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>);
00679 <span class="preprocessor">#else</span>
00680 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (nIndex == UOI_FLAGS)
00681             dwAlign = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
00682         <span class="keywordflow">else</span>
00683             dwAlign = <span class="keyword">sizeof</span>(WCHAR);
00684 <span class="preprocessor">#endif</span>
00685 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(pvInfo, nLength, dwAlign);
00686         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(pnLengthNeeded))
00687             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(pnLengthNeeded);
00688 
00689     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00690         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
00691     }
00692 
00693     <span class="comment">/*</span>
00694 <span class="comment">     * Make sure the handle doesn't get closed while we're playing with it.</span>
00695 <span class="comment">     */</span>
00696     <a class="code" href="../../d4/d1/userk_8h.html#a2071">SetHandleInUse</a>(hObject);
00697 
00698     <span class="comment">/*</span>
00699 <span class="comment">     * pvInfo is client-side.  GetUserObjectInformation</span>
00700 <span class="comment">     * protects use of this pointer with try blocks.</span>
00701 <span class="comment">     */</span>
00702 
00703     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1118">_GetUserObjectInformation</a>(hObject,
00704             nIndex, pvInfo,
00705             nLength, &amp;dwLocalLength);
00706 
00707     <span class="comment">/*</span>
00708 <span class="comment">     * OK, we're done with the handle.</span>
00709 <span class="comment">     */</span>
00710     <a class="code" href="../../d4/d1/userk_8h.html#a2071">SetHandleInUse</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00711 
00712     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(pnLengthNeeded)) {
00713         <span class="keywordflow">try</span> {
00714             *pnLengthNeeded = dwLocalLength;
00715         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00716             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
00717         }
00718     }
00719 
00720     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetObjectInformation"</span>);
00721     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
00722 }
00723 
<a name="l00724"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a84">00724</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a84">NtUserWin32PoolAllocationStats</a>(
00725     IN  LPDWORD parrTags,
00726     IN  SIZE_T  tagsCount,
00727     OUT SIZE_T* lpdwMaxMem,
00728     OUT SIZE_T* lpdwCrtMem,
00729     OUT LPDWORD lpdwMaxAlloc,
00730     OUT LPDWORD lpdwCrtAlloc)
00731 {
00732 <span class="preprocessor">#ifdef POOL_INSTR_API</span>
00733 <span class="preprocessor"></span>    SIZE_T  dwMaxMem, dwCrtMem;
00734     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwMaxAlloc, dwCrtAlloc;
00735 
00736     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00737 
00738     retval = _Win32PoolAllocationStats(parrTags,
00739                                        tagsCount,
00740                                        &amp;dwMaxMem,
00741                                        &amp;dwCrtMem,
00742                                        &amp;dwMaxAlloc,
00743                                        &amp;dwCrtAlloc);
00744     <span class="comment">/*</span>
00745 <span class="comment">     * Probe and copy</span>
00746 <span class="comment">     */</span>
00747     <span class="keywordflow">try</span> {
00748         <span class="keywordflow">if</span> (lpdwMaxMem != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00749             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(lpdwMaxMem, <span class="keyword">sizeof</span>(SIZE_T), <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
00750             *lpdwMaxMem = dwMaxMem;
00751         }
00752         <span class="keywordflow">if</span> (lpdwCrtMem != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00753             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(lpdwCrtMem, <span class="keyword">sizeof</span>(SIZE_T), <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
00754             *lpdwCrtMem = dwCrtMem;
00755         }
00756         <span class="keywordflow">if</span> (lpdwMaxAlloc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00757             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(lpdwMaxAlloc, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>), <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
00758             *lpdwMaxAlloc = dwMaxAlloc;
00759         }
00760         <span class="keywordflow">if</span> (lpdwCrtAlloc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00761             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(lpdwCrtAlloc, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>), <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
00762             *lpdwCrtAlloc = dwCrtAlloc;
00763         }
00764 
00765     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00766         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
00767     }
00768 
00769     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserWin32PoolAllocationStats"</span>);
00770     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
00771 <span class="preprocessor">#else</span>
00772 <span class="preprocessor"></span>    UNREFERENCED_PARAMETER(parrTags);
00773     UNREFERENCED_PARAMETER(tagsCount);
00774     UNREFERENCED_PARAMETER(lpdwMaxMem);
00775     UNREFERENCED_PARAMETER(lpdwCrtMem);
00776     UNREFERENCED_PARAMETER(lpdwMaxAlloc);
00777     UNREFERENCED_PARAMETER(lpdwCrtAlloc);
00778     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00779 <span class="preprocessor">#endif // POOL_INSTR_API</span>
00780 <span class="preprocessor"></span>}
00781 
00782 <span class="preprocessor">#if DBG</span>
00783 <span class="preprocessor"></span>
00784 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> NtUserDbgWin32HeapFail( <span class="comment">// private DbgWin32HeapFail</span>
00785     IN DWORD dwFlags,
00786     IN BOOL  bFail)
00787 {
00788     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a12">BEGINRECV_VOID</a>();
00789 
00790     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> | WHF_VALID) != WHF_VALID) {
00791         RIPMSG1(RIP_WARNING, <span class="stringliteral">"Invalid flags for DbgWin32HeapFail %x"</span>, dwFlags);
00792         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a43">MSGERROR_VOID</a>();
00793     }
00794 
00795     Win32HeapFailAllocations(bFail);
00796 
00797     <a class="code" href="../../d4/d1/userk_8h.html#a94">TRACEVOID</a>(<span class="stringliteral">"NtUserDbgWin32HeapFail"</span>);
00798     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a13">ENDRECV_VOID</a>();
00799 }
00800 
00801 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  NtUserDbgWin32HeapStat( <span class="comment">// private DbgWin32HeapStat</span>
00802     PDBGHEAPSTAT phs,
00803     DWORD dwLen)
00804 {
00805     <span class="keyword">extern</span> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Win32HeapStat(PDBGHEAPSTAT phs, DWORD dwLen, BOOL bTagsAreShift);
00806 
00807     DBGHEAPSTAT localHS[30];
00808     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(DWORD, 0);
00809 
00810     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a47">LIMITVALUE</a>(dwLen, <span class="keyword">sizeof</span>(localHS), <span class="stringliteral">"DbgWin32HeapStat"</span>);
00811 
00812     <span class="keywordflow">try</span>{
00813         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(phs, dwLen, CHARALIGN);
00814         RtlCopyMemory(localHS, phs, dwLen);
00815     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(FALSE)) {
00816         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
00817     }
00818 
00819     retval = Win32HeapStat(localHS, dwLen, FALSE);
00820 
00821     <span class="keywordflow">try</span> {
00822         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(phs, dwLen, CHARALIGN);
00823         RtlCopyMemory(phs, localHS, dwLen);
00824     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(FALSE)) {
00825     }
00826     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserDbgWin32HeapStat"</span>);
00827     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
00828 }
00829 <span class="preprocessor">#endif // DBG</span>
00830 <span class="preprocessor"></span>
<a name="l00831"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a85">00831</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a85">NtUserSetObjectInformation</a>(  <span class="comment">// API SetUserObjectInformationA/W</span>
00832     IN HANDLE hObject,
00833     IN <span class="keywordtype">int</span> nIndex,
00834     IN PVOID pvInfo,
00835     IN DWORD nLength)
00836 {
00837     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00838 
00839     <span class="comment">/*</span>
00840 <span class="comment">     * Probe arguments</span>
00841 <span class="comment">     */</span>
00842     <span class="keywordflow">try</span> {
00843         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(pvInfo, nLength, <a class="code" href="../../d4/d1/userk_8h.html#a22">DATAALIGN</a>);
00844 
00845     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00846         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
00847     }
00848 
00849     <span class="comment">/*</span>
00850 <span class="comment">     * Make sure the handle doesn't get closed while we're playing with it.</span>
00851 <span class="comment">     */</span>
00852     <a class="code" href="../../d4/d1/userk_8h.html#a2071">SetHandleInUse</a>(hObject);
00853 
00854     <span class="comment">/*</span>
00855 <span class="comment">     * pvInfo is client-side.  SetUserObjectInformation</span>
00856 <span class="comment">     * protects use of this pointer with try blocks.</span>
00857 <span class="comment">     */</span>
00858     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1119">_SetUserObjectInformation</a>(hObject,
00859                 nIndex, pvInfo, nLength);
00860 
00861     <span class="comment">/*</span>
00862 <span class="comment">     * OK, we're done with the handle.</span>
00863 <span class="comment">     */</span>
00864     <a class="code" href="../../d4/d1/userk_8h.html#a2071">SetHandleInUse</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00865 
00866     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetObjectInformation"</span>);
00867     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
00868 }
00869 
<a name="l00870"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">00870</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">NtUserConsoleControl</a>(  <span class="comment">// private NtUserConsoleControl</span>
00871     IN CONSOLECONTROL ConsoleCommand,
00872     IN PVOID ConsoleInformation,
00873     IN DWORD ConsoleInformationLength)
00874 {
00875     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a7">BEGINRECVCSRSS</a>(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>, STATUS_UNSUCCESSFUL);
00876 
00877 <span class="preprocessor">#if DBG</span>
00878 <span class="preprocessor"></span>    <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(ConsoleInformation,
00879                   ConsoleInformationLength,
00880                   <span class="keyword">sizeof</span>(WORD));
00881 <span class="preprocessor">#endif</span>
00882 <span class="preprocessor"></span>
00883     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1947">xxxConsoleControl</a>(ConsoleCommand,
00884                                 ConsoleInformation,
00885                                 ConsoleInformationLength);
00886 
00887     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserConsoleControl"</span>);
00888     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a8">ENDRECVCSRSS</a>();
00889 }
00890 
<a name="l00891"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a87">00891</a> HWINSTA <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a87">NtUserCreateWindowStation</a>(  <span class="comment">// API CreateWindowStationA/W</span>
00892     IN POBJECT_ATTRIBUTES pObja,
00893     IN ACCESS_MASK        amRequest,
00894     IN HANDLE             hKbdLayoutFile,
00895     IN DWORD              offTable,
00896     IN PUNICODE_STRING    pstrKLID,
00897     UINT                  uKbdInputLocale)
00898 
00899 {
00900     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00901     OBJECT_ATTRIBUTES           CapturedAttributes;
00902     SECURITY_QUALITY_OF_SERVICE qosCaptured;
00903     PSECURITY_DESCRIPTOR        psdCaptured = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00904     LUID                        luidService;
00905     UNICODE_STRING              strWinSta;
00906     UNICODE_STRING              strKLID;
00907     WCHAR                       awchName[<a class="code" href="../../d8/d9/dllinit_8c.html#a1">MAX_SESSION_PATH</a>];
00908     WCHAR                       awchKF[<span class="keyword">sizeof</span>(((<a class="code" href="../../d4/d9/structtagKL.html">PKL</a>)0)-&gt;spkf-&gt;awchKF)];
00909     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>                        chMax;
00910     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>             OwnershipMode;
00911 
00912     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(HWINSTA, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00913 
00914     <span class="comment">/*</span>
00915 <span class="comment">     * Set status so we can clean up in case of failure</span>
00916 <span class="comment">     */</span>
00917     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00918 
00919     <span class="keywordflow">try</span> {
00920         <span class="comment">/*</span>
00921 <span class="comment">         * Probe and capture the ??? string</span>
00922 <span class="comment">         */</span>
00923         strKLID = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(pstrKLID);
00924         <a class="code" href="../../d4/d1/userk_8h.html#a61">ProbeForReadUnicodeStringBuffer</a>(strKLID);
00925         chMax = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(<span class="keyword">sizeof</span>(awchKF) - <span class="keyword">sizeof</span>(WCHAR), strKLID.Length) / <span class="keyword">sizeof</span>(WCHAR);
00926         <a class="code" href="../../d1/d5/w32_2ntuser_2rtl_2random_8c.html#a3">wcsncpycch</a>(awchKF, strKLID.Buffer, chMax);
00927         awchKF[chMax] = 0;
00928 
00929         <span class="comment">/*</span>
00930 <span class="comment">         * Probe and capture the object attributes</span>
00931 <span class="comment">         */</span>
00932         CapturedAttributes = <a class="code" href="../../d5/d8/ex_8h.html#a27">ProbeAndReadStructure</a>(pObja, OBJECT_ATTRIBUTES);
00933 
00934         <span class="comment">/*</span>
00935 <span class="comment">         * Probe and capture all other components of the object attributes.</span>
00936 <span class="comment">         */</span>
00937         <span class="keywordflow">if</span> (CapturedAttributes.ObjectName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; CapturedAttributes.RootDirectory == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00938 
00939             <span class="comment">/*</span>
00940 <span class="comment">             * Use the logon authentication id to form the windowstation</span>
00941 <span class="comment">             * name.</span>
00942 <span class="comment">             */</span>
00943             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a961">GetProcessLuid</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;luidService);
00944             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00945                 swprintf(awchName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%ws\\Service-0x%x-%x$"</span>,
00946                         <a class="code" href="../../d6/d8/clinit_8c.html#a9">szWindowStationDirectory</a>,
00947                         luidService.HighPart, luidService.LowPart);
00948                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strWinSta, awchName);
00949                 CapturedAttributes.ObjectName = &amp;strWinSta;
00950             }
00951             OwnershipMode = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
00952         } <span class="keywordflow">else</span> {
00953             strWinSta = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(CapturedAttributes.ObjectName);
00954             <a class="code" href="../../d4/d1/userk_8h.html#a61">ProbeForReadUnicodeStringBuffer</a>(strWinSta);
00955             <span class="comment">/*</span>
00956 <span class="comment">             * Use the StaticUnicodeBuffer on the TEB as the buffer for the object name.</span>
00957 <span class="comment">             * Even if this is client side and we pass KernelMode to the Ob call in</span>
00958 <span class="comment">             * _OpenWindowStation this is safe because the TEB is not going to go away</span>
00959 <span class="comment">             * during this call. The worst it can happen is to have the buffer in the TEB</span>
00960 <span class="comment">             * trashed.</span>
00961 <span class="comment">             */</span>
00962             strWinSta.Length = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(strWinSta.Length, STATIC_UNICODE_BUFFER_LENGTH * <span class="keyword">sizeof</span>(WCHAR));
00963 
00964             RtlCopyMemory(NtCurrentTeb()-&gt;StaticUnicodeBuffer,
00965                           strWinSta.Buffer,
00966                           strWinSta.Length);
00967 
00968             strWinSta.Buffer = NtCurrentTeb()-&gt;StaticUnicodeBuffer;
00969             CapturedAttributes.ObjectName = &amp;strWinSta;
00970             OwnershipMode = <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>;
00971         }
00972 
00973         <span class="keywordflow">if</span> (CapturedAttributes.SecurityQualityOfService) {
00974             PSECURITY_QUALITY_OF_SERVICE pqos;
00975 
00976             pqos = CapturedAttributes.SecurityQualityOfService;
00977             qosCaptured = <a class="code" href="../../d5/d8/ex_8h.html#a27">ProbeAndReadStructure</a>(pqos, SECURITY_QUALITY_OF_SERVICE);
00978             CapturedAttributes.SecurityQualityOfService = &amp;qosCaptured;
00979         }
00980 
00981         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp; CapturedAttributes.SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00982             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a1">SeCaptureSecurityDescriptor</a>(
00983                     CapturedAttributes.SecurityDescriptor,
00984                     <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
00985                     <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00986                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00987                     &amp;psdCaptured);
00988             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00989                 psdCaptured = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00990             }
00991             CapturedAttributes.SecurityDescriptor = psdCaptured;
00992         }
00993 
00994     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00995         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00996     }
00997     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00998         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(ERROR_INVALID_PARAMETER);
00999 
01000     <span class="comment">/*</span>
01001 <span class="comment">     * Create the windowstation and return a kernel handle.</span>
01002 <span class="comment">     */</span>
01003     retval = <a class="code" href="../../d8/d8/winsta_8c.html#a3">xxxCreateWindowStation</a>(&amp;CapturedAttributes,
01004                                     OwnershipMode,
01005                                     amRequest,
01006                                     hKbdLayoutFile,
01007                                     offTable,
01008                                     awchKF,
01009                                     uKbdInputLocale);
01010 
01011     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a33">CLEANUPRECV</a>();
01012 
01013     <span class="comment">/*</span>
01014 <span class="comment">     * Release captured security descriptor.</span>
01015 <span class="comment">     */</span>
01016     <span class="keywordflow">if</span> (psdCaptured != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01017         <a class="code" href="../../d2/d5/se_2capture_8c.html#a2">SeReleaseSecurityDescriptor</a>(
01018                 psdCaptured,
01019                 <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
01020                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01021     }
01022 
01023     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserCreateWindowStation"</span>);
01024     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
01025 }
01026 
01027 
<a name="l01028"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a88">01028</a> HWINSTA <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a88">NtUserOpenWindowStation</a>(
01029     IN OUT POBJECT_ATTRIBUTES pObja,
01030     IN ACCESS_MASK amRequest)
01031 {
01032     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01033     LUID                        luidService;
01034     WCHAR                       awchName[<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Service-0x0000-0000$"</span>) / <span class="keyword">sizeof</span>(WCHAR)];
01035     OBJECT_ATTRIBUTES           Obja;
01036     UNICODE_STRING              ObjectName;
01037 
01038     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(HWINSTA, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01039 
01040     retval = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01041 
01042     <span class="comment">/*</span>
01043 <span class="comment">     * NT Bug 387849: We want to allow the caller to pass in a "template" to be </span>
01044 <span class="comment">     * filled in for the Service windowstation.  So, we need to walk through the</span>
01045 <span class="comment">     * pObja structure and check the string out, replacing it with the real</span>
01046 <span class="comment">     * object name if necessary.</span>
01047 <span class="comment">     *</span>
01048 <span class="comment">     * It is VERY important that we pass the pObja object to the executive</span>
01049 <span class="comment">     * (through _OpenWindowStation) and not the Obja object.  This is because we</span>
01050 <span class="comment">     * will request UserMode for this object, and the executive will check that</span>
01051 <span class="comment">     * it is actually getting a user-mode address.</span>
01052 <span class="comment">     *</span>
01053 <span class="comment">     * We will still make a copy of the structures to manipulate while we are </span>
01054 <span class="comment">     * walking everything so that we don't need to worry about the rug being</span>
01055 <span class="comment">     * removed from beneath us.  The executive will do its own checking.</span>
01056 <span class="comment">     */</span>
01057 
01058     <span class="keywordflow">try</span> {
01059         <span class="comment">/*</span>
01060 <span class="comment">         * Probe the object attributes.  We need to be able to read the</span>
01061 <span class="comment">         * OBJECT_ATTRIBUTES and to write the ObjectName (UNICODE_STRING).</span>
01062 <span class="comment">         */</span>
01063         Obja = <a class="code" href="../../d5/d8/ex_8h.html#a27">ProbeAndReadStructure</a>(pObja, OBJECT_ATTRIBUTES);
01064 
01065         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(Obja.ObjectName, <span class="keyword">sizeof</span>(*(Obja.ObjectName)), <a class="code" href="../../d4/d1/userk_8h.html#a22">DATAALIGN</a>);
01066 
01067         ObjectName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(Obja.ObjectName);
01068 
01069         <span class="comment">/*</span>
01070 <span class="comment">         * If we are trying to open the NULL or "" WindowStation, remap this</span>
01071 <span class="comment">         * benign name to Service-0x????-????$.</span>
01072 <span class="comment">         */</span>
01073         <span class="keywordflow">if</span> (Obja.RootDirectory != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
01074                 ObjectName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
01075                 ObjectName.MaximumLength == <span class="keyword">sizeof</span>(awchName) &amp;&amp;
01076                 ObjectName.Length == (<span class="keyword">sizeof</span>(awchName) - <span class="keyword">sizeof</span>(UNICODE_NULL))) {
01077 
01078             <span class="comment">/*</span>
01079 <span class="comment">             * Use the logon authentication id to form the windowstation</span>
01080 <span class="comment">             * name.  Put this in the user's buffer since we were the one</span>
01081 <span class="comment">             * who allocated it in OpenWindowStation.</span>
01082 <span class="comment">             */</span>
01083 
01084             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(ObjectName.Buffer, ObjectName.MaximumLength, <a class="code" href="../../d4/d1/userk_8h.html#a23">CHARALIGN</a>);
01085 
01086             <span class="keywordflow">if</span> (!_wcsicmp(ObjectName.Buffer, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Service-0x0000-0000$"</span>)) {
01087                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a961">GetProcessLuid</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;luidService);
01088                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01089                     swprintf(ObjectName.Buffer,
01090                               <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Service-0x%x-%x$"</span>,
01091                               luidService.HighPart,
01092                               luidService.LowPart);
01093                     <span class="comment">/*</span>
01094 <span class="comment">                     * We need to re-initialize the string to get the counted</span>
01095 <span class="comment">                     * length correct.  Otherwise the hashing function used</span>
01096 <span class="comment">                     * by ObpLookupDirectoryEntry will fail.</span>
01097 <span class="comment">                     */</span>
01098                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(Obja.ObjectName, ObjectName.Buffer);
01099                 }
01100             }
01101         }
01102 
01103     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
01104         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
01105     }
01106 
01107     <span class="comment">/*</span>
01108 <span class="comment">     * Open the WindowStation</span>
01109 <span class="comment">     */</span>
01110     retval = <a class="code" href="../../d8/d8/winsta_8c.html#a8">_OpenWindowStation</a>(pObja, amRequest, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
01111 
01112     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserOpenWindowStation"</span>);
01113     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
01114 
01115     UNREFERENCED_PARAMETER(awchName);
01116 }
01117 
<a name="l01118"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a89">01118</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a89">NtUserCloseWindowStation</a>(
01119     IN HWINSTA hwinsta)
01120 {
01121     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
01122     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01123 
01124     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01125 
01126     retval = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01127 
01128     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/validate_8c.html#a6">ValidateHwinsta</a>(hwinsta, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, 0, &amp;pwinsta);
01129     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01130         retval = <a class="code" href="../../d8/d8/winsta_8c.html#a9">_CloseWindowStation</a>(hwinsta);
01131         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pwinsta);
01132     }
01133 
01134     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserCloseWindowStation"</span>);
01135     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
01136 }
01137 
01138 
<a name="l01139"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a90">01139</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a90">NtUserSetProcessWindowStation</a>(
01140     IN HWINSTA hwinsta)
01141 {
01142     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01143 
01144     retval = <a class="code" href="../../d8/d8/winsta_8c.html#a10">xxxSetProcessWindowStation</a>(hwinsta, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
01145 
01146     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetProcessWindowStation"</span>);
01147     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
01148 }
01149 
<a name="l01150"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a91">01150</a> HWINSTA <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a91">NtUserGetProcessWindowStation</a>(
01151     VOID)
01152 {
01153     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(HWINSTA, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01154 
01155     <a class="code" href="../../d8/d8/winsta_8c.html#a11">_GetProcessWindowStation</a>(&amp;retval);
01156 
01157     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetProcessWindowStation"</span>);
01158     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
01159 }
01160 
<a name="l01161"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a92">01161</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a92">NtUserLockWorkStation</a>(
01162     VOID)
01163 {
01164     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01165 
01166     retval = <a class="code" href="../../d8/d8/winsta_8c.html#a15">_LockWorkStation</a>();
01167 
01168     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserLockWorkStation"</span>);
01169     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
01170 }
01171 
01172 
<a name="l01173"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a93">01173</a> HDESK <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a93">NtUserCreateDesktop</a>(  <span class="comment">// API CreateDesktopA/W</span>
01174     IN POBJECT_ATTRIBUTES pObja,
01175     IN PUNICODE_STRING pstrDevice,
01176     IN LPDEVMODEW pDevmode,
01177     IN DWORD dwFlags,
01178     IN ACCESS_MASK amRequest)
01179 {
01180     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(HDESK, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01181 
01182     <span class="comment">/*</span>
01183 <span class="comment">     * Fail this call for restricted threads</span>
01184 <span class="comment">     */</span>
01185     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a383">IS_CURRENT_THREAD_RESTRICTED</a>(JOB_OBJECT_UILIMIT_DESKTOP)) {
01186         RIPMSG0(RIP_WARNING, <span class="stringliteral">"NtUserCreateDesktop failed for restricted thread"</span>);
01187         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
01188     }
01189 
01190     <span class="comment">/*</span>
01191 <span class="comment">     * Probe arguments</span>
01192 <span class="comment">     */</span>
01193     <span class="keywordflow">try</span> {
01194         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(pObja, <span class="keyword">sizeof</span>(*pObja), <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
01195     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
01196         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
01197     }
01198 
01199     <span class="comment">/*</span>
01200 <span class="comment">     * pObja, pDevmode, and pstrDevice are all client side addresses.</span>
01201 <span class="comment">     *</span>
01202 <span class="comment">     * pstrDevice and pDevmode are put into the Context info,</span>
01203 <span class="comment">     * and they are used in ntgdi\dre\drvsup.cxx,</span>
01204 <span class="comment">     * where thay are captured before use.</span>
01205 <span class="comment"></span>
01206 <span class="comment">     */</span>
01207 
01208     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1795">xxxCreateDesktop</a>(pObja,
01209                               <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
01210                               pstrDevice,
01211                               pDevmode,
01212                               <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>,
01213                               amRequest);
01214 
01215     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserCreateDesktop"</span>);
01216     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
01217 }
01218 
<a name="l01219"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a94">01219</a> HDESK <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a94">NtUserOpenDesktop</a>(
01220     IN POBJECT_ATTRIBUTES pObja,
01221     IN DWORD dwFlags,
01222     IN ACCESS_MASK amRequest)
01223 {
01224     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bShutDown;
01225 
01226     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(HDESK, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01227 
01228     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1796">xxxOpenDesktop</a>(pObja, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>, amRequest, &amp;bShutDown);
01229 
01230     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserOpenDesktop"</span>);
01231     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
01232 }
01233 
01234 
<a name="l01235"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a95">01235</a> HDESK <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a95">NtUserOpenInputDesktop</a>(
01236     IN DWORD dwFlags,
01237     IN BOOL fInherit,
01238     IN DWORD amRequest)
01239 {
01240     HWINSTA        hwinsta;
01241     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
01242     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>       pdesk;
01243     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>       <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01244 
01245     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(HDESK, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01246 
01247     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01248         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(ERROR_OPEN_FAILED);
01249     } <span class="keywordflow">else</span> {
01250         pwinsta = <a class="code" href="../../d8/d8/winsta_8c.html#a11">_GetProcessWindowStation</a>(&amp;hwinsta);
01251         <span class="keywordflow">if</span> (pwinsta == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01252             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(ERROR_ACCESS_DENIED);
01253         }
01254         <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>) {
01255             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(ERROR_INVALID_FUNCTION);
01256         } <span class="keywordflow">else</span> {
01257 
01258             <span class="comment">/*</span>
01259 <span class="comment">             * We should never return the 'Disconnect' desktop to</span>
01260 <span class="comment">             * an app. We should return instead the desktop that we will</span>
01261 <span class="comment">             * restore to from the Disconnect desktop.</span>
01262 <span class="comment">             */</span>
01263             
01264             pdesk = (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a331">gbDesktopLocked</a> ? <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a330">gspdeskShouldBeForeground</a> : <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>);
01265             
01266             <span class="comment">/*</span>
01267 <span class="comment">             * Require read/write access</span>
01268 <span class="comment">             */</span>
01269             amRequest |= DESKTOP_READOBJECTS | DESKTOP_WRITEOBJECTS;
01270 
01271             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a3">ObOpenObjectByPointer</a>(
01272                     pdesk,
01273                     fInherit ? OBJ_INHERIT : 0,
01274                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01275                     amRequest,
01276                     *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>,
01277                     <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
01278                     &amp;retval);
01279             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01280 
01281                 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bShutDown;
01282                 <span class="comment">/*</span>
01283 <span class="comment">                 * Complete the desktop open</span>
01284 <span class="comment">                 */</span>
01285                 <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1797">OpenDesktopCompletion</a>(pdesk, retval,
01286                     <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>, &amp;bShutDown)) {
01287 
01288                     <a class="code" href="../../d4/d1/userk_8h.html#a2073">CloseProtectedHandle</a>(retval);
01289                     retval = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01290                 } <span class="keywordflow">else</span> {
01291                     <a class="code" href="../../d4/d1/userk_8h.html#a2069">SetHandleFlag</a>(retval, <a class="code" href="../../d4/d1/userk_8h.html#a747">HF_PROTECTED</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01292                 }
01293             } <span class="keywordflow">else</span>
01294                 retval = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01295         }
01296     }
01297 
01298     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserOpenInputDesktop"</span>);
01299     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
01300 }
01301 
01302 
<a name="l01303"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a96">01303</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a96">NtUserResolveDesktopForWOW</a> (  <span class="comment">// WOW ResolveDesktopForWOW</span>
01304     IN OUT PUNICODE_STRING pstrDesktop)
01305 {
01306     UNICODE_STRING strDesktop, strDesktop2;
01307     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
01308     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlBuffer;
01309     LPWSTR lpBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01310     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fFreeBuffer = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01311     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>, STATUS_UNSUCCESSFUL);
01312 
01313     retval = STATUS_SUCCESS;
01314 
01315     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01316     <span class="comment">/*</span>
01317 <span class="comment">     * Probe arguments</span>
01318 <span class="comment">     */</span>
01319     <span class="keywordflow">try</span> {
01320         strDesktop = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(pstrDesktop);
01321         <a class="code" href="../../d4/d1/userk_8h.html#a62">ProbeForReadUnicodeStringFullBuffer</a>(strDesktop);
01322         RtlCopyMemory(&amp;strDesktop2, &amp;strDesktop, <span class="keyword">sizeof</span> strDesktop);
01323         <span class="keywordflow">if</span> (strDesktop.MaximumLength &gt; 0) {
01324             PWSTR pszCapture = strDesktop.Buffer;
01325             strDesktop.Buffer = UserAllocPoolWithQuota(strDesktop.MaximumLength, TAG_TEXT2);
01326             <span class="keywordflow">if</span> (strDesktop.Buffer) {
01327                 fFreeBuffer = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01328                 <a class="code" href="../../d4/d1/userk_8h.html#a137">ThreadLockPool</a>(ptiCurrent, strDesktop.Buffer, &amp;tlBuffer);
01329                 RtlCopyMemory(strDesktop.Buffer, pszCapture, strDesktop.Length);
01330             } <span class="keywordflow">else</span>
01331                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_NO_MEMORY);
01332 
01333         } <span class="keywordflow">else</span> {
01334             strDesktop.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01335         }
01336     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
01337         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
01338     }
01339 
01340     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1280">xxxResolveDesktopForWOW</a>(&amp;strDesktop);
01341 
01342     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(retval)) {
01343         <span class="keywordflow">try</span> {
01344             <span class="comment">/*</span>
01345 <span class="comment">             * The string structure at pstrDesktop could have changed</span>
01346 <span class="comment">             * so we will ignore it and drop the one we have already</span>
01347 <span class="comment">             * probed down on top of it.  We have already performed the</span>
01348 <span class="comment">             * ResolveDesktopForWOW action, so we should not return an</span>
01349 <span class="comment">             * error if this copy fails.</span>
01350 <span class="comment">             */</span>
01351 
01352             <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>(&amp;strDesktop2, &amp;strDesktop);
01353             RtlCopyMemory(pstrDesktop, &amp;strDesktop2, <span class="keyword">sizeof</span> strDesktop2);
01354         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
01355         }
01356     }
01357 
01358 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a33">CLEANUPRECV</a>();
01359     <span class="keywordflow">if</span> (fFreeBuffer)
01360         <a class="code" href="../../d4/d1/userk_8h.html#a139">ThreadUnlockAndFreePool</a>(ptiCurrent, &amp;tlBuffer);
01361     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserResolveDesktopForWOW"</span>);
01362     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
01363 }
01364 
<a name="l01365"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a97">01365</a> HDESK <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a97">NtUserResolveDesktop</a>(
01366     IN HANDLE hProcess,
01367     IN PUNICODE_STRING pstrDesktop,
01368     IN BOOL fInherit,
01369     OUT HWINSTA *phwinsta)
01370 {
01371     UNICODE_STRING strDesktop;
01372     HWINSTA hwinsta = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01373     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
01374     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlBuffer;
01375     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fFreeBuffer = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01376     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bShutDown = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01377 
01378     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(HDESK, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01379 
01380     pti = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01381     <span class="comment">/*</span>
01382 <span class="comment">     * Probe and capture desktop path</span>
01383 <span class="comment">     */</span>
01384     <span class="keywordflow">try</span> {
01385         strDesktop = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(pstrDesktop);
01386         <span class="keywordflow">if</span> (strDesktop.Length &gt; 0) {
01387             PWSTR pszCapture = strDesktop.Buffer;
01388             <a class="code" href="../../d4/d1/userk_8h.html#a61">ProbeForReadUnicodeStringBuffer</a>(strDesktop);
01389             strDesktop.Buffer = UserAllocPoolWithQuota(strDesktop.Length, TAG_TEXT2);
01390             <span class="keywordflow">if</span> (strDesktop.Buffer) {
01391                 fFreeBuffer = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01392                 <a class="code" href="../../d4/d1/userk_8h.html#a137">ThreadLockPool</a>(pti, strDesktop.Buffer, &amp;tlBuffer);
01393                 RtlCopyMemory(strDesktop.Buffer, pszCapture, strDesktop.Length);
01394             } <span class="keywordflow">else</span>
01395                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_NO_MEMORY);
01396         } <span class="keywordflow">else</span> {
01397             strDesktop.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01398         }
01399     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
01400         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
01401     }
01402 
01403     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1279">xxxResolveDesktop</a>(hProcess, &amp;strDesktop, &amp;hwinsta,
01404             fInherit, &amp;bShutDown);
01405 
01406     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a33">CLEANUPRECV</a>();
01407     <span class="keywordflow">if</span> (fFreeBuffer)
01408         <a class="code" href="../../d4/d1/userk_8h.html#a139">ThreadUnlockAndFreePool</a>(pti, &amp;tlBuffer);
01409 
01410     <span class="keywordflow">try</span> {
01411         <a class="code" href="../../d5/d8/ex_8h.html#a49">ProbeAndWriteHandle</a>((PHANDLE)phwinsta, hwinsta);
01412     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
01413         <a class="code" href="../../d4/d1/userk_8h.html#a1803">xxxCloseDesktop</a>(retval, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>);
01414         <span class="keywordflow">if</span> (hwinsta)
01415             <a class="code" href="../../d8/d8/winsta_8c.html#a9">_CloseWindowStation</a>(hwinsta);
01416         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
01417     }
01418 
01419     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserResolveDesktop"</span>);
01420     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
01421 }
01422 
<a name="l01423"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a98">01423</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a98">NtUserCloseDesktop</a>(
01424     IN HDESK hdesk)
01425 {
01426     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01427 
01428     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1803">xxxCloseDesktop</a>(hdesk, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
01429 
01430     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserCloseDesktop"</span>);
01431     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
01432 }
01433 
<a name="l01434"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a99">01434</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a99">NtUserSetThreadDesktop</a>(
01435     IN HDESK hdesk)
01436 {
01437     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01438     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01439 
01440     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01441     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/validate_8c.html#a7">ValidateHdesk</a>(hdesk, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, 0, &amp;pdesk);
01442     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01443         retval = <a class="code" href="../../d4/d1/userk_8h.html#a1801">xxxSetThreadDesktop</a>(hdesk, pdesk);
01444         <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdesk, LD_DEREF_VALIDATE_HDESK1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
01445         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pdesk);
01446     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hdesk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>) {
01447         retval = <a class="code" href="../../d4/d1/userk_8h.html#a1801">xxxSetThreadDesktop</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01448     } <span class="keywordflow">else</span>
01449         retval = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01450 
01451     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetThreadDesktop"</span>);
01452     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
01453 }
01454 
<a name="l01455"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a100">01455</a> HDESK <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a100">NtUserGetThreadDesktop</a>(
01456     IN DWORD dwThreadId,
01457     IN HDESK hdeskConsole)
01458 {
01459     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(HDESK, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01460 
01461     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1802">xxxGetThreadDesktop</a>(dwThreadId, hdeskConsole, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
01462 
01463     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetThreadDesktop"</span>);
01464     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
01465 }
01466 
<a name="l01467"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a101">01467</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a101">NtUserSwitchDesktop</a>(
01468     IN HDESK hdesk)
01469 {
01470     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk;
01471     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpdesk;
01472     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
01473     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01474 
01475     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01476 
01477     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01478 
01479     <span class="comment">/*</span>
01480 <span class="comment">     * Fail this call for restricted threads</span>
01481 <span class="comment">     */</span>
01482     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a383">IS_CURRENT_THREAD_RESTRICTED</a>(JOB_OBJECT_UILIMIT_DESKTOP)) {
01483         RIPMSG0(RIP_WARNING, <span class="stringliteral">"NtUserSwitchDesktop failed for restricted thread"</span>);
01484         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
01485     }
01486 
01487     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/validate_8c.html#a7">ValidateHdesk</a>(hdesk, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, DESKTOP_SWITCHDESKTOP, &amp;pdesk);
01488     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01489         <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>) {
01490             <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdesk, LD_DEREF_VALIDATE_HDESK2, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
01491             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pdesk);
01492             RIPERR0(ERROR_ACCESS_DENIED, RIP_VERBOSE, <span class="stringliteral">""</span>);
01493             retval = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01494         } <span class="keywordflow">else</span> {
01495             <a class="code" href="../../d4/d1/userk_8h.html#a128">ThreadLockDesktop</a>(ptiCurrent, pdesk, &amp;tlpdesk, LDLT_FN_NTUSERSWITCHDESKTOP);
01496             <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdesk, LD_DEREF_VALIDATE_HDESK3, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
01497             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pdesk);
01498             retval = <a class="code" href="../../d4/d1/userk_8h.html#a1798">xxxSwitchDesktop</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pdesk, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01499             <a class="code" href="../../d4/d1/userk_8h.html#a130">ThreadUnlockDesktop</a>(ptiCurrent, &amp;tlpdesk, LDUT_FN_NTUSERSWITCHDESKTOP);
01500         }
01501     } <span class="keywordflow">else</span>
01502         retval = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01503 
01504     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSwitchDesktop"</span>);
01505     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
01506 }
01507 
<a name="l01508"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a102">01508</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a102">NtUserInitializeClientPfnArrays</a>(  <span class="comment">// private</span>
01509     IN CONST <a class="code" href="../../d0/d5/struct__PFNCLIENT.html">PFNCLIENT</a> *ppfnClientA OPTIONAL,
01510     IN CONST <a class="code" href="../../d0/d5/struct__PFNCLIENT.html">PFNCLIENT</a> *ppfnClientW OPTIONAL,
01511     IN CONST <a class="code" href="../../d1/d5/struct__PFNCLIENTWORKER.html">PFNCLIENTWORKER</a> *ppfnClientWorker OPTIONAL,
01512     IN HANDLE hModUser)
01513 {
01514     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>, STATUS_UNSUCCESSFUL);
01515 
01516     <span class="comment">/*</span>
01517 <span class="comment">     * Probe all read arguments</span>
01518 <span class="comment">     */</span>
01519     <span class="keywordflow">try</span> {
01520         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ppfnClientA)) {
01521             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(ppfnClientA, <span class="keyword">sizeof</span>(*ppfnClientA), <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
01522         }
01523         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ppfnClientW)) {
01524             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(ppfnClientW, <span class="keyword">sizeof</span>(*ppfnClientW), <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
01525         }
01526 
01527         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ppfnClientWorker)) {
01528             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(ppfnClientWorker, <span class="keyword">sizeof</span>(*ppfnClientWorker), <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
01529         }
01530 
01531         retval = <a class="code" href="../../d4/d1/userk_8h.html#a1014">InitializeClientPfnArrays</a>(
01532                 ppfnClientA, ppfnClientW, ppfnClientWorker, hModUser);
01533     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
01534         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
01535     }
01536 
01537     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserInitializeThreadInfo"</span>);
01538     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
01539 }
01540 
<a name="l01541"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a103">01541</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a103">NtUserWaitForMsgAndEvent</a>(
01542     IN HANDLE hevent)
01543 {
01544     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01545 
01546     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1556">xxxSleepTask</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, hevent);
01547 
01548     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserWaitForMsgAndEvent"</span>);
01549     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
01550 }
01551 
<a name="l01552"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a104">01552</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a104">NtUserDragObject</a>(
01553     IN HWND hwndParent,
01554     IN HWND hwndFrom,
01555     IN UINT wFmt,
01556     IN ULONG_PTR dwData,
01557     IN HCURSOR hcur)
01558 {
01559 
01560     <span class="comment">//</span>
01561     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
01562     <span class="comment">//      enabled. These operations are performed in the User server API</span>
01563     <span class="comment">//      dispatcher.</span>
01564     <span class="comment">//</span>
01565 
01566     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndFrom;
01567     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcur;
01568     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndFrom;
01569     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpcur;
01570 
01571     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, 0, hwndParent);
01572 
01573     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a57">ValidateHWNDOPT</a>(pwndFrom, hwndFrom);
01574     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a65">ValidateHCURSOROPT</a>(pcur, hcur);
01575 
01576     <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwndFrom, &amp;tlpwndFrom);
01577     <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pcur, &amp;tlpcur);
01578 
01579     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1311">xxxDragObject</a>(
01580             pwnd,
01581             pwndFrom,
01582             wFmt,
01583             dwData,
01584             pcur);
01585 
01586     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpcur);
01587     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndFrom);
01588 
01589     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserDragObject"</span>);
01590     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
01591 }
01592 
<a name="l01593"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a105">01593</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a105">NtUserGetIconInfo</a>(  <span class="comment">// API GetIconInfo</span>
01594     IN  HICON hIcon,
01595     OUT PICONINFO piconinfo,
01596     IN OUT OPTIONAL PUNICODE_STRING pstrInstanceName,
01597     IN OUT OPTIONAL PUNICODE_STRING pstrResName,
01598     OUT LPDWORD pbpp,
01599     IN  BOOL fInternal)
01600 {
01601     <a class="code" href="../../d1/d0/inc_2user_8h.html#a529">PICON</a> pIcon;
01602     UNICODE_STRING strInstanceName, *pstrInstanceLocal;
01603     UNICODE_STRING strResName, *pstrResLocal;
01604 
01605     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01606 
01607     <span class="comment">/*</span>
01608 <span class="comment">     * NOTE -- this can't be _SHARED since it calls Gre code with system HDC's.</span>
01609 <span class="comment">     */</span>
01610 
01611     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a64">ValidateHCURSOR</a>(pIcon, hIcon);
01612 
01613     <span class="comment">/*</span>
01614 <span class="comment">     * Probe arguments</span>
01615 <span class="comment">     */</span>
01616     <span class="keywordflow">try</span> {
01617         <span class="keywordflow">if</span> (pstrInstanceName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01618             strInstanceName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(pstrInstanceName);
01619             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(strInstanceName.Buffer, strInstanceName.MaximumLength, <a class="code" href="../../d4/d1/userk_8h.html#a23">CHARALIGN</a>);
01620             pstrInstanceLocal = &amp;strInstanceName;
01621         } <span class="keywordflow">else</span> {
01622             pstrInstanceLocal = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01623         }
01624 
01625         <span class="keywordflow">if</span> (pstrResName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01626             strResName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(pstrResName);
01627             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(strResName.Buffer, strResName.MaximumLength, <a class="code" href="../../d4/d1/userk_8h.html#a23">CHARALIGN</a>);
01628             pstrResLocal = &amp;strResName;
01629         } <span class="keywordflow">else</span> {
01630             pstrResLocal = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01631         }
01632 
01633         <span class="keywordflow">if</span> (pbpp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01634             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(pbpp, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>), <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
01635         }
01636         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(piconinfo, <span class="keyword">sizeof</span>(*piconinfo), <a class="code" href="../../d4/d1/userk_8h.html#a22">DATAALIGN</a>);
01637     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
01638         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
01639     }
01640 
01641     <span class="comment">/*</span>
01642 <span class="comment">     * All use of client-side pointers in InternalGetIconInfo</span>
01643 <span class="comment">     * is protected by try/except.</span>
01644 <span class="comment">     */</span>
01645 
01646     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1112">_InternalGetIconInfo</a>(
01647             pIcon,
01648             piconinfo,
01649             pstrInstanceLocal,
01650             pstrResLocal,
01651             pbpp,
01652             fInternal);
01653 
01654     <span class="keywordflow">try</span> {
01655         <span class="keywordflow">if</span> (pstrInstanceName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01656             RtlCopyMemory(pstrInstanceName, pstrInstanceLocal, <span class="keyword">sizeof</span>(UNICODE_STRING));
01657         }
01658         <span class="keywordflow">if</span> (pstrResName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01659             RtlCopyMemory(pstrResName, pstrResLocal, <span class="keyword">sizeof</span>(UNICODE_STRING));
01660         }
01661     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
01662         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
01663     }
01664 
01665     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetIconInfo"</span>);
01666     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
01667 }
01668 
<a name="l01669"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a106">01669</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a106">NtUserGetIconSize</a>(  <span class="comment">// private</span>
01670     IN HICON hIcon,
01671     IN UINT istepIfAniCur,
01672     OUT <span class="keywordtype">int</span> *pcx,
01673     OUT <span class="keywordtype">int</span> *pcy)
01674 {
01675     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> picon;
01676 
01677     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01678 
01679     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a66">ValidateHICON</a>(picon, hIcon);
01680 
01681     <span class="keywordflow">if</span> (picon-&gt;CURSORF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a537">CURSORF_ACON</a>) {
01682         <a class="code" href="../../d1/d8/structtagACON.html">PACON</a> <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a> = (<a class="code" href="../../d1/d8/structtagACON.html">PACON</a>)picon;
01683         <span class="keywordflow">if</span> (istepIfAniCur &lt; (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)<a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;cpcur) {
01684             picon = <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;aspcur[<a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;aicur[istepIfAniCur]];
01685         } <span class="keywordflow">else</span> {
01686             RIPMSG2(RIP_WARNING, <span class="stringliteral">"NtUserGetIconSize: Invalid istepIfAniCur:%#lx. picon:%#p"</span>,
01687                     istepIfAniCur, picon);
01688             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
01689         }
01690     }
01691 
01692     <span class="comment">/*</span>
01693 <span class="comment">     * Probe arguments</span>
01694 <span class="comment">     */</span>
01695     <span class="keywordflow">try</span> {
01696         <a class="code" href="../../d5/d8/ex_8h.html#a50">ProbeAndWriteLong</a>(pcx, picon-&gt;cx);
01697         <a class="code" href="../../d5/d8/ex_8h.html#a50">ProbeAndWriteLong</a>(pcy, picon-&gt;cy);
01698 
01699         retval = 1;
01700     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
01701         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
01702     }
01703 
01704     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetIconSize"</span>);
01705     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
01706 }
01707 
01708 
01709 
<a name="l01710"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a107">01710</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a107">NtUserDrawIconEx</a>(  <span class="comment">// API DrawIconEx</span>
01711     IN HDC hdc,
01712     IN <span class="keywordtype">int</span> x,
01713     IN <span class="keywordtype">int</span> y,
01714     IN HICON hicon,
01715     IN <span class="keywordtype">int</span> cx,
01716     IN <span class="keywordtype">int</span> cy,
01717     IN UINT istepIfAniCur,
01718     IN HBRUSH hbrush,
01719     IN UINT diFlags,
01720     IN BOOL fMeta,
01721     OUT <a class="code" href="../../d9/d8/struct__DRAWICONEXDATA.html">DRAWICONEXDATA</a> *pdid)
01722 {
01723     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> picon;
01724 
01725     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01726 
01727     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a66">ValidateHICON</a>(picon, hicon);
01728 
01729     <span class="keywordflow">if</span> (fMeta) {
01730         <span class="keywordflow">if</span> (picon-&gt;CURSORF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a537">CURSORF_ACON</a>)
01731             picon = ((<a class="code" href="../../d1/d8/structtagACON.html">PACON</a>)picon)-&gt;aspcur[((<a class="code" href="../../d1/d8/structtagACON.html">PACON</a>)picon)-&gt;aicur[0]];
01732 
01733         <span class="comment">/*</span>
01734 <span class="comment">         * Probe arguments</span>
01735 <span class="comment">         */</span>
01736         <span class="keywordflow">try</span> {
01737             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(pdid, <span class="keyword">sizeof</span>(*pdid), <a class="code" href="../../d4/d1/userk_8h.html#a22">DATAALIGN</a>);
01738 
01739             pdid-&gt;hbmMask  = picon-&gt;hbmMask;
01740             pdid-&gt;hbmColor = picon-&gt;hbmColor;
01741 
01742             pdid-&gt;cx = cx ? cx : picon-&gt;cx ;
01743             pdid-&gt;cy = <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> ? <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> : picon-&gt;cy ;
01744 
01745             retval = 1;
01746         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
01747             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
01748         }
01749 
01750     } <span class="keywordflow">else</span> {
01751         retval = <a class="code" href="../../d0/d9/wmicon_8c.html#a4">_DrawIconEx</a>(hdc, x, y, picon,
01752                             cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
01753                             istepIfAniCur, hbrush,
01754                             diFlags );
01755     }
01756 
01757     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserDrawIconEx"</span>);
01758     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
01759 }
01760 
<a name="l01761"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a108">01761</a> HANDLE <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a108">NtUserDeferWindowPos</a>(
01762     IN HDWP hWinPosInfo,
01763     IN HWND hwnd,
01764     IN HWND hwndInsertAfter,
01765     IN <span class="keywordtype">int</span> x,
01766     IN <span class="keywordtype">int</span> y,
01767     IN <span class="keywordtype">int</span> cx,
01768     IN <span class="keywordtype">int</span> cy,
01769     IN UINT wFlags)
01770 {
01771     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
01772     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndInsertAfter;
01773     <a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a> psmwp;
01774 
01775     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(HANDLE, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01776 
01777     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a46">TESTFLAGS</a>(wFlags, SWP_VALID);
01778 
01779     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a56">ValidateHWNDND</a>(pwnd, hwnd);
01780     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a58">ValidateHWNDIA</a>(pwndInsertAfter, hwndInsertAfter);
01781     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a69">ValidateHDWP</a>(psmwp, hWinPosInfo);
01782 
01783     <span class="keywordflow">if</span> (wFlags &amp; ~(SWP_NOSIZE | SWP_NOMOVE | SWP_NOZORDER |
01784             SWP_NOREDRAW | SWP_NOACTIVATE | SWP_FRAMECHANGED |
01785             SWP_SHOWWINDOW | SWP_HIDEWINDOW | SWP_NOCOPYBITS |
01786             SWP_NOOWNERZORDER)) {
01787         RIPERR1(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"Invalid flags (0x%lx) passed to DeferWindowPos"</span>,
01788                 wFlags);
01789         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
01790     }
01791 
01792     <span class="comment">/*</span>
01793 <span class="comment">     * Make sure the window coordinates can fit in WORDs.</span>
01794 <span class="comment">     */</span>
01795     <span class="keywordflow">if</span> (!(wFlags &amp; SWP_NOMOVE)) {
01796         <span class="keywordflow">if</span> (x &gt; SHRT_MAX) {
01797             x = SHRT_MAX;
01798         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (x &lt; SHRT_MIN) {
01799             x = SHRT_MIN;
01800         }
01801         <span class="keywordflow">if</span> (y &gt; SHRT_MAX) {
01802             y = SHRT_MAX;
01803         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (y &lt; SHRT_MIN) {
01804             y = SHRT_MIN;
01805         }
01806     }
01807 
01808     <span class="comment">/*</span>
01809 <span class="comment">     * Actually, if we were going to be really strict about this we'd</span>
01810 <span class="comment">     * make sure that x + cx &lt; SHRT_MAX, etc but since we do maintain</span>
01811 <span class="comment">     * signed 32-bit coords internally this case doesn't cause a problem.</span>
01812 <span class="comment">     */</span>
01813     <span class="keywordflow">if</span> (!(wFlags &amp; SWP_NOSIZE)) {
01814         <span class="keywordflow">if</span> (cx &lt; 0) {
01815             cx = 0;
01816         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cx &gt; SHRT_MAX) {
01817             cx = SHRT_MAX;
01818         }
01819         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> &lt; 0) {
01820             <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = 0;
01821         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> &gt; SHRT_MAX) {
01822             <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = SHRT_MAX;
01823         }
01824     }
01825 
01826 <span class="preprocessor">#ifdef NEVER</span>
01827 <span class="preprocessor"></span><span class="comment">//</span>
01828 <span class="comment">// do not fail these conditions because real apps use them.</span>
01829 <span class="comment">//</span>
01830     <span class="keywordflow">if</span> (!(wFlags &amp; SWP_NOMOVE) &amp;&amp;
01831             (x &gt; SHRT_MAX || x &lt; SHRT_MIN ||
01832              y &gt; SHRT_MAX || y &lt; SHRT_MIN)) {
01833         RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"Invalid coordinate passed to SetWindowPos"</span>);
01834         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
01835     }
01836 
01837     <span class="comment">/*</span>
01838 <span class="comment">     * Actually, if we were going to be really strict about this we'd</span>
01839 <span class="comment">     * make sure that x + cx &lt; SHRT_MAX, etc but since we do maintain</span>
01840 <span class="comment">     * signed 32-bit coords internally this case doesn't cause a problem.</span>
01841 <span class="comment">     */</span>
01842     <span class="keywordflow">if</span> (!(wFlags &amp; SWP_NOSIZE) &amp;&amp;
01843             (cx &lt; 0 || cx &gt; SHRT_MAX ||
01844              cy &lt; 0 || cy &gt; SHRT_MAX)) {
01845         RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"Invalid width/height passed to SetWindowPos"</span>);
01846         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
01847     }
01848 <span class="preprocessor">#endif</span>
01849 <span class="preprocessor"></span>
01850     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1619">_DeferWindowPos</a>(
01851             psmwp,
01852             pwnd,
01853             pwndInsertAfter,
01854             x,
01855             y,
01856             cx,
01857             <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
01858             wFlags);
01859     retval = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>((PVOID)retval);
01860 
01861     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserDeferWindowPos"</span>);
01862     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
01863 }
01864 
<a name="l01865"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a109">01865</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a109">NtUserEndDeferWindowPosEx</a>(
01866     IN HDWP hWinPosInfo,
01867     IN BOOL fAsync)
01868 {
01869     <a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a> psmwp;
01870     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpsmp;
01871 
01872     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01873 
01874     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a69">ValidateHDWP</a>(psmwp, hWinPosInfo);
01875 
01876     <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(psmwp, &amp;tlpsmp);
01877 
01878     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1620">xxxEndDeferWindowPosEx</a>(
01879             psmwp,
01880             fAsync);
01881 
01882     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpsmp);
01883 
01884     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserEndDeferWindowPosEx"</span>);
01885     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
01886 }
01887 
<a name="l01888"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a110">01888</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a110">NtUserGetMessage</a>(  <span class="comment">// API GetMessageA/W</span>
01889     OUT LPMSG pmsg,
01890     IN HWND hwnd,
01891     IN UINT wMsgFilterMin,
01892     IN UINT wMsgFilterMax)
01893 {
01894     MSG <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
01895 
01896     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01897 
01898     retval = <a class="code" href="../../d4/d1/userk_8h.html#a577">xxxGetMessage</a>(
01899             &amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
01900             hwnd,
01901             wMsgFilterMin,
01902             wMsgFilterMax);
01903 
01904     <span class="comment">/*</span>
01905 <span class="comment">     * Probe arguments</span>
01906 <span class="comment">     */</span>
01907     <span class="keywordflow">try</span> {
01908         <a class="code" href="../../d5/d8/ex_8h.html#a54">ProbeAndWriteStructure</a>(pmsg, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, MSG);
01909     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
01910         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
01911     }
01912 
01913     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetMessage"</span>);
01914     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
01915 }
01916 
<a name="l01917"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a111">01917</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a111">NtUserMoveWindow</a>(
01918     IN HWND hwnd,
01919     IN <span class="keywordtype">int</span> x,
01920     IN <span class="keywordtype">int</span> y,
01921     IN <span class="keywordtype">int</span> cx,
01922     IN <span class="keywordtype">int</span> cy,
01923     IN BOOL fRepaint)
01924 {
01925     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a26">BEGINRECV_HWNDLOCK_ND</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, hwnd);
01926 
01927     <span class="comment">/*</span>
01928 <span class="comment">     * Make sure the window coordinates can fit in WORDs.</span>
01929 <span class="comment">     */</span>
01930     <span class="keywordflow">if</span> (x &gt; SHRT_MAX) {
01931         x = SHRT_MAX;
01932     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (x &lt; SHRT_MIN) {
01933         x = SHRT_MIN;
01934     }
01935     <span class="keywordflow">if</span> (y &gt; SHRT_MAX) {
01936         y = SHRT_MAX;
01937     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (y &lt; SHRT_MIN) {
01938         y = SHRT_MIN;
01939     }
01940 
01941     <span class="comment">/*</span>
01942 <span class="comment">     * Actually, if we were going to be really strict about this we'd</span>
01943 <span class="comment">     * make sure that x + cx &lt; SHRT_MAX, etc but since we do maintain</span>
01944 <span class="comment">     * signed 32-bit coords internally this case doesn't cause a problem.</span>
01945 <span class="comment">     */</span>
01946     <span class="keywordflow">if</span> (cx &lt; 0) {
01947         cx = 0;
01948     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cx &gt; SHRT_MAX) {
01949         cx = SHRT_MAX;
01950     }
01951     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> &lt; 0) {
01952         <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = 0;
01953     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> &gt; SHRT_MAX) {
01954         <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = SHRT_MAX;
01955     }
01956 
01957 <span class="preprocessor">#ifdef NEVER</span>
01958 <span class="preprocessor"></span><span class="comment">//</span>
01959 <span class="comment">// do not fail these conditions because real apps use them.</span>
01960 <span class="comment">//</span>
01961     <span class="keywordflow">if</span> (x &gt; SHRT_MAX || x &lt; SHRT_MIN ||
01962             y &gt; SHRT_MAX || y &lt; SHRT_MIN) {
01963         RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"Invalid coordinate passed to MoveWindow"</span>);
01964         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
01965     }
01966 
01967     <span class="comment">/*</span>
01968 <span class="comment">     * Actually, if we were going to be really strict about this we'd</span>
01969 <span class="comment">     * make sure that x + cx &lt; SHRT_MAX, etc but since we do maintain</span>
01970 <span class="comment">     * signed 32-bit coords internally this case doesn't cause a problem.</span>
01971 <span class="comment">     */</span>
01972     <span class="keywordflow">if</span> (cx &lt; 0 || cx &gt; SHRT_MAX ||
01973             cy &lt; 0 || cy &gt; SHRT_MAX) {
01974         RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"Invalid width/height passed to MoveWindow"</span>);
01975         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
01976     }
01977 <span class="preprocessor">#endif</span>
01978 <span class="preprocessor"></span>
01979     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1621">xxxMoveWindow</a>(
01980             pwndND,
01981             x,
01982             y,
01983             cx,
01984             <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
01985             fRepaint);
01986 
01987     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserMoveWindow"</span>);
01988     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a27">ENDRECV_HWNDLOCK_ND</a>();
01989 }
01990 
<a name="l01991"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a112">01991</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a112">NtUserTranslateAccelerator</a>(  <span class="comment">// API TranslateAcceleratorA/W</span>
01992     IN HWND hwnd,
01993     IN HACCEL haccel,
01994     IN LPMSG lpmsg)
01995 {
01996     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
01997     <a class="code" href="../../d0/d8/structtagACCELTABLE.html">LPACCELTABLE</a> pat;
01998     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
01999     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpat;
02000     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
02001     MSG <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
02002 
02003     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<span class="keywordtype">int</span>, 0);
02004 
02005     <span class="comment">/*</span>
02006 <span class="comment">     * Probe arguments</span>
02007 <span class="comment">     */</span>
02008     <span class="keywordflow">try</span> {
02009         <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> = <a class="code" href="../../d4/d1/userk_8h.html#a33">ProbeAndReadMessage</a>(lpmsg);
02010     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
02011         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
02012     }
02013 
02014     <span class="comment">/*</span>
02015 <span class="comment">     * This is called within a message loop. If the window gets destroyed,</span>
02016 <span class="comment">     * there still may be other messages in the queue that get returned</span>
02017 <span class="comment">     * after the window is destroyed. The app will call TranslateAccelerator()</span>
02018 <span class="comment">     * on every one of these, causing RIPs.... Make it nice so it just</span>
02019 <span class="comment">     * returns FALSE.</span>
02020 <span class="comment">     */</span>
02021     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a54">ValidateHWNDNoRIP</a>(pwnd, hwnd);
02022     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a63">ValidateHACCEL</a>(pat, haccel);
02023 
02024     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
02025     <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwnd, &amp;tlpwnd);
02026     <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pat, &amp;tlpat);
02027 
02028     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1585">xxxTranslateAccelerator</a>(
02029             pwnd,
02030             pat,
02031             &amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>);
02032 
02033     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpat);
02034     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
02035 
02036     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserTranslateAccelerator"</span>);
02037     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
02038 }
02039 
<a name="l02040"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a113">02040</a> LONG_PTR <a class="code" href="../../d0/d0/ntuser_8h.html#a2">NtUserSetClassLongPtr</a>(  <span class="comment">// API SetClassLongPtrA/W</span>
02041     IN  HWND hwnd,
02042     IN  <span class="keywordtype">int</span> nIndex,
02043     OUT LONG_PTR dwNewLong,
02044     IN  BOOL bAnsi)
02045 {
02046     UNICODE_STRING strMenuName;
02047     <a class="code" href="../../d8/d0/structtagCLSMENUNAME.html">CLSMENUNAME</a> cmn, *pcmnSave;
02048 
02049     <span class="comment">//</span>
02050     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
02051     <span class="comment">//      enabled. These operations are performed in the User server API</span>
02052     <span class="comment">//      dispatcher.</span>
02053     <span class="comment">//</span>
02054 
02055     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(ULONG_PTR, 0, hwnd);
02056 
02057     <span class="keywordflow">switch</span> (nIndex) {
02058     <span class="keywordflow">case</span> GCLP_MENUNAME:
02059         <span class="keywordflow">try</span> {
02060             <span class="comment">/*</span>
02061 <span class="comment">             *  There is no callback from the routine for</span>
02062 <span class="comment">             *  this value, so we can protect it with a try/except.</span>
02063 <span class="comment">             *  This is cheaper than  capturing the name</span>
02064 <span class="comment">             *  and copying it back.  FritzS</span>
02065 <span class="comment">             */</span>
02066 
02067             pcmnSave = (<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html">PCLSMENUNAME</a>) dwNewLong;
02068             cmn = <a class="code" href="../../d5/d8/ex_8h.html#a27">ProbeAndReadStructure</a>(pcmnSave, <a class="code" href="../../d8/d0/structtagCLSMENUNAME.html">CLSMENUNAME</a>);
02069             strMenuName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(cmn.<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o2">pusMenuName</a>);
02070             <a class="code" href="../../d4/d1/userk_8h.html#a63">ProbeForReadUnicodeStringBufferOrId</a>(strMenuName);
02071         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
02072             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
02073         }
02074         cmn.<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o2">pusMenuName</a> = &amp;strMenuName;
02075         dwNewLong = (ULONG_PTR) &amp;cmn;
02076         retval = <a class="code" href="../../d4/d1/userk_8h.html#a606">xxxSetClassLongPtr</a>(
02077             pwnd,
02078             nIndex,
02079             dwNewLong,
02080             bAnsi);
02081         <span class="keywordflow">try</span> {
02082             <a class="code" href="../../d5/d8/ex_8h.html#a54">ProbeAndWriteStructure</a>(pcmnSave, cmn, <a class="code" href="../../d8/d0/structtagCLSMENUNAME.html">CLSMENUNAME</a>);
02083         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
02084             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
02085         }
02086         <span class="keywordflow">break</span>;
02087 
02088     <span class="keywordflow">case</span> GCL_STYLE:
02089         <span class="comment">/*</span>
02090 <span class="comment">         * I'm not sure how CS_VALID mask will affect existing apps,</span>
02091 <span class="comment">         * so leave it for now --- except CS_IME flag, on which the system</span>
02092 <span class="comment">         * deeply depends.</span>
02093 <span class="comment">         */</span>
02094 <span class="preprocessor">#if DBG</span>
02095 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (dwNewLong &amp; ~CS_VALID) {
02096             RIPMSG1(RIP_WARNING, <span class="stringliteral">"NtUserSetClassLongPtr: Invalid style (%x) specified."</span>, dwNewLong);
02097         }
02098 <span class="preprocessor">#endif</span>
02099 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (dwNewLong &amp; CS_IME) {
02100            RIPERR1(ERROR_INVALID_DATA, RIP_VERBOSE, <span class="stringliteral">"NtUserSetClassLongPtr: CS_IME is specified in new style (%x)."</span>, dwNewLong);
02101            <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
02102         }
02103     <span class="keywordflow">default</span>:
02104         retval = <a class="code" href="../../d4/d1/userk_8h.html#a606">xxxSetClassLongPtr</a>(
02105                 pwnd,
02106                 nIndex,
02107                 dwNewLong,
02108                 bAnsi);
02109 
02110     }
02111 
02112     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetClassLongPtr"</span>);
02113     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
02114 }
02115 
02116 <span class="preprocessor">#ifdef _WIN64</span>
02117 <span class="preprocessor"></span>LONG <a class="code" href="../../d0/d0/ntuser_8h.html#a36">NtUserSetClassLong</a>(
02118     IN  HWND hwnd,
02119     IN  <span class="keywordtype">int</span> nIndex,
02120     OUT LONG dwNewLong,
02121     IN  BOOL bAnsi)
02122 {
02123     <span class="comment">//</span>
02124     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
02125     <span class="comment">//      enabled. These operations are performed in the User server API</span>
02126     <span class="comment">//      dispatcher.</span>
02127     <span class="comment">//</span>
02128 
02129     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(DWORD, 0, hwnd);
02130 
02131     <span class="keywordflow">switch</span> (nIndex) {
02132     <span class="keywordflow">case</span> GCL_STYLE:
02133         <span class="comment">/*</span>
02134 <span class="comment">         * I'm not sure how CS_VALID mask will affect existing apps,</span>
02135 <span class="comment">         * so leave it for now --- except CS_IME flag, on which the system</span>
02136 <span class="comment">         * deeply depends.</span>
02137 <span class="comment">         */</span>
02138 <span class="preprocessor">#if DBG</span>
02139 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (dwNewLong &amp; ~CS_VALID) {
02140             RIPMSG1(RIP_WARNING, <span class="stringliteral">"NtUserSetClassLong: Invalid style (%x) specified."</span>, dwNewLong);
02141         }
02142 <span class="preprocessor">#endif</span>
02143 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (dwNewLong &amp; CS_IME) {
02144            RIPERR1(ERROR_INVALID_DATA, RIP_VERBOSE, <span class="stringliteral">"NtUserSetClassLong: CS_IME is specified in new style (%x)."</span>, dwNewLong);
02145            <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
02146         }
02147     }
02148 
02149     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1897">xxxSetClassLong</a>(
02150             pwnd,
02151             nIndex,
02152             dwNewLong,
02153             bAnsi);
02154 
02155     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetClassLong"</span>);
02156     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
02157 }
02158 <span class="preprocessor">#endif</span>
02159 <span class="preprocessor"></span>
<a name="l02160"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a114">02160</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a114">NtUserSetKeyboardState</a>(  <span class="comment">// API SetKeyboardState</span>
02161     IN CONST BYTE *lpKeyState)
02162 {
02163     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02164 
02165     <span class="comment">/*</span>
02166 <span class="comment">     * Probe arguments</span>
02167 <span class="comment">     */</span>
02168     <span class="keywordflow">try</span> {
02169         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(lpKeyState, 256, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
02170 
02171         retval = <a class="code" href="../../d4/d1/userk_8h.html#a1715">_SetKeyboardState</a>(lpKeyState);
02172     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
02173         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
02174     }
02175 
02176     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetKeyboardState"</span>);
02177     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
02178 }
02179 
<a name="l02180"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a115">02180</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a115">NtUserSetWindowPos</a>(
02181     IN HWND hwnd,
02182     IN HWND hwndInsertAfter,
02183     IN <span class="keywordtype">int</span> x,
02184     IN <span class="keywordtype">int</span> y,
02185     IN <span class="keywordtype">int</span> cx,
02186     IN <span class="keywordtype">int</span> cy,
02187     IN UINT dwFlags)
02188 {
02189     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndT;
02190     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndInsertAfter;
02191     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlpwndT;
02192 
02193     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a26">BEGINRECV_HWNDLOCK_ND</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, hwnd);
02194 
02195     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a46">TESTFLAGS</a>(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>, SWP_VALID);
02196 
02197     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a58">ValidateHWNDIA</a>(pwndInsertAfter, hwndInsertAfter);
02198 
02199     <span class="comment">/*</span>
02200 <span class="comment">     * Let's not allow the window to be shown/hidden once we</span>
02201 <span class="comment">     * started the destruction of the window.</span>
02202 <span class="comment">     */</span>
02203     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndND, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a591">WFINDESTROY</a>)) {
02204         RIPERR1(ERROR_INVALID_PARAMETER,
02205                 RIP_WARNING,
02206                 <span class="stringliteral">"SetWindowPos: Window is being destroyed (pwnd == %#p)"</span>,
02207                 pwndND);
02208         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
02209     }
02210 
02211     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; ~SWP_VALID) {
02212         RIPERR1(ERROR_INVALID_PARAMETER,
02213                 RIP_WARNING,
02214                 <span class="stringliteral">"SetWindowPos: Invalid flags passed in (flags == 0x%lx)"</span>,
02215                 <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
02216         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
02217     }
02218 
02219     <span class="comment">/*</span>
02220 <span class="comment">     * Make sure the window coordinates can fit in WORDs.</span>
02221 <span class="comment">     */</span>
02222     <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; SWP_NOMOVE)) {
02223         <span class="keywordflow">if</span> (x &gt; SHRT_MAX) {
02224             x = SHRT_MAX;
02225         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (x &lt; SHRT_MIN) {
02226             x = SHRT_MIN;
02227         }
02228         <span class="keywordflow">if</span> (y &gt; SHRT_MAX) {
02229             y = SHRT_MAX;
02230         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (y &lt; SHRT_MIN) {
02231             y = SHRT_MIN;
02232         }
02233     }
02234 
02235     <span class="comment">/*</span>
02236 <span class="comment">     * Actually, if we were going to be really strict about this we'd</span>
02237 <span class="comment">     * make sure that x + cx &lt; SHRT_MAX, etc but since we do maintain</span>
02238 <span class="comment">     * signed 32-bit coords internally this case doesn't cause a problem.</span>
02239 <span class="comment">     */</span>
02240     <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; SWP_NOSIZE)) {
02241         <span class="keywordflow">if</span> (cx &lt; 0) {
02242             cx = 0;
02243         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cx &gt; SHRT_MAX) {
02244             cx = SHRT_MAX;
02245         }
02246         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> &lt; 0) {
02247             <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = 0;
02248         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> &gt; SHRT_MAX) {
02249             <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = SHRT_MAX;
02250         }
02251     }
02252 
02253 <span class="preprocessor">#ifdef NEVER</span>
02254 <span class="preprocessor"></span><span class="comment">//</span>
02255 <span class="comment">// do not fail these conditions because real apps use them.</span>
02256 <span class="comment">//</span>
02257     <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; SWP_NOMOVE) &amp;&amp;
02258             (x &gt; SHRT_MAX || x &lt; SHRT_MIN ||
02259              y &gt; SHRT_MAX || y &lt; SHRT_MIN)) {
02260         RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"Invalid coordinate passed to SetWindowPos"</span>);
02261         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
02262     }
02263 
02264     <span class="comment">/*</span>
02265 <span class="comment">     * Actually, if we were going to be really strict about this we'd</span>
02266 <span class="comment">     * make sure that x + cx &lt; SHRT_MAX, etc but since we do maintain</span>
02267 <span class="comment">     * signed 32-bit coords internally this case doesn't cause a problem.</span>
02268 <span class="comment">     */</span>
02269     <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; SWP_NOSIZE) &amp;&amp;
02270             (cx &lt; 0 || cx &gt; SHRT_MAX ||
02271              cy &lt; 0 || cy &gt; SHRT_MAX)) {
02272         RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"Invalid width/height passed to SetWindowPos"</span>);
02273         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
02274     }
02275 <span class="preprocessor">#endif</span>
02276 <span class="preprocessor"></span>
02277     <span class="keywordflow">switch</span>((ULONG_PTR)pwndInsertAfter) {
02278     <span class="keywordflow">case</span> (ULONG_PTR)HWND_TOPMOST:
02279     <span class="keywordflow">case</span> (ULONG_PTR)HWND_NOTOPMOST:
02280     <span class="keywordflow">case</span> (ULONG_PTR)HWND_TOP:
02281     <span class="keywordflow">case</span> (ULONG_PTR)HWND_BOTTOM:
02282         pwndT = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02283         <span class="keywordflow">break</span>;
02284 
02285     <span class="keywordflow">default</span>:
02286         pwndT = pwndInsertAfter;
02287         <span class="keywordflow">break</span>;
02288     }
02289 
02290     <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwndT, &amp;tlpwndT);
02291 
02292     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(
02293             pwndND,
02294             pwndInsertAfter,
02295             x,
02296             y,
02297             cx,
02298             <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
02299             <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
02300 
02301     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
02302 
02303     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetWindowPos"</span>);
02304     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a27">ENDRECV_HWNDLOCK_ND</a>();
02305 }
02306 
<a name="l02307"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a116">02307</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a116">NtUserSetShellWindowEx</a>(
02308     IN HWND hwnd,
02309     IN HWND hwndBkGnd)
02310 {
02311     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndBkGnd;
02312     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlpwndBkGnd;
02313 
02314     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a26">BEGINRECV_HWNDLOCK_ND</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, hwnd);
02315 
02316     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a56">ValidateHWNDND</a>(pwndBkGnd, hwndBkGnd);
02317 
02318     <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwndBkGnd, &amp;tlpwndBkGnd);
02319 
02320     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1746">xxxSetShellWindow</a>(pwndND, pwndBkGnd);
02321 
02322     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndBkGnd);
02323 
02324     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetShellWindowEx"</span>);
02325     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a27">ENDRECV_HWNDLOCK_ND</a>();
02326 }
02327 
02328 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
<a name="l02329"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a117">02329</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a117">NtUserGetGuiResources</a>(
02330     HANDLE hProcess,
02331     DWORD dwFlags)
02332 
02333 {
02334     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
02335     PW32PROCESS pW32Process;
02336     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, 0);
02337 
02338     <span class="comment">/*</span>
02339 <span class="comment">     * Probe arguments</span>
02340 <span class="comment">     */</span>
02341     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &gt; GR_MAXOBJECT) {
02342         RIPERR1(ERROR_INVALID_PARAMETER, RIP_VERBOSE, <span class="stringliteral">"GetGuiResources: invalid flag bits %x\n"</span>,
02343                         <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
02344         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
02345     }
02346 
02347 
02348     <span class="keywordflow">if</span> (hProcess == NtCurrentProcess()) {
02349         pW32Process = W32GetCurrentProcess();
02350     } <span class="keywordflow">else</span> {
02351         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02352         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02353             hProcess,
02354             PROCESS_QUERY_INFORMATION,
02355             *<a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>,
02356             <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
02357             &amp;Process,
02358             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02359 
02360         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02361             RIPERR2(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"GetGuiResources: Failed with Process handle == %X, Status = %x\n"</span>,
02362                     hProcess, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02363             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
02364         }
02365 
02366         <span class="comment">/*</span>
02367 <span class="comment">         * Make sure they are from the same session</span>
02368 <span class="comment">         */</span>
02369         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o60">SessionId</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a327">gSessionId</a>) {
02370             RIPERR2(ERROR_INVALID_PARAMETER, RIP_VERBOSE, <span class="stringliteral">"GetGuiResources: Different session. Failed with Process handle == %X, Status = %x\n"</span>,
02371                     hProcess, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02372             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
02373             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
02374         }
02375 
02376         pW32Process = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o72">Win32Process</a>;
02377     }
02378 
02379     <span class="keywordflow">if</span> (pW32Process) {
02380         <span class="keywordflow">switch</span>(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>) {
02381         <span class="keywordflow">case</span> GR_GDIOBJECTS:
02382             retval = pW32Process-&gt;GDIHandleCount;
02383             <span class="keywordflow">break</span>;
02384         <span class="keywordflow">case</span> GR_USEROBJECTS:
02385             retval = pW32Process-&gt;UserHandleCount;
02386             <span class="keywordflow">break</span>;
02387         }
02388     } <span class="keywordflow">else</span>
02389         retval = 0;
02390 
02391     <span class="keywordflow">if</span> (hProcess != NtCurrentProcess()) {
02392         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
02393     }
02394 
02395     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetGuiResources"</span>);
02396     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
02397 }
02398 
02399 
<a name="l02400"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a118">02400</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a118">NtUserSystemParametersInfo</a>(  <span class="comment">// API SystemParametersInfoA/W</span>
02401     IN UINT   wFlag,
02402     IN DWORD  wParam,
02403     IN OUT LPVOID lpData,
02404     IN UINT   flags)
02405 {
02406     UNICODE_STRING strData;
02407     ULONG          ulLength, ulLength2;
02408     <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>         lpDataSave;
02409     <span class="keyword">union </span>{
02410         <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>              MouseData[3];
02411         LOGFONTW         LogFont;
02412         MOUSEKEYS        <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>;
02413         FILTERKEYS       <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a16">FilterKeys</a>;
02414         STICKYKEYS       StickyKeys;
02415         TOGGLEKEYS       <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a40">ToggleKeys</a>;
02416         SOUNDSENTRY      SoundSentry;
02417         ACCESSTIMEOUT    AccessTimeout;
02418         RECT             <a class="code" href="../../d5/d6/structRect.html">Rect</a>;
02419         ANIMATIONINFO    AnimationInfo;
02420         NONCLIENTMETRICS NonClientMetrics;
02421         MINIMIZEDMETRICS MinimizedMetrics;
02422         ICONMETRICS      IconMetrics;
02423         HKL              hkl;
02424         <a class="code" href="../../d8/d8/structtagINTERNALSETHIGHCONTRAST.html">INTERNALSETHIGHCONTRAST</a>     ihc;
02425         HIGHCONTRAST     hc;
02426         WCHAR            szTemp[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
02427     } CaptureBuffer;
02428     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
02429     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlBuffer;
02430     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fFreeBuffer = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02431     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fWrite = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02432 
02433 
02434 
02435 
02436     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02437 
02438     <span class="comment">/*</span>
02439 <span class="comment">     * Prevent restricted processes from setting system</span>
02440 <span class="comment">     * parameters.</span>
02441 <span class="comment">     *</span>
02442 <span class="comment">     * clupu: this is ineficient and temporary. I'll change this</span>
02443 <span class="comment">     * soon !!!</span>
02444 <span class="comment">     */</span>
02445     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a383">IS_CURRENT_THREAD_RESTRICTED</a>(JOB_OBJECT_UILIMIT_SYSTEMPARAMETERS)) {
02446 
02447         <span class="keywordflow">switch</span> (wFlag) {
02448         <span class="keywordflow">case</span> SPI_SETBEEP:
02449         <span class="keywordflow">case</span> SPI_SETMOUSE:
02450         <span class="keywordflow">case</span> SPI_SETBORDER:
02451         <span class="keywordflow">case</span> SPI_SETKEYBOARDSPEED:
02452         <span class="keywordflow">case</span> SPI_ICONHORIZONTALSPACING:
02453         <span class="keywordflow">case</span> SPI_SETSCREENSAVETIMEOUT:
02454         <span class="keywordflow">case</span> SPI_SETSCREENSAVEACTIVE:
02455         <span class="keywordflow">case</span> SPI_SETGRIDGRANULARITY:
02456         <span class="keywordflow">case</span> SPI_SETDESKWALLPAPER:
02457         <span class="keywordflow">case</span> SPI_SETDESKPATTERN:
02458         <span class="keywordflow">case</span> SPI_SETKEYBOARDDELAY:
02459         <span class="keywordflow">case</span> SPI_ICONVERTICALSPACING:
02460         <span class="keywordflow">case</span> SPI_SETICONTITLEWRAP:
02461         <span class="keywordflow">case</span> SPI_SETMENUDROPALIGNMENT:
02462         <span class="keywordflow">case</span> SPI_SETDOUBLECLKWIDTH:
02463         <span class="keywordflow">case</span> SPI_SETDOUBLECLKHEIGHT:
02464         <span class="keywordflow">case</span> SPI_SETDOUBLECLICKTIME:
02465         <span class="keywordflow">case</span> SPI_SETMOUSEBUTTONSWAP:
02466         <span class="keywordflow">case</span> SPI_SETICONTITLELOGFONT:
02467         <span class="keywordflow">case</span> SPI_SETFASTTASKSWITCH:
02468         <span class="keywordflow">case</span> SPI_SETDRAGFULLWINDOWS:
02469         <span class="keywordflow">case</span> SPI_SETNONCLIENTMETRICS:
02470         <span class="keywordflow">case</span> SPI_SETMINIMIZEDMETRICS:
02471         <span class="keywordflow">case</span> SPI_SETICONMETRICS:
02472         <span class="keywordflow">case</span> SPI_SETWORKAREA:
02473         <span class="keywordflow">case</span> SPI_SETPENWINDOWS:
02474         <span class="keywordflow">case</span> SPI_SETHIGHCONTRAST:
02475         <span class="keywordflow">case</span> SPI_SETKEYBOARDPREF:
02476         <span class="keywordflow">case</span> SPI_SETSCREENREADER:
02477         <span class="keywordflow">case</span> SPI_SETANIMATION:
02478         <span class="keywordflow">case</span> SPI_SETFONTSMOOTHING:
02479         <span class="keywordflow">case</span> SPI_SETDRAGWIDTH:
02480         <span class="keywordflow">case</span> SPI_SETDRAGHEIGHT:
02481         <span class="keywordflow">case</span> SPI_SETHANDHELD:
02482         <span class="keywordflow">case</span> SPI_SETLOWPOWERTIMEOUT:
02483         <span class="keywordflow">case</span> SPI_SETPOWEROFFTIMEOUT:
02484         <span class="keywordflow">case</span> SPI_SETLOWPOWERACTIVE:
02485         <span class="keywordflow">case</span> SPI_SETPOWEROFFACTIVE:
02486         <span class="keywordflow">case</span> SPI_SETCURSORS:
02487         <span class="keywordflow">case</span> SPI_SETICONS:
02488         <span class="keywordflow">case</span> SPI_SETDEFAULTINPUTLANG:
02489         <span class="keywordflow">case</span> SPI_SETLANGTOGGLE:
02490         <span class="keywordflow">case</span> SPI_SETMOUSETRAILS:
02491         <span class="keywordflow">case</span> SPI_SETSCREENSAVERRUNNING:
02492         <span class="keywordflow">case</span> SPI_SETFILTERKEYS:
02493         <span class="keywordflow">case</span> SPI_SETTOGGLEKEYS:
02494         <span class="keywordflow">case</span> SPI_SETMOUSEKEYS:
02495         <span class="keywordflow">case</span> SPI_SETSHOWSOUNDS:
02496         <span class="keywordflow">case</span> SPI_SETSTICKYKEYS:
02497         <span class="keywordflow">case</span> SPI_SETACCESSTIMEOUT:
02498         <span class="keywordflow">case</span> SPI_SETSOUNDSENTRY:
02499         <span class="keywordflow">case</span> SPI_SETSNAPTODEFBUTTON:
02500         <span class="keywordflow">case</span> SPI_SETMOUSEHOVERWIDTH:
02501         <span class="keywordflow">case</span> SPI_SETMOUSEHOVERHEIGHT:
02502         <span class="keywordflow">case</span> SPI_SETMOUSEHOVERTIME:
02503         <span class="keywordflow">case</span> SPI_SETWHEELSCROLLLINES:
02504         <span class="keywordflow">case</span> SPI_SETMENUSHOWDELAY:
02505         <span class="keywordflow">case</span> SPI_SETSHOWIMEUI:
02506         <span class="keywordflow">case</span> SPI_SETMOUSESPEED:
02507         <span class="keywordflow">case</span> SPI_SETACTIVEWINDOWTRACKING:
02508         <span class="keywordflow">case</span> SPI_SETMENUANIMATION:
02509         <span class="keywordflow">case</span> SPI_SETCOMBOBOXANIMATION:
02510         <span class="keywordflow">case</span> SPI_SETLISTBOXSMOOTHSCROLLING:
02511         <span class="keywordflow">case</span> SPI_SETGRADIENTCAPTIONS:
02512         <span class="keywordflow">case</span> SPI_SETKEYBOARDCUES:
02513         <span class="keywordflow">case</span> SPI_SETACTIVEWNDTRKZORDER:
02514         <span class="keywordflow">case</span> SPI_SETHOTTRACKING:
02515         <span class="keywordflow">case</span> SPI_SETMENUFADE:
02516         <span class="keywordflow">case</span> SPI_SETSELECTIONFADE:
02517         <span class="keywordflow">case</span> SPI_SETTOOLTIPANIMATION:
02518         <span class="keywordflow">case</span> SPI_SETTOOLTIPFADE:
02519         <span class="keywordflow">case</span> SPI_SETFOREGROUNDLOCKTIMEOUT:
02520         <span class="keywordflow">case</span> SPI_SETACTIVEWNDTRKTIMEOUT:
02521         <span class="keywordflow">case</span> SPI_SETFOREGROUNDFLASHCOUNT:
02522             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
02523             <span class="keywordflow">break</span>;
02524         }
02525     }
02526 
02527     <span class="keywordflow">try</span> {
02528         <span class="keywordflow">switch</span>(wFlag) {
02529 
02530         <span class="keywordflow">case</span> SPI_SETDESKPATTERN:
02531             <span class="comment">/*</span>
02532 <span class="comment">             * If wParam is -1, that means read the new wallpaper from</span>
02533 <span class="comment">             * win.ini. If wParam is not -1, lParam points to the wallpaper</span>
02534 <span class="comment">             * string.</span>
02535 <span class="comment">             */</span>
02536             <span class="keywordflow">if</span> (wParam == (WPARAM)-1)
02537                 <span class="keywordflow">break</span>;
02538 
02539             <span class="comment">/*</span>
02540 <span class="comment">             * SetDeskPattern may take a string in lpData; if lpData</span>
02541 <span class="comment">             * is one of the magic values it obviously is not a string</span>
02542 <span class="comment">             */</span>
02543             <span class="keywordflow">if</span> (lpData == (PVOID)IntToPtr( 0xFFFFFFFF ) || lpData == (PVOID)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02544                 <span class="comment">/*</span>
02545 <span class="comment">                 * These are not really magic values, but in order not to break apps</span>
02546 <span class="comment">                 * we have to keep them valid.  wParam =-1 will make lParam be ignored</span>
02547 <span class="comment">                 * MCostea 208416</span>
02548 <span class="comment">                 */</span>
02549                 wParam = -1;
02550                 <span class="keywordflow">break</span>;
02551             }
02552             <span class="keywordflow">goto</span> ProbeString;
02553 
02554         <span class="keywordflow">case</span> SPI_SETDESKWALLPAPER:
02555 
02556             <span class="comment">/*</span>
02557 <span class="comment">             * If the caller passed in (-1) in the wParam, then the</span>
02558 <span class="comment">             * wallpaper-name is to be loaded later.  Otherwise,</span>
02559 <span class="comment">             * they passed in a unicode-string in the lParam.</span>
02560 <span class="comment">             */</span>
02561             <span class="keywordflow">if</span> (wParam == (WPARAM)-1)
02562                 <span class="keywordflow">break</span>;
02563 
02564             <span class="keywordflow">if</span> (((LPWSTR)lpData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)                 ||
02565                 ((LPWSTR)lpData == SETWALLPAPER_METRICS) ||
02566                 ((LPWSTR)lpData == SETWALLPAPER_DEFAULT)) {
02567                 <span class="keywordflow">break</span>;
02568             }
02569 
02570 ProbeString:
02571 
02572             <span class="comment">/*</span>
02573 <span class="comment">             * Probe and capture the string.  Capture is necessary to</span>
02574 <span class="comment">             * the pointer to be passed directly to the registry routines</span>
02575 <span class="comment">             * which cannot cleanly handle exceptions.</span>
02576 <span class="comment">             */</span>
02577             strData = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>((PUNICODE_STRING)lpData);
02578 <span class="preprocessor">#if defined(_X86_)</span>
02579 <span class="preprocessor"></span>            <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(strData.Buffer, strData.Length, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
02580 <span class="preprocessor">#else</span>
02581 <span class="preprocessor"></span>            <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(strData.Buffer, strData.Length, <span class="keyword">sizeof</span>(WCHAR));
02582 <span class="preprocessor">#endif</span>
02583 <span class="preprocessor"></span>            lpData = UserAllocPoolWithQuota(strData.Length + <span class="keyword">sizeof</span>(WCHAR), TAG_TEXT2);
02584             <span class="keywordflow">if</span> (lpData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02585                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_NO_MEMORY);
02586             }
02587             pti = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
02588             <a class="code" href="../../d4/d1/userk_8h.html#a137">ThreadLockPool</a>(pti, lpData, &amp;tlBuffer);
02589             fFreeBuffer = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02590             RtlCopyMemory(lpData,
02591                           strData.Buffer,
02592                           strData.Length);
02593             ((PWSTR)lpData)[strData.Length / <span class="keyword">sizeof</span>(WCHAR)] = 0;
02594             <span class="keywordflow">break</span>;
02595 
02596         <span class="keywordflow">case</span> SPI_SETMOUSE:
02597             ulLength = <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>) * 3;
02598             <span class="keywordflow">goto</span> ProbeRead;
02599         <span class="keywordflow">case</span> SPI_SETICONTITLELOGFONT:
02600             <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(lpData))
02601                 <span class="keywordflow">break</span>;
02602             ulLength = <span class="keyword">sizeof</span>(LOGFONTW);
02603             <span class="keywordflow">goto</span> ProbeRead;
02604         <span class="keywordflow">case</span> SPI_SETMOUSEKEYS:
02605             ulLength = <span class="keyword">sizeof</span>(MOUSEKEYS);
02606             <span class="keywordflow">goto</span> ProbeRead;
02607         <span class="keywordflow">case</span> SPI_SETFILTERKEYS:
02608             ulLength = <span class="keyword">sizeof</span>(FILTERKEYS);
02609             <span class="keywordflow">goto</span> ProbeRead;
02610         <span class="keywordflow">case</span> SPI_SETSTICKYKEYS:
02611             ulLength = <span class="keyword">sizeof</span>(STICKYKEYS);
02612             <span class="keywordflow">goto</span> ProbeRead;
02613         <span class="keywordflow">case</span> SPI_SETTOGGLEKEYS:
02614             ulLength = <span class="keyword">sizeof</span>(TOGGLEKEYS);
02615             <span class="keywordflow">goto</span> ProbeRead;
02616         <span class="keywordflow">case</span> SPI_SETSOUNDSENTRY:
02617             ulLength = <span class="keyword">sizeof</span>(SOUNDSENTRY);
02618             <span class="keywordflow">goto</span> ProbeRead;
02619         <span class="keywordflow">case</span> SPI_SETACCESSTIMEOUT:
02620             ulLength = <span class="keyword">sizeof</span>(ACCESSTIMEOUT);
02621             <span class="keywordflow">goto</span> ProbeRead;
02622         <span class="keywordflow">case</span> SPI_SETWORKAREA:
02623             ulLength = <span class="keyword">sizeof</span>(RECT);
02624             <span class="keywordflow">goto</span> ProbeRead;
02625         <span class="keywordflow">case</span> SPI_SETANIMATION:
02626             ulLength = <span class="keyword">sizeof</span>(ANIMATIONINFO);
02627             <span class="keywordflow">goto</span> ProbeRead;
02628         <span class="keywordflow">case</span> SPI_SETNONCLIENTMETRICS:
02629             ulLength = <span class="keyword">sizeof</span>(NONCLIENTMETRICS);
02630             <span class="keywordflow">goto</span> ProbeRead;
02631         <span class="keywordflow">case</span> SPI_SETMINIMIZEDMETRICS:
02632             ulLength = <span class="keyword">sizeof</span>(MINIMIZEDMETRICS);
02633             <span class="keywordflow">goto</span> ProbeRead;
02634         <span class="keywordflow">case</span> SPI_SETICONMETRICS:
02635             ulLength = <span class="keyword">sizeof</span>(ICONMETRICS);
02636             <span class="keywordflow">goto</span> ProbeRead;
02637         <span class="keywordflow">case</span> SPI_SETDEFAULTINPUTLANG:
02638             ulLength = <span class="keyword">sizeof</span>(HKL);
02639             <span class="keywordflow">goto</span> ProbeRead;
02640         <span class="keywordflow">case</span> SPI_SETHIGHCONTRAST:
02641             CaptureBuffer.ihc = <a class="code" href="../../d5/d8/ex_8h.html#a27">ProbeAndReadStructure</a>((<a class="code" href="../../d8/d8/structtagINTERNALSETHIGHCONTRAST.html">INTERNALSETHIGHCONTRAST</a> *)lpData, <a class="code" href="../../d8/d8/structtagINTERNALSETHIGHCONTRAST.html">INTERNALSETHIGHCONTRAST</a>);
02642             lpData = &amp;CaptureBuffer.ihc;
02643 
02644             <span class="comment">/*</span>
02645 <span class="comment">             * Now probe High Contrast string -- note that we send a client-side buffer pointer to the routine.</span>
02646 <span class="comment">             */</span>
02647 
02648             <a class="code" href="../../d4/d1/userk_8h.html#a61">ProbeForReadUnicodeStringBuffer</a>(CaptureBuffer.ihc.usDefaultScheme);
02649             <span class="keywordflow">if</span> (CaptureBuffer.ihc.usDefaultScheme.Length == 0) {
02650                 CaptureBuffer.ihc.usDefaultScheme.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02651             }
02652             <span class="keywordflow">break</span>;
02653 
02654             <span class="comment">/*</span>
02655 <span class="comment">             * Probe and capture the data.  Capture is necessary to</span>
02656 <span class="comment">             * allow the pointer to be passed to the worker routines</span>
02657 <span class="comment">             * where exceptions cannot be cleanly handled.</span>
02658 <span class="comment">             */</span>
02659 ProbeRead:
02660 <span class="preprocessor">#if defined(_X86_)</span>
02661 <span class="preprocessor"></span>            <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(lpData, ulLength, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
02662 <span class="preprocessor">#else</span>
02663 <span class="preprocessor"></span>            <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(lpData, ulLength, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
02664 <span class="preprocessor">#endif</span>
02665 <span class="preprocessor"></span>            RtlCopyMemory(&amp;CaptureBuffer, lpData, ulLength);
02666             lpData = &amp;CaptureBuffer;
02667             <span class="keywordflow">break</span>;
02668 
02669         <span class="keywordflow">case</span> SPI_ICONHORIZONTALSPACING: <span class="comment">// returns INT</span>
02670         <span class="keywordflow">case</span> SPI_ICONVERTICALSPACING:   <span class="comment">// returns INT</span>
02671             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(lpData))
02672                 <span class="keywordflow">break</span>;
02673 
02674             <span class="comment">/*</span>
02675 <span class="comment">             * Fall through and probe the data</span>
02676 <span class="comment">             */</span>
02677         <span class="keywordflow">case</span> SPI_GETBEEP:               <span class="comment">// returns BOOL</span>
02678         <span class="keywordflow">case</span> SPI_GETBORDER:             <span class="comment">// returns INT</span>
02679         <span class="keywordflow">case</span> SPI_GETKEYBOARDSPEED:      <span class="comment">// returns DWORD</span>
02680         <span class="keywordflow">case</span> SPI_GETKEYBOARDDELAY:      <span class="comment">// returns INT</span>
02681         <span class="keywordflow">case</span> SPI_GETSCREENSAVETIMEOUT:  <span class="comment">// returns INT</span>
02682         <span class="keywordflow">case</span> SPI_GETLOWPOWERTIMEOUT:    <span class="comment">// returns INT</span>
02683         <span class="keywordflow">case</span> SPI_GETPOWEROFFTIMEOUT:    <span class="comment">// returns INT</span>
02684         <span class="keywordflow">case</span> SPI_GETSCREENSAVEACTIVE:   <span class="comment">// returns BOOL</span>
02685         <span class="keywordflow">case</span> SPI_GETLOWPOWERACTIVE:     <span class="comment">// returns BOOL</span>
02686         <span class="keywordflow">case</span> SPI_GETPOWEROFFACTIVE:     <span class="comment">// returns BOOL</span>
02687         <span class="keywordflow">case</span> SPI_GETGRIDGRANULARITY:    <span class="comment">// returns INT</span>
02688         <span class="keywordflow">case</span> SPI_GETICONTITLEWRAP:      <span class="comment">// returns BOOL</span>
02689         <span class="keywordflow">case</span> SPI_GETMENUDROPALIGNMENT:  <span class="comment">// returns BOOL</span>
02690         <span class="keywordflow">case</span> SPI_GETFASTTASKSWITCH:     <span class="comment">// returns BOOL</span>
02691         <span class="keywordflow">case</span> SPI_GETDRAGFULLWINDOWS:    <span class="comment">// returns INT</span>
02692         <span class="keywordflow">case</span> SPI_GETSHOWSOUNDS:         <span class="comment">// returns BOOL</span>
02693         <span class="keywordflow">case</span> SPI_GETFONTSMOOTHING:      <span class="comment">// returns INT</span>
02694         <span class="keywordflow">case</span> SPI_GETSNAPTODEFBUTTON:    <span class="comment">// returns BOOL</span>
02695         <span class="keywordflow">case</span> SPI_GETKEYBOARDPREF:       <span class="comment">// returns BOOL</span>
02696         <span class="keywordflow">case</span> SPI_GETSCREENREADER:       <span class="comment">// returns BOOL</span>
02697         <span class="keywordflow">case</span> SPI_GETDEFAULTINPUTLANG:
02698         <span class="keywordflow">case</span> SPI_GETMOUSEHOVERWIDTH:
02699         <span class="keywordflow">case</span> SPI_GETMOUSEHOVERHEIGHT:
02700         <span class="keywordflow">case</span> SPI_GETMOUSEHOVERTIME:
02701         <span class="keywordflow">case</span> SPI_GETWHEELSCROLLLINES:
02702         <span class="keywordflow">case</span> SPI_GETMENUSHOWDELAY:
02703         <span class="keywordflow">case</span> SPI_GETMOUSESPEED:
02704         <span class="keywordflow">case</span> SPI_GETSCREENSAVERRUNNING:
02705         <span class="keywordflow">case</span> SPI_GETSHOWIMEUI:
02706             <span class="keywordflow">goto</span> ProbeWriteUlong;
02707 
02708         <span class="keywordflow">case</span> SPI_GETICONTITLELOGFONT:   <span class="comment">// returns LOGFONT</span>
02709             ulLength = <span class="keyword">sizeof</span>(LOGFONT);
02710             <span class="keywordflow">goto</span> ProbeWrite;
02711         <span class="keywordflow">case</span> SPI_GETMOUSE:              <span class="comment">// returns 3 INTs</span>
02712             ulLength = <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>) * 3;
02713             <span class="keywordflow">goto</span> ProbeWrite;
02714         <span class="keywordflow">case</span> SPI_GETFILTERKEYS:         <span class="comment">// returns FILTERKEYS</span>
02715             ulLength = <span class="keyword">sizeof</span>(FILTERKEYS);
02716             <span class="keywordflow">goto</span> ProbeWrite;
02717         <span class="keywordflow">case</span> SPI_GETSTICKYKEYS:         <span class="comment">// returns STICKYKEYS</span>
02718             ulLength = <span class="keyword">sizeof</span>(STICKYKEYS);
02719             <span class="keywordflow">goto</span> ProbeWrite;
02720         <span class="keywordflow">case</span> SPI_GETMOUSEKEYS:          <span class="comment">// returns MOUSEKEYS</span>
02721             ulLength = <span class="keyword">sizeof</span>(MOUSEKEYS);
02722             <span class="keywordflow">goto</span> ProbeWrite;
02723         <span class="keywordflow">case</span> SPI_GETTOGGLEKEYS:         <span class="comment">// returns TOGGLEKEYS</span>
02724             ulLength = <span class="keyword">sizeof</span>(TOGGLEKEYS);
02725             <span class="keywordflow">goto</span> ProbeWrite;
02726         <span class="keywordflow">case</span> SPI_GETSOUNDSENTRY:        <span class="comment">// returns SOUNDSENTRY</span>
02727             ulLength = <span class="keyword">sizeof</span>(SOUNDSENTRY);
02728             <span class="keywordflow">goto</span> ProbeWrite;
02729         <span class="keywordflow">case</span> SPI_GETACCESSTIMEOUT:      <span class="comment">// returns ACCESSTIMEOUT</span>
02730             ulLength = <span class="keyword">sizeof</span>(ACCESSTIMEOUT);
02731             <span class="keywordflow">goto</span> ProbeWrite;
02732         <span class="keywordflow">case</span> SPI_GETANIMATION:          <span class="comment">// returns ANIMATIONINFO</span>
02733             ulLength = <span class="keyword">sizeof</span>(ANIMATIONINFO);
02734             <span class="keywordflow">goto</span> ProbeWrite;
02735         <span class="keywordflow">case</span> SPI_GETNONCLIENTMETRICS:   <span class="comment">// returns NONCLIENTMETRICS</span>
02736             ulLength = <span class="keyword">sizeof</span>(NONCLIENTMETRICS);
02737             <span class="keywordflow">goto</span> ProbeWrite;
02738         <span class="keywordflow">case</span> SPI_GETMINIMIZEDMETRICS:   <span class="comment">// returns MINIMIZEDMETRICS</span>
02739             ulLength = <span class="keyword">sizeof</span>(MINIMIZEDMETRICS);
02740             <span class="keywordflow">goto</span> ProbeWrite;
02741         <span class="keywordflow">case</span> SPI_GETICONMETRICS:        <span class="comment">// returns ICONMETRICS</span>
02742             ulLength = <span class="keyword">sizeof</span>(ICONMETRICS);
02743             <span class="keywordflow">goto</span> ProbeWrite;
02744 
02745         <span class="keywordflow">case</span> SPI_GETHIGHCONTRAST:       <span class="comment">// returns HIGHCONTRAST</span>
02746             ulLength = <span class="keyword">sizeof</span>(HIGHCONTRASTW);
02747             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(lpData, ulLength, <a class="code" href="../../d4/d1/userk_8h.html#a22">DATAALIGN</a>);
02748             lpDataSave = lpData;
02749             CaptureBuffer.hc = *((LPHIGHCONTRAST)lpData);
02750             lpData = &amp;CaptureBuffer.hc;
02751 
02752             <span class="comment">/*</span>
02753 <span class="comment">             * now probe string address</span>
02754 <span class="comment">             */</span>
02755 
02756             ulLength2 = MAX_SCHEME_NAME_SIZE * <span class="keyword">sizeof</span>(WCHAR);
02757 
02758             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(((LPHIGHCONTRAST)lpData)-&gt;lpszDefaultScheme, ulLength2, <a class="code" href="../../d4/d1/userk_8h.html#a23">CHARALIGN</a>);
02759             fWrite = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02760             <span class="keywordflow">break</span>;
02761         <span class="keywordflow">case</span> SPI_GETWORKAREA:           <span class="comment">// returns RECT</span>
02762             ulLength = <span class="keyword">sizeof</span>(RECT);
02763             <span class="keywordflow">goto</span> ProbeWrite;
02764 
02765 
02766         <span class="comment">/*</span>
02767 <span class="comment">         * Bug 257718 - joejo</span>
02768 <span class="comment">         * Add SPI_GETDESKWALLPAPER to SystemParametersInfo</span>
02769 <span class="comment">         */</span>
02770         <span class="keywordflow">case</span> SPI_GETDESKWALLPAPER:
02771             lpDataSave = lpData;
02772             lpData = CaptureBuffer.szTemp;
02773             <a class="code" href="../../d4/d1/userk_8h.html#a25">ProbeForWriteBuffer</a>((PWSTR)lpDataSave, wParam, <a class="code" href="../../d4/d1/userk_8h.html#a23">CHARALIGN</a>);
02774             wParam = (wParam &lt; <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>) ? wParam : <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>;
02775             ulLength = wParam * <span class="keyword">sizeof</span>(WCHAR);
02776             fWrite = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02777             <span class="keywordflow">break</span>;
02778 
02779         <span class="keywordflow">default</span>:
02780             <span class="keywordflow">if</span> (wFlag &lt; SPI_MAX) {
02781                 <span class="keywordflow">break</span>;
02782             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a556">UPIsBOOLRange</a>(wFlag)
02783                     &amp;&amp; !<a class="code" href="../../d4/d1/userk_8h.html#a554">UPIsDWORDRange</a>(wFlag)) {
02784 
02785                 RIPERR1(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"NtUserSystemParametersInfo: Invalid SPI_:%#lx"</span>, wFlag);
02786                 retval = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02787                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
02788             }
02789 
02790             <span class="comment">/*</span>
02791 <span class="comment">             * Let's enforce this or this parameter is gone for good.</span>
02792 <span class="comment">             */</span>
02793             <span class="keywordflow">if</span> (wParam != 0) {
02794                 <span class="comment">/*</span>
02795 <span class="comment">                 * Too late, Winstone98 is alreay using it (incorrectly).</span>
02796 <span class="comment">                 * Bummer, this has never been shipped and it's hacked already</span>
02797 <span class="comment">                 * Allow a special case to go through</span>
02798 <span class="comment">                 */</span>
02799                 <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;dwExpWinVer &gt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>)
02800                         || (wFlag != SPI_SETUIEFFECTS)
02801                         || (wParam != 1)) {
02802                     RIPERR1(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"NtUserSystemParametersInfo: uiParam must be zero for SPI %#lx"</span>, wFlag);
02803                     retval = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02804                     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
02805                 }
02806             }
02807 
02808             UserAssert(wFlag &amp; SPIF_RANGETYPEMASK);
02809 
02810             <span class="keywordflow">if</span> (wFlag &amp; SPIF_SET) {
02811                 <span class="comment">/*</span>
02812 <span class="comment">                 * If your dword data needs to be validated (i.e, range, value),</span>
02813 <span class="comment">                 *  switch here on wFlag and do it here</span>
02814 <span class="comment">                 */</span>
02815                 <span class="keywordflow">switch</span> (wFlag) {
02816                     <span class="keywordflow">case</span> SPI_SETFOREGROUNDLOCKTIMEOUT:
02817                         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1663">CanForceForeground</a>(<a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>())) {
02818                             RIPERR0(ERROR_ACCESS_DENIED, RIP_VERBOSE, <span class="stringliteral">""</span>);
02819                             retval = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02820                             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
02821                         }
02822                         <span class="keywordflow">break</span>;
02823                 }
02824 
02825             } <span class="keywordflow">else</span> { <span class="comment">/* if (wFlag &amp; SPIF_SET) */</span>
02826 ProbeWriteUlong:
02827                 ulLength = <span class="keyword">sizeof</span>(ULONG);
02828                 lpDataSave = lpData;
02829                 lpData = &amp;CaptureBuffer;
02830                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>((PULONG)lpDataSave);
02831                 fWrite = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02832             }
02833             <span class="keywordflow">break</span>;
02834 
02835             <span class="comment">/*</span>
02836 <span class="comment">             * Probe the data.  wParam contains the length</span>
02837 <span class="comment">             */</span>
02838 ProbeWrite:
02839             lpDataSave = lpData;
02840             lpData = &amp;CaptureBuffer;
02841             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(lpDataSave, ulLength, <a class="code" href="../../d4/d1/userk_8h.html#a22">DATAALIGN</a>);
02842             fWrite = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02843             <span class="comment">/*</span>
02844 <span class="comment">             * Copy the first DWORD of the buffer.  This will make sure that</span>
02845 <span class="comment">             * the cbSize parameter of some structures gets copied.</span>
02846 <span class="comment">             */</span>
02847 
02848             UserAssert(ulLength &gt;= <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
02849             *(LPDWORD)lpData=*(LPDWORD)lpDataSave;
02850         }
02851     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
02852         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
02853     }
02854 
02855    retval = <a class="code" href="../../d4/d1/userk_8h.html#a1493">xxxSystemParametersInfo</a>(wFlag, wParam, lpData, flags);
02856 
02857    <span class="comment">/*</span>
02858 <span class="comment">     * Copy out any data we need to.</span>
02859 <span class="comment">     */</span>
02860     <span class="keywordflow">if</span> (fWrite) {
02861         <span class="keywordflow">try</span> {
02862             RtlCopyMemory(lpDataSave, lpData, ulLength);
02863         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
02864             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
02865         }
02866     }
02867 
02868     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a33">CLEANUPRECV</a>();
02869     <span class="keywordflow">if</span> (fFreeBuffer)
02870         <a class="code" href="../../d4/d1/userk_8h.html#a139">ThreadUnlockAndFreePool</a>(pti, &amp;tlBuffer);
02871 
02872     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSystemParametersInfo"</span>);
02873     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
02874 }
02875 
<a name="l02876"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a119">02876</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a119">NtUserUpdatePerUserSystemParameters</a>(
02877     IN HANDLE hToken,
02878     IN BOOL   bUserLoggedOn)
02879 {
02880     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02881 
02882     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1538">xxxUpdatePerUserSystemParameters</a>(hToken, bUserLoggedOn);
02883 
02884     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserUpdatePerUserSystemParameters"</span>);
02885     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
02886 }
02887 
<a name="l02888"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a120">02888</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a120">NtUserDdeInitialize</a>(  <span class="comment">// API DdeInitializeA/W</span>
02889     OUT PHANDLE phInst,
02890     OUT HWND *phwnd,
02891     OUT LPDWORD pMonFlags,
02892     IN DWORD afCmd,
02893     IN PVOID pcii)
02894 {
02895     HANDLE <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a0">hInst</a>;
02896     HWND hwnd;
02897     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> MonFlags;
02898 
02899     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, DMLERR_INVALIDPARAMETER);
02900 
02901     <span class="comment">/*</span>
02902 <span class="comment">     * NOTE -- pcii is a value that is passed back to the client side</span>
02903 <span class="comment">     *  for event callbacks.  It is not probed because it is not used</span>
02904 <span class="comment">     *  on the kernel side.</span>
02905 <span class="comment">     */</span>
02906 
02907     retval = <a class="code" href="../../d2/d4/ddemlsvr_8h.html#a8">xxxCsDdeInitialize</a>(&amp;<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a0">hInst</a>, &amp;hwnd,
02908             &amp;MonFlags, afCmd, pcii);
02909 
02910     <span class="comment">/*</span>
02911 <span class="comment">     * Probe arguments.  pcii is not dereferenced in the kernel so probing</span>
02912 <span class="comment">     * is not needed.</span>
02913 <span class="comment">     */</span>
02914     <span class="keywordflow">if</span> (retval == DMLERR_NO_ERROR) {
02915         <span class="keywordflow">try</span> {
02916             <a class="code" href="../../d5/d8/ex_8h.html#a49">ProbeAndWriteHandle</a>(phInst, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a0">hInst</a>);
02917             <a class="code" href="../../d5/d8/ex_8h.html#a49">ProbeAndWriteHandle</a>((PHANDLE)phwnd, hwnd);
02918             <a class="code" href="../../d5/d8/ex_8h.html#a51">ProbeAndWriteUlong</a>(pMonFlags, MonFlags);
02919         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
02920             <a class="code" href="../../d2/d4/ddemlsvr_8h.html#a11">xxxDestroyThreadDDEObject</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), <a class="code" href="../../d4/d1/userk_8h.html#a102">HtoP</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a0">hInst</a>));
02921             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
02922         }
02923     }
02924 
02925     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserDdeInitialize"</span>);
02926     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
02927 }
02928 
<a name="l02929"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a121">02929</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a121">NtUserUpdateInstance</a>( <span class="comment">// private, but pMonFlags from API DdeInitializeA/W</span>
02930     IN HANDLE hInst,
02931     OUT LPDWORD pMonFlags,
02932     IN DWORD afCmd)
02933 {
02934     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> MonFlags;
02935     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, DMLERR_INVALIDPARAMETER);
02936 
02937     <span class="comment">/*</span>
02938 <span class="comment">     * Probe arguments</span>
02939 <span class="comment">     */</span>
02940     <span class="keywordflow">try</span> {
02941         <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(pMonFlags);
02942     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
02943         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
02944     }
02945     retval = <a class="code" href="../../d2/d4/ddemlsvr_8h.html#a9">_CsUpdateInstance</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a0">hInst</a>, &amp;MonFlags, afCmd);
02946     <span class="keywordflow">try</span> {
02947         *pMonFlags = MonFlags;
02948     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
02949         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
02950     }
02951 
02952     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserUpdateInstance"</span>);
02953     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
02954 }
02955 
<a name="l02956"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a122">02956</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a122">NtUserEvent</a>(  <span class="comment">// private</span>
02957     IN <a class="code" href="../../d7/d4/structtagEVENT__PACKET.html">PEVENT_PACKET</a> pep)
02958 {
02959     WORD cbEventData;
02960     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, 0);
02961 
02962     <span class="comment">/*</span>
02963 <span class="comment">     * Probe arguments</span>
02964 <span class="comment">     */</span>
02965     <span class="keywordflow">try</span> {
02966         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(<a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a2">pep</a>, <span class="keyword">sizeof</span>(*<a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a2">pep</a>), <a class="code" href="../../d4/d1/userk_8h.html#a22">DATAALIGN</a>);
02967         <span class="comment">/*</span>
02968 <span class="comment">         * capture so that another thread can't change it after the probe.</span>
02969 <span class="comment">         */</span>
02970         cbEventData = <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a2">pep</a>-&gt;cbEventData;
02971         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(&amp;<a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a2">pep</a>-&gt;Data, cbEventData, <a class="code" href="../../d4/d1/userk_8h.html#a22">DATAALIGN</a>);
02972     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
02973         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
02974     }
02975 
02976     <span class="comment">/*</span>
02977 <span class="comment">     * The buffer is captured within a try/except in xxxCsEvent.</span>
02978 <span class="comment">     */</span>
02979 
02980     retval = <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a9">xxxCsEvent</a>((<a class="code" href="../../d7/d4/structtagEVENT__PACKET.html">PEVENT_PACKET</a>)<a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a2">pep</a>, cbEventData);
02981 
02982     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserEvent"</span>);
02983     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
02984 }
02985 
<a name="l02986"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a123">02986</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a123">NtUserFillWindow</a>(
02987     IN HWND hwndBrush,
02988     IN HWND hwndPaint,
02989     IN HDC hdc,
02990     IN HBRUSH hbr)
02991 {
02992 
02993     <span class="comment">//</span>
02994     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
02995     <span class="comment">//      enabled. These operations are performed in the User server API</span>
02996     <span class="comment">//      dispatcher.</span>
02997     <span class="comment">//</span>
02998 
02999     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndBrush;
03000     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndBrush;
03001 
03002     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, 0, hwndPaint);
03003 
03004     <span class="keywordflow">if</span> (hdc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03005         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03006 
03007     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a57">ValidateHWNDOPT</a>(pwndBrush, hwndBrush);
03008 
03009     <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwndBrush, &amp;tlpwndBrush);
03010 
03011     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1563">xxxFillWindow</a>(
03012             pwndBrush,
03013             pwnd,
03014             hdc,
03015             hbr);
03016 
03017     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndBrush);
03018 
03019     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserFillWindow"</span>);
03020     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
03021 }
03022 
<a name="l03023"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a124">03023</a> <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a124">NtUserGetWOWClass</a>(  <span class="comment">// wow</span>
03024     IN HINSTANCE hInstance,
03025     IN PUNICODE_STRING pString)
03026 {
03027     UNICODE_STRING strClassName;
03028 
03029     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(<a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03030 
03031     <span class="comment">/*</span>
03032 <span class="comment">     * Probe arguments</span>
03033 <span class="comment">     */</span>
03034     <span class="keywordflow">try</span> {
03035         strClassName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(pString);
03036         <a class="code" href="../../d4/d1/userk_8h.html#a61">ProbeForReadUnicodeStringBuffer</a>(strClassName);
03037     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
03038         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03039     }
03040 
03041     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1904">_GetWOWClass</a>(
03042             hInstance,
03043             strClassName.Buffer);
03044 
03045     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetWOWClass"</span>);
03046     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
03047 }
03048 
<a name="l03049"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a125">03049</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a125">NtUserGetInternalWindowPos</a>(  <span class="comment">// private</span>
03050     IN HWND hwnd,
03051     OUT LPRECT lpRect OPTIONAL,
03052     OUT LPPOINT lpPoint OPTIONAL)
03053 {
03054     WINDOWPLACEMENT wp;
03055 
03056     <span class="comment">//</span>
03057     <span class="comment">// N.B. This function has implicit window handle translation. This</span>
03058     <span class="comment">//      operation is performed in the User server API dispatcher.</span>
03059     <span class="comment">//</span>
03060 
03061     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a20">BEGINRECV_HWND_SHARED</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, 0, hwnd);
03062 
03063     <span class="comment">/*</span>
03064 <span class="comment">     * Probe arguments</span>
03065 <span class="comment">     */</span>
03066     <span class="keywordflow">try</span> {
03067         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(lpRect)) {
03068             <a class="code" href="../../d4/d1/userk_8h.html#a68">ProbeForWriteRect</a>(lpRect);
03069         }
03070         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(lpPoint)) {
03071             <a class="code" href="../../d4/d1/userk_8h.html#a67">ProbeForWritePoint</a>(lpPoint);
03072         }
03073 
03074     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
03075         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03076     }
03077 
03078     wp.length = <span class="keyword">sizeof</span>(WINDOWPLACEMENT);
03079 
03080     <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a9">_GetWindowPlacement</a>(pwnd, &amp;wp);
03081 
03082     retval = wp.showCmd;
03083     <span class="keywordflow">try</span> {
03084         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(lpRect)) {
03085             RtlCopyMemory(lpRect, &amp;wp.rcNormalPosition, sizeof (RECT));
03086         }
03087         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(lpPoint)) {
03088             RtlCopyMemory(lpPoint, &amp;wp.ptMinPosition, sizeof (POINT));
03089         }
03090 
03091     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
03092     }
03093 
03094     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetInternalWindowPos"</span>);
03095     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a21">ENDRECV_HWND_SHARED</a>();
03096 }
03097 
<a name="l03098"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a126">03098</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a126">NtUserInitTask</a>(  <span class="comment">// wow</span>
03099     IN UINT dwExpWinVer,
03100     IN DWORD dwAppCompatFlags,
03101     IN PUNICODE_STRING pstrModName,
03102     IN PUNICODE_STRING pstrBaseFileName,
03103     IN DWORD hTaskWow,
03104     IN DWORD dwHotkey,
03105     IN DWORD idTask,
03106     IN DWORD dwX,
03107     IN DWORD dwY,
03108     IN DWORD dwXSize,
03109     IN DWORD dwYSize)
03110 {
03111     UNICODE_STRING strModName;
03112     UNICODE_STRING strBaseFileName;
03113 
03114     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>, STATUS_UNSUCCESSFUL);
03115 
03116     <span class="comment">/*</span>
03117 <span class="comment">     * Make sure this is really a WOW process.</span>
03118 <span class="comment">     */</span>
03119     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()-&gt;pwpi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03120         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03121     }
03122 
03123     <span class="comment">/*</span>
03124 <span class="comment">     * Probe arguments</span>
03125 <span class="comment">     */</span>
03126     <span class="keywordflow">try</span> {
03127         strModName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(pstrModName);
03128         <span class="comment">/*</span>
03129 <span class="comment">         * pstrModName-&gt;Buffer has a UNICODE_NULL that's not counted in</span>
03130 <span class="comment">         * the length, but we want to include it for convenience. The</span>
03131 <span class="comment">         * probe routine does this.</span>
03132 <span class="comment">         */</span>
03133         <a class="code" href="../../d4/d1/userk_8h.html#a61">ProbeForReadUnicodeStringBuffer</a>(strModName);
03134 
03135         <span class="keywordflow">if</span> (pstrBaseFileName) {
03136             strBaseFileName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(pstrBaseFileName);
03137             <a class="code" href="../../d4/d1/userk_8h.html#a61">ProbeForReadUnicodeStringBuffer</a>(strBaseFileName);
03138         }
03139 
03140     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
03141         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03142     }
03143 
03144     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1193">zzzInitTask</a>(
03145             dwExpWinVer,
03146             dwAppCompatFlags,
03147             &amp;strModName,
03148             pstrBaseFileName ? &amp;strBaseFileName : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03149             hTaskWow,
03150             dwHotkey,
03151             idTask,
03152             dwX,
03153             dwY,
03154             dwXSize,
03155             dwYSize);
03156 
03157     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserInitTask"</span>);
03158     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
03159 }
03160 
<a name="l03161"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a127">03161</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a127">NtUserPostThreadMessage</a>(
03162     IN DWORD <span class="keywordtype">id</span>,
03163     IN UINT msg,
03164     IN WPARAM wParam,
03165     IN LPARAM lParam)
03166 {
03167     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent, pti;
03168 
03169     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03170 
03171     <span class="comment">/*</span>
03172 <span class="comment">     * Prevent apps from setting hi 16 bits so we can use them internally.</span>
03173 <span class="comment">     */</span>
03174     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a543">MSGFLAG_MASK</a>) {
03175         RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"Invalid message"</span>);
03176         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03177     }
03178 
03179     pti = <a class="code" href="../../d4/d1/userk_8h.html#a1201">PtiFromThreadId</a>(<span class="keywordtype">id</span>);
03180     <span class="keywordflow">if</span> (pti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03181         <span class="keyword">struct </span><a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html">tagWOWPROCESSINFO</a> *pwpi;
03182         <a class="code" href="../../d0/d8/structtagTDB.html">PTDB</a> ptdb;
03183 
03184         <span class="keywordflow">for</span> (pwpi=<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a28">gpwpiFirstWow</a>; pwpi; pwpi=pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o0">pwpiNext</a>) {
03185             <span class="keywordflow">for</span> (ptdb=pwpi-&gt;ptdbHead; ptdb; ptdb=ptdb-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o0">ptdbNext</a>) {
03186                 <span class="keywordflow">if</span> (ptdb-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o5">hTaskWow</a> == <span class="keywordtype">id</span>) {
03187                     pti=ptdb-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o3">pti</a>;
03188                     <span class="keywordflow">goto</span> PTM_DoIt;
03189                 }
03190             }
03191         }
03192 
03193         RIPERR0(ERROR_INVALID_THREAD_ID, RIP_VERBOSE, <span class="stringliteral">""</span>);
03194         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03195     }
03196 
03197 PTM_DoIt:
03198 
03199     <span class="comment">/*</span>
03200 <span class="comment">     * Should be OK if any of the following are true</span>
03201 <span class="comment">     *   threads are running on the same desktop</span>
03202 <span class="comment">     *   request is on behalf of a system process</span>
03203 <span class="comment">     *   this process owns the desktop the thread is running in</span>
03204 <span class="comment">     *   the LUIDs match</span>
03205 <span class="comment">     */</span>
03206     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
03207     <span class="keywordflow">if</span> ( !(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>) &amp;&amp;
03208          !(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a798">TIF_CSRSSTHREAD</a>) &amp;&amp;
03209          !(<a class="code" href="../../d4/d1/userk_8h.html#a1283">GetDesktopView</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>))) {
03210 
03211         LUID     luidCurrent, luidTo;
03212 
03213         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d4/d1/userk_8h.html#a961">GetProcessLuid</a>(ptiCurrent-&gt;pEThread, &amp;luidCurrent)) ||
03214             !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d4/d1/userk_8h.html#a961">GetProcessLuid</a>(pti-&gt;pEThread, &amp;luidTo)) ||
03215             !<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;luidCurrent, &amp;luidTo)) {
03216             RIPERR3(ERROR_INVALID_THREAD_ID,
03217                     RIP_WARNING,
03218                     <span class="stringliteral">"NtUserPostThreadMessage failed LUID check: msg(%lx), t1(%#p) -&gt; t2(%#p)"</span>,
03219                     <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, ptiCurrent, pti);
03220             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03221         }
03222     }
03223 
03224     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1645">_PostThreadMessage</a>(
03225             pti,
03226             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
03227             wParam,
03228             lParam);
03229 
03230     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserPostThreadMessage"</span>);
03231     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
03232 }
03233 
<a name="l03234"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a128">03234</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a128">NtUserRegisterTasklist</a>(
03235     IN HWND hwnd)
03236 {
03237 
03238     <span class="comment">//</span>
03239     <span class="comment">// N.B. This function has implicit window handle translation. This</span>
03240     <span class="comment">//      operation is performed in the User server API dispatcher.</span>
03241     <span class="comment">//</span>
03242 
03243     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a14">BEGINRECV_HWND</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, 0, hwnd);
03244 
03245     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1914">_RegisterTasklist</a>(
03246             pwnd);
03247 
03248     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserRegisterTasklist"</span>);
03249     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a15">ENDRECV_HWND</a>();
03250 }
03251 
<a name="l03252"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a129">03252</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a129">NtUserCloseClipboard</a>(
03253     VOID)
03254 {
03255     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03256 
03257     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1736">xxxCloseClipboard</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03258 
03259     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserCloseClipboard"</span>);
03260     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
03261 }
03262 
<a name="l03263"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a130">03263</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a130">NtUserEmptyClipboard</a>(
03264     VOID)
03265 {
03266     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03267 
03268     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1738">xxxEmptyClipboard</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03269 
03270     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserEmptyClipboard"</span>);
03271     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
03272 }
03273 
<a name="l03274"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a131">03274</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a131">NtUserSetClipboardData</a>(  <span class="comment">// API SetClipboardData</span>
03275     IN UINT          fmt,
03276     IN HANDLE        hData,
03277     IN <a class="code" href="../../d3/d6/structtagSETCLIPBDATA.html">PSETCLIPBDATA</a> pscd)
03278 {
03279     <a class="code" href="../../d3/d6/structtagSETCLIPBDATA.html">SETCLIPBDATA</a> scd;
03280 
03281     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03282 
03283     <span class="comment">/*</span>
03284 <span class="comment">     * Check for jobs with JOB_OBJECT_UILIMIT_WRITECLIPBOARD</span>
03285 <span class="comment">     */</span>
03286     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a383">IS_CURRENT_THREAD_RESTRICTED</a>(JOB_OBJECT_UILIMIT_WRITECLIPBOARD)) {
03287         RIPMSG0(RIP_WARNING, <span class="stringliteral">"NtUserSetClipboardData failed for restricted thread"</span>);
03288         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03289     }
03290 
03291     <span class="comment">/*</span>
03292 <span class="comment">     * Probe arguments</span>
03293 <span class="comment">     */</span>
03294     <span class="keywordflow">try</span> {
03295         scd = <a class="code" href="../../d4/d1/userk_8h.html#a58">ProbeAndReadSetClipBData</a>(pscd);
03296     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03297         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03298     }
03299 
03300     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1895">_SetClipboardData</a>(
03301             fmt,
03302             hData,
03303             scd.<a class="code" href="../../d3/d6/structtagSETCLIPBDATA.html#o0">fGlobalHandle</a>,
03304             scd.<a class="code" href="../../d3/d6/structtagSETCLIPBDATA.html#o1">fIncSerialNumber</a>);
03305 
03306     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetClipboardData"</span>);
03307     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
03308 }
03309 
<a name="l03310"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a132">03310</a> HANDLE <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a132">NtUserConvertMemHandle</a>(  <span class="comment">// worker routine, lpData not from API</span>
03311     IN LPBYTE lpData,
03312     IN UINT   cbData)
03313 {
03314     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(HANDLE, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03315 
03316     <span class="comment">/*</span>
03317 <span class="comment">     * Probe arguments</span>
03318 <span class="comment">     */</span>
03319     <span class="keywordflow">try</span> {
03320 
03321         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(lpData, cbData, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
03322 
03323     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
03324         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03325     }
03326 
03327     <span class="comment">/*</span>
03328 <span class="comment">     * lpData is client-side.</span>
03329 <span class="comment">     */</span>
03330     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1487">_ConvertMemHandle</a>(lpData, cbData);
03331 
03332     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserConvertMemHandle"</span>);
03333     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
03334 }
03335 
<a name="l03336"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a133">03336</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a133">NtUserCreateLocalMemHandle</a>(  <span class="comment">// helper routine</span>
03337     IN HANDLE hMem,
03338     OUT LPBYTE lpData OPTIONAL,
03339     IN UINT cbData,
03340     OUT PUINT lpcbNeeded OPTIONAL)
03341 {
03342     <a class="code" href="../../d6/d0/structtagCLIPDATA.html">PCLIPDATA</a> pClipData;
03343 
03344     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>, STATUS_INVALID_HANDLE);
03345 
03346     pClipData = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a6">HMValidateHandle</a>(hMem, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a242">TYPE_CLIPDATA</a>);
03347     <span class="keywordflow">if</span> (pClipData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03348         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03349 
03350     <span class="comment">/*</span>
03351 <span class="comment">     * Probe arguments</span>
03352 <span class="comment">     */</span>
03353     <span class="keywordflow">try</span> {
03354         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(lpData)) {
03355             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(lpData, cbData, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
03356         }
03357 
03358         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(lpcbNeeded)) {
03359             <a class="code" href="../../d5/d8/ex_8h.html#a51">ProbeAndWriteUlong</a>(lpcbNeeded, pClipData-&gt;<a class="code" href="../../d6/d0/structtagCLIPDATA.html#o1">cbData</a>);
03360         }
03361 
03362         <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(lpData) || cbData &lt; pClipData-&gt;<a class="code" href="../../d6/d0/structtagCLIPDATA.html#o1">cbData</a>) {
03363             retval = STATUS_BUFFER_TOO_SMALL;
03364         } <span class="keywordflow">else</span> {
03365             RtlCopyMemory(lpData, &amp;pClipData-&gt;<a class="code" href="../../d6/d0/structtagCLIPDATA.html#o2">abData</a>, pClipData-&gt;<a class="code" href="../../d6/d0/structtagCLIPDATA.html#o1">cbData</a>);
03366             retval = STATUS_SUCCESS;
03367         }
03368     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
03369         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03370     }
03371 
03372     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserCreateLocalMemHandle"</span>);
03373     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
03374 }
03375 
<a name="l03376"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a134">03376</a> HHOOK <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a134">NtUserSetWindowsHookEx</a>(
03377     IN HANDLE hmod,
03378     IN PUNICODE_STRING pstrLib OPTIONAL,
03379     IN DWORD idThread,
03380     IN <span class="keywordtype">int</span> nFilterType,
03381     IN PROC pfnFilterProc,
03382     IN DWORD dwFlags)
03383 {
03384     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiThread;
03385 
03386     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(HHOOK, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03387 
03388     <span class="keywordflow">if</span> (idThread != 0) {
03389         ptiThread = <a class="code" href="../../d4/d1/userk_8h.html#a1201">PtiFromThreadId</a>(idThread);
03390         <span class="keywordflow">if</span> (ptiThread == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03391             RIPERR0(ERROR_INVALID_PARAMETER, RIP_VERBOSE, <span class="stringliteral">""</span>);
03392             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03393         }
03394     } <span class="keywordflow">else</span> {
03395         ptiThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03396     }
03397 
03398     <span class="comment">/*</span>
03399 <span class="comment">     * Probe pstrLib in GetHmodTableIndex().</span>
03400 <span class="comment">     */</span>
03401     retval = (HHOOK)<a class="code" href="../../d4/d1/userk_8h.html#a1906">zzzSetWindowsHookEx</a>(
03402             hmod,
03403             pstrLib,
03404             ptiThread,
03405             nFilterType,
03406             pfnFilterProc,
03407             <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
03408     retval = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>((PVOID)retval);
03409 
03410     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetWindowsHookEx"</span>);
03411     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
03412 }
03413 
<a name="l03414"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a135">03414</a> HWINEVENTHOOK <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a135">NtUserSetWinEventHook</a>(
03415     IN DWORD           eventMin,
03416     IN DWORD           eventMax,
03417     IN HMODULE         hmodWinEventProc,
03418     IN PUNICODE_STRING pstrLib OPTIONAL,
03419     IN WINEVENTPROC    pfnWinEventProc,
03420     IN DWORD           idEventProcess,
03421     IN DWORD           idEventThread,
03422     IN DWORD           dwFlags)
03423 {
03424     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(HWINEVENTHOOK, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03425 
03426     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a46">TESTFLAGS</a>(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>, WINEVENT_VALID);
03427 
03428     <span class="comment">/*</span>
03429 <span class="comment">     * Probe pstrLib in GetHmodTableIndex().</span>
03430 <span class="comment">     */</span>
03431     retval = (HWINEVENTHOOK)<a class="code" href="../../d5/d7/kernel_2winable_8c.html#a12">_SetWinEventHook</a>(
03432             eventMin,
03433             eventMax,
03434             hmodWinEventProc,
03435             pstrLib,
03436             pfnWinEventProc,
03437             (HANDLE)LongToHandle( idEventProcess ),
03438             idEventThread,
03439             <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
03440     retval = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>((PVOID)retval);
03441 
03442     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetWinEventHook"</span>);
03443     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
03444 }
03445 
<a name="l03446"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a136">03446</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a136">NtUserUnhookWinEvent</a>(
03447     IN HWINEVENTHOOK hWinEventUnhook)
03448 {
03449     <a class="code" href="../../d8/d4/structtagEVENTHOOK.html">PEVENTHOOK</a> peh;
03450 
03451     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03452 
03453     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a68">ValidateHWINEVENTHOOK</a>(peh, hWinEventUnhook);
03454 
03455     retval = <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a13">_UnhookWinEvent</a>(peh);
03456 
03457     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserUnhookWinEvent"</span>);
03458     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
03459 }
03460 
<a name="l03461"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a137">03461</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a137">NtUserNotifyWinEvent</a>(
03462     IN DWORD event,
03463     IN HWND  hwnd,
03464     IN LONG  idObject,
03465     IN LONG  idChild)
03466 {
03467     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a30">BEGINRECV_HWNDLOCK_VOID</a>(hwnd);
03468 
03469     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
03470         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a43">MSGERROR_VOID</a>();
03471     }
03472     <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(event, pwnd, idObject, idChild, <a class="code" href="../../d4/d1/userk_8h.html#a610">WEF_USEPWNDTHREAD</a>);
03473 
03474     <a class="code" href="../../d4/d1/userk_8h.html#a94">TRACEVOID</a>(<span class="stringliteral">"NtUserNotifyWinEvent"</span>);
03475     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a41">ENDRECV_HWNDLOCK_VOID</a>();
03476 }
03477 
03478 
<a name="l03479"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a138">03479</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a138">NtUserGetGUIThreadInfo</a>(  <span class="comment">// API GetGUIThreadInfo</span>
03480     IN DWORD idThread,
03481     IN OUT PGUITHREADINFO pgui)
03482 {
03483     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiThread;
03484     GUITHREADINFO gui;
03485 
03486     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03487 
03488     <span class="keywordflow">if</span> (idThread) {
03489         ptiThread = <a class="code" href="../../d4/d1/userk_8h.html#a1201">PtiFromThreadId</a>(idThread);
03490         <span class="keywordflow">if</span> (ptiThread == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03491             RIPERR0(ERROR_INVALID_PARAMETER, RIP_VERBOSE, <span class="stringliteral">"Bad thread id"</span>);
03492             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03493         }
03494     } <span class="keywordflow">else</span> {
03495         ptiThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03496     }
03497 
03498     <span class="comment">/*</span>
03499 <span class="comment">     * Probe arguments and copy results</span>
03500 <span class="comment">     * C2: test pti &amp; current thread on same desktop within _GetGUIThreadInfo</span>
03501 <span class="comment">     */</span>
03502     <span class="keywordflow">try</span> {
03503         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(pgui, <span class="keyword">sizeof</span>(*pgui), <a class="code" href="../../d4/d1/userk_8h.html#a22">DATAALIGN</a>);
03504         gui.cbSize = pgui-&gt;cbSize;
03505     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03506         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03507     }
03508 
03509     retval = <a class="code" href="../../d6/d7/winable2_8c.html#a0">_GetGUIThreadInfo</a>(ptiThread, &amp;gui);
03510     <span class="keywordflow">if</span> (retval) {
03511         <span class="keywordflow">try</span> {
03512             *pgui = gui;
03513         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03514             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03515         }
03516     }
03517 
03518     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetGUIThreadInfo"</span>);
03519     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
03520 }
03521 
03522 <span class="comment">/*****************************************************************************\</span>
03523 <span class="comment">* GetTitleBarInfo</span>
03524 <span class="comment">*</span>
03525 <span class="comment">* Gets information about the title bar</span>
03526 <span class="comment">\*****************************************************************************/</span>
<a name="l03527"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a139">03527</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a139">NtUserGetTitleBarInfo</a>(IN HWND hwnd, IN OUT PTITLEBARINFO ptbi)
03528 {
03529     TITLEBARINFO tbi;
03530 
03531     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, hwnd);
03532 
03533     <span class="comment">/*</span>
03534 <span class="comment">     * Probe arguments and copy out results</span>
03535 <span class="comment">     */</span>
03536     <span class="keywordflow">try</span> {
03537         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(ptbi, <span class="keyword">sizeof</span>(*ptbi), <a class="code" href="../../d4/d1/userk_8h.html#a22">DATAALIGN</a>);
03538         tbi.cbSize = ptbi-&gt;cbSize;
03539     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03540         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03541     }
03542     <span class="comment">/*</span>
03543 <span class="comment">     * Get the titlebar info</span>
03544 <span class="comment">     */</span>
03545     retval = <a class="code" href="../../d6/d7/winable2_8c.html#a1">xxxGetTitleBarInfo</a>(pwnd, &amp;tbi);
03546     <span class="keywordflow">if</span> (retval) {
03547         <span class="keywordflow">try</span> {
03548             *ptbi = tbi;
03549         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03550             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03551         }
03552     }
03553 
03554     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetTitleBarInfo"</span>);
03555     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
03556 }
03557 
03558 
03559 <span class="comment">/*****************************************************************************\</span>
03560 <span class="comment">* NtUserGetComboBoxInfo</span>
03561 <span class="comment">*</span>
03562 <span class="comment">* Gets information about the combo box</span>
03563 <span class="comment">\*****************************************************************************/</span>
<a name="l03564"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a140">03564</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a140">NtUserGetComboBoxInfo</a>(IN HWND hwnd, IN OUT PCOMBOBOXINFO pcbi)
03565 {
03566     COMBOBOXINFO cbi;
03567 
03568     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a20">BEGINRECV_HWND_SHARED</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, hwnd);
03569 
03570     <span class="comment">/*</span>
03571 <span class="comment">     * Probe arguments and copy out results</span>
03572 <span class="comment">     */</span>
03573     <span class="keywordflow">try</span> {
03574         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(pcbi, <span class="keyword">sizeof</span>(*pcbi), <a class="code" href="../../d4/d1/userk_8h.html#a22">DATAALIGN</a>);
03575         cbi.cbSize = pcbi-&gt;cbSize;
03576     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03577         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03578     }
03579 
03580         <span class="comment">/*</span>
03581 <span class="comment">         * Get the combobox info</span>
03582 <span class="comment">         */</span>
03583     retval = <a class="code" href="../../d6/d7/winable2_8c.html#a6">_GetComboBoxInfo</a>(pwnd, &amp;cbi);
03584 
03585     <span class="keywordflow">if</span> (retval) {
03586         <span class="keywordflow">try</span> {
03587             *pcbi = cbi;
03588         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03589              <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03590         }
03591     }
03592 
03593     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetComboBoxInfo"</span>);
03594     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a21">ENDRECV_HWND_SHARED</a>();
03595 }
03596 
03597 
03598 <span class="comment">/*****************************************************************************\</span>
03599 <span class="comment">* NtUserGetListBoxInfo</span>
03600 <span class="comment">*</span>
03601 <span class="comment">* Gets information about the list box</span>
03602 <span class="comment">\*****************************************************************************/</span>
<a name="l03603"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a141">03603</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a141">NtUserGetListBoxInfo</a>(IN HWND hwnd)
03604 {
03605     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a20">BEGINRECV_HWND_SHARED</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, 0, hwnd);
03606 
03607     <span class="comment">/*</span>
03608 <span class="comment">     * Get the listbox info</span>
03609 <span class="comment">     */</span>
03610     retval = <a class="code" href="../../d6/d7/winable2_8c.html#a7">_GetListBoxInfo</a>(pwnd);
03611 
03612     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetListBoxInfo"</span>);
03613     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a21">ENDRECV_HWND_SHARED</a>();
03614 }
03615 
03616 
03617 <span class="comment">/*****************************************************************************\</span>
03618 <span class="comment">* GetCursorInfo</span>
03619 <span class="comment">*</span>
03620 <span class="comment">* Gets information about the global cursor</span>
03621 <span class="comment">\*****************************************************************************/</span>
<a name="l03622"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a142">03622</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a142">NtUserGetCursorInfo</a>(IN OUT PCURSORINFO pci)
03623 {
03624     CURSORINFO ci = {0};
03625 
03626     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03627 
03628     ci.ptScreenPos = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor;
03629     ci.flags = 0;
03630 
03631     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a84">gpcurPhysCurrent</a>)
03632         ci.flags |= CURSOR_SHOWING;
03633 
03634     <span class="comment">/*</span>
03635 <span class="comment">     * Get the current LOGICAL cursor (the one apps actually see from LoadCursor())</span>
03636 <span class="comment">     */</span>
03637     ci.hCursor = (HCURSOR)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a83">gpcurLogCurrent</a>);
03638 
03639     retval = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03640 
03641     <span class="comment">/*</span>
03642 <span class="comment">     * Probe arguments and copy out result</span>
03643 <span class="comment">     */</span>
03644     <span class="keywordflow">try</span> {
03645         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(pci, <span class="keyword">sizeof</span>(*pci), <a class="code" href="../../d4/d1/userk_8h.html#a22">DATAALIGN</a>);
03646         <span class="keywordflow">if</span> (pci-&gt;cbSize != <span class="keyword">sizeof</span>(CURSORINFO)) {
03647             RIPERR1(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"CURSORINFO.cbSize %d is wrong"</span>, pci-&gt;cbSize);
03648             retval = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03649         } <span class="keywordflow">else</span> {
03650             *pci = ci;
03651         }
03652 
03653     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03654         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03655     }
03656 
03657     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetCursorInfo"</span>);
03658     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
03659 }
03660 
03661 <span class="comment">/*****************************************************************************\</span>
03662 <span class="comment">* GetScrollBarInfo</span>
03663 <span class="comment">*</span>
03664 <span class="comment">* Gets information about the scroll bar</span>
03665 <span class="comment">\*****************************************************************************/</span>
<a name="l03666"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a143">03666</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a143">NtUserGetScrollBarInfo</a>(IN HWND hwnd, IN LONG idObject, IN OUT PSCROLLBARINFO psbi)
03667 {
03668     SCROLLBARINFO sbi;
03669 
03670     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a20">BEGINRECV_HWND_SHARED</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, hwnd);
03671 
03672     <span class="comment">/*</span>
03673 <span class="comment">     * Probe arguments and copy out results</span>
03674 <span class="comment">     */</span>
03675     <span class="keywordflow">try</span> {
03676         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(psbi, <span class="keyword">sizeof</span>(*psbi), <a class="code" href="../../d4/d1/userk_8h.html#a22">DATAALIGN</a>);
03677         sbi.cbSize = psbi-&gt;cbSize;
03678     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03679         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03680     }
03681     <span class="comment">/*</span>
03682 <span class="comment">     * Get the scrollbar info</span>
03683 <span class="comment">     */</span>
03684     retval = <a class="code" href="../../d6/d7/winable2_8c.html#a2">_GetScrollBarInfo</a>(pwnd, idObject, &amp;sbi);
03685 
03686     <span class="keywordflow">if</span> (retval) {
03687         <span class="keywordflow">try</span> {
03688             *psbi = sbi;
03689         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03690             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03691         }
03692     }
03693 
03694     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetScrollBarInfo"</span>);
03695     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a21">ENDRECV_HWND_SHARED</a>();
03696 }
03697 
<a name="l03698"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a144">03698</a> HWND <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a144">NtUserGetAncestor</a>(IN HWND hwndChild, IN UINT gaFlags)
03699 {
03700     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a20">BEGINRECV_HWND_SHARED</a>(HWND, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hwndChild);
03701 
03702     <span class="keywordflow">if</span> ((gaFlags &lt; GA_MIN) || (gaFlags &gt; GA_MAX)) {
03703         RIPERR3(ERROR_INVALID_PARAMETER, RIP_WARNING,
03704                 <span class="stringliteral">"NtUserGetAncestor: Invalid gaFlags parameter %d, not %d - %d"</span>,
03705                  gaFlags, GA_MIN, GA_MAX);
03706         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03707     }
03708     retval = (HWND)<a class="code" href="../../d6/d7/winable2_8c.html#a3">_GetAncestor</a>(pwnd, gaFlags);
03709     retval = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>((PVOID)retval);
03710 
03711     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetAncestor"</span>);
03712     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a21">ENDRECV_HWND_SHARED</a>();
03713 }
03714 
<a name="l03715"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a145">03715</a> HWND <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a145">NtUserRealChildWindowFromPoint</a>(IN HWND hwndParent, IN POINT pt)
03716 {
03717     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a20">BEGINRECV_HWND_SHARED</a>(HWND, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hwndParent);
03718 
03719     retval = (HWND)<a class="code" href="../../d6/d7/winable2_8c.html#a4">_RealChildWindowFromPoint</a>(pwnd, pt);
03720     retval = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>((PVOID)retval);
03721 
03722     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserRealChildWindowFromPoint"</span>);
03723     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a21">ENDRECV_HWND_SHARED</a>();
03724 }
03725 
<a name="l03726"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a146">03726</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a146">NtUserGetAltTabInfo</a>(
03727     IN HWND hwnd,
03728     IN <span class="keywordtype">int</span> iItem,
03729     IN OUT PALTTABINFO pati,
03730     OUT LPWSTR lpszItemText,
03731     IN UINT cchItemText OPTIONAL,
03732     BOOL bAnsi)
03733 {
03734     ALTTABINFO ati;
03735 
03736     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a22">BEGINRECV_HWNDOPT_SHARED</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, hwnd);
03737 
03738     <span class="comment">/*</span>
03739 <span class="comment">     * If the specified window is not a switch window, then fail the call.</span>
03740 <span class="comment">     * It's a dumb API we got from Windows 95, I am hereby allowing NULL hwnd.</span>
03741 <span class="comment">     */</span>
03742     <span class="keywordflow">if</span> (pwnd &amp;&amp; (pwnd != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a>)) {
03743         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(ERROR_INVALID_WINDOW_HANDLE);
03744     }
03745 
03746     <span class="comment">/*</span>
03747 <span class="comment">     * Probe arguments</span>
03748 <span class="comment">     */</span>
03749     <span class="keywordflow">try</span> {
03750         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(pati, <span class="keyword">sizeof</span>(*pati), <a class="code" href="../../d4/d1/userk_8h.html#a22">DATAALIGN</a>);
03751         <span class="keywordflow">if</span> (bAnsi) {
03752             <a class="code" href="../../d4/d1/userk_8h.html#a25">ProbeForWriteBuffer</a>((LPSTR)lpszItemText, cchItemText, <a class="code" href="../../d4/d1/userk_8h.html#a23">CHARALIGN</a>);
03753         } <span class="keywordflow">else</span> {
03754             <a class="code" href="../../d4/d1/userk_8h.html#a25">ProbeForWriteBuffer</a>(lpszItemText, cchItemText, <a class="code" href="../../d4/d1/userk_8h.html#a23">CHARALIGN</a>);
03755         }
03756 
03757         <span class="comment">/*</span>
03758 <span class="comment">         * Validate AltTabInfo structure</span>
03759 <span class="comment">         */</span>
03760         <span class="keywordflow">if</span> (pati-&gt;cbSize != <span class="keyword">sizeof</span>(ALTTABINFO)) {
03761             RIPERR1(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"ALTTABINFO.cbSize %d is wrong"</span>, pati-&gt;cbSize);
03762             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03763         }
03764     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03765         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03766     }
03767 
03768     <span class="comment">/*</span>
03769 <span class="comment">     * Get the alt tab info</span>
03770 <span class="comment">     */</span>
03771     ati.cbSize = <span class="keyword">sizeof</span>(ALTTABINFO);
03772     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1964">_GetAltTabInfo</a>(iItem, &amp;ati, lpszItemText, cchItemText, bAnsi);
03773     <span class="keywordflow">if</span> (retval) {
03774         <span class="keywordflow">try</span> {
03775             *pati = ati;
03776         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03777             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03778         }
03779     }
03780 
03781     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetAltTabInfo"</span>);
03782     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a23">ENDRECV_HWNDOPT_SHARED</a>();
03783 }
03784 
<a name="l03785"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a147">03785</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a147">NtUserGetMenuBarInfo</a>(
03786     IN HWND hwnd,
03787     IN <span class="keywordtype">long</span> idObject,
03788     IN <span class="keywordtype">long</span> idItem,
03789     IN OUT PMENUBARINFO pmbi)
03790 {
03791     MENUBARINFO mbi;
03792 
03793     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, hwnd);
03794 
03795     <span class="comment">/*</span>
03796 <span class="comment">     * Probe arguments</span>
03797 <span class="comment">     */</span>
03798     <span class="keywordflow">try</span> {
03799 <span class="preprocessor">#if defined(_X86_)</span>
03800 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(pmbi, <span class="keyword">sizeof</span>(*pmbi), <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
03801 <span class="preprocessor">#else</span>
03802 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(pmbi, <span class="keyword">sizeof</span>(*pmbi), <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
03803 <span class="preprocessor">#endif</span>
03804 <span class="preprocessor"></span>        mbi.cbSize = pmbi-&gt;cbSize;
03805     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03806         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03807     }
03808 
03809     <span class="comment">/*</span>
03810 <span class="comment">     * Get the menubar info</span>
03811 <span class="comment">     */</span>
03812     retval = <a class="code" href="../../d6/d7/winable2_8c.html#a5">xxxGetMenuBarInfo</a>(pwnd, idObject, idItem, &amp;mbi);
03813 
03814     <span class="keywordflow">if</span> (retval) {
03815         <span class="keywordflow">try</span> {
03816             *pmbi = mbi;
03817         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03818             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03819         }
03820     }
03821 
03822     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetMenuBarInfo"</span>);
03823     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
03824 }
03825 
<a name="l03826"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a148">03826</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a148">NtUserSetInternalWindowPos</a>(  <span class="comment">// private SetInternalWindowPos</span>
03827     IN HWND hwnd,
03828     IN UINT cmdShow,
03829     IN CONST RECT *lpRect,
03830     IN CONST POINT *lpPoint)
03831 {
03832     RECT rc;
03833     POINT pt;
03834 
03835     <span class="comment">//</span>
03836     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
03837     <span class="comment">//      enabled. These operations are performed in the User server API</span>
03838     <span class="comment">//      dispatcher.</span>
03839     <span class="comment">//</span>
03840 
03841     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, 0, hwnd);
03842 
03843     <span class="comment">/*</span>
03844 <span class="comment">     * Probe arguments</span>
03845 <span class="comment">     */</span>
03846     <span class="keywordflow">try</span> {
03847         rc = <a class="code" href="../../d4/d1/userk_8h.html#a31">ProbeAndReadRect</a>(lpRect);
03848         pt = <a class="code" href="../../d4/d1/userk_8h.html#a29">ProbeAndReadPoint</a>(lpPoint);
03849     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
03850         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03851     }
03852 
03853     retval = <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a13">xxxSetInternalWindowPos</a>(
03854             pwnd,
03855             cmdShow,
03856             &amp;rc,
03857             &amp;pt);
03858 
03859     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetInternalWindowPos"</span>);
03860     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
03861 }
03862 
03863 
<a name="l03864"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a149">03864</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a149">NtUserChangeClipboardChain</a>(
03865     IN HWND hwndRemove,
03866     IN HWND hwndNewNext)
03867 {
03868 
03869     <span class="comment">//</span>
03870     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
03871     <span class="comment">//      enabled. These operations are performed in the User server API</span>
03872     <span class="comment">//      dispatcher.</span>
03873     <span class="comment">//</span>
03874 
03875     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndNewNext;
03876     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndNewNext;
03877 
03878     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, 0, hwndRemove);
03879 
03880     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a57">ValidateHWNDOPT</a>(pwndNewNext, hwndNewNext);
03881 
03882     <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwndNewNext, &amp;tlpwndNewNext);
03883     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1743">xxxChangeClipboardChain</a>(
03884             pwnd,
03885             pwndNewNext);
03886 
03887     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndNewNext);
03888 
03889     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserChangeClipboardChain"</span>);
03890     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
03891 }
03892 
<a name="l03893"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a150">03893</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a150">NtUserCheckMenuItem</a>(
03894     IN HMENU hmenu,
03895     IN UINT wIDCheckItem,
03896     IN UINT wCheck)
03897 {
03898     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu;
03899 
03900     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1);
03901 
03902     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a46">TESTFLAGS</a>(wCheck, MF_VALID);
03903 
03904     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a62">ValidateHMENUMODIFY</a>(pmenu, hmenu);
03905 
03906     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1888">_CheckMenuItem</a>(
03907             pmenu,
03908             wIDCheckItem,
03909             wCheck);
03910 
03911     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserCheckMenuItem"</span>);
03912     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
03913 }
03914 
<a name="l03915"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a151">03915</a> HWND <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a151">NtUserChildWindowFromPointEx</a>(
03916     IN HWND hwndParent,
03917     IN POINT point,
03918     IN UINT flags)
03919 {
03920 
03921     <span class="comment">//</span>
03922     <span class="comment">// N.B. This function has implicit window handle translation. This</span>
03923     <span class="comment">//      operation is performed in the User server API dispatcher.</span>
03924     <span class="comment">//</span>
03925 
03926     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a14">BEGINRECV_HWND</a>(HWND, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hwndParent);
03927 
03928     retval = (HWND)<a class="code" href="../../d9/d8/winwhere_8c.html#a1">_ChildWindowFromPointEx</a>(pwnd, point, flags);
03929     retval = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>((PVOID)retval);
03930 
03931     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserChildWindowFromPointEx"</span>);
03932     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a15">ENDRECV_HWND</a>();
03933 }
03934 
<a name="l03935"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a152">03935</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a152">NtUserClipCursor</a>(  <span class="comment">// API ClipCursor</span>
03936     IN CONST RECT *lpRect OPTIONAL)
03937 {
03938     RECT rc;
03939 
03940     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03941 
03942     <span class="comment">/*</span>
03943 <span class="comment">     * Probe arguments</span>
03944 <span class="comment">     */</span>
03945     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(lpRect)) {
03946         <span class="keywordflow">try</span> {
03947             rc = <a class="code" href="../../d4/d1/userk_8h.html#a31">ProbeAndReadRect</a>(lpRect);
03948             lpRect = &amp;rc;
03949         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03950             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03951         }
03952     }
03953 
03954     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1788">zzzClipCursor</a>(lpRect);
03955 
03956     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserClipCursor"</span>);
03957     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
03958 }
03959 
<a name="l03960"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a153">03960</a> HACCEL <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a153">NtUserCreateAcceleratorTable</a>(  <span class="comment">// API CreateAcceleratorTableA/W</span>
03961     IN LPACCEL paccel,
03962     IN INT cAccel)
03963 {
03964     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(HACCEL, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03965 
03966     <span class="keywordflow">if</span> (cAccel &lt;= 0) {
03967         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03968     }
03969 
03970     <span class="comment">/*</span>
03971 <span class="comment">     * Probe arguments</span>
03972 <span class="comment">     */</span>
03973     <span class="keywordflow">try</span> {
03974         <a class="code" href="../../d4/d1/userk_8h.html#a24">ProbeForReadBuffer</a>(paccel, cAccel, <a class="code" href="../../d4/d1/userk_8h.html#a22">DATAALIGN</a>);
03975     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03976         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
03977     }
03978 
03979     retval = (HACCEL)<a class="code" href="../../d4/d1/userk_8h.html#a1783">_CreateAcceleratorTable</a>(
03980             paccel,
03981             cAccel * <span class="keyword">sizeof</span>(ACCEL));
03982     retval = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>((PVOID)retval);
03983 
03984     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserCreateAcceleratorTable"</span>);
03985     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
03986 }
03987 
<a name="l03988"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a154">03988</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a154">NtUserDeleteMenu</a>(
03989     IN HMENU hmenu,
03990     IN UINT nPosition,
03991     IN UINT dwFlags)
03992 {
03993     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu;
03994     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpmenu;
03995 
03996     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03997 
03998     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a46">TESTFLAGS</a>(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>, MF_VALID);
03999 
04000     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a62">ValidateHMENUMODIFY</a>(pmenu, hmenu);
04001     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pmenu, &amp;tlpmenu);
04002     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1595">xxxDeleteMenu</a>(
04003             pmenu,
04004             nPosition,
04005             <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
04006     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpmenu);
04007 
04008     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserDeleteMenu"</span>);
04009     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
04010 }
04011 
<a name="l04012"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a155">04012</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a155">NtUserDestroyAcceleratorTable</a>(
04013     IN HACCEL hAccel)
04014 {
04015     <a class="code" href="../../d0/d8/structtagACCELTABLE.html">LPACCELTABLE</a> pat;
04016 
04017     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04018 
04019     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a63">ValidateHACCEL</a>(pat, hAccel);
04020 
04021     <span class="comment">/*</span>
04022 <span class="comment">     * Mark the object for destruction - if it says it's ok to free,</span>
04023 <span class="comment">     * then free it.</span>
04024 <span class="comment">     */</span>
04025     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a971">HMMarkObjectDestroy</a>(pat))
04026         <a class="code" href="../../d4/d1/userk_8h.html#a970">HMFreeObject</a>(pat);
04027     retval = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04028 
04029     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserDestroyAcceleratorTable"</span>);
04030     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
04031 }
04032 
<a name="l04033"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a156">04033</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a156">NtUserDestroyCursor</a>(
04034     IN HCURSOR hcurs,
04035     IN DWORD cmd)
04036 {
04037     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcurs;
04038 
04039     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04040 
04041     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a64">ValidateHCURSOR</a>(pcurs, hcurs);
04042 
04043     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1782">_DestroyCursor</a>(
04044             pcurs, cmd);
04045 
04046     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserDestroyCursor"</span>);
04047     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
04048 }
04049 
<a name="l04050"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a157">04050</a> HANDLE <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a157">NtUserGetClipboardData</a>(  <span class="comment">// API GetClipboardData</span>
04051     IN  UINT          fmt,
04052     OUT <a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html">PGETCLIPBDATA</a> pgcd)
04053 {
04054     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>    ptiCurrent;
04055     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>             tlpwinsta;
04056     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
04057     <a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html">GETCLIPBDATA</a>   gcd;
04058 
04059     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(HANDLE, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04060 
04061     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
04062     <span class="keywordflow">if</span> ((pwinsta = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a14">CheckClipboardAccess</a>()) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
04063         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
04064 
04065     <span class="comment">/*</span>
04066 <span class="comment">     * Check for jobs with JOB_OBJECT_UILIMIT_READCLIPBOARD</span>
04067 <span class="comment">     */</span>
04068     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a382">IS_THREAD_RESTRICTED</a>(ptiCurrent, JOB_OBJECT_UILIMIT_READCLIPBOARD)) {
04069         RIPERR0(ERROR_ACCESS_DENIED, RIP_WARNING, <span class="stringliteral">"NtUserGetClipboardData failed for restricted thread"</span>);
04070         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
04071     }
04072 
04073     <a class="code" href="../../d4/d1/userk_8h.html#a131">ThreadLockWinSta</a>(ptiCurrent, pwinsta, &amp;tlpwinsta);
04074 
04075     <span class="comment">/*</span>
04076 <span class="comment">     * Start out assuming the format requested</span>
04077 <span class="comment">     * will be the format returned.</span>
04078 <span class="comment">     */</span>
04079     gcd.<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o0">uFmtRet</a> = fmt;
04080 
04081     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1739">xxxGetClipboardData</a>(pwinsta, fmt, &amp;gcd);
04082 
04083     <span class="comment">/*</span>
04084 <span class="comment">     * Probe arguments</span>
04085 <span class="comment">     */</span>
04086     <span class="keywordflow">try</span> {
04087         <a class="code" href="../../d5/d8/ex_8h.html#a54">ProbeAndWriteStructure</a>(pgcd, gcd, <a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html">GETCLIPBDATA</a>);
04088     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
04089         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
04090     }
04091 
04092     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a33">CLEANUPRECV</a>();
04093     <a class="code" href="../../d4/d1/userk_8h.html#a135">ThreadUnlockWinSta</a>(ptiCurrent, &amp;tlpwinsta);
04094 
04095     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetClipboardData"</span>);
04096     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
04097 
04098 }
04099 
<a name="l04100"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a158">04100</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a158">NtUserDestroyMenu</a>(
04101     IN HMENU hmenu)
04102 {
04103     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu;
04104 
04105     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04106 
04107     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a62">ValidateHMENUMODIFY</a>(pmenu, hmenu);
04108 
04109     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1887">_DestroyMenu</a>(pmenu);
04110 
04111     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserDestroyMenu"</span>);
04112     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
04113 }
04114 
<a name="l04115"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a159">04115</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a159">NtUserDestroyWindow</a>(
04116     IN HWND hwnd)
04117 {
04118 
04119     <span class="comment">//</span>
04120     <span class="comment">// N.B. This function has implicit window handle translation. This</span>
04121     <span class="comment">//      operation is performed in the User server API dispatcher.</span>
04122     <span class="comment">//</span>
04123 
04124     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a14">BEGINRECV_HWND</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, 0, hwnd);
04125 
04126     retval  = <a class="code" href="../../d4/d1/userk_8h.html#a1575">xxxDestroyWindow</a>(pwnd);
04127 
04128     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserDestroyWindow"</span>);
04129     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a15">ENDRECV_HWND</a>();
04130 }
04131 
<a name="l04132"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a160">04132</a> LRESULT <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a160">NtUserDispatchMessage</a>(  <span class="comment">// API DispatchMessageA/W</span>
04133     IN CONST MSG *pmsg)
04134 {
04135     MSG <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
04136 
04137     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(LRESULT, 0);
04138 
04139     <span class="comment">/*</span>
04140 <span class="comment">     * Probe arguments</span>
04141 <span class="comment">     */</span>
04142     <span class="keywordflow">try</span> {
04143         <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> = <a class="code" href="../../d4/d1/userk_8h.html#a33">ProbeAndReadMessage</a>(pmsg);
04144     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
04145         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
04146     }
04147 
04148     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1640">xxxDispatchMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>);
04149 
04150     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserDispatchMessage"</span>);
04151     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
04152 }
04153 
<a name="l04154"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a161">04154</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a161">NtUserEnableMenuItem</a>(
04155     IN HMENU hMenu,
04156     IN UINT wIDEnableItem,
04157     IN UINT wEnable)
04158 {
04159     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu;
04160     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlmenu;
04161 
04162     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, -1);
04163 
04164     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a46">TESTFLAGS</a>(wEnable, MF_VALID);
04165 
04166     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a62">ValidateHMENUMODIFY</a>(pmenu, hMenu);
04167 
04168     <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pmenu, &amp;tlmenu);
04169     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1889">xxxEnableMenuItem</a>(
04170             pmenu,
04171             wIDEnableItem,
04172             wEnable);
04173     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlmenu);
04174 
04175     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserEnableMenuItem"</span>);
04176     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
04177 }
04178 
<a name="l04179"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a162">04179</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a162">NtUserAttachThreadInput</a>(
04180     IN DWORD idAttach,
04181     IN DWORD idAttachTo,
04182     IN BOOL fAttach)
04183 {
04184     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiAttach;
04185     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiAttachTo;
04186 
04187     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04188 
04189     <span class="comment">/*</span>
04190 <span class="comment">     * Always must attach or detach from a real thread id.</span>
04191 <span class="comment">     */</span>
04192     <span class="keywordflow">if</span> ((ptiAttach = <a class="code" href="../../d4/d1/userk_8h.html#a1201">PtiFromThreadId</a>(idAttach)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04193         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
04194     }
04195     <span class="keywordflow">if</span> ((ptiAttachTo = <a class="code" href="../../d4/d1/userk_8h.html#a1201">PtiFromThreadId</a>(idAttachTo)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04196         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
04197     }
04198 
04199     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1202">zzzAttachThreadInput</a>(
04200             ptiAttach,
04201             ptiAttachTo,
04202             fAttach);
04203 
04204     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserAttachThreadInput"</span>);
04205     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
04206 }
04207 
<a name="l04208"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a163">04208</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a163">NtUserGetWindowPlacement</a>(  <span class="comment">// API GetWindowPlacement</span>
04209     IN HWND hwnd,
04210     OUT PWINDOWPLACEMENT pwp)
04211 {
04212 
04213     <span class="comment">//</span>
04214     <span class="comment">// N.B. This function has implicit window handle translation. This</span>
04215     <span class="comment">//      operation is performed in the User server API dispatcher.</span>
04216     <span class="comment">//</span>
04217 
04218     <span class="comment">/*</span>
04219 <span class="comment">     * Note -- this routine updates the checkpoint, so it needs exclusive</span>
04220 <span class="comment">     * use of the crit sect.</span>
04221 <span class="comment">     */</span>
04222 
04223     WINDOWPLACEMENT wp;
04224     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a14">BEGINRECV_HWND</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, 0, hwnd);
04225 
04226     <span class="comment">/*</span>
04227 <span class="comment">     * Probe arguments</span>
04228 <span class="comment">     */</span>
04229     <span class="keywordflow">try</span> {
04230         <a class="code" href="../../d4/d1/userk_8h.html#a77">ProbeForWriteWindowPlacement</a>(pwp);
04231         wp.length = pwp-&gt;length;
04232 <span class="preprocessor">#ifdef LATER</span>
04233 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (pwp-&gt;length != <span class="keyword">sizeof</span>(WINDOWPLACEMENT)) {
04234             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>)) {
04235                 RIPERR1(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"GetWindowPlacement: invalid length %lX"</span>, pwp-&gt;length);
04236                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
04237             } <span class="keywordflow">else</span> {
04238                 RIPMSG1(RIP_WARNING, <span class="stringliteral">"GetWindowPlacement: invalid length %lX"</span>, pwp-&gt;length);
04239                 pwp-&gt;length = <span class="keyword">sizeof</span>(WINDOWPLACEMENT);
04240             }
04241         }
04242 <span class="preprocessor">#endif</span>
04243 <span class="preprocessor"></span>
04244     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
04245         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
04246     }
04247 
04248     retval = <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a9">_GetWindowPlacement</a>(pwnd, &amp;wp);
04249 
04250     <span class="keywordflow">try</span> {
04251         RtlCopyMemory(pwp, &amp;wp, <span class="keyword">sizeof</span> (WINDOWPLACEMENT));
04252     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
04253         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
04254     }
04255 
04256     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetWindowPlacement"</span>);
04257     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a15">ENDRECV_HWND</a>();
04258 }
04259 
<a name="l04260"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a164">04260</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a164">NtUserSetWindowPlacement</a>(  <span class="comment">// API SetWindowPlacement</span>
04261     IN HWND hwnd,
04262     IN CONST WINDOWPLACEMENT *pwp)
04263 {
04264     WINDOWPLACEMENT wp;
04265 
04266     <span class="comment">//</span>
04267     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
04268     <span class="comment">//      enabled. These operations are performed in the User server API</span>
04269     <span class="comment">//      dispatcher.</span>
04270     <span class="comment">//</span>
04271 
04272     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a26">BEGINRECV_HWNDLOCK_ND</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, hwnd);
04273 
04274     <span class="comment">/*</span>
04275 <span class="comment">     * Probe arguments</span>
04276 <span class="comment">     */</span>
04277     <span class="keywordflow">try</span> {
04278         wp = <a class="code" href="../../d4/d1/userk_8h.html#a35">ProbeAndReadWindowPlacement</a>(pwp);
04279     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
04280         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
04281     }
04282 
04283     <span class="keywordflow">if</span> (wp.length != <span class="keyword">sizeof</span>(WINDOWPLACEMENT)) {
04284         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a105">Is400Compat</a>(ptiCurrent-&gt;dwExpWinVer)) {
04285             RIPERR1(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"SetWindowPlacement: invalid length %lX"</span>, pwp-&gt;length);
04286             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
04287         } <span class="keywordflow">else</span> {
04288             RIPMSG1(RIP_WARNING, <span class="stringliteral">"SetWindowPlacement: invalid length %lX"</span>, pwp-&gt;length);
04289         }
04290     }
04291 
04292     retval = <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a12">xxxSetWindowPlacement</a>(pwndND, &amp;wp);
04293 
04294     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetWindowPlacement"</span>);
04295     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a27">ENDRECV_HWNDLOCK_ND</a>();
04296 }
04297 
<a name="l04298"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a165">04298</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a165">NtUserLockWindowUpdate</a>(  <span class="comment">// API LockWindowUpdate</span>
04299     IN HWND hwnd)
04300 {
04301     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
04302 
04303     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04304 
04305     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a57">ValidateHWNDOPT</a>(pwnd, hwnd);
04306 
04307     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1772">LockWindowUpdate2</a>(pwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04308 
04309     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserLockWindowUpdate"</span>);
04310     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
04311 }
04312 
<a name="l04313"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a166">04313</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a166">NtUserGetClipCursor</a>(  <span class="comment">// API GetClipCursor</span>
04314     OUT LPRECT lpRect)
04315 {
04316     <span class="comment">/*</span>
04317 <span class="comment">     * Check if the caller has the proper access rights: if not, this will</span>
04318 <span class="comment">     * SetLastError to ERROR_ACCESS_DENIED and return FALSE.  Do this *before*</span>
04319 <span class="comment">     * BEGINRECV_SHARED, else we must use MSGERROR to release the critsect!</span>
04320 <span class="comment">     */</span>
04321     <a class="code" href="../../d4/d1/userk_8h.html#a263">RETURN_IF_ACCESS_DENIED</a>(<a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()-&gt;amwinsta,
04322                             WINSTA_READATTRIBUTES,
04323                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04324     {
04325         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04326 
04327         <span class="comment">/*</span>
04328 <span class="comment">         * Probe arguments</span>
04329 <span class="comment">         */</span>
04330         <span class="keywordflow">try</span> {
04331             <a class="code" href="../../d4/d1/userk_8h.html#a68">ProbeForWriteRect</a>(lpRect);
04332 
04333             *lpRect = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a75">grcCursorClip</a>;
04334             retval = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04335         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
04336             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
04337         }
04338 
04339         <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetClipCursor"</span>);
04340         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
04341     }
04342 }
04343 
<a name="l04344"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a167">04344</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a167">NtUserEnableScrollBar</a>(
04345     IN HWND hwnd,
04346     IN UINT wSBflags,
04347     IN UINT wArrows)
04348 {
04349 
04350     <span class="comment">//</span>
04351     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
04352     <span class="comment">//      enabled. These operations are performed in the User server API</span>
04353     <span class="comment">//      dispatcher.</span>
04354     <span class="comment">//</span>
04355 
04356     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a26">BEGINRECV_HWNDLOCK_ND</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, hwnd);
04357 
04358     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a47">LIMITVALUE</a>(wSBflags, SB_MAX, <span class="stringliteral">"EnableScrollBar"</span>);
04359 
04360     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1424">xxxEnableScrollBar</a>(
04361             pwndND,
04362             wSBflags,
04363             wArrows);
04364 
04365     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserEnableScrollBar"</span>);
04366     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a27">ENDRECV_HWNDLOCK_ND</a>();
04367 }
04368 
<a name="l04369"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a168">04369</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a168">NtUserDdeSetQualityOfService</a>(  <span class="comment">// API DdeSetQualityOfService</span>
04370     IN HWND hwndClient,
04371     IN CONST SECURITY_QUALITY_OF_SERVICE *pqosNew,
04372     OUT PSECURITY_QUALITY_OF_SERVICE pqosPrev OPTIONAL)
04373 {
04374     SECURITY_QUALITY_OF_SERVICE qosNew, qosPrev;
04375 
04376     <span class="comment">//</span>
04377     <span class="comment">// N.B. This function has implicit window handle translation. This</span>
04378     <span class="comment">//      operation is performed in the User server API dispatcher.</span>
04379     <span class="comment">//</span>
04380 
04381     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a14">BEGINRECV_HWND</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, hwndClient);
04382 
04383     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd) != <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()) {
04384         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
04385     }
04386 
04387     <span class="comment">/*</span>
04388 <span class="comment">     * Probe arguments</span>
04389 <span class="comment">     */</span>
04390     <span class="keywordflow">try</span> {
04391         qosNew = <a class="code" href="../../d5/d8/ex_8h.html#a27">ProbeAndReadStructure</a>(pqosNew, SECURITY_QUALITY_OF_SERVICE);
04392         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(pqosPrev))
04393             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(pqosPrev, <span class="keyword">sizeof</span>(*pqosPrev), <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
04394 
04395     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
04396         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
04397     }
04398 
04399     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1127">_DdeSetQualityOfService</a>(
04400                 pwnd,
04401                 &amp;qosNew,
04402                 &amp;qosPrev);
04403 
04404     <span class="keywordflow">try</span> {
04405         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(pqosPrev))
04406             *pqosPrev = qosPrev;
04407     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
04408         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
04409     }
04410 
04411     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserDdeSetQualityOfService"</span>);
04412     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a15">ENDRECV_HWND</a>();
04413 }
04414 
<a name="l04415"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a169">04415</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a169">NtUserDdeGetQualityOfService</a>(  <span class="comment">// private DdeGetQualityOfService</span>
04416     IN HWND hwndClient,
04417     IN HWND hwndServer,
04418     OUT PSECURITY_QUALITY_OF_SERVICE pqos)
04419 {
04420 
04421     <span class="comment">//</span>
04422     <span class="comment">// N.B. This function has implicit window handle translation. This</span>
04423     <span class="comment">//      operation is performed in the User server API dispatcher.</span>
04424     <span class="comment">//</span>
04425 
04426     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndServer;
04427     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
04428     SECURITY_QUALITY_OF_SERVICE qos;
04429 
04430     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a16">BEGINATOMICRECV_HWND</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, hwndClient);
04431 
04432     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a57">ValidateHWNDOPT</a>(pwndServer, hwndServer);
04433     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
04434     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd) != ptiCurrent &amp;&amp; pwndServer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
04435             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndServer) != ptiCurrent) {
04436         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
04437     }
04438 
04439     <span class="comment">/*</span>
04440 <span class="comment">     * Probe arguments</span>
04441 <span class="comment">     */</span>
04442     <span class="keywordflow">try</span> {
04443         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(pqos, <span class="keyword">sizeof</span>(*pqos), <a class="code" href="../../d4/d1/userk_8h.html#a22">DATAALIGN</a>);
04444 
04445     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
04446         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
04447     }
04448     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1128">_DdeGetQualityOfService</a>(
04449                 pwnd,
04450                 pwndServer,
04451                 &amp;qos);
04452     <span class="keywordflow">try</span> {
04453         RtlCopyMemory(pqos, &amp;qos, <span class="keyword">sizeof</span> (SECURITY_QUALITY_OF_SERVICE));
04454     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
04455         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
04456     }
04457 
04458     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserDdeGetQualityOfService"</span>);
04459     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a17">ENDATOMICRECV_HWND</a>();
04460 }
04461 
<a name="l04462"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a170">04462</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a170">NtUserGetMenuIndex</a>(
04463     IN HMENU hMenu,
04464     IN HMENU hSubMenu)
04465 {
04466 
04467     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu;
04468     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> psubmenu;
04469     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> idx;
04470 
04471     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, 0);
04472 
04473     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a61">ValidateHMENU</a>(pmenu, hMenu);
04474     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a61">ValidateHMENU</a>(psubmenu, hSubMenu);
04475 
04476     retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1;
04477 
04478     <span class="keywordflow">if</span> (pmenu &amp;&amp; psubmenu) {
04479         <span class="keywordflow">for</span> (idx=0; idx&lt;pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>; idx++)
04480             <span class="keywordflow">if</span> ((pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>[idx].<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a> == psubmenu)) {
04481                 retval = idx;
04482                 <span class="keywordflow">break</span>;
04483             }
04484     }
04485 
04486     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetMenuIndex"</span>);
04487     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
04488 }
04489 
<a name="l04490"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a171">04490</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a171">NtUserSetRipFlags</a>(DWORD dwRipFlags, DWORD dwPID)
04491 {
04492     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a12">BEGINRECV_VOID</a>();
04493 
04494     <a class="code" href="../../d4/d1/userk_8h.html#a1015">_SetRipFlags</a>(dwRipFlags, dwPID);
04495 
04496     <a class="code" href="../../d4/d1/userk_8h.html#a94">TRACEVOID</a>(<span class="stringliteral">"NtUserSetRipFlags"</span>);
04497     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a13">ENDRECV_VOID</a>();
04498 }
04499 
<a name="l04500"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a172">04500</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a172">NtUserSetDbgTag</a>(<span class="keywordtype">int</span> tag, DWORD dwBitFlags)
04501 {
04502     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a12">BEGINRECV_VOID</a>();
04503 
04504     <a class="code" href="../../d4/d1/userk_8h.html#a1016">_SetDbgTag</a>(tag, dwBitFlags);
04505 
04506     <a class="code" href="../../d4/d1/userk_8h.html#a94">TRACEVOID</a>(<span class="stringliteral">"NtUserSetRipFlags"</span>);
04507     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a13">ENDRECV_VOID</a>();
04508 }
04509 
<a name="l04510"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a173">04510</a> ULONG_PTR <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a173">NtUserCallNoParam</a>(
04511     IN DWORD xpfnProc)
04512 {
04513     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(ULONG_PTR, 0);
04514 
04515     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a32">VALIDATEXPFNPROC</a>(NOPARAM);
04516 
04517     retval = (<a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a246">apfnSimpleCall</a>[xpfnProc]());
04518     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a31">ISXPFNPROCINRANGE</a>(NOPARAMANDRETURNHANDLE)) {
04519         retval = (ULONG_PTR)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>((PVOID)retval);
04520     }
04521 
04522     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(apszSimpleCallNames[xpfnProc]);
04523     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
04524 }
04525 
<a name="l04526"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">04526</a> ULONG_PTR <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(
04527     IN ULONG_PTR dwParam,
04528     IN DWORD xpfnProc)
04529 {
04530     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(ULONG_PTR, 0);
04531 
04532     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a32">VALIDATEXPFNPROC</a>(ONEPARAM);
04533 
04534     retval = (<a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a246">apfnSimpleCall</a>[xpfnProc](dwParam));
04535     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a31">ISXPFNPROCINRANGE</a>(ONEPARAMANDRETURNHANDLE)) {
04536         retval = (ULONG_PTR)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>((PVOID)retval);
04537     }
04538 
04539     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(apszSimpleCallNames[xpfnProc]);
04540     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
04541 }
04542 
<a name="l04543"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a175">04543</a> ULONG_PTR <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a175">NtUserCallHwnd</a>(
04544     IN HWND hwnd,
04545     IN DWORD xpfnProc)
04546 {
04547 
04548     <span class="comment">//</span>
04549     <span class="comment">// N.B. This function has implicit window handle translation. This</span>
04550     <span class="comment">//      operation is performed in the User server API dispatcher.</span>
04551     <span class="comment">//</span>
04552 
04553     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(ULONG_PTR, 0, hwnd);
04554 
04555     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a32">VALIDATEXPFNPROC</a>(HWND);
04556 
04557     retval = (<a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a246">apfnSimpleCall</a>[xpfnProc](pwnd));
04558 
04559     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(apszSimpleCallNames[xpfnProc]);
04560     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
04561 }
04562 
<a name="l04563"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a176">04563</a> ULONG_PTR <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a176">NtUserCallHwndLock</a>(
04564     IN HWND hwnd,
04565     IN DWORD xpfnProc)
04566 {
04567 
04568     <span class="comment">//</span>
04569     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
04570     <span class="comment">//      enabled. These operations are performed in the User server API</span>
04571     <span class="comment">//      dispatcher.</span>
04572     <span class="comment">//</span>
04573 
04574     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(ULONG_PTR, 0, hwnd);
04575 
04576     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a32">VALIDATEXPFNPROC</a>(HWNDLOCK);
04577 
04578     retval = (<a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a246">apfnSimpleCall</a>[xpfnProc](pwnd));
04579 
04580     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(apszSimpleCallNames[xpfnProc]);
04581     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
04582 }
04583 
<a name="l04584"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a177">04584</a> ULONG_PTR <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a177">NtUserCallHwndOpt</a>(
04585     IN HWND hwnd,
04586     IN DWORD xpfnProc)
04587 {
04588     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
04589 
04590     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(ULONG_PTR, 0);
04591 
04592     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a57">ValidateHWNDOPT</a>(pwnd, hwnd);
04593 
04594     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a32">VALIDATEXPFNPROC</a>(HWNDOPT);
04595 
04596     retval = (<a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a246">apfnSimpleCall</a>[xpfnProc](pwnd));
04597 
04598     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(apszSimpleCallNames[xpfnProc]);
04599     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
04600 }
04601 
<a name="l04602"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a178">04602</a> ULONG_PTR <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a178">NtUserCallHwndParam</a>(
04603     IN HWND hwnd,
04604     IN ULONG_PTR dwParam,
04605     IN DWORD xpfnProc)
04606 {
04607 
04608     <span class="comment">//</span>
04609     <span class="comment">// N.B. This function has implicit window handle translation. This</span>
04610     <span class="comment">//      operation is performed in the User server API dispatcher.</span>
04611     <span class="comment">//</span>
04612 
04613     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(ULONG_PTR, 0, hwnd);
04614 
04615     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a32">VALIDATEXPFNPROC</a>(HWNDPARAM);
04616 
04617     retval = (<a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a246">apfnSimpleCall</a>[xpfnProc](pwnd, dwParam));
04618     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a31">ISXPFNPROCINRANGE</a>(HWNDPARAMANDRETURNHANDLE)) {
04619         retval = (ULONG_PTR)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>((PVOID)retval);
04620     }
04621 
04622     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(apszSimpleCallNames[xpfnProc]);
04623     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
04624 }
04625 
<a name="l04626"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a179">04626</a> ULONG_PTR <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a179">NtUserCallHwndParamLock</a>(
04627     IN HWND hwnd,
04628     IN ULONG_PTR dwParam,
04629     IN DWORD xpfnProc)
04630 {
04631 
04632     <span class="comment">//</span>
04633     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
04634     <span class="comment">//      enabled. These operations are performed in the User server API</span>
04635     <span class="comment">//      dispatcher.</span>
04636     <span class="comment">//</span>
04637 
04638     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(ULONG_PTR, 0, hwnd);
04639 
04640     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a32">VALIDATEXPFNPROC</a>(HWNDPARAMLOCK);
04641 
04642     retval = (<a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a246">apfnSimpleCall</a>[xpfnProc](pwnd, dwParam));
04643 
04644     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(apszSimpleCallNames[xpfnProc]);
04645     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
04646 }
04647 
<a name="l04648"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a180">04648</a> ULONG_PTR <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a180">NtUserCallTwoParam</a>(
04649     ULONG_PTR dwParam1,
04650     ULONG_PTR dwParam2,
04651     IN DWORD xpfnProc)
04652 {
04653     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(ULONG_PTR, 0);
04654 
04655     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a32">VALIDATEXPFNPROC</a>(TWOPARAM);
04656 
04657     retval = (<a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a246">apfnSimpleCall</a>[xpfnProc](dwParam1, dwParam2));
04658 
04659     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(apszSimpleCallNames[xpfnProc]);
04660     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
04661 }
04662 
<a name="l04663"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a181">04663</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a181">NtUserThunkedMenuItemInfo</a>(  <span class="comment">// worker for various menu APIs</span>
04664     IN HMENU hMenu,
04665     IN UINT nPosition,
04666     IN BOOL fByPosition,
04667     IN BOOL fInsert,
04668     IN LPMENUITEMINFOW lpmii,
04669     IN PUNICODE_STRING pstrItem OPTIONAL)
04670 {
04671     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu;
04672     MENUITEMINFO mii;
04673     UNICODE_STRING strItem;
04674     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpmenu;
04675 
04676     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04677 
04678     <span class="comment">/*</span>
04679 <span class="comment">     * Probe arguments</span>
04680 <span class="comment">     * No need to SetLastError because lpmii always the address of</span>
04681 <span class="comment">     * local stack structure in USER code, not an application address.</span>
04682 <span class="comment">     */</span>
04683     <span class="keywordflow">try</span> {
04684         mii = <a class="code" href="../../d4/d1/userk_8h.html#a36">ProbeAndReadMenuItem</a>(lpmii);
04685 
04686         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(pstrItem)) {
04687             strItem = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(pstrItem);
04688             <a class="code" href="../../d4/d1/userk_8h.html#a61">ProbeForReadUnicodeStringBuffer</a>(strItem);
04689         } <span class="keywordflow">else</span> {
04690             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strItem, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04691         }
04692     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
04693         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
04694     }
04695 
04696     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a62">ValidateHMENUMODIFY</a>(pmenu, hMenu);
04697 
04698     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pmenu, &amp;tlpmenu);
04699     <span class="comment">/*</span>
04700 <span class="comment">     * These routines only use the buffer in a try/except (actually in</span>
04701 <span class="comment">     * xxxSetLPITEMInfo).</span>
04702 <span class="comment">     */</span>
04703     <span class="keywordflow">if</span> (fInsert) {
04704         retval = <a class="code" href="../../d4/d1/userk_8h.html#a1593">xxxInsertMenuItem</a>(
04705                 pmenu,
04706                 nPosition,
04707                 fByPosition,
04708                 &amp;mii,
04709                 &amp;strItem);
04710     } <span class="keywordflow">else</span> {
04711         retval = <a class="code" href="../../d4/d1/userk_8h.html#a1590">xxxSetMenuItemInfo</a>(
04712                 pmenu,
04713                 nPosition,
04714                 fByPosition,
04715                 &amp;mii,
04716                 &amp;strItem);
04717     }
04718     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpmenu);
04719 
04720     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserThunkedMenuItemInfo"</span>);
04721     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
04722 }
04723 
04724 <span class="comment">/***************************************************************************\</span>
04725 <span class="comment">* NtUserThunkedMenuInfo</span>
04726 <span class="comment">*</span>
04727 <span class="comment">* History:</span>
04728 <span class="comment">*  07-23-96 GerardoB - Added header &amp; fixed up for 5.0</span>
04729 <span class="comment">\***************************************************************************/</span>
<a name="l04730"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a182">04730</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a182">NtUserThunkedMenuInfo</a>(  <span class="comment">// API SetMenuInfo</span>
04731     IN HMENU hMenu,
04732     IN LPCMENUINFO lpmi)
04733 {
04734     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu;
04735     MENUINFO mi;
04736     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpmenu;
04737 
04738     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04739 
04740     <span class="comment">/*</span>
04741 <span class="comment">     * Probe arguments</span>
04742 <span class="comment">     */</span>
04743     <span class="keywordflow">try</span> {
04744         mi = <a class="code" href="../../d4/d1/userk_8h.html#a37">ProbeAndReadMenuInfo</a>(lpmi);
04745     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
04746         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
04747     }
04748 
04749     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a62">ValidateHMENUMODIFY</a>(pmenu, hMenu);
04750 
04751     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pmenu, &amp;tlpmenu);
04752     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1596">xxxSetMenuInfo</a>(pmenu, &amp;mi);
04753     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpmenu);
04754 
04755     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserThunkedMenuInfo"</span>);
04756     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
04757 }
04758 
<a name="l04759"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a183">04759</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a183">NtUserSetMenuDefaultItem</a>(
04760     IN HMENU hMenu,
04761     IN UINT wID,
04762     IN UINT fByPosition)
04763 {
04764     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu;
04765 
04766     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04767 
04768     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a62">ValidateHMENUMODIFY</a>(pmenu, hMenu);
04769 
04770     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1599">_SetMenuDefaultItem</a>(
04771             pmenu,
04772             wID,
04773             fByPosition);
04774 
04775     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetMenuDefaultItem"</span>);
04776     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
04777 }
04778 
<a name="l04779"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a184">04779</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a184">NtUserSetMenuContextHelpId</a>(
04780     IN HMENU hMenu,
04781     IN DWORD dwContextHelpId)
04782 {
04783     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu;
04784 
04785     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04786 
04787     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a62">ValidateHMENUMODIFY</a>(pmenu, hMenu);
04788 
04789     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1591">_SetMenuContextHelpId</a>(
04790             pmenu,
04791             dwContextHelpId);
04792 
04793     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetMenuContextHelpId"</span>);
04794     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
04795 }
04796 
<a name="l04797"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a185">04797</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a185">NtUserSetMenuFlagRtoL</a>(
04798     IN HMENU hMenu)
04799 {
04800     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu;
04801 
04802     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04803 
04804     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a61">ValidateHMENU</a>(pmenu, hMenu);
04805 
04806     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1592">_SetMenuFlagRtoL</a>(pmenu);
04807 
04808     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetMenuFlagRtoL"</span>);
04809     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
04810 }
04811 
<a name="l04812"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a186">04812</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a186">NtUserDrawAnimatedRects</a>(  <span class="comment">// API DrawAnimatedRects</span>
04813     IN HWND hwnd,
04814     IN <span class="keywordtype">int</span> idAni,
04815     IN CONST RECT *lprcFrom,
04816     IN CONST RECT *lprcTo)
04817 {
04818     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
04819     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
04820     RECT rcFrom;
04821     RECT rcTo;
04822 
04823     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04824 
04825     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a57">ValidateHWNDOPT</a>(pwnd, hwnd);
04826 
04827     <span class="comment">/*</span>
04828 <span class="comment">     * Probe arguments</span>
04829 <span class="comment">     */</span>
04830     <span class="keywordflow">try</span> {
04831         rcFrom = <a class="code" href="../../d4/d1/userk_8h.html#a31">ProbeAndReadRect</a>(lprcFrom);
04832         rcTo = <a class="code" href="../../d4/d1/userk_8h.html#a31">ProbeAndReadRect</a>(lprcTo);
04833     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
04834         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
04835     }
04836 
04837     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwnd, &amp;tlpwnd);
04838 
04839     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1043">xxxDrawAnimatedRects</a>(
04840         pwnd,
04841         idAni,
04842         &amp;rcFrom,
04843         &amp;rcTo
04844         );
04845 
04846     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
04847 
04848     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserDrawAnimatedRects"</span>);
04849     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
04850 }
04851 
<a name="l04852"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a187">04852</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a187">NtUserDrawCaption</a>(  <span class="comment">// API DrawCaption</span>
04853     IN HWND hwnd,
04854     IN HDC hdc,
04855     IN CONST RECT *lprc,
04856     IN UINT flags)
04857 {
04858     RECT rc;
04859 
04860     <span class="comment">//</span>
04861     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
04862     <span class="comment">//      enabled. These operations are performed in the User server API</span>
04863     <span class="comment">//      dispatcher.</span>
04864     <span class="comment">//</span>
04865 
04866     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, hwnd);
04867 
04868     <span class="comment">/*</span>
04869 <span class="comment">     * Probe arguments</span>
04870 <span class="comment">     */</span>
04871     <span class="keywordflow">try</span> {
04872         rc = <a class="code" href="../../d4/d1/userk_8h.html#a31">ProbeAndReadRect</a>(lprc);
04873     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
04874         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
04875     }
04876 
04877     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1935">xxxDrawCaptionTemp</a>(pwnd, hdc, &amp;rc, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, flags);
04878 
04879     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserDrawCaption"</span>);
04880     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
04881 }
04882 
<a name="l04883"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a188">04883</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a188">NtUserPaintDesktop</a>(
04884     IN HDC hdc)
04885 {
04886     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
04887     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndDesk;
04888     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlpwndDesk;
04889 
04890     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04891 
04892     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
04893 
04894     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04895         pwndDesk = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>;
04896         <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwndDesk, &amp;tlpwndDesk);
04897         retval = <a class="code" href="../../d4/d1/userk_8h.html#a1444">xxxInternalPaintDesktop</a>(pwndDesk, hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04898         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndDesk);
04899     } <span class="keywordflow">else</span> {
04900         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
04901     }
04902 
04903     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserPaintDesktop"</span>);
04904     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
04905 }
04906 
<a name="l04907"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a189">04907</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a189">NtUserGetAsyncKeyState</a>(
04908     IN <span class="keywordtype">int</span> vKey)
04909 {
04910 
04911     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
04912     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>, 0);
04913 
04914 
04915     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>();
04916     UserAssert(ptiCurrent);
04917 
04918     <span class="comment">/*</span>
04919 <span class="comment">     * Don't allow other processes to spy on other deskops or a process</span>
04920 <span class="comment">     * to spy on the foreground if the desktop does not allow input spying</span>
04921 <span class="comment">     */</span>
04922     <span class="keywordflow">if</span> ((ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>) ||
04923             ( ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (<a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>() != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>)) &amp;&amp;
04924               !<a class="code" href="../../d8/d6/sertl_8c.html#a69">RtlAreAnyAccessesGranted</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o48">amdesk</a>, (DESKTOP_HOOKCONTROL | DESKTOP_JOURNALRECORD)))) {
04925         RIPERR0(ERROR_ACCESS_DENIED, RIP_WARNING, <span class="stringliteral">"GetAysncKeyState: not"</span>
04926                 <span class="stringliteral">" foreground desktop or no desktop hooking (input spying)"</span>);
04927         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
04928     }
04929     UserAssert(!(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>));
04930 
04931     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1714">_GetAsyncKeyState</a>(vKey);
04932 
04933     <span class="comment">/*</span>
04934 <span class="comment">     * Update the client side key state cache.</span>
04935 <span class="comment">     */</span>
04936     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o17">dwAsyncKeyCache</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;dwAsyncKeyCache;
04937     RtlCopyMemory(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o18">afAsyncKeyState</a>,
04938                   <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a222">gafAsyncKeyState</a>,
04939                   <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a111">CBASYNCKEYCACHE</a>);
04940     RtlCopyMemory(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o19">afAsyncKeyStateRecentDown</a>,
04941                   <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a223">gafAsyncKeyStateRecentDown</a>,
04942                   <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a111">CBASYNCKEYCACHE</a>);
04943 
04944     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetAsyncKeyState"</span>);
04945     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
04946 }
04947 
<a name="l04948"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a190">04948</a> HBRUSH <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a190">NtUserGetControlBrush</a>(
04949     IN HWND hwnd,
04950     IN HDC hdc,
04951     IN UINT msg)
04952 {
04953 
04954     <span class="comment">//</span>
04955     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
04956     <span class="comment">//      enabled. These operations are performed in the User server API</span>
04957     <span class="comment">//      dispatcher.</span>
04958     <span class="comment">//</span>
04959 
04960     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(HBRUSH, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hwnd);
04961 
04962     <span class="keywordflow">if</span> (hdc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
04963         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
04964 
04965     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1564">xxxGetControlBrush</a>(
04966             pwnd,
04967             hdc,
04968             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>);
04969 
04970     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetControlBrush"</span>);
04971     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
04972 }
04973 
<a name="l04974"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a191">04974</a> HBRUSH <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a191">NtUserGetControlColor</a>(
04975     IN HWND hwndParent,
04976     IN HWND hwndCtl,
04977     IN HDC hdc,
04978     IN UINT msg)
04979 {
04980 
04981     <span class="comment">//</span>
04982     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
04983     <span class="comment">//      enabled. These operations are performed in the User server API</span>
04984     <span class="comment">//      dispatcher.</span>
04985     <span class="comment">//</span>
04986 
04987     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndCtl;
04988     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndCtl;
04989 
04990     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(HBRUSH, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hwndParent);
04991 
04992     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a55">ValidateHWND</a>(pwndCtl, hwndCtl);
04993 
04994     <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwndCtl, &amp;tlpwndCtl);
04995 
04996     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1565">xxxGetControlColor</a>(
04997             pwnd,
04998             pwndCtl,
04999             hdc,
05000             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>);
05001 
05002     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndCtl);
05003 
05004     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetControlColor"</span>);
05005     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
05006 }
05007 
<a name="l05008"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a192">05008</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a192">NtUserEndMenu</a>(VOID)
05009 {
05010     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
05011     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
05012 
05013     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05014 
05015     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
05016 
05017     <span class="comment">/*</span>
05018 <span class="comment">     * The menu might be in the middle of some callback, so calling xxxEndMenu</span>
05019 <span class="comment">     *  directly might screw things up. So we post it a message to signal it to</span>
05020 <span class="comment">     *  go away at a good moment</span>
05021 <span class="comment">     */</span>
05022     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05023         pwnd = <a class="code" href="../../d4/d1/userk_8h.html#a1359">GetMenuStateWindow</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a>);
05024 
05025         <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05026             <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwnd, MN_ENDMENU, 0, 0);
05027         } <span class="keywordflow">else</span> {
05028             <span class="comment">/*</span>
05029 <span class="comment">             * Is this menu messed up?</span>
05030 <span class="comment">             */</span>
05031             UserAssert(pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05032             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a>-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o3">fInsideMenuLoop</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05033         }
05034     }
05035 
05036     retval = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05037 
05038     <a class="code" href="../../d4/d1/userk_8h.html#a94">TRACEVOID</a>(<span class="stringliteral">"NtUserEndMenu"</span>);
05039     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
05040 }
05041 
<a name="l05042"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a193">05042</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a193">NtUserCountClipboardFormats</a>(
05043     VOID)
05044 {
05045     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
05046 
05047     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(<span class="keywordtype">int</span>, 0);
05048 
05049     <span class="comment">/*</span>
05050 <span class="comment">     * Blow it off if the caller doesn't have the proper access rights</span>
05051 <span class="comment">     */</span>
05052     <span class="keywordflow">if</span> ((pwinsta = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a14">CheckClipboardAccess</a>()) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05053         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
05054     }
05055 
05056     retval = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o11">cNumClipFormats</a>;
05057 
05058     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserCountClipboardFormats"</span>);
05059     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
05060 }
05061 
<a name="l05062"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a194">05062</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a194">NtUserGetClipboardSequenceNumber</a>(
05063     VOID)
05064 {
05065     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
05066 
05067     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, 0);
05068 
05069     <span class="comment">/*</span>
05070 <span class="comment">     * Blow it off if the caller doesn't have the proper access rights</span>
05071 <span class="comment">     */</span>
05072     <span class="keywordflow">if</span> ((pwinsta = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a14">CheckClipboardAccess</a>()) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05073         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
05074     }
05075 
05076     retval = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o13">iClipSequenceNumber</a>;
05077 
05078     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetClipboardSequenceNumber"</span>);
05079     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
05080 }
05081 
<a name="l05082"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a195">05082</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a195">NtUserGetCaretBlinkTime</a>(VOID)
05083 {
05084     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>, 0);
05085 
05086     <span class="comment">/*</span>
05087 <span class="comment">     * Blow it off if the caller doesn't have the proper access rights.  However, allow the</span>
05088 <span class="comment">     * CSR process to use this value internally to the server.  Note that if the client</span>
05089 <span class="comment">     * tries to retrieve this value itself, the access check will function normally.</span>
05090 <span class="comment">     */</span>
05091     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()-&gt;Process != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>) &amp;&amp;
05092         (!<a class="code" href="../../d4/d1/userk_8h.html#a1270">CheckGrantedAccess</a>(<a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()-&gt;amwinsta, WINSTA_READATTRIBUTES))) {
05093         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
05094     }
05095 
05096     retval = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;dtCaretBlink;
05097 
05098     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetCaretBlinkTime"</span>);
05099     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
05100 }
05101 
<a name="l05102"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a196">05102</a> HWND <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a196">NtUserGetClipboardOwner</a>(
05103     VOID)
05104 {
05105     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
05106 
05107     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(HWND, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05108 
05109     <span class="comment">/*</span>
05110 <span class="comment">     * Blow it off if the caller doesn't have the proper access rights</span>
05111 <span class="comment">     */</span>
05112     <span class="keywordflow">if</span> ((pwinsta = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a14">CheckClipboardAccess</a>()) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05113         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
05114     }
05115 
05116     retval = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o9">spwndClipOwner</a>);
05117 
05118     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetClipboardOwner"</span>);
05119     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
05120 }
05121 
<a name="l05122"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a197">05122</a> HWND <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a197">NtUserGetClipboardViewer</a>(
05123     VOID)
05124 {
05125     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
05126 
05127     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(HWND, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05128 
05129     <span class="comment">/*</span>
05130 <span class="comment">     * Blow it off if the caller doesn't have the proper access rights</span>
05131 <span class="comment">     */</span>
05132     <span class="keywordflow">if</span> ((pwinsta = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a14">CheckClipboardAccess</a>()) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05133         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
05134     }
05135 
05136     retval = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o8">spwndClipViewer</a>);
05137 
05138     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetClipboardViewer"</span>);
05139     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
05140 }
05141 
<a name="l05142"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a198">05142</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a198">NtUserGetDoubleClickTime</a>(
05143     VOID)
05144 {
05145     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>, 0);
05146 
05147     <span class="comment">/*</span>
05148 <span class="comment">     * Blow it off if the caller doesn't have the proper access rights.  However, allow the</span>
05149 <span class="comment">     * CSR process to use this value internally to the server.  Note that if the client</span>
05150 <span class="comment">     * tries to retrieve this value itself, the access check will function normally.</span>
05151 <span class="comment">     */</span>
05152     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()-&gt;Process != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>) &amp;&amp;
05153         (!<a class="code" href="../../d4/d1/userk_8h.html#a1270">CheckGrantedAccess</a>(<a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()-&gt;amwinsta, WINSTA_READATTRIBUTES))) {
05154         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
05155     }
05156 
05157     retval = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a100">gdtDblClk</a>;
05158 
05159     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetDoubleClickTime"</span>);
05160     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
05161 }
05162 
<a name="l05163"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a199">05163</a> HWND <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a199">NtUserGetForegroundWindow</a>(
05164     VOID)
05165 {
05166     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(HWND, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05167 
05168     <span class="comment">/*</span>
05169 <span class="comment">     * Only return a window if there is a foreground queue and the</span>
05170 <span class="comment">     * caller has access to the current desktop.</span>
05171 <span class="comment">     */</span>
05172     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
05173             <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>()-&gt;rpdesk != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk) {
05174         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
05175     }
05176 
05177     retval = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>);
05178 
05179     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetForegroundWindow"</span>);
05180     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
05181 }
05182 
<a name="l05183"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a200">05183</a> HWND <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a200">NtUserGetOpenClipboardWindow</a>(
05184     VOID)
05185 {
05186     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
05187 
05188     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(HWND, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05189 
05190     <span class="comment">/*</span>
05191 <span class="comment">     * Blow it off if the caller doesn't have the proper access rights</span>
05192 <span class="comment">     */</span>
05193     <span class="keywordflow">if</span> ((pwinsta = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a14">CheckClipboardAccess</a>()) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05194         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
05195     }
05196 
05197     retval = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o7">spwndClipOpen</a>);
05198 
05199     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetOpenClipboardWindow"</span>);
05200     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
05201 }
05202 
<a name="l05203"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a201">05203</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a201">NtUserGetPriorityClipboardFormat</a>(  <span class="comment">// API GetPriorityClipboardFormat</span>
05204     IN UINT *paFormatPriorityList,
05205     IN <span class="keywordtype">int</span> cFormats)
05206 {
05207     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(<span class="keywordtype">int</span>, 0);
05208 
05209     <span class="comment">/*</span>
05210 <span class="comment">     * Probe arguments</span>
05211 <span class="comment">     */</span>
05212     <span class="keywordflow">try</span> {
05213         <a class="code" href="../../d4/d1/userk_8h.html#a24">ProbeForReadBuffer</a>(paFormatPriorityList, cFormats, <a class="code" href="../../d4/d1/userk_8h.html#a22">DATAALIGN</a>);
05214 
05215         retval = <a class="code" href="../../d4/d1/userk_8h.html#a1741">_GetPriorityClipboardFormat</a>(
05216                 paFormatPriorityList,
05217                 cFormats);
05218     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
05219         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
05220     }
05221 
05222     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetPriorityClipboardFormat"</span>);
05223     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
05224 }
05225 
<a name="l05226"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a202">05226</a> HMENU <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a202">NtUserGetSystemMenu</a>(
05227     IN HWND hwnd,
05228     IN BOOL bRevert)
05229 {
05230 
05231     <span class="comment">//</span>
05232     <span class="comment">// N.B. This function has implicit window handle translation. This</span>
05233     <span class="comment">//      operation is performed in the User server API dispatcher.</span>
05234     <span class="comment">//</span>
05235 
05236     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(HMENU, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hwnd);
05237 
05238     retval = (HMENU)<a class="code" href="../../d4/d1/userk_8h.html#a1886">xxxGetSystemMenu</a>(pwnd, bRevert);
05239     retval = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>((PVOID)retval);
05240 
05241     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetSystemMenu"</span>);
05242     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
05243 }
05244 
<a name="l05245"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a203">05245</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a203">NtUserGetUpdateRect</a>(  <span class="comment">// API GetUpdateRect</span>
05246     IN HWND hwnd,
05247     IN LPRECT prect OPTIONAL,
05248     IN BOOL bErase)
05249 {
05250 
05251     <span class="comment">//</span>
05252     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
05253     <span class="comment">//      enabled. These operations are performed in the User server API</span>
05254     <span class="comment">//      dispatcher.</span>
05255     <span class="comment">//</span>
05256 
05257     RECT rect2;
05258     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, 0, hwnd);
05259 
05260     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1674">xxxGetUpdateRect</a>(
05261             pwnd,
05262             prect? &amp;rect2:NULL,
05263             bErase);
05264     <span class="comment">/*</span>
05265 <span class="comment">     * Probe arguments</span>
05266 <span class="comment">     */</span>
05267     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(prect)) {
05268         <span class="keywordflow">try</span> {
05269             <a class="code" href="../../d5/d8/ex_8h.html#a54">ProbeAndWriteStructure</a>(prect, rect2, RECT);
05270         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
05271             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
05272         }
05273     }
05274 
05275     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetUpdateRect"</span>);
05276     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
05277 }
05278 
<a name="l05279"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a204">05279</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a204">NtUserHideCaret</a>(
05280     IN HWND hwnd)
05281 {
05282     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
05283 
05284     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05285 
05286     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a57">ValidateHWNDOPT</a>(pwnd, hwnd);
05287 
05288     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1726">zzzHideCaret</a>(pwnd);
05289 
05290     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserHideCaret"</span>);
05291     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
05292 }
05293 
<a name="l05294"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a205">05294</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a205">NtUserHiliteMenuItem</a>(
05295     IN HWND hwnd,
05296     IN HMENU hMenu,
05297     IN UINT uIDHiliteItem,
05298     IN UINT uHilite)
05299 {
05300 
05301     <span class="comment">//</span>
05302     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
05303     <span class="comment">//      enabled. These operations are performed in the User server API</span>
05304     <span class="comment">//      dispatcher.</span>
05305     <span class="comment">//</span>
05306 
05307     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu;
05308     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpmenu;
05309 
05310     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, 0, hwnd);
05311 
05312     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a46">TESTFLAGS</a>(uHilite, MF_VALID);
05313 
05314     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a62">ValidateHMENUMODIFY</a>(pmenu, hMenu);
05315 
05316     <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pmenu, &amp;tlpmenu);
05317 
05318     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1899">xxxHiliteMenuItem</a>(
05319             pwnd,
05320             pmenu,
05321             uIDHiliteItem,
05322             uHilite);
05323 
05324     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpmenu);
05325 
05326     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserHiliteMenuItem"</span>);
05327     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
05328 }
05329 
<a name="l05330"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a206">05330</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a206">NtUserInvalidateRect</a>(  <span class="comment">// API InvalidateRect</span>
05331     IN HWND hwnd,
05332     IN CONST RECT *prect OPTIONAL,
05333     IN BOOL bErase)
05334 {
05335     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
05336     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
05337     RECT rc;
05338 
05339     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05340 
05341     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a57">ValidateHWNDOPT</a>(pwnd, hwnd);
05342 
05343     <span class="comment">/*</span>
05344 <span class="comment">     * Probe arguments</span>
05345 <span class="comment">     */</span>
05346     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(prect)) {
05347         <span class="keywordflow">try</span> {
05348             rc = <a class="code" href="../../d4/d1/userk_8h.html#a31">ProbeAndReadRect</a>(prect);
05349             prect = &amp;rc;
05350         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
05351             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
05352         }
05353     }
05354 
05355     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwnd, &amp;tlpwnd);
05356 
05357     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1669">xxxInvalidateRect</a>(
05358             pwnd,
05359             (PRECT)prect,
05360             bErase);
05361 
05362     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
05363 
05364     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserInvalidateRect"</span>);
05365     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
05366 }
05367 
<a name="l05368"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a207">05368</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a207">NtUserIsClipboardFormatAvailable</a>(
05369     IN UINT nFormat)
05370 {
05371     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
05372 
05373     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05374 
05375     <span class="comment">/*</span>
05376 <span class="comment">     * Blow it off if the caller doesn't have the proper access rights</span>
05377 <span class="comment">     */</span>
05378     <span class="keywordflow">if</span> ((pwinsta = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a14">CheckClipboardAccess</a>()) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05379         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
05380     }
05381 
05382     retval = (<a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, nFormat) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05383 
05384     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserIsClipboardFormatAvailable"</span>);
05385     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
05386 }
05387 
<a name="l05388"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a208">05388</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a208">NtUserKillTimer</a>(
05389     IN HWND hwnd,
05390     IN UINT_PTR nIDEvent)
05391 {
05392     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
05393 
05394     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05395 
05396     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a57">ValidateHWNDOPT</a>(pwnd, hwnd);
05397 
05398     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1720">_KillTimer</a>(
05399             pwnd,
05400             nIDEvent);
05401 
05402     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserKillTimer"</span>);
05403     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
05404 }
05405 
<a name="l05406"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a209">05406</a> HWND <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a209">NtUserMinMaximize</a>(
05407     IN HWND hwnd,
05408     IN UINT nCmdShow,
05409     IN BOOL fKeepHidden)
05410 {
05411     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a26">BEGINRECV_HWNDLOCK_ND</a>(HWND, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hwnd);
05412 
05413     retval = (HWND)<a class="code" href="../../d4/d1/userk_8h.html#a1159">xxxMinMaximize</a>(
05414             pwndND,
05415             nCmdShow,
05416             ((fKeepHidden) ? <a class="code" href="../../d4/d1/userk_8h.html#a503">MINMAX_KEEPHIDDEN</a> : 0) | <a class="code" href="../../d4/d1/userk_8h.html#a657">TEST_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a636">PUDF_ANIMATE</a>));
05417     retval = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>((PVOID)retval);
05418 
05419     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserMinMaximize"</span>);
05420     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a27">ENDRECV_HWNDLOCK_ND</a>();
05421 }
05422 
05423 <span class="comment">/**************************************************************************\</span>
05424 <span class="comment">* NtUserMNDragOver</span>
05425 <span class="comment">*</span>
05426 <span class="comment">* Called from the IDropTarget interface to let menus update the selection</span>
05427 <span class="comment">*  given the mouse position. It also returns the handle of the menu the</span>
05428 <span class="comment">*  the index of the item  the point is on.</span>
05429 <span class="comment">*</span>
05430 <span class="comment">* 10/28/96 GerardoB     Created</span>
05431 <span class="comment">\**************************************************************************/</span>
<a name="l05432"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a210">05432</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a210">NtUserMNDragOver</a>(  <span class="comment">// worker for menu drag &amp; drop</span>
05433     IN POINT * ppt,
05434     OUT <a class="code" href="../../d7/d1/structtagMNDRAGOVERINFO.html">PMNDRAGOVERINFO</a> pmndoi)
05435 {
05436     POINT pt;
05437     <a class="code" href="../../d7/d1/structtagMNDRAGOVERINFO.html">MNDRAGOVERINFO</a> mndoi;
05438 
05439     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05440 
05441     <span class="comment">/*</span>
05442 <span class="comment">     * No need to SetLastError since ppt and pmndoi are always addresses of</span>
05443 <span class="comment">     * local stack variables in USER, not addresses from an application</span>
05444 <span class="comment">     */</span>
05445     <span class="keywordflow">try</span> {
05446         pt = <a class="code" href="../../d4/d1/userk_8h.html#a29">ProbeAndReadPoint</a>(ppt);
05447     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
05448         RIPMSG1(RIP_WARNING, <span class="stringliteral">"NtUserMNDragOver: Exception:%#lx"</span>, GetExceptionCode());
05449         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
05450     }
05451 
05452     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1417">xxxMNDragOver</a>(&amp;pt, &amp;mndoi);
05453 
05454     <span class="keywordflow">if</span> (retval) {
05455         <span class="keywordflow">try</span> {
05456             <a class="code" href="../../d5/d8/ex_8h.html#a54">ProbeAndWriteStructure</a>(pmndoi, mndoi, <a class="code" href="../../d7/d1/structtagMNDRAGOVERINFO.html">MNDRAGOVERINFO</a>);
05457         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
05458             RIPMSG1(RIP_WARNING, <span class="stringliteral">"NtUserMNDragOver: Exception:%#lx"</span>, GetExceptionCode());
05459             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
05460         }
05461     }
05462 
05463     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserMNDragOver"</span>);
05464     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
05465 }
05466 <span class="comment">/**************************************************************************\</span>
05467 <span class="comment">* NtUserMNDragLeave</span>
05468 <span class="comment">*</span>
05469 <span class="comment">* Called from the IDropTarget interface to let the menu clean up</span>
05470 <span class="comment">*</span>
05471 <span class="comment">* 10/28/96 GerardoB     Created</span>
05472 <span class="comment">\**************************************************************************/</span>
<a name="l05473"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a211">05473</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a211">NtUserMNDragLeave</a>(VOID)
05474 {
05475     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05476     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1418">xxxMNDragLeave</a>();
05477     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserMNDragLeave"</span>);
05478     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
05479 }
05480 
<a name="l05481"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a212">05481</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a212">NtUserOpenClipboard</a>(  <span class="comment">// API OpenClipboard</span>
05482     IN HWND hwnd,
05483     OUT PBOOL pfEmptyClient)
05484 {
05485     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
05486     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
05487     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fEmptyClient;
05488 
05489     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05490 
05491     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a57">ValidateHWNDOPT</a>(pwnd, hwnd);
05492 
05493     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwnd, &amp;tlpwnd);
05494 
05495     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1735">xxxOpenClipboard</a>(pwnd, &amp;fEmptyClient);
05496 
05497     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
05498 
05499     <span class="comment">/*</span>
05500 <span class="comment">     * Probe arguments</span>
05501 <span class="comment">     * No need to SetLastError since pfEmptyClient is the address of a local</span>
05502 <span class="comment">     * variable in USER client code, not an application address.</span>
05503 <span class="comment">     */</span>
05504     <span class="keywordflow">try</span> {
05505         <a class="code" href="../../d5/d8/ex_8h.html#a51">ProbeAndWriteUlong</a>(pfEmptyClient, fEmptyClient);
05506     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
05507         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
05508     }
05509 
05510     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserOpenClipboard"</span>);
05511     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
05512 }
05513 
<a name="l05514"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a213">05514</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a213">NtUserPeekMessage</a>(
05515     OUT LPMSG pmsg,
05516     IN HWND hwnd,
05517     IN UINT wMsgFilterMin,
05518     IN UINT wMsgFilterMax,
05519     IN UINT wRemoveMsg)
05520 {
05521     MSG <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
05522 
05523     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05524 
05525     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a46">TESTFLAGS</a>(wRemoveMsg, PM_VALID);
05526 
05527     retval = <a class="code" href="../../d4/d1/userk_8h.html#a576">xxxPeekMessage</a>(
05528             &amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
05529             hwnd,
05530             wMsgFilterMin,
05531             wMsgFilterMax,
05532             wRemoveMsg);
05533 
05534     <span class="comment">/*</span>
05535 <span class="comment">     * Probe and write arguments only if PeekMessage suceeds otherwise</span>
05536 <span class="comment">     * we want to leave MSG undisturbed (bug 16224) to be compatible.</span>
05537 <span class="comment">     */</span>
05538     <span class="keywordflow">if</span> (retval) {
05539         <span class="keywordflow">try</span> {
05540             <a class="code" href="../../d5/d8/ex_8h.html#a54">ProbeAndWriteStructure</a>(pmsg, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, MSG);
05541         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
05542             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
05543         }
05544     }
05545 
05546     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserPeekMessage"</span>);
05547     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
05548 }
05549 
<a name="l05550"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a214">05550</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a214">NtUserPostMessage</a>(
05551     IN HWND hwnd,
05552     IN UINT msg,
05553     IN WPARAM wParam,
05554     IN LPARAM lParam)
05555 {
05556     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
05557 
05558     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05559 
05560     <span class="comment">/*</span>
05561 <span class="comment">     * Prevent apps from setting hi 16 bits so we can use them internally.</span>
05562 <span class="comment">     */</span>
05563     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a543">MSGFLAG_MASK</a>) {
05564         RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"Invalid message"</span>);
05565         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
05566     }
05567 
05568     <span class="keywordflow">switch</span> ((ULONG_PTR)hwnd) {
05569     <span class="keywordflow">case</span> -1:
05570     <span class="keywordflow">case</span> 0x0000FFFF:
05571         pwnd = <a class="code" href="../../d4/d1/userk_8h.html#a457">PWND_BROADCAST</a>;
05572         <span class="keywordflow">break</span>;
05573 
05574     <span class="keywordflow">case</span> 0:
05575         pwnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05576         <span class="keywordflow">break</span>;
05577 
05578     <span class="keywordflow">default</span>:
05579         <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05580             <span class="comment">/*</span>
05581 <span class="comment">             * We fake terminates to dead windows! (SAS)</span>
05582 <span class="comment">             */</span>
05583             errret = (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> == WM_DDE_TERMINATE);
05584             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
05585         }
05586         <span class="keywordflow">break</span>;
05587     }
05588 
05589     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(
05590             pwnd,
05591             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
05592             wParam,
05593             lParam);
05594 
05595     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserPostMessage"</span>);
05596     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
05597 }
05598 
<a name="l05599"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a215">05599</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a215">NtUserSendNotifyMessage</a>(  <span class="comment">// API SendNotifyMessageA/W</span>
05600     IN HWND hwnd,
05601     IN UINT Msg,
05602     IN WPARAM wParam,
05603     IN LPARAM lParam OPTIONAL)
05604 {
05605     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
05606     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
05607     <a class="code" href="../../d1/d9/struct__LARGE__STRING.html">LARGE_STRING</a> strLParam;
05608 
05609     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05610 
05611     <span class="comment">/*</span>
05612 <span class="comment">     * Prevent apps from setting hi 16 bits so we can use them internally.</span>
05613 <span class="comment">     */</span>
05614     <span class="keywordflow">if</span> (Msg &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a543">MSGFLAG_MASK</a>) {
05615         RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"Invalid message"</span>);
05616         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
05617     }
05618 
05619     <span class="keywordflow">if</span> ((Msg == WM_WININICHANGE || Msg == WM_DEVMODECHANGE) &amp;&amp;
05620             ARGUMENT_PRESENT(lParam)) {
05621         <span class="keywordflow">try</span> {
05622             strLParam = <a class="code" href="../../d4/d1/userk_8h.html#a34">ProbeAndReadLargeString</a>((<a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a>)lParam);
05623             <a class="code" href="../../d4/d1/userk_8h.html#a61">ProbeForReadUnicodeStringBuffer</a>(strLParam);
05624             lParam = (LPARAM)&amp;strLParam;
05625         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
05626             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
05627         }
05628     }
05629 
05630     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a59">ValidateHWNDFF</a>(pwnd, hwnd);
05631 
05632     <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d1/userk_8h.html#a457">PWND_BROADCAST</a>)
05633         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwnd, &amp;tlpwnd);
05634 
05635     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1581">xxxSendNotifyMessage</a>(
05636             pwnd,
05637             Msg,
05638             wParam,
05639             lParam );
05640 
05641     <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d1/userk_8h.html#a457">PWND_BROADCAST</a>)
05642         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
05643 
05644     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSendNotifyMessage"</span>);
05645     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
05646 }
05647 
<a name="l05648"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a216">05648</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a216">NtUserSendMessageCallback</a>(
05649     IN HWND hwnd,
05650     IN UINT wMsg,
05651     IN WPARAM wParam,
05652     IN LPARAM lParam,
05653     IN SENDASYNCPROC lpResultCallBack,
05654     IN ULONG_PTR dwData)
05655 {
05656     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
05657     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
05658 
05659     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05660 
05661     <span class="comment">/*</span>
05662 <span class="comment">     * Prevent apps from setting hi 16 bits so we can use them internally.</span>
05663 <span class="comment">     */</span>
05664     <span class="keywordflow">if</span> (wMsg &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a543">MSGFLAG_MASK</a>) {
05665         RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"Invalid message"</span>);
05666         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
05667     }
05668 
05669     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a59">ValidateHWNDFF</a>(pwnd, hwnd);
05670 
05671     <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d1/userk_8h.html#a457">PWND_BROADCAST</a>)
05672         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwnd, &amp;tlpwnd);
05673 
05674     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1583">xxxSendMessageCallback</a>(
05675             pwnd,
05676             wMsg,
05677             wParam,
05678             lParam,
05679             lpResultCallBack,
05680             dwData,
05681             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
05682 
05683     <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d1/userk_8h.html#a457">PWND_BROADCAST</a>)
05684         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
05685 
05686     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSendMessageCallback"</span>);
05687     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
05688 }
05689 
<a name="l05690"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a217">05690</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a217">NtUserRegisterHotKey</a>(
05691     IN HWND hwnd,
05692     IN <span class="keywordtype">int</span> <span class="keywordtype">id</span>,
05693     IN UINT fsModifiers,
05694     IN UINT vk)
05695 {
05696     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
05697 
05698     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05699 
05700     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a46">TESTFLAGS</a>(fsModifiers, MOD_VALID);
05701 
05702     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a57">ValidateHWNDOPT</a>(pwnd, hwnd);
05703 
05704     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1660">_RegisterHotKey</a>(
05705             pwnd,
05706             <span class="keywordtype">id</span>,
05707             fsModifiers,
05708             vk
05709             );
05710 
05711     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserRegisterHotKey"</span>);
05712     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
05713 }
05714 
<a name="l05715"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a218">05715</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a218">NtUserRemoveMenu</a>(
05716     IN HMENU hmenu,
05717     IN UINT nPosition,
05718     IN UINT dwFlags)
05719 {
05720     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu;
05721     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpmenu;
05722 
05723     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05724 
05725     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a46">TESTFLAGS</a>(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>, MF_VALID);
05726 
05727     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a62">ValidateHMENUMODIFY</a>(pmenu, hmenu);
05728 
05729     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>( pmenu, &amp;tlpmenu);
05730     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1594">xxxRemoveMenu</a>(
05731             pmenu,
05732             nPosition,
05733             <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
05734     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpmenu);
05735 
05736     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserRemoveMenu"</span>);
05737     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
05738 }
05739 
<a name="l05740"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a219">05740</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a219">NtUserScrollWindowEx</a>(  <span class="comment">// API ScrollWindowEx</span>
05741     IN HWND hwnd,
05742     IN <span class="keywordtype">int</span> dx,
05743     IN <span class="keywordtype">int</span> dy,
05744     IN CONST RECT *prcScroll OPTIONAL,
05745     IN CONST RECT *prcClip OPTIONAL,
05746     IN HRGN hrgnUpdate,
05747     OUT LPRECT prcUpdate OPTIONAL,
05748     IN UINT flags)
05749 {
05750     RECT rcScroll;
05751     RECT rcClip;
05752     RECT rcUpdate;
05753 
05754     <span class="comment">//</span>
05755     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
05756     <span class="comment">//      enabled. These operations are performed in the User server API</span>
05757     <span class="comment">//      dispatcher.</span>
05758     <span class="comment">//</span>
05759 
05760     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, 0, hwnd);
05761 
05762     <span class="comment">/*</span>
05763 <span class="comment">     * Probe arguments</span>
05764 <span class="comment">     */</span>
05765     <span class="keywordflow">try</span> {
05766         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(prcScroll)) {
05767             rcScroll = <a class="code" href="../../d4/d1/userk_8h.html#a31">ProbeAndReadRect</a>(prcScroll);
05768             prcScroll = &amp;rcScroll;
05769         }
05770         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(prcClip)) {
05771             rcClip = <a class="code" href="../../d4/d1/userk_8h.html#a31">ProbeAndReadRect</a>(prcClip);
05772             prcClip = &amp;rcClip;
05773         }
05774 
05775     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
05776         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
05777     }
05778 
05779     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1426">xxxScrollWindowEx</a>(
05780                 pwnd,
05781                 dx,
05782                 dy,
05783                 (PRECT)prcScroll,
05784                 (PRECT)prcClip,
05785                 hrgnUpdate,
05786                 prcUpdate ? &amp;rcUpdate : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05787                 flags);
05788 
05789     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(prcUpdate)) {
05790         <span class="keywordflow">try</span> {
05791             <a class="code" href="../../d5/d8/ex_8h.html#a54">ProbeAndWriteStructure</a>(prcUpdate, rcUpdate, RECT);
05792         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
05793             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
05794         }
05795     }
05796 
05797     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserScrollWindow"</span>);
05798     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
05799 }
05800 
<a name="l05801"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a220">05801</a> HWND <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a220">NtUserSetActiveWindow</a>(
05802     IN HWND hwnd)
05803 {
05804     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
05805     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
05806 
05807     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(HWND, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05808 
05809     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a57">ValidateHWNDOPT</a>(pwnd, hwnd);
05810 
05811     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwnd, &amp;tlpwnd);
05812 
05813     retval = (HWND)<a class="code" href="../../d4/d1/userk_8h.html#a1666">xxxSetActiveWindow</a>(pwnd);
05814     retval = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>((PVOID)retval);
05815 
05816     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
05817 
05818     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetActiveWindow"</span>);
05819     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
05820 }
05821 
<a name="l05822"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a221">05822</a> HWND <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a221">NtUserSetCapture</a>(
05823     IN HWND hwnd)
05824 {
05825     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
05826     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
05827 
05828     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(HWND, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05829 
05830     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a57">ValidateHWNDOPT</a>(pwnd, hwnd);
05831 
05832     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwnd, &amp;tlpwnd);
05833 
05834     retval = (HWND)<a class="code" href="../../d4/d1/userk_8h.html#a1712">xxxSetCapture</a>(pwnd);
05835     retval = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>((PVOID)retval);
05836 
05837     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
05838 
05839     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetCapture"</span>);
05840     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
05841 }
05842 
<a name="l05843"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a222">05843</a> WORD <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a222">NtUserSetClassWord</a>(
05844     IN HWND hwnd,
05845     IN <span class="keywordtype">int</span> nIndex,
05846     IN WORD wNewWord)
05847 {
05848 
05849     <span class="comment">//</span>
05850     <span class="comment">// N.B. This function has implicit window handle translation. This</span>
05851     <span class="comment">//      operation is performed in the User server API dispatcher.</span>
05852     <span class="comment">//</span>
05853 
05854     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a14">BEGINRECV_HWND</a>(WORD, 0, hwnd);
05855 
05856     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1896">_SetClassWord</a>(
05857             pwnd,
05858             nIndex,
05859             wNewWord);
05860 
05861     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetClassWord"</span>);
05862     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a15">ENDRECV_HWND</a>();
05863 }
05864 
<a name="l05865"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a223">05865</a> HWND <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a223">NtUserSetClipboardViewer</a>(
05866     IN HWND hwnd)
05867 {
05868     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
05869     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
05870 
05871     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(HWND, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05872 
05873     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a57">ValidateHWNDOPT</a>(pwnd, hwnd);
05874 
05875     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwnd, &amp;tlpwnd);
05876 
05877     retval = (HWND)<a class="code" href="../../d4/d1/userk_8h.html#a1742">xxxSetClipboardViewer</a>(pwnd);
05878     retval = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>((PVOID)retval);
05879 
05880     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
05881 
05882     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetClipboardViewer"</span>);
05883     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
05884 }
05885 
<a name="l05886"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a224">05886</a> HCURSOR <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a224">NtUserSetCursor</a>(
05887     IN HCURSOR hCursor)
05888 {
05889     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pCursor;
05890 
05891     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(HCURSOR, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05892 
05893     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a65">ValidateHCURSOROPT</a>(pCursor, hCursor);
05894 
05895     retval = (HCURSOR)<a class="code" href="../../d4/d1/userk_8h.html#a1785">zzzSetCursor</a>(pCursor);
05896     retval = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>((PVOID)retval);
05897 
05898     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetCursor"</span>);
05899     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
05900 }
05901 
<a name="l05902"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a225">05902</a> HWND <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a225">NtUserSetFocus</a>(
05903     IN HWND hwnd)
05904 {
05905     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
05906     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
05907 
05908     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(HWND, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05909 
05910     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a57">ValidateHWNDOPT</a>(pwnd, hwnd);
05911 
05912     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwnd, &amp;tlpwnd);
05913 
05914     retval = (HWND)<a class="code" href="../../d4/d1/userk_8h.html#a1662">xxxSetFocus</a>(pwnd);
05915     retval = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>((PVOID)retval);
05916 
05917     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
05918 
05919     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetFocus"</span>);
05920     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
05921 }
05922 
<a name="l05923"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a226">05923</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a226">NtUserSetMenu</a>(
05924     IN HWND  hwnd,
05925     IN HMENU hmenu,
05926     IN BOOL  fRedraw)
05927 {
05928 
05929     <span class="comment">//</span>
05930     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
05931     <span class="comment">//      enabled. These operations are performed in the User server API</span>
05932     <span class="comment">//      dispatcher.</span>
05933     <span class="comment">//</span>
05934 
05935     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu;
05936     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>    tlpmenu;
05937 
05938     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a26">BEGINRECV_HWNDLOCK_ND</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, 0, hwnd);
05939 
05940     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a60">ValidateHMENUOPT</a>(pmenu, hmenu);
05941 
05942     <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pmenu, &amp;tlpmenu);
05943 
05944     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1586">xxxSetMenu</a>(
05945             pwndND,
05946             pmenu,
05947             fRedraw);
05948 
05949     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpmenu);
05950 
05951     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetMenu"</span>);
05952     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a27">ENDRECV_HWNDLOCK_ND</a>();
05953 }
05954 
<a name="l05955"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a227">05955</a> HWND <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a227">NtUserSetParent</a>(
05956     IN HWND hwndChild,
05957     IN HWND hwndNewParent)
05958 {
05959 
05960     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndNewParent;
05961     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndNewParent;
05962 
05963     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a26">BEGINRECV_HWNDLOCK_ND</a>(HWND, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hwndChild);
05964 
05965     <span class="keywordflow">if</span> (hwndNewParent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05966         pwndNewParent = <a class="code" href="../../d3/d9/client_2wow_8c.html#a3">_GetDesktopWindow</a>();
05967     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hwndNewParent == HWND_MESSAGE) {
05968         pwndNewParent = <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a15">_GetMessageWindow</a>();
05969     } <span class="keywordflow">else</span> {
05970         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a55">ValidateHWND</a>(pwndNewParent, hwndNewParent);
05971     }
05972 
05973     <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwndNewParent, &amp;tlpwndNewParent);
05974 
05975     retval = (HWND)<a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a6">xxxSetParent</a>(
05976             pwndND,
05977             pwndNewParent);
05978     retval = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>((PVOID)retval);
05979 
05980     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndNewParent);
05981 
05982     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetParent"</span>);
05983     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a27">ENDRECV_HWNDLOCK_ND</a>();
05984 }
05985 
<a name="l05986"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a228">05986</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a228">NtUserSetScrollInfo</a>(  <span class="comment">// API SetScrollInfo</span>
05987     IN HWND hwnd,
05988     IN <span class="keywordtype">int</span> nBar,
05989     IN LPCSCROLLINFO pInfo,
05990     IN BOOL fRedraw)
05991 {
05992     SCROLLINFO si;
05993 
05994     <span class="comment">//</span>
05995     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
05996     <span class="comment">//      enabled. These operations are performed in the User server API</span>
05997     <span class="comment">//      dispatcher.</span>
05998     <span class="comment">//</span>
05999 
06000     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a26">BEGINRECV_HWNDLOCK_ND</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, 0, hwnd);
06001 
06002     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a47">LIMITVALUE</a>(nBar, SB_MAX, <span class="stringliteral">"SetScrollInfo"</span>);
06003 
06004     <span class="comment">/*</span>
06005 <span class="comment">     * Probe arguments</span>
06006 <span class="comment">     */</span>
06007     <span class="keywordflow">try</span> {
06008         si = <a class="code" href="../../d4/d1/userk_8h.html#a38">ProbeAndReadScrollInfo</a>(pInfo);
06009     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
06010         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
06011     }
06012 
06013     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1468">xxxSetScrollBar</a>(
06014             pwndND,
06015             nBar,
06016             &amp;si,
06017             fRedraw);
06018 
06019     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetScrollInfo"</span>);
06020     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a27">ENDRECV_HWNDLOCK_ND</a>();
06021 }
06022 
<a name="l06023"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a229">06023</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a229">NtUserSetSysColors</a>(  <span class="comment">// API SetSysColors</span>
06024     IN <span class="keywordtype">int</span> nCount,
06025     IN CONST INT *pSysColor,
06026     IN CONST COLORREF *pColorValues,
06027     IN UINT  uOptions)
06028 {
06029     LPINT lpSysColors = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06030     LPDWORD lpSysColorValues = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06031     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlName, tlSysColors, tlSysColorValues;
06032     PUNICODE_STRING pProfileUserName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06033     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
06034 
06035     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
06036 
06037     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
06038 
06039     <span class="comment">/*</span>
06040 <span class="comment">     * Prevent restricted threads from changing global stuff</span>
06041 <span class="comment">     */</span>
06042     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a382">IS_THREAD_RESTRICTED</a>(ptiCurrent, JOB_OBJECT_UILIMIT_SYSTEMPARAMETERS)) {
06043         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
06044     }
06045 
06046     <span class="comment">/*</span>
06047 <span class="comment">     * Probe arguments</span>
06048 <span class="comment">     */</span>
06049     <span class="keywordflow">if</span> (nCount) {
06050         <span class="keywordflow">try</span> {
06051             <a class="code" href="../../d4/d1/userk_8h.html#a24">ProbeForReadBuffer</a>(pSysColor, nCount, <a class="code" href="../../d4/d1/userk_8h.html#a22">DATAALIGN</a>);
06052             <a class="code" href="../../d4/d1/userk_8h.html#a24">ProbeForReadBuffer</a>(pColorValues, nCount, <a class="code" href="../../d4/d1/userk_8h.html#a22">DATAALIGN</a>);
06053             lpSysColors = UserAllocPoolWithQuota(nCount * <span class="keyword">sizeof</span>(*pSysColor), TAG_COLORS);
06054             <span class="keywordflow">if</span> (lpSysColors == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06055                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_NO_MEMORY);
06056             }
06057             RtlCopyMemory(lpSysColors, pSysColor, nCount * <span class="keyword">sizeof</span>(*pSysColor));
06058             lpSysColorValues = UserAllocPoolWithQuota(nCount * <span class="keyword">sizeof</span>(*pColorValues), TAG_COLORVALUES);
06059             <span class="keywordflow">if</span> (lpSysColorValues == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06060                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_NO_MEMORY);
06061             }
06062             RtlCopyMemory(lpSysColorValues, pColorValues, nCount * <span class="keyword">sizeof</span>(*pColorValues));
06063 
06064         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
06065             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
06066         }
06067     }
06068 
06069     <a class="code" href="../../d4/d1/userk_8h.html#a137">ThreadLockPool</a>(ptiCurrent, lpSysColors, &amp;tlSysColors);
06070     <a class="code" href="../../d4/d1/userk_8h.html#a137">ThreadLockPool</a>(ptiCurrent, lpSysColorValues, &amp;tlSysColorValues);
06071     pProfileUserName = <a class="code" href="../../d4/d1/userk_8h.html#a2000">CreateProfileUserName</a>(&amp;tlName);
06072     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1774">xxxSetSysColors</a>(pProfileUserName,
06073                 nCount,
06074                 lpSysColors,
06075                 lpSysColorValues,
06076                 uOptions
06077                 );
06078     <a class="code" href="../../d4/d1/userk_8h.html#a2001">FreeProfileUserName</a>(pProfileUserName, &amp;tlName);
06079     <a class="code" href="../../d4/d1/userk_8h.html#a138">ThreadUnlockPool</a>(ptiCurrent, &amp;tlSysColorValues);
06080     <a class="code" href="../../d4/d1/userk_8h.html#a138">ThreadUnlockPool</a>(ptiCurrent, &amp;tlSysColors);
06081 
06082     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a33">CLEANUPRECV</a>();
06083     <span class="keywordflow">if</span> (lpSysColors)
06084         UserFreePool(lpSysColors);
06085     <span class="keywordflow">if</span> (lpSysColorValues)
06086         UserFreePool(lpSysColorValues);
06087 
06088     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetSysColors"</span>);
06089     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
06090 }
06091 
<a name="l06092"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a230">06092</a> UINT_PTR <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a230">NtUserSetTimer</a>(
06093     IN HWND hwnd,
06094     IN UINT_PTR nIDEvent,
06095     IN UINT wElapse,
06096     IN TIMERPROC pTimerFunc)
06097 {
06098     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
06099 
06100     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(UINT_PTR, 0);
06101 
06102     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a57">ValidateHWNDOPT</a>(pwnd, hwnd);
06103 
06104     <span class="comment">/*</span>
06105 <span class="comment">     * If we let apps set a timer granularity less then 10 the app</span>
06106 <span class="comment">     * spend too long processing timer messages.  Some WOW apps like</span>
06107 <span class="comment">     * Paradox in WinStone use zero to effectively get the minimal</span>
06108 <span class="comment">     * timer value which was ~55ms in Win 3.1.  We also step this</span>
06109 <span class="comment">     * value up for 32 bit apps because the NT timer resolution</span>
06110 <span class="comment">     * can very depending if the multimedia timers have turned up</span>
06111 <span class="comment">     * the resolution.  If they have NT apps that specify a low value</span>
06112 <span class="comment">     * will not work properly because they will eat the CPU processing</span>
06113 <span class="comment">     * WM_TIMER messages</span>
06114 <span class="comment">     */</span>
06115     <span class="keywordflow">if</span> (wElapse &lt; 10) {
06116         RIPMSG1(RIP_WARNING, <span class="stringliteral">"SetTimer: timeout value was %ld set to 10"</span>,
06117                 wElapse);
06118         wElapse = 10;
06119     }
06120 
06121     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1241">_SetTimer</a>(
06122             pwnd,
06123             nIDEvent,
06124             wElapse,
06125             (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a991">TIMERPROC_PWND</a>)pTimerFunc);
06126 
06127     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetTimer"</span>);
06128     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
06129 }
06130 
<a name="l06131"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a231">06131</a> LONG_PTR <a class="code" href="../../d0/d0/ntuser_8h.html#a3">NtUserSetWindowLongPtr</a>(
06132     IN HWND hwnd,
06133     IN <span class="keywordtype">int</span> nIndex,
06134     IN LONG_PTR dwNewLong,
06135     IN BOOL bAnsi)
06136 {
06137 
06138     <span class="comment">//</span>
06139     <span class="comment">// N.B. This function has implicit window handle translation. This</span>
06140     <span class="comment">//      operation is performed in the User server API dispatcher.</span>
06141     <span class="comment">//</span>
06142 
06143     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(ULONG_PTR, 0, hwnd);
06144 
06145     retval = <a class="code" href="../../d4/d1/userk_8h.html#a586">xxxSetWindowLongPtr</a>(
06146             pwnd,
06147             nIndex,
06148             dwNewLong,
06149             bAnsi);
06150 
06151     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetWindowLongPtr"</span>);
06152     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
06153 }
06154 
06155 <span class="preprocessor">#ifdef _WIN64</span>
06156 <span class="preprocessor"></span>LONG <a class="code" href="../../d0/d0/ntuser_8h.html#a135">NtUserSetWindowLong</a>(
06157     IN HWND hwnd,
06158     IN <span class="keywordtype">int</span> nIndex,
06159     IN LONG dwNewLong,
06160     IN BOOL bAnsi)
06161 {
06162 
06163     <span class="comment">//</span>
06164     <span class="comment">// N.B. This function has implicit window handle translation. This</span>
06165     <span class="comment">//      operation is performed in the User server API dispatcher.</span>
06166     <span class="comment">//</span>
06167 
06168     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(DWORD, 0, hwnd);
06169 
06170     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1432">xxxSetWindowLong</a>(
06171             pwnd,
06172             nIndex,
06173             dwNewLong,
06174             bAnsi);
06175 
06176     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetWindowLong"</span>);
06177     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
06178 }
06179 <span class="preprocessor">#endif</span>
06180 <span class="preprocessor"></span>
<a name="l06181"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a232">06181</a> WORD <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a232">NtUserSetWindowWord</a>(
06182     IN HWND hwnd,
06183     IN <span class="keywordtype">int</span> nIndex,
06184     IN WORD wNewWord)
06185 {
06186 
06187     <span class="comment">//</span>
06188     <span class="comment">// N.B. This function has implicit window handle translation. This</span>
06189     <span class="comment">//      operation is performed in the User server API dispatcher.</span>
06190     <span class="comment">//</span>
06191 
06192     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a14">BEGINRECV_HWND</a>(WORD, 0, hwnd);
06193 
06194     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1431">_SetWindowWord</a>(
06195             pwnd,
06196             nIndex,
06197             wNewWord);
06198 
06199     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetWindowWord"</span>);
06200     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a15">ENDRECV_HWND</a>();
06201 }
06202 
<a name="l06203"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a233">06203</a> HHOOK <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a233">NtUserSetWindowsHookAW</a>(
06204     IN <span class="keywordtype">int</span> nFilterType,
06205     IN HOOKPROC pfnFilterProc,
06206     IN DWORD dwFlags)
06207 {
06208     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(HHOOK, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
06209 
06210     retval = (HHOOK)<a class="code" href="../../d4/d1/userk_8h.html#a1814">zzzSetWindowsHookAW</a>(
06211             nFilterType,
06212             (PROC)pfnFilterProc,
06213             <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
06214 
06215     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetWindowsHookAW"</span>);
06216     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
06217 }
06218 
<a name="l06219"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a234">06219</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a234">NtUserShowCaret</a>(
06220     IN HWND hwnd)
06221 {
06222     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
06223 
06224     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
06225 
06226     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a57">ValidateHWNDOPT</a>(pwnd, hwnd);
06227 
06228     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1725">zzzShowCaret</a>(
06229             pwnd);
06230 
06231     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserShowCaret"</span>);
06232     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
06233 }
06234 
<a name="l06235"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a235">06235</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a235">NtUserShowScrollBar</a>(
06236     IN HWND hwnd,
06237     IN <span class="keywordtype">int</span> iBar,
06238     IN BOOL fShow)
06239 {
06240 
06241     <span class="comment">//</span>
06242     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
06243     <span class="comment">//      enabled. These operations are performed in the User server API</span>
06244     <span class="comment">//      dispatcher.</span>
06245     <span class="comment">//</span>
06246 
06247     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a26">BEGINRECV_HWNDLOCK_ND</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, 0, hwnd);
06248 
06249     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a47">LIMITVALUE</a>(iBar, SB_MAX, <span class="stringliteral">"ShowScrollBar"</span>);
06250 
06251     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1760">xxxShowScrollBar</a>(
06252             pwndND,
06253             iBar,
06254             fShow);
06255 
06256     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserShowScrollBar"</span>);
06257     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a27">ENDRECV_HWNDLOCK_ND</a>();
06258 }
06259 
<a name="l06260"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a236">06260</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a236">NtUserShowWindowAsync</a>(
06261     IN HWND hwnd,
06262     IN <span class="keywordtype">int</span> nCmdShow)
06263 {
06264     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a26">BEGINRECV_HWNDLOCK_ND</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, hwnd);
06265 
06266     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a47">LIMITVALUE</a>(nCmdShow, SW_MAX, <span class="stringliteral">"ShowWindowAsync"</span>);
06267 
06268     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1608">_ShowWindowAsync</a>(pwndND, nCmdShow, 0);
06269 
06270     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserShowWindowAsync"</span>);
06271     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a27">ENDRECV_HWNDLOCK_ND</a>();
06272 }
06273 
<a name="l06274"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a237">06274</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a237">NtUserShowWindow</a>(
06275     IN HWND hwnd,
06276     IN <span class="keywordtype">int</span> nCmdShow)
06277 {
06278     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a26">BEGINRECV_HWNDLOCK_ND</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, hwnd);
06279 
06280     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a47">LIMITVALUE</a>(nCmdShow, SW_MAX, <span class="stringliteral">"ShowWindow"</span>);
06281 
06282     <span class="comment">/*</span>
06283 <span class="comment">     * Let's not allow the window to be shown/hidden once we</span>
06284 <span class="comment">     * started the destruction of the window.</span>
06285 <span class="comment">     */</span>
06286     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndND, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a591">WFINDESTROY</a>)) {
06287         RIPERR1(ERROR_INVALID_PARAMETER,
06288                 RIP_WARNING,
06289                 <span class="stringliteral">"ShowWindow: Window is being destroyed (%#p)"</span>,
06290                 pwndND);
06291         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
06292     }
06293 
06294     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1607">xxxShowWindow</a>(pwndND, nCmdShow | <a class="code" href="../../d4/d1/userk_8h.html#a657">TEST_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a636">PUDF_ANIMATE</a>));
06295 
06296     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserShowWindow"</span>);
06297     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a27">ENDRECV_HWNDLOCK_ND</a>();
06298 }
06299 
<a name="l06300"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a238">06300</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a238">NtUserTrackMouseEvent</a>(  <span class="comment">// API TrackMouseEvent</span>
06301     IN OUT LPTRACKMOUSEEVENT lpTME)
06302 {
06303     TRACKMOUSEEVENT tme;
06304 
06305     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
06306 
06307     <span class="comment">/*</span>
06308 <span class="comment">     * Probe arguments</span>
06309 <span class="comment">     */</span>
06310     <span class="keywordflow">try</span> {
06311         tme = <a class="code" href="../../d4/d1/userk_8h.html#a55">ProbeAndReadTrackMouseEvent</a>(lpTME);
06312 
06313         <span class="keywordflow">if</span> (tme.cbSize != <span class="keyword">sizeof</span>(tme)) {
06314             RIPERR1(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"TrackMouseEvent: invalid size %lX"</span>, tme.cbSize);
06315             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
06316         }
06317 
06318         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a46">TESTFLAGS</a>(tme.dwFlags, TME_VALID);
06319 
06320     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
06321         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
06322     }
06323 
06324     <span class="keywordflow">if</span> (tme.dwFlags &amp; TME_QUERY) {
06325         retval = <a class="code" href="../../d4/d1/userk_8h.html#a1129">QueryTrackMouseEvent</a>(&amp;tme);
06326         <span class="keywordflow">try</span> {
06327             RtlCopyMemory(lpTME, &amp;tme, <span class="keyword">sizeof</span>(tme));
06328         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
06329             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
06330         }
06331     } <span class="keywordflow">else</span> {
06332         retval = <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a47">TrackMouseEvent</a>(&amp;tme);
06333     }
06334 
06335     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserTrackMouseEvent"</span>);
06336     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
06337 }
06338 
<a name="l06339"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a239">06339</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a239">NtUserTrackPopupMenuEx</a>(  <span class="comment">// API TrackPopupMenuEx</span>
06340     IN HMENU hMenu,
06341     IN UINT uFlags,
06342     IN <span class="keywordtype">int</span> x,
06343     IN <span class="keywordtype">int</span> y,
06344     IN HWND hwnd,
06345     IN CONST TPMPARAMS *pparamst OPTIONAL)
06346 {
06347     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
06348     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu;
06349     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
06350     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpmenu;
06351     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
06352     TPMPARAMS paramst;
06353 
06354     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
06355 
06356     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a46">TESTFLAGS</a>(uFlags, TPM_VALID);
06357 
06358     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a61">ValidateHMENU</a>(pmenu, hMenu);
06359     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a55">ValidateHWND</a>(pwnd, hwnd);
06360 
06361     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
06362     <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwnd, &amp;tlpwnd);
06363     <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pmenu, &amp;tlpmenu);
06364 
06365     <span class="comment">/*</span>
06366 <span class="comment">     * Probe arguments</span>
06367 <span class="comment">     */</span>
06368     <span class="keywordflow">try</span> {
06369         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(pparamst)) {
06370             paramst = <a class="code" href="../../d4/d1/userk_8h.html#a39">ProbeAndReadPopupParams</a>(pparamst);
06371             pparamst = &amp;paramst;
06372         }
06373 
06374     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
06375         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
06376     }
06377     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1597">xxxTrackPopupMenuEx</a>(
06378                 pmenu,
06379                 uFlags,
06380                 x,
06381                 y,
06382                 pwnd,
06383                 pparamst);
06384 
06385     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a33">CLEANUPRECV</a>();
06386 
06387     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpmenu);
06388     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
06389 
06390     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserTrackPopupMenuEx"</span>);
06391     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
06392 }
06393 
<a name="l06394"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a240">06394</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a240">NtUserTranslateMessage</a>(  <span class="comment">// API TranslateMessage</span>
06395     IN CONST MSG *lpMsg,
06396     IN UINT flags)
06397 {
06398     MSG <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
06399 
06400     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
06401 
06402     <span class="comment">/*</span>
06403 <span class="comment">     * Probe arguments</span>
06404 <span class="comment">     */</span>
06405     <span class="keywordflow">try</span> {
06406         <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> = <a class="code" href="../../d4/d1/userk_8h.html#a33">ProbeAndReadMessage</a>(lpMsg);
06407     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
06408         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
06409     }
06410 
06411     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.hwnd) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06412         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
06413     }
06414 
06415     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1646">xxxTranslateMessage</a>(
06416             &amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
06417             flags);
06418 
06419     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserTranslateMessage"</span>);
06420     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
06421 }
06422 
<a name="l06423"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a241">06423</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a241">NtUserUnhookWindowsHookEx</a>(
06424     IN HHOOK hhk)
06425 {
06426     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phk;
06427 
06428     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
06429 
06430     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a67">ValidateHHOOK</a>(phk, hhk);
06431 
06432     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1815">zzzUnhookWindowsHookEx</a>(
06433             phk);
06434 
06435     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserUnhookWindowsHookEx"</span>);
06436     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
06437 }
06438 
<a name="l06439"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a242">06439</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a242">NtUserUnregisterHotKey</a>(
06440     IN HWND hwnd,
06441     IN <span class="keywordtype">int</span> <span class="keywordtype">id</span>)
06442 {
06443     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
06444 
06445     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
06446 
06447     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a57">ValidateHWNDOPT</a>(pwnd, hwnd);
06448 
06449     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1661">_UnregisterHotKey</a>(
06450             pwnd,
06451             <span class="keywordtype">id</span>);
06452 
06453     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserUnregisterHotKey"</span>);
06454     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
06455 }
06456 
<a name="l06457"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a243">06457</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a243">NtUserValidateRect</a>(  <span class="comment">// API ValidateRect</span>
06458     IN HWND hwnd,
06459     IN CONST RECT *lpRect OPTIONAL)
06460 {
06461     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
06462     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
06463     RECT rc;
06464 
06465     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
06466 
06467     <span class="comment">/*</span>
06468 <span class="comment">     * Probe arguments</span>
06469 <span class="comment">     */</span>
06470     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(lpRect)) {
06471         <span class="keywordflow">try</span> {
06472             rc = <a class="code" href="../../d4/d1/userk_8h.html#a31">ProbeAndReadRect</a>(lpRect);
06473             lpRect = &amp;rc;
06474         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
06475             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
06476         }
06477     }
06478 
06479     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a57">ValidateHWNDOPT</a>(pwnd, hwnd);
06480 
06481     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwnd, &amp;tlpwnd);
06482 
06483     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1670">xxxValidateRect</a>(pwnd, (PRECT)lpRect);
06484 
06485     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
06486 
06487     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserValidateRect"</span>);
06488     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
06489 }
06490 
<a name="l06491"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a244">06491</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a244">NtUserWaitForInputIdle</a>(
06492     IN ULONG_PTR idProcess,
06493     IN DWORD dwMilliseconds,
06494     IN BOOL fSharedWow)
06495 {
06496     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1);
06497 
06498     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1120">xxxWaitForInputIdle</a>(
06499             idProcess,
06500             dwMilliseconds,
06501             fSharedWow);
06502 
06503     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserWaitForInputIdle"</span>);
06504     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
06505 }
06506 
<a name="l06507"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a245">06507</a> HWND <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a245">NtUserWindowFromPoint</a>(
06508     IN POINT <a class="code" href="../../d7/d5/structPoint.html">Point</a>)
06509 {
06510     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(HWND, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
06511 
06512     retval = (HWND)<a class="code" href="../../d9/d8/winwhere_8c.html#a2">xxxWindowFromPoint</a>(
06513             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a30">Point</a>);
06514     retval = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>((PVOID)retval);
06515 
06516     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserWindowFromPoint"</span>);
06517     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
06518 }
06519 
<a name="l06520"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a246">06520</a> HDC <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a246">NtUserBeginPaint</a>(  <span class="comment">// API BeginPaint</span>
06521     IN HWND hwnd,
06522     OUT LPPAINTSTRUCT lpPaint)
06523 {
06524     PAINTSTRUCT ps;
06525 
06526     <span class="comment">//</span>
06527     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
06528     <span class="comment">//      enabled. These operations are performed in the User server API</span>
06529     <span class="comment">//      dispatcher.</span>
06530     <span class="comment">//</span>
06531 
06532     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(HDC, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hwnd);
06533 
06534     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1710">xxxBeginPaint</a>(pwnd, &amp;ps);
06535 
06536     <span class="comment">/*</span>
06537 <span class="comment">     * Probe arguments</span>
06538 <span class="comment">     */</span>
06539     <span class="keywordflow">try</span> {
06540         <a class="code" href="../../d5/d8/ex_8h.html#a54">ProbeAndWriteStructure</a>(lpPaint, ps, PAINTSTRUCT);
06541     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
06542         <a class="code" href="../../d4/d1/userk_8h.html#a1711">xxxEndPaint</a>(pwnd, &amp;ps);
06543         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
06544     }
06545 
06546     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserBeginPaint"</span>);
06547     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
06548 }
06549 
<a name="l06550"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a247">06550</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a247">NtUserCreateCaret</a>(
06551     IN HWND hwnd,
06552     IN HBITMAP hBitmap,
06553     IN <span class="keywordtype">int</span> nWidth,
06554     IN <span class="keywordtype">int</span> nHeight)
06555 {
06556 
06557     <span class="comment">//</span>
06558     <span class="comment">// N.B. This function has implicit window handle translation. This</span>
06559     <span class="comment">//      operation is performed in the User server API dispatcher.</span>
06560     <span class="comment">//</span>
06561 
06562     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, 0, hwnd);
06563 
06564     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1724">xxxCreateCaret</a>(
06565             pwnd,
06566             hBitmap,
06567             nWidth,
06568             nHeight
06569     );
06570 
06571     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserCreateCaret"</span>);
06572     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
06573 }
06574 
<a name="l06575"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a248">06575</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a248">NtUserEndPaint</a>(  <span class="comment">// API EndPaint</span>
06576     IN HWND hwnd,
06577     IN CONST PAINTSTRUCT *lpPaint)
06578 {
06579     PAINTSTRUCT ps;
06580 
06581     <span class="comment">//</span>
06582     <span class="comment">// N.B. This function has implicit window handle translation. This</span>
06583     <span class="comment">//      operation is performed in the User server API dispatcher.</span>
06584     <span class="comment">//</span>
06585 
06586     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, hwnd);
06587 
06588     <span class="comment">/*</span>
06589 <span class="comment">     * Probe arguments</span>
06590 <span class="comment">     */</span>
06591     <span class="keywordflow">try</span> {
06592         ps = <a class="code" href="../../d4/d1/userk_8h.html#a40">ProbeAndReadPaintStruct</a>(lpPaint);
06593     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
06594         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
06595     }
06596 
06597     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1711">xxxEndPaint</a>(pwnd, &amp;ps);
06598 
06599     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserEndPaint"</span>);
06600     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
06601 }
06602 
<a name="l06603"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a249">06603</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a249">NtUserExcludeUpdateRgn</a>(
06604     IN HDC hdc,
06605     IN HWND hwnd)
06606 {
06607 
06608     <span class="comment">//</span>
06609     <span class="comment">// N.B. This function has implicit window handle translation. This</span>
06610     <span class="comment">//      operation is performed in the User server API dispatcher.</span>
06611     <span class="comment">//</span>
06612 
06613     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a14">BEGINRECV_HWND</a>(<span class="keywordtype">int</span>, ERROR, hwnd);
06614 
06615     <span class="keywordflow">if</span> (hdc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
06616         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
06617 
06618     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1676">_ExcludeUpdateRgn</a>(hdc, pwnd);
06619 
06620     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserExcludeUpdateRgn"</span>);
06621     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a15">ENDRECV_HWND</a>();
06622 }
06623 
<a name="l06624"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a250">06624</a> HDC <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a250">NtUserGetDC</a>(
06625     IN HWND hwnd)
06626 {
06627     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
06628     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bValid = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06629 
06630     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(HDC, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
06631 
06632     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a57">ValidateHWNDOPT</a>(pwnd, hwnd);
06633 
06634     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a383">IS_CURRENT_THREAD_RESTRICTED</a>(JOB_OBJECT_UILIMIT_HANDLES) &amp;&amp; pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06635 
06636         <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;rpdesk;
06637 
06638         <span class="comment">/*</span>
06639 <span class="comment">         * make sure it has access to the desktop window</span>
06640 <span class="comment">         */</span>
06641         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>))) {
06642             bValid = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06643         }
06644     }
06645 
06646     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1694">_GetDC</a>(pwnd);
06647 
06648     <span class="keywordflow">if</span> (!bValid) {
06649 
06650         HRGN hrgn;
06651 
06652         <span class="comment">/*</span>
06653 <span class="comment">         * Select a NULL visible region on this DC so that restricted</span>
06654 <span class="comment">         * processes don't mess with GetDC(NULL)</span>
06655 <span class="comment">         */</span>
06656         hrgn = <a class="code" href="../../d4/d1/userk_8h.html#a1162">CreateEmptyRgn</a>();
06657 
06658         GreSelectVisRgn(retval, hrgn, SVR_DELETEOLD);
06659     }
06660 
06661     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetDC"</span>);
06662     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
06663 }
06664 
<a name="l06665"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a251">06665</a> HDC <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a251">NtUserGetDCEx</a>(
06666     IN HWND hwnd,
06667     IN HRGN hrgnClip,
06668     IN DWORD flags)
06669 {
06670     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
06671 
06672     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(HDC, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
06673 
06674     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a57">ValidateHWNDOPT</a>(pwnd, hwnd);
06675 
06676     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06677         pwnd = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;rpdesk-&gt;pDeskInfo-&gt;spwnd;
06678 
06679         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a383">IS_CURRENT_THREAD_RESTRICTED</a>(JOB_OBJECT_UILIMIT_HANDLES)) {
06680             <span class="comment">/*</span>
06681 <span class="comment">             * make sure it has access to the desktop window</span>
06682 <span class="comment">             */</span>
06683             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pwnd))) {
06684                 RIPMSG0(RIP_WARNING,
06685                         <span class="stringliteral">"NtUserGetDCEx fails desktop window validation"</span>);
06686                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
06687             }
06688         }
06689     }
06690 
06691     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>(
06692             pwnd,
06693             hrgnClip,
06694             flags);
06695 
06696     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetDCEx"</span>);
06697     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
06698 }
06699 
<a name="l06700"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a252">06700</a> HDC <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a252">NtUserGetWindowDC</a>(
06701     IN HWND hwnd)
06702 {
06703     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
06704 
06705     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(HDC, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
06706 
06707     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a57">ValidateHWNDOPT</a>(pwnd, hwnd);
06708 
06709     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1696">_GetWindowDC</a>(pwnd);
06710 
06711     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetWindowDC"</span>);
06712     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
06713 }
06714 
<a name="l06715"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a253">06715</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a253">NtUserGetUpdateRgn</a>(
06716     IN HWND hwnd,
06717     IN HRGN hrgn,
06718     IN BOOL bErase)
06719 {
06720 
06721     <span class="comment">//</span>
06722     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
06723     <span class="comment">//      enabled. These operations are performed in the User server API</span>
06724     <span class="comment">//      dispatcher.</span>
06725     <span class="comment">//</span>
06726 
06727     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(<span class="keywordtype">int</span>, ERROR, hwnd);
06728 
06729     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1675">xxxGetUpdateRgn</a>(
06730             pwnd,
06731             hrgn,
06732             bErase);
06733 
06734     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetUpdateRgn"</span>);
06735     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
06736 }
06737 
<a name="l06738"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a254">06738</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a254">NtUserRedrawWindow</a>(  <span class="comment">// API RedrawWindow</span>
06739     IN HWND hwnd,
06740     IN CONST RECT *lprcUpdate OPTIONAL,
06741     IN HRGN hrgnUpdate,
06742     IN UINT flags)
06743 {
06744     RECT rc;
06745 
06746     <span class="comment">//</span>
06747     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
06748     <span class="comment">//      enabled. These operations are performed in the User server API</span>
06749     <span class="comment">//      dispatcher.</span>
06750     <span class="comment">//</span>
06751 
06752     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a28">BEGINRECV_HWNDLOCK_OPT</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, hwnd);
06753 
06754     <span class="comment">/*</span>
06755 <span class="comment">     * Probe arguments</span>
06756 <span class="comment">     */</span>
06757     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(lprcUpdate)) {
06758         <span class="keywordflow">try</span> {
06759             rc = <a class="code" href="../../d4/d1/userk_8h.html#a31">ProbeAndReadRect</a>(lprcUpdate);
06760             lprcUpdate = &amp;rc;
06761         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
06762             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
06763         }
06764     }
06765 
06766     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a46">TESTFLAGS</a>(flags, RDW_VALIDMASK);
06767 
06768     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1679">xxxRedrawWindow</a>(
06769             pwnd,
06770             (PRECT)lprcUpdate,
06771             hrgnUpdate,
06772             flags);
06773 
06774     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserRedrawWindow"</span>);
06775     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a29">ENDRECV_HWNDLOCK_OPT</a>();
06776 }
06777 
<a name="l06778"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a255">06778</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a255">NtUserInvalidateRgn</a>(
06779     IN HWND hwnd,
06780     IN HRGN hrgn,
06781     IN BOOL bErase)
06782 {
06783 
06784     <span class="comment">//</span>
06785     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
06786     <span class="comment">//      enabled. These operations are performed in the User server API</span>
06787     <span class="comment">//      dispatcher.</span>
06788     <span class="comment">//</span>
06789 
06790     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, hwnd);
06791 
06792     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1671">xxxInvalidateRgn</a>(
06793             pwnd,
06794             hrgn,
06795             bErase);
06796 
06797     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserInvalidateRgn"</span>);
06798     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
06799 }
06800 
<a name="l06801"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a256">06801</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a256">NtUserSetWindowRgn</a>(
06802     IN HWND hwnd,
06803     IN HRGN hrgn,
06804     IN BOOL bRedraw)
06805 {
06806 
06807     <span class="comment">//</span>
06808     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
06809     <span class="comment">//      enabled. These operations are performed in the User server API</span>
06810     <span class="comment">//      dispatcher.</span>
06811     <span class="comment">//</span>
06812 
06813     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a26">BEGINRECV_HWNDLOCK_ND</a>(<span class="keywordtype">int</span>, 0, hwnd);
06814 
06815     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1610">xxxSetWindowRgn</a>(
06816             pwndND,
06817             hrgn,
06818             bRedraw);
06819 
06820     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetWindowRgn"</span>);
06821     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a27">ENDRECV_HWNDLOCK_ND</a>();
06822 }
06823 
<a name="l06824"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a257">06824</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a257">NtUserScrollDC</a>(  <span class="comment">// API ScrollDC</span>
06825     IN HDC hdc,
06826     IN <span class="keywordtype">int</span> dx,
06827     IN <span class="keywordtype">int</span> dy,
06828     IN CONST RECT *prcScroll OPTIONAL,
06829     IN CONST RECT *prcClip OPTIONAL,
06830     IN HRGN hrgnUpdate,
06831     OUT LPRECT prcUpdate OPTIONAL)
06832 {
06833     RECT rcScroll;
06834     RECT rcClip;
06835     RECT rcUpdate;
06836 
06837     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
06838 
06839     <span class="comment">/*</span>
06840 <span class="comment">     * Probe arguments</span>
06841 <span class="comment">     */</span>
06842     <span class="keywordflow">try</span> {
06843         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(prcScroll)) {
06844             rcScroll = <a class="code" href="../../d4/d1/userk_8h.html#a31">ProbeAndReadRect</a>(prcScroll);
06845             prcScroll = &amp;rcScroll;
06846         }
06847         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(prcClip)) {
06848             rcClip = <a class="code" href="../../d4/d1/userk_8h.html#a31">ProbeAndReadRect</a>(prcClip);
06849             prcClip = &amp;rcClip;
06850         }
06851 
06852     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
06853         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
06854     }
06855     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1762">_ScrollDC</a>(
06856                 hdc,
06857                 dx,
06858                 dy,
06859                 (PRECT)prcScroll,
06860                 (PRECT)prcClip,
06861                 hrgnUpdate,
06862                 prcUpdate ? &amp;rcUpdate : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
06863 
06864     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(prcUpdate)) {
06865         <span class="keywordflow">try</span> {
06866             <a class="code" href="../../d5/d8/ex_8h.html#a54">ProbeAndWriteStructure</a>(prcUpdate, rcUpdate, RECT);
06867         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
06868             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
06869         }
06870     }
06871     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
06872 }
06873 
<a name="l06874"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a258">06874</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a258">NtUserInternalGetWindowText</a>(  <span class="comment">// private InternalGetWindowText</span>
06875     IN HWND hwnd,
06876     OUT LPWSTR lpString,
06877     IN <span class="keywordtype">int</span> nMaxCount)
06878 {
06879 
06880     <span class="comment">//</span>
06881     <span class="comment">// N.B. This function has implicit window handle translation. This</span>
06882     <span class="comment">//      operation is performed in the User server API dispatcher.</span>
06883     <span class="comment">//</span>
06884 
06885     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a20">BEGINRECV_HWND_SHARED</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, 0, hwnd);
06886 
06887     <span class="keywordflow">if</span> (nMaxCount) {
06888         <span class="comment">/*</span>
06889 <span class="comment">         * Probe arguments</span>
06890 <span class="comment">         */</span>
06891         <span class="keywordflow">try</span> {
06892             <a class="code" href="../../d4/d1/userk_8h.html#a25">ProbeForWriteBuffer</a>(lpString, nMaxCount, <a class="code" href="../../d4/d1/userk_8h.html#a23">CHARALIGN</a>);
06893            <span class="comment">/*</span>
06894 <span class="comment">            * Initialize string empty.</span>
06895 <span class="comment">            */</span>
06896             *lpString = TEXT(<span class="charliteral">'\0'</span>);
06897             <span class="keywordflow">if</span> (pwnd-&gt;strName.Length) {
06898                 retval = <a class="code" href="../../d1/d5/w32_2ntuser_2rtl_2random_8c.html#a2">TextCopy</a>(&amp;pwnd-&gt;strName, lpString, nMaxCount);
06899             } <span class="keywordflow">else</span> {
06900                 retval = 0;
06901             }
06902 
06903         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
06904             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0); <span class="comment">// private API, don't SetLastError</span>
06905         }
06906     } <span class="keywordflow">else</span> {
06907         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
06908     }
06909 
06910     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserInternalGetWindowText"</span>);
06911     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a21">ENDRECV_HWND_SHARED</a>();
06912 }
06913 
<a name="l06914"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a259">06914</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a259">NtUserGetMouseMovePointsEx</a>(  <span class="comment">// API GetMouseMovePointsEx</span>
06915     IN UINT             cbSize,
06916     IN CONST MOUSEMOVEPOINT *lppt,
06917     OUT MOUSEMOVEPOINT *lpptBuf,
06918     IN UINT             nBufPoints,
06919     IN DWORD            resolution)
06920 {
06921     MOUSEMOVEPOINT mmp;
06922     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<span class="keywordtype">int</span>, -1);
06923 
06924     <span class="keywordflow">if</span> (cbSize != <span class="keyword">sizeof</span>(MOUSEMOVEPOINT) || nBufPoints &gt; <a class="code" href="../../d4/d1/userk_8h.html#a148">MAX_MOUSEPOINTS</a>) {
06925 
06926         RIPERR2(ERROR_INVALID_PARAMETER, RIP_VERBOSE,
06927                 <span class="stringliteral">"GetMouseMovePointsEx: invalid cbSize %d or nBufPoints %d"</span>,
06928                 cbSize, nBufPoints);
06929         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
06930     }
06931 
06932     <span class="comment">/*</span>
06933 <span class="comment">     * Probe arguments</span>
06934 <span class="comment">     */</span>
06935     <span class="keywordflow">try</span> {
06936         mmp = <a class="code" href="../../d5/d8/ex_8h.html#a27">ProbeAndReadStructure</a>(lppt, MOUSEMOVEPOINT);
06937         <a class="code" href="../../d4/d1/userk_8h.html#a25">ProbeForWriteBuffer</a>(lpptBuf, nBufPoints, <a class="code" href="../../d4/d1/userk_8h.html#a22">DATAALIGN</a>);
06938     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
06939         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
06940     }
06941 
06942     <span class="comment">/*</span>
06943 <span class="comment">     * GetMouseMovePointsEx protects itself with a try block.</span>
06944 <span class="comment">     * No it doesn't!</span>
06945 <span class="comment">     */</span>
06946 
06947     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1025">_GetMouseMovePointsEx</a>(&amp;mmp, lpptBuf, nBufPoints, resolution);
06948 
06949     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetMouseMovePointsEx"</span>);
06950     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
06951 }
06952 
<a name="l06953"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a260">06953</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a260">NtUserToUnicodeEx</a>(  <span class="comment">// API ToUnicode/ToUnicodeEx/ToAscii/ToAsciiEx</span>
06954     IN UINT wVirtKey,
06955     IN UINT wScanCode,
06956     IN CONST BYTE *lpKeyState,
06957     OUT LPWSTR pwszBuff,
06958     IN <span class="keywordtype">int</span> cchBuff,
06959     IN UINT wFlags,
06960     IN HKL hKeyboardLayout)
06961 {
06962     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> KeyState[256];
06963     WCHAR wcBuff[4];
06964     LPWSTR pwszBuffK;
06965     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bAlloc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06966     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
06967     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlInput;
06968 
06969     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<span class="keywordtype">int</span>, 0);
06970 
06971     <span class="keywordflow">if</span> (cchBuff &lt;= 0) {
06972         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(ERROR_INVALID_PARAMETER);
06973     }
06974 
06975     <span class="comment">/*</span>
06976 <span class="comment">     * Probe arguments</span>
06977 <span class="comment">     */</span>
06978     <span class="keywordflow">try</span> {
06979         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(lpKeyState, 256, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
06980         RtlCopyMemory(&amp;KeyState, lpKeyState, 256);
06981         <a class="code" href="../../d4/d1/userk_8h.html#a25">ProbeForWriteBuffer</a>(pwszBuff, cchBuff, <a class="code" href="../../d4/d1/userk_8h.html#a23">CHARALIGN</a>);
06982         <span class="keywordflow">if</span> (cchBuff &lt; 4) {
06983             pwszBuffK = wcBuff;
06984         }<span class="keywordflow">else</span> {
06985             pwszBuffK = UserAllocPoolWithQuota(cchBuff * <span class="keyword">sizeof</span>(WCHAR), TAG_UNICODEBUFFER);
06986             <span class="keywordflow">if</span> (pwszBuffK == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06987                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_NO_MEMORY);
06988             }
06989             bAlloc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06990             ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
06991             <a class="code" href="../../d4/d1/userk_8h.html#a137">ThreadLockPool</a>(ptiCurrent, pwszBuffK, &amp;tlInput);
06992         }
06993     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
06994         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
06995     }
06996 
06997     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1658">xxxToUnicodeEx</a>(
06998                 wVirtKey,
06999                 wScanCode,
07000                 KeyState,
07001                 pwszBuffK,
07002                 cchBuff,
07003                 wFlags,
07004                 hKeyboardLayout);
07005 
07006     <span class="keywordflow">try</span> {
07007         RtlCopyMemory(pwszBuff, pwszBuffK, cchBuff*<span class="keyword">sizeof</span>(WCHAR));
07008     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
07009         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
07010     }
07011 
07012     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a33">CLEANUPRECV</a>();
07013 
07014     <span class="keywordflow">if</span> (bAlloc) {
07015         <a class="code" href="../../d4/d1/userk_8h.html#a139">ThreadUnlockAndFreePool</a>(ptiCurrent, &amp;tlInput);
07016     }
07017 
07018     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserToUnicodeEx"</span>);
07019     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
07020 }
07021 
<a name="l07022"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a261">07022</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a261">NtUserYieldTask</a>(
07023     VOID)
07024 {
07025     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
07026 
07027     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
07028 
07029     <span class="comment">/*</span>
07030 <span class="comment">     * Make sure this process is running in the background if it is just</span>
07031 <span class="comment">     * spinning.</span>
07032 <span class="comment">     */</span>
07033     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
07034 
07035     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o1">cSpins</a>++;
07036 
07037     <span class="comment">/*</span>
07038 <span class="comment">     * CheckProcessBackground see input.c for comments</span>
07039 <span class="comment">     */</span>
07040     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o1">cSpins</a> &gt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a767">CSPINBACKGROUND</a>) {
07041         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o1">cSpins</a> = 0;
07042         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a804">TIF_SPINNING</a>;
07043         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o4">dwTIFlags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a804">TIF_SPINNING</a>;
07044 
07045         <span class="keywordflow">if</span> (!(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;W32PF_Flags &amp; W32PF_FORCEBACKGROUNDPRIORITY)) {
07046             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;W32PF_Flags |= W32PF_FORCEBACKGROUNDPRIORITY;
07047             <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a111">gppiWantForegroundPriority</a>) {
07048                 <a class="code" href="../../d4/d1/userk_8h.html#a1334">SetForegroundPriority</a>(ptiCurrent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
07049             }
07050         }
07051     }
07052 
07053     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1557">xxxUserYield</a>(ptiCurrent);
07054 
07055     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserYieldTask"</span>);
07056     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
07057 }
07058 
<a name="l07059"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a262">07059</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a262">NtUserWaitMessage</a>(
07060     VOID)
07061 {
07062     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
07063 
07064     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1634">xxxWaitMessage</a>();
07065 
07066     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserWaitMessage"</span>);
07067     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
07068 }
07069 
<a name="l07070"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a263">07070</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a263">NtUserLockWindowStation</a>(
07071     IN HWINSTA hwinsta)
07072 {
07073     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
07074     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
07075 
07076     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>, 0);
07077 
07078     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/validate_8c.html#a6">ValidateHwinsta</a>(hwinsta, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, 0, &amp;pwinsta);
07079     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
07080         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
07081 
07082     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1909">_LockWindowStation</a>(pwinsta);
07083 
07084     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pwinsta);
07085 
07086     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserLockWindowStation"</span>);
07087     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
07088 }
07089 
<a name="l07090"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a264">07090</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a264">NtUserUnlockWindowStation</a>(
07091     IN HWINSTA hwinsta)
07092 {
07093     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
07094     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
07095 
07096     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
07097 
07098     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/validate_8c.html#a6">ValidateHwinsta</a>(hwinsta, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, 0, &amp;pwinsta);
07099     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
07100         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
07101 
07102     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1910">_UnlockWindowStation</a>(pwinsta);
07103 
07104     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pwinsta);
07105 
07106     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserUnlockWindowStation"</span>);
07107     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
07108 }
07109 
<a name="l07110"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a265">07110</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a265">NtUserSetWindowStationUser</a>(  <span class="comment">// private SetWindowStationUser</span>
07111     IN HWINSTA hwinsta,
07112     IN PLUID pLuidUser,
07113     IN PSID pSidUser OPTIONAL,
07114     IN DWORD cbSidUser)
07115 {
07116     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
07117     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
07118     LUID luid;
07119     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
07120 
07121     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/validate_8c.html#a6">ValidateHwinsta</a>(hwinsta, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, 0, &amp;pwinsta);
07122     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
07123         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
07124 
07125     <span class="keywordflow">try</span> {
07126         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(pLuidUser, <span class="keyword">sizeof</span>(*pLuidUser), <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
07127         luid = *pLuidUser;
07128         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(pSidUser)) {
07129             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(pSidUser, cbSidUser, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
07130         }
07131     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
07132         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);  <span class="comment">// don't SetLastError for private API</span>
07133     }
07134 
07135     <span class="comment">/*</span>
07136 <span class="comment">     * SetWindowStationUser uses pSidUser in a try block.</span>
07137 <span class="comment">     */</span>
07138 
07139     retval = <a class="code" href="../../d8/d8/winsta_8c.html#a14">_SetWindowStationUser</a>(pwinsta, &amp;luid, pSidUser, cbSidUser);
07140 
07141     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a33">CLEANUPRECV</a>();
07142 
07143     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pwinsta);
07144 
07145     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetWindowStationUser"</span>);
07146     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
07147 }
07148 
<a name="l07149"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a266">07149</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a266">NtUserSetLogonNotifyWindow</a>(
07150     IN HWND hwnd)
07151 {
07152 
07153     <span class="comment">//</span>
07154     <span class="comment">// N.B. This function has implicit window handle translation. This</span>
07155     <span class="comment">//      operation is performed in the User server API dispatcher.</span>
07156     <span class="comment">//</span>
07157 
07158     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a14">BEGINRECV_HWND</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, hwnd);
07159 
07160     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1913">_SetLogonNotifyWindow</a>(pwnd);
07161 
07162     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetLogonNotifyWindow"</span>);
07163     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a15">ENDRECV_HWND</a>();
07164 }
07165 
<a name="l07166"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a267">07166</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a267">NtUserSetSystemCursor</a>(
07167     IN HCURSOR hcur,
07168     IN DWORD <span class="keywordtype">id</span>)
07169 {
07170     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcur;
07171 
07172     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
07173 
07174     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a64">ValidateHCURSOR</a>(pcur, hcur);
07175 
07176     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1110">zzzSetSystemCursor</a>(
07177             pcur,
07178             <span class="keywordtype">id</span>);
07179 
07180     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetSystemCursor"</span>);
07181     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
07182 }
07183 
<a name="l07184"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a268">07184</a> HCURSOR <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a268">NtUserGetCursorFrameInfo</a>(  <span class="comment">// private GetCursorFrameInfo (Obsolete? - IanJa)</span>
07185     IN HCURSOR hcur,
07186     IN <span class="keywordtype">int</span> iFrame,
07187     OUT LPDWORD pjifRate,
07188     OUT LPINT pccur)
07189 {
07190     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcur;
07191     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> jifRate;
07192     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> ccur;
07193 
07194     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(HCURSOR, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
07195 
07196     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a64">ValidateHCURSOR</a>(pcur, hcur);
07197 
07198     <span class="comment">/*</span>
07199 <span class="comment">     * Probe arguments</span>
07200 <span class="comment">     */</span>
07201     <span class="keywordflow">try</span> {
07202         <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(pjifRate);
07203         <a class="code" href="../../d5/d8/ex_8h.html#a39">ProbeForWriteLong</a>(pccur);
07204     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
07205         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);  <span class="comment">// don't SetLastError for private API</span>
07206     }
07207 
07208     retval = (HCURSOR)<a class="code" href="../../d4/d1/userk_8h.html#a1115">_GetCursorFrameInfo</a>(
07209                 pcur,
07210                 iFrame,
07211                 &amp;jifRate,
07212                 &amp;ccur);
07213         retval = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>((PVOID)retval);
07214     <span class="keywordflow">try</span> {
07215         *pjifRate = jifRate;
07216         *pccur = ccur;
07217     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
07218         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);  <span class="comment">// don't SetLastError for private API</span>
07219     }
07220 
07221     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetCursorFrameInfo"</span>);
07222     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
07223 }
07224 
<a name="l07225"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a269">07225</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a269">NtUserSetCursorContents</a>(
07226     IN HCURSOR hCursor,
07227     IN HCURSOR hCursorNew)
07228 {
07229     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pCursor;
07230     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pCursorNew;
07231 
07232     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
07233 
07234     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a64">ValidateHCURSOR</a>(pCursor, hCursor);
07235     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a64">ValidateHCURSOR</a>(pCursorNew, hCursorNew);
07236 
07237     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1789">_SetCursorContents</a>(pCursor, pCursorNew);
07238 
07239     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetCursorContents"</span>);
07240     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
07241 }
07242 
<a name="l07243"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a270">07243</a> HCURSOR <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a270">NtUserFindExistingCursorIcon</a>(  <span class="comment">// Various Icon/Cursor APIs</span>
07244     IN PUNICODE_STRING pstrModName,
07245     IN PUNICODE_STRING pstrResName,
07246     IN <a class="code" href="../../d9/d1/structtagCURSORFIND.html">PCURSORFIND</a>     pcfSearch)
07247 {
07248     ATOM           atomModName;
07249     UNICODE_STRING strModName;
07250     UNICODE_STRING strResName;
07251     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a>        pcurSrc;
07252     <a class="code" href="../../d9/d1/structtagCURSORFIND.html">CURSORFIND</a>     cfSearch;
07253 
07254     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(HCURSOR, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
07255 
07256     <span class="comment">/*</span>
07257 <span class="comment">     * Probe arguments</span>
07258 <span class="comment">     */</span>
07259     <span class="keywordflow">try</span> {
07260 
07261         cfSearch = <a class="code" href="../../d4/d1/userk_8h.html#a57">ProbeAndReadCursorFind</a>(pcfSearch);
07262 
07263         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a65">ValidateHCURSOROPT</a>(pcurSrc, cfSearch.<a class="code" href="../../d9/d1/structtagCURSORFIND.html#o0">hcur</a>);
07264 
07265         strModName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(pstrModName);
07266         <a class="code" href="../../d4/d1/userk_8h.html#a61">ProbeForReadUnicodeStringBuffer</a>(strModName);
07267 
07268         strResName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(pstrResName);
07269         <a class="code" href="../../d4/d1/userk_8h.html#a63">ProbeForReadUnicodeStringBufferOrId</a>(strResName);
07270 
07271     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
07272         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
07273     }
07274 
07275     <span class="comment">/*</span>
07276 <span class="comment">     * The ModName buffer is client-side, but UserFindAtom protects</span>
07277 <span class="comment">     * access.</span>
07278 <span class="comment">     */</span>
07279 
07280     atomModName = <a class="code" href="../../d4/d1/userk_8h.html#a1298">UserFindAtom</a>(strModName.Buffer);
07281 
07282     <span class="keywordflow">if</span> (atomModName) {
07283 
07284         <span class="comment">/*</span>
07285 <span class="comment">         * The ResName buffer is client-side.  FindExistincCursorIcon</span>
07286 <span class="comment">         * protects access.</span>
07287 <span class="comment">         */</span>
07288         retval = (HCURSOR)<a class="code" href="../../d4/d1/userk_8h.html#a1116">_FindExistingCursorIcon</a>(atomModName,
07289                                                   &amp;strResName,
07290                                                   pcurSrc,
07291                                                   &amp;cfSearch);
07292 
07293         retval = (HCURSOR)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>((<a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a>)retval);
07294 
07295     } <span class="keywordflow">else</span> {
07296 
07297         retval = 0;
07298     }
07299 
07300 
07301     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserFindExistingCursorIcon"</span>);
07302     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
07303 }
07304 
<a name="l07305"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a271">07305</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a271">NtUserSetCursorIconData</a>(  <span class="comment">// worker called by CreateIcon, CreateCursor etc.</span>
07306     IN HCURSOR         hCursor,
07307     IN PUNICODE_STRING pstrModName,
07308     IN PUNICODE_STRING pstrResName,
07309     IN <a class="code" href="../../d8/d1/structtagCURSORDATA.html">PCURSORDATA</a>     pData)
07310 {
07311     UNICODE_STRING strModName;
07312     UNICODE_STRING strResName;
07313     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a>        pCursor;
07314     <a class="code" href="../../d8/d1/structtagCURSORDATA.html">CURSORDATA</a>     curData;
07315     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>          cbData;
07316 
07317     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
07318 
07319     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a64">ValidateHCURSOR</a>(pCursor, hCursor);
07320 
07321     <span class="comment">/*</span>
07322 <span class="comment">     * Probe arguments</span>
07323 <span class="comment">     */</span>
07324     <span class="keywordflow">try</span> {
07325 
07326         strModName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(pstrModName);
07327         strResName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(pstrResName);
07328 
07329         <a class="code" href="../../d4/d1/userk_8h.html#a61">ProbeForReadUnicodeStringBuffer</a>(strModName);
07330         <a class="code" href="../../d4/d1/userk_8h.html#a63">ProbeForReadUnicodeStringBufferOrId</a>(strResName);
07331 
07332         curData = <a class="code" href="../../d4/d1/userk_8h.html#a60">ProbeAndReadCursorData</a>(pData);
07333 
07334         <span class="keywordflow">if</span> (curData.<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o0">CURSORF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a537">CURSORF_ACON</a>) {
07335             <span class="comment">/*</span>
07336 <span class="comment">             * Avoid overflow here.  Or we might end up probing less</span>
07337 <span class="comment">             * MCostea #199188</span>
07338 <span class="comment">             */</span>
07339             <span class="keywordflow">if</span> (HIWORD(curData.<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o12">cpcur</a>) | HIWORD(curData.<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o13">cicur</a>)) {
07340                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
07341             }
07342             <span class="comment">/*</span>
07343 <span class="comment">             * The code assumes that the memory was allocated in one chunk</span>
07344 <span class="comment">             * as in CreateAniIcon().  To prevent evil apps, do this check.</span>
07345 <span class="comment">             */</span>
07346             <span class="keywordflow">if</span> ((INT_PTR)curData.<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o16">ajifRate</a> != curData.<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o12">cpcur</a> * (INT_PTR) <span class="keyword">sizeof</span>(HCURSOR) ||
07347                 (INT_PTR)curData.<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o15">aicur</a> != (INT_PTR)curData.<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o16">ajifRate</a> + curData.<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o13">cicur</a> * (INT_PTR) <span class="keyword">sizeof</span>(JIF)) {
07348                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
07349             }
07350             cbData = (curData.<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o12">cpcur</a> * <span class="keyword">sizeof</span>(HCURSOR)) +
07351                      (curData.<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o13">cicur</a> * <span class="keyword">sizeof</span>(JIF)) +
07352                      (curData.<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o13">cicur</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
07353 
07354         } <span class="keywordflow">else</span> {
07355             cbData = 0;
07356         }
07357         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(curData.<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o14">aspcur</a>, cbData, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
07358 
07359     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
07360         <span class="comment">/*</span>
07361 <span class="comment">         * probed parameters are USER stack variables, not supplied by the</span>
07362 <span class="comment">         * application itself, so don't bother to SetLastError.</span>
07363 <span class="comment">         */</span>
07364         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
07365     }
07366 
07367     <span class="comment">/*</span>
07368 <span class="comment">     * SetCursorIconData guards use of the buffer addresses</span>
07369 <span class="comment">     * with try clauses.</span>
07370 <span class="comment">     */</span>
07371     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1114">_SetCursorIconData</a>(pCursor,
07372                                     &amp;strModName,
07373                                     &amp;strResName,
07374                                     &amp;curData,
07375                                     cbData);
07376 
07377     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetCursorIconData"</span>);
07378     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
07379 }
07380 
<a name="l07381"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a272">07381</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a272">NtUserGetMenuItemRect</a>(  <span class="comment">// API GetMenuItemRect</span>
07382     IN HWND hwnd,
07383     IN HMENU hMenu,
07384     IN UINT uItem,
07385     OUT LPRECT lprcItem)
07386 {
07387 
07388     <span class="comment">//</span>
07389     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
07390     <span class="comment">//      enabled. These operations are performed in the User server API</span>
07391     <span class="comment">//      dispatcher.</span>
07392     <span class="comment">//</span>
07393 
07394     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu;
07395     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpmenu;
07396     RECT rcItem;
07397 
07398     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a28">BEGINRECV_HWNDLOCK_OPT</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, 0, hwnd);
07399 
07400     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a61">ValidateHMENU</a>(pmenu, hMenu);
07401 
07402     <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pmenu, &amp;tlpmenu);
07403 
07404     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1601">xxxGetMenuItemRect</a>(
07405                 pwnd,
07406                 pmenu,
07407                 uItem,
07408                 &amp;rcItem);
07409     <span class="comment">/*</span>
07410 <span class="comment">     * Probe arguments</span>
07411 <span class="comment">     */</span>
07412     <span class="keywordflow">try</span> {
07413         <a class="code" href="../../d5/d8/ex_8h.html#a54">ProbeAndWriteStructure</a>(lprcItem, rcItem, RECT);
07414     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
07415         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
07416     }
07417 
07418     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a33">CLEANUPRECV</a>();
07419 
07420     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpmenu);
07421 
07422     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetMenuItemRect"</span>);
07423     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a29">ENDRECV_HWNDLOCK_OPT</a>();
07424 }
07425 
<a name="l07426"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a273">07426</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a273">NtUserMenuItemFromPoint</a>(  <span class="comment">// API MenuItemFromPoint</span>
07427     IN HWND hwnd,
07428     IN HMENU hMenu,
07429     IN POINT ptScreen)
07430 {
07431 
07432     <span class="comment">//</span>
07433     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
07434     <span class="comment">//      enabled. These operations are performed in the User server API</span>
07435     <span class="comment">//      dispatcher.</span>
07436     <span class="comment">//</span>
07437 
07438     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu;
07439     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpmenu;
07440 
07441     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a28">BEGINRECV_HWNDLOCK_OPT</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, -1, hwnd);
07442 
07443     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a61">ValidateHMENU</a>(pmenu, hMenu);
07444 
07445     <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pmenu, &amp;tlpmenu);
07446 
07447     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1600">xxxMenuItemFromPoint</a>(
07448             pwnd,
07449             pmenu,
07450             ptScreen);
07451 
07452     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpmenu);
07453 
07454     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserMenuItemFromPoint"</span>);
07455     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a29">ENDRECV_HWNDLOCK_OPT</a>();
07456 }
07457 
<a name="l07458"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a274">07458</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a274">NtUserGetCaretPos</a>(  <span class="comment">// API GetCaretPos</span>
07459     OUT LPPOINT lpPoint)
07460 {
07461 
07462     <span class="comment">//</span>
07463     <span class="comment">// N.B. This function has implicit window handle translation. This</span>
07464     <span class="comment">//      operation is performed in the User server API dispatcher.</span>
07465     <span class="comment">//</span>
07466 
07467     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
07468     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pq;
07469     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
07470 
07471     <span class="comment">/*</span>
07472 <span class="comment">     * Probe arguments</span>
07473 <span class="comment">     */</span>
07474     <span class="keywordflow">try</span> {
07475         <a class="code" href="../../d4/d1/userk_8h.html#a67">ProbeForWritePoint</a>(lpPoint);
07476 
07477         pti = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>();
07478         pq = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>;
07479         lpPoint-&gt;x = pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o18">caret</a>.<a class="code" href="../../d6/d9/structtagCARET.html#o4">x</a>;
07480         lpPoint-&gt;y = pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o18">caret</a>.<a class="code" href="../../d6/d9/structtagCARET.html#o5">y</a>;
07481         retval = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07482     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
07483         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
07484     }
07485 
07486     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetCaretPos"</span>);
07487     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
07488 }
07489 
<a name="l07490"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a275">07490</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a275">NtUserDefSetText</a>(
07491     IN HWND hwnd,
07492     IN <a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a> pstrText OPTIONAL)
07493 {
07494     <a class="code" href="../../d1/d9/struct__LARGE__STRING.html">LARGE_STRING</a> strText;
07495 
07496     <span class="comment">//</span>
07497     <span class="comment">// N.B. This function has implicit window handle translation. This</span>
07498     <span class="comment">//      operation is performed in the User server API dispatcher.</span>
07499     <span class="comment">//</span>
07500 
07501     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a14">BEGINRECV_HWND</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, 0, hwnd);
07502 
07503     <span class="comment">/*</span>
07504 <span class="comment">     * Probe arguments</span>
07505 <span class="comment">     */</span>
07506     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(pstrText)) {
07507         <span class="keywordflow">try</span> {
07508             strText = <a class="code" href="../../d4/d1/userk_8h.html#a34">ProbeAndReadLargeString</a>(pstrText);
07509 <span class="preprocessor">#if defined(_X86_)</span>
07510 <span class="preprocessor"></span>            <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(strText.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>, strText.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o0">Length</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
07511 <span class="preprocessor">#else</span>
07512 <span class="preprocessor"></span>            <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(strText.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>, strText.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o0">Length</a>,
07513                     strText.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o2">bAnsi</a> ? <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>) : <span class="keyword">sizeof</span>(WORD));
07514 <span class="preprocessor">#endif</span>
07515 <span class="preprocessor"></span>            pstrText = &amp;strText;
07516         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
07517             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);  <span class="comment">// WM_SETTEXT lParam</span>
07518         }
07519     }
07520 
07521     <span class="comment">/*</span>
07522 <span class="comment">     * pstrText buffer is client side.  DefSetText protects uses of the buffer.</span>
07523 <span class="comment">     */</span>
07524     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1529">DefSetText</a>(
07525             pwnd,
07526             pstrText);
07527 
07528     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserDefSetText"</span>);
07529     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a15">ENDRECV_HWND</a>();
07530 }
07531 
<a name="l07532"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a276">07532</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a276">NtUserQueryInformationThread</a>(
07533     IN HANDLE hThread,
07534     IN USERTHREADINFOCLASS ThreadInfoClass,
07535     OUT PVOID ThreadInformation,
07536     IN ULONG ThreadInformationLength,
07537     IN OUT PULONG ReturnLength OPTIONAL)
07538 {
07539     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a7">BEGINRECVCSRSS</a>(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>, STATUS_UNSUCCESSFUL);
07540     <span class="comment">/*</span>
07541 <span class="comment">     * note -- QueryInformationThread can call xxxSwitchDesktop, so it is not sharable</span>
07542 <span class="comment">     */</span>
07543 
07544     <span class="comment">/*</span>
07545 <span class="comment">     * Probe arguments -- no try/except</span>
07546 <span class="comment">     */</span>
07547 
07548 <span class="preprocessor">#if DBG</span>
07549 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ThreadInformation)) {
07550         <span class="keywordflow">switch</span> (ThreadInfoClass) {
07551         <span class="keywordflow">case</span> UserThreadShutdownInformation:
07552         <span class="keywordflow">case</span> UserThreadFlags:
07553         <span class="keywordflow">case</span> UserThreadWOWInformation:
07554         <span class="keywordflow">case</span> UserThreadHungStatus:
07555             <a class="code" href="../../d5/d8/ex_8h.html#a28">ProbeForWriteBoolean</a>((PBOOLEAN)ThreadInformation);
07556             <span class="keywordflow">break</span>;
07557         <span class="keywordflow">case</span> UserThreadTaskName:
07558             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(ThreadInformation, ThreadInformationLength,
07559                     <span class="keyword">sizeof</span>(WCHAR));
07560             <span class="keywordflow">break</span>;
07561         }
07562     }
07563     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength))
07564         <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(ReturnLength);
07565 <span class="preprocessor">#endif</span>
07566 <span class="preprocessor"></span>
07567     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1944">xxxQueryInformationThread</a>(hThread,
07568             ThreadInfoClass, ThreadInformation,
07569             ThreadInformationLength, ReturnLength);
07570 
07571     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserQueryInformationThread"</span>);
07572     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a8">ENDRECVCSRSS</a>();
07573 }
07574 
<a name="l07575"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">07575</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(
07576     IN HANDLE hThread,
07577     IN USERTHREADINFOCLASS ThreadInfoClass,
07578     IN PVOID ThreadInformation,
07579     IN ULONG ThreadInformationLength)
07580 {
07581     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a7">BEGINRECVCSRSS</a>(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>, STATUS_UNSUCCESSFUL);
07582 
07583     <span class="comment">/*</span>
07584 <span class="comment">     * Probe arguments outside a try clause -- CSRSS</span>
07585 <span class="comment">     */</span>
07586 <span class="preprocessor">#if DBG</span>
07587 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ThreadInfoClass == UserThreadUseDesktop) {
07588         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(ThreadInformation, ThreadInformationLength,
07589                 <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
07590     } <span class="keywordflow">else</span> {
07591         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(ThreadInformation, ThreadInformationLength,
07592                 <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
07593     }
07594 
07595 <span class="preprocessor">#endif</span>
07596 <span class="preprocessor"></span>
07597     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1945">xxxSetInformationThread</a>(hThread,
07598                 ThreadInfoClass, ThreadInformation,
07599                 ThreadInformationLength);
07600 
07601 
07602     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetInformationThread"</span>);
07603     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a8">ENDRECVCSRSS</a>();
07604 }
07605 
<a name="l07606"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a278">07606</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a278">NtUserSetInformationProcess</a>(
07607     IN HANDLE hProcess,
07608     IN USERPROCESSINFOCLASS ProcessInfoClass,
07609     IN PVOID ProcessInformation,
07610     IN ULONG ProcessInformationLength)
07611 {
07612     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a7">BEGINRECVCSRSS</a>(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>, STATUS_UNSUCCESSFUL);
07613 
07614     <span class="comment">/*</span>
07615 <span class="comment">     * Probe arguments without try/except</span>
07616 <span class="comment">     */</span>
07617 <span class="preprocessor">#if DBG</span>
07618 <span class="preprocessor"></span>    <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(ProcessInformation, ProcessInformationLength,
07619                 <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
07620 <span class="preprocessor">#endif</span>
07621 <span class="preprocessor"></span>
07622     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1946">SetInformationProcess</a>(hProcess,
07623                     ProcessInfoClass, ProcessInformation,
07624                     ProcessInformationLength);
07625 
07626 
07627     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetInformationProcess"</span>);
07628     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a8">ENDRECVCSRSS</a>();
07629 }
07630 
<a name="l07631"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a279">07631</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a279">NtUserNotifyProcessCreate</a>(
07632     IN DWORD dwProcessId,
07633     IN DWORD dwParentThreadId,
07634     IN ULONG_PTR dwData,
07635     IN DWORD dwFlags)
07636 {
07637     <span class="keyword">extern</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d3/queue_8c.html#a30">xxxUserNotifyProcessCreate</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> idProcess, <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> idParentThread,
07638             ULONG_PTR dwData, <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
07639 
07640     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a7">BEGINRECVCSRSS</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
07641 
07642     retval = <a class="code" href="../../d6/d3/queue_8c.html#a30">xxxUserNotifyProcessCreate</a>(dwProcessId,
07643             dwParentThreadId,
07644             dwData,
07645             <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
07646 
07647     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserNotifyProcessCreate"</span>);
07648     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a8">ENDRECVCSRSS</a>();
07649 }
07650 
<a name="l07651"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a280">07651</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a280">NtUserSoundSentry</a>(VOID)
07652 {
07653     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>, STATUS_UNSUCCESSFUL);
07654 
07655     retval = (<a class="code" href="../../d9/d3/access_8h.html#a74">_UserSoundSentryWorker</a>() ?
07656             STATUS_SUCCESS : STATUS_UNSUCCESSFUL);
07657 
07658     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSoundSentry"</span>);
07659     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
07660 }
07661 
<a name="l07662"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a281">07662</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a281">NtUserTestForInteractiveUser</a>(  <span class="comment">// private _UserTestTokenForInteractive</span>
07663     IN PLUID pluidCaller)
07664 {
07665     LUID luidCaller;
07666 
07667     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>, STATUS_UNSUCCESSFUL);
07668 
07669     <span class="comment">/*</span>
07670 <span class="comment">     * Probe arguments</span>
07671 <span class="comment">     */</span>
07672     <span class="keywordflow">try</span> {
07673         luidCaller = <a class="code" href="../../d5/d8/ex_8h.html#a27">ProbeAndReadStructure</a>(pluidCaller, LUID);
07674     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
07675         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
07676     }
07677 
07678     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1277">TestForInteractiveUser</a>(&amp;luidCaller);
07679 
07680     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserTestForInteractiveUser"</span>);
07681     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
07682 }
07683 
<a name="l07684"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a282">07684</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a282">NtUserSetConsoleReserveKeys</a>(
07685     IN HWND hwnd,
07686     IN DWORD fsReserveKeys)
07687 {
07688     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d8/ntinput_8c.html#a67">_SetConsoleReserveKeys</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>, <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
07689 
07690     <span class="comment">//</span>
07691     <span class="comment">// N.B. This function has implicit window handle translation. This</span>
07692     <span class="comment">//      operation is performed in the User server API dispatcher.</span>
07693     <span class="comment">//</span>
07694 
07695     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a14">BEGINRECV_HWND</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, hwnd);
07696 
07697     retval = <a class="code" href="../../d6/d8/ntinput_8c.html#a67">_SetConsoleReserveKeys</a>(pwnd, fsReserveKeys);
07698 
07699     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetConsoleReserveKeys"</span>);
07700     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a15">ENDRECV_HWND</a>();
07701 }
07702 
<a name="l07703"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a283">07703</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a283">NtUserModifyUserStartupInfoFlags</a>(
07704     IN DWORD dwMask,
07705     IN DWORD dwFlags)
07706 {
07707     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a12">BEGINRECV_VOID</a>();
07708 
07709     <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()-&gt;usi.dwFlags = (<a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()-&gt;usi.dwFlags &amp; ~dwMask) | (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; dwMask);
07710 
07711     <a class="code" href="../../d4/d1/userk_8h.html#a94">TRACEVOID</a>(<span class="stringliteral">"NtUserModifyUserStartupInfoFlags"</span>);
07712     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a13">ENDRECV_VOID</a>();
07713 }
07714 
<a name="l07715"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a284">07715</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a284">NtUserSetWindowFNID</a>(
07716     IN HWND hwnd,
07717     IN WORD fnid)
07718 {
07719     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a14">BEGINRECV_HWND</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, hwnd);
07720 
07721     <span class="comment">/*</span>
07722 <span class="comment">     * Don't let apps mess with windows on other processes.</span>
07723 <span class="comment">     */</span>
07724     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;ppi != <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()) {
07725         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
07726     }
07727 
07728     <span class="comment">/*</span>
07729 <span class="comment">     * Make sure the fnid is in the correct range.</span>
07730 <span class="comment">     */</span>
07731     <span class="keywordflow">if</span> (fnid != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a226">FNID_CLEANEDUP_BIT</a>) {
07732         <span class="keywordflow">if</span> ((fnid &lt; FNID_CONTROLSTART) || (fnid &gt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a209">FNID_CONTROLEND</a>) || (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd) != 0)) {
07733             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
07734         }
07735     }
07736 
07737     <span class="comment">/*</span>
07738 <span class="comment">     * Remember what window class this window belongs to.  Can't use</span>
07739 <span class="comment">     * the real class because any app can call CallWindowProc()</span>
07740 <span class="comment">     * directly no matter what the class is!</span>
07741 <span class="comment">     */</span>
07742     pwnd-&gt;fnid |= fnid;
07743     retval = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07744 
07745     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetWindowFNID"</span>);
07746     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a15">ENDRECV_HWND</a>();
07747 }
07748 
<a name="l07749"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a75">07749</a> <span class="preprocessor">#define AWS_MASK (BS_TYPEMASK | BS_RIGHT | BS_RIGHTBUTTON | \</span>
07750 <span class="preprocessor">        WS_HSCROLL | WS_VSCROLL | SS_TYPEMASK)</span>
07751 <span class="preprocessor"></span>
<a name="l07752"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a285">07752</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a285">NtUserAlterWindowStyle</a>(
07753     IN HWND hwnd,
07754     IN DWORD mask,
07755     IN DWORD flags)
07756 {
07757     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a18">BEGINRECV_HWND_VOID</a>(hwnd);
07758 
07759     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;ppi == <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()) {
07760 
07761 <span class="preprocessor">#if DBG</span>
07762 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (mask &amp; ~<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a75">AWS_MASK</a>) {
07763             RIPMSG1(RIP_WARNING, <span class="stringliteral">"NtUserAlterWindowStyle: bad mask %x"</span>, mask);
07764         }
07765 <span class="preprocessor">#endif</span>
07766 <span class="preprocessor"></span>
07767         mask &amp;= <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a75">AWS_MASK</a>;
07768         pwnd-&gt;style = (pwnd-&gt;style &amp; (~mask)) | (flags &amp; mask);
07769     } <span class="keywordflow">else</span> {
07770         RIPMSG1(RIP_WARNING, <span class="stringliteral">"NtUserAlterWIndowStyle: current ppi doesn't own pwnd %#p"</span>, pwnd);
07771     }
07772 
07773     <a class="code" href="../../d4/d1/userk_8h.html#a94">TRACEVOID</a>(<span class="stringliteral">"NtUserAlterWindowStyle"</span>);
07774     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a19">ENDRECV_HWND_VOID</a>();
07775 }
07776 
<a name="l07777"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a286">07777</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a286">NtUserSetThreadState</a>(
07778     IN DWORD dwFlags,
07779     IN DWORD dwMask)
07780 {
07781     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
07782     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwOldFlags;
07783 
07784     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; ~(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a867">QF_DIALOGACTIVE</a>)) {
07785         <span class="keywordflow">return</span>;
07786     }
07787 
07788     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a12">BEGINRECV_VOID</a>();
07789 
07790     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
07791     dwOldFlags = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a>;
07792     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> ^= ((dwOldFlags ^ <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>) &amp; dwMask);
07793 
07794     <a class="code" href="../../d4/d1/userk_8h.html#a94">TRACEVOID</a>(<span class="stringliteral">"NtUserSetThreadState"</span>);
07795     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a13">ENDRECV_VOID</a>();
07796 }
07797 
07798 
<a name="l07799"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a287">07799</a> ULONG_PTR <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a287">NtUserGetThreadState</a>(
07800     IN USERTHREADSTATECLASS ThreadState)
07801 {
07802     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>();
07803 
07804     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(ULONG_PTR, 0);
07805 
07806     <span class="keywordflow">switch</span> (ThreadState) {
07807     <span class="keywordflow">case</span> UserThreadStateFocusWindow:
07808         retval = (ULONG_PTR)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>);
07809         <span class="keywordflow">break</span>;
07810     <span class="keywordflow">case</span> UserThreadStateActiveWindow:
07811         retval = (ULONG_PTR)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>);
07812         <span class="keywordflow">break</span>;
07813     <span class="keywordflow">case</span> UserThreadStateCaptureWindow:
07814         retval = (ULONG_PTR)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a>);
07815         <span class="keywordflow">break</span>;
07816     <span class="keywordflow">case</span> UserThreadStateDefaultImeWindow:
07817         retval = (ULONG_PTR)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o39">spwndDefaultIme</a>);
07818         <span class="keywordflow">break</span>;
07819     <span class="keywordflow">case</span> UserThreadStateDefaultInputContext:
07820         retval = (ULONG_PTR)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o40">spDefaultImc</a>);
07821         <span class="keywordflow">break</span>;
07822     <span class="keywordflow">case</span> UserThreadStateImeCompatFlags:
07823         UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
07824         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o26">dwImeCompatFlags</a>);
07825         <span class="keywordflow">break</span>;
07826     <span class="keywordflow">case</span> UserThreadStatePreviousKeyboardLayout:
07827         retval = (ULONG_PTR)(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o41">hklPrev</a>);
07828         <span class="keywordflow">break</span>;
07829     <span class="keywordflow">case</span> UserThreadStateIsWinlogonThread:
07830         <span class="comment">// Client IMM checks if the process is Login;</span>
07831         <span class="comment">// to prevent switching dictionaries, etc.</span>
07832         <span class="comment">// LATER: gpidLogin per WinStation ?</span>
07833         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(<a class="code" href="../../d4/d1/userk_8h.html#a19">GetCurrentProcessId</a>() == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a>);
07834         <span class="keywordflow">break</span>;
07835     <span class="keywordflow">case</span> UserThreadStateIsConImeThread:
07836         UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
07837         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(<a class="code" href="../../d4/d1/userk_8h.html#a1201">PtiFromThreadId</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o18">dwConsoleIMEThreadId</a>) == ptiCurrent);
07838         <span class="keywordflow">break</span>;
07839     <span class="keywordflow">case</span> UserThreadStateInputState:
07840         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d4/d1/userk_8h.html#a1647">_GetInputState</a>();
07841         <span class="keywordflow">break</span>;
07842     <span class="keywordflow">case</span> UserThreadStateCursor:
07843         retval = (ULONG_PTR)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o19">spcurCurrent</a>);
07844         <span class="keywordflow">break</span>;
07845     <span class="keywordflow">case</span> UserThreadStateChangeBits:
07846         retval = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o1">fsChangeBits</a>;
07847         <span class="keywordflow">break</span>;
07848     <span class="keywordflow">case</span> UserThreadStatePeekMessage:
07849         <span class="comment">/*</span>
07850 <span class="comment">         * Update the last read time so that hung app painting won't occur.</span>
07851 <span class="comment">         */</span>
07852         <a class="code" href="../../d4/d1/userk_8h.html#a257">SET_TIME_LAST_READ</a>(ptiCurrent);
07853         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07854         <span class="keywordflow">break</span>;
07855     <span class="keywordflow">case</span> UserThreadStateExtraInfo:
07856         retval = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o25">ExtraInfo</a>;
07857         <span class="keywordflow">break</span>;
07858 
07859     <span class="keywordflow">case</span> UserThreadStateInSendMessage:
07860         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o12">psmsCurrent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07861             <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o12">psmsCurrent</a>-&gt;ptiSender != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07862                 retval = ISMEX_SEND;
07863             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o12">psmsCurrent</a>-&gt;flags &amp; (<a class="code" href="../../d4/d1/userk_8h.html#a429">SMF_CB_REQUEST</a> | <a class="code" href="../../d4/d1/userk_8h.html#a430">SMF_CB_REPLY</a>)) {
07864                 retval = ISMEX_CALLBACK;
07865             } <span class="keywordflow">else</span> {
07866                 retval = ISMEX_NOTIFY;
07867             }
07868 
07869             <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o12">psmsCurrent</a>-&gt;flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a424">SMF_REPLY</a>) {
07870                 retval |= ISMEX_REPLIED;
07871             }
07872         } <span class="keywordflow">else</span> {
07873             retval = ISMEX_NOSEND;
07874         }
07875         <span class="keywordflow">break</span>;
07876 
07877     <span class="keywordflow">case</span> UserThreadStateMessageTime:
07878         retval = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o14">timeLast</a>;
07879         <span class="keywordflow">break</span>;
07880     <span class="keywordflow">case</span> UserThreadStateIsForeground:
07881         retval = (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>);
07882         <span class="keywordflow">break</span>;
07883     <span class="keywordflow">case</span> UserThreadConnect:
07884         retval = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07885         <span class="keywordflow">break</span>;
07886     <span class="keywordflow">default</span>:
07887         RIPMSG1(RIP_WARNING, <span class="stringliteral">"NtUserGetThreadState invalid ThreadState:%#x"</span>, ThreadState);
07888         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
07889     }
07890 
07891     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
07892 }
07893 
<a name="l07894"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a288">07894</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a288">NtUserValidateHandleSecure</a>(
07895     IN HANDLE h)
07896 {
07897     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
07898 
07899     retval = <a class="code" href="../../d7/d3/validate_8c.html#a12">ValidateHandleSecure</a>(h);
07900 
07901     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserValidateHandleSecure"</span>);
07902     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
07903 }
07904 
<a name="l07905"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a289">07905</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a289">NtUserUserHandleGrantAccess</a>( <span class="comment">// API UserHandleGrantAccess</span>
07906     IN HANDLE hUserHandle,
07907     IN HANDLE hJob,
07908     IN BOOL   bGrant)
07909 {
07910     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>  <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
07911     <a class="code" href="../../d0/d3/struct__EJOB.html">PEJOB</a>     Job;
07912     <a class="code" href="../../d1/d9/structtagW32JOB.html">PW32JOB</a>   pW32Job;
07913     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>     dw;
07914     <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a>       phe;
07915     PULONG_PTR pgh;
07916     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>      retval;
07917     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>      errret = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07918 
07919     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
07920                     hJob,
07921                     JOB_OBJECT_SET_ATTRIBUTES,
07922                     *<a class="code" href="../../d9/d8/ntos_8h.html#a4">PsJobType</a>,
07923                     <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
07924                     (PVOID*)&amp;Job,
07925                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
07926 
07927     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
07928         RIPERR1(ERROR_INVALID_PARAMETER,
07929                 RIP_WARNING,
07930                 <span class="stringliteral">"UserHandleGrantAccess: invalid job handle %#p\n"</span>,
07931                 hJob);
07932         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07933     }
07934 
07935     <span class="comment">/*</span>
07936 <span class="comment">     * aquire the job's lock and after that enter the user</span>
07937 <span class="comment">     * critical section.</span>
07938 <span class="comment">     */</span>
07939     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
07940     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;Job-&gt;JobLock, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
07941 
07942     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
07943 
07944     <span class="comment">/*</span>
07945 <span class="comment">     * bail out if it doesn't have UI restrictions</span>
07946 <span class="comment">     */</span>
07947     <span class="keywordflow">if</span> (Job-&gt;UIRestrictionsClass == 0) {
07948         RIPERR1(ERROR_INVALID_PARAMETER,
07949                 RIP_WARNING,
07950                 <span class="stringliteral">"UserHandleGrantAccess: job %#p doesn't have UI restrictions\n"</span>,
07951                 hJob);
07952         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
07953     }
07954 
07955     <span class="comment">/*</span>
07956 <span class="comment">     * see if we have a W32JOB structure created for this job</span>
07957 <span class="comment">     */</span>
07958     pW32Job = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a113">gpJobsList</a>;
07959 
07960     <span class="keywordflow">while</span> (pW32Job) {
07961         <span class="keywordflow">if</span> (pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o1">Job</a> == Job) {
07962             <span class="keywordflow">break</span>;
07963         }
07964         pW32Job = pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o0">pNext</a>;
07965     }
07966 
07967     UserAssert(pW32Job != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
07968 
07969     <span class="keywordflow">try</span> {
07970         <span class="comment">/*</span>
07971 <span class="comment">         * Now, validate the 'unsecure' handle</span>
07972 <span class="comment">         */</span>
07973         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/rtl_2wow_8c.html#a6">HMValidateHandle</a>(hUserHandle, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a255">TYPE_GENERIC</a>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07974             RIPERR1(ERROR_INVALID_PARAMETER,
07975                     RIP_WARNING,
07976                     <span class="stringliteral">"UserHandleGrantAccess: invalid handle %#p\n"</span>,
07977                     hUserHandle);
07978 
07979             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
07980         }
07981 
07982         dw = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a432">HMIndexFromHandle</a>(hUserHandle);
07983 
07984         phe = &amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>[dw];
07985 
07986         phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o3">bFlags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a426">HANDLEF_GRANTED</a>;
07987 
07988         pgh = pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o9">pgh</a>;
07989 
07990         <span class="keywordflow">if</span> (bGrant) {
07991             <span class="comment">/*</span>
07992 <span class="comment">             * Add the handle to the process' list</span>
07993 <span class="comment">             */</span>
07994             <span class="keywordflow">if</span> (pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o7">ughCrt</a> == pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o8">ughMax</a>) {
07995 
07996                 <span class="keywordflow">if</span> (pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o7">ughCrt</a> == 0) {
07997                     pgh = UserAllocPool(<a class="code" href="../../d4/d1/userk_8h.html#a386">GH_SIZE</a> * <span class="keyword">sizeof</span>(*pgh), TAG_GRANTEDHANDLES);
07998                 } <span class="keywordflow">else</span> {
07999                     <span class="comment">/*</span>
08000 <span class="comment">                     * we need to grow the array</span>
08001 <span class="comment">                     */</span>
08002                     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> uBytes = (pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o8">ughMax</a>) * <span class="keyword">sizeof</span>(*pgh);
08003 
08004                     pgh = UserReAllocPool(pgh,
08005                                           uBytes,
08006                                           uBytes + <a class="code" href="../../d4/d1/userk_8h.html#a386">GH_SIZE</a> * <span class="keyword">sizeof</span>(*pgh),
08007                                           TAG_GRANTEDHANDLES);
08008                 }
08009 
08010                 <span class="keywordflow">if</span> (pgh == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08011                     RIPMSG0(RIP_WARNING, <span class="stringliteral">"UserHandleGrantAccess: out of memory\n"</span>);
08012                     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(ERROR_NOT_ENOUGH_MEMORY);
08013                 }
08014 
08015                 pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o9">pgh</a>     = pgh;
08016                 pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o8">ughMax</a> += <a class="code" href="../../d4/d1/userk_8h.html#a386">GH_SIZE</a>;
08017             }
08018 
08019             UserAssert(pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o7">ughCrt</a> &lt; pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o8">ughMax</a>);
08020 
08021             <span class="comment">/*</span>
08022 <span class="comment">             * see if the handle is not already granted to this process</span>
08023 <span class="comment">             */</span>
08024             <span class="keywordflow">for</span> (dw = 0; dw &lt; pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o7">ughCrt</a>; dw++) {
08025                 <span class="keywordflow">if</span> (*(pgh + dw) == (ULONG_PTR)hUserHandle) {
08026                     <span class="keywordflow">break</span>;
08027                 }
08028             }
08029 
08030             <span class="keywordflow">if</span> (dw &gt;= pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o7">ughCrt</a>) {
08031 
08032                 <span class="comment">/*</span>
08033 <span class="comment">                 * add the handle to the granted handles table</span>
08034 <span class="comment">                 */</span>
08035                 *(pgh + pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o7">ughCrt</a>) = (ULONG_PTR)hUserHandle;
08036 
08037                 (pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o7">ughCrt</a>)++;
08038             }
08039         } <span class="keywordflow">else</span> {
08040             <span class="comment">/*</span>
08041 <span class="comment">             * Remove the handle from the granted list</span>
08042 <span class="comment">             */</span>
08043             <span class="comment">/*</span>
08044 <span class="comment">             * search for the handle in the array.</span>
08045 <span class="comment">             */</span>
08046             <span class="keywordflow">for</span> (dw = 0; dw &lt; pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o7">ughCrt</a>; dw++) {
08047                 <span class="keywordflow">if</span> (*(pgh + dw) == (ULONG_PTR)hUserHandle) {
08048 
08049                     <span class="comment">/*</span>
08050 <span class="comment">                     * found the handle granted to this process</span>
08051 <span class="comment">                     */</span>
08052                     RtlMoveMemory(pgh + dw,
08053                                   pgh + dw + 1,
08054                                   (pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o7">ughCrt</a> - dw - 1) * <span class="keyword">sizeof</span>(*pgh));
08055 
08056                     (pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o7">ughCrt</a>)--;
08057                     <span class="keywordflow">break</span>;
08058                 }
08059             }
08060 <span class="preprocessor">#if DBG</span>
08061 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (dw &gt;= pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o7">ughCrt</a>) {
08062                 RIPERR1(ERROR_INVALID_HANDLE, RIP_WARNING,
08063                         <span class="stringliteral">"UserHandleGrantAccess(FALSE): handle not found %#p"</span>,
08064                         hUserHandle);
08065             }
08066 <span class="preprocessor">#endif // DBG</span>
08067 <span class="preprocessor"></span>        }
08068 
08069         retval = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
08070 
08071     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
08072         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
08073     }
08074 
08075     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a33">CLEANUPRECV</a>();
08076 
08077     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
08078     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;Job-&gt;JobLock);
08079     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
08080     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Job);
08081 
08082     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserUserHandleGrantAccess"</span>);
08083 
08084     <span class="keywordflow">return</span> retval;
08085 }
08086 
<a name="l08087"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a290">08087</a> HWND <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a290">NtUserCreateWindowEx</a>(
08088     IN DWORD dwExStyle,
08089     IN <a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a> pstrClassName,
08090     IN <a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a> pstrWindowName OPTIONAL,
08091     IN DWORD dwStyle,
08092     IN <span class="keywordtype">int</span> x,
08093     IN <span class="keywordtype">int</span> y,
08094     IN <span class="keywordtype">int</span> nWidth,
08095     IN <span class="keywordtype">int</span> nHeight,
08096     IN HWND hwndParent,
08097     IN HMENU hmenu,
08098     IN HANDLE hModule,
08099     IN LPVOID pParam,
08100     IN DWORD dwFlags)
08101 {
08102     <a class="code" href="../../d1/d9/struct__LARGE__STRING.html">LARGE_STRING</a> strClassName;
08103     <a class="code" href="../../d1/d9/struct__LARGE__STRING.html">LARGE_STRING</a> strWindowName;
08104     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndParent;
08105     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu;
08106     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndParent;
08107     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpmenu;
08108     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fLockMenu = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08109     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
08110 
08111     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(HWND, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
08112 
08113     <span class="keywordflow">if</span> (hwndParent != HWND_MESSAGE) {
08114         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a57">ValidateHWNDOPT</a>(pwndParent, hwndParent);
08115     } <span class="keywordflow">else</span>
08116         pwndParent = <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a15">_GetMessageWindow</a>();
08117 
08118 
08119     <span class="comment">/*</span>
08120 <span class="comment">     * Win3.1 only checks for WS_CHILD before treating pmenu as an id. This</span>
08121 <span class="comment">     * is a bug, because throughout the code, the real check is TestwndChild(),</span>
08122 <span class="comment">     * which checks (style &amp; (WS_CHILD | WS_POPUP)) == WS_CHILD. This is</span>
08123 <span class="comment">     * because old style "iconic popup" is WS_CHILD | WS_POPUP. So... if on</span>
08124 <span class="comment">     * win3.1 an app used ws_iconicpopup, menu validation would not occur</span>
08125 <span class="comment">     * (could crash if hmenu != NULL). On Win32, check for the real thing -</span>
08126 <span class="comment">     * but allow NULL!</span>
08127 <span class="comment">     */</span>
08128     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
08129     <span class="keywordflow">if</span> (((dwStyle &amp; (WS_CHILD | WS_POPUP)) != WS_CHILD) &amp;&amp;
08130             (hmenu != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
08131         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a61">ValidateHMENU</a>(pmenu, hmenu);
08132 
08133         <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pmenu, &amp;tlpmenu);
08134         fLockMenu = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
08135 
08136     } <span class="keywordflow">else</span> {
08137         pmenu = (<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>)hmenu;
08138     }
08139 
08140     <span class="comment">/*</span>
08141 <span class="comment">     * Mask out the new 5.0 extended style bits for apps</span>
08142 <span class="comment">     * that would try to use them and we'll fail in xxxCreateWindowEx</span>
08143 <span class="comment">     */</span>
08144     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/queue_8c.html#a35">GetAppCompatFlags2</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>) &amp; GACF2_NO50EXSTYLEBITSCW) {
08145 
08146 <span class="preprocessor">#if DBG</span>
08147 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (dwExStyle &amp; ~(WS_EX_VALID40 | WS_EX_INTERNAL)) {
08148             RIPMSG0(RIP_WARNING, <span class="stringliteral">"CreateWindowEx: appcompat removed 5.0 EX bits"</span>);
08149         }
08150 <span class="preprocessor">#endif</span>
08151 <span class="preprocessor"></span>
08152         dwExStyle &amp;= (WS_EX_VALID40 | WS_EX_INTERNAL);
08153     }
08154     
08155     <span class="comment">/*</span>
08156 <span class="comment">     * Probe arguments</span>
08157 <span class="comment">     */</span>
08158     <span class="keywordflow">try</span> {
08159 <span class="preprocessor">#if defined(_X86_)</span>
08160 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(pstrClassName)) {
08161             strClassName = <a class="code" href="../../d4/d1/userk_8h.html#a34">ProbeAndReadLargeString</a>(pstrClassName);
08162             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(strClassName.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>, strClassName.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o0">Length</a>,
08163                     <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
08164             pstrClassName = &amp;strClassName;
08165         }
08166         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(pstrWindowName)) {
08167             strWindowName = <a class="code" href="../../d4/d1/userk_8h.html#a34">ProbeAndReadLargeString</a>(pstrWindowName);
08168             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(strWindowName.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>, strWindowName.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o0">Length</a>,
08169                     <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
08170             pstrWindowName = &amp;strWindowName;
08171         }
08172 <span class="preprocessor">#else</span>
08173 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(pstrClassName)) {
08174             strClassName = <a class="code" href="../../d4/d1/userk_8h.html#a34">ProbeAndReadLargeString</a>(pstrClassName);
08175             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(strClassName.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>, strClassName.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o0">Length</a>,
08176                     <span class="keyword">sizeof</span>(WORD));
08177             pstrClassName = &amp;strClassName;
08178         }
08179         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(pstrWindowName)) {
08180             strWindowName = <a class="code" href="../../d4/d1/userk_8h.html#a34">ProbeAndReadLargeString</a>(pstrWindowName);
08181             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(strWindowName.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>, strWindowName.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o0">Length</a>,
08182                     (strWindowName.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o2">bAnsi</a> ? <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>) : <span class="keyword">sizeof</span>(WORD)));
08183             pstrWindowName = &amp;strWindowName;
08184         }
08185 <span class="preprocessor">#endif</span>
08186 <span class="preprocessor"></span>    } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
08187         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
08188     }
08189 
08190     <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwndParent, &amp;tlpwndParent);
08191 
08192     <span class="comment">/*</span>
08193 <span class="comment">     * The buffers for ClassName and WindowName are still in client space.</span>
08194 <span class="comment">     */</span>
08195 
08196     retval = (HWND)<a class="code" href="../../d4/d1/userk_8h.html#a1574">xxxCreateWindowEx</a>(
08197             dwExStyle,
08198             pstrClassName,
08199             pstrWindowName,
08200             dwStyle,
08201             x,
08202             y,
08203             nWidth,
08204             nHeight,
08205             pwndParent,
08206             pmenu,
08207             hModule,
08208             pParam,
08209             <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
08210     retval = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>((PVOID)retval);
08211 
08212     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndParent);
08213 
08214     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a33">CLEANUPRECV</a>();
08215     <span class="keywordflow">if</span> (fLockMenu)
08216         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpmenu);
08217 
08218     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserCreateWindowEx"</span>);
08219     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
08220 }
08221 
<a name="l08222"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a291">08222</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a291">NtUserBuildHwndList</a>(  <span class="comment">// worker for EnumWindows, EnumThreadWindows etc.</span>
08223     IN HDESK hdesk,
08224     IN HWND hwndNext,
08225     IN BOOL fEnumChildren,
08226     IN DWORD idThread,
08227     IN UINT cHwndMax,
08228     OUT HWND *phwndFirst,
08229     OUT PUINT pcHwndNeeded)
08230 {
08231     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndNext;
08232     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk;
08233     <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> pbwl;
08234     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
08235     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cHwndNeeded;
08236     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> wFlags = <a class="code" href="../../d4/d1/userk_8h.html#a410">BWL_ENUMLIST</a>;
08237     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>, STATUS_INVALID_HANDLE);
08238 
08239     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
08240         <span class="comment">// special treatment of IME Window</span>
08241         wFlags |= <a class="code" href="../../d4/d1/userk_8h.html#a412">BWL_ENUMIMELAST</a>;
08242     }
08243 
08244     <span class="comment">/*</span>
08245 <span class="comment">     * Validate prior to referencing the desktop</span>
08246 <span class="comment">     */</span>
08247     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a57">ValidateHWNDOPT</a>(pwndNext, hwndNext);
08248 
08249     <span class="keywordflow">if</span> (idThread) {
08250         pti = <a class="code" href="../../d4/d1/userk_8h.html#a1201">PtiFromThreadId</a>(idThread);
08251         <span class="keywordflow">if</span> (pti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>){
08252             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(ERROR_INVALID_PARAMETER);
08253         }
08254         pwndNext = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
08255     } <span class="keywordflow">else</span> {
08256         pti = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08257     }
08258 
08259     <span class="keywordflow">if</span> (hdesk) {
08260         retval = <a class="code" href="../../d7/d3/validate_8c.html#a7">ValidateHdesk</a>(hdesk, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, DESKTOP_READOBJECTS, &amp;pdesk);
08261         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(retval)){
08262             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(ERROR_INVALID_HANDLE);
08263         }
08264         pwndNext = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
08265     } <span class="keywordflow">else</span> {
08266         pdesk = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08267     }
08268 
08269 
08270     <span class="keywordflow">if</span> (pwndNext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08271         <span class="comment">/*</span>
08272 <span class="comment">         * Bug: 262004 joejo</span>
08273 <span class="comment">         * If we have a valid desk (just no windows on it), then we need</span>
08274 <span class="comment">         * to fall through. Otherwise, we'll just grab the current desktop and enum it's</span>
08275 <span class="comment">         * windows!</span>
08276 <span class="comment">         */</span>
08277         <span class="keywordflow">if</span> (pdesk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08278             <span class="keywordflow">if</span> (pti != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08279                 pwndNext = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
08280             } <span class="keywordflow">else</span> {
08281                 pwndNext = <a class="code" href="../../d3/d9/client_2wow_8c.html#a3">_GetDesktopWindow</a>()-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
08282             }
08283         }
08284     } <span class="keywordflow">else</span> {
08285         <span class="keywordflow">if</span> (fEnumChildren) {
08286             wFlags |= <a class="code" href="../../d4/d1/userk_8h.html#a409">BWL_ENUMCHILDREN</a>;
08287             pwndNext = pwndNext-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
08288         }
08289     }
08290 
08291     <span class="keywordflow">if</span> ((pbwl = <a class="code" href="../../d4/d1/userk_8h.html#a1157">BuildHwndList</a>(pwndNext, wFlags, pti)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08292         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(ERROR_NOT_ENOUGH_MEMORY);
08293     }
08294 
08295     cHwndNeeded = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o1">phwndNext</a> - pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o4">rghwnd</a>) + 1;
08296 
08297     <span class="comment">/*</span>
08298 <span class="comment">     * Probe arguments</span>
08299 <span class="comment">     */</span>
08300     <span class="keywordflow">try</span> {
08301         <a class="code" href="../../d4/d1/userk_8h.html#a25">ProbeForWriteBuffer</a>(phwndFirst, cHwndMax, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
08302         <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(pcHwndNeeded);
08303 
08304        <span class="comment">/*</span>
08305 <span class="comment">        * If we have enough space, copy out list of hwnds to user mode buffer.</span>
08306 <span class="comment">        */</span>
08307         <span class="keywordflow">if</span> (cHwndNeeded &lt;= cHwndMax) {
08308             RtlCopyMemory(phwndFirst, pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o4">rghwnd</a>, cHwndNeeded * <span class="keyword">sizeof</span>(HWND));
08309             retval = STATUS_SUCCESS;
08310         } <span class="keywordflow">else</span> {
08311             retval = STATUS_BUFFER_TOO_SMALL;
08312         }
08313         *pcHwndNeeded = cHwndNeeded;
08314     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
08315         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);  <span class="comment">// phwndFirst/pcHwndNeeded are USER's, not app's</span>
08316     }
08317 
08318     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a33">CLEANUPRECV</a>();
08319 
08320     <span class="keywordflow">if</span> (pbwl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08321         <a class="code" href="../../d4/d1/userk_8h.html#a1158">FreeHwndList</a>(pbwl);
08322     }
08323 
08324     <span class="keywordflow">if</span> (pdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08325         <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdesk, LD_DEREF_VALIDATE_HDESK4, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
08326         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pdesk);
08327     }
08328 
08329     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserBuildHwndList"</span>);
08330     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
08331 }
08332 
<a name="l08333"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a292">08333</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a292">NtUserBuildPropList</a>(  <span class="comment">// worker for EnumProps etc.</span>
08334     IN HWND hwnd,
08335     IN UINT cPropMax,
08336     OUT <a class="code" href="../../d2/d1/struct__PROPSET.html">PPROPSET</a> pPropSet,
08337     OUT PUINT pcPropNeeded)
08338 {
08339     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>, STATUS_INVALID_HANDLE, hwnd);
08340 
08341     <span class="keywordflow">if</span> (cPropMax == 0) {
08342         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
08343     }
08344 
08345     <span class="comment">/*</span>
08346 <span class="comment">     * Probe arguments</span>
08347 <span class="comment">     */</span>
08348     <span class="keywordflow">try</span> {
08349         <a class="code" href="../../d4/d1/userk_8h.html#a25">ProbeForWriteBuffer</a>(pPropSet, cPropMax, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
08350         <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(pcPropNeeded);
08351 
08352         retval = <a class="code" href="../../d4/d8/kernel_2winprop_8c.html#a2">_BuildPropList</a>(
08353                 pwnd,
08354                 pPropSet,
08355                 cPropMax,
08356                 pcPropNeeded);
08357     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
08358         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);  <span class="comment">// pPropSet/pcPropNeed are USER's, not app's</span>
08359     }
08360 
08361     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserBuildPropList"</span>);
08362     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
08363 }
08364 
<a name="l08365"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a293">08365</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a293">NtUserBuildNameList</a>(  <span class="comment">// worker for EnumWindowStations/EnumDesktops</span>
08366     IN HWINSTA hwinsta,
08367     IN UINT cbNameList,
08368     OUT <a class="code" href="../../d8/d2/structtagNAMELIST.html">PNAMELIST</a> pNameList,
08369     OUT PUINT pcbNeeded)
08370 {
08371     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cbNeeded;
08372     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08373 
08374     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>, STATUS_INVALID_HANDLE);
08375 
08376     <span class="keywordflow">if</span> (cbNameList &lt; <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d2/structtagNAMELIST.html">NAMELIST</a>)) {
08377         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
08378     }
08379 
08380     <span class="keywordflow">try</span> {
08381         <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(pcbNeeded);
08382         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(pNameList, cbNameList, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
08383     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
08384         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
08385     }
08386 
08387     <span class="keywordflow">if</span> (hwinsta != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08388         retval = <a class="code" href="../../d7/d3/validate_8c.html#a6">ValidateHwinsta</a>(hwinsta, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, WINSTA_ENUMDESKTOPS, &amp;pwinsta);
08389     } <span class="keywordflow">else</span> {
08390         retval = STATUS_SUCCESS;
08391     }
08392 
08393     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(retval)) {
08394         <span class="keywordflow">try</span> {
08395             *pNameList-&gt;awchNames = 0;
08396             pNameList-&gt;cb = 1;
08397         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
08398             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
08399         }
08400 
08401      }  <span class="keywordflow">else</span> {
08402         <span class="comment">/*</span>
08403 <span class="comment">         * Note -- pNameList is a client-side pointers.</span>
08404 <span class="comment">         *         BuildNameList protects access with try blocks.</span>
08405 <span class="comment">         */</span>
08406 
08407         retval = <a class="code" href="../../d8/d8/winsta_8c.html#a12">_BuildNameList</a>(
08408                     pwinsta,
08409                     pNameList,
08410                     cbNameList,
08411                     &amp;cbNeeded);
08412         <span class="keywordflow">try</span> {
08413             *pcbNeeded = cbNeeded;
08414         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
08415             retval = STATUS_ACCESS_VIOLATION;
08416         }
08417     }
08418 
08419     <span class="keywordflow">if</span> (pwinsta != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
08420         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pwinsta);
08421 
08422     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserBuildNameList"</span>);
08423     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
08424 }
08425 
<a name="l08426"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a294">08426</a> HKL <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a294">NtUserActivateKeyboardLayout</a>(
08427     IN HKL hkl,
08428     IN UINT Flags)
08429 {
08430     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(HKL, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
08431 
08432     <span class="comment">/*</span>
08433 <span class="comment">     * Prevent restricted threads from setting the keyboard layout</span>
08434 <span class="comment">     * for the entire system.</span>
08435 <span class="comment">     */</span>
08436     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a383">IS_CURRENT_THREAD_RESTRICTED</a>(JOB_OBJECT_UILIMIT_HANDLES)) {
08437         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
08438     }
08439 
08440     retval = (HKL)<a class="code" href="../../d4/d1/userk_8h.html#a1303">xxxActivateKeyboardLayout</a>(
08441                      <a class="code" href="../../d8/d8/winsta_8c.html#a11">_GetProcessWindowStation</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>),
08442                      hkl,
08443                      Flags, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
08444 
08445     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserActivateKeyboardLayout"</span>);
08446     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
08447 }
08448 
<a name="l08449"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a295">08449</a> HKL <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a295">NtUserLoadKeyboardLayoutEx</a>(
08450     IN HANDLE hFile,
08451     IN DWORD offTable,
08452     IN HKL hkl,
08453     IN PUNICODE_STRING pstrKLID,
08454     IN UINT KbdInputLocale,
08455     IN UINT Flags)
08456 {
08457     UNICODE_STRING strKLID;
08458     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
08459     WCHAR awchKF[<span class="keyword">sizeof</span>(((<a class="code" href="../../d4/d9/structtagKL.html">PKL</a>)0)-&gt;spkf-&gt;awchKF)];
08460     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> chMax;
08461 
08462     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(HKL, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
08463 
08464     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a46">TESTFLAGS</a>(Flags, KLF_VALID);
08465 
08466     pwinsta = <a class="code" href="../../d8/d8/winsta_8c.html#a11">_GetProcessWindowStation</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
08467 
08468     <span class="comment">/*</span>
08469 <span class="comment">     * Probe arguments</span>
08470 <span class="comment">     */</span>
08471     <span class="keywordflow">try</span> {
08472         strKLID = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(pstrKLID);
08473         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(strKLID.Buffer, strKLID.Length, <a class="code" href="../../d4/d1/userk_8h.html#a23">CHARALIGN</a>);
08474         chMax = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(<span class="keyword">sizeof</span>(awchKF) - <span class="keyword">sizeof</span>(WCHAR), strKLID.Length) / <span class="keyword">sizeof</span>(WCHAR);
08475         wcsncpy(awchKF, strKLID.Buffer, chMax);
08476         awchKF[chMax] = 0;
08477     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
08478         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
08479     }
08480 
08481     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1302">xxxLoadKeyboardLayoutEx</a>(
08482             pwinsta,
08483             hFile,
08484             hkl,
08485             offTable,
08486             awchKF,
08487             KbdInputLocale,
08488             Flags);
08489 
08490     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserLoadKeyboardLayoutEx"</span>);
08491     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
08492 }
08493 
<a name="l08494"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a296">08494</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a296">NtUserUnloadKeyboardLayout</a>(
08495     IN HKL hkl)
08496 {
08497     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
08498 
08499     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1306">xxxUnloadKeyboardLayout</a>(
08500                      <a class="code" href="../../d8/d8/winsta_8c.html#a11">_GetProcessWindowStation</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>),
08501                      hkl);
08502 
08503     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserUnloadKeyboardLayout"</span>);
08504     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
08505 }
08506 
<a name="l08507"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a297">08507</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a297">NtUserSetSystemMenu</a>(
08508     IN HWND hwnd,
08509     IN HMENU hmenu)
08510 {
08511 
08512     <span class="comment">//</span>
08513     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
08514     <span class="comment">//      enabled. These operations are performed in the User server API</span>
08515     <span class="comment">//      dispatcher.</span>
08516     <span class="comment">//</span>
08517 
08518     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu;
08519     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpmenu;
08520 
08521     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, 0, hwnd);
08522 
08523     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a61">ValidateHMENU</a>(pmenu, hmenu);
08524 
08525     <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pmenu, &amp;tlpmenu);
08526 
08527     retval =  <a class="code" href="../../d4/d1/userk_8h.html#a1390">xxxSetSystemMenu</a>(pwnd, pmenu);
08528 
08529     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpmenu);
08530 
08531     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetSystemMenu"</span>);
08532     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
08533 }
08534 
<a name="l08535"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a298">08535</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a298">NtUserDragDetect</a>(
08536     IN HWND hwnd,
08537     IN POINT pt)
08538 {
08539 
08540     <span class="comment">//</span>
08541     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
08542     <span class="comment">//      enabled. These operations are performed in the User server API</span>
08543     <span class="comment">//      dispatcher.</span>
08544     <span class="comment">//</span>
08545 
08546     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, 0, hwnd);
08547 
08548     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1312">xxxDragDetect</a>(pwnd, pt);
08549 
08550     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserDragDetect"</span>);
08551     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
08552 }
08553 
<a name="l08554"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a299">08554</a> UINT_PTR <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a299">NtUserSetSystemTimer</a>(
08555     IN HWND hwnd,
08556     IN UINT_PTR nIDEvent,
08557     IN DWORD dwElapse,
08558     IN WNDPROC pTimerFunc)
08559 {
08560 
08561     <span class="comment">//</span>
08562     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
08563     <span class="comment">//      enabled. These operations are performed in the User server API</span>
08564     <span class="comment">//      dispatcher.</span>
08565     <span class="comment">//</span>
08566 
08567     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a14">BEGINRECV_HWND</a>(UINT_PTR, 0, hwnd);
08568 
08569     UNREFERENCED_PARAMETER(pTimerFunc);
08570 
08571     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1894">_SetSystemTimer</a>(pwnd,
08572             nIDEvent,
08573             dwElapse,
08574             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
08575 
08576     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetSystemTimer"</span>);
08577     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a15">ENDRECV_HWND</a>();
08578 }
08579 
<a name="l08580"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a300">08580</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a300">NtUserQuerySendMessage</a>(  <span class="comment">// private QuerySendMessage</span>
08581     OUT PMSG pmsg OPTIONAL)
08582 {
08583     <a class="code" href="../../d4/d1/userk_8h.html#a871">PSMS</a> psms;
08584     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
08585 
08586     <span class="comment">/*</span>
08587 <span class="comment">     * This function looks like dead code. If it's not, it can be optimized</span>
08588 <span class="comment">     * by using the CTIF_INSENDMESSAGE flag from user mode. - JerrySh</span>
08589 <span class="comment">     */</span>
08590     RIPMSG0(RIP_ERROR, <span class="stringliteral">"I don't think QuerySendMessage ever gets called. Remove this assert if it does."</span>);
08591 
08592     <span class="keywordflow">if</span> ((psms = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>()-&gt;psmsCurrent) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08593         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
08594     }
08595 
08596     retval = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
08597     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(pmsg)) {
08598         <span class="keywordflow">try</span> {
08599             <a class="code" href="../../d4/d1/userk_8h.html#a69">ProbeForWriteMessage</a>(pmsg);
08600             pmsg-&gt;hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(psms-&gt;spwnd);
08601             pmsg-&gt;message = psms-&gt;message;
08602             pmsg-&gt;wParam = psms-&gt;wParam;
08603             pmsg-&gt;lParam = psms-&gt;lParam;
08604             pmsg-&gt;time = psms-&gt;tSent;
08605             pmsg-&gt;pt.x = 0;
08606             pmsg-&gt;pt.y = 0;
08607             retval = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
08608         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
08609             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
08610         }
08611     }
08612 
08613     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserQuerySendMessage"</span>);
08614     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
08615 }
08616 
<a name="l08617"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a301">08617</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a301">NtUserSendInput</a>(
08618     IN UINT    cInputs,
08619     IN CONST INPUT *pInputs,
08620     IN <span class="keywordtype">int</span>     cbSize)
08621 {
08622     LPINPUT pInput2 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08623     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
08624     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlInput;
08625     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwArgumentError = ERROR_INVALID_PARAMETER;
08626 
08627     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>, 0);
08628 
08629     <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>(INPUT) != cbSize || cInputs == 0) {
08630         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(dwArgumentError);
08631     }
08632 
08633     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
08634 
08635     <span class="comment">/*</span>
08636 <span class="comment">     * Probe arguments</span>
08637 <span class="comment">     */</span>
08638     <span class="keywordflow">try</span> {
08639         <a class="code" href="../../d4/d1/userk_8h.html#a24">ProbeForReadBuffer</a>(pInputs, cInputs, <a class="code" href="../../d4/d1/userk_8h.html#a22">DATAALIGN</a>);
08640 
08641         pInput2 = UserAllocPoolWithQuota(cInputs * <span class="keyword">sizeof</span>(*pInputs), TAG_SENDINPUT);
08642         <span class="keywordflow">if</span> (pInput2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08643             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_NO_MEMORY);
08644         }
08645         RtlCopyMemory(pInput2, pInputs, cInputs * <span class="keyword">sizeof</span>(*pInputs));
08646     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
08647         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
08648     }
08649 
08650     <a class="code" href="../../d4/d1/userk_8h.html#a137">ThreadLockPool</a>(ptiCurrent, pInput2, &amp;tlInput);
08651     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1023">xxxSendInput</a>(cInputs, pInput2);
08652     <a class="code" href="../../d4/d1/userk_8h.html#a138">ThreadUnlockPool</a>(ptiCurrent, &amp;tlInput);
08653 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a33">CLEANUPRECV</a>();
08654     <span class="keywordflow">if</span> (pInput2) {
08655         UserFreePool(pInput2);
08656     }
08657     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSendInput"</span>);
08658     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
08659 }
08660 
<a name="l08661"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a302">08661</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a302">NtUserBlockInput</a>(
08662     IN BOOL fBlockIt)
08663 {
08664     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
08665     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1024">_BlockInput</a>(fBlockIt);
08666     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserBlockInput"</span>);
08667     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
08668 }
08669 
<a name="l08670"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a303">08670</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a303">NtUserImpersonateDdeClientWindow</a>(
08671     IN HWND hwndClient,
08672     IN HWND hwndServer)
08673 {
08674 
08675     <span class="comment">//</span>
08676     <span class="comment">// N.B. This function has implicit window handle translation. This</span>
08677     <span class="comment">//      operation is performed in the User server API dispatcher.</span>
08678     <span class="comment">//</span>
08679 
08680     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndServer;
08681 
08682     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a16">BEGINATOMICRECV_HWND</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, hwndClient);
08683 
08684     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a55">ValidateHWND</a>(pwndServer, hwndServer);
08685     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndServer) != <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()) {
08686         RIPERR0(ERROR_INVALID_PARAMETER, RIP_VERBOSE, <span class="stringliteral">""</span>);
08687         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
08688     }
08689 
08690     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a458">GETPWNDPPI</a>(pwnd) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a458">GETPWNDPPI</a>(pwndServer)) {
08691         retval = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;  <span class="comment">// impersonating self is a NOOP</span>
08692     } <span class="keywordflow">else</span> {
08693         retval = <a class="code" href="../../d4/d1/userk_8h.html#a1879">_ImpersonateDdeClientWindow</a>(pwnd, pwndServer);
08694     }
08695 
08696     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserImpersonateDdeClientWindow"</span>);
08697     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a17">ENDATOMICRECV_HWND</a>();
08698 }
08699 
<a name="l08700"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a304">08700</a> ULONG_PTR <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a304">NtUserGetCPD</a>(
08701     IN HWND hwnd,
08702     IN DWORD options,
08703     IN ULONG_PTR dwData)
08704 {
08705 
08706     <span class="comment">//</span>
08707     <span class="comment">// N.B. This function has implicit window handle translation. This</span>
08708     <span class="comment">//      operation is performed in the User server API dispatcher.</span>
08709     <span class="comment">//</span>
08710 
08711     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a14">BEGINRECV_HWND</a>(ULONG_PTR, 0, hwnd);
08712 
08713     <span class="keywordflow">switch</span> (options &amp; ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a461">CPD_TRANSITION_TYPES</a>) {
08714     <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a463">CPD_WND</a>:
08715     <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a464">CPD_DIALOG</a>:
08716     <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a465">CPD_WNDTOCLS</a>:
08717         <span class="keywordflow">break</span>;
08718     <span class="keywordflow">default</span>:
08719         RIPMSG1(RIP_WARNING, <span class="stringliteral">"GetCPD: Invalid options %x"</span>, options);
08720         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
08721     }
08722 
08723     retval = <a class="code" href="../../d0/d5/ntuser_2kernel_2getset_8c.html#a7">GetCPD</a>(pwnd, options, dwData);
08724 
08725     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetCPD"</span>);
08726     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a15">ENDRECV_HWND</a>();
08727 }
08728 
<a name="l08729"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a305">08729</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a305">NtUserCopyAcceleratorTable</a>(  <span class="comment">// API CopyAcceleratorTableA/W</span>
08730     IN HACCEL hAccelSrc,
08731     IN OUT LPACCEL lpAccelDst OPTIONAL,
08732     IN <span class="keywordtype">int</span> cAccel)
08733 {
08734     <a class="code" href="../../d0/d8/structtagACCELTABLE.html">LPACCELTABLE</a> pat;
08735     <span class="keywordtype">int</span> i;
08736     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(<span class="keywordtype">int</span>, 0);
08737 
08738     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a63">ValidateHACCEL</a>(pat, hAccelSrc);
08739 
08740     <span class="keywordflow">if</span> (lpAccelDst == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08741         retval = pat-&gt;<a class="code" href="../../d0/d8/structtagACCELTABLE.html#o1">cAccel</a>;
08742     } <span class="keywordflow">else</span> {
08743 
08744         <span class="comment">/*</span>
08745 <span class="comment">         * Probe arguments</span>
08746 <span class="comment">         */</span>
08747         <span class="keywordflow">try</span> {
08748             <a class="code" href="../../d4/d1/userk_8h.html#a25">ProbeForWriteBuffer</a>(lpAccelDst, cAccel, <a class="code" href="../../d4/d1/userk_8h.html#a22">DATAALIGN</a>);
08749 
08750             <span class="keywordflow">if</span> (cAccel &gt; (<span class="keywordtype">int</span>)pat-&gt;<a class="code" href="../../d0/d8/structtagACCELTABLE.html#o1">cAccel</a>)
08751                 cAccel = pat-&gt;<a class="code" href="../../d0/d8/structtagACCELTABLE.html#o1">cAccel</a>;
08752 
08753             retval = cAccel;
08754             <span class="keywordflow">for</span> (i = 0; i &lt; cAccel; i++) {
08755                 RtlCopyMemory(&amp;lpAccelDst[i], &amp;pat-&gt;<a class="code" href="../../d0/d8/structtagACCELTABLE.html#o2">accel</a>[i], <span class="keyword">sizeof</span>(ACCEL));
08756                 lpAccelDst[i].fVirt &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a190">FLASTKEY</a>;
08757             }
08758         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
08759             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
08760         }
08761     }
08762 
08763     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserCopyAcceleratorTable"</span>);
08764     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
08765 }
08766 
<a name="l08767"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a306">08767</a> HWND <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a306">NtUserFindWindowEx</a>(  <span class="comment">// API FindWindowA/W, FindWindowExA/W</span>
08768     IN HWND hwndParent,
08769     IN HWND hwndChild,
08770     IN PUNICODE_STRING pstrClassName,
08771     IN PUNICODE_STRING pstrWindowName,
08772     DWORD dwType)
08773 {
08774     UNICODE_STRING  strClassName;
08775     UNICODE_STRING  strWindowName;
08776     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>            pwndParent, pwndChild;
08777 
08778     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(HWND, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
08779 
08780     <span class="keywordflow">if</span> (hwndParent != HWND_MESSAGE) {
08781         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a57">ValidateHWNDOPT</a>(pwndParent, hwndParent);
08782     } <span class="keywordflow">else</span>
08783         pwndParent = <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a15">_GetMessageWindow</a>();
08784 
08785     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a57">ValidateHWNDOPT</a>(pwndChild,  hwndChild);
08786 
08787     <span class="comment">/*</span>
08788 <span class="comment">     * Probe arguments</span>
08789 <span class="comment">     */</span>
08790     <span class="keywordflow">try</span> {
08791         strClassName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(pstrClassName);
08792         strWindowName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(pstrWindowName);
08793         <a class="code" href="../../d4/d1/userk_8h.html#a63">ProbeForReadUnicodeStringBufferOrId</a>(strClassName);
08794         <a class="code" href="../../d4/d1/userk_8h.html#a61">ProbeForReadUnicodeStringBuffer</a>(strWindowName);
08795     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
08796         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
08797     }
08798 
08799     <span class="comment">/*</span>
08800 <span class="comment">     * Use of both buffers is protected by try/except clauses in the code.</span>
08801 <span class="comment">     */</span>
08802 
08803     retval = (HWND)<a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a7">_FindWindowEx</a>(
08804             pwndParent,
08805             pwndChild,
08806             strClassName.Buffer,
08807             strWindowName.Buffer,
08808             dwType);
08809     retval = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>((PVOID)retval);
08810 
08811     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a33">CLEANUPRECV</a>();
08812 
08813     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserFindWindowEx"</span>);
08814     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
08815 }
08816 
<a name="l08817"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a307">08817</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a307">NtUserGetClassInfo</a>(  <span class="comment">// API GetClassInfoA/W</span>
08818     IN HINSTANCE hInstance OPTIONAL,
08819     IN PUNICODE_STRING pstrClassName,
08820     IN OUT LPWNDCLASSEXW lpWndClass,
08821     OUT LPWSTR *ppszMenuName,
08822     IN BOOL bAnsi)
08823 {
08824     UNICODE_STRING strClassName;
08825 
08826     LPWSTR pszMenuName;
08827     WNDCLASSEXW  wc;
08828     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
08829 
08830     <span class="comment">/*</span>
08831 <span class="comment">     * Probe arguments</span>
08832 <span class="comment">     */</span>
08833     <span class="keywordflow">try</span> {
08834         strClassName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(pstrClassName);
08835 
08836         <span class="comment">/*</span>
08837 <span class="comment">         * The class name may either be a string or an atom.  Only</span>
08838 <span class="comment">         * probe strings.</span>
08839 <span class="comment">         */</span>
08840         <a class="code" href="../../d4/d1/userk_8h.html#a63">ProbeForReadUnicodeStringBufferOrId</a>(strClassName);
08841         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(lpWndClass, <span class="keyword">sizeof</span>(*lpWndClass), <a class="code" href="../../d4/d1/userk_8h.html#a22">DATAALIGN</a>);
08842         <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>((PULONG)ppszMenuName);
08843         RtlCopyMemory(&amp;wc, lpWndClass, <span class="keyword">sizeof</span>(WNDCLASSEXW));
08844     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
08845         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
08846     }
08847 
08848     <span class="comment">/*</span>
08849 <span class="comment">     * The class name buffer is client-side.</span>
08850 <span class="comment">     */</span>
08851     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1902">_GetClassInfoEx</a>(
08852                 hInstance,
08853                 (LPTSTR)strClassName.Buffer,
08854                 &amp;wc,
08855                 &amp;pszMenuName,
08856                 bAnsi);
08857 
08858     <span class="keywordflow">try</span> {
08859         RtlCopyMemory(lpWndClass, &amp;wc, <span class="keyword">sizeof</span>(WNDCLASSEXW));
08860         *ppszMenuName = pszMenuName;
08861     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
08862         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
08863     }
08864     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetClassInfo"</span>);
08865     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
08866 }
08867 
08868 <span class="comment">/*</span>
08869 <span class="comment"> * gaFNIDtoICLS is used only in NtUserGetClassName and should be in sync with</span>
08870 <span class="comment"> * the values from user.h</span>
08871 <span class="comment"> * ICLS_MAX is an unused value</span>
08872 <span class="comment"> */</span>
<a name="l08873"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a76">08873</a> CONST <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a76">gaFNIDtoICLS</a>[] = {
08874                         <span class="comment">//  FNID-START</span>
08875     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a72">ICLS_SCROLLBAR</a>,     <span class="comment">//  FNID_SCROLLBAR</span>
08876     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a79">ICLS_ICONTITLE</a>,     <span class="comment">//  FNID_ICONTITLE</span>
08877     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a77">ICLS_MENU</a>,          <span class="comment">//  FNID_MENU</span>
08878     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a75">ICLS_DESKTOP</a>,       <span class="comment">//  FNID_DESKTOP</span>
08879     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a91">ICLS_MAX</a>,           <span class="comment">//  FNID_DEFWINDOWPROC</span>
08880     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a68">ICLS_BUTTON</a>,        <span class="comment">//  FNID_BUTTON</span>
08881     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a73">ICLS_COMBOBOX</a>,      <span class="comment">//  FNID_COMBOBOX</span>
08882     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a81">ICLS_COMBOLISTBOX</a>,  <span class="comment">//  FNID_COMBOLISTBOX</span>
08883     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a76">ICLS_DIALOG</a>,        <span class="comment">//  FNID_DIALOG</span>
08884     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a69">ICLS_EDIT</a>,          <span class="comment">//  FNID_EDIT</span>
08885     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a71">ICLS_LISTBOX</a>,       <span class="comment">//  FNID_LISTBOX</span>
08886     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a80">ICLS_MDICLIENT</a>,     <span class="comment">//  FNID_MDICLIENT</span>
08887     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a70">ICLS_STATIC</a>,        <span class="comment">//  FNID_STATIC</span>
08888     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a89">ICLS_IME</a>,           <span class="comment">//  FNID_IME</span>
08889     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a91">ICLS_MAX</a>,           <span class="comment">//  FNID_HKINLPCWPEXSTRUCT</span>
08890     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a91">ICLS_MAX</a>,           <span class="comment">//  FNID_HKINLPCWPRETEXSTRUCT</span>
08891     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a91">ICLS_MAX</a>,           <span class="comment">//  FNID_DEFFRAMEPROC</span>
08892     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a91">ICLS_MAX</a>,           <span class="comment">//  FNID_DEFMDICHILDPROC</span>
08893     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a91">ICLS_MAX</a>,           <span class="comment">//  FNID_MB_DLGPROC</span>
08894     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a91">ICLS_MAX</a>,           <span class="comment">//  FNID_MDIACTIVATEDLGPROC</span>
08895     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a91">ICLS_MAX</a>,           <span class="comment">//  FNID_SENDMESSAGE</span>
08896     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a91">ICLS_MAX</a>,           <span class="comment">//  FNID_SENDMESSAGEFF</span>
08897     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a91">ICLS_MAX</a>,           <span class="comment">//  FNID_SENDMESSAGEEX</span>
08898     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a91">ICLS_MAX</a>,           <span class="comment">//  FNID_CALLWINDOWPROC</span>
08899     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a91">ICLS_MAX</a>,           <span class="comment">//  FNID_SENDMESSAGEBSM</span>
08900     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a78">ICLS_SWITCH</a>,        <span class="comment">//  FNID_SWITCH</span>
08901     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a90">ICLS_TOOLTIP</a>        <span class="comment">//  FNID_TOOLTIP</span>
08902 };                      <span class="comment">//  FNID_END</span>
08903 
<a name="l08904"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a308">08904</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a308">NtUserGetClassName</a>(  <span class="comment">// API GetClassNameA/W</span>
08905     IN HWND hwnd,
08906     IN BOOL bReal,
08907     IN OUT PUNICODE_STRING pstrClassName)
08908 {
08909     UNICODE_STRING strClassName;
08910     ATOM atom;
08911 
08912     <span class="comment">//</span>
08913     <span class="comment">// N.B. This function has implicit window handle translation. This</span>
08914     <span class="comment">//      operation is performed in the User server API dispatcher.</span>
08915     <span class="comment">//</span>
08916 
08917     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a20">BEGINRECV_HWND_SHARED</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, 0, hwnd);
08918 
08919     <span class="comment">/*</span>
08920 <span class="comment">     * Probe arguments</span>
08921 <span class="comment">     */</span>
08922     <span class="keywordflow">try</span> {
08923         strClassName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(pstrClassName);
08924 <span class="preprocessor">#if defined(_X86_)</span>
08925 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(strClassName.Buffer, strClassName.MaximumLength,
08926             <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
08927 <span class="preprocessor">#else</span>
08928 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(strClassName.Buffer, strClassName.MaximumLength,
08929             <span class="keyword">sizeof</span>(WCHAR));
08930 <span class="preprocessor">#endif</span>
08931 <span class="preprocessor"></span>
08932         atom = pwnd-&gt;pcls-&gt;atomClassName;
08933         UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a76">gaFNIDtoICLS</a>) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a223">FNID_END</a> - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a191">FNID_START</a> + 1);
08934 
08935         <span class="keywordflow">if</span> (bReal) {
08936             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwFnid;
08937             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwClass;
08938             dwFnid = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd);
08939             <span class="keywordflow">if</span> (dwFnid) {
08940                 dwFnid -= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a191">FNID_START</a>;
08941                 <span class="keywordflow">if</span> ((dwFnid &lt; ARRAY_SIZE(gaFNIDtoICLS)) &amp;&amp; (dwFnid &gt;= 0)) {
08942                     dwClass = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a76">gaFNIDtoICLS</a>[dwFnid];
08943                     <span class="keywordflow">if</span> (dwClass != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a91">ICLS_MAX</a>) {
08944                         atom = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[dwClass];
08945                     }
08946                 }
08947             }
08948         }
08949         retval = <a class="code" href="../../d4/d1/userk_8h.html#a1300">UserGetAtomName</a>(
08950             atom,
08951             strClassName.Buffer,
08952             strClassName.MaximumLength / <span class="keyword">sizeof</span>(WCHAR));
08953 
08954     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
08955         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
08956     }
08957 
08958     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetClassName"</span>);
08959     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a21">ENDRECV_HWND_SHARED</a>();
08960 }
08961 
<a name="l08962"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a309">08962</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a309">NtUserGetClipboardFormatName</a>(  <span class="comment">// API GetclipboardFormatNameA/W</span>
08963     IN UINT format,
08964     OUT LPWSTR lpszFormatName,
08965     IN UINT chMax)
08966 {
08967     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a11">BEGINRECV_NOCRIT</a>(<span class="keywordtype">int</span>, 0);
08968 
08969     <span class="comment">/*</span>
08970 <span class="comment">     * Probe arguments</span>
08971 <span class="comment">     */</span>
08972     <span class="keywordflow">try</span> {
08973         <a class="code" href="../../d4/d1/userk_8h.html#a25">ProbeForWriteBuffer</a>(lpszFormatName, chMax, <a class="code" href="../../d4/d1/userk_8h.html#a23">CHARALIGN</a>);
08974     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
08975         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
08976     }
08977 
08978     <span class="keywordflow">if</span> ((ATOM)<a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> &lt; MAXINTATOM) {
08979         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(ERROR_INVALID_PARAMETER);
08980     } <span class="keywordflow">else</span> {
08981         <span class="comment">/*</span>
08982 <span class="comment">         * UserGetAtomName (actually RtlQueryAtomInAtomTable) protects access</span>
08983 <span class="comment">         * within a try block, and sets last error appropriately.</span>
08984 <span class="comment">         */</span>
08985         retval = <a class="code" href="../../d4/d1/userk_8h.html#a1300">UserGetAtomName</a>((ATOM)<a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>, lpszFormatName, chMax);
08986     }
08987 
08988     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetClipboardFormatName"</span>);
08989     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a36">ENDRECV_NOCRIT</a>();
08990 }
08991 
<a name="l08992"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a310">08992</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a310">NtUserGetKeyNameText</a>(
08993     IN LONG lParam,
08994     OUT LPWSTR lpszKeyName,
08995     IN UINT chMax)
08996 {
08997     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(<span class="keywordtype">int</span>, 0);
08998 
08999     <span class="comment">/*</span>
09000 <span class="comment">     * Probe arguments</span>
09001 <span class="comment">     */</span>
09002     <span class="keywordflow">try</span> {
09003         <a class="code" href="../../d4/d1/userk_8h.html#a25">ProbeForWriteBuffer</a>(lpszKeyName, chMax, <a class="code" href="../../d4/d1/userk_8h.html#a23">CHARALIGN</a>);
09004     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
09005         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
09006     }
09007 
09008     <span class="comment">/*</span>
09009 <span class="comment">     * Note -- lpszKeyName is a client-side address.  GetKeyNameText</span>
09010 <span class="comment">     * protects uses with try blocks, and sets last error accordingly.</span>
09011 <span class="comment">     */</span>
09012 
09013     retval = <a class="code" href="../../d3/d1/xlate_8c.html#a5">_GetKeyNameText</a>(
09014                 lParam,
09015                 lpszKeyName,
09016                 chMax);
09017 
09018     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetKeyNameText"</span>);
09019     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
09020 }
09021 
<a name="l09022"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a311">09022</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a311">NtUserGetKeyboardLayoutName</a>(
09023     IN OUT PUNICODE_STRING pstrKLID)
09024 {
09025     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
09026     <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pklActive;
09027     UNICODE_STRING strKLID;
09028 
09029     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
09030 
09031     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>();
09032     pklActive = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>;
09033 
09034     <span class="keywordflow">if</span> (pklActive == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09035         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
09036     }
09037     <span class="comment">/*</span>
09038 <span class="comment">     * Probe arguments</span>
09039 <span class="comment">     */</span>
09040     <span class="keywordflow">try</span> {
09041         strKLID = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(pstrKLID);
09042         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(strKLID.Buffer, strKLID.MaximumLength, <a class="code" href="../../d4/d1/userk_8h.html#a23">CHARALIGN</a>);
09043 
09044         <a class="code" href="../../d1/d5/w32_2ntuser_2rtl_2random_8c.html#a3">wcsncpycch</a>(strKLID.Buffer,
09045                 pklActive-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o5">spkf</a>-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o2">awchKF</a>,
09046                 strKLID.MaximumLength / <span class="keyword">sizeof</span>(WCHAR));
09047 
09048         retval = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
09049 
09050     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
09051         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
09052     }
09053 
09054     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetKeyboardLayoutName"</span>);
09055     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
09056 }
09057 
<a name="l09058"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a312">09058</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a312">NtUserGetKeyboardLayoutList</a>(
09059     IN UINT nItems,
09060     OUT HKL *lpBuff)
09061 {
09062     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
09063 
09064     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>, 0);
09065 
09066     <span class="comment">/*</span>
09067 <span class="comment">     * Probe arguments</span>
09068 <span class="comment">     */</span>
09069     <span class="keywordflow">try</span> {
09070         <span class="keywordflow">if</span> (!lpBuff) {
09071             nItems = 0;
09072         }
09073         <a class="code" href="../../d4/d1/userk_8h.html#a25">ProbeForWriteBuffer</a>(lpBuff, nItems, <a class="code" href="../../d4/d1/userk_8h.html#a22">DATAALIGN</a>);
09074         pwinsta = <a class="code" href="../../d8/d8/winsta_8c.html#a11">_GetProcessWindowStation</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
09075 
09076     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
09077         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
09078     }
09079 
09080     <span class="comment">/*</span>
09081 <span class="comment">     * Access to the client-side buffer lpBuff is protected by try/except</span>
09082 <span class="comment">     * inside _GetKeyboardLayoutList()</span>
09083 <span class="comment">     */</span>
09084     retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d4/d1/userk_8h.html#a1309">_GetKeyboardLayoutList</a>(pwinsta, nItems, lpBuff);
09085     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetKeyboardLayoutList"</span>);
09086     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
09087 }
09088 
<a name="l09089"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a313">09089</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a313">NtUserMapVirtualKeyEx</a>(
09090     IN UINT uCode,
09091     IN UINT uMapType,
09092     IN ULONG_PTR dwHKLorPKL,
09093     IN BOOL bHKL)
09094 {
09095     <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pkl;
09096 
09097     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>, 0);
09098 
09099     <span class="comment">/*</span>
09100 <span class="comment">     * See if we need to convert an HKL to a PKL.  MapVirtualKey passes a PKL and</span>
09101 <span class="comment">     * MapVirtualKeyEx passes an HKL.  The conversion must be done in the kernel.</span>
09102 <span class="comment">     */</span>
09103     <span class="keywordflow">if</span> (bHKL) {
09104         pkl = <a class="code" href="../../d4/d1/userk_8h.html#a1019">HKLtoPKL</a>(<a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>(), (HKL)dwHKLorPKL);
09105     } <span class="keywordflow">else</span> {
09106         pkl = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>()-&gt;spklActive;
09107     }
09108 
09109     <span class="keywordflow">if</span> (pkl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09110         retval = 0;
09111     } <span class="keywordflow">else</span> {
09112         retval = <a class="code" href="../../d3/d1/xlate_8c.html#a4">InternalMapVirtualKeyEx</a>(uCode, uMapType, pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o5">spkf</a>-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o4">pKbdTbl</a>);
09113     }
09114 
09115     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserMapVirtualKeyEx"</span>);
09116     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
09117 }
09118 
<a name="l09119"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a314">09119</a> ATOM <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a314">NtUserRegisterClassExWOW</a>(
09120     IN WNDCLASSEX *lpWndClass,
09121     IN PUNICODE_STRING pstrClassName,
09122     IN <a class="code" href="../../d8/d0/structtagCLSMENUNAME.html">PCLSMENUNAME</a> pcmn,
09123     IN WORD fnid,
09124     IN DWORD dwFlags,
09125     IN LPDWORD pdwWOWstuff OPTIONAL)
09126 {
09127     UNICODE_STRING strClassName;
09128     UNICODE_STRING strMenuName;
09129     WNDCLASSEX WndClass;
09130     WC WowCls;
09131     <a class="code" href="../../d8/d0/structtagCLSMENUNAME.html">CLSMENUNAME</a> cmn;
09132 
09133     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(ATOM, 0);
09134 
09135     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a46">TESTFLAGS</a>(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>, <a class="code" href="../../d1/d0/inc_2user_8h.html#a492">CSF_VALID</a>);
09136 
09137     <span class="comment">/*</span>
09138 <span class="comment">     * Probe arguments</span>
09139 <span class="comment">     */</span>
09140     <span class="keywordflow">try</span> {
09141         strClassName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(pstrClassName);
09142         cmn = <a class="code" href="../../d5/d8/ex_8h.html#a27">ProbeAndReadStructure</a>(pcmn, <a class="code" href="../../d8/d0/structtagCLSMENUNAME.html">CLSMENUNAME</a>);
09143         strMenuName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(cmn.<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o2">pusMenuName</a>);
09144         WndClass = <a class="code" href="../../d5/d8/ex_8h.html#a27">ProbeAndReadStructure</a>(lpWndClass, WNDCLASSEX);
09145         <a class="code" href="../../d4/d1/userk_8h.html#a63">ProbeForReadUnicodeStringBufferOrId</a>(strClassName);
09146         <a class="code" href="../../d4/d1/userk_8h.html#a63">ProbeForReadUnicodeStringBufferOrId</a>(strMenuName);
09147         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(pdwWOWstuff)) {
09148             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(pdwWOWstuff, <span class="keyword">sizeof</span>(WC), <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
09149             RtlCopyMemory(&amp;WowCls, pdwWOWstuff, <span class="keyword">sizeof</span>(WC));
09150             pdwWOWstuff = (PDWORD)&amp;WowCls;
09151         }
09152         WndClass.lpszClassName = strClassName.Buffer;
09153         WndClass.lpszMenuName = strMenuName.Buffer;
09154     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
09155         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
09156     }
09157 
09158     <span class="comment">/*</span>
09159 <span class="comment">     * ClassName and MenuName in WndClass are client-side pointers.</span>
09160 <span class="comment">     */</span>
09161 
09162     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1898">xxxRegisterClassEx</a>(
09163             &amp;WndClass,
09164             &amp;cmn,
09165             fnid,
09166             <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>,
09167             pdwWOWstuff);
09168 
09169     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserRegisterClassExWOW"</span>);
09170     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
09171 }
09172 
<a name="l09173"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a315">09173</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a315">NtUserRegisterWindowMessage</a>(
09174     IN PUNICODE_STRING pstrMessage)
09175 {
09176     UNICODE_STRING strMessage;
09177 
09178     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a11">BEGINRECV_NOCRIT</a>(<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>, 0);
09179 
09180     <span class="comment">/*</span>
09181 <span class="comment">     * Probe arguments</span>
09182 <span class="comment">     */</span>
09183     <span class="keywordflow">try</span> {
09184         strMessage = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(pstrMessage);
09185         <a class="code" href="../../d4/d1/userk_8h.html#a61">ProbeForReadUnicodeStringBuffer</a>(strMessage);
09186     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
09187         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
09188     }
09189 
09190     <span class="comment">/*</span>
09191 <span class="comment">     * The buffer is in client-side memory.</span>
09192 <span class="comment">     * Rtl atom routines protect accesses to strings with their</span>
09193 <span class="comment">     * own try/except blocks, UserAddAtom sets last error accordingly.</span>
09194 <span class="comment">     */</span>
09195     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1297">UserAddAtom</a>(
09196             strMessage.Buffer, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
09197 
09198     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserRegisterWindowMessage"</span>);
09199     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a36">ENDRECV_NOCRIT</a>();
09200 }
09201 
<a name="l09202"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a316">09202</a> HANDLE <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a316">NtUserRemoveProp</a>(
09203     IN HWND hwnd,
09204     IN DWORD dwProp)
09205 {
09206 
09207     <span class="comment">//</span>
09208     <span class="comment">// N.B. This function has implicit window handle translation. This</span>
09209     <span class="comment">//      operation is performed in the User server API dispatcher.</span>
09210     <span class="comment">//</span>
09211 
09212     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a14">BEGINRECV_HWND</a>(HANDLE, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hwnd);
09213 
09214     retval = <a class="code" href="../../d4/d8/kernel_2winprop_8c.html#a1">InternalRemoveProp</a>(pwnd, (LPWSTR)LOWORD(dwProp), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
09215 
09216     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserRemoveProp"</span>);
09217     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a15">ENDRECV_HWND</a>();
09218 }
09219 
<a name="l09220"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a317">09220</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a317">NtUserSetProp</a>(
09221     IN HWND hwnd,
09222     IN DWORD dwProp,
09223     IN HANDLE hData)
09224 {
09225 
09226     <span class="comment">//</span>
09227     <span class="comment">// N.B. This function has implicit window handle translation. This</span>
09228     <span class="comment">//      operation is performed in the User server API dispatcher.</span>
09229     <span class="comment">//</span>
09230 
09231     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a14">BEGINRECV_HWND</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, 0, hwnd);
09232 
09233     retval = <a class="code" href="../../d4/d8/kernel_2winprop_8c.html#a0">InternalSetProp</a>(
09234             pwnd,
09235             (LPTSTR)LOWORD(dwProp),
09236             hData,
09237             HIWORD(dwProp) ? <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a499">PROPF_STRING</a> : 0);
09238 
09239     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetProp"</span>);
09240     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a15">ENDRECV_HWND</a>();
09241 }
09242 
<a name="l09243"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a318">09243</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a318">NtUserUnregisterClass</a>(  <span class="comment">// API UnregisterClass</span>
09244     IN PUNICODE_STRING pstrClassName,
09245     IN HINSTANCE hInstance,
09246     OUT <a class="code" href="../../d8/d0/structtagCLSMENUNAME.html">PCLSMENUNAME</a> pcmn)
09247 {
09248     UNICODE_STRING strClassName;
09249     <a class="code" href="../../d8/d0/structtagCLSMENUNAME.html">CLSMENUNAME</a> cmn;
09250 
09251     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
09252 
09253     <span class="comment">/*</span>
09254 <span class="comment">     * Probe arguments</span>
09255 <span class="comment">     */</span>
09256     <span class="keywordflow">try</span> {
09257         strClassName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(pstrClassName);
09258         <a class="code" href="../../d4/d1/userk_8h.html#a63">ProbeForReadUnicodeStringBufferOrId</a>(strClassName);
09259     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
09260         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
09261     }
09262 
09263     <span class="comment">/*</span>
09264 <span class="comment">     * The buffer is in client-side memory.</span>
09265 <span class="comment">     */</span>
09266 
09267     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1901">_UnregisterClass</a>(
09268                 strClassName.Buffer,
09269                 hInstance,
09270                 &amp;cmn);
09271 
09272     <span class="keywordflow">try</span> {
09273         <a class="code" href="../../d5/d8/ex_8h.html#a54">ProbeAndWriteStructure</a>(pcmn, cmn, <a class="code" href="../../d8/d0/structtagCLSMENUNAME.html">CLSMENUNAME</a>);
09274     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
09275         <span class="comment">// no SetLastError, since pcmn is a USER address, not the application's</span>
09276     }
09277 
09278     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserUnregisterClass"</span>);
09279     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
09280 }
09281 
<a name="l09282"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a319">09282</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a319">NtUserVkKeyScanEx</a>(
09283     IN WCHAR cChar,
09284     IN ULONG_PTR dwHKLorPKL,
09285     IN BOOL bHKL)
09286 {
09287     <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pkl;
09288 
09289     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>, -1);
09290 
09291     <span class="comment">/*</span>
09292 <span class="comment">     * See if we need to convert an HKL to a PKL.  VkKeyScan passes a PKL and</span>
09293 <span class="comment">     * VkKeyScanEx passes an HKL.  The conversion must be done on the server side.</span>
09294 <span class="comment">     */</span>
09295     <span class="keywordflow">if</span> (bHKL) {
09296         pkl = <a class="code" href="../../d4/d1/userk_8h.html#a1019">HKLtoPKL</a>(<a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>(), (HKL)dwHKLorPKL);
09297     } <span class="keywordflow">else</span> {
09298         pkl = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>()-&gt;spklActive;
09299     }
09300 
09301     <span class="keywordflow">if</span> (pkl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09302         retval = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)-1;
09303     } <span class="keywordflow">else</span> {
09304         retval = <a class="code" href="../../d4/d1/userk_8h.html#a1123">InternalVkKeyScanEx</a>(cChar, pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o5">spkf</a>-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o4">pKbdTbl</a>);
09305     }
09306 
09307     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserVkKeyScanEx"</span>);
09308     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
09309 }
09310 
09311 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l09312"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a320">09312</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a320">NtUserEnumDisplayDevices</a>(
09313     IN PUNICODE_STRING pstrDeviceName,
09314     IN DWORD iDevNum,
09315     IN OUT LPDISPLAY_DEVICEW lpDisplayDevice,
09316     IN DWORD dwFlags)
09317 {
09318     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>, STATUS_UNSUCCESSFUL);
09319 
09320     <span class="comment">//</span>
09321     <span class="comment">// Update the list of devices.</span>
09322     <span class="comment">// If the function returns FALSE (retry update), then we must</span>
09323     <span class="comment">// disable the current hdev, call back, and reanable the hdev.</span>
09324     <span class="comment">//</span>
09325 
09326     <span class="keywordflow">if</span> (DrvUpdateGraphicsDeviceList(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
09327 
09328         <span class="keywordflow">if</span> (DrvDisableMDEV(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
09329 
09330             DrvUpdateGraphicsDeviceList(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
09331 
09332             DrvEnableMDEV(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
09333 
09334             <span class="comment">//</span>
09335             <span class="comment">// Repaint the screen</span>
09336             <span class="comment">//</span>
09337 
09338             <a class="code" href="../../d9/d6/desktop_8c.html#a26">xxxUserResetDisplayDevice</a>();
09339         }
09340     }
09341 
09342     <span class="comment">/*</span>
09343 <span class="comment">     * Address checking, etc., occurs in GRE.</span>
09344 <span class="comment">     */</span>
09345 
09346     retval = DrvEnumDisplayDevices(pstrDeviceName,
09347                                    <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o12">pMonitorPrimary</a>-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o8">hDev</a>,
09348                                    iDevNum,
09349                                    lpDisplayDevice,
09350                                    <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>,
09351                                    <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
09352     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserEnumDisplayDevices"</span>);
09353     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
09354 }
09355 
09356 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l09357"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a321">09357</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a321">NtUserEnumDisplaySettings</a>(
09358     IN PUNICODE_STRING pstrDeviceName,
09359     IN DWORD           iModeNum,
09360     OUT LPDEVMODEW     lpDevMode,
09361     IN  DWORD          dwFlags)
09362 {
09363     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>, STATUS_UNSUCCESSFUL);
09364 
09365     <span class="comment">/*</span>
09366 <span class="comment">     * Address checking, etc., occurs in GRE.</span>
09367 <span class="comment">     */</span>
09368 
09369     retval = DrvEnumDisplaySettings(pstrDeviceName,
09370                                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o12">pMonitorPrimary</a>-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o8">hDev</a>,
09371                                     iModeNum,
09372                                     lpDevMode,
09373                                     <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
09374 
09375     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserEnumDisplaySettings"</span>);
09376     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
09377 }
09378 
09379 LONG
<a name="l09380"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a322">09380</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a322">NtUserChangeDisplaySettings</a>(
09381     IN PUNICODE_STRING pstrDeviceName,
09382     IN LPDEVMODEW pDevMode,
09383     IN HWND hwnd,
09384     IN DWORD dwFlags,
09385     IN PVOID lParam)
09386 {
09387     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(LONG, DISP_CHANGE_FAILED);
09388 
09389     <span class="comment">/*</span>
09390 <span class="comment">     * Prevent restricted threads from changing</span>
09391 <span class="comment">     * display settings</span>
09392 <span class="comment">     */</span>
09393     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a383">IS_CURRENT_THREAD_RESTRICTED</a>(JOB_OBJECT_UILIMIT_DISPLAYSETTINGS)) {
09394         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
09395     }
09396 
09397     <span class="comment">/*</span>
09398 <span class="comment">     * Address checking, etc., occurs in GRE.</span>
09399 <span class="comment">     */</span>
09400 
09401     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1758">xxxUserChangeDisplaySettings</a>(pstrDeviceName,
09402                                           pDevMode,
09403                                           hwnd,
09404                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,     <span class="comment">// pdesk</span>
09405                                           <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>,
09406                                           lParam,
09407                                           <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
09408 
09409     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserChangeDisplaySettings"</span>);
09410     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
09411 }
09412 
<a name="l09413"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a323">09413</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a323">NtUserCallMsgFilter</a>(  <span class="comment">// API CallMsgFilterA/W</span>
09414     IN OUT LPMSG lpMsg,
09415     IN <span class="keywordtype">int</span> nCode)
09416 {
09417     MSG <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
09418 
09419     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
09420 
09421     <span class="comment">/*</span>
09422 <span class="comment">     * Probe arguments</span>
09423 <span class="comment">     */</span>
09424     <span class="keywordflow">try</span> {
09425         <a class="code" href="../../d4/d1/userk_8h.html#a69">ProbeForWriteMessage</a>(lpMsg);
09426         <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> = *lpMsg;
09427     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
09428         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
09429     }
09430 
09431     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1818">_CallMsgFilter</a>(
09432                 &amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
09433                 nCode);
09434     <span class="keywordflow">try</span> {
09435         *lpMsg = <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
09436     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
09437         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
09438     }
09439 
09440     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserCallMsgFilter"</span>);
09441     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
09442 }
09443 
<a name="l09444"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a324">09444</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a324">NtUserDrawMenuBarTemp</a>(  <span class="comment">// private DrawMenuBarTemp</span>
09445     IN HWND hwnd,
09446     IN HDC hdc,
09447     IN LPCRECT lprc,
09448     IN HMENU hMenu,
09449     IN HFONT hFont)
09450 {
09451     <span class="comment">//</span>
09452     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
09453     <span class="comment">//      enabled. These operations are performed in the User server API</span>
09454     <span class="comment">//      dispatcher.</span>
09455     <span class="comment">//</span>
09456 
09457     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>   pMenu;
09458     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>      tlpMenu;
09459     RECT    rc;
09460 
09461 
09462     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(<span class="keywordtype">int</span>, 0, hwnd);
09463 
09464     <span class="comment">/*</span>
09465 <span class="comment">     * Probe and capture arguments.</span>
09466 <span class="comment">     */</span>
09467     <span class="keywordflow">try</span> {
09468         rc = <a class="code" href="../../d4/d1/userk_8h.html#a31">ProbeAndReadRect</a>(lprc);
09469     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
09470         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
09471     }
09472 
09473     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a61">ValidateHMENU</a>(pMenu, hMenu);
09474 
09475     <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pMenu, &amp;tlpMenu);
09476 
09477     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1934">xxxDrawMenuBarTemp</a>(
09478             pwnd,
09479             hdc,
09480             &amp;rc,
09481             pMenu,
09482             hFont);
09483 
09484     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpMenu);
09485 
09486     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserDrawMenuBarTemp"</span>);
09487     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
09488 }
09489 
<a name="l09490"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a325">09490</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a325">NtUserDrawCaptionTemp</a>(  <span class="comment">// private DrawCaptionTempA/W</span>
09491     IN HWND hwnd,
09492     IN HDC hdc,
09493     IN LPCRECT lprc,
09494     IN HFONT hFont,
09495     IN HICON hIcon,
09496     IN PUNICODE_STRING pstrText,
09497     IN UINT flags)
09498 {
09499     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a>         pcur;
09500     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>              tlpcur;
09501     RECT            rc;
09502     UNICODE_STRING  strCapture;
09503     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>            pwnd;
09504     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>              tlpwnd;
09505     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>     ptiCurrent;
09506     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlBuffer;
09507     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fFreeBuffer = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09508 
09509     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
09510 
09511     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
09512 
09513     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a57">ValidateHWNDOPT</a>(pwnd, hwnd);
09514     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a65">ValidateHCURSOROPT</a>(pcur, hIcon);
09515 
09516     <span class="comment">/*</span>
09517 <span class="comment">     * Probe and capture arguments.  Capturing the text is ugly,</span>
09518 <span class="comment">     * but must be done because it is passed to GDI.</span>
09519 <span class="comment">     */</span>
09520     <span class="keywordflow">try</span> {
09521         rc = <a class="code" href="../../d4/d1/userk_8h.html#a31">ProbeAndReadRect</a>(lprc);
09522         strCapture = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(pstrText);
09523         <span class="keywordflow">if</span> (strCapture.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09524             PWSTR pszCapture = strCapture.Buffer;
09525             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(strCapture.Buffer, strCapture.Length, <a class="code" href="../../d4/d1/userk_8h.html#a23">CHARALIGN</a>);
09526             strCapture.Buffer = UserAllocPoolWithQuota(strCapture.Length+<span class="keyword">sizeof</span>(UNICODE_NULL), TAG_TEXT);
09527             <span class="keywordflow">if</span> (strCapture.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09528                 fFreeBuffer = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
09529                 <a class="code" href="../../d4/d1/userk_8h.html#a137">ThreadLockPool</a>(ptiCurrent, strCapture.Buffer, &amp;tlBuffer);
09530                 RtlCopyMemory(strCapture.Buffer, pszCapture, strCapture.Length);
09531                 strCapture.Buffer[strCapture.Length/<span class="keyword">sizeof</span>(WCHAR)]=0;  <span class="comment">// null-terminate string</span>
09532                 strCapture.MaximumLength = strCapture.Length+<span class="keyword">sizeof</span>(UNICODE_NULL);
09533                 pstrText = &amp;strCapture;
09534             } <span class="keywordflow">else</span> {
09535                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_NO_MEMORY);
09536             }
09537         }
09538     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
09539         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
09540     }
09541 
09542     <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwnd, &amp;tlpwnd);
09543     <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pcur, &amp;tlpcur);
09544 
09545     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1935">xxxDrawCaptionTemp</a>(
09546             pwnd,
09547             hdc,
09548             &amp;rc,
09549             hFont,
09550             pcur,
09551             strCapture.Buffer ? &amp;strCapture : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
09552             flags);
09553 
09554     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpcur);
09555     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
09556 
09557     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a33">CLEANUPRECV</a>();
09558     <span class="keywordflow">if</span> (fFreeBuffer)
09559         <a class="code" href="../../d4/d1/userk_8h.html#a139">ThreadUnlockAndFreePool</a>(ptiCurrent, &amp;tlBuffer);
09560 
09561     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserDrawCaptionTemp"</span>);
09562     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
09563 }
09564 
<a name="l09565"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a326">09565</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a326">NtUserGetKeyboardState</a>(  <span class="comment">// API GetKeyboardState</span>
09566     OUT PBYTE pb)
09567 {
09568     <span class="keywordtype">int</span> i;
09569     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pq;
09570     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>, 0)
09571 
09572     <span class="comment">/*</span>
09573 <span class="comment">     * Probe arguments</span>
09574 <span class="comment">     */</span>
09575     <span class="keywordflow">try</span> {
09576         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(pb, 256, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
09577 
09578         pq = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>()-&gt;pq;
09579 
09580         <span class="keywordflow">for</span> (i = 0; i &lt; 256; i++, pb++) {
09581             *pb = 0;
09582             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(pq, i))
09583                 *pb |= 0x80;
09584 
09585             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a840">TestKeyStateToggle</a>(pq, i))
09586                 *pb |= 0x01;
09587         }
09588         retval = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
09589     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
09590         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
09591     }
09592 
09593     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
09594 }
09595 
<a name="l09596"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a327">09596</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a327">NtUserGetKeyState</a>(
09597     IN <span class="keywordtype">int</span> vk)
09598 {
09599     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
09600     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>, 0)
09601 
09602     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>();
09603     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a856">QF_UPDATEKEYSTATE</a>) {
09604 
09605         <span class="comment">/*</span>
09606 <span class="comment">         * We are going to change the system state, so we</span>
09607 <span class="comment">         * must have an exclusive lock</span>
09608 <span class="comment">         */</span>
09609         <a class="code" href="../../d7/d3/validate_8c.html#a21">ChangeAcquireResourceType</a>();
09610 
09611         <span class="comment">/*</span>
09612 <span class="comment">         * If this thread needs a key state event, give one to it. There are</span>
09613 <span class="comment">         * cases where any app may be looping looking at GetKeyState(), plus</span>
09614 <span class="comment">         * calling PeekMessage(). Key state events don't get created unless</span>
09615 <span class="comment">         * new hardware input comes along. If the app isn't receiving hardware</span>
09616 <span class="comment">         * input, it won't get the new key state. So ResyncKeyState() will</span>
09617 <span class="comment">         * ensure that if the app is looping on GetKeyState(), it'll get the</span>
09618 <span class="comment">         * right key state.</span>
09619 <span class="comment">         */</span>
09620         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a856">QF_UPDATEKEYSTATE</a>) {
09621             <a class="code" href="../../d4/d1/userk_8h.html#a1235">PostUpdateKeyStateEvent</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>);
09622         }
09623     }
09624     retval = <a class="code" href="../../d7/d9/keyboard_8c.html#a1">_GetKeyState</a>(vk);
09625 
09626     <span class="comment">/*</span>
09627 <span class="comment">     * Update the client side key state cache.</span>
09628 <span class="comment">     */</span>
09629     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o15">dwKeyCache</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;dwKeyCache;
09630     RtlCopyMemory(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o16">afKeyState</a>,
09631                   ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o17">afKeyState</a>,
09632                   <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a109">CBKEYCACHE</a>);
09633 
09634     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
09635 }
09636 
09637 <span class="comment">/**************************************************************************\</span>
09638 <span class="comment">* NtUserQueryWindow</span>
09639 <span class="comment">*</span>
09640 <span class="comment">* 03-18-95 JimA         Created.</span>
09641 <span class="comment">\**************************************************************************/</span>
09642 
<a name="l09643"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a328">09643</a> HANDLE <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a328">NtUserQueryWindow</a>(
09644     IN HWND hwnd,
09645     IN WINDOWINFOCLASS WindowInfo)
09646 {
09647     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiWnd;
09648 
09649     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a20">BEGINRECV_HWND_SHARED</a>(HANDLE, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hwnd);
09650 
09651     ptiWnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd);
09652 
09653     <span class="keywordflow">switch</span> (WindowInfo) {
09654     <span class="keywordflow">case</span> WindowProcess:
09655 
09656         <span class="comment">/*</span>
09657 <span class="comment">         * Special case console windows</span>
09658 <span class="comment">         */</span>
09659         <span class="keywordflow">if</span> (ptiWnd-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a798">TIF_CSRSSTHREAD</a> &amp;&amp;
09660                 pwnd-&gt;pcls-&gt;atomClassName == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a281">gatomConsoleClass</a>) {
09661             retval = (HANDLE)LongToHandle( <a class="code" href="../../d4/d1/userk_8h.html#a589">_GetWindowLong</a>(pwnd, 0) );
09662         } <span class="keywordflow">else</span> {
09663             retval = (HANDLE)ptiWnd-&gt;pEThread-&gt;Cid.UniqueProcess;
09664         }
09665         <span class="keywordflow">break</span>;
09666     <span class="keywordflow">case</span> WindowThread:
09667 
09668         <span class="comment">/*</span>
09669 <span class="comment">         * Special case console windows</span>
09670 <span class="comment">         */</span>
09671         <span class="keywordflow">if</span> (ptiWnd-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a798">TIF_CSRSSTHREAD</a> &amp;&amp;
09672                 pwnd-&gt;pcls-&gt;atomClassName == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a281">gatomConsoleClass</a>) {
09673             retval = (HANDLE)LongToHandle( <a class="code" href="../../d4/d1/userk_8h.html#a589">_GetWindowLong</a>(pwnd, 4) );
09674         } <span class="keywordflow">else</span> {
09675             retval = (HANDLE)ptiWnd-&gt;pEThread-&gt;Cid.UniqueThread;
09676         }
09677         <span class="keywordflow">break</span>;
09678     <span class="keywordflow">case</span> WindowActiveWindow:
09679         retval = (HANDLE)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(ptiWnd-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>);
09680         <span class="keywordflow">break</span>;
09681     <span class="keywordflow">case</span> WindowFocusWindow:
09682         retval = (HANDLE)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(ptiWnd-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>);
09683         <span class="keywordflow">break</span>;
09684     <span class="keywordflow">case</span> WindowIsHung:
09685         retval = (HANDLE)IntToPtr( <a class="code" href="../../d4/d1/userk_8h.html#a1650">FHungApp</a>(ptiWnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a912">CMSHUNGAPPTIMEOUT</a>) );
09686         <span class="keywordflow">break</span>;
09687     <span class="keywordflow">case</span> WindowIsForegroundThread:
09688         retval = (HANDLE)IntToPtr( (ptiWnd-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>) );
09689         <span class="keywordflow">break</span>;
09690     <span class="keywordflow">case</span> WindowDefaultImeWindow:
09691         retval = (HANDLE)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(ptiWnd-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o39">spwndDefaultIme</a>);
09692         <span class="keywordflow">break</span>;
09693     <span class="keywordflow">case</span> WindowDefaultInputContext:
09694         retval = (HANDLE)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(ptiWnd-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o40">spDefaultImc</a>);
09695         <span class="keywordflow">break</span>;
09696     <span class="keywordflow">case</span> WindowActiveDefaultImeWindow:
09697         <span class="comment">/*</span>
09698 <span class="comment">         * Only return a window if there is a foreground queue and the</span>
09699 <span class="comment">         * caller has access to the current desktop.</span>
09700 <span class="comment">         */</span>
09701         retval = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09702         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> &amp;&amp;
09703                 <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>()-&gt;rpdesk == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk) {
09704             <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndFG = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>;
09705 
09706             <span class="keywordflow">if</span> (pwndFG &amp;&amp; pwndFG-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.pti) {
09707                 retval = (HANDLE)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(pwndFG-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.pti-&gt;spwndDefaultIme);
09708             }
09709         }
09710         <span class="keywordflow">break</span>;
09711     <span class="keywordflow">default</span>:
09712         retval = (HANDLE)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09713         <span class="keywordflow">break</span>;
09714     }
09715 
09716     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a21">ENDRECV_HWND_SHARED</a>();
09717 }
09718 
<a name="l09719"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a329">09719</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a329">NtUserSBGetParms</a>(  <span class="comment">// API GetScrollInfo, SBM_GETSCROLLINFO</span>
09720     IN HWND hwnd,
09721     IN <span class="keywordtype">int</span> code,
09722     IN <a class="code" href="../../d4/d5/structtagSBDATA.html">PSBDATA</a> pw,
09723     IN OUT LPSCROLLINFO lpsi)
09724 {
09725     <a class="code" href="../../d4/d5/structtagSBDATA.html">SBDATA</a> sbd;
09726     SCROLLINFO si;
09727     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a20">BEGINRECV_HWND_SHARED</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, hwnd);
09728 
09729     <span class="comment">/*</span>
09730 <span class="comment">     * Probe arguments</span>
09731 <span class="comment">     */</span>
09732     <span class="keywordflow">try</span> {
09733         <a class="code" href="../../d4/d1/userk_8h.html#a72">ProbeForWriteScrollInfo</a>(lpsi);
09734 
09735         <span class="comment">/*</span>
09736 <span class="comment">         * Probe the 4 DWORDS (MIN, MAX, PAGE, POS)</span>
09737 <span class="comment">         */</span>
09738         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(pw, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/structtagSBDATA.html">SBDATA</a>), <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
09739         RtlCopyMemory(&amp;sbd, pw, <span class="keyword">sizeof</span>(sbd));
09740         RtlCopyMemory(&amp;si, lpsi, <span class="keyword">sizeof</span>(SCROLLINFO));
09741     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
09742         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
09743     }
09744 
09745     retval = <a class="code" href="../../d8/d4/sbctl_8c.html#a15">_SBGetParms</a>(pwnd, code, &amp;sbd, &amp;si);
09746     <span class="keywordflow">try</span> {
09747         RtlCopyMemory(lpsi, &amp;si, <span class="keyword">sizeof</span>(SCROLLINFO));
09748     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
09749         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
09750     }
09751 
09752     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a21">ENDRECV_HWND_SHARED</a>();
09753 }
09754 
<a name="l09755"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a330">09755</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a330">NtUserBitBltSysBmp</a>(
09756     IN HDC hdc,
09757     IN <span class="keywordtype">int</span> xDest,
09758     IN <span class="keywordtype">int</span> yDest,
09759     IN <span class="keywordtype">int</span> cxDest,
09760     IN <span class="keywordtype">int</span> cyDest,
09761     IN <span class="keywordtype">int</span> xSrc,
09762     IN <span class="keywordtype">int</span> ySrc,
09763     IN DWORD dwRop)
09764 {
09765     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
09766 
09767     <span class="comment">/*</span>
09768 <span class="comment">     * Note -- this interface requires exclusive ownership of</span>
09769 <span class="comment">     *         the User crit sect in order to serialize use</span>
09770 <span class="comment">     *         of HDCBITS.  Only one thread at a time may use</span>
09771 <span class="comment">     *         a DC.</span>
09772 <span class="comment">     */</span>
09773 
09774     retval = GreBitBlt(hdc,
09775                        xDest,
09776                        yDest,
09777                        cxDest,
09778                        cyDest,
09779                        <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a527">HDCBITS</a>(),
09780                        xSrc,
09781                        ySrc,
09782                        dwRop,
09783                        0);
09784 
09785     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
09786 }
09787 
<a name="l09788"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a331">09788</a> HPALETTE <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a331">NtUserSelectPalette</a>(
09789     IN HDC hdc,
09790     IN HPALETTE hpalette,
09791     IN BOOL fForceBackground)
09792 {
09793     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(HPALETTE, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
09794 
09795     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1103">_SelectPalette</a>(hdc, hpalette, fForceBackground);
09796 
09797     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
09798 }
09799 
09800 <span class="comment">/*</span>
09801 <span class="comment"> * Message thunks</span>
09802 <span class="comment"> */</span>
09803 
<a name="l09804"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a332">09804</a> LRESULT <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a332">NtUserMessageCall</a>(
09805     IN HWND hwnd,
09806     IN UINT msg,
09807     IN WPARAM wParam,
09808     IN LPARAM lParam,
09809     IN ULONG_PTR xParam,
09810     IN DWORD xpfnProc,
09811     IN BOOL bAnsi)
09812 {
09813     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a24">BEGINRECV_HWNDLOCK</a>(LRESULT, 0, hwnd);
09814 
09815     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> &amp; ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a543">MSGFLAG_MASK</a>) &gt;= WM_USER) {
09816         retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
09817                 pwnd,
09818                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
09819                 wParam,
09820                 lParam,
09821                 xParam);
09822     } <span class="keywordflow">else</span> {
09823         retval = gapfnMessageCall[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1144">MessageTable</a>[(<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> &amp; ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a543">MSGFLAG_MASK</a>)].<a class="code" href="../../d6/d2/structtagMSG__TABLE__ENTRY.html#o0">iFunction</a>](
09824                 pwnd,
09825                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
09826                 wParam,
09827                 lParam,
09828                 xParam,
09829                 xpfnProc,
09830                 bAnsi);
09831     }
09832 
09833     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserMessageCall"</span>);
09834     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a25">ENDRECV_HWNDLOCK</a>();
09835 }
09836 
<a name="l09837"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a333">09837</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(DWORD)
09838 {
09839     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
09840     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnDWORD"</span>);
09841 
09842     UNREFERENCED_PARAMETER(bAnsi);
09843 
09844     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
09845             pwnd,
09846             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
09847             wParam,
09848             lParam,
09849             xParam);
09850 
09851     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnDWORD"</span>);
09852     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
09853 
09854 }
09855 
<a name="l09856"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a334">09856</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(OPTOUTLPDWORDOPTOUTLPDWORD)
09857 {
09858     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwwParam, dwlParam;
09859 
09860     <span class="comment">//</span>
09861     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
09862     <span class="comment">//      enabled. These operations are performed in the User server API</span>
09863     <span class="comment">//      dispatcher.</span>
09864     <span class="comment">//</span>
09865 
09866     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
09867     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnOPTOUTLPDWORDOPTOUTLPDWORD"</span>);
09868 
09869     UNREFERENCED_PARAMETER(bAnsi);
09870 
09871     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
09872             pwnd,
09873             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
09874             (WPARAM)&amp;dwwParam,
09875             (LPARAM)&amp;dwlParam,
09876             xParam);
09877 
09878     <span class="comment">/*</span>
09879 <span class="comment">     * Probe arguments</span>
09880 <span class="comment">     */</span>
09881     <span class="keywordflow">try</span> {
09882         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(wParam)) {
09883             <a class="code" href="../../d5/d8/ex_8h.html#a51">ProbeAndWriteUlong</a>((PULONG)wParam, dwwParam);
09884         }
09885         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(lParam)) {
09886             <a class="code" href="../../d5/d8/ex_8h.html#a51">ProbeAndWriteUlong</a>((PULONG)lParam, dwlParam);
09887         }
09888     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
09889         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);  <span class="comment">// should messages with bad wParam/lParam SetLastError?</span>
09890     }
09891 
09892     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnOPTOUTLPDWORDOPTOUTLPDWORD"</span>);
09893     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
09894 
09895 }
09896 
<a name="l09897"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a335">09897</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(INOUTNEXTMENU)
09898 {
09899     MDINEXTMENU mnm;
09900 
09901     <span class="comment">//</span>
09902     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
09903     <span class="comment">//      enabled. These operations are performed in the User server API</span>
09904     <span class="comment">//      dispatcher.</span>
09905     <span class="comment">//</span>
09906 
09907     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
09908     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnINOUTNEXTMENU"</span>);
09909 
09910     UNREFERENCED_PARAMETER(bAnsi);
09911 
09912     <span class="comment">/*</span>
09913 <span class="comment">     * Probe arguments</span>
09914 <span class="comment">     */</span>
09915     <span class="keywordflow">try</span> {
09916         <a class="code" href="../../d4/d1/userk_8h.html#a79">ProbeForWriteMDINextMenu</a>((PMDINEXTMENU)lParam);
09917         mnm = *(PMDINEXTMENU)lParam;
09918 
09919     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
09920         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
09921     }
09922     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
09923                 pwnd,
09924                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
09925                 wParam,
09926                 (LPARAM)&amp;mnm,
09927                 xParam);
09928 
09929     <span class="keywordflow">try</span> {
09930         *(PMDINEXTMENU)lParam = mnm;
09931     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
09932     }
09933 
09934     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnINOUTNEXTMENU"</span>);
09935     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
09936 }
09937 
09938 <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(DWORDOPTINLPMSG)
09939 {
09940     MSG msgstruct;
09941 
09942     <span class="comment">//</span>
09943     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
09944     <span class="comment">//      enabled. These operations are performed in the User server API</span>
09945     <span class="comment">//      dispatcher.</span>
09946     <span class="comment">//</span>
09947 
09948     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
09949     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnDWORDOPTINLPMSG"</span>);
09950 
09951     UNREFERENCED_PARAMETER(bAnsi);
09952 
09953     <span class="comment">/*</span>
09954 <span class="comment">     * Probe arguments</span>
09955 <span class="comment">     */</span>
09956     <span class="keywordflow">try</span> {
09957         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(lParam)) {
09958             msgstruct = <a class="code" href="../../d4/d1/userk_8h.html#a33">ProbeAndReadMessage</a>((LPMSG)lParam);
09959             lParam = (LPARAM)&amp;msgstruct;
09960         }
09961     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(FALSE)) {
09962         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
09963     }
09964 
09965     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
09966             pwnd,
09967             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
09968             wParam,
09969             lParam,
09970             xParam);
09971 
09972     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnDWORDOPTINLPMSG"</span>);
09973     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
09974 }
09975 
<a name="l09976"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a336">09976</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(COPYGLOBALDATA)
09977 {
09978 
09979     <span class="comment">//</span>
09980     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
09981     <span class="comment">//      enabled. These operations are performed in the User server API</span>
09982     <span class="comment">//      dispatcher.</span>
09983     <span class="comment">//</span>
09984 
09985     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
09986     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnCOPYGLOBALDATA"</span>);
09987 
09988     UNREFERENCED_PARAMETER(bAnsi);
09989 
09990     <span class="comment">/*</span>
09991 <span class="comment">     * Probe arguments</span>
09992 <span class="comment">     */</span>
09993     <span class="keywordflow">try</span> {
09994         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>((PVOID)lParam, wParam, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
09995     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
09996         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
09997     }
09998 
09999     <span class="comment">/*</span>
10000 <span class="comment">     * !!! Data pointed to by lParam must be captured</span>
10001 <span class="comment">     * in xxxInterSendMsgEx</span>
10002 <span class="comment">     */</span>
10003     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
10004             pwnd,
10005             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
10006             wParam,
10007             lParam,
10008             xParam);
10009 
10010     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnCOPYGLOBALDATA"</span>);
10011     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
10012 }
10013 
<a name="l10014"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a337">10014</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(COPYDATA)
10015 {
10016     COPYDATASTRUCT cds;
10017 
10018     <span class="comment">//</span>
10019     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
10020     <span class="comment">//      enabled. These operations are performed in the User server API</span>
10021     <span class="comment">//      dispatcher.</span>
10022     <span class="comment">//</span>
10023 
10024     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
10025     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnCOPYDATA"</span>);
10026 
10027     UNREFERENCED_PARAMETER(bAnsi);
10028 
10029     <span class="comment">/*</span>
10030 <span class="comment">     * Probe arguments</span>
10031 <span class="comment">     */</span>
10032     <span class="keywordflow">try</span> {
10033         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(lParam)) {
10034             cds = <a class="code" href="../../d4/d1/userk_8h.html#a43">ProbeAndReadCopyDataStruct</a>((PCOPYDATASTRUCT)lParam);
10035             <span class="keywordflow">if</span> (cds.lpData)
10036                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(cds.lpData, cds.cbData, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
10037             lParam = (LPARAM)&amp;cds;
10038         }
10039     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
10040         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
10041     }
10042 
10043     <span class="comment">/*</span>
10044 <span class="comment">     * !!! Data pointed to by cds.lpData must be captured</span>
10045 <span class="comment">     * in xxxInterSendMsgEx</span>
10046 <span class="comment">     */</span>
10047     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
10048             pwnd,
10049             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
10050             wParam,
10051             lParam,
10052             xParam);
10053 
10054     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnCOPYDATA"</span>);
10055     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
10056 }
10057 
<a name="l10058"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a338">10058</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(SENTDDEMSG)
10059 {
10060     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
10061     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnSENTDDEMSG"</span>);
10062 
10063     UNREFERENCED_PARAMETER(bAnsi);
10064 
10065     <span class="keywordflow">if</span> (xpfnProc == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a219">FNID_CALLWINDOWPROC</a>) {
10066         retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(pwnd,
10067                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a546">MSGFLAG_DDE_SPECIAL_SEND</a>,
10068                 wParam, lParam, xParam);
10069     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ptiCurrent-&gt;TIF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) &amp;&amp;
10070                (ptiCurrent-&gt;ptdb) &amp;&amp;
10071                (ptiCurrent-&gt;ptdb-&gt;hTaskWow)) {
10072         <span class="comment">/*</span>
10073 <span class="comment">         * Note that this function may modify msg by ORing in a bit in the</span>
10074 <span class="comment">         * high word.  This bit is ignored when thunking messages.</span>
10075 <span class="comment">         * This allows the DdeTrackSendMessage() hook to be skipped - which</span>
10076 <span class="comment">         * would cause an error - and instead allows this thunk to carry</span>
10077 <span class="comment">         * the message all the way across.</span>
10078 <span class="comment">         */</span>
10079         retval = <a class="code" href="../../d4/d1/userk_8h.html#a1874">xxxDDETrackPostHook</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, pwnd, wParam, &amp;lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
10080         <span class="keywordflow">switch</span> (retval) {
10081         <span class="keywordflow">case</span> <a class="code" href="../../d6/d4/ddetrack_8h.html#a19">DO_POST</a>:
10082             <span class="comment">/*</span>
10083 <span class="comment">             * Or in the MSGFLAG_DDE_SPECIAL_SEND so that</span>
10084 <span class="comment">             * xxxSendMessageTimeout() will not pass this on to</span>
10085 <span class="comment">             * xxxDdeTrackSendMsg() which would think it was evil.</span>
10086 <span class="comment">             *</span>
10087 <span class="comment">             * Since the SendMessage() thunks ignore the reserved bits</span>
10088 <span class="comment">             * it will still get maped to the fnSENTDDEMSG callback thunk.</span>
10089 <span class="comment">             */</span>
10090             retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(pwnd,
10091                     <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a546">MSGFLAG_DDE_SPECIAL_SEND</a>,
10092                     wParam, lParam, xParam);
10093             <span class="keywordflow">break</span>;
10094 
10095         <span class="keywordflow">case</span> <a class="code" href="../../d6/d4/ddetrack_8h.html#a18">FAKE_POST</a>:
10096         <span class="keywordflow">case</span> <a class="code" href="../../d6/d4/ddetrack_8h.html#a17">FAIL_POST</a>:
10097             retval = 0;
10098         }
10099     } <span class="keywordflow">else</span> {
10100         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
10101     }
10102 
10103     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnSENTDDEMSG"</span>);
10104     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
10105 }
10106 
<a name="l10107"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a339">10107</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(DDEINIT)
10108 {
10109 
10110     <span class="comment">//</span>
10111     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
10112     <span class="comment">//      enabled. These operations are performed in the User server API</span>
10113     <span class="comment">//      dispatcher.</span>
10114     <span class="comment">//</span>
10115 
10116     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndFrom;
10117     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndFrom;
10118     <a class="code" href="../../d7/d2/structtagDDEIMP.html">PDDEIMP</a> pddei;
10119     PSECURITY_QUALITY_OF_SERVICE pqos;
10120     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
10121 
10122     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
10123     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnDDEINIT"</span>);
10124 
10125     UNREFERENCED_PARAMETER(bAnsi);
10126 
10127     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a55">ValidateHWND</a>(pwndFrom, (HWND)wParam);
10128     <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwndFrom, &amp;tlpwndFrom);
10129 
10130     <span class="comment">/*</span>
10131 <span class="comment">     * Create temporary DDEIMP property for client window - this stays around</span>
10132 <span class="comment">     * only during the initiate phase.</span>
10133 <span class="comment">     */</span>
10134     <span class="keywordflow">if</span> ((pddei = (<a class="code" href="../../d7/d2/structtagDDEIMP.html">PDDEIMP</a>)<a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pwndFrom, <a class="code" href="../../d4/d1/userk_8h.html#a478">PROP_DDEIMP</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
10135             == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
10136         pddei = (<a class="code" href="../../d7/d2/structtagDDEIMP.html">PDDEIMP</a>)UserAllocPoolWithQuota(<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d2/structtagDDEIMP.html">DDEIMP</a>), TAG_DDEd);
10137         <span class="keywordflow">if</span> (pddei == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
10138             RIPERR0(ERROR_NOT_ENOUGH_MEMORY, RIP_WARNING, <span class="stringliteral">"fnDDEINIT: LocalAlloc failed."</span>);
10139             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
10140         }
10141         pqos = (PSECURITY_QUALITY_OF_SERVICE)<a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pwndFrom, <a class="code" href="../../d4/d1/userk_8h.html#a477">PROP_QOS</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
10142         <span class="keywordflow">if</span> (pqos == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
10143             pqos = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a311">gqosDefault</a>;
10144         }
10145         pddei-&gt;<a class="code" href="../../d7/d2/structtagDDEIMP.html#o0">qos</a> = *pqos;
10146         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d5/seclient_8c.html#a1">SeCreateClientSecurity</a>(<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>(),
10147                 pqos, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;pddei-&gt;<a class="code" href="../../d7/d2/structtagDDEIMP.html#o1">ClientContext</a>);
10148         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
10149             RIPMSG0(RIP_WARNING, <span class="stringliteral">"SeCreateClientContext failed."</span>);
10150             UserFreePool(pddei);
10151             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
10152         }
10153         pddei-&gt;<a class="code" href="../../d7/d2/structtagDDEIMP.html#o2">cRefInit</a> = 1;
10154         pddei-&gt;<a class="code" href="../../d7/d2/structtagDDEIMP.html#o3">cRefConv</a> = 0;
10155         <a class="code" href="../../d4/d8/kernel_2winprop_8c.html#a0">InternalSetProp</a>(pwndFrom, <a class="code" href="../../d4/d1/userk_8h.html#a478">PROP_DDEIMP</a>, pddei, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a498">PROPF_INTERNAL</a>);
10156     } <span class="keywordflow">else</span> {
10157         pddei-&gt;<a class="code" href="../../d7/d2/structtagDDEIMP.html#o2">cRefInit</a>++;      <span class="comment">// cover broadcast case!</span>
10158     }
10159 
10160     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
10161             pwnd,
10162             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
10163             wParam,
10164             lParam,
10165             xParam);
10166 
10167     <span class="comment">/*</span>
10168 <span class="comment">     * Reaquire pddei incase pwndFrom was destroyed.</span>
10169 <span class="comment">     */</span>
10170     pddei = (<a class="code" href="../../d7/d2/structtagDDEIMP.html">PDDEIMP</a>)<a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pwndFrom, <a class="code" href="../../d4/d1/userk_8h.html#a478">PROP_DDEIMP</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
10171     <span class="keywordflow">if</span> (pddei != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
10172         <span class="comment">/*</span>
10173 <span class="comment">         * Decrement reference count from DDEImpersonate property and remove property.</span>
10174 <span class="comment">         */</span>
10175         pddei-&gt;<a class="code" href="../../d7/d2/structtagDDEIMP.html#o2">cRefInit</a>--;
10176         <span class="keywordflow">if</span> (pddei-&gt;<a class="code" href="../../d7/d2/structtagDDEIMP.html#o2">cRefInit</a> == 0) {
10177             <a class="code" href="../../d4/d8/kernel_2winprop_8c.html#a1">InternalRemoveProp</a>(pwndFrom, <a class="code" href="../../d4/d1/userk_8h.html#a478">PROP_DDEIMP</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
10178             <span class="keywordflow">if</span> (pddei-&gt;<a class="code" href="../../d7/d2/structtagDDEIMP.html#o3">cRefConv</a> == 0) {
10179                 <a class="code" href="../../d0/d5/se_8h.html#a12">SeDeleteClientSecurity</a>(&amp;pddei-&gt;<a class="code" href="../../d7/d2/structtagDDEIMP.html#o1">ClientContext</a>);
10180                 UserFreePool(pddei);
10181             }
10182         }
10183     }
10184 
10185     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a33">CLEANUPRECV</a>();
10186     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndFrom);
10187 
10188     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnDDEINIT"</span>);
10189     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
10190 }
10191 
<a name="l10192"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a340">10192</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(INPAINTCLIPBRD)
10193 {
10194     PAINTSTRUCT ps;
10195 
10196     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
10197     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnINPAINTCLIPBRD"</span>);
10198 
10199     UNREFERENCED_PARAMETER(bAnsi);
10200 
10201     <span class="comment">/*</span>
10202 <span class="comment">     * Probe arguments</span>
10203 <span class="comment">     */</span>
10204     <span class="keywordflow">try</span> {
10205         ps = <a class="code" href="../../d4/d1/userk_8h.html#a40">ProbeAndReadPaintStruct</a>((PPAINTSTRUCT)lParam);
10206     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
10207         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
10208     }
10209 
10210     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
10211             pwnd,
10212             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
10213             wParam,
10214             (LPARAM)&amp;ps,
10215             xParam);
10216 
10217     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnINPAINTCLIPBRD"</span>);
10218     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
10219 }
10220 
<a name="l10221"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a341">10221</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(INSIZECLIPBRD)
10222 {
10223     RECT rc;
10224 
10225     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
10226     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnINSIZECLIPBRD"</span>);
10227 
10228     UNREFERENCED_PARAMETER(bAnsi);
10229 
10230     <span class="comment">/*</span>
10231 <span class="comment">     * Probe arguments</span>
10232 <span class="comment">     */</span>
10233     <span class="keywordflow">try</span> {
10234         rc = <a class="code" href="../../d4/d1/userk_8h.html#a31">ProbeAndReadRect</a>((PRECT)lParam);
10235     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
10236         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
10237     }
10238 
10239     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
10240             pwnd,
10241             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
10242             wParam,
10243             (LPARAM)&amp;rc,
10244             xParam);
10245 
10246     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnINSIZECLIPBRD"</span>);
10247     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
10248 }
10249 
10250 <span class="preprocessor">#if 0</span>
10251 <span class="preprocessor"></span>
10252 <span class="comment">// !!!LATER not needed until we support multiple screens</span>
10253 
10254 <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(FULLSCREEN)
10255 {
10256     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
10257 
10258     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(LRESULT, FALSE);
10259     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnFULLSCREEN"</span>);
10260 
10261     <span class="comment">/*</span>
10262 <span class="comment">     * Probe arguments</span>
10263 <span class="comment">     */</span>
10264     <span class="keywordflow">try</span> {
10265     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(FALSE)) {
10266         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
10267     }
10268 
10269     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a55">ValidateHWND</a>(pwnd, hwnd);
10270 
10271     <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwnd, &amp;tlpwnd);
10272     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
10273             pwnd,
10274             pmsg-&gt;msg,
10275             pmsg-&gt;wParam,
10276             (LONG)pdeviceinfo,
10277             pmsg-&gt;xParam);
10278     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
10279 
10280     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnFULLSCREEN"</span>);
10281     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
10282 }
10283 
10284 <span class="preprocessor">#endif // 0</span>
10285 <span class="preprocessor"></span>
<a name="l10286"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a342">10286</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(INOUTDRAG)
10287 {
10288     DROPSTRUCT <a class="code" href="../../d7/d4/conexts_8c.html#a30">ds</a>;
10289 
10290     <span class="comment">//</span>
10291     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
10292     <span class="comment">//      enabled. These operations are performed in the User server API</span>
10293     <span class="comment">//      dispatcher.</span>
10294     <span class="comment">//</span>
10295 
10296     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
10297     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnINOUTDRAG"</span>);
10298 
10299     UNREFERENCED_PARAMETER(bAnsi);
10300 
10301     <span class="comment">/*</span>
10302 <span class="comment">     * Probe arguments</span>
10303 <span class="comment">     */</span>
10304     <span class="keywordflow">try</span> {
10305         <a class="code" href="../../d4/d1/userk_8h.html#a71">ProbeForWriteDropStruct</a>((PDROPSTRUCT)lParam);
10306         <a class="code" href="../../d7/d4/conexts_8c.html#a30">ds</a> = *(PDROPSTRUCT)lParam;
10307 
10308     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
10309         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
10310     }
10311     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
10312                 pwnd,
10313                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
10314                 wParam,
10315                 (LPARAM)&amp;<a class="code" href="../../d7/d4/conexts_8c.html#a30">ds</a>,
10316                 xParam);
10317 
10318     <span class="keywordflow">try</span> {
10319         *(PDROPSTRUCT)lParam = <a class="code" href="../../d7/d4/conexts_8c.html#a30">ds</a>;
10320     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
10321     }
10322 
10323     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnINOUTDRAG"</span>);
10324     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
10325 }
10326 
<a name="l10327"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a343">10327</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(GETDBCSTEXTLENGTHS)
10328 {
10329 
10330     <span class="comment">//</span>
10331     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
10332     <span class="comment">//      enabled. These operations are performed in the User server API</span>
10333     <span class="comment">//      dispatcher.</span>
10334     <span class="comment">//</span>
10335 
10336     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
10337     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnGETDBCSTEXTLENGTHS"</span>);
10338 
10339     UNREFERENCED_PARAMETER(lParam);
10340 
10341     <span class="comment">/*</span>
10342 <span class="comment">     * This is used by L/CB_GETTEXTLEN which should return -1 (L/CB_ERR)</span>
10343 <span class="comment">     *  on error. If any error code path is introduced here, make sure we return the</span>
10344 <span class="comment">     *  proper value.This is also used by WM_GETTEXTLEN.</span>
10345 <span class="comment">     */</span>
10346 
10347     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
10348             pwnd,
10349             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
10350             wParam,
10351             bAnsi,
10352             xParam);
10353 
10354     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnGETDBCSTEXTLENGTHS"</span>);
10355     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
10356 }
10357 
<a name="l10358"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a344">10358</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(INLPCREATESTRUCT)
10359 {
10360     <a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html">CREATESTRUCTEX</a> csex;
10361 
10362     <span class="comment">//</span>
10363     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
10364     <span class="comment">//      enabled. These operations are performed in the User server API</span>
10365     <span class="comment">//      dispatcher.</span>
10366     <span class="comment">//</span>
10367 
10368     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
10369     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnINLPCREATESTRUCT"</span>);
10370 
10371     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(lParam)) {
10372         <span class="keywordflow">try</span> {
10373             csex.<a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html#o0">cs</a> = <a class="code" href="../../d4/d1/userk_8h.html#a41">ProbeAndReadCreateStruct</a>((LPCREATESTRUCTW)lParam);
10374             <span class="keywordflow">if</span> (bAnsi) {
10375                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(csex.<a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html#o0">cs</a>.lpszName, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>), <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
10376                 <a class="code" href="../../d5/d6/chartran_8c.html#a6">RtlInitLargeAnsiString</a>((<a class="code" href="../../d5/d8/struct__LARGE__ANSI__STRING.html">PLARGE_ANSI_STRING</a>)&amp;csex.<a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html#o1">strName</a>,
10377                         (LPSTR)csex.<a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html#o0">cs</a>.lpszName, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1);
10378                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(csex.<a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html#o0">cs</a>.lpszClass)) {
10379                     <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(csex.<a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html#o0">cs</a>.lpszClass, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>), <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
10380                     <a class="code" href="../../d5/d6/chartran_8c.html#a6">RtlInitLargeAnsiString</a>((<a class="code" href="../../d5/d8/struct__LARGE__ANSI__STRING.html">PLARGE_ANSI_STRING</a>)&amp;csex.<a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html#o2">strClass</a>,
10381                             (LPSTR)csex.<a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html#o0">cs</a>.lpszClass, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1);
10382                 }
10383             } <span class="keywordflow">else</span> {
10384                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(csex.<a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html#o0">cs</a>.lpszName, <span class="keyword">sizeof</span>(WCHAR), <a class="code" href="../../d4/d1/userk_8h.html#a23">CHARALIGN</a>);
10385                 <a class="code" href="../../d5/d6/chartran_8c.html#a7">RtlInitLargeUnicodeString</a>((<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html">PLARGE_UNICODE_STRING</a>)&amp;csex.<a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html#o1">strName</a>,
10386                         csex.<a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html#o0">cs</a>.lpszName, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1);
10387                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(csex.<a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html#o0">cs</a>.lpszClass)) {
10388                     <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(csex.<a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html#o0">cs</a>.lpszClass, <span class="keyword">sizeof</span>(WCHAR), <a class="code" href="../../d4/d1/userk_8h.html#a23">CHARALIGN</a>);
10389                     <a class="code" href="../../d5/d6/chartran_8c.html#a7">RtlInitLargeUnicodeString</a>((<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html">PLARGE_UNICODE_STRING</a>)&amp;csex.<a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html#o2">strClass</a>,
10390                             csex.<a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html#o0">cs</a>.lpszClass, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1);
10391                 }
10392             }
10393         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
10394             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
10395         }
10396     }
10397 
10398     <span class="comment">/*</span>
10399 <span class="comment">     * Per Win95, do not allow NULL lpcreatestructs for WM_NCCREATE [51986]</span>
10400 <span class="comment">     * Allowed for WM_CREATE in Win95 for ObjectVision</span>
10401 <span class="comment">     */</span>
10402     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> == WM_NCCREATE) {
10403         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0) ;
10404     }
10405 
10406     <span class="comment">/*</span>
10407 <span class="comment">     * !!! Strings pointed to by cs.cs must be captured in xxxInterSendMsgEx</span>
10408 <span class="comment">     */</span>
10409     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
10410             pwnd,
10411             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
10412             wParam,
10413             lParam ? (LPARAM)&amp;csex : 0,
10414             xParam);
10415 
10416     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnINLPCREATESTRUCT"</span>);
10417     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
10418 }
10419 
<a name="l10420"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a345">10420</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(INLPMDICREATESTRUCT)
10421 {
10422     <span class="comment">//</span>
10423     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
10424     <span class="comment">//      enabled. These operations are performed in the User server API</span>
10425     <span class="comment">//      dispatcher.</span>
10426     <span class="comment">//</span>
10427 
10428     <a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html">MDICREATESTRUCTEX</a> mdics;
10429 
10430     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
10431     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnINLPMDICREATESTRUCT"</span>);
10432 
10433     <span class="comment">/*</span>
10434 <span class="comment">     * Probe arguments</span>
10435 <span class="comment">     */</span>
10436     <span class="keywordflow">try</span> {
10437         mdics.<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o0">mdics</a> = <a class="code" href="../../d4/d1/userk_8h.html#a42">ProbeAndReadMDICreateStruct</a>((LPMDICREATESTRUCTW)lParam);
10438 
10439         <span class="keywordflow">if</span> (bAnsi) {
10440             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(mdics.<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o0">mdics</a>.szTitle, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>), <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
10441             <a class="code" href="../../d5/d6/chartran_8c.html#a6">RtlInitLargeAnsiString</a>((<a class="code" href="../../d5/d8/struct__LARGE__ANSI__STRING.html">PLARGE_ANSI_STRING</a>)&amp;mdics.<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o1">strTitle</a>,
10442                     (LPSTR)mdics.<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o0">mdics</a>.szTitle, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1);
10443             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(mdics.<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o0">mdics</a>.szClass)) {
10444                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(mdics.<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o0">mdics</a>.szClass, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>), <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
10445                 <a class="code" href="../../d5/d6/chartran_8c.html#a6">RtlInitLargeAnsiString</a>((<a class="code" href="../../d5/d8/struct__LARGE__ANSI__STRING.html">PLARGE_ANSI_STRING</a>)&amp;mdics.<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o2">strClass</a>,
10446                         (LPSTR)mdics.<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o0">mdics</a>.szClass, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1);
10447             } <span class="keywordflow">else</span> {
10448                 <span class="comment">/*</span>
10449 <span class="comment">                 * mdics.mdics.szClass may be Atom.</span>
10450 <span class="comment">                 */</span>
10451                 <a class="code" href="../../d5/d6/chartran_8c.html#a6">RtlInitLargeAnsiString</a>((<a class="code" href="../../d5/d8/struct__LARGE__ANSI__STRING.html">PLARGE_ANSI_STRING</a>)&amp;mdics.<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o2">strClass</a>,
10452                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
10453             }
10454         } <span class="keywordflow">else</span> {
10455             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(mdics.<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o0">mdics</a>.szTitle, <span class="keyword">sizeof</span>(WCHAR), <a class="code" href="../../d4/d1/userk_8h.html#a23">CHARALIGN</a>);
10456             <a class="code" href="../../d5/d6/chartran_8c.html#a7">RtlInitLargeUnicodeString</a>((<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html">PLARGE_UNICODE_STRING</a>)&amp;mdics.<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o1">strTitle</a>,
10457                     mdics.<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o0">mdics</a>.szTitle, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1);
10458             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(mdics.<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o0">mdics</a>.szClass)) {
10459                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(mdics.<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o0">mdics</a>.szClass, <span class="keyword">sizeof</span>(WCHAR), <a class="code" href="../../d4/d1/userk_8h.html#a23">CHARALIGN</a>);
10460                 <a class="code" href="../../d5/d6/chartran_8c.html#a7">RtlInitLargeUnicodeString</a>((<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html">PLARGE_UNICODE_STRING</a>)&amp;mdics.<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o2">strClass</a>,
10461                         mdics.<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o0">mdics</a>.szClass, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1);
10462             } <span class="keywordflow">else</span> {
10463                 <span class="comment">/*</span>
10464 <span class="comment">                 * mdics.mdics.szClass may be Atom.</span>
10465 <span class="comment">                 */</span>
10466                 <a class="code" href="../../d5/d6/chartran_8c.html#a7">RtlInitLargeUnicodeString</a>((<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html">PLARGE_UNICODE_STRING</a>)&amp;mdics.<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o2">strClass</a>,
10467                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
10468             }
10469         }
10470     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
10471         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
10472     }
10473 
10474     <span class="comment">/*</span>
10475 <span class="comment">     * !!! Strings pointed to by mdics must be captured in xxxInterSendMsgEx</span>
10476 <span class="comment">     */</span>
10477     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
10478             pwnd,
10479             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
10480             wParam,
10481             (LPARAM)&amp;mdics,
10482             xParam);
10483 
10484     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnINLPMDICREATESTRUCT"</span>);
10485     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
10486 }
10487 
<a name="l10488"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a346">10488</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(INOUTLPSCROLLINFO)
10489 {
10490     SCROLLINFO scrollinfo;
10491 
10492     <span class="comment">//</span>
10493     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
10494     <span class="comment">//      enabled. These operations are performed in the User server API</span>
10495     <span class="comment">//      dispatcher.</span>
10496     <span class="comment">//</span>
10497 
10498     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
10499     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnINOUTLPSCROLLINFO"</span>);
10500 
10501     UNREFERENCED_PARAMETER(bAnsi);
10502 
10503     <span class="comment">/*</span>
10504 <span class="comment">     * Probe arguments</span>
10505 <span class="comment">     */</span>
10506     <span class="keywordflow">try</span> {
10507         <a class="code" href="../../d4/d1/userk_8h.html#a72">ProbeForWriteScrollInfo</a>((LPSCROLLINFO)lParam);
10508         scrollinfo = *(LPSCROLLINFO)lParam;
10509     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
10510         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
10511     }
10512 
10513     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
10514                 pwnd,
10515                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
10516                 wParam,
10517                 (LPARAM)&amp;scrollinfo,
10518                 xParam);
10519 
10520     <span class="keywordflow">try</span> {
10521         *(LPSCROLLINFO)lParam = scrollinfo;
10522     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
10523     }
10524 
10525     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnINOUTLPSCROLLINFO"</span>);
10526     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
10527 }
10528 
<a name="l10529"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a347">10529</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(INOUTLPPOINT5)
10530 {
10531     <a class="code" href="../../d8/d5/structPOINT5.html">POINT5</a> pt5;
10532 
10533     <span class="comment">//</span>
10534     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
10535     <span class="comment">//      enabled. These operations are performed in the User server API</span>
10536     <span class="comment">//      dispatcher.</span>
10537     <span class="comment">//</span>
10538 
10539     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
10540     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnINOUTLPPOINT5"</span>);
10541 
10542     UNREFERENCED_PARAMETER(bAnsi);
10543 
10544     <span class="comment">/*</span>
10545 <span class="comment">     * Probe arguments</span>
10546 <span class="comment">     */</span>
10547     <span class="keywordflow">try</span> {
10548         <a class="code" href="../../d4/d1/userk_8h.html#a80">ProbeForWritePoint5</a>((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a986">LPPOINT5</a>)lParam);
10549         pt5 = *(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a986">LPPOINT5</a>)lParam;
10550     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
10551         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
10552     }
10553 
10554     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
10555                 pwnd,
10556                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
10557                 wParam,
10558                 (LPARAM)&amp;pt5,
10559                 xParam);
10560 
10561     <span class="keywordflow">try</span> {
10562         *(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a986">LPPOINT5</a>)lParam = pt5;
10563     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
10564     }
10565 
10566     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnINOUTLPPOINT5"</span>);
10567     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
10568 }
10569 
<a name="l10570"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a348">10570</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(INSTRING)
10571 {
10572     <a class="code" href="../../d1/d9/struct__LARGE__STRING.html">LARGE_STRING</a> str;
10573 
10574     <span class="comment">//</span>
10575     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
10576     <span class="comment">//      enabled. These operations are performed in the User server API</span>
10577     <span class="comment">//      dispatcher.</span>
10578     <span class="comment">//</span>
10579 
10580     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
10581     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnINSTRING"</span>);
10582 
10583     <span class="comment">/*</span>
10584 <span class="comment">     * Don't allow any app to send a LB_DIR or CB_DIR with the postmsgs bit</span>
10585 <span class="comment">     * set (ObjectVision does this). This is because there is actually a legal</span>
10586 <span class="comment">     * case that we need to thunk of user posting a LB_DIR or CB_DIR</span>
10587 <span class="comment">     * (DlgDirListHelper()). In the post case, we thunk the lParam (pointer</span>
10588 <span class="comment">     * to a string) differently, and we track that post case with the</span>
10589 <span class="comment">     * DDL_POSTMSGS bit. If an app sends a message with this bit, then our</span>
10590 <span class="comment">     * thunking gets confused, so clear it here. Let's hope that no app</span>
10591 <span class="comment">     * depends on this bit set when either of these messages are sent.</span>
10592 <span class="comment">     *</span>
10593 <span class="comment">     * These messages should return -1 on failure</span>
10594 <span class="comment">     */</span>
10595     <span class="keywordflow">switch</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>) {
10596     <span class="keywordflow">case</span> LB_DIR:
10597     <span class="keywordflow">case</span> CB_DIR:
10598         wParam &amp;= ~DDL_POSTMSGS;
10599         <span class="comment">/* Fall through */</span>
10600 
10601     <span class="keywordflow">case</span> LB_ADDFILE:
10602 <span class="preprocessor">#if (LB_ERR != CB_ERR)</span>
10603 <span class="preprocessor"></span><span class="preprocessor">#error LB_ERR/CB_ERR conflict</span>
10604 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
10605 <span class="preprocessor"></span>        errret = LB_ERR;
10606         <span class="keywordflow">break</span>;
10607     }
10608 
10609     <span class="comment">/*</span>
10610 <span class="comment">     * Probe arguments</span>
10611 <span class="comment">     */</span>
10612     <span class="keywordflow">try</span> {
10613         <span class="keywordflow">if</span> (bAnsi) {
10614             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>((LPSTR)lParam, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>), <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
10615             <a class="code" href="../../d5/d6/chartran_8c.html#a6">RtlInitLargeAnsiString</a>((<a class="code" href="../../d5/d8/struct__LARGE__ANSI__STRING.html">PLARGE_ANSI_STRING</a>)&amp;str,
10616                     (LPSTR)lParam, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1);
10617         } <span class="keywordflow">else</span> {
10618             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>((LPWSTR)lParam, <span class="keyword">sizeof</span>(WCHAR), <a class="code" href="../../d4/d1/userk_8h.html#a23">CHARALIGN</a>);
10619             <a class="code" href="../../d5/d6/chartran_8c.html#a7">RtlInitLargeUnicodeString</a>((<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html">PLARGE_UNICODE_STRING</a>)&amp;str,
10620                     (LPWSTR)lParam, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1);
10621         }
10622     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
10623         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
10624     }
10625 
10626     <span class="comment">/*</span>
10627 <span class="comment">     * !!! str.Buffer must be captured in xxxInterSendMsgEx</span>
10628 <span class="comment">     */</span>
10629     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
10630             pwnd,
10631             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
10632             wParam,
10633             (LPARAM)&amp;str,
10634             xParam);
10635 
10636     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnINSTRING"</span>);
10637     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
10638 }
10639 
10640 <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(INSTRINGNULL)
10641 {
10642     <a class="code" href="../../d1/d9/struct__LARGE__STRING.html">LARGE_STRING</a> str;
10643 
10644     <span class="comment">//</span>
10645     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
10646     <span class="comment">//      enabled. These operations are performed in the User server API</span>
10647     <span class="comment">//      dispatcher.</span>
10648     <span class="comment">//</span>
10649 
10650     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
10651     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnINSTRINGNULL"</span>);
10652 
10653     <span class="comment">/*</span>
10654 <span class="comment">     * Probe arguments</span>
10655 <span class="comment">     */</span>
10656     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(lParam)) {
10657         <span class="keywordflow">try</span> {
10658             <span class="keywordflow">if</span> (bAnsi) {
10659                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>((LPSTR)lParam, <span class="keyword">sizeof</span>(CHAR), <span class="keyword">sizeof</span>(CHAR));
10660                 <a class="code" href="../../d5/d6/chartran_8c.html#a6">RtlInitLargeAnsiString</a>((<a class="code" href="../../d5/d8/struct__LARGE__ANSI__STRING.html">PLARGE_ANSI_STRING</a>)&amp;str,
10661                         (LPSTR)lParam, (UINT)-1);
10662             } <span class="keywordflow">else</span> {
10663                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>((LPWSTR)lParam, <span class="keyword">sizeof</span>(WCHAR), CHARALIGN);
10664                 <a class="code" href="../../d5/d6/chartran_8c.html#a7">RtlInitLargeUnicodeString</a>((<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html">PLARGE_UNICODE_STRING</a>)&amp;str,
10665                         (LPWSTR)lParam, (UINT)-1);
10666             }
10667             lParam = (LPARAM)&amp;str;
10668         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(FALSE)) {
10669             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
10670         }
10671     }
10672 
10673     <span class="comment">/*</span>
10674 <span class="comment">     * !!! str.Buffer must be captured in xxxInterSendMsgEx</span>
10675 <span class="comment">     */</span>
10676     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
10677             pwnd,
10678             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
10679             wParam,
10680             lParam,
10681             xParam);
10682 
10683     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnINSTRINGNULL"</span>);
10684     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
10685 }
10686 
<a name="l10687"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a349">10687</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(INDEVICECHANGE)
10688 {
10689     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fPtr    = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)((wParam &amp; 0x8000) == 0x8000);
10690     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbSize;
10691     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> bfr = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
10692     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlBuffer;
10693 
10694     <span class="comment">//</span>
10695     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
10696     <span class="comment">//      enabled. These operations are performed in the User server API</span>
10697     <span class="comment">//      dispatcher.</span>
10698     <span class="comment">//</span>
10699 
10700     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
10701     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnINDEVICECHANGE"</span>);
10702 
10703     UNREFERENCED_PARAMETER(bAnsi);
10704 
10705     <span class="comment">/*</span>
10706 <span class="comment">     * Probe arguments</span>
10707 <span class="comment">     */</span>
10708     <span class="keywordflow">if</span> (fPtr &amp;&amp; lParam) {
10709         <span class="keyword">struct </span>_DEV_BROADCAST_HEADER *pHdr;
10710         PDEV_BROADCAST_DEVICEINTERFACE_W pInterfaceW;
10711         PDEV_BROADCAST_PORT_W pPortW;
10712         PDEV_BROADCAST_HANDLE pHandleW;
10713         <span class="keywordflow">try</span> {
10714             pHdr = (<span class="keyword">struct </span>_DEV_BROADCAST_HEADER *)lParam;
10715             cbSize = <a class="code" href="../../d5/d8/ex_8h.html#a20">ProbeAndReadUlong</a>(&amp;(pHdr-&gt;dbcd_size));
10716             <span class="keywordflow">if</span> (cbSize &lt; <span class="keyword">sizeof</span>(*pHdr)) {
10717                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(ERROR_INVALID_PARAMETER);
10718             }
10719             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(pHdr, cbSize, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
10720 
10721             bfr = UserAllocPoolWithQuota(cbSize+2, TAG_DEVICECHANGE); <span class="comment">// add space for trailing NULL for test</span>
10722             <span class="keywordflow">if</span> (bfr == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
10723                 RIPERR0(ERROR_NOT_ENOUGH_MEMORY, RIP_WARNING, <span class="stringliteral">"fnINDEVICECHANGE: LocalAlloc failed."</span>);
10724                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
10725             }
10726 
10727             <a class="code" href="../../d4/d1/userk_8h.html#a137">ThreadLockPool</a>(ptiCurrent, bfr, &amp;tlBuffer);
10728 
10729             RtlCopyMemory(bfr,  (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)lParam,
10730                         cbSize);
10731             ((PWSTR)bfr)[cbSize/<span class="keyword">sizeof</span>(WCHAR)] = 0;  <span class="comment">// trailing null to halt wcslen scan</span>
10732             lParam = (LPARAM)bfr;
10733             pHdr = (<span class="keyword">struct </span>_DEV_BROADCAST_HEADER *)lParam;
10734             <span class="keywordflow">if</span> (pHdr-&gt;dbcd_size != cbSize) {
10735                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
10736             }
10737             <span class="keywordflow">switch</span>(pHdr-&gt;dbcd_devicetype) {
10738             <span class="keywordflow">case</span> DBT_DEVTYP_PORT:
10739                 pPortW = (PDEV_BROADCAST_PORT_W)lParam;
10740                 <span class="keywordflow">if</span> ((1+wcslen(pPortW-&gt;dbcp_name))*<span class="keyword">sizeof</span>(WCHAR) + FIELD_OFFSET(DEV_BROADCAST_PORT_W, dbcp_name) &gt; cbSize) {
10741                     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
10742                 }
10743                 <span class="keywordflow">break</span>;
10744             <span class="keywordflow">case</span> DBT_DEVTYP_DEVICEINTERFACE:
10745                 pInterfaceW = (PDEV_BROADCAST_DEVICEINTERFACE_W)lParam;
10746                 <span class="keywordflow">if</span> ((1+wcslen(pInterfaceW-&gt;dbcc_name))*<span class="keyword">sizeof</span>(WCHAR) + FIELD_OFFSET(DEV_BROADCAST_DEVICEINTERFACE_W, dbcc_name) &gt; cbSize) {
10747                     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
10748                 }
10749                 <span class="keywordflow">break</span>;
10750             <span class="keywordflow">case</span> DBT_DEVTYP_HANDLE:
10751                 pHandleW = (PDEV_BROADCAST_HANDLE)lParam;
10752             <span class="comment">/*</span>
10753 <span class="comment">             * Check if there is any text.</span>
10754 <span class="comment">             */</span>
10755 
10756                 <span class="keywordflow">if</span> (wParam != DBT_CUSTOMEVENT) {
10757                     <span class="keywordflow">if</span> (FIELD_OFFSET(DEV_BROADCAST_HANDLE, dbch_eventguid) &gt; cbSize) {
10758                         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
10759                     }
10760                     <span class="keywordflow">break</span>;
10761                 }
10762                 <span class="keywordflow">if</span> (pHandleW-&gt;dbch_nameoffset &lt; 0) {
10763                     <span class="keywordflow">if</span> (FIELD_OFFSET(DEV_BROADCAST_HANDLE, dbch_data) &gt; cbSize) {
10764                         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
10765                     }
10766                     <span class="keywordflow">break</span>;
10767                 }
10768                 <span class="keywordflow">if</span> (pHandleW-&gt;dbch_nameoffset &amp; (<a class="code" href="../../d4/d1/userk_8h.html#a23">CHARALIGN</a> - 1)) {
10769                     <a class="code" href="../../d5/d8/ex_8h.html#a304">ExRaiseDatatypeMisalignment</a>();                                                            \
10770                 }
10771                 <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(FIELD_OFFSET(DEV_BROADCAST_HANDLE, dbch_data) + pHandleW-&gt;dbch_nameoffset) &gt; cbSize) {
10772                     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
10773                 }
10774                 <span class="keywordflow">if</span> (FIELD_OFFSET(DEV_BROADCAST_HANDLE, dbch_data) + pHandleW-&gt;dbch_nameoffset +
10775                     (1+wcslen((LPWSTR)(pHandleW-&gt;dbch_data+pHandleW-&gt;dbch_nameoffset)))*<span class="keyword">sizeof</span>(WCHAR) &gt;
10776                     cbSize) {
10777                     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
10778                 }
10779                 <span class="keywordflow">break</span>;
10780 
10781             }
10782 
10783         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
10784             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
10785         }
10786 
10787     }
10788 
10789     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
10790             pwnd,
10791             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
10792             wParam,
10793             lParam,
10794             xParam);
10795 
10796     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a33">CLEANUPRECV</a>();
10797     <span class="keywordflow">if</span> (bfr)
10798         <a class="code" href="../../d4/d1/userk_8h.html#a139">ThreadUnlockAndFreePool</a>(ptiCurrent, &amp;tlBuffer);
10799 
10800     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnINDEVICECHANGE"</span>);
10801     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
10802 }
10803 
<a name="l10804"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a350">10804</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(INOUTNCCALCSIZE)
10805 {
10806     NCCALCSIZE_PARAMS params;
10807     WINDOWPOS pos;
10808     PWINDOWPOS pposClient;
10809     RECT rc;
10810     LPARAM lParamLocal;
10811 
10812     <span class="comment">//</span>
10813     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
10814     <span class="comment">//      enabled. These operations are performed in the User server API</span>
10815     <span class="comment">//      dispatcher.</span>
10816     <span class="comment">//</span>
10817 
10818     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
10819     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnINOUTNCCALCSIZE"</span>);
10820 
10821     UNREFERENCED_PARAMETER(bAnsi);
10822 
10823     <span class="comment">/*</span>
10824 <span class="comment">     * Probe arguments</span>
10825 <span class="comment">     */</span>
10826     <span class="keywordflow">try</span> {
10827         <span class="keywordflow">if</span> (wParam != 0) {
10828             <a class="code" href="../../d4/d1/userk_8h.html#a81">ProbeForWriteNCCalcSize</a>((LPNCCALCSIZE_PARAMS)lParam);
10829             params = *(LPNCCALCSIZE_PARAMS)lParam;
10830             <a class="code" href="../../d4/d1/userk_8h.html#a82">ProbeForWriteWindowPos</a>(params.lppos);
10831             pposClient = params.lppos;
10832             pos = *params.lppos;
10833             params.lppos = &amp;pos;
10834             lParamLocal = (LPARAM)&amp;params;
10835         } <span class="keywordflow">else</span> {
10836             <a class="code" href="../../d4/d1/userk_8h.html#a68">ProbeForWriteRect</a>((LPRECT)lParam);
10837             rc = *(LPRECT)lParam;
10838             lParamLocal = (LPARAM)&amp;rc;
10839         }
10840     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
10841         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
10842     }
10843     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
10844                 pwnd,
10845                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
10846                 wParam,
10847                 lParamLocal,
10848                 xParam);
10849 
10850     <span class="keywordflow">try</span> {
10851         <span class="keywordflow">if</span> (wParam != 0) {
10852             *(LPNCCALCSIZE_PARAMS)lParam = params;
10853             ((LPNCCALCSIZE_PARAMS)lParam)-&gt;lppos = pposClient;
10854             *pposClient = pos;
10855         } <span class="keywordflow">else</span> {
10856             *(LPRECT)lParam = rc;
10857         }
10858     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
10859     }
10860 
10861     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnINOUTNCCALCSIZE"</span>);
10862     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
10863 }
10864 
<a name="l10865"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a351">10865</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(INOUTSTYLECHANGE)
10866 {
10867     STYLESTRUCT ss;
10868 
10869     <span class="comment">//</span>
10870     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
10871     <span class="comment">//      enabled. These operations are performed in the User server API</span>
10872     <span class="comment">//      dispatcher.</span>
10873     <span class="comment">//</span>
10874 
10875     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
10876     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnINOUTSTYLECHANGE"</span>);
10877 
10878     UNREFERENCED_PARAMETER(bAnsi);
10879 
10880     <span class="comment">/*</span>
10881 <span class="comment">     * Probe arguments</span>
10882 <span class="comment">     */</span>
10883     <span class="keywordflow">try</span> {
10884         <a class="code" href="../../d4/d1/userk_8h.html#a73">ProbeForWriteStyleStruct</a>((LPSTYLESTRUCT)lParam);
10885         ss = *(LPSTYLESTRUCT)lParam;
10886     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
10887         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
10888     }
10889 
10890     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
10891                 pwnd,
10892                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
10893                 wParam,
10894                 (LPARAM)&amp;ss,
10895                 xParam);
10896 
10897     <span class="keywordflow">try</span> {
10898         *(LPSTYLESTRUCT)lParam = ss;
10899     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
10900     }
10901 
10902     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnINOUTSTYLECHANGE"</span>);
10903     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
10904 }
10905 
<a name="l10906"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a352">10906</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(INOUTLPRECT)
10907 {
10908     RECT rc;
10909 
10910     <span class="comment">//</span>
10911     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
10912     <span class="comment">//      enabled. These operations are performed in the User server API</span>
10913     <span class="comment">//      dispatcher.</span>
10914     <span class="comment">//</span>
10915 
10916     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>((<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> == LB_GETITEMRECT ? LB_ERR : 0));
10917     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnINOUTLPRECT"</span>);
10918 
10919     UNREFERENCED_PARAMETER(bAnsi);
10920 
10921     <span class="comment">/*</span>
10922 <span class="comment">     * Probe arguments</span>
10923 <span class="comment">     */</span>
10924     <span class="keywordflow">try</span> {
10925         <a class="code" href="../../d4/d1/userk_8h.html#a68">ProbeForWriteRect</a>((PRECT)lParam);
10926         rc = *(PRECT)lParam;
10927     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
10928         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
10929     }
10930 
10931     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
10932                 pwnd,
10933                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
10934                 wParam,
10935                 (LPARAM)&amp;rc,
10936                 xParam);
10937 
10938     <span class="keywordflow">try</span> {
10939         *(PRECT)lParam = rc;
10940     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
10941     }
10942 
10943     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnINOUTLPRECT"</span>);
10944     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
10945 }
10946 
<a name="l10947"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a353">10947</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(OUTLPSCROLLINFO)
10948 {
10949     SCROLLINFO scrollinfo;
10950 
10951     <span class="comment">//</span>
10952     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
10953     <span class="comment">//      enabled. These operations are performed in the User server API</span>
10954     <span class="comment">//      dispatcher.</span>
10955     <span class="comment">//</span>
10956 
10957     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
10958     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnOUTLPSCROLLINFO"</span>);
10959 
10960     UNREFERENCED_PARAMETER(bAnsi);
10961 
10962     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
10963             pwnd,
10964             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
10965             wParam,
10966             (LPARAM)&amp;scrollinfo,
10967             xParam);
10968 
10969     <span class="comment">/*</span>
10970 <span class="comment">     * Probe arguments</span>
10971 <span class="comment">     */</span>
10972     <span class="keywordflow">try</span> {
10973         <a class="code" href="../../d5/d8/ex_8h.html#a54">ProbeAndWriteStructure</a>((LPSCROLLINFO)lParam, scrollinfo, SCROLLINFO);
10974     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
10975         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
10976     }
10977 
10978     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnOUTLPSCROLLINFO"</span>);
10979     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
10980 }
10981 
<a name="l10982"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a354">10982</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(OUTLPRECT)
10983 {
10984     RECT rc;
10985 
10986     <span class="comment">//</span>
10987     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
10988     <span class="comment">//      enabled. These operations are performed in the User server API</span>
10989     <span class="comment">//      dispatcher.</span>
10990     <span class="comment">//</span>
10991 
10992     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
10993     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnOUTLPRECT"</span>);
10994 
10995     UNREFERENCED_PARAMETER(bAnsi);
10996 
10997     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
10998             pwnd,
10999             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
11000             wParam,
11001             (LPARAM)&amp;rc,
11002             xParam);
11003 
11004     <span class="comment">/*</span>
11005 <span class="comment">     * Probe arguments</span>
11006 <span class="comment">     */</span>
11007     <span class="keywordflow">try</span> {
11008         <a class="code" href="../../d5/d8/ex_8h.html#a54">ProbeAndWriteStructure</a>((PRECT)lParam, rc, RECT);
11009     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
11010         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
11011     }
11012 
11013     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnOUTLPRECT"</span>);
11014     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
11015 }
11016 
<a name="l11017"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a355">11017</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(INLPCOMPAREITEMSTRUCT)
11018 {
11019     COMPAREITEMSTRUCT compareitemstruct;
11020 
11021     <span class="comment">//</span>
11022     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
11023     <span class="comment">//      enabled. These operations are performed in the User server API</span>
11024     <span class="comment">//      dispatcher.</span>
11025     <span class="comment">//</span>
11026 
11027     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
11028     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnINLPCOMPAREITEMSTRUCT"</span>);
11029 
11030     UNREFERENCED_PARAMETER(bAnsi);
11031 
11032     <span class="comment">/*</span>
11033 <span class="comment">     * Probe arguments</span>
11034 <span class="comment">     */</span>
11035     <span class="keywordflow">try</span> {
11036         compareitemstruct = <a class="code" href="../../d4/d1/userk_8h.html#a44">ProbeAndReadCompareItemStruct</a>((PCOMPAREITEMSTRUCT)lParam);
11037     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
11038         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
11039     }
11040 
11041     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
11042             pwnd,
11043             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
11044             wParam,
11045             (LPARAM)&amp;compareitemstruct,
11046             xParam);
11047 
11048     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnINLPCOMPAREITEMSTRUCT"</span>);
11049     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
11050 }
11051 
<a name="l11052"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a356">11052</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(INLPDELETEITEMSTRUCT)
11053 {
11054     DELETEITEMSTRUCT deleteitemstruct;
11055 
11056     <span class="comment">//</span>
11057     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
11058     <span class="comment">//      enabled. These operations are performed in the User server API</span>
11059     <span class="comment">//      dispatcher.</span>
11060     <span class="comment">//</span>
11061 
11062     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
11063     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnINLPDELETEITEMSTRUCT"</span>);
11064 
11065     UNREFERENCED_PARAMETER(bAnsi);
11066 
11067     <span class="comment">/*</span>
11068 <span class="comment">     * Probe arguments</span>
11069 <span class="comment">     */</span>
11070     <span class="keywordflow">try</span> {
11071         deleteitemstruct = <a class="code" href="../../d4/d1/userk_8h.html#a45">ProbeAndReadDeleteItemStruct</a>((PDELETEITEMSTRUCT)lParam);
11072     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
11073         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
11074     }
11075 
11076     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
11077             pwnd,
11078             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
11079             wParam,
11080             (LPARAM)&amp;deleteitemstruct,
11081             xParam);
11082 
11083     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnINLPDELETEITEMSTRUCT"</span>);
11084     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
11085 }
11086 
<a name="l11087"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a357">11087</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(INLPHLPSTRUCT)
11088 {
11089     HLP hlp;
11090     LPHLP phlp = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
11091     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlBuffer;
11092 
11093     <span class="comment">//</span>
11094     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
11095     <span class="comment">//      enabled. These operations are performed in the User server API</span>
11096     <span class="comment">//      dispatcher.</span>
11097     <span class="comment">//</span>
11098 
11099     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
11100     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnINLPHLPSTRUCT"</span>);
11101 
11102     UNREFERENCED_PARAMETER(bAnsi);
11103 
11104     <span class="comment">/*</span>
11105 <span class="comment">     * Probe arguments</span>
11106 <span class="comment">     */</span>
11107     <span class="keywordflow">try</span> {
11108         hlp = <a class="code" href="../../d4/d1/userk_8h.html#a46">ProbeAndReadHelp</a>((LPHLP)lParam);
11109         <span class="keywordflow">if</span> (hlp.cbData &lt; <span class="keyword">sizeof</span>(HLP)) {
11110             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
11111         }
11112         phlp = UserAllocPoolWithQuota(hlp.cbData, TAG_SYSTEM);
11113         <span class="keywordflow">if</span> (phlp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
11114             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_NO_MEMORY);
11115         }
11116         <a class="code" href="../../d4/d1/userk_8h.html#a137">ThreadLockPool</a>(ptiCurrent, phlp, &amp;tlBuffer);
11117         RtlCopyMemory(phlp, (PVOID)lParam, hlp.cbData);
11118     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
11119         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
11120     }
11121 
11122     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
11123             pwnd,
11124             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
11125             wParam,
11126             (LPARAM)phlp,
11127             xParam);
11128 
11129     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a33">CLEANUPRECV</a>();
11130     <span class="keywordflow">if</span> (phlp) {
11131         <a class="code" href="../../d4/d1/userk_8h.html#a139">ThreadUnlockAndFreePool</a>(ptiCurrent, &amp;tlBuffer);
11132     }
11133 
11134     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnINLPHLPSTRUCT"</span>);
11135     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
11136 }
11137 
<a name="l11138"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a358">11138</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(INLPHELPINFOSTRUCT)
11139 {
11140     HELPINFO helpinfo;
11141 
11142     <span class="comment">//</span>
11143     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
11144     <span class="comment">//      enabled. These operations are performed in the User server API</span>
11145     <span class="comment">//      dispatcher.</span>
11146     <span class="comment">//</span>
11147 
11148     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
11149     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnINLPHELPINFOSTRUCT"</span>);
11150 
11151     UNREFERENCED_PARAMETER(bAnsi);
11152 
11153     <span class="comment">/*</span>
11154 <span class="comment">     * Probe arguments</span>
11155 <span class="comment">     */</span>
11156     <span class="keywordflow">try</span> {
11157         helpinfo = <a class="code" href="../../d4/d1/userk_8h.html#a47">ProbeAndReadHelpInfo</a>((LPHELPINFO)lParam);
11158         <span class="keywordflow">if</span> (helpinfo.cbSize != <span class="keyword">sizeof</span>(HELPINFO)) {
11159             RIPMSG1(RIP_WARNING, <span class="stringliteral">"HELPINFO.cbSize %d is wrong"</span>, helpinfo.cbSize);
11160             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(ERROR_INVALID_PARAMETER);
11161         }
11162     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
11163         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
11164     }
11165 
11166     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
11167             pwnd,
11168             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
11169             wParam,
11170             (LPARAM)&amp;helpinfo,
11171             xParam);
11172 
11173     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnINLPHELPINFOSTRUCT"</span>);
11174     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
11175 }
11176 
<a name="l11177"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a359">11177</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(INLPDRAWITEMSTRUCT)
11178 {
11179     DRAWITEMSTRUCT drawitemstruct;
11180 
11181     <span class="comment">//</span>
11182     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
11183     <span class="comment">//      enabled. These operations are performed in the User server API</span>
11184     <span class="comment">//      dispatcher.</span>
11185     <span class="comment">//</span>
11186 
11187     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
11188     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnINLPDRAWITEMSTRUCT"</span>);
11189 
11190     UNREFERENCED_PARAMETER(bAnsi);
11191 
11192     <span class="comment">/*</span>
11193 <span class="comment">     * Probe arguments</span>
11194 <span class="comment">     */</span>
11195     <span class="keywordflow">try</span> {
11196         drawitemstruct = <a class="code" href="../../d4/d1/userk_8h.html#a48">ProbeAndReadDrawItemStruct</a>((PDRAWITEMSTRUCT)lParam);
11197     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
11198         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
11199     }
11200 
11201     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
11202             pwnd,
11203             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
11204             wParam,
11205             (LPARAM)&amp;drawitemstruct,
11206             xParam);
11207 
11208     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnINLPDRAWITEMSTRUCT"</span>);
11209     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
11210 }
11211 
<a name="l11212"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a360">11212</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(INOUTLPMEASUREITEMSTRUCT)
11213 {
11214     MEASUREITEMSTRUCT measureitemstruct;
11215 
11216     <span class="comment">//</span>
11217     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
11218     <span class="comment">//      enabled. These operations are performed in the User server API</span>
11219     <span class="comment">//      dispatcher.</span>
11220     <span class="comment">//</span>
11221 
11222     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
11223     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnINOUTLPMEASUREITEMSTRUCT"</span>);
11224 
11225     UNREFERENCED_PARAMETER(bAnsi);
11226 
11227     <span class="comment">/*</span>
11228 <span class="comment">     * Probe arguments</span>
11229 <span class="comment">     */</span>
11230     <span class="keywordflow">try</span> {
11231         <a class="code" href="../../d4/d1/userk_8h.html#a74">ProbeForWriteMeasureItemStruct</a>((PMEASUREITEMSTRUCT)lParam);
11232         measureitemstruct = *(PMEASUREITEMSTRUCT)lParam;
11233     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
11234         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
11235     }
11236 
11237     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
11238                 pwnd,
11239                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
11240                 wParam,
11241                 (LPARAM)&amp;measureitemstruct,
11242                 xParam);
11243 
11244     <span class="keywordflow">try</span> {
11245         *(PMEASUREITEMSTRUCT)lParam = measureitemstruct;
11246     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
11247     }
11248 
11249     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnINOUTLPMEASUREITEMSTRUCT"</span>);
11250     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
11251 }
11252 
<a name="l11253"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a361">11253</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(OUTSTRING)
11254 {
11255     <a class="code" href="../../d1/d9/struct__LARGE__STRING.html">LARGE_STRING</a> str;
11256 
11257     <span class="comment">//</span>
11258     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
11259     <span class="comment">//      enabled. These operations are performed in the User server API</span>
11260     <span class="comment">//      dispatcher.</span>
11261     <span class="comment">//</span>
11262 
11263     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
11264     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnOUTSTRING"</span>);
11265 
11266     <span class="comment">/*</span>
11267 <span class="comment">     * Probe all arguments</span>
11268 <span class="comment">     */</span>
11269     <span class="keywordflow">try</span> {
11270         str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o2">bAnsi</a> = bAnsi;
11271         str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o1">MaximumLength</a> = (ULONG)wParam;
11272         <span class="keywordflow">if</span> (!bAnsi) {
11273             str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o1">MaximumLength</a> *= <span class="keyword">sizeof</span>(WCHAR);
11274         }
11275         str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o0">Length</a> = 0;
11276         str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a> = (PVOID)lParam;
11277 <span class="preprocessor">#if defined(_X86_)</span>
11278 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>((PVOID)str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>, str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o1">MaximumLength</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
11279 <span class="preprocessor">#else</span>
11280 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>((PVOID)str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>, str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o1">MaximumLength</a>,
11281                 str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o2">bAnsi</a> ? <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>) : <span class="keyword">sizeof</span>(WORD));
11282 <span class="preprocessor">#endif</span>
11283 <span class="preprocessor"></span>    } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
11284         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
11285     }
11286 
11287     <span class="comment">/*</span>
11288 <span class="comment">     * !!! String buffer must be created in xxxInterSendMsgEx and</span>
11289 <span class="comment">     *     lParam probed for write again upon return.</span>
11290 <span class="comment">     */</span>
11291     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
11292             pwnd,
11293             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
11294             wParam,
11295             (LPARAM)&amp;str,
11296             xParam);
11297 
11298     <span class="comment">/*</span>
11299 <span class="comment">     * A dialog function returning FALSE means no text to copy out,</span>
11300 <span class="comment">     * but an empty string also has retval == 0: put a null char in</span>
11301 <span class="comment">     * pstr for the latter case.</span>
11302 <span class="comment">     */</span>
11303     <span class="keywordflow">if</span> (!retval &amp;&amp; wParam != 0) {
11304         <span class="keywordflow">try</span> {
11305             <a class="code" href="../../d1/d0/inc_2user_8h.html#a1133">NullTerminateString</a>((PVOID)lParam, bAnsi);
11306         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
11307             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
11308         }
11309     }
11310 
11311     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnOUTSTRING"</span>);
11312     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
11313 }
11314 
<a name="l11315"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a362">11315</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(OUTDWORDINDWORD)
11316 {
11317     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dw;
11318 
11319     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
11320     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnOUTDWORDINDWORD"</span>);
11321 
11322     UNREFERENCED_PARAMETER(bAnsi);
11323 
11324     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
11325             pwnd,
11326             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
11327             (WPARAM)&amp;dw,
11328             lParam,
11329             xParam);
11330 
11331     <span class="comment">/*</span>
11332 <span class="comment">     * Probe wParam</span>
11333 <span class="comment">     */</span>
11334     <span class="keywordflow">try</span> {
11335         <a class="code" href="../../d5/d8/ex_8h.html#a51">ProbeAndWriteUlong</a>((PULONG)wParam, dw);
11336     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
11337         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
11338     }
11339 
11340     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnOUTDWORDINDWORD"</span>);
11341     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
11342 }
11343 
<a name="l11344"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a363">11344</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(INCNTOUTSTRING)
11345 {
11346     <a class="code" href="../../d1/d9/struct__LARGE__STRING.html">LARGE_STRING</a> str;
11347 
11348     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
11349     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnINCNTOUTSTRING"</span>);
11350 
11351     <span class="comment">/*</span>
11352 <span class="comment">     * Probe arguments</span>
11353 <span class="comment">     */</span>
11354     <span class="keywordflow">try</span> {
11355         str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o2">bAnsi</a> = bAnsi;
11356         str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o1">MaximumLength</a> = <a class="code" href="../../d5/d8/ex_8h.html#a16">ProbeAndReadUshort</a>((LPWORD)lParam);
11357         <span class="keywordflow">if</span> (str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o1">MaximumLength</a> == 0) {
11358             RIPMSG0(RIP_WARNING, <span class="stringliteral">"fnINCNTOUTSTRING asking for 0 characters back\n"</span>);
11359             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
11360         }
11361         <span class="keywordflow">if</span> (!bAnsi) {
11362             str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o1">MaximumLength</a> *= <span class="keyword">sizeof</span>(WCHAR);
11363         }
11364         str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o0">Length</a> = 0;
11365         str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a> = (LPBYTE)lParam;
11366 <span class="preprocessor">#if defined(_X86_)</span>
11367 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>((PVOID)str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>, str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o1">MaximumLength</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
11368 <span class="preprocessor">#else</span>
11369 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>((PVOID)str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>, str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o1">MaximumLength</a>,
11370                 str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o2">bAnsi</a> ? <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>) : <span class="keyword">sizeof</span>(WORD));
11371 <span class="preprocessor">#endif</span>
11372 <span class="preprocessor"></span>    } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
11373         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
11374     }
11375 
11376     <span class="comment">/*</span>
11377 <span class="comment">     * !!! String buffer must be created in xxxInterSendMsgEx and</span>
11378 <span class="comment">     *     lParam probed for write again upon return.</span>
11379 <span class="comment">     */</span>
11380     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
11381             pwnd,
11382             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
11383             wParam,
11384             (LPARAM)&amp;str,
11385             xParam);
11386 
11387     <span class="comment">/*</span>
11388 <span class="comment">     * A dialog function returning FALSE means no text to copy out,</span>
11389 <span class="comment">     * but an empty string also has retval == 0: put a null char in</span>
11390 <span class="comment">     * pstr for the latter case.</span>
11391 <span class="comment">     */</span>
11392     <span class="keywordflow">if</span> (!retval) {
11393         <span class="keywordflow">try</span> {
11394             <a class="code" href="../../d1/d0/inc_2user_8h.html#a1133">NullTerminateString</a>((PVOID)lParam, bAnsi);
11395         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
11396             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
11397         }
11398     }
11399 
11400     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnINCNTOUTSTRING"</span>);
11401     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
11402 }
11403 
11404 <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(INCNTOUTSTRINGNULL)
11405 {
11406     <a class="code" href="../../d1/d9/struct__LARGE__STRING.html">LARGE_STRING</a> str;
11407 
11408     <span class="comment">//</span>
11409     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
11410     <span class="comment">//      enabled. These operations are performed in the User server API</span>
11411     <span class="comment">//      dispatcher.</span>
11412     <span class="comment">//</span>
11413 
11414     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
11415     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnINCNTOUTSTRINGNULL"</span>);
11416 
11417     <span class="comment">/*</span>
11418 <span class="comment">     * Probe arguments</span>
11419 <span class="comment">     */</span>
11420     <span class="keywordflow">try</span> {
11421         <span class="keywordflow">if</span> (wParam &lt; 2) {       <span class="comment">// This prevents a possible GP</span>
11422             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
11423         }
11424 
11425         str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o2">bAnsi</a> = bAnsi;
11426         str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o1">MaximumLength</a> = (ULONG)wParam;
11427         <span class="keywordflow">if</span> (!bAnsi) {
11428             str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o1">MaximumLength</a> *= <span class="keyword">sizeof</span>(WCHAR);
11429         }
11430         str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o0">Length</a> = 0;
11431         str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a> = (LPBYTE)lParam;
11432 <span class="preprocessor">#if defined(_X86_)</span>
11433 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>((PVOID)str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>, str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o1">MaximumLength</a>, <span class="keyword">sizeof</span>(BYTE));
11434 <span class="preprocessor">#else</span>
11435 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>((PVOID)str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>, str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o1">MaximumLength</a>,
11436                 str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o2">bAnsi</a> ? <span class="keyword">sizeof</span>(BYTE) : <span class="keyword">sizeof</span>(WORD));
11437 <span class="preprocessor">#endif</span>
11438 <span class="preprocessor"></span>        *((LPWSTR)str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>) = 0;    <span class="comment">// mark incase message is not handled</span>
11439     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(FALSE)) {
11440         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
11441     }
11442 
11443     <span class="comment">/*</span>
11444 <span class="comment">     * !!! String buffer must be created in xxxInterSendMsgEx and</span>
11445 <span class="comment">     *     lParam probed for write again upon return.</span>
11446 <span class="comment">     */</span>
11447     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
11448             pwnd,
11449             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
11450             wParam,
11451             (LPARAM)&amp;str,
11452             xParam);
11453 
11454     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnINCNTOUTSTRINGNULL"</span>);
11455     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
11456 }
11457 
<a name="l11458"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a364">11458</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(POUTLPINT)
11459 {
11460 
11461     <span class="comment">//</span>
11462     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
11463     <span class="comment">//      enabled. These operations are performed in the User server API</span>
11464     <span class="comment">//      dispatcher.</span>
11465     <span class="comment">//</span>
11466 
11467     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(LB_ERR);
11468     <span class="comment">/*</span>
11469 <span class="comment">     * If we use this for other messages, then that return value might not be appropriate.</span>
11470 <span class="comment">     */</span>
11471     UserAssert(<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> == LB_GETSELITEMS);
11472     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnPOUTLPINT"</span>);
11473 
11474     UNREFERENCED_PARAMETER(bAnsi);
11475 
11476     <span class="comment">/*</span>
11477 <span class="comment">     * Probe arguments</span>
11478 <span class="comment">     */</span>
11479     <span class="keywordflow">try</span> {
11480 <span class="preprocessor">#if defined(_X86_)</span>
11481 <span class="preprocessor"></span>        <a class="code" href="../../d4/d1/userk_8h.html#a25">ProbeForWriteBuffer</a>((LPINT)lParam, wParam, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
11482 <span class="preprocessor">#else</span>
11483 <span class="preprocessor"></span>        <a class="code" href="../../d4/d1/userk_8h.html#a25">ProbeForWriteBuffer</a>((LPINT)lParam, wParam, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>));
11484 <span class="preprocessor">#endif</span>
11485 <span class="preprocessor"></span>    } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
11486         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
11487     }
11488 
11489     <span class="comment">/*</span>
11490 <span class="comment">     * !!! Buffer must be created in xxxInterSendMsgEx and</span>
11491 <span class="comment">     *     lParam probed for write again upon return.</span>
11492 <span class="comment">     */</span>
11493     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
11494             pwnd,
11495             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
11496             wParam,
11497             lParam,
11498             xParam);
11499 
11500     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnPOUTLPINT"</span>);
11501     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
11502 }
11503 
<a name="l11504"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a365">11504</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(POPTINLPUINT)
11505 {
11506 
11507     <span class="comment">//</span>
11508     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
11509     <span class="comment">//      enabled. These operations are performed in the User server API</span>
11510     <span class="comment">//      dispatcher.</span>
11511     <span class="comment">//</span>
11512 
11513     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
11514     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnPOPTINLPUINT"</span>);
11515 
11516     UNREFERENCED_PARAMETER(bAnsi);
11517 
11518     <span class="comment">/*</span>
11519 <span class="comment">     * Probe arguments</span>
11520 <span class="comment">     */</span>
11521     <span class="keywordflow">try</span> {
11522 <span class="preprocessor">#if defined(_X86_)</span>
11523 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (lParam)
11524             <a class="code" href="../../d4/d1/userk_8h.html#a24">ProbeForReadBuffer</a>((LPUINT)lParam, wParam, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
11525 <span class="preprocessor">#else</span>
11526 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (lParam)
11527             <a class="code" href="../../d4/d1/userk_8h.html#a24">ProbeForReadBuffer</a>((LPUINT)lParam, wParam, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
11528 <span class="preprocessor">#endif</span>
11529 <span class="preprocessor"></span>    } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
11530         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
11531     }
11532 
11533     <span class="comment">/*</span>
11534 <span class="comment">     * !!! Data pointed to by lParam must be captured in xxxInterSendMsgEx</span>
11535 <span class="comment">     */</span>
11536     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
11537             pwnd,
11538             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
11539             wParam,
11540             lParam,
11541             xParam);
11542 
11543     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnPOPTINLPUINT"</span>);
11544     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
11545 }
11546 
<a name="l11547"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a366">11547</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(INOUTLPWINDOWPOS)
11548 {
11549     WINDOWPOS pos;
11550 
11551     <span class="comment">//</span>
11552     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
11553     <span class="comment">//      enabled. These operations are performed in the User server API</span>
11554     <span class="comment">//      dispatcher.</span>
11555     <span class="comment">//</span>
11556 
11557     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
11558     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnINOUTLPWINDOWPOS"</span>);
11559 
11560     UNREFERENCED_PARAMETER(bAnsi);
11561 
11562     <span class="comment">/*</span>
11563 <span class="comment">     * Probe arguments</span>
11564 <span class="comment">     */</span>
11565     <span class="keywordflow">try</span> {
11566         <a class="code" href="../../d4/d1/userk_8h.html#a82">ProbeForWriteWindowPos</a>((PWINDOWPOS)lParam);
11567         pos = *(PWINDOWPOS)lParam;
11568     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
11569         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
11570     }
11571 
11572     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
11573                 pwnd,
11574                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
11575                 wParam,
11576                 (LPARAM)&amp;pos,
11577                 xParam);
11578 
11579     <span class="keywordflow">try</span> {
11580         *(PWINDOWPOS)lParam = pos;
11581     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
11582     }
11583 
11584     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnINOUTLPWINDOWPOS"</span>);
11585     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
11586 }
11587 
<a name="l11588"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a367">11588</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(INLPWINDOWPOS)
11589 {
11590     WINDOWPOS pos;
11591 
11592     <span class="comment">//</span>
11593     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
11594     <span class="comment">//      enabled. These operations are performed in the User server API</span>
11595     <span class="comment">//      dispatcher.</span>
11596     <span class="comment">//</span>
11597 
11598     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
11599     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnINLPWINDOWPOS"</span>);
11600 
11601     UNREFERENCED_PARAMETER(bAnsi);
11602 
11603     <span class="comment">/*</span>
11604 <span class="comment">     * Probe arguments</span>
11605 <span class="comment">     */</span>
11606     <span class="keywordflow">try</span> {
11607         pos = <a class="code" href="../../d4/d1/userk_8h.html#a56">ProbeAndReadWindowPos</a>((PWINDOWPOS)lParam);
11608     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
11609         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
11610     }
11611 
11612     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
11613                 pwnd,
11614                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
11615                 wParam,
11616                 (LPARAM)&amp;pos,
11617                 xParam);
11618 
11619     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnINLPWINDOWPOS"</span>);
11620     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
11621 }
11622 
<a name="l11623"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a368">11623</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(INLBOXSTRING)
11624 {
11625     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(LB_ERR);
11626     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnINLBOXSTRING"</span>);
11627 
11628     <span class="keywordflow">if</span> (!(pwnd-&gt;style &amp; LBS_HASSTRINGS) &amp;&amp;
11629             (pwnd-&gt;style &amp; (LBS_OWNERDRAWFIXED | LBS_OWNERDRAWVARIABLE))) {
11630         retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
11631                 pwnd,
11632                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
11633                 wParam,
11634                 lParam,
11635                 xParam);
11636     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> == LB_FINDSTRING) {
11637         retval = NtUserfnINSTRINGNULL(
11638                 pwnd,
11639                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
11640                 wParam,
11641                 lParam,
11642                 xParam,
11643                 xpfnProc,
11644                 bAnsi);
11645     } <span class="keywordflow">else</span> {
11646         retval = NtUserfnINSTRING(
11647                 pwnd,
11648                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
11649                 wParam,
11650                 lParam,
11651                 xParam,
11652                 xpfnProc,
11653                 bAnsi);
11654     }
11655 
11656     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnINLBOXSTRING"</span>);
11657     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
11658 }
11659 
<a name="l11660"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a369">11660</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(OUTLBOXSTRING)
11661 {
11662     <a class="code" href="../../d1/d9/struct__LARGE__STRING.html">LARGE_STRING</a> str;
11663 
11664     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(LB_ERR);
11665     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnOUTLBOXSTRING"</span>);
11666 
11667     <span class="comment">/*</span>
11668 <span class="comment">     * Need to get the string length ahead of time. This isn't passed in</span>
11669 <span class="comment">     * with this message. Code assumes app already knows the size of</span>
11670 <span class="comment">     * the string and has passed a pointer to a buffer of adequate size.</span>
11671 <span class="comment">     * To do client/server copying of this string, we need to ahead of</span>
11672 <span class="comment">     * time the Unicode size of this string. We add one character because</span>
11673 <span class="comment">     * GETTEXTLEN excludes the null terminator.</span>
11674 <span class="comment">     */</span>
11675     retval = NtUserfnGETDBCSTEXTLENGTHS(
11676             pwnd,
11677             LB_GETTEXTLEN,
11678             wParam,
11679             lParam,
11680             xParam,
11681             xpfnProc,
11682             <span class="comment">/*IS_DBCS_ENABLED() &amp;&amp;*/</span> bAnsi);   <span class="comment">// HiroYama: LATER</span>
11683     <span class="keywordflow">if</span> (retval == LB_ERR)
11684         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
11685     retval++;
11686 
11687     <span class="comment">/*</span>
11688 <span class="comment">     * Probe all arguments</span>
11689 <span class="comment">     */</span>
11690     <span class="keywordflow">try</span> {
11691         str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o2">bAnsi</a> = bAnsi;
11692         <span class="keywordflow">if</span> (bAnsi)
11693             str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o1">MaximumLength</a> = (ULONG)retval;
11694         <span class="keywordflow">else</span>
11695             str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o1">MaximumLength</a> = (ULONG)retval * <span class="keyword">sizeof</span>(WCHAR);
11696         str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o0">Length</a> = 0;
11697         str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a> = (PVOID)lParam;
11698 <span class="preprocessor">#if defined(_X86_)</span>
11699 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>((PVOID)str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>, str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o1">MaximumLength</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
11700 <span class="preprocessor">#else</span>
11701 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>((PVOID)str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>, str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o1">MaximumLength</a>,
11702                 str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o2">bAnsi</a> ? <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>) : <span class="keyword">sizeof</span>(WORD));
11703 <span class="preprocessor">#endif</span>
11704 <span class="preprocessor"></span>    } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
11705           <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
11706     }
11707 
11708     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
11709             pwnd,
11710             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
11711             wParam,
11712             (LPARAM)&amp;str,
11713             xParam);
11714 
11715     <span class="comment">/*</span>
11716 <span class="comment">     * If the control is ownerdraw and does not have the LBS_HASSTRINGS</span>
11717 <span class="comment">     * style, then a 32-bits of application data has been obtained,</span>
11718 <span class="comment">     * not a string.</span>
11719 <span class="comment">     */</span>
11720     <span class="keywordflow">if</span> (!(pwnd-&gt;style &amp; LBS_HASSTRINGS) &amp;&amp;
11721             (pwnd-&gt;style &amp; (LBS_OWNERDRAWFIXED | LBS_OWNERDRAWVARIABLE))) {
11722         <span class="keywordflow">if</span> (bAnsi) {
11723             retval = <span class="keyword">sizeof</span>(ULONG_PTR)/<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>);     <span class="comment">// 4 CHARs just like win3.1</span>
11724         } <span class="keywordflow">else</span> {
11725             retval = <span class="keyword">sizeof</span>(ULONG_PTR)/<span class="keyword">sizeof</span>(WCHAR);    <span class="comment">// 2 WCHARs</span>
11726         }
11727     }
11728 
11729     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnOUTLBOXSTRING"</span>);
11730     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
11731 }
11732 
<a name="l11733"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a370">11733</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(INCBOXSTRING)
11734 {
11735     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(CB_ERR);
11736     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnINCBOXSTRING"</span>);
11737 
11738     <span class="keywordflow">if</span> (!(pwnd-&gt;style &amp; CBS_HASSTRINGS) &amp;&amp;
11739             (pwnd-&gt;style &amp; (CBS_OWNERDRAWFIXED | CBS_OWNERDRAWVARIABLE))) {
11740         retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
11741                 pwnd,
11742                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
11743                 wParam,
11744                 lParam,
11745                 xParam);
11746     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> == CB_FINDSTRING) {
11747         retval =  NtUserfnINSTRINGNULL(
11748                 pwnd,
11749                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
11750                 wParam,
11751                 lParam,
11752                 xParam,
11753                 xpfnProc,
11754                 bAnsi);
11755     } <span class="keywordflow">else</span> {
11756         retval = NtUserfnINSTRING(
11757                 pwnd,
11758                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
11759                 wParam,
11760                 lParam,
11761                 xParam,
11762                 xpfnProc,
11763                 bAnsi);
11764     }
11765 
11766     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnINCBOXSTRING"</span>);
11767     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
11768 }
11769 
<a name="l11770"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a371">11770</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(OUTCBOXSTRING)
11771 {
11772     <a class="code" href="../../d1/d9/struct__LARGE__STRING.html">LARGE_STRING</a> str;
11773 
11774     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(CB_ERR);
11775     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnOUTCBOXSTRING"</span>);
11776 
11777     <span class="comment">/*</span>
11778 <span class="comment">     * Need to get the string length ahead of time. This isn't passed in</span>
11779 <span class="comment">     * with this message. Code assumes app already knows the size of</span>
11780 <span class="comment">     * the string and has passed a pointer to a buffer of adequate size.</span>
11781 <span class="comment">     * To do client/server copying of this string, we need to ahead of</span>
11782 <span class="comment">     * time the size of this string. We add one character because</span>
11783 <span class="comment">     * GETTEXTLEN excludes the null terminator.</span>
11784 <span class="comment">     */</span>
11785     retval = NtUserfnGETDBCSTEXTLENGTHS(
11786             pwnd,
11787             CB_GETLBTEXTLEN,
11788             wParam,
11789             lParam,
11790             xParam,
11791             xpfnProc,
11792             <span class="comment">/*IS_DBCS_ENABLED() &amp;&amp;*/</span> bAnsi);   <span class="comment">// HiroYama: LATER</span>
11793     <span class="keywordflow">if</span> (retval == CB_ERR)
11794         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
11795     retval++;
11796 
11797     <span class="comment">/*</span>
11798 <span class="comment">     * Probe all arguments</span>
11799 <span class="comment">     */</span>
11800     <span class="keywordflow">try</span> {
11801         str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o2">bAnsi</a> = bAnsi;
11802         <span class="keywordflow">if</span> (bAnsi)
11803             str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o1">MaximumLength</a> = (ULONG)retval;
11804         <span class="keywordflow">else</span>
11805             str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o1">MaximumLength</a> = (ULONG)retval * <span class="keyword">sizeof</span>(WCHAR);
11806         str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o0">Length</a> = 0;
11807         str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a> = (PVOID)lParam;
11808 <span class="preprocessor">#if defined(_X86_)</span>
11809 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>((PVOID)str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>, str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o1">MaximumLength</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
11810 <span class="preprocessor">#else</span>
11811 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>((PVOID)str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>, str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o1">MaximumLength</a>,
11812                 str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o2">bAnsi</a> ? <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>) : <span class="keyword">sizeof</span>(WORD));
11813 <span class="preprocessor">#endif</span>
11814 <span class="preprocessor"></span>    } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
11815           <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
11816     }
11817 
11818     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
11819             pwnd,
11820             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
11821             wParam,
11822             (LPARAM)&amp;str,
11823             xParam);
11824 
11825     <span class="comment">/*</span>
11826 <span class="comment">     * If the control is ownerdraw and does not have the CBS_HASSTRINGS</span>
11827 <span class="comment">     * style, then a 32-bits of application data has been obtained,</span>
11828 <span class="comment">     * not a string.</span>
11829 <span class="comment">     */</span>
11830     <span class="keywordflow">if</span> (!(pwnd-&gt;style &amp; CBS_HASSTRINGS) &amp;&amp;
11831             (pwnd-&gt;style &amp; (CBS_OWNERDRAWFIXED | CBS_OWNERDRAWVARIABLE))) {
11832         <span class="keywordflow">if</span> (bAnsi) {
11833             retval = <span class="keyword">sizeof</span>(ULONG_PTR)/<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>);     <span class="comment">// 4 CHARs just like win3.1</span>
11834         } <span class="keywordflow">else</span> {
11835             retval = <span class="keyword">sizeof</span>(ULONG_PTR)/<span class="keyword">sizeof</span>(WCHAR);    <span class="comment">// 2 WCHARs</span>
11836         }
11837     }
11838 
11839     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnOUTCBOXSTRING"</span>);
11840     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
11841 }
11842 
<a name="l11843"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a372">11843</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(INWPARAMCHAR)
11844 {
11845     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
11846     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnINWPARAMCHAR"</span>);
11847 
11848     <span class="comment">/*</span>
11849 <span class="comment">     * The server always expects the characters to be unicode so</span>
11850 <span class="comment">     * if this was generated from an ANSI routine convert it to Unicode</span>
11851 <span class="comment">     */</span>
11852     <span class="keywordflow">if</span> (bAnsi) {
11853         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> == WM_CHARTOITEM || <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> == WM_MENUCHAR) {
11854             WPARAM dwT = wParam &amp; 0xFFFF;                <span class="comment">// mask of caret pos</span>
11855             <a class="code" href="../../d5/d6/chartran_8c.html#a5">RtlMBMessageWParamCharToWCS</a>(<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, &amp;dwT);     <span class="comment">// convert key portion</span>
11856             wParam = MAKELONG(LOWORD(dwT),HIWORD(wParam));  <span class="comment">// rebuild pos &amp; key wParam</span>
11857         } <span class="keywordflow">else</span> {
11858             <a class="code" href="../../d5/d6/chartran_8c.html#a5">RtlMBMessageWParamCharToWCS</a>(<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, &amp;wParam);
11859         }
11860     }
11861 
11862     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
11863             pwnd,
11864             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
11865             wParam,
11866             lParam,
11867             xParam);
11868 
11869     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnINWPARAMCHAR"</span>);
11870     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
11871 }
11872 
<a name="l11873"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a373">11873</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(KERNELONLY)
11874 {
11875     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
11876     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnKERNELONLY"</span>);
11877 
11878     UNREFERENCED_PARAMETER(pwnd);
11879     UNREFERENCED_PARAMETER(<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>);
11880     UNREFERENCED_PARAMETER(wParam);
11881     UNREFERENCED_PARAMETER(lParam);
11882     UNREFERENCED_PARAMETER(xParam);
11883     UNREFERENCED_PARAMETER(xpfnProc);
11884     UNREFERENCED_PARAMETER(bAnsi);
11885 
11886     RIPMSG0(RIP_WARNING,
11887             <span class="stringliteral">"Message sent from client to kernel for a process which has only kernel side\n"</span> );
11888 
11889     retval = 0;
11890 
11891     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnKERNELONLY"</span>);
11892     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
11893 }
11894 
<a name="l11895"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a374">11895</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(IMECONTROL)
11896 {
11897     CANDIDATEFORM   CandForm;
11898     COMPOSITIONFORM CompForm;
11899     LOGFONTW        LogFontW;
11900     LPARAM          lData = lParam;
11901     PSOFTKBDDATA    pSoftKbdData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
11902 
11903     <span class="comment">//</span>
11904     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
11905     <span class="comment">//      enabled. These operations are performed in the User server API</span>
11906     <span class="comment">//      dispatcher.</span>
11907     <span class="comment">//</span>
11908 
11909     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
11910     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnIMECONTROL"</span>);
11911 
11912     UNREFERENCED_PARAMETER(bAnsi);
11913 
11914     <span class="comment">/*</span>
11915 <span class="comment">     * wParam range validation:</span>
11916 <span class="comment">     * No need to check lower limit, 'cause we assume IMC_FIRST == 0</span>
11917 <span class="comment">     * and wParam is unsigned.</span>
11918 <span class="comment">     */</span>
11919 <span class="preprocessor">    #if (IMC_FIRST != 0)</span>
11920 <span class="preprocessor"></span><span class="preprocessor">    #error IMC_FIRST: unexpected value</span>
11921 <span class="preprocessor"></span><span class="preprocessor">    #endif</span>
11922 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> != WM_IME_CONTROL || wParam &gt; IMC_LAST) {
11923         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
11924     }
11925 
11926     <span class="comment">/*</span>
11927 <span class="comment">     * Probe arguments</span>
11928 <span class="comment">     */</span>
11929     <span class="keywordflow">try</span> {
11930         <span class="keywordflow">switch</span> (wParam) {
11931         <span class="keywordflow">case</span> IMC_GETCANDIDATEPOS:
11932             <a class="code" href="../../d4/d1/userk_8h.html#a83">ProbeForWriteCandidateForm</a>((PCANDIDATEFORM)lParam);
11933             <span class="keywordflow">break</span>;
11934 
11935         <span class="keywordflow">case</span> IMC_GETCOMPOSITIONWINDOW:
11936             <a class="code" href="../../d4/d1/userk_8h.html#a84">ProbeForWriteCompositionForm</a>((PCOMPOSITIONFORM)lParam);
11937             <span class="keywordflow">break</span>;
11938 
11939         <span class="keywordflow">case</span> IMC_GETCOMPOSITIONFONT:
11940         <span class="keywordflow">case</span> IMC_GETSOFTKBDFONT:
11941             <a class="code" href="../../d4/d1/userk_8h.html#a85">ProbeForWriteLogFontW</a>((PLOGFONTW)lParam);
11942             <span class="keywordflow">break</span>;
11943 
11944         <span class="keywordflow">case</span> IMC_SETCANDIDATEPOS:
11945             CandForm = <a class="code" href="../../d4/d1/userk_8h.html#a64">ProbeAndReadCandidateForm</a>((PCANDIDATEFORM)lParam);
11946             lData = (LPARAM)&amp;CandForm;
11947             <span class="keywordflow">break</span>;
11948 
11949         <span class="keywordflow">case</span> IMC_SETCOMPOSITIONWINDOW:
11950             CompForm = <a class="code" href="../../d4/d1/userk_8h.html#a65">ProbeAndReadCompositionForm</a>((PCOMPOSITIONFORM)lParam);
11951             lData = (LPARAM)&amp;CompForm;
11952             <span class="keywordflow">break</span>;
11953 
11954         <span class="keywordflow">case</span> IMC_SETCOMPOSITIONFONT:
11955             LogFontW = <a class="code" href="../../d4/d1/userk_8h.html#a66">ProbeAndReadLogFontW</a>((PLOGFONTW)lParam);
11956             lData = (LPARAM)&amp;LogFontW;
11957             <span class="keywordflow">break</span>;
11958 
11959         <span class="keywordflow">case</span> IMC_SETSOFTKBDDATA:
11960             pSoftKbdData = <a class="code" href="../../d4/d1/userk_8h.html#a2058">ProbeAndCaptureSoftKbdData</a>((PSOFTKBDDATA)lParam);
11961             <span class="keywordflow">if</span> (pSoftKbdData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
11962                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
11963             lData = (LPARAM)pSoftKbdData;
11964             <span class="keywordflow">break</span>;
11965 
11966         <span class="keywordflow">default</span>:
11967             <span class="keywordflow">break</span>;
11968         }
11969 
11970     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
11971         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
11972     }
11973     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
11974                 pwnd,
11975                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
11976                 wParam,
11977                 lData,
11978                 xParam);
11979 
11980     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a33">CLEANUPRECV</a>();
11981     <span class="keywordflow">if</span> (pSoftKbdData != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
11982         UserFreePool(pSoftKbdData);
11983     }
11984 
11985     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnIMECONTROL"</span>);
11986     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
11987 }
11988 
11989 <span class="preprocessor">#ifdef LATER</span>
11990 <span class="preprocessor"></span><a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(IMEREQUEST)
11991 {
11992     LPARAM          lData = lParam;
11993 
11994     <span class="comment">//</span>
11995     <span class="comment">// N.B. This function has implicit window translation and thread locking</span>
11996     <span class="comment">//      enabled. These operations are performed in the User server API</span>
11997     <span class="comment">//      dispatcher.</span>
11998     <span class="comment">//</span>
11999 
12000     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
12001     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnIMEREQUEST"</span>);
12002 
12003     UNREFERENCED_PARAMETER(bAnsi);
12004 
12005 <span class="comment">//    RIPMSG0(RIP_ERROR, "MESSAGECALL(IMEREQUEST) called.\n");</span>
12006 
12007     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd) != <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()) {
12008         <span class="comment">/*</span>
12009 <span class="comment">         * Does not allow to send WM_IME_REQUEST to</span>
12010 <span class="comment">         * the different thread.</span>
12011 <span class="comment">         */</span>
12012         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(ERROR_WINDOW_OF_OTHER_THREAD);
12013     }
12014 
12015     <span class="comment">/*</span>
12016 <span class="comment">     * Probe arguments</span>
12017 <span class="comment">     */</span>
12018     <span class="keywordflow">try</span> {
12019         <span class="keywordflow">switch</span> (wParam) {
12020         <span class="keywordflow">case</span> IMR_COMPOSITIONWINDOW:
12021             <a class="code" href="../../d4/d1/userk_8h.html#a84">ProbeForWriteCompositionForm</a>((PCOMPOSITIONFORM)lParam);
12022             <span class="keywordflow">break</span>;
12023 
12024         <span class="keywordflow">case</span> IMR_CANDIDATEWINDOW:
12025             <a class="code" href="../../d4/d1/userk_8h.html#a83">ProbeForWriteCandidateForm</a>((PCANDIDATEFORM)lParam);
12026             <span class="keywordflow">break</span>;
12027 
12028         <span class="keywordflow">case</span> IMR_COMPOSITIONFONT:
12029             <a class="code" href="../../d4/d1/userk_8h.html#a85">ProbeForWriteLogFontW</a>((PLOGFONTW)lParam);
12030             <span class="keywordflow">break</span>;
12031 
12032         <span class="keywordflow">case</span> IMR_RECONVERTSTRING:
12033         <span class="keywordflow">case</span> IMR_DOCUMENTFEED:
12034             <span class="keywordflow">if</span> (lParam) {
12035                 <a class="code" href="../../d4/d1/userk_8h.html#a86">ProbeForWriteReconvertString</a>((LPRECONVERTSTRING)lParam);
12036             }
12037             <span class="keywordflow">break</span>;
12038 
12039         <span class="keywordflow">case</span> IMR_CONFIRMRECONVERTSTRING:
12040             <span class="comment">//ProbeAndCaptureReconvertString((LPRECONVERTSTRING)lParam);</span>
12041             <span class="comment">//ProbeForWriteReconvertString((LPRECONVERTSTRING)lParam);</span>
12042             <a class="code" href="../../d4/d1/userk_8h.html#a87">ProbeForReadReconvertString</a>((LPRECONVERTSTRING)lParam);
12043             <span class="keywordflow">break</span>;
12044 
12045         <span class="keywordflow">case</span> IMR_QUERYCHARPOSITION:
12046             <a class="code" href="../../d4/d1/userk_8h.html#a88">ProbeForWriteImeCharPosition</a>((LPPrivateIMECHARPOSITION)lParam);
12047             <span class="keywordflow">break</span>;
12048 
12049         <span class="keywordflow">default</span>:
12050             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
12051         }
12052 
12053     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(FALSE)) {
12054         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
12055     }
12056 
12057     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
12058                 pwnd,
12059                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
12060                 wParam,
12061                 lData,
12062                 xParam);
12063 
12064     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a33">CLEANUPRECV</a>();
12065 
12066     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnIMEREQUEST"</span>);
12067     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
12068 }
12069 <span class="preprocessor">#endif</span>
12070 <span class="preprocessor"></span>
12071 <span class="comment">/*</span>
12072 <span class="comment"> * Hook stubs</span>
12073 <span class="comment"> */</span>
12074 
<a name="l12075"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a375">12075</a> LRESULT <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a375">NtUserfnHkINLPCBTCREATESTRUCT</a>(
12076     IN UINT msg,
12077     IN WPARAM wParam,
12078     IN LPCBT_CREATEWND pcbt,
12079     IN BOOL bAnsi)
12080 {
12081     CBT_CREATEWND cbt;
12082     <a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html">CREATESTRUCTEX</a> csex;
12083     LPCREATESTRUCT lpcsSave;
12084 
12085     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a51">BEGINRECV_HOOKCALL</a>();
12086 
12087     <span class="comment">/*</span>
12088 <span class="comment">     * Probe arguments</span>
12089 <span class="comment">     */</span>
12090     <span class="keywordflow">try</span> {
12091         cbt = <a class="code" href="../../d4/d1/userk_8h.html#a54">ProbeAndReadCBTCreateStruct</a>(pcbt);
12092         <a class="code" href="../../d4/d1/userk_8h.html#a75">ProbeForWriteCreateStruct</a>(cbt.lpcs);
12093         lpcsSave = cbt.lpcs;
12094         csex.<a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html#o0">cs</a> = *cbt.lpcs;
12095         cbt.lpcs = (LPCREATESTRUCT)&amp;csex;
12096         <span class="keywordflow">if</span> (bAnsi) {
12097             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(csex.<a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html#o0">cs</a>.lpszName, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>), <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
12098             <a class="code" href="../../d5/d6/chartran_8c.html#a6">RtlInitLargeAnsiString</a>((<a class="code" href="../../d5/d8/struct__LARGE__ANSI__STRING.html">PLARGE_ANSI_STRING</a>)&amp;csex.<a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html#o1">strName</a>,
12099                     (LPSTR)csex.<a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html#o0">cs</a>.lpszName, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1);
12100             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(csex.<a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html#o0">cs</a>.lpszClass)) {
12101                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(csex.<a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html#o0">cs</a>.lpszClass, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>), <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
12102                 <a class="code" href="../../d5/d6/chartran_8c.html#a6">RtlInitLargeAnsiString</a>((<a class="code" href="../../d5/d8/struct__LARGE__ANSI__STRING.html">PLARGE_ANSI_STRING</a>)&amp;csex.<a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html#o2">strClass</a>,
12103                         (LPSTR)csex.<a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html#o0">cs</a>.lpszClass, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1);
12104             }
12105         } <span class="keywordflow">else</span> {
12106             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(csex.<a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html#o0">cs</a>.lpszName, <span class="keyword">sizeof</span>(WCHAR), <a class="code" href="../../d4/d1/userk_8h.html#a23">CHARALIGN</a>);
12107             <a class="code" href="../../d5/d6/chartran_8c.html#a7">RtlInitLargeUnicodeString</a>((<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html">PLARGE_UNICODE_STRING</a>)&amp;csex.<a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html#o1">strName</a>,
12108                     csex.<a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html#o0">cs</a>.lpszName, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1);
12109             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(csex.<a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html#o0">cs</a>.lpszClass)) {
12110                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(csex.<a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html#o0">cs</a>.lpszClass, <span class="keyword">sizeof</span>(WCHAR), <a class="code" href="../../d4/d1/userk_8h.html#a23">CHARALIGN</a>);
12111                 <a class="code" href="../../d5/d6/chartran_8c.html#a7">RtlInitLargeUnicodeString</a>((<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html">PLARGE_UNICODE_STRING</a>)&amp;csex.<a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html#o2">strClass</a>,
12112                         csex.<a class="code" href="../../d6/d9/struct__CREATESTRUCTEX.html#o0">cs</a>.lpszClass, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1);
12113             }
12114         }
12115     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
12116         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
12117     }
12118 
12119     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1817">xxxCallNextHookEx</a>(
12120                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
12121                 wParam,
12122                 (LPARAM)&amp;cbt);
12123 
12124     <span class="keywordflow">try</span> {
12125         pcbt-&gt;hwndInsertAfter = cbt.hwndInsertAfter;
12126         lpcsSave-&gt;x = cbt.lpcs-&gt;x;
12127         lpcsSave-&gt;y = cbt.lpcs-&gt;y;
12128         lpcsSave-&gt;cx = cbt.lpcs-&gt;cx;
12129         lpcsSave-&gt;cy = cbt.lpcs-&gt;cy;
12130     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
12131         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
12132     }
12133 
12134     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserfnHkINLPCBTCREATESTRUCT"</span>);
12135     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a52">ENDRECV_HOOKCALL</a>();
12136 }
12137 
<a name="l12138"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a376">12138</a> LRESULT <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a376">NtUserfnHkINLPRECT</a>(
12139     IN DWORD nCode,
12140     IN WPARAM wParam,
12141     IN LPRECT lParam)
12142 {
12143     RECT rc;
12144 
12145     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a51">BEGINRECV_HOOKCALL</a>();
12146 
12147     <span class="comment">/*</span>
12148 <span class="comment">     * Probe arguments</span>
12149 <span class="comment">     */</span>
12150     <span class="keywordflow">try</span> {
12151         rc = <a class="code" href="../../d4/d1/userk_8h.html#a31">ProbeAndReadRect</a>((PRECT)lParam);
12152     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
12153         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
12154     }
12155 
12156     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1817">xxxCallNextHookEx</a>(
12157             nCode,
12158             wParam,
12159             (LPARAM)&amp;rc);
12160 
12161     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserfnHkINLPRECT"</span>);
12162     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a52">ENDRECV_HOOKCALL</a>();
12163 }
12164 
12165 <span class="preprocessor">#ifdef REDIRECTION</span>
12166 <span class="preprocessor"></span>
12167 LRESULT NtUserfnHkINLPPOINT(
12168     IN DWORD   nCode,
12169     IN WPARAM  wParam,
12170     IN LPPOINT lParam)
12171 {
12172     POINT pt;
12173 
12174     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a51">BEGINRECV_HOOKCALL</a>();
12175 
12176     <span class="comment">/*</span>
12177 <span class="comment">     * Probe arguments</span>
12178 <span class="comment">     */</span>
12179     <span class="keywordflow">try</span> {
12180         pt = <a class="code" href="../../d4/d1/userk_8h.html#a29">ProbeAndReadPoint</a>((LPPOINT)lParam);
12181     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(FALSE)) {
12182         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
12183     }
12184 
12185     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1817">xxxCallNextHookEx</a>(
12186             nCode,
12187             wParam,
12188             (LPARAM)&amp;pt);
12189 
12190     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserfnHkINLPPOINT"</span>);
12191     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a52">ENDRECV_HOOKCALL</a>();
12192 }
12193 <span class="preprocessor">#endif // REDIRECTION</span>
12194 <span class="preprocessor"></span>
<a name="l12195"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a377">12195</a> LRESULT <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a377">NtUserfnHkINLPMSG</a>(
12196     IN <span class="keywordtype">int</span> iHook,
12197     IN DWORD nCode,
12198     IN WPARAM wParam,
12199     IN LPMSG lParam)
12200 {
12201     MSG <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
12202 
12203     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a51">BEGINRECV_HOOKCALL</a>();
12204 
12205     <span class="comment">/*</span>
12206 <span class="comment">     * Probe arguments</span>
12207 <span class="comment">     */</span>
12208     <span class="keywordflow">try</span> {
12209         <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> = <a class="code" href="../../d4/d1/userk_8h.html#a33">ProbeAndReadMessage</a>((PMSG)lParam);
12210     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
12211         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
12212     }
12213 
12214     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1817">xxxCallNextHookEx</a>(
12215             nCode,
12216             wParam,
12217             (LPARAM)&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>);
12218 
12219     <span class="comment">/*</span>
12220 <span class="comment">     * If this is GetMessageHook, the hook should be</span>
12221 <span class="comment">     * able to change the message, as stated in SDK document.</span>
12222 <span class="comment">     */</span>
12223     <span class="keywordflow">if</span> (iHook == WH_GETMESSAGE) {
12224         <span class="keywordflow">try</span> {
12225             *(PMSG)lParam = <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
12226         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
12227             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
12228         }
12229     }
12230 
12231     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserfnHkINLPMSG"</span>);
12232     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a52">ENDRECV_HOOKCALL</a>();
12233 }
12234 
<a name="l12235"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a378">12235</a> LRESULT <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a378">NtUserfnHkINLPDEBUGHOOKSTRUCT</a>(
12236     IN DWORD nCode,
12237     IN WPARAM wParam,
12238     IN LPDEBUGHOOKINFO lParam)
12239 {
12240     DEBUGHOOKINFO hookinfo;
12241     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbDbgLParam;
12242 
12243     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a51">BEGINRECV_HOOKCALL</a>();
12244 
12245     <span class="comment">/*</span>
12246 <span class="comment">     * Probe arguments</span>
12247 <span class="comment">     */</span>
12248     <span class="keywordflow">try</span> {
12249         hookinfo = <a class="code" href="../../d4/d1/userk_8h.html#a49">ProbeAndReadHookInfo</a>((PDEBUGHOOKINFO)lParam);
12250 
12251         cbDbgLParam = <a class="code" href="../../d4/d1/userk_8h.html#a1907">GetDebugHookLParamSize</a>(wParam, &amp;hookinfo);
12252         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(hookinfo.lParam, cbDbgLParam, <a class="code" href="../../d4/d1/userk_8h.html#a22">DATAALIGN</a>);
12253     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
12254         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
12255     }
12256 
12257     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1817">xxxCallNextHookEx</a>(
12258             nCode,
12259             wParam,
12260             (LPARAM)&amp;hookinfo);
12261 
12262     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserfnHkINLPDEBUGHOOKSTRUCT"</span>);
12263     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a52">ENDRECV_HOOKCALL</a>();
12264 }
12265 
<a name="l12266"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a379">12266</a> LRESULT <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a379">NtUserfnHkOPTINLPEVENTMSG</a>(
12267     IN DWORD nCode,
12268     IN WPARAM wParam,
12269     IN OUT LPEVENTMSGMSG lParam OPTIONAL)
12270 {
12271     EVENTMSG event;
12272 
12273     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a51">BEGINRECV_HOOKCALL</a>();
12274 
12275     <span class="comment">/*</span>
12276 <span class="comment">     * Probe arguments</span>
12277 <span class="comment">     */</span>
12278     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(lParam)) {
12279         <span class="keywordflow">try</span> {
12280             <a class="code" href="../../d4/d1/userk_8h.html#a76">ProbeForWriteEvent</a>((LPEVENTMSGMSG)lParam);
12281             event = *(LPEVENTMSGMSG)lParam;
12282         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
12283             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
12284         }
12285     }
12286 
12287     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1817">xxxCallNextHookEx</a>(
12288             nCode,
12289             wParam,
12290             (LPARAM)(lParam ? &amp;event : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>));
12291 
12292     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(lParam)) {
12293         <span class="keywordflow">try</span> {
12294             *(LPEVENTMSGMSG)lParam = event;
12295         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
12296             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
12297         }
12298     }
12299 
12300     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserfnHkINLPEVENTMSG"</span>);
12301     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a52">ENDRECV_HOOKCALL</a>();
12302 }
12303 
<a name="l12304"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a380">12304</a> LRESULT <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a380">NtUserfnHkINLPMOUSEHOOKSTRUCTEX</a>(
12305     IN DWORD nCode,
12306     IN WPARAM wParam,
12307     IN LPMOUSEHOOKSTRUCTEX lParam)
12308 {
12309     MOUSEHOOKSTRUCTEX mousehook;
12310 
12311     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a51">BEGINRECV_HOOKCALL</a>();
12312 
12313     <span class="comment">/*</span>
12314 <span class="comment">     * Probe arguments</span>
12315 <span class="comment">     */</span>
12316     <span class="keywordflow">try</span> {
12317         mousehook = <a class="code" href="../../d4/d1/userk_8h.html#a53">ProbeAndReadMouseHook</a>((PMOUSEHOOKSTRUCTEX)lParam);
12318     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
12319         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
12320     }
12321 
12322     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1817">xxxCallNextHookEx</a>(
12323             nCode,
12324             wParam,
12325             (LPARAM)&amp;mousehook);
12326 
12327     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserfnHkINLPMOUSEHOOKSTRUCTEX"</span>);
12328     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a52">ENDRECV_HOOKCALL</a>();
12329 }
12330 
<a name="l12331"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a381">12331</a> LRESULT <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a381">NtUserfnHkINLPKBDLLHOOKSTRUCT</a>(
12332     IN DWORD nCode,
12333     IN WPARAM wParam,
12334     IN LPKBDLLHOOKSTRUCT lParam)
12335 {
12336     KBDLLHOOKSTRUCT kbdhook;
12337 
12338     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a51">BEGINRECV_HOOKCALL</a>();
12339 
12340     <span class="comment">/*</span>
12341 <span class="comment">     * Probe arguments</span>
12342 <span class="comment">     */</span>
12343     <span class="keywordflow">try</span> {
12344         kbdhook = <a class="code" href="../../d4/d1/userk_8h.html#a51">ProbeAndReadKbdHook</a>((PKBDLLHOOKSTRUCT)lParam);
12345     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
12346         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
12347     }
12348 
12349     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1817">xxxCallNextHookEx</a>(
12350             nCode,
12351             wParam,
12352             (LPARAM)&amp;kbdhook);
12353 
12354     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserfnHkINLPKBDLLHOOKSTRUCT"</span>);
12355     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a52">ENDRECV_HOOKCALL</a>();
12356 }
12357 
<a name="l12358"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a382">12358</a> LRESULT <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a382">NtUserfnHkINLPMSLLHOOKSTRUCT</a>(
12359     IN DWORD nCode,
12360     IN WPARAM wParam,
12361     IN LPMSLLHOOKSTRUCT lParam)
12362 {
12363     MSLLHOOKSTRUCT msllhook;
12364 
12365     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a51">BEGINRECV_HOOKCALL</a>();
12366 
12367     <span class="comment">/*</span>
12368 <span class="comment">     * Probe arguments</span>
12369 <span class="comment">     */</span>
12370     <span class="keywordflow">try</span> {
12371         msllhook = <a class="code" href="../../d4/d1/userk_8h.html#a52">ProbeAndReadMsllHook</a>((PMSLLHOOKSTRUCT)lParam);
12372     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
12373         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
12374     }
12375 
12376     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1817">xxxCallNextHookEx</a>(
12377             nCode,
12378             wParam,
12379             (LPARAM)&amp;msllhook);
12380 
12381     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserfnHkINLPMSLLHOOKSTRUCT"</span>);
12382     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a52">ENDRECV_HOOKCALL</a>();
12383 }
12384 
12385 <span class="preprocessor">#ifdef REDIRECTION</span>
12386 <span class="preprocessor"></span>LRESULT NtUserfnHkINLPHTHOOKSTRUCT(
12387     IN DWORD nCode,
12388     IN WPARAM wParam,
12389     IN LPHTHOOKSTRUCT lParam)
12390 {
12391     HTHOOKSTRUCT hthook;
12392 
12393     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a51">BEGINRECV_HOOKCALL</a>();
12394 
12395     <span class="comment">/*</span>
12396 <span class="comment">     * Probe arguments</span>
12397 <span class="comment">     */</span>
12398     <span class="keywordflow">try</span> {
12399         hthook = ProbeAndReadHTHook((PHTHOOKSTRUCT)lParam);
12400     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(FALSE)) {
12401         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
12402     }
12403 
12404     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1817">xxxCallNextHookEx</a>(
12405             nCode,
12406             wParam,
12407             (LPARAM)&amp;hthook);
12408 
12409     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserfnHkINLPHTHOOKSTRUCT"</span>);
12410     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a52">ENDRECV_HOOKCALL</a>();
12411 }
12412 <span class="preprocessor">#endif // REDIRECTION</span>
12413 <span class="preprocessor"></span>
<a name="l12414"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a383">12414</a> LRESULT <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a383">NtUserfnHkINLPCBTACTIVATESTRUCT</a>(
12415     IN DWORD nCode,
12416     IN WPARAM wParam,
12417     IN LPCBTACTIVATESTRUCT lParam)
12418 {
12419     CBTACTIVATESTRUCT cbtactivate;
12420 
12421     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a51">BEGINRECV_HOOKCALL</a>();
12422 
12423     <span class="comment">/*</span>
12424 <span class="comment">     * Probe arguments</span>
12425 <span class="comment">     */</span>
12426     <span class="keywordflow">try</span> {
12427         cbtactivate = <a class="code" href="../../d4/d1/userk_8h.html#a50">ProbeAndReadCBTActivateStruct</a>((LPCBTACTIVATESTRUCT)lParam);
12428     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
12429         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
12430     }
12431 
12432     retval = <a class="code" href="../../d4/d1/userk_8h.html#a1817">xxxCallNextHookEx</a>(
12433             nCode,
12434             wParam,
12435             (LPARAM)&amp;cbtactivate);
12436 
12437     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserfnHkINLPCBTACTIVATESTRUCT"</span>);
12438     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a52">ENDRECV_HOOKCALL</a>();
12439 }
12440 
<a name="l12441"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a384">12441</a> LRESULT <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a384">NtUserCallNextHookEx</a>(
12442     <span class="keywordtype">int</span> nCode,
12443     WPARAM wParam,
12444     LPARAM lParam,
12445     BOOL bAnsi)
12446 {
12447     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(LRESULT, 0);
12448 
12449     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;sphkCurrent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
12450         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
12451     }
12452 
12453     <span class="keywordflow">switch</span> (<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;sphkCurrent-&gt;iHook) {
12454     <span class="keywordflow">case</span> WH_CBT:
12455         <span class="comment">/*</span>
12456 <span class="comment">         * There are many different types of CBT hooks!</span>
12457 <span class="comment">         */</span>
12458         <span class="keywordflow">switch</span> (nCode) {
12459         <span class="keywordflow">case</span> HCBT_CLICKSKIPPED:
12460             <span class="keywordflow">goto</span> MouseHook;
12461             <span class="keywordflow">break</span>;
12462 
12463         <span class="keywordflow">case</span> HCBT_CREATEWND:
12464             <span class="comment">/*</span>
12465 <span class="comment">             * This hook type points to a CREATESTRUCT, so we need to</span>
12466 <span class="comment">             * be fancy it's thunking, because a CREATESTRUCT contains</span>
12467 <span class="comment">             * a pointer to CREATEPARAMS which can be anything... so</span>
12468 <span class="comment">             * funnel this through our message thunks.</span>
12469 <span class="comment">             */</span>
12470             retval =  <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a375">NtUserfnHkINLPCBTCREATESTRUCT</a>(
12471                     nCode,
12472                     wParam,
12473                     (LPCBT_CREATEWND)lParam,
12474                     bAnsi);
12475             <span class="keywordflow">break</span>;
12476 
12477 <span class="preprocessor">#ifdef REDIRECTION</span>
12478 <span class="preprocessor"></span>        <span class="keywordflow">case</span> HCBT_GETCURSORPOS:
12479 
12480             <span class="comment">/*</span>
12481 <span class="comment">             * This hook type points to a POINT structure.</span>
12482 <span class="comment">             */</span>
12483             retval = NtUserfnHkINLPPOINT(nCode, wParam, (LPPOINT)lParam);
12484             <span class="keywordflow">break</span>;
12485 <span class="preprocessor">#endif // REDIRECTION</span>
12486 <span class="preprocessor"></span>
12487         <span class="keywordflow">case</span> HCBT_MOVESIZE:
12488 
12489             <span class="comment">/*</span>
12490 <span class="comment">             * This hook type points to a RECT structure.</span>
12491 <span class="comment">             */</span>
12492             retval = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a376">NtUserfnHkINLPRECT</a>(nCode, wParam, (LPRECT)lParam);
12493             <span class="keywordflow">break</span>;
12494 
12495         <span class="keywordflow">case</span> HCBT_ACTIVATE:
12496             <span class="comment">/*</span>
12497 <span class="comment">             * This hook type points to a CBTACTIVATESTRUCT</span>
12498 <span class="comment">             */</span>
12499             retval = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a383">NtUserfnHkINLPCBTACTIVATESTRUCT</a>(nCode, wParam,
12500                     (LPCBTACTIVATESTRUCT)lParam);
12501             <span class="keywordflow">break</span>;
12502 
12503         <span class="keywordflow">default</span>:
12504             <span class="comment">/*</span>
12505 <span class="comment">             * The rest of the cbt hooks are all dword parameters.</span>
12506 <span class="comment">             */</span>
12507             retval = <a class="code" href="../../d4/d1/userk_8h.html#a1817">xxxCallNextHookEx</a>(
12508                     nCode,
12509                     wParam,
12510                     lParam);
12511             <span class="keywordflow">break</span>;
12512         }
12513         <span class="keywordflow">break</span>;
12514 
12515     <span class="keywordflow">case</span> WH_FOREGROUNDIDLE:
12516     <span class="keywordflow">case</span> WH_KEYBOARD:
12517     <span class="keywordflow">case</span> WH_SHELL:
12518         <span class="comment">/*</span>
12519 <span class="comment">         * These are dword parameters and are therefore real easy.</span>
12520 <span class="comment">         */</span>
12521         retval = <a class="code" href="../../d4/d1/userk_8h.html#a1817">xxxCallNextHookEx</a>(
12522                 nCode,
12523                 wParam,
12524                 lParam);
12525         <span class="keywordflow">break</span>;
12526 
12527     <span class="keywordflow">case</span> WH_MSGFILTER:
12528     <span class="keywordflow">case</span> WH_SYSMSGFILTER:
12529     <span class="keywordflow">case</span> WH_GETMESSAGE:
12530         <span class="comment">/*</span>
12531 <span class="comment">         * These take an lpMsg as their last parameter. Since these are</span>
12532 <span class="comment">         * exclusively posted parameters, and since nowhere on the server</span>
12533 <span class="comment">         * do we post a message with a pointer to some other structure in</span>
12534 <span class="comment">         * it, the lpMsg structure contents can all be treated verbatim.</span>
12535 <span class="comment">         */</span>
12536         retval = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a377">NtUserfnHkINLPMSG</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;sphkCurrent-&gt;iHook, nCode, wParam, (LPMSG)lParam);
12537         <span class="keywordflow">break</span>;
12538 
12539     <span class="keywordflow">case</span> WH_JOURNALPLAYBACK:
12540     <span class="keywordflow">case</span> WH_JOURNALRECORD:
12541         <span class="comment">/*</span>
12542 <span class="comment">         * These take an OPTIONAL lpEventMsg.</span>
12543 <span class="comment">         */</span>
12544         retval = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a379">NtUserfnHkOPTINLPEVENTMSG</a>(nCode, wParam, (LPEVENTMSGMSG)lParam);
12545         <span class="keywordflow">break</span>;
12546 
12547     <span class="keywordflow">case</span> WH_DEBUG:
12548         <span class="comment">/*</span>
12549 <span class="comment">         * This takes an lpDebugHookStruct.</span>
12550 <span class="comment">         */</span>
12551         retval = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a378">NtUserfnHkINLPDEBUGHOOKSTRUCT</a>(nCode, wParam, (LPDEBUGHOOKINFO)lParam);
12552         <span class="keywordflow">break</span>;
12553 
12554     <span class="keywordflow">case</span> WH_KEYBOARD_LL:
12555         <span class="comment">/*</span>
12556 <span class="comment">         * This takes an lpKbdllHookStruct.</span>
12557 <span class="comment">         */</span>
12558         retval = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a381">NtUserfnHkINLPKBDLLHOOKSTRUCT</a>(nCode, wParam, (LPKBDLLHOOKSTRUCT)lParam);
12559         <span class="keywordflow">break</span>;
12560 
12561     <span class="keywordflow">case</span> WH_MOUSE_LL:
12562         <span class="comment">/*</span>
12563 <span class="comment">         * This takes an lpMsllHookStruct.</span>
12564 <span class="comment">         */</span>
12565         retval = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a382">NtUserfnHkINLPMSLLHOOKSTRUCT</a>(nCode, wParam, (LPMSLLHOOKSTRUCT)lParam);
12566         <span class="keywordflow">break</span>;
12567 
12568     <span class="keywordflow">case</span> WH_MOUSE:
12569         <span class="comment">/*</span>
12570 <span class="comment">         * This takes an lpMouseHookStructEx.</span>
12571 <span class="comment">         */</span>
12572 MouseHook:
12573         retval = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a380">NtUserfnHkINLPMOUSEHOOKSTRUCTEX</a>(nCode, wParam, (LPMOUSEHOOKSTRUCTEX)lParam);
12574         <span class="keywordflow">break</span>;
12575 
12576 <span class="preprocessor">#ifdef REDIRECTION</span>
12577 <span class="preprocessor"></span>    <span class="keywordflow">case</span> WH_HITTEST:
12578         <span class="comment">/*</span>
12579 <span class="comment">         * This takes an lpHTHookStruct.</span>
12580 <span class="comment">         */</span>
12581         retval = NtUserfnHkINLPHTHOOKSTRUCT(nCode, wParam, (LPHTHOOKSTRUCT)lParam);
12582         <span class="keywordflow">break</span>;
12583 <span class="preprocessor">#endif // REDIRECTION</span>
12584 <span class="preprocessor"></span>
12585     <span class="keywordflow">default</span>:
12586         RIPMSG1(RIP_WARNING, <span class="stringliteral">"NtUserCallNextHookEx: Invalid hook type %x"</span>,
12587                 <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;sphkCurrent-&gt;iHook);
12588         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
12589     }
12590 
12591     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserCallNextHookEx"</span>);
12592     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
12593 }
12594 
12595 
<a name="l12596"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a385">12596</a> HIMC <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a385">NtUserCreateInputContext</a>(
12597     IN ULONG_PTR dwClientImcData)
12598 {
12599     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(HIMC, (HIMC)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
12600 
12601     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a73">ValidateIMMEnabled</a>();
12602 
12603     <span class="keywordflow">if</span> (dwClientImcData == 0) {
12604         RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"Invalid hMemClientIC parameter"</span>);
12605         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
12606     }
12607 
12608     retval = (HIMC)<a class="code" href="../../d4/d1/userk_8h.html#a2030">CreateInputContext</a>(dwClientImcData);
12609 
12610     retval = (HIMC)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>((PVOID)retval);
12611 
12612     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserCreateInputContext"</span>);
12613     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
12614 }
12615 
12616 
<a name="l12617"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a386">12617</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a386">NtUserDestroyInputContext</a>(
12618     IN HIMC hImc)
12619 {
12620     <a class="code" href="../../d1/d7/structtagIMC.html">PIMC</a> pImc;
12621 
12622     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
12623 
12624     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a73">ValidateIMMEnabled</a>();
12625 
12626     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a71">ValidateHIMC</a>(pImc, hImc);
12627 
12628     retval = <a class="code" href="../../d4/d1/userk_8h.html#a2031">DestroyInputContext</a>(pImc);
12629 
12630     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserDestroyInputContext"</span>);
12631     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
12632 }
12633 
12634 
<a name="l12635"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a387">12635</a> <a class="code" href="../../d8/d0/immstruc_8h.html#a39">AIC_STATUS</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a387">NtUserAssociateInputContext</a>(
12636     IN HWND hwnd,
12637     IN HIMC hImc,
12638     IN DWORD dwFlag)
12639 {
12640     <a class="code" href="../../d1/d7/structtagIMC.html">PIMC</a> pImc;
12641 
12642     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a16">BEGINATOMICRECV_HWND</a>(<a class="code" href="../../d8/d0/immstruc_8h.html#a39">AIC_STATUS</a>, <a class="code" href="../../d8/d0/immstruc_8h.html#a72a45">AIC_ERROR</a>, hwnd);
12643 
12644     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a73">ValidateIMMEnabled</a>();
12645 
12646     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a72">ValidateHIMCOPT</a>(pImc, hImc);
12647 
12648     retval = <a class="code" href="../../d4/d1/userk_8h.html#a2034">AssociateInputContextEx</a>(pwnd, pImc, dwFlag);
12649 
12650     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserAssociateInputContext"</span>);
12651     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a17">ENDATOMICRECV_HWND</a>();
12652 }
12653 
<a name="l12654"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a388">12654</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a388">NtUserUpdateInputContext</a>(
12655     IN HIMC hImc,
12656     IN UPDATEINPUTCONTEXTCLASS UpdateType,
12657     IN ULONG_PTR UpdateValue)
12658 {
12659     <a class="code" href="../../d1/d7/structtagIMC.html">PIMC</a> pImc;
12660 
12661     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
12662 
12663     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a73">ValidateIMMEnabled</a>();
12664 
12665     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a71">ValidateHIMC</a>(pImc, hImc);
12666 
12667     retval = <a class="code" href="../../d4/d1/userk_8h.html#a2035">UpdateInputContext</a>(pImc, UpdateType, UpdateValue);
12668 
12669     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserUpdateInputContext"</span>);
12670     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
12671 }
12672 
12673 
<a name="l12674"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a389">12674</a> ULONG_PTR <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a389">NtUserQueryInputContext</a>(
12675     IN HIMC hImc,
12676     IN INPUTCONTEXTINFOCLASS InputContextInfo)
12677 {
12678     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiImc;
12679     <a class="code" href="../../d1/d7/structtagIMC.html">PIMC</a> pImc;
12680 
12681     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(ULONG_PTR, 0);
12682 
12683     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a73">ValidateIMMEnabled</a>();
12684 
12685     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a71">ValidateHIMC</a>(pImc, hImc);
12686 
12687     ptiImc = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pImc);
12688 
12689     <span class="keywordflow">switch</span> (InputContextInfo) {
12690     <span class="keywordflow">case</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a74a48">InputContextProcess</a>:
12691         retval = (ULONG_PTR)ptiImc-&gt;pEThread-&gt;Cid.UniqueProcess;
12692         <span class="keywordflow">break</span>;
12693 
12694     <span class="keywordflow">case</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a74a49">InputContextThread</a>:
12695         retval = (ULONG_PTR)ptiImc-&gt;pEThread-&gt;Cid.UniqueThread;
12696         <span class="keywordflow">break</span>;
12697 
12698     <span class="keywordflow">case</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a74a50">InputContextDefaultImeWindow</a>:
12699         retval = (ULONG_PTR)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(ptiImc-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o39">spwndDefaultIme</a>);
12700         <span class="keywordflow">break</span>;
12701 
12702     <span class="keywordflow">case</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a74a51">InputContextDefaultInputContext</a>:
12703         retval = (ULONG_PTR)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(ptiImc-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o40">spDefaultImc</a>);
12704         <span class="keywordflow">break</span>;
12705     }
12706 
12707     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
12708 }
12709 
<a name="l12710"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a390">12710</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a390">NtUserBuildHimcList</a>(  <span class="comment">// private IMM BuildHimcList</span>
12711     IN DWORD  idThread,
12712     IN UINT   cHimcMax,
12713     OUT HIMC *phimcFirst,
12714     OUT PUINT pcHimcNeeded)
12715 {
12716     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
12717     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cHimcNeeded;
12718 
12719     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>, STATUS_UNSUCCESSFUL);
12720 
12721     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a73">ValidateIMMEnabled</a>();
12722 
12723     <span class="keywordflow">switch</span> (idThread) {
12724     <span class="keywordflow">case</span> 0:
12725         pti = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
12726         <span class="keywordflow">break</span>;
12727     <span class="keywordflow">case</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1:
12728         pti = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
12729         <span class="keywordflow">break</span>;
12730     <span class="keywordflow">default</span>:
12731         pti = <a class="code" href="../../d4/d1/userk_8h.html#a1201">PtiFromThreadId</a>(idThread);
12732         <span class="keywordflow">if</span> (pti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
12733             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
12734         }
12735         <span class="keywordflow">break</span>;
12736     }
12737 
12738     <span class="comment">/*</span>
12739 <span class="comment">     * Probe arguments</span>
12740 <span class="comment">     */</span>
12741     <span class="keywordflow">try</span> {
12742         <a class="code" href="../../d4/d1/userk_8h.html#a25">ProbeForWriteBuffer</a>(phimcFirst, cHimcMax, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
12743         <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(pcHimcNeeded);
12744     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
12745         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
12746     }
12747 
12748     <span class="comment">/*</span>
12749 <span class="comment">     * phimcFirst is client-side.</span>
12750 <span class="comment">     */</span>
12751 
12752     cHimcNeeded = <a class="code" href="../../d4/d1/userk_8h.html#a2037">BuildHimcList</a>(pti, cHimcMax, phimcFirst);
12753 
12754     <span class="keywordflow">if</span> (cHimcNeeded &lt;= cHimcMax) {
12755         retval = STATUS_SUCCESS;
12756     } <span class="keywordflow">else</span> {
12757         retval = STATUS_BUFFER_TOO_SMALL;
12758     }
12759     <span class="keywordflow">try</span> {
12760         *pcHimcNeeded = cHimcNeeded;
12761     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
12762     }
12763 
12764     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserBuildHimcList"</span>);
12765     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
12766 }
12767 
12768 
<a name="l12769"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a391">12769</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a391">NtUserGetImeInfoEx</a>(  <span class="comment">// private ImmGetImeInfoEx</span>
12770     IN OUT <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">PIMEINFOEX</a> piiex,
12771     IN IMEINFOEXCLASS SearchType)
12772 {
12773     <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">IMEINFOEX</a> iiex;
12774     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a9">BEGINRECV_SHARED</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
12775 
12776     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a73">ValidateIMMEnabled</a>();
12777 
12778     <span class="keywordflow">try</span> {
12779         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(piiex, <span class="keyword">sizeof</span>(*piiex), <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
12780         RtlCopyMemory(&amp;iiex, piiex, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/structtagIMEINFOEX.html">IMEINFOEX</a>));
12781     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
12782         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
12783     }
12784 
12785     retval = <a class="code" href="../../d4/d1/userk_8h.html#a2045">GetImeInfoEx</a>(
12786                     <a class="code" href="../../d8/d8/winsta_8c.html#a11">_GetProcessWindowStation</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>),
12787                     &amp;iiex,
12788                     SearchType);
12789 
12790     <span class="keywordflow">try</span> {
12791         RtlCopyMemory(piiex, &amp;iiex, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/structtagIMEINFOEX.html">IMEINFOEX</a>));
12792     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
12793     }
12794 
12795     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetImeInfoEx"</span>);
12796     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a10">ENDRECV_SHARED</a>();
12797 }
12798 
12799 
<a name="l12800"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a392">12800</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a392">NtUserSetImeInfoEx</a>(
12801     IN <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">PIMEINFOEX</a> piiex)
12802 {
12803     <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">IMEINFOEX</a> iiex;
12804     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
12805 
12806     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a73">ValidateIMMEnabled</a>();
12807 
12808     <span class="comment">/*</span>
12809 <span class="comment">     * Probe arguments</span>
12810 <span class="comment">     */</span>
12811     <span class="keywordflow">try</span> {
12812         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(piiex, <span class="keyword">sizeof</span>(*piiex), <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
12813         RtlCopyMemory(&amp;iiex, piiex, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/structtagIMEINFOEX.html">IMEINFOEX</a>));
12814     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
12815         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
12816     }
12817 
12818     retval = <a class="code" href="../../d4/d1/userk_8h.html#a2046">SetImeInfoEx</a>(
12819                     <a class="code" href="../../d8/d8/winsta_8c.html#a11">_GetProcessWindowStation</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>),
12820                     &amp;iiex);
12821 
12822     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetImeInfoEx"</span>);
12823     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
12824 }
12825 
<a name="l12826"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a393">12826</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a393">NtUserGetImeHotKey</a>(
12827     IN DWORD dwID,
12828     OUT PUINT puModifiers,
12829     OUT PUINT puVKey,
12830     OUT LPHKL phkl)
12831 {
12832     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uModifiers;
12833     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uVKey;
12834     HKL hkl;
12835     LPHKL phklIn = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
12836     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
12837 
12838     <span class="keywordflow">try</span> {
12839         <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(((PULONG)puModifiers));
12840         <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(((PULONG)puVKey));
12841         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(phkl)) {
12842             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>((PHANDLE)phkl);
12843             phklIn = &amp;hkl;
12844         }
12845     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
12846         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
12847     }
12848     retval = <a class="code" href="../../d4/d1/userk_8h.html#a2048">GetImeHotKey</a>( dwID, &amp;uModifiers, &amp;uVKey, phklIn);
12849 
12850     <span class="keywordflow">try</span> {
12851         *puModifiers = uModifiers;
12852         *puVKey = uVKey;
12853         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(phkl)) {
12854             *phkl = *phklIn;
12855         }
12856     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
12857         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
12858     }
12859     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetImeHotKey"</span>);
12860     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
12861 }
12862 
<a name="l12863"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a394">12863</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a394">NtUserSetImeHotKey</a>(
12864     IN DWORD dwID,
12865     IN UINT  uModifiers,
12866     IN UINT  uVKey,
12867     IN HKL   hkl,
12868     IN DWORD dwFlags)
12869 {
12870     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
12871 
12872     retval = <a class="code" href="../../d4/d1/userk_8h.html#a2049">SetImeHotKey</a>( dwID, uModifiers, uVKey, hkl, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> );
12873     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetImeHotKey"</span>);
12874     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
12875 }
12876 
12877 <span class="comment">/*</span>
12878 <span class="comment"> * Set per-window application level for IME control.</span>
12879 <span class="comment"> * Used only for Korean 3.x ( both 16 bit and 32 bit)</span>
12880 <span class="comment"> * applications.</span>
12881 <span class="comment"> *</span>
12882 <span class="comment"> * return value</span>
12883 <span class="comment"> *</span>
12884 <span class="comment"> *      TRUE : success</span>
12885 <span class="comment"> *      FALSE: error</span>
12886 <span class="comment"> */</span>
<a name="l12887"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a395">12887</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a395">NtUserSetAppImeLevel</a>(
12888     IN HWND  hwnd,
12889     IN DWORD dwLevel)
12890 {
12891     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a14">BEGINRECV_HWND</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, hwnd);
12892 
12893     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a73">ValidateIMMEnabled</a>();
12894 
12895     <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;ppi == <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>() ) {
12896         <a class="code" href="../../d4/d8/kernel_2winprop_8c.html#a0">InternalSetProp</a>(pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a480">PROP_IMELEVEL</a>, (HANDLE)LongToHandle( dwLevel ), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a498">PROPF_INTERNAL</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a500">PROPF_NOPOOL</a>);
12897         retval = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
12898     } <span class="keywordflow">else</span> {
12899         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
12900     }
12901     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetAppImeLevel"</span>);
12902     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a15">ENDRECV_HWND</a>();
12903 }
12904 
12905 <span class="comment">/*</span>
12906 <span class="comment"> * Get per-window application level for IME control.</span>
12907 <span class="comment"> * Used only for Korean 3.x ( both 16 bit and 32 bit)</span>
12908 <span class="comment"> * applications.</span>
12909 <span class="comment"> *</span>
12910 <span class="comment"> * return value</span>
12911 <span class="comment"> *</span>
12912 <span class="comment"> *      0               : error</span>
12913 <span class="comment"> *      non zero value  : level</span>
12914 <span class="comment"> */</span>
<a name="l12915"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a396">12915</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a396">NtUserGetAppImeLevel</a>(
12916     IN HWND  hwnd)
12917 {
12918     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a20">BEGINRECV_HWND_SHARED</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, 0, hwnd);
12919 
12920     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a73">ValidateIMMEnabled</a>();
12921 
12922     <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;ppi == <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>()-&gt;ppi ) {
12923         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(ULONG_PTR)<a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a480">PROP_IMELEVEL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
12924     } <span class="keywordflow">else</span> {
12925         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
12926     }
12927     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserGetAppImeLevel"</span>);
12928     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a21">ENDRECV_HWND_SHARED</a>();
12929 }
12930 
12931 
<a name="l12932"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a397">12932</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a397">NtUserCheckImeHotKey</a>(
12933     UINT uVKey,
12934     LPARAM lParam)
12935 {
12936     <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> pImeHotKeyObj;
12937     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, IME_INVALID_HOTKEY);
12938 
12939     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
12940         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
12941 
12942     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a73">ValidateIMMEnabled</a>();
12943 
12944     pImeHotKeyObj = <a class="code" href="../../d4/d1/userk_8h.html#a2050">CheckImeHotKey</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>, uVKey, lParam);
12945     <span class="keywordflow">if</span> (pImeHotKeyObj) {
12946         retval = pImeHotKeyObj-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o0">dwHotKeyID</a>;
12947     }
12948     <span class="keywordflow">else</span> {
12949         retval = IME_INVALID_HOTKEY;
12950     }
12951 
12952     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserCheckImeHotKey"</span>);
12953     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
12954 }
12955 
<a name="l12956"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a398">12956</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a398">NtUserSetImeOwnerWindow</a>(
12957     IN HWND hwndIme,
12958     IN HWND hwndFocus)
12959 {
12960     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndFocus;
12961 
12962     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a16">BEGINATOMICRECV_HWND</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, hwndIme);
12963 
12964     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a73">ValidateIMMEnabled</a>();
12965 
12966     <span class="comment">/*</span>
12967 <span class="comment">     * Make sure this really is an IME window.</span>
12968 <span class="comment">     */</span>
12969     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd) != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a208">FNID_IME</a>)
12970         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
12971 
12972     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a57">ValidateHWNDOPT</a>(pwndFocus, hwndFocus);
12973 
12974     <span class="keywordflow">if</span> (pwndFocus != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
12975         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndTopLevel;
12976         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT;
12977 
12978         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwndFocus, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a482">CFIME</a>) ||
12979                 pwndFocus-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a> == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a89">ICLS_IME</a>]) {
12980             RIPMSG0(RIP_WARNING, <span class="stringliteral">"Focus window should not be an IME/UI window!!"</span>);
12981             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
12982         }
12983 
12984         <span class="comment">/*</span>
12985 <span class="comment">         * Child window cannot be an owner window.</span>
12986 <span class="comment">         */</span>
12987         pwndTopLevel = pwndT = <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a11">GetTopLevelWindow</a>(pwndFocus);
12988 
12989         <span class="comment">/*</span>
12990 <span class="comment">         * To prevent the IME window becomes the onwer (HY?)</span>
12991 <span class="comment">         */</span>
12992         <span class="keywordflow">while</span> (pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
12993             <span class="keywordflow">if</span> (pwndT-&gt;pcls-&gt;atomClassName == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a89">ICLS_IME</a>]) {
12994                 RIPMSG0(RIP_WARNING,
12995                         <span class="stringliteral">"The owner of focus window should not be an IME window!!"</span>);
12996                 pwndTopLevel = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
12997                 <span class="keywordflow">break</span>;
12998             }
12999             pwndT = pwndT-&gt;spwndOwner;
13000         }
13001 
13002         UserAssert(pwnd-&gt;pcls-&gt;atomClassName == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a89">ICLS_IME</a>]);
13003         UserAssert(pwndTopLevel == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwndTopLevel, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a482">CFIME</a>));
13004         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pwnd-&gt;spwndOwner, pwndTopLevel);
13005         <a class="code" href="../../d4/d1/userk_8h.html#a2054">ImeCheckTopmost</a>(pwnd);
13006     }
13007     <span class="keywordflow">else</span> {
13008         <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiImeWnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd);
13009         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndActive = ptiImeWnd-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>;
13010 
13011         <span class="comment">/*</span>
13012 <span class="comment">         * If pwndFocus == NULL, active window in the queue should become the</span>
13013 <span class="comment">         * owner window of the IME window, except: if IME related windows</span>
13014 <span class="comment">         * somehow got a focus, or the active window belongs to the other thread.</span>
13015 <span class="comment">         */</span>
13016         <span class="keywordflow">if</span> (pwndActive == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || pwndActive != pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>) {
13017             <span class="keywordflow">if</span> (pwndActive == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || <a class="code" href="../../d4/d1/userk_8h.html#a745">IsWndImeRelated</a>(pwndActive) || ptiImeWnd != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndActive)) {
13018                 <span class="comment">/*</span>
13019 <span class="comment">                 * We should avoid improper window to be an owner of IME window.</span>
13020 <span class="comment">                 */</span>
13021                 <a class="code" href="../../d4/d1/userk_8h.html#a2055">ImeSetFutureOwner</a>(pwnd, pwnd-&gt;spwndOwner);
13022             }
13023             <span class="keywordflow">else</span> {
13024                 <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pwnd-&gt;spwndOwner, pwndActive);
13025             }
13026             <a class="code" href="../../d4/d1/userk_8h.html#a2054">ImeCheckTopmost</a>(pwnd);
13027         }
13028     }
13029 
13030     retval = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
13031 
13032     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetImeNewOwner"</span>);
13033     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a17">ENDATOMICRECV_HWND</a>();
13034 }
13035 
13036 
<a name="l13037"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a399">13037</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a399">NtUserSetThreadLayoutHandles</a>(
13038     IN HKL hklNew,
13039     IN HKL hklOld)
13040 {
13041     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
13042     <a class="code" href="../../d4/d9/structtagKL.html">PKL</a>         pklNew;
13043 
13044     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a12">BEGINRECV_VOID</a>();
13045 
13046     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
13047 
13048     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a> != hklOld)
13049         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a43">MSGERROR_VOID</a>();
13050 
13051     <span class="keywordflow">if</span> ((pklNew = <a class="code" href="../../d4/d1/userk_8h.html#a1019">HKLtoPKL</a>(ptiCurrent, hklNew)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
13052         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a43">MSGERROR_VOID</a>();
13053 
13054     <span class="comment">/*</span>
13055 <span class="comment">     * hklPrev is only used for IME, non-IME toggle hotkey.</span>
13056 <span class="comment">     * The purpose we remember hklPrev is to jump from</span>
13057 <span class="comment">     * non-IME keyboard layout to the most recently used</span>
13058 <span class="comment">     * IME layout, or to jump from an IME layout to</span>
13059 <span class="comment">     * the most recently used non-IME layout. Therefore</span>
13060 <span class="comment">     * piti-&gt;hklPrev is updated only when [ IME -&gt; non-IME ]</span>
13061 <span class="comment">     * or [ non-IME -&gt; IME ] transition is happened.</span>
13062 <span class="comment">     */</span>
13063     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/conimep_8h.html#a49">IS_IME_KBDLAYOUT</a>(hklNew) ^ <a class="code" href="../../d4/d5/conimep_8h.html#a49">IS_IME_KBDLAYOUT</a>(hklOld))
13064         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o41">hklPrev</a> = hklOld;
13065 
13066     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>, pklNew);
13067 
13068     <a class="code" href="../../d4/d1/userk_8h.html#a94">TRACEVOID</a>(<span class="stringliteral">"NtUserSetThreadLayoutHandles"</span>);
13069     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a13">ENDRECV_VOID</a>();
13070 }
13071 
<a name="l13072"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a400">13072</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a400">NtUserNotifyIMEStatus</a>(
13073     IN HWND hwnd,
13074     IN DWORD dwOpen,
13075     IN DWORD dwConversion)
13076 {
13077     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a30">BEGINRECV_HWNDLOCK_VOID</a>(hwnd);
13078 
13079     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a74">ValidateIMMEnabledVOID</a>();
13080 
13081     <a class="code" href="../../d4/d1/userk_8h.html#a2059">xxxNotifyIMEStatus</a>( pwnd, dwOpen, dwConversion );
13082 
13083     <a class="code" href="../../d4/d1/userk_8h.html#a94">TRACEVOID</a>(<span class="stringliteral">"NtUserNotifyIMEStatus"</span>);
13084     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a41">ENDRECV_HWNDLOCK_VOID</a>()
13085 }
13086 
<a name="l13087"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a401">13087</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a401">NtUserDisableThreadIme</a>(
13088     IN DWORD dwThreadId)
13089 {
13090     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent, pti;
13091 
13092     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
13093 
13094     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a73">ValidateIMMEnabled</a>();
13095 
13096     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
13097 
13098     <span class="keywordflow">if</span> (dwThreadId == -1) {
13099         <span class="comment">// IME processing is disabled for all the thread in the current process</span>
13100         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;W32PF_Flags |= W32PF_DISABLEIME;
13101         <span class="comment">// destory IME stuff</span>
13102         pti = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o1">ptiList</a>;
13103         <span class="keywordflow">while</span> (pti) {
13104             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a817">TIF_DISABLEIME</a>;
13105             <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o39">spwndDefaultIme</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
13106                 <a class="code" href="../../d4/d1/userk_8h.html#a1575">xxxDestroyWindow</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o39">spwndDefaultIme</a>);
13107                 <span class="comment">// Start the search over from beginning</span>
13108                 <span class="comment">// Since the ptilist may be updated</span>
13109                 pti = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o1">ptiList</a>;
13110                 <span class="keywordflow">continue</span>;
13111             }
13112             pti = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o29">ptiSibling</a>;
13113         }
13114     } <span class="keywordflow">else</span> {
13115         <span class="keywordflow">if</span> (dwThreadId == 0) {
13116             pti = ptiCurrent;
13117         }
13118         <span class="keywordflow">else</span> {
13119             pti = <a class="code" href="../../d4/d1/userk_8h.html#a1201">PtiFromThreadId</a>(dwThreadId);
13120             <span class="keywordflow">if</span> (pti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>)
13121                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
13122         }
13123         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a817">TIF_DISABLEIME</a>;
13124         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o39">spwndDefaultIme</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
13125             <a class="code" href="../../d4/d1/userk_8h.html#a1575">xxxDestroyWindow</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o39">spwndDefaultIme</a>);
13126         }
13127 
13128     }
13129 
13130     retval = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
13131 
13132     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserDisableThreadIme"</span>);
13133     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
13134 }
13135 
13136 
13137 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l13138"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a402">13138</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a402">NtUserEnumDisplayMonitors</a>(  <span class="comment">// API EnumDisplayMonitors</span>
13139     IN HDC             hdc,
13140     IN LPCRECT         lprcClip,
13141     IN MONITORENUMPROC lpfnEnum,
13142     IN LPARAM          dwData)
13143 {
13144     RECT    rc;
13145     LPRECT  lprc = (LPRECT) lprcClip;
13146 
13147     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
13148 
13149     <span class="comment">/*</span>
13150 <span class="comment">     * Probe arguments</span>
13151 <span class="comment">     */</span>
13152     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(lprc)) {
13153         <span class="keywordflow">try</span> {
13154             rc = <a class="code" href="../../d4/d1/userk_8h.html#a31">ProbeAndReadRect</a>(lprc);
13155             lprc = &amp;rc;
13156         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
13157             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
13158         }
13159     }
13160 
13161     retval = <a class="code" href="../../d4/d1/userk_8h.html#a2076">xxxEnumDisplayMonitors</a>(
13162             hdc,
13163             lprc,
13164             lpfnEnum,
13165             dwData,
13166             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
13167 
13168     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserEnumDisplayMonitors"</span>);
13169     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
13170 }
13171 
13172 <span class="comment">/*</span>
13173 <span class="comment"> * NtUserQueryUserCounters() retrieves statistics on win32k</span>
13174 <span class="comment"> * QUERYUSER_TYPE_USER retrieves the handle counters</span>
13175 <span class="comment"> * QUERYUSER_TYPE_CS will fill the result buffer with USER critical section usage data</span>
13176 <span class="comment"> */</span>
13177 
13178 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l13179"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a403">13179</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a403">NtUserQueryUserCounters</a>(  <span class="comment">// private QueryUserCounters</span>
13180     IN  DWORD       dwQueryType,
13181     IN  LPVOID      pvIn,
13182     IN  DWORD       dwInSize,
13183     OUT LPVOID      pvResult,
13184     IN  DWORD       dwOutSize)
13185 {
13186     PDWORD  pdwInternalIn = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
13187     PDWORD  pdwInternalResult = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
13188 
13189     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
13190 
13191 <span class="preprocessor">#if defined (USER_PERFORMANCE)</span>
13192 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (dwQueryType == QUERYUSER_CS) {
13193         <a class="code" href="../../d5/d8/struct__tagCSStatistics.html">CSSTATISTICS</a>* pcsData;
13194 
13195         <span class="keywordflow">if</span> (dwOutSize != <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d8/struct__tagCSStatistics.html">CSSTATISTICS</a>)) {
13196             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
13197         }
13198         <span class="keywordflow">try</span> {
13199             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>((PDWORD)pvResult, dwOutSize, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
13200 
13201             <span class="comment">/*</span>
13202 <span class="comment">             * Checking for overflow on these counters is caller responsability</span>
13203 <span class="comment">             */</span>
13204             pcsData = (<a class="code" href="../../d5/d8/struct__tagCSStatistics.html">CSSTATISTICS</a>*)pvResult;
13205             pcsData-&gt;<a class="code" href="../../d5/d8/struct__tagCSStatistics.html#o0">cExclusive</a>       = gCSStatistics.cExclusive;
13206             pcsData-&gt;<a class="code" href="../../d5/d8/struct__tagCSStatistics.html#o1">cShared</a>          = gCSStatistics.cShared;
13207             pcsData-&gt;<a class="code" href="../../d5/d8/struct__tagCSStatistics.html#o2">i64TimeExclusive</a> = gCSStatistics.i64TimeExclusive;
13208 
13209         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
13210             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
13211         }
13212         retval = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
13213         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a43">MSGERROR_VOID</a>();
13214     }
13215     <span class="keywordflow">else</span>
13216 <span class="preprocessor">#endif // USER_PERFORMANCE</span>
13217 <span class="preprocessor"></span>
13218     <span class="keywordflow">if</span> (dwQueryType == QUERYUSER_HANDLES) {
13219 
13220         <span class="comment">/*</span>
13221 <span class="comment">         * Probe arguments, dwInSize should be multiple of 4</span>
13222 <span class="comment">         */</span>
13223         <span class="keywordflow">if</span> (dwInSize &amp; (<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1) ||
13224             dwOutSize != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a254">TYPE_CTYPES</a>*dwInSize) {
13225 
13226             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0)
13227         }
13228 
13229         <span class="keywordflow">try</span> {
13230             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>((PDWORD)pvIn, dwInSize, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
13231             pdwInternalIn = UserAllocPoolWithQuota(dwInSize, TAG_SYSTEM);
13232             <span class="keywordflow">if</span> (!pdwInternalIn) {
13233                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_NO_MEMORY);
13234             }
13235             RtlCopyMemory(pdwInternalIn, pvIn, dwInSize);
13236 
13237             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(pvResult, dwOutSize, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
13238             pdwInternalResult = UserAllocPoolWithQuota(dwOutSize, TAG_SYSTEM);
13239             <span class="keywordflow">if</span> (!pdwInternalResult) {
13240                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_NO_MEMORY);
13241             }
13242 
13243         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
13244                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
13245         }
13246 
13247         <a class="code" href="../../d4/d1/userk_8h.html#a2084">_QueryUserHandles</a>(pdwInternalIn,
13248                 dwInSize/<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>),
13249                 (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> (*)[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a254">TYPE_CTYPES</a>])pdwInternalResult);
13250         retval = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
13251 
13252         <span class="keywordflow">try</span> {
13253             RtlCopyMemory(pvResult, pdwInternalResult, dwOutSize);
13254 
13255         } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
13256                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a44">MSGERRORCLEANUP</a>(0);
13257         }
13258     }
13259 
13260     <span class="keywordflow">else</span> {
13261 
13262        <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
13263     }
13264 
13265     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a33">CLEANUPRECV</a>();
13266     <span class="keywordflow">if</span> (pdwInternalIn) {
13267         UserFreePool(pdwInternalIn);
13268     }
13269     <span class="keywordflow">if</span> (pdwInternalResult) {
13270         UserFreePool(pdwInternalResult);
13271     }
13272 
13273     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserQueryCounters"</span>);
13274     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
13275 }
13276 
13277 
13278 <span class="comment">/***************************************************************************\</span>
13279 <span class="comment">* NtUserINOUTGETMENUINFO</span>
13280 <span class="comment">*</span>
13281 <span class="comment">* History:</span>
13282 <span class="comment">*  11-12-96 GerardoB - Created</span>
13283 <span class="comment">\***************************************************************************/</span>
<a name="l13284"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a404">13284</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(INOUTMENUGETOBJECT)
13285 {
13286     MENUGETOBJECTINFO mgoi;
13287     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a49">BEGINRECV_MESSAGECALL</a>(0);
13288     <a class="code" href="../../d4/d1/userk_8h.html#a95">TRACETHUNK</a>(<span class="stringliteral">"fnINOUTMENUGETOBJECT"</span>);
13289 
13290     UNREFERENCED_PARAMETER(bAnsi);
13291 
13292     <span class="keywordflow">try</span> {
13293         <span class="comment">/*</span>
13294 <span class="comment">         * Capture now so xxxInterSendMsgEx won't have to.</span>
13295 <span class="comment">         */</span>
13296         mgoi = <a class="code" href="../../d4/d1/userk_8h.html#a89">ProbeAndReadMenuGetObjectInfo</a>((PMENUGETOBJECTINFO)lParam);
13297 
13298     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
13299         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
13300     }
13301     retval = <a class="code" href="../../d6/d0/usercli_8h.html#a17">CALLPROC</a>(xpfnProc)(
13302                 pwnd,
13303                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
13304                 wParam,
13305                 (LPARAM)&amp;mgoi,
13306                 xParam);
13307 
13308     <span class="keywordflow">try</span> {
13309         *((PMENUGETOBJECTINFO)lParam) = mgoi;
13310 
13311     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
13312     }
13313 
13314     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"fnINOUTMENUGETOBJECT"</span>);
13315     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a50">ENDRECV_MESSAGECALL</a>();
13316 }
13317 
13318 <span class="comment">/***************************************************************************\</span>
13319 <span class="comment">* NtUserFlashWindowEx</span>
13320 <span class="comment">*</span>
13321 <span class="comment">* History:</span>
13322 <span class="comment">*  11-16-96 MCostea - Created</span>
13323 <span class="comment">\***************************************************************************/</span>
13324 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l13325"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a405">13325</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a405">NtUserFlashWindowEx</a>(  <span class="comment">// API FlashWindowEx</span>
13326     IN PFLASHWINFO pfwi)
13327 {
13328     FLASHWINFO fwiInternal;
13329     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
13330     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
13331 
13332     <a class="code" href="../../d5/d8/crecv_8c.html#a4">BEGINRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
13333     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a1">DBG_THREADLOCK_START</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a37">FlashWindowEx</a>);
13334 
13335     <span class="comment">/*</span>
13336 <span class="comment">     * Probe arguments</span>
13337 <span class="comment">     */</span>
13338     <span class="keywordflow">try</span> {
13339         fwiInternal = <a class="code" href="../../d5/d8/ex_8h.html#a27">ProbeAndReadStructure</a>(pfwi, FLASHWINFO);
13340 
13341     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
13342         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
13343     }
13344 
13345     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(fwiInternal.hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
13346         fwiInternal.cbSize != <span class="keyword">sizeof</span>(FLASHWINFO) ||
13347         fwiInternal.dwFlags &amp; ~FLASHW_VALID) {
13348 
13349         RIPMSG0(RIP_WARNING, <span class="stringliteral">"NtUserFlashWindowEx: Invalid Parameter"</span>);
13350         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(ERROR_INVALID_PARAMETER);
13351     }
13352     <span class="keywordflow">else</span> {
13353         <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), pwnd, &amp;tlpwnd);
13354         retval = <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a2">xxxFlashWindow</a>(pwnd,
13355                             MAKELONG(fwiInternal.dwFlags, fwiInternal.uCount),
13356                             fwiInternal.dwTimeout);
13357         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
13358     }
13359 
13360     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a2">DBG_THREADLOCK_END</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a37">FlashWindowEx</a>);
13361 
13362     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserFlashWindowEx"</span>);
13363     <a class="code" href="../../d5/d8/crecv_8c.html#a6">ENDRECV</a>();
13364 }
13365 
<a name="l13366"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a406">13366</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a406">NtUserUpdateLayeredWindow</a>(  <span class="comment">// API UpdateLayeredWindow</span>
13367     IN HWND hwnd,
13368     IN HDC hdcDst,
13369     IN POINT *pptDst,
13370     IN SIZE *psize,
13371     IN HDC hdcSrc,
13372     IN POINT *pptSrc,
13373     IN COLORREF crKey,
13374     IN BLENDFUNCTION *pblend,
13375     IN DWORD dwFlags)
13376 {
13377     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
13378     POINT ptSrc;
13379     SIZE size;
13380     POINT ptDst;
13381     BLENDFUNCTION blend;
13382 
13383     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
13384 
13385     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a55">ValidateHWND</a>(pwnd, hwnd);
13386 
13387     <span class="comment">/*</span>
13388 <span class="comment">     * Probe and validate arguments.</span>
13389 <span class="comment">     */</span>
13390     <span class="keywordflow">try</span> {
13391         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(pptSrc)) {
13392             ptSrc = <a class="code" href="../../d4/d1/userk_8h.html#a29">ProbeAndReadPoint</a>(pptSrc);
13393             pptSrc = &amp;ptSrc;
13394         }
13395         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(psize)) {
13396             size = <a class="code" href="../../d4/d1/userk_8h.html#a26">ProbeAndReadSize</a>(psize);
13397             psize = &amp;size;
13398             <span class="keywordflow">if</span> (psize-&gt;cx &lt; 0 || psize-&gt;cy &lt; 0) {
13399                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(ERROR_INVALID_PARAMETER);  <span class="comment">// this is a jump out of try!</span>
13400             }
13401         }
13402         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(pptDst)) {
13403             ptDst = <a class="code" href="../../d4/d1/userk_8h.html#a29">ProbeAndReadPoint</a>(pptDst);
13404             pptDst = &amp;ptDst;
13405         }
13406 
13407         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(pblend)) {
13408             blend = <a class="code" href="../../d4/d1/userk_8h.html#a27">ProbeAndReadBlendfunction</a>(pblend);
13409             pblend = &amp;blend;
13410         }
13411     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
13412         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(0);
13413     }
13414 
13415     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; ~ULW_VALID) {
13416         RIPMSG0(RIP_WARNING, <span class="stringliteral">"UpdateLayeredWindow: Invalid Parameter"</span>);
13417         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(ERROR_INVALID_PARAMETER);
13418     } <span class="keywordflow">else</span> {
13419         retval = <a class="code" href="../../d4/d1/userk_8h.html#a1987">_UpdateLayeredWindow</a>(
13420                 pwnd,
13421                 hdcDst,
13422                 pptDst,
13423                 psize,
13424                 hdcSrc,
13425                 pptSrc,
13426                 crKey,
13427                 pblend,
13428                 <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
13429     }
13430 
13431     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserUpdateLayeredWindow"</span>);
13432     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
13433 }
13434 
<a name="l13435"></a><a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a407">13435</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a407">NtUserSetLayeredWindowAttributes</a>(
13436     IN HWND hwnd,
13437     IN COLORREF crKey,
13438     IN BYTE bAlpha,
13439     IN DWORD dwFlags)
13440 {
13441     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
13442 
13443     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a5">BEGINATOMICRECV</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
13444 
13445     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a55">ValidateHWND</a>(pwnd, hwnd);
13446 
13447     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; ~LWA_VALID) {
13448         RIPMSG0(RIP_WARNING, <span class="stringliteral">"SetLayeredWindowAttributes: Invalid Parameter"</span>);
13449         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>(ERROR_INVALID_PARAMETER);
13450     } <span class="keywordflow">else</span> {
13451         retval = <a class="code" href="../../d4/d1/userk_8h.html#a1988">_SetLayeredWindowAttributes</a>(pwnd, crKey, bAlpha, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
13452     }
13453 
13454     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>(<span class="stringliteral">"NtUserSetLayeredWindowAttributes"</span>);
13455     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a6">ENDATOMICRECV</a>();
13456 }
13457 
13458 <span class="comment">/***************************************************************************\</span>
13459 <span class="comment">* GetHDevName</span>
13460 <span class="comment">* Called by NtUserCallTwoParam in GetMonitorInfo to query</span>
13461 <span class="comment">* gre about the HDev name</span>
13462 <span class="comment">*</span>
13463 <span class="comment">* 1-July-1998    MCostea      created</span>
13464 <span class="comment">\***************************************************************************/</span>
<a name="l13465"></a><a class="code" href="../../d4/d1/userk_8h.html#a2080">13465</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a2080">GetHDevName</a>(HMONITOR hMon, PWCHAR pName)
13466 {
13467     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a> pMonitor;
13468 
13469     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
13470 
13471     pMonitor = <a class="code" href="../../d7/d3/validate_8c.html#a10">ValidateHmonitor</a>(hMon);
13472     <span class="keywordflow">if</span> (!pMonitor) {
13473         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
13474     }
13475 
13476     <span class="keywordflow">try</span> {
13477         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(pName, CCHDEVICENAME*<span class="keyword">sizeof</span>(WCHAR), <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
13478     } except (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a45">StubExceptionHandler</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
13479         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
13480     }
13481     <span class="keywordflow">return</span> DrvGetHdevName(pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o8">hDev</a>, pName);
13482 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:04 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
