<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: rmlogon.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>rmlogon.c</h1><a href="../../d9/d9/rmlogon_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    rmlogon.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the kernel mode logon tracking performed by the</span>
00012 <span class="comment">    reference monitor.  Logon tracking is performed by keeping a count of</span>
00013 <span class="comment">    how many tokens exist for each active logon in a system.  When a logon</span>
00014 <span class="comment">    session's reference count drops to zero, the LSA is notified so that</span>
00015 <span class="comment">    authentication packages can clean up any related context data.</span>
00016 <span class="comment"></span>
00017 <span class="comment"></span>
00018 <span class="comment">Author:</span>
00019 <span class="comment"></span>
00020 <span class="comment">     Jim Kelly (JimK) 21-April-1991</span>
00021 <span class="comment"></span>
00022 <span class="comment">Environment:</span>
00023 <span class="comment"></span>
00024 <span class="comment">     Kernel mode only.</span>
00025 <span class="comment"></span>
00026 <span class="comment">Revision History:</span>
00027 <span class="comment"></span>
00028 <span class="comment">--*/</span>
00029 
00030 <span class="comment">//#define SEP_TRACK_LOGON_SESSION_REFS</span>
00031 
00032 
00033 <span class="preprocessor">#include "<a class="code" href="../../d1/d0/rmp_8h.html">rmp.h</a>"</span>
00034 <span class="preprocessor">#include &lt;bugcodes.h&gt;</span>
00035 
00036 
00037 <a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html">SEP_LOGON_SESSION_TERMINATED_NOTIFICATION</a>
<a name="l00038"></a><a class="code" href="../../d9/d9/rmlogon_8c.html#a1">00038</a> <a class="code" href="../../d9/d9/rmlogon_8c.html#a1">SeFileSystemNotifyRoutinesHead</a> = {0};
00039 
00040 
00042 <span class="comment">//                                                                        //</span>
00043 <span class="comment">// Internally defined data types                                          //</span>
00044 <span class="comment">//                                                                        //</span>
00046 <span class="comment"></span>
<a name="l00047"></a><a class="code" href="../../d5/d1/struct__SEP__FILE__SYSTEM__NOTIFY__CONTEXT.html">00047</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d5/d1/struct__SEP__FILE__SYSTEM__NOTIFY__CONTEXT.html">_SEP_FILE_SYSTEM_NOTIFY_CONTEXT</a> {
<a name="l00048"></a><a class="code" href="../../d5/d1/struct__SEP__FILE__SYSTEM__NOTIFY__CONTEXT.html#o0">00048</a>     <a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">WORK_QUEUE_ITEM</a> <a class="code" href="../../d5/d1/struct__SEP__FILE__SYSTEM__NOTIFY__CONTEXT.html#o0">WorkItem</a>;
<a name="l00049"></a><a class="code" href="../../d5/d1/struct__SEP__FILE__SYSTEM__NOTIFY__CONTEXT.html#o1">00049</a>     LUID <a class="code" href="../../d5/d1/struct__SEP__FILE__SYSTEM__NOTIFY__CONTEXT.html#o1">LogonId</a>;
00050 } <a class="code" href="../../d5/d1/struct__SEP__FILE__SYSTEM__NOTIFY__CONTEXT.html">SEP_FILE_SYSTEM_NOTIFY_CONTEXT</a>, *<a class="code" href="../../d5/d1/struct__SEP__FILE__SYSTEM__NOTIFY__CONTEXT.html">PSEP_FILE_SYSTEM_NOTIFY_CONTEXT</a>;
00051 
00052 
00054 <span class="comment">//                                                                        //</span>
00055 <span class="comment">// Internally defined routines                                            //</span>
00056 <span class="comment">//                                                                        //</span>
00058 <span class="comment"></span>
00059 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00060 <a class="code" href="../../d9/d9/rmlogon_8c.html#a4">SepGetLogonSessionTrack</a>(
00061     IN PLUID LogonId
00062     );
00063 
00064 
00065 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00066 <a class="code" href="../../d9/d9/rmlogon_8c.html#a5">SepInformLsaOfDeletedLogon</a>(
00067     IN PLUID LogonId
00068     );
00069 
00070 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00071 <a class="code" href="../../d9/d9/rmlogon_8c.html#a6">SepInformFileSystemsOfDeletedLogon</a>(
00072     IN PLUID LogonId
00073     );
00074 
00075 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00076 <a class="code" href="../../d9/d9/rmlogon_8c.html#a7">SepNotifyFileSystems</a>(
00077     IN PVOID Context
00078     );
00079 
00080 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00081 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeRegisterLogonSessionTerminatedRoutine)</span>
00082 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeUnregisterLogonSessionTerminatedRoutine)</span>
00083 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeMarkLogonSessionForTerminationNotification)</span>
00084 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepRmCreateLogonSessionWrkr)</span>
00085 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepRmDeleteLogonSessionWrkr)</span>
00086 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepReferenceLogonSession)</span>
00087 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepDeReferenceLogonSession)</span>
00088 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepCreateLogonSessionTrack)</span>
00089 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepDeleteLogonSessionTrack)</span>
00090 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepInformLsaOfDeletedLogon)</span>
00091 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepInformFileSystemsOfDeletedLogon)</span>
00092 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepNotifyFileSystems)</span>
00093 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00094 <span class="preprocessor"></span>
00095 
00096 
00098 <span class="comment">//                                                                        //</span>
00099 <span class="comment">// Local macros                                                           //</span>
00100 <span class="comment">//                                                                        //</span>
00102 <span class="comment"></span>
00103 
00104 <span class="comment">//</span>
00105 <span class="comment">// This macro is used to obtain an index into the logon session tracking</span>
00106 <span class="comment">// array given a logon session ID (a LUID).</span>
00107 <span class="comment">//</span>
00108 
<a name="l00109"></a><a class="code" href="../../d9/d9/rmlogon_8c.html#a0">00109</a> <span class="preprocessor">#define SepLogonSessionIndex( PLogonId ) (                                    \</span>
00110 <span class="preprocessor">     (PLogonId)-&gt;LowPart &amp; SEP_LOGON_TRACK_INDEX_MASK                         \</span>
00111 <span class="preprocessor">     )</span>
00112 <span class="preprocessor"></span>
00113 
00114 
00116 <span class="comment">//                                                                        //</span>
00117 <span class="comment">// Exported Services                                                      //</span>
00118 <span class="comment">//                                                                        //</span>
00120 <span class="comment"></span>
00121 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00122"></a><a class="code" href="../../d1/d0/rmp_8h.html#a29">00122</a> <a class="code" href="../../d1/d0/rmp_8h.html#a29">SepRmCreateLogonSessionWrkr</a>(
00123     IN PRM_COMMAND_MESSAGE CommandMessage,
00124     OUT PRM_REPLY_MESSAGE ReplyMessage
00125     )
00126 
00127 <span class="comment">/*++</span>
00128 <span class="comment"></span>
00129 <span class="comment">Routine Description:</span>
00130 <span class="comment"></span>
00131 <span class="comment">    This function is the dispatch routine for the LSA --&gt; RM</span>
00132 <span class="comment">    "CreateLogonSession" call.</span>
00133 <span class="comment"></span>
00134 <span class="comment">    The arguments passed to this routine are defined by the</span>
00135 <span class="comment">    type SEP_RM_COMMAND_WORKER.</span>
00136 <span class="comment"></span>
00137 <span class="comment"></span>
00138 <span class="comment">Arguments:</span>
00139 <span class="comment"></span>
00140 <span class="comment">    CommandMessage - Points to structure containing RM command message</span>
00141 <span class="comment">        information consisting of an LPC PORT_MESSAGE structure followed</span>
00142 <span class="comment">        by the command number (RmComponentTestCommand) and a command-specific</span>
00143 <span class="comment">        body.  The command-specific body of this parameter is a LUID of the</span>
00144 <span class="comment">        logon session to be created.</span>
00145 <span class="comment"></span>
00146 <span class="comment">    ReplyMessage - Pointer to structure containing LSA reply message</span>
00147 <span class="comment">        information consisting of an LPC PORT_MESSAGE structure followed</span>
00148 <span class="comment">        by the command ReturnedStatus field in which a status code from the</span>
00149 <span class="comment">        command will be returned.</span>
00150 <span class="comment"></span>
00151 <span class="comment">Return Value:</span>
00152 <span class="comment"></span>
00153 <span class="comment">    VOID</span>
00154 <span class="comment"></span>
00155 <span class="comment">--*/</span>
00156 
00157 {
00158 
00159     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00160     LUID LogonId;
00161 
00162     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00163 
00164     <span class="comment">//</span>
00165     <span class="comment">// Check that command is expected type</span>
00166     <span class="comment">//</span>
00167 
00168     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( CommandMessage-&gt;CommandNumber == RmCreateLogonSession );
00169 
00170 
00171     <span class="comment">//</span>
00172     <span class="comment">// Typecast the command parameter to what we expect.</span>
00173     <span class="comment">//</span>
00174 
00175     LogonId = *((LUID UNALIGNED *) CommandMessage-&gt;CommandParams);
00176 
00177 
00178 
00179     <span class="comment">//</span>
00180     <span class="comment">// Try to create the logon session tracking record</span>
00181     <span class="comment">//</span>
00182 
00183     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d0/rmp_8h.html#a31">SepCreateLogonSessionTrack</a>( &amp;LogonId );
00184 
00185 
00186 
00187     <span class="comment">//</span>
00188     <span class="comment">// Set the reply status</span>
00189     <span class="comment">//</span>
00190 
00191     <a class="code" href="../../d3/d8/client_8c.html#a125">ReplyMessage</a>-&gt;ReturnedStatus = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00192 
00193 
00194     <span class="keywordflow">return</span>;
00195 }
00196 
00197 
00198 
00199 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00200"></a><a class="code" href="../../d1/d0/rmp_8h.html#a30">00200</a> <a class="code" href="../../d1/d0/rmp_8h.html#a30">SepRmDeleteLogonSessionWrkr</a>(
00201     IN PRM_COMMAND_MESSAGE CommandMessage,
00202     OUT PRM_REPLY_MESSAGE ReplyMessage
00203     )
00204 
00205 <span class="comment">/*++</span>
00206 <span class="comment"></span>
00207 <span class="comment">Routine Description:</span>
00208 <span class="comment"></span>
00209 <span class="comment">    This function is the dispatch routine for the LSA --&gt; RM</span>
00210 <span class="comment">    "DeleteLogonSession" call.</span>
00211 <span class="comment"></span>
00212 <span class="comment">    The arguments passed to this routine are defined by the</span>
00213 <span class="comment">    type SEP_RM_COMMAND_WORKER.</span>
00214 <span class="comment"></span>
00215 <span class="comment"></span>
00216 <span class="comment">Arguments:</span>
00217 <span class="comment"></span>
00218 <span class="comment">    CommandMessage - Points to structure containing RM command message</span>
00219 <span class="comment">        information consisting of an LPC PORT_MESSAGE structure followed</span>
00220 <span class="comment">        by the command number (RmComponentTestCommand) and a command-specific</span>
00221 <span class="comment">        body.  The command-specific body of this parameter is a LUID of the</span>
00222 <span class="comment">        logon session to be created.</span>
00223 <span class="comment"></span>
00224 <span class="comment">    ReplyMessage - Pointer to structure containing LSA reply message</span>
00225 <span class="comment">        information consisting of an LPC PORT_MESSAGE structure followed</span>
00226 <span class="comment">        by the command ReturnedStatus field in which a status code from the</span>
00227 <span class="comment">        command will be returned.</span>
00228 <span class="comment"></span>
00229 <span class="comment">Return Value:</span>
00230 <span class="comment"></span>
00231 <span class="comment">    VOID</span>
00232 <span class="comment"></span>
00233 <span class="comment">--*/</span>
00234 
00235 {
00236 
00237     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00238     LUID LogonId;
00239 
00240     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00241 
00242     <span class="comment">//</span>
00243     <span class="comment">// Check that command is expected type</span>
00244     <span class="comment">//</span>
00245 
00246     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( CommandMessage-&gt;CommandNumber == RmDeleteLogonSession );
00247 
00248 
00249     <span class="comment">//</span>
00250     <span class="comment">// Typecast the command parameter to what we expect.</span>
00251     <span class="comment">//</span>
00252 
00253     LogonId = *((LUID UNALIGNED *) CommandMessage-&gt;CommandParams);
00254 
00255 
00256 
00257     <span class="comment">//</span>
00258     <span class="comment">// Try to create the logon session tracking record</span>
00259     <span class="comment">//</span>
00260 
00261     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d0/rmp_8h.html#a32">SepDeleteLogonSessionTrack</a>( &amp;LogonId );
00262 
00263 
00264 
00265     <span class="comment">//</span>
00266     <span class="comment">// Set the reply status</span>
00267     <span class="comment">//</span>
00268 
00269     <a class="code" href="../../d3/d8/client_8c.html#a125">ReplyMessage</a>-&gt;ReturnedStatus = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00270 
00271 
00272     <span class="keywordflow">return</span>;
00273 }
00274 
00275 
00276 
00277 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00278"></a><a class="code" href="../../d6/d6/sep_8h.html#a40">00278</a> <a class="code" href="../../d6/d6/sep_8h.html#a40">SepReferenceLogonSession</a>(
00279     IN PLUID LogonId
00280     )
00281 
00282 <span class="comment">/*++</span>
00283 <span class="comment"></span>
00284 <span class="comment">Routine Description:</span>
00285 <span class="comment"></span>
00286 <span class="comment">    This routine increments the reference count of a logon session</span>
00287 <span class="comment">    tracking record.</span>
00288 <span class="comment"></span>
00289 <span class="comment"></span>
00290 <span class="comment"></span>
00291 <span class="comment">Arguments:</span>
00292 <span class="comment"></span>
00293 <span class="comment">    LogonId - Pointer to the logon session ID whose logon track is</span>
00294 <span class="comment">        to be incremented.</span>
00295 <span class="comment"></span>
00296 <span class="comment">Return Value:</span>
00297 <span class="comment"></span>
00298 <span class="comment">    STATUS_SUCCESS - The reference count was successfully incremented.</span>
00299 <span class="comment"></span>
00300 <span class="comment">    STATUS_NO_SUCH_LOGON_SESSION - The specified logon session doesn't</span>
00301 <span class="comment">        exist in the reference monitor's database.</span>
00302 <span class="comment"></span>
00303 <span class="comment">--*/</span>
00304 
00305 {
00306 
00307     ULONG SessionArrayIndex;
00308     <a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html">PSEP_LOGON_SESSION_REFERENCES</a> Previous, Current;
00309 
00310 <span class="preprocessor">#ifdef SEP_TRACK_LOGON_SESSION_REFS</span>
00311 <span class="preprocessor"></span>    ULONG Refs;
00312 <span class="preprocessor">#endif //SEP_TRACK_LOGON_SESSION_REFS</span>
00313 <span class="preprocessor"></span>
00314     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00315 
00316     SessionArrayIndex = <a class="code" href="../../d9/d9/rmlogon_8c.html#a0">SepLogonSessionIndex</a>( LogonId );
00317 
00318     <span class="comment">//</span>
00319     <span class="comment">// Protect modification of reference monitor database</span>
00320     <span class="comment">//</span>
00321 
00322     <a class="code" href="../../d1/d0/rmp_8h.html#a3">SepRmAcquireDbWriteLock</a>();
00323 
00324 
00325     <span class="comment">//</span>
00326     <span class="comment">// Now walk the list for our logon session array hash index.</span>
00327     <span class="comment">//</span>
00328 
00329     Previous = (<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html">PSEP_LOGON_SESSION_REFERENCES</a>)
00330                ((PVOID)&amp;<a class="code" href="../../d1/d0/rmp_8h.html#a22">SepLogonSessions</a>[ SessionArrayIndex ]);
00331     Current = Previous-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o0">Next</a>;
00332 
00333     <span class="keywordflow">while</span> (Current != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00334 
00335         <span class="comment">//</span>
00336         <span class="comment">// If we found it, increment the reference count and return</span>
00337         <span class="comment">//</span>
00338 
00339         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>( LogonId, &amp;Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o1">LogonId</a>) ) {
00340 <span class="preprocessor">#ifdef SEP_TRACK_LOGON_SESSION_REFS</span>
00341 <span class="preprocessor"></span>             ULONG Refs;
00342 <span class="preprocessor">#endif //SEP_TRACK_LOGON_SESSION_REFS</span>
00343 <span class="preprocessor"></span>
00344              Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o2">ReferenceCount</a> += 1;
00345 
00346 <span class="preprocessor">#ifdef SEP_TRACK_LOGON_SESSION_REFS</span>
00347 <span class="preprocessor"></span>             Refs = Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o2">ReferenceCount</a>;
00348 <span class="preprocessor">#endif //SEP_TRACK_LOGON_SESSION_REFS</span>
00349 <span class="preprocessor"></span>
00350              <a class="code" href="../../d1/d0/rmp_8h.html#a5">SepRmReleaseDbWriteLock</a>();
00351 
00352 <span class="preprocessor">#ifdef SEP_TRACK_LOGON_SESSION_REFS</span>
00353 <span class="preprocessor"></span>             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"SE (rm): ++ logon session: (%d, %d) to %d by (%d, %d)\n"</span>,
00354                       LogonId-&gt;HighPart, LogonId-&gt;LowPart, Refs,
00355                       <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueProcess,
00356                       <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueThread);
00357 
00358 <span class="preprocessor">#endif //SEP_TRACK_LOGON_SESSION_REFS</span>
00359 <span class="preprocessor"></span>             <span class="keywordflow">return</span> STATUS_SUCCESS;
00360         }
00361 
00362         Previous = Current;
00363         Current = Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o0">Next</a>;
00364     }
00365 
00366     <a class="code" href="../../d1/d0/rmp_8h.html#a5">SepRmReleaseDbWriteLock</a>();
00367 
00368     <span class="comment">//</span>
00369     <span class="comment">// Bad news, someone asked us to increment the reference count of</span>
00370     <span class="comment">// a logon session we didn't know existed.  This might be a new</span>
00371     <span class="comment">// token being created, so return an error status and let the caller</span>
00372     <span class="comment">// decide if it warrants a bug check or not.</span>
00373     <span class="comment">//</span>
00374 
00375 
00376     <span class="keywordflow">return</span> STATUS_NO_SUCH_LOGON_SESSION;
00377 
00378 
00379 
00380 }
00381 
00382 
00383 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00384"></a><a class="code" href="../../d6/d6/sep_8h.html#a41">00384</a> <a class="code" href="../../d6/d6/sep_8h.html#a41">SepDeReferenceLogonSession</a>(
00385     IN PLUID LogonId
00386     )
00387 
00388 <span class="comment">/*++</span>
00389 <span class="comment"></span>
00390 <span class="comment">Routine Description:</span>
00391 <span class="comment"></span>
00392 <span class="comment">    This routine decrements the reference count of a logon session</span>
00393 <span class="comment">    tracking record.</span>
00394 <span class="comment"></span>
00395 <span class="comment">    If the reference count is decremented to zero, then there is no</span>
00396 <span class="comment">    possibility for any more tokens to exist for the logon session.</span>
00397 <span class="comment">    In this case, the LSA is notified that a logon session has</span>
00398 <span class="comment">    terminated.</span>
00399 <span class="comment"></span>
00400 <span class="comment"></span>
00401 <span class="comment"></span>
00402 <span class="comment">Arguments:</span>
00403 <span class="comment"></span>
00404 <span class="comment">    LogonId - Pointer to the logon session ID whose logon track is</span>
00405 <span class="comment">        to be decremented.</span>
00406 <span class="comment"></span>
00407 <span class="comment">Return Value:</span>
00408 <span class="comment"></span>
00409 <span class="comment">    None.</span>
00410 <span class="comment"></span>
00411 <span class="comment">--*/</span>
00412 
00413 {
00414 
00415     ULONG SessionArrayIndex;
00416     <a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html">PSEP_LOGON_SESSION_REFERENCES</a> Previous, Current;
00417 
00418 <span class="preprocessor">#ifdef SEP_TRACK_LOGON_SESSION_REFS</span>
00419 <span class="preprocessor"></span>    ULONG Refs;
00420 <span class="preprocessor">#endif //SEP_TRACK_LOGON_SESSION_REFS</span>
00421 <span class="preprocessor"></span>
00422     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00423 
00424     SessionArrayIndex = <a class="code" href="../../d9/d9/rmlogon_8c.html#a0">SepLogonSessionIndex</a>( LogonId );
00425 
00426     <span class="comment">//</span>
00427     <span class="comment">// Protect modification of reference monitor database</span>
00428     <span class="comment">//</span>
00429 
00430     <a class="code" href="../../d1/d0/rmp_8h.html#a3">SepRmAcquireDbWriteLock</a>();
00431 
00432 
00433     <span class="comment">//</span>
00434     <span class="comment">// Now walk the list for our logon session array hash index.</span>
00435     <span class="comment">//</span>
00436 
00437     Previous = (<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html">PSEP_LOGON_SESSION_REFERENCES</a>)
00438                ((PVOID)&amp;<a class="code" href="../../d1/d0/rmp_8h.html#a22">SepLogonSessions</a>[ SessionArrayIndex ]);
00439     Current = Previous-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o0">Next</a>;
00440 
00441     <span class="keywordflow">while</span> (Current != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00442 
00443         <span class="comment">//</span>
00444         <span class="comment">// If we found it, decrement the reference count and return</span>
00445         <span class="comment">//</span>
00446 
00447         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>( LogonId, &amp;Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o1">LogonId</a>) ) {
00448             Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o2">ReferenceCount</a> -= 1;
00449             <span class="keywordflow">if</span> (Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o2">ReferenceCount</a> == 0) {
00450 
00451                 <span class="comment">//</span>
00452                 <span class="comment">// Pull it from the list</span>
00453                 <span class="comment">//</span>
00454 
00455                 Previous-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o0">Next</a> = Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o0">Next</a>;
00456 
00457 
00458                 <span class="comment">//</span>
00459                 <span class="comment">// No longer need to protect our pointer to this</span>
00460                 <span class="comment">// record.</span>
00461                 <span class="comment">//</span>
00462 
00463                 <a class="code" href="../../d1/d0/rmp_8h.html#a5">SepRmReleaseDbWriteLock</a>();
00464 
00465                 <span class="comment">//</span>
00466                 <span class="comment">// Asynchronoously inform file systems that this logon session</span>
00467                 <span class="comment">// is going away, if atleast one FS expressed interest in this</span>
00468                 <span class="comment">// logon session.</span>
00469                 <span class="comment">//</span>
00470 
00471                 <span class="keywordflow">if</span> (Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o3">Flags</a> &amp; <a class="code" href="../../d1/d0/rmp_8h.html#a8">SEP_TERMINATION_NOTIFY</a>) {
00472                     <a class="code" href="../../d9/d9/rmlogon_8c.html#a6">SepInformFileSystemsOfDeletedLogon</a>( LogonId );
00473                 }
00474 
00475                 <span class="comment">//</span>
00476                 <span class="comment">// Deallocate the logon session track record.</span>
00477                 <span class="comment">//</span>
00478 
00479                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( (PVOID)Current );
00480 
00481 
00482 <span class="preprocessor">#ifdef SEP_TRACK_LOGON_SESSION_REFS</span>
00483 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"SE (rm): -- ** logon session: (%d, %d) to ZERO by (%d, %d)\n"</span>,
00484                       LogonId-&gt;HighPart, LogonId-&gt;LowPart,
00485                       <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueProcess,
00486                       <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueThread);
00487 
00488 <span class="preprocessor">#endif //SEP_TRACK_LOGON_SESSION_REFS</span>
00489 <span class="preprocessor"></span>
00490                 <span class="comment">//</span>
00491                 <span class="comment">// Inform the LSA about the deletion of this logon session.</span>
00492                 <span class="comment">//</span>
00493 
00494                 <a class="code" href="../../d9/d9/rmlogon_8c.html#a5">SepInformLsaOfDeletedLogon</a>( LogonId );
00495 
00496 
00497 
00498                 <span class="keywordflow">return</span>;
00499 
00500             }
00501 
00502             <span class="comment">//</span>
00503             <span class="comment">// reference count was incremented, but not to zero.</span>
00504             <span class="comment">//</span>
00505 
00506 <span class="preprocessor">#ifdef SEP_TRACK_LOGON_SESSION_REFS</span>
00507 <span class="preprocessor"></span>            Refs = Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o2">ReferenceCount</a>;
00508 <span class="preprocessor">#endif //SEP_TRACK_LOGON_SESSION_REFS</span>
00509 <span class="preprocessor"></span>
00510             <a class="code" href="../../d1/d0/rmp_8h.html#a5">SepRmReleaseDbWriteLock</a>();
00511 
00512 <span class="preprocessor">#ifdef SEP_TRACK_LOGON_SESSION_REFS</span>
00513 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"SE (rm): -- logon session: (%d, %d) to %d by (%d, %d)\n"</span>,
00514                       LogonId-&gt;HighPart, LogonId-&gt;LowPart, Refs,
00515                       <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueProcess,
00516                       <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueThread);
00517 <span class="preprocessor">#endif //SEP_TRACK_LOGON_SESSION_REFS</span>
00518 <span class="preprocessor"></span>
00519             <span class="keywordflow">return</span>;
00520         }
00521 
00522         Previous = Current;
00523         Current = Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o0">Next</a>;
00524     }
00525 
00526     <a class="code" href="../../d1/d0/rmp_8h.html#a5">SepRmReleaseDbWriteLock</a>();
00527 
00528     <span class="comment">//</span>
00529     <span class="comment">// Bad news, someone asked us to decrement the reference count of</span>
00530     <span class="comment">// a logon session we didn't know existed.</span>
00531     <span class="comment">//</span>
00532 
00533     <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>( DEREF_UNKNOWN_LOGON_SESSION );
00534 
00535     <span class="keywordflow">return</span>;
00536 
00537 }
00538 
00539 
00540 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00541"></a><a class="code" href="../../d1/d0/rmp_8h.html#a31">00541</a> <a class="code" href="../../d1/d0/rmp_8h.html#a31">SepCreateLogonSessionTrack</a>(
00542     IN PLUID LogonId
00543     )
00544 
00545 <span class="comment">/*++</span>
00546 <span class="comment"></span>
00547 <span class="comment">Routine Description:</span>
00548 <span class="comment"></span>
00549 <span class="comment">    This routine creates a new logon session tracking record.</span>
00550 <span class="comment"></span>
00551 <span class="comment">    This should only be called as a dispatch routine for a LSA-&gt;RM</span>
00552 <span class="comment">    call (and once during system initialization).</span>
00553 <span class="comment"></span>
00554 <span class="comment">    If the specified logon session already exists, then an error is returned.</span>
00555 <span class="comment"></span>
00556 <span class="comment"></span>
00557 <span class="comment"></span>
00558 <span class="comment">Arguments:</span>
00559 <span class="comment"></span>
00560 <span class="comment">    LogonId - Pointer to the logon session ID for which a new logon track is</span>
00561 <span class="comment">        to be created.</span>
00562 <span class="comment"></span>
00563 <span class="comment">Return Value:</span>
00564 <span class="comment"></span>
00565 <span class="comment">    STATUS_SUCCESS - The logon session track was created successfully.</span>
00566 <span class="comment"></span>
00567 <span class="comment">    STATUS_LOGON_SESSION_EXISTS - The logon session already exists.</span>
00568 <span class="comment">        A new one has not been created.</span>
00569 <span class="comment"></span>
00570 <span class="comment">--*/</span>
00571 
00572 {
00573 
00574     ULONG SessionArrayIndex;
00575     <a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html">PSEP_LOGON_SESSION_REFERENCES</a> Previous, Current;
00576     <a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html">PSEP_LOGON_SESSION_REFERENCES</a> LogonSessionTrack;
00577 
00578     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00579 
00580     <span class="comment">//</span>
00581     <span class="comment">// Make sure we can allocate a new logon session track record</span>
00582     <span class="comment">//</span>
00583 
00584     LogonSessionTrack = (<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html">PSEP_LOGON_SESSION_REFERENCES</a>)
00585                         <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00586                             <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00587                             <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html">SEP_LOGON_SESSION_REFERENCES</a>),
00588                             'sLeS'
00589                             );
00590 
00591     <span class="keywordflow">if</span> (LogonSessionTrack == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00592         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00593     }
00594 
00595     LogonSessionTrack-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o1">LogonId</a> = (*LogonId);
00596     LogonSessionTrack-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o2">ReferenceCount</a> = 0;
00597 
00598 
00599 
00600     SessionArrayIndex = <a class="code" href="../../d9/d9/rmlogon_8c.html#a0">SepLogonSessionIndex</a>( LogonId );
00601 
00602     <span class="comment">//</span>
00603     <span class="comment">// Protect modification of reference monitor database</span>
00604     <span class="comment">//</span>
00605 
00606     <a class="code" href="../../d1/d0/rmp_8h.html#a3">SepRmAcquireDbWriteLock</a>();
00607 
00608 
00609     <span class="comment">//</span>
00610     <span class="comment">// Now walk the list for our logon session array hash index</span>
00611     <span class="comment">// looking for a duplicate logon session ID.</span>
00612     <span class="comment">//</span>
00613 
00614     Previous = (<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html">PSEP_LOGON_SESSION_REFERENCES</a>)
00615                ((PVOID)&amp;<a class="code" href="../../d1/d0/rmp_8h.html#a22">SepLogonSessions</a>[ SessionArrayIndex ]);
00616     Current = Previous-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o0">Next</a>;
00617 
00618     <span class="keywordflow">while</span> (Current != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00619 
00620         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>( LogonId, &amp;Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o1">LogonId</a>) ) {
00621 
00622             <span class="comment">//</span>
00623             <span class="comment">// One already exists. Hmmm.</span>
00624             <span class="comment">//</span>
00625 
00626             <a class="code" href="../../d1/d0/rmp_8h.html#a5">SepRmReleaseDbWriteLock</a>();
00627             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(LogonSessionTrack);
00628             <span class="keywordflow">return</span> STATUS_LOGON_SESSION_EXISTS;
00629 
00630         }
00631 
00632         Previous = Current;
00633         Current = Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o0">Next</a>;
00634     }
00635 
00636 
00637     <span class="comment">//</span>
00638     <span class="comment">// Reached the end of the list without finding a duplicate.</span>
00639     <span class="comment">// Add the new one.</span>
00640     <span class="comment">//</span>
00641 
00642     LogonSessionTrack-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o0">Next</a> = <a class="code" href="../../d1/d0/rmp_8h.html#a22">SepLogonSessions</a>[ SessionArrayIndex ];
00643     <a class="code" href="../../d1/d0/rmp_8h.html#a22">SepLogonSessions</a>[ SessionArrayIndex ] = LogonSessionTrack;
00644 
00645 
00646 
00647 
00648     <a class="code" href="../../d1/d0/rmp_8h.html#a5">SepRmReleaseDbWriteLock</a>();
00649     <span class="keywordflow">return</span> STATUS_SUCCESS;
00650 
00651 }
00652 
00653 
00654 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00655"></a><a class="code" href="../../d1/d0/rmp_8h.html#a32">00655</a> <a class="code" href="../../d1/d0/rmp_8h.html#a32">SepDeleteLogonSessionTrack</a>(
00656     IN PLUID LogonId
00657     )
00658 
00659 <span class="comment">/*++</span>
00660 <span class="comment"></span>
00661 <span class="comment">Routine Description:</span>
00662 <span class="comment"></span>
00663 <span class="comment">    This routine creates a new logon session tracking record.</span>
00664 <span class="comment"></span>
00665 <span class="comment">    This should only be called as a dispatch routine for a LSA-&gt;RM</span>
00666 <span class="comment">    call (and once during system initialization).</span>
00667 <span class="comment"></span>
00668 <span class="comment">    If the specified logon session already exists, then an error is returned.</span>
00669 <span class="comment"></span>
00670 <span class="comment"></span>
00671 <span class="comment"></span>
00672 <span class="comment">Arguments:</span>
00673 <span class="comment"></span>
00674 <span class="comment">    LogonId - Pointer to the logon session ID whose logon track is</span>
00675 <span class="comment">        to be deleted.</span>
00676 <span class="comment"></span>
00677 <span class="comment">Return Value:</span>
00678 <span class="comment"></span>
00679 <span class="comment">    STATUS_SUCCESS - The logon session track was deleted successfully.</span>
00680 <span class="comment"></span>
00681 <span class="comment">    STATUS_BAD_LOGON_SESSION_STATE - The logon session has a non-zero</span>
00682 <span class="comment">        reference count and can not be deleted.</span>
00683 <span class="comment"></span>
00684 <span class="comment">    STATUS_NO_SUCH_LOGON_SESSION - The specified logon session does not</span>
00685 <span class="comment">        exist.</span>
00686 <span class="comment"></span>
00687 <span class="comment"></span>
00688 <span class="comment">--*/</span>
00689 
00690 {
00691 
00692     ULONG SessionArrayIndex;
00693     <a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html">PSEP_LOGON_SESSION_REFERENCES</a> Previous, Current;
00694 
00695     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00696 
00697     SessionArrayIndex = <a class="code" href="../../d9/d9/rmlogon_8c.html#a0">SepLogonSessionIndex</a>( LogonId );
00698 
00699     <span class="comment">//</span>
00700     <span class="comment">// Protect modification of reference monitor database</span>
00701     <span class="comment">//</span>
00702 
00703     <a class="code" href="../../d1/d0/rmp_8h.html#a3">SepRmAcquireDbWriteLock</a>();
00704 
00705 
00706     <span class="comment">//</span>
00707     <span class="comment">// Now walk the list for our logon session array hash index.</span>
00708     <span class="comment">//</span>
00709 
00710     Previous = (<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html">PSEP_LOGON_SESSION_REFERENCES</a>)
00711                ((PVOID)&amp;<a class="code" href="../../d1/d0/rmp_8h.html#a22">SepLogonSessions</a>[ SessionArrayIndex ]);
00712     Current = Previous-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o0">Next</a>;
00713 
00714     <span class="keywordflow">while</span> (Current != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00715 
00716         <span class="comment">//</span>
00717         <span class="comment">// If we found it, make sure reference count is zero</span>
00718         <span class="comment">//</span>
00719 
00720         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>( LogonId, &amp;Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o1">LogonId</a>) ) {
00721 
00722             <span class="keywordflow">if</span> (Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o2">ReferenceCount</a> == 0) {
00723 
00724                 <span class="comment">//</span>
00725                 <span class="comment">// Pull it from the list</span>
00726                 <span class="comment">//</span>
00727 
00728                 Previous-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o0">Next</a> = Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o0">Next</a>;
00729 
00730 
00731                 <span class="comment">//</span>
00732                 <span class="comment">// No longer need to protect our pointer to this</span>
00733                 <span class="comment">// record.</span>
00734                 <span class="comment">//</span>
00735 
00736                 <a class="code" href="../../d1/d0/rmp_8h.html#a5">SepRmReleaseDbWriteLock</a>();
00737 
00738 
00739                 <span class="comment">//</span>
00740                 <span class="comment">// Deallocate the logon session track record.</span>
00741                 <span class="comment">//</span>
00742 
00743                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( (PVOID)Current );
00744 
00745 
00746                 <span class="keywordflow">return</span> STATUS_SUCCESS;
00747 
00748             }
00749 
00750             <span class="comment">//</span>
00751             <span class="comment">// reference count was not zero.  This is not considered</span>
00752             <span class="comment">// a healthy situation.  Return an error and let someone</span>
00753             <span class="comment">// else declare the bug check.</span>
00754             <span class="comment">//</span>
00755 
00756             <a class="code" href="../../d1/d0/rmp_8h.html#a5">SepRmReleaseDbWriteLock</a>();
00757             <span class="keywordflow">return</span> STATUS_BAD_LOGON_SESSION_STATE;
00758         }
00759 
00760         Previous = Current;
00761         Current = Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o0">Next</a>;
00762     }
00763 
00764     <a class="code" href="../../d1/d0/rmp_8h.html#a5">SepRmReleaseDbWriteLock</a>();
00765 
00766     <span class="comment">//</span>
00767     <span class="comment">// Someone asked us to delete a logon session that isn't</span>
00768     <span class="comment">// in the database.</span>
00769     <span class="comment">//</span>
00770 
00771     <span class="keywordflow">return</span> STATUS_NO_SUCH_LOGON_SESSION;
00772 
00773 }
00774 
00775 
00776 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00777"></a><a class="code" href="../../d9/d9/rmlogon_8c.html#a5">00777</a> <a class="code" href="../../d9/d9/rmlogon_8c.html#a5">SepInformLsaOfDeletedLogon</a>(
00778     IN PLUID LogonId
00779     )
00780 
00781 <span class="comment">/*++</span>
00782 <span class="comment"></span>
00783 <span class="comment">Routine Description:</span>
00784 <span class="comment"></span>
00785 <span class="comment">    This routine informs the LSA about the deletion of a logon session.</span>
00786 <span class="comment"></span>
00787 <span class="comment">    Note that we can not be guaranteed that we are in a whole (or wholesome)</span>
00788 <span class="comment">    thread, since we may be in the middle of process deletion and object</span>
00789 <span class="comment">    rundown.  Therefore, we must queue the work off to a worker thread which</span>
00790 <span class="comment">    can then make an LPC call to the LSA.</span>
00791 <span class="comment"></span>
00792 <span class="comment"></span>
00793 <span class="comment"></span>
00794 <span class="comment"></span>
00795 <span class="comment">Arguments:</span>
00796 <span class="comment"></span>
00797 <span class="comment">    LogonId - Pointer to the logon session ID which has been deleted.</span>
00798 <span class="comment"></span>
00799 <span class="comment">Return Value:</span>
00800 <span class="comment"></span>
00801 <span class="comment">    None.</span>
00802 <span class="comment"></span>
00803 <span class="comment">--*/</span>
00804 
00805 {
00806     <a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html">PSEP_LSA_WORK_ITEM</a> DeleteLogonItem;
00807 
00808     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00809 
00810     <span class="comment">//</span>
00811     <span class="comment">// Pass the LUID value along with the work queue item.</span>
00812     <span class="comment">// Note that the worker thread is responsible for freeing the WorkItem data</span>
00813     <span class="comment">// structure.</span>
00814     <span class="comment">//</span>
00815 
00816     DeleteLogonItem = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html">SEP_LSA_WORK_ITEM</a>), 'wLeS' );
00817     <span class="keywordflow">if</span> (DeleteLogonItem == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00818 
00819         <span class="comment">//</span>
00820         <span class="comment">// I don't know what to do here... we loose track of a logon session,</span>
00821         <span class="comment">// but the system isn't really harmed in any way.</span>
00822         <span class="comment">//</span>
00823 
00824         <span class="keywordflow">return</span>;
00825 
00826     }
00827 
00828     DeleteLogonItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o5">CommandParams</a>.LogonId   = (*LogonId);
00829     DeleteLogonItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o6">CommandNumber</a>           = LsapLogonSessionDeletedCommand;
00830     DeleteLogonItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o7">CommandParamsLength</a>     = <span class="keyword">sizeof</span>( LUID );
00831     DeleteLogonItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o8">ReplyBuffer</a>             = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00832     DeleteLogonItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o9">ReplyBufferLength</a>       = 0;
00833     DeleteLogonItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o10">CleanupFunction</a>         = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00834     DeleteLogonItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o11">CleanupParameter</a>        = 0;
00835     DeleteLogonItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o2">Tag</a>                     = <a class="code" href="../../d6/d6/sep_8h.html#a77a33">SepDeleteLogon</a>;
00836     DeleteLogonItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o1">CommandParamsMemoryType</a> = SepRmImmediateMemory;
00837 
00838     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/sep_8h.html#a68">SepQueueWorkItem</a>( DeleteLogonItem, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> )) {
00839 
00840         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DeleteLogonItem );
00841     }
00842 
00843     <span class="keywordflow">return</span>;
00844 
00845 }
00846 
00847 
00848 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00849"></a><a class="code" href="../../d9/d9/rmlogon_8c.html#a14">00849</a> <a class="code" href="../../d9/d9/rmlogon_8c.html#a14">SeRegisterLogonSessionTerminatedRoutine</a>(
00850     IN <a class="code" href="../../d0/d5/se_8h.html#a35">PSE_LOGON_SESSION_TERMINATED_ROUTINE</a> CallbackRoutine
00851     )
00852 
00853 <span class="comment">/*++</span>
00854 <span class="comment"></span>
00855 <span class="comment">Routine Description:</span>
00856 <span class="comment"></span>
00857 <span class="comment">    This routine is called by file systems that are interested in being</span>
00858 <span class="comment">    notified when a logon session is being deleted.</span>
00859 <span class="comment"></span>
00860 <span class="comment">Arguments:</span>
00861 <span class="comment"></span>
00862 <span class="comment">    CallbackRoutine - Address of routine to call back when a logon session</span>
00863 <span class="comment">        is being deleted.</span>
00864 <span class="comment"></span>
00865 <span class="comment">Return Value:</span>
00866 <span class="comment"></span>
00867 <span class="comment">    STATUS_SUCCESS - Successfully registered routine</span>
00868 <span class="comment"></span>
00869 <span class="comment">    STATUS_INVALID_PARAMETER - CallbackRoutine is NULL</span>
00870 <span class="comment"></span>
00871 <span class="comment">    STATUS_INSUFFICIENT_RESOURCE - Unable to allocate list entry.</span>
00872 <span class="comment"></span>
00873 <span class="comment">--*/</span>
00874 
00875 {
00876     <a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html">PSEP_LOGON_SESSION_TERMINATED_NOTIFICATION</a> NewCallback;
00877 
00878     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00879 
00880     <span class="keywordflow">if</span> (CallbackRoutine == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00881         <span class="keywordflow">return</span>( STATUS_INVALID_PARAMETER );
00882     }
00883 
00884     NewCallback = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00885                         <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00886                         <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html">SEP_LOGON_SESSION_TERMINATED_NOTIFICATION</a>),
00887                         'SFeS');
00888 
00889     <span class="keywordflow">if</span> (NewCallback == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00890         <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
00891     }
00892 
00893     <a class="code" href="../../d1/d0/rmp_8h.html#a3">SepRmAcquireDbWriteLock</a>();
00894 
00895     NewCallback-&gt;<a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html#o0">Next</a> = <a class="code" href="../../d9/d9/rmlogon_8c.html#a1">SeFileSystemNotifyRoutinesHead</a>.<a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html#o0">Next</a>;
00896 
00897     NewCallback-&gt;<a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html#o1">CallbackRoutine</a> = CallbackRoutine;
00898 
00899     <a class="code" href="../../d9/d9/rmlogon_8c.html#a1">SeFileSystemNotifyRoutinesHead</a>.<a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html#o0">Next</a> = NewCallback;
00900 
00901     <a class="code" href="../../d1/d0/rmp_8h.html#a5">SepRmReleaseDbWriteLock</a>();
00902 
00903     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00904 }
00905 
00906 
00907 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00908"></a><a class="code" href="../../d9/d9/rmlogon_8c.html#a15">00908</a> <a class="code" href="../../d9/d9/rmlogon_8c.html#a15">SeUnregisterLogonSessionTerminatedRoutine</a>(
00909     IN PSE_LOGON_SESSION_TERMINATED_ROUTINE CallbackRoutine
00910     )
00911 
00912 <span class="comment">/*++</span>
00913 <span class="comment"></span>
00914 <span class="comment">Routine Description:</span>
00915 <span class="comment"></span>
00916 <span class="comment">    This is the dual of SeRegisterLogonSessionTerminatedRoutine. A File System</span>
00917 <span class="comment">    *MUST* call this before it is unloaded.</span>
00918 <span class="comment"></span>
00919 <span class="comment">Arguments:</span>
00920 <span class="comment"></span>
00921 <span class="comment">    CallbackRoutine - Address of routine that was originally passed in to</span>
00922 <span class="comment">        SeRegisterLogonSessionTerminatedRoutine.</span>
00923 <span class="comment"></span>
00924 <span class="comment">Return Value:</span>
00925 <span class="comment"></span>
00926 <span class="comment">    STATUS_SUCCESS - Successfully removed callback routine</span>
00927 <span class="comment"></span>
00928 <span class="comment">    STATUS_INVALID_PARAMETER - CallbackRoutine is NULL</span>
00929 <span class="comment"></span>
00930 <span class="comment">    STATUS_NOT_FOUND - Didn't find and entry for CallbackRoutine</span>
00931 <span class="comment"></span>
00932 <span class="comment">--*/</span>
00933 {
00934     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00935     <a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html">PSEP_LOGON_SESSION_TERMINATED_NOTIFICATION</a> PreviousEntry;
00936     <a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html">PSEP_LOGON_SESSION_TERMINATED_NOTIFICATION</a> NotifyEntry;
00937 
00938     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00939 
00940     <span class="keywordflow">if</span> (CallbackRoutine == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00941         <span class="keywordflow">return</span>( STATUS_INVALID_PARAMETER );
00942     }
00943 
00944     <a class="code" href="../../d1/d0/rmp_8h.html#a3">SepRmAcquireDbWriteLock</a>();
00945 
00946     <span class="keywordflow">for</span> (PreviousEntry = &amp;<a class="code" href="../../d9/d9/rmlogon_8c.html#a1">SeFileSystemNotifyRoutinesHead</a>,
00947             NotifyEntry = <a class="code" href="../../d9/d9/rmlogon_8c.html#a1">SeFileSystemNotifyRoutinesHead</a>.<a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html#o0">Next</a>;
00948                 NotifyEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00949                     PreviousEntry = NotifyEntry,
00950                         NotifyEntry = NotifyEntry-&gt;<a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html#o0">Next</a>) {
00951 
00952          <span class="keywordflow">if</span> (NotifyEntry-&gt;CallbackRoutine == CallbackRoutine)
00953              <span class="keywordflow">break</span>;
00954 
00955     }
00956 
00957     <span class="keywordflow">if</span> (NotifyEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00958 
00959         PreviousEntry-&gt;<a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html#o0">Next</a> = NotifyEntry-&gt;<a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html#o0">Next</a>;
00960 
00961         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NotifyEntry );
00962 
00963         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00964 
00965     } <span class="keywordflow">else</span> {
00966 
00967         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_FOUND;
00968 
00969     }
00970 
00971     <a class="code" href="../../d1/d0/rmp_8h.html#a5">SepRmReleaseDbWriteLock</a>();
00972 
00973     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00974 
00975 }
00976 
00977 
00978 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00979"></a><a class="code" href="../../d9/d9/rmlogon_8c.html#a16">00979</a> <a class="code" href="../../d9/d9/rmlogon_8c.html#a16">SeMarkLogonSessionForTerminationNotification</a>(
00980     IN PLUID LogonId
00981     )
00982 
00983 <span class="comment">/*++</span>
00984 <span class="comment"></span>
00985 <span class="comment">Routine Description:</span>
00986 <span class="comment"></span>
00987 <span class="comment">    File systems that have registered for logon-termination notification</span>
00988 <span class="comment">    can mark logon sessions they are interested in for callback by calling</span>
00989 <span class="comment">    this routine.</span>
00990 <span class="comment"></span>
00991 <span class="comment">Arguments:</span>
00992 <span class="comment"></span>
00993 <span class="comment">    LogonId - The logon id for which the file system should be notified</span>
00994 <span class="comment">        when the logon session is terminated.</span>
00995 <span class="comment"></span>
00996 <span class="comment">Returns:</span>
00997 <span class="comment"></span>
00998 <span class="comment">    Nothing.</span>
00999 <span class="comment"></span>
01000 <span class="comment">--*/</span>
01001 
01002 {
01003 
01004     ULONG SessionArrayIndex;
01005     <a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html">PSEP_LOGON_SESSION_REFERENCES</a> Previous, Current;
01006 
01007     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01008 
01009     SessionArrayIndex = <a class="code" href="../../d9/d9/rmlogon_8c.html#a0">SepLogonSessionIndex</a>( LogonId );
01010 
01011     <span class="comment">//</span>
01012     <span class="comment">// Protect modification of reference monitor database</span>
01013     <span class="comment">//</span>
01014 
01015     <a class="code" href="../../d1/d0/rmp_8h.html#a3">SepRmAcquireDbWriteLock</a>();
01016 
01017 
01018     <span class="comment">//</span>
01019     <span class="comment">// Now walk the list for our logon session array hash index.</span>
01020     <span class="comment">//</span>
01021 
01022     Previous = (<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html">PSEP_LOGON_SESSION_REFERENCES</a>)
01023                ((PVOID)&amp;<a class="code" href="../../d1/d0/rmp_8h.html#a22">SepLogonSessions</a>[ SessionArrayIndex ]);
01024     Current = Previous-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o0">Next</a>;
01025 
01026     <span class="keywordflow">while</span> (Current != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01027 
01028         <span class="comment">//</span>
01029         <span class="comment">// If we found it, decrement the reference count and return</span>
01030         <span class="comment">//</span>
01031 
01032         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>( LogonId, &amp;Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o1">LogonId</a>) ) {
01033             Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o3">Flags</a> |= <a class="code" href="../../d1/d0/rmp_8h.html#a8">SEP_TERMINATION_NOTIFY</a>;
01034             <span class="keywordflow">break</span>;
01035         }
01036 
01037         Previous = Current;
01038         Current = Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o0">Next</a>;
01039     }
01040 
01041     <a class="code" href="../../d1/d0/rmp_8h.html#a5">SepRmReleaseDbWriteLock</a>();
01042 
01043     <span class="keywordflow">return</span>( (Current != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ? STATUS_SUCCESS : STATUS_NOT_FOUND );
01044 
01045 }
01046 
01047 
01048 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01049"></a><a class="code" href="../../d9/d9/rmlogon_8c.html#a6">01049</a> <a class="code" href="../../d9/d9/rmlogon_8c.html#a6">SepInformFileSystemsOfDeletedLogon</a>(
01050     IN PLUID LogonId
01051     )
01052 
01053 <span class="comment">/*++</span>
01054 <span class="comment"></span>
01055 <span class="comment">Routine Description:</span>
01056 <span class="comment"></span>
01057 <span class="comment">    This routine informs interested file systems of a deleted logon.</span>
01058 <span class="comment"></span>
01059 <span class="comment">    Note that we can not be guaranteed that we are in a whole (or wholesome)</span>
01060 <span class="comment">    thread, since we may be in the middle of process deletion and object</span>
01061 <span class="comment">    rundown.  Therefore, we must queue the work off to a worker thread.</span>
01062 <span class="comment"></span>
01063 <span class="comment"></span>
01064 <span class="comment">Arguments:</span>
01065 <span class="comment"></span>
01066 <span class="comment">    LogonId - Pointer to the logon session ID which has been deleted.</span>
01067 <span class="comment"></span>
01068 <span class="comment">Return Value:</span>
01069 <span class="comment"></span>
01070 <span class="comment">    None.</span>
01071 <span class="comment"></span>
01072 <span class="comment">--*/</span>
01073 
01074 {
01075     <a class="code" href="../../d9/d9/rmlogon_8c.html#a3">PSEP_FILE_SYSTEM_NOTIFY_CONTEXT</a> FSNotifyContext;
01076 
01077     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01078 
01079     FSNotifyContext = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
01080                             <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
01081                             <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d1/struct__SEP__FILE__SYSTEM__NOTIFY__CONTEXT.html">SEP_FILE_SYSTEM_NOTIFY_CONTEXT</a>),
01082                             'SFeS');
01083 
01084     <span class="keywordflow">if</span> (FSNotifyContext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01085 
01086         <span class="comment">//</span>
01087         <span class="comment">// I don't know what to do here... file systems will loose track of a</span>
01088         <span class="comment">// logon session, but the system isn't really harmed in any way.</span>
01089         <span class="comment">//</span>
01090 
01091         <span class="keywordflow">return</span>;
01092 
01093     }
01094 
01095     FSNotifyContext-&gt;<a class="code" href="../../d5/d1/struct__SEP__FILE__SYSTEM__NOTIFY__CONTEXT.html#o1">LogonId</a> = *LogonId;
01096 
01097     <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>( &amp;FSNotifyContext-&gt;<a class="code" href="../../d5/d1/struct__SEP__FILE__SYSTEM__NOTIFY__CONTEXT.html#o0">WorkItem</a>,
01098                           (<a class="code" href="../../d5/d8/ex_8h.html#a111">PWORKER_THREAD_ROUTINE</a>) <a class="code" href="../../d9/d9/rmlogon_8c.html#a7">SepNotifyFileSystems</a>,
01099                           (PVOID) FSNotifyContext);
01100 
01101     <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>( &amp;FSNotifyContext-&gt;WorkItem, <a class="code" href="../../d5/d8/ex_8h.html#a332a206">DelayedWorkQueue</a> );
01102 
01103 }
01104 
01105 
01106 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01107"></a><a class="code" href="../../d9/d9/rmlogon_8c.html#a7">01107</a> <a class="code" href="../../d9/d9/rmlogon_8c.html#a7">SepNotifyFileSystems</a>(
01108     IN PVOID Context
01109     )
01110 {
01111     <a class="code" href="../../d9/d9/rmlogon_8c.html#a3">PSEP_FILE_SYSTEM_NOTIFY_CONTEXT</a> FSNotifyContext =
01112         (<a class="code" href="../../d9/d9/rmlogon_8c.html#a3">PSEP_FILE_SYSTEM_NOTIFY_CONTEXT</a>) Context;
01113 
01114     <a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html">PSEP_LOGON_SESSION_TERMINATED_NOTIFICATION</a> NextCallback;
01115 
01116     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01117 
01118     <span class="comment">//</span>
01119     <span class="comment">// Protect modification of the list of FS callbacks.</span>
01120     <span class="comment">//</span>
01121 
01122     <a class="code" href="../../d1/d0/rmp_8h.html#a2">SepRmAcquireDbReadLock</a>();
01123 
01124     NextCallback = <a class="code" href="../../d9/d9/rmlogon_8c.html#a1">SeFileSystemNotifyRoutinesHead</a>.<a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html#o0">Next</a>;
01125 
01126     <span class="keywordflow">while</span> (NextCallback != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01127 
01128         NextCallback-&gt;<a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html#o1">CallbackRoutine</a>( &amp;FSNotifyContext-&gt;<a class="code" href="../../d5/d1/struct__SEP__FILE__SYSTEM__NOTIFY__CONTEXT.html#o1">LogonId</a> );
01129 
01130         NextCallback = NextCallback-&gt;<a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html#o0">Next</a>;
01131     }
01132 
01133     <a class="code" href="../../d1/d0/rmp_8h.html#a4">SepRmReleaseDbReadLock</a>();
01134 
01135     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( FSNotifyContext );
01136 }
01137 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:40 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
