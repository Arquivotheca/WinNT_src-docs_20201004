<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: sysptes.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>sysptes.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d1/d8/sysptes_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/sysptes_8c.html#a0">MM_MIN_SYSPTE_FREE</a>&nbsp;&nbsp;&nbsp;500</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/sysptes_8c.html#a1">MM_MAX_SYSPTE_FREE</a>&nbsp;&nbsp;&nbsp;3000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/sysptes_8c.html#a2">MM_PTE_LIST_1</a>&nbsp;&nbsp;&nbsp;400</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/sysptes_8c.html#a3">MM_PTE_LIST_2</a>&nbsp;&nbsp;&nbsp;100</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/sysptes_8c.html#a4">MM_PTE_LIST_4</a>&nbsp;&nbsp;&nbsp;60</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/sysptes_8c.html#a5">MM_PTE_LIST_8</a>&nbsp;&nbsp;&nbsp;50</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/sysptes_8c.html#a6">MM_PTE_LIST_16</a>&nbsp;&nbsp;&nbsp;40</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/sysptes_8c.html#a7">MM_PTE_TABLE_LIMIT</a>&nbsp;&nbsp;&nbsp;16</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/sysptes_8c.html#a19">MiFeedSysPtePool</a> (IN ULONG <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/sysptes_8c.html#a20">MiReserveSystemPtes2</a> (IN ULONG NumberOfPtes, IN <a class="el" href="../../d4/d8/mi_8h.html#a512">MMSYSTEM_PTE_POOL_TYPE</a> SystemPtePoolType, IN ULONG Alignment, IN ULONG <a class="el" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>, IN ULONG BugCheckOnFailure)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/sysptes_8c.html#a21">MiGetSystemPteListCount</a> (IN ULONG ListSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/sysptes_8c.html#a22">MiDumpSystemPtes</a> (IN <a class="el" href="../../d4/d8/mi_8h.html#a512">MMSYSTEM_PTE_POOL_TYPE</a> SystemPtePoolType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/sysptes_8c.html#a23">MiCountFreeSystemPtes</a> (IN <a class="el" href="../../d4/d8/mi_8h.html#a512">MMSYSTEM_PTE_POOL_TYPE</a> SystemPtePoolType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/sysptes_8c.html#a24">MiGetHighestPteConsumer</a> (OUT PULONG_PTR NumberOfPtes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a> (IN ULONG NumberOfPtes, IN <a class="el" href="../../d4/d8/mi_8h.html#a512">MMSYSTEM_PTE_POOL_TYPE</a> SystemPtePoolType, IN ULONG Alignment, IN ULONG <a class="el" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>, IN ULONG BugCheckOnFailure)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartingPte, IN ULONG NumberOfPtes, IN <a class="el" href="../../d4/d8/mi_8h.html#a512">MMSYSTEM_PTE_POOL_TYPE</a> SystemPtePoolType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/sysptes_8c.html#a27">MiInitializeSystemPtes</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartingPte, IN ULONG NumberOfPtes, IN <a class="el" href="../../d4/d8/mi_8h.html#a512">MMSYSTEM_PTE_POOL_TYPE</a> SystemPtePoolType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/sysptes_8c.html#a28">MiAddSystemPtes</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartingPte, IN ULONG NumberOfPtes, IN <a class="el" href="../../d4/d8/mi_8h.html#a512">MMSYSTEM_PTE_POOL_TYPE</a> SystemPtePoolType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/sysptes_8c.html#a29">MiGetSystemPteAvailability</a> (IN ULONG NumberOfPtes, IN <a class="el" href="../../d2/d1/mm_8h.html#a154">MM_PAGE_PRIORITY</a> Priority)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/sysptes_8c.html#a8">MmTotalFreeSystemPtes</a> [MaximumPtePoolTypes]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/sysptes_8c.html#a9">MmSystemPtesStart</a> [MaximumPtePoolTypes]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/sysptes_8c.html#a10">MmSystemPtesEnd</a> [MaximumPtePoolTypes]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/sysptes_8c.html#a11">MmFlushPte1</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/sysptes_8c.html#a12">MmFlushCounter</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a> [MM_SYS_PTE_TABLES_MAX] = {1,2,4,8,16}</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/sysptes_8c.html#a14">MmSysPteTables</a> [17] = {0,0,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4}</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/sysptes_8c.html#a15">MmFreeSysPteListBySize</a> [MM_SYS_PTE_TABLES_MAX]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/sysptes_8c.html#a16">MmLastSysPteListBySize</a> [MM_SYS_PTE_TABLES_MAX]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/sysptes_8c.html#a17">MmSysPteListBySizeCount</a> [MM_SYS_PTE_TABLES_MAX]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/sysptes_8c.html#a18">MmSysPteMinimumFree</a> [MM_SYS_PTE_TABLES_MAX] = {100,50,30,20,20}</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a1" doxytag="sysptes.c::MM_MAX_SYSPTE_FREE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MM_MAX_SYSPTE_FREE&nbsp;&nbsp;&nbsp;3000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00074">74</a> of file <a class="el" href="../../d1/d8/sysptes_8c-source.html">sysptes.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="sysptes.c::MM_MIN_SYSPTE_FREE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MM_MIN_SYSPTE_FREE&nbsp;&nbsp;&nbsp;500          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00073">73</a> of file <a class="el" href="../../d1/d8/sysptes_8c-source.html">sysptes.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00788">MiFeedSysPtePool()</a>, and <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="sysptes.c::MM_PTE_LIST_1" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MM_PTE_LIST_1&nbsp;&nbsp;&nbsp;400          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00110">110</a> of file <a class="el" href="../../d1/d8/sysptes_8c-source.html">sysptes.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01740">MiInitializeSystemPtes()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="sysptes.c::MM_PTE_LIST_16" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MM_PTE_LIST_16&nbsp;&nbsp;&nbsp;40          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00114">114</a> of file <a class="el" href="../../d1/d8/sysptes_8c-source.html">sysptes.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01740">MiInitializeSystemPtes()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="sysptes.c::MM_PTE_LIST_2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MM_PTE_LIST_2&nbsp;&nbsp;&nbsp;100          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00111">111</a> of file <a class="el" href="../../d1/d8/sysptes_8c-source.html">sysptes.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01740">MiInitializeSystemPtes()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="sysptes.c::MM_PTE_LIST_4" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MM_PTE_LIST_4&nbsp;&nbsp;&nbsp;60          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00112">112</a> of file <a class="el" href="../../d1/d8/sysptes_8c-source.html">sysptes.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01740">MiInitializeSystemPtes()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="sysptes.c::MM_PTE_LIST_8" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MM_PTE_LIST_8&nbsp;&nbsp;&nbsp;50          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00113">113</a> of file <a class="el" href="../../d1/d8/sysptes_8c-source.html">sysptes.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01740">MiInitializeSystemPtes()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="sysptes.c::MM_PTE_TABLE_LIMIT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MM_PTE_TABLE_LIMIT&nbsp;&nbsp;&nbsp;16          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00116">116</a> of file <a class="el" href="../../d1/d8/sysptes_8c-source.html">sysptes.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d8/sysptes_8c-source.html#l02030">MiGetSystemPteAvailability()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01987">MiGetSystemPteListCount()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, and <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00524">MiReserveSystemPtes()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a28" doxytag="sysptes.c::MiAddSystemPtes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiAddSystemPtes           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfPtes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d8/mi_8h.html#a512">MMSYSTEM_PTE_POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemPtePoolType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01907">1907</a> of file <a class="el" href="../../d1/d8/sysptes_8c-source.html">sysptes.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02543">MiFillMemoryPte</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00431">MM_KERNEL_NOACCESS_PTE</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00054">MmSystemPtesEnd</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00053">MmSystemPtesStart</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d2/d1/mm_2i386_2init386_8c-source.html#l00058">MiInitMachineDependent()</a>, and <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>.
<p>
<pre class="fragment"><div>01915                    :
01916 
01917     This routine adds newly created PTEs to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
01918 
01919 Arguments:
01920 
01921     StartingPte - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first PTE to put in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
01922 
01923     NumberOfPtes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of PTEs to put in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
01924 
01925     SystemPtePoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> to expand, one of
01926                         <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a> or <a class="code" href="../../d4/d8/mi_8h.html#a1003a770">NonPagedPoolExpansion</a>.
01927 
01928 Return Value:
01929 
01930     None.
01931 
01932 Environment:
01933 
01934     Kernel mode.
01935 
01936 --*/
01937 
01938 {
01939     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndingPte;
01940 
01941     EndingPte = StartingPte + NumberOfPtes - 1;
01942 
01943 <span class="preprocessor">#ifdef _MI_SYSPTE_DEBUG_</span>
01944 <span class="preprocessor"></span>    MiRebuildPteTracker (StartingPte, NumberOfPtes);
01945 <span class="preprocessor">#endif</span>
01946 <span class="preprocessor"></span>
01947     <span class="keywordflow">if</span> (StartingPte &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a14">MmSystemPtesStart</a>[SystemPtePoolType]) {
01948         <a class="code" href="../../d8/d5/kddata_8c.html#a14">MmSystemPtesStart</a>[SystemPtePoolType] = StartingPte;
01949     }
01950 
01951     <span class="keywordflow">if</span> (EndingPte &gt; <a class="code" href="../../d8/d5/kddata_8c.html#a15">MmSystemPtesEnd</a>[SystemPtePoolType]) {
01952         <a class="code" href="../../d8/d5/kddata_8c.html#a15">MmSystemPtesEnd</a>[SystemPtePoolType] = EndingPte;
01953     }
01954 
01955 <span class="preprocessor">#ifdef _MI_SYSPTE_DEBUG_</span>
01956 <span class="preprocessor"></span>
01957     <span class="keywordflow">if</span> (SystemPtePoolType == <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a> &amp;&amp; MiPteTracker != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01958 
01959         ULONG i;
01960         ULONG_PTR <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01961         PMMPTE_TRACKER Tracker;
01962 
01963         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = StartingPte - <a class="code" href="../../d8/d5/kddata_8c.html#a14">MmSystemPtesStart</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>];
01964         Tracker = &amp;MiPteTracker[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01965 
01966         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfPtes &lt; 0x10000);
01967         Tracker-&gt;NumberOfPtes = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)NumberOfPtes;
01968 
01969         <span class="keywordflow">for</span> (i = 0; i &lt; NumberOfPtes; i += 1) {
01970             Tracker-&gt;InUse = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01971             Tracker += 1;
01972         }
01973     }
01974 
01975     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a189">MiFillMemoryPte</a> (StartingPte, NumberOfPtes * <span class="keyword">sizeof</span> (<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>), MM_KERNEL_NOACCESS_PTE);
01976 <span class="preprocessor">#endif</span>
01977 <span class="preprocessor"></span>
01978 <span class="preprocessor">#ifdef _MI_GUARD_PTE_</span>
01979 <span class="preprocessor"></span>    <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (StartingPte, NumberOfPtes - 1, SystemPtePoolType);
01980 <span class="preprocessor">#else</span>
01981 <span class="preprocessor"></span>    <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (StartingPte, NumberOfPtes, SystemPtePoolType);
01982 <span class="preprocessor">#endif</span>
01983 <span class="preprocessor"></span>}

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="sysptes.c::MiCountFreeSystemPtes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG MiCountFreeSystemPtes           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d8/mi_8h.html#a512">MMSYSTEM_PTE_POOL_TYPE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SystemPtePoolType</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01740">MiInitializeSystemPtes()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, and <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00843">MiReserveSystemPtes2()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="sysptes.c::MiDumpSystemPtes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiDumpSystemPtes           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d8/mi_8h.html#a512">MMSYSTEM_PTE_POOL_TYPE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SystemPtePoolType</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, and <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00843">MiReserveSystemPtes2()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="sysptes.c::MiFeedSysPtePool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiFeedSysPtePool           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Index</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00788">788</a> of file <a class="el" href="../../d1/d8/sysptes_8c-source.html">sysptes.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00843">MiReserveSystemPtes2()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00073">MM_MIN_SYSPTE_FREE</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00096">MmSysPteIndex</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00045">MmTotalFreeSystemPtes</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>.
<p>
Referenced by <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00524">MiReserveSystemPtes()</a>.
<p>
<pre class="fragment"><div>00794                    :
00795 
00796     This routine adds PTEs to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> look aside lists.
00797 
00798 Arguments:
00799 
00800     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> look aside list to fill.
00801 
00802 Return Value:
00803 
00804     None.
00805 
00806 
00807 Environment:
00808 
00809     Kernel mode, internal to SysPtes.
00810 
00811 --*/
00812 
00813 {
00814 <span class="preprocessor">#ifdef _MI_GUARD_PTE_</span>
00815 <span class="preprocessor"></span>    UNREFERENCED_PARAMETER (Index);
00816 <span class="preprocessor">#else</span>
00817 <span class="preprocessor"></span>    ULONG i;
00818     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00819 
00820     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>] &lt; <a class="code" href="../../d0/d9/sysptes_8c.html#a0">MM_MIN_SYSPTE_FREE</a>) {
00821         <span class="keywordflow">return</span>;
00822     }
00823 
00824     <span class="keywordflow">for</span> (i = 0; i &lt; 10 ; i++ ) {
00825         PointerPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a20">MiReserveSystemPtes2</a> (MmSysPteIndex [Index],
00826                                            SystemPteSpace,
00827                                            0,
00828                                            0,
00829                                            FALSE);
00830         <span class="keywordflow">if</span> (PointerPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00831             <span class="keywordflow">return</span>;
00832         }
00833         <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (PointerPte,
00834                              MmSysPteIndex [Index],
00835                              SystemPteSpace);
00836     }
00837 <span class="preprocessor">#endif</span>
00838 <span class="preprocessor"></span>    <span class="keywordflow">return</span>;
00839 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="sysptes.c::MiGetHighestPteConsumer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MiGetHighestPteConsumer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PULONG_PTR&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>NumberOfPtes</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l01901">1901</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d6/d5/iosup_8c-source.html#l00082">_PTE_TRACKER::CallingAddress</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00076">_PTE_TRACKER::Count</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00088">_SYSPTES_HEADER::ListHead</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00094">MiPteHeader</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00093">MiTrackPtesAborted</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00093">MmTrackPtes</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d6/iosup_8c.html#a5">PPTE_TRACKER</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00582">PsLoadedModuleList</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00843">MiReserveSystemPtes2()</a>.
<p>
<pre class="fragment"><div>01907                    :
01908 
01909     This function examines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE tracking blocks and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> biggest
01910     consumer.
01911 
01912 Arguments:
01913 
01914     None.
01915 
01916 Return Value:
01917 
01918     The loaded module entry of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> biggest consumer.
01919 
01920 Environment:
01921 
01922     Kernel mode, called during bugcheck <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>.  Many locks may be held.
01923 
01924 --*/
01925 
01926 {
01927     <a class="code" href="../../d7/d1/struct__PTE__TRACKER.html">PPTE_TRACKER</a> Tracker;
01928     PVOID BaseAddress;
01929     PFN_NUMBER NumberOfPages;
01930     PLIST_ENTRY NextEntry;
01931     PLIST_ENTRY NextEntry2;
01932     PLDR_DATA_TABLE_ENTRY DataTableEntry;
01933     ULONG_PTR Highest;
01934     ULONG_PTR PagesByThisModule;
01935     PLDR_DATA_TABLE_ENTRY HighDataTableEntry;
01936 
01937     *NumberOfPtes = 0;
01938 
01939     <span class="comment">//</span>
01940     <span class="comment">// No locks are acquired as this is only called during a bugcheck.</span>
01941     <span class="comment">//</span>
01942 
01943     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a37">MmTrackPtes</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01944         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01945     }
01946 
01947     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/iosup_8c.html#a9">MiTrackPtesAborted</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01948         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01949     }
01950 
01951     <span class="keywordflow">if</span> (IsListEmpty(&amp;<a class="code" href="../../d5/d6/iosup_8c.html#a10">MiPteHeader</a>.<a class="code" href="../../d9/d7/struct__SYSPTES__HEADER.html#o0">ListHead</a>)) {
01952         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01953     }
01954 
01955     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01956         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01957     }
01958 
01959     Highest = 0;
01960     HighDataTableEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01961 
01962     NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
01963     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
01964 
01965         DataTableEntry = CONTAINING_RECORD(NextEntry,
01966                                            LDR_DATA_TABLE_ENTRY,
01967                                            InLoadOrderLinks);
01968 
01969         PagesByThisModule = 0;
01970 
01971         <span class="comment">//</span>
01972         <span class="comment">// Walk the PTE mapping list and update each driver's counts.</span>
01973         <span class="comment">//</span>
01974     
01975         NextEntry2 = <a class="code" href="../../d5/d6/iosup_8c.html#a10">MiPteHeader</a>.<a class="code" href="../../d9/d7/struct__SYSPTES__HEADER.html#o0">ListHead</a>.Flink;
01976         <span class="keywordflow">while</span> (NextEntry2 != &amp;<a class="code" href="../../d5/d6/iosup_8c.html#a10">MiPteHeader</a>.<a class="code" href="../../d9/d7/struct__SYSPTES__HEADER.html#o0">ListHead</a>) {
01977     
01978             Tracker = (<a class="code" href="../../d7/d1/struct__PTE__TRACKER.html">PPTE_TRACKER</a>) CONTAINING_RECORD (NextEntry2,
01979                                                         <a class="code" href="../../d7/d1/struct__PTE__TRACKER.html">PTE_TRACKER</a>,
01980                                                         ListEntry.Flink);
01981     
01982             BaseAddress = Tracker-&gt;<a class="code" href="../../d7/d1/struct__PTE__TRACKER.html#o8">CallingAddress</a>;
01983             NumberOfPages = Tracker-&gt;<a class="code" href="../../d7/d1/struct__PTE__TRACKER.html#o2">Count</a>;
01984     
01985             <span class="keywordflow">if</span> ((BaseAddress &gt;= DataTableEntry-&gt;DllBase) &amp;&amp;
01986                 (BaseAddress &lt; (PVOID)((ULONG_PTR)(DataTableEntry-&gt;DllBase) + DataTableEntry-&gt;SizeOfImage))) {
01987 
01988                 PagesByThisModule += NumberOfPages;
01989             }
01990         
01991             NextEntry2 = NextEntry2-&gt;Flink;
01992     
01993         }
01994     
01995         <span class="keywordflow">if</span> (PagesByThisModule &gt; Highest) {
01996             Highest = PagesByThisModule;
01997             HighDataTableEntry = DataTableEntry;
01998         }
01999 
02000         NextEntry = NextEntry-&gt;Flink;
02001     }
02002 
02003     *NumberOfPtes = Highest;
02004 
02005     <span class="keywordflow">return</span> (PVOID)HighDataTableEntry;
02006 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="sysptes.c::MiGetSystemPteAvailability" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MiGetSystemPteAvailability           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfPtes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d1/mm_8h.html#a154">MM_PAGE_PRIORITY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Priority</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/sysptes_8c-source.html#l02030">2030</a> of file <a class="el" href="../../d1/d8/sysptes_8c-source.html">sysptes.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/mm_8h.html#a347a183">HighPagePriority</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00116">MM_PTE_TABLE_LIMIT</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00103">MmSysPteListBySizeCount</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00104">MmSysPteMinimumFree</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00098">MmSysPteTables</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00045">MmTotalFreeSystemPtes</a>, <a class="el" href="../../d2/d1/mm_8h.html#a347a182">NormalPagePriority</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l02395">MiMapSinglePage()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l02058">MmMapLockedPagesSpecifyCache()</a>.
<p>
<pre class="fragment"><div>02037                    :
02038 
02039     This routine checks how many <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a> PTEs are available <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02040     requested size.  If plenty are available then <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
02041     If we are reaching a <a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a> resource situation, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> evaluated
02042     based on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> argument priority.
02043 
02044 Arguments:
02045 
02046     NumberOfPtes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of PTEs needed.
02047 
02048     Priority - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> priority of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request.
02049 
02050 Return Value:
02051 
02052     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller should allocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTEs, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> not.
02053 
02054 Environment:
02055 
02056     Kernel mode.
02057 
02058 --*/
02059 
02060 {
02061     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02062     ULONG FreePtes;
02063     ULONG FreeBinnedPtes;
02064 
02065     <span class="keywordflow">if</span> (Priority == <a class="code" href="../../d2/d1/mm_8h.html#a347a183">HighPagePriority</a>) {
02066         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02067     }
02068 
02069 <span class="preprocessor">#ifdef _MI_GUARD_PTE_</span>
02070 <span class="preprocessor"></span>    NumberOfPtes += 1;
02071 <span class="preprocessor">#endif</span>
02072 <span class="preprocessor"></span>
02073     FreePtes = <a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>];
02074 
02075     <span class="keywordflow">if</span> (NumberOfPtes &lt;= <a class="code" href="../../d0/d9/sysptes_8c.html#a7">MM_PTE_TABLE_LIMIT</a>) {
02076         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d0/d9/sysptes_8c.html#a14">MmSysPteTables</a> [NumberOfPtes];
02077         FreeBinnedPtes = <a class="code" href="../../d0/d9/sysptes_8c.html#a17">MmSysPteListBySizeCount</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
02078 
02079         <span class="keywordflow">if</span> (FreeBinnedPtes &gt; <a class="code" href="../../d0/d9/sysptes_8c.html#a18">MmSysPteMinimumFree</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]) {
02080             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02081         }
02082         <span class="keywordflow">if</span> (FreeBinnedPtes != 0) {
02083             <span class="keywordflow">if</span> (Priority == <a class="code" href="../../d2/d1/mm_8h.html#a347a182">NormalPagePriority</a>) {
02084                 <span class="keywordflow">if</span> (FreeBinnedPtes &gt; 1 || FreePtes &gt; 512) {
02085                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02086                 }
02087                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02088             }
02089             <span class="keywordflow">if</span> (FreePtes &gt; 2048) {
02090                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02091             }
02092             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02093         }
02094     }
02095 
02096     <span class="keywordflow">if</span> (Priority == <a class="code" href="../../d2/d1/mm_8h.html#a347a182">NormalPagePriority</a>) {
02097         <span class="keywordflow">if</span> ((LONG)NumberOfPtes &lt; (LONG)FreePtes - 512) {
02098             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02099         }
02100         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02101     }
02102 
02103     <span class="keywordflow">if</span> ((LONG)NumberOfPtes &lt; (LONG)FreePtes - 2048) {
02104         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02105     }
02106     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02107 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="sysptes.c::MiGetSystemPteListCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG MiGetSystemPteListCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ListSize</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d4/procsup_8c-source.html#l02450">MmCreateKernelStack()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="sysptes.c::MiInitializeSystemPtes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiInitializeSystemPtes           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfPtes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d8/mi_8h.html#a512">MMSYSTEM_PTE_POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemPtePoolType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01740">1740</a> of file <a class="el" href="../../d1/d8/sysptes_8c-source.html">sysptes.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00110">MI_PTE_BASE_FOR_LOWEST_KERNEL_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02486">MI_WRITE_INVALID_PTE</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00807">MiAllocatePoolPages()</a>, <a class="el" href="../../d0/d9/sysptes_8c.html#a23">MiCountFreeSystemPtes()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02543">MiFillMemoryPte</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00524">MiReserveSystemPtes()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00107">MM_EMPTY_LIST</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00108">MM_EMPTY_PTE_LIST</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00110">MM_PTE_LIST_1</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00114">MM_PTE_LIST_16</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00111">MM_PTE_LIST_2</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00112">MM_PTE_LIST_4</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00113">MM_PTE_LIST_8</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02581">MM_SYS_PTE_TABLES_MAX</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04742">MmFirstFreeSystemPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04696">MmFlushCounter</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00076">MmFlushPte1</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00101">MmFreeSysPteListBySize</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00102">MmLastSysPteListBySize</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00096">MmSysPteIndex</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04806">MmSystemPteBase</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00054">MmSystemPtesEnd</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00053">MmSystemPtesStart</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00045">MmTotalFreeSystemPtes</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>.
<p>
Referenced by <a class="el" href="../../d2/d5/allocpag_8c-source.html#l02476">MiInitializeNonPagedPool()</a>, and <a class="el" href="../../d3/d0/inialpha_8c-source.html#l00041">MiInitMachineDependent()</a>.
<p>
<pre class="fragment"><div>01748                    :
01749 
01750     This routine initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system PTE <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
01751 
01752 Arguments:
01753 
01754     StartingPte - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first PTE to put in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
01755 
01756     NumberOfPtes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of PTEs to put in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
01757 
01758     SystemPtePoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> to initialize, one of
01759                         <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a> or <a class="code" href="../../d4/d8/mi_8h.html#a1003a770">NonPagedPoolExpansion</a>.
01760 
01761 Return Value:
01762 
01763     none.
01764 
01765 Environment:
01766 
01767     Kernel mode.
01768 
01769 --*/
01770 
01771 {
01772     LONG i;
01773     LONG j;
01774 <span class="preprocessor">#ifdef _MI_SYSPTE_DEBUG_</span>
01775 <span class="preprocessor"></span>    PMMPTE_TRACKER Tracker;
01776 <span class="preprocessor">#endif</span>
01777 <span class="preprocessor"></span>
01778     <span class="comment">//</span>
01779     <span class="comment">// Set the base of the system PTE pool to this PTE.  This takes into</span>
01780     <span class="comment">// account that systems may have additional PTE pools below the PTE_BASE.</span>
01781     <span class="comment">//</span>
01782 
01783     <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a2">MI_PTE_BASE_FOR_LOWEST_KERNEL_ADDRESS</a>;
01784 
01785     <a class="code" href="../../d8/d5/kddata_8c.html#a14">MmSystemPtesStart</a>[SystemPtePoolType] = StartingPte;
01786     <a class="code" href="../../d8/d5/kddata_8c.html#a15">MmSystemPtesEnd</a>[SystemPtePoolType] = StartingPte + NumberOfPtes - 1;
01787 
01788     <span class="comment">//</span>
01789     <span class="comment">// If there are no PTEs specified, then make a valid chain by indicating</span>
01790     <span class="comment">// that the list is empty.</span>
01791     <span class="comment">//</span>
01792 
01793     <span class="keywordflow">if</span> (NumberOfPtes == 0) {
01794         <a class="code" href="../../d4/d8/mi_8h.html#a655">MmFirstFreeSystemPte</a>[SystemPtePoolType] = <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>;
01795         <a class="code" href="../../d4/d8/mi_8h.html#a655">MmFirstFreeSystemPte</a>[SystemPtePoolType].<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry =
01796                                                                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
01797         <span class="keywordflow">return</span>;
01798     }
01799 
01800     <span class="comment">//</span>
01801     <span class="comment">// Initialize the specified system pte pool.</span>
01802     <span class="comment">//</span>
01803 
01804     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a189">MiFillMemoryPte</a> (StartingPte,
01805                      NumberOfPtes * <span class="keyword">sizeof</span> (<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>),
01806                      <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
01807 
01808     <span class="comment">//</span>
01809     <span class="comment">// The page frame field points to the next cluster.  As we only</span>
01810     <span class="comment">// have one cluster at initialization time, mark it as the last</span>
01811     <span class="comment">// cluster.</span>
01812     <span class="comment">//</span>
01813 
01814     StartingPte-&gt;u.List.NextEntry = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
01815 
01816     <a class="code" href="../../d4/d8/mi_8h.html#a655">MmFirstFreeSystemPte</a>[SystemPtePoolType] = <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>;
01817     <a class="code" href="../../d4/d8/mi_8h.html#a655">MmFirstFreeSystemPte</a>[SystemPtePoolType].<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry =
01818                                                 StartingPte - <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a>;
01819 
01820     <span class="comment">//</span>
01821     <span class="comment">// If there is only one PTE in the pool, then mark it as a one entry</span>
01822     <span class="comment">// PTE. Otherwise, store the cluster size in the following PTE.</span>
01823     <span class="comment">//</span>
01824 
01825     <span class="keywordflow">if</span> (NumberOfPtes == 1) {
01826         StartingPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.OneEntry = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01827 
01828     } <span class="keywordflow">else</span> {
01829         StartingPte += 1;
01830         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (StartingPte, ZeroKernelPte);
01831         StartingPte-&gt;u.List.NextEntry = NumberOfPtes;
01832     }
01833 
01834     <span class="comment">//</span>
01835     <span class="comment">// Set the total number of free PTEs for the specified type.</span>
01836     <span class="comment">//</span>
01837 
01838     <a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[SystemPtePoolType] = NumberOfPtes;
01839 
01840     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmTotalFreeSystemPtes[SystemPtePoolType] ==
01841                          MiCountFreeSystemPtes (SystemPtePoolType));
01842 
01843     <span class="keywordflow">if</span> (SystemPtePoolType == <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>) {
01844 
01845         ULONG Lists[<a class="code" href="../../d4/d8/mi_8h.html#a237">MM_SYS_PTE_TABLES_MAX</a>] = {<a class="code" href="../../d0/d9/sysptes_8c.html#a2">MM_PTE_LIST_1</a>, <a class="code" href="../../d0/d9/sysptes_8c.html#a3">MM_PTE_LIST_2</a>, <a class="code" href="../../d0/d9/sysptes_8c.html#a4">MM_PTE_LIST_4</a>, <a class="code" href="../../d0/d9/sysptes_8c.html#a5">MM_PTE_LIST_8</a>, <a class="code" href="../../d0/d9/sysptes_8c.html#a6">MM_PTE_LIST_16</a>};
01846         <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01847         ULONG total;
01848 
01849 <span class="preprocessor">#ifdef _MI_SYSPTE_DEBUG_</span>
01850 <span class="preprocessor"></span>        Tracker = (PMMPTE_TRACKER) <a class="code" href="../../d1/d6/allocpag_8c.html#a54">MiAllocatePoolPages</a> (
01851                                           NonPagedPool,
01852                                           NumberOfPtes * <span class="keyword">sizeof</span> (MMPTE_TRACKER),
01853                                           0);
01854 
01855         <span class="keywordflow">if</span> (Tracker) {
01856             RtlZeroMemory (Tracker, NumberOfPtes * <span class="keyword">sizeof</span> (MMPTE_TRACKER));
01857         }
01858 <span class="preprocessor">#endif</span>
01859 <span class="preprocessor"></span>
01860         <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="../../d4/d8/mi_8h.html#a237">MM_SYS_PTE_TABLES_MAX</a> ; j++) {
01861             <a class="code" href="../../d0/d9/sysptes_8c.html#a15">MmFreeSysPteListBySize</a> [j].<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>;
01862             <a class="code" href="../../d0/d9/sysptes_8c.html#a16">MmLastSysPteListBySize</a> [j] = &amp;<a class="code" href="../../d0/d9/sysptes_8c.html#a15">MmFreeSysPteListBySize</a> [j];
01863         }
01864         <a class="code" href="../../d4/d8/mi_8h.html#a644">MmFlushCounter</a> += 1;
01865 
01866 <span class="preprocessor">#ifndef _MI_GUARD_PTE_</span>
01867 <span class="preprocessor"></span>
01868         <span class="comment">//</span>
01869         <span class="comment">// Initialize the by size lists.</span>
01870         <span class="comment">//</span>
01871 
01872         total = <a class="code" href="../../d0/d9/sysptes_8c.html#a2">MM_PTE_LIST_1</a> * <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a>[0] +
01873                 <a class="code" href="../../d0/d9/sysptes_8c.html#a3">MM_PTE_LIST_2</a> * <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a>[1] +
01874                 <a class="code" href="../../d0/d9/sysptes_8c.html#a4">MM_PTE_LIST_4</a> * <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a>[2] +
01875                 <a class="code" href="../../d0/d9/sysptes_8c.html#a5">MM_PTE_LIST_8</a> * <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a>[3] +
01876                 <a class="code" href="../../d0/d9/sysptes_8c.html#a6">MM_PTE_LIST_16</a> * <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a>[4];
01877 
01878         PointerPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a> (total,
01879                                           SystemPteSpace,
01880                                           64*1024,
01881                                           0,
01882                                           TRUE);
01883 
01884         <span class="keywordflow">for</span> (i = (<a class="code" href="../../d4/d8/mi_8h.html#a237">MM_SYS_PTE_TABLES_MAX</a> - 1); i &gt;= 0; i--) {
01885             <span class="keywordflow">do</span> {
01886                 Lists[i] -= 1;
01887                 <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (PointerPte,
01888                                      MmSysPteIndex[i],
01889                                      SystemPteSpace);
01890                 PointerPte += <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a>[i];
01891             } <span class="keywordflow">while</span> (Lists[i] != 0  );
01892         }
01893 <span class="preprocessor">#endif</span>
01894 <span class="preprocessor"></span>
01895         <a class="code" href="../../d4/d8/mi_8h.html#a644">MmFlushCounter</a> += 1;
01896         <a class="code" href="../../d0/d9/sysptes_8c.html#a11">MmFlushPte1</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01897 
01898 <span class="preprocessor">#ifdef _MI_SYSPTE_DEBUG_</span>
01899 <span class="preprocessor"></span>        MiPteTracker = Tracker;
01900 <span class="preprocessor">#endif</span>
01901 <span class="preprocessor"></span>    }
01902 
01903     <span class="keywordflow">return</span>;
01904 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="sysptes.c::MiReleaseSystemPtes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiReleaseSystemPtes           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfPtes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d8/mi_8h.html#a512">MMSYSTEM_PTE_POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemPtePoolType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">1354</a> of file <a class="el" href="../../d1/d8/sysptes_8c-source.html">sysptes.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02655">_MMPTE_FLUSH_LIST::Count</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02656">_MMPTE_FLUSH_LIST::FlushPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02657">_MMPTE_FLUSH_LIST::FlushVa</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00033">KeFlushEntireTb()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d0/d9/sysptes_8c.html#a23">MiCountFreeSystemPtes()</a>, <a class="el" href="../../d0/d9/sysptes_8c.html#a22">MiDumpSystemPtes()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02543">MiFillMemoryPte</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01160">MiFlushPteList()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00822">MiLockSystemSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00825">MiUnlockSystemSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00173">MM_DBG_SYS_PTES</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00108">MM_EMPTY_PTE_LIST</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00431">MM_KERNEL_NOACCESS_PTE</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00074">MM_MAX_SYSPTE_FREE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00127">MM_MAXIMUM_FLUSH_COUNT</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00073">MM_MIN_SYSPTE_FREE</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00116">MM_PTE_TABLE_LIMIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04742">MmFirstFreeSystemPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04696">MmFlushCounter</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00076">MmFlushPte1</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00101">MmFreeSysPteListBySize</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00102">MmLastSysPteListBySize</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00096">MmSysPteIndex</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00103">MmSysPteListBySizeCount</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00104">MmSysPteMinimumFree</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00098">MmSysPteTables</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04806">MmSystemPteBase</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00054">MmSystemPtesEnd</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00053">MmSystemPtesStart</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00045">MmTotalFreeSystemPtes</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00970">ExFreePool()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01907">MiAddSystemPtes()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l01544">MiDereferenceSession()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00788">MiFeedSysPtePool()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00708">MiFreeNonPagedPool()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01740">MiInitializeSystemPtes()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l01474">MiLoadImageSection()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l05956">MiReloadBootLoadedDrivers()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l00394">MiSessionCreateInternal()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l02543">MiUnmapSinglePage()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03942">MmAllocateIndependentPages()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05581">MmAllocateNonCachedMemory()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l02723">MmDeleteKernelStack()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05721">MmFreeNonCachedMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03415">MmMapIoSpace()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l02058">MmMapLockedPagesSpecifyCache()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07516">MmMapVideoDisplay()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">MmUnloadSystemImage()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03678">MmUnmapIoSpace()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03124">MmUnmapLockedPages()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l07751">MmUnmapVideoDisplay()</a>.
<p>
<pre class="fragment"><div>01362                    :
01363 
01364     This function releases <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified number of PTEs
01365     within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non paged portion of system space.
01366 
01367     Note that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTEs must be invalid and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page frame number
01368     must have been set to zero.
01369 
01370 Arguments:
01371 
01372     StartingPte - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first PTE to release.
01373 
01374     NumberOfPtes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of PTEs to release.
01375 
01376     SystemPtePoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> to release PTEs to,
01377                         one of <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a> or <a class="code" href="../../d4/d8/mi_8h.html#a1003a770">NonPagedPoolExpansion</a>.
01378 
01379 Return Value:
01380 
01381     none.
01382 
01383 Environment:
01384 
01385     Kernel mode.
01386 
01387 --*/
01388 
01389 {
01390     ULONG_PTR <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
01391     ULONG i;
01392     ULONG_PTR PteOffset;
01393     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01394     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerFollowingPte;
01395     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> NextPte;
01396     KIRQL OldIrql;
01397     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01398 <span class="preprocessor">#if defined(_IA64_)</span>
01399 <span class="preprocessor"></span>    <a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html">MMPTE_FLUSH_LIST</a> PteFlushList;
01400     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> Previous;
01401     PVOID BaseAddress;
01402 <span class="preprocessor">#endif</span>
01403 <span class="preprocessor"></span>
01404     <span class="comment">//</span>
01405     <span class="comment">// Check to make sure the PTEs don't map anything.</span>
01406     <span class="comment">//</span>
01407 
01408     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfPtes != 0);
01409 
01410 <span class="preprocessor">#ifdef _MI_GUARD_PTE_</span>
01411 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (NumberOfPtes == 0) {
01412         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SYSTEM_PTE_MISUSE,
01413                       0xD,
01414                       (ULONG_PTR)StartingPte,
01415                       NumberOfPtes,
01416                       SystemPtePoolType);
01417     }
01418 
01419     <span class="keywordflow">if</span> (SystemPtePoolType == <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>) {
01420         <span class="keywordflow">if</span> ((StartingPte + NumberOfPtes)-&gt;u.Long != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a97">MM_KERNEL_NOACCESS_PTE</a>) {
01421             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SYSTEM_PTE_MISUSE,
01422                           0xE,
01423                           (ULONG_PTR)StartingPte,
01424                           NumberOfPtes,
01425                           SystemPtePoolType);
01426         }
01427         NumberOfPtes += 1;
01428     }
01429 <span class="preprocessor">#endif</span>
01430 <span class="preprocessor"></span>
01431 <span class="preprocessor">#if DBG</span>
01432 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (StartingPte &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a14">MmSystemPtesStart</a>[SystemPtePoolType]) {
01433         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SYSTEM_PTE_MISUSE,
01434                       0xF,
01435                       (ULONG_PTR)StartingPte,
01436                       NumberOfPtes,
01437                       SystemPtePoolType);
01438     }
01439 
01440     <span class="keywordflow">if</span> (StartingPte &gt; <a class="code" href="../../d8/d5/kddata_8c.html#a15">MmSystemPtesEnd</a>[SystemPtePoolType]) {
01441         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SYSTEM_PTE_MISUSE,
01442                       0x10,
01443                       (ULONG_PTR)StartingPte,
01444                       NumberOfPtes,
01445                       SystemPtePoolType);
01446     }
01447 <span class="preprocessor">#endif //DBG</span>
01448 <span class="preprocessor"></span>
01449 <span class="preprocessor">#if 0</span>
01450 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a65">MM_DBG_SYS_PTES</a>) {
01451         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"releasing 0x%lx system PTEs at location %lx\n"</span>,NumberOfPtes,StartingPte);
01452     }
01453 <span class="preprocessor">#endif //0</span>
01454 <span class="preprocessor"></span>
01455 <span class="preprocessor">#if defined(_IA64_)</span>
01456 <span class="preprocessor"></span>
01457     PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> = 0;
01458     Previous = StartingPte;
01459     BaseAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (Previous);
01460     <span class="keywordflow">for</span> (i = 0; i &lt; NumberOfPtes ; i++) {
01461         <span class="keywordflow">if</span> (PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> != <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>) {
01462             PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o1">FlushPte</a>[PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a>] = Previous;
01463             PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o2">FlushVa</a>[PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a>] = BaseAddress;
01464             PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> += 1;
01465         }
01466         *Previous = <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>;
01467         BaseAddress = (PVOID)((PCHAR)BaseAddress + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01468         Previous++;
01469     }
01470 
01471     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (DISPATCH_LEVEL, &amp;OldIrql);
01472     <a class="code" href="../../d4/d8/mi_8h.html#a888">MiFlushPteList</a> (&amp;PteFlushList, TRUE, ZeroKernelPte);
01473     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
01474 
01475 <span class="preprocessor">#else</span>
01476 <span class="preprocessor"></span>
01477     <span class="comment">//</span>
01478     <span class="comment">// Zero PTEs.</span>
01479     <span class="comment">//</span>
01480 
01481 <span class="preprocessor">#ifdef _MI_SYSPTE_DEBUG_</span>
01482 <span class="preprocessor"></span>    MiValidateSystemPtes (StartingPte, NumberOfPtes);
01483 <span class="preprocessor">#endif</span>
01484 <span class="preprocessor"></span>
01485     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a189">MiFillMemoryPte</a> (StartingPte,
01486                      NumberOfPtes * <span class="keyword">sizeof</span> (<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>),
01487                      <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
01488 
01489 <span class="preprocessor">#ifdef _MI_SYSPTE_DEBUG_</span>
01490 <span class="preprocessor"></span>
01491     <span class="comment">//</span>
01492     <span class="comment">// Invalidate any TB entries that might have been mapped to</span>
01493     <span class="comment">// immediately prevent bad callers from corrupting the system.</span>
01494     <span class="comment">//</span>
01495 
01496     <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (TRUE, TRUE);
01497 <span class="preprocessor">#endif</span>
01498 <span class="preprocessor"></span>
01499 <span class="preprocessor">#endif</span>
01500 <span class="preprocessor"></span>
01501     <span class="comment">//</span>
01502     <span class="comment">// Acquire system space spin lock to synchronize access.</span>
01503     <span class="comment">//</span>
01504 
01505     PteOffset = (ULONG_PTR)(StartingPte - <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a>);
01506 
01507 <span class="preprocessor">#ifdef _MI_SYSPTE_DEBUG_</span>
01508 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (PteOffset == 0) {
01509         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SYSTEM_PTE_MISUSE,
01510                       0x11,
01511                       (ULONG_PTR)StartingPte,
01512                       NumberOfPtes,
01513                       SystemPtePoolType);
01514     }
01515 <span class="preprocessor">#endif</span>
01516 <span class="preprocessor"></span>
01517     <a class="code" href="../../d4/d8/mi_8h.html#a117">MiLockSystemSpace</a>(OldIrql);
01518 
01519 <span class="preprocessor">#ifdef _MI_SYSPTE_DEBUG_</span>
01520 <span class="preprocessor"></span>    MiCheckPteRelease (StartingPte, NumberOfPtes);
01521 <span class="preprocessor">#endif</span>
01522 <span class="preprocessor"></span>
01523 <span class="preprocessor">#ifndef _MI_GUARD_PTE_</span>
01524 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((SystemPtePoolType == <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>) &amp;&amp;
01525         (NumberOfPtes &lt;= <a class="code" href="../../d0/d9/sysptes_8c.html#a7">MM_PTE_TABLE_LIMIT</a>)) {
01526 
01527         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d0/d9/sysptes_8c.html#a14">MmSysPteTables</a> [NumberOfPtes];
01528         NumberOfPtes = <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a> [<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01529 
01530         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>] &gt;= <a class="code" href="../../d0/d9/sysptes_8c.html#a0">MM_MIN_SYSPTE_FREE</a>) {
01531 
01532             <span class="comment">//</span>
01533             <span class="comment">// Don't add to the pool if the size is greater than 15 + the minimum.</span>
01534             <span class="comment">//</span>
01535 
01536             i = <a class="code" href="../../d0/d9/sysptes_8c.html#a18">MmSysPteMinimumFree</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01537             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>] &gt;= <a class="code" href="../../d0/d9/sysptes_8c.html#a1">MM_MAX_SYSPTE_FREE</a>) {
01538 
01539                 <span class="comment">//</span>
01540                 <span class="comment">// Lots of free PTEs, quadruple the limit.</span>
01541                 <span class="comment">//</span>
01542 
01543                 i = i * 4;
01544             }
01545             i += 15;
01546             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d9/sysptes_8c.html#a17">MmSysPteListBySizeCount</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] &lt;= i) {
01547 
01548 <span class="preprocessor">#if DBG</span>
01549 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a65">MM_DBG_SYS_PTES</a>) {
01550                     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte1;
01551 
01552                     PointerPte1 = &amp;<a class="code" href="../../d0/d9/sysptes_8c.html#a15">MmFreeSysPteListBySize</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01553                     <span class="keywordflow">while</span> (PointerPte1-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>) {
01554                         <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerFreedPte;
01555                         ULONG j;
01556 
01557                         PointerPte1 = <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a> + PointerPte1-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
01558                         PointerFreedPte = PointerPte1;
01559                         <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]; j++) {
01560                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerFreedPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
01561                             PointerFreedPte++;
01562                         }
01563                     }
01564                 }
01565 <span class="preprocessor">#endif //DBG</span>
01566 <span class="preprocessor"></span>                <a class="code" href="../../d0/d9/sysptes_8c.html#a17">MmSysPteListBySizeCount</a> [<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] += 1;
01567                 PointerPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a16">MmLastSysPteListBySize</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01568                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry == MM_EMPTY_PTE_LIST);
01569                 PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry = PteOffset;
01570                 <a class="code" href="../../d0/d9/sysptes_8c.html#a16">MmLastSysPteListBySize</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = StartingPte;
01571                 StartingPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>;
01572 
01573 <span class="preprocessor">#if DBG</span>
01574 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a65">MM_DBG_SYS_PTES</a>) {
01575                     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte1;
01576                     PointerPte1 = &amp;<a class="code" href="../../d0/d9/sysptes_8c.html#a15">MmFreeSysPteListBySize</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01577                     <span class="keywordflow">while</span> (PointerPte1-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>) {
01578                         <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerFreedPte;
01579                         ULONG j;
01580 
01581                         PointerPte1 = <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a> + PointerPte1-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
01582                         PointerFreedPte = PointerPte1;
01583                         <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]; j++) {
01584                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerFreedPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
01585                             PointerFreedPte++;
01586                         }
01587                     }
01588                 }
01589 <span class="preprocessor">#endif //DBG</span>
01590 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (NumberOfPtes == 1) {
01591                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d9/sysptes_8c.html#a11">MmFlushPte1</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01592                         <a class="code" href="../../d0/d9/sysptes_8c.html#a11">MmFlushPte1</a> = StartingPte;
01593                     }
01594                 } <span class="keywordflow">else</span> {
01595                     (StartingPte + 1)-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry = <a class="code" href="../../d4/d8/mi_8h.html#a644">MmFlushCounter</a>;
01596                 }
01597 
01598                 <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
01599                 <span class="keywordflow">return</span>;
01600             }
01601         }
01602     }
01603 <span class="preprocessor">#endif</span>
01604 <span class="preprocessor"></span>
01605     <a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[SystemPtePoolType] += NumberOfPtes;
01606 
01607     PteOffset = (ULONG_PTR)(StartingPte - <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a>);
01608     PointerPte = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a655">MmFirstFreeSystemPte</a>[SystemPtePoolType];
01609 
01610     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01611         NextPte = <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a> + PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
01612         <span class="keywordflow">if</span> (PteOffset &lt; PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry) {
01613 
01614             <span class="comment">//</span>
01615             <span class="comment">// Insert in the list at this point.  The</span>
01616             <span class="comment">// previous one should point to the new freed set and</span>
01617             <span class="comment">// the new freed set should point to the place</span>
01618             <span class="comment">// the previous set points to.</span>
01619             <span class="comment">//</span>
01620             <span class="comment">// Attempt to combine the clusters before we</span>
01621             <span class="comment">// insert.</span>
01622             <span class="comment">//</span>
01623             <span class="comment">// Locate the end of the current structure.</span>
01624             <span class="comment">//</span>
01625 
01626             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((StartingPte + NumberOfPtes) &lt;= NextPte) ||
01627                     (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry == MM_EMPTY_PTE_LIST));
01628 
01629             PointerFollowingPte = PointerPte + 1;
01630             <span class="keywordflow">if</span> (PointerPte-&gt;u.List.OneEntry) {
01631                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 1;
01632             } <span class="keywordflow">else</span> {
01633                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = (ULONG_PTR) PointerFollowingPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
01634             }
01635             <span class="keywordflow">if</span> ((PointerPte + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>) == StartingPte) {
01636 
01637                 <span class="comment">//</span>
01638                 <span class="comment">// We can combine the clusters.</span>
01639                 <span class="comment">//</span>
01640 
01641                 NumberOfPtes += (ULONG)<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
01642                 PointerFollowingPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry = NumberOfPtes;
01643                 PointerPte-&gt;u.List.OneEntry = 0;
01644 
01645                 <span class="comment">//</span>
01646                 <span class="comment">// Point the starting PTE to the beginning of</span>
01647                 <span class="comment">// the new free set and try to combine with the</span>
01648                 <span class="comment">// following free cluster.</span>
01649                 <span class="comment">//</span>
01650 
01651                 StartingPte = PointerPte;
01652 
01653             } <span class="keywordflow">else</span> {
01654 
01655                 <span class="comment">//</span>
01656                 <span class="comment">// Can't combine with previous. Make this Pte the</span>
01657                 <span class="comment">// start of a cluster.</span>
01658                 <span class="comment">//</span>
01659 
01660                 <span class="comment">//</span>
01661                 <span class="comment">// Point this cluster to the next cluster.</span>
01662                 <span class="comment">//</span>
01663 
01664                 StartingPte-&gt;u.List.NextEntry = PointerPte-&gt;u.List.NextEntry;
01665 
01666                 <span class="comment">//</span>
01667                 <span class="comment">// Point the current cluster to this cluster.</span>
01668                 <span class="comment">//</span>
01669 
01670                 PointerPte-&gt;u.List.NextEntry = PteOffset;
01671 
01672                 <span class="comment">//</span>
01673                 <span class="comment">// Set the size of this cluster.</span>
01674                 <span class="comment">//</span>
01675 
01676                 <span class="keywordflow">if</span> (NumberOfPtes == 1) {
01677                     StartingPte-&gt;u.List.OneEntry = 1;
01678 
01679                 } <span class="keywordflow">else</span> {
01680                     StartingPte-&gt;u.List.OneEntry = 0;
01681                     PointerFollowingPte = StartingPte + 1;
01682                     PointerFollowingPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry = NumberOfPtes;
01683                 }
01684             }
01685 
01686             <span class="comment">//</span>
01687             <span class="comment">// Attempt to combine the newly created cluster with</span>
01688             <span class="comment">// the following cluster.</span>
01689             <span class="comment">//</span>
01690 
01691             <span class="keywordflow">if</span> ((StartingPte + NumberOfPtes) == NextPte) {
01692 
01693                 <span class="comment">//</span>
01694                 <span class="comment">// Combine with following cluster.</span>
01695                 <span class="comment">//</span>
01696 
01697                 <span class="comment">//</span>
01698                 <span class="comment">// Set the next cluster to the value contained in the</span>
01699                 <span class="comment">// cluster we are merging into this one.</span>
01700                 <span class="comment">//</span>
01701 
01702                 StartingPte-&gt;u.List.NextEntry = NextPte-&gt;u.List.NextEntry;
01703                 StartingPte-&gt;u.List.OneEntry = 0;
01704                 PointerFollowingPte = StartingPte + 1;
01705 
01706                 <span class="keywordflow">if</span> (NextPte-&gt;u.List.OneEntry) {
01707                     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 1;
01708 
01709                 } <span class="keywordflow">else</span> {
01710                     NextPte++;
01711                     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = (ULONG_PTR) NextPte-&gt;u.List.NextEntry;
01712                 }
01713                 PointerFollowingPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry = NumberOfPtes + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
01714             }
01715 <span class="preprocessor">#if 0</span>
01716 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a65">MM_DBG_SYS_PTES</a>) {
01717                 <a class="code" href="../../d0/d9/sysptes_8c.html#a22">MiDumpSystemPtes</a>(SystemPtePoolType);
01718             }
01719 <span class="preprocessor">#endif //0</span>
01720 <span class="preprocessor"></span>
01721 <span class="preprocessor">#if DBG</span>
01722 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a65">MM_DBG_SYS_PTES</a>) {
01723                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmTotalFreeSystemPtes[SystemPtePoolType] ==
01724                          MiCountFreeSystemPtes (SystemPtePoolType));
01725             }
01726 <span class="preprocessor">#endif //DBG</span>
01727 <span class="preprocessor"></span>            <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
01728             <span class="keywordflow">return</span>;
01729         }
01730 
01731         <span class="comment">//</span>
01732         <span class="comment">// Point to next freed cluster.</span>
01733         <span class="comment">//</span>
01734 
01735         PointerPte = NextPte;
01736     }
01737 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="sysptes.c::MiReserveSystemPtes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> MiReserveSystemPtes           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfPtes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d8/mi_8h.html#a512">MMSYSTEM_PTE_POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemPtePoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Alignment</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Offset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BugCheckOnFailure</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00524">524</a> of file <a class="el" href="../../d1/d8/sysptes_8c-source.html">sysptes.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00033">KeFlushEntireTb()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00788">MiFeedSysPtePool()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00822">MiLockSystemSpace</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00843">MiReserveSystemPtes2()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00825">MiUnlockSystemSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00173">MM_DBG_SYS_PTES</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00108">MM_EMPTY_PTE_LIST</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00074">MM_FLUSH_COUNTER_MASK</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00431">MM_KERNEL_NOACCESS_PTE</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00116">MM_PTE_TABLE_LIMIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04696">MmFlushCounter</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00076">MmFlushPte1</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00101">MmFreeSysPteListBySize</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00102">MmLastSysPteListBySize</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00096">MmSysPteIndex</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00103">MmSysPteListBySizeCount</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00104">MmSysPteMinimumFree</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00098">MmSysPteTables</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04806">MmSystemPteBase</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00054">MmSystemPtesEnd</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00053">MmSystemPtesStart</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00282">PTE_SHIFT</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00413">ExAllocatePool()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00807">MiAllocatePoolPages()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l02184">MiBuildPagedPool()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l04569">MiFindContiguousMemory()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l02974">MiInitializeSpecialPool()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01740">MiInitializeSystemPtes()</a>, <a class="el" href="../../d3/d0/inialpha_8c-source.html#l00041">MiInitMachineDependent()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l01474">MiLoadImageSection()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l01440">MiMapBBTMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l02395">MiMapSinglePage()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l05956">MiReloadBootLoadedDrivers()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l00394">MiSessionCreateInternal()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03942">MmAllocateIndependentPages()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05581">MmAllocateNonCachedMemory()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l02450">MmCreateKernelStack()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03415">MmMapIoSpace()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l02058">MmMapLockedPagesSpecifyCache()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l07516">MmMapVideoDisplay()</a>.
<p>
<pre class="fragment"><div>00534                    :
00535 
00536     This function locates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified number of unused PTEs to locate
00537     within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non paged portion of system space.
00538 
00539 Arguments:
00540 
00541     NumberOfPtes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of PTEs to locate.
00542 
00543     SystemPtePoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> to expand, one of
00544                         <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a> or <a class="code" href="../../d4/d8/mi_8h.html#a1003a770">NonPagedPoolExpansion</a>.
00545 
00546     Alignment - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address alignment <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address
00547                 <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned PTE maps. For example, <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> 64K,
00548                 <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned PTE will map an address on a 64K boundary.
00549                 An alignment of zero means to align on a page boundary.
00550 
00551     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> alignment <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address.
00552              For example, <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Alignment <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> 64k and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> 4k,
00553              <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned address will be 4k above a 64k boundary.
00554 
00555     BugCheckOnFailure - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> should be returned <span class="keywordflow">if</span>
00556                         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request cannot be satisfied, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span>
00557                         a bugcheck should be issued.
00558 
00559 Return Value:
00560 
00561     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first PTE located.
00562     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> no system PTEs can be located and BugCheckOnFailure <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
00563 
00564 Environment:
00565 
00566     Kernel mode, <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> or below.
00567 
00568 --*/
00569 
00570 {
00571     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00572     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> Previous;
00573     KIRQL OldIrql;
00574     ULONG PteMask;
00575     ULONG MaskSize;
00576     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00577 
00578 <span class="preprocessor">#ifdef _MI_GUARD_PTE_</span>
00579 <span class="preprocessor"></span>    ULONG ExactPtes;
00580 
00581     <span class="keywordflow">if</span> (NumberOfPtes == 0) {
00582         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SYSTEM_PTE_MISUSE,
00583                       0xA,
00584                       BugCheckOnFailure,
00585                       NumberOfPtes,
00586                       SystemPtePoolType);
00587     }
00588 
00589     <span class="keywordflow">if</span> (SystemPtePoolType == <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>) {
00590         NumberOfPtes += 1;
00591     }
00592 
00593     ExactPtes = NumberOfPtes;
00594 <span class="preprocessor">#endif</span>
00595 <span class="preprocessor"></span>
00596     <span class="keywordflow">if</span> (SystemPtePoolType == <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>) {
00597 
00598         MaskSize = (Alignment - 1) &gt;&gt; (<a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> - <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>);
00599         PteMask = MaskSize &amp; (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &gt;&gt; (<a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> - <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>));
00600 
00601         <span class="comment">//</span>
00602         <span class="comment">// Acquire the system space lock to synchronize access to this</span>
00603         <span class="comment">// routine.</span>
00604         <span class="comment">//</span>
00605 
00606         <a class="code" href="../../d4/d8/mi_8h.html#a117">MiLockSystemSpace</a>(OldIrql);
00607 
00608         <span class="keywordflow">if</span> (NumberOfPtes &lt;= <a class="code" href="../../d0/d9/sysptes_8c.html#a7">MM_PTE_TABLE_LIMIT</a>) {
00609             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d0/d9/sysptes_8c.html#a14">MmSysPteTables</a> [NumberOfPtes];
00610             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfPtes &lt;= MmSysPteIndex[Index]);
00611             PointerPte = &amp;<a class="code" href="../../d0/d9/sysptes_8c.html#a15">MmFreeSysPteListBySize</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00612 <span class="preprocessor">#if DBG</span>
00613 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a65">MM_DBG_SYS_PTES</a>) {
00614                 <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte1;
00615                 PointerPte1 = &amp;<a class="code" href="../../d0/d9/sysptes_8c.html#a15">MmFreeSysPteListBySize</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00616                 <span class="keywordflow">while</span> (PointerPte1-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>) {
00617                     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerFreedPte;
00618                     ULONG j;
00619 
00620                     PointerPte1 = <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a> + PointerPte1-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
00621                     PointerFreedPte = PointerPte1;
00622                     <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]; j++) {
00623                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerFreedPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
00624                         PointerFreedPte++;
00625                     }
00626                 }
00627             }
00628 <span class="preprocessor">#endif //DBG</span>
00629 <span class="preprocessor"></span>
00630             Previous = PointerPte;
00631 
00632             <span class="keywordflow">while</span> (PointerPte-&gt;u.List.NextEntry != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>) {
00633 
00634                 <span class="comment">//</span>
00635                 <span class="comment">//  Try to find suitable PTEs with the proper alignment.</span>
00636                 <span class="comment">//</span>
00637 
00638                 Previous = PointerPte;
00639                 PointerPte = <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a> + PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
00640 <span class="preprocessor">#if !defined(_IA64_)</span>
00641 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (PointerPte == <a class="code" href="../../d0/d9/sysptes_8c.html#a11">MmFlushPte1</a>) {
00642                     <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (TRUE, TRUE);
00643                     <a class="code" href="../../d4/d8/mi_8h.html#a644">MmFlushCounter</a> = (<a class="code" href="../../d4/d8/mi_8h.html#a644">MmFlushCounter</a> + 1) &amp; <a class="code" href="../../d4/d8/mi_8h.html#a8">MM_FLUSH_COUNTER_MASK</a>;
00644                     <a class="code" href="../../d0/d9/sysptes_8c.html#a11">MmFlushPte1</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00645                 }
00646 <span class="preprocessor">#endif</span>
00647 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ((Alignment == 0) ||
00648                     (((ULONG_PTR)PointerPte &amp; MaskSize) == PteMask)) {
00649 
00650 <span class="preprocessor">#ifdef _MI_SYSPTE_DEBUG_</span>
00651 <span class="preprocessor"></span>                    MiCheckPteAllocation (PointerPte,
00652                                           NumberOfPtes,
00653                                           0,
00654                                           MmSysPteIndex[Index]);
00655 <span class="preprocessor">#endif</span>
00656 <span class="preprocessor"></span>                    <span class="comment">//</span>
00657                     <span class="comment">// Proper alignment and offset, update list index.</span>
00658                     <span class="comment">//</span>
00659 
00660                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((PointerPte-&gt;u.List.NextEntry + MmSystemPteBase) &gt;=
00661                              MmSystemPtesStart[SystemPtePoolType] ||
00662                              PointerPte-&gt;u.List.NextEntry == MM_EMPTY_PTE_LIST);
00663                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((PointerPte-&gt;u.List.NextEntry + MmSystemPteBase) &lt;=
00664                              MmSystemPtesEnd[SystemPtePoolType] ||
00665                              PointerPte-&gt;u.List.NextEntry == MM_EMPTY_PTE_LIST);
00666 
00667                     Previous-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry = PointerPte-&gt;u.List.NextEntry;
00668                     <a class="code" href="../../d0/d9/sysptes_8c.html#a17">MmSysPteListBySizeCount</a> [<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] -= 1;
00669 
00670 <span class="preprocessor">#if !defined(_IA64_)</span>
00671 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (NumberOfPtes != 1) {
00672 
00673                         <span class="comment">//</span>
00674                         <span class="comment">// Check to see if the TB should be flushed.</span>
00675                         <span class="comment">//</span>
00676 
00677                         <span class="keywordflow">if</span> ((PointerPte + 1)-&gt;u.List.NextEntry == <a class="code" href="../../d4/d8/mi_8h.html#a644">MmFlushCounter</a>) {
00678                             <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (TRUE, TRUE);
00679                             <a class="code" href="../../d4/d8/mi_8h.html#a644">MmFlushCounter</a> = (<a class="code" href="../../d4/d8/mi_8h.html#a644">MmFlushCounter</a> + 1) &amp;
00680                                                     <a class="code" href="../../d4/d8/mi_8h.html#a8">MM_FLUSH_COUNTER_MASK</a>;
00681                             <a class="code" href="../../d0/d9/sysptes_8c.html#a11">MmFlushPte1</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00682                         }
00683                     }
00684 <span class="preprocessor">#endif</span>
00685 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (PointerPte-&gt;u.List.NextEntry == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>) {
00686                         <a class="code" href="../../d0/d9/sysptes_8c.html#a16">MmLastSysPteListBySize</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = Previous;
00687                     }
00688 <span class="preprocessor">#if DBG</span>
00689 <span class="preprocessor"></span>
00690                     <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a65">MM_DBG_SYS_PTES</a>) {
00691                         <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte1;
00692                         PointerPte1 = &amp;<a class="code" href="../../d0/d9/sysptes_8c.html#a15">MmFreeSysPteListBySize</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00693                         <span class="keywordflow">while</span> (PointerPte1-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>) {
00694                             <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerFreedPte;
00695                             ULONG j;
00696 
00697                             PointerPte1 = <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a> + PointerPte1-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
00698                             PointerFreedPte = PointerPte1;
00699                             <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]; j++) {
00700                                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerFreedPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
00701                                 PointerFreedPte++;
00702                             }
00703                         }
00704                     }
00705 <span class="preprocessor">#endif //DBG</span>
00706 <span class="preprocessor"></span>                    <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
00707 
00708 <span class="preprocessor">#if DBG</span>
00709 <span class="preprocessor"></span>                    PointerPte-&gt;u.List.NextEntry = 0xABCDE;
00710                     <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a65">MM_DBG_SYS_PTES</a>) {
00711 
00712                         <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerFreedPte;
00713                         ULONG j;
00714 
00715                         PointerFreedPte = PointerPte;
00716                         <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]; j++) {
00717                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerFreedPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
00718                             PointerFreedPte++;
00719                         }
00720                     }
00721                     <span class="keywordflow">if</span> (PointerPte &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a14">MmSystemPtesStart</a>[SystemPtePoolType]) {
00722                         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SYSTEM_PTE_MISUSE,
00723                                       0xB,
00724                                       (ULONG_PTR)PointerPte,
00725                                       NumberOfPtes,
00726                                       SystemPtePoolType);
00727                     }
00728                     <span class="keywordflow">if</span> (PointerPte &gt; <a class="code" href="../../d8/d5/kddata_8c.html#a15">MmSystemPtesEnd</a>[SystemPtePoolType]) {
00729                         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SYSTEM_PTE_MISUSE,
00730                                       0xC,
00731                                       (ULONG_PTR)PointerPte,
00732                                       NumberOfPtes,
00733                                       SystemPtePoolType);
00734                     }
00735 <span class="preprocessor">#endif //DBG</span>
00736 <span class="preprocessor"></span>
00737                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d9/sysptes_8c.html#a17">MmSysPteListBySizeCount</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] &lt;
00738                                             <a class="code" href="../../d0/d9/sysptes_8c.html#a18">MmSysPteMinimumFree</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]) {
00739                         <a class="code" href="../../d0/d9/sysptes_8c.html#a19">MiFeedSysPtePool</a> (Index);
00740                     }
00741 <span class="preprocessor">#ifdef _MI_GUARD_PTE_</span>
00742 <span class="preprocessor"></span>                    (PointerPte + ExactPtes - 1)-&gt;u.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a97">MM_KERNEL_NOACCESS_PTE</a>;
00743 <span class="preprocessor">#endif</span>
00744 <span class="preprocessor"></span>                    <span class="keywordflow">return</span> PointerPte;
00745                 }
00746             }
00747             NumberOfPtes = <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a> [<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00748         }
00749         <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
00750     }
00751 
00752 <span class="preprocessor">#ifdef _MI_GUARD_PTE_</span>
00753 <span class="preprocessor"></span>    NumberOfPtes = ExactPtes;
00754 <span class="preprocessor">#endif</span>
00755 <span class="preprocessor"></span>
00756     PointerPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a20">MiReserveSystemPtes2</a> (NumberOfPtes,
00757                                        SystemPtePoolType,
00758                                        Alignment,
00759                                        Offset,
00760                                        BugCheckOnFailure);
00761 
00762 <span class="preprocessor">#if DBG</span>
00763 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a65">MM_DBG_SYS_PTES</a>) {
00764 
00765         <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerFreedPte;
00766         ULONG j;
00767 
00768         <span class="keywordflow">if</span> (PointerPte) {
00769             PointerFreedPte = PointerPte;
00770             <span class="keywordflow">for</span> (j = 0; j &lt; NumberOfPtes; j++) {
00771                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerFreedPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
00772                 PointerFreedPte++;
00773             }
00774         }
00775     }
00776 <span class="preprocessor">#endif //DBG</span>
00777 <span class="preprocessor"></span>
00778 <span class="preprocessor">#ifdef _MI_GUARD_PTE_</span>
00779 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (PointerPte) {
00780         (PointerPte + ExactPtes - 1)-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a97">MM_KERNEL_NOACCESS_PTE</a>;
00781     }
00782 <span class="preprocessor">#endif</span>
00783 <span class="preprocessor"></span>
00784     <span class="keywordflow">return</span> PointerPte;
00785 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="sysptes.c::MiReserveSystemPtes2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> MiReserveSystemPtes2           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfPtes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d8/mi_8h.html#a512">MMSYSTEM_PTE_POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemPtePoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Alignment</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Offset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BugCheckOnFailure</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00843">843</a> of file <a class="el" href="../../d1/d8/sysptes_8c-source.html">sysptes.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02655">_MMPTE_FLUSH_LIST::Count</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02656">_MMPTE_FLUSH_LIST::FlushPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02657">_MMPTE_FLUSH_LIST::FlushVa</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d0/d9/sysptes_8c.html#a23">MiCountFreeSystemPtes()</a>, <a class="el" href="../../d0/d9/sysptes_8c.html#a22">MiDumpSystemPtes()</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01160">MiFlushPteList()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01901">MiGetHighestPteConsumer()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00822">MiLockSystemSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00825">MiUnlockSystemSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00173">MM_DBG_SYS_PTES</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00108">MM_EMPTY_PTE_LIST</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00127">MM_MAXIMUM_FLUSH_COUNT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04742">MmFirstFreeSystemPte</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00079">MmNumberOfSystemPtes</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04806">MmSystemPteBase</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00045">MmTotalFreeSystemPtes</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00282">PTE_SHIFT</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>.
<p>
Referenced by <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00788">MiFeedSysPtePool()</a>, and <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00524">MiReserveSystemPtes()</a>.
<p>
<pre class="fragment"><div>00853                    :
00854 
00855     This function locates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified number of unused PTEs to locate
00856     within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non paged portion of system space.
00857 
00858 Arguments:
00859 
00860     NumberOfPtes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of PTEs to locate.
00861 
00862     SystemPtePoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> to expand, one of
00863                         <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a> or <a class="code" href="../../d4/d8/mi_8h.html#a1003a770">NonPagedPoolExpansion</a>.
00864 
00865     Alignment - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address alignment <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address
00866                 <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned PTE maps. For example, <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> 64K,
00867                 <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned PTE will map an address on a 64K boundary.
00868                 An alignment of zero means to align on a page boundary.
00869 
00870     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> alignment <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address.
00871              For example, <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Alignment <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> 64k and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> 4k,
00872              <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned address will be 4k above a 64k boundary.
00873 
00874     BugCheckOnFailure - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> should be returned <span class="keywordflow">if</span>
00875                         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request cannot be satisfied, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span>
00876                         a bugcheck should be issued.
00877 
00878 Return Value:
00879 
00880     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first PTE located.
00881     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> no system PTEs can be located and BugCheckOnFailure <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
00882 
00883 Environment:
00884 
00885     Kernel mode, <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> or below.
00886 
00887 --*/
00888 
00889 {
00890     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00891     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerFollowingPte;
00892     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> Previous;
00893     ULONG_PTR SizeInSet;
00894     KIRQL OldIrql;
00895     ULONG MaskSize;
00896     ULONG NumberOfRequiredPtes;
00897     ULONG OffsetSum;
00898     ULONG PtesToObtainAlignment;
00899     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> NextSetPointer;
00900     ULONG_PTR LeftInSet;
00901     ULONG_PTR PteOffset;
00902     <a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html">MMPTE_FLUSH_LIST</a> PteFlushList;
00903     PVOID HighConsumer;
00904     ULONG_PTR HighPteUse;
00905 
00906     MaskSize = (Alignment - 1) &gt;&gt; (<a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> - <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>);
00907 
00908     OffsetSum = (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &gt;&gt; (<a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> - <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>)) |
00909                             (Alignment &gt;&gt; (<a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> - <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>));
00910 
00911     <a class="code" href="../../d4/d8/mi_8h.html#a117">MiLockSystemSpace</a>(OldIrql);
00912 
00913     <span class="comment">//</span>
00914     <span class="comment">// The nonpaged PTE pool uses the invalid PTEs to define the pool</span>
00915     <span class="comment">// structure.   A global pointer points to the first free set</span>
00916     <span class="comment">// in the list, each free set contains the number free and a pointer</span>
00917     <span class="comment">// to the next free set.  The free sets are kept in an ordered list</span>
00918     <span class="comment">// such that the pointer to the next free set is always greater</span>
00919     <span class="comment">// than the address of the current free set.</span>
00920     <span class="comment">//</span>
00921     <span class="comment">// As to not limit the size of this pool, two PTEs are used</span>
00922     <span class="comment">// to define a free region.  If the region is a single PTE, the</span>
00923     <span class="comment">// prototype field within the PTE is set indicating the set</span>
00924     <span class="comment">// consists of a single PTE.</span>
00925     <span class="comment">//</span>
00926     <span class="comment">// The page frame number field is used to define the next set</span>
00927     <span class="comment">// and the number free.  The two flavors are:</span>
00928     <span class="comment">//</span>
00929     <span class="comment">//                           o          V</span>
00930     <span class="comment">//                           n          l</span>
00931     <span class="comment">//                           e          d</span>
00932     <span class="comment">//  +-----------------------+-+----------+</span>
00933     <span class="comment">//  |  next set             |0|0        0|</span>
00934     <span class="comment">//  +-----------------------+-+----------+</span>
00935     <span class="comment">//  |  number in this set   |0|0        0|</span>
00936     <span class="comment">//  +-----------------------+-+----------+</span>
00937     <span class="comment">//</span>
00938     <span class="comment">//</span>
00939     <span class="comment">//  +-----------------------+-+----------+</span>
00940     <span class="comment">//  |  next set             |1|0        0|</span>
00941     <span class="comment">//  +-----------------------+-+----------+</span>
00942     <span class="comment">//  ...</span>
00943     <span class="comment">//</span>
00944 
00945     <span class="comment">//</span>
00946     <span class="comment">// Acquire the system space lock to synchronize access to this routine.</span>
00947     <span class="comment">//</span>
00948 
00949     PointerPte = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a655">MmFirstFreeSystemPte</a>[SystemPtePoolType];
00950     Previous = PointerPte;
00951 
00952     <span class="keywordflow">if</span> (PointerPte-&gt;u.List.NextEntry == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>) {
00953 
00954         <span class="comment">//</span>
00955         <span class="comment">// End of list and none found, return NULL or bugcheck.</span>
00956         <span class="comment">//</span>
00957 
00958         <span class="keywordflow">if</span> (BugCheckOnFailure) {
00959             <span class="keywordflow">goto</span> IssueBugcheck;
00960         }
00961 
00962         <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
00963         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00964     }
00965 
00966     PointerPte = <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a> + PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
00967 
00968     <span class="keywordflow">if</span> (Alignment &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) {
00969 
00970         <span class="comment">//</span>
00971         <span class="comment">// Don't deal with alignment issues.</span>
00972         <span class="comment">//</span>
00973 
00974         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00975 
00976             <span class="keywordflow">if</span> (PointerPte-&gt;u.List.OneEntry) {
00977                 SizeInSet = 1;
00978 
00979             } <span class="keywordflow">else</span> {
00980 
00981                 PointerFollowingPte = PointerPte + 1;
00982                 SizeInSet = (ULONG_PTR) PointerFollowingPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
00983             }
00984 
00985             <span class="keywordflow">if</span> (NumberOfPtes &lt; SizeInSet) {
00986 
00987                 <span class="comment">//</span>
00988                 <span class="comment">// Get the PTEs from this set and reduce the size of the</span>
00989                 <span class="comment">// set.  Note that the size of the current set cannot be 1.</span>
00990                 <span class="comment">//</span>
00991 
00992                 <span class="keywordflow">if</span> ((SizeInSet - NumberOfPtes) == 1) {
00993 
00994                     <span class="comment">//</span>
00995                     <span class="comment">// Collapse to the single PTE format.</span>
00996                     <span class="comment">//</span>
00997 
00998                     PointerPte-&gt;u.List.OneEntry = 1;
00999 
01000                 } <span class="keywordflow">else</span> {
01001 
01002                     PointerFollowingPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry = SizeInSet - NumberOfPtes;
01003 
01004                     <span class="comment">//</span>
01005                     <span class="comment">// Get the required PTEs from the end of the set.</span>
01006                     <span class="comment">//</span>
01007 
01008 <span class="preprocessor">#if 0</span>
01009 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a65">MM_DBG_SYS_PTES</a>) {
01010                         <a class="code" href="../../d0/d9/sysptes_8c.html#a22">MiDumpSystemPtes</a>(SystemPtePoolType);
01011                         PointerFollowingPte = PointerPte + (SizeInSet - NumberOfPtes);
01012                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"allocated 0x%lx Ptes at %lx\n"</span>,NumberOfPtes,PointerFollowingPte);
01013                     }
01014 <span class="preprocessor">#endif //0</span>
01015 <span class="preprocessor"></span>                }
01016 
01017                 <a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[SystemPtePoolType] -= NumberOfPtes;
01018 <span class="preprocessor">#if DBG</span>
01019 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a65">MM_DBG_SYS_PTES</a>) {
01020                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmTotalFreeSystemPtes[SystemPtePoolType] ==
01021                              MiCountFreeSystemPtes (SystemPtePoolType));
01022                 }
01023 <span class="preprocessor">#endif //DBG</span>
01024 <span class="preprocessor"></span>
01025 <span class="preprocessor">#ifdef _MI_SYSPTE_DEBUG_</span>
01026 <span class="preprocessor"></span>                MiCheckPteAllocation (PointerPte + (SizeInSet - NumberOfPtes),
01027                                       NumberOfPtes,
01028                                       1,
01029                                       0);
01030 <span class="preprocessor">#endif</span>
01031 <span class="preprocessor"></span>
01032                 <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
01033 
01034                 PointerPte =  PointerPte + (SizeInSet - NumberOfPtes);
01035                 <span class="keywordflow">goto</span> Flush;
01036             }
01037 
01038             <span class="keywordflow">if</span> (NumberOfPtes == SizeInSet) {
01039 
01040                 <span class="comment">//</span>
01041                 <span class="comment">// Satisfy the request with this complete set and change</span>
01042                 <span class="comment">// the list to reflect the fact that this set is gone.</span>
01043                 <span class="comment">//</span>
01044 
01045                 Previous-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry = PointerPte-&gt;u.List.NextEntry;
01046 
01047                 <span class="comment">//</span>
01048                 <span class="comment">// Release the system PTE lock.</span>
01049                 <span class="comment">//</span>
01050 
01051 <span class="preprocessor">#if 0</span>
01052 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a65">MM_DBG_SYS_PTES</a>) {
01053                         <a class="code" href="../../d0/d9/sysptes_8c.html#a22">MiDumpSystemPtes</a>(SystemPtePoolType);
01054                         PointerFollowingPte = PointerPte + (SizeInSet - NumberOfPtes);
01055                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"allocated 0x%lx Ptes at %lx\n"</span>,NumberOfPtes,PointerFollowingPte);
01056                 }
01057 <span class="preprocessor">#endif //0</span>
01058 <span class="preprocessor"></span>
01059                 <a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[SystemPtePoolType] -= NumberOfPtes;
01060 <span class="preprocessor">#if DBG</span>
01061 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a65">MM_DBG_SYS_PTES</a>) {
01062                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmTotalFreeSystemPtes[SystemPtePoolType] ==
01063                              MiCountFreeSystemPtes (SystemPtePoolType));
01064                 }
01065 <span class="preprocessor">#endif //DBG</span>
01066 <span class="preprocessor"></span>
01067 <span class="preprocessor">#ifdef _MI_SYSPTE_DEBUG_</span>
01068 <span class="preprocessor"></span>                MiCheckPteAllocation (PointerPte,
01069                                       NumberOfPtes,
01070                                       2,
01071                                       0);
01072 <span class="preprocessor">#endif</span>
01073 <span class="preprocessor"></span>
01074                 <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
01075                 <span class="keywordflow">goto</span> Flush;
01076             }
01077 
01078             <span class="comment">//</span>
01079             <span class="comment">// Point to the next set and try again</span>
01080             <span class="comment">//</span>
01081 
01082             <span class="keywordflow">if</span> (PointerPte-&gt;u.List.NextEntry == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>) {
01083 
01084                 <span class="comment">//</span>
01085                 <span class="comment">// End of list and none found, return NULL or bugcheck.</span>
01086                 <span class="comment">//</span>
01087 
01088                 <span class="keywordflow">if</span> (BugCheckOnFailure) {
01089                     <span class="keywordflow">goto</span> IssueBugcheck;
01090                 }
01091 
01092                 <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
01093                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01094             }
01095             Previous = PointerPte;
01096             PointerPte = <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a> + PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
01097             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte &gt; Previous);
01098         }
01099 
01100     } <span class="keywordflow">else</span> {
01101 
01102         <span class="comment">//</span>
01103         <span class="comment">// Deal with the alignment issues.</span>
01104         <span class="comment">//</span>
01105 
01106         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01107 
01108             <span class="keywordflow">if</span> (PointerPte-&gt;u.List.OneEntry) {
01109                 SizeInSet = 1;
01110 
01111             } <span class="keywordflow">else</span> {
01112 
01113                 PointerFollowingPte = PointerPte + 1;
01114                 SizeInSet = (ULONG_PTR) PointerFollowingPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
01115             }
01116 
01117             PtesToObtainAlignment = (ULONG)
01118                 (((OffsetSum - ((ULONG_PTR)PointerPte &amp; MaskSize)) &amp; MaskSize) &gt;&gt;
01119                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>);
01120 
01121             NumberOfRequiredPtes = NumberOfPtes + PtesToObtainAlignment;
01122 
01123             <span class="keywordflow">if</span> (NumberOfRequiredPtes &lt; SizeInSet) {
01124 
01125                 <span class="comment">//</span>
01126                 <span class="comment">// Get the PTEs from this set and reduce the size of the</span>
01127                 <span class="comment">// set.  Note that the size of the current set cannot be 1.</span>
01128                 <span class="comment">//</span>
01129                 <span class="comment">// This current block will be slit into 2 blocks if</span>
01130                 <span class="comment">// the PointerPte does not match the alignment.</span>
01131                 <span class="comment">//</span>
01132 
01133                 <span class="comment">//</span>
01134                 <span class="comment">// Check to see if the first PTE is on the proper</span>
01135                 <span class="comment">// alignment, if so, eliminate this block.</span>
01136                 <span class="comment">//</span>
01137 
01138                 LeftInSet = SizeInSet - NumberOfRequiredPtes;
01139 
01140                 <span class="comment">//</span>
01141                 <span class="comment">// Set up the new set at the end of this block.</span>
01142                 <span class="comment">//</span>
01143 
01144                 NextSetPointer = PointerPte + NumberOfRequiredPtes;
01145                 NextSetPointer-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry =
01146                                        PointerPte-&gt;u.List.NextEntry;
01147 
01148                 PteOffset = (ULONG_PTR)(NextSetPointer - <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a>);
01149 
01150                 <span class="keywordflow">if</span> (PtesToObtainAlignment == 0) {
01151 
01152                     Previous-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry += NumberOfRequiredPtes;
01153 
01154                 } <span class="keywordflow">else</span> {
01155 
01156                     <span class="comment">//</span>
01157                     <span class="comment">// Point to the new set at the end of the block</span>
01158                     <span class="comment">// we are giving away.</span>
01159                     <span class="comment">//</span>
01160 
01161                     PointerPte-&gt;u.List.NextEntry = PteOffset;
01162 
01163                     <span class="comment">//</span>
01164                     <span class="comment">// Update the size of the current set.</span>
01165                     <span class="comment">//</span>
01166 
01167                     <span class="keywordflow">if</span> (PtesToObtainAlignment == 1) {
01168 
01169                         <span class="comment">//</span>
01170                         <span class="comment">// Collapse to the single PTE format.</span>
01171                         <span class="comment">//</span>
01172 
01173                         PointerPte-&gt;u.List.OneEntry = 1;
01174 
01175                     } <span class="keywordflow">else</span> {
01176 
01177                         <span class="comment">//</span>
01178                         <span class="comment">// Set the set size in the next PTE.</span>
01179                         <span class="comment">//</span>
01180 
01181                         PointerFollowingPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry =
01182                                                         PtesToObtainAlignment;
01183                     }
01184                 }
01185 
01186                 <span class="comment">//</span>
01187                 <span class="comment">// Set up the new set at the end of the block.</span>
01188                 <span class="comment">//</span>
01189 
01190                 <span class="keywordflow">if</span> (LeftInSet == 1) {
01191                     NextSetPointer-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.OneEntry = 1;
01192                 } <span class="keywordflow">else</span> {
01193                     NextSetPointer-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.OneEntry = 0;
01194                     NextSetPointer += 1;
01195                     NextSetPointer-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry = LeftInSet;
01196                 }
01197                 <a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[SystemPtePoolType] -= NumberOfPtes;
01198 <span class="preprocessor">#if DBG</span>
01199 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a65">MM_DBG_SYS_PTES</a>) {
01200                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmTotalFreeSystemPtes[SystemPtePoolType] ==
01201                              MiCountFreeSystemPtes (SystemPtePoolType));
01202                 }
01203 <span class="preprocessor">#endif //DBG</span>
01204 <span class="preprocessor"></span>
01205 <span class="preprocessor">#ifdef _MI_SYSPTE_DEBUG_</span>
01206 <span class="preprocessor"></span>                MiCheckPteAllocation (PointerPte + PtesToObtainAlignment,
01207                                       NumberOfPtes,
01208                                       3,
01209                                       0);
01210 <span class="preprocessor">#endif</span>
01211 <span class="preprocessor"></span>
01212                 <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
01213 
01214                 PointerPte = PointerPte + PtesToObtainAlignment;
01215                 <span class="keywordflow">goto</span> Flush;
01216             }
01217 
01218             <span class="keywordflow">if</span> (NumberOfRequiredPtes == SizeInSet) {
01219 
01220                 <span class="comment">//</span>
01221                 <span class="comment">// Satisfy the request with this complete set and change</span>
01222                 <span class="comment">// the list to reflect the fact that this set is gone.</span>
01223                 <span class="comment">//</span>
01224 
01225                 <span class="keywordflow">if</span> (PtesToObtainAlignment == 0) {
01226 
01227                     <span class="comment">//</span>
01228                     <span class="comment">// This block exactly satisfies the request.</span>
01229                     <span class="comment">//</span>
01230 
01231                     Previous-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry =
01232                                             PointerPte-&gt;u.List.NextEntry;
01233 
01234                 } <span class="keywordflow">else</span> {
01235 
01236                     <span class="comment">//</span>
01237                     <span class="comment">// A portion at the start of this block remains.</span>
01238                     <span class="comment">//</span>
01239 
01240                     <span class="keywordflow">if</span> (PtesToObtainAlignment == 1) {
01241 
01242                         <span class="comment">//</span>
01243                         <span class="comment">// Collapse to the single PTE format.</span>
01244                         <span class="comment">//</span>
01245 
01246                         PointerPte-&gt;u.List.OneEntry = 1;
01247 
01248                     } <span class="keywordflow">else</span> {
01249                       PointerFollowingPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry =
01250                                                         PtesToObtainAlignment;
01251 
01252                     }
01253                 }
01254 
01255                 <a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[SystemPtePoolType] -= NumberOfPtes;
01256 <span class="preprocessor">#if DBG</span>
01257 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a65">MM_DBG_SYS_PTES</a>) {
01258                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmTotalFreeSystemPtes[SystemPtePoolType] ==
01259                              MiCountFreeSystemPtes (SystemPtePoolType));
01260                 }
01261 <span class="preprocessor">#endif //DBG</span>
01262 <span class="preprocessor"></span>
01263 <span class="preprocessor">#ifdef _MI_SYSPTE_DEBUG_</span>
01264 <span class="preprocessor"></span>                MiCheckPteAllocation (PointerPte + PtesToObtainAlignment,
01265                                       NumberOfPtes,
01266                                       4,
01267                                       0);
01268 <span class="preprocessor">#endif</span>
01269 <span class="preprocessor"></span>
01270                 <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
01271 
01272                 PointerPte = PointerPte + PtesToObtainAlignment;
01273                 <span class="keywordflow">goto</span> Flush;
01274             }
01275 
01276             <span class="comment">//</span>
01277             <span class="comment">// Point to the next set and try again</span>
01278             <span class="comment">//</span>
01279 
01280             <span class="keywordflow">if</span> (PointerPte-&gt;u.List.NextEntry == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>) {
01281 
01282                 <span class="comment">//</span>
01283                 <span class="comment">// End of list and none found, return NULL or bugcheck.</span>
01284                 <span class="comment">//</span>
01285 
01286                 <span class="keywordflow">if</span> (BugCheckOnFailure) {
01287                     <span class="keywordflow">goto</span> IssueBugcheck;
01288                 }
01289 
01290                 <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
01291                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01292             }
01293             Previous = PointerPte;
01294             PointerPte = <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a> + PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
01295             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte &gt; Previous);
01296         }
01297     }
01298 Flush:
01299 
01300     <span class="keywordflow">if</span> (SystemPtePoolType == <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>) {
01301         PVOID BaseAddress;
01302         ULONG j;
01303 
01304         PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> = 0;
01305         Previous = PointerPte;
01306         BaseAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (Previous);
01307 
01308         <span class="keywordflow">for</span> (j = 0; j &lt; NumberOfPtes ; j++) {
01309             <span class="keywordflow">if</span> (PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> != <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>) {
01310                 PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o1">FlushPte</a>[PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a>] = Previous;
01311                 PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o2">FlushVa</a>[PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a>] = BaseAddress;
01312                 PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> += 1;
01313             }
01314 
01315             <span class="comment">//</span>
01316             <span class="comment">// PTEs being freed better be invalid.</span>
01317             <span class="comment">//</span>
01318             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Previous-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
01319 
01320             *Previous = <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>;
01321             BaseAddress = (PVOID)((PCHAR)BaseAddress + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01322             Previous++;
01323         }
01324 
01325         <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (DISPATCH_LEVEL, &amp;OldIrql);
01326         <a class="code" href="../../d4/d8/mi_8h.html#a888">MiFlushPteList</a> (&amp;PteFlushList, TRUE, ZeroKernelPte);
01327         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
01328     }
01329     <span class="keywordflow">return</span> PointerPte;
01330 
01331 IssueBugcheck:
01332 
01333     <span class="keywordflow">if</span> (SystemPtePoolType == <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>) {
01334 
01335         HighConsumer = <a class="code" href="../../d0/d9/sysptes_8c.html#a24">MiGetHighestPteConsumer</a> (&amp;HighPteUse);
01336 
01337         <span class="keywordflow">if</span> (HighConsumer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01338             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_USED_EXCESSIVE_PTES,
01339                           (ULONG_PTR)HighConsumer,
01340                           HighPteUse,
01341                           MmTotalFreeSystemPtes[SystemPtePoolType],
01342                           MmNumberOfSystemPtes);
01343         }
01344     }
01345 
01346     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (NO_MORE_SYSTEM_PTES,
01347                   (ULONG_PTR)SystemPtePoolType,
01348                   NumberOfPtes,
01349                   MmTotalFreeSystemPtes[SystemPtePoolType],
01350                   MmNumberOfSystemPtes);
01351 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a12" doxytag="sysptes.c::MmFlushCounter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d0/d9/sysptes_8c.html#a12">MmFlushCounter</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00078">78</a> of file <a class="el" href="../../d1/d8/sysptes_8c-source.html">sysptes.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01160">MiFlushPteList()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01740">MiInitializeSystemPtes()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, and <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00524">MiReserveSystemPtes()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="sysptes.c::MmFlushPte1" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> <a class="el" href="../../d0/d9/sysptes_8c.html#a11">MmFlushPte1</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00076">76</a> of file <a class="el" href="../../d1/d8/sysptes_8c-source.html">sysptes.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01740">MiInitializeSystemPtes()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, and <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00524">MiReserveSystemPtes()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="sysptes.c::MmFreeSysPteListBySize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="el" href="../../d0/d9/sysptes_8c.html#a15">MmFreeSysPteListBySize</a>[MM_SYS_PTE_TABLES_MAX]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00101">101</a> of file <a class="el" href="../../d1/d8/sysptes_8c-source.html">sysptes.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01740">MiInitializeSystemPtes()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, and <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00524">MiReserveSystemPtes()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="sysptes.c::MmLastSysPteListBySize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> <a class="el" href="../../d0/d9/sysptes_8c.html#a16">MmLastSysPteListBySize</a>[MM_SYS_PTE_TABLES_MAX]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00102">102</a> of file <a class="el" href="../../d1/d8/sysptes_8c-source.html">sysptes.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01740">MiInitializeSystemPtes()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, and <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00524">MiReserveSystemPtes()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="sysptes.c::MmSysPteIndex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a>[MM_SYS_PTE_TABLES_MAX] = {1,2,4,8,16}          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00096">96</a> of file <a class="el" href="../../d1/d8/sysptes_8c-source.html">sysptes.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00788">MiFeedSysPtePool()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01740">MiInitializeSystemPtes()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, and <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00524">MiReserveSystemPtes()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="sysptes.c::MmSysPteListBySizeCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d0/d9/sysptes_8c.html#a17">MmSysPteListBySizeCount</a>[MM_SYS_PTE_TABLES_MAX]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00103">103</a> of file <a class="el" href="../../d1/d8/sysptes_8c-source.html">sysptes.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d8/sysptes_8c-source.html#l02030">MiGetSystemPteAvailability()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01987">MiGetSystemPteListCount()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, and <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00524">MiReserveSystemPtes()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="sysptes.c::MmSysPteMinimumFree" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d0/d9/sysptes_8c.html#a18">MmSysPteMinimumFree</a>[MM_SYS_PTE_TABLES_MAX] = {100,50,30,20,20}          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00104">104</a> of file <a class="el" href="../../d1/d8/sysptes_8c-source.html">sysptes.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d8/sysptes_8c-source.html#l02030">MiGetSystemPteAvailability()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, and <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00524">MiReserveSystemPtes()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="sysptes.c::MmSysPteTables" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UCHAR <a class="el" href="../../d0/d9/sysptes_8c.html#a14">MmSysPteTables</a>[17] = {0,0,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4}          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00098">98</a> of file <a class="el" href="../../d1/d8/sysptes_8c-source.html">sysptes.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d8/sysptes_8c-source.html#l02030">MiGetSystemPteAvailability()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01987">MiGetSystemPteListCount()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, and <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00524">MiReserveSystemPtes()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="sysptes.c::MmSystemPtesEnd" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> <a class="el" href="../../d0/d9/sysptes_8c.html#a10">MmSystemPtesEnd</a>[MaximumPtePoolTypes]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00071">71</a> of file <a class="el" href="../../d1/d8/sysptes_8c-source.html">sysptes.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="sysptes.c::MmSystemPtesStart" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> <a class="el" href="../../d0/d9/sysptes_8c.html#a9">MmSystemPtesStart</a>[MaximumPtePoolTypes]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00070">70</a> of file <a class="el" href="../../d1/d8/sysptes_8c-source.html">sysptes.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="sysptes.c::MmTotalFreeSystemPtes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d0/d9/sysptes_8c.html#a8">MmTotalFreeSystemPtes</a>[MaximumPtePoolTypes]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00069">69</a> of file <a class="el" href="../../d1/d8/sysptes_8c-source.html">sysptes.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:44 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
