<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: imectl.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>imectl.c</h1><a href="../../d9/d9/imectl_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************************************************************\</span>
00002 <span class="comment">* Module Name: imectl.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* IME Window Handling Routines</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 20-Dec-1995 wkwok</span>
00010 <span class="comment">\**************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
00015 <span class="preprocessor">#include &lt;intlshar.h&gt;</span>
00016 
<a name="l00017"></a><a class="code" href="../../d9/d9/imectl_8c.html#a0">00017</a> <span class="preprocessor">#define LATE_CREATEUI 1</span>
00018 <span class="preprocessor"></span>
<a name="l00019"></a><a class="code" href="../../d9/d9/imectl_8c.html#a7">00019</a> CONST WCHAR <a class="code" href="../../d9/d9/imectl_8c.html#a7">szIndicDLL</a>[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"indicdll.dll"</span>;
00020 
<a name="l00021"></a><a class="code" href="../../d9/d9/imectl_8c.html#a8">00021</a> FARPROC <a class="code" href="../../d9/d9/imectl_8c.html#a8">gpfnGetIMEMenuItemData</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00022 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/imectl_8c.html#a10">IMEIndicatorGetMenuIDData</a>(PUINT puMenuID, PDWORD pdwData);
00023 
00024 <span class="comment">/*</span>
00025 <span class="comment"> * Local Routines.</span>
00026 <span class="comment"> */</span>
00027 LONG <a class="code" href="../../d9/d9/imectl_8c.html#a11">ImeWndCreateHandler</a>(<a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a>, LPCREATESTRUCT);
00028 <span class="keywordtype">void</span> <a class="code" href="../../d9/d9/imectl_8c.html#a12">ImeWndDestroyHandler</a>(<a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a>);
00029 LRESULT <a class="code" href="../../d9/d9/imectl_8c.html#a13">ImeSystemHandler</a>(<a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a>, UINT, WPARAM, LPARAM);
00030 LONG <a class="code" href="../../d9/d9/imectl_8c.html#a14">ImeSelectHandler</a>(<a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a>, UINT, WPARAM, LPARAM);
00031 LRESULT <a class="code" href="../../d9/d9/imectl_8c.html#a15">ImeControlHandler</a>(<a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a>, UINT, WPARAM, LPARAM, BOOL);
00032 LRESULT <a class="code" href="../../d9/d9/imectl_8c.html#a16">ImeSetContextHandler</a>(<a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a>, UINT, WPARAM, LPARAM);
00033 LRESULT <a class="code" href="../../d9/d9/imectl_8c.html#a17">ImeNotifyHandler</a>(<a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a>, UINT, WPARAM, LPARAM);
00034 HWND <a class="code" href="../../d9/d9/imectl_8c.html#a18">CreateIMEUI</a>(<a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a>, HKL);
00035 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d9/imectl_8c.html#a19">DestroyIMEUI</a>(<a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a>);
00036 LRESULT <a class="code" href="../../d9/d9/imectl_8c.html#a20">SendMessageToUI</a>(<a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a>, UINT, WPARAM, LPARAM, BOOL);
00037 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d9/imectl_8c.html#a21">SendOpenStatusNotify</a>(<a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a>, HWND, BOOL);
00038 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d9/imectl_8c.html#a22">ImeSetImc</a>(<a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a>, HIMC);
00039 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d9/imectl_8c.html#a23">FocusSetIMCContext</a>(HWND, BOOL);
00040 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/imectl_8c.html#a24">ImeBroadCastMsg</a>(<a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a>, UINT, WPARAM, LPARAM);
00041 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d9/imectl_8c.html#a25">ImeMarkUsedContext</a>(HWND, HIMC);
00042 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/imectl_8c.html#a26">ImeIsUsableContext</a>(HWND, HIMC);
00043 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/imectl_8c.html#a27">GetIMEShowStatus</a>(<span class="keywordtype">void</span>);
00044 LRESULT <a class="code" href="../../d9/d9/imectl_8c.html#a28">ImeCopyDataHandler</a>(WPARAM, LPARAM);
00045 
00046 <span class="comment">/*</span>
00047 <span class="comment"> * Common macros for IME UI, HKL and IMC handlings</span>
00048 <span class="comment"> */</span>
<a name="l00049"></a><a class="code" href="../../d9/d9/imectl_8c.html#a1">00049</a> <span class="preprocessor">#define GETHKL(pimeui)        (pimeui-&gt;hKL)</span>
<a name="l00050"></a><a class="code" href="../../d9/d9/imectl_8c.html#a2">00050</a> <span class="preprocessor"></span><span class="preprocessor">#define SETHKL(pimeui, hkl)   (pimeui-&gt;hKL=(hkl))</span>
<a name="l00051"></a><a class="code" href="../../d9/d9/imectl_8c.html#a3">00051</a> <span class="preprocessor"></span><span class="preprocessor">#define GETIMC(pimeui)        (pimeui-&gt;hIMC)</span>
<a name="l00052"></a><a class="code" href="../../d9/d9/imectl_8c.html#a4">00052</a> <span class="preprocessor"></span><span class="preprocessor">#define SETIMC(pimeui, himc)  (ImeSetImc(pimeui, himc))</span>
<a name="l00053"></a><a class="code" href="../../d9/d9/imectl_8c.html#a5">00053</a> <span class="preprocessor"></span><span class="preprocessor">#define GETUI(pimeui)         (pimeui-&gt;hwndUI)</span>
<a name="l00054"></a><a class="code" href="../../d9/d9/imectl_8c.html#a6">00054</a> <span class="preprocessor"></span><span class="preprocessor">#define SETUI(pimeui, hwndui) (pimeui-&gt;hwndUI=(hwndui))</span>
00055 <span class="preprocessor"></span>
<a name="l00056"></a><a class="code" href="../../d9/d9/imectl_8c.html#a9">00056</a> <a class="code" href="../../d2/d4/struct__LOOKASIDE.html">LOOKASIDE</a> <a class="code" href="../../d9/d9/imectl_8c.html#a9">ImeUILookaside</a>;
00057 
00058 <span class="comment">/***************************************************************************\</span>
00059 <span class="comment">* NtUserBroadcastImeShowStatusChange(), NtUserCheckImeShowStatusInThread()</span>
00060 <span class="comment">*</span>
00061 <span class="comment">* Stub for kernel mode routines</span>
00062 <span class="comment">*</span>
00063 <span class="comment">\***************************************************************************/</span>
00064 
<a name="l00065"></a><a class="code" href="../../d9/d9/imectl_8c.html#a29">00065</a> _inline <span class="keywordtype">void</span> <a class="code" href="../../d9/d9/imectl_8c.html#a29">NtUserBroadcastImeShowStatusChange</a>(HWND hwndDefIme, BOOL fShow)
00066 {
00067     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a179">NtUserCallHwndParamLock</a>(hwndDefIme, fShow, SFI_XXXBROADCASTIMESHOWSTATUSCHANGE);
00068 }
00069 
<a name="l00070"></a><a class="code" href="../../d9/d9/imectl_8c.html#a30">00070</a> _inline <span class="keywordtype">void</span> <a class="code" href="../../d9/d9/imectl_8c.html#a30">NtUserCheckImeShowStatusInThread</a>(HWND hwndDefIme)
00071 {
00072     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a176">NtUserCallHwndLock</a>(hwndDefIme, SFI_XXXCHECKIMESHOWSTATUSINTHREAD);
00073 }
00074 
00075 <span class="comment">/***************************************************************************\</span>
00076 <span class="comment">* ImeWndProc</span>
00077 <span class="comment">*</span>
00078 <span class="comment">* WndProc for IME class</span>
00079 <span class="comment">*</span>
00080 <span class="comment">* History:</span>
00081 <span class="comment">\***************************************************************************/</span>
00082 
<a name="l00083"></a><a class="code" href="../../d6/d0/usercli_8h.html#a619">00083</a> LRESULT <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> <a class="code" href="../../d6/d0/usercli_8h.html#a619">ImeWndProcWorker</a>(
00084     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00085     UINT message,
00086     WPARAM wParam,
00087     LPARAM lParam,
00088     DWORD fAnsi)
00089 {
00090     HWND        hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd);
00091     <a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a>      pimeui;
00092     <span class="keyword">static</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fInit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00093 
00094     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00095 
00096     <a class="code" href="../../d6/d0/usercli_8h.html#a28">VALIDATECLASSANDSIZE</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a208">FNID_IME</a>);
00097     <a class="code" href="../../d6/d0/usercli_8h.html#a29">INITCONTROLLOOKASIDE</a>(&amp;<a class="code" href="../../d9/d9/imectl_8c.html#a9">ImeUILookaside</a>, <a class="code" href="../../d4/d8/structtagIMEUI.html">IMEUI</a>, spwnd, 8);
00098 
00099     <span class="comment">/*</span>
00100 <span class="comment">     * If the control is not interested in this message,</span>
00101 <span class="comment">     * pass it to DefWindowProc.</span>
00102 <span class="comment">     */</span>
00103     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a10">FWINDOWMSG</a>(message, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a208">FNID_IME</a>))
00104         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(pwnd, message, wParam, lParam, fAnsi);
00105 
00106     <span class="comment">/*</span>
00107 <span class="comment">     * Get the pimeui for the given window now since we will use it a lot in</span>
00108 <span class="comment">     * various handlers. This was stored using SetWindowLong(hwnd,0,pimeui) when</span>
00109 <span class="comment">     * we initially created the IME control.</span>
00110 <span class="comment">     */</span>
00111     pimeui = ((<a class="code" href="../../d5/d8/structtagIMEWND.html">PIMEWND</a>)pwnd)-&gt;pimeui;
00112 
00113     <span class="keywordflow">if</span> (pimeui == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00114         <span class="comment">/*</span>
00115 <span class="comment">         * Further processing not needed</span>
00116 <span class="comment">         */</span>
00117         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImeWndProcWorker: pimeui == NULL\n"</span>);
00118         <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00119     }
00120 
00121     <span class="comment">/*</span>
00122 <span class="comment">     * This is necessary to avoid recursion call from IME UI.</span>
00123 <span class="comment">     */</span>
00124     UserAssert(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o5">nCntInIMEProc</a> &gt;= 0);
00125 
00126     <span class="keywordflow">if</span> (pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o5">nCntInIMEProc</a> &gt; 0) {
00127         TAGMSG5(DBGTAG_IMM, <span class="stringliteral">"ImeWndProcWorker: Recursive for pwnd=%08p, msg=%08x, wp=%08x, lp=%08x, fAnsi=%d\n"</span>,
00128                 pwnd, message, wParam, lParam, fAnsi);
00129         <span class="keywordflow">switch</span> (message) {
00130         <span class="keywordflow">case</span> WM_IME_SYSTEM:
00131             <span class="keywordflow">switch</span> (wParam) {
00132             <span class="keywordflow">case</span> IMS_ISACTIVATED:
00133             <span class="keywordflow">case</span> IMS_SETOPENSTATUS:
00134 <span class="comment">//          case IMS_SETCONVERSIONSTATUS:</span>
00135             <span class="keywordflow">case</span> IMS_SETSOFTKBDONOFF:
00136                 <span class="comment">/*</span>
00137 <span class="comment">                 * Because these will not be pass to UI.</span>
00138 <span class="comment">                 * We can do it.</span>
00139 <span class="comment">                 */</span>
00140                 <span class="keywordflow">break</span>;
00141 
00142             <span class="keywordflow">default</span>:
00143                 <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00144             }
00145             <span class="keywordflow">break</span>;
00146 
00147         <span class="keywordflow">case</span> WM_IME_STARTCOMPOSITION:
00148         <span class="keywordflow">case</span> WM_IME_ENDCOMPOSITION:
00149         <span class="keywordflow">case</span> WM_IME_COMPOSITION:
00150         <span class="keywordflow">case</span> WM_IME_SETCONTEXT:
00151         <span class="keywordflow">case</span> WM_IME_NOTIFY:
00152         <span class="keywordflow">case</span> WM_IME_CONTROL:
00153         <span class="keywordflow">case</span> WM_IME_COMPOSITIONFULL:
00154         <span class="keywordflow">case</span> WM_IME_SELECT:
00155         <span class="keywordflow">case</span> WM_IME_CHAR:
00156         <span class="keywordflow">case</span> WM_IME_REQUEST:
00157             <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00158 
00159         <span class="keywordflow">default</span>:
00160             <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(pwnd, message, wParam, lParam, fAnsi);
00161         }
00162     }
00163 
00164     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a591">WFINDESTROY</a>) || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a583">WFDESTROYED</a>)) {
00165         <span class="keywordflow">switch</span> (message) {
00166         <span class="keywordflow">case</span> WM_DESTROY:
00167         <span class="keywordflow">case</span> WM_NCDESTROY:
00168         <span class="keywordflow">case</span> WM_FINALDESTROY:
00169             <span class="keywordflow">break</span>;
00170         <span class="keywordflow">default</span>:
00171             RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImeWndProcWorker: message %x is sent to destroyed window."</span>, message);
00172             <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00173         }
00174     }
00175 
00176     <span class="keywordflow">switch</span> (message) {
00177     <span class="keywordflow">case</span> WM_ERASEBKGND:
00178         <span class="keywordflow">return</span> (LONG)<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00179 
00180     <span class="keywordflow">case</span> WM_PAINT:
00181         <span class="keywordflow">break</span>;
00182 
00183     <span class="keywordflow">case</span> WM_CREATE:
00184 
00185         <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/imectl_8c.html#a11">ImeWndCreateHandler</a>(pimeui, (LPCREATESTRUCT)lParam);
00186 
00187     <span class="keywordflow">case</span> WM_DESTROY:
00188         <span class="comment">/*</span>
00189 <span class="comment">         * We are destroying the IME window, destroy</span>
00190 <span class="comment">         * any UI window that it owns.</span>
00191 <span class="comment">         */</span>
00192         <a class="code" href="../../d9/d9/imectl_8c.html#a12">ImeWndDestroyHandler</a>(pimeui);
00193         <span class="keywordflow">break</span>;
00194 
00195     <span class="keywordflow">case</span> WM_NCDESTROY:
00196     <span class="keywordflow">case</span> WM_FINALDESTROY:
00197         <span class="keywordflow">if</span> (pimeui) {
00198             <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o0">spwnd</a>);
00199             <a class="code" href="../../d6/d0/usercli_8h.html#a408">FreeLookasideEntry</a>(&amp;<a class="code" href="../../d9/d9/imectl_8c.html#a9">ImeUILookaside</a>, pimeui);
00200         }
00201         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a284">NtUserSetWindowFNID</a>(hwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a226">FNID_CLEANEDUP_BIT</a>);
00202         <span class="keywordflow">goto</span> CallDWP;
00203 
00204     <span class="keywordflow">case</span> WM_IME_SYSTEM:
00205         UserAssert(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o0">spwnd</a> == pwnd);
00206         <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/imectl_8c.html#a13">ImeSystemHandler</a>(pimeui, message, wParam, lParam);
00207 
00208     <span class="keywordflow">case</span> WM_IME_SELECT:
00209         <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/imectl_8c.html#a14">ImeSelectHandler</a>(pimeui, message, wParam, lParam);
00210 
00211     <span class="keywordflow">case</span> WM_IME_CONTROL:
00212         <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/imectl_8c.html#a15">ImeControlHandler</a>(pimeui, message, wParam, lParam, fAnsi);
00213 
00214     <span class="keywordflow">case</span> WM_IME_SETCONTEXT:
00215         <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/imectl_8c.html#a16">ImeSetContextHandler</a>(pimeui, message, wParam, lParam);
00216 
00217     <span class="keywordflow">case</span> WM_IME_NOTIFY:
00218         <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/imectl_8c.html#a17">ImeNotifyHandler</a>(pimeui, message, wParam, lParam);
00219 
00220     <span class="keywordflow">case</span> WM_IME_REQUEST:
00221         <span class="keywordflow">return</span> 0;
00222 
00223     <span class="keywordflow">case</span> WM_IME_COMPOSITION:
00224     <span class="keywordflow">case</span> WM_IME_ENDCOMPOSITION:
00225     <span class="keywordflow">case</span> WM_IME_STARTCOMPOSITION:
00226         <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/imectl_8c.html#a20">SendMessageToUI</a>(pimeui, message, wParam, lParam, fAnsi);
00227 
00228     <span class="keywordflow">case</span> WM_COPYDATA:
00229         <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/imectl_8c.html#a28">ImeCopyDataHandler</a>(wParam, lParam);
00230 
00231     <span class="keywordflow">default</span>:
00232 CallDWP:
00233         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(pwnd, message, wParam, lParam, fAnsi);
00234     }
00235 
00236     <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00237 }
00238 
00239 
<a name="l00240"></a><a class="code" href="../../d6/d0/usercli_8h.html#a598">00240</a> LRESULT WINAPI <a class="code" href="../../d6/d0/usercli_8h.html#a598">ImeWndProcA</a>(
00241     HWND hwnd,
00242     UINT message,
00243     WPARAM wParam,
00244     LPARAM lParam)
00245 {
00246     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00247 
00248     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00249         <span class="keywordflow">return</span> (0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00250     }
00251 
00252     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a619">ImeWndProcWorker</a>(pwnd, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00253 }
00254 
00255 
<a name="l00256"></a><a class="code" href="../../d6/d0/usercli_8h.html#a599">00256</a> LRESULT WINAPI <a class="code" href="../../d6/d0/usercli_8h.html#a599">ImeWndProcW</a>(
00257     HWND hwnd,
00258     UINT message,
00259     WPARAM wParam,
00260     LPARAM lParam)
00261 {
00262     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00263 
00264     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00265         <span class="keywordflow">return</span> (0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00266     }
00267 
00268     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a619">ImeWndProcWorker</a>(pwnd, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00269 }
00270 
00271 
<a name="l00272"></a><a class="code" href="../../d9/d9/imectl_8c.html#a11">00272</a> LONG <a class="code" href="../../d9/d9/imectl_8c.html#a11">ImeWndCreateHandler</a>(
00273     <a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a> pimeui,
00274     LPCREATESTRUCT lpcs)
00275 {
00276     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndParent;
00277     HIMC hImc;
00278     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndIme = pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o0">spwnd</a>;
00279 <span class="preprocessor">#if _DBG</span>
00280 <span class="preprocessor"></span>    <span class="keyword">static</span> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwFirstWinlogonThreadId;
00281 <span class="preprocessor">#endif</span>
00282 <span class="preprocessor"></span>    <span class="keyword">extern</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a18">gfLogonProcess</a>;
00283 
00284 <span class="preprocessor">#if _DBG</span>
00285 <span class="preprocessor"></span>    <span class="comment">/*</span>
00286 <span class="comment">     * For Winlogon, only the first thread can have IME processing.</span>
00287 <span class="comment">     */</span>
00288     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/client_8c.html#a18">gfLogonProcess</a>) {
00289         UserAssert(dwFirstWinLogonThreadId == 0);
00290         dwFirstWinlogonThreadId = GetCurrentThreadId();
00291     }
00292 <span class="preprocessor">#endif</span>
00293 <span class="preprocessor"></span>
00294     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndIme, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a655">WFPOPUP</a>) || !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndIme, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a651">WFDISABLED</a>)) {
00295         RIPMSG0(RIP_WARNING, <span class="stringliteral">"IME window should have WS_POPUP and WS_DISABLE!!"</span>);
00296         <span class="keywordflow">return</span> -1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00297     }
00298 
00299     <span class="comment">/*</span>
00300 <span class="comment">     * Check with parent window, if exists, try to get IMC.</span>
00301 <span class="comment">     * If this is top level window, wait for first WM_IME_SETCONTEXT.</span>
00302 <span class="comment">     */</span>
00303     <span class="keywordflow">if</span> ((pwndParent = <a class="code" href="../../d3/d9/client_2wow_8c.html#a1">ValidateHwndNoRip</a>(lpcs-&gt;hwndParent)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00304         hImc = pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o20">hImc</a>;
00305         <span class="keywordflow">if</span> (hImc != <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a> &amp;&amp; <a class="code" href="../../d9/d9/imectl_8c.html#a26">ImeIsUsableContext</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwndIme), hImc)) {
00306             <span class="comment">/*</span>
00307 <span class="comment">             * Store it for later use.</span>
00308 <span class="comment">             */</span>
00309             <a class="code" href="../../d9/d9/imectl_8c.html#a4">SETIMC</a>(pimeui, hImc);
00310         }
00311         <span class="keywordflow">else</span> {
00312             <a class="code" href="../../d9/d9/imectl_8c.html#a4">SETIMC</a>(pimeui, <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>);
00313         }
00314     }
00315     <span class="keywordflow">else</span> {
00316         <a class="code" href="../../d9/d9/imectl_8c.html#a4">SETIMC</a>(pimeui, <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>);
00317     }
00318 
00319     <span class="comment">/*</span>
00320 <span class="comment">     * Initialize status window show state</span>
00321 <span class="comment">     * The status window is not open yet.</span>
00322 <span class="comment">     */</span>
00323     pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o6">fShowStatus</a> = 0;
00324     pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o5">nCntInIMEProc</a> = 0;
00325     pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o7">fActivate</a> = 0;
00326     pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o8">fDestroy</a> = 0;
00327     pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o2">hwndIMC</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00328     pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o3">hKL</a> = <a class="code" href="../../d6/d0/usercli_8h.html#a151">THREAD_HKL</a>();
00329     pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o15">fCtrlShowStatus</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00330 
00331     <span class="comment">/*</span>
00332 <span class="comment">     * Load up the IME DLL of current keyboard layout.</span>
00333 <span class="comment">     */</span>
00334     <a class="code" href="../../d6/d0/usercli_8h.html#a324">fpImmLoadIME</a>(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o3">hKL</a>);
00335 
00336 <span class="preprocessor">#ifdef LATE_CREATEUI</span>
00337 <span class="preprocessor"></span>    <a class="code" href="../../d9/d9/imectl_8c.html#a6">SETUI</a>(pimeui, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00338 <span class="preprocessor">#else</span>
00339 <span class="preprocessor"></span>    <a class="code" href="../../d9/d9/imectl_8c.html#a6">SETUI</a>(pimeui, <a class="code" href="../../d9/d9/imectl_8c.html#a18">CreateIMEUI</a>(pimeui, pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o3">hKL</a>));
00340 <span class="preprocessor">#endif</span>
00341 <span class="preprocessor"></span>
00342     <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00343 }
00344 
<a name="l00345"></a><a class="code" href="../../d9/d9/imectl_8c.html#a12">00345</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/d9/imectl_8c.html#a12">ImeWndDestroyHandler</a>(
00346     <a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a> pimeui)
00347 {
00348     <a class="code" href="../../d9/d9/imectl_8c.html#a19">DestroyIMEUI</a>(pimeui);
00349 }
00350 
00351 
00352 <span class="comment">/***************************************************************************\</span>
00353 <span class="comment">* ImeRunHelp</span>
00354 <span class="comment">*</span>
00355 <span class="comment">* Display Help file (HLP and CHM).</span>
00356 <span class="comment">*</span>
00357 <span class="comment">* History:</span>
00358 <span class="comment">* 27-Oct-98 Hiroyama</span>
00359 <span class="comment">\***************************************************************************/</span>
00360 
<a name="l00361"></a><a class="code" href="../../d9/d9/imectl_8c.html#a34">00361</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/d9/imectl_8c.html#a34">ImeRunHelp</a>(LPWSTR wszHelpFile)
00362 {
00363     <span class="keyword">static</span> <span class="keyword">const</span> WCHAR wszHelpFileExt[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">".HLP"</span>;
00364     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cchLen = wcslen(wszHelpFile);
00365 
00366     <span class="keywordflow">if</span> (cchLen &gt; 4 &amp;&amp; _wcsicmp(wszHelpFile + cchLen - 4, wszHelpFileExt) == 0) {
00367 <span class="preprocessor">#ifdef FYI</span>
00368 <span class="preprocessor"></span>        <a class="code" href="../../d1/d0/client_2help_8c.html#a18">WinHelpW</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, wszHelpFile, HELP_CONTENTS, 0);
00369 <span class="preprocessor">#else</span>
00370 <span class="preprocessor"></span>        <a class="code" href="../../d1/d0/client_2help_8c.html#a18">WinHelpW</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, wszHelpFile, HELP_FINDER, 0);
00371 <span class="preprocessor">#endif</span>
00372 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
00373         <span class="comment">//</span>
00374         <span class="comment">// If it's not HLP file, try to run hh.exe, HTML based</span>
00375         <span class="comment">// help tool. It should be in %windir%\hh.exe.</span>
00376         <span class="comment">//</span>
00377         <span class="keyword">static</span> <span class="keyword">const</span> WCHAR wszHH[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"hh.exe "</span>;
00378         WCHAR wszCmdLine[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a> * 2];
00379         LPWSTR lpwszCmdLine = wszCmdLine;
00380         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>               idProcess;
00381         STARTUPINFO         StartupInfo;
00382         PROCESS_INFORMATION ProcessInformation;
00383         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> i;
00384 
00385         i = GetSystemWindowsDirectoryW(wszCmdLine, <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>);
00386         <span class="keywordflow">if</span> (i &gt; 0 &amp;&amp; i &lt; <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a> - cchLen - (<span class="keyword">sizeof</span> <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span> + <span class="keyword">sizeof</span> wszHH) / <span class="keyword">sizeof</span>(WCHAR)) {
00387             lpwszCmdLine += i;
00388             <span class="keywordflow">if</span> (lpwszCmdLine[-1] != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>) {
00389                 *lpwszCmdLine++ = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>;
00390             }
00391         }
00392         wcscpy(lpwszCmdLine, wszHH);
00393         wcscat(lpwszCmdLine, wszHelpFile);
00394 
00395         <span class="comment">/*</span>
00396 <span class="comment">         *  Launch HTML Help.</span>
00397 <span class="comment">         */</span>
00398         RtlZeroMemory(&amp;StartupInfo, <span class="keyword">sizeof</span>(StartupInfo));
00399         StartupInfo.cb = <span class="keyword">sizeof</span>(StartupInfo);
00400         StartupInfo.wShowWindow = SW_SHOW;
00401         StartupInfo.dwFlags = STARTF_USESHOWWINDOW | STARTF_FORCEONFEEDBACK;
00402 
00403         TAGMSG1(DBGTAG_IMM, <span class="stringliteral">"Invoking help with '%S'"</span>, wszCmdLine);
00404 
00405         idProcess = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)CreateProcessW(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, wszCmdLine,
00406                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, NORMAL_PRIORITY_CLASS, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;StartupInfo,
00407                 &amp;ProcessInformation);
00408 
00409         <span class="keywordflow">if</span> (idProcess) {
00410             <a class="code" href="../../d3/d8/client_8c.html#a56">WaitForInputIdle</a>(ProcessInformation.hProcess, 10000);
00411             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(ProcessInformation.hProcess);
00412             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(ProcessInformation.hThread);
00413         }
00414     }
00415 }
00416 
<a name="l00417"></a><a class="code" href="../../d9/d9/imectl_8c.html#a13">00417</a> LRESULT <a class="code" href="../../d9/d9/imectl_8c.html#a13">ImeSystemHandler</a>(
00418     <a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a> pimeui,
00419     UINT   message,
00420     WPARAM wParam,
00421     LPARAM lParam)
00422 {
00423     PINPUTCONTEXT pInputContext;
00424     HIMC          hImc = <a class="code" href="../../d9/d9/imectl_8c.html#a3">GETIMC</a>(pimeui);
00425     LRESULT       dwRet = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00426 
00427     UNREFERENCED_PARAMETER(message);
00428 
00429     <span class="keywordflow">switch</span> (wParam) {
00430 
00431     <span class="keywordflow">case</span> IMS_SETOPENCLOSE:
00432         <span class="keywordflow">if</span> (hImc != <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>)
00433             <a class="code" href="../../d6/d0/usercli_8h.html#a325">fpImmSetOpenStatus</a>(hImc, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)lParam);
00434         <span class="keywordflow">break</span>;
00435 
00436 <span class="preprocessor">#ifdef LATER</span>
00437 <span class="preprocessor"></span>    <span class="keywordflow">case</span> IMS_WINDOWPOS:
00438         <span class="keywordflow">if</span> (hImc != <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>) {
00439             <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>  i;
00440             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> f31Hidden = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>:
00441 
00442             <span class="keywordflow">if</span> ((pInputContext = <a class="code" href="../../d6/d0/usercli_8h.html#a313">fpImmLockIMC</a>(hImc)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00443                 f31Hidden = (pInputContext &amp; F31COMPAT_MCWHIDDEN) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00444                 <a class="code" href="../../d6/d0/usercli_8h.html#a323">fpImmUnlockIMC</a>(hImc);
00445             }
00446 
00447             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o2">hwndIMC</a>)) {
00448                 <span class="keywordflow">if</span> (!f31Hidden) {
00449                 }
00450             }
00451         }
00452 <span class="preprocessor">#endif</span>
00453 <span class="preprocessor"></span>
00454     <span class="keywordflow">case</span> IMS_ACTIVATECONTEXT:
00455         <a class="code" href="../../d9/d9/imectl_8c.html#a23">FocusSetIMCContext</a>((HWND)(lParam), <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00456         <span class="keywordflow">break</span>;
00457 
00458     <span class="keywordflow">case</span> IMS_DEACTIVATECONTEXT:
00459         <a class="code" href="../../d9/d9/imectl_8c.html#a23">FocusSetIMCContext</a>((HWND)(lParam), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00460         <span class="keywordflow">break</span>;
00461 
00462     <span class="keywordflow">case</span> IMS_UNLOADTHREADLAYOUT:
00463         <span class="keywordflow">return</span> (LONG)(<a class="code" href="../../d6/d0/usercli_8h.html#a326">fpImmFreeLayout</a>((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)lParam));
00464 
00465     <span class="keywordflow">case</span> IMS_ACTIVATETHREADLAYOUT:
00466         <span class="keywordflow">return</span> (LONG)(<a class="code" href="../../d6/d0/usercli_8h.html#a327">fpImmActivateLayout</a>((HKL)lParam));
00467 
00468     <span class="keywordflow">case</span> IMS_SETCANDIDATEPOS:
00469         <span class="keywordflow">if</span> ( (pInputContext = <a class="code" href="../../d6/d0/usercli_8h.html#a313">fpImmLockIMC</a>( hImc )) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00470             LPCANDIDATEFORM lpcaf;
00471             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwIndex = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)lParam;
00472 
00473             lpcaf = &amp;(pInputContext-&gt;cfCandForm[dwIndex]);
00474             <a class="code" href="../../d6/d0/usercli_8h.html#a328">fpImmSetCandidateWindow</a>( hImc, lpcaf );
00475             <a class="code" href="../../d6/d0/usercli_8h.html#a323">fpImmUnlockIMC</a>( hImc );
00476         }
00477         <span class="keywordflow">break</span>;
00478 
00479     <span class="keywordflow">case</span> IMS_SETCOMPOSITIONWINDOW:
00480         <span class="keywordflow">if</span> ( (pInputContext = <a class="code" href="../../d6/d0/usercli_8h.html#a313">fpImmLockIMC</a>( hImc )) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00481             LPCOMPOSITIONFORM lpcof;
00482 
00483             lpcof = &amp;(pInputContext-&gt;cfCompForm);
00484             pInputContext-&gt;fdw31Compat |= F31COMPAT_CALLFROMWINNLS;
00485             <a class="code" href="../../d6/d0/usercli_8h.html#a321">fpImmSetCompositionWindow</a>( hImc, lpcof);
00486         }
00487         <span class="keywordflow">break</span>;
00488 
00489     <span class="keywordflow">case</span> IMS_SETCOMPOSITIONFONT:
00490         <span class="keywordflow">if</span> ( (pInputContext = <a class="code" href="../../d6/d0/usercli_8h.html#a313">fpImmLockIMC</a>( hImc )) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00491             LPLOGFONT lplf;
00492 
00493             lplf = &amp;(pInputContext-&gt;lfFont.W);
00494             <a class="code" href="../../d6/d0/usercli_8h.html#a320">fpImmSetCompositionFont</a>( hImc, lplf );
00495         }
00496         <span class="keywordflow">break</span>;
00497 
00498     <span class="keywordflow">case</span> IMS_CONFIGUREIME:
00499         <a class="code" href="../../d6/d0/usercli_8h.html#a329">fpImmConfigureIMEW</a>( (HKL)lParam, pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o2">hwndIMC</a>, IME_CONFIG_GENERAL, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00500         <span class="keywordflow">break</span>;
00501 
00502     <span class="keywordflow">case</span> IMS_CHANGE_SHOWSTAT:
00503         <span class="comment">// Private message from internat.exe</span>
00504         <span class="comment">// Before it reaches here, the registry is already updated.</span>
00505         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/imectl_8c.html#a27">GetIMEShowStatus</a>() == !lParam) {
00506 <span class="preprocessor">#if 1</span>
00507 <span class="preprocessor"></span>            <a class="code" href="../../d9/d9/imectl_8c.html#a29">NtUserBroadcastImeShowStatusChange</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o0">spwnd</a>), !!lParam);
00508 <span class="preprocessor">#else</span>
00509 <span class="preprocessor"></span>            <a class="code" href="../../d5/d9/cltxt_8h.html#a26">SystemParametersInfo</a>(SPI_SETSHOWIMEUI, lParam, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00510 <span class="preprocessor">#endif</span>
00511 <span class="preprocessor"></span>        }
00512         <span class="keywordflow">break</span>;
00513 
00514     <span class="keywordflow">case</span> IMS_GETCONVERSIONMODE:
00515     {
00516         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwConv = 0;
00517         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwTemp;
00518 
00519         <a class="code" href="../../d6/d0/usercli_8h.html#a330">fpImmGetConversionStatus</a>(hImc, &amp;dwConv, &amp;dwTemp);
00520         <span class="keywordflow">return</span> (dwConv);
00521         <span class="keywordflow">break</span>;
00522     }
00523 
00524     <span class="keywordflow">case</span> IMS_SETSOFTKBDONOFF:
00525         <a class="code" href="../../d6/d0/usercli_8h.html#a345">fpImmEnumInputContext</a>(0, <a class="code" href="../../d9/d9/imectl_8c.html#a35">SyncSoftKbdState</a>, lParam);
00526         <span class="keywordflow">break</span>;
00527 
00528     <span class="keywordflow">case</span> IMS_GETIMEMENU:
00529         <span class="comment">// new in NT50</span>
00530         <span class="comment">// IMS_GETIEMMENU is used to handle Inter Process GetMenu.</span>
00531         <span class="comment">// NOTE: This operation is only intended to internat.exe</span>
00532         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a341">fpImmPutImeMenuItemsIntoMappedFile</a>((HIMC)lParam);
00533 
00534     <span class="keywordflow">case</span> IMS_IMEHELP:
00535         dwRet = IME_ESC_GETHELPFILENAME;
00536         dwRet = <a class="code" href="../../d6/d0/usercli_8h.html#a306">fpImmEscapeW</a>(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o3">hKL</a>, pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o1">hIMC</a>, IME_ESC_QUERY_SUPPORT, (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)&amp;dwRet);
00537         <span class="keywordflow">if</span> (lParam) {
00538             <span class="comment">// try to run WinHelp</span>
00539             WCHAR wszHelpFile[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00540 
00541             <span class="keywordflow">if</span> (dwRet) {
00542                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a306">fpImmEscapeW</a>(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o3">hKL</a>, pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o1">hIMC</a>, IME_ESC_GETHELPFILENAME,
00543                         (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)wszHelpFile)) {
00544                     <a class="code" href="../../d9/d9/imectl_8c.html#a34">ImeRunHelp</a>(wszHelpFile);
00545                 }
00546             }
00547         }
00548         <span class="keywordflow">return</span> dwRet;
00549 
00550     <span class="keywordflow">case</span> IMS_GETCONTEXT:
00551         dwRet = (ULONG_PTR)<a class="code" href="../../d6/d0/usercli_8h.html#a307">fpImmGetContext</a>((HWND)lParam);
00552         <span class="keywordflow">return</span> dwRet;
00553 
00554     <span class="keywordflow">case</span> IMS_ENDIMEMENU:
00555         <span class="comment">// New in NT5.0: Special support for Internat.exe</span>
00556         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>((HWND)lParam)) {
00557             HIMC hImc;
00558             <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uID;
00559             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwData;
00560 
00561             hImc = <a class="code" href="../../d6/d0/usercli_8h.html#a307">fpImmGetContext</a>((HWND)lParam);
00562 
00563             <span class="keywordflow">if</span> (hImc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00564                 <span class="comment">//</span>
00565                 <span class="comment">// Call Indicator to get IME menu data.</span>
00566                 <span class="comment">//</span>
00567                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/imectl_8c.html#a10">IMEIndicatorGetMenuIDData</a>(&amp;uID, &amp;dwData)) {
00568                     <a class="code" href="../../d6/d0/usercli_8h.html#a322">fpImmNotifyIME</a>(hImc, NI_IMEMENUSELECTED, uID, dwData);
00569                 }
00570                 <a class="code" href="../../d6/d0/usercli_8h.html#a314">fpImmReleaseContext</a>((HWND)lParam, hImc);
00571             }
00572         }
00573         <span class="keywordflow">break</span>;
00574 
00575     <span class="keywordflow">case</span> IMS_SENDNOTIFICATION:
00576     <span class="keywordflow">case</span> IMS_FINALIZE_COMPSTR:
00577         dwRet = <a class="code" href="../../d6/d0/usercli_8h.html#a346">fpImmSystemHandler</a>(hImc, wParam, lParam);
00578         <span class="keywordflow">break</span>;
00579 
00580     <span class="keywordflow">default</span>:
00581         <span class="keywordflow">break</span>;
00582     }
00583 
00584     <span class="keywordflow">return</span> dwRet;
00585 }
00586 
00587 
<a name="l00588"></a><a class="code" href="../../d9/d9/imectl_8c.html#a14">00588</a> LONG <a class="code" href="../../d9/d9/imectl_8c.html#a14">ImeSelectHandler</a>(
00589     <a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a> pimeui,
00590     UINT   message,
00591     WPARAM wParam,
00592     LPARAM lParam)
00593 {
00594     HWND hwndUI;
00595 
00596     <span class="comment">/*</span>
00597 <span class="comment">     * Deliver this message to other IME windows in this thread.</span>
00598 <span class="comment">     */</span>
00599     <span class="keywordflow">if</span> (pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o9">fDefault</a>)
00600         <a class="code" href="../../d9/d9/imectl_8c.html#a24">ImeBroadCastMsg</a>(pimeui, message, wParam, lParam);
00601 
00602     <span class="comment">/*</span>
00603 <span class="comment">     * We must re-create UI window of newly selected IME.</span>
00604 <span class="comment">     */</span>
00605     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)wParam == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00606         UserAssert(!<a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(<a class="code" href="../../d9/d9/imectl_8c.html#a5">GETUI</a>(pimeui)));
00607 
00608         <a class="code" href="../../d9/d9/imectl_8c.html#a2">SETHKL</a>(pimeui, (HKL)lParam);
00609 
00610 <span class="preprocessor">#ifdef LATE_CREATEUI</span>
00611 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o7">fActivate</a>)
00612             <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00613 <span class="preprocessor">#endif</span>
00614 <span class="preprocessor"></span>
00615         hwndUI = <a class="code" href="../../d9/d9/imectl_8c.html#a18">CreateIMEUI</a>(pimeui, (HKL)lParam);
00616 
00617         <a class="code" href="../../d9/d9/imectl_8c.html#a6">SETUI</a>(pimeui, hwndUI);
00618 
00619         <span class="keywordflow">if</span> (hwndUI != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00620             <a class="code" href="../../d5/d9/cltxt_8h.html#a12">SetWindowLongPtr</a>(hwndUI, IMMGWLP_IMC, (LONG_PTR)<a class="code" href="../../d9/d9/imectl_8c.html#a3">GETIMC</a>(pimeui));
00621             <a class="code" href="../../d9/d9/imectl_8c.html#a20">SendMessageToUI</a>(pimeui, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00622         }
00623 
00624         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/imectl_8c.html#a27">GetIMEShowStatus</a>() &amp;&amp; pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o15">fCtrlShowStatus</a>) {
00625             <span class="keywordflow">if</span> (!pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o6">fShowStatus</a> &amp;&amp; pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o7">fActivate</a> &amp;&amp;
00626                     <a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o2">hwndIMC</a>)) {
00627                 <span class="comment">/*</span>
00628 <span class="comment">                 * This must be sent to an application as an app may want</span>
00629 <span class="comment">                 * to hook this message to do its own UI.</span>
00630 <span class="comment">                 */</span>
00631                 <a class="code" href="../../d9/d9/imectl_8c.html#a21">SendOpenStatusNotify</a>(pimeui, pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o2">hwndIMC</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00632             }
00633         }
00634     }
00635     <span class="keywordflow">else</span> {
00636 
00637         <span class="keywordflow">if</span> (pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o6">fShowStatus</a> &amp;&amp; pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o7">fActivate</a> &amp;&amp;
00638                 <a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o2">hwndIMC</a>)) {
00639             <span class="comment">/*</span>
00640 <span class="comment">             * This must be sent to an application as an app may want</span>
00641 <span class="comment">             * to hook this message to do its own UI.</span>
00642 <span class="comment">             */</span>
00643             <a class="code" href="../../d9/d9/imectl_8c.html#a21">SendOpenStatusNotify</a>(pimeui, pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o2">hwndIMC</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00644         }
00645 
00646         <a class="code" href="../../d9/d9/imectl_8c.html#a20">SendMessageToUI</a>(pimeui, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00647 
00648         <a class="code" href="../../d9/d9/imectl_8c.html#a19">DestroyIMEUI</a>(pimeui);
00649 
00650         <a class="code" href="../../d9/d9/imectl_8c.html#a2">SETHKL</a>(pimeui, (HKL)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00651     }
00652 
00653     <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00654 }
00655 
00656 
<a name="l00657"></a><a class="code" href="../../d9/d9/imectl_8c.html#a15">00657</a> LRESULT <a class="code" href="../../d9/d9/imectl_8c.html#a15">ImeControlHandler</a>(
00658     <a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a> pimeui,
00659     UINT   message,
00660     WPARAM wParam,
00661     LPARAM lParam,
00662     BOOL   fAnsi)
00663 {
00664     HIMC  hImc;
00665     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwConversion, dwSentence;
00666 
00667     <span class="comment">/*</span>
00668 <span class="comment">     * Do nothing with NULL hImc.</span>
00669 <span class="comment">     */</span>
00670     <span class="keywordflow">if</span> ((hImc = <a class="code" href="../../d9/d9/imectl_8c.html#a3">GETIMC</a>(pimeui)) == <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>)
00671         <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00672 
00673     <span class="keywordflow">switch</span> (wParam) {
00674 
00675     <span class="keywordflow">case</span> IMC_OPENSTATUSWINDOW:
00676         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/imectl_8c.html#a27">GetIMEShowStatus</a>() &amp;&amp; !pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o6">fShowStatus</a>) {
00677             pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o6">fShowStatus</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00678             <a class="code" href="../../d9/d9/imectl_8c.html#a20">SendMessageToUI</a>(pimeui, WM_IME_NOTIFY,
00679                     IMN_OPENSTATUSWINDOW, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00680         }
00681         pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o15">fCtrlShowStatus</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00682         <span class="keywordflow">break</span>;
00683 
00684     <span class="keywordflow">case</span> IMC_CLOSESTATUSWINDOW:
00685         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/imectl_8c.html#a27">GetIMEShowStatus</a>() &amp;&amp; pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o6">fShowStatus</a>) {
00686             pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o6">fShowStatus</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00687             <a class="code" href="../../d9/d9/imectl_8c.html#a20">SendMessageToUI</a>(pimeui, WM_IME_NOTIFY,
00688                     IMN_CLOSESTATUSWINDOW, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00689         }
00690         pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o15">fCtrlShowStatus</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00691         <span class="keywordflow">break</span>;
00692 
00693     <span class="comment">/*</span>
00694 <span class="comment">     * ------------------------------------------------</span>
00695 <span class="comment">     * IMC_SETCOMPOSITIONFONT,</span>
00696 <span class="comment">     * IMC_SETCONVERSIONMODE,</span>
00697 <span class="comment">     * IMC_SETOPENSTATUS</span>
00698 <span class="comment">     * ------------------------------------------------</span>
00699 <span class="comment">     * Don't pass these WM_IME_CONTROLs to UI window.</span>
00700 <span class="comment">     * Call Imm in order to process these requests instead.</span>
00701 <span class="comment">     * It makes message flows simpler.</span>
00702 <span class="comment">     */</span>
00703     <span class="keywordflow">case</span> IMC_SETCOMPOSITIONFONT:
00704         <span class="keywordflow">if</span> (fAnsi) {
00705             <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a319">fpImmSetCompositionFontA</a>(hImc, (LPLOGFONTA)lParam))
00706                 <span class="keywordflow">return</span> 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00707         }
00708         <span class="keywordflow">else</span> {
00709             <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a318">fpImmSetCompositionFontW</a>(hImc, (LPLOGFONTW)lParam))
00710                 <span class="keywordflow">return</span> 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00711         }
00712         <span class="keywordflow">break</span>;
00713 
00714     <span class="keywordflow">case</span> IMC_SETCONVERSIONMODE:
00715         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a330">fpImmGetConversionStatus</a>(hImc, &amp;dwConversion, &amp;dwSentence) ||
00716             !<a class="code" href="../../d6/d0/usercli_8h.html#a331">fpImmSetConversionStatus</a>(hImc, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)lParam, dwSentence))
00717             <span class="keywordflow">return</span> 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00718         <span class="keywordflow">break</span>;
00719 
00720     <span class="keywordflow">case</span> IMC_SETSENTENCEMODE:
00721         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a330">fpImmGetConversionStatus</a>(hImc, &amp;dwConversion, &amp;dwSentence) ||
00722             !<a class="code" href="../../d6/d0/usercli_8h.html#a331">fpImmSetConversionStatus</a>(hImc, dwConversion, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)lParam))
00723             <span class="keywordflow">return</span> 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00724         <span class="keywordflow">break</span>;
00725 
00726     <span class="keywordflow">case</span> IMC_SETOPENSTATUS:
00727         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a325">fpImmSetOpenStatus</a>(hImc, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)lParam))
00728             <span class="keywordflow">return</span> 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00729         <span class="keywordflow">break</span>;
00730 
00731     <span class="keywordflow">case</span> IMC_GETCONVERSIONMODE:
00732         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a330">fpImmGetConversionStatus</a>(hImc,&amp;dwConversion, &amp;dwSentence))
00733             <span class="keywordflow">return</span> 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00734 
00735         <span class="keywordflow">return</span> (LONG)dwConversion;
00736 
00737     <span class="keywordflow">case</span> IMC_GETSENTENCEMODE:
00738         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a330">fpImmGetConversionStatus</a>(hImc,&amp;dwConversion, &amp;dwSentence))
00739             <span class="keywordflow">return</span> 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00740 
00741         <span class="keywordflow">return</span> (LONG)dwSentence;
00742 
00743     <span class="keywordflow">case</span> IMC_GETOPENSTATUS:
00744         <span class="keywordflow">return</span> (LONG)<a class="code" href="../../d6/d0/usercli_8h.html#a336">fpImmGetOpenStatus</a>(hImc);
00745 
00746     <span class="keywordflow">case</span> IMC_GETCOMPOSITIONFONT:
00747         <span class="keywordflow">if</span> (fAnsi) {
00748             <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a317">fpImmGetCompositionFontA</a>(hImc, (LPLOGFONTA)lParam))
00749                 <span class="keywordflow">return</span> 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00750         }
00751         <span class="keywordflow">else</span> {
00752             <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a316">fpImmGetCompositionFontW</a>(hImc, (LPLOGFONTW)lParam))
00753                 <span class="keywordflow">return</span> 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00754         }
00755         <span class="keywordflow">break</span>;
00756 
00757     <span class="keywordflow">case</span> IMC_SETCOMPOSITIONWINDOW:
00758         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a321">fpImmSetCompositionWindow</a>(hImc, (LPCOMPOSITIONFORM)lParam))
00759             <span class="keywordflow">return</span> 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00760         <span class="keywordflow">break</span>;
00761 
00762     <span class="keywordflow">case</span> IMC_SETSTATUSWINDOWPOS:
00763         {
00764             POINT ppt;
00765 
00766             ppt.x = (LONG)((LPPOINTS)&amp;lParam)-&gt;x;
00767             ppt.y = (LONG)((LPPOINTS)&amp;lParam)-&gt;y;
00768 
00769             <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a332">fpImmSetStatusWindowPos</a>(hImc, &amp;ppt))
00770                 <span class="keywordflow">return</span> 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00771         }
00772         <span class="keywordflow">break</span>;
00773 
00774     <span class="keywordflow">case</span> IMC_SETCANDIDATEPOS:
00775         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a328">fpImmSetCandidateWindow</a>(hImc, (LPCANDIDATEFORM)lParam))
00776             <span class="keywordflow">return</span> 1;
00777         <span class="keywordflow">break</span>;
00778 
00779     <span class="comment">/*</span>
00780 <span class="comment">     * Followings are the messsages to be sent to UI.</span>
00781 <span class="comment">     */</span>
00782     <span class="keywordflow">case</span> IMC_GETCANDIDATEPOS:
00783     <span class="keywordflow">case</span> IMC_GETSTATUSWINDOWPOS:
00784     <span class="keywordflow">case</span> IMC_GETCOMPOSITIONWINDOW:
00785     <span class="keywordflow">case</span> IMC_GETSOFTKBDPOS:
00786     <span class="keywordflow">case</span> IMC_SETSOFTKBDPOS:
00787         <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/imectl_8c.html#a20">SendMessageToUI</a>(pimeui, message, wParam, lParam, fAnsi);
00788 
00789     <span class="keywordflow">default</span>:
00790         <span class="keywordflow">break</span>;
00791     }
00792 
00793     <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00794 }
00795 
00796 
00797 
<a name="l00798"></a><a class="code" href="../../d9/d9/imectl_8c.html#a16">00798</a> LRESULT <a class="code" href="../../d9/d9/imectl_8c.html#a16">ImeSetContextHandler</a>(
00799     <a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a> pimeui,
00800     UINT   message,
00801     WPARAM wParam,
00802     LPARAM lParam)
00803 {
00804     HWND  hwndPrevIMC, hwndFocus;   <span class="comment">// focus window in the thread</span>
00805     HIMC  hFocusImc;                <span class="comment">// focus window's IMC</span>
00806     LRESULT lRet;
00807 
00808     pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o7">fActivate</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)wParam ? 1 : 0;
00809     hwndPrevIMC = pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o2">hwndIMC</a>;
00810 
00811     <span class="keywordflow">if</span> (wParam) {
00812         <span class="comment">/*</span>
00813 <span class="comment">         * if it's being activated</span>
00814 <span class="comment">         */</span>
00815 <span class="preprocessor">#ifdef LATE_CREATEUI</span>
00816 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/imectl_8c.html#a5">GETUI</a>(pimeui))
00817             <a class="code" href="../../d9/d9/imectl_8c.html#a6">SETUI</a>(pimeui, <a class="code" href="../../d9/d9/imectl_8c.html#a18">CreateIMEUI</a>(pimeui, <a class="code" href="../../d9/d9/imectl_8c.html#a1">GETHKL</a>(pimeui)));
00818 <span class="preprocessor">#endif</span>
00819 <span class="preprocessor"></span>
00820         <span class="comment">/*</span>
00821 <span class="comment">         * Check if this process a console IME ?</span>
00822 <span class="comment">         */</span>
00823         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a67">gfConIme</a> == <a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a8">UNKNOWN_CONIME</a>) {
00824             <a class="code" href="../../d1/d8/clglobal_8c.html#a67">gfConIme</a> = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a287">NtUserGetThreadState</a>(UserThreadStateIsConImeThread);
00825             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a67">gfConIme</a>) {
00826                 RIPMSG0(RIP_VERBOSE, <span class="stringliteral">"ImmSetContextHandler: This thread is console IME.\n"</span>);
00827                 UserAssert(pimeui);
00828                 <span class="comment">// Console IME will never show the IME status window.</span>
00829                 pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o15">fCtrlShowStatus</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00830             }
00831         }
00832 
00833         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a67">gfConIme</a>) {
00834             <span class="comment">/*</span>
00835 <span class="comment">             * Special handling for Console IME is needed</span>
00836 <span class="comment">             */</span>
00837             <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndOwner;
00838 
00839             UserAssert(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o0">spwnd</a>);
00840             pwndOwner = <a class="code" href="../../d6/d0/usercli_8h.html#a27">REBASEPWND</a>(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o0">spwnd</a>, spwndOwner);
00841             <span class="keywordflow">if</span> (pwndOwner != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00842                 <span class="comment">/*</span>
00843 <span class="comment">                 * Set current associated hIMC in IMEUI.</span>
00844 <span class="comment">                 */</span>
00845                 <a class="code" href="../../d9/d9/imectl_8c.html#a4">SETIMC</a>(pimeui, pwndOwner-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o20">hImc</a>);
00846                 <span class="comment">/*</span>
00847 <span class="comment">                 * Store it to the window memory.</span>
00848 <span class="comment">                 */</span>
00849                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/imectl_8c.html#a5">GETUI</a>(pimeui) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00850                     <a class="code" href="../../d5/d9/cltxt_8h.html#a12">SetWindowLongPtr</a>(<a class="code" href="../../d9/d9/imectl_8c.html#a5">GETUI</a>(pimeui), IMMGWLP_IMC, (LONG_PTR)pwndOwner-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o20">hImc</a>);
00851             }
00852 
00853             hwndFocus = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a328">NtUserQueryWindow</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o0">spwnd</a>), WindowFocusWindow);
00854             hFocusImc = pwndOwner-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o20">hImc</a>;
00855             RIPMSG2(RIP_VERBOSE, <span class="stringliteral">"CONSOLE IME: hwndFocus = %x, hFocusImc = %x"</span>, hwndFocus, hFocusImc);
00856 
00857             <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/imectl_8c.html#a20">SendMessageToUI</a>(pimeui, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00858         }
00859         <span class="keywordflow">else</span> {
00860             hwndFocus = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a328">NtUserQueryWindow</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o0">spwnd</a>), WindowFocusWindow);
00861             hFocusImc = <a class="code" href="../../d6/d0/usercli_8h.html#a307">fpImmGetContext</a>(hwndFocus);
00862         }
00863 
00864         <span class="comment">/*</span>
00865 <span class="comment">         * Cannot share input context with other IME window.</span>
00866 <span class="comment">         */</span>
00867         <span class="keywordflow">if</span> (hFocusImc != <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a> &amp;&amp;
00868                 !<a class="code" href="../../d9/d9/imectl_8c.html#a26">ImeIsUsableContext</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o0">spwnd</a>), hFocusImc)) {
00869             <a class="code" href="../../d9/d9/imectl_8c.html#a4">SETIMC</a>(pimeui, <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>);
00870             <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00871         }
00872 
00873         <a class="code" href="../../d9/d9/imectl_8c.html#a4">SETIMC</a>(pimeui, hFocusImc);
00874 
00875         <span class="comment">/*</span>
00876 <span class="comment">         * Store it to the window memory.</span>
00877 <span class="comment">         */</span>
00878         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/imectl_8c.html#a5">GETUI</a>(pimeui) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00879             <a class="code" href="../../d5/d9/cltxt_8h.html#a12">SetWindowLongPtr</a>(<a class="code" href="../../d9/d9/imectl_8c.html#a5">GETUI</a>(pimeui), IMMGWLP_IMC, (LONG_PTR)hFocusImc);
00880 
00881         <span class="comment">/*</span>
00882 <span class="comment">         * When we're receiving context,</span>
00883 <span class="comment">         * it is necessary to set the owner to this window.</span>
00884 <span class="comment">         * This is for:</span>
00885 <span class="comment">         *     Give the UI moving information.</span>
00886 <span class="comment">         *     Give the UI automatic Z-ordering.</span>
00887 <span class="comment">         *     Hide the UI when the owner is minimized.</span>
00888 <span class="comment">         */</span>
00889         <span class="keywordflow">if</span> (hFocusImc != <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>) {
00890             PINPUTCONTEXT pInputContext;
00891 
00892             <span class="comment">/*</span>
00893 <span class="comment">             * Get the window who's given the context.</span>
00894 <span class="comment">             */</span>
00895             <span class="keywordflow">if</span> ((pInputContext = <a class="code" href="../../d6/d0/usercli_8h.html#a313">fpImmLockIMC</a>(hFocusImc)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00896                 <span class="comment">//UserAssert(hwndFocus == pInputContext-&gt;hWnd);</span>
00897                 <span class="keywordflow">if</span> (hwndFocus != pInputContext-&gt;hWnd) {
00898                     <span class="comment">/*</span>
00899 <span class="comment">                     * Pq-&gt;spwndFocus has been changed so far...</span>
00900 <span class="comment">                     * All we can do is just to bail out.</span>
00901 <span class="comment">                     */</span>
00902                     <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00903                 }
00904             }
00905             <span class="keywordflow">else</span>
00906                 <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>; <span class="comment">// the context was broken</span>
00907 
00908             <span class="keywordflow">if</span> ((pInputContext-&gt;fdw31Compat &amp; F31COMPAT_ECSETCFS) &amp;&amp;
00909                     hwndPrevIMC != hwndFocus) {
00910                 COMPOSITIONFORM cf;
00911 
00912                 <span class="comment">/*</span>
00913 <span class="comment">                 * Set CFS_DEFAULT....</span>
00914 <span class="comment">                 */</span>
00915                 RtlZeroMemory(&amp;cf, <span class="keyword">sizeof</span>(cf));
00916                 <a class="code" href="../../d6/d0/usercli_8h.html#a321">fpImmSetCompositionWindow</a>(hFocusImc, &amp;cf);
00917                 pInputContext-&gt;fdw31Compat &amp;= ~F31COMPAT_ECSETCFS;
00918             }
00919 
00920             <a class="code" href="../../d6/d0/usercli_8h.html#a323">fpImmUnlockIMC</a>(hFocusImc);
00921 
00922             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a398">NtUserSetImeOwnerWindow</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o0">spwnd</a>), hwndFocus))
00923                 pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o2">hwndIMC</a> = hwndFocus;
00924 
00925         }
00926         <span class="keywordflow">else</span> {
00927             <span class="comment">/*</span>
00928 <span class="comment">             * NULL IMC is getting activated</span>
00929 <span class="comment">             */</span>
00930             pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o2">hwndIMC</a> = hwndFocus;
00931 
00932             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a398">NtUserSetImeOwnerWindow</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o0">spwnd</a>), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00933 
00934         }
00935     }
00936 
00937     lRet = <a class="code" href="../../d9/d9/imectl_8c.html#a20">SendMessageToUI</a>(pimeui, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00938 
00939     <span class="keywordflow">if</span> (pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o0">spwnd</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00940         <span class="comment">// Unusual case in stress..</span>
00941         <span class="comment">// IME window has been destroyed during the callback</span>
00942         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmSetContextHandler: pimeui-&gt;spwnd is NULL after SendMessageToUI."</span>);
00943         <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00944     }
00945 
00946     <span class="keywordflow">if</span> (pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o15">fCtrlShowStatus</a> &amp;&amp; <a class="code" href="../../d9/d9/imectl_8c.html#a27">GetIMEShowStatus</a>()) {
00947         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndFocus, pwndIMC, pwndPrevIMC;
00948         HWND hwndActive;
00949 
00950         hwndFocus = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a328">NtUserQueryWindow</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o0">spwnd</a>), WindowFocusWindow);
00951         pwndFocus = <a class="code" href="../../d3/d9/client_2wow_8c.html#a1">ValidateHwndNoRip</a>(hwndFocus);
00952 
00953         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)wParam == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00954             HWND hwndIme;
00955 
00956             <span class="comment">/*</span>
00957 <span class="comment">             * BOGUS BOGUS</span>
00958 <span class="comment">             * The following if statement is still insufficient</span>
00959 <span class="comment">             * it needs to think what WM_IME_SETCONTEXT:TRUE should do</span>
00960 <span class="comment">             * in the case of WINNLSEnableIME(true) - ref.win95c B#8548.</span>
00961 <span class="comment">             */</span>
00962             UserAssert(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o0">spwnd</a>);
00963             <span class="keywordflow">if</span> (pwndFocus != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o0">spwnd</a>) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndFocus)) {
00964 
00965                 <span class="keywordflow">if</span> (!pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o6">fShowStatus</a>) {
00966                     <span class="comment">/*</span>
00967 <span class="comment">                     * We have never sent IMN_OPENSTATUSWINDOW yet....</span>
00968 <span class="comment">                     */</span>
00969                     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9/client_2wow_8c.html#a1">ValidateHwndNoRip</a>(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o2">hwndIMC</a>)) {
00970                         <a class="code" href="../../d9/d9/imectl_8c.html#a21">SendOpenStatusNotify</a>(pimeui, pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o2">hwndIMC</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00971                     }
00972                 }
00973                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pwndIMC = <a class="code" href="../../d3/d9/client_2wow_8c.html#a1">ValidateHwndNoRip</a>(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o2">hwndIMC</a>)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00974                          (pwndPrevIMC = <a class="code" href="../../d3/d9/client_2wow_8c.html#a1">ValidateHwndNoRip</a>(hwndPrevIMC)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00975                          <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a11">GetTopLevelWindow</a>(pwndIMC) != <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a11">GetTopLevelWindow</a>(pwndPrevIMC)) {
00976                     <span class="comment">/*</span>
00977 <span class="comment">                     * Because the top level window of IME Wnd was changed.</span>
00978 <span class="comment">                     */</span>
00979                     <a class="code" href="../../d9/d9/imectl_8c.html#a21">SendOpenStatusNotify</a>(pimeui, hwndPrevIMC, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00980                     <a class="code" href="../../d9/d9/imectl_8c.html#a21">SendOpenStatusNotify</a>(pimeui, pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o2">hwndIMC</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00981                 }
00982             }
00983             <span class="comment">/*</span>
00984 <span class="comment">             * There may have other IME windows that have fShowStatus.</span>
00985 <span class="comment">             * We need to check the fShowStatus in the window list.</span>
00986 <span class="comment">             */</span>
00987             hwndIme = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o0">spwnd</a>);
00988             <span class="keywordflow">if</span> (hwndIme) {
00989                 <a class="code" href="../../d9/d9/imectl_8c.html#a30">NtUserCheckImeShowStatusInThread</a>(hwndIme);
00990             }
00991         }
00992         <span class="keywordflow">else</span> {
00993             <span class="comment">/*</span>
00994 <span class="comment">             * When focus was removed from this thread, we close the</span>
00995 <span class="comment">             * status window.</span>
00996 <span class="comment">             * Because focus was already removed from whndPrevIMC,</span>
00997 <span class="comment">             * hwndPrevIMC may be destroyed but we need to close the</span>
00998 <span class="comment">             * status window.</span>
00999 <span class="comment">             */</span>
01000             hwndActive = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a328">NtUserQueryWindow</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o0">spwnd</a>), WindowActiveWindow);
01001             UserAssert(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o0">spwnd</a>);
01002             <span class="keywordflow">if</span> (pwndFocus == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o0">spwnd</a>) != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndFocus) ||
01003                     hwndActive == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01004 
01005                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(hwndPrevIMC))
01006                     <a class="code" href="../../d9/d9/imectl_8c.html#a21">SendOpenStatusNotify</a>(pimeui, hwndPrevIMC, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01007                 <span class="keywordflow">else</span> {
01008                     pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o6">fShowStatus</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01009                     <a class="code" href="../../d9/d9/imectl_8c.html#a20">SendMessageToUI</a>(pimeui, WM_IME_NOTIFY,
01010                             IMN_CLOSESTATUSWINDOW, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01011                 }
01012             }
01013         }
01014     }
01015 
01016     <span class="keywordflow">return</span> lRet;
01017 }
01018 
01019 
<a name="l01020"></a><a class="code" href="../../d9/d9/imectl_8c.html#a17">01020</a> LRESULT <a class="code" href="../../d9/d9/imectl_8c.html#a17">ImeNotifyHandler</a>(
01021     <a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a> pimeui,
01022     UINT   message,
01023     WPARAM wParam,
01024     LPARAM lParam)
01025 {
01026     HWND hwndUI;
01027     LRESULT lRet = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
01028     HIMC hImc;
01029     PINPUTCONTEXT pInputContext;
01030 
01031     <span class="keywordflow">switch</span> (wParam) {
01032     <span class="keywordflow">case</span> IMN_PRIVATE:
01033         hwndUI = <a class="code" href="../../d9/d9/imectl_8c.html#a5">GETUI</a>(pimeui);
01034         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(hwndUI))
01035             lRet = <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwndUI, message, wParam, lParam);
01036         <span class="keywordflow">break</span>;
01037 
01038     <span class="keywordflow">case</span> IMN_SETCONVERSIONMODE:
01039     <span class="keywordflow">case</span> IMN_SETOPENSTATUS:
01040         <span class="comment">//</span>
01041         <span class="comment">// notify shell and keyboard the conversion mode change</span>
01042         <span class="comment">//</span>
01043         <span class="comment">// if this message is sent from ImmSetOpenStatus or</span>
01044         <span class="comment">// ImmSetConversionStatus, we have already notified</span>
01045         <span class="comment">// kernel the change. This is a little bit redundant.</span>
01046         <span class="comment">//</span>
01047         <span class="comment">// if application has eaten the message, we won't be here.</span>
01048         <span class="comment">// We need to think about the possibility later.</span>
01049         <span class="comment">//</span>
01050         hImc = <a class="code" href="../../d9/d9/imectl_8c.html#a3">GETIMC</a>(pimeui);
01051         <span class="keywordflow">if</span> ((pInputContext = <a class="code" href="../../d6/d0/usercli_8h.html#a313">fpImmLockIMC</a>(hImc)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01052             <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o2">hwndIMC</a>) ) {
01053                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a400">NtUserNotifyIMEStatus</a>( pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o2">hwndIMC</a>,
01054                                        (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)pInputContext-&gt;fOpen,
01055                                        pInputContext-&gt;fdwConversion );
01056             }
01057             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a67">gfConIme</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01058                 <span class="comment">/*</span>
01059 <span class="comment">                 * Special handling for Console IME is needed</span>
01060 <span class="comment">                 */</span>
01061                 <span class="keywordflow">if</span> (pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o0">spwnd</a>) {    <span class="comment">// If IME window is still there.</span>
01062                     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndOwner = <a class="code" href="../../d6/d0/usercli_8h.html#a27">REBASEPWND</a>(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o0">spwnd</a>, spwndOwner);
01063 
01064                     <span class="keywordflow">if</span> (pwndOwner != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01065                         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a400">NtUserNotifyIMEStatus</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwndOwner),
01066                                               (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)pInputContext-&gt;fOpen,
01067                                               pInputContext-&gt;fdwConversion);
01068                     }
01069                 }
01070             }
01071             <a class="code" href="../../d6/d0/usercli_8h.html#a323">fpImmUnlockIMC</a>(hImc);
01072         }
01073         <span class="comment">/*** FALL THROUGH ***/</span>
01074     <span class="keywordflow">default</span>:
01075         TAGMSG4(DBGTAG_IMM, <span class="stringliteral">"ImeNotifyHandler: sending to pimeui-&gt;ui=%p, msg=%x, wParam=%x, lParam=%x\n"</span>, <a class="code" href="../../d9/d9/imectl_8c.html#a5">GETUI</a>(pimeui), message, wParam, lParam);
01076         lRet = <a class="code" href="../../d9/d9/imectl_8c.html#a20">SendMessageToUI</a>(pimeui, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01077     }
01078 
01079     <span class="keywordflow">return</span> lRet;
01080 }
01081 
01082 
<a name="l01083"></a><a class="code" href="../../d9/d9/imectl_8c.html#a18">01083</a> HWND <a class="code" href="../../d9/d9/imectl_8c.html#a18">CreateIMEUI</a>(
01084     <a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a> pimeui,
01085     HKL    hKL)
01086 {
01087     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>      pwndIme = pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o0">spwnd</a>;
01088     HWND      hwndUI;
01089     <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">IMEINFOEX</a> iiex;
01090     <a class="code" href="../../d2/d7/structtagIMEDPI.html">PIMEDPI</a>   pimedpi;
01091     WNDCLASS  wndcls;
01092 
01093     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a333">fpImmGetImeInfoEx</a>(&amp;iiex, <a class="code" href="../../d8/d0/immstruc_8h.html#a75a52">ImeInfoExKeyboardLayout</a>, &amp;hKL))
01094         <span class="keywordflow">return</span> (HWND)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01095 
01096     <span class="keywordflow">if</span> ((pimedpi = <a class="code" href="../../d6/d0/usercli_8h.html#a334">fpImmLockImeDpi</a>(hKL)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01097         RIPMSG1(RIP_WARNING, <span class="stringliteral">"CreateIMEUI: ImmLockImeDpi(%lx) failed."</span>, hKL);
01098         <span class="keywordflow">return</span> (HWND)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01099     }
01100 
01101     <span class="keywordflow">if</span> (!GetClassInfoW(pimedpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o1">hInst</a>, iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o2">wszUIClass</a>, &amp;wndcls)) {
01102         RIPMSG1(RIP_WARNING, <span class="stringliteral">"CreateIMEUI: GetClassInfoW(%ws) failed\n"</span>, iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o2">wszUIClass</a>);
01103         <a class="code" href="../../d6/d0/usercli_8h.html#a335">fpImmUnlockImeDpi</a>(pimedpi);
01104         <span class="keywordflow">return</span> (HWND)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01105     }
01106 
01107     <span class="comment">// HACK HACK HACK</span>
01108     <span class="keywordflow">if</span> ((wndcls.style &amp; CS_IME) == 0) {
01109         RIPMSG1(RIP_ERROR, <span class="stringliteral">"CreateIMEUI: the Window Class (%S) does not have CS_IME flag on !!!\n"</span>,
01110                 wndcls.lpszClassName);
01111     }
01112 
01113     <span class="keywordflow">if</span> (iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o1">ImeInfo</a>.fdwProperty &amp; IME_PROP_UNICODE) {
01114         <span class="comment">/*</span>
01115 <span class="comment">         * For Unicode IME, we create an Unicode IME UI window.</span>
01116 <span class="comment">         */</span>
01117         hwndUI = CreateWindowExW(0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01118                         iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o2">wszUIClass</a>,
01119                         iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o2">wszUIClass</a>,
01120                         WS_POPUP|WS_DISABLED,
01121                         0, 0, 0, 0,
01122                         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwndIme), 0, wndcls.hInstance, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01123     }
01124     <span class="keywordflow">else</span> {
01125         <span class="comment">/*</span>
01126 <span class="comment">         * For ANSI IME, we create an ANSI IME UI window.</span>
01127 <span class="comment">         */</span>
01128 
01129         LPSTR pszClass;
01130         <span class="keywordtype">int</span> i;
01131         i = WCSToMB(iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o2">wszUIClass</a>, -1, &amp;pszClass, -1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01132         <span class="keywordflow">if</span> (i == 0) {
01133             RIPMSG1(RIP_WARNING, <span class="stringliteral">"CreateIMEUI: failed in W-&gt;A conversion (%S)"</span>, iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o2">wszUIClass</a>);
01134             <span class="keywordflow">return</span> (HWND)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01135         }
01136         pszClass[i] = <span class="charliteral">'\0'</span>;
01137 
01138         hwndUI = CreateWindowExA(0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01139                         pszClass,
01140                         pszClass,
01141                         WS_POPUP|WS_DISABLED,
01142                         0, 0, 0, 0,
01143                         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwndIme), 0, wndcls.hInstance, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01144 
01145         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(pszClass);
01146     }
01147 
01148     <span class="keywordflow">if</span> (hwndUI)
01149         <a class="code" href="../../d0/d0/ntuser_8h.html#a3">NtUserSetWindowLongPtr</a>(hwndUI, IMMGWLP_IMC, (LONG_PTR)<a class="code" href="../../d9/d9/imectl_8c.html#a3">GETIMC</a>(pimeui), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01150 
01151     <a class="code" href="../../d6/d0/usercli_8h.html#a335">fpImmUnlockImeDpi</a>(pimedpi);
01152 
01153     <span class="keywordflow">return</span> hwndUI;
01154 }
01155 
01156 
<a name="l01157"></a><a class="code" href="../../d9/d9/imectl_8c.html#a19">01157</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d9/imectl_8c.html#a19">DestroyIMEUI</a>(
01158     <a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a> pimeui)
01159 {
01160     <span class="comment">// This has currently nothing to do except for destroying the UI.</span>
01161     <span class="comment">// Review: Need to notify the UI with WM_IME_SETCONTEXT ?</span>
01162     <span class="comment">// Review: This doesn't support Multiple IME install yet.</span>
01163 
01164     HWND hwndUI = <a class="code" href="../../d9/d9/imectl_8c.html#a5">GETUI</a>(pimeui);
01165 
01166     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(hwndUI)) {
01167         pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o8">fDestroy</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01168         <span class="comment">/*</span>
01169 <span class="comment">         * We need this verify because the owner might have already</span>
01170 <span class="comment">         * killed it during its termination.</span>
01171 <span class="comment">         */</span>
01172         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a159">NtUserDestroyWindow</a>(hwndUI);
01173     }
01174     pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o8">fDestroy</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01175 
01176     <span class="comment">/*</span>
01177 <span class="comment">     * Reinitialize show status of the IME status window so that</span>
01178 <span class="comment">     * notification message will be sent when needed.</span>
01179 <span class="comment">     */</span>
01180     pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o6">fShowStatus</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01181 
01182     <a class="code" href="../../d9/d9/imectl_8c.html#a6">SETUI</a>(pimeui, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01183 
01184     <span class="keywordflow">return</span>;
01185 }
01186 
01187 
01188 <span class="comment">/***************************************************************************\</span>
01189 <span class="comment">* SendMessageToUI</span>
01190 <span class="comment">*</span>
01191 <span class="comment">* History:</span>
01192 <span class="comment">* 09-Apr-1996 wkwok       Created</span>
01193 <span class="comment">\***************************************************************************/</span>
01194 
<a name="l01195"></a><a class="code" href="../../d9/d9/imectl_8c.html#a20">01195</a> LRESULT <a class="code" href="../../d9/d9/imectl_8c.html#a20">SendMessageToUI</a>(
01196     <a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a> pimeui,
01197     UINT   message,
01198     WPARAM wParam,
01199     LPARAM lParam,
01200     BOOL   fAnsi)
01201 {
01202     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwndUI;
01203     LRESULT lRet;
01204 
01205     TAGMSG1(DBGTAG_IMM, <span class="stringliteral">"Sending to UI msg[%04X]\n"</span>, message);
01206 
01207     pwndUI = <a class="code" href="../../d3/d9/client_2wow_8c.html#a1">ValidateHwndNoRip</a>(<a class="code" href="../../d9/d9/imectl_8c.html#a5">GETUI</a>(pimeui));
01208 
01209     <span class="keywordflow">if</span> (pwndUI == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o0">spwnd</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01210         <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
01211 
01212     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o0">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a591">WFINDESTROY</a>) || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o0">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a583">WFDESTROYED</a>) ||
01213             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndUI, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a591">WFINDESTROY</a>) || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndUI, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a583">WFDESTROYED</a>)) {
01214         <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
01215     }
01216 
01217     InterlockedIncrement(&amp;pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o5">nCntInIMEProc</a>); <span class="comment">// Mark to avoid recursion.</span>
01218 
01219     lRet = <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pwndUI, message, wParam, lParam, fAnsi);
01220 
01221     InterlockedDecrement(&amp;pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o5">nCntInIMEProc</a>); <span class="comment">// Mark to avoid recursion.</span>
01222 
01223     <span class="keywordflow">return</span> lRet;
01224 }
01225 
01226 
01227 <span class="comment">/***************************************************************************\</span>
01228 <span class="comment">* SendOpenStatusNotify</span>
01229 <span class="comment">*</span>
01230 <span class="comment">* History:</span>
01231 <span class="comment">* 09-Apr-1996 wkwok       Created</span>
01232 <span class="comment">\***************************************************************************/</span>
01233 
<a name="l01234"></a><a class="code" href="../../d9/d9/imectl_8c.html#a21">01234</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d9/imectl_8c.html#a21">SendOpenStatusNotify</a>(
01235     <a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a> pimeui,
01236     HWND   hwndApp,
01237     BOOL   fOpen)
01238 {
01239     WPARAM wParam = fOpen ? IMN_OPENSTATUSWINDOW : IMN_CLOSESTATUSWINDOW;
01240 
01241     pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o6">fShowStatus</a> = fOpen;
01242 
01243 
01244     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;dwExpWinVer &gt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>) {
01245         TAGMSG2(DBGTAG_IMM, <span class="stringliteral">"SendOpenStatusNotify: sending to hwnd=%lx, wParam=%d\n"</span>, hwndApp, wParam);
01246         <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwndApp, WM_IME_NOTIFY, wParam, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01247     }
01248     <span class="keywordflow">else</span> {
01249         TAGMSG2(DBGTAG_IMM, <span class="stringliteral">"SendOpenStatusNotify:sending to imeui-&gt;UI=%p, wParam=%d\n"</span>, <a class="code" href="../../d9/d9/imectl_8c.html#a5">GETUI</a>(pimeui), wParam);
01250         <a class="code" href="../../d9/d9/imectl_8c.html#a20">SendMessageToUI</a>(pimeui, WM_IME_NOTIFY, wParam, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01251     }
01252 
01253     <span class="keywordflow">return</span>;
01254 }
01255 
01256 
<a name="l01257"></a><a class="code" href="../../d9/d9/imectl_8c.html#a22">01257</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d9/imectl_8c.html#a22">ImeSetImc</a>(
01258     <a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a> pimeui,
01259     HIMC hImc)
01260 {
01261     HWND hImeWnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o0">spwnd</a>);
01262     HIMC hOldImc = <a class="code" href="../../d9/d9/imectl_8c.html#a3">GETIMC</a>(pimeui);
01263 
01264     <span class="comment">/*</span>
01265 <span class="comment">     * return if nothing to change.</span>
01266 <span class="comment">     */</span>
01267     <span class="keywordflow">if</span> (hImc == hOldImc)
01268         <span class="keywordflow">return</span>;
01269 
01270     <span class="comment">/*</span>
01271 <span class="comment">     * Unmark the old input context.</span>
01272 <span class="comment">     */</span>
01273     <span class="keywordflow">if</span> (hOldImc != <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>)
01274         <a class="code" href="../../d9/d9/imectl_8c.html#a25">ImeMarkUsedContext</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hOldImc);
01275 
01276     <span class="comment">/*</span>
01277 <span class="comment">     * Update the in use input context for this IME window.</span>
01278 <span class="comment">     */</span>
01279     pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o1">hIMC</a> = hImc;
01280 
01281     <span class="comment">/*</span>
01282 <span class="comment">     * Mark the new input context.</span>
01283 <span class="comment">     */</span>
01284     <span class="keywordflow">if</span> (hImc != <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>)
01285         <a class="code" href="../../d9/d9/imectl_8c.html#a25">ImeMarkUsedContext</a>(hImeWnd, hImc);
01286 }
01287 
01288 
01289 <span class="comment">/***************************************************************************\</span>
01290 <span class="comment">*  FocusSetIMCContext()</span>
01291 <span class="comment">*</span>
01292 <span class="comment">* History:</span>
01293 <span class="comment">* 21-Mar-1996 wkwok       Created</span>
01294 <span class="comment">\***************************************************************************/</span>
01295 
<a name="l01296"></a><a class="code" href="../../d9/d9/imectl_8c.html#a23">01296</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d9/imectl_8c.html#a23">FocusSetIMCContext</a>(
01297     HWND hWnd,
01298     BOOL fActivate)
01299 {
01300     HIMC hImc;
01301 
01302     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>)) {
01303         hImc = <a class="code" href="../../d6/d0/usercli_8h.html#a307">fpImmGetContext</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
01304         <a class="code" href="../../d6/d0/usercli_8h.html#a337">fpImmSetActiveContext</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, hImc, fActivate);
01305         <a class="code" href="../../d6/d0/usercli_8h.html#a314">fpImmReleaseContext</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, hImc);
01306     }
01307     <span class="keywordflow">else</span> {
01308         <a class="code" href="../../d6/d0/usercli_8h.html#a337">fpImmSetActiveContext</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>, fActivate);
01309     }
01310 
01311     <span class="keywordflow">return</span>;
01312 }
01313 
01314 
<a name="l01315"></a><a class="code" href="../../d9/d9/imectl_8c.html#a24">01315</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/imectl_8c.html#a24">ImeBroadCastMsg</a>(
01316     <a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a> pimeui,
01317     UINT   message,
01318     WPARAM wParam,
01319     LPARAM lParam)
01320 {
01321     UNREFERENCED_PARAMETER(pimeui);
01322     UNREFERENCED_PARAMETER(message);
01323     UNREFERENCED_PARAMETER(wParam);
01324     UNREFERENCED_PARAMETER(lParam);
01325 
01326     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01327 }
01328 
01329 <span class="comment">/***************************************************************************\</span>
01330 <span class="comment">*  ImeMarkUsedContext()</span>
01331 <span class="comment">*</span>
01332 <span class="comment">*  Some IME windows can not share the same input context. This function</span>
01333 <span class="comment">*  marks the specified hImc to be in used by the specified IME window.</span>
01334 <span class="comment">*</span>
01335 <span class="comment">* History:</span>
01336 <span class="comment">* 12-Mar-1996 wkwok       Created</span>
01337 <span class="comment">\***************************************************************************/</span>
01338 
<a name="l01339"></a><a class="code" href="../../d9/d9/imectl_8c.html#a25">01339</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d9/imectl_8c.html#a25">ImeMarkUsedContext</a>(
01340     HWND hImeWnd,
01341     HIMC hImc)
01342 {
01343     <a class="code" href="../../d1/d7/structtagIMC.html">PIMC</a> pImc;
01344 
01345     pImc = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a6">HMValidateHandle</a>((HANDLE)hImc, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a253">TYPE_INPUTCONTEXT</a>);
01346     <span class="keywordflow">if</span> (pImc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01347         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImeMarkUsedContext: Invalid hImc (=%lx)."</span>, hImc);
01348         <span class="keywordflow">return</span>;
01349     }
01350 
01351     UserAssert( <a class="code" href="../../d3/d9/client_2wow_8c.html#a1">ValidateHwndNoRip</a>(pImc-&gt;<a class="code" href="../../d1/d7/structtagIMC.html#o3">hImeWnd</a>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || hImeWnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01352 
01353     <span class="comment">/*</span>
01354 <span class="comment">     * Nothing to change?</span>
01355 <span class="comment">     */</span>
01356     <span class="keywordflow">if</span> (pImc-&gt;<a class="code" href="../../d1/d7/structtagIMC.html#o3">hImeWnd</a> == hImeWnd)
01357         <span class="keywordflow">return</span>;
01358 
01359     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a388">NtUserUpdateInputContext</a>(hImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a73a47">UpdateInUseImeWindow</a>, (ULONG_PTR)hImeWnd);
01360 
01361     <span class="keywordflow">return</span>;
01362 }
01363 
01364 
01365 <span class="comment">/***************************************************************************\</span>
01366 <span class="comment">*  ImeIsUsableContext()</span>
01367 <span class="comment">*</span>
01368 <span class="comment">*  Some IME windows can not share the same input context. This function</span>
01369 <span class="comment">*  checks whether the specified hImc can be used (means 'Set activated')</span>
01370 <span class="comment">*  by the specified IME window.</span>
01371 <span class="comment">*</span>
01372 <span class="comment">*  Return: TRUE  - OK to use the hImc by hImeWnd.</span>
01373 <span class="comment">*          FALSE - otherwise.</span>
01374 <span class="comment">*</span>
01375 <span class="comment">* History:</span>
01376 <span class="comment">* 12-Mar-1996 wkwok       Created</span>
01377 <span class="comment">\***************************************************************************/</span>
01378 
<a name="l01379"></a><a class="code" href="../../d9/d9/imectl_8c.html#a26">01379</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/imectl_8c.html#a26">ImeIsUsableContext</a>(
01380     HWND hImeWnd,
01381     HIMC hImc)
01382 {
01383     <a class="code" href="../../d1/d7/structtagIMC.html">PIMC</a> pImc;
01384 
01385     UserAssert(hImeWnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01386 
01387     pImc = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a6">HMValidateHandle</a>((HANDLE)hImc, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a253">TYPE_INPUTCONTEXT</a>);
01388     <span class="keywordflow">if</span> (pImc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01389         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImeIsUsableContext: Invalid hImc (=%lx)."</span>, hImc);
01390         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01391     }
01392 
01393     <span class="keywordflow">if</span> ( pImc-&gt;<a class="code" href="../../d1/d7/structtagIMC.html#o3">hImeWnd</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>     ||
01394          pImc-&gt;<a class="code" href="../../d1/d7/structtagIMC.html#o3">hImeWnd</a> == hImeWnd  ||
01395          <a class="code" href="../../d3/d9/client_2wow_8c.html#a1">ValidateHwndNoRip</a>(pImc-&gt;<a class="code" href="../../d1/d7/structtagIMC.html#o3">hImeWnd</a>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
01396     {
01397         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01398     }
01399 
01400 
01401     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01402 }
01403 
01404 <span class="comment">/***************************************************************************\</span>
01405 <span class="comment">* GetIMEShowStatus()</span>
01406 <span class="comment">*</span>
01407 <span class="comment">* Get the global IME show status from kernel.</span>
01408 <span class="comment">*</span>
01409 <span class="comment">* History:</span>
01410 <span class="comment">* 19-Sep-1996 takaok       Ported from internat.exe.</span>
01411 <span class="comment">\***************************************************************************/</span>
01412 
<a name="l01413"></a><a class="code" href="../../d9/d9/imectl_8c.html#a27">01413</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/imectl_8c.html#a27">GetIMEShowStatus</a>(<span class="keywordtype">void</span>)
01414 {
01415     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a173">NtUserCallNoParam</a>(SFI__GETIMESHOWSTATUS);
01416 }
01417 
01418 
01419 
01420 <span class="comment">/***************************************************************************\</span>
01421 <span class="comment">*  IMEIndicatorGetMenuIDData</span>
01422 <span class="comment">*</span>
01423 <span class="comment">* History:</span>
01424 <span class="comment">* 3-Nov-97 Hiroyama</span>
01425 <span class="comment">\***************************************************************************/</span>
01426 
<a name="l01427"></a><a class="code" href="../../d9/d9/imectl_8c.html#a10">01427</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/imectl_8c.html#a10">IMEIndicatorGetMenuIDData</a>(PUINT puMenuID, PDWORD pdwData)
01428 {
01429     HANDLE hinstIndic;
01430 
01431     hinstIndic = GetModuleHandle(<a class="code" href="../../d9/d9/imectl_8c.html#a7">szIndicDLL</a>);
01432     <span class="keywordflow">if</span> (hinstIndic == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01433         <a class="code" href="../../d9/d9/imectl_8c.html#a8">gpfnGetIMEMenuItemData</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01434         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01435     }
01436 
01437     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/imectl_8c.html#a8">gpfnGetIMEMenuItemData</a>) {
01438         <a class="code" href="../../d9/d9/imectl_8c.html#a8">gpfnGetIMEMenuItemData</a> = GetProcAddress(hinstIndic, (LPSTR)ORD_GETIMEMENUITEMDATA);
01439     }
01440     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/imectl_8c.html#a8">gpfnGetIMEMenuItemData</a>)
01441         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01442 
01443     (*(FPGETIMEMENUITEMDATA)<a class="code" href="../../d9/d9/imectl_8c.html#a8">gpfnGetIMEMenuItemData</a>)(puMenuID, pdwData);
01444     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01445 }
01446 
01447 
<a name="l01448"></a><a class="code" href="../../d6/d0/usercli_8h.html#a789">01448</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/usercli_8h.html#a789">SyncSoftKbdState</a>(
01449     HIMC hImc,
01450     LPARAM lParam)
01451 {
01452     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> fdwConversion, fdwSentence, fdwNewConversion;
01453 
01454     <a class="code" href="../../d6/d0/usercli_8h.html#a330">fpImmGetConversionStatus</a>(hImc, &amp;fdwConversion, &amp;fdwSentence);
01455 
01456     <span class="keywordflow">if</span> (lParam) {
01457         fdwNewConversion = fdwConversion | IME_CMODE_SOFTKBD;
01458     } <span class="keywordflow">else</span> {
01459         fdwNewConversion = fdwConversion &amp; ~IME_CMODE_SOFTKBD;
01460     }
01461 
01462     <span class="keywordflow">if</span> (fdwNewConversion != fdwConversion) {
01463         <a class="code" href="../../d6/d0/usercli_8h.html#a331">fpImmSetConversionStatus</a>(hImc, fdwNewConversion, fdwSentence);
01464     }
01465 
01466     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01467 }
01468 
01469 <span class="comment">/***************************************************************************\</span>
01470 <span class="comment">*  ImeCopyDataHandler</span>
01471 <span class="comment">*</span>
01472 <span class="comment">* History:</span>
01473 <span class="comment">* 10-Nov-98 Hiroyama</span>
01474 <span class="comment">\***************************************************************************/</span>
01475 
<a name="l01476"></a><a class="code" href="../../d9/d9/imectl_8c.html#a28">01476</a> LRESULT <a class="code" href="../../d9/d9/imectl_8c.html#a28">ImeCopyDataHandler</a>(
01477     WPARAM wParam,
01478     LPARAM lParam)
01479 {
01480     HINSTANCE hInstImm;
01481     <a class="code" href="../../d0/d5/perfuser_8c.html#a20">BOOL</a> (WINAPI* fpImmPenAuxInput)(HWND, <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>);
01482 
01483     hInstImm = GetModuleHandleW(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"IMM32.DLL"</span>);
01484     <span class="keywordflow">if</span> (hInstImm == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01485         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01486     }
01487 
01488     fpImmPenAuxInput = (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)GetProcAddress(hInstImm, <span class="stringliteral">"ImmPenAuxInput"</span>);
01489     <span class="keywordflow">if</span> (fpImmPenAuxInput == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01490         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01491     }
01492 
01493     <span class="keywordflow">return</span> fpImmPenAuxInput((HWND)wParam, (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)lParam);
01494 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:20 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
