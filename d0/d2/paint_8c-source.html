<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: paint.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>paint.c</h1><a href="../../d9/d2/paint_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: paint.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains the APIs used to begin and end window painting.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 27-Oct-1990 DarrinM   Created.</span>
00010 <span class="comment">* 12-Feb-1991 IanJa     HWND revalidation added</span>
00011 <span class="comment">\***************************************************************************/</span>
00012 
00013 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00014 <span class="preprocessor">#pragma hdrstop</span>
00015 <span class="preprocessor"></span>
00016 <span class="comment">/***************************************************************************\</span>
00017 <span class="comment">* xxxFillWindow (not an API)</span>
00018 <span class="comment">*</span>
00019 <span class="comment">* pwndBrush - The brush is aligned with with client rect of this window.</span>
00020 <span class="comment">*             It is usually either pwndPaint or pwndPaint's parent.</span>
00021 <span class="comment">*</span>
00022 <span class="comment">* pwndPaint - The window to paint.</span>
00023 <span class="comment">* hdc       - The DC to paint in.</span>
00024 <span class="comment">* hbr       - The brush to use.</span>
00025 <span class="comment">*</span>
00026 <span class="comment">* Returns TRUE if successful, FALSE if not.</span>
00027 <span class="comment">*</span>
00028 <span class="comment">* History:</span>
00029 <span class="comment">* 15-Nov-1990 DarrinM   Ported from Win 3.0 sources.</span>
00030 <span class="comment">* 21-Jan-1991 IanJa     Prefix '_' denoting exported function.</span>
00031 <span class="comment">\***************************************************************************/</span>
00032 
<a name="l00033"></a><a class="code" href="../../d4/d1/userk_8h.html#a1563">00033</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1563">xxxFillWindow</a>(
00034     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>   pwndBrush,
00035     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>   pwndPaint,
00036     HDC    hdc,
00037     HBRUSH hbr)
00038 {
00039     RECT rc;
00040 
00041     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndBrush);
00042     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndPaint);
00043 
00044     <span class="comment">/*</span>
00045 <span class="comment">     * If there is no pwndBrush (sometimes the parent), use pwndPaint.</span>
00046 <span class="comment">     */</span>
00047     <span class="keywordflow">if</span> (pwndBrush == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00048         pwndBrush = pwndPaint;
00049 
00050     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1233">UT_GetParentDCClipBox</a>(pwndPaint, hdc, &amp;rc))
00051         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1568">xxxPaintRect</a>(pwndBrush, pwndPaint, hdc, hbr, &amp;rc);
00052 
00053     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00054 }
00055 
00056 <span class="comment">/***************************************************************************\</span>
00057 <span class="comment">* xxxPaintRect</span>
00058 <span class="comment">*</span>
00059 <span class="comment">* pwndBrush - The brush is aligned with with client rect of this window.</span>
00060 <span class="comment">*             It is usually either pwndPaint or pwndPaint's parent.</span>
00061 <span class="comment">*</span>
00062 <span class="comment">* pwndPaint - The window to paint in.</span>
00063 <span class="comment">* hdc       - The DC to paint in.</span>
00064 <span class="comment">* hbr       - The brush to use.</span>
00065 <span class="comment">* lprc      - The rectangle to paint.</span>
00066 <span class="comment">*</span>
00067 <span class="comment">* History:</span>
00068 <span class="comment">* 15-Nov-1990 DarrinM   Ported from Win 3.0 sources.</span>
00069 <span class="comment">* 21-Jan-1991 IanJa     Prefix '_' denoting exported function.</span>
00070 <span class="comment">\***************************************************************************/</span>
00071 
<a name="l00072"></a><a class="code" href="../../d4/d1/userk_8h.html#a1568">00072</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1568">xxxPaintRect</a>(
00073     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>   pwndBrush,
00074     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>   pwndPaint,
00075     HDC    hdc,
00076     HBRUSH hbr,
00077     LPRECT lprc)
00078 {
00079     POINT ptOrg;
00080 
00081     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndBrush);
00082     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndPaint);
00083 
00084     <span class="keywordflow">if</span> (pwndBrush == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00085         pwndBrush = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;rpdesk-&gt;pDeskInfo-&gt;spwnd;
00086     }
00087 
00088     <span class="keywordflow">if</span> (pwndBrush == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwndBrush)) {
00089         GreSetBrushOrg(
00090                 hdc,
00091                 0,
00092                 0,
00093                 &amp;ptOrg);
00094     } <span class="keywordflow">else</span> {
00095         GreSetBrushOrg(
00096                 hdc,
00097                 pwndBrush-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left - pwndPaint-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left,
00098                 pwndBrush-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top - pwndPaint-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top,
00099                 &amp;ptOrg);
00100     }
00101 
00102     <span class="comment">/*</span>
00103 <span class="comment">     * If hbr &lt; CTLCOLOR_MAX, it isn't really a brush but is one of our</span>
00104 <span class="comment">     * special color values.  Translate it to the appropriate WM_CTLCOLOR</span>
00105 <span class="comment">     * message and send it off to get back a real brush.  The translation</span>
00106 <span class="comment">     * process assumes the CTLCOLOR*** and WM_CTLCOLOR*** values map directly.</span>
00107 <span class="comment">     */</span>
00108     <span class="keywordflow">if</span> (hbr &lt; (HBRUSH)CTLCOLOR_MAX) {
00109         hbr = <a class="code" href="../../d4/d1/userk_8h.html#a1565">xxxGetControlColor</a>(pwndBrush,
00110                                  pwndPaint,
00111                                  hdc,
00112                                  HandleToUlong(hbr) + WM_CTLCOLORMSGBOX);
00113     }
00114 
00115     <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>(hdc, lprc, hbr);
00116 
00117     GreSetBrushOrg(hdc, ptOrg.x, ptOrg.y, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00118 
00119 
00120     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00121 }
00122 
00123 <span class="comment">/***************************************************************************\</span>
00124 <span class="comment">* DeleteMaybeSpecialRgn</span>
00125 <span class="comment">*</span>
00126 <span class="comment">* Deletes a GDI region, making sure it is not a special region.</span>
00127 <span class="comment">*</span>
00128 <span class="comment">* History:</span>
00129 <span class="comment">* 26-Feb-1992 MikeKe    from win3.1</span>
00130 <span class="comment">\***************************************************************************/</span>
00131 
<a name="l00132"></a><a class="code" href="../../d4/d1/userk_8h.html#a1003">00132</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1003">DeleteMaybeSpecialRgn</a>(
00133     HRGN hrgn)
00134 {
00135     <span class="keywordflow">if</span> (hrgn &gt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a879">HRGN_SPECIAL_LAST</a>) {
00136         GreDeleteObject(hrgn);
00137     }
00138 }
00139 
00140 
00141 
00142 <span class="comment">/***************************************************************************\</span>
00143 <span class="comment">* GetNCUpdateRgn</span>
00144 <span class="comment">*</span>
00145 <span class="comment">* Gets the update region which includes the non-client area.</span>
00146 <span class="comment">*</span>
00147 <span class="comment">* History:</span>
00148 <span class="comment">* 26-Feb-1992 MikeKe    From win3.1</span>
00149 <span class="comment">\***************************************************************************/</span>
00150 
<a name="l00151"></a><a class="code" href="../../d9/d2/paint_8c.html#a3">00151</a> HRGN <a class="code" href="../../d9/d2/paint_8c.html#a3">GetNCUpdateRgn</a>(
00152     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00153     BOOL fValidateFrame)
00154 {
00155     HRGN hrgnUpdate;
00156 
00157     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> &gt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>) {
00158 
00159         <span class="comment">/*</span>
00160 <span class="comment">         * We must make a copy of our update region, because</span>
00161 <span class="comment">         * it could change if we send a message, and we want to</span>
00162 <span class="comment">         * make sure the whole thing is used for drawing our</span>
00163 <span class="comment">         * frame and background.  We can't use a global</span>
00164 <span class="comment">         * temporary region, because more than one app may</span>
00165 <span class="comment">         * be calling this routine.</span>
00166 <span class="comment">         */</span>
00167         hrgnUpdate = <a class="code" href="../../d4/d1/userk_8h.html#a1163">CreateEmptyRgnPublic</a>();
00168 
00169         <span class="keywordflow">if</span> (hrgnUpdate == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00170             hrgnUpdate = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>;
00171         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a227">CopyRgn</a>(hrgnUpdate, pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a>) == ERROR) {
00172             GreDeleteObject(hrgnUpdate);
00173             hrgnUpdate = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>;
00174         }
00175 
00176         <span class="keywordflow">if</span> (fValidateFrame) {
00177 
00178             <span class="comment">/*</span>
00179 <span class="comment">             * Now that we've taken care of any frame drawing,</span>
00180 <span class="comment">             * intersect the update region with the window's</span>
00181 <span class="comment">             * client area.  Otherwise, apps that do ValidateRects()</span>
00182 <span class="comment">             * to draw themselves (e.g., WinWord) won't ever</span>
00183 <span class="comment">             * subtract off the part of the update region that</span>
00184 <span class="comment">             * overlaps the frame but not the client.</span>
00185 <span class="comment">             */</span>
00186             <a class="code" href="../../d3/d6/visrgn_8c.html#a18">CalcWindowRgn</a>(pwnd, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a191">ghrgnInv2</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00187 
00188             <span class="keywordflow">switch</span> (<a class="code" href="../../d4/d1/userk_8h.html#a228">IntersectRgn</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a>,
00189                                  pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a>,
00190                                  <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a191">ghrgnInv2</a>)) {
00191             <span class="keywordflow">case</span> ERROR:
00192                 <span class="comment">/*</span>
00193 <span class="comment">                 * If an error occured, we can't leave things as</span>
00194 <span class="comment">                 * they are: invalidate the whole window and let</span>
00195 <span class="comment">                 * BeginPaint() take care of it.</span>
00196 <span class="comment">                 */</span>
00197                 GreDeleteObject(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a>);
00198                 pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>;
00199                 <span class="keywordflow">break</span>;
00200 
00201             <span class="keywordflow">case</span> NULLREGION:
00202                 <span class="comment">/*</span>
00203 <span class="comment">                 * There is nothing in the client area to repaint.</span>
00204 <span class="comment">                 * Blow the region away, and decrement the paint count</span>
00205 <span class="comment">                 * if possible.</span>
00206 <span class="comment">                 */</span>
00207                 GreDeleteObject(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a>);
00208                 pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00209                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a564">WFUPDATEDIRTY</a>);
00210                 <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a563">WFINTERNALPAINT</a>))
00211                     <a class="code" href="../../d4/d1/userk_8h.html#a1470">DecPaintCount</a>(pwnd);
00212                 <span class="keywordflow">break</span>;
00213             }
00214         }
00215 
00216     } <span class="keywordflow">else</span> {
00217         hrgnUpdate = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a>;
00218     }
00219 
00220     <span class="keywordflow">return</span> hrgnUpdate;
00221 }
00222 
00223 <span class="comment">/***************************************************************************\</span>
00224 <span class="comment">* xxxSendNCPaint</span>
00225 <span class="comment">*</span>
00226 <span class="comment">* Sends a WM_NCPAINT message to a window.</span>
00227 <span class="comment">*</span>
00228 <span class="comment">* History:</span>
00229 <span class="comment">* 16-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
00230 <span class="comment">\***************************************************************************/</span>
00231 
<a name="l00232"></a><a class="code" href="../../d9/d2/paint_8c.html#a4">00232</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d2/paint_8c.html#a4">xxxSendNCPaint</a>(
00233     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00234     HRGN hrgnUpdate)
00235 {
00236     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00237 
00238     <span class="comment">/*</span>
00239 <span class="comment">     * Clear the WFSENDNCPAINT bit...</span>
00240 <span class="comment">     */</span>
00241     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a562">WFSENDNCPAINT</a>);
00242 
00243     <span class="comment">/*</span>
00244 <span class="comment">     * If the window is active, but its FRAMEON bit hasn't</span>
00245 <span class="comment">     * been set yet, set it and make sure that the entire frame</span>
00246 <span class="comment">     * gets redrawn when we send the NCPAINT.</span>
00247 <span class="comment">     */</span>
00248     <span class="keywordflow">if</span> ((pwnd == <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;pq-&gt;spwndActive) &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a557">WFFRAMEON</a>)) {
00249         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a557">WFFRAMEON</a>);
00250         hrgnUpdate = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>;
00251         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a559">WFNONCPAINT</a>);
00252     }
00253 
00254     <span class="comment">/*</span>
00255 <span class="comment">     * If PixieHack() has set the WM_NCPAINT bit, we must be sure</span>
00256 <span class="comment">     * to send with hrgnClip == HRGN_FULL.  (see PixieHack() in wmupdate.c)</span>
00257 <span class="comment">     */</span>
00258     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a608">WFPIXIEHACK</a>)) {
00259         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a608">WFPIXIEHACK</a>);
00260         hrgnUpdate = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>;
00261     }
00262 
00263     <span class="keywordflow">if</span> (hrgnUpdate)
00264         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_NCPAINT, (WPARAM)hrgnUpdate, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00265 }
00266 
00267 
00268 
00269 <span class="comment">/***************************************************************************\</span>
00270 <span class="comment">* xxxSendChildNCPaint</span>
00271 <span class="comment">*</span>
00272 <span class="comment">* Sends WM_NCPAINT message to the immediate children of a window.</span>
00273 <span class="comment">*</span>
00274 <span class="comment">* History:</span>
00275 <span class="comment">* 16-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
00276 <span class="comment">\***************************************************************************/</span>
00277 
<a name="l00278"></a><a class="code" href="../../d9/d2/paint_8c.html#a5">00278</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d2/paint_8c.html#a5">xxxSendChildNCPaint</a>(
00279     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00280 {
00281     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
00282 
00283     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00284 
00285     <a class="code" href="../../d4/d1/userk_8h.html#a115">ThreadLockNever</a>(&amp;tlpwnd);
00286     pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
00287     <span class="keywordflow">while</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00288         <span class="keywordflow">if</span> ((pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a562">WFSENDNCPAINT</a>)) {
00289             <a class="code" href="../../d4/d1/userk_8h.html#a983">ThreadLockExchangeAlways</a>(pwnd, &amp;tlpwnd);
00290             <a class="code" href="../../d9/d2/paint_8c.html#a4">xxxSendNCPaint</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>);
00291         }
00292 
00293         pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
00294     }
00295 
00296     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
00297 }
00298 
00299 <span class="comment">/***************************************************************************\</span>
00300 <span class="comment">* xxxBeginPaint</span>
00301 <span class="comment">*</span>
00302 <span class="comment">* Revalidation Note:</span>
00303 <span class="comment">* We MUST return NULL if the window is deleted during xxxBeginPaint because</span>
00304 <span class="comment">* its DCs are released upon deletion, and we shouldn't return a *released* DC!</span>
00305 <span class="comment">*</span>
00306 <span class="comment">* History:</span>
00307 <span class="comment">* 16-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
00308 <span class="comment">\***************************************************************************/</span>
00309 
<a name="l00310"></a><a class="code" href="../../d9/d2/paint_8c.html#a6">00310</a> HDC <a class="code" href="../../d4/d1/userk_8h.html#a1710">xxxBeginPaint</a>(
00311     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>          pwnd,
00312     LPPAINTSTRUCT lpps)
00313 {
00314     HRGN hrgnUpdate;
00315     HDC  hdc;
00316     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSendEraseBkgnd;
00317 
00318     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00319     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
00320 
00321     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a657">TEST_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a648">PUDF_DRAGGINGFULLWINDOW</a>))
00322         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a586">WFSTARTPAINT</a>);
00323 
00324     <span class="comment">/*</span>
00325 <span class="comment">     * We're processing a WM_PAINT message: clear this flag.</span>
00326 <span class="comment">     */</span>
00327     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a573">WFPAINTNOTPROCESSED</a>);
00328 
00329     <span class="comment">/*</span>
00330 <span class="comment">     * If this bit gets set while we are drawing the frame we will need</span>
00331 <span class="comment">     * to redraw it.</span>
00332 <span class="comment">     *</span>
00333 <span class="comment">     * If necessary, send our WM_NCPAINT message now.</span>
00334 <span class="comment">     *</span>
00335 <span class="comment">     * please heed these notes</span>
00336 <span class="comment">     *</span>
00337 <span class="comment">     * We have to send this message BEFORE we diddle hwnd-&gt;hrgnUpdate,</span>
00338 <span class="comment">     * because an app may call ValidateRect or InvalidateRect in its</span>
00339 <span class="comment">     * handler, and it expects what it does to affect what gets drawn</span>
00340 <span class="comment">     * in the later WM_PAINT.</span>
00341 <span class="comment">     *</span>
00342 <span class="comment">     * It is possible to get an invalidate when we leave the critical</span>
00343 <span class="comment">     * section below, therefore we loop until UPDATEDIRTY is clear</span>
00344 <span class="comment">     * meaning there were no additional invalidates.</span>
00345 <span class="comment">     */</span>
00346     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a562">WFSENDNCPAINT</a>)) {
00347 
00348         <span class="keywordflow">do</span> {
00349             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a564">WFUPDATEDIRTY</a>);
00350             hrgnUpdate = <a class="code" href="../../d9/d2/paint_8c.html#a3">GetNCUpdateRgn</a>(pwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00351             <a class="code" href="../../d9/d2/paint_8c.html#a4">xxxSendNCPaint</a>(pwnd, hrgnUpdate);
00352             <a class="code" href="../../d4/d1/userk_8h.html#a1003">DeleteMaybeSpecialRgn</a>(hrgnUpdate);
00353         } <span class="keywordflow">while</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a564">WFUPDATEDIRTY</a>));
00354 
00355     } <span class="keywordflow">else</span> {
00356         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a564">WFUPDATEDIRTY</a>);
00357     }
00358 
00359     <span class="comment">/*</span>
00360 <span class="comment">     * Hide the caret if needed.  Do this before we get the DC so</span>
00361 <span class="comment">     * that if HideCaret() gets and releases a DC we will be able</span>
00362 <span class="comment">     * to reuse it later here.</span>
00363 <span class="comment">     * No need to DeferWinEventNotify() since pwnd is locked.</span>
00364 <span class="comment">     */</span>
00365     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;pq-&gt;caret.spwnd)
00366         <a class="code" href="../../d4/d5/caret_8c.html#a6">zzzInternalHideCaret</a>();
00367 
00368     <span class="comment">/*</span>
00369 <span class="comment">     * Send the check for sending an WM_ERASEBKGND to the</span>
00370 <span class="comment">     * window.</span>
00371 <span class="comment">     */</span>
00372     <span class="keywordflow">if</span> (fSendEraseBkgnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a560">WFSENDERASEBKGND</a>)) {
00373         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a561">WFERASEBKGND</a>);
00374         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a560">WFSENDERASEBKGND</a>);
00375     }
00376 
00377     <span class="comment">/*</span>
00378 <span class="comment">     * Validate the entire window.</span>
00379 <span class="comment">     */</span>
00380     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a501">NEEDSPAINT</a>(pwnd))
00381         <a class="code" href="../../d4/d1/userk_8h.html#a1470">DecPaintCount</a>(pwnd);
00382 
00383     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a563">WFINTERNALPAINT</a>);
00384 
00385     hrgnUpdate = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a>;
00386     pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00387 
00388     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a585">WFDONTVALIDATE</a>)) {
00389 
00390         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a9">ghrgnUpdateSave</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00391             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a9">ghrgnUpdateSave</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1162">CreateEmptyRgn</a>();
00392         }
00393 
00394         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a9">ghrgnUpdateSave</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00395             <a class="code" href="../../d4/d1/userk_8h.html#a230">UnionRgn</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a9">ghrgnUpdateSave</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a9">ghrgnUpdateSave</a>, hrgnUpdate);
00396             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a10">gnUpdateSave</a>++;
00397         }
00398     }
00399 
00400     <span class="comment">/*</span>
00401 <span class="comment">     * Clear these flags for backward compatibility</span>
00402 <span class="comment">     */</span>
00403     lpps-&gt;fIncUpdate =
00404     lpps-&gt;fRestore   = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00405 
00406     lpps-&gt;hdc =
00407     hdc       = <a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>(pwnd,
00408                          hrgnUpdate,
00409                          DCX_USESTYLE | DCX_INTERSECTRGN);
00410 
00411     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1233">UT_GetParentDCClipBox</a>(pwnd, hdc, &amp;lpps-&gt;rcPaint)) {
00412 
00413         <span class="comment">/*</span>
00414 <span class="comment">         * If necessary, erase our background, and possibly deal with</span>
00415 <span class="comment">         * our children's frames and backgrounds.</span>
00416 <span class="comment">         */</span>
00417         <span class="keywordflow">if</span> (fSendEraseBkgnd)
00418             <a class="code" href="../../d4/d1/userk_8h.html#a1467">xxxSendEraseBkgnd</a>(pwnd, hdc, hrgnUpdate);
00419     }
00420 
00421     <span class="comment">/*</span>
00422 <span class="comment">     * Now that we're completely erased, see if there are any children</span>
00423 <span class="comment">     * that couldn't draw their own frames because their update regions</span>
00424 <span class="comment">     * got deleted.</span>
00425 <span class="comment">     */</span>
00426     <a class="code" href="../../d9/d2/paint_8c.html#a5">xxxSendChildNCPaint</a>(pwnd);
00427 
00428     <span class="comment">/*</span>
00429 <span class="comment">     * The erase and frame operation has occured. Clear the WFREDRAWIFHUNG</span>
00430 <span class="comment">     * bit here. We don't want to clear it until we know the erase and</span>
00431 <span class="comment">     * frame has occured, so we know we always have a consistent looking</span>
00432 <span class="comment">     * window.</span>
00433 <span class="comment">     */</span>
00434     <a class="code" href="../../d4/d1/userk_8h.html#a1126">ClearHungFlag</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a578">WFREDRAWIFHUNG</a>);
00435 
00436     lpps-&gt;fErase = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a561">WFERASEBKGND</a>) != 0);
00437 
00438     <span class="keywordflow">return</span> hdc;
00439 }
00440 
00441 <span class="comment">/***************************************************************************\</span>
00442 <span class="comment">* xxxEndPaint (API)</span>
00443 <span class="comment">*</span>
00444 <span class="comment">*</span>
00445 <span class="comment">* History:</span>
00446 <span class="comment">* 16-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
00447 <span class="comment">\***************************************************************************/</span>
00448 
<a name="l00449"></a><a class="code" href="../../d9/d2/paint_8c.html#a7">00449</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1711">xxxEndPaint</a>(
00450     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>          pwnd,
00451     LPPAINTSTRUCT lpps)
00452 {
00453     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00454 
00455     <a class="code" href="../../d4/d1/userk_8h.html#a1698">ReleaseCacheDC</a>(lpps-&gt;hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00456 
00457     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a585">WFDONTVALIDATE</a>)) {
00458 
00459         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a9">ghrgnUpdateSave</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00460 
00461             <a class="code" href="../../d4/d1/userk_8h.html#a1992">InternalInvalidate3</a>(pwnd,
00462                                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a9">ghrgnUpdateSave</a>,
00463                                 RDW_INVALIDATE | RDW_ERASE);
00464 
00465             <span class="keywordflow">if</span> (--<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a10">gnUpdateSave</a> == 0) {
00466                 GreDeleteObject(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a9">ghrgnUpdateSave</a>);
00467                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a9">ghrgnUpdateSave</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00468             }
00469         }
00470 
00471         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a585">WFDONTVALIDATE</a>);
00472     }
00473 
00474     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a584">WFWMPAINTSENT</a>);
00475 
00476     <span class="comment">/*</span>
00477 <span class="comment">     * This used to check that the update-region was empty before</span>
00478 <span class="comment">     * doing the clear.  However, this caused a problem with WOW</span>
00479 <span class="comment">     * amipro/approach hanging.  They were invalidating rects in</span>
00480 <span class="comment">     * their WM_PAINT handler, and allowing the defwindowproc to</span>
00481 <span class="comment">     * perform the validation for them.  Since we were blocking</span>
00482 <span class="comment">     * the BeginPaint in this case, it sent them into a infinite</span>
00483 <span class="comment">     * loop (see bug 19036).</span>
00484 <span class="comment">     */</span>
00485     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a586">WFSTARTPAINT</a>);
00486 
00487     <span class="comment">/*</span>
00488 <span class="comment">     * Reshow the caret if needed, but AFTER we've released the DC.</span>
00489 <span class="comment">     * This way ShowCaret() can reuse the DC we just released.</span>
00490 <span class="comment">     */</span>
00491     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;pq-&gt;caret.spwnd)
00492         <a class="code" href="../../d4/d5/caret_8c.html#a5">zzzInternalShowCaret</a>();
00493 
00494     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00495 }
00496 
00497 <span class="comment">/***************************************************************************\</span>
00498 <span class="comment">* InternalDoPaint</span>
00499 <span class="comment">*</span>
00500 <span class="comment">* Return a window equal to or below pwnd, created by the current thread,</span>
00501 <span class="comment">* which needs painting.</span>
00502 <span class="comment">*</span>
00503 <span class="comment">* pwnd       - Window to start searching from. Search is depth first.</span>
00504 <span class="comment">* ptiCurrent - The current thread.</span>
00505 <span class="comment">*</span>
00506 <span class="comment">* History:</span>
00507 <span class="comment">* 16-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
00508 <span class="comment">\***************************************************************************/</span>
00509 
<a name="l00510"></a><a class="code" href="../../d9/d2/paint_8c.html#a8">00510</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d9/d2/paint_8c.html#a8">InternalDoPaint</a>(
00511     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwnd,
00512     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent)
00513 {
00514     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT;
00515 
00516     <span class="comment">/*</span>
00517 <span class="comment">     * Enumerate all windows, top-down, looking for one that</span>
00518 <span class="comment">     * needs repainting.  Skip windows of other tasks.</span>
00519 <span class="comment">     */</span>
00520     <span class="keywordflow">for</span> ( ; pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>) {
00521 
00522         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd) == ptiCurrent) {
00523 
00524             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a501">NEEDSPAINT</a>(pwnd)) {
00525 
00526                 <span class="comment">/*</span>
00527 <span class="comment">                 * If this window is transparent, we don't want to</span>
00528 <span class="comment">                 * send it a WM_PAINT until all its siblings below it</span>
00529 <span class="comment">                 * have been repainted.  If we find an unpainted sibling</span>
00530 <span class="comment">                 * below, return it instead.</span>
00531 <span class="comment">                 */</span>
00532                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a617">WEFTRANSPARENT</a>)) {
00533 
00534                     pwndT = pwnd;
00535                     <span class="keywordflow">while</span> ((pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00536 
00537                         <span class="comment">/*</span>
00538 <span class="comment">                         * Make sure sibling window belongs to same app</span>
00539 <span class="comment">                         */</span>
00540                         <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndT) == ptiCurrent) &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a501">NEEDSPAINT</a>(pwndT)) {
00541 
00542                             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a617">WEFTRANSPARENT</a>))
00543                                 <span class="keywordflow">continue</span>;
00544 
00545                             <span class="keywordflow">return</span> pwndT;
00546                         }
00547                     }
00548                 }
00549 
00550                 <span class="keywordflow">return</span> pwnd;
00551             }
00552         }
00553 
00554         <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a> &amp;&amp;
00555             (pwndT = <a class="code" href="../../d9/d2/paint_8c.html#a8">InternalDoPaint</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>, ptiCurrent))) {
00556 
00557             <span class="keywordflow">return</span> pwndT;
00558         }
00559     }
00560 
00561     <span class="keywordflow">return</span> pwnd;
00562 }
00563 
00564 <span class="comment">/***************************************************************************\</span>
00565 <span class="comment">* DoPaint</span>
00566 <span class="comment">*</span>
00567 <span class="comment">* Looks at all the desktops for the window needing a paint and places a</span>
00568 <span class="comment">* WM_PAINT in its queue.</span>
00569 <span class="comment">*</span>
00570 <span class="comment">* History:</span>
00571 <span class="comment">* 16-Jul-91 DarrinM     Ported from Win 3.1 sources.</span>
00572 <span class="comment">\***************************************************************************/</span>
00573 
<a name="l00574"></a><a class="code" href="../../d4/d1/userk_8h.html#a1218">00574</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1218">DoPaint</a>(
00575     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwndFilter,
00576     LPMSG lpMsg)
00577 {
00578     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwnd;
00579     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndT;
00580     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00581 
00582 
00583 <span class="preprocessor">#if 0 // CHRISWIL: WIN95 SPECIFIC</span>
00584 <span class="preprocessor"></span>
00585     <span class="comment">/*</span>
00586 <span class="comment">     * If there is a system modal up and it is attached to another task,</span>
00587 <span class="comment">     * DON'T do paints.  We don't want to return a message for a window in</span>
00588 <span class="comment">     * another task!</span>
00589 <span class="comment">     */</span>
00590     <span class="keywordflow">if</span> (hwndSysModal &amp;&amp; (hwndSysModal-&gt;hq != hqCurrent)) {
00591 
00592         <span class="comment">/*</span>
00593 <span class="comment">         * Poke this guy so he wakes up at some point in the future,</span>
00594 <span class="comment">         * otherwise he may never wake up to realize he should paint.</span>
00595 <span class="comment">         * Causes hangs - e.g. Photoshop installation program</span>
00596 <span class="comment">         *   PostThreadMessage32(Lpq(hqCurrent)-&gt;idThread, WM_NULL, 0, 0, 0);</span>
00597 <span class="comment">         */</span>
00598         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00599     }
00600 
00601 <span class="preprocessor">#endif</span>
00602 <span class="preprocessor"></span>
00603     <span class="comment">/*</span>
00604 <span class="comment">     * If this is a system thread, then walk the windowstation desktop-list</span>
00605 <span class="comment">     * to find the window which needs painting.  For other threads, we</span>
00606 <span class="comment">     * reference off the thread-desktop.</span>
00607 <span class="comment">     */</span>
00608     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a>) {
00609 
00610         <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
00611         <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>       pdesk;
00612 
00613         <span class="keywordflow">if</span> ((pwinsta = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o23">pwinsta</a>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00614             RIPMSG0(RIP_ERROR, <span class="stringliteral">"DoPaint: SYSTEMTHREAD does not have (pwinsta)"</span>);
00615             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00616         }
00617 
00618         pwnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00619         <span class="keywordflow">for</span>(pdesk = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a>; pdesk; pdesk = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o2">rpdeskNext</a>) {
00620 
00621             <span class="keywordflow">if</span> (pwnd = <a class="code" href="../../d9/d2/paint_8c.html#a8">InternalDoPaint</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>, ptiCurrent))
00622                 <span class="keywordflow">break</span>;
00623         }
00624 
00625     } <span class="keywordflow">else</span> {
00626         pwnd = <a class="code" href="../../d9/d2/paint_8c.html#a8">InternalDoPaint</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>,
00627                                ptiCurrent);
00628     }
00629 
00630     <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00631 
00632         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1220">CheckPwndFilter</a>(pwnd, pwndFilter))
00633             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00634 
00635         <span class="comment">/*</span>
00636 <span class="comment">         * We're returning a WM_PAINT message, so clear WFINTERNALPAINT so</span>
00637 <span class="comment">         * it won't get sent again later.</span>
00638 <span class="comment">         */</span>
00639         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a563">WFINTERNALPAINT</a>)) {
00640 
00641             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a563">WFINTERNALPAINT</a>);
00642 
00643             <span class="comment">/*</span>
00644 <span class="comment">             * If there is no update region, then no more paint for this</span>
00645 <span class="comment">             * window.</span>
00646 <span class="comment">             */</span>
00647             <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00648                 <a class="code" href="../../d4/d1/userk_8h.html#a1470">DecPaintCount</a>(pwnd);
00649         }
00650 
00651         <span class="comment">/*</span>
00652 <span class="comment">         * Set the STARTPAINT so that any other calls to BeginPaint while</span>
00653 <span class="comment">         * painting is begin performed, will prevent painting on those</span>
00654 <span class="comment">         * windows.</span>
00655 <span class="comment">         *</span>
00656 <span class="comment">         * Clear the UPDATEDIRTY since some apps (DBFast) don't call</span>
00657 <span class="comment">         * GetUpdateRect, BeginPaint/EndPaint.</span>
00658 <span class="comment">         */</span>
00659         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a586">WFSTARTPAINT</a>);
00660         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a564">WFUPDATEDIRTY</a>);
00661 
00662         <span class="comment">/*</span>
00663 <span class="comment">         * If we get an invalidate between now and the time the app calls</span>
00664 <span class="comment">         * BeginPaint() and the windows parent is not CLIPCHILDREN, then</span>
00665 <span class="comment">         * the parent will paint in the wrong order.  So we are going to</span>
00666 <span class="comment">         * cause the child to paint again.  Look in beginpaint and internal</span>
00667 <span class="comment">         * invalidate for other parts of this fix.</span>
00668 <span class="comment">         *</span>
00669 <span class="comment">         * Set a flag to signify that we are in the bad zone.</span>
00670 <span class="comment">         *</span>
00671 <span class="comment">         * Must go up the parent links to make sure all parents have</span>
00672 <span class="comment">         * WFCLIPCHILDREN set otherwise set the WFWMPAINTSENT flag.</span>
00673 <span class="comment">         * This is to fix Excel spreadsheet and fulldrag. The speadsheet</span>
00674 <span class="comment">         * parent window (class XLDESK) has WFCLIPCHILDREN set but it's</span>
00675 <span class="comment">         * parent (class XLMAIN) doesn't. So the main window erases  the</span>
00676 <span class="comment">         * background after the child window paints.</span>
00677 <span class="comment">         *</span>
00678 <span class="comment">         * JOHANNEC : 27-Jul-1994</span>
00679 <span class="comment">         */</span>
00680         
00681         <span class="comment">/*</span>
00682 <span class="comment">         * NT Bug 400167: As we walk up the tree, we need to stop short of</span>
00683 <span class="comment">         * desktop windows and mother desktop windows.  We can't do a test</span>
00684 <span class="comment">         * for WFCLIPCHILDREN on the mother desktop window's parent because</span>
00685 <span class="comment">         * it doesn't exist.  This means that no desktop window will get </span>
00686 <span class="comment">         * WFWMPAINTSENT set, but the message window will be able to get </span>
00687 <span class="comment">         * WFWMPAINTSENT set.</span>
00688 <span class="comment">         */</span>
00689         
00690         pwndT = pwnd;
00691         <span class="keywordflow">while</span> (pwndT &amp;&amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwndT) != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a196">FNID_DESKTOP</a>)) {
00692 
00693             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a649">WFCLIPCHILDREN</a>)) {
00694                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a584">WFWMPAINTSENT</a>);
00695                 <span class="keywordflow">break</span>;
00696             }
00697 
00698             pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
00699         }
00700 
00701         <span class="comment">/*</span>
00702 <span class="comment">         * If the top level "tiled" owner/parent of this window is iconed,</span>
00703 <span class="comment">         * send a WM_PAINTICON rather than a WM_PAINT.  The wParam</span>
00704 <span class="comment">         * is TRUE if this is the tiled window and FALSE if it is a</span>
00705 <span class="comment">         * child/owned popup of the minimized window.</span>
00706 <span class="comment">         *</span>
00707 <span class="comment">         * BACKWARD COMPATIBILITY HACK</span>
00708 <span class="comment">         *</span>
00709 <span class="comment">         * 3.0 sent WM_PAINTICON with wParam == TRUE for no apparent</span>
00710 <span class="comment">         * reason.  Lotus Notes 2.1 depends on this for some reason</span>
00711 <span class="comment">         * to properly change its icon when new mail arrives.</span>
00712 <span class="comment">         */</span>
00713         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>) &amp;&amp;
00714             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)    &amp;&amp;
00715             (pwnd-&gt;pcls-&gt;spicn != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00716 
00717             <a class="code" href="../../d4/d1/userk_8h.html#a1502">StoreMessage</a>(lpMsg, pwnd, WM_PAINTICON, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00718 
00719         } <span class="keywordflow">else</span> {
00720 
00721             <a class="code" href="../../d4/d1/userk_8h.html#a1502">StoreMessage</a>(lpMsg, pwnd, WM_PAINT, 0, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00722         }
00723 
00724         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00725     }
00726 
00727     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00728 }
00729 
00730 <span class="comment">/***************************************************************************\</span>
00731 <span class="comment">* xxxSimpleDoSyncPaint</span>
00732 <span class="comment">*</span>
00733 <span class="comment">* Process the sync-paint for this window.  This can send either a NCPAINT</span>
00734 <span class="comment">* or an ERASEBKGND.  This assumes no recursion and flags == 0.</span>
00735 <span class="comment">*</span>
00736 <span class="comment">* History:</span>
00737 <span class="comment">* 26-Oct-1993 MikeKe    Created</span>
00738 <span class="comment">\***************************************************************************/</span>
00739 
<a name="l00740"></a><a class="code" href="../../d4/d1/userk_8h.html#a1040">00740</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1040">xxxSimpleDoSyncPaint</a>(
00741     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00742 {
00743     HRGN  hrgnUpdate;
00744     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> flags = 0;
00745 
00746     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00747 
00748     <span class="comment">/*</span>
00749 <span class="comment">     * Since we're taking care of the frame drawing, we can consider</span>
00750 <span class="comment">     * this WM_PAINT message processed.</span>
00751 <span class="comment">     */</span>
00752     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a573">WFPAINTNOTPROCESSED</a>);
00753 
00754     <span class="comment">/*</span>
00755 <span class="comment">     * Make copies of these flags, because their state might</span>
00756 <span class="comment">     * change after we send a message, and we don't want</span>
00757 <span class="comment">     * to "lose" them.</span>
00758 <span class="comment">     */</span>
00759     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a562">WFSENDNCPAINT</a>))
00760         flags |= <a class="code" href="../../d4/d1/userk_8h.html#a494">DSP_FRAME</a>;
00761 
00762     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a560">WFSENDERASEBKGND</a>))
00763         flags |= <a class="code" href="../../d4/d1/userk_8h.html#a493">DSP_ERASE</a>;
00764 
00765     <span class="keywordflow">if</span> (flags &amp; (<a class="code" href="../../d4/d1/userk_8h.html#a493">DSP_ERASE</a> | <a class="code" href="../../d4/d1/userk_8h.html#a494">DSP_FRAME</a>)) {
00766 
00767         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) {
00768 
00769             <span class="comment">/*</span>
00770 <span class="comment">             * If there is no update region, just clear the bits.</span>
00771 <span class="comment">             */</span>
00772             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a562">WFSENDNCPAINT</a>);
00773             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a560">WFSENDERASEBKGND</a>);
00774             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a608">WFPIXIEHACK</a>);
00775             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a561">WFERASEBKGND</a>);
00776             <a class="code" href="../../d4/d1/userk_8h.html#a1126">ClearHungFlag</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a578">WFREDRAWIFHUNG</a>);
00777 
00778         } <span class="keywordflow">else</span> {
00779 
00780             <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00781 
00782             <span class="comment">/*</span>
00783 <span class="comment">             * If there is no update region, we don't have to</span>
00784 <span class="comment">             * do any erasing, but we may need to send an NCPAINT.</span>
00785 <span class="comment">             */</span>
00786             <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00787                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a560">WFSENDERASEBKGND</a>);
00788                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a561">WFERASEBKGND</a>);
00789                 flags &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a493">DSP_ERASE</a>;
00790             }
00791 
00792             <span class="comment">/*</span>
00793 <span class="comment">             * Only mess with windows owned by the current thread.</span>
00794 <span class="comment">             * NOTE: This means that WM_NCPAINT and WM_ERASEBKGND are</span>
00795 <span class="comment">             *       only sent intra-thread.</span>
00796 <span class="comment">             */</span>
00797             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd) == ptiCurrent) {
00798 
00799                 hrgnUpdate = <a class="code" href="../../d9/d2/paint_8c.html#a3">GetNCUpdateRgn</a>(pwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00800 
00801                 <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a494">DSP_FRAME</a>) {
00802 
00803                     <span class="comment">/*</span>
00804 <span class="comment">                     * If the message got sent before we got here then do</span>
00805 <span class="comment">                     * nothing.</span>
00806 <span class="comment">                     */</span>
00807                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a562">WFSENDNCPAINT</a>))
00808                         <a class="code" href="../../d9/d2/paint_8c.html#a4">xxxSendNCPaint</a>(pwnd, hrgnUpdate);
00809                 }
00810 
00811                 <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a493">DSP_ERASE</a>) {
00812 
00813                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a562">WFSENDNCPAINT</a>)) {
00814                         <span class="comment">/*</span>
00815 <span class="comment">                         * If we got another invalidate during the NCPAINT</span>
00816 <span class="comment">                         * callback get the new update region</span>
00817 <span class="comment">                         */</span>
00818                         <a class="code" href="../../d4/d1/userk_8h.html#a1003">DeleteMaybeSpecialRgn</a>(hrgnUpdate);
00819                         hrgnUpdate = <a class="code" href="../../d9/d2/paint_8c.html#a3">GetNCUpdateRgn</a>(pwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00820                     }
00821 
00822                     <span class="comment">/*</span>
00823 <span class="comment">                     * If the message got sent before we got here</span>
00824 <span class="comment">                     * (e.g.: an UpdateWindow() inside WM_NCPAINT handler,</span>
00825 <span class="comment">                     * for example), don't do anything.</span>
00826 <span class="comment">                     *</span>
00827 <span class="comment">                     * WINPROJ.EXE (version 1.0) calls UpdateWindow() in</span>
00828 <span class="comment">                     * the WM_NCPAINT handlers for its subclassed listboxes</span>
00829 <span class="comment">                     * in the open dialog.</span>
00830 <span class="comment">                     */</span>
00831                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a560">WFSENDERASEBKGND</a>)) {
00832                         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a560">WFSENDERASEBKGND</a>);
00833                         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a561">WFERASEBKGND</a>);
00834                         <a class="code" href="../../d4/d1/userk_8h.html#a1467">xxxSendEraseBkgnd</a>(pwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hrgnUpdate);
00835                     }
00836 
00837                     <span class="comment">/*</span>
00838 <span class="comment">                     * The erase and frame operation has occured. Clear the</span>
00839 <span class="comment">                     * WFREDRAWIFHUNG bit here. We don't want to clear it until we</span>
00840 <span class="comment">                     * know the erase and frame has occured, so we know we always</span>
00841 <span class="comment">                     * have a consistent looking window.</span>
00842 <span class="comment">                     */</span>
00843                     <a class="code" href="../../d4/d1/userk_8h.html#a1126">ClearHungFlag</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a578">WFREDRAWIFHUNG</a>);
00844                 }
00845 
00846                 <a class="code" href="../../d4/d1/userk_8h.html#a1003">DeleteMaybeSpecialRgn</a>(hrgnUpdate);
00847 
00848             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwnd)                         &amp;&amp;
00849                        (pwnd != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>) &amp;&amp;
00850                        <a class="code" href="../../d4/d1/userk_8h.html#a1650">FHungApp</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a912">CMSHUNGAPPTIMEOUT</a>)   &amp;&amp;
00851                        <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a578">WFREDRAWIFHUNG</a>)) {
00852 
00853                 <a class="code" href="../../d4/d1/userk_8h.html#a1126">ClearHungFlag</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a578">WFREDRAWIFHUNG</a>);
00854                 <a class="code" href="../../d4/d1/userk_8h.html#a1651">xxxRedrawHungWindow</a>(pwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00855             }
00856         }
00857     }
00858 }
00859 
00860 <span class="comment">/***************************************************************************\</span>
00861 <span class="comment">* xxxInternalDoSyncPaint</span>
00862 <span class="comment">*</span>
00863 <span class="comment">* Mostly the same functionality as the old xxxDoSyncPaint.</span>
00864 <span class="comment">*</span>
00865 <span class="comment">*</span>
00866 <span class="comment">* This function is called to erase the background of a window, and</span>
00867 <span class="comment">* possibly frame and erase the children too.</span>
00868 <span class="comment">*</span>
00869 <span class="comment">* WM_SYNCPAINT(wParam)/DoSyncPaint(flags) values:</span>
00870 <span class="comment">*</span>
00871 <span class="comment">* DSP_ERASE               - Erase background</span>
00872 <span class="comment">* DSP_FRAME               - Draw child frames</span>
00873 <span class="comment">* DSP_ENUMCLIPPEDCHILDREN - Recurse if children are clipped</span>
00874 <span class="comment">* DSP_NOCHECKPARENTS      - Don't check</span>
00875 <span class="comment">*</span>
00876 <span class="comment">*</span>
00877 <span class="comment">* Normally, only the DSP_ENUMCLIPPEDCHILDREN bit of flags is</span>
00878 <span class="comment">* significant on entry.  If DSP_WM_SYNCPAINT is set, then hrgnUpdate</span>
00879 <span class="comment">* and the rest of the flags bits are valid.</span>
00880 <span class="comment">*</span>
00881 <span class="comment">* History:</span>
00882 <span class="comment">* 16-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
00883 <span class="comment">\***************************************************************************/</span>
00884 
<a name="l00885"></a><a class="code" href="../../d4/d1/userk_8h.html#a1042">00885</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1042">xxxInternalDoSyncPaint</a>(
00886     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwnd,
00887     DWORD flags)
00888 {
00889     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00890 
00891     <span class="comment">/*</span>
00892 <span class="comment">     * Do the paint for this window.</span>
00893 <span class="comment">     */</span>
00894     <a class="code" href="../../d4/d1/userk_8h.html#a1040">xxxSimpleDoSyncPaint</a>(pwnd);
00895 
00896     <span class="comment">/*</span>
00897 <span class="comment">     * Normally we like to enumerate all of this window's children and have</span>
00898 <span class="comment">     * them erase their backgrounds synchronously.  However, this is a bad</span>
00899 <span class="comment">     * thing to do if the window is NOT CLIPCHLIDREN.  Here's the scenario</span>
00900 <span class="comment">     * we want to to avoid:</span>
00901 <span class="comment">     *</span>
00902 <span class="comment">     * 1) Window 'A' is invalidated</span>
00903 <span class="comment">     * 2) 'A' erases itself (or not, doesn't matter)</span>
00904 <span class="comment">     * 3) 'A's children are enumerated and they erase themselves.</span>
00905 <span class="comment">     * 4) 'A' paints over its children (remember, 'A' isn't CLIPCHILDREN)</span>
00906 <span class="comment">     * 5) 'A's children paint but their backgrounds aren't their ERASEBKND</span>
00907 <span class="comment">     *    color (because 'A' painted over them) and everything looks like</span>
00908 <span class="comment">     *    dirt.</span>
00909 <span class="comment">     */</span>
00910     <span class="keywordflow">if</span> ((flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a498">DSP_ALLCHILDREN</a>) ||
00911         ((flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a495">DSP_ENUMCLIPPEDCHILDREN</a>) &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a649">WFCLIPCHILDREN</a>))) {
00912 
00913         <a class="code" href="../../d5/d1/struct__TL.html">TL</a>   tlpwnd;
00914         <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> pbwl;
00915         HWND *phwnd;
00916 
00917         <span class="keywordflow">if</span> (pbwl = <a class="code" href="../../d4/d1/userk_8h.html#a1157">BuildHwndList</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>, <a class="code" href="../../d4/d1/userk_8h.html#a410">BWL_ENUMLIST</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00918 
00919             <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00920             HWND        hwnd;
00921 
00922             <span class="comment">/*</span>
00923 <span class="comment">             * If the client dies during a callback, the hwnd list</span>
00924 <span class="comment">             * will be freed in xxxDestroyThreadInfo.</span>
00925 <span class="comment">             */</span>
00926             <span class="keywordflow">for</span> (phwnd = pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o4">rghwnd</a>; (hwnd = *phwnd) != (HWND)1; phwnd++) {
00927 
00928                 <span class="keywordflow">if</span> (hwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00929                     <span class="keywordflow">continue</span>;
00930 
00931                 <span class="keywordflow">if</span> ((pwnd = (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)<a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00932                     <span class="keywordflow">continue</span>;
00933 
00934                 <span class="comment">/*</span>
00935 <span class="comment">                 * Note: testing if a window is a child automatically</span>
00936 <span class="comment">                 * excludes the desktop window.</span>
00937 <span class="comment">                 */</span>
00938                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a654">WFCHILD</a>) &amp;&amp; (ptiCurrent != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd))) {
00939 
00940                     <span class="comment">/*</span>
00941 <span class="comment">                     * Don't cause any more intertask sendmessages cause it</span>
00942 <span class="comment">                     * does bad things to cbt's windowproc hooks.  (Due to</span>
00943 <span class="comment">                     * SetParent allowing child windows in the topwindow</span>
00944 <span class="comment">                     * hierarchy.</span>
00945 <span class="comment">                     */</span>
00946                     <span class="keywordflow">continue</span>;
00947                 }
00948 
00949                 <span class="comment">/*</span>
00950 <span class="comment">                 * Note that we pass only certain bits down as we recurse:</span>
00951 <span class="comment">                 * the other bits pertain to the current window only.</span>
00952 <span class="comment">                 */</span>
00953                 <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwnd, &amp;tlpwnd);
00954                 <a class="code" href="../../d4/d1/userk_8h.html#a1042">xxxInternalDoSyncPaint</a>(pwnd, flags);
00955                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
00956             }
00957 
00958             <a class="code" href="../../d4/d1/userk_8h.html#a1158">FreeHwndList</a>(pbwl);
00959         }
00960     }
00961 }
00962 
00963 <span class="comment">/***************************************************************************\</span>
00964 <span class="comment">* DoQueuedSyncPaint</span>
00965 <span class="comment">*</span>
00966 <span class="comment">* Queues WM_SYNCPAINT messages for top level windows not of the specified</span>
00967 <span class="comment">* thread.</span>
00968 <span class="comment">*</span>
00969 <span class="comment">* History:</span>
00970 <span class="comment">\***************************************************************************/</span>
00971 
<a name="l00972"></a><a class="code" href="../../d9/d2/paint_8c.html#a12">00972</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d2/paint_8c.html#a12">DoQueuedSyncPaint</a>(
00973     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwnd,
00974     DWORD       flags,
00975     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti)
00976 {
00977     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiPwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd);
00978 
00979     <span class="keywordflow">if</span> ((ptiPwnd != pti)          &amp;&amp;
00980         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a562">WFSENDNCPAINT</a>)    &amp;&amp;
00981         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a560">WFSENDERASEBKGND</a>) &amp;&amp;
00982         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) {
00983 
00984         <a class="code" href="../../d4/d1/userk_8h.html#a871">PSMS</a> psms = ptiPwnd-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o13">psmsReceiveList</a>;
00985 
00986         <span class="comment">/*</span>
00987 <span class="comment">         * If this window already has a WM_SYNCPAINT queue'd up, then there's</span>
00988 <span class="comment">         * no need to send another one.  Also protects our heap from getting</span>
00989 <span class="comment">         * chewed up.</span>
00990 <span class="comment">         */</span>
00991         <span class="keywordflow">while</span> (psms != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00992 
00993             <span class="keywordflow">if</span> ((psms-&gt;message == WM_SYNCPAINT) &amp;&amp; (psms-&gt;spwnd == pwnd)) {
00994                 <span class="keywordflow">break</span>;
00995             }
00996 
00997             psms = psms-&gt;psmsReceiveNext;
00998         }
00999 
01000         <span class="keywordflow">if</span> (psms == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01001             <span class="comment">/*</span>
01002 <span class="comment">             * This will give this message the semantics of a notify</span>
01003 <span class="comment">             * message (sendmessage no wait), without calling back</span>
01004 <span class="comment">             * the WH_CALLWNDPROC hook. We don't want to do that</span>
01005 <span class="comment">             * because that'll let all these processes with invalid</span>
01006 <span class="comment">             * windows to process paint messages before they process</span>
01007 <span class="comment">             * "synchronous" erasing or framing needs.</span>
01008 <span class="comment">             *</span>
01009 <span class="comment">             * Hi word of wParam must be zero or wow will drop it</span>
01010 <span class="comment">             *</span>
01011 <span class="comment">             * LATER mikeke</span>
01012 <span class="comment">             * Do we need to send down the flags with DWP_ERASE and DSP_FRAME</span>
01013 <span class="comment">             * in it?</span>
01014 <span class="comment">             */</span>
01015             UserAssert(HIWORD(flags) == 0);
01016             <a class="code" href="../../d4/d1/userk_8h.html#a1582">QueueNotifyMessage</a>(pwnd, WM_SYNCPAINT, flags, 0);
01017 
01018             <span class="comment">/*</span>
01019 <span class="comment">             * Set our syncpaint-pending flag, since we queued one up.  This</span>
01020 <span class="comment">             * will be used to check when we validate-parents for windows</span>
01021 <span class="comment">             * without clipchildren.</span>
01022 <span class="comment">             */</span>
01023             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a574">WFSYNCPAINTPENDING</a>);
01024         }
01025 
01026         <span class="comment">/*</span>
01027 <span class="comment">         * If we posted a WM_SYNCPAINT for a top-level window that is not</span>
01028 <span class="comment">         * of the current thread we're done; we'll pick up the children</span>
01029 <span class="comment">         * when we process the message for real.  If we're the desktop</span>
01030 <span class="comment">         * however make sure we get all it children.</span>
01031 <span class="comment">         */</span>
01032         <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd))
01033             <span class="keywordflow">return</span>;
01034     }
01035 
01036     <span class="comment">/*</span>
01037 <span class="comment">     * Normally we like to enumerate all of this window's children and have</span>
01038 <span class="comment">     * them erase their backgrounds synchronously.  However, this is a bad</span>
01039 <span class="comment">     * thing to do if the window is NOT CLIPCHLIDREN.  Here's the scenario</span>
01040 <span class="comment">     * we want to to avoid:</span>
01041 <span class="comment">     *</span>
01042 <span class="comment">     * 1.  Window 'A' is invalidated</span>
01043 <span class="comment">     * 2.  'A' erases itself (or not, doesn't matter)</span>
01044 <span class="comment">     * 3.  'A's children are enumerated and they erase themselves.</span>
01045 <span class="comment">     * 4.  'A' paints over its children (remember, 'A' isn't CLIPCHILDREN)</span>
01046 <span class="comment">     * 5.  'A's children paint but their backgrounds aren't their ERASEBKND</span>
01047 <span class="comment">     *    color (because 'A' painted over them) and everything looks like</span>
01048 <span class="comment">     *    dirt.</span>
01049 <span class="comment">     */</span>
01050     <span class="keywordflow">if</span> ((flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a498">DSP_ALLCHILDREN</a>) ||
01051         ((flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a495">DSP_ENUMCLIPPEDCHILDREN</a>) &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a649">WFCLIPCHILDREN</a>))) {
01052 
01053         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT;
01054 
01055         <span class="keywordflow">for</span> (pwndT = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>; pwndT; pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>) {
01056 
01057             <span class="comment">/*</span>
01058 <span class="comment">             * Don't cause any more intertask sendmessages cause it does</span>
01059 <span class="comment">             * bad things to cbt's windowproc hooks.  (Due to SetParent</span>
01060 <span class="comment">             * allowing child windows in the topwindow hierarchy.</span>
01061 <span class="comment">             * The child bit also catches the desktop window; we want to</span>
01062 <span class="comment">             */</span>
01063             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a654">WFCHILD</a>) &amp;&amp; (pti != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndT)))
01064                 <span class="keywordflow">continue</span>;
01065 
01066             <span class="comment">/*</span>
01067 <span class="comment">             * Note that we pass only certain bits down as we recurse:</span>
01068 <span class="comment">             * the other bits pertain to the current window only.</span>
01069 <span class="comment">             */</span>
01070             <a class="code" href="../../d9/d2/paint_8c.html#a12">DoQueuedSyncPaint</a>(pwndT, flags, pti);
01071         }
01072     }
01073 }
01074 
01075 <span class="comment">/***************************************************************************\</span>
01076 <span class="comment">* xxxDoSyncPaint</span>
01077 <span class="comment">*</span>
01078 <span class="comment">* This funstion is only called for the initial syncpaint so we always</span>
01079 <span class="comment">* queue syncpaints to other threads in this funtion.</span>
01080 <span class="comment">*</span>
01081 <span class="comment">* History:</span>
01082 <span class="comment">\***************************************************************************/</span>
01083 
<a name="l01084"></a><a class="code" href="../../d4/d1/userk_8h.html#a1041">01084</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1041">xxxDoSyncPaint</a>(
01085     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwnd,
01086     DWORD flags)
01087 {
01088     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
01089 
01090     <span class="comment">/*</span>
01091 <span class="comment">     * If any of our non-clipchildren parents have an update region, don't</span>
01092 <span class="comment">     * do anything.  This way we won't redraw our background or frame out</span>
01093 <span class="comment">     * of order, only to have it get obliterated when our parent erases his</span>
01094 <span class="comment">     * background.</span>
01095 <span class="comment">     */</span>
01096     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1124">ParentNeedsPaint</a>(pwnd))
01097         <span class="keywordflow">return</span>;
01098 
01099     <span class="comment">/*</span>
01100 <span class="comment">     * First of all if we are going to be queueing any WM_SYNCPAINT messages</span>
01101 <span class="comment">     * to windows of another thread do it first while the window's update</span>
01102 <span class="comment">     * regions are still in sync.  This way there is no chance the update</span>
01103 <span class="comment">     * region will be incorrect (through window movement during callbacks of</span>
01104 <span class="comment">     * the WM_ERASEBKGND|WM_NCPAINT messages).</span>
01105 <span class="comment">     */</span>
01106     <a class="code" href="../../d9/d2/paint_8c.html#a12">DoQueuedSyncPaint</a>(pwnd, flags, <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
01107     <a class="code" href="../../d4/d1/userk_8h.html#a1042">xxxInternalDoSyncPaint</a>(pwnd, flags);
01108 }
01109 
01110 <span class="comment">/***************************************************************************\</span>
01111 <span class="comment">* ParentNeedsPaint</span>
01112 <span class="comment">*</span>
01113 <span class="comment">* Return a non-zero PWND if a non-CLIPCHILDREN parent requires a WM_PAINT</span>
01114 <span class="comment">* message.</span>
01115 <span class="comment">*</span>
01116 <span class="comment">* History:</span>
01117 <span class="comment">* 16-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
01118 <span class="comment">\***************************************************************************/</span>
01119 
<a name="l01120"></a><a class="code" href="../../d4/d1/userk_8h.html#a1124">01120</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d4/d1/userk_8h.html#a1124">ParentNeedsPaint</a>(
01121     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
01122 {
01123     <span class="keywordflow">while</span> ((pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01124 
01125         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a649">WFCLIPCHILDREN</a>))
01126             <span class="keywordflow">break</span>;
01127 
01128         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a501">NEEDSPAINT</a>(pwnd))
01129             <span class="keywordflow">return</span> pwnd;
01130     }
01131 
01132     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01133 }
01134 
01135 <span class="comment">/***************************************************************************\</span>
01136 <span class="comment">* xxxSendEraseBkgnd</span>
01137 <span class="comment">*</span>
01138 <span class="comment">* Sends a WM_ERASEBKGROUND event to the window.  This contains the paintDC</span>
01139 <span class="comment">* with the update-region selected into it.  If there's no update region</span>
01140 <span class="comment">* then we prevent this event from making it to the window.</span>
01141 <span class="comment">*</span>
01142 <span class="comment">* History:</span>
01143 <span class="comment">* 16-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
01144 <span class="comment">* 15-Dec-1996 ChrisWil  Merged Chicago Functionality (no erase on min).</span>
01145 <span class="comment">\***************************************************************************/</span>
01146 
<a name="l01147"></a><a class="code" href="../../d4/d1/userk_8h.html#a1467">01147</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1467">xxxSendEraseBkgnd</a>(
01148     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
01149     HDC  hdcBeginPaint,
01150     HRGN hrgnUpdate)
01151 {
01152     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
01153     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fErased;
01154     HDC         hdc;
01155 
01156     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
01157 
01158     <span class="comment">/*</span>
01159 <span class="comment">     * For minimized dudes in win3.1, we would've sent an</span>
01160 <span class="comment">     * WM_ICONERASEBKGND and cleared the erase bit.  Now that min</span>
01161 <span class="comment">     * windows in 4.0 are all nonclient, don't bother erasing at</span>
01162 <span class="comment">     * all.  Pretend like we did.</span>
01163 <span class="comment">     *</span>
01164 <span class="comment">     * NOTE:</span>
01165 <span class="comment">     * For &lt; 4.0 windows, we may have to send a fake WM_ICONERASEKBGND</span>
01166 <span class="comment">     * to keep 'em happy.  Saves time not to though.  Getting a DC and</span>
01167 <span class="comment">     * sending the message ain't speedy.</span>
01168 <span class="comment">     */</span>
01169     <span class="keywordflow">if</span> ((hrgnUpdate == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>))
01170         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01171 
01172     <span class="comment">/*</span>
01173 <span class="comment">     * If a DC to use was not passed in, get one.</span>
01174 <span class="comment">     * We want one clipped to this window's update region.</span>
01175 <span class="comment">     */</span>
01176     <span class="keywordflow">if</span> (hdcBeginPaint == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01177 
01178        hdc = <a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>(pwnd,
01179                       hrgnUpdate,
01180                       DCX_USESTYLE | DCX_INTERSECTRGN | DCX_NODELETERGN);
01181     } <span class="keywordflow">else</span> {
01182 
01183         hdc = hdcBeginPaint;
01184     }
01185 
01186     <span class="comment">/*</span>
01187 <span class="comment">     * If we're send the WM_ERASEBKGND to another process</span>
01188 <span class="comment">     * we need to change the DC owner.</span>
01189 <span class="comment">     *</span>
01190 <span class="comment">     * We'd like to change the owner to pwnd-&gt;pti-&gt;idProcess, but</span>
01191 <span class="comment">     * GDI won't let us assign ownership back to ourselves later.</span>
01192 <span class="comment">     */</span>
01193     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01194 
01195     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;ppi != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>)
01196         GreSetDCOwner(hdc, OBJECT_OWNER_PUBLIC);
01197 
01198     <span class="comment">/*</span>
01199 <span class="comment">     * Send the event to the window.  This contains the DC clipped to</span>
01200 <span class="comment">     * the update-region.</span>
01201 <span class="comment">     */</span>
01202     fErased = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_ERASEBKGND, (WPARAM)hdc, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01203 
01204     <span class="comment">/*</span>
01205 <span class="comment">     * If we've changed the DC owner, change it back to</span>
01206 <span class="comment">     * the current process.</span>
01207 <span class="comment">     */</span>
01208     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;ppi != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>)
01209         GreSetDCOwner(hdc, OBJECT_OWNER_CURRENT);
01210 
01211     <span class="comment">/*</span>
01212 <span class="comment">     * If the WM_ERASEBKGND message did not erase the</span>
01213 <span class="comment">     * background, then set this flag to let BeginPaint()</span>
01214 <span class="comment">     * know to ask the caller to do it via the fErase</span>
01215 <span class="comment">     * flag in the PAINTSTRUCT.</span>
01216 <span class="comment">     */</span>
01217     <span class="keywordflow">if</span> (!fErased) {
01218         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a561">WFERASEBKGND</a>);
01219         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a592">WFWIN31COMPAT</a>))
01220             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a560">WFSENDERASEBKGND</a>);
01221     }
01222 
01223     <span class="comment">/*</span>
01224 <span class="comment">     * If we got a cache DC in this routine, release it.</span>
01225 <span class="comment">     */</span>
01226     <span class="keywordflow">if</span> (hdcBeginPaint == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01227         <a class="code" href="../../d4/d1/userk_8h.html#a1698">ReleaseCacheDC</a>(hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01228     }
01229 
01230     <span class="keywordflow">return</span> fErased;
01231 }
01232 
01233 <span class="comment">/***************************************************************************\</span>
01234 <span class="comment">* IncPaintCount</span>
01235 <span class="comment">*</span>
01236 <span class="comment">* EFFECTS:</span>
01237 <span class="comment">* If cPaintsReady changes from 0 to 1, the QS_PAINT bit is set for</span>
01238 <span class="comment">* associated queue and we wake up task so repaint will occur.</span>
01239 <span class="comment">*</span>
01240 <span class="comment">* IMPLEMENTATION:</span>
01241 <span class="comment">* Get the queue handle from the window handle, bump the paint count, and</span>
01242 <span class="comment">* if paint count is one, Set the wakebit.</span>
01243 <span class="comment">*</span>
01244 <span class="comment">* History:</span>
01245 <span class="comment">* 17-Jul-1991 DarrinM   Translated Win 3.1 ASM code.</span>
01246 <span class="comment">\***************************************************************************/</span>
01247 
<a name="l01248"></a><a class="code" href="../../d4/d1/userk_8h.html#a1469">01248</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1469">IncPaintCount</a>(
01249     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
01250 {
01251     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd);
01252 
01253     <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o19">cPaintsReady</a>++ == 0)
01254         <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(pti, QS_PAINT);
01255 }
01256 
01257 <span class="comment">/***************************************************************************\</span>
01258 <span class="comment">* DecPaintCount</span>
01259 <span class="comment">*</span>
01260 <span class="comment">* EFFECTS:</span>
01261 <span class="comment">* If cPaintsReady changes from 1 to 0, the QS_PAINT bit is cleared so</span>
01262 <span class="comment">* that no more paints will occur.</span>
01263 <span class="comment">*</span>
01264 <span class="comment">* IMPLEMENTATION:</span>
01265 <span class="comment">* Get the queue handle from the window handle, decrement the paint count,</span>
01266 <span class="comment">* and if paint count is zero, clear the wakebit.</span>
01267 <span class="comment">*</span>
01268 <span class="comment">* History:</span>
01269 <span class="comment">* 17-Jul-1991 DarrinM   Translated Win 3.1 ASM code.</span>
01270 <span class="comment">\***************************************************************************/</span>
01271 
<a name="l01272"></a><a class="code" href="../../d4/d1/userk_8h.html#a1470">01272</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1470">DecPaintCount</a>(
01273     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
01274 {
01275     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd);
01276 
01277     <span class="keywordflow">if</span> (--pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o19">cPaintsReady</a> == 0) {
01278         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a>   &amp;= ~QS_PAINT;
01279         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o1">fsChangeBits</a> &amp;= ~QS_PAINT;
01280     }
01281 }
01282 
01283 <span class="comment">/***************************************************************************\</span>
01284 <span class="comment">* UT_GetParentDCClipBox</span>
01285 <span class="comment">*</span>
01286 <span class="comment">* Return rectangle coordinates of the parent clip-rect.  If the window</span>
01287 <span class="comment">* isn't using a parentDC for drawing then return normal clipbox.</span>
01288 <span class="comment">*</span>
01289 <span class="comment">* History:</span>
01290 <span class="comment">* 31-Oct-1990 DarrinM   Ported from Win 3.0 sources.</span>
01291 <span class="comment">\***************************************************************************/</span>
01292 
<a name="l01293"></a><a class="code" href="../../d4/d1/userk_8h.html#a1233">01293</a> <span class="keywordtype">int</span> <a class="code" href="../../d4/d1/userk_8h.html#a1233">UT_GetParentDCClipBox</a>(
01294     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>   pwnd,
01295     HDC    hdc,
01296     LPRECT lprc)
01297 {
01298     RECT rc;
01299 
01300     <span class="keywordflow">if</span> (GreGetClipBox(hdc, lprc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) == NULLREGION)
01301         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01302 
01303     <span class="keywordflow">if</span> ((pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a476">CFPARENTDC</a>))
01304         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01305 
01306     <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a12">GetRect</a>(pwnd, &amp;rc, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a902">GRECT_CLIENT</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a905">GRECT_CLIENTCOORDS</a>);
01307 
01308     <span class="keywordflow">return</span> <a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(lprc, lprc, &amp;rc);
01309 }
01310 
01311 <span class="comment">/***************************************************************************\</span>
01312 <span class="comment">* UserRedrawDesktop</span>
01313 <span class="comment">*</span>
01314 <span class="comment">* Redraw the desktop and its children.  This is called from GDI for DCI</span>
01315 <span class="comment">* related unlocks, so that all visrgns are recalculated for the apps.</span>
01316 <span class="comment">*</span>
01317 <span class="comment">* History:</span>
01318 <span class="comment">* 08-Jan-1996 ChrisWil  Created.</span>
01319 <span class="comment">\***************************************************************************/</span>
01320 
<a name="l01321"></a><a class="code" href="../../d9/d2/paint_8c.html#a19">01321</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d2/paint_8c.html#a19">UserRedrawDesktop</a>(VOID)
01322 {
01323     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>   tlpwnd;
01324     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndDesk;
01325 
01326     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
01327 
01328     pwndDesk = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;rpdesk-&gt;pDeskInfo-&gt;spwnd;
01329 
01330     <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwndDesk, &amp;tlpwnd);
01331 
01332     <a class="code" href="../../d4/d1/userk_8h.html#a1681">xxxInternalInvalidate</a>(pwndDesk,
01333                           <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>,
01334                           RDW_INVALIDATE |
01335                               RDW_ERASE  |
01336                               RDW_FRAME  |
01337                               RDW_ALLCHILDREN);
01338 
01339     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
01340 
01341     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01342 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:08 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
