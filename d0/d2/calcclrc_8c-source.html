<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: calcclrc.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>calcclrc.c</h1><a href="../../d9/d2/calcclrc_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: calcclrc.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* History:</span>
00007 <span class="comment">* 10-22-90 MikeHar      Ported functions from Win 3.0 sources.</span>
00008 <span class="comment">* 01-Feb-1991 mikeke    Added Revalidation code</span>
00009 <span class="comment">\***************************************************************************/</span>
00010 
00011 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00012 <span class="preprocessor">#pragma hdrstop</span>
00013 <span class="preprocessor"></span>
00014 
00015 <span class="comment">/****************************** Module Header ******************************\</span>
00016 <span class="comment">* xxxCalcClientRect</span>
00017 <span class="comment">*</span>
00018 <span class="comment">* 10-22-90 MikeHar      Ported functions from Win 3.0 sources.</span>
00019 <span class="comment">\****************************** Module Header ******************************/</span>
00020 
<a name="l00021"></a><a class="code" href="../../d4/d1/userk_8h.html#a1531">00021</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1531">xxxCalcClientRect</a>(
00022     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00023     LPRECT lprc,
00024     BOOL fHungRedraw)
00025 {
00026     <span class="keywordtype">int</span> cxFrame, yTopOld;
00027     RECT rcTemp;
00028     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu;
00029     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpmenu;
00030     <span class="keywordtype">int</span>     cBorders;
00031     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fEmptyClient;
00032     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>    bFramePresent;
00033 
00034     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00035     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
00036 
00037     bFramePresent = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a554">WFFRAMEPRESENTMASK</a>);
00038 
00039     <span class="comment">/*</span>
00040 <span class="comment">     * Clear all the frame bits.  NOTE: The HIBYTE of all these #defines</span>
00041 <span class="comment">     * must stay the same for this line to work.</span>
00042 <span class="comment">     */</span>
00043     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a554">WFFRAMEPRESENTMASK</a>);
00044 
00045     <span class="comment">//</span>
00046     <span class="comment">// We need to clear the client border bits also. Otherwise, when the</span>
00047     <span class="comment">// window gets really small, the client border will draw over the menu</span>
00048     <span class="comment">// and caption.</span>
00049     <span class="comment">//</span>
00050     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a588">WFCEPRESENT</a>);
00051 
00052     <span class="comment">/*</span>
00053 <span class="comment">     * If the window is iconic, the client area is empty.</span>
00054 <span class="comment">     */</span>
00055     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)) {
00056         <span class="comment">//  SetRectEmpty(lprc);</span>
00057       <span class="comment">// We must make it an empty rectangle.</span>
00058       <span class="comment">// But, that empty rectangle should be at the top left corner of the</span>
00059       <span class="comment">// window rect. Else, ScreenToClient() will return bad values.</span>
00060         lprc-&gt;right = lprc-&gt;left;
00061         lprc-&gt;bottom = lprc-&gt;top;
00062         <span class="keywordflow">goto</span> CalcClientDone;
00063     }
00064 
00065     <span class="comment">// Save rect into rcTemp for easy local calculations.</span>
00066     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcTemp, lprc);
00067 
00068     <span class="comment">// Save the top so we'll know how tall the caption was</span>
00069     yTopOld = rcTemp.top;
00070 
00071     <span class="comment">// Adjustment for the caption</span>
00072     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a645">WFBORDERMASK</a>) == <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a646">WFCAPTION</a>))
00073     {
00074         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a553">WFCPRESENT</a>);
00075 
00076         rcTemp.top += <a class="code" href="../../d4/d1/userk_8h.html#a2017">GetCaptionHeight</a>(pwnd);
00077     }
00078 
00079     <span class="comment">// Subtract out window borders</span>
00080     cBorders = <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a7">GetWindowBorders</a>(pwnd-&gt;style, pwnd-&gt;ExStyle, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00081     cxFrame = cBorders * SYSMETFROMPROCESS(CXBORDER);
00082     <a class="code" href="../../d3/d6/rect_8c.html#a7">InflateRect</a>(&amp;rcTemp, -cxFrame, -cBorders * SYSMETFROMPROCESS(CYBORDER));
00083 
00084     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwnd) &amp;&amp; (pMenu = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>)) {
00085         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a550">WFMPRESENT</a>);
00086         <span class="keywordflow">if</span> (!fHungRedraw) {
00087             <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pMenu, &amp;tlpmenu);
00088             rcTemp.top += <a class="code" href="../../d4/d1/userk_8h.html#a1396">xxxMenuBarCompute</a>(pMenu, pwnd, rcTemp.top - yTopOld,
00089                     cxFrame, rcTemp.right - rcTemp.left);
00090             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpmenu);
00091         }
00092     }
00093     <span class="comment">/*</span>
00094 <span class="comment">     * We should have cleared WFMPRESENT in the else case here. Win9x doesn't do</span>
00095 <span class="comment">     *  it either. Any code checking this flag will do the wrong thing...</span>
00096 <span class="comment">     * It seems that it's pretty unsual for apps to remove the menu....</span>
00097 <span class="comment">     * No code checking this flag can assume that pwnd-&gt;spmenu is not NULL -- we</span>
00098 <span class="comment">     *  would need to clear it way earlier (at unlock time) for such assumption to hold true.</span>
00099 <span class="comment">     */</span>
00100 
00101     <span class="comment">//</span>
00102     <span class="comment">// Fix for B#1425 -- Sizing window really small used to move children's</span>
00103     <span class="comment">// rects because the client calculations were wrong.  So we make the</span>
00104     <span class="comment">// bottom of the client match up with the top (the bottom of the menu</span>
00105     <span class="comment">// bar).</span>
00106     <span class="comment">//</span>
00107     fEmptyClient = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00108 
00109     <span class="keywordflow">if</span> (rcTemp.top &gt;= rcTemp.bottom) {
00110         rcTemp.bottom = rcTemp.top;
00111         fEmptyClient = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00112     }
00113 
00114     <span class="comment">//</span>
00115     <span class="comment">// BOGUS BOGUS BOGUS</span>
00116     <span class="comment">// Hack for Central Point PC Tools.</span>
00117     <span class="comment">// Possibly for M5 only.</span>
00118     <span class="comment">// B#8445</span>
00119     <span class="comment">//</span>
00120     <span class="comment">// They check for div-by-zero all over, but they jump to the wrong place</span>
00121     <span class="comment">// if a zero divisor is encountered, and end up faulting anyway.  So this</span>
00122     <span class="comment">// code path was never tested basically.  There's a period when starting</span>
00123     <span class="comment">// up where the window rect of their drives ribbon is empty.  In Win3.x,</span>
00124     <span class="comment">// the client would be shrunk to account for the border it had, and it</span>
00125     <span class="comment">// would look like it wasn't empty because the width would be negative,</span>
00126     <span class="comment">// signed!  So we version-switch this code, since other apps have</span>
00127     <span class="comment">// reported the non-emptiness as an annoying bug.</span>
00128     <span class="comment">//</span>
00129     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>) &amp;&amp; (rcTemp.left &gt;= rcTemp.right)) {
00130         rcTemp.right = rcTemp.left;
00131         fEmptyClient = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00132     }
00133 
00134     <span class="keywordflow">if</span> (fEmptyClient)
00135         <span class="keywordflow">goto</span> ClientCalcEnd;
00136 
00137     <span class="comment">//</span>
00138     <span class="comment">// Subtract client edge if we have space</span>
00139     <span class="comment">//</span>
00140     <span class="keywordflow">if</span> (    <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a621">WEFCLIENTEDGE</a>) &amp;&amp;
00141             (rcTemp.right - rcTemp.left &gt;= (2 * SYSMETFROMPROCESS(CXEDGE))) &amp;&amp;
00142             (rcTemp.bottom - rcTemp.top &gt;= (2 * SYSMETFROMPROCESS(CYEDGE))) ) {
00143         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a588">WFCEPRESENT</a>);
00144         <a class="code" href="../../d3/d6/rect_8c.html#a7">InflateRect</a>(&amp;rcTemp, -SYSMETFROMPROCESS(CXEDGE), -SYSMETFROMPROCESS(CYEDGE));
00145     }
00146 
00147     <span class="comment">//</span>
00148     <span class="comment">// Subtract scrollbars</span>
00149     <span class="comment">// Note compatibility with 3.1:</span>
00150     <span class="comment">//      * You don't get a horizontal scrollbar unless you have MORE</span>
00151     <span class="comment">//  space (&gt; ) in your client than you need for one.</span>
00152     <span class="comment">//      * You get a vertical scrollbar if you have AT LEAST ENOUGH</span>
00153     <span class="comment">//  space (&gt;=) in your client for one.</span>
00154     <span class="comment">//</span>
00155     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a640">WFHSCROLL</a>) &amp;&amp; (rcTemp.bottom - rcTemp.top &gt; SYSMETFROMPROCESS(CYHSCROLL))) {
00156         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a552">WFHPRESENT</a>);
00157         <span class="keywordflow">if</span> (!fHungRedraw) {
00158             rcTemp.bottom -= SYSMETFROMPROCESS(CYHSCROLL);
00159         }
00160     }
00161 
00162     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a641">WFVSCROLL</a>) &amp;&amp; (rcTemp.right - rcTemp.left &gt;= SYSMETFROMPROCESS(CXVSCROLL))) {
00163         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a551">WFVPRESENT</a>);
00164         <span class="keywordflow">if</span> (!fHungRedraw) {
00165 <span class="preprocessor">#ifdef USE_MIRRORING</span>
00166 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((!!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a626">WEFLEFTSCROLL</a>)) ^ (!!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WEFLAYOUTRTL)))
00167 <span class="preprocessor">#else</span>
00168 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a626">WEFLEFTSCROLL</a>))
00169 <span class="preprocessor">#endif</span>
00170 <span class="preprocessor"></span>                rcTemp.left += SYSMETFROMPROCESS(CXVSCROLL);
00171             <span class="keywordflow">else</span>
00172                 rcTemp.right -= SYSMETFROMPROCESS(CXVSCROLL);
00173         }
00174     }
00175 
00176 ClientCalcEnd:
00177 
00178     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(lprc, &amp;rcTemp);
00179 
00180 CalcClientDone:
00181     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>() &amp;&amp; (bFramePresent != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a554">WFFRAMEPRESENTMASK</a>))) {
00182         <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(EVENT_OBJECT_REORDER, pwnd, OBJID_WINDOW, 0, <a class="code" href="../../d4/d1/userk_8h.html#a610">WEF_USEPWNDTHREAD</a>);
00183     }
00184 }
00185 
00186 <span class="comment">/***************************************************************************\</span>
00187 <span class="comment">*</span>
00188 <span class="comment">*  UpdateClientRect()</span>
00189 <span class="comment">*</span>
00190 <span class="comment">*  Make sure the client rect reflects the window styles correctly</span>
00191 <span class="comment">*</span>
00192 <span class="comment">\***************************************************************************/</span>
00193 
<a name="l00194"></a><a class="code" href="../../d4/d1/userk_8h.html#a1532">00194</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1532">xxxUpdateClientRect</a>(
00195     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00196 {
00197     RECT rc;
00198 
00199     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rc, &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>);
00200     <a class="code" href="../../d4/d1/userk_8h.html#a1531">xxxCalcClientRect</a>(pwnd, &amp;rc, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00201     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>, &amp;rc);
00202 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:19 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
