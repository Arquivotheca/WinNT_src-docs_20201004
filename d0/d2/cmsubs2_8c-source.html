<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmsubs2.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmsubs2.c</h1><a href="../../d9/d2/cmsubs2_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    cmsubs2.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module various support routines for the configuration manager.</span>
00012 <span class="comment"></span>
00013 <span class="comment">    The routines in this module are independent enough to be linked into</span>
00014 <span class="comment">    any other program.  The routines in cmsubs.c are not.</span>
00015 <span class="comment"></span>
00016 <span class="comment">Author:</span>
00017 <span class="comment"></span>
00018 <span class="comment">    Bryan M. Willman (bryanwi) 12-Sep-1991</span>
00019 <span class="comment"></span>
00020 <span class="comment">Revision History:</span>
00021 <span class="comment"></span>
00022 <span class="comment">--*/</span>
00023 
00024 <span class="preprocessor">#include    "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00025 
00026 PUCHAR
00027 <a class="code" href="../../d9/d2/cmsubs2_8c.html#a2">CmpGetValueDataFromCache</a>(
00028     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>  Hive,
00029     IN <a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PPCM_CACHED_VALUE</a> ContainingList,
00030     IN <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> ValueKey,
00031     IN BOOLEAN    ValueCached
00032 );
00033 
00034 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpGetValueDataFromCache)</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpFreeValue)</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpQueryKeyData)</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpQueryKeyValueData)</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00040 <span class="preprocessor"></span>
00041 <span class="comment">//</span>
00042 <span class="comment">// Define alignment macro.</span>
00043 <span class="comment">//</span>
00044 
<a name="l00045"></a><a class="code" href="../../d9/d2/cmsubs2_8c.html#a0">00045</a> <span class="preprocessor">#define ALIGN_OFFSET(Offset) (ULONG) \</span>
00046 <span class="preprocessor">        ((((ULONG)(Offset) + sizeof(ULONG)-1)) &amp; (~(sizeof(ULONG) - 1)))</span>
00047 <span class="preprocessor"></span>
<a name="l00048"></a><a class="code" href="../../d9/d2/cmsubs2_8c.html#a1">00048</a> <span class="preprocessor">#define ALIGN_OFFSET64(Offset) (ULONG) \</span>
00049 <span class="preprocessor">        ((((ULONG)(Offset) + sizeof(ULONGLONG)-1)) &amp; (~(sizeof(ULONGLONG) - 1)))</span>
00050 <span class="preprocessor"></span>
00051 
00052 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00053"></a><a class="code" href="../../d9/d2/cmsubs2_8c.html#a3">00053</a> <a class="code" href="../../d9/d2/cmsubs2_8c.html#a3">CmpFreeValue</a>(
00054     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00055     HCELL_INDEX Cell
00056     )
00057 <span class="comment">/*++</span>
00058 <span class="comment"></span>
00059 <span class="comment">Routine Description:</span>
00060 <span class="comment"></span>
00061 <span class="comment">    Free the value entry Hive.Cell refers to, including</span>
00062 <span class="comment">    its name and data cells.</span>
00063 <span class="comment"></span>
00064 <span class="comment">Arguments:</span>
00065 <span class="comment"></span>
00066 <span class="comment">    Hive - supplies a pointer to the hive control structure for the hive</span>
00067 <span class="comment"></span>
00068 <span class="comment">    Cell - supplies index of value to delete</span>
00069 <span class="comment"></span>
00070 <span class="comment">Return Value:</span>
00071 <span class="comment"></span>
00072 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
00073 <span class="comment"></span>
00074 <span class="comment">        &lt;TBS&gt;</span>
00075 <span class="comment"></span>
00076 <span class="comment">--*/</span>
00077 {
00078     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> value;
00079     ULONG       realsize;
00080     BOOLEAN     small;
00081 
00082     <span class="comment">//</span>
00083     <span class="comment">// map in the cell</span>
00084     <span class="comment">//</span>
00085     value = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00086 
00087     <span class="comment">//</span>
00088     <span class="comment">// free data if present</span>
00089     <span class="comment">//</span>
00090     small = <a class="code" href="../../d9/d0/cmdata_8h.html#a38">CmpIsHKeyValueSmall</a>(realsize, value-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a>);
00091     <span class="keywordflow">if</span> ((! small) &amp;&amp; (realsize &gt; 0))
00092     {
00093         <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, value-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>);
00094     }
00095 
00096     <span class="comment">//</span>
00097     <span class="comment">// free the cell itself</span>
00098     <span class="comment">//</span>
00099     <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00100 
00101     <span class="keywordflow">return</span>;
00102 }
00103 
00104 
00105 <span class="comment">//</span>
00106 <span class="comment">// Data transfer workers</span>
00107 <span class="comment">//</span>
00108 
00109 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00110"></a><a class="code" href="../../d9/d2/cmsubs2_8c.html#a4">00110</a> <a class="code" href="../../d9/d2/cmsubs2_8c.html#a4">CmpQueryKeyData</a>(
00111     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00112     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node,
00113     KEY_INFORMATION_CLASS KeyInformationClass,
00114     PVOID KeyInformation,
00115     ULONG Length,
00116     PULONG ResultLength
00117     )
00118 <span class="comment">/*++</span>
00119 <span class="comment"></span>
00120 <span class="comment">Routine Description:</span>
00121 <span class="comment"></span>
00122 <span class="comment">    Do the actual copy of data for a key into caller's buffer.</span>
00123 <span class="comment"></span>
00124 <span class="comment">    If KeyInformation is not long enough to hold all requested data,</span>
00125 <span class="comment">    STATUS_BUFFER_OVERFLOW will be returned, and ResultLength will be</span>
00126 <span class="comment">    set to the number of bytes actually required.</span>
00127 <span class="comment"></span>
00128 <span class="comment">Arguments:</span>
00129 <span class="comment"></span>
00130 <span class="comment">    Hive - supplies a pointer to the hive control structure for the hive</span>
00131 <span class="comment"></span>
00132 <span class="comment">    Node - Supplies pointer to node whose subkeys are to be found</span>
00133 <span class="comment"></span>
00134 <span class="comment">    KeyInformationClass - Specifies the type of information returned in</span>
00135 <span class="comment">        Buffer.  One of the following types:</span>
00136 <span class="comment"></span>
00137 <span class="comment">        KeyBasicInformation - return last write time, title index, and name.</span>
00138 <span class="comment">            (see KEY_BASIC_INFORMATION structure)</span>
00139 <span class="comment"></span>
00140 <span class="comment">        KeyNodeInformation - return last write time, title index, name, class.</span>
00141 <span class="comment">            (see KEY_NODE_INFORMATION structure)</span>
00142 <span class="comment"></span>
00143 <span class="comment">    KeyInformation -Supplies pointer to buffer to receive the data.</span>
00144 <span class="comment"></span>
00145 <span class="comment">    Length - Length of KeyInformation in bytes.</span>
00146 <span class="comment"></span>
00147 <span class="comment">    ResultLength - Number of bytes actually written into KeyInformation.</span>
00148 <span class="comment"></span>
00149 <span class="comment">Return Value:</span>
00150 <span class="comment"></span>
00151 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
00152 <span class="comment"></span>
00153 <span class="comment">        &lt;TBS&gt;</span>
00154 <span class="comment"></span>
00155 <span class="comment">--*/</span>
00156 {
00157     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00158     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  pclass;
00159     ULONG       requiredlength;
00160     LONG        leftlength;
00161     ULONG       offset;
00162     ULONG       minimumlength;
00163     <a class="code" href="../../d5/d6/union__KEY__INFORMATION.html">PKEY_INFORMATION</a> pbuffer;
00164     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>      NameLength;
00165 
00166     pbuffer = (<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html">PKEY_INFORMATION</a>)KeyInformation;
00167     NameLength = <a class="code" href="../../d1/d2/cmp_8h.html#a96">CmpHKeyNameLen</a>(Node);
00168 
00169     <span class="keywordflow">switch</span> (KeyInformationClass) {
00170 
00171     <span class="keywordflow">case</span> KeyBasicInformation:
00172 
00173         <span class="comment">//</span>
00174         <span class="comment">// LastWriteTime, TitleIndex, NameLength, Name</span>
00175 
00176         requiredlength = FIELD_OFFSET(KEY_BASIC_INFORMATION, <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>) +
00177                          NameLength;
00178 
00179         minimumlength = FIELD_OFFSET(KEY_BASIC_INFORMATION, <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00180 
00181         *ResultLength = requiredlength;
00182 
00183         status = STATUS_SUCCESS;
00184 
00185         <span class="keywordflow">if</span> (Length &lt; minimumlength) {
00186 
00187             status = STATUS_BUFFER_TOO_SMALL;
00188 
00189         } <span class="keywordflow">else</span> {
00190 
00191             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o0">KeyBasicInformation</a>.LastWriteTime =
00192                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a>;
00193 
00194             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o0">KeyBasicInformation</a>.TitleIndex = 0;
00195 
00196             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o0">KeyBasicInformation</a>.NameLength =
00197                 NameLength;
00198 
00199             leftlength = Length - minimumlength;
00200 
00201             requiredlength = NameLength;
00202 
00203             <span class="keywordflow">if</span> (leftlength &lt; (LONG)requiredlength) {
00204                 requiredlength = leftlength;
00205                 status = STATUS_BUFFER_OVERFLOW;
00206             }
00207 
00208             <span class="keywordflow">if</span> (Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>) {
00209                 <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o0">KeyBasicInformation</a>.Name,
00210                                       leftlength,
00211                                       Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
00212                                       Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
00213             } <span class="keywordflow">else</span> {
00214                 RtlCopyMemory(
00215                     &amp;(pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o0">KeyBasicInformation</a>.Name[0]),
00216                     &amp;(Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>[0]),
00217                     requiredlength
00218                     );
00219             }
00220         }
00221 
00222         <span class="keywordflow">break</span>;
00223 
00224 
00225     <span class="keywordflow">case</span> KeyNodeInformation:
00226 
00227         <span class="comment">//</span>
00228         <span class="comment">// LastWriteTime, TitleIndex, ClassOffset, ClassLength</span>
00229         <span class="comment">// NameLength, Name, Class</span>
00230         <span class="comment">//</span>
00231         requiredlength = FIELD_OFFSET(KEY_NODE_INFORMATION, <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>) +
00232                          NameLength +
00233                          Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a>;
00234 
00235         minimumlength = FIELD_OFFSET(KEY_NODE_INFORMATION, <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00236 
00237         *ResultLength = requiredlength;
00238 
00239         status = STATUS_SUCCESS;
00240 
00241         <span class="keywordflow">if</span> (Length &lt; minimumlength) {
00242 
00243             status = STATUS_BUFFER_TOO_SMALL;
00244 
00245         } <span class="keywordflow">else</span> {
00246 
00247             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o1">KeyNodeInformation</a>.LastWriteTime =
00248                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a>;
00249 
00250             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o1">KeyNodeInformation</a>.TitleIndex = 0;
00251 
00252             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o1">KeyNodeInformation</a>.ClassLength =
00253                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a>;
00254 
00255             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o1">KeyNodeInformation</a>.NameLength =
00256                 NameLength;
00257 
00258             leftlength = Length - minimumlength;
00259             requiredlength = NameLength;
00260 
00261             <span class="keywordflow">if</span> (leftlength &lt; (LONG)requiredlength) {
00262                 requiredlength = leftlength;
00263                 status = STATUS_BUFFER_OVERFLOW;
00264             }
00265 
00266             <span class="keywordflow">if</span> (Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>) {
00267                 <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o1">KeyNodeInformation</a>.Name,
00268                                       leftlength,
00269                                       Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
00270                                       Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
00271             } <span class="keywordflow">else</span> {
00272                 RtlCopyMemory(
00273                     &amp;(pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o1">KeyNodeInformation</a>.Name[0]),
00274                     &amp;(Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>[0]),
00275                     requiredlength
00276                     );
00277             }
00278 
00279             <span class="keywordflow">if</span> (Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a> &gt; 0) {
00280 
00281                 offset = FIELD_OFFSET(KEY_NODE_INFORMATION, <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>) +
00282                             NameLength;
00283                 offset = <a class="code" href="../../d9/d2/cmsubs2_8c.html#a0">ALIGN_OFFSET</a>(offset);
00284 
00285                 pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o1">KeyNodeInformation</a>.ClassOffset = offset;
00286 
00287                 pclass = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o10">Class</a>);
00288 
00289                 pbuffer = (<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html">PKEY_INFORMATION</a>)((PUCHAR)pbuffer + offset);
00290 
00291                 leftlength = (((LONG)Length - (LONG)offset) &lt; 0) ?
00292                                     0 :
00293                                     Length - offset;
00294 
00295                 requiredlength = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a>;
00296 
00297                 <span class="keywordflow">if</span> (leftlength &lt; (LONG)requiredlength) {
00298                     requiredlength = leftlength;
00299                     status = STATUS_BUFFER_OVERFLOW;
00300                 }
00301 
00302                 RtlMoveMemory(
00303                     pbuffer,
00304                     pclass,
00305                     requiredlength
00306                     );
00307 
00308             } <span class="keywordflow">else</span> {
00309                 pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o1">KeyNodeInformation</a>.ClassOffset = (ULONG)-1;
00310             }
00311         }
00312 
00313         <span class="keywordflow">break</span>;
00314 
00315 
00316     <span class="keywordflow">case</span> KeyFullInformation:
00317 
00318         <span class="comment">//</span>
00319         <span class="comment">// LastWriteTime, TitleIndex, ClassOffset, ClassLength,</span>
00320         <span class="comment">// SubKeys, MaxNameLen, MaxClassLen, Values, MaxValueNameLen,</span>
00321         <span class="comment">// MaxValueDataLen, Class</span>
00322         <span class="comment">//</span>
00323         requiredlength = FIELD_OFFSET(KEY_FULL_INFORMATION, Class) +
00324                          Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a>;
00325 
00326         minimumlength = FIELD_OFFSET(KEY_FULL_INFORMATION, Class);
00327 
00328         *ResultLength = requiredlength;
00329 
00330         status = STATUS_SUCCESS;
00331 
00332         <span class="keywordflow">if</span> (Length &lt; minimumlength) {
00333 
00334             status = STATUS_BUFFER_TOO_SMALL;
00335 
00336         } <span class="keywordflow">else</span> {
00337 
00338             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.LastWriteTime =
00339                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a>;
00340 
00341             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.TitleIndex = 0;
00342 
00343             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.ClassLength =
00344                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a>;
00345 
00346             <span class="keywordflow">if</span> (Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a> &gt; 0) {
00347 
00348                 pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.ClassOffset =
00349                         FIELD_OFFSET(KEY_FULL_INFORMATION, Class);
00350 
00351                 pclass = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o10">Class</a>);
00352 
00353                 leftlength = Length - minimumlength;
00354                 requiredlength = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a>;
00355 
00356                 <span class="keywordflow">if</span> (leftlength &lt; (LONG)requiredlength) {
00357                     requiredlength = leftlength;
00358                     status = STATUS_BUFFER_OVERFLOW;
00359                 }
00360 
00361                 RtlMoveMemory(
00362                     &amp;(pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.Class[0]),
00363                     pclass,
00364                     requiredlength
00365                     );
00366 
00367             } <span class="keywordflow">else</span> {
00368                 pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.ClassOffset = (ULONG)-1;
00369             }
00370 
00371             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.SubKeys =
00372                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] +
00373                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>];
00374 
00375             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.Values =
00376                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a>;
00377 
00378             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.MaxNameLen =
00379                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o11">MaxNameLen</a>;
00380 
00381             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.MaxClassLen =
00382                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o12">MaxClassLen</a>;
00383 
00384             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.MaxValueNameLen =
00385                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o13">MaxValueNameLen</a>;
00386 
00387             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.MaxValueDataLen =
00388                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o14">MaxValueDataLen</a>;
00389 
00390         }
00391 
00392         <span class="keywordflow">break</span>;
00393 
00394 
00395     <span class="keywordflow">default</span>:
00396         status = STATUS_INVALID_PARAMETER;
00397         <span class="keywordflow">break</span>;
00398     }
00399     <span class="keywordflow">return</span> status;
00400 }
00401 
00402 PUCHAR
<a name="l00403"></a><a class="code" href="../../d9/d2/cmsubs2_8c.html#a2">00403</a> <a class="code" href="../../d9/d2/cmsubs2_8c.html#a2">CmpGetValueDataFromCache</a>(
00404     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>  Hive,
00405     IN <a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PPCM_CACHED_VALUE</a> ContainingList,
00406     IN <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> ValueKey,
00407     IN BOOLEAN    ValueCached
00408 )
00409 <span class="comment">/*++</span>
00410 <span class="comment"></span>
00411 <span class="comment">Routine Description:</span>
00412 <span class="comment"></span>
00413 <span class="comment">    Get the cached Value Data given a value node.</span>
00414 <span class="comment"></span>
00415 <span class="comment">Arguments:</span>
00416 <span class="comment"></span>
00417 <span class="comment">    Hive - pointer to hive control structure for hive of interest</span>
00418 <span class="comment"></span>
00419 <span class="comment">    ContainingList - Address that stores the allocation address of the value node.</span>
00420 <span class="comment">                     We need to update this when we do a re-allocate to cache</span>
00421 <span class="comment">                     both value key and value data.</span>
00422 <span class="comment"></span>
00423 <span class="comment">    ValueKey - pointer to the Value Key</span>
00424 <span class="comment"></span>
00425 <span class="comment">    ValueCached - Indicating whether Value key is cached or not.</span>
00426 <span class="comment"></span>
00427 <span class="comment">Return Value:</span>
00428 <span class="comment"></span>
00429 <span class="comment">    Pointer to the Valve Index.</span>
00430 <span class="comment">--*/</span>
00431 {
00432     <span class="comment">//</span>
00433     <span class="comment">// Cache the data if needed.</span>
00434     <span class="comment">//</span>
00435     <a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PCM_CACHED_VALUE</a> OldEntry;
00436     <a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PCM_CACHED_VALUE</a> NewEntry;
00437     PUCHAR      datapointer;
00438     PUCHAR      Cacheddatapointer;
00439     ULONG       AllocSize;
00440     ULONG       CopySize;
00441     ULONG       DataSize;
00442 
00443     <span class="keywordflow">if</span> (ValueCached) {
00444         OldEntry = (<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PCM_CACHED_VALUE</a>) <a class="code" href="../../d9/d0/cmdata_8h.html#a46">CMP_GET_CACHED_ADDRESS</a>(*ContainingList);
00445         <span class="keywordflow">if</span> (OldEntry-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o0">DataCacheType</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a41">CM_CACHE_DATA_CACHED</a>) {
00446             <span class="comment">//</span>
00447             <span class="comment">// Data is already cached, use it.</span>
00448             <span class="comment">//</span>
00449             datapointer = (PUCHAR) ((ULONG_PTR) ValueKey + OldEntry-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o1">ValueKeySize</a>);
00450         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (OldEntry-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o0">DataCacheType</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a42">CM_CACHE_DATA_TOO_BIG</a>) {
00451             <span class="comment">//</span>
00452             <span class="comment">// Data is too big to warrent caching, get it from the registry.</span>
00453             <span class="comment">//</span>
00454             datapointer = (PUCHAR)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ValueKey-&gt;u.KeyValue.Data);
00455         } <span class="keywordflow">else</span> {
00456             <span class="comment">//</span>
00457             <span class="comment">// consistency check</span>
00458             <span class="comment">//</span>
00459             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OldEntry-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o0">DataCacheType</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a40">CM_CACHE_DATA_NOT_CACHED</a>);
00460 
00461             <span class="comment">//</span>
00462             <span class="comment">// Value data is not cached.</span>
00463             <span class="comment">// Check the size of value data, if it is smaller than MAXIMUM_CACHED_DATA, cache it.</span>
00464             <span class="comment">//</span>
00465             datapointer = (PUCHAR)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ValueKey-&gt;u.KeyValue.Data);
00466             DataSize = (ULONG) <a class="code" href="../../d8/d0/hivecell_8c.html#a15">HvGetCellSize</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, datapointer);
00467             <span class="keywordflow">if</span> (DataSize &lt;= <a class="code" href="../../d9/d0/cmdata_8h.html#a43">MAXIMUM_CACHED_DATA</a>) {
00468                 <span class="comment">//</span>
00469                 <span class="comment">// Data is not cached and now we are going to do it.</span>
00470                 <span class="comment">// Reallocate a new cached entry for both value key and value data.</span>
00471                 <span class="comment">//</span>
00472                 CopySize = DataSize + OldEntry-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o1">ValueKeySize</a>;
00473                 AllocSize = CopySize + FIELD_OFFSET(<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html">CM_CACHED_VALUE</a>, KeyValue);
00474 
00475                 <span class="comment">// Dragos: Changed to catch the memory violator</span>
00476                 <span class="comment">// it didn't work</span>
00477                 <span class="comment">//NewEntry = (PCM_CACHED_VALUE) ExAllocatePoolWithTagPriority(PagedPool, AllocSize, CM_CACHE_VALUE_DATA_TAG,NormalPoolPrioritySpecialPoolUnderrun);</span>
00478                 NewEntry = (<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PCM_CACHED_VALUE</a>) <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, AllocSize, CM_CACHE_VALUE_DATA_TAG);
00479 
00480                 <span class="keywordflow">if</span> (NewEntry) {
00481                     <span class="comment">//</span>
00482                     <span class="comment">// Now fill the data to the new cached entry</span>
00483                     <span class="comment">//</span>
00484                     NewEntry-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o0">DataCacheType</a> = <a class="code" href="../../d9/d0/cmdata_8h.html#a41">CM_CACHE_DATA_CACHED</a>;
00485                     NewEntry-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o1">ValueKeySize</a> = OldEntry-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o1">ValueKeySize</a>;
00486 
00487                     RtlCopyMemory((PVOID)&amp;(NewEntry-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o2">KeyValue</a>),
00488                                   (PVOID)&amp;(OldEntry-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o2">KeyValue</a>),
00489                                   NewEntry-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o1">ValueKeySize</a>);
00490 
00491                     Cacheddatapointer = (PUCHAR) ((ULONG_PTR) &amp;(NewEntry-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o2">KeyValue</a>) + OldEntry-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o1">ValueKeySize</a>);
00492                     RtlCopyMemory(Cacheddatapointer, datapointer, DataSize);
00493 
00494                     <span class="comment">// Trying to catch the BAD guy who writes over our pool.</span>
00495                     <a class="code" href="../../d1/d2/cmp_8h.html#a8">CmpMakeSpecialPoolReadWrite</a>( OldEntry );
00496 
00497                     *ContainingList = (<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PCM_CACHED_VALUE</a>) <a class="code" href="../../d9/d0/cmdata_8h.html#a50">CMP_MARK_CELL_CACHED</a>(NewEntry);
00498 
00499                     <span class="comment">// Trying to catch the BAD guy who writes over our pool.</span>
00500                     <a class="code" href="../../d1/d2/cmp_8h.html#a7">CmpMakeSpecialPoolReadOnly</a>( NewEntry );
00501 
00502                     <span class="comment">//</span>
00503                     <span class="comment">// Free the old entry</span>
00504                     <span class="comment">//</span>
00505 
00506                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(OldEntry);
00507                 }
00508             } <span class="keywordflow">else</span> {
00509                 <span class="comment">// Trying to catch the BAD guy who writes over our pool.</span>
00510                 <a class="code" href="../../d1/d2/cmp_8h.html#a8">CmpMakeSpecialPoolReadWrite</a>( OldEntry );
00511 
00512                 <span class="comment">//</span>
00513                 <span class="comment">// Mark the type and do not cache it.</span>
00514                 <span class="comment">//</span>
00515                 OldEntry-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o0">DataCacheType</a> = <a class="code" href="../../d9/d0/cmdata_8h.html#a42">CM_CACHE_DATA_TOO_BIG</a>;
00516 
00517                 <span class="comment">// Trying to catch the BAD guy who writes over our pool.</span>
00518                 <a class="code" href="../../d1/d2/cmp_8h.html#a7">CmpMakeSpecialPoolReadOnly</a>( OldEntry );
00519             }
00520         }
00521     } <span class="keywordflow">else</span> {
00522         datapointer = (PUCHAR)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ValueKey-&gt;u.KeyValue.Data);
00523     }
00524 
00525     <span class="keywordflow">return</span> (datapointer);
00526 }
00527 
00528 
00529 
00530 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00531"></a><a class="code" href="../../d9/d2/cmsubs2_8c.html#a5">00531</a> <a class="code" href="../../d9/d2/cmsubs2_8c.html#a5">CmpQueryKeyValueData</a>(
00532     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00533     <a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PPCM_CACHED_VALUE</a> ContainingList,
00534     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> ValueKey,
00535     BOOLEAN     ValueCached,
00536     KEY_VALUE_INFORMATION_CLASS KeyValueInformationClass,
00537     PVOID KeyValueInformation,
00538     ULONG Length,
00539     PULONG ResultLength
00540     )
00541 <span class="comment">/*++</span>
00542 <span class="comment"></span>
00543 <span class="comment">Routine Description:</span>
00544 <span class="comment"></span>
00545 <span class="comment">    Do the actual copy of data for a key value into caller's buffer.</span>
00546 <span class="comment"></span>
00547 <span class="comment">    If KeyValueInformation is not long enough to hold all requested data,</span>
00548 <span class="comment">    STATUS_BUFFER_OVERFLOW will be returned, and ResultLength will be</span>
00549 <span class="comment">    set to the number of bytes actually required.</span>
00550 <span class="comment"></span>
00551 <span class="comment">Arguments:</span>
00552 <span class="comment"></span>
00553 <span class="comment">    Hive - supplies a pointer to the hive control structure for the hive</span>
00554 <span class="comment"></span>
00555 <span class="comment">    Cell - supplies index of node to whose sub keys are to be found</span>
00556 <span class="comment"></span>
00557 <span class="comment">    KeyValueInformationClass - Specifies the type of information returned in</span>
00558 <span class="comment">        KeyValueInformation.  One of the following types:</span>
00559 <span class="comment"></span>
00560 <span class="comment">    KeyValueInformation -Supplies pointer to buffer to receive the data.</span>
00561 <span class="comment"></span>
00562 <span class="comment">    Length - Length of KeyInformation in bytes.</span>
00563 <span class="comment"></span>
00564 <span class="comment">    ResultLength - Number of bytes actually written into KeyInformation.</span>
00565 <span class="comment"></span>
00566 <span class="comment">Return Value:</span>
00567 <span class="comment"></span>
00568 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
00569 <span class="comment"></span>
00570 <span class="comment">        &lt;TBS&gt;</span>
00571 <span class="comment"></span>
00572 <span class="comment">--*/</span>
00573 {
00574     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00575     <a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html">PKEY_VALUE_INFORMATION</a> pbuffer;
00576     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  pcell;
00577     LONG        leftlength;
00578     ULONG       requiredlength;
00579     ULONG       minimumlength;
00580     ULONG       offset;
00581     ULONG       base;
00582     ULONG       realsize;
00583     PUCHAR      datapointer;
00584     BOOLEAN     small;
00585     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>      NameLength;
00586 
00587     pbuffer = (<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html">PKEY_VALUE_INFORMATION</a>)KeyValueInformation;
00588 
00589     pcell = (<a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>) ValueKey;
00590     NameLength = <a class="code" href="../../d1/d2/cmp_8h.html#a99">CmpValueNameLen</a>(&amp;pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>);
00591 
00592     <span class="keywordflow">switch</span> (KeyValueInformationClass) {
00593 
00594     <span class="keywordflow">case</span> KeyValueBasicInformation:
00595 
00596         <span class="comment">//</span>
00597         <span class="comment">// TitleIndex, Type, NameLength, Name</span>
00598         <span class="comment">//</span>
00599         requiredlength = FIELD_OFFSET(KEY_VALUE_BASIC_INFORMATION, <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>) +
00600                          NameLength;
00601 
00602         minimumlength = FIELD_OFFSET(KEY_VALUE_BASIC_INFORMATION, <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00603 
00604         *ResultLength = requiredlength;
00605 
00606         status = STATUS_SUCCESS;
00607 
00608         <span class="keywordflow">if</span> (Length &lt; minimumlength) {
00609 
00610             status = STATUS_BUFFER_TOO_SMALL;
00611 
00612         } <span class="keywordflow">else</span> {
00613 
00614             pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o0">KeyValueBasicInformation</a>.TitleIndex = 0;
00615 
00616             pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o0">KeyValueBasicInformation</a>.Type =
00617                 pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a>;
00618 
00619             pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o0">KeyValueBasicInformation</a>.NameLength =
00620                 NameLength;
00621 
00622             leftlength = Length - minimumlength;
00623             requiredlength = NameLength;
00624 
00625             <span class="keywordflow">if</span> (leftlength &lt; (LONG)requiredlength) {
00626                 requiredlength = leftlength;
00627                 status = STATUS_BUFFER_OVERFLOW;
00628             }
00629 
00630             <span class="keywordflow">if</span> (pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o5">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a37">VALUE_COMP_NAME</a>) {
00631                 <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o0">KeyValueBasicInformation</a>.Name,
00632                                       requiredlength,
00633                                       pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o7">Name</a>,
00634                                       pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o1">NameLength</a>);
00635             } <span class="keywordflow">else</span> {
00636                 RtlCopyMemory(&amp;(pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o0">KeyValueBasicInformation</a>.Name[0]),
00637                               &amp;(pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o7">Name</a>[0]),
00638                               requiredlength);
00639             }
00640         }
00641 
00642         <span class="keywordflow">break</span>;
00643 
00644 
00645 
00646     <span class="keywordflow">case</span> KeyValueFullInformation:
00647     <span class="keywordflow">case</span> KeyValueFullInformationAlign64:
00648 
00649         <span class="comment">//</span>
00650         <span class="comment">// TitleIndex, Type, DataOffset, DataLength, NameLength,</span>
00651         <span class="comment">// Name, Data</span>
00652         <span class="comment">//</span>
00653         small = <a class="code" href="../../d9/d0/cmdata_8h.html#a38">CmpIsHKeyValueSmall</a>(realsize, pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a>);
00654 
00655         requiredlength = FIELD_OFFSET(KEY_VALUE_FULL_INFORMATION, <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>) +
00656                          NameLength +
00657                          realsize;
00658 
00659         minimumlength = FIELD_OFFSET(KEY_VALUE_FULL_INFORMATION, <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00660         <span class="keywordflow">if</span> (realsize &gt; 0) {
00661             base = requiredlength - realsize;
00662 
00663 <span class="preprocessor">#if defined(_WIN64)</span>
00664 <span class="preprocessor"></span>
00665             offset = <a class="code" href="../../d9/d2/cmsubs2_8c.html#a1">ALIGN_OFFSET64</a>(base);
00666 
00667 <span class="preprocessor">#else</span>
00668 <span class="preprocessor"></span>
00669             <span class="keywordflow">if</span> (KeyValueInformationClass == KeyValueFullInformationAlign64) {
00670                 offset = <a class="code" href="../../d9/d2/cmsubs2_8c.html#a1">ALIGN_OFFSET64</a>(base);
00671 
00672             } <span class="keywordflow">else</span> {
00673                 offset = <a class="code" href="../../d9/d2/cmsubs2_8c.html#a0">ALIGN_OFFSET</a>(base);
00674             }
00675 
00676 <span class="preprocessor">#endif</span>
00677 <span class="preprocessor"></span>
00678             <span class="keywordflow">if</span> (offset &gt; base) {
00679                 requiredlength += (offset - base);
00680             }
00681 
00682 <span class="preprocessor">#if DBG &amp;&amp; defined(_WIN64)</span>
00683 <span class="preprocessor"></span>
00684             <span class="comment">//</span>
00685             <span class="comment">// Some clients will have passed in a structure that they "know"</span>
00686             <span class="comment">// will be exactly the right size.  The fact that alignment</span>
00687             <span class="comment">// has changed on NT64 may cause these clients to have problems.</span>
00688             <span class="comment">//</span>
00689             <span class="comment">// The solution is to fix the client, but print out some debug</span>
00690             <span class="comment">// spew here if it looks like this is the case.  This problem</span>
00691             <span class="comment">// isn't particularly easy to spot from the client end.</span>
00692             <span class="comment">//</span>
00693 
00694             <span class="keywordflow">if</span>((KeyValueInformationClass == KeyValueFullInformation) &amp;&amp;
00695                 (Length != minimumlength) &amp;&amp;
00696                 (requiredlength &gt; Length) &amp;&amp;
00697                 ((requiredlength - Length) &lt;=
00698                                 (<a class="code" href="../../d9/d2/cmsubs2_8c.html#a1">ALIGN_OFFSET64</a>(base) - <a class="code" href="../../d9/d2/cmsubs2_8c.html#a0">ALIGN_OFFSET</a>(base)))) {
00699 
00700                 KdPrint((<span class="stringliteral">"ntos/config-64 KeyValueFullInformation: "</span>
00701                          <span class="stringliteral">"Possible client buffer size problem.\n"</span>));
00702 
00703                 KdPrint((<span class="stringliteral">"    Required size = %d\n"</span>, requiredlength));
00704                 KdPrint((<span class="stringliteral">"    Supplied size = %d\n"</span>, Length));
00705             }
00706 
00707 <span class="preprocessor">#endif</span>
00708 <span class="preprocessor"></span>
00709         }
00710 
00711         *ResultLength = requiredlength;
00712 
00713         status = STATUS_SUCCESS;
00714 
00715         <span class="keywordflow">if</span> (Length &lt; minimumlength) {
00716 
00717             status = STATUS_BUFFER_TOO_SMALL;
00718 
00719         } <span class="keywordflow">else</span> {
00720 
00721             pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o1">KeyValueFullInformation</a>.TitleIndex = 0;
00722 
00723             pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o1">KeyValueFullInformation</a>.Type =
00724                 pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a>;
00725 
00726             pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o1">KeyValueFullInformation</a>.DataLength =
00727                 realsize;
00728 
00729             pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o1">KeyValueFullInformation</a>.NameLength =
00730                 NameLength;
00731 
00732             leftlength = Length - minimumlength;
00733             requiredlength = NameLength;
00734 
00735             <span class="keywordflow">if</span> (leftlength &lt; (LONG)requiredlength) {
00736                 requiredlength = leftlength;
00737                 status = STATUS_BUFFER_OVERFLOW;
00738             }
00739 
00740             <span class="keywordflow">if</span> (pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o5">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a37">VALUE_COMP_NAME</a>) {
00741                 <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o1">KeyValueFullInformation</a>.Name,
00742                                       requiredlength,
00743                                       pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o7">Name</a>,
00744                                       pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o1">NameLength</a>);
00745             } <span class="keywordflow">else</span> {
00746                 RtlMoveMemory(
00747                     &amp;(pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o1">KeyValueFullInformation</a>.Name[0]),
00748                     &amp;(pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o7">Name</a>[0]),
00749                     requiredlength
00750                     );
00751             }
00752 
00753             <span class="keywordflow">if</span> (realsize &gt; 0) {
00754 
00755                 <span class="keywordflow">if</span> (small == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00756                     datapointer = (PUCHAR)(&amp;(pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>));
00757                 } <span class="keywordflow">else</span> {
00758                     datapointer = <a class="code" href="../../d9/d2/cmsubs2_8c.html#a2">CmpGetValueDataFromCache</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ContainingList, pcell, ValueCached);
00759                 }
00760 
00761                 pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o1">KeyValueFullInformation</a>.DataOffset = offset;
00762 
00763                 leftlength = (((LONG)Length - (LONG)offset) &lt; 0) ?
00764                                     0 :
00765                                     Length - offset;
00766 
00767                 requiredlength = realsize;
00768 
00769                 <span class="keywordflow">if</span> (leftlength &lt; (LONG)requiredlength) {
00770                     requiredlength = leftlength;
00771                     status = STATUS_BUFFER_OVERFLOW;
00772                 }
00773 
00774                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((small ? (requiredlength &lt;= <a class="code" href="../../d9/d0/cmdata_8h.html#a36">CM_KEY_VALUE_SMALL</a>) : <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
00775 
00776                 RtlMoveMemory(
00777                     ((PUCHAR)pbuffer + offset),
00778                     datapointer,
00779                     requiredlength
00780                     );
00781 
00782             } <span class="keywordflow">else</span> {
00783                 pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o1">KeyValueFullInformation</a>.DataOffset = (ULONG)-1;
00784             }
00785         }
00786 
00787         <span class="keywordflow">break</span>;
00788 
00789 
00790     <span class="keywordflow">case</span> KeyValuePartialInformation:
00791 
00792         <span class="comment">//</span>
00793         <span class="comment">// TitleIndex, Type, DataLength, Data</span>
00794         <span class="comment">//</span>
00795         small = <a class="code" href="../../d9/d0/cmdata_8h.html#a38">CmpIsHKeyValueSmall</a>(realsize, pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a>);
00796         requiredlength = FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION, Data) +
00797                          realsize;
00798 
00799         minimumlength = FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION, Data);
00800 
00801         *ResultLength = requiredlength;
00802 
00803         status = STATUS_SUCCESS;
00804 
00805         <span class="keywordflow">if</span> (Length &lt; minimumlength) {
00806 
00807             status = STATUS_BUFFER_TOO_SMALL;
00808 
00809         } <span class="keywordflow">else</span> {
00810 
00811             pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o2">KeyValuePartialInformation</a>.TitleIndex = 0;
00812 
00813             pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o2">KeyValuePartialInformation</a>.Type =
00814                 pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a>;
00815 
00816             pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o2">KeyValuePartialInformation</a>.DataLength =
00817                 realsize;
00818 
00819             leftlength = Length - minimumlength;
00820             requiredlength = realsize;
00821 
00822             <span class="keywordflow">if</span> (leftlength &lt; (LONG)requiredlength) {
00823                 requiredlength = leftlength;
00824                 status = STATUS_BUFFER_OVERFLOW;
00825             }
00826 
00827             <span class="keywordflow">if</span> (realsize &gt; 0) {
00828 
00829                 <span class="keywordflow">if</span> (small == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00830                     datapointer = (PUCHAR)(&amp;(pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>));
00831                 } <span class="keywordflow">else</span> {
00832                     datapointer = <a class="code" href="../../d9/d2/cmsubs2_8c.html#a2">CmpGetValueDataFromCache</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ContainingList, pcell, ValueCached);
00833                 }
00834 
00835                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((small ? (requiredlength &lt;= <a class="code" href="../../d9/d0/cmdata_8h.html#a36">CM_KEY_VALUE_SMALL</a>) : <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
00836 
00837                 RtlMoveMemory((PUCHAR)&amp;(pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o2">KeyValuePartialInformation</a>.Data[0]),
00838                               datapointer,
00839                               requiredlength);
00840             }
00841         }
00842 
00843         <span class="keywordflow">break</span>;
00844     <span class="keywordflow">case</span> KeyValuePartialInformationAlign64:
00845 
00846         <span class="comment">//</span>
00847         <span class="comment">// TitleIndex, Type, DataLength, Data</span>
00848         <span class="comment">//</span>
00849         small = <a class="code" href="../../d9/d0/cmdata_8h.html#a38">CmpIsHKeyValueSmall</a>(realsize, pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a>);
00850         requiredlength = FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION_ALIGN64, Data) +
00851                          realsize;
00852 
00853         minimumlength = FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION_ALIGN64, Data);
00854 
00855         *ResultLength = requiredlength;
00856 
00857         status = STATUS_SUCCESS;
00858 
00859         <span class="keywordflow">if</span> (Length &lt; minimumlength) {
00860 
00861             status = STATUS_BUFFER_TOO_SMALL;
00862 
00863         } <span class="keywordflow">else</span> {
00864 
00865             pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o3">KeyValuePartialInformationAlign64</a>.Type =
00866                 pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a>;
00867 
00868             pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o3">KeyValuePartialInformationAlign64</a>.DataLength =
00869                 realsize;
00870 
00871             leftlength = Length - minimumlength;
00872             requiredlength = realsize;
00873 
00874             <span class="keywordflow">if</span> (leftlength &lt; (LONG)requiredlength) {
00875                 requiredlength = leftlength;
00876                 status = STATUS_BUFFER_OVERFLOW;
00877             }
00878 
00879             <span class="keywordflow">if</span> (realsize &gt; 0) {
00880 
00881                 <span class="keywordflow">if</span> (small == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00882                     datapointer = (PUCHAR)(&amp;(pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>));
00883                 } <span class="keywordflow">else</span> {
00884                     datapointer = <a class="code" href="../../d9/d2/cmsubs2_8c.html#a2">CmpGetValueDataFromCache</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ContainingList, pcell, ValueCached);
00885                 }
00886 
00887                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((small ? (requiredlength &lt;= <a class="code" href="../../d9/d0/cmdata_8h.html#a36">CM_KEY_VALUE_SMALL</a>) : <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
00888                 RtlMoveMemory((PUCHAR)&amp;(pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o3">KeyValuePartialInformationAlign64</a>.Data[0]),
00889                               datapointer,
00890                               requiredlength);
00891             }
00892         }
00893 
00894         <span class="keywordflow">break</span>;
00895 
00896     <span class="keywordflow">default</span>:
00897         status = STATUS_INVALID_PARAMETER;
00898         <span class="keywordflow">break</span>;
00899     }
00900     <span class="keywordflow">return</span> status;
00901 }
00902 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:28 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
