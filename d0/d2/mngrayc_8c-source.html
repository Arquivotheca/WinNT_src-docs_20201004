<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: mngrayc.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>mngrayc.c</h1><a href="../../d9/d2/mngrayc_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: mngray.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains the DrawState API</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 01-05-94  FritzS  Ported from Chicago</span>
00010 <span class="comment">\***************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
<a name="l00015"></a><a class="code" href="../../d9/d2/mngrayc_8c.html#a0">00015</a> <span class="preprocessor">#define PATOR               0x00FA0089L</span>
<a name="l00016"></a><a class="code" href="../../d9/d2/mngrayc_8c.html#a1">00016</a> <span class="preprocessor"></span><span class="preprocessor">#define SRCSTENCIL          0x00B8074AL</span>
<a name="l00017"></a><a class="code" href="../../d9/d2/mngrayc_8c.html#a2">00017</a> <span class="preprocessor"></span><span class="preprocessor">#define SRCINVSTENCIL       0x00E20746L</span>
00018 <span class="preprocessor"></span>
<a name="l00019"></a><a class="code" href="../../d9/d2/mngrayc_8c.html#a3">00019</a> <span class="preprocessor">#define BC_INVERT             0x00000001</span>
00020 <span class="preprocessor"></span>
00021 <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1501">BltColor</a>(HDC hdc, HBRUSH hbr, HDC hdcSrce,<span class="keywordtype">int</span> xO, <span class="keywordtype">int</span> yO,
00022        <span class="keywordtype">int</span> cx, <span class="keywordtype">int</span> cy, <span class="keywordtype">int</span> xO1, <span class="keywordtype">int</span> yO1, UINT uBltFlags);
00023 <span class="comment">/***************************************************************************\</span>
00024 <span class="comment">*</span>
00025 <span class="comment">*  BitBltSysBmp()</span>
00026 <span class="comment">*</span>
00027 <span class="comment">*  From Chicago -- client *only* for now.</span>
00028 <span class="comment">\***************************************************************************/</span>
<a name="l00029"></a><a class="code" href="../../d4/d1/userk_8h.html#a1773">00029</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> <a class="code" href="../../d4/d1/userk_8h.html#a1773">BitBltSysBmp</a>(HDC hdc, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, UINT i)
00030 {
00031     <a class="code" href="../../d0/d3/structtagOEMBITMAPINFO.html">POEMBITMAPINFO</a> pOem = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;oembmi + i;
00032 
00033     <span class="keywordflow">return</span>(<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a330">NtUserBitBltSysBmp</a>(hdc, x, y, pOem-&gt;<a class="code" href="../../d0/d3/structtagOEMBITMAPINFO.html#o2">cx</a>, pOem-&gt;<a class="code" href="../../d0/d3/structtagOEMBITMAPINFO.html#o3">cy</a>, pOem-&gt;<a class="code" href="../../d0/d3/structtagOEMBITMAPINFO.html#o0">x</a>, pOem-&gt;<a class="code" href="../../d0/d3/structtagOEMBITMAPINFO.html#o1">y</a>, SRCCOPY));
00034 }
00035 
00036 
00037 <span class="comment">/***************************************************************************\</span>
00038 <span class="comment">*</span>
00039 <span class="comment">*  DrawState()</span>
00040 <span class="comment">*</span>
00041 <span class="comment">*  Generic state drawing routine.  Does simple drawing into same DC if</span>
00042 <span class="comment">*  normal state;  uses offscreen bitmap otherwise.</span>
00043 <span class="comment">*</span>
00044 <span class="comment">*  We do drawing for these simple types ourselves:</span>
00045 <span class="comment">*      (1) Text</span>
00046 <span class="comment">*          lData is string pointer.</span>
00047 <span class="comment">*          wData is string length</span>
00048 <span class="comment">*      (2) Icon</span>
00049 <span class="comment">*          LOWORD(lData) is hIcon</span>
00050 <span class="comment">*      (3) Bitmap</span>
00051 <span class="comment">*          LOWORD(lData) is hBitmap</span>
00052 <span class="comment">*      (4) Glyph (internal)</span>
00053 <span class="comment">*          LOWORD(lData) is OBI_ value, one of</span>
00054 <span class="comment">*              OBI_CHECKMARK</span>
00055 <span class="comment">*              OBI_BULLET</span>
00056 <span class="comment">*              OBI_MENUARROW</span>
00057 <span class="comment">*          right now</span>
00058 <span class="comment">*</span>
00059 <span class="comment">*  Other types are required to draw via the callback function, and are</span>
00060 <span class="comment">*  allowed to stick whatever they want in lData and wData.</span>
00061 <span class="comment">*</span>
00062 <span class="comment">*  We apply the following effects onto the image:</span>
00063 <span class="comment">*      (1) Normal      (nothing)</span>
00064 <span class="comment">*      (2) Default     (drop shadow)</span>
00065 <span class="comment">*      (3) Union       (gray string dither)</span>
00066 <span class="comment">*      (4) Disabled    (embossed)</span>
00067 <span class="comment">*</span>
00068 <span class="comment">*  Note that we do NOT stretch anything.  We just clip.</span>
00069 <span class="comment">*</span>
00070 <span class="comment">*</span>
00071 <span class="comment">*   FritzS note -- this is client-side *only*.  Similar code is in server\mngray.c</span>
00072 <span class="comment">*</span>
00073 <span class="comment">*</span>
00074 <span class="comment">\***************************************************************************/</span>
<a name="l00075"></a><a class="code" href="../../d9/d2/mngrayc_8c.html#a6">00075</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d2/mngrayc_8c.html#a6">DrawStateW</a>(
00076     HDC             hdcDraw,
00077     HBRUSH          hbrFore,
00078     DRAWSTATEPROC   qfnCallBack,
00079     LPARAM          lData,
00080     WPARAM          wData,
00081     <span class="keywordtype">int</span>             x,
00082     <span class="keywordtype">int</span>             y,
00083     <span class="keywordtype">int</span>             cx,
00084     <span class="keywordtype">int</span>             cy,
00085     UINT            uFlags)
00086 {
00087     HFONT   hFont;
00088     HFONT   hFontSave = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00089     HDC     hdcT;
00090     HBITMAP hbmpT;
00091     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fResult = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00092     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwPSMFlags;
00093     POINT   ptOrg;
00094     <span class="keywordtype">int</span>     oldAlign;
00095 <span class="preprocessor">#ifdef USE_MIRRORING</span>
00096 <span class="preprocessor"></span>    <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwLayout=0;
00097 <span class="preprocessor">#endif</span>
00098 <span class="preprocessor"></span>
00099     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00100         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00101 
00102     RtlEnterCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a23">gcsHdc</a>);
00103 
00104     <span class="comment">/*</span>
00105 <span class="comment">     * These require monochrome conversion</span>
00106 <span class="comment">     *</span>
00107 <span class="comment">     * Enforce monochrome: embossed doesn't look great with 2 color displays</span>
00108 <span class="comment">     */</span>
00109     <span class="keywordflow">if</span> ((uFlags &amp; DSS_DISABLED) &amp;&amp;
00110         (<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;BitCount == 1 || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(SLOWMACHINE))) {
00111 
00112         uFlags &amp;= ~DSS_DISABLED;
00113         uFlags |= DSS_UNION;
00114     }
00115 
00116     <span class="keywordflow">if</span> (uFlags &amp; (DSS_DISABLED | DSS_DEFAULT | DSS_UNION))
00117         uFlags |= DSS_MONO;
00118 
00119     <span class="comment">/*</span>
00120 <span class="comment">     * Get drawing sizes etc. AND VALIDATE.</span>
00121 <span class="comment">     */</span>
00122     <span class="keywordflow">switch</span> (uFlags &amp; DST_TYPEMASK) {
00123 
00124         <span class="keywordflow">case</span> DST_GLYPH:
00125 
00126             <span class="comment">/*</span>
00127 <span class="comment">             * LOWORD(lData) is OBI_ value.</span>
00128 <span class="comment">             */</span>
00129             <span class="keywordflow">if</span> (LOWORD(lData) &gt;= (WORD)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a361">OBI_COUNT</a>) {
00130                 <span class="keywordflow">goto</span> CDS_Leave;
00131             }
00132 
00133             <span class="keywordflow">if</span> (!cx) {
00134                 cx = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;oembmi[LOWORD(lData)].cx;
00135             }
00136 
00137             <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>) {
00138                 <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;oembmi[LOWORD(lData)].cy;
00139             }
00140 
00141             <span class="keywordflow">break</span>;
00142 
00143         <span class="keywordflow">case</span> DST_BITMAP:
00144 
00145             <span class="comment">/*</span>
00146 <span class="comment">             * LOWORD(lData) is hbmp.</span>
00147 <span class="comment">             */</span>
00148             <span class="keywordflow">if</span> (GetObjectType((HGDIOBJ)lData) != OBJ_BITMAP) {
00149                 <span class="keywordflow">goto</span> CDS_Leave;
00150             }
00151 
00152             <span class="keywordflow">if</span> (!cx || !<a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>) {
00153 
00154                 BITMAP bmp;
00155 
00156                 GetObjectW((HGDIOBJ)lData, <span class="keyword">sizeof</span>(BITMAP), &amp;bmp);
00157 
00158                 <span class="keywordflow">if</span> (!cx)
00159                     cx = bmp.bmWidth;
00160 
00161                 <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>)
00162                     <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = bmp.bmHeight;
00163             }
00164             <span class="keywordflow">break</span>;
00165 
00166         <span class="keywordflow">case</span> DST_ICON:
00167 
00168             <span class="comment">/*</span>
00169 <span class="comment">             * lData is hicon.</span>
00170 <span class="comment">             */</span>
00171             <span class="keywordflow">if</span> (!cx || !<a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>) {
00172 
00173                 <span class="keywordtype">int</span> cx1 = 0;
00174                 <span class="keywordtype">int</span> cy1 = 0;
00175 
00176                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a106">NtUserGetIconSize</a>((HICON)lData, 0, &amp;cx1, &amp;cy1);
00177 
00178                 <span class="keywordflow">if</span> (!cx)
00179                     cx = cx1;
00180 
00181                 <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>)
00182                     <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = cy1 / 2; <span class="comment">// icons are double height in NT</span>
00183             }
00184             <span class="keywordflow">break</span>;
00185 
00186         <span class="keywordflow">case</span> DST_TEXT:
00187 
00188             <span class="comment">/*</span>
00189 <span class="comment">             * lData is LPSTR</span>
00190 <span class="comment">             * NOTE THAT WE DO NOT VALIDATE lData, DUE TO COMPATIBILITY</span>
00191 <span class="comment">             * WITH GRAYSTRING().  THIS _SHOULD_ FAULT IF YOU PASS IN NULL.</span>
00192 <span class="comment">             *</span>
00193 <span class="comment">             * wData is cch.</span>
00194 <span class="comment">             */</span>
00195             <span class="keywordflow">if</span> (!wData)
00196                 wData = wcslen((LPWSTR)lData);
00197 
00198             <span class="keywordflow">if</span> (!cx || !<a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>) {
00199 
00200                 SIZE size;
00201 
00202                 <span class="comment">/*</span>
00203 <span class="comment">                 * Make sure we use right dc w/ right font.</span>
00204 <span class="comment">                 */</span>
00205                 GetTextExtentPointW(hdcDraw, (LPWSTR)lData, (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)wData, &amp;size);
00206 
00207                 <span class="keywordflow">if</span> (!cx)
00208                     cx = size.cx;
00209 
00210                 <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>)
00211                     <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = size.cy;
00212 
00213             }
00214 
00215             <span class="comment">/*</span>
00216 <span class="comment">             * Now, pretend we're complex if qfnCallBack is supplied AND</span>
00217 <span class="comment">             * we're supporting GrayString().</span>
00218 <span class="comment">             */</span>
00219 <span class="preprocessor">#if 0 // This will get turned on if/when we change GrayString to tie</span>
00220 <span class="preprocessor"></span>      <span class="comment">// into DrawState.</span>
00221       <span class="comment">//</span>
00222       <span class="comment">// FritzS</span>
00223             <span class="keywordflow">if</span> ((uFlags &amp; DST_GRAYSTRING) &amp;&amp; SELECTOROF(qfnCallBack)) {
00224                 uFlags &amp;= ~DST_TYPEMASK;
00225                 uFlags |= DST_COMPLEX;
00226             }
00227 <span class="preprocessor">#endif</span>
00228 <span class="preprocessor"></span>            <span class="keywordflow">break</span>;
00229 
00230         <span class="keywordflow">case</span> DST_PREFIXTEXT:
00231 
00232             <span class="keywordflow">if</span> (lData == 0) {
00233                 RIPMSG0(RIP_ERROR, <span class="stringliteral">"DrawState: NULL DST_PREFIXTEXT string"</span>);
00234                 <span class="keywordflow">goto</span> CDS_Leave;
00235             }
00236 
00237             <span class="keywordflow">if</span> (!wData)
00238                 wData = wcslen((LPWSTR)lData);
00239 
00240             <span class="keywordflow">if</span> (!cx || !<a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>) {
00241 
00242                 SIZE size;
00243 
00244                 <a class="code" href="../../d8/d0/rtl_2text_8c.html#a0">PSMGetTextExtent</a>(hdcDraw, (LPWSTR)lData, (<span class="keywordtype">int</span>)wData, &amp;size);
00245 
00246                 <span class="keywordflow">if</span> (!cx)
00247                     cx = size.cx;
00248 
00249                 <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>)
00250                     <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = size.cy;
00251             }
00252 
00253             <span class="comment">/*</span>
00254 <span class="comment">             * Add on height for prefix</span>
00255 <span class="comment">             */</span>
00256             <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> += (2 * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYBORDER));
00257             <span class="keywordflow">break</span>;
00258 
00259         <span class="keywordflow">case</span> DST_COMPLEX:
00260 <span class="preprocessor">#if 0</span>
00261 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (!SELECTOROF(qfnCallBack)) {
00262                 DebugErr(DBF_ERROR, <span class="stringliteral">"DrawState: invalid callback for DST_COMPLEX"</span>);
00263                 <span class="keywordflow">goto</span> CDS_Leave;
00264             }
00265 <span class="preprocessor">#endif</span>
00266 <span class="preprocessor"></span>            <span class="keywordflow">break</span>;
00267 
00268         <span class="keywordflow">default</span>:
00269             RIPMSG0(RIP_ERROR, <span class="stringliteral">"DrawState: invalid DST_ type"</span>);
00270             <span class="keywordflow">goto</span> CDS_Leave;
00271     }
00272 
00273     <span class="comment">/*</span>
00274 <span class="comment">     * Optimize:  nothing to draw</span>
00275 <span class="comment">     * Have to call callback if GRAYSTRING for compatibility.</span>
00276 <span class="comment">     */</span>
00277     <span class="keywordflow">if</span> ((!cx || !<a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>)
00278 <span class="comment">//        &amp;&amp; !(uFlags &amp; DST_GRAYSTRING)</span>
00279     ) {
00280         fResult = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00281         <span class="keywordflow">goto</span> CDS_Leave;
00282     }
00283 
00284     <span class="comment">/*</span>
00285 <span class="comment">     * Setup drawing dc</span>
00286 <span class="comment">     */</span>
00287     <span class="keywordflow">if</span> (uFlags &amp; DSS_MONO) {
00288 
00289         hdcT = <a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>;
00290 <span class="preprocessor">#ifdef USE_MIRRORING</span>
00291 <span class="preprocessor"></span>        <span class="comment">/*</span>
00292 <span class="comment">         * First turn off mirroring on hdcGray if any.</span>
00293 <span class="comment">         */</span>
00294         SetLayoutWidth(hdcT, -1, 0);
00295         <span class="comment">/*</span>
00296 <span class="comment">         * Set the ghdcGray layout to be equal to the screen hdcDraw layout.</span>
00297 <span class="comment">         */</span>
00298         dwLayout = GetLayout(hdcDraw);
00299         <span class="keywordflow">if</span> (dwLayout != GDI_ERROR) {
00300             SetLayoutWidth(hdcT, cx, dwLayout);
00301         }
00302 <span class="preprocessor">#endif</span>
00303 <span class="preprocessor"></span>
00304         <span class="comment">/*</span>
00305 <span class="comment">         * Is our scratch bitmap big enough?  We need potentially</span>
00306 <span class="comment">         * cx+1 by cy pixels for default etc.</span>
00307 <span class="comment">         */</span>
00308         <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d8/clglobal_8c.html#a30">gcxGray</a> &lt; cx + 1) || (<a class="code" href="../../d1/d8/clglobal_8c.html#a31">gcyGray</a> &lt; <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>)) {
00309 
00310             <span class="keywordflow">if</span> (hbmpT = CreateBitmap(<a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a30">gcxGray</a>, cx + 1), <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a31">gcyGray</a>, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>), 1, 1, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>)) {
00311 
00312                 HBITMAP hbmGray;
00313 
00314                 hbmGray = SelectObject(<a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>, hbmpT);
00315                 DeleteObject(hbmGray);
00316 
00317                 <a class="code" href="../../d1/d8/clglobal_8c.html#a30">gcxGray</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a30">gcxGray</a>, cx + 1);
00318                 <a class="code" href="../../d1/d8/clglobal_8c.html#a31">gcyGray</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a31">gcyGray</a>, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>);
00319 
00320             } <span class="keywordflow">else</span> {
00321                 cx = <a class="code" href="../../d1/d8/clglobal_8c.html#a30">gcxGray</a> - 1;
00322                 <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a31">gcyGray</a>;
00323             }
00324         }
00325 
00326         PatBlt(<a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>, 0, 0, <a class="code" href="../../d1/d8/clglobal_8c.html#a30">gcxGray</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a31">gcyGray</a>, WHITENESS);
00327         SetTextCharacterExtra(<a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>, GetTextCharacterExtra(hdcDraw));
00328 
00329         oldAlign = GetTextAlign(hdcT);
00330         SetTextAlign(hdcT, (oldAlign &amp; ~(TA_RTLREADING |TA_CENTER |TA_RIGHT))
00331                      | (GetTextAlign(hdcDraw) &amp; (TA_RTLREADING |TA_CENTER |TA_RIGHT)));
00332 
00333         <span class="comment">/*</span>
00334 <span class="comment">         * Setup font</span>
00335 <span class="comment">         */</span>
00336         <span class="keywordflow">if</span> ((uFlags &amp; DST_TYPEMASK) &lt;= DST_TEXTMAX) {
00337 
00338             <span class="keywordflow">if</span> (GetCurrentObject(hdcDraw, OBJ_FONT) != <a class="code" href="../../d1/d8/clglobal_8c.html#a28">ghFontSys</a>) {
00339                 hFont = SelectObject(hdcDraw, <a class="code" href="../../d1/d8/clglobal_8c.html#a28">ghFontSys</a>);
00340                 SelectObject(hdcDraw, hFont);
00341                 hFontSave = SelectObject(<a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>, hFont);
00342             }
00343         }
00344 
00345     } <span class="keywordflow">else</span> {
00346 
00347         hdcT = hdcDraw;
00348 
00349         <span class="comment">/*</span>
00350 <span class="comment">         * Adjust viewport</span>
00351 <span class="comment">         */</span>
00352         GetViewportOrgEx(hdcT, &amp;ptOrg);
00353         SetViewportOrgEx(hdcT, ptOrg.x + x, ptOrg.y + y, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00354     }
00355 
00356     <span class="comment">/*</span>
00357 <span class="comment">     * Now, draw original image</span>
00358 <span class="comment">     */</span>
00359     fResult = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00360 
00361     <span class="keywordflow">switch</span> (uFlags &amp; DST_TYPEMASK) {
00362 
00363         <span class="keywordflow">case</span> DST_GLYPH:
00364             <span class="comment">/*</span>
00365 <span class="comment">             * Blt w/ current brush in hdcT</span>
00366 <span class="comment">             */</span>
00367             <a class="code" href="../../d4/d1/userk_8h.html#a1773">BitBltSysBmp</a>(hdcT, 0, 0, LOWORD(lData));
00368             <span class="keywordflow">break</span>;
00369 
00370         <span class="keywordflow">case</span> DST_BITMAP:
00371             <span class="comment">/*</span>
00372 <span class="comment">             * Draw the bitmap.  If mono, it'll use the colors set up</span>
00373 <span class="comment">             * in the dc.</span>
00374 <span class="comment">             */</span>
00375 <span class="comment">//            RtlEnterCriticalSection(&amp;gcsHdcBits2);</span>
00376             UserAssert(GetBkColor(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>) == RGB(255, 255, 255));
00377             UserAssert(GetTextColor(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>) == RGB(0, 0, 0));
00378 
00379             hbmpT = SelectObject(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>, (HBITMAP)lData);
00380             BitBlt(hdcT, 0, 0, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>, 0, 0, SRCCOPY);
00381             SelectObject(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>, hbmpT);
00382 <span class="comment">//            RtlLeaveCriticalSection(&amp;gcsHdcBits2);</span>
00383             <span class="keywordflow">break</span>;
00384 
00385         <span class="keywordflow">case</span> DST_ICON:
00386             <span class="comment">/*</span>
00387 <span class="comment">             * Draw the icon.</span>
00388 <span class="comment">             */</span>
00389             <a class="code" href="../../d3/d8/client_8c.html#a50">DrawIconEx</a>(hdcT, 0, 0, (HICON)lData, 0, 0, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, DI_NORMAL);
00390             <span class="keywordflow">break</span>;
00391 
00392         <span class="keywordflow">case</span> DST_PREFIXTEXT:
00393             <span class="keywordflow">if</span> (uFlags &amp; DSS_HIDEPREFIX) {
00394                 dwPSMFlags = DT_HIDEPREFIX;
00395             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (uFlags &amp; DSS_PREFIXONLY) {
00396                 dwPSMFlags = DT_PREFIXONLY;
00397             } <span class="keywordflow">else</span> {
00398                 dwPSMFlags = 0;
00399             }
00400             <a class="code" href="../../d6/d0/usercli_8h.html#a425">PSMTextOut</a>(hdcT, 0, 0, (LPWSTR)lData, (<span class="keywordtype">int</span>)wData, dwPSMFlags);
00401             <span class="keywordflow">break</span>;
00402 
00403         <span class="keywordflow">case</span> DST_TEXT:
00404             fResult = TextOutW(hdcT, 0, 0, (LPWSTR)lData, (<span class="keywordtype">int</span>)wData);
00405             <span class="keywordflow">break</span>;
00406 
00407         <span class="keywordflow">default</span>:
00408 
00409             fResult = (qfnCallBack)(hdcT, lData, wData, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>);
00410 
00411             <span class="comment">/*</span>
00412 <span class="comment">             * The callbacks could have altered the attributes of ghdcGray</span>
00413 <span class="comment">             */</span>
00414             <span class="keywordflow">if</span> (hdcT == <a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>) {
00415                 SetBkColor(<a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>, RGB(255, 255, 255));
00416                 SetTextColor(<a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>, RGB(0, 0, 0));
00417                 SelectObject(<a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>, GetStockObject(BLACK_BRUSH));
00418                 SetBkMode(<a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>, OPAQUE);
00419             }
00420             <span class="keywordflow">break</span>;
00421     }
00422 
00423     <span class="comment">/*</span>
00424 <span class="comment">     * Clean up</span>
00425 <span class="comment">     */</span>
00426     <span class="keywordflow">if</span> (uFlags &amp; DSS_MONO) {
00427         <span class="comment">/*</span>
00428 <span class="comment">         * Reset font</span>
00429 <span class="comment">         */</span>
00430         <span class="keywordflow">if</span> (hFontSave)
00431             SelectObject(hdcT, hFontSave);
00432         SetTextAlign(hdcT, oldAlign);
00433     } <span class="keywordflow">else</span> {
00434         <span class="comment">/*</span>
00435 <span class="comment">         * Reset DC.</span>
00436 <span class="comment">         */</span>
00437         SetViewportOrgEx(hdcT, ptOrg.x, ptOrg.y, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00438         <span class="keywordflow">goto</span> CDS_Leave;
00439     }
00440 
00441     <span class="comment">/*</span>
00442 <span class="comment">     * UNION state</span>
00443 <span class="comment">     * Dither over image</span>
00444 <span class="comment">     * We want white pixels to stay white, in either dest or pattern.</span>
00445 <span class="comment">     */</span>
00446     <span class="keywordflow">if</span> (uFlags &amp; DSS_UNION) {
00447 
00448         POLYPATBLT PolyData;
00449 
00450         PolyData.x         = 0;
00451         PolyData.y         = 0;
00452         PolyData.cx        = cx;
00453         PolyData.cx        = <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
00454         PolyData.BrClr.hbr = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;hbrGray;
00455 
00456         PolyPatBlt(<a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>, <a class="code" href="../../d9/d2/mngrayc_8c.html#a0">PATOR</a>, &amp;PolyData, 1, PPB_BRUSH);
00457     }
00458 
00459     <span class="comment">/*</span>
00460 <span class="comment">     * DISABLED state</span>
00461 <span class="comment">     * Emboss</span>
00462 <span class="comment">     * Draw over-1/down-1 in hilight color, and in same position in shadow.</span>
00463 <span class="comment">     *</span>
00464 <span class="comment">     * DEFAULT state</span>
00465 <span class="comment">     * Drop shadow</span>
00466 <span class="comment">     * Draw over-1/down-1 in shadow color, and in same position in foreground</span>
00467 <span class="comment">     * Draw offset down in shadow color,</span>
00468 <span class="comment">     */</span>
00469     <span class="keywordflow">if</span> (uFlags &amp; DSS_DISABLED) {
00470 
00471         <a class="code" href="../../d4/d1/userk_8h.html#a1501">BltColor</a>(hdcDraw,
00472                  <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(3DHILIGHT),
00473                  <a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>,
00474                  x + 1,
00475                  y + 1,
00476                  cx,
00477                  <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
00478                  0,
00479                  0,
00480                  <a class="code" href="../../d9/d2/mngrayc_8c.html#a3">BC_INVERT</a>);
00481 
00482         <a class="code" href="../../d4/d1/userk_8h.html#a1501">BltColor</a>(hdcDraw,
00483                  <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(3DSHADOW),
00484                  <a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>,
00485                  x,
00486                  y,
00487                  cx,
00488                  <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
00489                  0,
00490                  0,
00491                  <a class="code" href="../../d9/d2/mngrayc_8c.html#a3">BC_INVERT</a>);
00492 
00493     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (uFlags &amp; DSS_DEFAULT) {
00494 
00495         <a class="code" href="../../d4/d1/userk_8h.html#a1501">BltColor</a>(hdcDraw,
00496                  <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(3DSHADOW),
00497                  <a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>,
00498                  x+1,
00499                  y+1,
00500                  cx,
00501                  <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
00502                  0,
00503                  0,
00504                  <a class="code" href="../../d9/d2/mngrayc_8c.html#a3">BC_INVERT</a>);
00505 
00506         <span class="keywordflow">goto</span> DrawNormal;
00507 
00508     } <span class="keywordflow">else</span> {
00509 
00510 DrawNormal:
00511 
00512         <a class="code" href="../../d4/d1/userk_8h.html#a1501">BltColor</a>(hdcDraw, hbrFore, <a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>, x, y, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>, 0, 0, <a class="code" href="../../d9/d2/mngrayc_8c.html#a3">BC_INVERT</a>);
00513     }
00514 
00515 CDS_Leave:
00516 
00517 <span class="preprocessor">#ifdef USE_MIRRORING</span>
00518 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (uFlags &amp; DSS_MONO) {
00519         <span class="comment">/*</span>
00520 <span class="comment">         * Set the ghdcGray layout to 0, it is a public DC.</span>
00521 <span class="comment">         */</span>
00522         SetLayoutWidth(hdcT, -1, 0);
00523     }
00524 <span class="preprocessor">#endif</span>
00525 <span class="preprocessor"></span>    RtlLeaveCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a23">gcsHdc</a>);
00526 
00527     <span class="keywordflow">return</span> fResult;
00528 }
00529 
<a name="l00530"></a><a class="code" href="../../d9/d2/mngrayc_8c.html#a7">00530</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d2/mngrayc_8c.html#a7">DrawStateA</a>(HDC hDC, HBRUSH hBrush, DRAWSTATEPROC func,
00531     LPARAM lParam, WPARAM wParam, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> cx, <span class="keywordtype">int</span> cy, UINT wFlags) {
00532 
00533     LPARAM lpwstr = lParam;
00534     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bRet;
00535     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bFree;
00536 
00537     <span class="keywordflow">if</span> (((wFlags &amp; DST_TYPEMASK) == DST_TEXT) ||
00538         ((wFlags &amp; DST_TYPEMASK) == DST_PREFIXTEXT)) {
00539 
00540         bFree = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00541 
00542         <span class="keywordflow">if</span> ((wParam = MBToWCS((LPSTR)lParam, wParam ? (<span class="keywordtype">int</span>)wParam : USER_AWCONV_COUNTSTRINGSZ, &amp;(LPWSTR)lpwstr, -1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) == 0)
00543             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00544     } <span class="keywordflow">else</span> {
00545         bFree = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00546     }
00547 
00548     bRet = <a class="code" href="../../d9/d2/mngrayc_8c.html#a6">DrawStateW</a>(hDC, hBrush, func, lpwstr, wParam, x, y, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>, wFlags);
00549 
00550     <span class="keywordflow">if</span> (bFree) {
00551         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>((HANDLE)lpwstr);
00552     }
00553     <span class="keywordflow">return</span> bRet;
00554 }
00555 
00556 <span class="comment">/***************************************************************************\</span>
00557 <span class="comment">* BltColor</span>
00558 <span class="comment">*</span>
00559 <span class="comment">* History:</span>
00560 <span class="comment">\***************************************************************************/</span>
00561 
<a name="l00562"></a><a class="code" href="../../d9/d2/mngrayc_8c.html#a4">00562</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1501">BltColor</a>(
00563     HDC hdc,
00564     HBRUSH hbr,
00565     HDC hdcSrce,
00566     <span class="keywordtype">int</span> xO,
00567     <span class="keywordtype">int</span> yO,
00568     <span class="keywordtype">int</span> cx,
00569     <span class="keywordtype">int</span> cy,
00570     <span class="keywordtype">int</span> xO1,
00571     <span class="keywordtype">int</span> yO1,
00572     UINT uBltFlags
00573 )
00574 {
00575     HBRUSH hbrSave;
00576     HBRUSH hbrNew = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00577     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  textColorSave;
00578     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  bkColorSave;
00579 
00580     <span class="keywordflow">if</span> (hbr == (HBRUSH)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00581         LOGBRUSH lb;
00582 
00583         lb.lbStyle = BS_SOLID;
00584         lb.lbColor = <a class="code" href="../../d3/d9/client_2wow_8c.html#a15">GetSysColor</a>(COLOR_WINDOWTEXT);
00585         hbrNew = hbr = CreateBrushIndirect(&amp;lb);
00586     }
00587 
00588     <span class="comment">/*</span>
00589 <span class="comment">     * Set the Text and Background colors so that bltColor handles the</span>
00590 <span class="comment">     * background of buttons (and other bitmaps) properly.</span>
00591 <span class="comment">     * Save the HDC's old Text and Background colors.  This causes problems with</span>
00592 <span class="comment">     * Omega (and probably other apps) when calling GrayString which uses this</span>
00593 <span class="comment">     * routine...</span>
00594 <span class="comment">     */</span>
00595     textColorSave = SetTextColor(hdc, 0x00000000L);
00596     bkColorSave = SetBkColor(hdc, 0x00FFFFFFL);
00597 
00598     hbrSave = SelectObject(hdc, hbr);
00599 
00600     BitBlt(hdc, xO, yO, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>, hdcSrce,
00601         xO1, yO1, ((uBltFlags &amp; <a class="code" href="../../d9/d2/mngrayc_8c.html#a3">BC_INVERT</a>) ? 0xB8074AL : 0xE20746L));
00602         <span class="comment">//xO1, yO1, (fInvert ? 0xB80000 : 0xE20000));</span>
00603 
00604     SelectObject(hdc, hbrSave);
00605 
00606     <span class="comment">/*</span>
00607 <span class="comment">     * Restore saved colors</span>
00608 <span class="comment">     */</span>
00609     SetTextColor(hdc, textColorSave);
00610     SetBkColor(hdc, bkColorSave);
00611 
00612     <span class="keywordflow">if</span> (hbrNew) {
00613         DeleteObject(hbrNew);
00614     }
00615 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:51 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
